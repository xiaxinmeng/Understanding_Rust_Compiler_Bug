{"sha": "c24f06354aa4434e872c72cbb88fb205140738dd", "node_id": "C_kwDOAAsO6NoAKGMyNGYwNjM1NGFhNDQzNGU4NzJjNzJjYmI4OGZiMjA1MTQwNzM4ZGQ", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-24T08:55:13Z"}, "committer": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-06-27T11:43:44Z"}, "message": "Remove a back-compat hack on lazy TAIT", "tree": {"sha": "33e42b2f16fc3cca116a9004330ae55748cdaaf0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33e42b2f16fc3cca116a9004330ae55748cdaaf0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c24f06354aa4434e872c72cbb88fb205140738dd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEClCZYSKPPkQPouAvN5zu/dY+XdcFAmK5l/AACgkQN5zu/dY+\nXddetRAAo3lbD3nJaOt19X2nqw5Dw+S7+KoslHPvaC6Q4b+St7BPJw3REg1a48ya\n/iCdZAXhB/l829LSyq4JvGWOOb0Su/FGg8ohDdZeyzGXnQKcpz1bGF1PlT2Zl17G\nvhyR39V76gRm5iG4qErcIwIXD2Sq2DMJ448ffNP0fObDm4+LpH+uOnsl0yIKS2g1\n4ypOZ3pjOaQXQIMsbc9eEea60lzhDh4ch4KOcQd6/70i4vvWnuCeC63hF4d4eANK\nTir5Xl9O9DdPW7b26eQcAmAYM2RoNXiJ41TUZO/k9/iKcvCizM+rwuL2dgW77q9P\ncOLPx9dtPBPGZvOSPS1Wp3PfUqoC12fhHmsu5coONJ4Lf0DkE0CvYevXCzwlVeLM\n4XR6RYV33als58/L30aYwwS39+Q66yR7DliMyD9QeCqWPDhyanaIDPM9HZKusBsv\nU8TYDQ/DfLqxsS37hdV1F/LvkSFcGQRZ9WvhjCh27oQNcfLCoceHUvJLNrmCoICo\nw+UK37dwNLGk7uGCfADvZSi95seN8fPNkSHkLdFvdI8UZA4/qYcVeDIRHZCqIncs\nuRjzEeAtKnxlhPOMPFJxImY0KNQw9g7R1FNFTKpfaOpKUVzZYlTJ1fp+hu80BpaH\n31atAjDuhqTyoiSQPdubn5M+xOtcnQOGG6qqj0acYGSI0+n8KcA=\n=Wevt\n-----END PGP SIGNATURE-----", "payload": "tree 33e42b2f16fc3cca116a9004330ae55748cdaaf0\nparent bd2e51a338e36372b200a22f3e0e22189a1063e6\nauthor Yuki Okushi <jtitor@2k36.org> 1653382513 +0900\ncommitter Yuki Okushi <jtitor@2k36.org> 1656330224 +0900\n\nRemove a back-compat hack on lazy TAIT\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c24f06354aa4434e872c72cbb88fb205140738dd", "html_url": "https://github.com/rust-lang/rust/commit/c24f06354aa4434e872c72cbb88fb205140738dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c24f06354aa4434e872c72cbb88fb205140738dd/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd2e51a338e36372b200a22f3e0e22189a1063e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd2e51a338e36372b200a22f3e0e22189a1063e6", "html_url": "https://github.com/rust-lang/rust/commit/bd2e51a338e36372b200a22f3e0e22189a1063e6"}], "stats": {"total": 59, "additions": 28, "deletions": 31}, "files": [{"sha": "ebb8d4434215fef29a0c9928c12a144262b3ce84", "filename": "compiler/rustc_infer/src/infer/opaque_types.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c24f06354aa4434e872c72cbb88fb205140738dd/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c24f06354aa4434e872c72cbb88fb205140738dd/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types.rs?ref=c24f06354aa4434e872c72cbb88fb205140738dd", "patch": "@@ -39,21 +39,19 @@ pub struct OpaqueTypeDecl<'tcx> {\n }\n \n impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n-    /// This is a backwards compatibility hack to prevent breaking changes from\n-    /// lazy TAIT around RPIT handling.\n-    pub fn replace_opaque_types_with_inference_vars<T: TypeFoldable<'tcx>>(\n+    pub fn replace_opaque_types_with_inference_vars(\n         &self,\n-        value: T,\n+        ty: Ty<'tcx>,\n         body_id: HirId,\n         span: Span,\n         code: ObligationCauseCode<'tcx>,\n         param_env: ty::ParamEnv<'tcx>,\n-    ) -> InferOk<'tcx, T> {\n-        if !value.has_opaque_types() {\n-            return InferOk { value, obligations: vec![] };\n+    ) -> InferOk<'tcx, Ty<'tcx>> {\n+        if !ty.has_opaque_types() {\n+            return InferOk { value: ty, obligations: vec![] };\n         }\n         let mut obligations = vec![];\n-        let value = value.fold_with(&mut ty::fold::BottomUpFolder {\n+        let value = ty.fold_with(&mut ty::fold::BottomUpFolder {\n             tcx: self.tcx,\n             lt_op: |lt| lt,\n             ct_op: |ct| ct,"}, {"sha": "aba4f144d4bcc7db0871fb19216c7b3e3dea4bf9", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 4, "deletions": 17, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c24f06354aa4434e872c72cbb88fb205140738dd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c24f06354aa4434e872c72cbb88fb205140738dd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=c24f06354aa4434e872c72cbb88fb205140738dd", "patch": "@@ -28,7 +28,6 @@ use rustc_hir::def::DefKind;\n use rustc_hir::def_id::DefId;\n use rustc_hir::lang_items::LangItem;\n use rustc_infer::infer::resolve::OpportunisticRegionResolver;\n-use rustc_infer::traits::ObligationCauseCode;\n use rustc_middle::traits::select::OverflowError;\n use rustc_middle::ty::fold::{MaxUniverse, TypeFoldable, TypeFolder, TypeSuperFoldable};\n use rustc_middle::ty::subst::Subst;\n@@ -252,22 +251,10 @@ fn project_and_unify_type<'cx, 'tcx>(\n         Err(InProgress) => return ProjectAndUnifyResult::Recursive,\n     };\n     debug!(?normalized, ?obligations, \"project_and_unify_type result\");\n-    let actual = obligation.predicate.term;\n-    // HACK: lazy TAIT would regress src/test/ui/impl-trait/nested-return-type2.rs, so we add\n-    // a back-compat hack hat converts the RPITs into inference vars, just like they were before\n-    // lazy TAIT.\n-    // This does not affect TAITs in general, as tested in the nested-return-type-tait* tests.\n-    let InferOk { value: actual, obligations: new } =\n-        selcx.infcx().replace_opaque_types_with_inference_vars(\n-            actual,\n-            obligation.cause.body_id,\n-            obligation.cause.span,\n-            ObligationCauseCode::MiscObligation,\n-            obligation.param_env,\n-        );\n-    obligations.extend(new);\n-\n-    match infcx.at(&obligation.cause, obligation.param_env).eq(normalized, actual) {\n+    match infcx\n+        .at(&obligation.cause, obligation.param_env)\n+        .eq(normalized, obligation.predicate.term)\n+    {\n         Ok(InferOk { obligations: inferred_obligations, value: () }) => {\n             obligations.extend(inferred_obligations);\n             ProjectAndUnifyResult::Holds(obligations)"}, {"sha": "279641a46c3d0fd32402b7d9576d7247bf05c151", "filename": "src/test/ui/impl-trait/nested-return-type2.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c24f06354aa4434e872c72cbb88fb205140738dd/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-return-type2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c24f06354aa4434e872c72cbb88fb205140738dd/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-return-type2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-return-type2.rs?ref=c24f06354aa4434e872c72cbb88fb205140738dd", "patch": "@@ -1,5 +1,3 @@\n-// check-pass\n-\n trait Duh {}\n \n impl Duh for i32 {}\n@@ -20,11 +18,9 @@ impl<R: Duh, F: FnMut() -> R> Trait for F {\n // the hidden type. We already have obligations registered on the inference\n // var to make it uphold the `: Duh` bound on `Trait::Assoc`. The opaque\n // type does not implement `Duh`, even if its hidden type does.\n-// Lazy TAIT would error out, but we inserted a hack to make it work again,\n-// keeping backwards compatibility.\n fn foo() -> impl Trait<Assoc = impl Send> {\n+    //~^ ERROR `impl Send: Duh` is not satisfied\n     || 42\n }\n \n-fn main() {\n-}\n+fn main() {}"}, {"sha": "f996e99de074208a67bca89e474f2b6f0b4b974a", "filename": "src/test/ui/impl-trait/nested-return-type2.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c24f06354aa4434e872c72cbb88fb205140738dd/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-return-type2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c24f06354aa4434e872c72cbb88fb205140738dd/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-return-type2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fnested-return-type2.stderr?ref=c24f06354aa4434e872c72cbb88fb205140738dd", "patch": "@@ -0,0 +1,16 @@\n+error[E0277]: the trait bound `impl Send: Duh` is not satisfied\n+  --> $DIR/nested-return-type2.rs:21:13\n+   |\n+LL | fn foo() -> impl Trait<Assoc = impl Send> {\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `Duh` is not implemented for `impl Send`\n+   |\n+   = help: the trait `Duh` is implemented for `i32`\n+note: required because of the requirements on the impl of `Trait` for `[closure@$DIR/nested-return-type2.rs:23:5: 23:10]`\n+  --> $DIR/nested-return-type2.rs:12:31\n+   |\n+LL | impl<R: Duh, F: FnMut() -> R> Trait for F {\n+   |                               ^^^^^     ^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}]}