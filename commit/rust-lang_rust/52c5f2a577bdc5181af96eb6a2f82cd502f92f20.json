{"sha": "52c5f2a577bdc5181af96eb6a2f82cd502f92f20", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyYzVmMmE1NzdiZGM1MTgxYWY5NmViNmEyZjgyY2Q1MDJmOTJmMjA=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-03-03T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-03-03T07:41:08Z"}, "message": "Add test for -Znew-llvm-pass-manager -Clto=thin -Zsanitizer=...\n\nAdditionally verify that the current implementation of LLVM version\ncheck (which uses lexicographic ordering) is good enough to exclude\nversions before LLVM 9, where the new LLVM pass manager is unsupported.", "tree": {"sha": "af7c0ca82398da5312d8953752163611df69a01e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af7c0ca82398da5312d8953752163611df69a01e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52c5f2a577bdc5181af96eb6a2f82cd502f92f20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52c5f2a577bdc5181af96eb6a2f82cd502f92f20", "html_url": "https://github.com/rust-lang/rust/commit/52c5f2a577bdc5181af96eb6a2f82cd502f92f20", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52c5f2a577bdc5181af96eb6a2f82cd502f92f20/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a61e13423e57380a08ea1475db57fc30cb7deb15", "url": "https://api.github.com/repos/rust-lang/rust/commits/a61e13423e57380a08ea1475db57fc30cb7deb15", "html_url": "https://github.com/rust-lang/rust/commit/a61e13423e57380a08ea1475db57fc30cb7deb15"}], "stats": {"total": 45, "additions": 45, "deletions": 0}, "files": [{"sha": "61d5d51cfd2483720c81de0fdf36235b153501f4", "filename": "src/test/ui/sanitize/new-llvm-pass-manager-thin-lto.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/52c5f2a577bdc5181af96eb6a2f82cd502f92f20/src%2Ftest%2Fui%2Fsanitize%2Fnew-llvm-pass-manager-thin-lto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52c5f2a577bdc5181af96eb6a2f82cd502f92f20/src%2Ftest%2Fui%2Fsanitize%2Fnew-llvm-pass-manager-thin-lto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fnew-llvm-pass-manager-thin-lto.rs?ref=52c5f2a577bdc5181af96eb6a2f82cd502f92f20", "patch": "@@ -0,0 +1,27 @@\n+// Regression test for sanitizer function instrumentation passes not\n+// being run when compiling with new LLVM pass manager and ThinLTO.\n+// Note: The issue occured only on non-zero opt-level.\n+//\n+// min-llvm-version 9.0\n+// needs-sanitizer-support\n+// only-x86_64\n+//\n+// no-prefer-dynamic\n+// revisions: opt0 opt1\n+// compile-flags: -Znew-llvm-pass-manager=yes -Zsanitizer=address -Clto=thin\n+//[opt0]compile-flags: -Copt-level=0\n+//[opt1]compile-flags: -Copt-level=1\n+// run-fail\n+// error-pattern: ERROR: AddressSanitizer: stack-use-after-scope\n+\n+static mut P: *mut usize = std::ptr::null_mut();\n+\n+fn main() {\n+    unsafe {\n+        {\n+            let mut x = 0;\n+            P = &mut x;\n+        }\n+        std::ptr::write_volatile(P, 123);\n+    }\n+}"}, {"sha": "6c478f7e29da479e2078f3c995ca2c0c45710372", "filename": "src/tools/compiletest/src/header/tests.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/52c5f2a577bdc5181af96eb6a2f82cd502f92f20/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52c5f2a577bdc5181af96eb6a2f82cd502f92f20/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs?ref=52c5f2a577bdc5181af96eb6a2f82cd502f92f20", "patch": "@@ -109,6 +109,24 @@ fn no_system_llvm() {\n     assert!(parse_rs(&config, \"// no-system-llvm\").ignore);\n }\n \n+#[test]\n+fn llvm_version() {\n+    let mut config = config();\n+\n+    config.llvm_version = Some(\"8.1.2-rust\".to_owned());\n+    assert!(parse_rs(&config, \"// min-llvm-version 9.0\").ignore);\n+\n+    config.llvm_version = Some(\"9.0.1-rust-1.43.0-dev\".to_owned());\n+    assert!(parse_rs(&config, \"// min-llvm-version 9.2\").ignore);\n+\n+    config.llvm_version = Some(\"9.3.1-rust-1.43.0-dev\".to_owned());\n+    assert!(!parse_rs(&config, \"// min-llvm-version 9.2\").ignore);\n+\n+    // FIXME.\n+    // config.llvm_version = Some(\"10.0.0-rust\".to_owned());\n+    // assert!(!parse_rs(&config, \"// min-llvm-version 9.0\").ignore);\n+}\n+\n #[test]\n fn ignore_target() {\n     let mut config = config();"}]}