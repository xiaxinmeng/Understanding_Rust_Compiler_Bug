{"sha": "cb2c7bb833f439c224457442c83c3dfcba1709d6", "node_id": "C_kwDOAAsO6NoAKGNiMmM3YmI4MzNmNDM5YzIyNDQ1NzQ0MmM4M2MzZGZjYmExNzA5ZDY", "commit": {"author": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-12-21T18:30:38Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-12-21T18:32:01Z"}, "message": "Clarify that raw retags are not permitted in Mir", "tree": {"sha": "1a619b997c6dabecb9163ba7998bc069bb0363b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a619b997c6dabecb9163ba7998bc069bb0363b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb2c7bb833f439c224457442c83c3dfcba1709d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb2c7bb833f439c224457442c83c3dfcba1709d6", "html_url": "https://github.com/rust-lang/rust/commit/cb2c7bb833f439c224457442c83c3dfcba1709d6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb2c7bb833f439c224457442c83c3dfcba1709d6/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6da428f343ab811b2b132364360ba13ff05830c", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6da428f343ab811b2b132364360ba13ff05830c", "html_url": "https://github.com/rust-lang/rust/commit/d6da428f343ab811b2b132364360ba13ff05830c"}], "stats": {"total": 36, "additions": 17, "deletions": 19}, "files": [{"sha": "eb247a4cebe4b338026065ad1c7729fb503c4f49", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -9,8 +9,8 @@ use rustc_middle::mir::visit::{PlaceContext, Visitor};\n use rustc_middle::mir::{\n     traversal, AggregateKind, BasicBlock, BinOp, Body, BorrowKind, CastKind, CopyNonOverlapping,\n     Local, Location, MirPass, MirPhase, NonDivergingIntrinsic, Operand, Place, PlaceElem, PlaceRef,\n-    ProjectionElem, RuntimePhase, Rvalue, SourceScope, Statement, StatementKind, Terminator,\n-    TerminatorKind, UnOp, START_BLOCK,\n+    ProjectionElem, RetagKind, RuntimePhase, Rvalue, SourceScope, Statement, StatementKind,\n+    Terminator, TerminatorKind, UnOp, START_BLOCK,\n };\n use rustc_middle::ty::{self, InstanceDef, ParamEnv, Ty, TyCtxt, TypeVisitable};\n use rustc_mir_dataflow::impls::MaybeStorageLive;\n@@ -667,10 +667,13 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                     self.fail(location, \"`Deinit`is not allowed until deaggregation\");\n                 }\n             }\n-            StatementKind::Retag(_, _) => {\n+            StatementKind::Retag(kind, _) => {\n                 // FIXME(JakobDegen) The validator should check that `self.mir_phase <\n                 // DropsLowered`. However, this causes ICEs with generation of drop shims, which\n                 // seem to fail to set their `MirPhase` correctly.\n+                if *kind == RetagKind::Raw {\n+                    self.fail(location, \"explicit `RetagKind::Raw` is forbidden\");\n+                }\n             }\n             StatementKind::StorageLive(..)\n             | StatementKind::StorageDead(..)"}, {"sha": "bbb8148f5bc167fe6b783ff420434fcf033ac47b", "filename": "compiler/rustc_middle/src/mir/syntax.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -320,8 +320,11 @@ pub enum StatementKind<'tcx> {\n     /// <https://internals.rust-lang.org/t/stacked-borrows-an-aliasing-model-for-rust/8153/> for\n     /// more details.\n     ///\n-    /// For code that is not specific to stacked borrows, you should consider retags to read\n-    /// and modify the place in an opaque way.\n+    /// For code that is not specific to stacked borrows, you should consider retags to read and\n+    /// modify the place in an opaque way.\n+    ///\n+    /// Explicit `RetagKind::Raw` is not permitted - it is implicit as a part of\n+    /// `Rvalue::AddressOf`.\n     Retag(RetagKind, Box<Place<'tcx>>),\n \n     /// Encodes a user's type ascription. These need to be preserved"}, {"sha": "dca4906c07de54bd2042edccd8ab65a5702e44fb", "filename": "compiler/rustc_mir_build/src/build/custom/parse/instruction.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -15,9 +15,6 @@ impl<'tcx, 'body> ParseCtxt<'tcx, 'body> {\n             @call(\"mir_retag\", args) => {\n                 Ok(StatementKind::Retag(RetagKind::Default, Box::new(self.parse_place(args[0])?)))\n             },\n-            @call(\"mir_retag_raw\", args) => {\n-                Ok(StatementKind::Retag(RetagKind::Raw, Box::new(self.parse_place(args[0])?)))\n-            },\n             @call(\"mir_set_discriminant\", args) => {\n                 let place = self.parse_place(args[0])?;\n                 let var = self.parse_integer_literal(args[1])? as u32;"}, {"sha": "9e7099ddfd1e1d98756d5b7624e0da4e20eca346", "filename": "library/core/src/intrinsics/mir.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -259,7 +259,6 @@ define!(\"mir_drop\", fn Drop<T>(place: T, goto: BasicBlock));\n define!(\"mir_drop_and_replace\", fn DropAndReplace<T>(place: T, value: T, goto: BasicBlock));\n define!(\"mir_call\", fn Call<T>(place: T, goto: BasicBlock, call: T));\n define!(\"mir_retag\", fn Retag<T>(place: T));\n-define!(\"mir_retag_raw\", fn RetagRaw<T>(place: T));\n define!(\"mir_move\", fn Move<T>(place: T) -> T);\n define!(\"mir_static\", fn Static<T>(s: T) -> &'static T);\n define!(\"mir_static_mut\", fn StaticMut<T>(s: T) -> *mut T);"}, {"sha": "f5ee112623541519731735298cd5b3ef5aab3c02", "filename": "src/test/mir-opt/building/custom/references.immut_ref.built.after.mir", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.immut_ref.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.immut_ref.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.immut_ref.built.after.mir?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -6,9 +6,8 @@ fn immut_ref(_1: &i32) -> &i32 {\n \n     bb0: {\n         _2 = &raw const (*_1);           // scope 0 at $DIR/references.rs:+5:13: +5:29\n-        Retag([raw] _2);                 // scope 0 at $DIR/references.rs:+6:13: +6:24\n-        _0 = &(*_2);                     // scope 0 at $DIR/references.rs:+7:13: +7:23\n-        Retag(_0);                       // scope 0 at $DIR/references.rs:+8:13: +8:23\n-        return;                          // scope 0 at $DIR/references.rs:+9:13: +9:21\n+        _0 = &(*_2);                     // scope 0 at $DIR/references.rs:+6:13: +6:23\n+        Retag(_0);                       // scope 0 at $DIR/references.rs:+7:13: +7:23\n+        return;                          // scope 0 at $DIR/references.rs:+8:13: +8:21\n     }\n }"}, {"sha": "8e2ffc33b1a0afabb9e26ad87691060905864c31", "filename": "src/test/mir-opt/building/custom/references.mut_ref.built.after.mir", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.mut_ref.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.mut_ref.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.mut_ref.built.after.mir?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -6,9 +6,8 @@ fn mut_ref(_1: &mut i32) -> &mut i32 {\n \n     bb0: {\n         _2 = &raw mut (*_1);             // scope 0 at $DIR/references.rs:+5:13: +5:33\n-        Retag([raw] _2);                 // scope 0 at $DIR/references.rs:+6:13: +6:24\n-        _0 = &mut (*_2);                 // scope 0 at $DIR/references.rs:+7:13: +7:26\n-        Retag(_0);                       // scope 0 at $DIR/references.rs:+8:13: +8:23\n-        return;                          // scope 0 at $DIR/references.rs:+9:13: +9:21\n+        _0 = &mut (*_2);                 // scope 0 at $DIR/references.rs:+6:13: +6:26\n+        Retag(_0);                       // scope 0 at $DIR/references.rs:+7:13: +7:23\n+        return;                          // scope 0 at $DIR/references.rs:+8:13: +8:21\n     }\n }"}, {"sha": "a1c896de04cf0185e7b0a7a1fcaf32da06a8e82c", "filename": "src/test/mir-opt/building/custom/references.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cb2c7bb833f439c224457442c83c3dfcba1709d6/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb2c7bb833f439c224457442c83c3dfcba1709d6/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.rs?ref=cb2c7bb833f439c224457442c83c3dfcba1709d6", "patch": "@@ -12,7 +12,6 @@ pub fn mut_ref(x: &mut i32) -> &mut i32 {\n \n         {\n             t = addr_of_mut!(*x);\n-            RetagRaw(t);\n             RET = &mut *t;\n             Retag(RET);\n             Return()\n@@ -28,7 +27,6 @@ pub fn immut_ref(x: &i32) -> &i32 {\n \n         {\n             t = addr_of!(*x);\n-            RetagRaw(t);\n             RET = & *t;\n             Retag(RET);\n             Return()"}]}