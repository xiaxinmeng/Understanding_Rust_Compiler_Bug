{"sha": "9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjllMzUxN2Y4ZjNkYzJlZjgxNzRhNmE4ZWY5MzRkZDA5ZmE3NzhlZGM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-08-21T18:07:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-21T18:07:36Z"}, "message": "Merge #9975\n\n9975: minor: Fix panic caused by #9966 r=flodiebold a=flodiebold\n\nChalk can introduce new type variables when doing lazy normalization, so we have to do the proper 'fudging' after all.\n\nCo-authored-by: Florian Diebold <flodiebold@gmail.com>", "tree": {"sha": "d0e78f61e9d11264c4af8162d8f31dc30176934e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0e78f61e9d11264c4af8162d8f31dc30176934e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhIUDoCRBK7hj4Ov3rIwAAJL8IAH2Lm+cgmCzJ8drq5ufN6ai2\n8jBonona0xHhqXIEnlQBoVNncyNHOiS4o+hA3LCfOJ14SvIY0IENSylY7EFUndBG\nBKiZbmaeVluP9lA3I/O305yjWXGcR/gvD7e9/E6vC9kwOI4TemtqBwdT0Po9FQ3N\nNfQcwEigjjGYp3guCX3ibcugWSu00s/3wyGAxh/HXqyekvgGPibqfSWsX53eHFdo\nt3TmMnjfR0kCzmyImRUXvXrSpk8rowqGMb+oV0WCN0r/aoRUJ56ObY0aQ8at8QBb\newoEsCc7JbstjBO2TfQr3BwiGJOIin9s/U53W7knmCMl0xKmm3rwALMB+xh/E5c=\n=MDap\n-----END PGP SIGNATURE-----\n", "payload": "tree d0e78f61e9d11264c4af8162d8f31dc30176934e\nparent 337ccc75a14d65acd341afd31693a4d81f2caea6\nparent df77e2448cf85ad33d07ceddb31922a133168895\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1629569256 +0000\ncommitter GitHub <noreply@github.com> 1629569256 +0000\n\nMerge #9975\n\n9975: minor: Fix panic caused by #9966 r=flodiebold a=flodiebold\n\nChalk can introduce new type variables when doing lazy normalization, so we have to do the proper 'fudging' after all.\n\nCo-authored-by: Florian Diebold <flodiebold@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "html_url": "https://github.com/rust-lang/rust/commit/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "337ccc75a14d65acd341afd31693a4d81f2caea6", "url": "https://api.github.com/repos/rust-lang/rust/commits/337ccc75a14d65acd341afd31693a4d81f2caea6", "html_url": "https://github.com/rust-lang/rust/commit/337ccc75a14d65acd341afd31693a4d81f2caea6"}, {"sha": "df77e2448cf85ad33d07ceddb31922a133168895", "url": "https://api.github.com/repos/rust-lang/rust/commits/df77e2448cf85ad33d07ceddb31922a133168895", "html_url": "https://github.com/rust-lang/rust/commit/df77e2448cf85ad33d07ceddb31922a133168895"}], "stats": {"total": 146, "additions": 129, "deletions": 17}, "files": [{"sha": "881862e6f76286fb6a5e6736c84c1384322fb8ec", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 15, "deletions": 14, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "patch": "@@ -986,20 +986,21 @@ impl<'a> InferenceContext<'a> {\n         inputs: Vec<Ty>,\n     ) -> Vec<Ty> {\n         if let Some(expected_ty) = expected_output.to_option(&mut self.table) {\n-            let snapshot = self.table.snapshot();\n-            let result = if self.table.try_unify(&expected_ty, &output).is_ok() {\n-                // FIXME: the unification could introduce lifetime variables, which we'd need to handle here\n-                self.table.resolve_with_fallback(inputs, |var, kind, _, _| match kind {\n-                    chalk_ir::VariableKind::Ty(tk) => var.to_ty(&Interner, tk).cast(&Interner),\n-                    chalk_ir::VariableKind::Lifetime => var.to_lifetime(&Interner).cast(&Interner),\n-                    chalk_ir::VariableKind::Const(ty) => {\n-                        var.to_const(&Interner, ty).cast(&Interner)\n-                    }\n-                })\n-            } else {\n-                Vec::new()\n-            };\n-            self.table.rollback_to(snapshot);\n+            let result = self.table.fudge_inference(|table| {\n+                if table.try_unify(&expected_ty, &output).is_ok() {\n+                    table.resolve_with_fallback(inputs, |var, kind, _, _| match kind {\n+                        chalk_ir::VariableKind::Ty(tk) => var.to_ty(&Interner, tk).cast(&Interner),\n+                        chalk_ir::VariableKind::Lifetime => {\n+                            var.to_lifetime(&Interner).cast(&Interner)\n+                        }\n+                        chalk_ir::VariableKind::Const(ty) => {\n+                            var.to_const(&Interner, ty).cast(&Interner)\n+                        }\n+                    })\n+                } else {\n+                    Vec::new()\n+                }\n+            });\n             result\n         } else {\n             Vec::new()"}, {"sha": "bb87e83ca054dd2028299c771cb655f4f4d99b63", "filename": "crates/hir_ty/src/infer/unify.rs", "status": "modified", "additions": 83, "deletions": 3, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/crates%2Fhir_ty%2Fsrc%2Finfer%2Funify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/crates%2Fhir_ty%2Fsrc%2Finfer%2Funify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Funify.rs?ref=9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "patch": "@@ -11,9 +11,9 @@ use ena::unify::UnifyKey;\n \n use super::{InferOk, InferResult, InferenceContext, TypeError};\n use crate::{\n-    db::HirDatabase, fold_tys, static_lifetime, AliasEq, AliasTy, BoundVar, Canonical,\n-    DebruijnIndex, GenericArg, Goal, Guidance, InEnvironment, InferenceVar, Interner, ProjectionTy,\n-    Scalar, Solution, Substitution, TraitEnvironment, Ty, TyKind, VariableKind,\n+    db::HirDatabase, fold_tys, static_lifetime, AliasEq, AliasTy, BoundVar, Canonical, Const,\n+    DebruijnIndex, GenericArg, Goal, Guidance, InEnvironment, InferenceVar, Interner, Lifetime,\n+    ProjectionTy, Scalar, Solution, Substitution, TraitEnvironment, Ty, TyKind, VariableKind,\n };\n \n impl<'a> InferenceContext<'a> {\n@@ -273,6 +273,16 @@ impl<'a> InferenceTable<'a> {\n         self.new_var(TyVariableKind::General, true)\n     }\n \n+    pub(crate) fn new_const_var(&mut self, ty: Ty) -> Const {\n+        let var = self.var_unification_table.new_variable(UniverseIndex::ROOT);\n+        var.to_const(&Interner, ty)\n+    }\n+\n+    pub(crate) fn new_lifetime_var(&mut self) -> Lifetime {\n+        let var = self.var_unification_table.new_variable(UniverseIndex::ROOT);\n+        var.to_lifetime(&Interner)\n+    }\n+\n     pub(crate) fn resolve_with_fallback<T>(\n         &mut self,\n         t: T,\n@@ -388,6 +398,76 @@ impl<'a> InferenceTable<'a> {\n         }\n     }\n \n+    pub(crate) fn fudge_inference<T: Fold<Interner>>(\n+        &mut self,\n+        f: impl FnOnce(&mut Self) -> T,\n+    ) -> T::Result {\n+        use chalk_ir::fold::Folder;\n+        struct VarFudger<'a, 'b> {\n+            table: &'a mut InferenceTable<'b>,\n+            highest_known_var: InferenceVar,\n+        }\n+        impl<'a, 'b> Folder<'static, Interner> for VarFudger<'a, 'b> {\n+            fn as_dyn(&mut self) -> &mut dyn Folder<'static, Interner> {\n+                self\n+            }\n+\n+            fn interner(&self) -> &'static Interner {\n+                &Interner\n+            }\n+\n+            fn fold_inference_ty(\n+                &mut self,\n+                var: chalk_ir::InferenceVar,\n+                kind: TyVariableKind,\n+                _outer_binder: chalk_ir::DebruijnIndex,\n+            ) -> chalk_ir::Fallible<chalk_ir::Ty<Interner>> {\n+                Ok(if var < self.highest_known_var {\n+                    var.to_ty(&Interner, kind)\n+                } else {\n+                    self.table.new_type_var()\n+                })\n+            }\n+\n+            fn fold_inference_lifetime(\n+                &mut self,\n+                var: chalk_ir::InferenceVar,\n+                _outer_binder: chalk_ir::DebruijnIndex,\n+            ) -> chalk_ir::Fallible<chalk_ir::Lifetime<Interner>> {\n+                Ok(if var < self.highest_known_var {\n+                    var.to_lifetime(&Interner)\n+                } else {\n+                    self.table.new_lifetime_var()\n+                })\n+            }\n+\n+            fn fold_inference_const(\n+                &mut self,\n+                ty: chalk_ir::Ty<Interner>,\n+                var: chalk_ir::InferenceVar,\n+                _outer_binder: chalk_ir::DebruijnIndex,\n+            ) -> chalk_ir::Fallible<chalk_ir::Const<Interner>> {\n+                Ok(if var < self.highest_known_var {\n+                    var.to_const(&Interner, ty)\n+                } else {\n+                    self.table.new_const_var(ty)\n+                })\n+            }\n+        }\n+\n+        let snapshot = self.snapshot();\n+        let highest_known_var =\n+            self.new_type_var().inference_var(&Interner).expect(\"inference_var\");\n+        let result = f(self);\n+        self.rollback_to(snapshot);\n+\n+        let result = result\n+            .fold_with(&mut VarFudger { table: self, highest_known_var }, DebruijnIndex::INNERMOST)\n+            .expect(\"fold_with with VarFudger\");\n+\n+        result\n+    }\n+\n     /// This checks whether any of the free variables in the `canonicalized`\n     /// have changed (either been unified with another variable, or with a\n     /// value). If this is not the case, we don't need to try to solve the goal"}, {"sha": "70a1c37dc077d55e53434b5aa7e31f4d6cc480ac", "filename": "crates/hir_ty/src/tests/regression.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=9e3517f8f3dc2ef8174a6a8ef934dd09fa778edc", "patch": "@@ -1114,3 +1114,34 @@ fn test() {\n         \"#,\n     );\n }\n+\n+#[test]\n+fn coerce_diesel_panic() {\n+    check_no_mismatches(\n+        r#\"\n+//- minicore: option\n+\n+trait TypeMetadata {\n+    type MetadataLookup;\n+}\n+\n+pub struct Output<'a, T, DB>\n+where\n+    DB: TypeMetadata,\n+    DB::MetadataLookup: 'a,\n+{\n+    out: T,\n+    metadata_lookup: Option<&'a DB::MetadataLookup>,\n+}\n+\n+impl<'a, T, DB: TypeMetadata> Output<'a, T, DB> {\n+    pub fn new(out: T, metadata_lookup: &'a DB::MetadataLookup) -> Self {\n+        Output {\n+            out,\n+            metadata_lookup: Some(metadata_lookup),\n+        }\n+    }\n+}\n+        \"#,\n+    );\n+}"}]}