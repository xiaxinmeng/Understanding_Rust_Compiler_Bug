{"sha": "55cf566f041e110d5cfe39b49391dcb33f8da37b", "node_id": "C_kwDOAAsO6NoAKDU1Y2Y1NjZmMDQxZTExMGQ1Y2ZlMzliNDkzOTFkY2IzM2Y4ZGEzN2I", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-27T15:03:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-27T15:03:09Z"}, "message": "Rollup merge of #104946 - notriddle:notriddle/popover-menu-focus, r=GuillaumeGomez\n\nrustdoc: improve popover focus handling JS\n\nThis commit fixes a few inconsistencies and erratic behavior from the notable traits, settings, and sidebar popups:\n\n* It makes it so that pressing Escape closes the mobile sidebar. This is a bit difficult to do on iPhone, but on other setups like desktop tiling window managers, it's easy and makes sense.\n* It makes sure that pressing escape while a notable trait popover is open focuses the popover's toggle button, instead of leaving nothing focused, since that makes more sense with keyboard navigation. Clicking the settings, help, or sidebar buttons, however, will not focus the notable trait popover toggle button.\n* It ensures that notable trait and settings popovers are exclusive with the mobile sidebar. Nothing should ever overlap a popover, and there should never be more than one popover open at once.", "tree": {"sha": "f5d1723bfbb8ea875a13541b5d58b954ba4c445a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f5d1723bfbb8ea875a13541b5d58b954ba4c445a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55cf566f041e110d5cfe39b49391dcb33f8da37b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjg3wtCRBK7hj4Ov3rIwAAOycIAF8P/jRm4GlId0oySIM/hXuM\nXg64e4yFny9EOqKYPtTFQBLDIFgfYcw2Jpuq9AQYCUf0Sx/A68xrbHqQGHYzZ6fb\nFsnrcQ1uGdsd4Q4w40eMYoWnfRd/EploxSTUhEyj6DR/HwROAF2lBoSq43txQo7v\n99IYY48qg75xZ85OLzZJi1wIaMv2UiHxHuplTG5q8k6SjNIRAKYDqVD7Rg57gFVx\n11/2a8lXQpOOmy7HADmKnIzqOB1TzON20zxYKK/yZofqD9KX5e0w9Gvla9ugHnRk\nDp3vqJCJfrrSEnOVQx/sfNK9W+3gVIKF9+PxpfoE3/Sa1p9YbFrIJehS2FEu85E=\n=ZDYR\n-----END PGP SIGNATURE-----\n", "payload": "tree f5d1723bfbb8ea875a13541b5d58b954ba4c445a\nparent e3165a3808fe096cd0d8f9be0937fdcaa4c80383\nparent c26074afde3dbe5873874647709ccd4ce4b64813\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1669561389 +0100\ncommitter GitHub <noreply@github.com> 1669561389 +0100\n\nRollup merge of #104946 - notriddle:notriddle/popover-menu-focus, r=GuillaumeGomez\n\nrustdoc: improve popover focus handling JS\n\nThis commit fixes a few inconsistencies and erratic behavior from the notable traits, settings, and sidebar popups:\n\n* It makes it so that pressing Escape closes the mobile sidebar. This is a bit difficult to do on iPhone, but on other setups like desktop tiling window managers, it's easy and makes sense.\n* It makes sure that pressing escape while a notable trait popover is open focuses the popover's toggle button, instead of leaving nothing focused, since that makes more sense with keyboard navigation. Clicking the settings, help, or sidebar buttons, however, will not focus the notable trait popover toggle button.\n* It ensures that notable trait and settings popovers are exclusive with the mobile sidebar. Nothing should ever overlap a popover, and there should never be more than one popover open at once.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55cf566f041e110d5cfe39b49391dcb33f8da37b", "html_url": "https://github.com/rust-lang/rust/commit/55cf566f041e110d5cfe39b49391dcb33f8da37b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55cf566f041e110d5cfe39b49391dcb33f8da37b/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e3165a3808fe096cd0d8f9be0937fdcaa4c80383", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3165a3808fe096cd0d8f9be0937fdcaa4c80383", "html_url": "https://github.com/rust-lang/rust/commit/e3165a3808fe096cd0d8f9be0937fdcaa4c80383"}, {"sha": "c26074afde3dbe5873874647709ccd4ce4b64813", "url": "https://api.github.com/repos/rust-lang/rust/commits/c26074afde3dbe5873874647709ccd4ce4b64813", "html_url": "https://github.com/rust-lang/rust/commit/c26074afde3dbe5873874647709ccd4ce4b64813"}], "stats": {"total": 74, "additions": 69, "deletions": 5}, "files": [{"sha": "7230df36c075b071081e51f6f1caf4338d02e211", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=55cf566f041e110d5cfe39b49391dcb33f8da37b", "patch": "@@ -202,6 +202,7 @@ function loadCss(cssUrl) {\n         if (event.ctrlKey || event.altKey || event.metaKey) {\n             return;\n         }\n+        window.hideAllModals(false);\n         addClass(getSettingsButton(), \"rotate\");\n         event.preventDefault();\n         // Sending request for the CSS and the JS files at the same time so it will\n@@ -377,7 +378,7 @@ function loadCss(cssUrl) {\n         }\n         ev.preventDefault();\n         searchState.defocus();\n-        window.hidePopoverMenus();\n+        window.hideAllModals(true); // true = reset focus for notable traits\n     }\n \n     function handleShortcut(ev) {\n@@ -767,6 +768,7 @@ function loadCss(cssUrl) {\n     };\n \n     function showSidebar() {\n+        window.hideAllModals(false);\n         window.rustdocMobileScrollLock();\n         const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n         addClass(sidebar, \"shown\");\n@@ -843,7 +845,7 @@ function loadCss(cssUrl) {\n             // Make this function idempotent.\n             return;\n         }\n-        hideNotable(false);\n+        window.hideAllModals(false);\n         const ty = e.getAttribute(\"data-ty\");\n         const wrapper = document.createElement(\"div\");\n         wrapper.innerHTML = \"<div class=\\\"docblock\\\">\" + window.NOTABLE_TRAITS[ty] + \"</div>\";\n@@ -1049,14 +1051,24 @@ function loadCss(cssUrl) {\n         return container;\n     }\n \n+    /**\n+     * Hide popover menus, notable trait tooltips, and the sidebar (if applicable).\n+     *\n+     * Pass \"true\" to reset focus for notable traits.\n+     */\n+    window.hideAllModals = function(switchFocus) {\n+        hideSidebar();\n+        window.hidePopoverMenus();\n+        hideNotable(switchFocus);\n+    };\n+\n     /**\n      * Hide all the popover menus.\n      */\n     window.hidePopoverMenus = function() {\n         onEachLazy(document.querySelectorAll(\".search-form .popover\"), elem => {\n             elem.style.display = \"none\";\n         });\n-        hideNotable(false);\n     };\n \n     /**\n@@ -1081,7 +1093,7 @@ function loadCss(cssUrl) {\n     function showHelp() {\n         const menu = getHelpMenu(true);\n         if (menu.style.display === \"none\") {\n-            window.hidePopoverMenus();\n+            window.hideAllModals();\n             menu.style.display = \"\";\n         }\n     }"}, {"sha": "589bfc79360ce17f1bdf2d8bcb9c2026b2339e28", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=55cf566f041e110d5cfe39b49391dcb33f8da37b", "patch": "@@ -268,7 +268,7 @@\n             event.preventDefault();\n             const shouldDisplaySettings = settingsMenu.style.display === \"none\";\n \n-            window.hidePopoverMenus();\n+            window.hideAllModals();\n             if (shouldDisplaySettings) {\n                 displaySettings();\n             }"}, {"sha": "7e24af47ee8176462e051333c7b2b868bb75e9da", "filename": "src/test/rustdoc-gui/notable-trait.goml", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Ftest%2Frustdoc-gui%2Fnotable-trait.goml", "raw_url": "https://github.com/rust-lang/rust/raw/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Ftest%2Frustdoc-gui%2Fnotable-trait.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fnotable-trait.goml?ref=55cf566f041e110d5cfe39b49391dcb33f8da37b", "patch": "@@ -200,12 +200,14 @@ move-cursor-to: \"//*[@class='notable popover']\"\n assert-count: (\"//*[@class='notable popover']\", 1)\n press-key: \"Escape\"\n assert-count: (\"//*[@class='notable popover']\", 0)\n+assert: \"#method\\.create_an_iterator_from_read .notable-traits:focus\"\n \n // Check that clicking outside works.\n click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n assert-count: (\"//*[@class='notable popover']\", 1)\n click: \".search-input\"\n assert-count: (\"//*[@class='notable popover']\", 0)\n+assert-false: \"#method\\.create_an_iterator_from_read .notable-traits:focus\"\n \n // Check that pressing tab over and over works.\n click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n@@ -249,3 +251,26 @@ click: \"#settings-menu a\"\n press-key: \"Escape\"\n // We ensure we didn't come back to the previous focused item.\n assert-window-property-false: {\"scrollY\": |scroll|}\n+\n+// Opening the mobile sidebar should close the popover.\n+size: (650, 600)\n+click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n+assert-count: (\"//*[@class='notable popover']\", 1)\n+click: \".sidebar-menu-toggle\"\n+assert: \"//*[@class='sidebar shown']\"\n+assert-count: (\"//*[@class='notable popover']\", 0)\n+assert-false: \"#method\\.create_an_iterator_from_read .notable-traits:focus\"\n+// Clicking a notable popover should close the sidebar.\n+click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n+assert-count: (\"//*[@class='notable popover']\", 1)\n+assert-false: \"//*[@class='sidebar shown']\"\n+\n+// Also check the focus handling for the help button.\n+size: (1100, 600)\n+reload:\n+assert-count: (\"//*[@class='notable popover']\", 0)\n+click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n+assert-count: (\"//*[@class='notable popover']\", 1)\n+click: \"#help-button a\"\n+assert-count: (\"//*[@class='notable popover']\", 0)\n+assert-false: \"#method\\.create_an_iterator_from_read .notable-traits:focus\""}, {"sha": "c3649dc7bda20211ce124c53231a93821224ac96", "filename": "src/test/rustdoc-gui/pocket-menu.goml", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml", "raw_url": "https://github.com/rust-lang/rust/raw/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml?ref=55cf566f041e110d5cfe39b49391dcb33f8da37b", "patch": "@@ -75,3 +75,24 @@ assert-css: (\n )\n compare-elements-css: (\"#help-button .popover\", \"#help-button .top\", [\"border-color\"])\n compare-elements-css: (\"#help-button .popover\", \"#help-button .bottom\", [\"border-color\"])\n+\n+// Opening the mobile sidebar should close the settings popover.\n+size: (650, 600)\n+click: \"#settings-menu a\"\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"block\"})\n+click: \".sidebar-menu-toggle\"\n+assert: \"//*[@class='sidebar shown']\"\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"none\"})\n+// Opening the settings popover should close the sidebar.\n+click: \"#settings-menu a\"\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"block\"})\n+assert-false: \"//*[@class='sidebar shown']\"\n+\n+// Opening the settings popover at start (which async loads stuff) should also close.\n+reload:\n+click: \".sidebar-menu-toggle\"\n+assert: \"//*[@class='sidebar shown']\"\n+assert-false: \"#settings-menu .popover\"\n+click: \"#settings-menu a\"\n+assert-false: \"//*[@class='sidebar shown']\"\n+wait-for: \"#settings-menu .popover\""}, {"sha": "840091799a7787f498ede523af7ae0a8d0c9b227", "filename": "src/test/rustdoc-gui/sidebar-mobile.goml", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile.goml", "raw_url": "https://github.com/rust-lang/rust/raw/55cf566f041e110d5cfe39b49391dcb33f8da37b/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile.goml?ref=55cf566f041e110d5cfe39b49391dcb33f8da37b", "patch": "@@ -32,6 +32,12 @@ assert-css: (\"//nav[contains(@class, 'sidebar')]//h2/a[text()='In test_docs']/pa\n click: \"body\"\n assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n \n+// Open the sidebar menu, and make sure pressing Escape closes it.\n+click: \".sidebar-menu-toggle\"\n+assert-css: (\".sidebar\", {\"left\": \"0px\"})\n+press-key: \"Escape\"\n+assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n+\n // Check that the topbar is visible\n assert-property: (\".mobile-topbar\", {\"clientHeight\": \"45\"})\n "}]}