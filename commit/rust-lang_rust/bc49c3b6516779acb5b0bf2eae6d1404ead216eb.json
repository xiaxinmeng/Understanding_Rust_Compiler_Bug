{"sha": "bc49c3b6516779acb5b0bf2eae6d1404ead216eb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJjNDljM2I2NTE2Nzc5YWNiNWIwYmYyZWFlNmQxNDA0ZWFkMjE2ZWI=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-09-05T15:20:37Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-09-17T11:37:24Z"}, "message": "Allow to pass \"compiler\" arguments to doc subcommand", "tree": {"sha": "b583b73a69e08850c966dc677612c11164c42f52", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b583b73a69e08850c966dc677612c11164c42f52"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc49c3b6516779acb5b0bf2eae6d1404ead216eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc49c3b6516779acb5b0bf2eae6d1404ead216eb", "html_url": "https://github.com/rust-lang/rust/commit/bc49c3b6516779acb5b0bf2eae6d1404ead216eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc49c3b6516779acb5b0bf2eae6d1404ead216eb/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb", "url": "https://api.github.com/repos/rust-lang/rust/commits/e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb", "html_url": "https://github.com/rust-lang/rust/commit/e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb"}], "stats": {"total": 54, "additions": 44, "deletions": 10}, "files": [{"sha": "5a1593d740529595d61fcb749690e40b4e984eba", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 44, "deletions": 10, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/bc49c3b6516779acb5b0bf2eae6d1404ead216eb/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc49c3b6516779acb5b0bf2eae6d1404ead216eb/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=bc49c3b6516779acb5b0bf2eae6d1404ead216eb", "patch": "@@ -537,7 +537,7 @@ impl Step for Rustc {\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n         let builder = run.builder;\n-        run.krate(\"rustc-main\").default_condition(builder.config.docs)\n+        run.krate(\"rustc-main\").path(\"compiler\").default_condition(builder.config.docs)\n     }\n \n     fn make_run(run: RunConfig<'_>) {\n@@ -553,9 +553,24 @@ impl Step for Rustc {\n     fn run(self, builder: &Builder<'_>) {\n         let stage = self.stage;\n         let target = self.target;\n+        let mut is_explicit_request = false;\n         builder.info(&format!(\"Documenting stage{} compiler ({})\", stage, target));\n \n-        if !builder.config.compiler_docs {\n+        let paths = builder\n+            .paths\n+            .iter()\n+            .map(components_simplified)\n+            .filter_map(|path| {\n+                if path.get(0) == Some(&\"compiler\") {\n+                    is_explicit_request = true;\n+                    path.get(1).map(|p| p.to_owned())\n+                } else {\n+                    None\n+                }\n+            })\n+            .collect::<Vec<_>>();\n+\n+        if !builder.config.compiler_docs && !is_explicit_request {\n             builder.info(\"\\tskipping - compiler/librustdoc docs disabled\");\n             return;\n         }\n@@ -603,15 +618,34 @@ impl Step for Rustc {\n         cargo.rustdocflag(\"--extern-html-root-url\");\n         cargo.rustdocflag(\"ena=https://docs.rs/ena/latest/\");\n \n-        // Find dependencies for top level crates.\n         let mut compiler_crates = HashSet::new();\n-        for root_crate in &[\"rustc_driver\", \"rustc_codegen_llvm\", \"rustc_codegen_ssa\"] {\n-            compiler_crates.extend(\n-                builder\n-                    .in_tree_crates(root_crate, Some(target))\n-                    .into_iter()\n-                    .map(|krate| krate.name),\n-            );\n+\n+        if paths.is_empty() {\n+            // Find dependencies for top level crates.\n+            for root_crate in &[\"rustc_driver\", \"rustc_codegen_llvm\", \"rustc_codegen_ssa\"] {\n+                compiler_crates.extend(\n+                    builder\n+                        .in_tree_crates(root_crate, Some(target))\n+                        .into_iter()\n+                        .map(|krate| krate.name),\n+                );\n+            }\n+        } else {\n+            for root_crate in paths {\n+                if !builder.src.join(\"compiler\").join(&root_crate).exists() {\n+                    builder.info(&format!(\n+                        \"\\tskipping - compiler/{} (unknown compiler crate)\",\n+                        root_crate\n+                    ));\n+                } else {\n+                    compiler_crates.extend(\n+                        builder\n+                            .in_tree_crates(root_crate, Some(target))\n+                            .into_iter()\n+                            .map(|krate| krate.name),\n+                    );\n+                }\n+            }\n         }\n \n         for krate in &compiler_crates {"}]}