{"sha": "3585706fa28c976c1ffad197da842c85a85dbd73", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1ODU3MDZmYTI4Yzk3NmMxZmZhZDE5N2RhODQyYzg1YTg1ZGJkNzM=", "commit": {"author": {"name": "crw5996", "email": "henry11", "date": "2018-08-27T16:31:32Z"}, "committer": {"name": "crw5996", "email": "henry11", "date": "2018-08-27T17:44:56Z"}, "message": "Merge branch 'master' of https://github.com/rust-lang-nursery/rustfmt into fix-optional-arg-condensing", "tree": {"sha": "5d3fa9a7885b30ec8605e8eea26df5cd3e961dc6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d3fa9a7885b30ec8605e8eea26df5cd3e961dc6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3585706fa28c976c1ffad197da842c85a85dbd73", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3585706fa28c976c1ffad197da842c85a85dbd73", "html_url": "https://github.com/rust-lang/rust/commit/3585706fa28c976c1ffad197da842c85a85dbd73", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3585706fa28c976c1ffad197da842c85a85dbd73/comments", "author": null, "committer": null, "parents": [{"sha": "8c9a988bdc56625bd460be1b12879a0bb4b62102", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c9a988bdc56625bd460be1b12879a0bb4b62102", "html_url": "https://github.com/rust-lang/rust/commit/8c9a988bdc56625bd460be1b12879a0bb4b62102"}, {"sha": "448460958347cc633c9aea993253be076fda1580", "url": "https://api.github.com/repos/rust-lang/rust/commits/448460958347cc633c9aea993253be076fda1580", "html_url": "https://github.com/rust-lang/rust/commit/448460958347cc633c9aea993253be076fda1580"}], "stats": {"total": 758, "additions": 461, "deletions": 297}, "files": [{"sha": "2d4dcf1c601170b80a101145f763c5b7eea4739c", "filename": ".travis.yml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -41,6 +41,10 @@ matrix:\n     - env: INTEGRATION=crater\n     # Doesn't build\n     - env: INTEGRATION=futures-rs\n+    # Doesn't build - seems to be because of an option\n+    - env: INTEGRATION=packed_simd\n+    # Weird bug I can't reproduce: #2969\n+    - env: INTEGRATION=rand\n     # Test failure\n     - env: INTEGRATION=rust-clippy\n     # Build failure"}, {"sha": "9c3e4f59669594c446ab6b226eb102ff2b99b3d7", "filename": "Cargo.lock", "status": "modified", "additions": 44, "deletions": 39, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -331,7 +331,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"libc 0.2.43 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"smallvec 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"smallvec 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n@@ -401,15 +401,15 @@ dependencies = [\n \n [[package]]\n name = \"rustc-ap-arena\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n- \"rustc-ap-rustc_data_structures 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_data_structures 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"rustc-ap-rustc_cratesio_shim\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -418,75 +418,80 @@ dependencies = [\n \n [[package]]\n name = \"rustc-ap-rustc_data_structures\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"cfg-if 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"ena 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"parking_lot 0.5.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"parking_lot_core 0.2.14 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_cratesio_shim 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-serialize 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_cratesio_shim 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-serialize 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-rayon 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-rayon-core 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"smallvec 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"stable_deref_trait 1.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"rustc-ap-rustc_errors\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"atty 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_data_structures 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-serialize 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-syntax_pos 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_data_structures 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-serialize 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-syntax_pos 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"termcolor 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"unicode-width 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"rustc-ap-rustc_target\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_cratesio_shim 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-serialize 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_cratesio_shim 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-serialize 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"rustc-ap-serialize\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"smallvec 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n \n [[package]]\n name = \"rustc-ap-syntax\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_data_structures 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_errors 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_target 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-serialize 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-syntax_pos 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_data_structures 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_errors 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_target 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-serialize 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-syntax_pos 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"scoped-tls 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"smallvec 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"rustc-ap-syntax_pos\"\n-version = \"230.0.0\"\n+version = \"237.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"cfg-if 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-arena 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_data_structures 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-serialize 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-arena 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_data_structures 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-serialize 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"scoped-tls 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"unicode-width 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -527,7 +532,7 @@ dependencies = [\n \n [[package]]\n name = \"rustfmt-nightly\"\n-version = \"0.99.2\"\n+version = \"0.99.4\"\n dependencies = [\n  \"assert_cli 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"cargo_metadata 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -541,9 +546,9 @@ dependencies = [\n  \"lazy_static 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"regex 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-rustc_target 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-syntax 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustc-ap-syntax_pos 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-rustc_target 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-syntax 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-ap-syntax_pos 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde 1.0.71 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_derive 1.0.71 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_json 1.0.26 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -608,7 +613,7 @@ dependencies = [\n \n [[package]]\n name = \"smallvec\"\n-version = \"0.6.4\"\n+version = \"0.6.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -820,14 +825,14 @@ dependencies = [\n \"checksum redox_termios 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7e891cfe48e9100a70a3b6eb652fef28920c117d366339687bd5576160db0f76\"\n \"checksum regex 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5bbbea44c5490a1e84357ff28b7d518b4619a159fed5d25f6c1de2d19cc42814\"\n \"checksum regex-syntax 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"747ba3b235651f6e2f67dfa8bcdcd073ddb7c243cb21c442fc12395dfcac212d\"\n-\"checksum rustc-ap-arena 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0cfa6cc1afa6a0f100f07052ae80fadb2af6034bad7e1eedc8b9c399f8f47ff8\"\n-\"checksum rustc-ap-rustc_cratesio_shim 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"e771302cd244d9579c7ba3344415e88c56ad21eddd79356825fe022d7b2d81ab\"\n-\"checksum rustc-ap-rustc_data_structures 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"a17d0e44cd437b65748e525111f6b170f9af50a625b45b55b6ef78217d3209c0\"\n-\"checksum rustc-ap-rustc_errors 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"1553077b149a2272978e94281a8f4a457fe00fc21bb45947c406f50edb8bea72\"\n-\"checksum rustc-ap-rustc_target 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"919bf28c3d2e2f695fa6a8c3779a41275d45e02bcfec6156813bcdcc686e5a04\"\n-\"checksum rustc-ap-serialize 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"96e676167b9a4b49e33ca92a5747205082e667d9064d8bb48447b75f8695e658\"\n-\"checksum rustc-ap-syntax 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9ad8cf79b47d76743be20371ec61bee5a7c11ffbd0590939378afb9ab573501d\"\n-\"checksum rustc-ap-syntax_pos 230.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"3fd44296b68ba3b690f276dba8b5b3fe52aad24b35faa6c993d3ee31dc6b53bb\"\n+\"checksum rustc-ap-arena 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"2d24c8b3c1437fad023cb9472381216a1d41d82dbb2d2e6c7858bd6f50317719\"\n+\"checksum rustc-ap-rustc_cratesio_shim 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9c5b02c76cd1ee4e9c97c8228701796d6b7431e8f100dea2d8af1d6c2c2bad56\"\n+\"checksum rustc-ap-rustc_data_structures 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4076388154497fb9a007e3badd78e415402a5594111cd6bc7ce1420dd1b1818b\"\n+\"checksum rustc-ap-rustc_errors 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c6c11e4789cbc276ceaa87d326c234b1a2d1e0fe6017b88a8a25903200060acb\"\n+\"checksum rustc-ap-rustc_target 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"25f711bb152b9d7cdd69410cfe6d99aeb1409c959e0fdf3c8ca4d220e568aa52\"\n+\"checksum rustc-ap-serialize 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"57638db658d4942d3f30a12566836f9a67a636ed8002c8cae1c9231214e39929\"\n+\"checksum rustc-ap-syntax 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d6dbcf07abf7a9957dce8d34353d55dfb4cd882153181f24349f4690facb58f0\"\n+\"checksum rustc-ap-syntax_pos 237.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0915cb5e166cabe588a129dec2d47357077e96fb1f9b57318fbe217eac4ce508\"\n \"checksum rustc-demangle 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bcfe5b13211b4d78e5c2cadfebd7769197d95c639c35a50057eb4c05de811395\"\n \"checksum rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7540fc8b0c49f096ee9c961cda096467dce8084bec6bdca2fc83895fd9b28cb8\"\n \"checksum rustc-rayon 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"8c6d5a683c6ba4ed37959097e88d71c9e8e26659a3cb5be8b389078e7ad45306\"\n@@ -840,7 +845,7 @@ dependencies = [\n \"checksum serde 1.0.71 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6dfad05c8854584e5f72fb859385ecdfa03af69c3fd0572f0da2d4c95f060bdb\"\n \"checksum serde_derive 1.0.71 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b719c6d5e9f73fbc37892246d5852333f040caa617b8873c6aced84bcb28e7bb\"\n \"checksum serde_json 1.0.26 (registry+https://github.com/rust-lang/crates.io-index)\" = \"44dd2cfde475037451fa99b7e5df77aa3cfd1536575fa8e7a538ab36dcde49ae\"\n-\"checksum smallvec 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"211a489e65e94b103926d2054ae515a1cdb5d515ea0ef414fee23b7e043ce748\"\n+\"checksum smallvec 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"153ffa32fd170e9944f7e0838edf824a754ec4c1fc64746fcc9fe1f8fa602e5d\"\n \"checksum stable_deref_trait 1.1.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"dba1a27d3efae4351c8051072d619e3ade2820635c3958d826bfea39d59b54c8\"\n \"checksum syn 0.14.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b7bfcbb0c068d0f642a0ffbd5c604965a360a61f99e8add013cef23a838614f3\"\n \"checksum synstructure 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"85bb9b7550d063ea184027c9b8c20ac167cd36d3e06b3a40bceb9d746dc1a7b7\""}, {"sha": "6730d200b8055cc4855d419df2ec3d9b7a9d314d", "filename": "Cargo.toml", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -1,7 +1,7 @@\n [package]\n \n name = \"rustfmt-nightly\"\n-version = \"0.99.2\"\n+version = \"0.99.4\"\n authors = [\"Nicholas Cameron <ncameron@mozilla.com>\", \"The Rustfmt developers\"]\n description = \"Tool to find and fix Rust formatting issues\"\n repository = \"https://github.com/rust-lang-nursery/rustfmt\"\n@@ -47,9 +47,9 @@ env_logger = \"0.5\"\n getopts = \"0.2\"\n derive-new = \"0.5\"\n cargo_metadata = \"0.6\"\n-rustc-ap-rustc_target = \"230.0.0\"\n-rustc-ap-syntax = \"230.0.0\"\n-rustc-ap-syntax_pos = \"230.0.0\"\n+rustc-ap-rustc_target = \"237.0.0\"\n+rustc-ap-syntax = \"237.0.0\"\n+rustc-ap-syntax_pos = \"237.0.0\"\n failure = \"0.1.1\"\n \n [dev-dependencies]"}, {"sha": "f4b84e51a30b741972a45bf2e09145d6fd56dac6", "filename": "src/attr.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fattr.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -22,7 +22,7 @@ use utils::{count_newlines, mk_sp};\n \n use std::borrow::Cow;\n use syntax::ast;\n-use syntax::codemap::{BytePos, Span, DUMMY_SP};\n+use syntax::source_map::{BytePos, Span, DUMMY_SP};\n \n /// Returns attributes on the given statement.\n pub fn get_attrs_from_stmt(stmt: &ast::Stmt) -> &[ast::Attribute] {\n@@ -217,11 +217,8 @@ impl Rewrite for ast::MetaItem {\n             ast::MetaItemKind::List(ref list) => {\n                 let path = rewrite_path(context, PathContext::Type, None, &self.ident, shape)?;\n \n-                let snippet = context.snippet(self.span);\n-                // 2 = )] (this might go wrong if there is whitespace between the brackets, but\n-                // it's close enough).\n-                let snippet = snippet[..snippet.len() - 2].trim();\n-                let trailing_comma = if snippet.ends_with(',') { \",\" } else { \"\" };\n+                let has_comma = ::expr::span_ends_with_comma(context, self.span);\n+                let trailing_comma = if has_comma { \",\" } else { \"\" };\n                 let combine = list.len() == 1 && match list[0].node {\n                     ast::NestedMetaItemKind::Literal(..) => false,\n                     ast::NestedMetaItemKind::MetaItem(ref inner_meta_item) => {"}, {"sha": "760333955a054599991ed37c0a43dc0539bd1e57", "filename": "src/bin/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmain.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -160,7 +160,7 @@ fn make_opts() -> Options {\n \n fn is_nightly() -> bool {\n     option_env!(\"CFG_RELEASE_CHANNEL\")\n-        .map(|c| c == \"nightly\")\n+        .map(|c| c == \"nightly\" || c == \"dev\")\n         .unwrap_or(false)\n }\n "}, {"sha": "3f5ff75a722880916ed7b91a7d8841099a46b930", "filename": "src/chains.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fchains.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fchains.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fchains.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -65,14 +65,14 @@\n //!            .qux\n //! ```\n \n-use codemap::SpanUtils;\n use comment::rewrite_comment;\n use config::IndentStyle;\n use expr::rewrite_call;\n use lists::{extract_post_comment, extract_pre_comment, get_comment_end};\n use macros::convert_try_mac;\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use utils::{\n     first_line_width, last_line_extendable, last_line_width, mk_sp, trimmed_last_line_width,\n     wrap_str,\n@@ -82,7 +82,7 @@ use std::borrow::Cow;\n use std::cmp::min;\n use std::iter;\n \n-use syntax::codemap::{BytePos, Span};\n+use syntax::source_map::{BytePos, Span};\n use syntax::{ast, ptr};\n \n pub fn rewrite_chain(expr: &ast::Expr, context: &RewriteContext, shape: Shape) -> Option<String> {"}, {"sha": "3451fcfe6f46e729397dc94718115d34b489a63d", "filename": "src/closures.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fclosures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fclosures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fclosures.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -9,16 +9,16 @@\n // except according to those terms.\n \n use config::lists::*;\n-use syntax::codemap::Span;\n use syntax::parse::classify;\n+use syntax::source_map::Span;\n use syntax::{ast, ptr};\n \n-use codemap::SpanUtils;\n use expr::{block_contains_comment, is_simple_block, is_unsafe_block, rewrite_cond, ToExpr};\n use items::{span_hi_for_arg, span_lo_for_arg};\n use lists::{definitive_tactic, itemize_list, write_list, ListFormatting, Separator};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use utils::{last_line_width, left_most_sub_expr, stmt_expr};\n \n // This module is pretty messy because of the rules around closures and blocks:\n@@ -51,7 +51,7 @@ pub fn rewrite_closure(\n \n     if let ast::ExprKind::Block(ref block, _) = body.node {\n         // The body of the closure is an empty block.\n-        if block.stmts.is_empty() && !block_contains_comment(block, context.codemap) {\n+        if block.stmts.is_empty() && !block_contains_comment(block, context.source_map) {\n             return body\n                 .rewrite(context, shape)\n                 .map(|s| format!(\"{} {}\", prefix, s));\n@@ -114,7 +114,7 @@ fn get_inner_expr<'a>(\n fn needs_block(block: &ast::Block, prefix: &str, context: &RewriteContext) -> bool {\n     is_unsafe_block(block)\n         || block.stmts.len() > 1\n-        || block_contains_comment(block, context.codemap)\n+        || block_contains_comment(block, context.source_map)\n         || prefix.contains('\\n')\n }\n \n@@ -173,7 +173,7 @@ fn rewrite_closure_expr(\n         match expr.node {\n             ast::ExprKind::Match(..)\n             | ast::ExprKind::Block(..)\n-            | ast::ExprKind::Catch(..)\n+            | ast::ExprKind::TryBlock(..)\n             | ast::ExprKind::Loop(..)\n             | ast::ExprKind::Struct(..) => true,\n \n@@ -304,7 +304,7 @@ pub fn rewrite_last_closure(\n         let body = match body.node {\n             ast::ExprKind::Block(ref block, _)\n                 if !is_unsafe_block(block)\n-                    && is_simple_block(block, Some(&body.attrs), context.codemap) =>\n+                    && is_simple_block(block, Some(&body.attrs), context.source_map) =>\n             {\n                 stmt_expr(&block.stmts[0]).unwrap_or(body)\n             }"}, {"sha": "78d087ce7a48bdfc7581d7330c07c1169d5905cb", "filename": "src/comment.rs", "status": "modified", "additions": 58, "deletions": 32, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fcomment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fcomment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomment.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -13,7 +13,7 @@\n use std::{self, borrow::Cow, iter};\n \n use itertools::{multipeek, MultiPeek};\n-use syntax::codemap::Span;\n+use syntax::source_map::Span;\n \n use config::Config;\n use rewrite::RewriteContext;\n@@ -96,21 +96,6 @@ impl<'a> CommentStyle<'a> {\n     pub fn to_str_tuplet(&self) -> (&'a str, &'a str, &'a str) {\n         (self.opener(), self.closer(), self.line_start())\n     }\n-\n-    pub fn line_with_same_comment_style(&self, line: &str, normalize_comments: bool) -> bool {\n-        match *self {\n-            CommentStyle::DoubleSlash | CommentStyle::TripleSlash | CommentStyle::Doc => {\n-                line.trim_left().starts_with(self.line_start().trim_left())\n-                    || comment_style(line, normalize_comments) == *self\n-            }\n-            CommentStyle::DoubleBullet | CommentStyle::SingleBullet | CommentStyle::Exclamation => {\n-                line.trim_left().starts_with(self.closer().trim_left())\n-                    || line.trim_left().starts_with(self.line_start().trim_left())\n-                    || comment_style(line, normalize_comments) == *self\n-            }\n-            CommentStyle::Custom(opener) => line.trim_left().starts_with(opener.trim_right()),\n-        }\n-    }\n }\n \n fn comment_style(orig: &str, normalize_comments: bool) -> CommentStyle {\n@@ -273,19 +258,56 @@ fn identify_comment(\n     is_doc_comment: bool,\n ) -> Option<String> {\n     let style = comment_style(orig, false);\n-    let first_group = orig\n-        .lines()\n-        .take_while(|l| style.line_with_same_comment_style(l, false))\n-        .collect::<Vec<_>>()\n-        .join(\"\\n\");\n-    let rest = orig\n-        .lines()\n-        .skip(first_group.lines().count())\n-        .collect::<Vec<_>>()\n-        .join(\"\\n\");\n+    let mut first_group_ending = 0;\n \n+    fn compute_len(orig: &str, line: &str) -> usize {\n+        if orig.len() > line.len() {\n+            if orig.as_bytes()[line.len()] == b'\\r' {\n+                line.len() + 2\n+            } else {\n+                line.len() + 1\n+            }\n+        } else {\n+            line.len()\n+        }\n+    }\n+\n+    match style {\n+        CommentStyle::DoubleSlash | CommentStyle::TripleSlash | CommentStyle::Doc => {\n+            let line_start = style.line_start().trim_left();\n+            for line in orig.lines() {\n+                if line.trim_left().starts_with(line_start) || comment_style(line, false) == style {\n+                    first_group_ending += compute_len(&orig[first_group_ending..], line);\n+                } else {\n+                    break;\n+                }\n+            }\n+        }\n+        CommentStyle::Custom(opener) => {\n+            let trimmed_opener = opener.trim_right();\n+            for line in orig.lines() {\n+                if line.trim_left().starts_with(trimmed_opener) {\n+                    first_group_ending += compute_len(&orig[first_group_ending..], line);\n+                } else {\n+                    break;\n+                }\n+            }\n+        }\n+        // for a block comment, search for the closing symbol\n+        CommentStyle::DoubleBullet | CommentStyle::SingleBullet | CommentStyle::Exclamation => {\n+            let closer = style.closer().trim_left();\n+            for line in orig.lines() {\n+                first_group_ending += compute_len(&orig[first_group_ending..], line);\n+                if line.trim_left().ends_with(closer) {\n+                    break;\n+                }\n+            }\n+        }\n+    }\n+\n+    let (first_group, rest) = orig.split_at(first_group_ending);\n     let first_group_str = rewrite_comment_inner(\n-        &first_group,\n+        first_group,\n         block_style,\n         style,\n         shape,\n@@ -295,7 +317,7 @@ fn identify_comment(\n     if rest.is_empty() {\n         Some(first_group_str)\n     } else {\n-        identify_comment(&rest, block_style, shape, config, is_doc_comment).map(|rest_str| {\n+        identify_comment(rest, block_style, shape, config, is_doc_comment).map(|rest_str| {\n             format!(\n                 \"{}\\n{}{}\",\n                 first_group_str,\n@@ -427,8 +449,12 @@ fn rewrite_comment_inner(\n                 }\n             } else if is_prev_line_multi_line && !line.is_empty() {\n                 result.push(' ')\n-            } else if is_last && !closer.is_empty() && line.is_empty() {\n-                result.push_str(&indent_str);\n+            } else if is_last && line.is_empty() {\n+                // trailing blank lines are unwanted\n+                if !closer.is_empty() {\n+                    result.push_str(&indent_str);\n+                }\n+                break;\n             } else {\n                 result.push_str(&comment_line_separator);\n                 if !has_leading_whitespace && result.ends_with(' ') {\n@@ -1125,10 +1151,10 @@ pub fn recover_comment_removed(\n         // We missed some comments. Warn and keep the original text.\n         if context.config.error_on_unformatted() {\n             context.report.append(\n-                context.codemap.span_to_filename(span).into(),\n+                context.source_map.span_to_filename(span).into(),\n                 vec![FormattingError::from_span(\n                     &span,\n-                    &context.codemap,\n+                    &context.source_map,\n                     ErrorKind::LostComment,\n                 )],\n             );"}, {"sha": "aea19b34375ca8b8ff707b2004738eff3cf28531", "filename": "src/config/config_type.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fconfig%2Fconfig_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fconfig%2Fconfig_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig%2Fconfig_type.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -73,7 +73,7 @@ impl ConfigType for IgnoreList {\n macro_rules! is_nightly_channel {\n     () => {\n         option_env!(\"CFG_RELEASE_CHANNEL\")\n-            .map(|c| c == \"nightly\")\n+            .map(|c| c == \"nightly\" || c == \"dev\")\n             .unwrap_or(true)\n     };\n }"}, {"sha": "e113118c64303dd2cf00090da70a3c6ebc301079", "filename": "src/config/file_lines.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fconfig%2Ffile_lines.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fconfig%2Ffile_lines.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig%2Ffile_lines.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -19,11 +19,11 @@ use serde::de::{Deserialize, Deserializer};\n use serde::ser::{self, Serialize, Serializer};\n use serde_json as json;\n \n-use syntax::codemap::{self, FileMap};\n+use syntax::source_map::{self, SourceFile};\n \n /// A range of lines in a file, inclusive of both ends.\n pub struct LineRange {\n-    pub file: Rc<FileMap>,\n+    pub file: Rc<SourceFile>,\n     pub lo: usize,\n     pub hi: usize,\n }\n@@ -35,11 +35,11 @@ pub enum FileName {\n     Stdin,\n }\n \n-impl From<codemap::FileName> for FileName {\n-    fn from(name: codemap::FileName) -> FileName {\n+impl From<source_map::FileName> for FileName {\n+    fn from(name: source_map::FileName) -> FileName {\n         match name {\n-            codemap::FileName::Real(p) => FileName::Real(p),\n-            codemap::FileName::Custom(ref f) if f == \"stdin\" => FileName::Stdin,\n+            source_map::FileName::Real(p) => FileName::Real(p),\n+            source_map::FileName::Custom(ref f) if f == \"stdin\" => FileName::Stdin,\n             _ => unreachable!(),\n         }\n     }\n@@ -386,7 +386,7 @@ mod test {\n         );\n     }\n \n-    use super::json::{self, json, json_internal};\n+    use super::json::{self, json};\n     use super::{FileLines, FileName};\n     use std::{collections::HashMap, path::PathBuf};\n "}, {"sha": "74639c6ef63d61e9001e7fb45205c6e9a16d377a", "filename": "src/expr.rs", "status": "modified", "additions": 26, "deletions": 27, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -12,13 +12,12 @@ use std::borrow::Cow;\n use std::cmp::min;\n \n use config::lists::*;\n-use syntax::codemap::{BytePos, CodeMap, Span};\n use syntax::parse::token::DelimToken;\n+use syntax::source_map::{BytePos, SourceMap, Span};\n use syntax::{ast, ptr};\n \n use chains::rewrite_chain;\n use closures;\n-use codemap::{LineRangeUtils, SpanUtils};\n use comment::{\n     combine_strs_with_missing_comments, contains_comment, recover_comment_removed, rewrite_comment,\n     rewrite_missing_comment, CharClasses, FindUncommented,\n@@ -35,6 +34,7 @@ use pairs::{rewrite_all_pairs, rewrite_pair, PairParts};\n use patterns::{can_be_overflowed_pat, is_short_pattern, TuplePatField};\n use rewrite::{Rewrite, RewriteContext};\n use shape::{Indent, Shape};\n+use source_map::{LineRangeUtils, SpanUtils};\n use spanned::Spanned;\n use string::{rewrite_string, StringFormat};\n use types::{can_be_overflowed_type, rewrite_path, PathContext};\n@@ -317,22 +317,17 @@ pub fn format_expr(\n         // We do not format these expressions yet, but they should still\n         // satisfy our width restrictions.\n         ast::ExprKind::InlineAsm(..) => Some(context.snippet(expr.span).to_owned()),\n-        ast::ExprKind::Catch(ref block) => {\n-            if let rw @ Some(_) = rewrite_single_line_block(\n-                context,\n-                \"do catch \",\n-                block,\n-                Some(&expr.attrs),\n-                None,\n-                shape,\n-            ) {\n+        ast::ExprKind::TryBlock(ref block) => {\n+            if let rw @ Some(_) =\n+                rewrite_single_line_block(context, \"try \", block, Some(&expr.attrs), None, shape)\n+            {\n                 rw\n             } else {\n-                // 9 = `do catch `\n+                // 9 = `try `\n                 let budget = shape.width.saturating_sub(9);\n                 Some(format!(\n                     \"{}{}\",\n-                    \"do catch \",\n+                    \"try \",\n                     rewrite_block(\n                         block,\n                         Some(&expr.attrs),\n@@ -343,8 +338,10 @@ pub fn format_expr(\n                 ))\n             }\n         }\n-        // FIXME(#2743)\n-        ast::ExprKind::ObsoleteInPlace(..) => unimplemented!(),\n+        ast::ExprKind::ObsoleteInPlace(ref lhs, ref rhs) => lhs\n+            .rewrite(context, shape)\n+            .map(|s| s + \" <-\")\n+            .and_then(|lhs| rewrite_assign_rhs(context, lhs, &**rhs, shape)),\n         ast::ExprKind::Async(capture_by, _node_id, ref block) => {\n             let mover = if capture_by == ast::CaptureBy::Value {\n                 \"move \"\n@@ -425,7 +422,9 @@ fn rewrite_empty_block(\n         return None;\n     }\n \n-    if block.stmts.is_empty() && !block_contains_comment(block, context.codemap) && shape.width >= 2\n+    if block.stmts.is_empty()\n+        && !block_contains_comment(block, context.source_map)\n+        && shape.width >= 2\n     {\n         return Some(format!(\"{}{}{{}}\", prefix, label_str));\n     }\n@@ -483,7 +482,7 @@ fn rewrite_single_line_block(\n     label: Option<ast::Label>,\n     shape: Shape,\n ) -> Option<String> {\n-    if is_simple_block(block, attrs, context.codemap) {\n+    if is_simple_block(block, attrs, context.source_map) {\n         let expr_shape = shape.offset_left(last_line_width(prefix))?;\n         let expr_str = block.stmts[0].rewrite(context, expr_shape)?;\n         let label_str = rewrite_label(label);\n@@ -769,8 +768,8 @@ impl<'a> ControlFlow<'a> {\n         let fixed_cost = self.keyword.len() + \"  {  } else {  }\".len();\n \n         if let ast::ExprKind::Block(ref else_node, _) = else_block.node {\n-            if !is_simple_block(self.block, None, context.codemap)\n-                || !is_simple_block(else_node, None, context.codemap)\n+            if !is_simple_block(self.block, None, context.source_map)\n+                || !is_simple_block(else_node, None, context.source_map)\n                 || pat_expr_str.contains('\\n')\n             {\n                 return None;\n@@ -1113,8 +1112,8 @@ fn extract_comment(span: Span, context: &RewriteContext, shape: Shape) -> Option\n     }\n }\n \n-pub fn block_contains_comment(block: &ast::Block, codemap: &CodeMap) -> bool {\n-    let snippet = codemap.span_to_snippet(block.span).unwrap();\n+pub fn block_contains_comment(block: &ast::Block, source_map: &SourceMap) -> bool {\n+    let snippet = source_map.span_to_snippet(block.span).unwrap();\n     contains_comment(&snippet)\n }\n \n@@ -1125,11 +1124,11 @@ pub fn block_contains_comment(block: &ast::Block, codemap: &CodeMap) -> bool {\n pub fn is_simple_block(\n     block: &ast::Block,\n     attrs: Option<&[ast::Attribute]>,\n-    codemap: &CodeMap,\n+    source_map: &SourceMap,\n ) -> bool {\n     (block.stmts.len() == 1\n         && stmt_is_expr(&block.stmts[0])\n-        && !block_contains_comment(block, codemap)\n+        && !block_contains_comment(block, source_map)\n         && attrs.map_or(true, |a| a.is_empty()))\n }\n \n@@ -1138,10 +1137,10 @@ pub fn is_simple_block(\n pub fn is_simple_block_stmt(\n     block: &ast::Block,\n     attrs: Option<&[ast::Attribute]>,\n-    codemap: &CodeMap,\n+    source_map: &SourceMap,\n ) -> bool {\n     block.stmts.len() <= 1\n-        && !block_contains_comment(block, codemap)\n+        && !block_contains_comment(block, source_map)\n         && attrs.map_or(true, |a| a.is_empty())\n }\n \n@@ -1150,10 +1149,10 @@ pub fn is_simple_block_stmt(\n pub fn is_empty_block(\n     block: &ast::Block,\n     attrs: Option<&[ast::Attribute]>,\n-    codemap: &CodeMap,\n+    source_map: &SourceMap,\n ) -> bool {\n     block.stmts.is_empty()\n-        && !block_contains_comment(block, codemap)\n+        && !block_contains_comment(block, source_map)\n         && attrs.map_or(true, |a| inner_attributes(a).is_empty())\n }\n "}, {"sha": "3012837ba640ea83af3829f90e466467948464f2", "filename": "src/formatting.rs", "status": "modified", "additions": 38, "deletions": 34, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fformatting.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -7,19 +7,19 @@ use std::rc::Rc;\n use std::time::{Duration, Instant};\n \n use syntax::ast;\n-use syntax::codemap::{CodeMap, FilePathMapping, Span};\n use syntax::errors::emitter::{ColorConfig, EmitterWriter};\n use syntax::errors::Handler;\n use syntax::parse::{self, ParseSess};\n+use syntax::source_map::{FilePathMapping, SourceMap, Span};\n \n use comment::{CharClasses, FullCodeCharKind};\n use config::{Config, FileName, Verbosity};\n use issues::BadIssueSeeker;\n use visitor::{FmtVisitor, SnippetProvider};\n-use {filemap, modules, ErrorKind, FormatReport, Input, Session};\n+use {modules, source_file, ErrorKind, FormatReport, Input, Session};\n \n // A map of the files of a crate, with their new content\n-pub(crate) type FileMap = Vec<FileRecord>;\n+pub(crate) type SourceFile = Vec<FileRecord>;\n pub(crate) type FileRecord = (FileName, String);\n \n impl<'b, T: Write + 'b> Session<'b, T> {\n@@ -70,30 +70,30 @@ fn format_project<T: FormatHandler>(\n     let input_is_stdin = main_file == FileName::Stdin;\n \n     // Parse the crate.\n-    let codemap = Rc::new(CodeMap::new(FilePathMapping::empty()));\n-    let mut parse_session = make_parse_sess(codemap.clone(), config);\n+    let source_map = Rc::new(SourceMap::new(FilePathMapping::empty()));\n+    let mut parse_session = make_parse_sess(source_map.clone(), config);\n     let mut report = FormatReport::new();\n     let krate = parse_crate(input, &parse_session, config, &mut report)?;\n     timer = timer.done_parsing();\n \n     // Suppress error output if we have to do any further parsing.\n-    let silent_emitter = silent_emitter(codemap);\n+    let silent_emitter = silent_emitter(source_map);\n     parse_session.span_diagnostic = Handler::with_emitter(true, false, silent_emitter);\n \n     let mut context = FormatContext::new(&krate, report, parse_session, config, handler);\n \n-    let files = modules::list_files(&krate, context.parse_session.codemap())?;\n+    let files = modules::list_files(&krate, context.parse_session.source_map())?;\n     for (path, module) in files {\n         if (config.skip_children() && path != main_file) || config.ignore().skip_file(&path) {\n             continue;\n         }\n-        should_emit_verbose(!input_is_stdin, config, || println!(\"Formatting {}\", path));\n+        should_emit_verbose(input_is_stdin, config, || println!(\"Formatting {}\", path));\n         let is_root = path == main_file;\n         context.format_file(path, module, is_root)?;\n     }\n     timer = timer.done_formatting();\n \n-    should_emit_verbose(!input_is_stdin, config, || {\n+    should_emit_verbose(input_is_stdin, config, || {\n         println!(\n             \"Spent {0:.3} secs in the parsing phase, and {1:.3} secs in the formatting phase\",\n             timer.get_parse_time(),\n@@ -122,14 +122,14 @@ impl<'a, T: FormatHandler + 'a> FormatContext<'a, T> {\n         module: &ast::Mod,\n         is_root: bool,\n     ) -> Result<(), ErrorKind> {\n-        let filemap = self\n+        let source_file = self\n             .parse_session\n-            .codemap()\n+            .source_map()\n             .lookup_char_pos(module.inner.lo())\n             .file;\n-        let big_snippet = filemap.src.as_ref().unwrap();\n-        let snippet_provider = SnippetProvider::new(filemap.start_pos, big_snippet);\n-        let mut visitor = FmtVisitor::from_codemap(\n+        let big_snippet = source_file.src.as_ref().unwrap();\n+        let snippet_provider = SnippetProvider::new(source_file.start_pos, big_snippet);\n+        let mut visitor = FmtVisitor::from_source_map(\n             &self.parse_session,\n             &self.config,\n             &snippet_provider,\n@@ -138,26 +138,26 @@ impl<'a, T: FormatHandler + 'a> FormatContext<'a, T> {\n \n         // Format inner attributes if available.\n         if !self.krate.attrs.is_empty() && is_root {\n-            visitor.skip_empty_lines(filemap.end_pos);\n+            visitor.skip_empty_lines(source_file.end_pos);\n             if visitor.visit_attrs(&self.krate.attrs, ast::AttrStyle::Inner) {\n                 visitor.push_rewrite(module.inner, None);\n             } else {\n-                visitor.format_separate_mod(module, &*filemap);\n+                visitor.format_separate_mod(module, &*source_file);\n             }\n         } else {\n-            visitor.last_pos = filemap.start_pos;\n-            visitor.skip_empty_lines(filemap.end_pos);\n-            visitor.format_separate_mod(module, &*filemap);\n+            visitor.last_pos = source_file.start_pos;\n+            visitor.skip_empty_lines(source_file.end_pos);\n+            visitor.format_separate_mod(module, &*source_file);\n         };\n \n         debug_assert_eq!(\n             visitor.line_number,\n             ::utils::count_newlines(&visitor.buffer)\n         );\n \n-        // For some reason, the codemap does not include terminating\n+        // For some reason, the source_map does not include terminating\n         // newlines so we must add one on for each file. This is sad.\n-        filemap::append_newline(&mut visitor.buffer);\n+        source_file::append_newline(&mut visitor.buffer);\n \n         format_lines(\n             &mut visitor.buffer,\n@@ -198,7 +198,7 @@ impl<'b, T: Write + 'b> FormatHandler for Session<'b, T> {\n         report: &mut FormatReport,\n     ) -> Result<(), ErrorKind> {\n         if let Some(ref mut out) = self.out {\n-            match filemap::write_file(&mut result, &path, out, &self.config) {\n+            match source_file::write_file(&mut result, &path, out, &self.config) {\n                 Ok(b) if b => report.add_diff(),\n                 Err(e) => {\n                     // Create a new error with path_str to help users see which files failed\n@@ -209,7 +209,7 @@ impl<'b, T: Write + 'b> FormatHandler for Session<'b, T> {\n             }\n         }\n \n-        self.filemap.push((path, result));\n+        self.source_file.push((path, result));\n         Ok(())\n     }\n }\n@@ -223,13 +223,17 @@ pub(crate) struct FormattingError {\n }\n \n impl FormattingError {\n-    pub(crate) fn from_span(span: &Span, codemap: &CodeMap, kind: ErrorKind) -> FormattingError {\n+    pub(crate) fn from_span(\n+        span: &Span,\n+        source_map: &SourceMap,\n+        kind: ErrorKind,\n+    ) -> FormattingError {\n         FormattingError {\n-            line: codemap.lookup_char_pos(span.lo()).line,\n+            line: source_map.lookup_char_pos(span.lo()).line,\n             is_comment: kind.is_comment(),\n             kind,\n             is_string: false,\n-            line_buffer: codemap\n+            line_buffer: source_map\n                 .span_to_lines(*span)\n                 .ok()\n                 .and_then(|fl| {\n@@ -587,7 +591,7 @@ fn parse_crate(\n         Input::File(file) => parse::new_parser_from_file(parse_session, &file),\n         Input::Text(text) => parse::new_parser_from_source_str(\n             parse_session,\n-            syntax::codemap::FileName::Custom(\"stdin\".to_owned()),\n+            syntax::source_map::FileName::Custom(\"stdin\".to_owned()),\n             text,\n         ),\n     };\n@@ -611,7 +615,7 @@ fn parse_crate(\n             // Note that if you see this message and want more information,\n             // then run the `parse_crate_mod` function above without\n             // `catch_unwind` so rustfmt panics and you can get a backtrace.\n-            should_emit_verbose(!input_is_stdin, config, || {\n+            should_emit_verbose(input_is_stdin, config, || {\n                 println!(\"The Rust parser panicked\")\n             });\n         }\n@@ -621,18 +625,18 @@ fn parse_crate(\n     Err(ErrorKind::ParseError)\n }\n \n-fn silent_emitter(codemap: Rc<CodeMap>) -> Box<EmitterWriter> {\n+fn silent_emitter(source_map: Rc<SourceMap>) -> Box<EmitterWriter> {\n     Box::new(EmitterWriter::new(\n         Box::new(Vec::new()),\n-        Some(codemap),\n+        Some(source_map),\n         false,\n         false,\n     ))\n }\n \n-fn make_parse_sess(codemap: Rc<CodeMap>, config: &Config) -> ParseSess {\n+fn make_parse_sess(source_map: Rc<SourceMap>, config: &Config) -> ParseSess {\n     let tty_handler = if config.hide_parse_errors() {\n-        let silent_emitter = silent_emitter(codemap.clone());\n+        let silent_emitter = silent_emitter(source_map.clone());\n         Handler::with_emitter(true, false, silent_emitter)\n     } else {\n         let supports_color = term::stderr().map_or(false, |term| term.supports_color());\n@@ -641,10 +645,10 @@ fn make_parse_sess(codemap: Rc<CodeMap>, config: &Config) -> ParseSess {\n         } else {\n             ColorConfig::Never\n         };\n-        Handler::with_tty_emitter(color_cfg, true, false, Some(codemap.clone()))\n+        Handler::with_tty_emitter(color_cfg, true, false, Some(source_map.clone()))\n     };\n \n-    ParseSess::with_span_handler(tty_handler, codemap)\n+    ParseSess::with_span_handler(tty_handler, source_map)\n }\n \n fn should_emit_verbose<F>(is_stdin: bool, config: &Config, f: F)"}, {"sha": "b3408bf7bf26a4103c876ccd953d5f0c7e04ad98", "filename": "src/imports.rs", "status": "modified", "additions": 18, "deletions": 20, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fimports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fimports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fimports.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -12,14 +12,14 @@ use std::cmp::Ordering;\n \n use config::lists::*;\n use syntax::ast::{self, UseTreeKind};\n-use syntax::codemap::{self, BytePos, Span, DUMMY_SP};\n+use syntax::source_map::{self, BytePos, Span, DUMMY_SP};\n \n-use codemap::SpanUtils;\n use comment::combine_strs_with_missing_comments;\n use config::IndentStyle;\n use lists::{definitive_tactic, itemize_list, write_list, ListFormatting, ListItem, Separator};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use utils::{is_same_visibility, mk_sp, rewrite_ident};\n use visitor::FmtVisitor;\n@@ -149,12 +149,10 @@ impl UseSegment {\n         if name.is_empty() || name == \"{{root}}\" {\n             return None;\n         }\n-        Some(if name == \"self\" {\n-            UseSegment::Slf(None)\n-        } else if name == \"super\" {\n-            UseSegment::Super(None)\n-        } else {\n-            UseSegment::Ident((*name).to_owned(), None)\n+        Some(match name {\n+            \"self\" => UseSegment::Slf(None),\n+            \"super\" => UseSegment::Super(None),\n+            _ => UseSegment::Ident((*name).to_owned(), None),\n         })\n     }\n }\n@@ -350,19 +348,19 @@ impl UseTree {\n             UseTreeKind::Simple(ref rename, ..) => {\n                 let name = rewrite_ident(context, path_to_imported_ident(&a.prefix)).to_owned();\n                 let alias = rename.and_then(|ident| {\n-                    if ident == path_to_imported_ident(&a.prefix) {\n+                    if ident.name == \"_\" {\n+                        // for impl-only-use\n+                        Some(\"_\".to_owned())\n+                    } else if ident == path_to_imported_ident(&a.prefix) {\n                         None\n                     } else {\n                         Some(rewrite_ident(context, ident).to_owned())\n                     }\n                 });\n-\n-                let segment = if &name == \"self\" {\n-                    UseSegment::Slf(alias)\n-                } else if &name == \"super\" {\n-                    UseSegment::Super(alias)\n-                } else {\n-                    UseSegment::Ident(name, alias)\n+                let segment = match name.as_ref() {\n+                    \"self\" => UseSegment::Slf(alias),\n+                    \"super\" => UseSegment::Super(alias),\n+                    _ => UseSegment::Ident(name, alias),\n                 };\n \n                 // `name` is already in result.\n@@ -470,15 +468,15 @@ impl UseTree {\n     fn same_visibility(&self, other: &UseTree) -> bool {\n         match (&self.visibility, &other.visibility) {\n             (\n-                Some(codemap::Spanned {\n+                Some(source_map::Spanned {\n                     node: ast::VisibilityKind::Inherited,\n                     ..\n                 }),\n                 None,\n             )\n             | (\n                 None,\n-                Some(codemap::Spanned {\n+                Some(source_map::Spanned {\n                     node: ast::VisibilityKind::Inherited,\n                     ..\n                 }),\n@@ -746,7 +744,7 @@ fn rewrite_nested_use_tree(\n \n impl Rewrite for UseSegment {\n     fn rewrite(&self, context: &RewriteContext, shape: Shape) -> Option<String> {\n-        Some(match *self {\n+        Some(match self {\n             UseSegment::Ident(ref ident, Some(ref rename)) => format!(\"{} as {}\", ident, rename),\n             UseSegment::Ident(ref ident, None) => ident.clone(),\n             UseSegment::Slf(Some(ref rename)) => format!(\"self as {}\", rename),\n@@ -785,7 +783,7 @@ impl Rewrite for UseTree {\n #[cfg(test)]\n mod test {\n     use super::*;\n-    use syntax::codemap::DUMMY_SP;\n+    use syntax::source_map::DUMMY_SP;\n \n     // Parse the path part of an import. This parser is not robust and is only\n     // suitable for use in a test harness."}, {"sha": "ff635137e42d671e61ef323b0ab5411b440c6d29", "filename": "src/items.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -16,11 +16,10 @@ use std::cmp::{min, Ordering};\n use config::lists::*;\n use regex::Regex;\n use rustc_target::spec::abi;\n-use syntax::codemap::{self, BytePos, Span};\n+use syntax::source_map::{self, BytePos, Span};\n use syntax::visit;\n use syntax::{ast, ptr, symbol};\n \n-use codemap::{LineRangeUtils, SpanUtils};\n use comment::{\n     combine_strs_with_missing_comments, contains_comment, recover_comment_removed,\n     recover_missing_comment_in_span, rewrite_missing_comment, FindUncommented,\n@@ -35,14 +34,15 @@ use macros::{rewrite_macro, MacroPosition};\n use overflow;\n use rewrite::{Rewrite, RewriteContext};\n use shape::{Indent, Shape};\n+use source_map::{LineRangeUtils, SpanUtils};\n use spanned::Spanned;\n use utils::*;\n use vertical::rewrite_with_alignment;\n use visitor::FmtVisitor;\n \n-const DEFAULT_VISIBILITY: ast::Visibility = codemap::Spanned {\n+const DEFAULT_VISIBILITY: ast::Visibility = source_map::Spanned {\n     node: ast::VisibilityKind::Inherited,\n-    span: codemap::DUMMY_SP,\n+    span: source_map::DUMMY_SP,\n };\n \n fn type_annotation_separator(config: &Config) -> &str {\n@@ -380,16 +380,16 @@ impl<'a> FmtVisitor<'a> {\n             return None;\n         }\n \n-        let codemap = self.get_context().codemap;\n+        let source_map = self.get_context().source_map;\n \n         if self.config.empty_item_single_line()\n-            && is_empty_block(block, None, codemap)\n+            && is_empty_block(block, None, source_map)\n             && self.block_indent.width() + fn_str.len() + 2 <= self.config.max_width()\n         {\n             return Some(format!(\"{}{{}}\", fn_str));\n         }\n \n-        if self.config.fn_single_line() && is_simple_block_stmt(block, None, codemap) {\n+        if self.config.fn_single_line() && is_simple_block_stmt(block, None, source_map) {\n             let rewrite = {\n                 if let Some(stmt) = block.stmts.first() {\n                     match stmt_expr(stmt) {"}, {"sha": "7ebb967a494ce9ca11cf59dcf193110fc1539d9c", "filename": "src/lib.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -8,7 +8,6 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(tool_attributes)]\n #![feature(decl_macro)]\n #![allow(unused_attributes)]\n #![feature(type_ascription)]\n@@ -49,7 +48,7 @@ use syntax::ast;\n \n use comment::LineClasses;\n use failure::Fail;\n-use formatting::{FileMap, FormatErrorMap, FormattingError, ReportedErrors};\n+use formatting::{FormatErrorMap, FormattingError, ReportedErrors, SourceFile};\n use issues::Issue;\n use shape::Indent;\n \n@@ -65,11 +64,9 @@ mod attr;\n mod chains;\n pub(crate) mod checkstyle;\n mod closures;\n-pub(crate) mod codemap;\n mod comment;\n pub(crate) mod config;\n mod expr;\n-pub(crate) mod filemap;\n pub(crate) mod formatting;\n mod imports;\n mod issues;\n@@ -86,6 +83,8 @@ mod reorder;\n mod rewrite;\n pub(crate) mod rustfmt_diff;\n mod shape;\n+pub(crate) mod source_file;\n+pub(crate) mod source_map;\n mod spanned;\n mod string;\n #[cfg(test)]\n@@ -459,7 +458,7 @@ pub struct Session<'b, T: Write + 'b> {\n     pub config: Config,\n     pub out: Option<&'b mut T>,\n     pub(crate) errors: ReportedErrors,\n-    filemap: FileMap,\n+    source_file: SourceFile,\n }\n \n impl<'b, T: Write + 'b> Session<'b, T> {\n@@ -472,7 +471,7 @@ impl<'b, T: Write + 'b> Session<'b, T> {\n             config,\n             out,\n             errors: ReportedErrors::default(),\n-            filemap: FileMap::new(),\n+            source_file: SourceFile::new(),\n         }\n     }\n "}, {"sha": "9b65fdbd1da75c8b6044e3253afa2f04012e17f0", "filename": "src/lists.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Flists.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Flists.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flists.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -14,7 +14,7 @@ use std::cmp;\n use std::iter::Peekable;\n \n use config::lists::*;\n-use syntax::codemap::BytePos;\n+use syntax::source_map::BytePos;\n \n use comment::{find_comment_end, rewrite_comment, FindUncommented};\n use config::{Config, IndentStyle};"}, {"sha": "e8e0f1b572e210d4d16c7c6aebd4af3db965c482", "filename": "src/macros.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -22,17 +22,16 @@\n use std::collections::HashMap;\n \n use config::lists::*;\n-use syntax::codemap::{BytePos, Span};\n use syntax::parse::new_parser_from_tts;\n use syntax::parse::parser::Parser;\n use syntax::parse::token::{BinOpToken, DelimToken, Token};\n use syntax::print::pprust;\n+use syntax::source_map::{BytePos, Span};\n use syntax::symbol;\n use syntax::tokenstream::{Cursor, ThinTokenStream, TokenStream, TokenTree};\n use syntax::ThinVec;\n use syntax::{ast, ptr};\n \n-use codemap::SpanUtils;\n use comment::{\n     contains_comment, remove_trailing_white_spaces, CharClasses, FindUncommented, FullCodeCharKind,\n     LineClasses,\n@@ -42,6 +41,7 @@ use lists::{itemize_list, write_list, ListFormatting};\n use overflow;\n use rewrite::{Rewrite, RewriteContext};\n use shape::{Indent, Shape};\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use utils::{format_visibility, mk_sp, rewrite_ident, wrap_str};\n "}, {"sha": "231112edb1e1a0600870947349cdd5fbabe4cd9b", "filename": "src/matches.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmatches.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -13,10 +13,9 @@\n use std::iter::repeat;\n \n use config::lists::*;\n-use syntax::codemap::{BytePos, Span};\n+use syntax::source_map::{BytePos, Span};\n use syntax::{ast, ptr};\n \n-use codemap::SpanUtils;\n use comment::{combine_strs_with_missing_comments, rewrite_comment};\n use config::{Config, ControlBraceStyle, IndentStyle};\n use expr::{\n@@ -26,6 +25,7 @@ use expr::{\n use lists::{itemize_list, write_list, ListFormatting};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use utils::{\n     contains_skip, extra_offset, first_line_width, inner_attributes, last_line_extendable, mk_sp,\n@@ -302,7 +302,7 @@ fn block_can_be_flattened<'a>(\n     match expr.node {\n         ast::ExprKind::Block(ref block, _)\n             if !is_unsafe_block(block)\n-                && is_simple_block(block, Some(&expr.attrs), context.codemap) =>\n+                && is_simple_block(block, Some(&expr.attrs), context.source_map) =>\n         {\n             Some(&*block)\n         }\n@@ -347,7 +347,7 @@ fn rewrite_match_body(\n     let (is_block, is_empty_block) = if let ast::ExprKind::Block(ref block, _) = body.node {\n         (\n             true,\n-            is_empty_block(block, Some(&body.attrs), context.codemap),\n+            is_empty_block(block, Some(&body.attrs), context.source_map),\n         )\n     } else {\n         (false, false)"}, {"sha": "ef047b3144ccc3ea10d42745859242436adf9293", "filename": "src/missed_spans.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmissed_spans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmissed_spans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmissed_spans.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -10,12 +10,12 @@\n \n use std::borrow::Cow;\n \n-use syntax::codemap::{BytePos, Pos, Span};\n+use syntax::source_map::{BytePos, Pos, Span};\n \n-use codemap::LineRangeUtils;\n use comment::{rewrite_comment, CodeCharKind, CommentCodeSlices};\n use config::{EmitMode, FileName};\n use shape::{Indent, Shape};\n+use source_map::LineRangeUtils;\n use utils::{count_newlines, last_line_width, mk_sp};\n use visitor::FmtVisitor;\n \n@@ -97,8 +97,8 @@ impl<'a> FmtVisitor<'a> {\n         assert!(\n             start < end,\n             \"Request to format inverted span: {:?} to {:?}\",\n-            self.codemap.lookup_char_pos(start),\n-            self.codemap.lookup_char_pos(end)\n+            self.source_map.lookup_char_pos(start),\n+            self.source_map.lookup_char_pos(end)\n         );\n \n         self.last_pos = end;\n@@ -159,9 +159,9 @@ impl<'a> FmtVisitor<'a> {\n         // Get a snippet from the file start to the span's hi without allocating.\n         // We need it to determine what precedes the current comment. If the comment\n         // follows code on the same line, we won't touch it.\n-        let big_span_lo = self.codemap.lookup_char_pos(span.lo()).file.start_pos;\n-        let local_begin = self.codemap.lookup_byte_offset(big_span_lo);\n-        let local_end = self.codemap.lookup_byte_offset(span.hi());\n+        let big_span_lo = self.source_map.lookup_char_pos(span.lo()).file.start_pos;\n+        let local_begin = self.source_map.lookup_byte_offset(big_span_lo);\n+        let local_end = self.source_map.lookup_byte_offset(span.hi());\n         let start_index = local_begin.pos.to_usize();\n         let end_index = local_end.pos.to_usize();\n         let big_snippet = &local_begin.fm.src.as_ref().unwrap()[start_index..end_index];\n@@ -187,7 +187,7 @@ impl<'a> FmtVisitor<'a> {\n         // Trim whitespace from the right hand side of each line.\n         // Annoyingly, the library functions for splitting by lines etc. are not\n         // quite right, so we must do it ourselves.\n-        let char_pos = self.codemap.lookup_char_pos(span.lo());\n+        let char_pos = self.source_map.lookup_char_pos(span.lo());\n         let file_name = &char_pos.file.name.clone().into();\n         let mut status = SnippetStatus::new(char_pos.line);\n "}, {"sha": "aa36f4103e4231268738213bb5020765b457556a", "filename": "src/modules.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmodules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fmodules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmodules.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -13,8 +13,8 @@ use std::io;\n use std::path::{Path, PathBuf};\n \n use syntax::ast;\n-use syntax::codemap;\n use syntax::parse::{parser, DirectoryOwnership};\n+use syntax::source_map;\n use syntax_pos::symbol::Symbol;\n \n use config::FileName;\n@@ -24,16 +24,16 @@ use utils::contains_skip;\n /// If a file is used twice in a crate, it appears only once.\n pub fn list_files<'a>(\n     krate: &'a ast::Crate,\n-    codemap: &codemap::CodeMap,\n+    source_map: &source_map::SourceMap,\n ) -> Result<BTreeMap<FileName, &'a ast::Mod>, io::Error> {\n     let mut result = BTreeMap::new(); // Enforce file order determinism\n-    let root_filename = codemap.span_to_filename(krate.span);\n+    let root_filename = source_map.span_to_filename(krate.span);\n     {\n         let parent = match root_filename {\n-            codemap::FileName::Real(ref path) => path.parent().unwrap(),\n+            source_map::FileName::Real(ref path) => path.parent().unwrap(),\n             _ => Path::new(\"\"),\n         };\n-        list_submodules(&krate.module, parent, None, codemap, &mut result)?;\n+        list_submodules(&krate.module, parent, None, source_map, &mut result)?;\n     }\n     result.insert(root_filename.into(), &krate.module);\n     Ok(result)\n@@ -59,15 +59,15 @@ fn list_submodules<'a>(\n     module: &'a ast::Mod,\n     search_dir: &Path,\n     relative: Option<ast::Ident>,\n-    codemap: &codemap::CodeMap,\n+    source_map: &source_map::SourceMap,\n     result: &mut BTreeMap<FileName, &'a ast::Mod>,\n ) -> Result<(), io::Error> {\n     debug!(\"list_submodules: search_dir: {:?}\", search_dir);\n     for item in &module.items {\n         if let ast::ItemKind::Mod(ref sub_mod) = item.node {\n             if !contains_skip(&item.attrs) {\n-                let is_internal =\n-                    codemap.span_to_filename(item.span) == codemap.span_to_filename(sub_mod.inner);\n+                let is_internal = source_map.span_to_filename(item.span)\n+                    == source_map.span_to_filename(sub_mod.inner);\n                 let (dir_path, relative) = if is_internal {\n                     if let Some(path) = find_path_value(&item.attrs) {\n                         (search_dir.join(&path.as_str()), None)\n@@ -76,12 +76,12 @@ fn list_submodules<'a>(\n                     }\n                 } else {\n                     let (mod_path, relative) =\n-                        module_file(item.ident, &item.attrs, search_dir, relative, codemap)?;\n+                        module_file(item.ident, &item.attrs, search_dir, relative, source_map)?;\n                     let dir_path = mod_path.parent().unwrap().to_owned();\n                     result.insert(FileName::Real(mod_path), sub_mod);\n                     (dir_path, relative)\n                 };\n-                list_submodules(sub_mod, &dir_path, relative, codemap, result)?;\n+                list_submodules(sub_mod, &dir_path, relative, source_map, result)?;\n             }\n         }\n     }\n@@ -94,13 +94,13 @@ fn module_file(\n     attrs: &[ast::Attribute],\n     dir_path: &Path,\n     relative: Option<ast::Ident>,\n-    codemap: &codemap::CodeMap,\n+    source_map: &source_map::SourceMap,\n ) -> Result<(PathBuf, Option<ast::Ident>), io::Error> {\n     if let Some(path) = parser::Parser::submod_path_from_attr(attrs, dir_path) {\n         return Ok((path, None));\n     }\n \n-    match parser::Parser::default_submod_path(id, relative, dir_path, codemap).result {\n+    match parser::Parser::default_submod_path(id, relative, dir_path, source_map).result {\n         Ok(parser::ModulePathSuccess {\n             path,\n             directory_ownership,"}, {"sha": "1a223cf3ca636f76e0d27c493f0a218001f38611", "filename": "src/overflow.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Foverflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Foverflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Foverflow.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -13,15 +13,15 @@\n \n use config::lists::*;\n use syntax::ast;\n-use syntax::codemap::Span;\n use syntax::parse::token::DelimToken;\n+use syntax::source_map::Span;\n \n use closures;\n-use codemap::SpanUtils;\n use expr::{is_every_expr_simple, is_method_call, is_nested_call, maybe_get_args_offset, ToExpr};\n use lists::{definitive_tactic, itemize_list, write_list, ListFormatting, ListItem, Separator};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use utils::{count_newlines, extra_offset, first_line_width, last_line_width, mk_sp};\n "}, {"sha": "0bacfe13fd07bbe190174ea4bfc5efe6d22ab276", "filename": "src/patterns.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fpatterns.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -10,10 +10,9 @@\n \n use config::lists::*;\n use syntax::ast::{self, BindingMode, FieldPat, Pat, PatKind, RangeEnd, RangeSyntax};\n-use syntax::codemap::{self, BytePos, Span};\n use syntax::ptr;\n+use syntax::source_map::{self, BytePos, Span};\n \n-use codemap::SpanUtils;\n use comment::FindUncommented;\n use expr::{can_be_overflowed_expr, rewrite_unary_prefix, wrap_struct_field};\n use lists::{\n@@ -25,6 +24,7 @@ use overflow;\n use pairs::{rewrite_pair, PairParts};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use types::{rewrite_path, PathContext};\n use utils::{format_mutability, mk_sp, rewrite_ident};\n@@ -171,7 +171,7 @@ impl Rewrite for Pat {\n \n fn rewrite_struct_pat(\n     path: &ast::Path,\n-    fields: &[codemap::Spanned<ast::FieldPat>],\n+    fields: &[source_map::Spanned<ast::FieldPat>],\n     ellipsis: bool,\n     span: Span,\n     context: &RewriteContext,\n@@ -332,7 +332,7 @@ fn rewrite_tuple_pat(\n             lo,\n             // 2 == \"..\".len()\n             lo + BytePos(2),\n-            codemap::NO_EXPANSION,\n+            source_map::NO_EXPANSION,\n         ));\n         pat_vec.insert(pos, dotdot);\n     }\n@@ -371,7 +371,9 @@ fn rewrite_tuple_pat(\n         shape,\n         span,\n         context.config.max_width(),\n-        if add_comma {\n+        if dotdot_pos.is_some() {\n+            Some(SeparatorTactic::Never)\n+        } else if add_comma {\n             Some(SeparatorTactic::Always)\n         } else {\n             None"}, {"sha": "b6876738cfd6a2236bf8c3cab8a45f98979df1d1", "filename": "src/reorder.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Freorder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Freorder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Freorder.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -17,16 +17,16 @@\n // FIXME(#2455): Reorder trait items.\n \n use config::Config;\n-use syntax::{ast, attr, codemap::Span};\n+use syntax::{ast, attr, source_map::Span};\n \n use attr::filter_inline_attrs;\n-use codemap::LineRangeUtils;\n use comment::combine_strs_with_missing_comments;\n use imports::{merge_use_trees, UseTree};\n use items::{is_mod_decl, rewrite_extern_crate, rewrite_mod};\n use lists::{itemize_list, write_list, ListFormatting, ListItem};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::LineRangeUtils;\n use spanned::Spanned;\n use utils::mk_sp;\n use visitor::FmtVisitor;\n@@ -226,13 +226,13 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n         item_kind: ReorderableItemKind,\n         in_group: bool,\n     ) -> usize {\n-        let mut last = self.codemap.lookup_line_range(items[0].span());\n+        let mut last = self.source_map.lookup_line_range(items[0].span());\n         let item_length = items\n             .iter()\n             .take_while(|ppi| {\n                 item_kind.is_same_item_kind(&***ppi)\n                     && (!in_group || {\n-                        let current = self.codemap.lookup_line_range(ppi.span());\n+                        let current = self.source_map.lookup_line_range(ppi.span());\n                         let in_same_group = current.lo < last.hi + 2;\n                         last = current;\n                         in_same_group"}, {"sha": "f463732c0e497dbccd4fa9f4482fa592518c4b46", "filename": "src/rewrite.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Frewrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Frewrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frewrite.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -10,8 +10,8 @@\n \n // A generic trait to abstract the rewriting of an element (of the AST).\n \n-use syntax::codemap::{CodeMap, Span};\n use syntax::parse::ParseSess;\n+use syntax::source_map::{SourceMap, Span};\n \n use config::{Config, IndentStyle};\n use shape::Shape;\n@@ -28,7 +28,7 @@ pub trait Rewrite {\n #[derive(Clone)]\n pub struct RewriteContext<'a> {\n     pub parse_session: &'a ParseSess,\n-    pub codemap: &'a CodeMap,\n+    pub source_map: &'a SourceMap,\n     pub config: &'a Config,\n     pub inside_macro: RefCell<bool>,\n     // Force block indent style even if we are using visual indent style."}, {"sha": "306f262663921a8037938ee302f22f267a885722", "filename": "src/source_file.rs", "status": "renamed", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fsource_file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fsource_file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fsource_file.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -25,7 +25,7 @@ pub fn append_newline(s: &mut String) {\n \n #[cfg(test)]\n pub(crate) fn write_all_files<T>(\n-    file_map: &[FileRecord],\n+    source_file: &[FileRecord],\n     out: &mut T,\n     config: &Config,\n ) -> Result<(), io::Error>\n@@ -35,7 +35,7 @@ where\n     if config.emit_mode() == EmitMode::Checkstyle {\n         write!(out, \"{}\", ::checkstyle::header())?;\n     }\n-    for &(ref filename, ref text) in file_map {\n+    for &(ref filename, ref text) in source_file {\n         write_file(text, filename, out, config)?;\n     }\n     if config.emit_mode() == EmitMode::Checkstyle {", "previous_filename": "src/filemap.rs"}, {"sha": "dee5e4f760110beec27e9fe37115842ba48b12c9", "filename": "src/source_map.rs", "status": "renamed", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fsource_map.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -8,11 +8,11 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-//! This module contains utilities that work with the `CodeMap` from `libsyntax` / `syntex_syntax`.\n+//! This module contains utilities that work with the `SourceMap` from `libsyntax`/`syntex_syntax`.\n //! This includes extension traits and methods for looking up spans and line ranges for AST nodes.\n \n use config::file_lines::LineRange;\n-use syntax::codemap::{BytePos, CodeMap, Span};\n+use syntax::source_map::{BytePos, SourceMap, Span};\n use visitor::SnippetProvider;\n \n use comment::FindUncommented;\n@@ -71,7 +71,7 @@ impl<'a> SpanUtils for SnippetProvider<'a> {\n     }\n }\n \n-impl LineRangeUtils for CodeMap {\n+impl LineRangeUtils for SourceMap {\n     fn lookup_line_range(&self, span: Span) -> LineRange {\n         let lo = self.lookup_line(span.lo()).unwrap();\n         let hi = self.lookup_line(span.hi()).unwrap();", "previous_filename": "src/codemap.rs"}, {"sha": "a7ba0f1a72dfbc24dec9344f580fc96321500f57", "filename": "src/spanned.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fspanned.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fspanned.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fspanned.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n use syntax::ast;\n-use syntax::codemap::Span;\n+use syntax::source_map::Span;\n \n use macros::MacroArg;\n use utils::{mk_sp, outer_attributes};"}, {"sha": "8b2358f1ada3a5a025fc33b9b268cdb278b85a8e", "filename": "src/test/mod.rs", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Ftest%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Ftest%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmod.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -20,9 +20,9 @@ use std::path::{Path, PathBuf};\n use std::str::Chars;\n \n use config::{Color, Config, EmitMode, FileName, ReportTactic};\n-use filemap;\n-use formatting::{FileMap, ModifiedChunk};\n+use formatting::{ModifiedChunk, SourceFile};\n use rustfmt_diff::{make_diff, print_diff, DiffLine, Mismatch, OutputWriter};\n+use source_file;\n use {FormatReport, Input, Session};\n \n const DIFF_CONTEXT_SIZE: usize = 3;\n@@ -197,11 +197,11 @@ fn modified_test() {\n // to a known output file generated by one of the write modes.\n fn assert_output(source: &Path, expected_filename: &Path) {\n     let config = read_config(source);\n-    let (_, file_map, _) = format_file(source, config.clone());\n+    let (_, source_file, _) = format_file(source, config.clone());\n \n     // Populate output by writing to a vec.\n     let mut out = vec![];\n-    let _ = filemap::write_all_files(&file_map, &mut out, &config);\n+    let _ = source_file::write_all_files(&source_file, &mut out, &config);\n     let output = String::from_utf8(out).unwrap();\n \n     let mut expected_file = fs::File::open(&expected_filename).expect(\"Couldn't open target\");\n@@ -414,15 +414,15 @@ fn read_config(filename: &Path) -> Config {\n     config\n }\n \n-fn format_file<P: Into<PathBuf>>(filepath: P, config: Config) -> (bool, FileMap, FormatReport) {\n+fn format_file<P: Into<PathBuf>>(filepath: P, config: Config) -> (bool, SourceFile, FormatReport) {\n     let filepath = filepath.into();\n     let input = Input::File(filepath);\n     let mut session = Session::<io::Stdout>::new(config, None);\n     let result = session.format(input).unwrap();\n     let parsing_errors = session.has_parsing_errors();\n-    let mut filemap = FileMap::new();\n-    mem::swap(&mut session.filemap, &mut filemap);\n-    (parsing_errors, filemap, result)\n+    let mut source_file = SourceFile::new();\n+    mem::swap(&mut session.source_file, &mut source_file);\n+    (parsing_errors, source_file, result)\n }\n \n enum IdempotentCheckError {\n@@ -440,13 +440,13 @@ fn idempotent_check(\n     } else {\n         read_config(filename)\n     };\n-    let (parsing_errors, file_map, format_report) = format_file(filename, config);\n+    let (parsing_errors, source_file, format_report) = format_file(filename, config);\n     if parsing_errors {\n         return Err(IdempotentCheckError::Parse);\n     }\n \n     let mut write_result = HashMap::new();\n-    for (filename, text) in file_map {\n+    for (filename, text) in source_file {\n         if let FileName::Real(ref filename) = filename {\n             write_result.insert(filename.to_owned(), text);\n         }"}, {"sha": "dd7f60a60b4fd671f9f7fffdee1835333613d625", "filename": "src/types.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftypes.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -13,10 +13,9 @@ use std::ops::Deref;\n \n use config::lists::*;\n use syntax::ast::{self, FunctionRetTy, Mutability};\n-use syntax::codemap::{self, BytePos, Span};\n+use syntax::source_map::{self, BytePos, Span};\n use syntax::symbol::keywords;\n \n-use codemap::SpanUtils;\n use config::{IndentStyle, TypeDensity};\n use expr::{rewrite_assign_rhs, rewrite_tuple, rewrite_unary_prefix, ToExpr};\n use lists::{definitive_tactic, itemize_list, write_list, ListFormatting, Separator};\n@@ -25,6 +24,7 @@ use overflow;\n use pairs::{rewrite_pair, PairParts};\n use rewrite::{Rewrite, RewriteContext};\n use shape::Shape;\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use utils::{\n     colon_spaces, extra_offset, first_line_width, format_abi, format_mutability,\n@@ -267,7 +267,7 @@ fn rewrite_segment(\n             ast::GenericArgs::Parenthesized(ref data) => {\n                 let output = match data.output {\n                     Some(ref ty) => FunctionRetTy::Ty(ty.clone()),\n-                    None => FunctionRetTy::Default(codemap::DUMMY_SP),\n+                    None => FunctionRetTy::Default(source_map::DUMMY_SP),\n                 };\n                 result.push_str(&format_function_type(\n                     data.inputs.iter().map(|x| &**x),"}, {"sha": "63b238a781761d8e73f7684b445ef9df6e3a3f7b", "filename": "src/utils.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -15,8 +15,8 @@ use syntax::ast::{\n     self, Attribute, CrateSugar, MetaItem, MetaItemKind, NestedMetaItem, NestedMetaItemKind, Path,\n     Visibility, VisibilityKind,\n };\n-use syntax::codemap::{BytePos, Span, NO_EXPANSION};\n use syntax::ptr;\n+use syntax::source_map::{BytePos, Span, NO_EXPANSION};\n \n use comment::filter_normal_code;\n use rewrite::RewriteContext;\n@@ -327,7 +327,7 @@ macro_rules! out_of_file_lines_range {\n         !$self.config.file_lines().is_all() && !$self\n             .config\n             .file_lines()\n-            .intersects(&$self.codemap.lookup_line_range($span))\n+            .intersects(&$self.source_map.lookup_line_range($span))\n     };\n }\n "}, {"sha": "e76f44ca39b05f6ebda4464817e3715975ff5796", "filename": "src/vertical.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fvertical.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fvertical.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvertical.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -14,15 +14,15 @@ use std::cmp;\n \n use config::lists::*;\n use syntax::ast;\n-use syntax::codemap::{BytePos, Span};\n+use syntax::source_map::{BytePos, Span};\n \n-use codemap::SpanUtils;\n use comment::{combine_strs_with_missing_comments, contains_comment};\n use expr::rewrite_field;\n use items::{rewrite_struct_field, rewrite_struct_field_prefix};\n use lists::{definitive_tactic, itemize_list, write_list, ListFormatting, Separator};\n use rewrite::{Rewrite, RewriteContext};\n use shape::{Indent, Shape};\n+use source_map::SpanUtils;\n use spanned::Spanned;\n use utils::{contains_skip, is_attributes_extendable, mk_sp, rewrite_ident};\n "}, {"sha": "7f557747778dc467bc53414c7b0420bb16f19c43", "filename": "src/visitor.rs", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -9,12 +9,11 @@\n // except according to those terms.\n \n use syntax::attr::HasAttrs;\n-use syntax::codemap::{self, BytePos, CodeMap, Pos, Span};\n use syntax::parse::ParseSess;\n+use syntax::source_map::{self, BytePos, Pos, SourceMap, Span};\n use syntax::{ast, visit};\n \n use attr::*;\n-use codemap::{LineRangeUtils, SpanUtils};\n use comment::{CodeCharKind, CommentCodeSlices, FindUncommented};\n use config::{BraceStyle, Config};\n use items::{\n@@ -26,6 +25,7 @@ use items::{\n use macros::{rewrite_macro, rewrite_macro_def, MacroPosition};\n use rewrite::{Rewrite, RewriteContext};\n use shape::{Indent, Shape};\n+use source_map::{LineRangeUtils, SpanUtils};\n use spanned::Spanned;\n use utils::{\n     self, contains_skip, count_newlines, inner_attributes, mk_sp, ptr_vec_to_ref_vec,\n@@ -61,7 +61,7 @@ impl<'a> SnippetProvider<'a> {\n \n pub struct FmtVisitor<'a> {\n     pub parse_session: &'a ParseSess,\n-    pub codemap: &'a CodeMap,\n+    pub source_map: &'a SourceMap,\n     pub buffer: String,\n     pub last_pos: BytePos,\n     // FIXME: use an RAII util or closure for indenting\n@@ -83,8 +83,8 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n     fn visit_stmt(&mut self, stmt: &ast::Stmt) {\n         debug!(\n             \"visit_stmt: {:?} {:?}\",\n-            self.codemap.lookup_char_pos(stmt.span.lo()),\n-            self.codemap.lookup_char_pos(stmt.span.hi())\n+            self.source_map.lookup_char_pos(stmt.span.lo()),\n+            self.source_map.lookup_char_pos(stmt.span.hi())\n         );\n \n         match stmt.node {\n@@ -121,8 +121,8 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n     ) {\n         debug!(\n             \"visit_block: {:?} {:?}\",\n-            self.codemap.lookup_char_pos(b.span.lo()),\n-            self.codemap.lookup_char_pos(b.span.hi())\n+            self.source_map.lookup_char_pos(b.span.lo()),\n+            self.source_map.lookup_char_pos(b.span.hi())\n         );\n \n         // Check if this block has braces.\n@@ -575,23 +575,23 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n     }\n \n     pub fn from_context(ctx: &'a RewriteContext) -> FmtVisitor<'a> {\n-        FmtVisitor::from_codemap(\n+        FmtVisitor::from_source_map(\n             ctx.parse_session,\n             ctx.config,\n             ctx.snippet_provider,\n             ctx.report.clone(),\n         )\n     }\n \n-    pub(crate) fn from_codemap(\n+    pub(crate) fn from_source_map(\n         parse_session: &'a ParseSess,\n         config: &'a Config,\n         snippet_provider: &'a SnippetProvider,\n         report: FormatReport,\n     ) -> FmtVisitor<'a> {\n         FmtVisitor {\n             parse_session,\n-            codemap: parse_session.codemap(),\n+            source_map: parse_session.source_map(),\n             buffer: String::with_capacity(snippet_provider.big_snippet.len() * 2),\n             last_pos: BytePos(0),\n             block_indent: Indent::empty(),\n@@ -617,25 +617,25 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n     pub fn visit_attrs(&mut self, attrs: &[ast::Attribute], style: ast::AttrStyle) -> bool {\n         for attr in attrs {\n             if attr.name() == DEPR_SKIP_ANNOTATION {\n-                let file_name = self.codemap.span_to_filename(attr.span).into();\n+                let file_name = self.source_map.span_to_filename(attr.span).into();\n                 self.report.append(\n                     file_name,\n                     vec![FormattingError::from_span(\n                         &attr.span,\n-                        &self.codemap,\n+                        &self.source_map,\n                         ErrorKind::DeprecatedAttr,\n                     )],\n                 );\n             } else if attr.path.segments[0].ident.to_string() == \"rustfmt\" {\n                 if attr.path.segments.len() == 1\n                     || attr.path.segments[1].ident.to_string() != \"skip\"\n                 {\n-                    let file_name = self.codemap.span_to_filename(attr.span).into();\n+                    let file_name = self.source_map.span_to_filename(attr.span).into();\n                     self.report.append(\n                         file_name,\n                         vec![FormattingError::from_span(\n                             &attr.span,\n-                            &self.codemap,\n+                            &self.source_map,\n                             ErrorKind::BadAttr,\n                         )],\n                     );\n@@ -741,10 +741,10 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n         }\n     }\n \n-    pub fn format_separate_mod(&mut self, m: &ast::Mod, filemap: &codemap::FileMap) {\n+    pub fn format_separate_mod(&mut self, m: &ast::Mod, source_file: &source_map::SourceFile) {\n         self.block_indent = Indent::empty();\n         self.walk_mod_items(m);\n-        self.format_missing_with_indent(filemap.end_pos);\n+        self.format_missing_with_indent(source_file.end_pos);\n     }\n \n     pub fn skip_empty_lines(&mut self, end_pos: BytePos) {\n@@ -779,7 +779,7 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n     pub fn get_context(&self) -> RewriteContext {\n         RewriteContext {\n             parse_session: self.parse_session,\n-            codemap: self.codemap,\n+            source_map: self.source_map,\n             config: self.config,\n             inside_macro: RefCell::new(false),\n             use_block: RefCell::new(false),"}, {"sha": "113464112695917f2627189a6734a0846ce5d811", "filename": "tests/source/attrib.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fattrib.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -190,3 +190,23 @@ pub struct Params {\n   job: Option<Job>\n }\n }\n+\n+// #2969\n+#[cfg(not(all(feature=\"std\",\n+              any(target_os = \"linux\", target_os = \"android\",\n+                  target_os = \"netbsd\",\n+                  target_os = \"dragonfly\",\n+                  target_os = \"haiku\",\n+                  target_os = \"emscripten\",\n+                  target_os = \"solaris\",\n+                  target_os = \"cloudabi\",\n+                  target_os = \"macos\", target_os = \"ios\",\n+                  target_os = \"freebsd\",\n+                  target_os = \"openbsd\", target_os = \"bitrig\",\n+                  target_os = \"redox\",\n+                  target_os = \"fuchsia\",\n+                  windows,\n+                  all(target_arch = \"wasm32\", feature = \"stdweb\"),\n+                  all(target_arch = \"wasm32\", feature = \"wasm-bindgen\"),\n+              ))))]\n+type Os = NoSource;"}, {"sha": "6674e7eebe4b64ff36a8507c5c81787736076e1d", "filename": "tests/source/catch.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fcatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fcatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fcatch.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -1,27 +1,28 @@\n-#![feature(catch_expr)]\n+// rustfmt-edition: Edition2018\n+#![feature(try_blocks)]\n \n fn main() {\n-    let x = do catch {\n+    let x = try {\n         foo()?\n     };\n \n-    let x = do catch /* Invisible comment */ { foo()? };\n+    let x = try /* Invisible comment */ { foo()? };\n \n-    let x = do catch {\n+    let x = try {\n         unsafe { foo()? }\n     };\n \n-    let y = match (do catch {\n+    let y = match (try {\n         foo()?\n     }) {\n         _ => (),\n     };\n \n-    do catch {\n+    try {\n         foo()?;\n     };\n \n-    do catch {\n-        // Regular do catch block\n+    try {\n+        // Regular try block\n     };\n }"}, {"sha": "48cc1fd72ae8819b011a702e3ac5234c1287ae59", "filename": "tests/source/expr-block.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fexpr-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fexpr-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fexpr-block.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -77,7 +77,7 @@ fn arrays() {\n }\n \n fn function_calls() {\n-    let items = itemize_list(context.codemap,\n+    let items = itemize_list(context.source_map,\n                              args.iter(),\n                              \")\",\n                              |item| item.span.lo(),\n@@ -92,7 +92,7 @@ fn function_calls() {\n                              span.lo(),\n                              span.hi());\n \n-    itemize_list(context.codemap,\n+    itemize_list(context.source_map,\n                              args.iter(),\n                              \")\",\n                              |item| item.span.lo(),"}, {"sha": "7098d65f100b9dea3b24e4625e610fdfa4a83f68", "filename": "tests/source/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fexpr.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -9,7 +9,7 @@ fn foo() -> bool {\n     let very_long_variable_name = ( a +  first +   simple + test   );\n     let very_long_variable_name = (a + first + simple + test + AAAAAAAAAAAAA + BBBBBBBBBBBBBBBBB + b + c);\n \n-    let is_internalxxxx = self.codemap.span_to_filename(s) == self.codemap.span_to_filename(m.inner);\n+    let is_internalxxxx = self.source_map.span_to_filename(s) == self.source_map.span_to_filename(m.inner);\n \n     let some_val = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa * bbbb / (bbbbbb -\n         function_call(x, *very_long_pointer, y))"}, {"sha": "d290d8d91858d9ba7ff970619a5107bca90a61fe", "filename": "tests/source/imports-impl-only-use.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fimports-impl-only-use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fimports-impl-only-use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fimports-impl-only-use.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,4 @@\n+#![feature(underscore_imports)]\n+\n+use attr;\n+use std::iter::Iterator as _;"}, {"sha": "55b5c56e698447539663fb05e4a4e2928d948d66", "filename": "tests/source/issue-2936.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-2936.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-2936.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-2936.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,19 @@\n+struct AStruct {\n+    A: u32,\n+    B: u32,\n+    C: u32,\n+}\n+\n+impl Something for AStruct {\n+    fn a_func() {\n+        match a_val {\n+            ContextualParseError::InvalidMediaRule(ref err) => {\n+                let err: &CStr = match err.kind {\n+                    ParseErrorKind::Custom(StyleParseErrorKind::MediaQueryExpectedFeatureName(..)) => {\n+                        cstr!(\"PEMQExpectedFeatureName\")\n+                    },\n+                };\n+            }\n+        };\n+    }\n+}"}, {"sha": "525e070a57eee7df83adfed1cb4437b578010326", "filename": "tests/source/issue-2955.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-2955.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-2955.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-2955.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,6 @@\n+// rustfmt-condense_wildcard_suffixes: true\n+fn main() {\n+    match (1, 2, 3) {\n+        (_, _, _) => (),\n+    }\n+}"}, {"sha": "d70682e3bee4686fe6573c1f79ac58c6d33d6676", "filename": "tests/source/issue-539.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-539.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-539.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-539.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,5 @@\n+// rustfmt-normalize_comments: true\n+/*\n+  FIXME (#3300): Should allow items to be anonymous. Right now\n+  we just use dummy names for anon items.\n+ */"}, {"sha": "fd99015ea51ca04f694358b932de785dd3019801", "filename": "tests/source/issue-683.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-683.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Fsource%2Fissue-683.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-683.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,5 @@\n+// rustfmt-normalize_comments: true\n+/*\n+ * FIXME (#3300): Should allow items to be anonymous. Right now\n+ * we just use dummy names for anon items.\n+ */"}, {"sha": "84841f33d8ef511cd8b115d835d54697a9bd9d2a", "filename": "tests/target/attrib.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fattrib.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -219,3 +219,29 @@ mod issue_2620 {\n         job: Option<Job>,\n     }\n }\n+\n+// #2969\n+#[cfg(not(all(\n+    feature = \"std\",\n+    any(\n+        target_os = \"linux\",\n+        target_os = \"android\",\n+        target_os = \"netbsd\",\n+        target_os = \"dragonfly\",\n+        target_os = \"haiku\",\n+        target_os = \"emscripten\",\n+        target_os = \"solaris\",\n+        target_os = \"cloudabi\",\n+        target_os = \"macos\",\n+        target_os = \"ios\",\n+        target_os = \"freebsd\",\n+        target_os = \"openbsd\",\n+        target_os = \"bitrig\",\n+        target_os = \"redox\",\n+        target_os = \"fuchsia\",\n+        windows,\n+        all(target_arch = \"wasm32\", feature = \"stdweb\"),\n+        all(target_arch = \"wasm32\", feature = \"wasm-bindgen\"),\n+    )\n+)))]\n+type Os = NoSource;"}, {"sha": "6987a19bcadbb79cbcadad924fbb21d0a9a1f0af", "filename": "tests/target/catch.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fcatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fcatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fcatch.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -1,21 +1,22 @@\n-#![feature(catch_expr)]\n+// rustfmt-edition: Edition2018\n+#![feature(try_blocks)]\n \n fn main() {\n-    let x = do catch { foo()? };\n+    let x = try { foo()? };\n \n-    let x = do catch /* Invisible comment */ { foo()? };\n+    let x = try /* Invisible comment */ { foo()? };\n \n-    let x = do catch { unsafe { foo()? } };\n+    let x = try { unsafe { foo()? } };\n \n-    let y = match (do catch { foo()? }) {\n+    let y = match (try { foo()? }) {\n         _ => (),\n     };\n \n-    do catch {\n+    try {\n         foo()?;\n     };\n \n-    do catch {\n-        // Regular do catch block\n+    try {\n+        // Regular try block\n     };\n }"}, {"sha": "bdf2adf0c6437b721428386a2b48149526eb1f72", "filename": "tests/target/doc-comment-with-example.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fdoc-comment-with-example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fdoc-comment-with-example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fdoc-comment-with-example.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -8,5 +8,4 @@\n /// # #![cfg_attr(not(dox), no_std)]\n /// fn foo() {}\n /// ```\n-///\n fn foo() {}"}, {"sha": "d3a45566efa11a6d427c648a2ff6fbc1052fa0ea", "filename": "tests/target/expr-block.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fexpr-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fexpr-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fexpr-block.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -73,7 +73,7 @@ fn arrays() {\n \n fn function_calls() {\n     let items = itemize_list(\n-        context.codemap,\n+        context.source_map,\n         args.iter(),\n         \")\",\n         |item| item.span.lo(),\n@@ -92,7 +92,7 @@ fn function_calls() {\n     );\n \n     itemize_list(\n-        context.codemap,\n+        context.source_map,\n         args.iter(),\n         \")\",\n         |item| item.span.lo(),"}, {"sha": "2e2312a11d503a1488eee0c40e431952a4d889f1", "filename": "tests/target/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fexpr.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -11,7 +11,7 @@ fn foo() -> bool {\n         (a + first + simple + test + AAAAAAAAAAAAA + BBBBBBBBBBBBBBBBB + b + c);\n \n     let is_internalxxxx =\n-        self.codemap.span_to_filename(s) == self.codemap.span_to_filename(m.inner);\n+        self.source_map.span_to_filename(s) == self.source_map.span_to_filename(m.inner);\n \n     let some_val = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa * bbbb\n         / (bbbbbb - function_call(x, *very_long_pointer, y))"}, {"sha": "d290d8d91858d9ba7ff970619a5107bca90a61fe", "filename": "tests/target/imports-impl-only-use.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fimports-impl-only-use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fimports-impl-only-use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fimports-impl-only-use.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,4 @@\n+#![feature(underscore_imports)]\n+\n+use attr;\n+use std::iter::Iterator as _;"}, {"sha": "876050a20f45f5e8a86407c88c6119ce4d6c7bc8", "filename": "tests/target/issue-2936.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-2936.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-2936.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-2936.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,19 @@\n+struct AStruct {\n+    A: u32,\n+    B: u32,\n+    C: u32,\n+}\n+\n+impl Something for AStruct {\n+    fn a_func() {\n+        match a_val {\n+            ContextualParseError::InvalidMediaRule(ref err) => {\n+                let err: &CStr = match err.kind {\n+                    ParseErrorKind::Custom(StyleParseErrorKind::MediaQueryExpectedFeatureName(\n+                        ..\n+                    )) => cstr!(\"PEMQExpectedFeatureName\"),\n+                };\n+            }\n+        };\n+    }\n+}"}, {"sha": "799cd36e29ac28cc47aa9287a81d7d213b1bd6c0", "filename": "tests/target/issue-2955.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-2955.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-2955.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-2955.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,6 @@\n+// rustfmt-condense_wildcard_suffixes: true\n+fn main() {\n+    match (1, 2, 3) {\n+        (..) => (),\n+    }\n+}"}, {"sha": "adeb33555fb5c04e8378af52527ff3effae6de12", "filename": "tests/target/issue-539.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-539.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-539.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-539.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,3 @@\n+// rustfmt-normalize_comments: true\n+// FIXME (#3300): Should allow items to be anonymous. Right now\n+// we just use dummy names for anon items."}, {"sha": "adeb33555fb5c04e8378af52527ff3effae6de12", "filename": "tests/target/issue-683.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-683.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fissue-683.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-683.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,3 @@\n+// rustfmt-normalize_comments: true\n+// FIXME (#3300): Should allow items to be anonymous. Right now\n+// we just use dummy names for anon items."}, {"sha": "ed6c181fc7bf134937455c4074a06da0005a420c", "filename": "tests/target/nested-visual-block.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fnested-visual-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fnested-visual-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fnested-visual-block.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -1,7 +1,7 @@\n fn main() {\n     // #1078\n     let items = itemize_list(\n-        context.codemap,\n+        context.source_map,\n         field_iter,\n         \"}\",\n         |item| match *item {\n@@ -33,7 +33,7 @@ fn main() {\n                 }\n             }\n         },\n-        context.codemap.span_after(span, \"{\"),\n+        context.source_map.span_after(span, \"{\"),\n         span.hi(),\n     );\n "}, {"sha": "3f364c1aecdc7abebc948df0db02603e2a057095", "filename": "tests/target/obsolete_in_place.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fobsolete_in_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3585706fa28c976c1ffad197da842c85a85dbd73/tests%2Ftarget%2Fobsolete_in_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fobsolete_in_place.rs?ref=3585706fa28c976c1ffad197da842c85a85dbd73", "patch": "@@ -0,0 +1,9 @@\n+// #2953\n+\n+macro_rules! demo {\n+    ($a:ident <- $b:expr) => {};\n+}\n+\n+fn main() {\n+    demo!(i <- 0);\n+}"}]}