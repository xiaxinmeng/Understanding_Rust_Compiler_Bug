{"sha": "63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzZjUxZWU5MGNjYzFiN2FiM2E3NDliYTdkYmQ0YTNjNzY5NjFjMTY=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2015-02-19T00:35:20Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-02-19T00:38:17Z"}, "message": "Exempt phantom fns from the object safety check", "tree": {"sha": "71f351d8cd5cafcda0c0474969b9a1e5c0a02eb1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/71f351d8cd5cafcda0c0474969b9a1e5c0a02eb1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16", "html_url": "https://github.com/rust-lang/rust/commit/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6e939a2df16338e9cf63ad19d1025a15069387c", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6e939a2df16338e9cf63ad19d1025a15069387c", "html_url": "https://github.com/rust-lang/rust/commit/d6e939a2df16338e9cf63ad19d1025a15069387c"}], "stats": {"total": 37, "additions": 33, "deletions": 4}, "files": [{"sha": "f10f7eb3951c7a0468a3a5e86367e9d4c024060f", "filename": "src/librustc/middle/traits/object_safety.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16/src%2Flibrustc%2Fmiddle%2Ftraits%2Fobject_safety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16/src%2Flibrustc%2Fmiddle%2Ftraits%2Fobject_safety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftraits%2Fobject_safety.rs?ref=63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16", "patch": "@@ -138,10 +138,11 @@ fn supertraits_reference_self<'tcx>(tcx: &ty::ctxt<'tcx>,\n             match predicate {\n                 ty::Predicate::Trait(ref data) => {\n                     // In the case of a trait predicate, we can skip the \"self\" type.\n-                    data.0.trait_ref.substs.types.get_slice(TypeSpace)\n-                                                 .iter()\n-                                                 .cloned()\n-                                                 .any(is_self)\n+                    Some(data.def_id()) != tcx.lang_items.phantom_fn() &&\n+                        data.0.trait_ref.substs.types.get_slice(TypeSpace)\n+                                                     .iter()\n+                                                     .cloned()\n+                                                     .any(is_self)\n                 }\n                 ty::Predicate::Projection(..) |\n                 ty::Predicate::TypeOutlives(..) |"}, {"sha": "fb30ce5c2455cf50338fac5e30014df45e9eda86", "filename": "src/test/compile-fail/object-safety-phantom-fn.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16/src%2Ftest%2Fcompile-fail%2Fobject-safety-phantom-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16/src%2Ftest%2Fcompile-fail%2Fobject-safety-phantom-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fobject-safety-phantom-fn.rs?ref=63f51ee90ccc1b7ab3a749ba7dbd4a3c76961c16", "patch": "@@ -0,0 +1,28 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Check that `Self` appearing in a phantom fn does not make a trait not object safe.\n+\n+#![feature(rustc_attrs)]\n+\n+trait Baz : PhantomFn<Self> {\n+}\n+\n+fn make_bar<T:Bar<u32>>(t: &T) -> &Bar<u32> {\n+    t\n+}\n+\n+fn make_baz<T:Baz>(t: &T) -> &Baz {\n+    t\n+}\n+\n+#[rustc_error]\n+fn main() { //~ ERROR compilation successful\n+}"}]}