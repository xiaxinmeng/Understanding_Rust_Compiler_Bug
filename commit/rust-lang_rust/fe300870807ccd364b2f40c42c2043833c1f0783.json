{"sha": "fe300870807ccd364b2f40c42c2043833c1f0783", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlMzAwODcwODA3Y2NkMzY0YjJmNDBjNDJjMjA0MzgzM2MxZjA3ODM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-12-30T16:19:04Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-12-30T16:21:41Z"}, "message": "Add metadata from a tempdir instead of a build dir\n\nRight now if you have concurrent builds of two libraries in the same directory\n(such as rustc's bootstrapping process), it's possible that two libraries will\nstomp over each others' metadata, producing corrupt rlibs.\n\nBy placing the metadata file in a tempdir we're guranteed to not conflict with\nay other builds happening concurrently. Normally this isn't a problem because\noutput filenames are scoped to the name of the crate, but metadata is special in\nthat it has the same name across all crates.", "tree": {"sha": "189697b5e0ee757503435fac786d36fc82fdfac2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/189697b5e0ee757503435fac786d36fc82fdfac2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe300870807ccd364b2f40c42c2043833c1f0783", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe300870807ccd364b2f40c42c2043833c1f0783", "html_url": "https://github.com/rust-lang/rust/commit/fe300870807ccd364b2f40c42c2043833c1f0783", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe300870807ccd364b2f40c42c2043833c1f0783/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a4f30bf0c001034b855e79b72676667deb6db463", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4f30bf0c001034b855e79b72676667deb6db463", "html_url": "https://github.com/rust-lang/rust/commit/a4f30bf0c001034b855e79b72676667deb6db463"}], "stats": {"total": 7, "additions": 5, "deletions": 2}, "files": [{"sha": "063b66b3777180cbff379d7a659661e1caecd24c", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fe300870807ccd364b2f40c42c2043833c1f0783/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe300870807ccd364b2f40c42c2043833c1f0783/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=fe300870807ccd364b2f40c42c2043833c1f0783", "patch": "@@ -890,8 +890,11 @@ fn link_rlib(sess: Session,\n     match trans {\n         Some(trans) => {\n             // Instead of putting the metadata in an object file section, rlibs\n-            // contain the metadata in a separate file.\n-            let metadata = obj_filename.with_filename(METADATA_FILENAME);\n+            // contain the metadata in a separate file. We use a temp directory\n+            // here so concurrent builds in the same directory don't try to use\n+            // the same filename for metadata (stomping over one another)\n+            let tmpdir = TempDir::new(\"rustc\").expect(\"needs a temp dir\");\n+            let metadata = tmpdir.path().join(METADATA_FILENAME);\n             fs::File::create(&metadata).write(trans.metadata);\n             a.add_file(&metadata, false);\n             fs::unlink(&metadata);"}]}