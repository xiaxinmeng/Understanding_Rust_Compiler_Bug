{"sha": "7de205ea3affa62d0f847380ab7313d465c4b2e4", "node_id": "C_kwDOAAsO6NoAKDdkZTIwNWVhM2FmZmE2MmQwZjg0NzM4MGFiNzMxM2Q0NjVjNGIyZTQ", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2023-02-24T22:58:32Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2023-02-25T00:04:56Z"}, "message": "Emit the enum discriminant separately for the Encodable macro", "tree": {"sha": "9909b2fcc017a5b134a8ba1d27453e87e843c75d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9909b2fcc017a5b134a8ba1d27453e87e843c75d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7de205ea3affa62d0f847380ab7313d465c4b2e4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7de205ea3affa62d0f847380ab7313d465c4b2e4", "html_url": "https://github.com/rust-lang/rust/commit/7de205ea3affa62d0f847380ab7313d465c4b2e4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7de205ea3affa62d0f847380ab7313d465c4b2e4/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07c993eba8b76eae497e98433ae075b00f01be10", "url": "https://api.github.com/repos/rust-lang/rust/commits/07c993eba8b76eae497e98433ae075b00f01be10", "html_url": "https://github.com/rust-lang/rust/commit/07c993eba8b76eae497e98433ae075b00f01be10"}], "stats": {"total": 59, "additions": 30, "deletions": 29}, "files": [{"sha": "8d017d149f62901fefa99176f30d39e1e653e6fc", "filename": "compiler/rustc_macros/src/serialize.rs", "status": "modified", "additions": 30, "deletions": 17, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/7de205ea3affa62d0f847380ab7313d465c4b2e4/compiler%2Frustc_macros%2Fsrc%2Fserialize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7de205ea3affa62d0f847380ab7313d465c4b2e4/compiler%2Frustc_macros%2Fsrc%2Fserialize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fserialize.rs?ref=7de205ea3affa62d0f847380ab7313d465c4b2e4", "patch": "@@ -42,6 +42,12 @@ fn decodable_body(\n     }\n     let ty_name = s.ast().ident.to_string();\n     let decode_body = match s.variants() {\n+        [] => {\n+            let message = format!(\"`{}` has no variants to decode\", ty_name);\n+            quote! {\n+                panic!(#message)\n+            }\n+        }\n         [vi] => vi.construct(|field, _index| decode_field(field)),\n         variants => {\n             let match_inner: TokenStream = variants\n@@ -139,6 +145,11 @@ fn encodable_body(\n     });\n \n     let encode_body = match s.variants() {\n+        [] => {\n+            quote! {\n+                match *self {}\n+            }\n+        }\n         [_] => {\n             let encode_inner = s.each_variant(|vi| {\n                 vi.bindings()\n@@ -160,6 +171,23 @@ fn encodable_body(\n             }\n         }\n         _ => {\n+            let disc = {\n+                let mut variant_idx = 0usize;\n+                let encode_inner = s.each_variant(|_| {\n+                    let result = quote! {\n+                        #variant_idx\n+                    };\n+                    variant_idx += 1;\n+                    result\n+                });\n+                quote! {\n+                    let disc = match *self {\n+                        #encode_inner\n+                    };\n+                    ::rustc_serialize::Encoder::emit_usize(__encoder, disc);\n+                }\n+            };\n+\n             let mut variant_idx = 0usize;\n             let encode_inner = s.each_variant(|vi| {\n                 let encode_fields: TokenStream = vi\n@@ -176,26 +204,11 @@ fn encodable_body(\n                         result\n                     })\n                     .collect();\n-\n-                let result = if !vi.bindings().is_empty() {\n-                    quote! {\n-                        ::rustc_serialize::Encoder::emit_enum_variant(\n-                            __encoder,\n-                            #variant_idx,\n-                            |__encoder| { #encode_fields }\n-                        )\n-                    }\n-                } else {\n-                    quote! {\n-                        ::rustc_serialize::Encoder::emit_fieldless_enum_variant::<#variant_idx>(\n-                            __encoder,\n-                        )\n-                    }\n-                };\n                 variant_idx += 1;\n-                result\n+                encode_fields\n             });\n             quote! {\n+                #disc\n                 match *self {\n                     #encode_inner\n                 }"}, {"sha": "567fe06109b781f2275233b2b8ce3cd987f9d268", "filename": "compiler/rustc_serialize/src/serialize.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/7de205ea3affa62d0f847380ab7313d465c4b2e4/compiler%2Frustc_serialize%2Fsrc%2Fserialize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7de205ea3affa62d0f847380ab7313d465c4b2e4/compiler%2Frustc_serialize%2Fsrc%2Fserialize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_serialize%2Fsrc%2Fserialize.rs?ref=7de205ea3affa62d0f847380ab7313d465c4b2e4", "patch": "@@ -43,25 +43,13 @@ pub trait Encoder {\n     fn emit_str(&mut self, v: &str);\n     fn emit_raw_bytes(&mut self, s: &[u8]);\n \n-    // Convenience for the derive macro:\n     fn emit_enum_variant<F>(&mut self, v_id: usize, f: F)\n     where\n         F: FnOnce(&mut Self),\n     {\n         self.emit_usize(v_id);\n         f(self);\n     }\n-\n-    // We put the field index in a const generic to allow the emit_usize to be\n-    // compiled into a more efficient form. In practice, the variant index is\n-    // known at compile-time, and that knowledge allows much more efficient\n-    // codegen than we'd otherwise get. LLVM isn't always able to make the\n-    // optimization that would otherwise be necessary here, likely due to the\n-    // multiple levels of inlining and const-prop that are needed.\n-    #[inline]\n-    fn emit_fieldless_enum_variant<const ID: usize>(&mut self) {\n-        self.emit_usize(ID)\n-    }\n }\n \n // Note: all the methods in this trait are infallible, which may be surprising."}]}