{"sha": "3666fa080050594ab3ad26255c069e4d2000a3f4", "node_id": "C_kwDOAAsO6NoAKDM2NjZmYTA4MDA1MDU5NGFiM2FkMjYyNTVjMDY5ZTRkMjAwMGEzZjQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-04T19:29:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-04T19:29:06Z"}, "message": "Rollup merge of #107116 - ozkanonur:consolidate-bootstrap-docs, r=jyn514\n\nconsolidate bootstrap docs\n\nWith this diff, I tried to consolidate bootstrap documentations and remove the duplicated informations.\n\nCoupled with https://github.com/rust-lang/rustc-dev-guide/pull/1563\n\nResolves #90686\n\nSigned-off-by: ozkanonur <work@onurozkan.dev>", "tree": {"sha": "df4ff69986cd9fe79be179b11e2896fece35d787", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df4ff69986cd9fe79be179b11e2896fece35d787"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3666fa080050594ab3ad26255c069e4d2000a3f4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj3rICCRBK7hj4Ov3rIwAAcWsIAHa80IRKbiJhH+d+k9wBGMES\noEFRhtQpBYtfrNCqIoShpkcyHc/gPVbY6fb1JL3Hx7D/G84jXYGp11k5r7sKZ/pP\nstrLXOou5H0AM6RWpnc8JMR2QzUOK1WjpTnlNmlqphH/6hNtimrAGkogwwNT4vYx\nxSMgjqS/qejNpaqUM8DHR3/fd0FH60n7Q7C0AB5+v6Z7xrbaxIRrfuW+GtTxg2Bu\nI98wGIb4tHOd39r+UNuAczuEEx7TnT+aTsAGVMR08i/J9lkFUa2/MRTEPQkPbIWq\naov6l4GEsSfRnDH8fwnMbNvDS2N26X7EXTjpRPO5usxQwZtJvRqL+rbx49rnQxA=\n=mh71\n-----END PGP SIGNATURE-----\n", "payload": "tree df4ff69986cd9fe79be179b11e2896fece35d787\nparent 9dee4e4c42d23b0c5afd6d8fed025181f70fbe12\nparent 6558326e7b5f8f5591b0a1289bc48099ae473a01\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1675538946 +0100\ncommitter GitHub <noreply@github.com> 1675538946 +0100\n\nRollup merge of #107116 - ozkanonur:consolidate-bootstrap-docs, r=jyn514\n\nconsolidate bootstrap docs\n\nWith this diff, I tried to consolidate bootstrap documentations and remove the duplicated informations.\n\nCoupled with https://github.com/rust-lang/rustc-dev-guide/pull/1563\n\nResolves #90686\n\nSigned-off-by: ozkanonur <work@onurozkan.dev>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3666fa080050594ab3ad26255c069e4d2000a3f4", "html_url": "https://github.com/rust-lang/rust/commit/3666fa080050594ab3ad26255c069e4d2000a3f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3666fa080050594ab3ad26255c069e4d2000a3f4/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9dee4e4c42d23b0c5afd6d8fed025181f70fbe12", "url": "https://api.github.com/repos/rust-lang/rust/commits/9dee4e4c42d23b0c5afd6d8fed025181f70fbe12", "html_url": "https://github.com/rust-lang/rust/commit/9dee4e4c42d23b0c5afd6d8fed025181f70fbe12"}, {"sha": "6558326e7b5f8f5591b0a1289bc48099ae473a01", "url": "https://api.github.com/repos/rust-lang/rust/commits/6558326e7b5f8f5591b0a1289bc48099ae473a01", "html_url": "https://github.com/rust-lang/rust/commit/6558326e7b5f8f5591b0a1289bc48099ae473a01"}], "stats": {"total": 286, "additions": 38, "deletions": 248}, "files": [{"sha": "71eee8968e272e66593286e252455c53460c265c", "filename": "src/bootstrap/README.md", "status": "modified", "additions": 38, "deletions": 161, "changes": 199, "blob_url": "https://github.com/rust-lang/rust/blob/3666fa080050594ab3ad26255c069e4d2000a3f4/src%2Fbootstrap%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/3666fa080050594ab3ad26255c069e4d2000a3f4/src%2Fbootstrap%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FREADME.md?ref=3666fa080050594ab3ad26255c069e4d2000a3f4", "patch": "@@ -4,105 +4,31 @@ This is an in-progress README which is targeted at helping to explain how Rust\n is bootstrapped and in general, some of the technical details of the build\n system.\n \n-## Using rustbuild\n+Note that this README only covers internal information, not how to use the tool.\n+Please check [bootstrapping dev guide][bootstrapping-dev-guide] for further information.\n \n-The rustbuild build system has a primary entry point, a top level `x.py` script:\n+[bootstrapping-dev-guide]: https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html\n \n-```sh\n-$ python ./x.py build\n-```\n-\n-Note that if you're on Unix, you should be able to execute the script directly:\n-\n-```sh\n-$ ./x.py build\n-```\n-\n-The script accepts commands, flags, and arguments to determine what to do:\n-\n-* `build` - a general purpose command for compiling code. Alone, `build` will\n-  bootstrap the entire compiler, and otherwise, arguments passed indicate what to\n-  build. For example:\n-\n-  ```\n-  # build the whole compiler\n-  ./x.py build --stage 2\n-\n-  # build the stage1 compiler\n-  ./x.py build\n-\n-  # build stage0 libstd\n-  ./x.py build --stage 0 library/std\n-\n-  # build a particular crate in stage0\n-  ./x.py build --stage 0 library/test\n-  ```\n-\n-  If files that would normally be rebuilt from stage 0 are dirty, the rebuild can be\n-  overridden using `--keep-stage 0`. Using `--keep-stage n` will skip all steps\n-  that belong to stage n or earlier:\n-\n-  ```\n-  # build stage 1, keeping old build products for stage 0\n-  ./x.py build --keep-stage 0\n-  ```\n-\n-* `test` - a command for executing unit tests. Like the `build` command, this\n-  will execute the entire test suite by default, and otherwise, it can be used to\n-  select which test suite is run:\n-\n-  ```\n-  # run all unit tests\n-  ./x.py test\n-\n-  # execute tool tests\n-  ./x.py test tidy\n-\n-  # execute the UI test suite\n-  ./x.py test tests/ui\n-\n-  # execute only some tests in the UI test suite\n-  ./x.py test tests/ui --test-args substring-of-test-name\n-\n-  # execute tests in the standard library in stage0\n-  ./x.py test --stage 0 library/std\n-\n-  # execute tests in the core and standard library in stage0,\n-  # without running doc tests (thus avoid depending on building the compiler)\n-  ./x.py test --stage 0 --no-doc library/core library/std\n+## Introduction\n \n-  # execute all doc tests\n-  ./x.py test src/doc\n-  ```\n+The build system defers most of the complicated logic managing invocations\n+of rustc and rustdoc to Cargo itself. However, moving through various stages\n+and copying artifacts is still necessary for it to do. Each time rustbuild\n+is invoked, it will iterate through the list of predefined steps and execute\n+each serially in turn if it matches the paths passed or is a default rule.\n+For each step rustbuild relies on the step internally being incremental and\n+parallel. Note, though, that the `-j` parameter to rustbuild gets forwarded\n+to appropriate test harnesses and such.\n \n-* `doc` - a command for building documentation. Like above, can take arguments\n-  for what to document.\n-\n-## Configuring rustbuild\n-\n-rustbuild offers a TOML-based configuration system with a `config.toml`\n-file. An example of this configuration can be found at `config.toml.example`,\n-and the configuration file can also be passed as `--config path/to/config.toml`\n-if the build system is being invoked manually (via the python script).\n-\n-You can generate a config.toml using `./configure` options if you want to automate creating the file without having to edit it.\n-\n-Finally, rustbuild makes use of the [cc-rs crate] which has [its own\n-method][env-vars] of configuring C compilers and C flags via environment\n-variables.\n-\n-[cc-rs crate]: https://github.com/alexcrichton/cc-rs\n-[env-vars]: https://github.com/alexcrichton/cc-rs#external-configuration-via-environment-variables\n-\n-## Build stages\n+## Build phases\n \n The rustbuild build system goes through a few phases to actually build the\n compiler. What actually happens when you invoke rustbuild is:\n \n-1. The entry point script, `x.py` is run. This script is\n-   responsible for downloading the stage0 compiler/Cargo binaries, and it then\n-   compiles the build system itself (this folder). Finally, it then invokes the\n-   actual `bootstrap` binary build system.\n+1. The entry point script(`x` for unix like systems, `x.ps1` for windows systems,\n+   `x.py` cross-platform) is run. This script is responsible for downloading the stage0\n+   compiler/Cargo binaries, and it then compiles the build system itself (this folder).\n+   Finally, it then invokes the actual `bootstrap` binary build system.\n 2. In Rust, `bootstrap` will slurp up all configuration, perform a number of\n    sanity checks (whether compilers exist, for example), and then start building the\n    stage0 artifacts.\n@@ -115,24 +41,6 @@ compiler. What actually happens when you invoke rustbuild is:\n The goal of each stage is to (a) leverage Cargo as much as possible and failing\n that (b) leverage Rust as much as possible!\n \n-## Incremental builds\n-\n-You can configure rustbuild to use incremental compilation with the\n-`--incremental` flag:\n-\n-```sh\n-$ ./x.py build --incremental\n-```\n-\n-The `--incremental` flag will store incremental compilation artifacts\n-in `build/<host>/stage0-incremental`. Note that we only use incremental\n-compilation for the stage0 -> stage1 compilation -- this is because\n-the stage1 compiler is changing, and we don't try to cache and reuse\n-incremental artifacts across different versions of the compiler.\n-\n-You can always drop the `--incremental` to build as normal (but you\n-will still be using the local nightly as your bootstrap).\n-\n ## Directory Layout\n \n This build system houses all output under the `build` directory, which looks\n@@ -236,63 +144,31 @@ build/\n     # system will link (using hard links) output from stageN-{std,rustc} into\n     # each of these directories.\n     #\n-    # In theory, there is no extra build output in these directories.\n+    # In theory these are working rustc sysroot directories, meaning there is\n+    # no extra build output in these directories.\n     stage1/\n     stage2/\n     stage3/\n ```\n \n-## Cargo projects\n-\n-The current build is unfortunately not quite as simple as `cargo build` in a\n-directory, but rather the compiler is split into three different Cargo projects:\n-\n-* `library/std` - the standard library\n-* `library/test` - testing support, depends on libstd\n-* `compiler/rustc` - the actual compiler itself\n-\n-Each \"project\" has a corresponding Cargo.lock file with all dependencies, and\n-this means that building the compiler involves running Cargo three times. The\n-structure here serves two goals:\n-\n-1. Facilitating dependencies coming from crates.io. These dependencies don't\n-   depend on `std`, so libstd is a separate project compiled ahead of time\n-   before the actual compiler builds.\n-2. Splitting \"host artifacts\" from \"target artifacts\". That is, when building\n-   code for an arbitrary target, you don't need the entire compiler, but you'll\n-   end up needing libraries like libtest that depend on std but also want to use\n-   crates.io dependencies. Hence, libtest is split out as its own project that\n-   is sequenced after `std` but before `rustc`. This project is built for all\n-   targets.\n-\n-There is some loss in build parallelism here because libtest can be compiled in\n-parallel with a number of rustc artifacts, but in theory, the loss isn't too bad!\n-\n-## Build tools\n-\n-We've actually got quite a few tools that we use in the compiler's build system\n-and for testing. To organize these, each tool is a project in `src/tools` with a\n-corresponding `Cargo.toml`. All tools are compiled with Cargo (currently having\n-independent `Cargo.lock` files) and do not currently explicitly depend on the\n-compiler or standard library. Compiling each tool is sequenced after the\n-appropriate libstd/libtest/librustc compile above.\n-\n ## Extending rustbuild\n \n-So, you'd like to add a feature to the rustbuild build system or just fix a bug.\n-Great! One of the major motivational factors for moving away from `make` is that\n-Rust is in theory much easier to read, modify, and write. If you find anything\n-excessively confusing, please open an issue on this, and we'll try to get it\n-documented or simplified, pronto.\n+When you use the bootstrap system, you'll call it through the entry point script\n+(`x`, `x.ps1`, or `x.py`). However, most of the code lives in `src/bootstrap`.\n+`bootstrap` has a difficult problem: it is written in Rust, but yet it is run\n+before the Rust compiler is built! To work around this, there are two components\n+of bootstrap: the main one written in rust, and `bootstrap.py`. `bootstrap.py`\n+is what gets run by entry point script. It takes care of downloading the `stage0`\n+compiler, which will then build the bootstrap binary written in Rust.\n \n-First up, you'll probably want to read over the documentation above, as that'll\n-give you a high level overview of what rustbuild is doing. You also probably\n-want to play around a bit yourself by just getting it up and running before you\n-dive too much into the actual build system itself.\n+Because there are two separate codebases behind `x.py`, they need to\n+be kept in sync. In particular, both `bootstrap.py` and the bootstrap binary\n+parse `config.toml` and read the same command line arguments. `bootstrap.py`\n+keeps these in sync by setting various environment variables, and the\n+programs sometimes have to add arguments that are explicitly ignored, to be\n+read by the other.\n \n-After that, each module in rustbuild should have enough documentation to keep\n-you up and running. Some general areas that you may be interested in modifying\n-are:\n+Some general areas that you may be interested in modifying are:\n \n * Adding a new build tool? Take a look at `bootstrap/tool.rs` for examples of\n   other tools.\n@@ -320,8 +196,9 @@ A 'major change' includes\n Changes that do not affect contributors to the compiler or users\n building rustc from source don't need an update to `VERSION`.\n \n-If you have any questions, feel free to reach out on the `#t-infra` channel in\n-the [Rust Zulip server][rust-zulip] or ask on internals.rust-lang.org. When\n-you encounter bugs, please file issues on the rust-lang/rust issue tracker.\n+If you have any questions, feel free to reach out on the `#t-infra/bootstrap` channel\n+at [Rust Bootstrap Zulip server][rust-bootstrap-zulip]. When you encounter bugs,\n+please file issues on the [Rust issue tracker][rust-issue-tracker].\n \n-[rust-zulip]: https://rust-lang.zulipchat.com/#narrow/stream/242791-t-infra\n+[rust-bootstrap-zulip]: https://rust-lang.zulipchat.com/#narrow/stream/t-infra.2Fbootstrap\n+[rust-issue-tracker]: https://github.com/rust-lang/rust/issues"}, {"sha": "f4abdf1cc57589e51c8c8aec36e07e48dfdecac9", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 0, "deletions": 87, "changes": 87, "blob_url": "https://github.com/rust-lang/rust/blob/3666fa080050594ab3ad26255c069e4d2000a3f4/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3666fa080050594ab3ad26255c069e4d2000a3f4/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=3666fa080050594ab3ad26255c069e4d2000a3f4", "patch": "@@ -11,93 +11,6 @@\n //!   crates.io and Cargo.\n //! * A standard interface to build across all platforms, including MSVC\n //!\n-//! ## Architecture\n-//!\n-//! The build system defers most of the complicated logic managing invocations\n-//! of rustc and rustdoc to Cargo itself. However, moving through various stages\n-//! and copying artifacts is still necessary for it to do. Each time rustbuild\n-//! is invoked, it will iterate through the list of predefined steps and execute\n-//! each serially in turn if it matches the paths passed or is a default rule.\n-//! For each step rustbuild relies on the step internally being incremental and\n-//! parallel. Note, though, that the `-j` parameter to rustbuild gets forwarded\n-//! to appropriate test harnesses and such.\n-//!\n-//! Most of the \"meaty\" steps that matter are backed by Cargo, which does indeed\n-//! have its own parallelism and incremental management. Later steps, like\n-//! tests, aren't incremental and simply run the entire suite currently.\n-//! However, compiletest itself tries to avoid running tests when the artifacts\n-//! that are involved (mainly the compiler) haven't changed.\n-//!\n-//! When you execute `x.py build`, the steps executed are:\n-//!\n-//! * First, the python script is run. This will automatically download the\n-//!   stage0 rustc and cargo according to `src/stage0.json`, or use the cached\n-//!   versions if they're available. These are then used to compile rustbuild\n-//!   itself (using Cargo). Finally, control is then transferred to rustbuild.\n-//!\n-//! * Rustbuild takes over, performs sanity checks, probes the environment,\n-//!   reads configuration, and starts executing steps as it reads the command\n-//!   line arguments (paths) or going through the default rules.\n-//!\n-//!   The build output will be something like the following:\n-//!\n-//!   Building stage0 std artifacts\n-//!   Copying stage0 std\n-//!   Building stage0 test artifacts\n-//!   Copying stage0 test\n-//!   Building stage0 compiler artifacts\n-//!   Copying stage0 rustc\n-//!   Assembling stage1 compiler\n-//!   Building stage1 std artifacts\n-//!   Copying stage1 std\n-//!   Building stage1 test artifacts\n-//!   Copying stage1 test\n-//!   Building stage1 compiler artifacts\n-//!   Copying stage1 rustc\n-//!   Assembling stage2 compiler\n-//!   Uplifting stage1 std\n-//!   Uplifting stage1 test\n-//!   Uplifting stage1 rustc\n-//!\n-//! Let's disect that a little:\n-//!\n-//! ## Building stage0 {std,test,compiler} artifacts\n-//!\n-//! These steps use the provided (downloaded, usually) compiler to compile the\n-//! local Rust source into libraries we can use.\n-//!\n-//! ## Copying stage0 {std,test,rustc}\n-//!\n-//! This copies the build output from Cargo into\n-//! `build/$HOST/stage0-sysroot/lib/rustlib/$ARCH/lib`. FIXME: this step's\n-//! documentation should be expanded -- the information already here may be\n-//! incorrect.\n-//!\n-//! ## Assembling stage1 compiler\n-//!\n-//! This copies the libraries we built in \"building stage0 ... artifacts\" into\n-//! the stage1 compiler's lib directory. These are the host libraries that the\n-//! compiler itself uses to run. These aren't actually used by artifacts the new\n-//! compiler generates. This step also copies the rustc and rustdoc binaries we\n-//! generated into build/$HOST/stage/bin.\n-//!\n-//! The stage1/bin/rustc is a fully functional compiler, but it doesn't yet have\n-//! any libraries to link built binaries or libraries to. The next 3 steps will\n-//! provide those libraries for it; they are mostly equivalent to constructing\n-//! the stage1/bin compiler so we don't go through them individually.\n-//!\n-//! ## Uplifting stage1 {std,test,rustc}\n-//!\n-//! This step copies the libraries from the stage1 compiler sysroot into the\n-//! stage2 compiler. This is done to avoid rebuilding the compiler; libraries\n-//! we'd build in this step should be identical (in function, if not necessarily\n-//! identical on disk) so there's no need to recompile the compiler again. Note\n-//! that if you want to, you can enable the full-bootstrap option to change this\n-//! behavior.\n-//!\n-//! Each step is driven by a separate Cargo project and rustbuild orchestrates\n-//! copying files between steps and otherwise preparing for Cargo to run.\n-//!\n //! ## Further information\n //!\n //! More documentation can be found in each respective module below, and you can"}]}