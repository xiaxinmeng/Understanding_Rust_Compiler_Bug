{"sha": "5e8e1b515a9ef1cd38ee0c71f032415906a7f42d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlOGUxYjUxNWE5ZWYxY2QzOGVlMGM3MWYwMzI0MTU5MDZhN2Y0MmQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-22T15:36:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-22T15:36:50Z"}, "message": "auto merge of #13078 : klutzy/rust/issue-13075, r=alexcrichton\n\n`FormatMessageW()` is called by `std::os::last_os_error()` to convert\r\nerrno into string, but the function may fail on non-english locale.\r\nI don't know why it fails, but anyway it's better to return errno\r\nthan to `fail!()` in the case.\r\n\r\nFixes #13075\r\nFixes #13073", "tree": {"sha": "e7003afab13be48f15f121a8dd04e47d938a06d4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7003afab13be48f15f121a8dd04e47d938a06d4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e8e1b515a9ef1cd38ee0c71f032415906a7f42d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e8e1b515a9ef1cd38ee0c71f032415906a7f42d", "html_url": "https://github.com/rust-lang/rust/commit/5e8e1b515a9ef1cd38ee0c71f032415906a7f42d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e8e1b515a9ef1cd38ee0c71f032415906a7f42d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e233a43f5a0e14ceb322b955b16c8967adb2f4a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e233a43f5a0e14ceb322b955b16c8967adb2f4a8", "html_url": "https://github.com/rust-lang/rust/commit/e233a43f5a0e14ceb322b955b16c8967adb2f4a8"}, {"sha": "cffe9e041dc62b98ac83f34c78128febda3d6122", "url": "https://api.github.com/repos/rust-lang/rust/commits/cffe9e041dc62b98ac83f34c78128febda3d6122", "html_url": "https://github.com/rust-lang/rust/commit/cffe9e041dc62b98ac83f34c78128febda3d6122"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "f270c7e7a743c13f137e98df8aadc5bfff12c45a", "filename": "src/libstd/os.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5e8e1b515a9ef1cd38ee0c71f032415906a7f42d/src%2Flibstd%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e8e1b515a9ef1cd38ee0c71f032415906a7f42d/src%2Flibstd%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fos.rs?ref=5e8e1b515a9ef1cd38ee0c71f032415906a7f42d", "patch": "@@ -740,11 +740,16 @@ pub fn last_os_error() -> ~str {\n                                      buf.len() as DWORD,\n                                      ptr::null());\n             if res == 0 {\n-                fail!(\"[{}] FormatMessage failure\", errno());\n+                // Sometimes FormatMessageW can fail e.g. system doesn't like langId,\n+                let fm_err = errno();\n+                return format!(\"OS Error {} (FormatMessageW() returned error {})\", err, fm_err);\n             }\n \n-            str::from_utf16(str::truncate_utf16_at_nul(buf))\n-                .expect(\"FormatMessageW returned invalid UTF-16\")\n+            let msg = str::from_utf16(str::truncate_utf16_at_nul(buf));\n+            match msg {\n+                Some(msg) => format!(\"OS Error {}: {}\", err, msg),\n+                None => format!(\"OS Error {} (FormatMessageW() returned invalid UTF-16)\", err),\n+            }\n         }\n     }\n "}]}