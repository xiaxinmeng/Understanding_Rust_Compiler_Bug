{"sha": "dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "node_id": "C_kwDOAAsO6NoAKGRjZDcxNmZlZTIzMDNjOTNhMGJmMWJhNjhlNjY3YzliYzRiZjM1NTg", "commit": {"author": {"name": "lcnr", "email": "rust@lcnr.de", "date": "2021-05-07T18:00:02Z"}, "committer": {"name": "lcnr", "email": "rust@lcnr.de", "date": "2021-12-14T12:32:42Z"}, "message": "extend `simplify_type`", "tree": {"sha": "06fbf4248ed530c10b97b195276180bd510e9a24", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/06fbf4248ed530c10b97b195276180bd510e9a24"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "html_url": "https://github.com/rust-lang/rust/commit/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "83b32f27fc6c34b0b411f47be31ab4ae07eafed4", "url": "https://api.github.com/repos/rust-lang/rust/commits/83b32f27fc6c34b0b411f47be31ab4ae07eafed4", "html_url": "https://github.com/rust-lang/rust/commit/83b32f27fc6c34b0b411f47be31ab4ae07eafed4"}], "stats": {"total": 175, "additions": 132, "deletions": 43}, "files": [{"sha": "3154859bc651b2b2f64283a7fa06c8bccf6174a1", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -26,6 +26,7 @@ use rustc_middle::mir::interpret;\n use rustc_middle::thir;\n use rustc_middle::traits::specialization_graph;\n use rustc_middle::ty::codec::TyEncoder;\n+use rustc_middle::ty::fast_reject::{self, SimplifyParams, StripReferences};\n use rustc_middle::ty::{self, SymbolName, Ty, TyCtxt};\n use rustc_serialize::{opaque, Encodable, Encoder};\n use rustc_session::config::CrateType;\n@@ -2033,15 +2034,19 @@ impl EncodeContext<'a, 'tcx> {\n \n struct ImplVisitor<'tcx> {\n     tcx: TyCtxt<'tcx>,\n-    impls: FxHashMap<DefId, Vec<(DefIndex, Option<ty::fast_reject::SimplifiedType>)>>,\n+    impls: FxHashMap<DefId, Vec<(DefIndex, Option<fast_reject::SimplifiedType>)>>,\n }\n \n impl<'tcx, 'v> ItemLikeVisitor<'v> for ImplVisitor<'tcx> {\n     fn visit_item(&mut self, item: &hir::Item<'_>) {\n         if let hir::ItemKind::Impl { .. } = item.kind {\n             if let Some(trait_ref) = self.tcx.impl_trait_ref(item.def_id.to_def_id()) {\n-                let simplified_self_ty =\n-                    ty::fast_reject::simplify_type(self.tcx, trait_ref.self_ty(), false);\n+                let simplified_self_ty = fast_reject::simplify_type(\n+                    self.tcx,\n+                    trait_ref.self_ty(),\n+                    SimplifyParams::No,\n+                    StripReferences::No,\n+                );\n \n                 self.impls\n                     .entry(trait_ref.def_id)"}, {"sha": "f49472afb1c132776265a66207477c6a502b7ebd", "filename": "compiler/rustc_middle/src/ty/fast_reject.rs", "status": "modified", "additions": 38, "deletions": 14, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffast_reject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffast_reject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffast_reject.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -1,3 +1,4 @@\n+use crate::mir::Mutability;\n use crate::ty::{self, Ty, TyCtxt};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_hir::def_id::DefId;\n@@ -27,9 +28,12 @@ where\n     UintSimplifiedType(ty::UintTy),\n     FloatSimplifiedType(ty::FloatTy),\n     AdtSimplifiedType(D),\n+    ForeignSimplifiedType(DefId),\n     StrSimplifiedType,\n     ArraySimplifiedType,\n-    PtrSimplifiedType,\n+    SliceSimplifiedType,\n+    RefSimplifiedType(Mutability),\n+    PtrSimplifiedType(Mutability),\n     NeverSimplifiedType,\n     TupleSimplifiedType(usize),\n     /// A trait object, all of whose components are markers\n@@ -42,7 +46,18 @@ where\n     OpaqueSimplifiedType(D),\n     FunctionSimplifiedType(usize),\n     ParameterSimplifiedType,\n-    ForeignSimplifiedType(DefId),\n+}\n+\n+#[derive(PartialEq, Eq, Debug, Clone, Copy)]\n+pub enum SimplifyParams {\n+    Yes,\n+    No,\n+}\n+\n+#[derive(PartialEq, Eq, Debug, Clone, Copy)]\n+pub enum StripReferences {\n+    Yes,\n+    No,\n }\n \n /// Tries to simplify a type by dropping type parameters, deref'ing away any reference types, etc.\n@@ -57,7 +72,8 @@ where\n pub fn simplify_type(\n     tcx: TyCtxt<'_>,\n     ty: Ty<'_>,\n-    can_simplify_params: bool,\n+    can_simplify_params: SimplifyParams,\n+    strip_references: StripReferences,\n ) -> Option<SimplifiedType> {\n     match *ty.kind() {\n         ty::Bool => Some(BoolSimplifiedType),\n@@ -67,19 +83,24 @@ pub fn simplify_type(\n         ty::Float(float_type) => Some(FloatSimplifiedType(float_type)),\n         ty::Adt(def, _) => Some(AdtSimplifiedType(def.did)),\n         ty::Str => Some(StrSimplifiedType),\n-        ty::Array(..) | ty::Slice(_) => Some(ArraySimplifiedType),\n-        ty::RawPtr(_) => Some(PtrSimplifiedType),\n+        ty::Array(..) => Some(ArraySimplifiedType),\n+        ty::Slice(..) => Some(SliceSimplifiedType),\n+        ty::RawPtr(ptr) => Some(PtrSimplifiedType(ptr.mutbl)),\n         ty::Dynamic(ref trait_info, ..) => match trait_info.principal_def_id() {\n             Some(principal_def_id) if !tcx.trait_is_auto(principal_def_id) => {\n                 Some(TraitSimplifiedType(principal_def_id))\n             }\n             _ => Some(MarkerTraitObjectSimplifiedType),\n         },\n-        ty::Ref(_, ty, _) => {\n-            // since we introduce auto-refs during method lookup, we\n-            // just treat &T and T as equivalent from the point of\n-            // view of possibly unifying\n-            simplify_type(tcx, ty, can_simplify_params)\n+        ty::Ref(_, ty, mutbl) => {\n+            if strip_references == StripReferences::Yes {\n+                // For diagnostics, when recommending similar impls we want to\n+                // recommend impls even when there is a reference mismatch,\n+                // so we treat &T and T equivalently in that case.\n+                simplify_type(tcx, ty, can_simplify_params, strip_references)\n+            } else {\n+                Some(RefSimplifiedType(mutbl))\n+            }\n         }\n         ty::FnDef(def_id, _) | ty::Closure(def_id, _) => Some(ClosureSimplifiedType(def_id)),\n         ty::Generator(def_id, _, _) => Some(GeneratorSimplifiedType(def_id)),\n@@ -90,7 +111,7 @@ pub fn simplify_type(\n         ty::Tuple(ref tys) => Some(TupleSimplifiedType(tys.len())),\n         ty::FnPtr(ref f) => Some(FunctionSimplifiedType(f.skip_binder().inputs().len())),\n         ty::Projection(_) | ty::Param(_) => {\n-            if can_simplify_params {\n+            if can_simplify_params == SimplifyParams::Yes {\n                 // In normalized types, projections don't unify with\n                 // anything. when lazy normalization happens, this\n                 // will change. It would still be nice to have a way\n@@ -120,9 +141,12 @@ impl<D: Copy + Debug + Ord + Eq> SimplifiedTypeGen<D> {\n             UintSimplifiedType(t) => UintSimplifiedType(t),\n             FloatSimplifiedType(t) => FloatSimplifiedType(t),\n             AdtSimplifiedType(d) => AdtSimplifiedType(map(d)),\n+            ForeignSimplifiedType(d) => ForeignSimplifiedType(d),\n             StrSimplifiedType => StrSimplifiedType,\n             ArraySimplifiedType => ArraySimplifiedType,\n-            PtrSimplifiedType => PtrSimplifiedType,\n+            SliceSimplifiedType => SliceSimplifiedType,\n+            RefSimplifiedType(m) => RefSimplifiedType(m),\n+            PtrSimplifiedType(m) => PtrSimplifiedType(m),\n             NeverSimplifiedType => NeverSimplifiedType,\n             MarkerTraitObjectSimplifiedType => MarkerTraitObjectSimplifiedType,\n             TupleSimplifiedType(n) => TupleSimplifiedType(n),\n@@ -133,7 +157,6 @@ impl<D: Copy + Debug + Ord + Eq> SimplifiedTypeGen<D> {\n             OpaqueSimplifiedType(d) => OpaqueSimplifiedType(map(d)),\n             FunctionSimplifiedType(n) => FunctionSimplifiedType(n),\n             ParameterSimplifiedType => ParameterSimplifiedType,\n-            ForeignSimplifiedType(d) => ForeignSimplifiedType(d),\n         }\n     }\n }\n@@ -149,12 +172,13 @@ where\n             | CharSimplifiedType\n             | StrSimplifiedType\n             | ArraySimplifiedType\n-            | PtrSimplifiedType\n+            | SliceSimplifiedType\n             | NeverSimplifiedType\n             | ParameterSimplifiedType\n             | MarkerTraitObjectSimplifiedType => {\n                 // nothing to do\n             }\n+            RefSimplifiedType(m) | PtrSimplifiedType(m) => m.hash_stable(hcx, hasher),\n             IntSimplifiedType(t) => t.hash_stable(hcx, hasher),\n             UintSimplifiedType(t) => t.hash_stable(hcx, hasher),\n             FloatSimplifiedType(t) => t.hash_stable(hcx, hasher),"}, {"sha": "4a415b7a228437f3e46e90484313d9fdf43e391d", "filename": "compiler/rustc_middle/src/ty/trait_def.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_middle%2Fsrc%2Fty%2Ftrait_def.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_middle%2Fsrc%2Fty%2Ftrait_def.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Ftrait_def.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -1,5 +1,5 @@\n use crate::traits::specialization_graph;\n-use crate::ty::fast_reject;\n+use crate::ty::fast_reject::{self, SimplifyParams, StripReferences};\n use crate::ty::fold::TypeFoldable;\n use crate::ty::{Ty, TyCtxt};\n use rustc_hir as hir;\n@@ -179,7 +179,9 @@ impl<'tcx> TyCtxt<'tcx> {\n         // blanket and non-blanket impls, and compare them separately.\n         //\n         // I think we'll cross that bridge when we get to it.\n-        if let Some(simp) = fast_reject::simplify_type(self, self_ty, true) {\n+        if let Some(simp) =\n+            fast_reject::simplify_type(self, self_ty, SimplifyParams::Yes, StripReferences::No)\n+        {\n             if let Some(impls) = impls.non_blanket_impls.get(&simp) {\n                 for &impl_def_id in impls {\n                     if let result @ Some(_) = f(impl_def_id) {\n@@ -238,7 +240,9 @@ pub(super) fn trait_impls_of_provider(tcx: TyCtxt<'_>, trait_id: DefId) -> Trait\n             continue;\n         }\n \n-        if let Some(simplified_self_ty) = fast_reject::simplify_type(tcx, impl_self_ty, false) {\n+        if let Some(simplified_self_ty) =\n+            fast_reject::simplify_type(tcx, impl_self_ty, SimplifyParams::No, StripReferences::No)\n+        {\n             impls.non_blanket_impls.entry(simplified_self_ty).or_default().push(impl_def_id);\n         } else {\n             impls.blanket_impls.push(impl_def_id);"}, {"sha": "5fac2e55b1d0d98a6ac777eeb5c07baed894ed06", "filename": "compiler/rustc_trait_selection/src/traits/coherence.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -12,9 +12,10 @@ use crate::traits::{\n     self, Normalized, Obligation, ObligationCause, PredicateObligation, SelectionContext,\n };\n use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n+use rustc_middle::ty::fast_reject::{self, SimplifyParams, StripReferences};\n use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::subst::Subst;\n-use rustc_middle::ty::{self, fast_reject, Ty, TyCtxt};\n+use rustc_middle::ty::{self, Ty, TyCtxt};\n use rustc_span::symbol::sym;\n use rustc_span::DUMMY_SP;\n use std::iter;\n@@ -82,12 +83,11 @@ where\n         impl2_ref.iter().flat_map(|tref| tref.substs.types()),\n     )\n     .any(|(ty1, ty2)| {\n-        let t1 = fast_reject::simplify_type(tcx, ty1, false);\n-        let t2 = fast_reject::simplify_type(tcx, ty2, false);\n+        let t1 = fast_reject::simplify_type(tcx, ty1, SimplifyParams::No, StripReferences::No);\n+        let t2 = fast_reject::simplify_type(tcx, ty2, SimplifyParams::No, StripReferences::No);\n         if let (Some(t1), Some(t2)) = (t1, t2) {\n             // Simplified successfully\n-            // Types cannot unify if they differ in their reference mutability or simplify to different types\n-            t1 != t2 || ty1.ref_mutability() != ty2.ref_mutability()\n+            t1 != t2\n         } else {\n             // Types might unify\n             false"}, {"sha": "00b469c686ad1f3d89c4c3c12a3df6ad28551a97", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -21,9 +21,10 @@ use rustc_hir::Item;\n use rustc_hir::Node;\n use rustc_middle::thir::abstract_const::NotConstEvaluatable;\n use rustc_middle::ty::error::ExpectedFound;\n+use rustc_middle::ty::fast_reject::{self, SimplifyParams, StripReferences};\n use rustc_middle::ty::fold::TypeFolder;\n use rustc_middle::ty::{\n-    self, fast_reject, AdtKind, SubtypePredicate, ToPolyTraitRef, ToPredicate, Ty, TyCtxt,\n+    self, AdtKind, SubtypePredicate, ToPolyTraitRef, ToPredicate, Ty, TyCtxt,\n     TypeFoldable,\n };\n use rustc_session::DiagnosticMessageId;\n@@ -1439,14 +1440,24 @@ impl<'a, 'tcx> InferCtxtPrivExt<'tcx> for InferCtxt<'a, 'tcx> {\n         &self,\n         trait_ref: ty::PolyTraitRef<'tcx>,\n     ) -> Vec<ty::TraitRef<'tcx>> {\n-        let simp = fast_reject::simplify_type(self.tcx, trait_ref.skip_binder().self_ty(), true);\n+        let simp = fast_reject::simplify_type(\n+            self.tcx,\n+            trait_ref.skip_binder().self_ty(),\n+            SimplifyParams::Yes,\n+            StripReferences::Yes,\n+        );\n         let all_impls = self.tcx.all_impls(trait_ref.def_id());\n \n         match simp {\n             Some(simp) => all_impls\n                 .filter_map(|def_id| {\n                     let imp = self.tcx.impl_trait_ref(def_id).unwrap();\n-                    let imp_simp = fast_reject::simplify_type(self.tcx, imp.self_ty(), true);\n+                    let imp_simp = fast_reject::simplify_type(\n+                        self.tcx,\n+                        imp.self_ty(),\n+                        SimplifyParams::Yes,\n+                        StripReferences::Yes,\n+                    );\n                     if let Some(imp_simp) = imp_simp {\n                         if simp != imp_simp {\n                             return None;"}, {"sha": "607deb8f90875cb9f589226b9472db6ed2c2ed75", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -35,7 +35,7 @@ use rustc_infer::infer::LateBoundRegionConversionTime;\n use rustc_middle::dep_graph::{DepKind, DepNodeIndex};\n use rustc_middle::mir::interpret::ErrorHandled;\n use rustc_middle::thir::abstract_const::NotConstEvaluatable;\n-use rustc_middle::ty::fast_reject;\n+use rustc_middle::ty::fast_reject::{self, SimplifyParams, StripReferences};\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::relate::TypeRelation;\n use rustc_middle::ty::subst::{GenericArgKind, Subst, SubstsRef};\n@@ -2089,10 +2089,21 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             |(obligation_arg, impl_arg)| {\n                 match (obligation_arg.unpack(), impl_arg.unpack()) {\n                     (GenericArgKind::Type(obligation_ty), GenericArgKind::Type(impl_ty)) => {\n-                        let simplified_obligation_ty =\n-                            fast_reject::simplify_type(self.tcx(), obligation_ty, true);\n-                        let simplified_impl_ty =\n-                            fast_reject::simplify_type(self.tcx(), impl_ty, false);\n+                        // Note, we simplify parameters for the obligation but not the\n+                        // impl so that we do not reject a blanket impl but do reject\n+                        // more concrete impls if we're searching for `T: Trait`.\n+                        let simplified_obligation_ty = fast_reject::simplify_type(\n+                            self.tcx(),\n+                            obligation_ty,\n+                            SimplifyParams::Yes,\n+                            StripReferences::No,\n+                        );\n+                        let simplified_impl_ty = fast_reject::simplify_type(\n+                            self.tcx(),\n+                            impl_ty,\n+                            SimplifyParams::No,\n+                            StripReferences::No,\n+                        );\n \n                         simplified_obligation_ty.is_some()\n                             && simplified_impl_ty.is_some()"}, {"sha": "2f9d2c47b011fba28e3034d10f55e561f2b19746", "filename": "compiler/rustc_trait_selection/src/traits/specialize/specialization_graph.rs", "status": "modified", "additions": 19, "deletions": 4, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fspecialization_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fspecialization_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fspecialization_graph.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -2,7 +2,7 @@ use super::OverlapError;\n \n use crate::traits;\n use rustc_hir::def_id::DefId;\n-use rustc_middle::ty::fast_reject::{self, SimplifiedType};\n+use rustc_middle::ty::fast_reject::{self, SimplifiedType, SimplifyParams, StripReferences};\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::{self, TyCtxt, TypeFoldable};\n \n@@ -48,7 +48,12 @@ impl ChildrenExt for Children {\n     /// Insert an impl into this set of children without comparing to any existing impls.\n     fn insert_blindly(&mut self, tcx: TyCtxt<'tcx>, impl_def_id: DefId) {\n         let trait_ref = tcx.impl_trait_ref(impl_def_id).unwrap();\n-        if let Some(st) = fast_reject::simplify_type(tcx, trait_ref.self_ty(), false) {\n+        if let Some(st) = fast_reject::simplify_type(\n+            tcx,\n+            trait_ref.self_ty(),\n+            SimplifyParams::No,\n+            StripReferences::No,\n+        ) {\n             debug!(\"insert_blindly: impl_def_id={:?} st={:?}\", impl_def_id, st);\n             self.non_blanket_impls.entry(st).or_default().push(impl_def_id)\n         } else {\n@@ -63,7 +68,12 @@ impl ChildrenExt for Children {\n     fn remove_existing(&mut self, tcx: TyCtxt<'tcx>, impl_def_id: DefId) {\n         let trait_ref = tcx.impl_trait_ref(impl_def_id).unwrap();\n         let vec: &mut Vec<DefId>;\n-        if let Some(st) = fast_reject::simplify_type(tcx, trait_ref.self_ty(), false) {\n+        if let Some(st) = fast_reject::simplify_type(\n+            tcx,\n+            trait_ref.self_ty(),\n+            SimplifyParams::No,\n+            StripReferences::No,\n+        ) {\n             debug!(\"remove_existing: impl_def_id={:?} st={:?}\", impl_def_id, st);\n             vec = self.non_blanket_impls.get_mut(&st).unwrap();\n         } else {\n@@ -306,7 +316,12 @@ impl GraphExt for Graph {\n \n         let mut parent = trait_def_id;\n         let mut last_lint = None;\n-        let simplified = fast_reject::simplify_type(tcx, trait_ref.self_ty(), false);\n+        let simplified = fast_reject::simplify_type(\n+            tcx,\n+            trait_ref.self_ty(),\n+            SimplifyParams::No,\n+            StripReferences::No,\n+        );\n \n         // Descend the specialization tree, where `parent` is the current parent node.\n         loop {"}, {"sha": "41c652616ca86df48eee09eb40e9442aa4d36665", "filename": "compiler/rustc_typeck/src/check/method/suggest.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -10,7 +10,7 @@ use rustc_hir::def_id::{DefId, LocalDefId, CRATE_DEF_INDEX};\n use rustc_hir::lang_items::LangItem;\n use rustc_hir::{ExprKind, Node, QPath};\n use rustc_infer::infer::type_variable::{TypeVariableOrigin, TypeVariableOriginKind};\n-use rustc_middle::ty::fast_reject::simplify_type;\n+use rustc_middle::ty::fast_reject::{simplify_type, SimplifyParams, StripReferences};\n use rustc_middle::ty::print::with_crate_prefix;\n use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable};\n use rustc_span::lev_distance;\n@@ -1703,7 +1703,9 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 // FIXME: Even though negative bounds are not implemented, we could maybe handle\n                 // cases where a positive bound implies a negative impl.\n                 (candidates, Vec::new())\n-            } else if let Some(simp_rcvr_ty) = simplify_type(self.tcx, rcvr_ty, true) {\n+            } else if let Some(simp_rcvr_ty) =\n+                simplify_type(self.tcx, rcvr_ty, SimplifyParams::Yes, StripReferences::No)\n+            {\n                 let mut potential_candidates = Vec::new();\n                 let mut explicitly_negative = Vec::new();\n                 for candidate in candidates {\n@@ -1716,7 +1718,12 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         })\n                         .any(|imp_did| {\n                             let imp = self.tcx.impl_trait_ref(imp_did).unwrap();\n-                            let imp_simp = simplify_type(self.tcx, imp.self_ty(), true);\n+                            let imp_simp = simplify_type(\n+                                self.tcx,\n+                                imp.self_ty(),\n+                                SimplifyParams::Yes,\n+                                StripReferences::No,\n+                            );\n                             imp_simp.map_or(false, |s| s == simp_rcvr_ty)\n                         })\n                     {"}, {"sha": "8ce70b1ac0677c53494c4bc7a86d75f82c85d6ab", "filename": "src/test/ui/auto-traits/typeck-default-trait-impl-precedence.stderr", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/src%2Ftest%2Fui%2Fauto-traits%2Ftypeck-default-trait-impl-precedence.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/src%2Ftest%2Fui%2Fauto-traits%2Ftypeck-default-trait-impl-precedence.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fauto-traits%2Ftypeck-default-trait-impl-precedence.stderr?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -4,7 +4,11 @@ error[E0277]: the trait bound `u32: Signed` is not satisfied\n LL |     is_defaulted::<&'static u32>();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `Signed` is not implemented for `u32`\n    |\n-   = note: required because of the requirements on the impl of `Defaulted` for `&'static u32`\n+note: required because of the requirements on the impl of `Defaulted` for `&'static u32`\n+  --> $DIR/typeck-default-trait-impl-precedence.rs:10:19\n+   |\n+LL | impl<'a,T:Signed> Defaulted for &'a T { }\n+   |                   ^^^^^^^^^     ^^^^^\n note: required by a bound in `is_defaulted`\n   --> $DIR/typeck-default-trait-impl-precedence.rs:12:19\n    |"}, {"sha": "aef6db0a40b75658466ad1d45d20e12dc6e2ddad", "filename": "src/test/ui/wf/hir-wf-check-erase-regions.stderr", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dcd716fee2303c93a0bf1ba68e667c9bc4bf3558/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.stderr?ref=dcd716fee2303c93a0bf1ba68e667c9bc4bf3558", "patch": "@@ -5,7 +5,11 @@ LL |     type IntoIter = std::iter::Flatten<std::slice::Iter<'a, T>>;\n    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `&T` is not an iterator\n    |\n    = help: the trait `Iterator` is not implemented for `&T`\n-   = note: required because of the requirements on the impl of `IntoIterator` for `&T`\n+note: required because of the requirements on the impl of `IntoIterator` for `&T`\n+  --> $DIR/hir-wf-check-erase-regions.rs:6:29\n+   |\n+LL | impl<'a, T, const N: usize> IntoIterator for &'a Table<T, N> {\n+   |                             ^^^^^^^^^^^^     ^^^^^^^^^^^^^^^\n note: required by a bound in `Flatten`\n   --> $SRC_DIR/core/src/iter/adapters/flatten.rs:LL:COL\n    |\n@@ -19,7 +23,11 @@ LL |     fn into_iter(self) -> Self::IntoIter {\n    |                           ^^^^^^^^^^^^^^ `&T` is not an iterator\n    |\n    = help: the trait `Iterator` is not implemented for `&T`\n-   = note: required because of the requirements on the impl of `IntoIterator` for `&T`\n+note: required because of the requirements on the impl of `IntoIterator` for `&T`\n+  --> $DIR/hir-wf-check-erase-regions.rs:6:29\n+   |\n+LL | impl<'a, T, const N: usize> IntoIterator for &'a Table<T, N> {\n+   |                             ^^^^^^^^^^^^     ^^^^^^^^^^^^^^^\n note: required by a bound in `Flatten`\n   --> $SRC_DIR/core/src/iter/adapters/flatten.rs:LL:COL\n    |"}]}