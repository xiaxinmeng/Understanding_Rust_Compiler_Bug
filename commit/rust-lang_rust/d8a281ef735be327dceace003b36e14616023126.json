{"sha": "d8a281ef735be327dceace003b36e14616023126", "node_id": "C_kwDOAAsO6NoAKGQ4YTI4MWVmNzM1YmUzMjdkY2VhY2UwMDNiMzZlMTQ2MTYwMjMxMjY", "commit": {"author": {"name": "Micha White", "email": "botahamec@outlook.com", "date": "2022-05-21T21:02:00Z"}, "committer": {"name": "Micha White", "email": "botahamec@outlook.com", "date": "2022-05-25T02:53:29Z"}, "message": "Added an unused_rounding lint", "tree": {"sha": "0ec002090ca365ae51014e09dd080e5c1b7f4f13", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ec002090ca365ae51014e09dd080e5c1b7f4f13"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d8a281ef735be327dceace003b36e14616023126", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEGofhdE61kfoixWy+rtlL+hwwE4kFAmKNmisACgkQrtlL+hww\nE4nBHhAAkt8hV6VKQMjUqCADPW1L/w23MQhnrioW5eQD9df7UA3iKHtSLWTcIm0Z\nDMbzFqlEf/NL2+0rtqGYtwP/sBZ8JCFQK4iF0czhUFLlX9xl9MIUSqsYYeYVD3Mi\nJ9u2IKeJcGpPWda2Vfo2LIEMGwJsIPrZ//tepGF+JJ0gMsQMEMnDBPSt0R8fWRqg\nPGJgkf/FD5l3kM1L7mXWC31DGy7C6E53rP2jmL4BhOmQYWEVq5h3c+1ZC0h4X6y6\n5ZqEuybmY91x9PRM16NqM6o+K6NCUOpBp+6WfvZjnOdDSHU2cQfKq+kUTLfy5ZFs\nOAkgqbJld/ucLPFbps2bQN/+W33uFIJmVOvVVmLgURibKkPhK0II3K/tr5HkIenh\naitNzXjehJNNAjgmVHAFvwY2sYDsHTSY2qlN7CMetJuVXafW0Y5/rZ2ZI0TeWEG+\nzropRImjRU3EL9E7R7Va+wdDNzHh7Y8aA/flhj8qYM3FzVG0C1HUhZA8e+rPocU7\nZIkqqqgVc0c7o6MH2zJT0T6/vIpjdXHTpA533lduiJ9dmasWTKCo8yKsU/7w8v7J\nyigxn7qI1G1C3cduZYcrqB0Wor7wA2fuVJsOkRlHKheiPd386PoTWmyV7D2dKUgy\nULY8qF7mvHPiQ10TIbvllyDzgT8gbXUY+wx+mIHLGf8DSH2MPE0=\n=gfTg\n-----END PGP SIGNATURE-----", "payload": "tree 0ec002090ca365ae51014e09dd080e5c1b7f4f13\nparent 3cc50a4a0816efd4e1964025e7abdeba3a661275\nauthor Micha White <botahamec@outlook.com> 1653166920 -0400\ncommitter Micha White <botahamec@outlook.com> 1653447209 -0400\n\nAdded an unused_rounding lint\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d8a281ef735be327dceace003b36e14616023126", "html_url": "https://github.com/rust-lang/rust/commit/d8a281ef735be327dceace003b36e14616023126", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d8a281ef735be327dceace003b36e14616023126/comments", "author": {"login": "botahamec", "id": 32026883, "node_id": "MDQ6VXNlcjMyMDI2ODgz", "avatar_url": "https://avatars.githubusercontent.com/u/32026883?v=4", "gravatar_id": "", "url": "https://api.github.com/users/botahamec", "html_url": "https://github.com/botahamec", "followers_url": "https://api.github.com/users/botahamec/followers", "following_url": "https://api.github.com/users/botahamec/following{/other_user}", "gists_url": "https://api.github.com/users/botahamec/gists{/gist_id}", "starred_url": "https://api.github.com/users/botahamec/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/botahamec/subscriptions", "organizations_url": "https://api.github.com/users/botahamec/orgs", "repos_url": "https://api.github.com/users/botahamec/repos", "events_url": "https://api.github.com/users/botahamec/events{/privacy}", "received_events_url": "https://api.github.com/users/botahamec/received_events", "type": "User", "site_admin": false}, "committer": {"login": "botahamec", "id": 32026883, "node_id": "MDQ6VXNlcjMyMDI2ODgz", "avatar_url": "https://avatars.githubusercontent.com/u/32026883?v=4", "gravatar_id": "", "url": "https://api.github.com/users/botahamec", "html_url": "https://github.com/botahamec", "followers_url": "https://api.github.com/users/botahamec/followers", "following_url": "https://api.github.com/users/botahamec/following{/other_user}", "gists_url": "https://api.github.com/users/botahamec/gists{/gist_id}", "starred_url": "https://api.github.com/users/botahamec/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/botahamec/subscriptions", "organizations_url": "https://api.github.com/users/botahamec/orgs", "repos_url": "https://api.github.com/users/botahamec/repos", "events_url": "https://api.github.com/users/botahamec/events{/privacy}", "received_events_url": "https://api.github.com/users/botahamec/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3cc50a4a0816efd4e1964025e7abdeba3a661275", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cc50a4a0816efd4e1964025e7abdeba3a661275", "html_url": "https://github.com/rust-lang/rust/commit/3cc50a4a0816efd4e1964025e7abdeba3a661275"}], "stats": {"total": 112, "additions": 112, "deletions": 0}, "files": [{"sha": "137fd793e754c266768001d7483f7270963e2f1c", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -3821,6 +3821,7 @@ Released 2018-09-13\n [`unused_collect`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_collect\n [`unused_io_amount`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_io_amount\n [`unused_label`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_label\n+[`unused_rounding`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_rounding\n [`unused_self`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_self\n [`unused_unit`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_unit\n [`unusual_byte_groupings`]: https://rust-lang.github.io/rust-clippy/master/index.html#unusual_byte_groupings"}, {"sha": "02171a0909ed7e9c9f4991384cf9a14937b053aa", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -546,6 +546,7 @@ store.register_lints(&[\n     unsafe_removed_from_name::UNSAFE_REMOVED_FROM_NAME,\n     unused_async::UNUSED_ASYNC,\n     unused_io_amount::UNUSED_IO_AMOUNT,\n+    unused_rounding::UNUSED_ROUNDING,\n     unused_self::UNUSED_SELF,\n     unused_unit::UNUSED_UNIT,\n     unwrap::PANICKING_UNWRAP,"}, {"sha": "10808af363d7019d6bb393c37e29f7760a215b47", "filename": "clippy_lints/src/lib.register_nursery.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_nursery.rs?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -32,5 +32,6 @@ store.register_group(true, \"clippy::nursery\", Some(\"clippy_nursery\"), vec![\n     LintId::of(trait_bounds::TYPE_REPETITION_IN_BOUNDS),\n     LintId::of(transmute::TRANSMUTE_UNDEFINED_REPR),\n     LintId::of(transmute::USELESS_TRANSMUTE),\n+    LintId::of(unused_rounding::UNUSED_ROUNDING),\n     LintId::of(use_self::USE_SELF),\n ])"}, {"sha": "09435b06d0a1e403059f60e81b8836b8a8896452", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -402,6 +402,7 @@ mod unnested_or_patterns;\n mod unsafe_removed_from_name;\n mod unused_async;\n mod unused_io_amount;\n+mod unused_rounding;\n mod unused_self;\n mod unused_unit;\n mod unwrap;\n@@ -906,6 +907,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(rc_clone_in_vec_init::RcCloneInVecInit));\n     store.register_early_pass(|| Box::new(duplicate_mod::DuplicateMod::default()));\n     store.register_late_pass(|| Box::new(get_first::GetFirst));\n+    store.register_early_pass(|| Box::new(unused_rounding::UnusedRounding));\n     // add lints here, do not remove this comment, it's used in `new_lint`\n }\n "}, {"sha": "7706a338eb25b9fccde60c5a2cf599d58b6e2b6e", "filename": "clippy_lints/src/unused_rounding.rs", "status": "added", "additions": 69, "deletions": 0, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Funused_rounding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/clippy_lints%2Fsrc%2Funused_rounding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funused_rounding.rs?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -0,0 +1,69 @@\n+use clippy_utils::diagnostics::span_lint_and_sugg;\n+use rustc_ast::ast::{Expr, ExprKind, LitFloatType, LitKind};\n+use rustc_errors::Applicability;\n+use rustc_lint::{EarlyContext, EarlyLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    ///\n+    /// Detects cases where a whole-number literal float is being rounded, using\n+    /// the `floor`, `ceil`, or `round` methods.\n+    ///\n+    /// ### Why is this bad?\n+    ///\n+    /// This is unnecessary and confusing to the reader. Doing this is probably a mistake.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// let x = 1f32.ceil();\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// let x = 1f32;\n+    /// ```\n+    #[clippy::version = \"1.62.0\"]\n+    pub UNUSED_ROUNDING,\n+    nursery,\n+    \"Rounding a whole number literal, which is useless\"\n+}\n+declare_lint_pass!(UnusedRounding => [UNUSED_ROUNDING]);\n+\n+fn is_useless_rounding(expr: &Expr) -> Option<(&str, String)> {\n+    if let ExprKind::MethodCall(name_ident, args, _) = &expr.kind\n+        && let method_name = name_ident.ident.name.as_str()\n+        && (method_name == \"ceil\" || method_name == \"round\" || method_name == \"floor\")\n+        && !args.is_empty()\n+        && let ExprKind::Lit(spanned) = &args[0].kind\n+        && let LitKind::Float(symbol, ty) = spanned.kind {\n+            let f = symbol.as_str().parse::<f64>().unwrap();\n+            let f_str = symbol.to_string() + if let LitFloatType::Suffixed(ty) = ty {\n+                ty.name_str()\n+            } else {\n+                \"\"\n+            };\n+            if f.fract() < f64::EPSILON {\n+                Some((method_name, f_str))\n+            } else {\n+                None\n+            }\n+        } else {\n+            None\n+        }\n+}\n+\n+impl EarlyLintPass for UnusedRounding {\n+    fn check_expr(&mut self, cx: &EarlyContext<'_>, expr: &Expr) {\n+        if let Some((method_name, float)) = is_useless_rounding(expr) {\n+            span_lint_and_sugg(\n+                cx,\n+                UNUSED_ROUNDING,\n+                expr.span,\n+                &format!(\"used the `{}` method with a whole number float\", method_name),\n+                &format!(\"remove the `{}` method call\", method_name),\n+                float,\n+                Applicability::MachineApplicable,\n+            );\n+        }\n+    }\n+}"}, {"sha": "a1cb80413d2caa4d9944960547a8c3d5a5a94dd0", "filename": "tests/ui/unused_rounding.fixed", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/tests%2Fui%2Funused_rounding.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/tests%2Fui%2Funused_rounding.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.fixed?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+#![warn(clippy::unused_rounding)]\n+\n+fn main() {\n+    let _ = 1f32;\n+    let _ = 1.0f64;\n+    let _ = 1.00f32;\n+}"}, {"sha": "90af8f19dd9bd66c61a8ee105124802d3c3520b9", "filename": "tests/ui/unused_rounding.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/tests%2Fui%2Funused_rounding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/tests%2Fui%2Funused_rounding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.rs?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+#![warn(clippy::unused_rounding)]\n+\n+fn main() {\n+    let _ = 1f32.ceil();\n+    let _ = 1.0f64.floor();\n+    let _ = 1.00f32.round();\n+}"}, {"sha": "6cfb02e040283f615f1162618993fe7709dbe05c", "filename": "tests/ui/unused_rounding.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d8a281ef735be327dceace003b36e14616023126/tests%2Fui%2Funused_rounding.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d8a281ef735be327dceace003b36e14616023126/tests%2Fui%2Funused_rounding.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.stderr?ref=d8a281ef735be327dceace003b36e14616023126", "patch": "@@ -0,0 +1,22 @@\n+error: used the `ceil` method with a whole number float\n+  --> $DIR/unused_rounding.rs:5:13\n+   |\n+LL |     let _ = 1f32.ceil();\n+   |             ^^^^^^^^^^^ help: remove the `ceil` method call: `1f32`\n+   |\n+   = note: `-D clippy::unused-rounding` implied by `-D warnings`\n+\n+error: used the `floor` method with a whole number float\n+  --> $DIR/unused_rounding.rs:6:13\n+   |\n+LL |     let _ = 1.0f64.floor();\n+   |             ^^^^^^^^^^^^^^ help: remove the `floor` method call: `1.0f64`\n+\n+error: used the `round` method with a whole number float\n+  --> $DIR/unused_rounding.rs:7:13\n+   |\n+LL |     let _ = 1.00f32.round();\n+   |             ^^^^^^^^^^^^^^^ help: remove the `round` method call: `1.00f32`\n+\n+error: aborting due to 3 previous errors\n+"}]}