{"sha": "86f7f78f05ff8295aad2ad2a31770ce4408cc849", "node_id": "C_kwDOAAsO6NoAKDg2ZjdmNzhmMDVmZjgyOTVhYWQyYWQyYTMxNzcwY2U0NDA4Y2M4NDk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-14T06:29:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-14T06:29:32Z"}, "message": "Auto merge of #92781 - lambinoo:I-92755-no-mir-missing-reachable, r=petrochenkov\n\nSet struct/union/enum fields/variants as reachable when item is\n\nFixes #92755", "tree": {"sha": "276256732419630a1731cdb195ffc5253f6edbeb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/276256732419630a1731cdb195ffc5253f6edbeb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/86f7f78f05ff8295aad2ad2a31770ce4408cc849", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/86f7f78f05ff8295aad2ad2a31770ce4408cc849", "html_url": "https://github.com/rust-lang/rust/commit/86f7f78f05ff8295aad2ad2a31770ce4408cc849", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/86f7f78f05ff8295aad2ad2a31770ce4408cc849/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f312a5e610d47601e9a3da828002f5e1ffeb272a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f312a5e610d47601e9a3da828002f5e1ffeb272a", "html_url": "https://github.com/rust-lang/rust/commit/f312a5e610d47601e9a3da828002f5e1ffeb272a"}, {"sha": "1b2c64d223625e53556a520b1ddd4b8265ee671b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b2c64d223625e53556a520b1ddd4b8265ee671b", "html_url": "https://github.com/rust-lang/rust/commit/1b2c64d223625e53556a520b1ddd4b8265ee671b"}], "stats": {"total": 111, "additions": 91, "deletions": 20}, "files": [{"sha": "e7741ccc4e42419e82bf2d6626c45a9088c7744b", "filename": "compiler/rustc_privacy/src/lib.rs", "status": "modified", "additions": 64, "deletions": 20, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/86f7f78f05ff8295aad2ad2a31770ce4408cc849/compiler%2Frustc_privacy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86f7f78f05ff8295aad2ad2a31770ce4408cc849/compiler%2Frustc_privacy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_privacy%2Fsrc%2Flib.rs?ref=86f7f78f05ff8295aad2ad2a31770ce4408cc849", "patch": "@@ -652,12 +652,73 @@ impl<'tcx> Visitor<'tcx> for EmbargoVisitor<'tcx> {\n             _ => self.get(item.def_id),\n         };\n \n+        // Update levels of nested things.\n+        match item.kind {\n+            hir::ItemKind::Enum(ref def, _) => {\n+                for variant in def.variants {\n+                    let variant_level = self.update_with_hir_id(variant.id, item_level);\n+                    if let Some(ctor_hir_id) = variant.data.ctor_hir_id() {\n+                        self.update_with_hir_id(ctor_hir_id, item_level);\n+                    }\n+                    for field in variant.data.fields() {\n+                        self.update_with_hir_id(field.hir_id, variant_level);\n+                    }\n+                }\n+            }\n+            hir::ItemKind::Impl(ref impl_) => {\n+                for impl_item_ref in impl_.items {\n+                    if impl_.of_trait.is_some()\n+                        || self.tcx.visibility(impl_item_ref.id.def_id) == ty::Visibility::Public\n+                    {\n+                        self.update(impl_item_ref.id.def_id, item_level);\n+                    }\n+                }\n+            }\n+            hir::ItemKind::Trait(.., trait_item_refs) => {\n+                for trait_item_ref in trait_item_refs {\n+                    self.update(trait_item_ref.id.def_id, item_level);\n+                }\n+            }\n+            hir::ItemKind::Struct(ref def, _) | hir::ItemKind::Union(ref def, _) => {\n+                if let Some(ctor_hir_id) = def.ctor_hir_id() {\n+                    self.update_with_hir_id(ctor_hir_id, item_level);\n+                }\n+                for field in def.fields() {\n+                    if field.vis.node.is_pub() {\n+                        self.update_with_hir_id(field.hir_id, item_level);\n+                    }\n+                }\n+            }\n+            hir::ItemKind::Macro(ref macro_def) => {\n+                self.update_reachability_from_macro(item.def_id, macro_def);\n+            }\n+            hir::ItemKind::ForeignMod { items, .. } => {\n+                for foreign_item in items {\n+                    if self.tcx.visibility(foreign_item.id.def_id) == ty::Visibility::Public {\n+                        self.update(foreign_item.id.def_id, item_level);\n+                    }\n+                }\n+            }\n+\n+            hir::ItemKind::OpaqueTy(..)\n+            | hir::ItemKind::Use(..)\n+            | hir::ItemKind::Static(..)\n+            | hir::ItemKind::Const(..)\n+            | hir::ItemKind::GlobalAsm(..)\n+            | hir::ItemKind::TyAlias(..)\n+            | hir::ItemKind::Mod(..)\n+            | hir::ItemKind::TraitAlias(..)\n+            | hir::ItemKind::Fn(..)\n+            | hir::ItemKind::ExternCrate(..) => {}\n+        }\n+\n         // Mark all items in interfaces of reachable items as reachable.\n         match item.kind {\n             // The interface is empty.\n-            hir::ItemKind::ExternCrate(..) => {}\n+            hir::ItemKind::Macro(..) | hir::ItemKind::ExternCrate(..) => {}\n             // All nested items are checked by `visit_item`.\n             hir::ItemKind::Mod(..) => {}\n+            // Handled in the access level of in rustc_resolve\n             hir::ItemKind::Use(..) => {}\n             // The interface is empty.\n             hir::ItemKind::GlobalAsm(..) => {}\n@@ -709,14 +770,6 @@ impl<'tcx> Visitor<'tcx> for EmbargoVisitor<'tcx> {\n             }\n             // Visit everything except for private impl items.\n             hir::ItemKind::Impl(ref impl_) => {\n-                for impl_item_ref in impl_.items {\n-                    if impl_.of_trait.is_some()\n-                        || self.tcx.visibility(impl_item_ref.id.def_id) == ty::Visibility::Public\n-                    {\n-                        self.update(impl_item_ref.id.def_id, item_level);\n-                    }\n-                }\n-\n                 if item_level.is_some() {\n                     self.reach(item.def_id, item_level).generics().predicates().ty().trait_ref();\n \n@@ -731,21 +784,15 @@ impl<'tcx> Visitor<'tcx> for EmbargoVisitor<'tcx> {\n                     }\n                 }\n             }\n+\n             // Visit everything, but enum variants have their own levels.\n             hir::ItemKind::Enum(ref def, _) => {\n                 if item_level.is_some() {\n                     self.reach(item.def_id, item_level).generics().predicates();\n                 }\n-\n-                let enum_level = self.get(item.def_id);\n                 for variant in def.variants {\n-                    let variant_level = self.update_with_hir_id(variant.id, enum_level);\n-\n+                    let variant_level = self.get(self.tcx.hir().local_def_id(variant.id));\n                     if variant_level.is_some() {\n-                        if let Some(ctor_id) = variant.data.ctor_hir_id() {\n-                            self.update_with_hir_id(ctor_id, variant_level);\n-                        }\n-\n                         for field in variant.data.fields() {\n                             self.reach(self.tcx.hir().local_def_id(field.hir_id), variant_level)\n                                 .ty();\n@@ -756,9 +803,6 @@ impl<'tcx> Visitor<'tcx> for EmbargoVisitor<'tcx> {\n                     }\n                 }\n             }\n-            hir::ItemKind::Macro(ref macro_def) => {\n-                self.update_reachability_from_macro(item.def_id, macro_def);\n-            }\n             // Visit everything, but foreign items have their own levels.\n             hir::ItemKind::ForeignMod { items, .. } => {\n                 for foreign_item in items {"}, {"sha": "6f85273461af5417f12c15dbc5b36a49ccbe3723", "filename": "src/test/ui/privacy/auxiliary/issue-92755.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/86f7f78f05ff8295aad2ad2a31770ce4408cc849/src%2Ftest%2Fui%2Fprivacy%2Fauxiliary%2Fissue-92755.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86f7f78f05ff8295aad2ad2a31770ce4408cc849/src%2Ftest%2Fui%2Fprivacy%2Fauxiliary%2Fissue-92755.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprivacy%2Fauxiliary%2Fissue-92755.rs?ref=86f7f78f05ff8295aad2ad2a31770ce4408cc849", "patch": "@@ -0,0 +1,17 @@\n+mod machine {\n+    pub struct A {\n+        pub b: B,\n+    }\n+    pub struct B {}\n+    impl B {\n+        pub fn f(&self) {}\n+    }\n+}\n+\n+pub struct Context {\n+    pub a: machine::A,\n+}\n+\n+pub fn ctx() -> Context {\n+    todo!();\n+}"}, {"sha": "49559152b6fd09b4777bbe561adfca0d55d8ff0f", "filename": "src/test/ui/privacy/issue-92755.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/86f7f78f05ff8295aad2ad2a31770ce4408cc849/src%2Ftest%2Fui%2Fprivacy%2Fissue-92755.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86f7f78f05ff8295aad2ad2a31770ce4408cc849/src%2Ftest%2Fui%2Fprivacy%2Fissue-92755.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprivacy%2Fissue-92755.rs?ref=86f7f78f05ff8295aad2ad2a31770ce4408cc849", "patch": "@@ -0,0 +1,10 @@\n+// aux-build:issue-92755.rs\n+// build-pass\n+\n+// Thank you @tmiasko for providing the content of this test!\n+\n+extern crate issue_92755;\n+\n+fn main() {\n+    issue_92755::ctx().a.b.f();\n+}"}]}