{"sha": "aaef1a16495092ca910128d1dd70bb169303e2a1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhZWYxYTE2NDk1MDkyY2E5MTAxMjhkMWRkNzBiYjE2OTMwM2UyYTE=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-07-30T07:26:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-30T07:26:55Z"}, "message": "Rollup merge of #87554 - sexxi-goose:fix-issue-87426, r=nikomatsakis\n\n2229: Discr should be read when PatKind is Range\n\nThis PR fixes an issue related to pattern matching in closures when Edition 2021 is enabled.\n\n- If any of the patterns the discr is being matched on is `PatKind::Range` then the discr should be read\n\nr? ```@nikomatsakis```\n\nCloses https://github.com/rust-lang/rust/issues/87426", "tree": {"sha": "93761debb2f203f87f251abf1a90e52d4aeebccd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/93761debb2f203f87f251abf1a90e52d4aeebccd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aaef1a16495092ca910128d1dd70bb169303e2a1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhA6nACRBK7hj4Ov3rIwAACcwIAKkwy56tD6q+7CJXUIUSELUK\nb0LZsomVt8WPnNk+q7S0AIuK/jH3M49qT0/vbtxAkVCf9YarzmOFR0pq41OXT4XN\n4cHHPnmLGTEK3Y+bZ2P/FkQAjPOAxZW+Igunq5wbW8wON0wJV0qE5BDwB8tBcsZu\nSHPiHTvaWyrrExVC+nWe7jJjT8ryeuNEnNxoKyaWzpkiedshkWaTY9kt0LXAwhc2\nnw5yHJ3txPCAt3CQeY2bJErMrFwlL1AXP323kHQiy1RKB1JD2Ng8Rf5sjK9M/SO4\nvsTIlYQmzInpX+KzGws2yKscR5z5Yfvq+MeQpsU2J+/Kmn+Ua75UGJZiXk5Dvvk=\n=oIe9\n-----END PGP SIGNATURE-----\n", "payload": "tree 93761debb2f203f87f251abf1a90e52d4aeebccd\nparent 7e4b1737ff3c054fb8a9893515ced938b5fe24ba\nparent d380ed13043d52139b3c766a07edb93b891e2be6\nauthor Yuki Okushi <jtitor@2k36.org> 1627630015 +0900\ncommitter GitHub <noreply@github.com> 1627630015 +0900\n\nRollup merge of #87554 - sexxi-goose:fix-issue-87426, r=nikomatsakis\n\n2229: Discr should be read when PatKind is Range\n\nThis PR fixes an issue related to pattern matching in closures when Edition 2021 is enabled.\n\n- If any of the patterns the discr is being matched on is `PatKind::Range` then the discr should be read\n\nr? ```@nikomatsakis```\n\nCloses https://github.com/rust-lang/rust/issues/87426\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aaef1a16495092ca910128d1dd70bb169303e2a1", "html_url": "https://github.com/rust-lang/rust/commit/aaef1a16495092ca910128d1dd70bb169303e2a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aaef1a16495092ca910128d1dd70bb169303e2a1/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e4b1737ff3c054fb8a9893515ced938b5fe24ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e4b1737ff3c054fb8a9893515ced938b5fe24ba", "html_url": "https://github.com/rust-lang/rust/commit/7e4b1737ff3c054fb8a9893515ced938b5fe24ba"}, {"sha": "d380ed13043d52139b3c766a07edb93b891e2be6", "url": "https://api.github.com/repos/rust-lang/rust/commits/d380ed13043d52139b3c766a07edb93b891e2be6", "html_url": "https://github.com/rust-lang/rust/commit/d380ed13043d52139b3c766a07edb93b891e2be6"}], "stats": {"total": 29, "additions": 26, "deletions": 3}, "files": [{"sha": "1d7852d964c1dd428108c9934c0ffbe40e0886ce", "filename": "compiler/rustc_typeck/src/expr_use_visitor.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/aaef1a16495092ca910128d1dd70bb169303e2a1/compiler%2Frustc_typeck%2Fsrc%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aaef1a16495092ca910128d1dd70bb169303e2a1/compiler%2Frustc_typeck%2Fsrc%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fexpr_use_visitor.rs?ref=aaef1a16495092ca910128d1dd70bb169303e2a1", "patch": "@@ -267,12 +267,21 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n                                     }\n                                 }\n                             }\n-                            PatKind::Lit(_) => {\n-                                // If the PatKind is a Lit then we want\n+                            PatKind::Lit(_) | PatKind::Range(..) => {\n+                                // If the PatKind is a Lit or a Range then we want\n                                 // to borrow discr.\n                                 needs_to_be_read = true;\n                             }\n-                            _ => {}\n+                            PatKind::Or(_)\n+                            | PatKind::Box(_)\n+                            | PatKind::Slice(..)\n+                            | PatKind::Ref(..)\n+                            | PatKind::Wild => {\n+                                // If the PatKind is Or, Box, Slice or Ref, the decision is made later\n+                                // as these patterns contains subpatterns\n+                                // If the PatKind is Wild, the decision is made based on the other patterns being\n+                                // examined\n+                            }\n                         }\n                     }));\n                 }"}, {"sha": "74506979a28c52159bbac7b4907402dbcb154486", "filename": "src/test/ui/closures/2229_closure_analysis/issue-87426.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/aaef1a16495092ca910128d1dd70bb169303e2a1/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fissue-87426.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aaef1a16495092ca910128d1dd70bb169303e2a1/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fissue-87426.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fissue-87426.rs?ref=aaef1a16495092ca910128d1dd70bb169303e2a1", "patch": "@@ -0,0 +1,14 @@\n+// run-pass\n+// edition:2021\n+\n+pub fn foo() {\n+    let ref_x_ck = 123;\n+    let _y = || match ref_x_ck {\n+        2_000_000..=3_999_999 => { println!(\"A\")}\n+        _ => { println!(\"B\")}\n+    };\n+}\n+\n+fn main() {\n+    foo();\n+}"}]}