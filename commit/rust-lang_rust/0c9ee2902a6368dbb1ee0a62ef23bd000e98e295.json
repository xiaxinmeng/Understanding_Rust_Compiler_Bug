{"sha": "0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjOWVlMjkwMmE2MzY4ZGJiMWVlMGE2MmVmMjNiZDAwMGU5OGUyOTU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-18T14:01:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-18T14:01:29Z"}, "message": "Merge #6585\n\n6585: Link rustc error page and clippy lint page via CodeDescription r=kjeremy a=Veykril\n\nFixes #6371\r\n\r\nThis makes the error code in here clickable, same for clippy lints\r\n![image](https://user-images.githubusercontent.com/3757771/99459468-6d110b00-292e-11eb-9cde-d43ec9cebc09.png)\r\n\r\nFor clippy I just chose the master build of the site as I believe that to be pretty much always the best fitting.\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "da87cf6a9a6ce3347e47acd9fe0e250b589c4922", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da87cf6a9a6ce3347e47acd9fe0e250b589c4922"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJftSk5CRBK7hj4Ov3rIwAAdHIIAJmWVvBO+pOddFMxEsD/GHl3\ncuRx+UPBi2U1ANpj8OsFQJU9uiDJ3whtIwSx7bhhpG4fYQSbzExJAjxSPziOtFqd\nfBBSLagM9qfRYokc2rJ1/j4WI3Z0uQGR9d/7S3ZXFJRqxuMUMWGdQRhfFOMFkxy9\n8o+xTjNBynRFyZBNRfMshK54lyRkiS7kOOx6hDuc0bAla+dlzQgkIds4fHv2v6XC\nEhfMLLu3XBtTEowOYjmU3z44ywcLm2fratBNv2ErMtg04SJoeuTY1Dgo9uPLrftc\nbllxbaqpdOwAJOkmB2ez6Gl822WBO7EPJWEyOI5bzULW908G89HsRmvQhdNh/Mk=\n=IOeX\n-----END PGP SIGNATURE-----\n", "payload": "tree da87cf6a9a6ce3347e47acd9fe0e250b589c4922\nparent 99975d08f0f1497abc6dc13681f040848595e50b\nparent 91a1a836015f61accb73f7b855b852fc22e810fc\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1605708089 +0000\ncommitter GitHub <noreply@github.com> 1605708089 +0000\n\nMerge #6585\n\n6585: Link rustc error page and clippy lint page via CodeDescription r=kjeremy a=Veykril\n\nFixes #6371\r\n\r\nThis makes the error code in here clickable, same for clippy lints\r\n![image](https://user-images.githubusercontent.com/3757771/99459468-6d110b00-292e-11eb-9cde-d43ec9cebc09.png)\r\n\r\nFor clippy I just chose the master build of the site as I believe that to be pretty much always the best fitting.\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "html_url": "https://github.com/rust-lang/rust/commit/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99975d08f0f1497abc6dc13681f040848595e50b", "url": "https://api.github.com/repos/rust-lang/rust/commits/99975d08f0f1497abc6dc13681f040848595e50b", "html_url": "https://github.com/rust-lang/rust/commit/99975d08f0f1497abc6dc13681f040848595e50b"}, {"sha": "91a1a836015f61accb73f7b855b852fc22e810fc", "url": "https://api.github.com/repos/rust-lang/rust/commits/91a1a836015f61accb73f7b855b852fc22e810fc", "html_url": "https://github.com/rust-lang/rust/commit/91a1a836015f61accb73f7b855b852fc22e810fc"}], "stats": {"total": 158, "additions": 149, "deletions": 9}, "files": [{"sha": "72f6c5725476f05e8b895881a0d1fed9deec6c10", "filename": "crates/rust-analyzer/src/diagnostics/test_data/clippy_pass_by_ref.txt", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -27,7 +27,24 @@\n                     \"trivially_copy_pass_by_ref\",\n                 ),\n             ),\n-            code_description: None,\n+            code_description: Some(\n+                CodeDescription {\n+                    href: Url {\n+                        scheme: \"https\",\n+                        host: Some(\n+                            Domain(\n+                                \"rust-lang.github.io\",\n+                            ),\n+                        ),\n+                        port: None,\n+                        path: \"/rust-clippy/master/index.html\",\n+                        query: None,\n+                        fragment: Some(\n+                            \"trivially_copy_pass_by_ref\",\n+                        ),\n+                    },\n+                },\n+            ),\n             source: Some(\n                 \"clippy\",\n             ),"}, {"sha": "eb4a6b597b2f9c1f0c86a017055fed40a2ff0361", "filename": "crates/rust-analyzer/src/diagnostics/test_data/handles_macro_location.txt", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fhandles_macro_location.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fhandles_macro_location.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fhandles_macro_location.txt?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -27,7 +27,24 @@\n                     \"E0277\",\n                 ),\n             ),\n-            code_description: None,\n+            code_description: Some(\n+                CodeDescription {\n+                    href: Url {\n+                        scheme: \"https\",\n+                        host: Some(\n+                            Domain(\n+                                \"doc.rust-lang.org\",\n+                            ),\n+                        ),\n+                        port: None,\n+                        path: \"/error-index.html\",\n+                        query: None,\n+                        fragment: Some(\n+                            \"E0277\",\n+                        ),\n+                    },\n+                },\n+            ),\n             source: Some(\n                 \"rustc\",\n             ),"}, {"sha": "19f72196dac4c497d6aac910af0c877f5213ea76", "filename": "crates/rust-analyzer/src/diagnostics/test_data/rustc_incompatible_type_for_trait.txt", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_incompatible_type_for_trait.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_incompatible_type_for_trait.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_incompatible_type_for_trait.txt?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -27,7 +27,24 @@\n                     \"E0053\",\n                 ),\n             ),\n-            code_description: None,\n+            code_description: Some(\n+                CodeDescription {\n+                    href: Url {\n+                        scheme: \"https\",\n+                        host: Some(\n+                            Domain(\n+                                \"doc.rust-lang.org\",\n+                            ),\n+                        ),\n+                        port: None,\n+                        path: \"/error-index.html\",\n+                        query: None,\n+                        fragment: Some(\n+                            \"E0053\",\n+                        ),\n+                    },\n+                },\n+            ),\n             source: Some(\n                 \"rustc\",\n             ),"}, {"sha": "15ac95d7218ac80caf0ae094ab813482ec40d058", "filename": "crates/rust-analyzer/src/diagnostics/test_data/rustc_mismatched_type.txt", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_mismatched_type.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_mismatched_type.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_mismatched_type.txt?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -27,7 +27,24 @@\n                     \"E0308\",\n                 ),\n             ),\n-            code_description: None,\n+            code_description: Some(\n+                CodeDescription {\n+                    href: Url {\n+                        scheme: \"https\",\n+                        host: Some(\n+                            Domain(\n+                                \"doc.rust-lang.org\",\n+                            ),\n+                        ),\n+                        port: None,\n+                        path: \"/error-index.html\",\n+                        query: None,\n+                        fragment: Some(\n+                            \"E0308\",\n+                        ),\n+                    },\n+                },\n+            ),\n             source: Some(\n                 \"rustc\",\n             ),"}, {"sha": "b9650f3e45ebb47a6eda20b178e5221b3d432c33", "filename": "crates/rust-analyzer/src/diagnostics/test_data/rustc_wrong_number_of_parameters.txt", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_wrong_number_of_parameters.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_wrong_number_of_parameters.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Frustc_wrong_number_of_parameters.txt?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -27,7 +27,24 @@\n                     \"E0061\",\n                 ),\n             ),\n-            code_description: None,\n+            code_description: Some(\n+                CodeDescription {\n+                    href: Url {\n+                        scheme: \"https\",\n+                        host: Some(\n+                            Domain(\n+                                \"doc.rust-lang.org\",\n+                            ),\n+                        ),\n+                        port: None,\n+                        path: \"/error-index.html\",\n+                        query: None,\n+                        fragment: Some(\n+                            \"E0061\",\n+                        ),\n+                    },\n+                },\n+            ),\n             source: Some(\n                 \"rustc\",\n             ),"}, {"sha": "c45f68a916d016b3b2d1433ca2459f8f5535d50c", "filename": "crates/rust-analyzer/src/diagnostics/test_data/snap_multi_line_fix.txt", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fsnap_multi_line_fix.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fsnap_multi_line_fix.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fsnap_multi_line_fix.txt?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -27,7 +27,24 @@\n                     \"let_and_return\",\n                 ),\n             ),\n-            code_description: None,\n+            code_description: Some(\n+                CodeDescription {\n+                    href: Url {\n+                        scheme: \"https\",\n+                        host: Some(\n+                            Domain(\n+                                \"rust-lang.github.io\",\n+                            ),\n+                        ),\n+                        port: None,\n+                        path: \"/rust-clippy/master/index.html\",\n+                        query: None,\n+                        fragment: Some(\n+                            \"let_and_return\",\n+                        ),\n+                    },\n+                },\n+            ),\n             source: Some(\n                 \"clippy\",\n             ),"}, {"sha": "324019614d528ab7ffe8d4b23845e4c3cb388c3e", "filename": "crates/rust-analyzer/src/diagnostics/to_proto.rs", "status": "modified", "additions": 33, "deletions": 2, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -211,6 +211,12 @@ pub(crate) fn map_rust_diagnostic_to_lsp(\n         }\n     }\n \n+    let code_description = match source.as_str() {\n+        \"rustc\" => rustc_code_description(code.as_deref()),\n+        \"clippy\" => clippy_code_description(code.as_deref()),\n+        _ => None,\n+    };\n+\n     primary_spans\n         .iter()\n         .map(|primary_span| {\n@@ -248,7 +254,7 @@ pub(crate) fn map_rust_diagnostic_to_lsp(\n                         range: in_macro_location.range,\n                         severity,\n                         code: code.clone().map(lsp_types::NumberOrString::String),\n-                        code_description: None,\n+                        code_description: code_description.clone(),\n                         source: Some(source.clone()),\n                         message: message.clone(),\n                         related_information: Some(information_for_additional_diagnostic),\n@@ -269,7 +275,7 @@ pub(crate) fn map_rust_diagnostic_to_lsp(\n                 range: location.range,\n                 severity,\n                 code: code.clone().map(lsp_types::NumberOrString::String),\n-                code_description: None,\n+                code_description: code_description.clone(),\n                 source: Some(source.clone()),\n                 message,\n                 related_information: if related_information.is_empty() {\n@@ -292,6 +298,31 @@ pub(crate) fn map_rust_diagnostic_to_lsp(\n         .collect()\n }\n \n+fn rustc_code_description(code: Option<&str>) -> Option<lsp_types::CodeDescription> {\n+    code.filter(|code| {\n+        let mut chars = code.chars();\n+        chars.next().map_or(false, |c| c == 'E')\n+            && chars.by_ref().take(4).all(|c| c.is_ascii_digit())\n+            && chars.next().is_none()\n+    })\n+    .and_then(|code| {\n+        lsp_types::Url::parse(&format!(\"https://doc.rust-lang.org/error-index.html#{}\", code))\n+            .ok()\n+            .map(|href| lsp_types::CodeDescription { href })\n+    })\n+}\n+\n+fn clippy_code_description(code: Option<&str>) -> Option<lsp_types::CodeDescription> {\n+    code.and_then(|code| {\n+        lsp_types::Url::parse(&format!(\n+            \"https://rust-lang.github.io/rust-clippy/master/index.html#{}\",\n+            code\n+        ))\n+        .ok()\n+        .map(|href| lsp_types::CodeDescription { href })\n+    })\n+}\n+\n #[cfg(test)]\n #[cfg(not(windows))]\n mod tests {"}, {"sha": "1cf4139d2bb30e1a31525f212518d5fd28c33593", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c9ee2902a6368dbb1ee0a62ef23bd000e98e295/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=0c9ee2902a6368dbb1ee0a62ef23bd000e98e295", "patch": "@@ -1129,7 +1129,14 @@ pub(crate) fn publish_diagnostics(\n             range: to_proto::range(&line_index, d.range),\n             severity: Some(to_proto::diagnostic_severity(d.severity)),\n             code: d.code.map(|d| d.as_str().to_owned()).map(NumberOrString::String),\n-            code_description: None,\n+            code_description: d.code.and_then(|code| {\n+                lsp_types::Url::parse(&format!(\n+                    \"https://rust-analyzer.github.io/manual.html#{}\",\n+                    code.as_str()\n+                ))\n+                .ok()\n+                .map(|href| lsp_types::CodeDescription { href })\n+            }),\n             source: Some(\"rust-analyzer\".to_string()),\n             message: d.message,\n             related_information: None,"}]}