{"sha": "ef07d7dd40e33d7af95c7b00717503730ce69c11", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVmMDdkN2RkNDBlMzNkN2FmOTVjN2IwMDcxNzUwMzczMGNlNjljMTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-10-02T19:16:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-10-02T19:16:39Z"}, "message": "Auto merge of #28650 - sanxiyn:attr-usage, r=nrc\n\nThis is technically a [breaking-change].\r\n\r\nFix #2809.\r\nFix #22746.", "tree": {"sha": "5725bfdeb870197fb9efa5b5ef9ca8099d7ba8e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5725bfdeb870197fb9efa5b5ef9ca8099d7ba8e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ef07d7dd40e33d7af95c7b00717503730ce69c11", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ef07d7dd40e33d7af95c7b00717503730ce69c11", "html_url": "https://github.com/rust-lang/rust/commit/ef07d7dd40e33d7af95c7b00717503730ce69c11", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ef07d7dd40e33d7af95c7b00717503730ce69c11/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e650491f209a4c76dbd31ed1cdc390dd13c3d1e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e650491f209a4c76dbd31ed1cdc390dd13c3d1e9", "html_url": "https://github.com/rust-lang/rust/commit/e650491f209a4c76dbd31ed1cdc390dd13c3d1e9"}, {"sha": "61f5b2b0ca492a7eef9c362efb2108c77eac5bf8", "url": "https://api.github.com/repos/rust-lang/rust/commits/61f5b2b0ca492a7eef9c362efb2108c77eac5bf8", "html_url": "https://github.com/rust-lang/rust/commit/61f5b2b0ca492a7eef9c362efb2108c77eac5bf8"}], "stats": {"total": 195, "additions": 182, "deletions": 13}, "files": [{"sha": "cca14f1fbf2a355b8654bf8916208daafd4ac72f", "filename": "src/librustc/front/check_attr.rs", "status": "added", "additions": 110, "deletions": 0, "changes": 110, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc%2Ffront%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc%2Ffront%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Fcheck_attr.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -0,0 +1,110 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use session::Session;\n+\n+use syntax::ast;\n+use syntax::attr::AttrMetaMethods;\n+use syntax::visit;\n+use syntax::visit::Visitor;\n+\n+#[derive(Copy, Clone, PartialEq)]\n+enum Target {\n+    Fn,\n+    Struct,\n+    Enum,\n+    Other,\n+}\n+\n+impl Target {\n+    fn from_item(item: &ast::Item) -> Target {\n+        match item.node {\n+            ast::ItemFn(..) => Target::Fn,\n+            ast::ItemStruct(..) => Target::Struct,\n+            ast::ItemEnum(..) => Target::Enum,\n+            _ => Target::Other,\n+        }\n+    }\n+}\n+\n+struct CheckAttrVisitor<'a> {\n+    sess: &'a Session,\n+}\n+\n+impl<'a> CheckAttrVisitor<'a> {\n+    fn check_inline(&self, attr: &ast::Attribute, target: Target) {\n+        if target != Target::Fn {\n+            self.sess.span_err(\n+                attr.span,\n+                \"attribute should be applied to function\");\n+        }\n+    }\n+\n+    fn check_repr(&self, attr: &ast::Attribute, target: Target) {\n+        let words = match attr.meta_item_list() {\n+            Some(words) => words,\n+            None => {\n+                return;\n+            }\n+        };\n+        for word in words {\n+            let word: &str = &word.name();\n+            match word {\n+                \"C\" => {\n+                    if target != Target::Struct && target != Target::Enum {\n+                        self.sess.span_err(\n+                            attr.span,\n+                            \"attribute should be applied to struct or enum\");\n+                    }\n+                }\n+                \"packed\" |\n+                \"simd\" => {\n+                    if target != Target::Struct {\n+                        self.sess.span_err(\n+                            attr.span,\n+                            \"attribute should be applied to struct\");\n+                    }\n+                }\n+                \"i8\" | \"u8\" | \"i16\" | \"u16\" |\n+                \"i32\" | \"u32\" | \"i64\" | \"u64\" |\n+                \"isize\" | \"usize\" => {\n+                    if target != Target::Enum {\n+                        self.sess.span_err(\n+                            attr.span,\n+                            \"attribute should be applied to enum\");\n+                    }\n+                }\n+                _ => (),\n+            }\n+        }\n+    }\n+\n+    fn check_attribute(&self, attr: &ast::Attribute, target: Target) {\n+        let name: &str = &attr.name();\n+        match name {\n+            \"inline\" => self.check_inline(attr, target),\n+            \"repr\" => self.check_repr(attr, target),\n+            _ => (),\n+        }\n+    }\n+}\n+\n+impl<'a, 'v> Visitor<'v> for CheckAttrVisitor<'a> {\n+    fn visit_item(&mut self, item: &ast::Item) {\n+        let target = Target::from_item(item);\n+        for attr in &item.attrs {\n+            self.check_attribute(attr, target);\n+        }\n+    }\n+}\n+\n+pub fn check_crate(sess: &Session, krate: &ast::Crate) {\n+    visit::walk_crate(&mut CheckAttrVisitor { sess: sess }, krate);\n+}"}, {"sha": "e08dc2acbc0885e61712286ba2af9454cee3c18a", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -101,6 +101,7 @@ pub mod back {\n }\n \n pub mod front {\n+    pub mod check_attr;\n     pub mod map;\n }\n "}, {"sha": "97fb6c3d26fc9f0b9aa8720e16c949fa2ebacecf", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -130,6 +130,10 @@ pub fn compile_input(sess: Session,\n                                                                      &ast_map.krate(),\n                                                                      &id[..]));\n \n+        time(sess.time_passes(), \"attribute checking\", || {\n+            front::check_attr::check_crate(&sess, &expanded_crate);\n+        });\n+\n         time(sess.time_passes(), \"early lint checks\", || {\n             lint::check_ast_crate(&sess, &expanded_crate)\n         });"}, {"sha": "1a564eb28a3a039874bde3aacff131ac1d33dfed", "filename": "src/librustc_front/attr.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc_front%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibrustc_front%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Fattr.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -300,7 +300,6 @@ pub enum InlineAttr {\n \n /// Determine what `#[inline]` attribute is present in `attrs`, if any.\n pub fn find_inline_attr(diagnostic: Option<&SpanHandler>, attrs: &[Attribute]) -> InlineAttr {\n-    // FIXME (#2809)---validate the usage of #[inline] and #[inline]\n     attrs.iter().fold(InlineAttr::None, |ia,attr| {\n         match attr.node.value.node {\n             MetaWord(ref n) if *n == \"inline\" => {"}, {"sha": "bd99d33222db1ab4a25747e1cef1718b0f0d59bb", "filename": "src/libsyntax/attr.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibsyntax%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Flibsyntax%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -323,7 +323,6 @@ pub enum InlineAttr {\n \n /// Determine what `#[inline]` attribute is present in `attrs`, if any.\n pub fn find_inline_attr(diagnostic: Option<&SpanHandler>, attrs: &[Attribute]) -> InlineAttr {\n-    // FIXME (#2809)---validate the usage of #[inline] and #[inline]\n     attrs.iter().fold(InlineAttr::None, |ia,attr| {\n         match attr.node.value.node {\n             MetaWord(ref n) if *n == \"inline\" => {"}, {"sha": "c57d161d8f574b7016dc21fa6c0520248340d1eb", "filename": "src/test/auxiliary/sepcomp_cci_lib.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fauxiliary%2Fsepcomp_cci_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fauxiliary%2Fsepcomp_cci_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fsepcomp_cci_lib.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -13,5 +13,4 @@ pub fn cci_fn() -> usize {\n     1200\n }\n \n-#[inline]\n-pub static CCI_STATIC: usize = 34;\n+pub const CCI_CONST: usize = 34;"}, {"sha": "d0da80e31b913d732ead23a3c910444a7a6ff573", "filename": "src/test/auxiliary/xcrate_static_addresses.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fauxiliary%2Fxcrate_static_addresses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fauxiliary%2Fxcrate_static_addresses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fxcrate_static_addresses.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -8,13 +8,10 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#[inline(never)]\n pub static global: isize = 3;\n \n-#[inline(never)]\n static global0: isize = 4;\n \n-#[inline(never)]\n pub static global2: &'static isize = &global0;\n \n pub fn verify_same(a: &'static isize) {"}, {"sha": "c6b9b016331aa61d0ed1b257b34161f247a0b504", "filename": "src/test/compile-fail/attr-usage-inline.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fcompile-fail%2Fattr-usage-inline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fcompile-fail%2Fattr-usage-inline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fattr-usage-inline.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![allow(dead_code)]\n+\n+#[inline]\n+fn f() {}\n+\n+#[inline] //~ ERROR: attribute should be applied to function\n+struct S;\n+\n+fn main() {}"}, {"sha": "9bad6a8389a5d9fefb21b5837f49a02300092a96", "filename": "src/test/compile-fail/attr-usage-repr.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fcompile-fail%2Fattr-usage-repr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Fcompile-fail%2Fattr-usage-repr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fattr-usage-repr.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -0,0 +1,41 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![allow(dead_code)]\n+#![feature(repr_simd)]\n+\n+#[repr(C)] //~ ERROR: attribute should be applied to struct or enum\n+fn f() {}\n+\n+#[repr(C)]\n+struct SExtern(f64, f64);\n+\n+#[repr(packed)]\n+struct SPacked(f64, f64);\n+\n+#[repr(simd)]\n+struct SSimd(f64, f64);\n+\n+#[repr(i8)] //~ ERROR: attribute should be applied to enum\n+struct SInt(f64, f64);\n+\n+#[repr(C)]\n+enum EExtern { A, B }\n+\n+#[repr(packed)] //~ ERROR: attribute should be applied to struct\n+enum EPacked { A, B }\n+\n+#[repr(simd)] //~ ERROR: attribute should be applied to struct\n+enum ESimd { A, B }\n+\n+#[repr(i8)]\n+enum EInt { A, B }\n+\n+fn main() {}"}, {"sha": "d3d3de0e2c0cbc68b4f8f03dc2a258a10eb3da8d", "filename": "src/test/run-pass/sepcomp-cci.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Frun-pass%2Fsepcomp-cci.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef07d7dd40e33d7af95c7b00717503730ce69c11/src%2Ftest%2Frun-pass%2Fsepcomp-cci.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fsepcomp-cci.rs?ref=ef07d7dd40e33d7af95c7b00717503730ce69c11", "patch": "@@ -16,23 +16,23 @@\n \n \n extern crate sepcomp_cci_lib;\n-use sepcomp_cci_lib::{cci_fn, CCI_STATIC};\n+use sepcomp_cci_lib::{cci_fn, CCI_CONST};\n \n fn call1() -> usize {\n-    cci_fn() + CCI_STATIC\n+    cci_fn() + CCI_CONST\n }\n \n mod a {\n-    use sepcomp_cci_lib::{cci_fn, CCI_STATIC};\n+    use sepcomp_cci_lib::{cci_fn, CCI_CONST};\n     pub fn call2() -> usize {\n-        cci_fn() + CCI_STATIC\n+        cci_fn() + CCI_CONST\n     }\n }\n \n mod b {\n-    use sepcomp_cci_lib::{cci_fn, CCI_STATIC};\n+    use sepcomp_cci_lib::{cci_fn, CCI_CONST};\n     pub fn call3() -> usize {\n-        cci_fn() + CCI_STATIC\n+        cci_fn() + CCI_CONST\n     }\n }\n "}]}