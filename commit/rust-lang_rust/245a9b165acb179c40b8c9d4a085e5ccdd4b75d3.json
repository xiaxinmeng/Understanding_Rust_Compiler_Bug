{"sha": "245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0NWE5YjE2NWFjYjE3OWM0MGI4YzlkNGEwODVlNWNjZGQ0Yjc1ZDM=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-11-26T07:05:53Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-11-26T07:05:53Z"}, "message": "Add hygiene information to SourceAnalyzer", "tree": {"sha": "8074ef35c99dd6345536e11f5fe030daebade95a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8074ef35c99dd6345536e11f5fe030daebade95a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "html_url": "https://github.com/rust-lang/rust/commit/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58a3b3b502580e9f49dcfc9b7223e8aec258adf6", "url": "https://api.github.com/repos/rust-lang/rust/commits/58a3b3b502580e9f49dcfc9b7223e8aec258adf6", "html_url": "https://github.com/rust-lang/rust/commit/58a3b3b502580e9f49dcfc9b7223e8aec258adf6"}], "stats": {"total": 49, "additions": 36, "deletions": 13}, "files": [{"sha": "287cea88087a50c3b3944ef3fbef82c98fc2ecc4", "filename": "crates/ra_hir/src/source_binder.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs?ref=245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "patch": "@@ -14,7 +14,8 @@ use hir_def::{\n     DefWithBodyId,\n };\n use hir_expand::{\n-    name::AsName, AstId, HirFileId, MacroCallId, MacroCallLoc, MacroFileKind, Source,\n+    hygiene::Hygiene, name::AsName, AstId, HirFileId, MacroCallId, MacroCallLoc, MacroFileKind,\n+    Source,\n };\n use ra_syntax::{\n     ast::{self, AstNode},\n@@ -236,10 +237,10 @@ impl SourceAnalyzer {\n     pub fn resolve_macro_call(\n         &self,\n         db: &impl HirDatabase,\n-        macro_call: &ast::MacroCall,\n+        macro_call: Source<&ast::MacroCall>,\n     ) -> Option<MacroDef> {\n-        // This must be a normal source file rather than macro file.\n-        let path = macro_call.path().and_then(Path::from_ast)?;\n+        let hygiene = Hygiene::new(db, macro_call.file_id);\n+        let path = macro_call.value.path().and_then(|ast| Path::from_src(ast, &hygiene))?;\n         self.resolver.resolve_path_as_macro(db, &path).map(|it| it.into())\n     }\n \n@@ -441,12 +442,14 @@ impl SourceAnalyzer {\n         db: &impl HirDatabase,\n         macro_call: Source<&ast::MacroCall>,\n     ) -> Option<Expansion> {\n-        let def = self.resolve_macro_call(db, macro_call.value)?.id;\n+        let def = self.resolve_macro_call(db, macro_call)?.id;\n         let ast_id = AstId::new(\n             macro_call.file_id,\n             db.ast_id_map(macro_call.file_id).ast_id(macro_call.value),\n         );\n         let macro_call_loc = MacroCallLoc { def, ast_id };\n+        let kind = to_macro_file_kind(macro_call.value);\n+        dbg!(kind);\n         Some(Expansion {\n             macro_call_id: db.intern_macro(macro_call_loc),\n             macro_file_kind: to_macro_file_kind(macro_call.value),"}, {"sha": "6810a26dbbd1336b0968667d198ca6b470fb6659", "filename": "crates/ra_hir_def/src/path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_hir_def%2Fsrc%2Fpath.rs", "raw_url": "https://github.com/rust-lang/rust/raw/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_hir_def%2Fsrc%2Fpath.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fpath.rs?ref=245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "patch": "@@ -97,7 +97,7 @@ impl Path {\n \n     /// Converts an `ast::Path` to `Path`. Works with use trees.\n     /// It correctly handles `$crate` based path from macro call.\n-    pub(crate) fn from_src(mut path: ast::Path, hygiene: &Hygiene) -> Option<Path> {\n+    pub fn from_src(mut path: ast::Path, hygiene: &Hygiene) -> Option<Path> {\n         let mut kind = PathKind::Plain;\n         let mut segments = Vec::new();\n         loop {"}, {"sha": "7ebdfc585a18fe52afd59becb227618a2157f70c", "filename": "crates/ra_ide_api/src/call_info.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_ide_api%2Fsrc%2Fcall_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_ide_api%2Fsrc%2Fcall_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcall_info.rs?ref=245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "patch": "@@ -18,12 +18,9 @@ pub(crate) fn call_info(db: &RootDatabase, position: FilePosition) -> Option<Cal\n     // Find the calling expression and it's NameRef\n     let calling_node = FnCallNode::with_node(&syntax, position.offset)?;\n     let name_ref = calling_node.name_ref()?;\n+    let name_ref = hir::Source::new(position.file_id.into(), name_ref.syntax());\n \n-    let analyzer = hir::SourceAnalyzer::new(\n-        db,\n-        hir::Source::new(position.file_id.into(), name_ref.syntax()),\n-        None,\n-    );\n+    let analyzer = hir::SourceAnalyzer::new(db, name_ref, None);\n     let (mut call_info, has_self) = match &calling_node {\n         FnCallNode::CallExpr(expr) => {\n             //FIXME: don't poke into Ty\n@@ -44,7 +41,7 @@ pub(crate) fn call_info(db: &RootDatabase, position: FilePosition) -> Option<Cal\n             (CallInfo::with_fn(db, function), function.has_self_param(db))\n         }\n         FnCallNode::MacroCallExpr(expr) => {\n-            let macro_def = analyzer.resolve_macro_call(db, &expr)?;\n+            let macro_def = analyzer.resolve_macro_call(db, name_ref.with_value(&expr))?;\n             (CallInfo::with_macro(db, macro_def)?, false)\n         }\n     };"}, {"sha": "abc602244cab961785eafc592590da1ad064e64a", "filename": "crates/ra_ide_api/src/expand_macro.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs?ref=245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "patch": "@@ -269,4 +269,27 @@ fn some_thing() -> u32 {\n         assert_eq!(res.name, \"foo\");\n         assert_snapshot!(res.expansion, @r###\"bar!()\"###);\n     }\n+\n+    #[test]\n+    fn macro_expand_with_dollar_crate() {\n+        let res = check_expand_macro(\n+            r#\"\n+        //- /lib.rs\n+        #[macro_export]\n+        macro_rules! bar {\n+            () => {0};\n+        }\n+        macro_rules! foo {\n+            () => {$crate::bar!()};\n+        }        \n+\n+        fn main() {        \n+            let res = fo<|>o!();\n+        }\n+        \"#,\n+        );\n+\n+        assert_eq!(res.name, \"foo\");\n+        assert_snapshot!(res.expansion, @r###\"0\"###);\n+    }\n }"}, {"sha": "227737ad24dae91a165232658b59426143c5724d", "filename": "crates/ra_ide_api/src/references/classify.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_ide_api%2Fsrc%2Freferences%2Fclassify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/245a9b165acb179c40b8c9d4a085e5ccdd4b75d3/crates%2Fra_ide_api%2Fsrc%2Freferences%2Fclassify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Freferences%2Fclassify.rs?ref=245a9b165acb179c40b8c9d4a085e5ccdd4b75d3", "patch": "@@ -152,7 +152,7 @@ pub(crate) fn classify_name_ref(\n \n     if let Some(macro_call) = parent.ancestors().find_map(ast::MacroCall::cast) {\n         tested_by!(goto_definition_works_for_macros);\n-        if let Some(macro_def) = analyzer.resolve_macro_call(db, &macro_call) {\n+        if let Some(macro_def) = analyzer.resolve_macro_call(db, name_ref.with_value(&macro_call)) {\n             let kind = NameKind::Macro(macro_def);\n             return Some(NameDefinition { kind, container, visibility });\n         }"}]}