{"sha": "92ce768ea3dcfe5cda55f2a4607d4245730e0d64", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkyY2U3NjhlYTNkY2ZlNWNkYTU1ZjJhNDYwN2Q0MjQ1NzMwZTBkNjQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-09-09T15:07:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-09T15:07:43Z"}, "message": "Merge #10188\n\n10188: fix: add multi-token mapping support to runnables r=jonas-schievink a=lnicola\n\nCloses #10184\r\n\r\n\r\nchangelog fix (first contribution) add multi-token mapping support to runnables\n\nCo-authored-by: Anatol Ulrich <anatol.ulrich@ferrous-systems.com>", "tree": {"sha": "bbc3be0bd19fda0a61f56c9b10f705657f450744", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbc3be0bd19fda0a61f56c9b10f705657f450744"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/92ce768ea3dcfe5cda55f2a4607d4245730e0d64", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhOiM/CRBK7hj4Ov3rIwAAiu4IADD0v8LYcenlvLQXt5n5tcEr\n35KbuaIGltXELCc2xI5qLtLQLJeAGS7rCOMtBUO5csoAAwQuog7H/h+6au9tnoPD\nu9xogRKa0G/xVBYLI8bUmVqNC7KLcqeLR8WcGoG5l8eJcwJQWesHL2mkS/jmW3Lj\nVVr/wyGnjdOQA+4PmqyEDA+ompokZHBs8S3bTTzBlim1kfua/dgwoufENIe4YEPM\nHQQGR6yRhmcm37egcAEmUGEg7FD/lljXvY3q4KbhlHuD/WGLaVs8q1TYw0pYhn0R\nm8177WK8LpH8b24xoxw8TNLhp3HxSekqd4m1dGQypLmrtQrnxh7T+wy1ik5xfzA=\n=K+v5\n-----END PGP SIGNATURE-----\n", "payload": "tree bbc3be0bd19fda0a61f56c9b10f705657f450744\nparent f1bcf975a7f692b0d395224e4ce3e587e7cab3b5\nparent 5d08ac20d9de138d69c9c86c6c6814629a1d9190\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1631200063 +0000\ncommitter GitHub <noreply@github.com> 1631200063 +0000\n\nMerge #10188\n\n10188: fix: add multi-token mapping support to runnables r=jonas-schievink a=lnicola\n\nCloses #10184\r\n\r\n\r\nchangelog fix (first contribution) add multi-token mapping support to runnables\n\nCo-authored-by: Anatol Ulrich <anatol.ulrich@ferrous-systems.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/92ce768ea3dcfe5cda55f2a4607d4245730e0d64", "html_url": "https://github.com/rust-lang/rust/commit/92ce768ea3dcfe5cda55f2a4607d4245730e0d64", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/92ce768ea3dcfe5cda55f2a4607d4245730e0d64/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1bcf975a7f692b0d395224e4ce3e587e7cab3b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1bcf975a7f692b0d395224e4ce3e587e7cab3b5", "html_url": "https://github.com/rust-lang/rust/commit/f1bcf975a7f692b0d395224e4ce3e587e7cab3b5"}, {"sha": "5d08ac20d9de138d69c9c86c6c6814629a1d9190", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d08ac20d9de138d69c9c86c6c6814629a1d9190", "html_url": "https://github.com/rust-lang/rust/commit/5d08ac20d9de138d69c9c86c6c6814629a1d9190"}], "stats": {"total": 19, "additions": 12, "deletions": 7}, "files": [{"sha": "6b74ec3430de57c5319fc344718c28800f905eab", "filename": "crates/ide/src/runnables.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/92ce768ea3dcfe5cda55f2a4607d4245730e0d64/crates%2Fide%2Fsrc%2Frunnables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ce768ea3dcfe5cda55f2a4607d4245730e0d64/crates%2Fide%2Fsrc%2Frunnables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Frunnables.rs?ref=92ce768ea3dcfe5cda55f2a4607d4245730e0d64", "patch": "@@ -229,15 +229,20 @@ fn find_related_tests(\n         for (file_id, refs) in refs.into_iter().flat_map(|refs| refs.references) {\n             let file = sema.parse(file_id);\n             let file = file.syntax();\n-            let functions = refs.iter().filter_map(|(range, _)| {\n-                let token = file.token_at_offset(range.start()).next()?;\n-                let token = sema.descend_into_macros(token);\n-                token\n-                    .ancestors()\n-                    .find_map(ast::Fn::cast)\n-                    .map(|f| hir::InFile::new(sema.hir_file_for(f.syntax()), f))\n+\n+            // create flattened vec of tokens\n+            let tokens = refs.iter().flat_map(|(range, _)| {\n+                match file.token_at_offset(range.start()).next() {\n+                    Some(token) => sema.descend_into_macros_many(token),\n+                    None => Default::default(),\n+                }\n             });\n \n+            // find first suitable ancestor\n+            let functions = tokens\n+                .filter_map(|token| token.ancestors().find_map(ast::Fn::cast))\n+                .map(|f| hir::InFile::new(sema.hir_file_for(f.syntax()), f));\n+\n             for fn_def in functions {\n                 // #[test/bench] expands to just the item causing us to lose the attribute, so recover them by going out of the attribute\n                 let InFile { value: fn_def, .. } = &fn_def.node_with_attributes(sema.db);"}]}