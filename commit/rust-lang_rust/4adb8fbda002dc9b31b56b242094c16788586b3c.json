{"sha": "4adb8fbda002dc9b31b56b242094c16788586b3c", "node_id": "C_kwDOAAsO6NoAKDRhZGI4ZmJkYTAwMmRjOWIzMWI1NmIyNDIwOTRjMTY3ODg1ODZiM2M", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2023-03-27T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2023-04-26T22:33:52Z"}, "message": "Remove workaround for CastKind::Transmute from const prop\n\nSince constants are no longer validated before propagation the\nworkaround is obsolete. Remove it.", "tree": {"sha": "3d50d4ca6bd86047c83fb3e6a48cc3b49793cd10", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d50d4ca6bd86047c83fb3e6a48cc3b49793cd10"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4adb8fbda002dc9b31b56b242094c16788586b3c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4adb8fbda002dc9b31b56b242094c16788586b3c", "html_url": "https://github.com/rust-lang/rust/commit/4adb8fbda002dc9b31b56b242094c16788586b3c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4adb8fbda002dc9b31b56b242094c16788586b3c/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bc41973e35e60fe01cb6f464240a2f1db9afb4bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc41973e35e60fe01cb6f464240a2f1db9afb4bd", "html_url": "https://github.com/rust-lang/rust/commit/bc41973e35e60fe01cb6f464240a2f1db9afb4bd"}], "stats": {"total": 34, "additions": 19, "deletions": 15}, "files": [{"sha": "7ac8ffb495517d38d66534658ce9685a92a55c31", "filename": "compiler/rustc_mir_transform/src/const_prop.rs", "status": "modified", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4adb8fbda002dc9b31b56b242094c16788586b3c/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4adb8fbda002dc9b31b56b242094c16788586b3c/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs?ref=4adb8fbda002dc9b31b56b242094c16788586b3c", "patch": "@@ -501,16 +501,6 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n \n                 return None;\n             }\n-            // Do not try creating references, nor any types with potentially-complex\n-            // invariants. This avoids an issue where checking validity would do a\n-            // bunch of work generating a nice message about the invariant violation,\n-            // only to not show it to anyone (since this isn't the lint).\n-            Rvalue::Cast(CastKind::Transmute, op, dst_ty) if !dst_ty.is_primitive() => {\n-                trace!(\"skipping Transmute of {:?} to {:?}\", op, dst_ty);\n-\n-                return None;\n-            }\n-\n             // There's no other checking to do at this time.\n             Rvalue::Aggregate(..)\n             | Rvalue::Use(..)"}, {"sha": "4a31194de6eed992d5ec2c9d00ee9ef7ac596d28", "filename": "tests/mir-opt/const_prop/transmute.invalid_bool.ConstProp.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.invalid_bool.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.invalid_bool.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.invalid_bool.ConstProp.diff?ref=4adb8fbda002dc9b31b56b242094c16788586b3c", "patch": "@@ -7,7 +7,8 @@\n       }\n   \n       bb0: {\n-          _0 = const -1_i8 as bool (Transmute); // scope 1 at $DIR/transmute.rs:+1:14: +1:30\n+-         _0 = const -1_i8 as bool (Transmute); // scope 1 at $DIR/transmute.rs:+1:14: +1:30\n++         _0 = const {transmute(0xff): bool}; // scope 1 at $DIR/transmute.rs:+1:14: +1:30\n           return;                          // scope 0 at $DIR/transmute.rs:+2:2: +2:2\n       }\n   }"}, {"sha": "2c541f2f6a08442803a31b68176d628580384ddd", "filename": "tests/mir-opt/const_prop/transmute.invalid_char.ConstProp.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.invalid_char.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.invalid_char.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.invalid_char.ConstProp.diff?ref=4adb8fbda002dc9b31b56b242094c16788586b3c", "patch": "@@ -7,7 +7,8 @@\n       }\n   \n       bb0: {\n-          _0 = const _ as char (Transmute); // scope 1 at $DIR/transmute.rs:+1:14: +1:33\n+-         _0 = const _ as char (Transmute); // scope 1 at $DIR/transmute.rs:+1:14: +1:33\n++         _0 = const {transmute(0x7fffffff): char}; // scope 1 at $DIR/transmute.rs:+1:14: +1:33\n           return;                          // scope 0 at $DIR/transmute.rs:+2:2: +2:2\n       }\n   }"}, {"sha": "c4376e6e17afc32fee69357adddc2f0771217e9c", "filename": "tests/mir-opt/const_prop/transmute.unreachable_box.ConstProp.diff", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_box.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_box.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_box.ConstProp.diff?ref=4adb8fbda002dc9b31b56b242094c16788586b3c", "patch": "@@ -15,7 +15,11 @@\n       bb0: {\n           StorageLive(_1);                 // scope 0 at $DIR/transmute.rs:+0:38: +3:2\n           StorageLive(_2);                 // scope 0 at $DIR/transmute.rs:+1:9: +1:10\n-          _2 = const 1_usize as std::boxed::Box<Never> (Transmute); // scope 2 at $DIR/transmute.rs:+1:34: +1:52\n+-         _2 = const 1_usize as std::boxed::Box<Never> (Transmute); // scope 2 at $DIR/transmute.rs:+1:34: +1:52\n++         _2 = const Box::<Never>(Unique::<Never> {{ pointer: NonNull::<Never> {{ pointer: {0x1 as *const Never} }}, _marker: PhantomData::<Never> }}, std::alloc::Global); // scope 2 at $DIR/transmute.rs:+1:34: +1:52\n++                                          // mir::Constant\n++                                          // + span: no-location\n++                                          // + literal: Const { ty: Box<Never>, val: Value(Scalar(0x0000000000000001)) }\n           StorageLive(_3);                 // scope 1 at $DIR/transmute.rs:+2:5: +2:16\n           unreachable;                     // scope 1 at $DIR/transmute.rs:+2:11: +2:13\n       }"}, {"sha": "62300d2e313b3671a865574ff2a61758d2fd0a40", "filename": "tests/mir-opt/const_prop/transmute.unreachable_mut.ConstProp.diff", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_mut.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_mut.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_mut.ConstProp.diff?ref=4adb8fbda002dc9b31b56b242094c16788586b3c", "patch": "@@ -17,7 +17,11 @@\n           StorageLive(_1);                 // scope 0 at $DIR/transmute.rs:+0:38: +3:2\n           StorageLive(_2);                 // scope 0 at $DIR/transmute.rs:+1:9: +1:10\n           StorageLive(_3);                 // scope 0 at $DIR/transmute.rs:+1:34: +1:52\n-          _3 = const 1_usize as &mut Never (Transmute); // scope 2 at $DIR/transmute.rs:+1:34: +1:52\n+-         _3 = const 1_usize as &mut Never (Transmute); // scope 2 at $DIR/transmute.rs:+1:34: +1:52\n++         _3 = const {0x1 as &mut Never};  // scope 2 at $DIR/transmute.rs:+1:34: +1:52\n++                                          // mir::Constant\n++                                          // + span: no-location\n++                                          // + literal: Const { ty: &mut Never, val: Value(Scalar(0x0000000000000001)) }\n           _2 = &mut (*_3);                 // scope 0 at $DIR/transmute.rs:+1:34: +1:52\n           StorageDead(_3);                 // scope 0 at $DIR/transmute.rs:+1:54: +1:55\n           StorageLive(_4);                 // scope 1 at $DIR/transmute.rs:+2:5: +2:16"}, {"sha": "8b11cea93658d17a92c5e016fe59fa759b4cc19f", "filename": "tests/mir-opt/const_prop/transmute.unreachable_ref.ConstProp.diff", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_ref.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/4adb8fbda002dc9b31b56b242094c16788586b3c/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_ref.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Ftransmute.unreachable_ref.ConstProp.diff?ref=4adb8fbda002dc9b31b56b242094c16788586b3c", "patch": "@@ -15,7 +15,11 @@\n       bb0: {\n           StorageLive(_1);                 // scope 0 at $DIR/transmute.rs:+0:38: +3:2\n           StorageLive(_2);                 // scope 0 at $DIR/transmute.rs:+1:9: +1:10\n-          _2 = const 1_usize as &Never (Transmute); // scope 2 at $DIR/transmute.rs:+1:30: +1:48\n+-         _2 = const 1_usize as &Never (Transmute); // scope 2 at $DIR/transmute.rs:+1:30: +1:48\n++         _2 = const {0x1 as &Never};      // scope 2 at $DIR/transmute.rs:+1:30: +1:48\n++                                          // mir::Constant\n++                                          // + span: no-location\n++                                          // + literal: Const { ty: &Never, val: Value(Scalar(0x0000000000000001)) }\n           StorageLive(_3);                 // scope 1 at $DIR/transmute.rs:+2:5: +2:16\n           unreachable;                     // scope 1 at $DIR/transmute.rs:+2:11: +2:13\n       }"}]}