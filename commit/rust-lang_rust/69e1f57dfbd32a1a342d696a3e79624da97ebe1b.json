{"sha": "69e1f57dfbd32a1a342d696a3e79624da97ebe1b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5ZTFmNTdkZmJkMzJhMWEzNDJkNjk2YTNlNzk2MjRkYTk3ZWJlMWI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-01-11T06:40:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-01-11T06:40:58Z"}, "message": "Auto merge of #30295 - jseyfried:fix_extern_crate_duplicate, r=nrc\n\nFix a bug allowing an item and an external crate to collide so long as the external crate is declared after the item. For example,\n```rust\nmod core { pub fn f() {} } // This would be an error if it followed the `extern crate`\nextern crate core; // This declaration is shadowed by the preceding module\n\nfn main() { core::f(); }\n```\nThis is a [breaking-change], but it looks unlikely to cause breakage in practice, and any breakage can be fixed by removing colliding `extern crate` declarations, which are shadowed and hence unused.", "tree": {"sha": "42571100253fd85695b9a256399e9476c2974253", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/42571100253fd85695b9a256399e9476c2974253"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/69e1f57dfbd32a1a342d696a3e79624da97ebe1b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/69e1f57dfbd32a1a342d696a3e79624da97ebe1b", "html_url": "https://github.com/rust-lang/rust/commit/69e1f57dfbd32a1a342d696a3e79624da97ebe1b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/69e1f57dfbd32a1a342d696a3e79624da97ebe1b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d70ab2bdf16c22b9f3ff0230089b44855e3f1593", "url": "https://api.github.com/repos/rust-lang/rust/commits/d70ab2bdf16c22b9f3ff0230089b44855e3f1593", "html_url": "https://github.com/rust-lang/rust/commit/d70ab2bdf16c22b9f3ff0230089b44855e3f1593"}, {"sha": "834fb17e9476204dbd5723cd2cc3617bf848b9e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/834fb17e9476204dbd5723cd2cc3617bf848b9e9", "html_url": "https://github.com/rust-lang/rust/commit/834fb17e9476204dbd5723cd2cc3617bf848b9e9"}], "stats": {"total": 35, "additions": 22, "deletions": 13}, "files": [{"sha": "8ed47300a17082ad95370d888330ac7755cf1c6a", "filename": "src/librustc_resolve/build_reduced_graph.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/69e1f57dfbd32a1a342d696a3e79624da97ebe1b/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69e1f57dfbd32a1a342d696a3e79624da97ebe1b/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs?ref=69e1f57dfbd32a1a342d696a3e79624da97ebe1b", "patch": "@@ -325,7 +325,7 @@ impl<'a, 'b:'a, 'tcx:'b> GraphBuilder<'a, 'b, 'tcx> {\n \n                     debug!(\"(build reduced graph for item) found extern `{}`\",\n                            module_to_string(&*external_module));\n-                    self.check_for_conflicts_between_external_crates(&**parent, name, sp);\n+                    self.check_for_conflicts_for_external_crate(&parent, name, sp);\n                     parent.external_module_children\n                           .borrow_mut()\n                           .insert(name, external_module.clone());"}, {"sha": "c7031f72af4639d738a68547f55f79d446938070", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 21, "deletions": 12, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/69e1f57dfbd32a1a342d696a3e79624da97ebe1b/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69e1f57dfbd32a1a342d696a3e79624da97ebe1b/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=69e1f57dfbd32a1a342d696a3e79624da97ebe1b", "patch": "@@ -122,6 +122,8 @@ enum SuggestionType {\n }\n \n pub enum ResolutionError<'a> {\n+    /// error E0260: name conflicts with an extern crate\n+    NameConflictsWithExternCrate(Name),\n     /// error E0401: can't use type parameters from outer function\n     TypeParametersFromOuterFunction,\n     /// error E0402: cannot use an outer type parameter in this context\n@@ -228,6 +230,14 @@ fn resolve_struct_error<'b, 'a: 'b, 'tcx: 'a>(resolver: &'b Resolver<'a, 'tcx>,\n     }\n \n     match resolution_error {\n+        ResolutionError::NameConflictsWithExternCrate(name) => {\n+            struct_span_err!(resolver.session,\n+                             span,\n+                             E0260,\n+                             \"the name `{}` conflicts with an external crate \\\n+                             that has been imported into this module\",\n+                             name)\n+        }\n         ResolutionError::TypeParametersFromOuterFunction => {\n             struct_span_err!(resolver.session,\n                              span,\n@@ -1297,19 +1307,23 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n         }\n     }\n \n-    /// Checks that the names of external crates don't collide with other\n-    /// external crates.\n-    fn check_for_conflicts_between_external_crates(&self,\n-                                                   module: &Module,\n-                                                   name: Name,\n-                                                   span: Span) {\n+    /// Check that an external crate doesn't collide with items or other external crates.\n+    fn check_for_conflicts_for_external_crate(&self, module: &Module, name: Name, span: Span) {\n         if module.external_module_children.borrow().contains_key(&name) {\n             span_err!(self.session,\n                       span,\n                       E0259,\n                       \"an external crate named `{}` has already been imported into this module\",\n                       name);\n         }\n+        match module.children.borrow().get(&name) {\n+            Some(name_bindings) if name_bindings.type_ns.defined() => {\n+                resolve_error(self,\n+                              name_bindings.type_ns.span().unwrap_or(codemap::DUMMY_SP),\n+                              ResolutionError::NameConflictsWithExternCrate(name));\n+            }\n+            _ => {},\n+        }\n     }\n \n     /// Checks that the names of items don't collide with external crates.\n@@ -1318,12 +1332,7 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n                                                              name: Name,\n                                                              span: Span) {\n         if module.external_module_children.borrow().contains_key(&name) {\n-            span_err!(self.session,\n-                      span,\n-                      E0260,\n-                      \"the name `{}` conflicts with an external crate that has been imported \\\n-                       into this module\",\n-                      name);\n+            resolve_error(self, span, ResolutionError::NameConflictsWithExternCrate(name));\n         }\n     }\n "}]}