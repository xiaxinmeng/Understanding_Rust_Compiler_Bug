{"sha": "b5c5995bf13da31bb97113a7eea5c138555c2b1b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1YzU5OTViZjEzZGEzMWJiOTcxMTNhN2VlYTVjMTM4NTU1YzJiMWI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-12-21T11:38:41Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-12-21T11:38:41Z"}, "message": "use builder interface for completion item", "tree": {"sha": "81f8eee77b832c49a3c47f5b4fc4738cd83f2284", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81f8eee77b832c49a3c47f5b4fc4738cd83f2284"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b5c5995bf13da31bb97113a7eea5c138555c2b1b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b5c5995bf13da31bb97113a7eea5c138555c2b1b", "html_url": "https://github.com/rust-lang/rust/commit/b5c5995bf13da31bb97113a7eea5c138555c2b1b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b5c5995bf13da31bb97113a7eea5c138555c2b1b/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0ff6176ed0401251ae9f84d115a888fa4baee89", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0ff6176ed0401251ae9f84d115a888fa4baee89", "html_url": "https://github.com/rust-lang/rust/commit/b0ff6176ed0401251ae9f84d115a888fa4baee89"}], "stats": {"total": 99, "additions": 40, "deletions": 59}, "files": [{"sha": "bf2297e696ccd8097b3e27164460d5c5668df48f", "filename": "Cargo.lock", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b5c5995bf13da31bb97113a7eea5c138555c2b1b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/b5c5995bf13da31bb97113a7eea5c138555c2b1b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=b5c5995bf13da31bb97113a7eea5c138555c2b1b", "patch": "@@ -734,7 +734,7 @@ dependencies = [\n  \"serde 1.0.82 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_derive 1.0.82 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_json 1.0.33 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"smol_str 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"test_utils 0.1.0\",\n  \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -959,7 +959,7 @@ version = \"0.1.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"parking_lot 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"smol_str 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n@@ -1092,7 +1092,7 @@ dependencies = [\n \n [[package]]\n name = \"smol_str\"\n-version = \"0.1.7\"\n+version = \"0.1.8\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"serde 1.0.82 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1565,7 +1565,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum sha-1 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"51b9d1f3b5de8a167ab06834a7c883bd197f2191e1dda1a22d9ccfeedbf9aded\"\n \"checksum slug 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b3bc762e6a4b6c6fcaade73e77f9ebc6991b676f88bb2358bddb56560f073373\"\n \"checksum smallvec 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b73ea3738b47563803ef814925e69be00799a8c07420be8b996f8e98fb2336db\"\n-\"checksum smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\" = \"f3ed6f19b800d76574926e458d5f8e2dbea86c2b58c08d33a982448f09ac8d0c\"\n+\"checksum smol_str 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"486a74e9b9fc53373808f7a17e10fc728adcb1fbe272292271d8bea61175e181\"\n \"checksum stable_deref_trait 1.1.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"dba1a27d3efae4351c8051072d619e3ade2820635c3958d826bfea39d59b54c8\"\n \"checksum strsim 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bb4f380125926a99e52bc279241539c018323fab05ad6368b56f93d9369ff550\"\n \"checksum superslice 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b50b13d42370e0f5fc62eafdd5c2d20065eaf5458dab215ff3e20e63eea96b30\""}, {"sha": "fd7b78c2a7d6dbcdd101d1cb4939e2b34430e73b", "filename": "crates/ra_analysis/src/completion.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b5c5995bf13da31bb97113a7eea5c138555c2b1b/crates%2Fra_analysis%2Fsrc%2Fcompletion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c5995bf13da31bb97113a7eea5c138555c2b1b/crates%2Fra_analysis%2Fsrc%2Fcompletion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fcompletion.rs?ref=b5c5995bf13da31bb97113a7eea5c138555c2b1b", "patch": "@@ -428,7 +428,7 @@ mod tests {\n                 <|>\n             }\n             \",\n-            r##\"[CompletionItem { label: \"Test function\", lookup: Some(\"tfn\"), snippet: Some(\"#[test]\\nfn ${1:feature}() {\\n$0\\n}\") },\n+            r##\"[CompletionItem { label: \"Test function\", lookup: Some(\"tfn\"), snippet: Some(\"#[test]\\nfn ${1:feature}() {\\n    $0\\n}\") },\n                  CompletionItem { label: \"pub(crate)\", lookup: None, snippet: Some(\"pub(crate) $0\") }]\"##,\n         );\n     }"}, {"sha": "7edb864363bcb42e8f516e7077234c5f561710e1", "filename": "crates/ra_analysis/src/completion/completion_item.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b5c5995bf13da31bb97113a7eea5c138555c2b1b/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Fcompletion_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c5995bf13da31bb97113a7eea5c138555c2b1b/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Fcompletion_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Fcompletion_item.rs?ref=b5c5995bf13da31bb97113a7eea5c138555c2b1b", "patch": "@@ -19,6 +19,7 @@ impl CompletionItem {\n     }\n }\n \n+#[must_use]\n pub(crate) struct Builder {\n     label: String,\n     lookup: Option<String>,\n@@ -41,4 +42,8 @@ impl Builder {\n         self.lookup = Some(lookup.into());\n         self\n     }\n+    pub fn snippet(mut self, snippet: impl Into<String>) -> Builder {\n+        self.snippet = Some(snippet.into());\n+        self\n+    }\n }"}, {"sha": "23052295c1c66a876fec61734fbb36ed26effc60", "filename": "crates/ra_analysis/src/completion/reference_completion.rs", "status": "modified", "additions": 30, "deletions": 54, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/b5c5995bf13da31bb97113a7eea5c138555c2b1b/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Freference_completion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c5995bf13da31bb97113a7eea5c138555c2b1b/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Freference_completion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Freference_completion.rs?ref=b5c5995bf13da31bb97113a7eea5c138555c2b1b", "patch": "@@ -125,23 +125,13 @@ fn classify_name_ref(name_ref: ast::NameRef) -> Option<NameRefKind> {\n \n fn complete_fn(name_ref: ast::NameRef, scopes: &FnScopes, acc: &mut Vec<CompletionItem>) {\n     let mut shadowed = FxHashSet::default();\n-    acc.extend(\n-        scopes\n-            .scope_chain(name_ref.syntax())\n-            .flat_map(|scope| scopes.entries(scope).iter())\n-            .filter(|entry| shadowed.insert(entry.name()))\n-            .map(|entry| CompletionItem {\n-                label: entry.name().to_string(),\n-                lookup: None,\n-                snippet: None,\n-            }),\n-    );\n+    scopes\n+        .scope_chain(name_ref.syntax())\n+        .flat_map(|scope| scopes.entries(scope).iter())\n+        .filter(|entry| shadowed.insert(entry.name()))\n+        .for_each(|entry| CompletionItem::new(entry.name().to_string()).add_to(acc));\n     if scopes.self_param.is_some() {\n-        acc.push(CompletionItem {\n-            label: \"self\".to_string(),\n-            lookup: None,\n-            snippet: None,\n-        })\n+        CompletionItem::new(\"self\").add_to(acc);\n     }\n }\n \n@@ -164,32 +154,26 @@ fn complete_path(\n         _ => return Ok(()),\n     };\n     let module_scope = target_module.scope(db)?;\n-    let completions = module_scope.entries().map(|(name, _res)| CompletionItem {\n-        label: name.to_string(),\n-        lookup: None,\n-        snippet: None,\n-    });\n-    acc.extend(completions);\n+    module_scope\n+        .entries()\n+        .for_each(|(name, _res)| CompletionItem::new(name.to_string()).add_to(acc));\n     Ok(())\n }\n \n fn complete_mod_item_snippets(acc: &mut Vec<CompletionItem>) {\n-    acc.push(CompletionItem {\n-        label: \"Test function\".to_string(),\n-        lookup: Some(\"tfn\".to_string()),\n-        snippet: Some(\n-            \"#[test]\\n\\\n-             fn ${1:feature}() {\\n\\\n-             $0\\n\\\n-             }\"\n-            .to_string(),\n-        ),\n-    });\n-    acc.push(CompletionItem {\n-        label: \"pub(crate)\".to_string(),\n-        lookup: None,\n-        snippet: Some(\"pub(crate) $0\".to_string()),\n-    })\n+    CompletionItem::new(\"Test function\")\n+        .lookup_by(\"tfn\")\n+        .snippet(\n+            \"\\\n+#[test]\n+fn ${1:feature}() {\n+    $0\n+}\",\n+        )\n+        .add_to(acc);\n+    CompletionItem::new(\"pub(crate)\")\n+        .snippet(\"pub(crate) $0\")\n+        .add_to(acc);\n }\n \n fn complete_expr_keywords(\n@@ -270,23 +254,15 @@ fn complete_return(fn_def: ast::FnDef, name_ref: ast::NameRef) -> Option<Complet\n     Some(keyword(\"return\", snip))\n }\n \n-fn keyword(kw: &str, snip: &str) -> CompletionItem {\n-    CompletionItem {\n-        label: kw.to_string(),\n-        lookup: None,\n-        snippet: Some(snip.to_string()),\n-    }\n+fn keyword(kw: &str, snippet: &str) -> CompletionItem {\n+    CompletionItem::new(kw).snippet(snippet).build()\n }\n \n fn complete_expr_snippets(acc: &mut Vec<CompletionItem>) {\n-    acc.push(CompletionItem {\n-        label: \"pd\".to_string(),\n-        lookup: None,\n-        snippet: Some(\"eprintln!(\\\"$0 = {:?}\\\", $0);\".to_string()),\n-    });\n-    acc.push(CompletionItem {\n-        label: \"ppd\".to_string(),\n-        lookup: None,\n-        snippet: Some(\"eprintln!(\\\"$0 = {:#?}\\\", $0);\".to_string()),\n-    });\n+    CompletionItem::new(\"pd\")\n+        .snippet(\"eprintln!(\\\"$0 = {:?}\\\", $0);\")\n+        .add_to(acc);\n+    CompletionItem::new(\"ppd\")\n+        .snippet(\"eprintln!(\\\"$0 = {:#?}\\\", $0);\")\n+        .add_to(acc);\n }"}]}