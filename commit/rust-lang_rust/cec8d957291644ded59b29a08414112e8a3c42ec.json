{"sha": "cec8d957291644ded59b29a08414112e8a3c42ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlYzhkOTU3MjkxNjQ0ZGVkNTliMjlhMDg0MTQxMTJlOGEzYzQyZWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-17T17:13:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-17T17:13:57Z"}, "message": "Auto merge of #7233 - giraffate:fix_manual_unwrap_or_fp_with_deref_coercion, r=flip1995\n\nFix a `manual_unwrap_or` FP with deref coercion\n\nFix https://github.com/rust-lang/rust-clippy/issues/7228.\n\nchangelog: Fix a [`manual_unwrap_or`] FP with deref coercion", "tree": {"sha": "25eabcac52e95857d04c4db65f8acd1ef45977ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/25eabcac52e95857d04c4db65f8acd1ef45977ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cec8d957291644ded59b29a08414112e8a3c42ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cec8d957291644ded59b29a08414112e8a3c42ec", "html_url": "https://github.com/rust-lang/rust/commit/cec8d957291644ded59b29a08414112e8a3c42ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cec8d957291644ded59b29a08414112e8a3c42ec/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acdf43f2575d534893840091c6c0a19b861ab263", "url": "https://api.github.com/repos/rust-lang/rust/commits/acdf43f2575d534893840091c6c0a19b861ab263", "html_url": "https://github.com/rust-lang/rust/commit/acdf43f2575d534893840091c6c0a19b861ab263"}, {"sha": "ebf065e5172227a99743f4032c5bfff80d5630e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/ebf065e5172227a99743f4032c5bfff80d5630e6", "html_url": "https://github.com/rust-lang/rust/commit/ebf065e5172227a99743f4032c5bfff80d5630e6"}], "stats": {"total": 19, "additions": 19, "deletions": 0}, "files": [{"sha": "cf183d4c16f12a505143bc055e9136a1d0424feb", "filename": "clippy_lints/src/manual_unwrap_or.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cec8d957291644ded59b29a08414112e8a3c42ec/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cec8d957291644ded59b29a08414112e8a3c42ec/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs?ref=cec8d957291644ded59b29a08414112e8a3c42ec", "patch": "@@ -11,6 +11,7 @@ use rustc_hir::{Arm, Expr, ExprKind, PatKind};\n use rustc_lint::LintContext;\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::lint::in_external_macro;\n+use rustc_middle::ty::adjustment::Adjust;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n \n@@ -87,6 +88,8 @@ fn lint_manual_unwrap_or<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'tcx>) {\n             if let PatKind::Binding(_, binding_hir_id, ..) = unwrap_pat.kind;\n             if path_to_local_id(unwrap_arm.body, binding_hir_id);\n             if !contains_return_break_continue_macro(or_arm.body);\n+            if !cx.typeck_results().expr_adjustments(unwrap_arm.body).iter()\n+                .any(|a| matches!(a.kind, Adjust::Deref(Some(..))));\n             then {\n                 Some(or_arm)\n             } else {"}, {"sha": "1efecb0ba12779b0bc1c5bc28071ee9d61030d09", "filename": "tests/ui/manual_unwrap_or.fixed", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cec8d957291644ded59b29a08414112e8a3c42ec/tests%2Fui%2Fmanual_unwrap_or.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/cec8d957291644ded59b29a08414112e8a3c42ec/tests%2Fui%2Fmanual_unwrap_or.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_unwrap_or.fixed?ref=cec8d957291644ded59b29a08414112e8a3c42ec", "patch": "@@ -163,4 +163,12 @@ mod issue6965 {\n     }\n }\n \n+use std::rc::Rc;\n+fn format_name(name: Option<&Rc<str>>) -> &str {\n+    match name {\n+        None => \"<anon>\",\n+        Some(name) => name,\n+    }\n+}\n+\n fn main() {}"}, {"sha": "95d585ad18a96c1f093e573d081fe6dd677fcb7e", "filename": "tests/ui/manual_unwrap_or.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cec8d957291644ded59b29a08414112e8a3c42ec/tests%2Fui%2Fmanual_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cec8d957291644ded59b29a08414112e8a3c42ec/tests%2Fui%2Fmanual_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_unwrap_or.rs?ref=cec8d957291644ded59b29a08414112e8a3c42ec", "patch": "@@ -205,4 +205,12 @@ mod issue6965 {\n     }\n }\n \n+use std::rc::Rc;\n+fn format_name(name: Option<&Rc<str>>) -> &str {\n+    match name {\n+        None => \"<anon>\",\n+        Some(name) => name,\n+    }\n+}\n+\n fn main() {}"}]}