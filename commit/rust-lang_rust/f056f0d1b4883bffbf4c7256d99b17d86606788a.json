{"sha": "f056f0d1b4883bffbf4c7256d99b17d86606788a", "node_id": "C_kwDOAAsO6NoAKGYwNTZmMGQxYjQ4ODNiZmZiZjRjNzI1NmQ5OWIxN2Q4NjYwNjc4OGE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-12-03T05:24:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-12-03T05:24:17Z"}, "message": "Rollup merge of #91462 - b-naber:use-try-normalize-erasing-regions, r=jackh726\n\nUse try_normalize_erasing_regions in needs_drop\n\nFixes https://github.com/rust-lang/rust/issues/81199\n\nr? ``@jackh726``", "tree": {"sha": "1d03dbb2f21fa21142ddde7ae8b43457e032c629", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1d03dbb2f21fa21142ddde7ae8b43457e032c629"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f056f0d1b4883bffbf4c7256d99b17d86606788a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhqaoBCRBK7hj4Ov3rIwAA9bYIABVXLJCOQ3vbqu90D9tYMeBH\nyMOZJIvebBMh37lu821EvCBpHnnAuYCYirGVm055iib1ErHAQfOOI8UaWZFV7Jy3\ntKrVAhHFydeQphjyPIm1QV/8kWbbz0bcfjvQOzU24ciEc09iKezrguaSU/QXbqAD\nD7qIweVHUL066f1eMnSvXt7g03LdTQ6bs0laHpdpaIMyohMMApFRs7xjdQnr8Ma7\nnAS+NIQvadnRnVg99ijqssFNo+oFjYGoAr8+WlR3aoUuRZ+mp5jZaTHiqnVdH/Vx\nHRVINmbsSJ4HpVJif8bXd3Xzjjch8O/aMSzeQJA10TrRQl6gBWxbOOSihQtHz7c=\n=4FmW\n-----END PGP SIGNATURE-----\n", "payload": "tree 1d03dbb2f21fa21142ddde7ae8b43457e032c629\nparent 25474ed73162b8e31b17064a7720c91315bc3b36\nparent a11994e4230c777a5fbcc3bb1cc080903e7c1664\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1638509057 +0100\ncommitter GitHub <noreply@github.com> 1638509057 +0100\n\nRollup merge of #91462 - b-naber:use-try-normalize-erasing-regions, r=jackh726\n\nUse try_normalize_erasing_regions in needs_drop\n\nFixes https://github.com/rust-lang/rust/issues/81199\n\nr? ``@jackh726``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f056f0d1b4883bffbf4c7256d99b17d86606788a", "html_url": "https://github.com/rust-lang/rust/commit/f056f0d1b4883bffbf4c7256d99b17d86606788a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f056f0d1b4883bffbf4c7256d99b17d86606788a/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25474ed73162b8e31b17064a7720c91315bc3b36", "url": "https://api.github.com/repos/rust-lang/rust/commits/25474ed73162b8e31b17064a7720c91315bc3b36", "html_url": "https://github.com/rust-lang/rust/commit/25474ed73162b8e31b17064a7720c91315bc3b36"}, {"sha": "a11994e4230c777a5fbcc3bb1cc080903e7c1664", "url": "https://api.github.com/repos/rust-lang/rust/commits/a11994e4230c777a5fbcc3bb1cc080903e7c1664", "html_url": "https://github.com/rust-lang/rust/commit/a11994e4230c777a5fbcc3bb1cc080903e7c1664"}], "stats": {"total": 64, "additions": 60, "deletions": 4}, "files": [{"sha": "ba9b2eae2c830abaedc5533e8fe463edab8be214", "filename": "compiler/rustc_middle/src/ty/util.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f056f0d1b4883bffbf4c7256d99b17d86606788a/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f056f0d1b4883bffbf4c7256d99b17d86606788a/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs?ref=f056f0d1b4883bffbf4c7256d99b17d86606788a", "patch": "@@ -788,10 +788,14 @@ impl<'tcx> ty::TyS<'tcx> {\n                     [component_ty] => component_ty,\n                     _ => self,\n                 };\n+\n                 // This doesn't depend on regions, so try to minimize distinct\n                 // query keys used.\n-                let erased = tcx.normalize_erasing_regions(param_env, query_ty);\n-                tcx.needs_drop_raw(param_env.and(erased))\n+                // If normalization fails, we just use `query_ty`.\n+                let query_ty =\n+                    tcx.try_normalize_erasing_regions(param_env, query_ty).unwrap_or(query_ty);\n+\n+                tcx.needs_drop_raw(param_env.and(query_ty))\n             }\n         }\n     }"}, {"sha": "fc309aa848ca195d39c755f0ffb8f196b3ca2fc0", "filename": "compiler/rustc_ty_utils/src/needs_drop.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f056f0d1b4883bffbf4c7256d99b17d86606788a/compiler%2Frustc_ty_utils%2Fsrc%2Fneeds_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f056f0d1b4883bffbf4c7256d99b17d86606788a/compiler%2Frustc_ty_utils%2Fsrc%2Fneeds_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fneeds_drop.rs?ref=f056f0d1b4883bffbf4c7256d99b17d86606788a", "patch": "@@ -147,8 +147,10 @@ where\n                             Ok(tys) => tys,\n                         };\n                         for required_ty in tys {\n-                            let required =\n-                                tcx.normalize_erasing_regions(self.param_env, required_ty);\n+                            let required = tcx\n+                                .try_normalize_erasing_regions(self.param_env, required_ty)\n+                                .unwrap_or(required_ty);\n+\n                             queue_type(self, required);\n                         }\n                     }"}, {"sha": "628e7c6ed5da816cf6a89fbc6966310cd935ab2e", "filename": "src/test/ui/union/issue-81199.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/f056f0d1b4883bffbf4c7256d99b17d86606788a/src%2Ftest%2Fui%2Funion%2Fissue-81199.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f056f0d1b4883bffbf4c7256d99b17d86606788a/src%2Ftest%2Fui%2Funion%2Fissue-81199.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funion%2Fissue-81199.rs?ref=f056f0d1b4883bffbf4c7256d99b17d86606788a", "patch": "@@ -0,0 +1,21 @@\n+#[repr(C)]\n+union PtrRepr<T: ?Sized> {\n+    const_ptr: *const T,\n+    mut_ptr: *mut T,\n+    components: PtrComponents<T>,\n+    //~^ ERROR the trait bound\n+}\n+\n+#[repr(C)]\n+struct PtrComponents<T: Pointee + ?Sized> {\n+    data_address: *const (),\n+    metadata: <T as Pointee>::Metadata,\n+}\n+\n+\n+\n+pub trait Pointee {\n+   type Metadata;\n+}\n+\n+fn main() {}"}, {"sha": "f26bfe3a0b060804fc58eee0fce98f77e61f9ecf", "filename": "src/test/ui/union/issue-81199.stderr", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/f056f0d1b4883bffbf4c7256d99b17d86606788a/src%2Ftest%2Fui%2Funion%2Fissue-81199.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f056f0d1b4883bffbf4c7256d99b17d86606788a/src%2Ftest%2Fui%2Funion%2Fissue-81199.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funion%2Fissue-81199.stderr?ref=f056f0d1b4883bffbf4c7256d99b17d86606788a", "patch": "@@ -0,0 +1,29 @@\n+error[E0277]: the trait bound `T: Pointee` is not satisfied in `PtrComponents<T>`\n+  --> $DIR/issue-81199.rs:5:17\n+   |\n+LL |     components: PtrComponents<T>,\n+   |                 ^^^^^^^^^^^^^^^^ within `PtrComponents<T>`, the trait `Pointee` is not implemented for `T`\n+   |\n+note: required because it appears within the type `PtrComponents<T>`\n+  --> $DIR/issue-81199.rs:10:8\n+   |\n+LL | struct PtrComponents<T: Pointee + ?Sized> {\n+   |        ^^^^^^^^^^^^^\n+   = note: no field of a union may have a dynamically sized type\n+   = help: change the field's type to have a statically known size\n+help: consider further restricting this bound\n+   |\n+LL | union PtrRepr<T: ?Sized + Pointee> {\n+   |                         +++++++++\n+help: borrowed types always have a statically known size\n+   |\n+LL |     components: &PtrComponents<T>,\n+   |                 +\n+help: the `Box` type always has a statically known size and allocates its contents in the heap\n+   |\n+LL |     components: Box<PtrComponents<T>>,\n+   |                 ++++                +\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}]}