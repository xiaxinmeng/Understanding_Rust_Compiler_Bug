{"sha": "7b7ddfa55da889b41e90243ac59a04eed832a71e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiN2RkZmE1NWRhODg5YjQxZTkwMjQzYWM1OWEwNGVlZDgzMmE3MWU=", "commit": {"author": {"name": "Sebastian Andersson", "email": "sebastian@bittr.nu", "date": "2020-10-09T18:23:03Z"}, "committer": {"name": "Sebastian Andersson", "email": "sebastian@bittr.nu", "date": "2020-10-09T18:23:03Z"}, "message": "Preserve raw strs for: format!(s) to s.to_string() lint\n\nIe:\n|     let s = format!(r#\"\"hello\"\"#);\n|             ^^^^^^^^^^^^^^^^^^^^^ help: consider using `.to_string()`: `r#\"\"hello\"\"#.to_string()`", "tree": {"sha": "769d11a94ae4790f63c261fe172b6aaf813276ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/769d11a94ae4790f63c261fe172b6aaf813276ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b7ddfa55da889b41e90243ac59a04eed832a71e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b7ddfa55da889b41e90243ac59a04eed832a71e", "html_url": "https://github.com/rust-lang/rust/commit/7b7ddfa55da889b41e90243ac59a04eed832a71e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b7ddfa55da889b41e90243ac59a04eed832a71e/comments", "author": {"login": "bofh69", "id": 1444315, "node_id": "MDQ6VXNlcjE0NDQzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1444315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bofh69", "html_url": "https://github.com/bofh69", "followers_url": "https://api.github.com/users/bofh69/followers", "following_url": "https://api.github.com/users/bofh69/following{/other_user}", "gists_url": "https://api.github.com/users/bofh69/gists{/gist_id}", "starred_url": "https://api.github.com/users/bofh69/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bofh69/subscriptions", "organizations_url": "https://api.github.com/users/bofh69/orgs", "repos_url": "https://api.github.com/users/bofh69/repos", "events_url": "https://api.github.com/users/bofh69/events{/privacy}", "received_events_url": "https://api.github.com/users/bofh69/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bofh69", "id": 1444315, "node_id": "MDQ6VXNlcjE0NDQzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1444315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bofh69", "html_url": "https://github.com/bofh69", "followers_url": "https://api.github.com/users/bofh69/followers", "following_url": "https://api.github.com/users/bofh69/following{/other_user}", "gists_url": "https://api.github.com/users/bofh69/gists{/gist_id}", "starred_url": "https://api.github.com/users/bofh69/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bofh69/subscriptions", "organizations_url": "https://api.github.com/users/bofh69/orgs", "repos_url": "https://api.github.com/users/bofh69/repos", "events_url": "https://api.github.com/users/bofh69/events{/privacy}", "received_events_url": "https://api.github.com/users/bofh69/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fcf22d90bb9087f03e60c03ccccdc2f95668bf88", "url": "https://api.github.com/repos/rust-lang/rust/commits/fcf22d90bb9087f03e60c03ccccdc2f95668bf88", "html_url": "https://github.com/rust-lang/rust/commit/fcf22d90bb9087f03e60c03ccccdc2f95668bf88"}], "stats": {"total": 19, "additions": 15, "deletions": 4}, "files": [{"sha": "26da058598e4ff996ff872cc16e22e7fbdc48b77", "filename": "clippy_lints/src/format.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7b7ddfa55da889b41e90243ac59a04eed832a71e/clippy_lints%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b7ddfa55da889b41e90243ac59a04eed832a71e/clippy_lints%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fformat.rs?ref=7b7ddfa55da889b41e90243ac59a04eed832a71e", "patch": "@@ -1,6 +1,6 @@\n use crate::utils::paths;\n use crate::utils::{\n-    is_expn_of, is_type_diagnostic_item, last_path_segment, match_def_path, match_function_call, snippet,\n+    is_expn_of, is_type_diagnostic_item, last_path_segment, match_def_path, match_function_call, snippet, snippet_opt,\n     span_lint_and_then,\n };\n use if_chain::if_chain;\n@@ -132,7 +132,11 @@ fn on_new_v1<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) -> Option<Strin\n         then {\n             // `format!(\"foo\")` expansion contains `match () { () => [], }`\n             if tup.is_empty() {\n-                return Some(format!(\"{:?}.to_string()\", s.as_str()));\n+                if let Some(s_src) = snippet_opt(cx, lit.span) {\n+                    // Simulate macro expansion, converting {{ and }} to { and }.\n+                    let s_expand = s_src.replace(\"{{\", \"{\").replace(\"}}\", \"}\");\n+                    return Some(format!(\"{}.to_string()\", s_expand))\n+                }\n             } else if s.as_str().is_empty() {\n                 return on_argumentv1_new(cx, &tup[0], arms);\n             }"}, {"sha": "740a22a07d747c5dc409fea811cf27afb96e5468", "filename": "tests/ui/format.fixed", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7b7ddfa55da889b41e90243ac59a04eed832a71e/tests%2Fui%2Fformat.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/7b7ddfa55da889b41e90243ac59a04eed832a71e/tests%2Fui%2Fformat.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fformat.fixed?ref=7b7ddfa55da889b41e90243ac59a04eed832a71e", "patch": "@@ -13,7 +13,8 @@ fn main() {\n     \"foo\".to_string();\n     \"{}\".to_string();\n     \"{} abc {}\".to_string();\n-    \"foo {}\\n\\\" bar\".to_string();\n+    r##\"foo {}\n+\" bar\"##.to_string();\n \n     \"foo\".to_string();\n     format!(\"{:?}\", \"foo\"); // Don't warn about `Debug`."}, {"sha": "96df7f37f779232dd03fc305b86845381317ef69", "filename": "tests/ui/format.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7b7ddfa55da889b41e90243ac59a04eed832a71e/tests%2Fui%2Fformat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7b7ddfa55da889b41e90243ac59a04eed832a71e/tests%2Fui%2Fformat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fformat.stderr?ref=7b7ddfa55da889b41e90243ac59a04eed832a71e", "patch": "@@ -25,7 +25,13 @@ LL | /     format!(\n LL | |         r##\"foo {{}}\n LL | | \" bar\"##\n LL | |     );\n-   | |______^ help: consider using `.to_string()`: `\"foo {}/n/\" bar\".to_string();`\n+   | |______^\n+   |\n+help: consider using `.to_string()`\n+   |\n+LL |     r##\"foo {}\n+LL | \" bar\"##.to_string();\n+   |\n \n error: useless use of `format!`\n   --> $DIR/format.rs:21:5"}]}