{"sha": "e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "node_id": "C_kwDOAAsO6NoAKGU5ZjE0YzUwNWY0YTg3ZTY3YmYzZTJmMGM3NDNhNWUyNTExOWIzNjc", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-01-24T10:26:07Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-01-24T10:44:58Z"}, "message": "Remove `TypeWalk` and use `TypeFlags` instead", "tree": {"sha": "2960ca6076bc91f8bd5f78133bce68fecc4f0707", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2960ca6076bc91f8bd5f78133bce68fecc4f0707"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmPPtqoACgkQ4laYqTBY\nYXE1fw/+Iq3f+w9U+p0mzda/W10OgpNrZxK1jcmRICsj711FOAEElc5h8D7bKYSh\nLDxVEigZ/NVWfEPGdjAGuCLSH19LdP4XtRa2CBaUzteSWfTYuGt8uB1E8ACJcJZg\nc3+8Pq/Rq/FctW3yp9tqGxj1IUoUgi0/AVn3qH2dNu8UsepxQVdHz+kFeN6ZC9zY\nOcUfyBTxiFQMtlp6uwiUJB1V9Mdvk5+tpn3+cOfKT5nAC5iEjH24Lf/GDjcHiZPa\nE+9nZUp0KE8+OQvNl3jk7yxxioz654rUKP32Vu8lngWJWqHuG7fKGzl4SXerL7kN\nFp0VcOw7EkepSQil9tLLZ2wMRFdXwpp02pJFtB4nLDUeENXIgb35STZSrEohf+Ph\nWt6ten+aO3RY5prVuo61gcjDuTwxeVZNFg/mn3KLvK+9QtA5p23txWQS0W+hY7Hk\nny80eSTTGZ1XmqMiiQmRPRKeF2GS8YtlYFt2O9rps7CTJdSjCXEG8CEvWu1bfyfe\nOrUTpmkKummP9RJjNDFNZQcpkblZxQ21j1dYk+MWs9SICCpaperZUt9yYU6ZA/b6\nfMJRbcOs+UD5TNHrW0KgyjsJYrb275ozEIP7WAKFTVkvRgKHHdpga5SZutmu9lNQ\nvf9R32npYGeHBqg76rmoFvEesgLZejdU9gpIBrJOaHriF84Xnak=\n=z/nk\n-----END PGP SIGNATURE-----", "payload": "tree 2960ca6076bc91f8bd5f78133bce68fecc4f0707\nparent c552e5a55f13b2f08d506bb46fb74dbc11702d0d\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1674555967 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1674557098 +0900\n\nRemove `TypeWalk` and use `TypeFlags` instead\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "html_url": "https://github.com/rust-lang/rust/commit/e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c552e5a55f13b2f08d506bb46fb74dbc11702d0d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c552e5a55f13b2f08d506bb46fb74dbc11702d0d", "html_url": "https://github.com/rust-lang/rust/commit/c552e5a55f13b2f08d506bb46fb74dbc11702d0d"}], "stats": {"total": 167, "additions": 8, "deletions": 159}, "files": [{"sha": "a1182445ede58a75f739c4b55349d0dbab8394e3", "filename": "crates/hir-ty/src/lib.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/crates%2Fhir-ty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/crates%2Fhir-ty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Flib.rs?ref=e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "patch": "@@ -20,7 +20,6 @@ mod lower;\n mod mapping;\n mod tls;\n mod utils;\n-mod walk;\n pub mod db;\n pub mod diagnostics;\n pub mod display;\n@@ -71,7 +70,6 @@ pub use mapping::{\n };\n pub use traits::TraitEnvironment;\n pub use utils::{all_super_traits, is_fn_unsafe_to_call};\n-pub use walk::TypeWalk;\n \n pub use chalk_ir::{\n     cast::Cast, AdtId, BoundVar, DebruijnIndex, Mutability, Safety, Scalar, TyVariableKind,\n@@ -107,6 +105,7 @@ pub type GenericArgData = chalk_ir::GenericArgData<Interner>;\n \n pub type Ty = chalk_ir::Ty<Interner>;\n pub type TyKind = chalk_ir::TyKind<Interner>;\n+pub type TypeFlags = chalk_ir::TypeFlags;\n pub type DynTy = chalk_ir::DynTy<Interner>;\n pub type FnPointer = chalk_ir::FnPointer<Interner>;\n // pub type FnSubst = chalk_ir::FnSubst<Interner>;"}, {"sha": "c476894552e6c879e2a1d18841ad5e594bf2bac3", "filename": "crates/hir-ty/src/walk.rs", "status": "removed", "additions": 0, "deletions": 147, "changes": 147, "blob_url": "https://github.com/rust-lang/rust/blob/c552e5a55f13b2f08d506bb46fb74dbc11702d0d/crates%2Fhir-ty%2Fsrc%2Fwalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c552e5a55f13b2f08d506bb46fb74dbc11702d0d/crates%2Fhir-ty%2Fsrc%2Fwalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fwalk.rs?ref=c552e5a55f13b2f08d506bb46fb74dbc11702d0d", "patch": "@@ -1,147 +0,0 @@\n-//! The `TypeWalk` trait (probably to be replaced by Chalk's `Fold` and\n-//! `Visit`).\n-\n-use chalk_ir::interner::HasInterner;\n-\n-use crate::{\n-    AliasEq, AliasTy, Binders, CallableSig, FnSubst, GenericArg, GenericArgData, Interner,\n-    OpaqueTy, ProjectionTy, Substitution, TraitRef, Ty, TyKind, WhereClause,\n-};\n-\n-/// This allows walking structures that contain types to do something with those\n-/// types, similar to Chalk's `Fold` trait.\n-pub trait TypeWalk {\n-    fn walk(&self, f: &mut impl FnMut(&Ty));\n-}\n-\n-impl TypeWalk for Ty {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        match self.kind(Interner) {\n-            TyKind::Alias(AliasTy::Projection(p_ty)) => {\n-                for t in p_ty.substitution.iter(Interner) {\n-                    t.walk(f);\n-                }\n-            }\n-            TyKind::Alias(AliasTy::Opaque(o_ty)) => {\n-                for t in o_ty.substitution.iter(Interner) {\n-                    t.walk(f);\n-                }\n-            }\n-            TyKind::Dyn(dyn_ty) => {\n-                for p in dyn_ty.bounds.skip_binders().interned().iter() {\n-                    p.walk(f);\n-                }\n-            }\n-            TyKind::Slice(ty)\n-            | TyKind::Array(ty, _)\n-            | TyKind::Ref(_, _, ty)\n-            | TyKind::Raw(_, ty) => {\n-                ty.walk(f);\n-            }\n-            TyKind::Function(fn_pointer) => {\n-                fn_pointer.substitution.0.walk(f);\n-            }\n-            TyKind::Adt(_, substs)\n-            | TyKind::FnDef(_, substs)\n-            | TyKind::Tuple(_, substs)\n-            | TyKind::OpaqueType(_, substs)\n-            | TyKind::AssociatedType(_, substs)\n-            | TyKind::Closure(.., substs) => {\n-                substs.walk(f);\n-            }\n-            _ => {}\n-        }\n-        f(self);\n-    }\n-}\n-\n-impl<T: TypeWalk> TypeWalk for Vec<T> {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        for t in self {\n-            t.walk(f);\n-        }\n-    }\n-}\n-\n-impl TypeWalk for OpaqueTy {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        self.substitution.walk(f);\n-    }\n-}\n-\n-impl TypeWalk for ProjectionTy {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        self.substitution.walk(f);\n-    }\n-}\n-\n-impl TypeWalk for AliasTy {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        match self {\n-            AliasTy::Projection(it) => it.walk(f),\n-            AliasTy::Opaque(it) => it.walk(f),\n-        }\n-    }\n-}\n-\n-impl TypeWalk for GenericArg {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        if let GenericArgData::Ty(ty) = &self.interned() {\n-            ty.walk(f);\n-        }\n-    }\n-}\n-\n-impl TypeWalk for Substitution {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        for t in self.iter(Interner) {\n-            t.walk(f);\n-        }\n-    }\n-}\n-\n-impl<T: TypeWalk + HasInterner<Interner = Interner>> TypeWalk for Binders<T> {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        self.skip_binders().walk(f);\n-    }\n-}\n-\n-impl TypeWalk for TraitRef {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        self.substitution.walk(f);\n-    }\n-}\n-\n-impl TypeWalk for WhereClause {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        match self {\n-            WhereClause::Implemented(trait_ref) => trait_ref.walk(f),\n-            WhereClause::AliasEq(alias_eq) => alias_eq.walk(f),\n-            _ => {}\n-        }\n-    }\n-}\n-\n-impl TypeWalk for CallableSig {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        for t in self.params_and_return.iter() {\n-            t.walk(f);\n-        }\n-    }\n-}\n-\n-impl TypeWalk for AliasEq {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        self.ty.walk(f);\n-        match &self.alias {\n-            AliasTy::Projection(projection_ty) => projection_ty.walk(f),\n-            AliasTy::Opaque(opaque) => opaque.walk(f),\n-        }\n-    }\n-}\n-\n-impl TypeWalk for FnSubst<Interner> {\n-    fn walk(&self, f: &mut impl FnMut(&Ty)) {\n-        self.0.walk(f)\n-    }\n-}"}, {"sha": "4415bef4bb1c7bcc9dea7df8ad17d4adb39bf451", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "patch": "@@ -3168,6 +3168,8 @@ impl Type {\n     }\n \n     pub fn contains_unknown(&self) -> bool {\n+        // FIXME: When we get rid of `ConstScalar::Unknown`, we can just look at precomputed\n+        // `TypeFlags` in `TyData`.\n         return go(&self.ty);\n \n         fn go(ty: &Ty) -> bool {\n@@ -3482,10 +3484,9 @@ impl Type {\n         Type { env: self.env.clone(), ty }\n     }\n \n+    /// Visits every type, including generic arguments, in this type. `cb` is called with type\n+    /// itself first, and then with its generic arguments.\n     pub fn walk(&self, db: &dyn HirDatabase, mut cb: impl FnMut(Type)) {\n-        // TypeWalk::walk for a Ty at first visits parameters and only after that the Ty itself.\n-        // We need a different order here.\n-\n         fn walk_substs(\n             db: &dyn HirDatabase,\n             type_: &Type,"}, {"sha": "4b91433f63a68d88c324c057759846bc572301ef", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9f14c505f4a87e67bf3e2f0c743a5e25119b367/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=e9f14c505f4a87e67bf3e2f0c743a5e25119b367", "patch": "@@ -15,7 +15,7 @@ use hir_def::{\n     expr::ExprId,\n     FunctionId,\n };\n-use hir_ty::{TyExt, TypeWalk};\n+use hir_ty::{Interner, TyExt, TypeFlags};\n use ide::{Analysis, AnalysisHost, LineCol, RootDatabase};\n use ide_db::base_db::{\n     salsa::{self, debug::DebugQueryTable, ParallelDatabase},\n@@ -280,12 +280,8 @@ impl flags::AnalysisStats {\n                     }\n                     true\n                 } else {\n-                    let mut is_partially_unknown = false;\n-                    ty.walk(&mut |ty| {\n-                        if ty.is_unknown() {\n-                            is_partially_unknown = true;\n-                        }\n-                    });\n+                    let is_partially_unknown =\n+                        ty.data(Interner).flags.contains(TypeFlags::HAS_ERROR);\n                     if is_partially_unknown {\n                         num_exprs_partially_unknown += 1;\n                     }"}]}