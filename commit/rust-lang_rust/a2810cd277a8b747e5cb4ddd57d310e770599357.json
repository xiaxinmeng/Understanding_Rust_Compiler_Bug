{"sha": "a2810cd277a8b747e5cb4ddd57d310e770599357", "node_id": "C_kwDOAAsO6NoAKGEyODEwY2QyNzdhOGI3NDdlNWNiNGRkZDU3ZDMxMGU3NzA1OTkzNTc", "commit": {"author": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-06-25T22:00:47Z"}, "committer": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-07-06T20:01:40Z"}, "message": "Fix `#[expect]` and `#[allow]` for `clippy::duplicate_mod`", "tree": {"sha": "46d97f343147373bc0d0b873c21a3a66a43361cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/46d97f343147373bc0d0b873c21a3a66a43361cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2810cd277a8b747e5cb4ddd57d310e770599357", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEwgBEOx3xlHwII7PG9cWdDmaeUwIFAmLF6iQACgkQ9cWdDmae\nUwKdzw//XM3SrCd9eI9RRfNYW8Bj+A2ijWZsVcyM37uIjGYzrEOK62ZjlbxndE3g\n7y2hoNDsxtxdwYXwSLIxM9/WMWM5HYk3e5dA87xE26Kxas9OCWugnlYOVimbrJjQ\n2cAtONKmWIKuPRV278NekfNIo8ffn4s1lijRLL0Vb0fXxFn1ZL9jL6OHkHsu9aX1\n+q3fqzEAECzTBSepFpBh1hjLL7ZlkExXhbXYrp98BEwRf6Iaw0HQqiyy0EdWumkf\n5g+AHUBJCrf0/YBlnT0++rrBxlDE3tcvhih6c3us1MJNk6d9T8y9k5SDtwMDSBhX\nlEUNYT6IZf/GoddpvASyeOS2it5LsJXbK2jPJEHbUCRP7LuU9iFCd2c6bNU2jnbw\n1KT5dtLgWmK35tZv68hxxLpQNfl/HoKEFx7NmnlKVLPhK51Kn3FYURbzLdePhzxw\nt1dSf9r0OoOPZve4/+c5EPkOyabPGIQfHsIUijBucEC9pfG25Pva4laKR+bvsESC\nJ2cwyASjA4pG6AVtKn4zTmhDH63mePtMVIIN0IHIV9Pg7RUq01naNTLLBh6vQ8oL\nsr5US/nCztGioUOjUanZbbnRqd0XXklB+S6Dp6W0t9qABW+J3Oc220mcbW5AAytj\n2bTu5c1SRtl3DUraxLbVaawCuzpUnzN7l2MNlNk4ZpIy4c3Rwz4=\n=/452\n-----END PGP SIGNATURE-----", "payload": "tree 46d97f343147373bc0d0b873c21a3a66a43361cf\nparent c8b4873cf90c542efbda7a27a8ad6ebdb099275e\nauthor xFrednet <xFrednet@gmail.com> 1656194447 +0200\ncommitter xFrednet <xFrednet@gmail.com> 1657137700 +0200\n\nFix `#[expect]` and `#[allow]` for `clippy::duplicate_mod`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2810cd277a8b747e5cb4ddd57d310e770599357", "html_url": "https://github.com/rust-lang/rust/commit/a2810cd277a8b747e5cb4ddd57d310e770599357", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2810cd277a8b747e5cb4ddd57d310e770599357/comments", "author": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8b4873cf90c542efbda7a27a8ad6ebdb099275e", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8b4873cf90c542efbda7a27a8ad6ebdb099275e", "html_url": "https://github.com/rust-lang/rust/commit/c8b4873cf90c542efbda7a27a8ad6ebdb099275e"}], "stats": {"total": 54, "additions": 48, "deletions": 6}, "files": [{"sha": "4f49bb879f5035c9b66e07a354089d681046e5e9", "filename": "src/tools/clippy/clippy_lints/src/duplicate_mod.rs", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fduplicate_mod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fduplicate_mod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fduplicate_mod.rs?ref=a2810cd277a8b747e5cb4ddd57d310e770599357", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::span_lint_and_help;\n use rustc_ast::ast::{Crate, Inline, Item, ItemKind, ModKind};\n use rustc_errors::MultiSpan;\n-use rustc_lint::{EarlyContext, EarlyLintPass, LintContext};\n+use rustc_lint::{EarlyContext, EarlyLintPass, LintContext, Level};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::{FileName, Span};\n use std::collections::BTreeMap;\n@@ -49,6 +49,7 @@ declare_clippy_lint! {\n struct Modules {\n     local_path: PathBuf,\n     spans: Vec<Span>,\n+    lint_levels: Vec<Level>,\n }\n \n #[derive(Default)]\n@@ -70,13 +71,30 @@ impl EarlyLintPass for DuplicateMod {\n             let modules = self.modules.entry(absolute_path).or_insert(Modules {\n                 local_path,\n                 spans: Vec::new(),\n+                lint_levels: Vec::new(),\n             });\n             modules.spans.push(item.span_with_attributes());\n+            modules.lint_levels.push(cx.get_lint_level(DUPLICATE_MOD));\n         }\n     }\n \n     fn check_crate_post(&mut self, cx: &EarlyContext<'_>, _: &Crate) {\n-        for Modules { local_path, spans } in self.modules.values() {\n+        for Modules { local_path, spans, lint_levels } in self.modules.values() {\n+            if spans.len() < 2 {\n+                continue;\n+            }\n+\n+            // At this point the lint would be emitted\n+            assert_eq!(spans.len(), lint_levels.len());\n+            let spans: Vec<_> = spans.into_iter().zip(lint_levels).filter_map(|(span, lvl)|{\n+                if let Some(id) = lvl.get_expectation_id() {\n+                    cx.fulfill_expectation(id);\n+                }\n+\n+                (!matches!(lvl, Level::Allow | Level::Expect(_))).then_some(*span)\n+            })\n+            .collect();\n+\n             if spans.len() < 2 {\n                 continue;\n             }"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "src/tools/clippy/tests/ui-cargo/duplicate_mod/fail/src/d.rs", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fd.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fd.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fd.rs?ref=a2810cd277a8b747e5cb4ddd57d310e770599357"}, {"sha": "99ca538b6e4a58bcecd21c2ea8bc7dc04037a9d5", "filename": "src/tools/clippy/tests/ui-cargo/duplicate_mod/fail/src/main.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fmain.rs?ref=a2810cd277a8b747e5cb4ddd57d310e770599357", "patch": "@@ -1,3 +1,5 @@\n+#[feature(lint_reasons)]\n+\n mod a;\n \n mod b;\n@@ -13,4 +15,15 @@ mod c3;\n mod from_other_module;\n mod other_module;\n \n+mod d;\n+#[path = \"d.rs\"]\n+mod d2;\n+#[path = \"d.rs\"]\n+#[expect(clippy::duplicate_mod)]\n+mod d3;\n+#[path = \"d.rs\"]\n+#[allow(clippy::duplicate_mod)]\n+mod d4;\n+\n+\n fn main() {}"}, {"sha": "61df1ad5d501aad6d95ea089f282af0e639d7ce0", "filename": "src/tools/clippy/tests/ui-cargo/duplicate_mod/fail/src/main.stderr", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fmain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a2810cd277a8b747e5cb4ddd57d310e770599357/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fmain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui-cargo%2Fduplicate_mod%2Ffail%2Fsrc%2Fmain.stderr?ref=a2810cd277a8b747e5cb4ddd57d310e770599357", "patch": "@@ -1,5 +1,5 @@\n error: file is loaded as a module multiple times: `$DIR/b.rs`\n-  --> $DIR/main.rs:3:1\n+  --> $DIR/main.rs:5:1\n    |\n LL |   mod b;\n    |   ^^^^^^ first loaded here\n@@ -11,7 +11,7 @@ LL | | mod b2;\n    = help: replace all but one `mod` item with `use` items\n \n error: file is loaded as a module multiple times: `$DIR/c.rs`\n-  --> $DIR/main.rs:7:1\n+  --> $DIR/main.rs:9:1\n    |\n LL |   mod c;\n    |   ^^^^^^ first loaded here\n@@ -25,7 +25,7 @@ LL | | mod c3;\n    = help: replace all but one `mod` item with `use` items\n \n error: file is loaded as a module multiple times: `$DIR/from_other_module.rs`\n-  --> $DIR/main.rs:13:1\n+  --> $DIR/main.rs:15:1\n    |\n LL |   mod from_other_module;\n    |   ^^^^^^^^^^^^^^^^^^^^^^ first loaded here\n@@ -38,5 +38,16 @@ LL | | mod m;\n    |\n    = help: replace all but one `mod` item with `use` items\n \n-error: aborting due to 3 previous errors\n+error: file is loaded as a module multiple times: `$DIR/b.rs`\n+  --> $DIR/main.rs:18:1\n+   |\n+LL |   mod d;\n+   |   ^^^^^^ first loaded here\n+LL | / #[path = \"d.rs\"]\n+LL | | mod d2;\n+   | |_______^ loaded again here\n+   |\n+   = help: replace all but one `mod` item with `use` items\n+\n+error: aborting due to 4 previous errors\n "}]}