{"sha": "1e1e5b8d98750a162335f64ec3c792ce80c9866c", "node_id": "C_kwDOAAsO6NoAKDFlMWU1YjhkOTg3NTBhMTYyMzM1ZjY0ZWMzYzc5MmNlODBjOTg2NmM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-06T14:03:59Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-06T14:03:59Z"}, "message": "Auto merge of #103861 - compiler-errors:codegen-select-in-vtable-slot, r=nagisa\n\nUse `codegen_select` in `vtable_trait_upcasting_coercion_new_vptr_slot`\n\nA super tiny clean up", "tree": {"sha": "7165916a79824831a6d723fa63e10fbffa87fe06", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7165916a79824831a6d723fa63e10fbffa87fe06"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e1e5b8d98750a162335f64ec3c792ce80c9866c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e1e5b8d98750a162335f64ec3c792ce80c9866c", "html_url": "https://github.com/rust-lang/rust/commit/1e1e5b8d98750a162335f64ec3c792ce80c9866c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e1e5b8d98750a162335f64ec3c792ce80c9866c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "534ddc6166a9031b0c269544929d68f2539ea7a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/534ddc6166a9031b0c269544929d68f2539ea7a0", "html_url": "https://github.com/rust-lang/rust/commit/534ddc6166a9031b0c269544929d68f2539ea7a0"}, {"sha": "20bb56ebfd4a9d8b21de8f8e75e062ae48d04810", "url": "https://api.github.com/repos/rust-lang/rust/commits/20bb56ebfd4a9d8b21de8f8e75e062ae48d04810", "html_url": "https://github.com/rust-lang/rust/commit/20bb56ebfd4a9d8b21de8f8e75e062ae48d04810"}], "stats": {"total": 24, "additions": 6, "deletions": 18}, "files": [{"sha": "a33534f5747fa11b941e71677016967ea9223868", "filename": "compiler/rustc_trait_selection/src/traits/mod.rs", "status": "modified", "additions": 6, "deletions": 18, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1e1e5b8d98750a162335f64ec3c792ce80c9866c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e1e5b8d98750a162335f64ec3c792ce80c9866c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs?ref=1e1e5b8d98750a162335f64ec3c792ce80c9866c", "patch": "@@ -900,25 +900,13 @@ pub fn vtable_trait_upcasting_coercion_new_vptr_slot<'tcx>(\n         def_id: unsize_trait_did,\n         substs: tcx.mk_substs_trait(source, &[target.into()]),\n     };\n-    let obligation = Obligation::new(\n-        ObligationCause::dummy(),\n-        ty::ParamEnv::reveal_all(),\n-        ty::Binder::dummy(ty::TraitPredicate {\n-            trait_ref,\n-            constness: ty::BoundConstness::NotConst,\n-            polarity: ty::ImplPolarity::Positive,\n-        }),\n-    );\n-\n-    let infcx = tcx.infer_ctxt().build();\n-    let mut selcx = SelectionContext::new(&infcx);\n-    let implsrc = selcx.select(&obligation).unwrap();\n \n-    let Some(ImplSource::TraitUpcasting(implsrc_traitcasting)) = implsrc else {\n-        bug!();\n-    };\n-\n-    implsrc_traitcasting.vtable_vptr_slot\n+    match tcx.codegen_select_candidate((ty::ParamEnv::reveal_all(), ty::Binder::dummy(trait_ref))) {\n+        Ok(ImplSource::TraitUpcasting(implsrc_traitcasting)) => {\n+            implsrc_traitcasting.vtable_vptr_slot\n+        }\n+        otherwise => bug!(\"expected TraitUpcasting candidate, got {otherwise:?}\"),\n+    }\n }\n \n pub fn provide(providers: &mut ty::query::Providers) {"}]}