{"sha": "35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1ZmU4YzkyZTliOGU5ZDNmM2I0NzQ1YTZkZWFiNzFkNzlhZWU0ZTM=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-12-14T14:10:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-12-14T14:10:07Z"}, "message": "Rollup merge of #56658 - Xanewok:non-panicking-file-parser, r=petrochenkov\n\nAdd non-panicking `maybe_new_parser_from_file` variant\n\nAdd (seemingly?) missing `maybe_new_parser_from_file` constructor variant.\n\nDisclaimer: I'm not certain this is the correct approach - just found out we don't have this when working on a Rustfmt PR to catch/prevent more Rust parser panics: https://github.com/rust-lang/rustfmt/pull/3240 and tried to make it work somehow.", "tree": {"sha": "3a3e3f5da121a9886bfd11328ce5f0be26322d38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a3e3f5da121a9886bfd11328ce5f0be26322d38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcE7m/CRBK7hj4Ov3rIwAAdHIIAED906lcpqIwGXN3LhxzZRrD\n6i9/qhQJMXx5sf2ThTgyAz0QUkcXQl4K4ZUaqfpyvOsitO0KxZp73pMLOu2jpEx5\ndxr4wtrZ7ULekq2A7poTKqRHVlVM37VZCGB1EKpL3pwh5TtrNrgMObQhzxEsVUwe\nVpqoquQZkGLQUAmkCJFA2gSTrdy+b0Luss72W/AW8bgUSpav0+1L/X3iyfP3JcBl\no46SBCxpU35qy8CDGy5fI289H5A55g0v6PYC2Mn6UN/qjQBbOCpkaZnR4i+OI+3o\nbUh2W5zz8N3ZbgKY5Oyi/2t7a892l4V9SzZbw2jE43pGdmh8EQQ+qF8r0SGTUnU=\n=ZHgb\n-----END PGP SIGNATURE-----\n", "payload": "tree 3a3e3f5da121a9886bfd11328ce5f0be26322d38\nparent 795f18efb8cfe6b72e23b629e0cf4b1e6d9078d8\nparent 85b50d03120cf7bd1beb472a78ce9427c0d8d06e\nauthor kennytm <kennytm@gmail.com> 1544796607 +0800\ncommitter GitHub <noreply@github.com> 1544796607 +0800\n\nRollup merge of #56658 - Xanewok:non-panicking-file-parser, r=petrochenkov\n\nAdd non-panicking `maybe_new_parser_from_file` variant\n\nAdd (seemingly?) missing `maybe_new_parser_from_file` constructor variant.\n\nDisclaimer: I'm not certain this is the correct approach - just found out we don't have this when working on a Rustfmt PR to catch/prevent more Rust parser panics: https://github.com/rust-lang/rustfmt/pull/3240 and tried to make it work somehow.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3", "html_url": "https://github.com/rust-lang/rust/commit/35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "795f18efb8cfe6b72e23b629e0cf4b1e6d9078d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/795f18efb8cfe6b72e23b629e0cf4b1e6d9078d8", "html_url": "https://github.com/rust-lang/rust/commit/795f18efb8cfe6b72e23b629e0cf4b1e6d9078d8"}, {"sha": "85b50d03120cf7bd1beb472a78ce9427c0d8d06e", "url": "https://api.github.com/repos/rust-lang/rust/commits/85b50d03120cf7bd1beb472a78ce9427c0d8d06e", "html_url": "https://github.com/rust-lang/rust/commit/85b50d03120cf7bd1beb472a78ce9427c0d8d06e"}], "stats": {"total": 37, "additions": 29, "deletions": 8}, "files": [{"sha": "10c451e1f81994463e049b1919ab510c80b32c2b", "filename": "src/libsyntax/parse/mod.rs", "status": "modified", "additions": 29, "deletions": 8, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3/src%2Flibsyntax%2Fparse%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3/src%2Flibsyntax%2Fparse%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fmod.rs?ref=35fe8c92e9b8e9d3f3b4745a6deab71d79aee4e3", "patch": "@@ -15,7 +15,7 @@ use ast::{self, CrateConfig, NodeId};\n use early_buffered_lints::{BufferedEarlyLint, BufferedEarlyLintId};\n use source_map::{SourceMap, FilePathMapping};\n use syntax_pos::{Span, SourceFile, FileName, MultiSpan};\n-use errors::{Handler, ColorConfig, Diagnostic, DiagnosticBuilder};\n+use errors::{FatalError, Level, Handler, ColorConfig, Diagnostic, DiagnosticBuilder};\n use feature_gate::UnstableFeatures;\n use parse::parser::Parser;\n use ptr::P;\n@@ -192,6 +192,14 @@ pub fn new_parser_from_file<'a>(sess: &'a ParseSess, path: &Path) -> Parser<'a>\n     source_file_to_parser(sess, file_to_source_file(sess, path, None))\n }\n \n+/// Create a new parser, returning buffered diagnostics if the file doesn't\n+/// exist or from lexing the initial token stream.\n+pub fn maybe_new_parser_from_file<'a>(sess: &'a ParseSess, path: &Path)\n+    -> Result<Parser<'a>, Vec<Diagnostic>> {\n+    let file = try_file_to_source_file(sess, path, None).map_err(|db| vec![db])?;\n+    maybe_source_file_to_parser(sess, file)\n+}\n+\n /// Given a session, a crate config, a path, and a span, add\n /// the file at the given path to the source_map, and return a parser.\n /// On an error, use the given span as the source of the problem.\n@@ -236,18 +244,31 @@ pub fn new_parser_from_tts(sess: &ParseSess, tts: Vec<TokenTree>) -> Parser {\n \n // base abstractions\n \n+/// Given a session and a path and an optional span (for error reporting),\n+/// add the path to the session's source_map and return the new source_file or\n+/// error when a file can't be read.\n+fn try_file_to_source_file(sess: &ParseSess, path: &Path, spanopt: Option<Span>)\n+                   -> Result<Lrc<SourceFile>, Diagnostic> {\n+    sess.source_map().load_file(path)\n+    .map_err(|e| {\n+        let msg = format!(\"couldn't read {}: {}\", path.display(), e);\n+        let mut diag = Diagnostic::new(Level::Fatal, &msg);\n+        if let Some(sp) = spanopt {\n+            diag.set_span(sp);\n+        }\n+        diag\n+    })\n+}\n+\n /// Given a session and a path and an optional span (for error reporting),\n /// add the path to the session's source_map and return the new source_file.\n fn file_to_source_file(sess: &ParseSess, path: &Path, spanopt: Option<Span>)\n                    -> Lrc<SourceFile> {\n-    match sess.source_map().load_file(path) {\n+    match try_file_to_source_file(sess, path, spanopt) {\n         Ok(source_file) => source_file,\n-        Err(e) => {\n-            let msg = format!(\"couldn't read {}: {}\", path.display(), e);\n-            match spanopt {\n-                Some(sp) => sess.span_diagnostic.span_fatal(sp, &msg).raise(),\n-                None => sess.span_diagnostic.fatal(&msg).raise()\n-            }\n+        Err(d) => {\n+            DiagnosticBuilder::new_diagnostic(&sess.span_diagnostic, d).emit();\n+            FatalError.raise();\n         }\n     }\n }"}]}