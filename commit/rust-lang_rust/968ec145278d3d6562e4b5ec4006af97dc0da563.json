{"sha": "968ec145278d3d6562e4b5ec4006af97dc0da563", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2OGVjMTQ1Mjc4ZDNkNjU2MmU0YjVlYzQwMDZhZjk3ZGMwZGE1NjM=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-06-26T02:56:29Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-06-26T02:56:29Z"}, "message": "Fix marking logic.", "tree": {"sha": "a2421d2a91a5d6b79d7e83d58d051d375c2b077a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a2421d2a91a5d6b79d7e83d58d051d375c2b077a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/968ec145278d3d6562e4b5ec4006af97dc0da563", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/968ec145278d3d6562e4b5ec4006af97dc0da563", "html_url": "https://github.com/rust-lang/rust/commit/968ec145278d3d6562e4b5ec4006af97dc0da563", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/968ec145278d3d6562e4b5ec4006af97dc0da563/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "34dc7053ebfd440648f49dc83d2538ab5e7ceda5", "url": "https://api.github.com/repos/rust-lang/rust/commits/34dc7053ebfd440648f49dc83d2538ab5e7ceda5", "html_url": "https://github.com/rust-lang/rust/commit/34dc7053ebfd440648f49dc83d2538ab5e7ceda5"}], "stats": {"total": 12, "additions": 7, "deletions": 5}, "files": [{"sha": "a8b74fcf44d66d4ace851a4733c909d2e771b8a4", "filename": "src/boot/me/trans.ml", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/968ec145278d3d6562e4b5ec4006af97dc0da563/src%2Fboot%2Fme%2Ftrans.ml", "raw_url": "https://github.com/rust-lang/rust/raw/968ec145278d3d6562e4b5ec4006af97dc0da563/src%2Fboot%2Fme%2Ftrans.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Ftrans.ml?ref=968ec145278d3d6562e4b5ec4006af97dc0da563", "patch": "@@ -2639,13 +2639,15 @@ let trans_visitor\n                 (* if this has been marked already, jump to exit.*)\n                 note_gc_step slot \"mark GC slot: check for mark:\";\n                 emit (Il.binary Il.AND tmp (Il.Cell gc_word) one);\n-                let already_marked_jump = mark () in\n-                  emit (Il.jmp Il.JZ Il.CodeNone);\n+                trace_word cx.ctxt_sess.Session.sess_trace_gc tmp;\n+\n+                let already_marked_jump =\n+                  trans_compare Il.JNE (Il.Cell tmp) zero;\n+                in\n                   (* Set mark bit in allocation header. *)\n-                  note_gc_step slot \"mark GC slot: mark:\";\n                   emit (Il.binary Il.OR gc_word (Il.Cell gc_word) one);\n+                  note_gc_step slot \"mark GC slot: set mark\";\n                   (* Iterate over exterior slots marking outgoing links. *)\n-                  log cx \"slot rty: %s\" (cell_str cell);\n                   let (body_mem, _) =\n                     need_mem_cell\n                       (get_element_ptr (deref cell)\n@@ -2658,7 +2660,7 @@ let trans_visitor\n                       (get_mark_glue ty curr_iso)\n                       ty_params tmp;\n                     patch null_cell_jump;\n-                    patch already_marked_jump;\n+                    List.iter patch already_marked_jump;\n                     note_gc_step slot \"mark GC slot: done marking:\";\n \n         | MEM_interior when type_is_structured ty ->"}]}