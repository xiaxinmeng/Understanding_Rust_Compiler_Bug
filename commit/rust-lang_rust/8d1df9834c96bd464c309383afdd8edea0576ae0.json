{"sha": "8d1df9834c96bd464c309383afdd8edea0576ae0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkMWRmOTgzNGM5NmJkNDY0YzMwOTM4M2FmZGQ4ZWRlYTA1NzZhZTA=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-12-30T10:16:22Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-12-30T10:16:22Z"}, "message": "Merge #358\n\n358: Add support for formatting entire document with rustfmt r=matklad a=aleksanb\n\nAttempting to format a document when rustfmt isn't installed will result\r\nin an error being returned to the frontend. An alternative\r\nimplementation would be returning zero replacements.\r\n\r\nPart of https://github.com/rust-analyzer/rust-analyzer/issues/160.\n\nCo-authored-by: Aleksander Vognild Burkow <aleksanderburkow@gmail.com>", "tree": {"sha": "1836353cc58c9aeede832bb18872c37af312f377", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1836353cc58c9aeede832bb18872c37af312f377"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d1df9834c96bd464c309383afdd8edea0576ae0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d1df9834c96bd464c309383afdd8edea0576ae0", "html_url": "https://github.com/rust-lang/rust/commit/8d1df9834c96bd464c309383afdd8edea0576ae0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d1df9834c96bd464c309383afdd8edea0576ae0/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "75acc25c5a5df2ac0a8978be2972187ee974a754", "url": "https://api.github.com/repos/rust-lang/rust/commits/75acc25c5a5df2ac0a8978be2972187ee974a754", "html_url": "https://github.com/rust-lang/rust/commit/75acc25c5a5df2ac0a8978be2972187ee974a754"}, {"sha": "0cb270e75d9501dff9ac6633354ae12d9c0f4260", "url": "https://api.github.com/repos/rust-lang/rust/commits/0cb270e75d9501dff9ac6633354ae12d9c0f4260", "html_url": "https://github.com/rust-lang/rust/commit/0cb270e75d9501dff9ac6633354ae12d9c0f4260"}], "stats": {"total": 111, "additions": 107, "deletions": 4}, "files": [{"sha": "68158e41cbd71cd2159a7d3496937d266626d49f", "filename": ".gitignore", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitignore?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -4,3 +4,4 @@ crates/*/target\n .idea/*\n .vscode/*\n *.log\n+*.iml"}, {"sha": "8e962d35236b675a6bb0d999721b47e03f84d4a8", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -790,6 +790,7 @@ dependencies = [\n  \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"thread_worker 0.1.0\",\n  \"threadpool 1.7.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"tools 0.1.0\",\n  \"url_serde 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"walkdir 2.2.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]"}, {"sha": "bff2e00c9b317fa85fbe6b1b5ada65f87e6fc75a", "filename": "crates/ra_analysis/src/imp.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_analysis%2Fsrc%2Fimp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_analysis%2Fsrc%2Fimp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fimp.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -140,6 +140,9 @@ impl fmt::Debug for AnalysisImpl {\n }\n \n impl AnalysisImpl {\n+    pub fn file_text(&self, file_id: FileId) -> Arc<String> {\n+        self.db.file_text(file_id)\n+    }\n     pub fn file_syntax(&self, file_id: FileId) -> SourceFileNode {\n         self.db.source_file(file_id)\n     }"}, {"sha": "9f5e9f358b95be15143a2b2b8a4c771fef79def0", "filename": "crates/ra_analysis/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Flib.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -274,6 +274,9 @@ pub struct Analysis {\n }\n \n impl Analysis {\n+    pub fn file_text(&self, file_id: FileId) -> Arc<String> {\n+        self.imp.file_text(file_id)\n+    }\n     pub fn file_syntax(&self, file_id: FileId) -> SourceFileNode {\n         self.imp.file_syntax(file_id).clone()\n     }"}, {"sha": "f8f91e5e7e4be9ee3b2bf791275a531e9166e114", "filename": "crates/ra_lsp_server/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2FCargo.toml?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -33,6 +33,7 @@ ra_text_edit = { path = \"../ra_text_edit\" }\n ra_analysis = { path = \"../ra_analysis\" }\n gen_lsp_server = { path = \"../gen_lsp_server\" }\n ra_vfs = { path = \"../ra_vfs\" }\n+tools = { path = \"../tools\" }\n \n [dev-dependencies]\n tempdir = \"0.3.7\""}, {"sha": "8d508a3ba5316ab11a2ccda63da1312ab1717080", "filename": "crates/ra_lsp_server/src/caps.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -33,7 +33,7 @@ pub fn server_capabilities() -> ServerCapabilities {\n         workspace_symbol_provider: Some(true),\n         code_action_provider: Some(CodeActionProviderCapability::Simple(true)),\n         code_lens_provider: None,\n-        document_formatting_provider: None,\n+        document_formatting_provider: Some(true),\n         document_range_formatting_provider: None,\n         document_on_type_formatting_provider: Some(DocumentOnTypeFormattingOptions {\n             first_trigger_character: \"=\".to_string(),"}, {"sha": "97c1be7788fe971c83dabeee3c6415108aef4459", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -295,6 +295,7 @@ fn on_request(\n         .on::<req::PrepareRenameRequest>(handlers::handle_prepare_rename)?\n         .on::<req::Rename>(handlers::handle_rename)?\n         .on::<req::References>(handlers::handle_references)?\n+        .on::<req::Formatting>(handlers::handle_formatting)?\n         .finish();\n     match req {\n         Ok(id) => {"}, {"sha": "a2c12a4c194c15ac54ed14f60b9768be1b837365", "filename": "crates/ra_lsp_server/src/main_loop/handlers.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -6,13 +6,16 @@ use languageserver_types::{\n     DiagnosticSeverity, DocumentSymbol, Documentation, FoldingRange, FoldingRangeKind,\n     FoldingRangeParams, Location, MarkupContent, MarkupKind, MarkedString, Position,\n     PrepareRenameResponse, RenameParams, SymbolInformation, TextDocumentIdentifier, TextEdit,\n+    Range,\n     WorkspaceEdit, ParameterInformation, ParameterLabel, SignatureInformation, Hover, HoverContents,\n+    DocumentFormattingParams,\n };\n use ra_analysis::{FileId, FoldKind, Query, RunnableKind, FileRange, FilePosition, Severity};\n use ra_syntax::{TextUnit, text_utils::intersect};\n use ra_text_edit::text_utils::contains_offset_nonstrict;\n use rustc_hash::FxHashMap;\n use serde_json::to_value;\n+use std::io::Write;\n \n use crate::{\n     conv::{to_location, Conv, ConvWith, MapConvWith, TryConvWith},\n@@ -601,6 +604,40 @@ pub fn handle_references(\n     ))\n }\n \n+pub fn handle_formatting(\n+    world: ServerWorld,\n+    params: DocumentFormattingParams,\n+) -> Result<Option<Vec<TextEdit>>> {\n+    let file_id = params.text_document.try_conv_with(&world)?;\n+    let file = world.analysis().file_text(file_id);\n+\n+    let file_line_index = world.analysis().file_line_index(file_id);\n+    let end_position = TextUnit::of_str(&file).conv_with(&file_line_index);\n+\n+    use std::process;\n+    let mut rustfmt = process::Command::new(\"rustfmt\")\n+        .stdin(process::Stdio::piped())\n+        .stdout(process::Stdio::piped())\n+        .spawn()?;\n+\n+    rustfmt.stdin.as_mut().unwrap().write_all(file.as_bytes())?;\n+\n+    let output = rustfmt.wait_with_output()?;\n+    let captured_stdout = String::from_utf8(output.stdout)?;\n+    if !output.status.success() {\n+        failure::bail!(\n+            \"rustfmt exited with error code {}: {}.\",\n+            output.status,\n+            captured_stdout,\n+        );\n+    }\n+\n+    Ok(Some(vec![TextEdit {\n+        range: Range::new(Position::new(0, 0), end_position),\n+        new_text: captured_stdout,\n+    }]))\n+}\n+\n pub fn handle_code_action(\n     world: ServerWorld,\n     params: req::CodeActionParams,"}, {"sha": "b0e1e65b629803c54acebd9c5ca9db3992cc7a10", "filename": "crates/ra_lsp_server/tests/heavy_tests/main.rs", "status": "modified", "additions": 56, "deletions": 2, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -1,8 +1,8 @@\n mod support;\n \n use serde_json::json;\n-use ra_lsp_server::req::{Runnables, RunnablesParams, CodeActionRequest, CodeActionParams};\n-use languageserver_types::{Position, Range, CodeActionContext};\n+use ra_lsp_server::req::{Runnables, RunnablesParams, CodeActionRequest, CodeActionParams, Formatting};\n+use languageserver_types::{Position, Range, CodeActionContext, DocumentFormattingParams, FormattingOptions};\n \n use crate::support::project;\n \n@@ -118,6 +118,60 @@ fn test_eggs() {}\n     );\n }\n \n+use std::collections::HashMap;\n+#[test]\n+fn test_format_document() {\n+    tools::install_rustfmt().unwrap();\n+\n+    let server = project(\n+        r#\"\n+[package]\n+name = \"foo\"\n+version = \"0.0.0\"\n+\n+//- src/lib.rs\n+mod bar;\n+\n+fn main() {\n+}\n+\n+pub use std::collections::HashMap;\n+\"#,\n+    );\n+    server.wait_for_feedback(\"workspace loaded\");\n+\n+    server.request::<Formatting>(\n+        DocumentFormattingParams {\n+            text_document: server.doc_id(\"src/lib.rs\"),\n+            options: FormattingOptions {\n+                tab_size: 4,\n+                insert_spaces: false,\n+                properties: HashMap::new(),\n+            },\n+        },\n+        json!([\n+            {\n+                \"newText\": r#\"mod bar;\n+\n+fn main() {}\n+\n+pub use std::collections::HashMap;\n+\"#,\n+                \"range\": {\n+                    \"end\": {\n+                        \"character\": 0,\n+                        \"line\": 6\n+                    },\n+                    \"start\": {\n+                        \"character\": 0,\n+                        \"line\": 0\n+                    }\n+                }\n+            }\n+        ]),\n+    );\n+}\n+\n #[test]\n fn test_missing_module_code_action() {\n     let server = project("}, {"sha": "e5b32c25ce44eb9089fea8c940e8a890ecf4fe67", "filename": "crates/tools/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Ftools%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/crates%2Ftools%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftools%2Fsrc%2Flib.rs?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -117,7 +117,7 @@ pub fn run_rustfmt(mode: Mode) -> Result<()> {\n     Ok(())\n }\n \n-fn install_rustfmt() -> Result<()> {\n+pub fn install_rustfmt() -> Result<()> {\n     run(&format!(\"rustup install {}\", TOOLCHAIN), \".\")?;\n     run(\n         &format!(\"rustup component add rustfmt --toolchain {}\", TOOLCHAIN),"}, {"sha": "a63ced72559c65eca87cea7d783f9e9326c51207", "filename": "editors/README.md", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8d1df9834c96bd464c309383afdd8edea0576ae0/editors%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/8d1df9834c96bd464c309383afdd8edea0576ae0/editors%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2FREADME.md?ref=8d1df9834c96bd464c309383afdd8edea0576ae0", "patch": "@@ -45,6 +45,8 @@ It's better to remove existing Rust plugins to avoid interference.\n     `#[test]`, this action runs this specific test. If the cursor is\n     outside of the test function, this re-runs the last test. Do bind\n     this to a shortcut!\n+  - **Format document**. Formats the current file with rustfmt.\n+    Rustfmt must be installed separately with `rustup component add rustfmt`.\n \n * Typing assists\n   - typing `let =` tries to smartly add `;` if `=` is followed by an existing expression."}]}