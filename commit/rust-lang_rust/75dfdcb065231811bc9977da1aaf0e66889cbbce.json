{"sha": "75dfdcb065231811bc9977da1aaf0e66889cbbce", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1ZGZkY2IwNjUyMzE4MTFiYzk5NzdkYTFhYWYwZTY2ODg5Y2JiY2U=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-07-27T20:18:40Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-07-27T20:19:00Z"}, "message": "ci: download awscli from our mirror\n\nThis fixes multiple network issues we had when downloading awscli from\nPyPI on Azure Pipelines by vendoring awscli itself and its dependencies\nin our S3 bucket. Instructions on how to update the cache are present at\nthe top of src/ci/install-awscli.sh", "tree": {"sha": "02e9985fb66cc416c8999e7670b56ffb248a5e79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02e9985fb66cc416c8999e7670b56ffb248a5e79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75dfdcb065231811bc9977da1aaf0e66889cbbce", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl08sg8ACgkQPgar6Auq\n8ZxZGQ//ZFWAbZ47+I0hBiK3A2vwdXh1rhZVdGUf9V3HYeE23bEYMaYed9WBJBja\nET1n+YPnYXRQr0uuz0iZ5jDRWUqzsbb66hbQAf3/lzlw8+VfXdD0ss5BccpITP0J\noUc60Fv+RI4BSkz1WcD7bB1c0YoyXJbaczjzdTWw0gFNmPgVovOL/Kih2PZDLnHJ\nCXimFsE692fzE4lIA2IJZEBiOwOxpITYcpGPURIntacH81bDWp6gJn9GaLo+HP2D\n3uYRsjrm+DgRXHwqtCQ0/+55nwcj5H6GgDzz6swXryL+Oun4oAfDpyg9TXbx3x15\nm55VD3Kndy5JAIzU7Rh8wf45K2hpyihdI+BQm6aAnLyk4f57rOkNszkjL8neIcEy\n1mRO45T0T7WCs8vxLhTWWu7F9EV7h2410pDH87YO3OLMaJN6UgrSt3zgSvcaXzt4\nu+H4xLnzh3/NLvLuIIGbfgmsWzGk6By//Wj2niMUqCYalh1DzmnnDy4UHR54y9U0\n6c0sAkj0K2nymqDy9xWjfXAVir0/r32ZSqld1OdIrLtuTsXMzLUI32nGa6YSG1Pu\nyrFA1zcXjePJo+xQzrgxIb8WHDku7XX+tNf+AIGBRfG5d3KLDHU0WHMjgbx6+cZT\n0GiEvosk/nhGtyNls5VKz7B6WIjX47csREsxIrd9oZY5j7Xm0tw=\n=UFX9\n-----END PGP SIGNATURE-----", "payload": "tree 02e9985fb66cc416c8999e7670b56ffb248a5e79\nparent 0e9b465d729d07101b29b4d096d83edf9be82df0\nauthor Pietro Albini <pietro@pietroalbini.org> 1564258720 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1564258740 +0200\n\nci: download awscli from our mirror\n\nThis fixes multiple network issues we had when downloading awscli from\nPyPI on Azure Pipelines by vendoring awscli itself and its dependencies\nin our S3 bucket. Instructions on how to update the cache are present at\nthe top of src/ci/install-awscli.sh\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75dfdcb065231811bc9977da1aaf0e66889cbbce", "html_url": "https://github.com/rust-lang/rust/commit/75dfdcb065231811bc9977da1aaf0e66889cbbce", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75dfdcb065231811bc9977da1aaf0e66889cbbce/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0e9b465d729d07101b29b4d096d83edf9be82df0", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e9b465d729d07101b29b4d096d83edf9be82df0", "html_url": "https://github.com/rust-lang/rust/commit/0e9b465d729d07101b29b4d096d83edf9be82df0"}], "stats": {"total": 90, "additions": 40, "deletions": 50}, "files": [{"sha": "1e49cc00921cd7ad5a6ff17828aa814eb93df8a4", "filename": ".azure-pipelines/steps/run.yml", "status": "modified", "additions": 5, "deletions": 37, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/75dfdcb065231811bc9977da1aaf0e66889cbbce/.azure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/75dfdcb065231811bc9977da1aaf0e66889cbbce/.azure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Frun.yml?ref=75dfdcb065231811bc9977da1aaf0e66889cbbce", "patch": "@@ -138,43 +138,11 @@ steps:\n \n # Ensure the `aws` CLI is installed so we can deploy later on, cache docker\n # images, etc.\n-- bash: |\n-    set -e\n-    # Temporary code to debug #62967.\n-    debug_failed_connections() {\n-        echo \"trying to ping pypi.org\"\n-        ping pypi.org -c10 || true\n-        echo \"trying to ping google.com\"\n-        ping google.com -c10 || true\n-        echo \"trying to ping 8.8.8.8\"\n-        ping 8.8.8.8 -c10 || true\n-        echo \"trying to download pypi.org\"\n-        curl https://pypi.org || true\n-        echo \"trying to download from our S3 bucket\"\n-        curl https://rust-lang-ci2.s3.amazonaws.com || true\n-        echo \"trying to dig pypi.org\"\n-        dig pypi.org || true\n-        echo \"trying to dig files.pythonhosted.org\"\n-        dig files.pythonhosted.org || true\n-        echo \"trying to connect to pypi.org with openssl\"\n-        echo | openssl s_client -connect pypi.org:443 || true\n-        echo \"trying to connect to files.pythonhosted.org with openssl\"\n-        echo | openssl s_client -connect files.pythonhosted.org:443 || true\n-    }\n-    debug_failed_connections_and_fail() {\n-        debug_failed_connections\n-        return 1\n-    }\n-    source src/ci/shared.sh\n-    sudo apt-get install -y python3-setuptools\n-    debug_failed_connections\n-    retry pip3 install -r src/ci/awscli-requirements.txt --upgrade --user || debug_failed_connections_and_fail\n-    echo \"##vso[task.prependpath]$HOME/.local/bin\"\n-  displayName: Install awscli (Linux)\n-  condition: and(succeeded(), not(variables.SKIP_JOB), eq(variables['Agent.OS'], 'Linux'))\n-- script: pip install -r src/ci/awscli-requirements.txt\n-  displayName: Install awscli (non-Linux)\n-  condition: and(succeeded(), not(variables.SKIP_JOB), ne(variables['Agent.OS'], 'Linux'))\n+- bash: src/ci/install-awscli.sh\n+  env:\n+    AGENT_OS: $(Agent.OS)\n+  condition: and(succeeded(), not(variables.SKIP_JOB))\n+  displayName: Install awscli\n \n # Configure our CI_JOB_NAME variable which log analyzers can use for the main\n # step to see what's going on."}, {"sha": "c1ffa525a1b41509a20416831ce605c4670f2815", "filename": "src/ci/awscli-requirements.txt", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0e9b465d729d07101b29b4d096d83edf9be82df0/src%2Fci%2Fawscli-requirements.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0e9b465d729d07101b29b4d096d83edf9be82df0/src%2Fci%2Fawscli-requirements.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fawscli-requirements.txt?ref=0e9b465d729d07101b29b4d096d83edf9be82df0", "patch": "@@ -1,13 +0,0 @@\n-awscli==1.16.201\n-botocore==1.12.191\n-colorama==0.3.9\n-docutils==0.14\n-jmespath==0.9.4\n-pyasn1==0.4.5\n-python-dateutil==2.8.0\n-PyYAML==5.1\n-rsa==3.4.2\n-s3transfer==0.2.1\n-six==1.12.0\n-urllib3==1.25.3\n-futures==3.3.0; python_version < '3.0'"}, {"sha": "d491b9fbcdcf81a6ae67ac5496fe05b5f8635fb2", "filename": "src/ci/install-awscli.sh", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/75dfdcb065231811bc9977da1aaf0e66889cbbce/src%2Fci%2Finstall-awscli.sh", "raw_url": "https://github.com/rust-lang/rust/raw/75dfdcb065231811bc9977da1aaf0e66889cbbce/src%2Fci%2Finstall-awscli.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finstall-awscli.sh?ref=75dfdcb065231811bc9977da1aaf0e66889cbbce", "patch": "@@ -0,0 +1,35 @@\n+#!/bin/bash\n+# This script downloads and installs awscli from the packages mirrored in our\n+# own S3 bucket. This follows the recommendations at:\n+#\n+#    https://packaging.python.org/guides/index-mirrors-and-caches/#caching-with-pip\n+#\n+# To create a new mirrored copy you can run the command:\n+#\n+#    pip wheel awscli\n+#\n+# Before compressing please make sure all the wheels end with `-none-any.whl`.\n+# If that's not the case you'll need to remove the non-cross-platform ones and\n+# replace them with the .tar.gz downloaded from https://pypi.org. Also make\n+# sure it's possible to call this script with both Python 2 and Python 3.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+MIRROR=\"https://rust-lang-ci2.s3.amazonaws.com/rust-ci-mirror/2019-07-27-awscli.tar\"\n+DEPS_DIR=\"/tmp/awscli-deps\"\n+\n+pip=\"pip\"\n+pipflags=\"\"\n+if [[ \"${AGENT_OS}\" == \"Linux\" ]]; then\n+    pip=\"pip3\"\n+    pipflags=\"--user\"\n+\n+    sudo apt-get install -y python3-setuptools\n+    echo \"##vso[task.prependpath]$HOME/.local/bin\"\n+fi\n+\n+mkdir -p \"${DEPS_DIR}\"\n+curl \"${MIRROR}\" | tar xf - -C \"${DEPS_DIR}\"\n+\"${pip}\" install ${pipflags} --no-index \"--find-links=${DEPS_DIR}\" awscli\n+rm -rf \"${DEPS_DIR}\""}]}