{"sha": "c7ada001ec10f7702d98af70d3b8dffabb990f5f", "node_id": "C_kwDOAAsO6NoAKGM3YWRhMDAxZWMxMGY3NzAyZDk4YWY3MGQzYjhkZmZhYmI5OTBmNWY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-13T07:11:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-13T07:11:16Z"}, "message": "Rollup merge of #90001 - Fearyncess:master, r=alexcrichton\n\nMake rlib metadata strip works with MIPSr6 architecture\n\nBecause MIPSr6 has many differences with previous MIPSr2 arch, the previous rlib metadata stripping code in `rustc_codegen_ssa` is only for MIPSr2/r3/r5 (which share the same elf e_flags).\n\nThis commit fixed this problem. It makes `rustc_codegen_ssa` happy when compiling rustc for MIPSr6 target or hosts.\n\ne_flags REF: https://github.com/llvm/llvm-project/blob/e356027016c6365b3d8924f54c33e2c63d931492/llvm/include/llvm/BinaryFormat/ELF.h#L562", "tree": {"sha": "3a4078f5f8f78a160568497aabe87ea833532e47", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a4078f5f8f78a160568497aabe87ea833532e47"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c7ada001ec10f7702d98af70d3b8dffabb990f5f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh39CVCRBK7hj4Ov3rIwAAMwAIALAou0n8mK9udcoOA0WouJF/\nQOzy5ne3u2/H4RP7Y8ZA5kXcjFGj2SU2hFKwG4+1DhNM6t1peylGZXyqIBT/zrDH\nwztPWRpb8cjo0elL2ZqolgG9S3QfDE3FMzRRjKJMAkkg8FZsxuqS1dX4R/8YcNUo\nU90kDkr34JPDcf/cD9N6lVBXmrJJEiT68k6gnxXDB4iJTOtosVi58asWVmsNFSS/\n8+AHWxh56cmNZxv1d12EvqEtHOAUdiCkJ3IK2lz/4qECuJ0w2RHOy4YGngiIbbY2\nUQ47YN+h3JI9ZvX6whBOBcRR2KeTrgF+xOS/5larCMLiYhq5B3mqRNE6mr0k7NQ=\n=dsga\n-----END PGP SIGNATURE-----\n", "payload": "tree 3a4078f5f8f78a160568497aabe87ea833532e47\nparent 256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a\nparent cf36c21b289b020ef42dba1e02350672c904ad4a\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1642057876 +0100\ncommitter GitHub <noreply@github.com> 1642057876 +0100\n\nRollup merge of #90001 - Fearyncess:master, r=alexcrichton\n\nMake rlib metadata strip works with MIPSr6 architecture\n\nBecause MIPSr6 has many differences with previous MIPSr2 arch, the previous rlib metadata stripping code in `rustc_codegen_ssa` is only for MIPSr2/r3/r5 (which share the same elf e_flags).\n\nThis commit fixed this problem. It makes `rustc_codegen_ssa` happy when compiling rustc for MIPSr6 target or hosts.\n\ne_flags REF: https://github.com/llvm/llvm-project/blob/e356027016c6365b3d8924f54c33e2c63d931492/llvm/include/llvm/BinaryFormat/ELF.h#L562\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c7ada001ec10f7702d98af70d3b8dffabb990f5f", "html_url": "https://github.com/rust-lang/rust/commit/c7ada001ec10f7702d98af70d3b8dffabb990f5f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c7ada001ec10f7702d98af70d3b8dffabb990f5f/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a", "html_url": "https://github.com/rust-lang/rust/commit/256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a"}, {"sha": "cf36c21b289b020ef42dba1e02350672c904ad4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf36c21b289b020ef42dba1e02350672c904ad4a", "html_url": "https://github.com/rust-lang/rust/commit/cf36c21b289b020ef42dba1e02350672c904ad4a"}], "stats": {"total": 49, "additions": 42, "deletions": 7}, "files": [{"sha": "0056904c8d60db85157adf12c886aa692a48861a", "filename": "Cargo.lock", "status": "modified", "additions": 25, "deletions": 3, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/c7ada001ec10f7702d98af70d3b8dffabb990f5f/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c7ada001ec10f7702d98af70d3b8dffabb990f5f/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=c7ada001ec10f7702d98af70d3b8dffabb990f5f", "patch": "@@ -24,6 +24,17 @@ dependencies = [\n  \"rustc-std-workspace-core\",\n ]\n \n+[[package]]\n+name = \"ahash\"\n+version = \"0.7.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"43bb833f0bf979d8475d38fbf09ed3b8a55e1885fe93ad3f93239fc6a4f17b98\"\n+dependencies = [\n+ \"getrandom 0.2.0\",\n+ \"once_cell\",\n+ \"version_check\",\n+]\n+\n [[package]]\n name = \"aho-corasick\"\n version = \"0.7.18\"\n@@ -1579,6 +1590,7 @@ version = \"0.11.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"362385356d610bd1e5a408ddf8d022041774b683f345a1d2cfcb4f60f8ae2db5\"\n dependencies = [\n+ \"ahash\",\n  \"compiler_builtins\",\n  \"rustc-std-workspace-alloc\",\n  \"rustc-std-workspace-core\",\n@@ -2396,8 +2408,6 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"39f37e50073ccad23b6d09bcb5b263f4e76d3bb6038e4a3c08e52162ffa8abc2\"\n dependencies = [\n  \"compiler_builtins\",\n- \"crc32fast\",\n- \"indexmap\",\n  \"memchr\",\n  \"rustc-std-workspace-alloc\",\n  \"rustc-std-workspace-core\",\n@@ -2415,6 +2425,18 @@ dependencies = [\n  \"memchr\",\n ]\n \n+[[package]]\n+name = \"object\"\n+version = \"0.28.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"7ce8b38d41f9f3618fc23f908faae61510f8d8ce2d99cbe910641e8f1971f084\"\n+dependencies = [\n+ \"crc32fast\",\n+ \"hashbrown\",\n+ \"indexmap\",\n+ \"memchr\",\n+]\n+\n [[package]]\n name = \"odht\"\n version = \"0.3.1\"\n@@ -3801,7 +3823,7 @@ dependencies = [\n  \"itertools 0.9.0\",\n  \"jobserver\",\n  \"libc\",\n- \"object 0.26.2\",\n+ \"object 0.28.1\",\n  \"pathdiff\",\n  \"regex\",\n  \"rustc_apfloat\","}, {"sha": "6c6ee363ea310c1480c3208d2c3596793a4167cd", "filename": "compiler/rustc_codegen_ssa/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c7ada001ec10f7702d98af70d3b8dffabb990f5f/compiler%2Frustc_codegen_ssa%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c7ada001ec10f7702d98af70d3b8dffabb990f5f/compiler%2Frustc_codegen_ssa%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2FCargo.toml?ref=c7ada001ec10f7702d98af70d3b8dffabb990f5f", "patch": "@@ -41,6 +41,6 @@ rustc_target = { path = \"../rustc_target\" }\n rustc_session = { path = \"../rustc_session\" }\n \n [dependencies.object]\n-version = \"0.26.2\"\n+version = \"0.28.0\"\n default-features = false\n features = [\"read_core\", \"elf\", \"macho\", \"pe\", \"unaligned\", \"archive\", \"write\"]"}, {"sha": "6849533abc049e7098e8ee154b08bb23d1ed3f9d", "filename": "compiler/rustc_codegen_ssa/src/back/metadata.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c7ada001ec10f7702d98af70d3b8dffabb990f5f/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7ada001ec10f7702d98af70d3b8dffabb990f5f/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs?ref=c7ada001ec10f7702d98af70d3b8dffabb990f5f", "patch": "@@ -95,7 +95,7 @@ fn search_for_metadata<'a>(\n         .map_err(|e| format!(\"failed to read {} section in '{}': {}\", section, path.display(), e))\n }\n \n-fn create_object_file(sess: &Session) -> Option<write::Object> {\n+fn create_object_file(sess: &Session) -> Option<write::Object<'static>> {\n     let endianness = match sess.target.options.endian {\n         Endian::Little => Endianness::Little,\n         Endian::Big => Endianness::Big,\n@@ -135,12 +135,24 @@ fn create_object_file(sess: &Session) -> Option<write::Object> {\n         Architecture::Mips => {\n             // copied from `mipsel-linux-gnu-gcc foo.c -c` and\n             // inspecting the resulting `e_flags` field.\n-            let e_flags = elf::EF_MIPS_ARCH_32R2 | elf::EF_MIPS_CPIC | elf::EF_MIPS_PIC;\n+            let e_flags = elf::EF_MIPS_CPIC\n+                | elf::EF_MIPS_PIC\n+                | if sess.target.options.cpu.contains(\"r6\") {\n+                    elf::EF_MIPS_ARCH_32R6 | elf::EF_MIPS_NAN2008\n+                } else {\n+                    elf::EF_MIPS_ARCH_32R2\n+                };\n             file.flags = FileFlags::Elf { e_flags };\n         }\n         Architecture::Mips64 => {\n             // copied from `mips64el-linux-gnuabi64-gcc foo.c -c`\n-            let e_flags = elf::EF_MIPS_ARCH_64R2 | elf::EF_MIPS_CPIC | elf::EF_MIPS_PIC;\n+            let e_flags = elf::EF_MIPS_CPIC\n+                | elf::EF_MIPS_PIC\n+                | if sess.target.options.cpu.contains(\"r6\") {\n+                    elf::EF_MIPS_ARCH_64R6 | elf::EF_MIPS_NAN2008\n+                } else {\n+                    elf::EF_MIPS_ARCH_64R2\n+                };\n             file.flags = FileFlags::Elf { e_flags };\n         }\n         Architecture::Riscv64 if sess.target.options.features.contains(\"+d\") => {"}, {"sha": "9d2aa0f21c8e1a992f6f926fe90ba0bac7597157", "filename": "src/tools/tidy/src/deps.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c7ada001ec10f7702d98af70d3b8dffabb990f5f/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7ada001ec10f7702d98af70d3b8dffabb990f5f/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs?ref=c7ada001ec10f7702d98af70d3b8dffabb990f5f", "patch": "@@ -73,6 +73,7 @@ const RESTRICTED_DEPENDENCY_CRATES: &[&str] = &[\"rustc_driver\", \"rustc_codegen_l\n const PERMITTED_DEPENDENCIES: &[&str] = &[\n     \"addr2line\",\n     \"adler\",\n+    \"ahash\",\n     \"aho-corasick\",\n     \"annotate-snippets\",\n     \"ansi_term\","}]}