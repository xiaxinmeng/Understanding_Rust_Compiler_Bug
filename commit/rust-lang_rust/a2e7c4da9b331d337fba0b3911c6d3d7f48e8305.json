{"sha": "a2e7c4da9b331d337fba0b3911c6d3d7f48e8305", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyZTdjNGRhOWIzMzFkMzM3ZmJhMGIzOTExYzZkM2Q3ZjQ4ZTgzMDU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-10-04T19:32:07Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-10-04T19:32:07Z"}, "message": "auto merge of #17738 : hoeppnertill/rust/master, r=alexcrichton\n\nThere is an issue with lev_distance, where\r\n```\r\nfn main() {\r\n    println!(\"{}\", \"\\x80\".lev_distance(\"\\x80\"))\r\n}\r\n```\r\nprints `2`.\r\n\r\nThis is due to using the byte length instead of the char length.", "tree": {"sha": "934452ca7ce6287103d64b086e44feac3a219b71", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/934452ca7ce6287103d64b086e44feac3a219b71"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2e7c4da9b331d337fba0b3911c6d3d7f48e8305", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2e7c4da9b331d337fba0b3911c6d3d7f48e8305", "html_url": "https://github.com/rust-lang/rust/commit/a2e7c4da9b331d337fba0b3911c6d3d7f48e8305", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2e7c4da9b331d337fba0b3911c6d3d7f48e8305/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "url": "https://api.github.com/repos/rust-lang/rust/commits/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "html_url": "https://github.com/rust-lang/rust/commit/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49"}, {"sha": "3aea7f18894bfc35c03044688229f6de84eb42f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/3aea7f18894bfc35c03044688229f6de84eb42f3", "html_url": "https://github.com/rust-lang/rust/commit/3aea7f18894bfc35c03044688229f6de84eb42f3"}], "stats": {"total": 37, "additions": 28, "deletions": 9}, "files": [{"sha": "553b34a55c31743295ee01402cf6a311cd0700cd", "filename": "src/libcollections/str.rs", "status": "modified", "additions": 28, "deletions": 9, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a2e7c4da9b331d337fba0b3911c6d3d7f48e8305/src%2Flibcollections%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e7c4da9b331d337fba0b3911c6d3d7f48e8305/src%2Flibcollections%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fstr.rs?ref=a2e7c4da9b331d337fba0b3911c6d3d7f48e8305", "patch": "@@ -778,13 +778,11 @@ pub trait StrAllocating: Str {\n     /// Returns the Levenshtein Distance between two strings.\n     fn lev_distance(&self, t: &str) -> uint {\n         let me = self.as_slice();\n-        let slen = me.len();\n-        let tlen = t.len();\n+        if me.is_empty() { return t.char_len(); }\n+        if t.is_empty() { return me.char_len(); }\n \n-        if slen == 0 { return tlen; }\n-        if tlen == 0 { return slen; }\n-\n-        let mut dcol = Vec::from_fn(tlen + 1, |x| x);\n+        let mut dcol = Vec::from_fn(t.len() + 1, |x| x);\n+        let mut t_last = 0;\n \n         for (i, sc) in me.chars().enumerate() {\n \n@@ -799,15 +797,15 @@ pub trait StrAllocating: Str {\n                     *dcol.get_mut(j + 1) = current;\n                 } else {\n                     *dcol.get_mut(j + 1) = cmp::min(current, next);\n-                    *dcol.get_mut(j + 1) = cmp::min(dcol[j + 1],\n-                                                    dcol[j]) + 1;\n+                    *dcol.get_mut(j + 1) = cmp::min(dcol[j + 1], dcol[j]) + 1;\n                 }\n \n                 current = next;\n+                t_last = j;\n             }\n         }\n \n-        return dcol[tlen];\n+        dcol[t_last + 1]\n     }\n \n     /// Returns an iterator over the string in Unicode Normalization Form D\n@@ -1878,6 +1876,27 @@ mod tests {\n         assert_eq!(words, vec![\"M\u00e4ry\", \"h\u00e4d\", \"\u00e4\", \"little\", \"l\u00e4mb\", \"Little\", \"l\u00e4mb\"])\n     }\n \n+    #[test]\n+    fn test_lev_distance() {\n+        use std::char::{ from_u32, MAX };\n+        // Test bytelength agnosticity\n+        for c in range(0u32, MAX as u32)\n+                 .filter_map(|i| from_u32(i))\n+                 .map(|i| String::from_char(1, i)) {\n+            assert_eq!(c[].lev_distance(c[]), 0);\n+        }\n+\n+        let a = \"\\nM\u00e4ry h\u00e4d \u00e4 little l\u00e4mb\\n\\nLittle l\u00e4mb\\n\";\n+        let b = \"\\nMary h\u00e4d \u00e4 little l\u00e4mb\\n\\nLittle l\u00e4mb\\n\";\n+        let c = \"Mary h\u00e4d \u00e4 little l\u00e4mb\\n\\nLittle l\u00e4mb\\n\";\n+        assert_eq!(a.lev_distance(b), 1);\n+        assert_eq!(b.lev_distance(a), 1);\n+        assert_eq!(a.lev_distance(c), 2);\n+        assert_eq!(c.lev_distance(a), 2);\n+        assert_eq!(b.lev_distance(c), 1);\n+        assert_eq!(c.lev_distance(b), 1);\n+    }\n+\n     #[test]\n     fn test_nfd_chars() {\n         macro_rules! t {"}]}