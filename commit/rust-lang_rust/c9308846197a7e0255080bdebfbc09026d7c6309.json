{"sha": "c9308846197a7e0255080bdebfbc09026d7c6309", "node_id": "C_kwDOAAsO6NoAKGM5MzA4ODQ2MTk3YTdlMDI1NTA4MGJkZWJmYmMwOTAyNmQ3YzYzMDk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-02-27T20:46:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-27T20:46:36Z"}, "message": "Rollup merge of #94415 - bjorn3:cfg_default_backend, r=Mark-Simulacrum\n\nUse the first codegen backend in the config.toml as default\n\nIt is currently hard coded to llvm if enabled and cranelift otherwise.\nThis made some sense when cranelift was the only alternative codegen\nbackend. Since the introduction of the gcc backend this doesn't make\nmuch sense anymore. Before this PR bootstrapping rustc using a backend\nother than llvm or cranelift required changing the source of\nrustc_interface. With this PR it becomes a matter of putting the right\nbackend as first enabled backend in config.toml.\n\ncc ```@antoyo```", "tree": {"sha": "ad0799ba1429c266b883550f33f1bccea8935305", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ad0799ba1429c266b883550f33f1bccea8935305"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c9308846197a7e0255080bdebfbc09026d7c6309", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiG+MtCRBK7hj4Ov3rIwAAJFkIAE3ygqmAqFPcutYCfdgHvaWi\n1oYtTGDbWOsNmRwAbAUyZQz1j5WlqHtHJl9WQO0uSBrw/sv9mPE/2Sygr9tV3Na0\nuRwAUJ6A3VI0kFUrxuNL0BWulxj9cw95D1Re+fQFbezBJ5b//nHMJB6pEAnQgMkq\n8HwKjjy8cnr4mpS196IGZEu/Z9n5CdSLpXGRuW94Ws3w/gqiUs+6D2nayLI5VtTp\nn0CXDkVGG06zmtVNMdh4XTnmhWsqR1sEy64PtgSXf4imAO5U8Z+YDk4fxYXr/sFc\nfbw3/oXp1i2vdgg5mvl8jxTiyMeV7E6ztk1663X7ufUqyxxslyvd8f/6djslwXQ=\n=MUx0\n-----END PGP SIGNATURE-----\n", "payload": "tree ad0799ba1429c266b883550f33f1bccea8935305\nparent 736dae2f71370c6c1ad04d8b2c6d97484cd02f33\nparent 7ad4297a4960c657932885173bef77fde0f26ccd\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1645994796 +0100\ncommitter GitHub <noreply@github.com> 1645994796 +0100\n\nRollup merge of #94415 - bjorn3:cfg_default_backend, r=Mark-Simulacrum\n\nUse the first codegen backend in the config.toml as default\n\nIt is currently hard coded to llvm if enabled and cranelift otherwise.\nThis made some sense when cranelift was the only alternative codegen\nbackend. Since the introduction of the gcc backend this doesn't make\nmuch sense anymore. Before this PR bootstrapping rustc using a backend\nother than llvm or cranelift required changing the source of\nrustc_interface. With this PR it becomes a matter of putting the right\nbackend as first enabled backend in config.toml.\n\ncc ```@antoyo```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c9308846197a7e0255080bdebfbc09026d7c6309", "html_url": "https://github.com/rust-lang/rust/commit/c9308846197a7e0255080bdebfbc09026d7c6309", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c9308846197a7e0255080bdebfbc09026d7c6309/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "736dae2f71370c6c1ad04d8b2c6d97484cd02f33", "url": "https://api.github.com/repos/rust-lang/rust/commits/736dae2f71370c6c1ad04d8b2c6d97484cd02f33", "html_url": "https://github.com/rust-lang/rust/commit/736dae2f71370c6c1ad04d8b2c6d97484cd02f33"}, {"sha": "7ad4297a4960c657932885173bef77fde0f26ccd", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ad4297a4960c657932885173bef77fde0f26ccd", "html_url": "https://github.com/rust-lang/rust/commit/7ad4297a4960c657932885173bef77fde0f26ccd"}], "stats": {"total": 16, "additions": 9, "deletions": 7}, "files": [{"sha": "046f4f9451f58b535e27c470bd6b8f71d919e23a", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c9308846197a7e0255080bdebfbc09026d7c6309/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9308846197a7e0255080bdebfbc09026d7c6309/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=c9308846197a7e0255080bdebfbc09026d7c6309", "patch": "@@ -236,13 +236,9 @@ pub fn get_codegen_backend(\n     static LOAD: SyncOnceCell<unsafe fn() -> Box<dyn CodegenBackend>> = SyncOnceCell::new();\n \n     let load = LOAD.get_or_init(|| {\n-        #[cfg(feature = \"llvm\")]\n-        const DEFAULT_CODEGEN_BACKEND: &str = \"llvm\";\n+        let default_codegen_backend = option_env!(\"CFG_DEFAULT_CODEGEN_BACKEND\").unwrap_or(\"llvm\");\n \n-        #[cfg(not(feature = \"llvm\"))]\n-        const DEFAULT_CODEGEN_BACKEND: &str = \"cranelift\";\n-\n-        match backend_name.unwrap_or(DEFAULT_CODEGEN_BACKEND) {\n+        match backend_name.unwrap_or(default_codegen_backend) {\n             filename if filename.contains('.') => load_backend_from_dylib(filename.as_ref()),\n             #[cfg(feature = \"llvm\")]\n             \"llvm\" => rustc_codegen_llvm::LlvmCodegenBackend::new,"}, {"sha": "466a3a29c4c78284043d12ddb7a220c6406e2892", "filename": "config.toml.example", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c9308846197a7e0255080bdebfbc09026d7c6309/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/c9308846197a7e0255080bdebfbc09026d7c6309/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=c9308846197a7e0255080bdebfbc09026d7c6309", "patch": "@@ -551,7 +551,9 @@ changelog-seen = 2\n \n # This is an array of the codegen backends that will be compiled for the rustc\n # that's being compiled. The default is to only build the LLVM codegen backend,\n-# and currently the only standard options supported are `\"llvm\"` and `\"cranelift\"`.\n+# and currently the only standard options supported are `\"llvm\"`, `\"cranelift\"`\n+# and `\"gcc\"`. The first backend in this list will be used as default by rustc\n+# when no explicit backend is specified.\n #codegen-backends = [\"llvm\"]\n \n # Indicates whether LLD will be compiled and made available in the sysroot for"}, {"sha": "b4c6210b3881487916fcbab32617ad10573605ec", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c9308846197a7e0255080bdebfbc09026d7c6309/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9308846197a7e0255080bdebfbc09026d7c6309/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=c9308846197a7e0255080bdebfbc09026d7c6309", "patch": "@@ -662,6 +662,10 @@ pub fn rustc_cargo_env(builder: &Builder<'_>, cargo: &mut Cargo, target: TargetS\n         .env(\"CFG_RELEASE_CHANNEL\", &builder.config.channel)\n         .env(\"CFG_VERSION\", builder.rust_version());\n \n+    if let Some(backend) = builder.config.rust_codegen_backends.get(0) {\n+        cargo.env(\"CFG_DEFAULT_CODEGEN_BACKEND\", backend);\n+    }\n+\n     let libdir_relative = builder.config.libdir_relative().unwrap_or_else(|| Path::new(\"lib\"));\n     let target_config = builder.config.target_config.get(&target);\n "}]}