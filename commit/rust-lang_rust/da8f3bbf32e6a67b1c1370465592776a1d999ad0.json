{"sha": "da8f3bbf32e6a67b1c1370465592776a1d999ad0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhOGYzYmJmMzJlNmE2N2IxYzEzNzA0NjU1OTI3NzZhMWQ5OTlhZDA=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2020-04-14T01:02:03Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2020-04-15T18:58:54Z"}, "message": "Directly modify the `used_locals` vec\n\nFixes perf regression in `optimized_mir` query", "tree": {"sha": "55cd905c5552e63ca93cbdd78aa8b63f24f3d422", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55cd905c5552e63ca93cbdd78aa8b63f24f3d422"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/da8f3bbf32e6a67b1c1370465592776a1d999ad0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/da8f3bbf32e6a67b1c1370465592776a1d999ad0", "html_url": "https://github.com/rust-lang/rust/commit/da8f3bbf32e6a67b1c1370465592776a1d999ad0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/da8f3bbf32e6a67b1c1370465592776a1d999ad0/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de3cf6e8a472bf67df278cfae8986afdcc215c18", "url": "https://api.github.com/repos/rust-lang/rust/commits/de3cf6e8a472bf67df278cfae8986afdcc215c18", "html_url": "https://github.com/rust-lang/rust/commit/de3cf6e8a472bf67df278cfae8986afdcc215c18"}], "stats": {"total": 26, "additions": 12, "deletions": 14}, "files": [{"sha": "45e2e0c2596747298f085933566aa2bba8cf59de", "filename": "src/librustc_mir/transform/simplify.rs", "status": "modified", "additions": 12, "deletions": 14, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/da8f3bbf32e6a67b1c1370465592776a1d999ad0/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da8f3bbf32e6a67b1c1370465592776a1d999ad0/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs?ref=da8f3bbf32e6a67b1c1370465592776a1d999ad0", "patch": "@@ -438,13 +438,16 @@ impl<'a, 'tcx> Visitor<'tcx> for DeclMarker<'a, 'tcx> {\n }\n \n struct StatementDeclMarker<'a, 'tcx> {\n-    used_locals: IndexVec<Local, usize>,\n+    used_locals: &'a mut IndexVec<Local, usize>,\n     statement: &'a Statement<'tcx>,\n }\n \n impl<'a, 'tcx> StatementDeclMarker<'a, 'tcx> {\n-    pub fn new(local_count: usize, statement: &'a Statement<'tcx>) -> Self {\n-        Self { used_locals: IndexVec::from_elem_n(0, local_count), statement }\n+    pub fn new(\n+        used_locals: &'a mut IndexVec<Local, usize>,\n+        statement: &'a Statement<'tcx>,\n+    ) -> Self {\n+        Self { used_locals, statement }\n     }\n }\n \n@@ -457,7 +460,11 @@ impl<'a, 'tcx> Visitor<'tcx> for StatementDeclMarker<'a, 'tcx> {\n             }\n         }\n \n-        self.used_locals[*local] += 1;\n+        let use_count = &mut self.used_locals[*local];\n+        // If this is the local we're removing...\n+        if *use_count != 0 {\n+            *use_count -= 1;\n+        }\n     }\n }\n \n@@ -504,17 +511,8 @@ impl<'a, 'tcx> MutVisitor<'tcx> for RemoveStatements<'a, 'tcx> {\n                 trace!(\"removing statement {:?}\", stmt);\n                 self.modified = true;\n \n-                let mut visitor = StatementDeclMarker::new(self.used_locals.len(), stmt);\n+                let mut visitor = StatementDeclMarker::new(self.used_locals, stmt);\n                 visitor.visit_statement(stmt, Location { block, statement_index: i });\n-\n-                for (local, count) in visitor.used_locals.iter_enumerated() {\n-                    let used_count = &mut self.used_locals[local];\n-\n-                    // If this is the local we're removing...\n-                    if *used_count != 0 {\n-                        *used_count -= count;\n-                    }\n-                }\n             }\n \n             i += 1;"}]}