{"sha": "1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFjYTdiZmU0ODFhMTg5MDllNDc2OWE5ZjZhZWU1OGY4Y2VjMTdiNDQ=", "commit": {"author": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-07-06T15:10:42Z"}, "committer": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-07-10T08:56:13Z"}, "message": "Only add cfguard module flag on windows-msvc", "tree": {"sha": "edf2d5ad96413810dd1311344975a594b81ad6e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/edf2d5ad96413810dd1311344975a594b81ad6e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "html_url": "https://github.com/rust-lang/rust/commit/1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/comments", "author": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1beee4992ad4b235fc700bf7af1ee86f894ea53", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1beee4992ad4b235fc700bf7af1ee86f894ea53", "html_url": "https://github.com/rust-lang/rust/commit/e1beee4992ad4b235fc700bf7af1ee86f894ea53"}], "stats": {"total": 55, "additions": 36, "deletions": 19}, "files": [{"sha": "21ba97d15a485776362716ed8b84b6c946cd1f8d", "filename": "src/librustc_codegen_llvm/context.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcontext.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -188,14 +188,19 @@ pub unsafe fn create_module(\n         llvm::LLVMRustAddModuleFlag(llmod, avoid_plt, 1);\n     }\n \n-    // Set module flags to enable Windows Control Flow Guard (/guard:cf) metadata\n-    // only (`cfguard=1`) or metadata and checks (`cfguard=2`).\n-    match sess.opts.debugging_opts.control_flow_guard {\n-        CFGuard::Disabled => {}\n-        CFGuard::NoChecks => {\n-            llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 1)\n+    // Control Flow Guard is currently only supported by the MSVC linker on Windows.\n+    if sess.target.target.options.is_like_msvc {\n+        match sess.opts.debugging_opts.control_flow_guard {\n+            CFGuard::Disabled => {}\n+            CFGuard::NoChecks => {\n+                // Set `cfguard=1` module flag to emit metadata only.\n+                llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 1)\n+            }\n+            CFGuard::Checks => {\n+                // Set `cfguard=2` module flag to emit metadata and checks.\n+                llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 2)\n+            }\n         }\n-        CFGuard::Checks => llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 2),\n     }\n \n     llmod"}, {"sha": "550de75c709fb8d194549dac6aaf796bb418b0a4", "filename": "src/librustc_codegen_ssa/back/linker.rs", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -475,9 +475,7 @@ impl<'a> Linker for GccLinker<'a> {\n         self.cmd.arg(\"__llvm_profile_runtime\");\n     }\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn debuginfo(&mut self, strip: Strip) {\n         match strip {\n@@ -959,9 +957,7 @@ impl<'a> Linker for EmLinker<'a> {\n         // noop, but maybe we need something like the gnu linker?\n     }\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn debuginfo(&mut self, _strip: Strip) {\n         // Preserve names or generate source maps depending on debug info\n@@ -1163,9 +1159,7 @@ impl<'a> Linker for WasmLd<'a> {\n         }\n     }\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn no_crt_objects(&mut self) {}\n \n@@ -1330,9 +1324,7 @@ impl<'a> Linker for PtxLinker<'a> {\n \n     fn no_default_libraries(&mut self) {}\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn export_symbols(&mut self, _tmpdir: &Path, _crate_type: CrateType) {}\n "}, {"sha": "96a0a321199a37dc6e03eeb8f973cda45862ba64", "filename": "src/test/codegen/cfguard-checks.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z control-flow-guard=checks\n+// only-msvc\n \n #![crate_type = \"lib\"]\n ", "previous_filename": "src/test/codegen/cfguard_checks.rs"}, {"sha": "925e4e8e2d15557bc4dd9fdb9d43fcddba7cc6c1", "filename": "src/test/codegen/cfguard-disabled.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z control-flow-guard=no\n+// only-msvc\n \n #![crate_type = \"lib\"]\n ", "previous_filename": "src/test/codegen/cfguard_disabled.rs"}, {"sha": "d7dc3d7e89eea007fdeb644d237efab8dd6c181d", "filename": "src/test/codegen/cfguard-nochecks.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z control-flow-guard=nochecks\n+// only-msvc\n \n #![crate_type = \"lib\"]\n ", "previous_filename": "src/test/codegen/cfguard_nochecks.rs"}, {"sha": "4008f0187a0b05bc318262744e5d8bb17d4ff63e", "filename": "src/test/codegen/cfguard-non-msvc.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -0,0 +1,11 @@\n+// compile-flags: -Z control-flow-guard\n+// ignore-msvc\n+\n+#![crate_type = \"lib\"]\n+\n+// A basic test function.\n+pub fn test() {\n+}\n+\n+// Ensure the cfguard module flag is not added for non-MSVC targets.\n+// CHECK-NOT: !\"cfguard\""}, {"sha": "21368fad3b05848a47ae08cfaa1c02f3e006e264", "filename": "src/test/ui/cfguard-run.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fui%2Fcfguard-run.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ca7bfe481a18909e4769a9f6aee58f8cec17b44/src%2Ftest%2Fui%2Fcfguard-run.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfguard-run.rs?ref=1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "patch": "@@ -0,0 +1,6 @@\n+// run-pass\n+// compile-flags: -Z control-flow-guard\n+\n+pub fn main() {\n+    println!(\"hello, world\");\n+}"}]}