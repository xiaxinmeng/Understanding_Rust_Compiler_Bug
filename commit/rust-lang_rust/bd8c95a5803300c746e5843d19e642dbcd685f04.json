{"sha": "bd8c95a5803300c746e5843d19e642dbcd685f04", "node_id": "C_kwDOAAsO6NoAKGJkOGM5NWE1ODAzMzAwYzc0NmU1ODQzZDE5ZTY0MmRiY2Q2ODVmMDQ", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-09-24T12:20:43Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-09-24T12:20:43Z"}, "message": "Fix incorrect mod.rs handling in unlinked_file fixes", "tree": {"sha": "ae51f6e951511d83d191bcccb21b54e0760a7267", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae51f6e951511d83d191bcccb21b54e0760a7267"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd8c95a5803300c746e5843d19e642dbcd685f04", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd8c95a5803300c746e5843d19e642dbcd685f04", "html_url": "https://github.com/rust-lang/rust/commit/bd8c95a5803300c746e5843d19e642dbcd685f04", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd8c95a5803300c746e5843d19e642dbcd685f04/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d598d0b4f1aba67453287bf1a8e19cf7f47fd2d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/d598d0b4f1aba67453287bf1a8e19cf7f47fd2d5", "html_url": "https://github.com/rust-lang/rust/commit/d598d0b4f1aba67453287bf1a8e19cf7f47fd2d5"}], "stats": {"total": 65, "additions": 54, "deletions": 11}, "files": [{"sha": "9eafd42d86e78dc2f7855c001ddf0f6965321622", "filename": "crates/ide_diagnostics/src/handlers/unlinked_file.rs", "status": "modified", "additions": 54, "deletions": 11, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/bd8c95a5803300c746e5843d19e642dbcd685f04/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Funlinked_file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd8c95a5803300c746e5843d19e642dbcd685f04/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Funlinked_file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_diagnostics%2Fsrc%2Fhandlers%2Funlinked_file.rs?ref=bd8c95a5803300c746e5843d19e642dbcd685f04", "patch": "@@ -38,21 +38,35 @@ fn fixes(ctx: &DiagnosticsContext, file_id: FileId) -> Option<Vec<Assist>> {\n \n     let source_root = ctx.sema.db.source_root(ctx.sema.db.file_source_root(file_id));\n     let our_path = source_root.path_for_file(&file_id)?;\n-    let (module_name, _) = our_path.name_and_extension()?;\n+    let (mut module_name, _) = our_path.name_and_extension()?;\n \n     // Candidates to look for:\n-    // - `mod.rs` in the same folder\n-    //   - we also check `main.rs` and `lib.rs`\n+    // - `mod.rs`, `main.rs` and `lib.rs` in the same folder\n     // - `$dir.rs` in the parent folder, where `$dir` is the directory containing `self.file_id`\n     let parent = our_path.parent()?;\n-    let mut paths = vec![parent.join(\"mod.rs\")?, parent.join(\"lib.rs\")?, parent.join(\"main.rs\")?];\n-\n-    // `submod/bla.rs` -> `submod.rs`\n-    let parent_mod = (|| {\n-        let (name, _) = parent.name_and_extension()?;\n-        parent.parent()?.join(&format!(\"{}.rs\", name))\n-    })();\n-    paths.extend(parent_mod);\n+    let paths = {\n+        let temp;\n+        let parent = if module_name == \"mod\" {\n+            // for mod.rs we need to actually look up one higher\n+            // and take the parent as our to be module name\n+            let (name, _) = parent.name_and_extension()?;\n+            module_name = name;\n+            temp = parent.parent()?;\n+            &temp\n+        } else {\n+            &parent\n+        };\n+        let mut paths =\n+            vec![parent.join(\"mod.rs\")?, parent.join(\"lib.rs\")?, parent.join(\"main.rs\")?];\n+\n+        // `submod/bla.rs` -> `submod.rs`\n+        let parent_mod = (|| {\n+            let (name, _) = parent.name_and_extension()?;\n+            parent.parent()?.join(&format!(\"{}.rs\", name))\n+        })();\n+        paths.extend(parent_mod);\n+        paths\n+    };\n \n     for &parent_id in paths.iter().filter_map(|path| source_root.file_for_path(path)) {\n         for &krate in ctx.sema.db.relevant_crates(parent_id).iter() {\n@@ -156,6 +170,7 @@ fn make_fixes(\n \n #[cfg(test)]\n mod tests {\n+\n     use crate::tests::{check_diagnostics, check_fix, check_fixes, check_no_fix};\n \n     #[test]\n@@ -232,6 +247,34 @@ mod foo;\n         );\n     }\n \n+    #[test]\n+    fn unlinked_file_insert_in_empty_file_mod_file() {\n+        check_fix(\n+            r#\"\n+//- /main.rs\n+//- /foo/mod.rs\n+$0\n+\"#,\n+            r#\"\n+mod foo;\n+\"#,\n+        );\n+        check_fix(\n+            r#\"\n+//- /main.rs\n+mod bar;\n+//- /bar.rs\n+// bar module\n+//- /bar/foo/mod.rs\n+$0\n+\"#,\n+            r#\"\n+// bar module\n+mod foo;\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn unlinked_file_old_style_modrs() {\n         check_fix("}]}