{"sha": "a5926115b42143b842889cc9fb94f00ad3c9c17d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1OTI2MTE1YjQyMTQzYjg0Mjg4OWNjOWZiOTRmMDBhZDNjOWMxN2Q=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-06-16T04:32:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-06-16T04:32:43Z"}, "message": "Rollup merge of #42651 - infinity0:master, r=alexcrichton\n\nOnly run check-linkchecker when actually building docs\n\nOtherwise the build fails, when running tests but not building docs, e.g.:\nhttps://buildd.debian.org/status/fetch.php?pkg=rustc&arch=ppc64el&ver=1.17.0%2Bdfsg2-3&stamp=1497403375&raw=0", "tree": {"sha": "71a2c0aa93bffacb50acf18acd60f42e177908f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/71a2c0aa93bffacb50acf18acd60f42e177908f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a5926115b42143b842889cc9fb94f00ad3c9c17d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a5926115b42143b842889cc9fb94f00ad3c9c17d", "html_url": "https://github.com/rust-lang/rust/commit/a5926115b42143b842889cc9fb94f00ad3c9c17d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a5926115b42143b842889cc9fb94f00ad3c9c17d/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f784e5f13624f07df27ab76bfd8c8b40f92731bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/f784e5f13624f07df27ab76bfd8c8b40f92731bb", "html_url": "https://github.com/rust-lang/rust/commit/f784e5f13624f07df27ab76bfd8c8b40f92731bb"}, {"sha": "13b1a80505c7497cddadfa4fbed93f0d69ddeca5", "url": "https://api.github.com/repos/rust-lang/rust/commits/13b1a80505c7497cddadfa4fbed93f0d69ddeca5", "html_url": "https://github.com/rust-lang/rust/commit/13b1a80505c7497cddadfa4fbed93f0d69ddeca5"}], "stats": {"total": 29, "additions": 27, "deletions": 2}, "files": [{"sha": "8c3662002671b26aa3f5e10182268e000e1b0cc1", "filename": "src/bootstrap/step.rs", "status": "modified", "additions": 27, "deletions": 2, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/a5926115b42143b842889cc9fb94f00ad3c9c17d/src%2Fbootstrap%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5926115b42143b842889cc9fb94f00ad3c9c17d/src%2Fbootstrap%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fstep.rs?ref=a5926115b42143b842889cc9fb94f00ad3c9c17d", "patch": "@@ -463,7 +463,7 @@ pub fn build_rules<'a>(build: &'a Build) -> Rules {\n     rules.test(\"check-linkchecker\", \"src/tools/linkchecker\")\n          .dep(|s| s.name(\"tool-linkchecker\").stage(0))\n          .dep(|s| s.name(\"default:doc\"))\n-         .default(true)\n+         .default(build.config.docs)\n          .host(true)\n          .run(move |s| check::linkcheck(build, s.target));\n     rules.test(\"check-cargotest\", \"src/tools/cargotest\")\n@@ -1407,13 +1407,20 @@ mod tests {\n     fn build(args: &[&str],\n              extra_host: &[&str],\n              extra_target: &[&str]) -> Build {\n+        build_(args, extra_host, extra_target, true)\n+    }\n+\n+    fn build_(args: &[&str],\n+              extra_host: &[&str],\n+              extra_target: &[&str],\n+              docs: bool) -> Build {\n         let mut args = args.iter().map(|s| s.to_string()).collect::<Vec<_>>();\n         args.push(\"--build\".to_string());\n         args.push(\"A\".to_string());\n         let flags = Flags::parse(&args);\n \n         let mut config = Config::default();\n-        config.docs = true;\n+        config.docs = docs;\n         config.build = \"A\".to_string();\n         config.host = vec![config.build.clone()];\n         config.host.extend(extra_host.iter().map(|s| s.to_string()));\n@@ -1768,4 +1775,22 @@ mod tests {\n         assert!(!plan.iter().any(|s| s.name.contains(\"tidy\")));\n         assert!(plan.iter().any(|s| s.name.contains(\"valgrind\")));\n     }\n+\n+    #[test]\n+    fn test_disable_docs() {\n+        let build = build_(&[\"test\"], &[], &[], false);\n+        let rules = super::build_rules(&build);\n+        let plan = rules.plan();\n+        println!(\"rules: {:#?}\", plan);\n+        assert!(!plan.iter().any(|s| {\n+            s.name.contains(\"doc-\") || s.name.contains(\"default:doc\")\n+        }));\n+        // none of the dependencies should be a doc rule either\n+        assert!(!plan.iter().any(|s| {\n+            rules.rules[s.name].deps.iter().any(|dep| {\n+                let dep = dep(&rules.sbuild.name(s.name));\n+                dep.name.contains(\"doc-\") || dep.name.contains(\"default:doc\")\n+            })\n+        }));\n+    }\n }"}]}