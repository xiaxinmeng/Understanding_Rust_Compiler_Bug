{"sha": "25c153149ead5aebf7626a1ff42a6e0a3c35108e", "node_id": "C_kwDOAAsO6NoAKDI1YzE1MzE0OWVhZDVhZWJmNzYyNmExZmY0MmE2ZTBhM2MzNTEwOGU", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-12-30T10:11:33Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-01-03T16:45:34Z"}, "message": "Add `build_helper` crate to share code between tidy and bootstrap", "tree": {"sha": "dad082c98f0bbd1f7e10e0569b92963880147840", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dad082c98f0bbd1f7e10e0569b92963880147840"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25c153149ead5aebf7626a1ff42a6e0a3c35108e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25c153149ead5aebf7626a1ff42a6e0a3c35108e", "html_url": "https://github.com/rust-lang/rust/commit/25c153149ead5aebf7626a1ff42a6e0a3c35108e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25c153149ead5aebf7626a1ff42a6e0a3c35108e/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b435960c4cfd3975651c7051be56d7f5d6c201ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/b435960c4cfd3975651c7051be56d7f5d6c201ab", "html_url": "https://github.com/rust-lang/rust/commit/b435960c4cfd3975651c7051be56d7f5d6c201ab"}], "stats": {"total": 158, "additions": 98, "deletions": 60}, "files": [{"sha": "7a86a1012a7619343a493aaaadf5d89c42c9f97b", "filename": "Cargo.lock", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -259,6 +259,10 @@ dependencies = [\n  \"toml\",\n ]\n \n+[[package]]\n+name = \"build_helper\"\n+version = \"0.1.0\"\n+\n [[package]]\n name = \"bump-stage0\"\n version = \"0.1.0\"\n@@ -5304,6 +5308,7 @@ dependencies = [\n name = \"tidy\"\n version = \"0.1.0\"\n dependencies = [\n+ \"build_helper\",\n  \"cargo_metadata 0.14.0\",\n  \"ignore\",\n  \"lazy_static\","}, {"sha": "ce08d4edb567d05f1e108655c0fd56588913f00d", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -4,6 +4,7 @@ members = [\n   \"library/std\",\n   \"library/test\",\n   \"src/rustdoc-json-types\",\n+  \"src/tools/build_helper\",\n   \"src/tools/cargotest\",\n   \"src/tools/clippy\",\n   \"src/tools/clippy/clippy_dev\","}, {"sha": "4a0ba5925773e573e9862819ac10345f6c319cac", "filename": "src/bootstrap/Cargo.lock", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.lock?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -36,6 +36,7 @@ dependencies = [\n name = \"bootstrap\"\n version = \"0.0.0\"\n dependencies = [\n+ \"build_helper\",\n  \"cc\",\n  \"cmake\",\n  \"fd-lock\",\n@@ -70,6 +71,10 @@ dependencies = [\n  \"regex-automata\",\n ]\n \n+[[package]]\n+name = \"build_helper\"\n+version = \"0.1.0\"\n+\n [[package]]\n name = \"cc\"\n version = \"1.0.73\""}, {"sha": "22ceeca941e932872474ce0a3f549de91eece093", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -30,6 +30,7 @@ path = \"bin/sccache-plus-cl.rs\"\n test = false\n \n [dependencies]\n+build_helper = { path = \"../tools/build_helper\" }\n cmake = \"0.1.38\"\n fd-lock = \"3.0.8\"\n filetime = \"0.2\""}, {"sha": "cca45f4a634e839a5bce6728cdec5964bcfa95e4", "filename": "src/bootstrap/format.rs", "status": "modified", "additions": 1, "deletions": 29, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fformat.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -2,6 +2,7 @@\n \n use crate::builder::Builder;\n use crate::util::{output, program_out_of_date, t};\n+use build_helper::git::get_rust_lang_rust_remote;\n use ignore::WalkBuilder;\n use std::collections::VecDeque;\n use std::path::{Path, PathBuf};\n@@ -95,35 +96,6 @@ fn get_modified_rs_files(build: &Builder<'_>) -> Option<Vec<String>> {\n     )\n }\n \n-/// Finds the remote for rust-lang/rust.\n-/// For example for these remotes it will return `upstream`.\n-/// ```text\n-/// origin  https://github.com/Nilstrieb/rust.git (fetch)\n-/// origin  https://github.com/Nilstrieb/rust.git (push)\n-/// upstream        https://github.com/rust-lang/rust (fetch)\n-/// upstream        https://github.com/rust-lang/rust (push)\n-/// ```\n-fn get_rust_lang_rust_remote() -> Result<String, String> {\n-    let mut git = Command::new(\"git\");\n-    git.args([\"config\", \"--local\", \"--get-regex\", \"remote\\\\..*\\\\.url\"]);\n-\n-    let output = git.output().map_err(|err| format!(\"{err:?}\"))?;\n-    if !output.status.success() {\n-        return Err(\"failed to execute git config command\".to_owned());\n-    }\n-\n-    let stdout = String::from_utf8(output.stdout).map_err(|err| format!(\"{err:?}\"))?;\n-\n-    let rust_lang_remote = stdout\n-        .lines()\n-        .find(|remote| remote.contains(\"rust-lang\"))\n-        .ok_or_else(|| \"rust-lang/rust remote not found\".to_owned())?;\n-\n-    let remote_name =\n-        rust_lang_remote.split('.').nth(1).ok_or_else(|| \"remote name not found\".to_owned())?;\n-    Ok(remote_name.into())\n-}\n-\n #[derive(serde::Deserialize)]\n struct RustfmtConfig {\n     ignore: Vec<String>,"}, {"sha": "d44b96cfb991ece07a53944f225a0624737b2921", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -113,6 +113,7 @@ use std::path::{Path, PathBuf};\n use std::process::Command;\n use std::str;\n \n+use build_helper::ci::CiEnv;\n use channel::GitInfo;\n use config::{DryRun, Target};\n use filetime::FileTime;\n@@ -121,7 +122,7 @@ use once_cell::sync::OnceCell;\n use crate::builder::Kind;\n use crate::config::{LlvmLibunwind, TargetSelection};\n use crate::util::{\n-    exe, libdir, mtime, output, run, run_suppressed, symlink_dir, try_run_suppressed, CiEnv,\n+    exe, libdir, mtime, output, run, run_suppressed, symlink_dir, try_run_suppressed,\n };\n \n mod bolt;"}, {"sha": "bdc81b07b8d546c36b887920261bc9e092fe5323", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -24,6 +24,8 @@ use crate::util::get_clang_cl_resource_dir;\n use crate::util::{self, exe, output, t, up_to_date};\n use crate::{CLang, GitRepo};\n \n+use build_helper::ci::CiEnv;\n+\n #[derive(Clone)]\n pub struct LlvmResult {\n     /// Path to llvm-config binary.\n@@ -217,7 +219,7 @@ pub(crate) fn is_ci_llvm_available(config: &Config, asserts: bool) -> bool {\n         return false;\n     }\n \n-    if crate::util::CiEnv::is_ci() {\n+    if CiEnv::is_ci() {\n         // We assume we have access to git, so it's okay to unconditionally pass\n         // `true` here.\n         let llvm_sha = detect_llvm_sha(config, true);"}, {"sha": "8ce9a9ce38cc5d6115266e9bbda00d72018bd7dc", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 0, "deletions": 29, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -255,35 +255,6 @@ pub enum CiEnv {\n     GitHubActions,\n }\n \n-impl CiEnv {\n-    /// Obtains the current CI environment.\n-    pub fn current() -> CiEnv {\n-        if env::var(\"TF_BUILD\").map_or(false, |e| e == \"True\") {\n-            CiEnv::AzurePipelines\n-        } else if env::var(\"GITHUB_ACTIONS\").map_or(false, |e| e == \"true\") {\n-            CiEnv::GitHubActions\n-        } else {\n-            CiEnv::None\n-        }\n-    }\n-\n-    pub fn is_ci() -> bool {\n-        Self::current() != CiEnv::None\n-    }\n-\n-    /// If in a CI environment, forces the command to run with colors.\n-    pub fn force_coloring_in_ci(self, cmd: &mut Command) {\n-        if self != CiEnv::None {\n-            // Due to use of stamp/docker, the output stream of rustbuild is not\n-            // a TTY in CI, so coloring is by-default turned off.\n-            // The explicit `TERM=xterm` environment is needed for\n-            // `--color always` to actually work. This env var was lost when\n-            // compiling through the Makefile. Very strange.\n-            cmd.env(\"TERM\", \"xterm\").args(&[\"--color\", \"always\"]);\n-        }\n-    }\n-}\n-\n pub fn forcing_clang_based_tests() -> bool {\n     if let Some(var) = env::var_os(\"RUSTBUILD_FORCE_CLANG_BASED_TESTS\") {\n         match &var.to_string_lossy().to_lowercase()[..] {"}, {"sha": "99f6fea2ecf997b8a3b47433466f5a7840714ab5", "filename": "src/tools/build_helper/Cargo.toml", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2FCargo.toml?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -0,0 +1,8 @@\n+[package]\n+name = \"build_helper\"\n+version = \"0.1.0\"\n+edition = \"2021\"\n+\n+# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n+\n+[dependencies]"}, {"sha": "9f113c72b9338be390922d45d14d7f1ef6cf7dc5", "filename": "src/tools/build_helper/src/ci.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2Fsrc%2Fci.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2Fsrc%2Fci.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2Fsrc%2Fci.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -0,0 +1,40 @@\n+use std::process::Command;\n+\n+#[derive(Copy, Clone, PartialEq, Eq, Debug)]\n+pub enum CiEnv {\n+    /// Not a CI environment.\n+    None,\n+    /// The Azure Pipelines environment, for Linux (including Docker), Windows, and macOS builds.\n+    AzurePipelines,\n+    /// The GitHub Actions environment, for Linux (including Docker), Windows and macOS builds.\n+    GitHubActions,\n+}\n+\n+impl CiEnv {\n+    /// Obtains the current CI environment.\n+    pub fn current() -> CiEnv {\n+        if std::env::var(\"TF_BUILD\").map_or(false, |e| e == \"True\") {\n+            CiEnv::AzurePipelines\n+        } else if std::env::var(\"GITHUB_ACTIONS\").map_or(false, |e| e == \"true\") {\n+            CiEnv::GitHubActions\n+        } else {\n+            CiEnv::None\n+        }\n+    }\n+\n+    pub fn is_ci() -> bool {\n+        Self::current() != CiEnv::None\n+    }\n+\n+    /// If in a CI environment, forces the command to run with colors.\n+    pub fn force_coloring_in_ci(self, cmd: &mut Command) {\n+        if self != CiEnv::None {\n+            // Due to use of stamp/docker, the output stream of rustbuild is not\n+            // a TTY in CI, so coloring is by-default turned off.\n+            // The explicit `TERM=xterm` environment is needed for\n+            // `--color always` to actually work. This env var was lost when\n+            // compiling through the Makefile. Very strange.\n+            cmd.env(\"TERM\", \"xterm\").args(&[\"--color\", \"always\"]);\n+        }\n+    }\n+}"}, {"sha": "e9638206e6729f561f4a2ee388bc90f6b2748e5c", "filename": "src/tools/build_helper/src/git.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2Fsrc%2Fgit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2Fsrc%2Fgit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2Fsrc%2Fgit.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -0,0 +1,30 @@\n+use std::process::Command;\n+\n+/// Finds the remote for rust-lang/rust.\n+/// For example for these remotes it will return `upstream`.\n+/// ```text\n+/// origin  https://github.com/Nilstrieb/rust.git (fetch)\n+/// origin  https://github.com/Nilstrieb/rust.git (push)\n+/// upstream        https://github.com/rust-lang/rust (fetch)\n+/// upstream        https://github.com/rust-lang/rust (push)\n+/// ```\n+pub fn get_rust_lang_rust_remote() -> Result<String, String> {\n+    let mut git = Command::new(\"git\");\n+    git.args([\"config\", \"--local\", \"--get-regex\", \"remote\\\\..*\\\\.url\"]);\n+\n+    let output = git.output().map_err(|err| format!(\"{err:?}\"))?;\n+    if !output.status.success() {\n+        return Err(\"failed to execute git config command\".to_owned());\n+    }\n+\n+    let stdout = String::from_utf8(output.stdout).map_err(|err| format!(\"{err:?}\"))?;\n+\n+    let rust_lang_remote = stdout\n+        .lines()\n+        .find(|remote| remote.contains(\"rust-lang\"))\n+        .ok_or_else(|| \"rust-lang/rust remote not found\".to_owned())?;\n+\n+    let remote_name =\n+        rust_lang_remote.split('.').nth(1).ok_or_else(|| \"remote name not found\".to_owned())?;\n+    Ok(remote_name.into())\n+}"}, {"sha": "d3d2323db853a0cfe735d80dbfe2b9d19a883f43", "filename": "src/tools/build_helper/src/lib.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25c153149ead5aebf7626a1ff42a6e0a3c35108e/src%2Ftools%2Fbuild_helper%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2Fsrc%2Flib.rs?ref=25c153149ead5aebf7626a1ff42a6e0a3c35108e", "patch": "@@ -0,0 +1,2 @@\n+pub mod ci;\n+pub mod git;"}]}