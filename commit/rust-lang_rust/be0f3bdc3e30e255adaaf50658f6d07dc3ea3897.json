{"sha": "be0f3bdc3e30e255adaaf50658f6d07dc3ea3897", "node_id": "C_kwDOAAsO6NoAKGJlMGYzYmRjM2UzMGUyNTVhZGFhZjUwNjU4ZjZkMDdkYzNlYTM4OTc", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-06-17T16:27:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-06-17T16:27:30Z"}, "message": "Rollup merge of #110805 - pitaj:master, r=Mark-Simulacrum\n\nGithub action to periodically `cargo update` to keep dependencies current\n\nOpens a PR periodically with the results of `cargo update`. If an unmerged PR for the branch `cargo_update` already exists, it will edit then reopen it if necessary.\n\n~~This also uses [`cargo-upgrades`](https://gitlab.com/kornelski/cargo-upgrades) to provide a list of available major upgrades in the PR body.~~\n\nIt includes the list of changes output by `cargo update` in the commit message and PR body. Note that this output is currently sub-optimal due to https://github.com/rust-lang/cargo/issues/9408, but if updates are made more regularly that is less likely to show up.\n\nExample PR: https://github.com/pitaj/rust/pull/2\nExample action run: https://github.com/pitaj/rust/actions/runs/5035731903\nPrior discussion: https://rust-lang.zulipchat.com/#narrow/stream/242791-t-infra/topic/dependabot.20updates.3F\n\nUp for discussion:\n- What period do we want? Currently weekly\n- What user should it use? Currently \"Github Actions\"\n- Do we need the extra security of provided by executing `cargo update` and `cargo-upgrades` in a separate job?\n  If not I can simplify it to not need artifacts.\n- PR message wording\n- PR should probably always be `rollup=always`?\n- What branch should it use?\n- What should it do if no updates are available? Currently fails the job on empty commit\n- Should the yml file live in `src/ci` instead of directly under workflows?\n- ~~Is using the latest nightly toolchain enough to ensure compatibility with `Cargo.lock` and `Cargo.toml`s in master?~~\n  Now pulls the bootstrap version from stage0.json\n\nr? infra", "tree": {"sha": "910ff1cbe78d6503e0404dfc6e69bef9262dab2a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/910ff1cbe78d6503e0404dfc6e69bef9262dab2a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/be0f3bdc3e30e255adaaf50658f6d07dc3ea3897", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkjd7yCRBK7hj4Ov3rIwAAyKgIAAxCjVeVz8BmwJ2xtIl8LOO7\nUIYXfgLNXbgsVHlVdhfZa9Ou+NoKJZVBesFawka0sqie27EqOKxyIhL4lO+81/JP\nKAjrRfBP0W7GxM+IiUM+Pf5n1xYG0VeXby4z5bz2AkCtrK4ESKCvCvbBtt4YDVG+\nNN2POIsE822CnDawmLKoEfQg8VAl33506w+rYvzBZkNWUwzWY0FYoG2TSqq5Pfdp\n1c05w+Z67+BLtb3BOW8rlN+TepQznBogTHTeB5XCaAwmnKHBSQgDvutYPUKPqZoZ\nCwUjzUlBytT4r63PycY4RFjOfY33AUYFuqnDK5dwVOCqa3LAC5nFFkFca5eZsMY=\n=YItj\n-----END PGP SIGNATURE-----\n", "payload": "tree 910ff1cbe78d6503e0404dfc6e69bef9262dab2a\nparent e1c29d137dd779dcfce447d8d149ee6b8e9bdf78\nparent 6d3ff105365318fe41c907c424c6ff2b2ba80dae\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1687019250 +0200\ncommitter GitHub <noreply@github.com> 1687019250 +0200\n\nRollup merge of #110805 - pitaj:master, r=Mark-Simulacrum\n\nGithub action to periodically `cargo update` to keep dependencies current\n\nOpens a PR periodically with the results of `cargo update`. If an unmerged PR for the branch `cargo_update` already exists, it will edit then reopen it if necessary.\n\n~~This also uses [`cargo-upgrades`](https://gitlab.com/kornelski/cargo-upgrades) to provide a list of available major upgrades in the PR body.~~\n\nIt includes the list of changes output by `cargo update` in the commit message and PR body. Note that this output is currently sub-optimal due to https://github.com/rust-lang/cargo/issues/9408, but if updates are made more regularly that is less likely to show up.\n\nExample PR: https://github.com/pitaj/rust/pull/2\nExample action run: https://github.com/pitaj/rust/actions/runs/5035731903\nPrior discussion: https://rust-lang.zulipchat.com/#narrow/stream/242791-t-infra/topic/dependabot.20updates.3F\n\nUp for discussion:\n- What period do we want? Currently weekly\n- What user should it use? Currently \"Github Actions\"\n- Do we need the extra security of provided by executing `cargo update` and `cargo-upgrades` in a separate job?\n  If not I can simplify it to not need artifacts.\n- PR message wording\n- PR should probably always be `rollup=always`?\n- What branch should it use?\n- What should it do if no updates are available? Currently fails the job on empty commit\n- Should the yml file live in `src/ci` instead of directly under workflows?\n- ~~Is using the latest nightly toolchain enough to ensure compatibility with `Cargo.lock` and `Cargo.toml`s in master?~~\n  Now pulls the bootstrap version from stage0.json\n\nr? infra\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/be0f3bdc3e30e255adaaf50658f6d07dc3ea3897", "html_url": "https://github.com/rust-lang/rust/commit/be0f3bdc3e30e255adaaf50658f6d07dc3ea3897", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/be0f3bdc3e30e255adaaf50658f6d07dc3ea3897/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1c29d137dd779dcfce447d8d149ee6b8e9bdf78", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1c29d137dd779dcfce447d8d149ee6b8e9bdf78", "html_url": "https://github.com/rust-lang/rust/commit/e1c29d137dd779dcfce447d8d149ee6b8e9bdf78"}, {"sha": "6d3ff105365318fe41c907c424c6ff2b2ba80dae", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d3ff105365318fe41c907c424c6ff2b2ba80dae", "html_url": "https://github.com/rust-lang/rust/commit/6d3ff105365318fe41c907c424c6ff2b2ba80dae"}], "stats": {"total": 139, "additions": 139, "deletions": 0}, "files": [{"sha": "2eccd28e5bb1fb76ae98d7a4d18b7ba1158daa72", "filename": ".github/workflows/dependencies.yml", "status": "added", "additions": 139, "deletions": 0, "changes": 139, "blob_url": "https://github.com/rust-lang/rust/blob/be0f3bdc3e30e255adaaf50658f6d07dc3ea3897/.github%2Fworkflows%2Fdependencies.yml", "raw_url": "https://github.com/rust-lang/rust/raw/be0f3bdc3e30e255adaaf50658f6d07dc3ea3897/.github%2Fworkflows%2Fdependencies.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fdependencies.yml?ref=be0f3bdc3e30e255adaaf50658f6d07dc3ea3897", "patch": "@@ -0,0 +1,139 @@\n+# Automatically run `cargo update` periodically\n+\n+---\n+name: Bump dependencies in Cargo.lock\n+on:\n+  schedule:\n+    # Run weekly\n+    - cron: '0 0 * * Sun'\n+  workflow_dispatch:\n+    # Needed so we can run it manually\n+permissions:\n+  contents: read\n+defaults:\n+  run:\n+    shell: bash\n+env:\n+  # So cargo doesn't complain about unstable features\n+  RUSTC_BOOTSTRAP: 1\n+  PR_TITLE: Weekly `cargo update`\n+  PR_MESSAGE: |\n+    Automation to keep dependencies in `Cargo.lock` current.\n+\n+    The following is the output from `cargo update`:\n+  COMMIT_MESSAGE: \"cargo update \\n\\n\"\n+\n+jobs:\n+  not-waiting-on-bors:\n+    name: skip if S-waiting-on-bors\n+    runs-on: ubuntu-latest\n+    steps:\n+      - env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        run: |\n+          # Fetch state and labels of PR\n+          # Or exit successfully if PR does not exist\n+          JSON=$(gh pr view cargo_update --repo $GITHUB_REPOSITORY --json labels,state || exit 0)\n+          STATE=$(echo \"$JSON\" | jq -r '.state')\n+          WAITING_ON_BORS=$(echo \"$JSON\" | jq '.labels[] | any(.name == \"S-waiting-on-bors\"; .)')\n+\n+          # Exit with error if open and S-waiting-on-bors\n+          if [[ \"$STATE\" == \"OPEN\" && \"$WAITING_ON_BORS\" == \"true\" ]]; then\n+            exit 1\n+          fi\n+\n+  update:\n+    name: update dependencies\n+    needs: not-waiting-on-bors\n+    runs-on: ubuntu-latest\n+    steps:\n+      - name: checkout the source code\n+        uses: actions/checkout@v3\n+        with:\n+          submodules: recursive\n+      - name: install the bootstrap toolchain\n+        run: |\n+          # Extract the stage0 version\n+          TOOLCHAIN=$(jq -r '.compiler | {version,date} | join(\"-\")' -- src/stage0.json)\n+          # Install and set as default\n+          rustup toolchain install --no-self-update --profile minimal $TOOLCHAIN\n+          rustup default $TOOLCHAIN\n+\n+      - name: cargo update\n+        # Remove first line that always just says \"Updating crates.io index\"\n+        run: cargo update 2>&1 | sed '/crates.io index/d' | tee -a cargo_update.log\n+      - name: upload Cargo.lock artifact for use in PR\n+        uses: actions/upload-artifact@v3\n+        with:\n+          name: Cargo-lock\n+          path: Cargo.lock\n+          retention-days: 1\n+      - name: upload cargo-update log artifact for use in PR\n+        uses: actions/upload-artifact@v3\n+        with:\n+          name: cargo-updates\n+          path: cargo_update.log\n+          retention-days: 1\n+\n+  pr:\n+    name: amend PR\n+    needs: update\n+    runs-on: ubuntu-latest\n+    permissions:\n+      contents: write\n+      pull-requests: write\n+    steps:\n+      - name: checkout the source code\n+        uses: actions/checkout@v3\n+\n+      - name: download Cargo.lock from update job\n+        uses: actions/download-artifact@v3\n+        with:\n+          name: Cargo-lock\n+      - name: download cargo-update log from update job\n+        uses: actions/download-artifact@v3\n+        with:\n+          name: cargo-updates\n+\n+      - name: craft PR body and commit message\n+        run: |\n+          echo \"${COMMIT_MESSAGE}\" > commit.txt\n+          cat cargo_update.log >> commit.txt\n+\n+          echo \"${PR_MESSAGE}\" > body.md\n+          echo '```txt' >> body.md\n+          cat cargo_update.log >> body.md\n+          echo '```' >> body.md\n+\n+      - name: commit\n+        run: |\n+          git config user.name github-actions\n+          git config user.email github-actions@github.com\n+          git switch --force-create cargo_update\n+          git add ./Cargo.lock\n+          git commit --no-verify --file=commit.txt\n+\n+      - name: push\n+        run: git push --no-verify --force --set-upstream origin cargo_update\n+\n+      - name: edit existing open pull request\n+        id: edit\n+        # Don't fail job if we need to open new PR\n+        continue-on-error: true\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        run: |\n+          # Exit with error if PR is closed\n+          STATE=$(gh pr view cargo_update --repo $GITHUB_REPOSITORY --json state --jq '.state')\n+          if [[ \"$STATE\" != \"OPEN\" ]]; then\n+            exit 1\n+          fi\n+\n+          gh pr edit cargo_update --title \"${PR_TITLE}\" --body-file body.md --repo $GITHUB_REPOSITORY\n+\n+      - name: open new pull request\n+        # Only run if there wasn't an existing PR\n+        if: steps.edit.outcome != 'success'\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        run: gh pr create --title \"${PR_TITLE}\" --body-file body.md --repo $GITHUB_REPOSITORY"}]}