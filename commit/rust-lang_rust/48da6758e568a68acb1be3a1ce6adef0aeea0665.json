{"sha": "48da6758e568a68acb1be3a1ce6adef0aeea0665", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ4ZGE2NzU4ZTU2OGE2OGFjYjFiZTNhMWNlNmFkZWYwYWVlYTA2NjU=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-08-18T00:27:47Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-18T00:27:47Z"}, "message": "Rollup merge of #75613 - estebank:explain-mut-method, r=petrochenkov\n\nAdd explanation for `&mut self` method call when expecting `-> Self`\n\nWhen a user tries to use a method as if it returned a new value of the\nsame type as its receiver, we will emit a type error. Try to detect this\nand provide extra explanation that the method modifies the receiver\nin-place.\n\nThis has confused people in the wild, like in\nhttps://users.rust-lang.org/t/newbie-why-the-commented-line-stops-the-snippet-from-compiling/47322", "tree": {"sha": "f59e864647dc3e0b4dfb06ef5856978710b932f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f59e864647dc3e0b4dfb06ef5856978710b932f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/48da6758e568a68acb1be3a1ce6adef0aeea0665", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfOyCECRBK7hj4Ov3rIwAAdHIIABeTyhE0+trp3QJ5QuR++++i\nxNwu1utkNG5sMokO3x1rM953RnTkA/lbhYcU5Vb3BXm3sSgNXmUZWGKgl2NUQBQC\nDcA2QBxEDf6vvaB3YmQzKWdE0ybOZjF192f2DXvnPwyapWhfpevGgQtXOs0AYg65\np8Aw1Gy1H6EBrketiKNQ0rZamHgUvdlJ/WKB6qcfMM/5GtjVBrDEAs+g8z7LgJCu\nHEpTTdr3HPGkfsqSAcQYiNKTdTAlsRjyAMs2qk88lrXKHZw18tTym/rxLHr3wixn\nIEMLhDtpSWxX9rCm+yhJPRSStCYpnViHQ8XaB9ij4ucHUygUBuaOmv68asxqrec=\n=kqp1\n-----END PGP SIGNATURE-----\n", "payload": "tree f59e864647dc3e0b4dfb06ef5856978710b932f8\nparent 8eb805c55cca030109525ae5daac4d4a646ee0a1\nparent ac73474c7db65e49d3fd17906b7d34d984a88172\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1597710467 +0900\ncommitter GitHub <noreply@github.com> 1597710467 +0900\n\nRollup merge of #75613 - estebank:explain-mut-method, r=petrochenkov\n\nAdd explanation for `&mut self` method call when expecting `-> Self`\n\nWhen a user tries to use a method as if it returned a new value of the\nsame type as its receiver, we will emit a type error. Try to detect this\nand provide extra explanation that the method modifies the receiver\nin-place.\n\nThis has confused people in the wild, like in\nhttps://users.rust-lang.org/t/newbie-why-the-commented-line-stops-the-snippet-from-compiling/47322\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/48da6758e568a68acb1be3a1ce6adef0aeea0665", "html_url": "https://github.com/rust-lang/rust/commit/48da6758e568a68acb1be3a1ce6adef0aeea0665", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/48da6758e568a68acb1be3a1ce6adef0aeea0665/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8eb805c55cca030109525ae5daac4d4a646ee0a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/8eb805c55cca030109525ae5daac4d4a646ee0a1", "html_url": "https://github.com/rust-lang/rust/commit/8eb805c55cca030109525ae5daac4d4a646ee0a1"}, {"sha": "ac73474c7db65e49d3fd17906b7d34d984a88172", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac73474c7db65e49d3fd17906b7d34d984a88172", "html_url": "https://github.com/rust-lang/rust/commit/ac73474c7db65e49d3fd17906b7d34d984a88172"}], "stats": {"total": 70, "additions": 70, "deletions": 0}, "files": [{"sha": "aa92d8b8b2b9b8d7e8f57bd57e70762c16bfbbee", "filename": "src/librustc_typeck/check/demand.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs?ref=48da6758e568a68acb1be3a1ce6adef0aeea0665", "patch": "@@ -36,6 +36,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         self.suggest_missing_await(err, expr, expected, expr_ty);\n         self.suggest_missing_parentheses(err, expr);\n         self.note_need_for_fn_pointer(err, expected, expr_ty);\n+        self.note_internal_mutation_in_method(err, expr, expected, expr_ty);\n     }\n \n     // Requires that the two types unify, and prints an error message if"}, {"sha": "91573767389e566656512de93fe59908e568a288", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=48da6758e568a68acb1be3a1ce6adef0aeea0665", "patch": "@@ -5198,6 +5198,51 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n+    fn note_internal_mutation_in_method(\n+        &self,\n+        err: &mut DiagnosticBuilder<'_>,\n+        expr: &hir::Expr<'_>,\n+        expected: Ty<'tcx>,\n+        found: Ty<'tcx>,\n+    ) {\n+        if found != self.tcx.types.unit {\n+            return;\n+        }\n+        if let ExprKind::MethodCall(path_segment, _, [rcvr, ..], _) = expr.kind {\n+            if self\n+                .typeck_results\n+                .borrow()\n+                .expr_ty_adjusted_opt(rcvr)\n+                .map_or(true, |ty| expected.peel_refs() != ty.peel_refs())\n+            {\n+                return;\n+            }\n+            let mut sp = MultiSpan::from_span(path_segment.ident.span);\n+            sp.push_span_label(\n+                path_segment.ident.span,\n+                format!(\n+                    \"this call modifies {} in-place\",\n+                    match rcvr.kind {\n+                        ExprKind::Path(QPath::Resolved(\n+                            None,\n+                            hir::Path { segments: [segment], .. },\n+                        )) => format!(\"`{}`\", segment.ident),\n+                        _ => \"its receiver\".to_string(),\n+                    }\n+                ),\n+            );\n+            sp.push_span_label(\n+                rcvr.span,\n+                \"you probably want to use this value after calling the method...\".to_string(),\n+            );\n+            err.span_note(\n+                sp,\n+                &format!(\"method `{}` modifies its receiver in-place\", path_segment.ident),\n+            );\n+            err.note(&format!(\"...instead of the `()` output of method `{}`\", path_segment.ident));\n+        }\n+    }\n+\n     /// When encountering an `impl Future` where `BoxFuture` is expected, suggest `Box::pin`.\n     fn suggest_calling_boxed_future_when_appropriate(\n         &self,"}, {"sha": "cb92ab87a8ff723ab76c6d6ddb6f5b02936e77a3", "filename": "src/test/ui/suggestions/chain-method-call-mutation-in-place.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Ftest%2Fui%2Fsuggestions%2Fchain-method-call-mutation-in-place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Ftest%2Fui%2Fsuggestions%2Fchain-method-call-mutation-in-place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fchain-method-call-mutation-in-place.rs?ref=48da6758e568a68acb1be3a1ce6adef0aeea0665", "patch": "@@ -0,0 +1,4 @@\n+fn main() {}\n+fn foo(mut s: String) -> String {\n+    s.push_str(\"asdf\") //~ ERROR mismatched types\n+}"}, {"sha": "63e3bb78954cf298e86fc8e54b56729312963873", "filename": "src/test/ui/suggestions/chain-method-call-mutation-in-place.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Ftest%2Fui%2Fsuggestions%2Fchain-method-call-mutation-in-place.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/48da6758e568a68acb1be3a1ce6adef0aeea0665/src%2Ftest%2Fui%2Fsuggestions%2Fchain-method-call-mutation-in-place.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fchain-method-call-mutation-in-place.stderr?ref=48da6758e568a68acb1be3a1ce6adef0aeea0665", "patch": "@@ -0,0 +1,20 @@\n+error[E0308]: mismatched types\n+  --> $DIR/chain-method-call-mutation-in-place.rs:3:5\n+   |\n+LL | fn foo(mut s: String) -> String {\n+   |                          ------ expected `std::string::String` because of return type\n+LL |     s.push_str(\"asdf\")\n+   |     ^^^^^^^^^^^^^^^^^^ expected struct `std::string::String`, found `()`\n+   |\n+note: method `push_str` modifies its receiver in-place\n+  --> $DIR/chain-method-call-mutation-in-place.rs:3:7\n+   |\n+LL |     s.push_str(\"asdf\")\n+   |     - ^^^^^^^^ this call modifies `s` in-place\n+   |     |\n+   |     you probably want to use this value after calling the method...\n+   = note: ...instead of the `()` output of method `push_str`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}]}