{"sha": "3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmYjI0YzE4YWI2NjllOWVlOWY4ZjRiZWY4NTQxYmQ5MDY1M2VhMzM=", "commit": {"author": {"name": "Eduard Burtescu", "email": "edy.burt@gmail.com", "date": "2016-10-25T15:18:17Z"}, "committer": {"name": "Eduard Burtescu", "email": "edy.burt@gmail.com", "date": "2016-10-25T15:18:17Z"}, "message": "rustc_metadata: move is_extern_item to trans.", "tree": {"sha": "2a2fbc1ab7b598b4e8c631950a45750e4db30106", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a2fbc1ab7b598b4e8c631950a45750e4db30106"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "html_url": "https://github.com/rust-lang/rust/commit/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "affc3b7552324284ccd7042b5b23f6ecd391babc", "url": "https://api.github.com/repos/rust-lang/rust/commits/affc3b7552324284ccd7042b5b23f6ecd391babc", "html_url": "https://github.com/rust-lang/rust/commit/affc3b7552324284ccd7042b5b23f6ecd391babc"}], "stats": {"total": 50, "additions": 16, "deletions": 34}, "files": [{"sha": "3613366781d6d0b420e0ce88cba1a710fd3a7364", "filename": "src/librustc/middle/cstore.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcstore.rs?ref=3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "patch": "@@ -165,7 +165,6 @@ pub trait CrateStore<'tcx> {\n     fn is_const_fn(&self, did: DefId) -> bool;\n     fn is_defaulted_trait(&self, did: DefId) -> bool;\n     fn is_default_impl(&self, impl_did: DefId) -> bool;\n-    fn is_extern_item<'a>(&self, tcx: TyCtxt<'a, 'tcx, 'tcx>, did: DefId) -> bool;\n     fn is_foreign_item(&self, did: DefId) -> bool;\n     fn is_statically_included_foreign_item(&self, id: ast::NodeId) -> bool;\n \n@@ -334,8 +333,6 @@ impl<'tcx> CrateStore<'tcx> for DummyCrateStore {\n     fn is_const_fn(&self, did: DefId) -> bool { bug!(\"is_const_fn\") }\n     fn is_defaulted_trait(&self, did: DefId) -> bool { bug!(\"is_defaulted_trait\") }\n     fn is_default_impl(&self, impl_did: DefId) -> bool { bug!(\"is_default_impl\") }\n-    fn is_extern_item<'a>(&self, tcx: TyCtxt<'a, 'tcx, 'tcx>, did: DefId) -> bool\n-        { bug!(\"is_extern_item\") }\n     fn is_foreign_item(&self, did: DefId) -> bool { bug!(\"is_foreign_item\") }\n     fn is_statically_included_foreign_item(&self, id: ast::NodeId) -> bool { false }\n "}, {"sha": "e31f13fa417ad476a8cf722faafbdd90e2a45425", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "patch": "@@ -207,11 +207,6 @@ impl<'tcx> CrateStore<'tcx> for cstore::CStore {\n         self.get_crate_data(impl_did.krate).is_default_impl(impl_did.index)\n     }\n \n-    fn is_extern_item<'a>(&self, tcx: TyCtxt<'a, 'tcx, 'tcx>, did: DefId) -> bool {\n-        self.dep_graph.read(DepNode::MetaData(did));\n-        self.get_crate_data(did.krate).is_extern_item(did.index, tcx)\n-    }\n-\n     fn is_foreign_item(&self, did: DefId) -> bool {\n         self.get_crate_data(did.krate).is_foreign_item(did.index)\n     }"}, {"sha": "ea2d40c302a79f09e97616f4c12ab8e230311b54", "filename": "src/librustc_metadata/decoder.rs", "status": "modified", "additions": 0, "deletions": 24, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc_metadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc_metadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdecoder.rs?ref=3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "patch": "@@ -1009,30 +1009,6 @@ impl<'a, 'tcx> CrateMetadata {\n         constness == hir::Constness::Const\n     }\n \n-    pub fn is_extern_item(&self, id: DefIndex, tcx: TyCtxt<'a, 'tcx, 'tcx>) -> bool {\n-        let item = match self.maybe_entry(id) {\n-            Some(item) => item.decode(self),\n-            None => return false,\n-        };\n-        let applicable = match item.kind {\n-            EntryKind::ImmStatic |\n-            EntryKind::MutStatic |\n-            EntryKind::ForeignImmStatic |\n-            EntryKind::ForeignMutStatic => true,\n-\n-            EntryKind::Fn(_) |\n-            EntryKind::ForeignFn(_) => self.get_generics(id, tcx).types.is_empty(),\n-\n-            _ => false,\n-        };\n-\n-        if applicable {\n-            attr::contains_extern_indicator(tcx.sess.diagnostic(), &self.get_attributes(&item))\n-        } else {\n-            false\n-        }\n-    }\n-\n     pub fn is_foreign_item(&self, id: DefIndex) -> bool {\n         match self.entry(id).kind {\n             EntryKind::ForeignImmStatic |"}, {"sha": "9519e4425b34b50a95208cd188ae41b75f9b099f", "filename": "src/librustc_trans/base.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc_trans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fb24c18ab669e9ee9f8f4bef8541bd90653ea33/src%2Flibrustc_trans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fbase.rs?ref=3fb24c18ab669e9ee9f8f4bef8541bd90653ea33", "patch": "@@ -35,6 +35,7 @@ use back::link;\n use back::linker::LinkerInfo;\n use llvm::{Linkage, ValueRef, Vector, get_param};\n use llvm;\n+use rustc::hir::def::Def;\n use rustc::hir::def_id::DefId;\n use middle::lang_items::{LangItem, ExchangeMallocFnLangItem, StartFnLangItem};\n use rustc::ty::subst::Substs;\n@@ -1716,8 +1717,21 @@ pub fn trans_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     // `reachable_symbols` list later on so it should be ok.\n     for cnum in sess.cstore.crates() {\n         let syms = sess.cstore.reachable_ids(cnum);\n-        reachable_symbols.extend(syms.into_iter().filter(|did| {\n-            sess.cstore.is_extern_item(shared_ccx.tcx(), *did)\n+        reachable_symbols.extend(syms.into_iter().filter(|&def_id| {\n+            let applicable = match sess.cstore.describe_def(def_id) {\n+                Some(Def::Static(..)) => true,\n+                Some(Def::Fn(_)) => {\n+                    shared_ccx.tcx().lookup_generics(def_id).types.is_empty()\n+                }\n+                _ => false\n+            };\n+\n+            if applicable {\n+                let attrs = shared_ccx.tcx().get_attrs(def_id);\n+                attr::contains_extern_indicator(sess.diagnostic(), &attrs)\n+            } else {\n+                false\n+            }\n         }).map(|did| {\n             symbol_for_def_id(did, &shared_ccx, &symbol_map)\n         }));"}]}