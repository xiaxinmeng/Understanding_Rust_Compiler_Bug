{"sha": "995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk5NWE5MjgxNGZmZGEyZTljNGI0NjM5MmM2MjkzYmJkY2U0YjNjYzE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-06T14:46:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-06T14:46:03Z"}, "message": "Merge #3490\n\n3490: Support aliases and Self in struct literals r=matklad a=flodiebold\n\nFixes #3306.\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>", "tree": {"sha": "384f143b6f5454a6ff515ab387b2fc1a9d44bf29", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/384f143b6f5454a6ff515ab387b2fc1a9d44bf29"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeYmIrCRBK7hj4Ov3rIwAAdHIIAHSVW2xMHGxaQCOY6V0dLDaP\nArGXlzxioU4G6UUhydgwv4wTAGKy2WRIHdPm82ecxALThdTJ9+NJ8xwKnT6dta86\nO1Vto16a7v0CO0EMbp3sef3zbssg4QGo9F9LmNELBzx59ZUTkJaqpnVDOApz1hQd\nc8Zzz8haehdSU9fuNFZGFM9wEmcO4OD+n708WkD8UrvVd6w8b/cLrzQV6KKAx3R6\nSVQq0lt2iCQQj9WtQDOZxUCsanIk/N8fE0bdc93IvtTgjP5ERNw5w3owV4FHdjTo\nQkXgF2mxsjJ5BFj8Wi1PXWgs/q4t4ifnJC3cpmzDuXh1IuNj94C6yjrmQ4cNshc=\n=X3gj\n-----END PGP SIGNATURE-----\n", "payload": "tree 384f143b6f5454a6ff515ab387b2fc1a9d44bf29\nparent 13879afdd58f7cd9fe34843c5b09ba9c22de1e77\nparent 073a1ef834be5e2e1ae6733c6c299d2ae68050d8\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1583505963 +0000\ncommitter GitHub <noreply@github.com> 1583505963 +0000\n\nMerge #3490\n\n3490: Support aliases and Self in struct literals r=matklad a=flodiebold\n\nFixes #3306.\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "html_url": "https://github.com/rust-lang/rust/commit/995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "13879afdd58f7cd9fe34843c5b09ba9c22de1e77", "url": "https://api.github.com/repos/rust-lang/rust/commits/13879afdd58f7cd9fe34843c5b09ba9c22de1e77", "html_url": "https://github.com/rust-lang/rust/commit/13879afdd58f7cd9fe34843c5b09ba9c22de1e77"}, {"sha": "073a1ef834be5e2e1ae6733c6c299d2ae68050d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/073a1ef834be5e2e1ae6733c6c299d2ae68050d8", "html_url": "https://github.com/rust-lang/rust/commit/073a1ef834be5e2e1ae6733c6c299d2ae68050d8"}], "stats": {"total": 96, "additions": 95, "deletions": 1}, "files": [{"sha": "39f1442164b0aec22682e5f54b25438c4bef59a2", "filename": "crates/ra_hir_ty/src/infer.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/crates%2Fra_hir_ty%2Fsrc%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/crates%2Fra_hir_ty%2Fsrc%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Finfer.rs?ref=995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "patch": "@@ -425,7 +425,7 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n         let ctx = crate::lower::TyLoweringContext::new(self.db, &self.resolver);\n         // FIXME: this should resolve assoc items as well, see this example:\n         // https://play.rust-lang.org/?gist=087992e9e22495446c01c0d4e2d69521\n-        match resolver.resolve_path_in_type_ns_fully(self.db, path.mod_path()) {\n+        return match resolver.resolve_path_in_type_ns_fully(self.db, path.mod_path()) {\n             Some(TypeNs::AdtId(AdtId::StructId(strukt))) => {\n                 let substs = Ty::substs_from_path(&ctx, path, strukt.into());\n                 let ty = self.db.ty(strukt.into());\n@@ -438,7 +438,33 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                 let ty = self.insert_type_vars(ty.subst(&substs));\n                 (ty, Some(var.into()))\n             }\n+            Some(TypeNs::SelfType(impl_id)) => {\n+                let generics = crate::utils::generics(self.db, impl_id.into());\n+                let substs = Substs::type_params_for_generics(&generics);\n+                let ty = self.db.impl_self_ty(impl_id).subst(&substs);\n+                let variant = ty_variant(&ty);\n+                (ty, variant)\n+            }\n+            Some(TypeNs::TypeAliasId(it)) => {\n+                let substs = Substs::build_for_def(self.db, it)\n+                    .fill(std::iter::repeat_with(|| self.table.new_type_var()))\n+                    .build();\n+                let ty = self.db.ty(it.into()).subst(&substs);\n+                let variant = ty_variant(&ty);\n+                (ty, variant)\n+            }\n             Some(_) | None => (Ty::Unknown, None),\n+        };\n+\n+        fn ty_variant(ty: &Ty) -> Option<VariantId> {\n+            ty.as_adt().and_then(|(adt_id, _)| match adt_id {\n+                AdtId::StructId(s) => Some(VariantId::StructId(s)),\n+                AdtId::UnionId(u) => Some(VariantId::UnionId(u)),\n+                AdtId::EnumId(_) => {\n+                    // Error E0071, expected struct, variant or union type, found enum `Foo`\n+                    None\n+                }\n+            })\n         }\n     }\n "}, {"sha": "c140bd513014ad5bae680e6c000fbf08e1bf79f3", "filename": "crates/ra_hir_ty/src/tests/simple.rs", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fsimple.rs", "raw_url": "https://github.com/rust-lang/rust/raw/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fsimple.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fsimple.rs?ref=995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "patch": "@@ -50,6 +50,47 @@ fn test() {\n     assert_eq!(\"Nat\", type_at_pos(&db, pos));\n }\n \n+#[test]\n+fn self_in_struct_lit() {\n+    assert_snapshot!(infer(\n+        r#\"\n+//- /main.rs\n+struct S<T> { x: T }\n+\n+impl S<u32> {\n+    fn foo() {\n+        Self { x: 1 };\n+    }\n+}\n+\"#,\n+    ), @r###\"\n+    [63; 93) '{     ...     }': ()\n+    [73; 86) 'Self { x: 1 }': S<u32>\n+    [83; 84) '1': u32\n+    \"###);\n+}\n+\n+#[test]\n+fn type_alias_in_struct_lit() {\n+    assert_snapshot!(infer(\n+        r#\"\n+//- /main.rs\n+struct S<T> { x: T }\n+\n+type SS = S<u32>;\n+\n+fn foo() {\n+    SS { x: 1 };\n+}\n+\n+\"#,\n+    ), @r###\"\n+    [64; 84) '{     ...1 }; }': ()\n+    [70; 81) 'SS { x: 1 }': S<u32>\n+    [78; 79) '1': u32\n+    \"###);\n+}\n+\n #[test]\n fn infer_ranges() {\n     let (db, pos) = TestDB::with_position("}, {"sha": "a10e642dbac34190b0118167b1b98699d0b6c8d6", "filename": "crates/ra_ide/src/diagnostics.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/995a92814ffda2e9c4b46392c6293bbdce4b3cc1/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs?ref=995a92814ffda2e9c4b46392c6293bbdce4b3cc1", "patch": "@@ -472,6 +472,33 @@ mod tests {\n         check_apply_diagnostic_fix(before, after);\n     }\n \n+    #[test]\n+    fn test_fill_struct_fields_self() {\n+        let before = r\"\n+            struct TestStruct {\n+                one: i32,\n+            }\n+\n+            impl TestStruct {\n+                fn test_fn() {\n+                    let s = Self {};\n+                }\n+            }\n+        \";\n+        let after = r\"\n+            struct TestStruct {\n+                one: i32,\n+            }\n+\n+            impl TestStruct {\n+                fn test_fn() {\n+                    let s = Self { one: ()};\n+                }\n+            }\n+        \";\n+        check_apply_diagnostic_fix(before, after);\n+    }\n+\n     #[test]\n     fn test_fill_struct_fields_enum() {\n         let before = r\""}]}