{"sha": "e58270219fcb40e342d3f51ef140574960b21a67", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1ODI3MDIxOWZjYjQwZTM0MmQzZjUxZWYxNDA1NzQ5NjBiMjFhNjc=", "commit": {"author": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2013-10-31T23:44:25Z"}, "committer": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2013-11-03T03:55:23Z"}, "message": "fix cross-crate destructor inlining\n\nCloses #7793", "tree": {"sha": "e51df32ce2997274732e3af926a7ea78916d60c1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e51df32ce2997274732e3af926a7ea78916d60c1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e58270219fcb40e342d3f51ef140574960b21a67", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e58270219fcb40e342d3f51ef140574960b21a67", "html_url": "https://github.com/rust-lang/rust/commit/e58270219fcb40e342d3f51ef140574960b21a67", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e58270219fcb40e342d3f51ef140574960b21a67/comments", "author": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "committer": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2f62acaebbe2aa0962c0402d467310b2571ff4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2f62acaebbe2aa0962c0402d467310b2571ff4e", "html_url": "https://github.com/rust-lang/rust/commit/b2f62acaebbe2aa0962c0402d467310b2571ff4e"}], "stats": {"total": 53, "additions": 48, "deletions": 5}, "files": [{"sha": "c909afc74dd680787803806506f5120217470960", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e58270219fcb40e342d3f51ef140574960b21a67/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e58270219fcb40e342d3f51ef140574960b21a67/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=e58270219fcb40e342d3f51ef140574960b21a67", "patch": "@@ -521,16 +521,23 @@ pub fn get_res_dtor(ccx: @mut CrateContext,\n                     substs: &[ty::t])\n                  -> ValueRef {\n     let _icx = push_ctxt(\"trans_res_dtor\");\n+    let did = if did.crate != ast::LOCAL_CRATE {\n+        inline::maybe_instantiate_inline(ccx, did)\n+    } else {\n+        did\n+    };\n     if !substs.is_empty() {\n-        let did = if did.crate != ast::LOCAL_CRATE {\n-            inline::maybe_instantiate_inline(ccx, did)\n-        } else {\n-            did\n-        };\n         assert_eq!(did.crate, ast::LOCAL_CRATE);\n         let tsubsts = ty::substs {regions: ty::ErasedRegions,\n                                   self_ty: None,\n                                   tps: /*bad*/ substs.to_owned() };\n+\n+        // FIXME: #4252: Generic destructors with type bounds are broken.\n+        //\n+        // Since the vtables aren't passed to `monomorphic_fn` here, generic destructors with type\n+        // bounds are broken. Sadly, the `typeck` pass isn't outputting the necessary metadata\n+        // because it does so based on method calls present in the AST. Destructor calls are not yet\n+        // known about at that stage of compilation, since `trans` handles cleanups.\n         let (val, _) = monomorphize::monomorphic_fn(ccx,\n                                                     did,\n                                                     &tsubsts,"}, {"sha": "1e93cd6359167facd87ff01bb000e91e48fb1f03", "filename": "src/test/auxiliary/inline_dtor.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e58270219fcb40e342d3f51ef140574960b21a67/src%2Ftest%2Fauxiliary%2Finline_dtor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e58270219fcb40e342d3f51ef140574960b21a67/src%2Ftest%2Fauxiliary%2Finline_dtor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Finline_dtor.rs?ref=e58270219fcb40e342d3f51ef140574960b21a67", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[link(name=\"inline_dtor\", vers=\"0.1\")];\n+\n+pub struct Foo;\n+\n+impl Drop for Foo {\n+    #[inline]\n+    fn drop(&mut self) {}\n+}"}, {"sha": "73b7013742b2bf1e01f3ade399e634f8296b61ce", "filename": "src/test/run-pass/use_inline_dtor.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e58270219fcb40e342d3f51ef140574960b21a67/src%2Ftest%2Frun-pass%2Fuse_inline_dtor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e58270219fcb40e342d3f51ef140574960b21a67/src%2Ftest%2Frun-pass%2Fuse_inline_dtor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fuse_inline_dtor.rs?ref=e58270219fcb40e342d3f51ef140574960b21a67", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:inline_dtor.rs\n+// xfail-fast\n+\n+extern mod inline_dtor;\n+\n+fn main() {\n+    let _x = inline_dtor::Foo;\n+}"}]}