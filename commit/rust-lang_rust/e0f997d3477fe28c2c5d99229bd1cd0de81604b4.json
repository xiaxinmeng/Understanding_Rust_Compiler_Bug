{"sha": "e0f997d3477fe28c2c5d99229bd1cd0de81604b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwZjk5N2QzNDc3ZmUyOGMyYzVkOTkyMjliZDFjZDBkZTgxNjA0YjQ=", "commit": {"author": {"name": "Nick Platt", "email": "platt.nicholas@gmail.com", "date": "2016-04-14T02:10:42Z"}, "committer": {"name": "Nick Platt", "email": "platt.nicholas@gmail.com", "date": "2016-04-14T02:10:42Z"}, "message": "rustbuild: Verify sha256 of downloaded tarballs", "tree": {"sha": "4a53d33ea7087f2e81a830032545e3cbc40ac6cc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a53d33ea7087f2e81a830032545e3cbc40ac6cc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e0f997d3477fe28c2c5d99229bd1cd0de81604b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e0f997d3477fe28c2c5d99229bd1cd0de81604b4", "html_url": "https://github.com/rust-lang/rust/commit/e0f997d3477fe28c2c5d99229bd1cd0de81604b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e0f997d3477fe28c2c5d99229bd1cd0de81604b4/comments", "author": {"login": "caipre", "id": 295094, "node_id": "MDQ6VXNlcjI5NTA5NA==", "avatar_url": "https://avatars.githubusercontent.com/u/295094?v=4", "gravatar_id": "", "url": "https://api.github.com/users/caipre", "html_url": "https://github.com/caipre", "followers_url": "https://api.github.com/users/caipre/followers", "following_url": "https://api.github.com/users/caipre/following{/other_user}", "gists_url": "https://api.github.com/users/caipre/gists{/gist_id}", "starred_url": "https://api.github.com/users/caipre/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/caipre/subscriptions", "organizations_url": "https://api.github.com/users/caipre/orgs", "repos_url": "https://api.github.com/users/caipre/repos", "events_url": "https://api.github.com/users/caipre/events{/privacy}", "received_events_url": "https://api.github.com/users/caipre/received_events", "type": "User", "site_admin": false}, "committer": {"login": "caipre", "id": 295094, "node_id": "MDQ6VXNlcjI5NTA5NA==", "avatar_url": "https://avatars.githubusercontent.com/u/295094?v=4", "gravatar_id": "", "url": "https://api.github.com/users/caipre", "html_url": "https://github.com/caipre", "followers_url": "https://api.github.com/users/caipre/followers", "following_url": "https://api.github.com/users/caipre/following{/other_user}", "gists_url": "https://api.github.com/users/caipre/gists{/gist_id}", "starred_url": "https://api.github.com/users/caipre/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/caipre/subscriptions", "organizations_url": "https://api.github.com/users/caipre/orgs", "repos_url": "https://api.github.com/users/caipre/repos", "events_url": "https://api.github.com/users/caipre/events{/privacy}", "received_events_url": "https://api.github.com/users/caipre/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ffff91a8e8d1b29164db89019429a712feca4a18", "url": "https://api.github.com/repos/rust-lang/rust/commits/ffff91a8e8d1b29164db89019429a712feca4a18", "html_url": "https://github.com/rust-lang/rust/commit/ffff91a8e8d1b29164db89019429a712feca4a18"}], "stats": {"total": 31, "additions": 24, "deletions": 7}, "files": [{"sha": "84b8ad333c17a0aec301e718ba433830a6ebadd3", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 24, "deletions": 7, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e0f997d3477fe28c2c5d99229bd1cd0de81604b4/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/e0f997d3477fe28c2c5d99229bd1cd0de81604b4/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=e0f997d3477fe28c2c5d99229bd1cd0de81604b4", "patch": "@@ -10,6 +10,7 @@\n \n import argparse\n import contextlib\n+import hashlib\n import os\n import shutil\n import subprocess\n@@ -18,13 +19,29 @@\n \n def get(url, path, verbose=False):\n     print(\"downloading \" + url)\n-    # see http://serverfault.com/questions/301128/how-to-download\n-    if sys.platform == 'win32':\n-        run([\"PowerShell.exe\", \"/nologo\", \"-Command\",\n-             \"(New-Object System.Net.WebClient).DownloadFile('\" + url +\n-                \"', '\" + path + \"')\"], verbose=verbose)\n-    else:\n-        run([\"curl\", \"-o\", path, url], verbose=verbose)\n+    sha_url = url + \".sha256\"\n+    sha_path = path + \".sha256\"\n+    for _url, _path in ((url, path), (sha_url, sha_path)):\n+        # see http://serverfault.com/questions/301128/how-to-download\n+        if sys.platform == 'win32':\n+            run([\"PowerShell.exe\", \"/nologo\", \"-Command\",\n+                 \"(New-Object System.Net.WebClient)\"\n+                 \".DownloadFile('{}', '{}')\".format(_url, _path)],\n+                verbose=verbose)\n+        else:\n+            run([\"curl\", \"-o\", _path, _url], verbose=verbose)\n+    print(\"verifying \" + path)\n+    with open(path, \"rb\") as f:\n+        found = hashlib.sha256(f.read()).hexdigest()\n+    with open(sha_path, \"r\") as f:\n+        expected, _ = f.readline().split()\n+    if found != expected:\n+        err = (\"invalid checksum:\\n\"\n+               \"    found:    {}\\n\"\n+               \"    expected: {}\".format(found, expected))\n+        if verbose:\n+            raise RuntimeError(err)\n+        sys.exit(err)\n \n def unpack(tarball, dst, verbose=False, match=None):\n     print(\"extracting \" + tarball)"}]}