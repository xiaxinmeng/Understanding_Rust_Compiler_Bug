{"sha": "b35c04f7dc8febef216b17209d030bd239c19f2c", "node_id": "C_kwDOAAsO6NoAKGIzNWMwNGY3ZGM4ZmViZWYyMTZiMTcyMDlkMDMwYmQyMzljMTlmMmM", "commit": {"author": {"name": "Samuel E. Moelius III", "email": "sam@moeli.us", "date": "2022-04-23T00:05:18Z"}, "committer": {"name": "Samuel E. Moelius III", "email": "sam@moeli.us", "date": "2022-04-23T00:05:18Z"}, "message": "Extend `extra_unused_lifetimes` to handle impl lifetimes", "tree": {"sha": "e878abdf52e144224da3886397b39ec4c951088c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e878abdf52e144224da3886397b39ec4c951088c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b35c04f7dc8febef216b17209d030bd239c19f2c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b35c04f7dc8febef216b17209d030bd239c19f2c", "html_url": "https://github.com/rust-lang/rust/commit/b35c04f7dc8febef216b17209d030bd239c19f2c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b35c04f7dc8febef216b17209d030bd239c19f2c/comments", "author": {"login": "smoelius", "id": 35515885, "node_id": "MDQ6VXNlcjM1NTE1ODg1", "avatar_url": "https://avatars.githubusercontent.com/u/35515885?v=4", "gravatar_id": "", "url": "https://api.github.com/users/smoelius", "html_url": "https://github.com/smoelius", "followers_url": "https://api.github.com/users/smoelius/followers", "following_url": "https://api.github.com/users/smoelius/following{/other_user}", "gists_url": "https://api.github.com/users/smoelius/gists{/gist_id}", "starred_url": "https://api.github.com/users/smoelius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/smoelius/subscriptions", "organizations_url": "https://api.github.com/users/smoelius/orgs", "repos_url": "https://api.github.com/users/smoelius/repos", "events_url": "https://api.github.com/users/smoelius/events{/privacy}", "received_events_url": "https://api.github.com/users/smoelius/received_events", "type": "User", "site_admin": false}, "committer": {"login": "smoelius", "id": 35515885, "node_id": "MDQ6VXNlcjM1NTE1ODg1", "avatar_url": "https://avatars.githubusercontent.com/u/35515885?v=4", "gravatar_id": "", "url": "https://api.github.com/users/smoelius", "html_url": "https://github.com/smoelius", "followers_url": "https://api.github.com/users/smoelius/followers", "following_url": "https://api.github.com/users/smoelius/following{/other_user}", "gists_url": "https://api.github.com/users/smoelius/gists{/gist_id}", "starred_url": "https://api.github.com/users/smoelius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/smoelius/subscriptions", "organizations_url": "https://api.github.com/users/smoelius/orgs", "repos_url": "https://api.github.com/users/smoelius/repos", "events_url": "https://api.github.com/users/smoelius/events{/privacy}", "received_events_url": "https://api.github.com/users/smoelius/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed22428b7292db18f8e0b90e06b91a802c0bf647", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed22428b7292db18f8e0b90e06b91a802c0bf647", "html_url": "https://github.com/rust-lang/rust/commit/ed22428b7292db18f8e0b90e06b91a802c0bf647"}], "stats": {"total": 109, "additions": 97, "deletions": 12}, "files": [{"sha": "ec74b8606d9d9db2b0364bd69a58a80a8d109774", "filename": "clippy_lints/src/lifetimes.rs", "status": "modified", "additions": 58, "deletions": 7, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/clippy_lints%2Fsrc%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/clippy_lints%2Fsrc%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flifetimes.rs?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -1,16 +1,19 @@\n use clippy_utils::diagnostics::span_lint;\n use clippy_utils::trait_ref_of_method;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n+use rustc_hir::intravisit::nested_filter::{self as hir_nested_filter, NestedFilter};\n use rustc_hir::intravisit::{\n-    walk_fn_decl, walk_generic_param, walk_generics, walk_item, walk_param_bound, walk_poly_trait_ref, walk_ty, Visitor,\n+    walk_fn_decl, walk_generic_param, walk_generics, walk_impl_item_ref, walk_item, walk_param_bound,\n+    walk_poly_trait_ref, walk_trait_ref, walk_ty, Visitor,\n };\n use rustc_hir::FnRetTy::Return;\n use rustc_hir::{\n-    BareFnTy, BodyId, FnDecl, GenericArg, GenericBound, GenericParam, GenericParamKind, Generics, ImplItem,\n+    BareFnTy, BodyId, FnDecl, GenericArg, GenericBound, GenericParam, GenericParamKind, Generics, Impl, ImplItem,\n     ImplItemKind, Item, ItemKind, LangItem, Lifetime, LifetimeName, ParamName, PolyTraitRef, TraitBoundModifier,\n     TraitFn, TraitItem, TraitItemKind, Ty, TyKind, WhereClause, WherePredicate,\n };\n use rustc_lint::{LateContext, LateLintPass};\n+use rustc_middle::hir::nested_filter as mir_nested_filter;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n use rustc_span::symbol::{kw, Ident, Symbol};\n@@ -84,6 +87,8 @@ impl<'tcx> LateLintPass<'tcx> for Lifetimes {\n     fn check_item(&mut self, cx: &LateContext<'tcx>, item: &'tcx Item<'_>) {\n         if let ItemKind::Fn(ref sig, ref generics, id) = item.kind {\n             check_fn_inner(cx, sig.decl, Some(id), None, generics, item.span, true);\n+        } else if let ItemKind::Impl(ref impl_) = item.kind {\n+            report_extra_impl_lifetimes(cx, impl_);\n         }\n     }\n \n@@ -194,8 +199,7 @@ fn explicit_self_type<'tcx>(cx: &LateContext<'tcx>, func: &FnDecl<'tcx>, ident:\n             visitor.visit_ty(self_ty);\n \n             !visitor.all_lts().is_empty()\n-        }\n-        else {\n+        } else {\n             false\n         }\n     }\n@@ -481,11 +485,29 @@ fn has_where_lifetimes<'tcx>(cx: &LateContext<'tcx>, where_clause: &'tcx WhereCl\n     false\n }\n \n-struct LifetimeChecker {\n+struct LifetimeChecker<'cx, 'tcx, F> {\n+    cx: &'cx LateContext<'tcx>,\n     map: FxHashMap<Symbol, Span>,\n+    phantom: std::marker::PhantomData<F>,\n }\n \n-impl<'tcx> Visitor<'tcx> for LifetimeChecker {\n+impl<'cx, 'tcx, F> LifetimeChecker<'cx, 'tcx, F> {\n+    fn new(cx: &'cx LateContext<'tcx>, map: FxHashMap<Symbol, Span>) -> LifetimeChecker<'cx, 'tcx, F> {\n+        Self {\n+            cx,\n+            map,\n+            phantom: std::marker::PhantomData,\n+        }\n+    }\n+}\n+\n+impl<'cx, 'tcx, F> Visitor<'tcx> for LifetimeChecker<'cx, 'tcx, F>\n+where\n+    F: NestedFilter<'tcx>,\n+{\n+    type Map = rustc_middle::hir::map::Map<'tcx>;\n+    type NestedFilter = F;\n+\n     // for lifetimes as parameters of generics\n     fn visit_lifetime(&mut self, lifetime: &'tcx Lifetime) {\n         self.map.remove(&lifetime.name.ident().name);\n@@ -501,6 +523,10 @@ impl<'tcx> Visitor<'tcx> for LifetimeChecker {\n             walk_generic_param(self, param);\n         }\n     }\n+\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n+    }\n }\n \n fn report_extra_lifetimes<'tcx>(cx: &LateContext<'tcx>, func: &'tcx FnDecl<'_>, generics: &'tcx Generics<'_>) {\n@@ -512,7 +538,7 @@ fn report_extra_lifetimes<'tcx>(cx: &LateContext<'tcx>, func: &'tcx FnDecl<'_>,\n             _ => None,\n         })\n         .collect();\n-    let mut checker = LifetimeChecker { map: hs };\n+    let mut checker = LifetimeChecker::<hir_nested_filter::None>::new(cx, hs);\n \n     walk_generics(&mut checker, generics);\n     walk_fn_decl(&mut checker, func);\n@@ -527,6 +553,31 @@ fn report_extra_lifetimes<'tcx>(cx: &LateContext<'tcx>, func: &'tcx FnDecl<'_>,\n     }\n }\n \n+fn report_extra_impl_lifetimes<'tcx>(cx: &LateContext<'tcx>, impl_: &'tcx Impl<'_>) {\n+    let hs = impl_\n+        .generics\n+        .params\n+        .iter()\n+        .filter_map(|par| match par.kind {\n+            GenericParamKind::Lifetime { .. } => Some((par.name.ident().name, par.span)),\n+            _ => None,\n+        })\n+        .collect();\n+    let mut checker = LifetimeChecker::<mir_nested_filter::All>::new(cx, hs);\n+\n+    if let Some(ref trait_ref) = impl_.of_trait {\n+        walk_trait_ref(&mut checker, trait_ref);\n+    }\n+    walk_ty(&mut checker, impl_.self_ty);\n+    for item in impl_.items {\n+        walk_impl_item_ref(&mut checker, item);\n+    }\n+\n+    for &v in checker.map.values() {\n+        span_lint(cx, EXTRA_UNUSED_LIFETIMES, v, \"this lifetime isn't used in the impl\");\n+    }\n+}\n+\n struct BodyLifetimeChecker {\n     lifetimes_used_in_body: bool,\n }"}, {"sha": "c6298139601625392c47a5bd3614d3acd5ef1038", "filename": "tests/ui/crashes/ice-2865.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fcrashes%2Fice-2865.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fcrashes%2Fice-2865.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-2865.rs?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -1,4 +1,4 @@\n-#[allow(dead_code)]\n+#![allow(dead_code, clippy::extra_unused_lifetimes)]\n \n /// Test for https://github.com/rust-lang/rust-clippy/issues/2865\n "}, {"sha": "268ba86fc7aa80756b1aa151b1aff72949a4d75c", "filename": "tests/ui/crashes/ice-3151.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fcrashes%2Fice-3151.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fcrashes%2Fice-3151.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-3151.rs?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -1,4 +1,4 @@\n-/// Test for https://github.com/rust-lang/rust-clippy/issues/2865\n+/// Test for https://github.com/rust-lang/rust-clippy/issues/3151\n \n #[derive(Clone)]\n pub struct HashMap<V, S> {"}, {"sha": "69dc2f7965e10da7d182df5e6f0af4c6d5352a27", "filename": "tests/ui/extra_unused_lifetimes.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fextra_unused_lifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fextra_unused_lifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fextra_unused_lifetimes.rs?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -72,4 +72,20 @@ mod issue4291 {\n     }\n }\n \n+mod issue6437 {\n+    pub struct Scalar;\n+\n+    impl<'a> std::ops::AddAssign<&Scalar> for &mut Scalar {\n+        fn add_assign(&mut self, _rhs: &Scalar) {\n+            unimplemented!();\n+        }\n+    }\n+\n+    impl<'b> Scalar {\n+        pub fn something<'c>() -> Self {\n+            Self\n+        }\n+    }\n+}\n+\n fn main() {}"}, {"sha": "68f02c7ad0f48bb65d5d5ec08ed682950624ddaa", "filename": "tests/ui/extra_unused_lifetimes.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fextra_unused_lifetimes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fextra_unused_lifetimes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fextra_unused_lifetimes.stderr?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -24,5 +24,23 @@ error: this lifetime isn't used in the function definition\n LL |         fn unused_lt<'a>(x: u8) {}\n    |                      ^^\n \n-error: aborting due to 4 previous errors\n+error: this lifetime isn't used in the impl\n+  --> $DIR/extra_unused_lifetimes.rs:78:10\n+   |\n+LL |     impl<'a> std::ops::AddAssign<&Scalar> for &mut Scalar {\n+   |          ^^\n+\n+error: this lifetime isn't used in the impl\n+  --> $DIR/extra_unused_lifetimes.rs:84:10\n+   |\n+LL |     impl<'b> Scalar {\n+   |          ^^\n+\n+error: this lifetime isn't used in the function definition\n+  --> $DIR/extra_unused_lifetimes.rs:85:26\n+   |\n+LL |         pub fn something<'c>() -> Self {\n+   |                          ^^\n+\n+error: aborting due to 7 previous errors\n "}, {"sha": "aea52a852f987d6ab86d899240c9ed81cd3cddc3", "filename": "tests/ui/impl.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fimpl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fimpl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl.rs?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -1,4 +1,4 @@\n-#![allow(dead_code)]\n+#![allow(dead_code, clippy::extra_unused_lifetimes)]\n #![warn(clippy::multiple_inherent_impl)]\n \n struct MyStruct;"}, {"sha": "538927b18055a289c771f5cb1cfdc1ba9bfad531", "filename": "tests/ui/new_without_default.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fnew_without_default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35c04f7dc8febef216b17209d030bd239c19f2c/tests%2Fui%2Fnew_without_default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnew_without_default.rs?ref=b35c04f7dc8febef216b17209d030bd239c19f2c", "patch": "@@ -1,4 +1,4 @@\n-#![allow(dead_code, clippy::missing_safety_doc)]\n+#![allow(dead_code, clippy::missing_safety_doc, clippy::extra_unused_lifetimes)]\n #![warn(clippy::new_without_default)]\n \n pub struct Foo;"}]}