{"sha": "7697ce4560b7799f5fb7e48524b5a347ba893b4e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2OTdjZTQ1NjBiNzc5OWY1ZmI3ZTQ4NTI0YjVhMzQ3YmE4OTNiNGU=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-05-01T19:58:15Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-05-12T01:48:57Z"}, "message": "Recover from invalid `struct` item syntax\n\nParse unsupported \"default field const values\":\n\n```rust\nstruct S {\n    field: Type = const_val,\n}\n```\n\nRecover from small `:` typo and provide suggestion:\n\n```rust\nstruct S {\n    field; Type,\n    field2= Type,\n}\n```", "tree": {"sha": "b0b0ff87e0ac2fb1e7b72bafa3a03a10ddfcee6f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0b0ff87e0ac2fb1e7b72bafa3a03a10ddfcee6f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7697ce4560b7799f5fb7e48524b5a347ba893b4e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7697ce4560b7799f5fb7e48524b5a347ba893b4e", "html_url": "https://github.com/rust-lang/rust/commit/7697ce4560b7799f5fb7e48524b5a347ba893b4e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7697ce4560b7799f5fb7e48524b5a347ba893b4e/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "890803d3722b5cf8810ae1f49b4d9f062a87c927", "url": "https://api.github.com/repos/rust-lang/rust/commits/890803d3722b5cf8810ae1f49b4d9f062a87c927", "html_url": "https://github.com/rust-lang/rust/commit/890803d3722b5cf8810ae1f49b4d9f062a87c927"}], "stats": {"total": 208, "additions": 207, "deletions": 1}, "files": [{"sha": "b2b578f1ed44a41a1c84df1e42d8da5fb15a425b", "filename": "compiler/rustc_parse/src/parser/item.rs", "status": "modified", "additions": 45, "deletions": 1, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/7697ce4560b7799f5fb7e48524b5a347ba893b4e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7697ce4560b7799f5fb7e48524b5a347ba893b4e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs?ref=7697ce4560b7799f5fb7e48524b5a347ba893b4e", "patch": "@@ -1399,6 +1399,37 @@ impl<'a> Parser<'a> {\n         Ok(a_var)\n     }\n \n+    fn expect_field_ty_separator(&mut self) -> PResult<'a, ()> {\n+        if let Err(mut err) = self.expect(&token::Colon) {\n+            let sm = self.sess.source_map();\n+            let eq_typo = self.token.kind == token::Eq && self.look_ahead(1, |t| t.is_path_start());\n+            let semi_typo = self.token.kind == token::Semi\n+                && self.look_ahead(1, |t| {\n+                    t.is_path_start()\n+                    // We check that we are in a situation like `foo; bar` to avoid bad suggestions\n+                    // when there's no type and `;` was used instead of a comma.\n+                    && match (sm.lookup_line(self.token.span.hi()), sm.lookup_line(t.span.lo())) {\n+                        (Ok(l), Ok(r)) => l.line == r.line,\n+                        _ => true,\n+                    }\n+                });\n+            if eq_typo || semi_typo {\n+                self.bump();\n+                // Gracefully handle small typos.\n+                err.span_suggestion_short(\n+                    self.prev_token.span,\n+                    \"field names and their types are separated with `:`\",\n+                    \":\".to_string(),\n+                    Applicability::MachineApplicable,\n+                );\n+                err.emit();\n+            } else {\n+                return Err(err);\n+            }\n+        }\n+        Ok(())\n+    }\n+\n     /// Parses a structure field.\n     fn parse_name_and_ty(\n         &mut self,\n@@ -1408,8 +1439,21 @@ impl<'a> Parser<'a> {\n         attrs: Vec<Attribute>,\n     ) -> PResult<'a, FieldDef> {\n         let name = self.parse_field_ident(adt_ty, lo)?;\n-        self.expect(&token::Colon)?;\n+        self.expect_field_ty_separator()?;\n         let ty = self.parse_ty()?;\n+        if self.token.kind == token::Eq {\n+            self.bump();\n+            let const_expr = self.parse_anon_const_expr()?;\n+            let sp = ty.span.shrink_to_hi().to(const_expr.value.span);\n+            self.struct_span_err(sp, \"default values on `struct` fields aren't supported\")\n+                .span_suggestion(\n+                    sp,\n+                    \"remove this unsupported default value\",\n+                    String::new(),\n+                    Applicability::MachineApplicable,\n+                )\n+                .emit();\n+        }\n         Ok(FieldDef {\n             span: lo.to(self.prev_token.span),\n             ident: Some(name),"}, {"sha": "28191b82621fdc518dbaebb7fedffa30e480c28b", "filename": "src/test/ui/parser/struct-default-values-and-missing-field-separator.fixed", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/7697ce4560b7799f5fb7e48524b5a347ba893b4e/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/7697ce4560b7799f5fb7e48524b5a347ba893b4e/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.fixed?ref=7697ce4560b7799f5fb7e48524b5a347ba893b4e", "patch": "@@ -0,0 +1,35 @@\n+// run-rustfix\n+#![allow(dead_code)]\n+\n+enum E {\n+    A,\n+}\n+\n+struct S {\n+    field1: i32, //~ ERROR default values on `struct` fields aren't supported\n+    field2: E, //~ ERROR default values on `struct` fields aren't supported\n+    field3: i32, //~ ERROR default values on `struct` fields aren't supported\n+    field4: i32, //~ ERROR default values on `struct` fields aren't supported\n+    field5: E, //~ ERROR default values on `struct` fields aren't supported\n+    field6: E, //~ ERROR default values on `struct` fields aren't supported\n+}\n+\n+struct S1 {\n+    field1: i32, //~ ERROR expected `,`, or `}`, found `field2`\n+    field2: E, //~ ERROR expected `,`, or `}`, found `field3`\n+    field3: i32, //~ ERROR default values on `struct` fields aren't supported\n+    field4: i32, //~ ERROR default values on `struct` fields aren't supported\n+    field5: E, //~ ERROR default values on `struct` fields aren't supported\n+    field6: E, //~ ERROR default values on `struct` fields aren't supported\n+}\n+\n+struct S2 {\n+    field1 : i32, //~ ERROR expected `:`, found `=`\n+    field2: E, //~ ERROR expected `:`, found `;`\n+}\n+\n+const fn foo(_: i32) -> E {\n+    E::A\n+}\n+\n+fn main() {}"}, {"sha": "924cb08a990a56ea73d3a659b63a4736aca31861", "filename": "src/test/ui/parser/struct-default-values-and-missing-field-separator.rs", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/7697ce4560b7799f5fb7e48524b5a347ba893b4e/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7697ce4560b7799f5fb7e48524b5a347ba893b4e/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.rs?ref=7697ce4560b7799f5fb7e48524b5a347ba893b4e", "patch": "@@ -0,0 +1,35 @@\n+// run-rustfix\n+#![allow(dead_code)]\n+\n+enum E {\n+    A,\n+}\n+\n+struct S {\n+    field1: i32 = 42, //~ ERROR default values on `struct` fields aren't supported\n+    field2: E = E::A, //~ ERROR default values on `struct` fields aren't supported\n+    field3: i32 = 1 + 2, //~ ERROR default values on `struct` fields aren't supported\n+    field4: i32 = { 1 + 2 }, //~ ERROR default values on `struct` fields aren't supported\n+    field5: E = foo(42), //~ ERROR default values on `struct` fields aren't supported\n+    field6: E = { foo(42) }, //~ ERROR default values on `struct` fields aren't supported\n+}\n+\n+struct S1 {\n+    field1: i32 //~ ERROR expected `,`, or `}`, found `field2`\n+    field2: E //~ ERROR expected `,`, or `}`, found `field3`\n+    field3: i32 = 1 + 2, //~ ERROR default values on `struct` fields aren't supported\n+    field4: i32 = { 1 + 2 }, //~ ERROR default values on `struct` fields aren't supported\n+    field5: E = foo(42), //~ ERROR default values on `struct` fields aren't supported\n+    field6: E = { foo(42) }, //~ ERROR default values on `struct` fields aren't supported\n+}\n+\n+struct S2 {\n+    field1 = i32, //~ ERROR expected `:`, found `=`\n+    field2; E, //~ ERROR expected `:`, found `;`\n+}\n+\n+const fn foo(_: i32) -> E {\n+    E::A\n+}\n+\n+fn main() {}"}, {"sha": "7f16ebcfc3ace26b8c82a3dd1eadb84c1635254d", "filename": "src/test/ui/parser/struct-default-values-and-missing-field-separator.stderr", "status": "added", "additions": 92, "deletions": 0, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/7697ce4560b7799f5fb7e48524b5a347ba893b4e/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7697ce4560b7799f5fb7e48524b5a347ba893b4e/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fstruct-default-values-and-missing-field-separator.stderr?ref=7697ce4560b7799f5fb7e48524b5a347ba893b4e", "patch": "@@ -0,0 +1,92 @@\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:9:16\n+   |\n+LL |     field1: i32 = 42,\n+   |                ^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:10:14\n+   |\n+LL |     field2: E = E::A,\n+   |              ^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:11:16\n+   |\n+LL |     field3: i32 = 1 + 2,\n+   |                ^^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:12:16\n+   |\n+LL |     field4: i32 = { 1 + 2 },\n+   |                ^^^^^^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:13:14\n+   |\n+LL |     field5: E = foo(42),\n+   |              ^^^^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:14:14\n+   |\n+LL |     field6: E = { foo(42) },\n+   |              ^^^^^^^^^^^^^^ help: remove this unsupported default value\n+\n+error: expected `,`, or `}`, found `field2`\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:18:16\n+   |\n+LL |     field1: i32\n+   |                ^ help: try adding a comma: `,`\n+\n+error: expected `,`, or `}`, found `field3`\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:19:14\n+   |\n+LL |     field2: E\n+   |              ^ help: try adding a comma: `,`\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:20:16\n+   |\n+LL |     field3: i32 = 1 + 2,\n+   |                ^^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:21:16\n+   |\n+LL |     field4: i32 = { 1 + 2 },\n+   |                ^^^^^^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:22:14\n+   |\n+LL |     field5: E = foo(42),\n+   |              ^^^^^^^^^^ help: remove this unsupported default value\n+\n+error: default values on `struct` fields aren't supported\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:23:14\n+   |\n+LL |     field6: E = { foo(42) },\n+   |              ^^^^^^^^^^^^^^ help: remove this unsupported default value\n+\n+error: expected `:`, found `=`\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:27:12\n+   |\n+LL |     field1 = i32,\n+   |            ^\n+   |            |\n+   |            expected `:`\n+   |            help: field names and their types are separated with `:`\n+\n+error: expected `:`, found `;`\n+  --> $DIR/struct-default-values-and-missing-field-separator.rs:28:11\n+   |\n+LL |     field2; E,\n+   |           ^\n+   |           |\n+   |           expected `:`\n+   |           help: field names and their types are separated with `:`\n+\n+error: aborting due to 14 previous errors\n+"}]}