{"sha": "c61fee6d55c011e6f5eec29788101667ee62631c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2MWZlZTZkNTVjMDExZTZmNWVlYzI5Nzg4MTAxNjY3ZWU2MjYzMWM=", "commit": {"author": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2021-06-22T19:51:57Z"}, "committer": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2021-06-22T20:01:06Z"}, "message": "Fix compilation on WASM\n\nFixes #9214.\nFixes #9210.", "tree": {"sha": "c848d19087658a68772ce5b1f836a3d6c32a63b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c848d19087658a68772ce5b1f836a3d6c32a63b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c61fee6d55c011e6f5eec29788101667ee62631c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c61fee6d55c011e6f5eec29788101667ee62631c", "html_url": "https://github.com/rust-lang/rust/commit/c61fee6d55c011e6f5eec29788101667ee62631c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c61fee6d55c011e6f5eec29788101667ee62631c/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9b29573a4bfcecfcd3c48ada589f6129323a559c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b29573a4bfcecfcd3c48ada589f6129323a559c", "html_url": "https://github.com/rust-lang/rust/commit/9b29573a4bfcecfcd3c48ada589f6129323a559c"}], "stats": {"total": 31, "additions": 28, "deletions": 3}, "files": [{"sha": "222676d5e1a94692f11907dd8e748144ca142b90", "filename": ".github/workflows/ci.yaml", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c61fee6d55c011e6f5eec29788101667ee62631c/.github%2Fworkflows%2Fci.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/c61fee6d55c011e6f5eec29788101667ee62631c/.github%2Fworkflows%2Fci.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yaml?ref=c61fee6d55c011e6f5eec29788101667ee62631c", "patch": "@@ -66,6 +66,9 @@ jobs:\n \n     env:\n       targets: \"powerpc-unknown-linux-gnu x86_64-unknown-linux-musl\"\n+      # The rust-analyzer binary is not expected to compile on WASM, but the IDE\n+      # crate should\n+      targets_ide: \"wasm32-unknown-unknown\"\n \n     steps:\n     - name: Checkout repository\n@@ -79,7 +82,7 @@ jobs:\n         override: true\n \n     - name: Install Rust targets\n-      run: rustup target add ${{ env.targets }}\n+      run: rustup target add ${{ env.targets }} ${{ env.targets_ide }}\n \n     - name: Cache Dependencies\n       uses: Swatinem/rust-cache@ce325b60658c1b38465c06cc965b79baf32c1e72\n@@ -89,6 +92,9 @@ jobs:\n         for target in ${{ env.targets }}; do\n           cargo check --target=$target --all-targets\n         done\n+        for target in ${{ env.targets_ide }}; do\n+          cargo check -p ide --target=$target --all-targets\n+        done\n \n   typescript:\n     name: TypeScript"}, {"sha": "2963484faefc1e95c2d84732afb7e6ede99f5732", "filename": "crates/stdx/src/lib.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c61fee6d55c011e6f5eec29788101667ee62631c/crates%2Fstdx%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c61fee6d55c011e6f5eec29788101667ee62631c/crates%2Fstdx%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Flib.rs?ref=c61fee6d55c011e6f5eec29788101667ee62631c", "patch": "@@ -110,7 +110,7 @@ pub fn defer<F: FnOnce()>(f: F) -> impl Drop {\n     D(Some(f))\n }\n \n-#[repr(transparent)]\n+#[cfg_attr(not(target_arch = \"wasm32\"), repr(transparent))]\n pub struct JodChild(pub std::process::Child);\n \n impl ops::Deref for JodChild {\n@@ -135,7 +135,10 @@ impl Drop for JodChild {\n \n impl JodChild {\n     pub fn into_inner(self) -> std::process::Child {\n-        // SAFETY: repr transparent\n+        if cfg!(target_arch = \"wasm32\") {\n+            panic!(\"no processes on wasm\");\n+        }\n+        // SAFETY: repr transparent, except on WASM\n         unsafe { std::mem::transmute::<JodChild, std::process::Child>(self) }\n     }\n }"}, {"sha": "b290ba2f058272ce0f2ffd940251c8ecd975eb0c", "filename": "crates/stdx/src/process.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c61fee6d55c011e6f5eec29788101667ee62631c/crates%2Fstdx%2Fsrc%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c61fee6d55c011e6f5eec29788101667ee62631c/crates%2Fstdx%2Fsrc%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Fprocess.rs?ref=c61fee6d55c011e6f5eec29788101667ee62631c", "patch": "@@ -236,3 +236,19 @@ mod imp {\n         slice::from_raw_parts_mut(v.as_mut_ptr().add(v.len()), v.capacity() - v.len())\n     }\n }\n+\n+#[cfg(target_arch = \"wasm32\")]\n+mod imp {\n+    use std::{\n+        io,\n+        process::{ChildStderr, ChildStdout},\n+    };\n+\n+    pub(crate) fn read2(\n+        _out_pipe: ChildStdout,\n+        _err_pipe: ChildStderr,\n+        _data: &mut dyn FnMut(bool, &mut Vec<u8>, bool),\n+    ) -> io::Result<()> {\n+        panic!(\"no processes on wasm\")\n+    }\n+}"}]}