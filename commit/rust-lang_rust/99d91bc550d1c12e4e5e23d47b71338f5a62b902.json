{"sha": "99d91bc550d1c12e4e5e23d47b71338f5a62b902", "node_id": "C_kwDOAAsO6NoAKDk5ZDkxYmM1NTBkMWMxMmU0ZTVlMjNkNDdiNzEzMzhmNWE2MmI5MDI", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-04-07T18:02:33Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-04-07T18:02:33Z"}, "message": "flyimport: omit types when completing where-clause", "tree": {"sha": "e048dda89549542f73559dd81f777515802819d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e048dda89549542f73559dd81f777515802819d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/99d91bc550d1c12e4e5e23d47b71338f5a62b902", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/99d91bc550d1c12e4e5e23d47b71338f5a62b902", "html_url": "https://github.com/rust-lang/rust/commit/99d91bc550d1c12e4e5e23d47b71338f5a62b902", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/99d91bc550d1c12e4e5e23d47b71338f5a62b902/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b", "html_url": "https://github.com/rust-lang/rust/commit/b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b"}], "stats": {"total": 30, "additions": 28, "deletions": 2}, "files": [{"sha": "fb857aeccda19052826532d62c0ef87ccc297d0d", "filename": "crates/ide_completion/src/completions/flyimport.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/99d91bc550d1c12e4e5e23d47b71338f5a62b902/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99d91bc550d1c12e4e5e23d47b71338f5a62b902/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fflyimport.rs?ref=99d91bc550d1c12e4e5e23d47b71338f5a62b902", "patch": "@@ -1,5 +1,5 @@\n //! See [`import_on_the_fly`].\n-use hir::ItemInNs;\n+use hir::{ItemInNs, ModuleDef};\n use ide_db::imports::{\n     import_assets::{ImportAssets, ImportCandidate, LocatedImport},\n     insert_use::ImportScope,\n@@ -9,6 +9,7 @@ use syntax::{AstNode, SyntaxNode, T};\n \n use crate::{\n     context::{CompletionContext, PathKind},\n+    patterns::ImmediateLocation,\n     render::{render_resolution_with_import, RenderContext},\n };\n \n@@ -170,7 +171,13 @@ pub(crate) fn import_on_the_fly(acc: &mut Completions, ctx: &CompletionContext)\n             (PathKind::Pat, ItemInNs::Types(_)) => true,\n             (PathKind::Pat, ItemInNs::Values(def)) => matches!(def, hir::ModuleDef::Const(_)),\n \n-            (PathKind::Type, ItemInNs::Types(_)) => true,\n+            (PathKind::Type, ItemInNs::Types(ty)) => {\n+                if matches!(ctx.completion_location, Some(ImmediateLocation::TypeBound)) {\n+                    matches!(ty, ModuleDef::Trait(_))\n+                } else {\n+                    true\n+                }\n+            }\n             (PathKind::Type, ItemInNs::Values(_)) => false,\n \n             (PathKind::Attr { .. }, ItemInNs::Macros(mac)) => mac.is_attr(ctx.db),"}, {"sha": "41e6cf7aeeb06c3949dfddb79dce861ab8bb1938", "filename": "crates/ide_completion/src/tests/flyimport.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/99d91bc550d1c12e4e5e23d47b71338f5a62b902/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99d91bc550d1c12e4e5e23d47b71338f5a62b902/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=99d91bc550d1c12e4e5e23d47b71338f5a62b902", "patch": "@@ -1170,3 +1170,22 @@ struct Foo;\n \"#,\n     );\n }\n+\n+#[test]\n+fn flyimport_in_type_bound_omits_types() {\n+    check(\n+        r#\"\n+mod module {\n+    pub struct CompletemeStruct;\n+    pub type CompletemeType = ();\n+    pub enum CompletemeEnum {}\n+    pub trait CompletemeTrait {}\n+}\n+\n+fn f<T>() where T: Comp$0\n+\"#,\n+        expect![[r#\"\n+            tt CompletemeTrait (use module::CompletemeTrait)\n+        \"#]],\n+    );\n+}"}]}