{"sha": "988153cc2662eae41a6f779484ec65f0edba3716", "node_id": "C_kwDOAAsO6NoAKDk4ODE1M2NjMjY2MmVhZTQxYTZmNzc5NDg0ZWM2NWYwZWRiYTM3MTY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-10-22T10:58:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-22T10:58:07Z"}, "message": "Rollup merge of #103190 - fmease:rustdoc-render-bounds-of-cross-crate-gat-params, r=GuillaumeGomez\n\nrustdoc: render bounds of cross-crate GAT params\n\nFollow-up to #102439.\nRender the trait bounds of type parameters of cross-crate (generic) associated types.\n\n`````@rustbot````` label T-rustdoc A-cross-crate-reexports\nr? `````@GuillaumeGomez`````", "tree": {"sha": "ecaa40a41a270710cc8bd93206d6f0b4aa5b238a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ecaa40a41a270710cc8bd93206d6f0b4aa5b238a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/988153cc2662eae41a6f779484ec65f0edba3716", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjU8y/CRBK7hj4Ov3rIwAArd4IABCx82Vm3Uql/TV5l0m5+JfT\nsHs6JhQTSlZ+c0swUCK3Px/MjEfhWYLX7nggCmKkFRXV/plEBZUk+3JfTwBDNUqX\ne0O8jhALiSigFcpfaG8N/xaMUynP9liHNhrNERTDm4MYg5UhBTqbAnCOJZjCHOzD\n3EWZNGurdmk6TFJWpj9xND00G6rJAFKc2oqN4GkuFHf9wEk8C0p1hzEcEQBKJzx1\ndRdYVtdnkSmzAN0SZg7bmhiZc00/8fLIZ7RKCyiUoSPorcMsTgttHVXhOFExXTpu\nvr5O+CoXDkxm7eoVjzwZmQqiSK/p4CauBofAKYdE6j/y5seSw1mylt7EonBqKPk=\n=mMy8\n-----END PGP SIGNATURE-----\n", "payload": "tree ecaa40a41a270710cc8bd93206d6f0b4aa5b238a\nparent 16c3b6479458726c24faf9ff00d52b90cb25ce74\nparent 2cc4a0aad72752a4d485ced76bab677620f088b8\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1666436287 +0530\ncommitter GitHub <noreply@github.com> 1666436287 +0530\n\nRollup merge of #103190 - fmease:rustdoc-render-bounds-of-cross-crate-gat-params, r=GuillaumeGomez\n\nrustdoc: render bounds of cross-crate GAT params\n\nFollow-up to #102439.\nRender the trait bounds of type parameters of cross-crate (generic) associated types.\n\n`````@rustbot````` label T-rustdoc A-cross-crate-reexports\nr? `````@GuillaumeGomez`````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/988153cc2662eae41a6f779484ec65f0edba3716", "html_url": "https://github.com/rust-lang/rust/commit/988153cc2662eae41a6f779484ec65f0edba3716", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/988153cc2662eae41a6f779484ec65f0edba3716/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "16c3b6479458726c24faf9ff00d52b90cb25ce74", "url": "https://api.github.com/repos/rust-lang/rust/commits/16c3b6479458726c24faf9ff00d52b90cb25ce74", "html_url": "https://github.com/rust-lang/rust/commit/16c3b6479458726c24faf9ff00d52b90cb25ce74"}, {"sha": "2cc4a0aad72752a4d485ced76bab677620f088b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/2cc4a0aad72752a4d485ced76bab677620f088b8", "html_url": "https://github.com/rust-lang/rust/commit/2cc4a0aad72752a4d485ced76bab677620f088b8"}], "stats": {"total": 63, "additions": 41, "deletions": 22}, "files": [{"sha": "13d63ffa0ee3cc18163b9b6dd7fb8a5f71ae0712", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 30, "deletions": 14, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/988153cc2662eae41a6f779484ec65f0edba3716/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/988153cc2662eae41a6f779484ec65f0edba3716/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=988153cc2662eae41a6f779484ec65f0edba3716", "patch": "@@ -1201,21 +1201,19 @@ pub(crate) fn clean_middle_assoc_item<'tcx>(\n             }\n \n             if let ty::TraitContainer = assoc_item.container {\n-                // FIXME(fmease): `tcx.explicit_item_bounds` does not contain the bounds of GATs,\n-                //                e.g. the bounds `Copy`, `Display` & (implicitly) `Sized` in\n-                //                `type Assoc<T: Copy> where T: Display`. This also means that we\n-                //                later incorrectly render `where T: ?Sized`.\n-                //\n-                //                The result of `tcx.explicit_predicates_of` *does* contain them but\n-                //                it does not contain the other bounds / predicates we need.\n-                //                Either merge those two interned lists somehow or refactor\n-                //                `clean_ty_generics` to call `explicit_item_bounds` by itself.\n                 let bounds = tcx.explicit_item_bounds(assoc_item.def_id);\n-                let predicates = ty::GenericPredicates { parent: None, predicates: bounds };\n-                let mut generics =\n-                    clean_ty_generics(cx, tcx.generics_of(assoc_item.def_id), predicates);\n-                // Filter out the bounds that are (likely?) directly attached to the associated type,\n-                // as opposed to being located in the where clause.\n+                let predicates = tcx.explicit_predicates_of(assoc_item.def_id).predicates;\n+                let predicates =\n+                    tcx.arena.alloc_from_iter(bounds.into_iter().chain(predicates).copied());\n+                let mut generics = clean_ty_generics(\n+                    cx,\n+                    tcx.generics_of(assoc_item.def_id),\n+                    ty::GenericPredicates { parent: None, predicates },\n+                );\n+                // Move bounds that are (likely) directly attached to the associated type\n+                // from the where clause to the associated type.\n+                // There is no guarantee that this is what the user actually wrote but we have\n+                // no way of knowing.\n                 let mut bounds = generics\n                     .where_predicates\n                     .drain_filter(|pred| match *pred {\n@@ -1273,6 +1271,24 @@ pub(crate) fn clean_middle_assoc_item<'tcx>(\n                     }\n                     None => bounds.push(GenericBound::maybe_sized(cx)),\n                 }\n+                // Move bounds that are (likely) directly attached to the parameters of the\n+                // (generic) associated type from the where clause to the respective parameter.\n+                // There is no guarantee that this is what the user actually wrote but we have\n+                // no way of knowing.\n+                let mut where_predicates = Vec::new();\n+                for mut pred in generics.where_predicates {\n+                    if let WherePredicate::BoundPredicate { ty: Generic(arg), bounds, .. } = &mut pred\n+                    && let Some(GenericParamDef {\n+                        kind: GenericParamDefKind::Type { bounds: param_bounds, .. },\n+                        ..\n+                    }) = generics.params.iter_mut().find(|param| &param.name == arg)\n+                    {\n+                        param_bounds.extend(mem::take(bounds));\n+                    } else {\n+                        where_predicates.push(pred);\n+                    }\n+                }\n+                generics.where_predicates = where_predicates;\n \n                 if tcx.impl_defaultness(assoc_item.def_id).has_value() {\n                     AssocTypeItem("}, {"sha": "8934bc1ee339cb92742f33da4edeb3e2a088d148", "filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds.out0.html", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out0.html", "raw_url": "https://github.com/rust-lang/rust/raw/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out0.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out0.html?ref=988153cc2662eae41a6f779484ec65f0edba3716", "patch": "@@ -0,0 +1 @@\n+<h4 class=\"code-header\">type <a href=\"#associatedtype.Out0\" class=\"associatedtype\">Out0</a>: <a class=\"trait\" href=\"../assoc_item_trait_bounds/trait.Support.html\" title=\"trait assoc_item_trait_bounds::Support\">Support</a>&lt;Item = <a class=\"primitive\" href=\"{{channel}}/std/primitive.unit.html\">()</a>&gt;</h4>\n\\ No newline at end of file"}, {"sha": "bf330670ed0fa596839ac4eafd6b6bd1725b9bca", "filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds.out2.html", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out2.html", "raw_url": "https://github.com/rust-lang/rust/raw/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out2.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out2.html?ref=988153cc2662eae41a6f779484ec65f0edba3716", "patch": "@@ -0,0 +1 @@\n+<h4 class=\"code-header\">type <a href=\"#associatedtype.Out2\" class=\"associatedtype\">Out2</a>&lt;T&gt;: <a class=\"trait\" href=\"../assoc_item_trait_bounds/trait.Support.html\" title=\"trait assoc_item_trait_bounds::Support\">Support</a>&lt;Item = T&gt;</h4>\n\\ No newline at end of file"}, {"sha": "69d84e1b2c14e88ab373bb4989caa78b30f5d209", "filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds.out9.html", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out9.html", "raw_url": "https://github.com/rust-lang/rust/raw/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out9.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.out9.html?ref=988153cc2662eae41a6f779484ec65f0edba3716", "previous_filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds_with_bindings.out9.html"}, {"sha": "5f4712aab5b19efd916b9d240885f7144346dda1", "filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds.rs", "status": "renamed", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds.rs?ref=988153cc2662eae41a6f779484ec65f0edba3716", "patch": "@@ -1,13 +1,10 @@\n // Regression test for issues #77763, #84579 and #102142.\n #![crate_name = \"main\"]\n \n-// aux-build:assoc_item_trait_bounds_with_bindings.rs\n+// aux-build:assoc_item_trait_bounds.rs\n // build-aux-docs\n // ignore-cross-compile\n-extern crate assoc_item_trait_bounds_with_bindings as aux;\n-\n-// FIXME(fmease): Don't render an incorrect `T: ?Sized` where-clause for parameters\n-//                of GATs like `Main::Out{2,4}`. Add a snapshot test once it's fixed.\n+extern crate assoc_item_trait_bounds as aux;\n \n // @has main/trait.Main.html\n // @has - '//*[@id=\"associatedtype.Out0\"]' 'type Out0: Support<Item = ()>'\n@@ -24,11 +21,15 @@ extern crate assoc_item_trait_bounds_with_bindings as aux;\n // @has - '//*[@id=\"associatedtype.Out11\"]' \"type Out11: for<'r, 's> Helper<A<'s> = &'s (), B<'r> = ()>\"\n // @has - '//*[@id=\"associatedtype.Out12\"]' \"type Out12: for<'w> Helper<B<'w> = Cow<'w, str>, A<'w> = bool>\"\n // @has - '//*[@id=\"associatedtype.Out13\"]' \"type Out13: for<'fst, 'snd> Aid<'snd, Result<'fst> = &'fst mut str>\"\n+// @has - '//*[@id=\"associatedtype.Out14\"]' \"type Out14<P: Copy + Eq, Q: ?Sized>\"\n //\n-// Snapshots: Check that we do not render any where-clauses for those associated types since all of\n-// the trait bounds contained within were moved to the bounds of the respective item.\n+// Snapshots:\n+// Check that we don't render any where-clauses for the following associated types since\n+// all corresponding projection equality predicates should have already been re-sugared\n+// to associated type bindings:\n //\n // @snapshot out0 - '//*[@id=\"associatedtype.Out0\"]/*[@class=\"code-header\"]'\n+// @snapshot out2 - '//*[@id=\"associatedtype.Out2\"]/*[@class=\"code-header\"]'\n // @snapshot out9 - '//*[@id=\"associatedtype.Out9\"]/*[@class=\"code-header\"]'\n //\n // @has - '//*[@id=\"tymethod.make\"]' \\", "previous_filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds_with_bindings.rs"}, {"sha": "927a1a42a1f784bf77870265537784d3c59284c2", "filename": "src/test/rustdoc/inline_cross/assoc_item_trait_bounds_with_bindings.out0.html", "status": "removed", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/16c3b6479458726c24faf9ff00d52b90cb25ce74/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds_with_bindings.out0.html", "raw_url": "https://github.com/rust-lang/rust/raw/16c3b6479458726c24faf9ff00d52b90cb25ce74/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds_with_bindings.out0.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fassoc_item_trait_bounds_with_bindings.out0.html?ref=16c3b6479458726c24faf9ff00d52b90cb25ce74", "patch": "@@ -1 +0,0 @@\n-<h4 class=\"code-header\">type <a href=\"#associatedtype.Out0\" class=\"associatedtype\">Out0</a>: <a class=\"trait\" href=\"../assoc_item_trait_bounds_with_bindings/trait.Support.html\" title=\"trait assoc_item_trait_bounds_with_bindings::Support\">Support</a>&lt;Item = <a class=\"primitive\" href=\"{{channel}}/std/primitive.unit.html\">()</a>&gt;</h4>\n\\ No newline at end of file"}, {"sha": "d326e61daea2608c0835d8474e4d59c8bdec5a7c", "filename": "src/test/rustdoc/inline_cross/auxiliary/assoc_item_trait_bounds.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fassoc_item_trait_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/988153cc2662eae41a6f779484ec65f0edba3716/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fassoc_item_trait_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fassoc_item_trait_bounds.rs?ref=988153cc2662eae41a6f779484ec65f0edba3716", "patch": "@@ -15,6 +15,7 @@ pub trait Main {\n     type Out11: for<'r, 's> Helper<A<'s> = &'s (), B<'r> = ()>;\n     type Out12: for<'w> Helper<B<'w> = std::borrow::Cow<'w, str>, A<'w> = bool>;\n     type Out13: for<'fst, 'snd> Aid<'snd, Result<'fst> = &'fst mut str>;\n+    type Out14<P: Copy + Eq, Q: ?Sized>;\n \n     fn make<F>(_: F, _: impl FnMut(&str) -> bool)\n     where", "previous_filename": "src/test/rustdoc/inline_cross/auxiliary/assoc_item_trait_bounds_with_bindings.rs"}]}