{"sha": "7859a8e9a55725bd19636baa8d2a1a99b76689bf", "node_id": "C_kwDOAAsO6NoAKDc4NTlhOGU5YTU1NzI1YmQxOTYzNmJhYThkMmExYTk5Yjc2Njg5YmY", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-04-16T12:58:56Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-04-16T13:00:06Z"}, "message": "Don't use `serde_json` to serialize a simple JSON object\n\nThis avoids `rustc_data_structures` depending on `serde_json` which\nallows it to be compiled much earlier, unlocking most of rustc.", "tree": {"sha": "bfcdb0f3ccce7f573426a47faacd4e0390505a75", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfcdb0f3ccce7f573426a47faacd4e0390505a75"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7859a8e9a55725bd19636baa8d2a1a99b76689bf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7859a8e9a55725bd19636baa8d2a1a99b76689bf", "html_url": "https://github.com/rust-lang/rust/commit/7859a8e9a55725bd19636baa8d2a1a99b76689bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7859a8e9a55725bd19636baa8d2a1a99b76689bf/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e6e956dade79bdc084dfe3078abab24656a1b483", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6e956dade79bdc084dfe3078abab24656a1b483", "html_url": "https://github.com/rust-lang/rust/commit/e6e956dade79bdc084dfe3078abab24656a1b483"}], "stats": {"total": 62, "additions": 52, "deletions": 10}, "files": [{"sha": "df6f04259549fd499c630b408035bbdf68211724", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7859a8e9a55725bd19636baa8d2a1a99b76689bf/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/7859a8e9a55725bd19636baa8d2a1a99b76689bf/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=7859a8e9a55725bd19636baa8d2a1a99b76689bf", "patch": "@@ -4587,7 +4587,6 @@ dependencies = [\n  \"rustc_index\",\n  \"rustc_macros\",\n  \"rustc_serialize\",\n- \"serde_json\",\n  \"smallvec\",\n  \"stable_deref_trait\",\n  \"stacker\","}, {"sha": "39f4bc63c88d1accb807c874f7ddfac794c65bb1", "filename": "compiler/rustc_data_structures/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7859a8e9a55725bd19636baa8d2a1a99b76689bf/compiler%2Frustc_data_structures%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7859a8e9a55725bd19636baa8d2a1a99b76689bf/compiler%2Frustc_data_structures%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2FCargo.toml?ref=7859a8e9a55725bd19636baa8d2a1a99b76689bf", "patch": "@@ -21,7 +21,6 @@ rustc-hash = \"1.1.0\"\n rustc_index = { path = \"../rustc_index\", package = \"rustc_index\" }\n rustc_macros = { path = \"../rustc_macros\" }\n rustc_serialize = { path = \"../rustc_serialize\" }\n-serde_json = \"1.0.59\"\n smallvec = { version = \"1.8.1\", features = [\n     \"const_generics\",\n     \"union\","}, {"sha": "8fa1ac70a78c0533c395c2c1a5f981e8883eb9bf", "filename": "compiler/rustc_data_structures/src/profiling.rs", "status": "modified", "additions": 33, "deletions": 8, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/7859a8e9a55725bd19636baa8d2a1a99b76689bf/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7859a8e9a55725bd19636baa8d2a1a99b76689bf/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling.rs?ref=7859a8e9a55725bd19636baa8d2a1a99b76689bf", "patch": "@@ -87,6 +87,7 @@ use crate::fx::FxHashMap;\n use std::borrow::Borrow;\n use std::collections::hash_map::Entry;\n use std::error::Error;\n+use std::fmt::Display;\n use std::fs;\n use std::intrinsics::unlikely;\n use std::path::Path;\n@@ -97,7 +98,6 @@ use std::time::{Duration, Instant};\n pub use measureme::EventId;\n use measureme::{EventIdBuilder, Profiler, SerializableString, StringId};\n use parking_lot::RwLock;\n-use serde_json::json;\n use smallvec::SmallVec;\n \n bitflags::bitflags! {\n@@ -763,6 +763,31 @@ impl Drop for VerboseTimingGuard<'_> {\n     }\n }\n \n+struct JsonTimePassesEntry<'a> {\n+    pass: &'a str,\n+    time: f64,\n+    start_rss: Option<usize>,\n+    end_rss: Option<usize>,\n+}\n+\n+impl Display for JsonTimePassesEntry<'_> {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        let Self { pass: what, time, start_rss, end_rss } = self;\n+        write!(f, r#\"{{\"pass\":\"{what}\",\"time\":{time},\"rss_start\":\"#).unwrap();\n+        match start_rss {\n+            Some(rss) => write!(f, \"{rss}\")?,\n+            None => write!(f, \"null\")?,\n+        }\n+        write!(f, r#\",\"rss_end\":\"#)?;\n+        match end_rss {\n+            Some(rss) => write!(f, \"{rss}\")?,\n+            None => write!(f, \"null\")?,\n+        }\n+        write!(f, \"}}\")?;\n+        Ok(())\n+    }\n+}\n+\n pub fn print_time_passes_entry(\n     what: &str,\n     dur: Duration,\n@@ -772,13 +797,10 @@ pub fn print_time_passes_entry(\n ) {\n     match format {\n         TimePassesFormat::Json => {\n-            let json = json!({\n-                \"pass\": what,\n-                \"time\": dur.as_secs_f64(),\n-                \"rss_start\": start_rss,\n-                \"rss_end\": end_rss,\n-            });\n-            eprintln!(\"time: {json}\");\n+            let entry =\n+                JsonTimePassesEntry { pass: what, time: dur.as_secs_f64(), start_rss, end_rss };\n+\n+            eprintln!(r#\"time: {entry}\"#);\n             return;\n         }\n         TimePassesFormat::Text => (),\n@@ -894,3 +916,6 @@ cfg_if! {\n         }\n     }\n }\n+\n+#[cfg(test)]\n+mod tests;"}, {"sha": "2b09de085da061a752a1c9c0085e2f65082dc899", "filename": "compiler/rustc_data_structures/src/profiling/tests.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/7859a8e9a55725bd19636baa8d2a1a99b76689bf/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7859a8e9a55725bd19636baa8d2a1a99b76689bf/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling%2Ftests.rs?ref=7859a8e9a55725bd19636baa8d2a1a99b76689bf", "patch": "@@ -0,0 +1,19 @@\n+use super::JsonTimePassesEntry;\n+\n+#[test]\n+fn with_rss() {\n+    let entry =\n+        JsonTimePassesEntry { pass: \"typeck\", time: 56.1, start_rss: Some(10), end_rss: Some(20) };\n+\n+    assert_eq!(entry.to_string(), r#\"{\"pass\":\"typeck\",\"time\":56.1,\"rss_start\":10,\"rss_end\":20}\"#)\n+}\n+\n+#[test]\n+fn no_rss() {\n+    let entry = JsonTimePassesEntry { pass: \"typeck\", time: 56.1, start_rss: None, end_rss: None };\n+\n+    assert_eq!(\n+        entry.to_string(),\n+        r#\"{\"pass\":\"typeck\",\"time\":56.1,\"rss_start\":null,\"rss_end\":null}\"#\n+    )\n+}"}]}