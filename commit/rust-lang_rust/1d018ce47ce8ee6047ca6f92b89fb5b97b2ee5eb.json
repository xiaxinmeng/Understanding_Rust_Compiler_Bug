{"sha": "1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "node_id": "C_kwDOAAsO6NoAKDFkMDE4Y2U0N2NlOGVlNjA0N2NhNmY5MmI4OWZiNWI5N2IyZWU1ZWI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-08T14:10:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-08T14:10:12Z"}, "message": "Auto merge of #96770 - flip1995:fix-trait-type-in-bounds, r=cjgillot\n\nTrack if a where bound comes from a impl Trait desugar\n\nWith https://github.com/rust-lang/rust/pull/93803 `impl Trait` function arguments get desugared to hidden where bounds. However, Clippy needs to know if a bound was originally a `impl Trait` or an actual bound. This adds a field to the `WhereBoundPredicate` struct to keep track of this information during AST->HIR lowering.\n\nr? `@cjgillot`\n\ncc `@estebank` (as the reviewer of #93803)", "tree": {"sha": "b62fa30799236a09dd882e2e610f4b3302a0ad12", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b62fa30799236a09dd882e2e610f4b3302a0ad12"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "html_url": "https://github.com/rust-lang/rust/commit/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d0378953eebdfafd7ff150fe2ab46bc6c645b3f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d0378953eebdfafd7ff150fe2ab46bc6c645b3f", "html_url": "https://github.com/rust-lang/rust/commit/6d0378953eebdfafd7ff150fe2ab46bc6c645b3f"}, {"sha": "bca3d8a6b5f04fe2a6ca95ff22d07ee73ad80604", "url": "https://api.github.com/repos/rust-lang/rust/commits/bca3d8a6b5f04fe2a6ca95ff22d07ee73ad80604", "html_url": "https://github.com/rust-lang/rust/commit/bca3d8a6b5f04fe2a6ca95ff22d07ee73ad80604"}], "stats": {"total": 40, "additions": 14, "deletions": 26}, "files": [{"sha": "34d1555049da58bbe21e562bec1cd0b3c123a9a6", "filename": "clippy_lints/src/lib.register_nursery.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_nursery.rs?ref=1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "patch": "@@ -29,8 +29,6 @@ store.register_group(true, \"clippy::nursery\", Some(\"clippy_nursery\"), vec![\n     LintId::of(strings::STRING_LIT_AS_BYTES),\n     LintId::of(suspicious_operation_groupings::SUSPICIOUS_OPERATION_GROUPINGS),\n     LintId::of(trailing_empty_array::TRAILING_EMPTY_ARRAY),\n-    LintId::of(trait_bounds::TRAIT_DUPLICATION_IN_BOUNDS),\n-    LintId::of(trait_bounds::TYPE_REPETITION_IN_BOUNDS),\n     LintId::of(transmute::TRANSMUTE_UNDEFINED_REPR),\n     LintId::of(transmute::USELESS_TRANSMUTE),\n     LintId::of(use_self::USE_SELF),"}, {"sha": "63232fd41130538765c6b4f547c8c9ba7e9d9ab8", "filename": "clippy_lints/src/lib.register_pedantic.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Flib.register_pedantic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Flib.register_pedantic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_pedantic.rs?ref=1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "patch": "@@ -84,6 +84,8 @@ store.register_group(true, \"clippy::pedantic\", Some(\"clippy_pedantic\"), vec![\n     LintId::of(semicolon_if_nothing_returned::SEMICOLON_IF_NOTHING_RETURNED),\n     LintId::of(stable_sort_primitive::STABLE_SORT_PRIMITIVE),\n     LintId::of(strings::STRING_ADD_ASSIGN),\n+    LintId::of(trait_bounds::TRAIT_DUPLICATION_IN_BOUNDS),\n+    LintId::of(trait_bounds::TYPE_REPETITION_IN_BOUNDS),\n     LintId::of(transmute::TRANSMUTE_PTR_TO_PTR),\n     LintId::of(types::LINKEDLIST),\n     LintId::of(types::OPTION_OPTION),"}, {"sha": "51d5b510ab93053e155d1b6ec3cbb0ade5ceb101", "filename": "clippy_lints/src/lifetimes.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flifetimes.rs?ref=1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "patch": "@@ -9,8 +9,8 @@ use rustc_hir::intravisit::{\n use rustc_hir::FnRetTy::Return;\n use rustc_hir::{\n     BareFnTy, BodyId, FnDecl, GenericArg, GenericBound, GenericParam, GenericParamKind, Generics, Impl, ImplItem,\n-    ImplItemKind, Item, ItemKind, LangItem, Lifetime, LifetimeName, ParamName, PolyTraitRef, TraitBoundModifier,\n-    TraitFn, TraitItem, TraitItemKind, Ty, TyKind, WherePredicate,\n+    ImplItemKind, Item, ItemKind, LangItem, Lifetime, LifetimeName, ParamName, PolyTraitRef, PredicateOrigin,\n+    TraitBoundModifier, TraitFn, TraitItem, TraitItemKind, Ty, TyKind, WherePredicate,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::hir::nested_filter as middle_nested_filter;\n@@ -145,7 +145,7 @@ fn check_fn_inner<'tcx>(\n         .filter(|param| matches!(param.kind, GenericParamKind::Type { .. }));\n     for typ in types {\n         for pred in generics.bounds_for_param(cx.tcx.hir().local_def_id(typ.hir_id)) {\n-            if pred.in_where_clause {\n+            if pred.origin == PredicateOrigin::WhereClause {\n                 // has_where_lifetimes checked that this predicate contains no lifetime.\n                 continue;\n             }"}, {"sha": "911da3997ae451160af7106915e89e3a1243c093", "filename": "clippy_lints/src/trait_bounds.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Ftrait_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/clippy_lints%2Fsrc%2Ftrait_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftrait_bounds.rs?ref=1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "patch": "@@ -8,7 +8,8 @@ use rustc_data_structures::unhash::UnhashMap;\n use rustc_errors::Applicability;\n use rustc_hir::def::Res;\n use rustc_hir::{\n-    GenericBound, Generics, Item, ItemKind, Node, Path, PathSegment, QPath, TraitItem, Ty, TyKind, WherePredicate,\n+    GenericBound, Generics, Item, ItemKind, Node, Path, PathSegment, PredicateOrigin, QPath, TraitItem, Ty, TyKind,\n+    WherePredicate,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n@@ -35,7 +36,7 @@ declare_clippy_lint! {\n     /// ```\n     #[clippy::version = \"1.38.0\"]\n     pub TYPE_REPETITION_IN_BOUNDS,\n-    nursery,\n+    pedantic,\n     \"Types are repeated unnecessary in trait bounds use `+` instead of using `T: _, T: _`\"\n }\n \n@@ -65,7 +66,7 @@ declare_clippy_lint! {\n     /// ```\n     #[clippy::version = \"1.47.0\"]\n     pub TRAIT_DUPLICATION_IN_BOUNDS,\n-    nursery,\n+    pedantic,\n     \"Check if the same trait bounds are specified twice during a function declaration\"\n }\n \n@@ -95,6 +96,7 @@ impl<'tcx> LateLintPass<'tcx> for TraitBounds {\n         for predicate in item.generics.predicates {\n             if_chain! {\n                 if let WherePredicate::BoundPredicate(ref bound_predicate) = predicate;\n+                if bound_predicate.origin != PredicateOrigin::ImplTrait;\n                 if !bound_predicate.span.from_expansion();\n                 if let TyKind::Path(QPath::Resolved(_, Path { segments, .. })) = bound_predicate.bounded_ty.kind;\n                 if let Some(PathSegment {\n@@ -168,6 +170,7 @@ impl TraitBounds {\n         for bound in gen.predicates {\n             if_chain! {\n                 if let WherePredicate::BoundPredicate(ref p) = bound;\n+                if p.origin != PredicateOrigin::ImplTrait;\n                 if p.bounds.len() as u64 <= self.max_trait_bounds;\n                 if !p.span.from_expansion();\n                 if let Some(ref v) = map.insert(\n@@ -223,6 +226,7 @@ fn check_trait_bound_duplication(cx: &LateContext<'_>, gen: &'_ Generics<'_>) {\n     for predicate in gen.predicates {\n         if_chain! {\n             if let WherePredicate::BoundPredicate(ref bound_predicate) = predicate;\n+            if bound_predicate.origin != PredicateOrigin::ImplTrait;\n             if !bound_predicate.span.from_expansion();\n             if let TyKind::Path(QPath::Resolved(_, Path { segments, .. })) = bound_predicate.bounded_ty.kind;\n             if let Some(segment) = segments.first();"}, {"sha": "6f8c8e47dfbf1fe56589a06f80017513e69167e8", "filename": "tests/ui/trait_duplication_in_bounds.stderr", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/tests%2Fui%2Ftrait_duplication_in_bounds.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/tests%2Fui%2Ftrait_duplication_in_bounds.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftrait_duplication_in_bounds.stderr?ref=1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "patch": "@@ -67,13 +67,5 @@ LL |         Self: Iterator<Item = Foo>,\n    |\n    = help: consider removing this trait bound\n \n-error: this trait bound is already specified in the where clause\n-  --> $DIR/trait_duplication_in_bounds.rs:99:23\n-   |\n-LL | fn impl_trait(_: impl AsRef<str>, _: impl AsRef<str>) {}\n-   |                       ^^^^^^^^^^\n-   |\n-   = help: consider removing this trait bound\n-\n-error: aborting due to 9 previous errors\n+error: aborting due to 8 previous errors\n "}, {"sha": "148c19c7d0701dc2910de718d175a03122d26e03", "filename": "tests/ui/type_repetition_in_bounds.stderr", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/tests%2Fui%2Ftype_repetition_in_bounds.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb/tests%2Fui%2Ftype_repetition_in_bounds.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftype_repetition_in_bounds.stderr?ref=1d018ce47ce8ee6047ca6f92b89fb5b97b2ee5eb", "patch": "@@ -19,13 +19,5 @@ LL |     Self: Copy + Default + Ord,\n    |\n    = help: consider combining the bounds: `Self: Clone + Copy + Default + Ord`\n \n-error: this type has already been used as a bound predicate\n-  --> $DIR/type_repetition_in_bounds.rs:83:43\n-   |\n-LL | fn impl_trait(_: impl AsRef<str>, _: impl AsRef<str>) {}\n-   |                                           ^^^^^^^^^^\n-   |\n-   = help: consider combining the bounds: `impl AsRef<str>: AsRef<str> + AsRef<str>`\n-\n-error: aborting due to 3 previous errors\n+error: aborting due to 2 previous errors\n "}]}