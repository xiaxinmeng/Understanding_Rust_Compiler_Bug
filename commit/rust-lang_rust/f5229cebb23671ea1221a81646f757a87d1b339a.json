{"sha": "f5229cebb23671ea1221a81646f757a87d1b339a", "node_id": "C_kwDOAAsO6NoAKGY1MjI5Y2ViYjIzNjcxZWExMjIxYTgxNjQ2Zjc1N2E4N2QxYjMzOWE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-20T12:15:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-20T12:15:22Z"}, "message": "Auto merge of #12301 - harpsword:fix_for_crlf_cargo_range_map, r=jonas-schievink\n\nfix: calculate correct postion for Dos line ending in mapping rustc range to ls\u2026\n\nfix #12293", "tree": {"sha": "d3e1fd6c13568e5ea0bd429c90db4f4f1aeda4f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3e1fd6c13568e5ea0bd429c90db4f4f1aeda4f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f5229cebb23671ea1221a81646f757a87d1b339a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f5229cebb23671ea1221a81646f757a87d1b339a", "html_url": "https://github.com/rust-lang/rust/commit/f5229cebb23671ea1221a81646f757a87d1b339a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f5229cebb23671ea1221a81646f757a87d1b339a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "44be090f2eb185e94f64b38a51b51db30b1f9704", "url": "https://api.github.com/repos/rust-lang/rust/commits/44be090f2eb185e94f64b38a51b51db30b1f9704", "html_url": "https://github.com/rust-lang/rust/commit/44be090f2eb185e94f64b38a51b51db30b1f9704"}, {"sha": "dfae0a12efe4d4920782f1f808f56913097162e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfae0a12efe4d4920782f1f808f56913097162e9", "html_url": "https://github.com/rust-lang/rust/commit/dfae0a12efe4d4920782f1f808f56913097162e9"}], "stats": {"total": 27, "additions": 5, "deletions": 22}, "files": [{"sha": "aac8e9222d31f48283e9d26ba061eea666666bd8", "filename": "crates/rust-analyzer/src/diagnostics/to_proto.rs", "status": "modified", "additions": 5, "deletions": 22, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f5229cebb23671ea1221a81646f757a87d1b339a/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f5229cebb23671ea1221a81646f757a87d1b339a/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs?ref=f5229cebb23671ea1221a81646f757a87d1b339a", "patch": "@@ -3,18 +3,13 @@\n use std::collections::HashMap;\n \n use flycheck::{Applicability, DiagnosticLevel, DiagnosticSpan};\n-use ide::TextRange;\n use itertools::Itertools;\n use stdx::format_to;\n use vfs::{AbsPath, AbsPathBuf};\n \n use crate::{\n-    from_proto,\n-    global_state::GlobalStateSnapshot,\n-    line_index::OffsetEncoding,\n-    lsp_ext,\n-    to_proto::{self, url_from_abs_path},\n-    Result,\n+    global_state::GlobalStateSnapshot, line_index::OffsetEncoding, lsp_ext,\n+    to_proto::url_from_abs_path,\n };\n \n use super::{DiagnosticsMapConfig, Fix};\n@@ -70,28 +65,16 @@ fn location(\n     let file_name = resolve_path(config, workspace_root, &span.file_name);\n     let uri = url_from_abs_path(&file_name);\n \n-    let range = range(span, snap, &uri).unwrap_or_else(|_| {\n+    let range = {\n         let offset_encoding = snap.config.offset_encoding();\n         lsp_types::Range::new(\n             position(&offset_encoding, span, span.line_start, span.column_start),\n             position(&offset_encoding, span, span.line_end, span.column_end),\n         )\n-    });\n+    };\n     lsp_types::Location::new(uri, range)\n }\n \n-fn range(\n-    span: &DiagnosticSpan,\n-    snap: &GlobalStateSnapshot,\n-    uri: &lsp_types::Url,\n-) -> Result<lsp_types::Range> {\n-    let file_id = from_proto::file_id(snap, &uri)?;\n-    let line_index = snap.file_line_index(file_id)?;\n-    let range =\n-        to_proto::range(&line_index, TextRange::new(span.byte_start.into(), span.byte_end.into()));\n-    Ok(range)\n-}\n-\n fn position(\n     offset_encoding: &OffsetEncoding,\n     span: &DiagnosticSpan,\n@@ -103,7 +86,7 @@ fn position(\n     let mut true_column_offset = column_offset;\n     if let Some(line) = span.text.get(line_index) {\n         if line.text.chars().count() == line.text.len() {\n-            // all utf-8\n+            // all one byte utf-8 char\n             return lsp_types::Position {\n                 line: (line_offset as u32).saturating_sub(1),\n                 character: (column_offset as u32).saturating_sub(1),"}]}