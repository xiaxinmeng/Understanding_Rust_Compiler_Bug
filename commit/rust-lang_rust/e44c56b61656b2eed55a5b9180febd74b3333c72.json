{"sha": "e44c56b61656b2eed55a5b9180febd74b3333c72", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0NGM1NmI2MTY1NmIyZWVkNTVhNWI5MTgwZmViZDc0YjMzMzNjNzI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-07-08T09:55:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-08T09:55:27Z"}, "message": "Merge #9529\n\n9529: fix: Don't unify arrays with their elements r=flodiebold a=lnicola\n\nAddresses https://github.com/rust-analyzer/rust-analyzer/pull/9526#issuecomment-876206100.\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "d0893eead13eb5d401421b965f88aeeb33c6fd11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0893eead13eb5d401421b965f88aeeb33c6fd11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e44c56b61656b2eed55a5b9180febd74b3333c72", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg5suPCRBK7hj4Ov3rIwAAv1MIAAakyxaZvBljqxKMvIoJdH8Z\n3opoz5o0ZC6k+b/85FlT4hvCxRsw78lrv4ocYeU/KDC93bnDphJ36ZN+fo4t9pZP\nDrj0BeD1pKWgLg1JWF4b7fmg3Vw32v+x+gOVuLqTQi3MBW1gS28RGbIiQiEQCCRT\nCo92JjwM6t41g+2qcCoHIE3QHMJo/myszCRuRexRtpYptPpOeAVu2JqzJyA2giq7\nIfynSewKTgetlfLuGrn+SBul+xG4gJZnXnJPet8CRNHR6txcQEBIwfYrknLDBFan\n33iBsgYF0MZ2/aueWTx81DfP/A7HsgHUoDk/vnXDO2ohdWMg3e7YKnqtGysk6ZA=\n=IEjo\n-----END PGP SIGNATURE-----\n", "payload": "tree d0893eead13eb5d401421b965f88aeeb33c6fd11\nparent 85f0f9eb1bb7eedf11a3947508fccba66f22d108\nparent 3b2602cbb265ee68a3e3658072d58ff504675252\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1625738127 +0000\ncommitter GitHub <noreply@github.com> 1625738127 +0000\n\nMerge #9529\n\n9529: fix: Don't unify arrays with their elements r=flodiebold a=lnicola\n\nAddresses https://github.com/rust-analyzer/rust-analyzer/pull/9526#issuecomment-876206100.\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e44c56b61656b2eed55a5b9180febd74b3333c72", "html_url": "https://github.com/rust-lang/rust/commit/e44c56b61656b2eed55a5b9180febd74b3333c72", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e44c56b61656b2eed55a5b9180febd74b3333c72/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85f0f9eb1bb7eedf11a3947508fccba66f22d108", "url": "https://api.github.com/repos/rust-lang/rust/commits/85f0f9eb1bb7eedf11a3947508fccba66f22d108", "html_url": "https://github.com/rust-lang/rust/commit/85f0f9eb1bb7eedf11a3947508fccba66f22d108"}, {"sha": "3b2602cbb265ee68a3e3658072d58ff504675252", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b2602cbb265ee68a3e3658072d58ff504675252", "html_url": "https://github.com/rust-lang/rust/commit/3b2602cbb265ee68a3e3658072d58ff504675252"}], "stats": {"total": 30, "additions": 21, "deletions": 9}, "files": [{"sha": "746c3e4ee8803be68605af35e022073f064db8ee", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e44c56b61656b2eed55a5b9180febd74b3333c72/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e44c56b61656b2eed55a5b9180febd74b3333c72/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=e44c56b61656b2eed55a5b9180febd74b3333c72", "patch": "@@ -735,10 +735,11 @@ impl<'a> InferenceContext<'a> {\n                         _ => self.table.new_type_var(),\n                     };\n \n+                let expected = Expectation::has_type(elem_ty.clone());\n                 let len = match array {\n                     Array::ElementList(items) => {\n                         for expr in items.iter() {\n-                            let cur_elem_ty = self.infer_expr_inner(*expr, expected);\n+                            let cur_elem_ty = self.infer_expr_inner(*expr, &expected);\n                             elem_ty = self.coerce_merge_branch(Some(*expr), &elem_ty, &cur_elem_ty);\n                         }\n                         Some(items.len() as u64)"}, {"sha": "915dfbbc0d49ba1d9f24a2dab5fc8d7ddb166d94", "filename": "crates/hir_ty/src/tests/regression.rs", "status": "modified", "additions": 19, "deletions": 8, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/e44c56b61656b2eed55a5b9180febd74b3333c72/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e44c56b61656b2eed55a5b9180febd74b3333c72/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=e44c56b61656b2eed55a5b9180febd74b3333c72", "patch": "@@ -117,23 +117,34 @@ fn recursive_vars_2() {\n         \"#,\n         expect![[r#\"\n             10..79 '{     ...x)]; }': ()\n-            20..21 'x': {unknown}\n-            24..31 'unknown': {unknown}\n+            20..21 'x': &{unknown}\n+            24..31 'unknown': &{unknown}\n             41..42 'y': {unknown}\n             45..52 'unknown': {unknown}\n-            58..76 '[(x, y..., &x)]': [({unknown}, {unknown}); 2]\n-            59..65 '(x, y)': ({unknown}, {unknown})\n-            60..61 'x': {unknown}\n+            58..76 '[(x, y..., &x)]': [(&{unknown}, {unknown}); 2]\n+            59..65 '(x, y)': (&{unknown}, {unknown})\n+            60..61 'x': &{unknown}\n             63..64 'y': {unknown}\n-            67..75 '(&y, &x)': (&{unknown}, &{unknown})\n+            67..75 '(&y, &x)': (&{unknown}, {unknown})\n             68..70 '&y': &{unknown}\n             69..70 'y': {unknown}\n-            72..74 '&x': &{unknown}\n-            73..74 'x': {unknown}\n+            72..74 '&x': &&{unknown}\n+            73..74 'x': &{unknown}\n         \"#]],\n     );\n }\n \n+#[test]\n+fn array_elements_expected_type() {\n+    check_no_mismatches(\n+        r#\"\n+        fn test() {\n+            let x: [[u32; 2]; 2] = [[1, 2], [3, 4]];\n+        }\n+        \"#,\n+    );\n+}\n+\n #[test]\n fn infer_std_crash_1() {\n     // caused stack overflow, taken from std"}]}