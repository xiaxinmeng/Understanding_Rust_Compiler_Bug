{"sha": "02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "node_id": "C_kwDOAAsO6NoAKDAyYjY0YzVkMjY4OWZhZDgzNjBkODNmM2JjZDU4ZjVkYmJkMmYzMDM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-12-01T18:59:58Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-12-01T19:00:09Z"}, "message": "Document normalization methods on At", "tree": {"sha": "c2316cb92f043223fd85880c0eecab01f8ddf604", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2316cb92f043223fd85880c0eecab01f8ddf604"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "html_url": "https://github.com/rust-lang/rust/commit/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e45daa98565338fa7ad60475e35bac88548ddb9e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e45daa98565338fa7ad60475e35bac88548ddb9e", "html_url": "https://github.com/rust-lang/rust/commit/e45daa98565338fa7ad60475e35bac88548ddb9e"}], "stats": {"total": 58, "additions": 20, "deletions": 38}, "files": [{"sha": "899e30275a05296eb2de1958b29b41286f3f51d0", "filename": "compiler/rustc_trait_selection/src/traits/coherence.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs?ref=02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "patch": "@@ -11,8 +11,8 @@ use crate::traits::select::IntercrateAmbiguityCause;\n use crate::traits::util::impl_subject_and_oblig;\n use crate::traits::SkipLeakCheck;\n use crate::traits::{\n-    self, Normalized, Obligation, ObligationCause, ObligationCtxt, PredicateObligation,\n-    PredicateObligations, SelectionContext,\n+    self, Obligation, ObligationCause, ObligationCtxt, PredicateObligation, PredicateObligations,\n+    SelectionContext,\n };\n use rustc_data_structures::fx::FxIndexSet;\n use rustc_errors::Diagnostic;\n@@ -30,6 +30,8 @@ use std::fmt::Debug;\n use std::iter;\n use std::ops::ControlFlow;\n \n+use super::NormalizeExt;\n+\n /// Whether we do the orphan check relative to this crate or\n /// to some remote crate.\n #[derive(Copy, Clone, Debug)]\n@@ -128,8 +130,8 @@ fn with_fresh_ty_vars<'cx, 'tcx>(\n         predicates: tcx.predicates_of(impl_def_id).instantiate(tcx, impl_substs).predicates,\n     };\n \n-    let Normalized { value: mut header, obligations } =\n-        traits::normalize(selcx, param_env, ObligationCause::dummy(), header);\n+    let InferOk { value: mut header, obligations } =\n+        selcx.infcx.at(&ObligationCause::dummy(), param_env).normalize(header);\n \n     header.predicates.extend(obligations.into_iter().map(|o| o.predicate));\n     header"}, {"sha": "c6818a4e57d424cb04355b43f1451bf5caecdfa3", "filename": "compiler/rustc_trait_selection/src/traits/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs?ref=02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "patch": "@@ -56,7 +56,6 @@ pub use self::object_safety::astconv_object_safety_violations;\n pub use self::object_safety::is_vtable_safe_method;\n pub use self::object_safety::MethodViolationCode;\n pub use self::object_safety::ObjectSafetyViolation;\n-pub(crate) use self::project::{normalize, normalize_to};\n pub use self::project::{normalize_projection_type, NormalizeExt};\n pub use self::select::{EvaluationCache, SelectionCache, SelectionContext};\n pub use self::select::{EvaluationResult, IntercrateAmbiguityCause, OverflowError};"}, {"sha": "051660be9c474abb77ada510476f05f55426dc14", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 7, "deletions": 33, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "patch": "@@ -50,14 +50,18 @@ pub type ProjectionTyObligation<'tcx> = Obligation<'tcx, ty::ProjectionTy<'tcx>>\n pub(super) struct InProgress;\n \n pub trait NormalizeExt<'tcx> {\n+    /// Normalize a value using the `AssocTypeNormalizer`.\n+    ///\n+    /// This normalization should be used when the type contains inference variables or the\n+    /// projection may be fallible.\n     fn normalize<T: TypeFoldable<'tcx>>(&self, t: T) -> InferOk<'tcx, T>;\n }\n \n impl<'tcx> NormalizeExt<'tcx> for At<'_, 'tcx> {\n     fn normalize<T: TypeFoldable<'tcx>>(&self, value: T) -> InferOk<'tcx, T> {\n         let mut selcx = SelectionContext::new(self.infcx);\n         let Normalized { value, obligations } =\n-            normalize(&mut selcx, self.param_env, self.cause.clone(), value);\n+            normalize_with_depth(&mut selcx, self.param_env, self.cause.clone(), 0, value);\n         InferOk { value, obligations }\n     }\n }\n@@ -303,37 +307,6 @@ fn project_and_unify_type<'cx, 'tcx>(\n     }\n }\n \n-/// Normalizes any associated type projections in `value`, replacing\n-/// them with a fully resolved type where possible. The return value\n-/// combines the normalized result and any additional obligations that\n-/// were incurred as result.\n-pub(crate) fn normalize<'a, 'b, 'tcx, T>(\n-    selcx: &'a mut SelectionContext<'b, 'tcx>,\n-    param_env: ty::ParamEnv<'tcx>,\n-    cause: ObligationCause<'tcx>,\n-    value: T,\n-) -> Normalized<'tcx, T>\n-where\n-    T: TypeFoldable<'tcx>,\n-{\n-    let mut obligations = Vec::new();\n-    let value = normalize_to(selcx, param_env, cause, value, &mut obligations);\n-    Normalized { value, obligations }\n-}\n-\n-pub(crate) fn normalize_to<'a, 'b, 'tcx, T>(\n-    selcx: &'a mut SelectionContext<'b, 'tcx>,\n-    param_env: ty::ParamEnv<'tcx>,\n-    cause: ObligationCause<'tcx>,\n-    value: T,\n-    obligations: &mut Vec<PredicateObligation<'tcx>>,\n-) -> T\n-where\n-    T: TypeFoldable<'tcx>,\n-{\n-    normalize_with_depth_to(selcx, param_env, cause, 0, value, obligations)\n-}\n-\n /// As `normalize`, but with a custom depth.\n pub(crate) fn normalize_with_depth<'a, 'b, 'tcx, T>(\n     selcx: &'a mut SelectionContext<'b, 'tcx>,\n@@ -2324,10 +2297,11 @@ fn confirm_impl_trait_in_trait_candidate<'tcx>(\n         },\n     ));\n \n-    let ty = super::normalize_to(\n+    let ty = normalize_with_depth_to(\n         selcx,\n         obligation.param_env,\n         cause.clone(),\n+        obligation.recursion_depth + 1,\n         tcx.bound_trait_impl_trait_tys(impl_fn_def_id)\n             .map_bound(|tys| {\n                 tys.map_or_else(|_| tcx.ty_error(), |tys| tys[&obligation.predicate.item_def_id])"}, {"sha": "f899321fc01e1e4d1a13ea625b4185871c67fe41", "filename": "compiler/rustc_trait_selection/src/traits/query/normalize.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b64c5d2689fad8360d83f3bcd58f5dbbd2f303/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs?ref=02b64c5d2689fad8360d83f3bcd58f5dbbd2f303", "patch": "@@ -23,6 +23,13 @@ use super::NoSolution;\n pub use rustc_middle::traits::query::NormalizationResult;\n \n pub trait QueryNormalizeExt<'tcx> {\n+    /// Normalize a value using the `QueryNormalizer`.\n+    ///\n+    /// This normalization should *only* be used when the projection does not\n+    /// have possible ambiguity or may not be well-formed.\n+    ///\n+    /// After codegen, when lifetimes do not matter, it is preferable to instead\n+    /// use [`TyCtxt::normalize_erasing_regions`], which wraps this procedure.\n     fn query_normalize<T>(&self, value: T) -> Result<Normalized<'tcx, T>, NoSolution>\n     where\n         T: TypeFoldable<'tcx>;"}]}