{"sha": "7e855b59151f2e5c2a58fe422a273e997df14b24", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlODU1YjU5MTUxZjJlNWMyYTU4ZmU0MjJhMjczZTk5N2RmMTRiMjQ=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-05-04T21:36:22Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-05-08T13:08:15Z"}, "message": "Clean up rustdoc source code", "tree": {"sha": "74c7a1347484cea3bbd9e391d22d1d4bba24cd7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74c7a1347484cea3bbd9e391d22d1d4bba24cd7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e855b59151f2e5c2a58fe422a273e997df14b24", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e855b59151f2e5c2a58fe422a273e997df14b24", "html_url": "https://github.com/rust-lang/rust/commit/7e855b59151f2e5c2a58fe422a273e997df14b24", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e855b59151f2e5c2a58fe422a273e997df14b24/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97f3eeec8216d7155c24674b9be55e7c672bcae3", "url": "https://api.github.com/repos/rust-lang/rust/commits/97f3eeec8216d7155c24674b9be55e7c672bcae3", "html_url": "https://github.com/rust-lang/rust/commit/97f3eeec8216d7155c24674b9be55e7c672bcae3"}], "stats": {"total": 69, "additions": 33, "deletions": 36}, "files": [{"sha": "9a11e8fce28b7c5004eff2a5caf9c642eb491c20", "filename": "src/librustdoc/docfs.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Fdocfs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Fdocfs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdocfs.rs?ref=7e855b59151f2e5c2a58fe422a273e997df14b24", "patch": "@@ -12,6 +12,7 @@\n use std::fs;\n use std::io;\n use std::path::Path;\n+use std::string::ToString;\n use std::sync::mpsc::{channel, Receiver, Sender};\n use std::sync::Arc;\n \n@@ -25,7 +26,9 @@ macro_rules! try_err {\n }\n \n pub trait PathError {\n-    fn new<P: AsRef<Path>>(e: io::Error, path: P) -> Self;\n+    fn new<S, P: AsRef<Path>>(e: S, path: P) -> Self\n+    where\n+        S: ToString + Sized;\n }\n \n pub struct ErrorStorage {"}, {"sha": "c88db8c5ed00b67d4dde65304f4eaeadc5b5b29c", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=7e855b59151f2e5c2a58fe422a273e997df14b24", "patch": "@@ -31,7 +31,6 @@ use std::cmp::Ordering;\n use std::collections::{BTreeMap, VecDeque};\n use std::default::Default;\n use std::error;\n-\n use std::ffi::OsStr;\n use std::fmt::{self, Formatter, Write};\n use std::fs::{self, File};\n@@ -40,6 +39,7 @@ use std::io::{self, BufReader};\n use std::path::{Component, Path, PathBuf};\n use std::rc::Rc;\n use std::str;\n+use std::string::ToString;\n use std::sync::Arc;\n \n use rustc_ast_pretty::pprust;\n@@ -92,7 +92,7 @@ crate fn ensure_trailing_slash(v: &str) -> impl fmt::Display + '_ {\n #[derive(Debug)]\n pub struct Error {\n     pub file: PathBuf,\n-    pub error: io::Error,\n+    pub error: String,\n }\n \n impl error::Error for Error {}\n@@ -109,8 +109,11 @@ impl std::fmt::Display for Error {\n }\n \n impl PathError for Error {\n-    fn new<P: AsRef<Path>>(e: io::Error, path: P) -> Error {\n-        Error { file: path.as_ref().to_path_buf(), error: e }\n+    fn new<S, P: AsRef<Path>>(e: S, path: P) -> Error\n+    where\n+        S: ToString + Sized,\n+    {\n+        Error { file: path.as_ref().to_path_buf(), error: e.to_string() }\n     }\n }\n \n@@ -557,7 +560,7 @@ pub fn run(\n \n     // Write shared runs within a flock; disable thread dispatching of IO temporarily.\n     Arc::get_mut(&mut cx.shared).unwrap().fs.set_sync_only(true);\n-    write_shared(&cx, &krate, index, &md_opts, diag)?;\n+    write_shared(&cx, &krate, index, &md_opts)?;\n     Arc::get_mut(&mut cx.shared).unwrap().fs.set_sync_only(false);\n \n     // And finally render the whole crate's documentation\n@@ -577,7 +580,6 @@ fn write_shared(\n     krate: &clean::Crate,\n     search_index: String,\n     options: &RenderOptions,\n-    diag: &rustc_errors::Handler,\n ) -> Result<(), Error> {\n     // Write out the shared files. Note that these are shared among all rustdoc\n     // docs placed in the output directory, so this needs to be a synchronized\n@@ -960,7 +962,8 @@ themePicker.onblur = handleThemeButtonsBlur;\n             md_opts.output = cx.dst.clone();\n             md_opts.external_html = (*cx.shared).layout.external_html.clone();\n \n-            crate::markdown::render(index_page, md_opts, diag, cx.shared.edition);\n+            crate::markdown::render(&index_page, md_opts, cx.shared.edition)\n+                .map_err(|e| Error::new(e, &index_page))?;\n         } else {\n             let dst = cx.dst.join(\"index.html\");\n             let page = layout::Page {"}, {"sha": "8e5dfbeeda5f40e124a935643b780f5c74cb6bc6", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=7e855b59151f2e5c2a58fe422a273e997df14b24", "patch": "@@ -457,7 +457,13 @@ fn main_options(options: config::Options) -> i32 {\n         (true, true) => return markdown::test(options, &diag),\n         (true, false) => return test::run(options),\n         (false, true) => {\n-            return markdown::render(options.input, options.render_options, &diag, options.edition);\n+            match markdown::render(&options.input, options.render_options, options.edition) {\n+                Ok(()) => return 0,\n+                Err(err) => {\n+                    diag.struct_err(&err).emit();\n+                    return 1;\n+                }\n+            }\n         }\n         (false, false) => {}\n     }"}, {"sha": "1977d3653ba234b633e4aeedeca12be4ea50d3b1", "filename": "src/librustdoc/markdown.rs", "status": "modified", "additions": 12, "deletions": 27, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e855b59151f2e5c2a58fe422a273e997df14b24/src%2Flibrustdoc%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fmarkdown.rs?ref=7e855b59151f2e5c2a58fe422a273e997df14b24", "patch": "@@ -1,6 +1,6 @@\n-use std::fs::{create_dir_all, File};\n+use std::fs::{create_dir_all, read_to_string, File};\n use std::io::prelude::*;\n-use std::path::PathBuf;\n+use std::path::Path;\n \n use rustc_feature::UnstableFeatures;\n use rustc_span::edition::Edition;\n@@ -34,17 +34,16 @@ fn extract_leading_metadata(s: &str) -> (Vec<&str>, &str) {\n \n /// Render `input` (e.g., \"foo.md\") into an HTML file in `output`\n /// (e.g., output = \"bar\" => \"bar/foo.html\").\n-pub fn render(\n-    input: PathBuf,\n+pub fn render<P: AsRef<Path>>(\n+    input: P,\n     options: RenderOptions,\n-    diag: &rustc_errors::Handler,\n     edition: Edition,\n-) -> i32 {\n+) -> Result<(), String> {\n     if let Err(e) = create_dir_all(&options.output) {\n-        diag.struct_err(&format!(\"{}: {}\", options.output.display(), e)).emit();\n-        return 4;\n+        return Err(format!(\"{}: {}\", options.output.display(), e));\n     }\n \n+    let input = input.as_ref();\n     let mut output = options.output;\n     output.push(input.file_name().unwrap());\n     output.set_extension(\"html\");\n@@ -55,26 +54,15 @@ pub fn render(\n         css.push_str(&s)\n     }\n \n-    let input_str = match load_string(&input, diag) {\n-        Ok(s) => s,\n-        Err(LoadStringError::ReadFail) => return 1,\n-        Err(LoadStringError::BadUtf8) => return 2,\n-    };\n+    let input_str = read_to_string(input).map_err(|err| format!(\"{}: {}\", input.display(), err))?;\n     let playground_url = options.markdown_playground_url.or(options.playground_url);\n     let playground = playground_url.map(|url| markdown::Playground { crate_name: None, url });\n \n-    let mut out = match File::create(&output) {\n-        Err(e) => {\n-            diag.struct_err(&format!(\"{}: {}\", output.display(), e)).emit();\n-            return 4;\n-        }\n-        Ok(f) => f,\n-    };\n+    let mut out = File::create(&output).map_err(|e| format!(\"{}: {}\", output.display(), e))?;\n \n     let (metadata, text) = extract_leading_metadata(&input_str);\n     if metadata.is_empty() {\n-        diag.struct_err(\"invalid markdown file: no initial lines starting with `# ` or `%`\").emit();\n-        return 5;\n+        return Err(\"invalid markdown file: no initial lines starting with `# ` or `%`\".to_owned());\n     }\n     let title = metadata[0];\n \n@@ -122,11 +110,8 @@ pub fn render(\n     );\n \n     match err {\n-        Err(e) => {\n-            diag.struct_err(&format!(\"cannot write to `{}`: {}\", output.display(), e)).emit();\n-            6\n-        }\n-        Ok(_) => 0,\n+        Err(e) => Err(format!(\"cannot write to `{}`: {}\", output.display(), e)),\n+        Ok(_) => Ok(()),\n     }\n }\n "}]}