{"sha": "d9297aea101473d2dc59c702f96a02e64772c149", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5Mjk3YWVhMTAxNDczZDJkYzU5YzcwMmY5NmEwMmU2NDc3MmMxNDk=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-07-08T16:30:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-08T16:30:32Z"}, "message": "Rollup merge of #84961 - GuillaumeGomez:rework-session-globals, r=oli-obk\n\nRework SESSION_GLOBALS API\n\nFixes #84954.\n\n<s>Needs #84953 to be merged first (I cherry-picked its commits to have CI pass).</s> (done)\n\nr? ``@Aaron1011``", "tree": {"sha": "4ae63026c187fa7a877a265ac169690649e9ce01", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ae63026c187fa7a877a265ac169690649e9ce01"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9297aea101473d2dc59c702f96a02e64772c149", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg5ygoCRBK7hj4Ov3rIwAACMMIAGP0jFbMIHGlsSwo9H5vDtbs\nttvH2+XMQH7LbjId9bQ4B+1WU9UhxE0k91UKFubxX3JpBV5mwuyTYwi6mpYqL4SZ\nmbZPNRi/2ftgAnEcmA6fVDwunTInu98rPgqNbKcU3MjRp7PwIgTt+ITNMCn1TgdF\n2LfpC+k/lSu7at29TIwpHWc6nRIxbFxFWtoTz8e+jvOkxddaSbBXU371zIoD2A+t\nzGU24EsPDhIpJbWrco+8/ofQuKt0G4eTaunKmLNZYEH54eTNMLMx1OF1jjCQigIF\n+j05vQ///iLu6kgRuY24PWHaF5QsdWb6F8vRONE9VLGjHuC/nT2t83KheRgM0kA=\n=cqeq\n-----END PGP SIGNATURE-----\n", "payload": "tree 4ae63026c187fa7a877a265ac169690649e9ce01\nparent 0deb536ff987d7200f5ea35634781e9df9d5b666\nparent d891c8cd544e7f01dba2163cd1016ddf90dfedaf\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1625761832 +0200\ncommitter GitHub <noreply@github.com> 1625761832 +0200\n\nRollup merge of #84961 - GuillaumeGomez:rework-session-globals, r=oli-obk\n\nRework SESSION_GLOBALS API\n\nFixes #84954.\n\n<s>Needs #84953 to be merged first (I cherry-picked its commits to have CI pass).</s> (done)\n\nr? ``@Aaron1011``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9297aea101473d2dc59c702f96a02e64772c149", "html_url": "https://github.com/rust-lang/rust/commit/d9297aea101473d2dc59c702f96a02e64772c149", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9297aea101473d2dc59c702f96a02e64772c149/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0deb536ff987d7200f5ea35634781e9df9d5b666", "url": "https://api.github.com/repos/rust-lang/rust/commits/0deb536ff987d7200f5ea35634781e9df9d5b666", "html_url": "https://github.com/rust-lang/rust/commit/0deb536ff987d7200f5ea35634781e9df9d5b666"}, {"sha": "d891c8cd544e7f01dba2163cd1016ddf90dfedaf", "url": "https://api.github.com/repos/rust-lang/rust/commits/d891c8cd544e7f01dba2163cd1016ddf90dfedaf", "html_url": "https://github.com/rust-lang/rust/commit/d891c8cd544e7f01dba2163cd1016ddf90dfedaf"}], "stats": {"total": 256, "additions": 152, "deletions": 104}, "files": [{"sha": "6d137f3774fe76a6fe801557956602223e4a3963", "filename": "compiler/rustc_ast/src/util/comments/tests.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -1,9 +1,9 @@\n use super::*;\n-use rustc_span::with_default_session_globals;\n+use rustc_span::create_default_session_globals_then;\n \n #[test]\n fn test_block_doc_comment_1() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let comment = \"\\n * Test \\n **  Test\\n *   Test\\n\";\n         let stripped = beautify_doc_string(Symbol::intern(comment));\n         assert_eq!(stripped.as_str(), \" Test \\n*  Test\\n   Test\");\n@@ -12,7 +12,7 @@ fn test_block_doc_comment_1() {\n \n #[test]\n fn test_block_doc_comment_2() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let comment = \"\\n * Test\\n *  Test\\n\";\n         let stripped = beautify_doc_string(Symbol::intern(comment));\n         assert_eq!(stripped.as_str(), \" Test\\n  Test\");\n@@ -21,7 +21,7 @@ fn test_block_doc_comment_2() {\n \n #[test]\n fn test_block_doc_comment_3() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let comment = \"\\n let a: *i32;\\n *a = 5;\\n\";\n         let stripped = beautify_doc_string(Symbol::intern(comment));\n         assert_eq!(stripped.as_str(), \" let a: *i32;\\n *a = 5;\");\n@@ -30,7 +30,7 @@ fn test_block_doc_comment_3() {\n \n #[test]\n fn test_line_doc_comment() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let stripped = beautify_doc_string(Symbol::intern(\" test\"));\n         assert_eq!(stripped.as_str(), \" test\");\n         let stripped = beautify_doc_string(Symbol::intern(\"! test\"));"}, {"sha": "6c8d42f33eb5a74de15756cff7fbf760b3c60adf", "filename": "compiler/rustc_ast_pretty/src/pprust/tests.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -1,8 +1,8 @@\n use super::*;\n \n use rustc_ast as ast;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::symbol::Ident;\n-use rustc_span::with_default_session_globals;\n \n fn fun_to_string(\n     decl: &ast::FnDecl,\n@@ -24,7 +24,7 @@ fn variant_to_string(var: &ast::Variant) -> String {\n \n #[test]\n fn test_fun_to_string() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let abba_ident = Ident::from_str(\"abba\");\n \n         let decl =\n@@ -39,7 +39,7 @@ fn test_fun_to_string() {\n \n #[test]\n fn test_variant_to_string() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let ident = Ident::from_str(\"principal_skinner\");\n \n         let var = ast::Variant {"}, {"sha": "d055937ac36e37f9b21aa3194f9073dab7d71237", "filename": "compiler/rustc_errors/src/json/tests.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_errors%2Fsrc%2Fjson%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_errors%2Fsrc%2Fjson%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Fjson%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -39,16 +39,11 @@ impl<T: Write> Write for Shared<T> {\n     }\n }\n \n-fn with_default_session_globals(f: impl FnOnce()) {\n-    let session_globals = rustc_span::SessionGlobals::new(rustc_span::edition::DEFAULT_EDITION);\n-    rustc_span::SESSION_GLOBALS.set(&session_globals, f);\n-}\n-\n /// Test the span yields correct positions in JSON.\n fn test_positions(code: &str, span: (u32, u32), expected_output: SpanTestData) {\n     let expected_output = TestData { spans: vec![expected_output] };\n \n-    with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let sm = Lrc::new(SourceMap::new(FilePathMapping::empty()));\n         sm.new_source_file(Path::new(\"test.rs\").to_owned().into(), code.to_owned());\n "}, {"sha": "0068539fb3bd4b075c2176305abe776351b871a2", "filename": "compiler/rustc_expand/src/mut_visit/tests.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Fmut_visit%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Fmut_visit%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmut_visit%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -3,8 +3,8 @@ use crate::tests::{matches_codepattern, string_to_crate};\n use rustc_ast as ast;\n use rustc_ast::mut_visit::MutVisitor;\n use rustc_ast_pretty::pprust;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::symbol::Ident;\n-use rustc_span::with_default_session_globals;\n \n // This version doesn't care about getting comments or doc-strings in.\n fn print_crate_items(krate: &ast::Crate) -> String {\n@@ -38,7 +38,7 @@ macro_rules! assert_pred {\n // Make sure idents get transformed everywhere.\n #[test]\n fn ident_transformation() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mut zz_visitor = ToZzIdentMutVisitor;\n         let mut krate =\n             string_to_crate(\"#[a] mod b {fn c (d : e, f : g) {h!(i,j,k);l;m}}\".to_string());\n@@ -55,7 +55,7 @@ fn ident_transformation() {\n // Make sure idents get transformed even inside macro defs.\n #[test]\n fn ident_transformation_in_defs() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mut zz_visitor = ToZzIdentMutVisitor;\n         let mut krate = string_to_crate(\n             \"macro_rules! a {(b $c:expr $(d $e:token)f+ => \\"}, {"sha": "6402a81e7c1a5dba758fff4da279b140b9015ab8", "filename": "compiler/rustc_expand/src/parse/tests.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Fparse%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Fparse%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fparse%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -10,9 +10,9 @@ use rustc_errors::PResult;\n use rustc_parse::new_parser_from_source_str;\n use rustc_parse::parser::ForceCollect;\n use rustc_session::parse::ParseSess;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::source_map::FilePathMapping;\n use rustc_span::symbol::{kw, sym, Symbol};\n-use rustc_span::with_default_session_globals;\n use rustc_span::{BytePos, FileName, Pos, Span};\n \n use std::path::PathBuf;\n@@ -51,15 +51,15 @@ fn string_to_item(source_str: String) -> Option<P<ast::Item>> {\n #[should_panic]\n #[test]\n fn bad_path_expr_1() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         string_to_expr(\"::abc::def::return\".to_string());\n     })\n }\n \n // Checks the token-tree-ization of macros.\n #[test]\n fn string_to_tts_macro() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let tts: Vec<_> =\n             string_to_stream(\"macro_rules! zip (($a)=>($a))\".to_string()).trees().collect();\n         let tts: &[TokenTree] = &tts[..];\n@@ -96,7 +96,7 @@ fn string_to_tts_macro() {\n \n #[test]\n fn string_to_tts_1() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let tts = string_to_stream(\"fn a (b : i32) { b; }\".to_string());\n \n         let expected = TokenStream::new(vec![\n@@ -131,7 +131,7 @@ fn string_to_tts_1() {\n \n #[test]\n fn parse_use() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let use_s = \"use foo::bar::baz;\";\n         let vitem = string_to_item(use_s.to_string()).unwrap();\n         let vitem_s = item_to_string(&vitem);\n@@ -146,7 +146,7 @@ fn parse_use() {\n \n #[test]\n fn parse_extern_crate() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let ex_s = \"extern crate foo;\";\n         let vitem = string_to_item(ex_s.to_string()).unwrap();\n         let vitem_s = item_to_string(&vitem);\n@@ -184,7 +184,7 @@ fn get_spans_of_pat_idents(src: &str) -> Vec<Span> {\n \n #[test]\n fn span_of_self_arg_pat_idents_are_correct() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let srcs = [\n             \"impl z { fn a (&self, &myarg: i32) {} }\",\n             \"impl z { fn a (&mut self, &myarg: i32) {} }\",\n@@ -208,7 +208,7 @@ fn span_of_self_arg_pat_idents_are_correct() {\n \n #[test]\n fn parse_exprs() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         // just make sure that they parse....\n         string_to_expr(\"3 + 4\".to_string());\n         string_to_expr(\"a::z.froob(b,&(987+3))\".to_string());\n@@ -217,7 +217,7 @@ fn parse_exprs() {\n \n #[test]\n fn attrs_fix_bug() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         string_to_item(\n             \"pub fn mk_file_writer(path: &Path, flags: &[FileFlag])\n                 -> Result<Box<Writer>, String> {\n@@ -238,7 +238,7 @@ let mut fflags: c_int = wb();\n \n #[test]\n fn crlf_doc_comments() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let sess = sess();\n \n         let name_1 = FileName::Custom(\"crlf_source_1\".to_string());\n@@ -272,7 +272,7 @@ fn ttdelim_span() {\n         new_parser_from_source_str(sess, name, source).parse_expr()\n     }\n \n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let sess = sess();\n         let expr = parse_expr_from_source_str(\n             PathBuf::from(\"foo\").into(),\n@@ -300,7 +300,7 @@ fn ttdelim_span() {\n // See `recurse_into_file_modules` in the parser.\n #[test]\n fn out_of_line_mod() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let item = parse_item_from_source_str(\n             PathBuf::from(\"foo\").into(),\n             \"mod foo { struct S; mod this_does_not_exist; }\".to_owned(),"}, {"sha": "ed3aa1eaca84e18fe955553975ee8cef9896d465", "filename": "compiler/rustc_expand/src/tests.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -2,8 +2,8 @@ use rustc_ast as ast;\n use rustc_ast::tokenstream::TokenStream;\n use rustc_parse::{new_parser_from_source_str, parser::Parser, source_file_to_stream};\n use rustc_session::parse::ParseSess;\n+use rustc_span::create_default_session_if_not_set_then;\n use rustc_span::source_map::{FilePathMapping, SourceMap};\n-use rustc_span::with_default_session_globals;\n use rustc_span::{BytePos, MultiSpan, Span};\n \n use rustc_data_structures::sync::Lrc;\n@@ -124,7 +124,7 @@ impl<T: Write> Write for Shared<T> {\n }\n \n fn test_harness(file_text: &str, span_labels: Vec<SpanLabel>, expected_output: &str) {\n-    with_default_session_globals(|| {\n+    create_default_session_if_not_set_then(|_| {\n         let output = Arc::new(Mutex::new(Vec::new()));\n \n         let source_map = Lrc::new(SourceMap::new(FilePathMapping::empty()));"}, {"sha": "31052bfb54ce8584e445689ddd90d64268a138b4", "filename": "compiler/rustc_expand/src/tokenstream/tests.rs", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Ftokenstream%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_expand%2Fsrc%2Ftokenstream%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Ftokenstream%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -2,7 +2,7 @@ use crate::tests::string_to_stream;\n \n use rustc_ast::token;\n use rustc_ast::tokenstream::{Spacing, TokenStream, TokenStreamBuilder, TokenTree};\n-use rustc_span::with_default_session_globals;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::{BytePos, Span, Symbol};\n use smallvec::smallvec;\n \n@@ -20,7 +20,7 @@ fn joint(tree: TokenTree) -> TokenStream {\n \n #[test]\n fn test_concat() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_res = string_to_ts(\"foo::bar::baz\");\n         let test_fst = string_to_ts(\"foo::bar\");\n         let test_snd = string_to_ts(\"::baz\");\n@@ -33,7 +33,7 @@ fn test_concat() {\n \n #[test]\n fn test_to_from_bijection() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_start = string_to_ts(\"foo::bar(baz)\");\n         let test_end = test_start.trees().collect();\n         assert_eq!(test_start, test_end)\n@@ -42,7 +42,7 @@ fn test_to_from_bijection() {\n \n #[test]\n fn test_eq_0() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_res = string_to_ts(\"foo\");\n         let test_eqs = string_to_ts(\"foo\");\n         assert_eq!(test_res, test_eqs)\n@@ -51,7 +51,7 @@ fn test_eq_0() {\n \n #[test]\n fn test_eq_1() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_res = string_to_ts(\"::bar::baz\");\n         let test_eqs = string_to_ts(\"::bar::baz\");\n         assert_eq!(test_res, test_eqs)\n@@ -60,7 +60,7 @@ fn test_eq_1() {\n \n #[test]\n fn test_eq_3() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_res = string_to_ts(\"\");\n         let test_eqs = string_to_ts(\"\");\n         assert_eq!(test_res, test_eqs)\n@@ -69,7 +69,7 @@ fn test_eq_3() {\n \n #[test]\n fn test_diseq_0() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_res = string_to_ts(\"::bar::baz\");\n         let test_eqs = string_to_ts(\"bar::baz\");\n         assert_eq!(test_res == test_eqs, false)\n@@ -78,7 +78,7 @@ fn test_diseq_0() {\n \n #[test]\n fn test_diseq_1() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test_res = string_to_ts(\"(bar,baz)\");\n         let test_eqs = string_to_ts(\"bar,baz\");\n         assert_eq!(test_res == test_eqs, false)\n@@ -87,7 +87,7 @@ fn test_diseq_1() {\n \n #[test]\n fn test_is_empty() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let test0: TokenStream = Vec::<TokenTree>::new().into_iter().collect();\n         let test1: TokenStream =\n             TokenTree::token(token::Ident(Symbol::intern(\"a\"), false), sp(0, 1)).into();\n@@ -101,7 +101,7 @@ fn test_is_empty() {\n \n #[test]\n fn test_dotdotdot() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mut builder = TokenStreamBuilder::new();\n         builder.push(joint(TokenTree::token(token::Dot, sp(0, 1))));\n         builder.push(joint(TokenTree::token(token::Dot, sp(1, 2))));"}, {"sha": "086c49c73972f6efff13f0c1cbe31950493297b0", "filename": "compiler/rustc_interface/src/interface.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_interface%2Fsrc%2Finterface.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_interface%2Fsrc%2Finterface.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Finterface.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -76,7 +76,7 @@ impl Compiler {\n \n /// Converts strings provided as `--cfg [cfgspec]` into a `crate_cfg`.\n pub fn parse_cfgspecs(cfgspecs: Vec<String>) -> FxHashSet<(String, Option<String>)> {\n-    rustc_span::with_default_session_globals(move || {\n+    rustc_span::create_default_session_if_not_set_then(move |_| {\n         let cfg = cfgspecs\n             .into_iter()\n             .map(|s| {"}, {"sha": "a053253ec16e00625cd8c3d04c28a8f9772355d6", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -107,7 +107,7 @@ fn assert_non_crate_hash_different(x: &Options, y: &Options) {\n // When the user supplies --test we should implicitly supply --cfg test\n #[test]\n fn test_switch_implies_cfg_test() {\n-    rustc_span::with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let matches = optgroups().parse(&[\"--test\".to_string()]).unwrap();\n         let (sess, cfg) = mk_session(matches);\n         let cfg = build_configuration(&sess, to_crate_config(cfg));\n@@ -118,7 +118,7 @@ fn test_switch_implies_cfg_test() {\n // When the user supplies --test and --cfg test, don't implicitly add another --cfg test\n #[test]\n fn test_switch_implies_cfg_test_unless_cfg_test() {\n-    rustc_span::with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let matches = optgroups().parse(&[\"--test\".to_string(), \"--cfg=test\".to_string()]).unwrap();\n         let (sess, cfg) = mk_session(matches);\n         let cfg = build_configuration(&sess, to_crate_config(cfg));\n@@ -130,20 +130,20 @@ fn test_switch_implies_cfg_test_unless_cfg_test() {\n \n #[test]\n fn test_can_print_warnings() {\n-    rustc_span::with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let matches = optgroups().parse(&[\"-Awarnings\".to_string()]).unwrap();\n         let (sess, _) = mk_session(matches);\n         assert!(!sess.diagnostic().can_emit_warnings());\n     });\n \n-    rustc_span::with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let matches =\n             optgroups().parse(&[\"-Awarnings\".to_string(), \"-Dwarnings\".to_string()]).unwrap();\n         let (sess, _) = mk_session(matches);\n         assert!(sess.diagnostic().can_emit_warnings());\n     });\n \n-    rustc_span::with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let matches = optgroups().parse(&[\"-Adead_code\".to_string()]).unwrap();\n         let (sess, _) = mk_session(matches);\n         assert!(sess.diagnostic().can_emit_warnings());"}, {"sha": "4f51ce620427b4ecad71acdf53da52719b5e8787", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -150,7 +150,7 @@ pub fn setup_callbacks_and_run_in_thread_pool_with_globals<F: FnOnce() -> R + Se\n     crate::callbacks::setup_callbacks();\n \n     let main_handler = move || {\n-        rustc_span::with_session_globals(edition, || {\n+        rustc_span::create_session_globals_then(edition, || {\n             io::set_output_capture(stderr.clone());\n             f()\n         })\n@@ -171,12 +171,13 @@ unsafe fn handle_deadlock() {\n     rustc_data_structures::sync::assert_sync::<tls::ImplicitCtxt<'_, '_>>();\n     let icx: &tls::ImplicitCtxt<'_, '_> = &*(context as *const tls::ImplicitCtxt<'_, '_>);\n \n-    let session_globals = rustc_span::SESSION_GLOBALS.with(|sg| sg as *const _);\n+    let session_globals = rustc_span::with_session_globals(|sg| sg as *const _);\n     let session_globals = &*session_globals;\n     thread::spawn(move || {\n         tls::enter_context(icx, |_| {\n-            rustc_span::SESSION_GLOBALS\n-                .set(session_globals, || tls::with(|tcx| tcx.queries.deadlock(tcx, &registry)))\n+            rustc_span::set_session_globals_then(session_globals, || {\n+                tls::with(|tcx| tcx.queries.deadlock(tcx, &registry))\n+            })\n         });\n     });\n }\n@@ -203,13 +204,13 @@ pub fn setup_callbacks_and_run_in_thread_pool_with_globals<F: FnOnce() -> R + Se\n \n     let with_pool = move |pool: &rayon::ThreadPool| pool.install(f);\n \n-    rustc_span::with_session_globals(edition, || {\n-        rustc_span::SESSION_GLOBALS.with(|session_globals| {\n+    rustc_span::create_session_globals_then(edition, || {\n+        rustc_span::with_session_globals(|session_globals| {\n             // The main handler runs for each Rayon worker thread and sets up\n             // the thread local rustc uses. `session_globals` is captured and set\n             // on the new threads.\n             let main_handler = move |thread: rayon::ThreadBuilder| {\n-                rustc_span::SESSION_GLOBALS.set(session_globals, || {\n+                rustc_span::set_session_globals_then(session_globals, || {\n                     io::set_output_capture(stderr.clone());\n                     thread.run()\n                 })"}, {"sha": "fc9d6f636b2142a230e6c21e00a29be85f6973ae", "filename": "compiler/rustc_lint/src/tests.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_lint%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_lint%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -1,21 +1,23 @@\n use crate::context::parse_lint_and_tool_name;\n-use rustc_span::{with_default_session_globals, Symbol};\n+use rustc_span::{create_default_session_globals_then, Symbol};\n \n #[test]\n fn parse_lint_no_tool() {\n-    with_default_session_globals(|| assert_eq!(parse_lint_and_tool_name(\"foo\"), (None, \"foo\")));\n+    create_default_session_globals_then(|| {\n+        assert_eq!(parse_lint_and_tool_name(\"foo\"), (None, \"foo\"))\n+    });\n }\n \n #[test]\n fn parse_lint_with_tool() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         assert_eq!(parse_lint_and_tool_name(\"clippy::foo\"), (Some(Symbol::intern(\"clippy\")), \"foo\"))\n     });\n }\n \n #[test]\n fn parse_lint_multiple_path() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         assert_eq!(\n             parse_lint_and_tool_name(\"clippy::foo::bar\"),\n             (Some(Symbol::intern(\"clippy\")), \"foo::bar\")"}, {"sha": "e5b3059a5995fee80d77c0a50a7e4bfc45e66bf6", "filename": "compiler/rustc_mir/src/transform/coverage/tests.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -22,7 +22,7 @@\n //! are unrelated to the `TyCtxt` global. Without initializing the `Span` session globals, some\n //! basic, coverage-specific features would be impossible to test, but thankfully initializing these\n //! globals is comparatively simpler. The easiest way is to wrap the test in a closure argument\n-//! to: `rustc_span::with_default_session_globals(|| { test_here(); })`.\n+//! to: `rustc_span::create_default_session_globals_then(|| { test_here(); })`.\n \n use super::counters;\n use super::debug;\n@@ -677,7 +677,7 @@ fn synthesize_body_span_from_terminators(mir_body: &Body<'_>) -> Span {\n \n #[test]\n fn test_make_bcb_counters() {\n-    rustc_span::with_default_session_globals(|| {\n+    rustc_span::create_default_session_globals_then(|| {\n         let mir_body = goto_switchint();\n         let body_span = synthesize_body_span_from_terminators(&mir_body);\n         let mut basic_coverage_blocks = graph::CoverageGraph::from_mir(&mir_body);"}, {"sha": "b7693a85ad955a0365c91ffbe42829a1eabf3aff", "filename": "compiler/rustc_parse_format/src/tests.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_parse_format%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_parse_format%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse_format%2Fsrc%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -144,8 +144,7 @@ fn format_align_fill() {\n }\n #[test]\n fn format_counts() {\n-    use rustc_span::{edition, SessionGlobals, SESSION_GLOBALS};\n-    SESSION_GLOBALS.set(&SessionGlobals::new(edition::DEFAULT_EDITION), || {\n+    rustc_span::create_default_session_globals_then(|| {\n         same(\n             \"{:10x}\",\n             &[NextArgument(Argument {"}, {"sha": "b2da51f8f38d2df921d17800e025f6d1d849d4a6", "filename": "compiler/rustc_span/src/hygiene.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fhygiene.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -26,7 +26,7 @@\n \n use crate::edition::Edition;\n use crate::symbol::{kw, sym, Symbol};\n-use crate::SESSION_GLOBALS;\n+use crate::with_session_globals;\n use crate::{BytePos, CachingSourceMapView, ExpnIdCache, SourceFile, Span, DUMMY_SP};\n \n use crate::def_id::{CrateNum, DefId, DefPathHash, CRATE_DEF_INDEX, LOCAL_CRATE};\n@@ -201,7 +201,7 @@ impl HygieneData {\n     }\n \n     pub fn with<T, F: FnOnce(&mut HygieneData) -> T>(f: F) -> T {\n-        SESSION_GLOBALS.with(|session_globals| f(&mut *session_globals.hygiene_data.borrow_mut()))\n+        with_session_globals(|session_globals| f(&mut *session_globals.hygiene_data.borrow_mut()))\n     }\n \n     fn fresh_expn(&mut self, mut expn_data: Option<ExpnData>) -> ExpnId {\n@@ -1367,8 +1367,9 @@ fn update_disambiguator(expn_id: ExpnId) {\n         }\n     }\n \n-    let source_map = SESSION_GLOBALS\n-        .with(|session_globals| session_globals.source_map.borrow().as_ref().unwrap().clone());\n+    let source_map = with_session_globals(|session_globals| {\n+        session_globals.source_map.borrow().as_ref().unwrap().clone()\n+    });\n \n     let mut ctx =\n         DummyHashStableContext { caching_source_map: CachingSourceMapView::new(&source_map) };"}, {"sha": "11822e9ef974236c9784405674e178fa70a327b7", "filename": "compiler/rustc_span/src/lev_distance/tests.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Flev_distance%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Flev_distance%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flev_distance%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -21,8 +21,8 @@ fn test_lev_distance() {\n \n #[test]\n fn test_find_best_match_for_name() {\n-    use crate::with_default_session_globals;\n-    with_default_session_globals(|| {\n+    use crate::create_default_session_globals_then;\n+    create_default_session_globals_then(|| {\n         let input = vec![Symbol::intern(\"aaab\"), Symbol::intern(\"aaabc\")];\n         assert_eq!(\n             find_best_match_for_name(&input, Symbol::intern(\"aaaa\"), None),"}, {"sha": "3ddb10d2a06de781a878189c585d6a48f734c043", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 53, "deletions": 7, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -97,19 +97,65 @@ impl SessionGlobals {\n     }\n }\n \n-pub fn with_session_globals<R>(edition: Edition, f: impl FnOnce() -> R) -> R {\n+#[inline]\n+pub fn create_session_globals_then<R>(edition: Edition, f: impl FnOnce() -> R) -> R {\n+    assert!(\n+        !SESSION_GLOBALS.is_set(),\n+        \"SESSION_GLOBALS should never be overwritten! \\\n+         Use another thread if you need another SessionGlobals\"\n+    );\n     let session_globals = SessionGlobals::new(edition);\n     SESSION_GLOBALS.set(&session_globals, f)\n }\n \n-pub fn with_default_session_globals<R>(f: impl FnOnce() -> R) -> R {\n-    with_session_globals(edition::DEFAULT_EDITION, f)\n+#[inline]\n+pub fn set_session_globals_then<R>(session_globals: &SessionGlobals, f: impl FnOnce() -> R) -> R {\n+    assert!(\n+        !SESSION_GLOBALS.is_set(),\n+        \"SESSION_GLOBALS should never be overwritten! \\\n+         Use another thread if you need another SessionGlobals\"\n+    );\n+    SESSION_GLOBALS.set(session_globals, f)\n+}\n+\n+#[inline]\n+pub fn create_default_session_if_not_set_then<R, F>(f: F) -> R\n+where\n+    F: FnOnce(&SessionGlobals) -> R,\n+{\n+    create_session_if_not_set_then(edition::DEFAULT_EDITION, f)\n+}\n+\n+#[inline]\n+pub fn create_session_if_not_set_then<R, F>(edition: Edition, f: F) -> R\n+where\n+    F: FnOnce(&SessionGlobals) -> R,\n+{\n+    if !SESSION_GLOBALS.is_set() {\n+        let session_globals = SessionGlobals::new(edition);\n+        SESSION_GLOBALS.set(&session_globals, || SESSION_GLOBALS.with(f))\n+    } else {\n+        SESSION_GLOBALS.with(f)\n+    }\n+}\n+\n+#[inline]\n+pub fn with_session_globals<R, F>(f: F) -> R\n+where\n+    F: FnOnce(&SessionGlobals) -> R,\n+{\n+    SESSION_GLOBALS.with(f)\n+}\n+\n+#[inline]\n+pub fn create_default_session_globals_then<R>(f: impl FnOnce() -> R) -> R {\n+    create_session_globals_then(edition::DEFAULT_EDITION, f)\n }\n \n // If this ever becomes non thread-local, `decode_syntax_context`\n // and `decode_expn_id` will need to be updated to handle concurrent\n // deserialization.\n-scoped_tls::scoped_thread_local!(pub static SESSION_GLOBALS: SessionGlobals);\n+scoped_tls::scoped_thread_local!(static SESSION_GLOBALS: SessionGlobals);\n \n // FIXME: We should use this enum or something like it to get rid of the\n // use of magic `/rust/1.x/...` paths across the board.\n@@ -855,13 +901,13 @@ impl<D: Decoder> Decodable<D> for Span {\n /// the `SourceMap` provided to this function. If that is not available,\n /// we fall back to printing the raw `Span` field values.\n pub fn with_source_map<T, F: FnOnce() -> T>(source_map: Lrc<SourceMap>, f: F) -> T {\n-    SESSION_GLOBALS.with(|session_globals| {\n+    with_session_globals(|session_globals| {\n         *session_globals.source_map.borrow_mut() = Some(source_map);\n     });\n     struct ClearSourceMap;\n     impl Drop for ClearSourceMap {\n         fn drop(&mut self) {\n-            SESSION_GLOBALS.with(|session_globals| {\n+            with_session_globals(|session_globals| {\n                 session_globals.source_map.borrow_mut().take();\n             });\n         }\n@@ -880,7 +926,7 @@ pub fn debug_with_source_map(\n }\n \n pub fn default_span_debug(span: Span, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n-    SESSION_GLOBALS.with(|session_globals| {\n+    with_session_globals(|session_globals| {\n         if let Some(source_map) = &*session_globals.source_map.borrow() {\n             debug_with_source_map(span, f, source_map)\n         } else {"}, {"sha": "cb017709c6c7bfc071268a71779f2c230f34827f", "filename": "compiler/rustc_span/src/span_encoding.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fspan_encoding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fspan_encoding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fspan_encoding.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -5,7 +5,6 @@\n // See https://internals.rust-lang.org/t/rfc-compiler-refactoring-spans/1357/28\n \n use crate::hygiene::SyntaxContext;\n-use crate::SESSION_GLOBALS;\n use crate::{BytePos, SpanData};\n \n use rustc_data_structures::fx::FxIndexSet;\n@@ -122,5 +121,5 @@ impl SpanInterner {\n // If an interner exists, return it. Otherwise, prepare a fresh one.\n #[inline]\n fn with_span_interner<T, F: FnOnce(&mut SpanInterner) -> T>(f: F) -> T {\n-    SESSION_GLOBALS.with(|session_globals| f(&mut *session_globals.span_interner.lock()))\n+    crate::with_session_globals(|session_globals| f(&mut *session_globals.span_interner.lock()))\n }"}, {"sha": "a308d1efca1dac95490309ba52b9696491f5def0", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -13,7 +13,7 @@ use std::fmt;\n use std::hash::{Hash, Hasher};\n use std::str;\n \n-use crate::{Edition, Span, DUMMY_SP, SESSION_GLOBALS};\n+use crate::{with_session_globals, Edition, Span, DUMMY_SP};\n \n #[cfg(test)]\n mod tests;\n@@ -1790,7 +1790,7 @@ impl Ident {\n \n #[inline]\n fn with_interner<T, F: FnOnce(&mut Interner) -> T>(f: F) -> T {\n-    SESSION_GLOBALS.with(|session_globals| f(&mut *session_globals.symbol_interner.lock()))\n+    with_session_globals(|session_globals| f(&mut *session_globals.symbol_interner.lock()))\n }\n \n /// An alternative to [`Symbol`], useful when the chars within the symbol need to"}, {"sha": "11dea265b4e66c6adb3769195bf6d234bbf8919f", "filename": "compiler/rustc_span/src/symbol/tests.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fsymbol%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/compiler%2Frustc_span%2Fsrc%2Fsymbol%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -1,6 +1,6 @@\n use super::*;\n \n-use crate::{edition, SessionGlobals};\n+use crate::create_default_session_globals_then;\n \n #[test]\n fn interner_tests() {\n@@ -18,7 +18,7 @@ fn interner_tests() {\n \n #[test]\n fn without_first_quote_test() {\n-    SESSION_GLOBALS.set(&SessionGlobals::new(edition::DEFAULT_EDITION), || {\n+    create_default_session_globals_then(|| {\n         let i = Ident::from_str(\"'break\");\n         assert_eq!(i.without_first_quote().name, kw::Break);\n     });"}, {"sha": "275d1b3ebd938add90368a1cee9e59077a29d5cf", "filename": "src/librustdoc/clean/cfg/tests.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -2,8 +2,8 @@ use super::*;\n \n use rustc_ast::attr;\n use rustc_ast::Path;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::symbol::{Ident, Symbol};\n-use rustc_span::with_default_session_globals;\n use rustc_span::DUMMY_SP;\n \n fn word_cfg(s: &str) -> Cfg {\n@@ -52,7 +52,7 @@ macro_rules! dummy_meta_item_list {\n \n #[test]\n fn test_cfg_not() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         assert_eq!(!Cfg::False, Cfg::True);\n         assert_eq!(!Cfg::True, Cfg::False);\n         assert_eq!(!word_cfg(\"test\"), Cfg::Not(Box::new(word_cfg(\"test\"))));\n@@ -70,7 +70,7 @@ fn test_cfg_not() {\n \n #[test]\n fn test_cfg_and() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mut x = Cfg::False;\n         x &= Cfg::True;\n         assert_eq!(x, Cfg::False);\n@@ -154,7 +154,7 @@ fn test_cfg_and() {\n \n #[test]\n fn test_cfg_or() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mut x = Cfg::True;\n         x |= Cfg::False;\n         assert_eq!(x, Cfg::True);\n@@ -238,7 +238,7 @@ fn test_cfg_or() {\n \n #[test]\n fn test_parse_ok() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mi = dummy_meta_item_word(\"all\");\n         assert_eq!(Cfg::parse(&mi), Ok(word_cfg(\"all\")));\n \n@@ -271,7 +271,7 @@ fn test_parse_ok() {\n \n #[test]\n fn test_parse_err() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mi = attr::mk_name_value_item(Ident::from_str(\"foo\"), LitKind::Bool(false), DUMMY_SP);\n         assert!(Cfg::parse(&mi).is_err());\n \n@@ -303,7 +303,7 @@ fn test_parse_err() {\n \n #[test]\n fn test_render_short_html() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         assert_eq!(word_cfg(\"unix\").render_short_html(), \"Unix\");\n         assert_eq!(name_value_cfg(\"target_os\", \"macos\").render_short_html(), \"macOS\");\n         assert_eq!(name_value_cfg(\"target_pointer_width\", \"16\").render_short_html(), \"16-bit\");\n@@ -358,7 +358,7 @@ fn test_render_short_html() {\n \n #[test]\n fn test_render_long_html() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         assert_eq!(\n             word_cfg(\"unix\").render_long_html(),\n             \"This is supported on <strong>Unix</strong> only.\"\n@@ -442,7 +442,7 @@ fn test_render_long_html() {\n fn test_simplify_with() {\n     // This is a tiny subset of things that could be simplified, but it likely covers 90% of\n     // real world usecases well.\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let foo = word_cfg(\"foo\");\n         let bar = word_cfg(\"bar\");\n         let baz = word_cfg(\"baz\");"}, {"sha": "cd914f05e680c72c61527471ef1f0a8788127abf", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -513,7 +513,7 @@ crate fn make_test(\n     // Uses librustc_ast to parse the doctest and find if there's a main fn and the extern\n     // crate already is included.\n     let result = rustc_driver::catch_fatal_errors(|| {\n-        rustc_span::with_session_globals(edition, || {\n+        rustc_span::create_session_if_not_set_then(edition, |_| {\n             use rustc_errors::emitter::{Emitter, EmitterWriter};\n             use rustc_errors::Handler;\n             use rustc_parse::maybe_new_parser_from_source_str;"}, {"sha": "a505865b149c4bc91e0ee1e4480686c38df96502", "filename": "src/librustdoc/html/highlight/tests.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -1,8 +1,8 @@\n use super::write_code;\n use crate::html::format::Buffer;\n use expect_test::expect_file;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::edition::Edition;\n-use rustc_span::with_default_session_globals;\n \n const STYLE: &str = r#\"\n <style>\n@@ -18,7 +18,7 @@ const STYLE: &str = r#\"\n \n #[test]\n fn test_html_highlighting() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let src = include_str!(\"fixtures/sample.rs\");\n         let html = {\n             let mut out = Buffer::new();\n@@ -31,7 +31,7 @@ fn test_html_highlighting() {\n \n #[test]\n fn test_dos_backline() {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let src = \"pub fn foo() {\\r\\n\\\n     println!(\\\"foo\\\");\\r\\n\\\n }\\r\\n\";"}, {"sha": "82d1afac5eceb96fd48f1088917c991ef1fc0106", "filename": "src/librustdoc/passes/unindent_comments/tests.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fpasses%2Funindent_comments%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Flibrustdoc%2Fpasses%2Funindent_comments%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Funindent_comments%2Ftests.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -1,7 +1,7 @@\n use super::*;\n+use rustc_span::create_default_session_globals_then;\n use rustc_span::source_map::DUMMY_SP;\n use rustc_span::symbol::Symbol;\n-use rustc_span::with_default_session_globals;\n \n fn create_doc_fragment(s: &str) -> Vec<DocFragment> {\n     vec![DocFragment {\n@@ -17,7 +17,7 @@ fn create_doc_fragment(s: &str) -> Vec<DocFragment> {\n \n #[track_caller]\n fn run_test(input: &str, expected: &str) {\n-    with_default_session_globals(|| {\n+    create_default_session_globals_then(|| {\n         let mut s = create_doc_fragment(input);\n         unindent_fragments(&mut s);\n         assert_eq!(&s.iter().collect::<String>(), expected);"}, {"sha": "bb246de0e572dd4aa65f7a92f33ec63303ce9b19", "filename": "src/test/ui-fulldeps/mod_dir_path_canonicalized.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftest%2Fui-fulldeps%2Fmod_dir_path_canonicalized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftest%2Fui-fulldeps%2Fmod_dir_path_canonicalized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fmod_dir_path_canonicalized.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -19,7 +19,7 @@ use std::path::Path;\n mod gravy;\n \n pub fn main() {\n-    rustc_span::with_default_session_globals(|| parse());\n+    rustc_span::create_default_session_globals_then(|| parse());\n \n     assert_eq!(gravy::foo(), 10);\n }"}, {"sha": "36ff8b01fd454dacaabc288843894dcc59b4124b", "filename": "src/test/ui-fulldeps/pprust-expr-roundtrip.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftest%2Fui-fulldeps%2Fpprust-expr-roundtrip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftest%2Fui-fulldeps%2Fpprust-expr-roundtrip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fpprust-expr-roundtrip.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -202,7 +202,7 @@ impl MutVisitor for AddParens {\n }\n \n fn main() {\n-    rustc_span::with_default_session_globals(|| run());\n+    rustc_span::create_default_session_globals_then(|| run());\n }\n \n fn run() {"}, {"sha": "d6e3e92fc5eb6b76caf1c6575cfd889f7f4d2d07", "filename": "src/tools/clippy/clippy_lints/src/doc.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdoc.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -26,6 +26,7 @@ use rustc_span::source_map::{BytePos, FilePathMapping, MultiSpan, SourceMap, Spa\n use rustc_span::{sym, FileName, Pos};\n use std::io;\n use std::ops::Range;\n+use std::thread;\n use url::Url;\n \n declare_clippy_lint! {\n@@ -584,10 +585,10 @@ fn get_current_span(spans: &[(usize, Span)], idx: usize) -> (usize, Span) {\n }\n \n fn check_code(cx: &LateContext<'_>, text: &str, edition: Edition, span: Span) {\n-    fn has_needless_main(code: &str, edition: Edition) -> bool {\n+    fn has_needless_main(code: String, edition: Edition) -> bool {\n         rustc_driver::catch_fatal_errors(|| {\n-            rustc_span::with_session_globals(edition, || {\n-                let filename = FileName::anon_source_code(code);\n+            rustc_span::create_session_globals_then(edition, || {\n+                let filename = FileName::anon_source_code(&code);\n \n                 let sm = Lrc::new(SourceMap::new(FilePathMapping::empty()));\n                 let emitter = EmitterWriter::new(box io::sink(), None, false, false, false, None, false);\n@@ -649,7 +650,10 @@ fn check_code(cx: &LateContext<'_>, text: &str, edition: Edition, span: Span) {\n         .unwrap_or_default()\n     }\n \n-    if has_needless_main(text, edition) {\n+    // Because of the global session, we need to create a new session in a different thread with\n+    // the edition we need.\n+    let text = text.to_owned();\n+    if thread::spawn(move || has_needless_main(text, edition)).join().expect(\"thread::spawn failed\") {\n         span_lint(cx, NEEDLESS_DOCTEST_MAIN, span, \"needless `fn main` in doctest\");\n     }\n }"}, {"sha": "01a3fc812b2087cbad4ef95e08524e1d0cf38060", "filename": "src/tools/error_index_generator/main.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftools%2Ferror_index_generator%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftools%2Ferror_index_generator%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fmain.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -284,7 +284,8 @@ fn parse_args() -> (OutputFormat, PathBuf) {\n fn main() {\n     rustc_driver::init_env_logger(\"RUST_LOG\");\n     let (format, dst) = parse_args();\n-    let result = rustc_span::with_default_session_globals(move || main_with_result(format, &dst));\n+    let result =\n+        rustc_span::create_default_session_globals_then(move || main_with_result(format, &dst));\n     if let Err(e) = result {\n         panic!(\"{}\", e.to_string());\n     }"}, {"sha": "e0403574eebc1d73a361c70e144fe67920c4a40a", "filename": "src/tools/rustfmt/src/formatting.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftools%2Frustfmt%2Fsrc%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9297aea101473d2dc59c702f96a02e64772c149/src%2Ftools%2Frustfmt%2Fsrc%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt%2Fsrc%2Fformatting.rs?ref=d9297aea101473d2dc59c702f96a02e64772c149", "patch": "@@ -34,7 +34,7 @@ impl<'b, T: Write + 'b> Session<'b, T> {\n             return Err(ErrorKind::VersionMismatch);\n         }\n \n-        rustc_span::with_session_globals(self.config.edition().into(), || {\n+        rustc_span::create_session_if_not_set_then(self.config.edition().into(), |_| {\n             if self.config.disable_all_formatting() {\n                 // When the input is from stdin, echo back the input.\n                 if let Input::Text(ref buf) = input {"}]}