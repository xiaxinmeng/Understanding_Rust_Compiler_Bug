{"sha": "d40e624a3625c7c2d68c949435fd883cd43dd065", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0MGU2MjRhMzYyNWM3YzJkNjhjOTQ5NDM1ZmQ4ODNjZDQzZGQwNjU=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-06-05T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-06-13T12:24:30Z"}, "message": "compiletest: Add directives to detect sanitizer support\n\nAdd needs-sanitizer-{address,leak,memory,thread} directive indicating\nthat test requires target with support for specific sanitizer.\n\nThis is an addition to the existing needs-sanitizer-support directive\nindicating that test requires a sanitizer runtime library.", "tree": {"sha": "24d539e73bc73d8b80608b61c79b426f488ffbb8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24d539e73bc73d8b80608b61c79b426f488ffbb8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d40e624a3625c7c2d68c949435fd883cd43dd065", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d40e624a3625c7c2d68c949435fd883cd43dd065", "html_url": "https://github.com/rust-lang/rust/commit/d40e624a3625c7c2d68c949435fd883cd43dd065", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d40e624a3625c7c2d68c949435fd883cd43dd065/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "449e8eaa286e407c9cd8cac655b77998fd53db6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/449e8eaa286e407c9cd8cac655b77998fd53db6b", "html_url": "https://github.com/rust-lang/rust/commit/449e8eaa286e407c9cd8cac655b77998fd53db6b"}], "stats": {"total": 105, "additions": 75, "deletions": 30}, "files": [{"sha": "4bd50508d152056e13f7ecc21d80055ab00a6a45", "filename": "src/test/codegen/sanitizer-memory-track-orgins.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-memory-track-orgins.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-memory-track-orgins.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fsanitizer-memory-track-orgins.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,9 +1,7 @@\n // Verifies that MemorySanitizer track-origins level can be controlled\n // with -Zsanitizer-memory-track-origins option.\n //\n-// needs-sanitizer-support\n-// only-linux\n-// only-x86_64\n+// needs-sanitizer-memory\n // revisions:MSAN-0 MSAN-1 MSAN-2 MSAN-1-LTO MSAN-2-LTO\n //\n //[MSAN-0] compile-flags: -Zsanitizer=memory"}, {"sha": "b00441e4fc5abb078fca340700039ea60da0a5fe", "filename": "src/test/codegen/sanitizer-no-sanitize-inlining.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-no-sanitize-inlining.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-no-sanitize-inlining.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fsanitizer-no-sanitize-inlining.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,11 +1,9 @@\n // Verifies that no_sanitize attribute prevents inlining when\n // given sanitizer is enabled, but has no effect on inlining otherwise.\n //\n-// needs-sanitizer-support\n-// only-x86_64\n-//\n+// needs-sanitizer-address\n+// needs-sanitizer-leak\n // revisions: ASAN LSAN\n-//\n //[ASAN] compile-flags: -Zsanitizer=address -C opt-level=3 -Z mir-opt-level=3\n //[LSAN] compile-flags: -Zsanitizer=leak    -C opt-level=3 -Z mir-opt-level=3\n "}, {"sha": "1b2b18822e63e8a8c673166bcb92bd0fdb99ac2f", "filename": "src/test/codegen/sanitizer-no-sanitize.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-no-sanitize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-no-sanitize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fsanitizer-no-sanitize.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,7 +1,7 @@\n // Verifies that no_sanitze attribute can be used to\n // selectively disable sanitizer instrumentation.\n //\n-// needs-sanitizer-support\n+// needs-sanitizer-address\n // compile-flags: -Zsanitizer=address\n \n #![crate_type=\"lib\"]"}, {"sha": "719f219ce4ef1b9fe8cc0c1830309d352b9f142b", "filename": "src/test/codegen/sanitizer-recover.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-recover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fcodegen%2Fsanitizer-recover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fsanitizer-recover.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,9 +1,8 @@\n // Verifies that AddressSanitizer and MemorySanitizer\n // recovery mode can be enabled with -Zsanitizer-recover.\n //\n-// needs-sanitizer-support\n-// only-linux\n-// only-x86_64\n+// needs-sanitizer-address\n+// needs-sanitizer-memory\n // revisions:ASAN ASAN-RECOVER MSAN MSAN-RECOVER MSAN-RECOVER-LTO\n // no-prefer-dynamic\n //"}, {"sha": "b11d4c4cab7cf54c5f1f5de18a50cf3b15372149", "filename": "src/test/run-make-fulldeps/sanitizer-cdylib-link/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-cdylib-link%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-cdylib-link%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-cdylib-link%2FMakefile?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n # needs-sanitizer-support\n-# only-x86_64\n+# needs-sanitizer-address\n # only-linux\n \n -include ../tools.mk"}, {"sha": "c2ebd2a6d8cacbf49ad9c02f92ec1f3e8252b448", "filename": "src/test/run-make-fulldeps/sanitizer-dylib-link/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-dylib-link%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-dylib-link%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-dylib-link%2FMakefile?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n # needs-sanitizer-support\n-# only-x86_64\n+# needs-sanitizer-address\n # only-linux\n \n -include ../tools.mk"}, {"sha": "5ceff16471cee99fde034adabf0d53e8fadd9eeb", "filename": "src/test/run-make-fulldeps/sanitizer-staticlib-link/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-staticlib-link%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-staticlib-link%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsanitizer-staticlib-link%2FMakefile?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n # needs-sanitizer-support\n-# only-x86_64\n+# needs-sanitizer-address\n # only-linux\n \n -include ../tools.mk"}, {"sha": "a79b37ee08210717c27c9f278f7aac0402992e09", "filename": "src/test/rustdoc/sanitizer-option.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frustdoc%2Fsanitizer-option.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Frustdoc%2Fsanitizer-option.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fsanitizer-option.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,4 +1,5 @@\n // needs-sanitizer-support\n+// needs-sanitizer-address\n // compile-flags: --test -Z sanitizer=address\n //\n // #43031: Verify that rustdoc passes `-Z` options to rustc. Use an extern"}, {"sha": "cee73b0425ad52210f7032b7e6b9262babad2b51", "filename": "src/test/ui/sanitize/address.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Faddress.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Faddress.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Faddress.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-address\n //\n // compile-flags: -Z sanitizer=address -O -g\n //"}, {"sha": "095a6f4697b1c15a35a1e5139531b3ec5b4bfa46", "filename": "src/test/ui/sanitize/badfree.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fbadfree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fbadfree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fbadfree.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-address\n //\n // compile-flags: -Z sanitizer=address -O\n //"}, {"sha": "79dfe58f04d0b48274bac1512000aec19a327098", "filename": "src/test/ui/sanitize/cfg.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fcfg.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -2,8 +2,10 @@\n // the `#[cfg(sanitize = \"option\")]` attribute is configured.\n \n // needs-sanitizer-support\n-// only-linux\n-// only-x86_64\n+// needs-sanitizer-address\n+// needs-sanitizer-leak\n+// needs-sanitizer-memory\n+// needs-sanitizer-thread\n // check-pass\n // revisions: address leak memory thread\n //[address]compile-flags: -Zsanitizer=address --cfg address"}, {"sha": "b2e182238ce288803b0cd9116c8be6d8fb939d01", "filename": "src/test/ui/sanitize/issue-72154-lifetime-markers.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fissue-72154-lifetime-markers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fissue-72154-lifetime-markers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fissue-72154-lifetime-markers.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -4,7 +4,7 @@\n // miscompilation which was subsequently detected by AddressSanitizer as UB.\n //\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-address\n //\n // compile-flags: -Copt-level=0 -Zsanitizer=address\n // run-pass"}, {"sha": "c9f10fe4f467ed73c8bdc7a4a92944bcf49c788e", "filename": "src/test/ui/sanitize/leak.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fleak.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fleak.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fleak.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-leak\n //\n // compile-flags: -Z sanitizer=leak -O\n //"}, {"sha": "a26649a5800131e20a6820ec72a123263552a84a", "filename": "src/test/ui/sanitize/memory.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fmemory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fmemory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fmemory.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,6 +1,5 @@\n // needs-sanitizer-support\n-// only-linux\n-// only-x86_64\n+// needs-sanitizer-memory\n //\n // compile-flags: -Z sanitizer=memory -Zsanitizer-memory-track-origins -O\n //"}, {"sha": "64d6ccf34091681d386c7c3f746c7e529e2d15fb", "filename": "src/test/ui/sanitize/new-llvm-pass-manager-thin-lto.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fnew-llvm-pass-manager-thin-lto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fnew-llvm-pass-manager-thin-lto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fnew-llvm-pass-manager-thin-lto.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -4,7 +4,7 @@\n //\n // min-llvm-version 9.0\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-address\n //\n // no-prefer-dynamic\n // revisions: opt0 opt1"}, {"sha": "c70cf5accc0776611cf557a43178b708e002708e", "filename": "src/test/ui/sanitize/thread.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fthread.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -11,7 +11,7 @@\n // would occasionally fail, making test flaky.\n //\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-thread\n //\n // compile-flags: -Z sanitizer=thread -O\n //"}, {"sha": "30be2ae6f090641e4bdacb7374f0940b521370fd", "filename": "src/test/ui/sanitize/use-after-scope.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fuse-after-scope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftest%2Fui%2Fsanitize%2Fuse-after-scope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fuse-after-scope.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -1,5 +1,5 @@\n // needs-sanitizer-support\n-// only-x86_64\n+// needs-sanitizer-address\n //\n // compile-flags: -Zsanitizer=address\n // run-fail"}, {"sha": "9614707433e13af4a0111db8a271c7aa8f9547c7", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 23, "deletions": 5, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -43,6 +43,10 @@ impl EarlyProps {\n         let mut props = EarlyProps::default();\n         let rustc_has_profiler_support = env::var_os(\"RUSTC_PROFILER_SUPPORT\").is_some();\n         let rustc_has_sanitizer_support = env::var_os(\"RUSTC_SANITIZER_SUPPORT\").is_some();\n+        let has_asan = util::ASAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+        let has_lsan = util::LSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+        let has_msan = util::MSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+        let has_tsan = util::TSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n \n         iter_header(testfile, None, rdr, &mut |ln| {\n             // we should check if any only-<platform> exists and if it exists\n@@ -74,7 +78,25 @@ impl EarlyProps {\n                     props.ignore = true;\n                 }\n \n-                if !rustc_has_sanitizer_support && config.parse_needs_sanitizer_support(ln) {\n+                if !rustc_has_sanitizer_support\n+                    && config.parse_name_directive(ln, \"needs-sanitizer-support\")\n+                {\n+                    props.ignore = true;\n+                }\n+\n+                if !has_asan && config.parse_name_directive(ln, \"needs-sanitizer-address\") {\n+                    props.ignore = true;\n+                }\n+\n+                if !has_lsan && config.parse_name_directive(ln, \"needs-sanitizer-leak\") {\n+                    props.ignore = true;\n+                }\n+\n+                if !has_msan && config.parse_name_directive(ln, \"needs-sanitizer-memory\") {\n+                    props.ignore = true;\n+                }\n+\n+                if !has_tsan && config.parse_name_directive(ln, \"needs-sanitizer-thread\") {\n                     props.ignore = true;\n                 }\n \n@@ -829,10 +851,6 @@ impl Config {\n         self.parse_name_directive(line, \"needs-profiler-support\")\n     }\n \n-    fn parse_needs_sanitizer_support(&self, line: &str) -> bool {\n-        self.parse_name_directive(line, \"needs-sanitizer-support\")\n-    }\n-\n     /// Parses a name-value directive which contains config-specific information, e.g., `ignore-x86`\n     /// or `normalize-stderr-32bit`.\n     fn parse_cfg_name_directive(&self, line: &str, prefix: &str) -> ParsedNameDirective {"}, {"sha": "036409fbf070f7178e62d63126ae32b74314122c", "filename": "src/tools/compiletest/src/header/tests.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -195,3 +195,22 @@ fn debugger() {\n     config.debugger = Some(Debugger::Lldb);\n     assert!(parse_rs(&config, \"// ignore-lldb\").ignore);\n }\n+\n+#[test]\n+fn sanitizers() {\n+    let mut config = config();\n+\n+    // Target that supports all sanitizers:\n+    config.target = \"x86_64-unknown-linux-gnu\".to_owned();\n+    assert!(!parse_rs(&config, \"// needs-sanitizer-address\").ignore);\n+    assert!(!parse_rs(&config, \"// needs-sanitizer-leak\").ignore);\n+    assert!(!parse_rs(&config, \"// needs-sanitizer-memory\").ignore);\n+    assert!(!parse_rs(&config, \"// needs-sanitizer-thread\").ignore);\n+\n+    // Target that doesn't support sanitizers:\n+    config.target = \"wasm32-unknown-emscripten\".to_owned();\n+    assert!(parse_rs(&config, \"// needs-sanitizer-address\").ignore);\n+    assert!(parse_rs(&config, \"// needs-sanitizer-leak\").ignore);\n+    assert!(parse_rs(&config, \"// needs-sanitizer-memory\").ignore);\n+    assert!(parse_rs(&config, \"// needs-sanitizer-thread\").ignore);\n+}"}, {"sha": "b9087dee6174cf0db09d7d530c8fd09f7426caba", "filename": "src/tools/compiletest/src/util.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftools%2Fcompiletest%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40e624a3625c7c2d68c949435fd883cd43dd065/src%2Ftools%2Fcompiletest%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Futil.rs?ref=d40e624a3625c7c2d68c949435fd883cd43dd065", "patch": "@@ -81,6 +81,17 @@ const ARCH_TABLE: &'static [(&'static str, &'static str)] = &[\n     (\"xcore\", \"xcore\"),\n ];\n \n+pub const ASAN_SUPPORTED_TARGETS: &'static [&'static str] =\n+    &[\"aarch64-fuchsia\", \"x86_64-apple-darwin\", \"x86_64-fuchsia\", \"x86_64-unknown-linux-gnu\"];\n+\n+pub const LSAN_SUPPORTED_TARGETS: &'static [&'static str] =\n+    &[\"x86_64-apple-darwin\", \"x86_64-unknown-linux-gnu\"];\n+\n+pub const MSAN_SUPPORTED_TARGETS: &'static [&'static str] = &[\"x86_64-unknown-linux-gnu\"];\n+\n+pub const TSAN_SUPPORTED_TARGETS: &'static [&'static str] =\n+    &[\"x86_64-apple-darwin\", \"x86_64-unknown-linux-gnu\"];\n+\n pub fn matches_os(triple: &str, name: &str) -> bool {\n     // For the wasm32 bare target we ignore anything also ignored on emscripten\n     // and then we also recognize `wasm32-bare` as the os for the target"}]}