{"sha": "fc709c8b210c551c97ca3b7c7daeaabc15cd80aa", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjNzA5YzhiMjEwYzU1MWM5N2NhM2I3YzdkYWVhYWJjMTVjZDgwYWE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-19T15:55:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-19T15:55:29Z"}, "message": "Merge #8583\n\n8583: Simplify r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "3eebe39070ab3b3d986a3f0db2c46a300a38fe2a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3eebe39070ab3b3d986a3f0db2c46a300a38fe2a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc709c8b210c551c97ca3b7c7daeaabc15cd80aa", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgfafxCRBK7hj4Ov3rIwAAl08IAKhWybB6hBWmcoB/ThKJv741\ndqbohLEsJyS9CfKGfiqq4gXCsuisfC+hg/tPoR5AW9pVYmkcElo95TKpjzz1h/So\nyjotkPkAgqRvyKosz0IekRhGOD42UPRa9BdTwGXOo9J7sRZyF7h+zc24Kl0hZkvH\n8l8WAaZRvM4dIE9lEqtkW+2yBZvapPOk+SefD//JcXvCjc3RehcXQoWucjm2VnYl\nX9bK07PBW0Zt7DCk/VrNXavzPZ+fGrkN3dx1Tsm5X0F5SZ9TzHGk/uDmhFtmD1AL\nkrMgBnTJyNc9xIyPX4Cs8EXJLZYK6FgnWxaYLiK56kINKDsr28oOlJD72GiyD0U=\n=1lCM\n-----END PGP SIGNATURE-----\n", "payload": "tree 3eebe39070ab3b3d986a3f0db2c46a300a38fe2a\nparent 2b5f35ca4b5569ec8947083be3fecff938c3b8ba\nparent c96c38edd3e2d399c17f7a9346053162c0e149f7\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1618847729 +0000\ncommitter GitHub <noreply@github.com> 1618847729 +0000\n\nMerge #8583\n\n8583: Simplify r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc709c8b210c551c97ca3b7c7daeaabc15cd80aa", "html_url": "https://github.com/rust-lang/rust/commit/fc709c8b210c551c97ca3b7c7daeaabc15cd80aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc709c8b210c551c97ca3b7c7daeaabc15cd80aa/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b5f35ca4b5569ec8947083be3fecff938c3b8ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b5f35ca4b5569ec8947083be3fecff938c3b8ba", "html_url": "https://github.com/rust-lang/rust/commit/2b5f35ca4b5569ec8947083be3fecff938c3b8ba"}, {"sha": "c96c38edd3e2d399c17f7a9346053162c0e149f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/c96c38edd3e2d399c17f7a9346053162c0e149f7", "html_url": "https://github.com/rust-lang/rust/commit/c96c38edd3e2d399c17f7a9346053162c0e149f7"}], "stats": {"total": 37, "additions": 14, "deletions": 23}, "files": [{"sha": "870a8d4ffba92635603c78d4d677ab4e60c83760", "filename": "crates/ide_assists/src/handlers/replace_derive_with_manual_impl.rs", "status": "modified", "additions": 14, "deletions": 23, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/fc709c8b210c551c97ca3b7c7daeaabc15cd80aa/crates%2Fide_assists%2Fsrc%2Fhandlers%2Freplace_derive_with_manual_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc709c8b210c551c97ca3b7c7daeaabc15cd80aa/crates%2Fide_assists%2Fsrc%2Fhandlers%2Freplace_derive_with_manual_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Freplace_derive_with_manual_impl.rs?ref=fc709c8b210c551c97ca3b7c7daeaabc15cd80aa", "patch": "@@ -5,7 +5,6 @@ use itertools::Itertools;\n use syntax::{\n     ast::{self, make, AstNode, NameOwner},\n     SyntaxKind::{IDENT, WHITESPACE},\n-    TextSize,\n };\n \n use crate::{\n@@ -43,32 +42,23 @@ pub(crate) fn replace_derive_with_manual_impl(\n     ctx: &AssistContext,\n ) -> Option<()> {\n     let attr = ctx.find_node_at_offset::<ast::Attr>()?;\n-\n-    let has_derive = attr\n-        .syntax()\n-        .descendants_with_tokens()\n-        .filter(|t| t.kind() == IDENT)\n-        .find_map(syntax::NodeOrToken::into_token)\n-        .filter(|t| t.text() == \"derive\")\n-        .is_some();\n-    if !has_derive {\n+    let (name, args) = attr.as_simple_call()?;\n+    if name != \"derive\" {\n         return None;\n     }\n \n-    let trait_token = ctx.token_at_offset().find(|t| t.kind() == IDENT && t.text() != \"derive\")?;\n-    let trait_path = make::path_unqualified(make::path_segment(make::name_ref(trait_token.text())));\n+    let trait_token = args.syntax().token_at_offset(ctx.offset()).find(|t| t.kind() == IDENT)?;\n+    let trait_name = trait_token.text();\n \n     let adt = attr.syntax().parent().and_then(ast::Adt::cast)?;\n-    let annotated_name = adt.name()?;\n-    let insert_pos = adt.syntax().text_range().end();\n \n-    let current_module = ctx.sema.scope(annotated_name.syntax()).module()?;\n+    let current_module = ctx.sema.scope(adt.syntax()).module()?;\n     let current_crate = current_module.krate();\n \n     let found_traits = items_locator::items_with_name(\n         &ctx.sema,\n         current_crate,\n-        NameToImport::Exact(trait_token.text().to_string()),\n+        NameToImport::Exact(trait_name.to_string()),\n         items_locator::AssocItemSearch::Exclude,\n         Some(items_locator::DEFAULT_QUERY_SEARCH_LIMIT),\n     )\n@@ -86,10 +76,11 @@ pub(crate) fn replace_derive_with_manual_impl(\n \n     let mut no_traits_found = true;\n     for (trait_path, trait_) in found_traits.inspect(|_| no_traits_found = false) {\n-        add_assist(acc, ctx, &attr, &trait_path, Some(trait_), &adt, &annotated_name, insert_pos)?;\n+        add_assist(acc, ctx, &attr, &args, &trait_path, Some(trait_), &adt)?;\n     }\n     if no_traits_found {\n-        add_assist(acc, ctx, &attr, &trait_path, None, &adt, &annotated_name, insert_pos)?;\n+        let trait_path = make::path_unqualified(make::path_segment(make::name_ref(trait_name)));\n+        add_assist(acc, ctx, &attr, &args, &trait_path, None, &adt)?;\n     }\n     Some(())\n }\n@@ -98,24 +89,24 @@ fn add_assist(\n     acc: &mut Assists,\n     ctx: &AssistContext,\n     attr: &ast::Attr,\n+    input: &ast::TokenTree,\n     trait_path: &ast::Path,\n     trait_: Option<hir::Trait>,\n     adt: &ast::Adt,\n-    annotated_name: &ast::Name,\n-    insert_pos: TextSize,\n ) -> Option<()> {\n     let target = attr.syntax().text_range();\n-    let input = attr.token_tree()?;\n-    let label = format!(\"Convert to manual  `impl {} for {}`\", trait_path, annotated_name);\n+    let annotated_name = adt.name()?;\n+    let label = format!(\"Convert to manual `impl {} for {}`\", trait_path, annotated_name);\n     let trait_name = trait_path.segment().and_then(|seg| seg.name_ref())?;\n \n     acc.add(\n         AssistId(\"replace_derive_with_manual_impl\", AssistKind::Refactor),\n         label,\n         target,\n         |builder| {\n+            let insert_pos = adt.syntax().text_range().end();\n             let impl_def_with_items =\n-                impl_def_from_trait(&ctx.sema, annotated_name, trait_, trait_path);\n+                impl_def_from_trait(&ctx.sema, &annotated_name, trait_, trait_path);\n             update_attribute(builder, &input, &trait_name, &attr);\n             let trait_path = format!(\"{}\", trait_path);\n             match (ctx.config.snippet_cap, impl_def_with_items) {"}]}