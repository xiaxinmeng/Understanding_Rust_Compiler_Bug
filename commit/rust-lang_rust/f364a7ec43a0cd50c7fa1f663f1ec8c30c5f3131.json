{"sha": "f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYzNjRhN2VjNDNhMGNkNTBjN2ZhMWY2NjNmMWVjOGMzMGM1ZjMxMzE=", "commit": {"author": {"name": "Marcus Klaas", "email": "mail@marcusklaas.nl", "date": "2016-04-18T16:39:40Z"}, "committer": {"name": "Marcus Klaas", "email": "mail@marcusklaas.nl", "date": "2016-04-18T16:39:40Z"}, "message": "Add option to force explicit extern ABI's", "tree": {"sha": "a418407f2ad644196a78831337db36d39f028a32", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a418407f2ad644196a78831337db36d39f028a32"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "html_url": "https://github.com/rust-lang/rust/commit/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "68f04cec37a967413934852f37998655139ff7f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/68f04cec37a967413934852f37998655139ff7f0", "html_url": "https://github.com/rust-lang/rust/commit/68f04cec37a967413934852f37998655139ff7f0"}], "stats": {"total": 46, "additions": 40, "deletions": 6}, "files": [{"sha": "5632e9a925c18baef9f3a0946466ddc2953432e0", "filename": "src/config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "patch": "@@ -328,6 +328,7 @@ create_config! {\n         \"Maximum width of the args of a function call before falling back to vertical formatting\";\n     struct_lit_width: usize, 16,\n         \"Maximum width in the body of a struct lit before falling back to vertical formatting\";\n+    force_explicit_abi: bool, true, \"Always print the abi for extern items\";\n     newline_style: NewlineStyle, NewlineStyle::Unix, \"Unix or Windows line endings\";\n     fn_brace_style: BraceStyle, BraceStyle::SameLineWhere, \"Brace style for functions\";\n     item_brace_style: BraceStyle, BraceStyle::SameLineWhere, \"Brace style for structs and enums\";"}, {"sha": "2566d9a436b166e405b955d87193834a378b2d54", "filename": "src/items.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "patch": "@@ -80,7 +80,8 @@ impl Rewrite for ast::Local {\n \n impl<'a> FmtVisitor<'a> {\n     pub fn format_foreign_mod(&mut self, fm: &ast::ForeignMod, span: Span) {\n-        self.buffer.push_str(&::utils::format_abi(fm.abi));\n+        let abi_str = ::utils::format_abi(fm.abi, self.config.force_explicit_abi);\n+        self.buffer.push_str(&abi_str);\n \n         let snippet = self.snippet(span);\n         let brace_pos = snippet.find_uncommented(\"{\").unwrap();\n@@ -1265,7 +1266,7 @@ fn rewrite_fn_base(context: &RewriteContext,\n     result.push_str(::utils::format_unsafety(unsafety));\n \n     if abi != abi::Abi::Rust {\n-        result.push_str(&::utils::format_abi(abi));\n+        result.push_str(&::utils::format_abi(abi, context.config.force_explicit_abi));\n     }\n \n     // fn foo"}, {"sha": "22b518d246381f04618a42b9883c266a40679dee", "filename": "src/types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftypes.rs?ref=f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "patch": "@@ -608,7 +608,7 @@ fn rewrite_bare_fn(bare_fn: &ast::BareFnTy,\n     result.push_str(&::utils::format_unsafety(bare_fn.unsafety));\n \n     if bare_fn.abi != abi::Abi::Rust {\n-        result.push_str(&::utils::format_abi(bare_fn.abi));\n+        result.push_str(&::utils::format_abi(bare_fn.abi, context.config.force_explicit_abi));\n     }\n \n     result.push_str(\"fn\");"}, {"sha": "667c9cd7efd0aa166fda7ea2dc3d75f60e6a86b7", "filename": "src/utils.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "patch": "@@ -91,9 +91,12 @@ pub fn format_mutability(mutability: ast::Mutability) -> &'static str {\n }\n \n #[inline]\n-// FIXME(#451): include \"C\"?\n-pub fn format_abi(abi: abi::Abi) -> String {\n-    format!(\"extern {} \", abi)\n+pub fn format_abi(abi: abi::Abi, explicit_abi: bool) -> String {\n+    if abi == abi::Abi::C && !explicit_abi {\n+        \"extern \".into()\n+    } else {\n+        format!(\"extern {} \", abi)\n+    }\n }\n \n // The width of the first line in s."}, {"sha": "9d6c4c2a1cd52f82b259dce2229836577241a5e8", "filename": "tests/source/extern_not_explicit.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/tests%2Fsource%2Fextern_not_explicit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/tests%2Fsource%2Fextern_not_explicit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fextern_not_explicit.rs?ref=f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "patch": "@@ -0,0 +1,14 @@\n+// rustfmt-force_explicit_abi: false\n+\n+ extern  \"C\" {\n+   fn some_fn() -> ();\n+ }\n+\n+ extern \"C\" fn sup() {\n+\n+ }\n+\n+type funky_func = extern \"C\" fn (unsafe extern \"rust-call\" fn(*const JSJitInfo, *mut JSContext,\n+                                              HandleObject, *mut libc::c_void, u32,\n+                                              *mut JSVal)\n+                                              -> u8);"}, {"sha": "b0f64c4f1cf5a3c66d569994f538a0582ea5cd98", "filename": "tests/target/extern_not_explicit.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/tests%2Ftarget%2Fextern_not_explicit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131/tests%2Ftarget%2Fextern_not_explicit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fextern_not_explicit.rs?ref=f364a7ec43a0cd50c7fa1f663f1ec8c30c5f3131", "patch": "@@ -0,0 +1,15 @@\n+// rustfmt-force_explicit_abi: false\n+\n+extern {\n+    fn some_fn() -> ();\n+}\n+\n+extern fn sup() {}\n+\n+type funky_func = extern fn(unsafe extern \"rust-call\" fn(*const JSJitInfo,\n+                                                         *mut JSContext,\n+                                                         HandleObject,\n+                                                         *mut libc::c_void,\n+                                                         u32,\n+                                                         *mut JSVal)\n+                                                         -> u8);"}]}