{"sha": "f7a2371c176663d59062ec5158f39faecba45768", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3YTIzNzFjMTc2NjYzZDU5MDYyZWM1MTU4ZjM5ZmFlY2JhNDU3Njg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-03-29T04:48:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-03-29T04:48:49Z"}, "message": "auto merge of #5614 : graydon/rust/static-linkage-bug, r=catamorphism\n\nre bug that @nikomatsakis was hitting: when you define a `static` (old: `const`) containing a `&` or `&[]` expression, it will create temporaries (the underlying pointee) by creating a throwaway symbol for each temporary, each with _global_ linkage, and each named `\"const\"`. LLVM will helpfully rename multiple copies of this throwaway symbol to `\"const1\"` and `\"const2\"` and so forth in the _same_ library. But if you have _2 libraries_ -- say, libcore and librustc -- that both do this, the dynamic linker (at least on linux) will happily do horrible things like make the slice in one library point to the bytes of the vector from the other library. This is obviously a recipe for much hilarity and head-scratching.\r\n\r\nThe solution is to change the linkage to something else, internal or (in the case of this patch) _private_.\r\n\r\nIt will require a snapshot to integrate this into stage0 and thereby fix the problem / unblock patches that were hitting this in stage1.", "tree": {"sha": "51979c417b823bfd7e7f123eae26717d15fb8c15", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/51979c417b823bfd7e7f123eae26717d15fb8c15"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f7a2371c176663d59062ec5158f39faecba45768", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f7a2371c176663d59062ec5158f39faecba45768", "html_url": "https://github.com/rust-lang/rust/commit/f7a2371c176663d59062ec5158f39faecba45768", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f7a2371c176663d59062ec5158f39faecba45768/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d98a195ffc6f68cf071826917e50eb4ad80b270b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d98a195ffc6f68cf071826917e50eb4ad80b270b", "html_url": "https://github.com/rust-lang/rust/commit/d98a195ffc6f68cf071826917e50eb4ad80b270b"}, {"sha": "1163f69c847a768c6c0a987c8172c600519bf649", "url": "https://api.github.com/repos/rust-lang/rust/commits/1163f69c847a768c6c0a987c8172c600519bf649", "html_url": "https://github.com/rust-lang/rust/commit/1163f69c847a768c6c0a987c8172c600519bf649"}], "stats": {"total": 5, "additions": 4, "deletions": 1}, "files": [{"sha": "04b641ed3036c0286a5ec9fa4ad38a4867282bb4", "filename": "src/librustc/middle/trans/consts.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f7a2371c176663d59062ec5158f39faecba45768/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7a2371c176663d59062ec5158f39faecba45768/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs?ref=f7a2371c176663d59062ec5158f39faecba45768", "patch": "@@ -11,7 +11,8 @@\n use core::prelude::*;\n \n use back::abi;\n-use lib::llvm::{llvm, ValueRef, TypeRef, Bool, True, False};\n+use lib::llvm::{llvm, SetLinkage, InternalLinkage, PrivateLinkage,\n+                ValueRef, TypeRef, Bool, True, False};\n use metadata::csearch;\n use middle::const_eval;\n use middle::trans::adt;\n@@ -104,6 +105,7 @@ fn const_addr_of(cx: @CrateContext, cv: ValueRef) -> ValueRef {\n         };\n         llvm::LLVMSetInitializer(gv, cv);\n         llvm::LLVMSetGlobalConstant(gv, True);\n+        SetLinkage(gv, PrivateLinkage);\n         gv\n     }\n }\n@@ -483,6 +485,7 @@ fn const_expr_unadjusted(cx: @CrateContext, e: @ast::expr) -> ValueRef {\n                 };\n                 llvm::LLVMSetInitializer(gv, cv);\n                 llvm::LLVMSetGlobalConstant(gv, True);\n+                SetLinkage(gv, PrivateLinkage);\n                 let p = const_ptrcast(cx, gv, llunitty);\n                 C_struct(~[p, sz])\n               }"}]}