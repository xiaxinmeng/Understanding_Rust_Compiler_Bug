{"sha": "2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI1OTMwNzBkNTdjYjBiNGNkYzYyNmNmYzI5MjRkNmM1OTBiMGY5YTg=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-09T17:24:41Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-09T17:24:41Z"}, "message": "rollup merge of #19581: luqmana/duc\n\nFixes #19575.", "tree": {"sha": "4fd3715fd63aa67783ad97d5fb68efb58eafd517", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4fd3715fd63aa67783ad97d5fb68efb58eafd517"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "html_url": "https://github.com/rust-lang/rust/commit/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39b57115fbf5d91df3382699b1dbde7ea8716f6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/39b57115fbf5d91df3382699b1dbde7ea8716f6c", "html_url": "https://github.com/rust-lang/rust/commit/39b57115fbf5d91df3382699b1dbde7ea8716f6c"}, {"sha": "8ebc1c9fd88640b1833e0743b649a957f3337720", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ebc1c9fd88640b1833e0743b649a957f3337720", "html_url": "https://github.com/rust-lang/rust/commit/8ebc1c9fd88640b1833e0743b649a957f3337720"}], "stats": {"total": 59, "additions": 48, "deletions": 11}, "files": [{"sha": "1811388662c45f1ef4e77d897b3b3b582964c3c5", "filename": "src/librustc_trans/trans/closure.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/src%2Flibrustc_trans%2Ftrans%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/src%2Flibrustc_trans%2Ftrans%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fclosure.rs?ref=2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "patch": "@@ -288,7 +288,6 @@ fn load_environment<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n             debuginfo::create_captured_var_metadata(\n                 bcx,\n                 def_id.node,\n-                cdata_ty,\n                 env_pointer_alloca,\n                 i,\n                 captured_by_ref,\n@@ -328,7 +327,7 @@ fn load_unboxed_closure_environment<'blk, 'tcx>(\n     // Store the pointer to closure data in an alloca for debug info because that's what the\n     // llvm.dbg.declare intrinsic expects\n     let env_pointer_alloca = if bcx.sess().opts.debuginfo == FullDebugInfo {\n-        let alloc = alloc_ty(bcx, ty::mk_mut_ptr(bcx.tcx(), self_type), \"__debuginfo_env_ptr\");\n+        let alloc = alloca(bcx, val_ty(llenv), \"__debuginfo_env_ptr\");\n         Store(bcx, llenv, alloc);\n         Some(alloc)\n     } else {\n@@ -357,7 +356,6 @@ fn load_unboxed_closure_environment<'blk, 'tcx>(\n             debuginfo::create_captured_var_metadata(\n                 bcx,\n                 def_id.node,\n-                self_type,\n                 env_pointer_alloca,\n                 i,\n                 captured_by_ref,"}, {"sha": "f6c4ba64576f76d656efae22d1a556861501fffb", "filename": "src/librustc_trans/trans/debuginfo.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo.rs?ref=2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "patch": "@@ -884,7 +884,6 @@ pub fn create_local_var_metadata(bcx: Block, local: &ast::Local) {\n /// Adds the created metadata nodes directly to the crate's IR.\n pub fn create_captured_var_metadata<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n                                                 node_id: ast::NodeId,\n-                                                env_data_type: Ty<'tcx>,\n                                                 env_pointer: ValueRef,\n                                                 env_index: uint,\n                                                 captured_by_ref: bool,\n@@ -930,7 +929,10 @@ pub fn create_captured_var_metadata<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n     let variable_type = node_id_type(bcx, node_id);\n     let scope_metadata = bcx.fcx.debug_context.get_ref(cx, span).fn_metadata;\n \n-    let llvm_env_data_type = type_of::type_of(cx, env_data_type);\n+    // env_pointer is the alloca containing the pointer to the environment,\n+    // so it's type is **EnvironmentType. In order to find out the type of\n+    // the environment we have to \"dereference\" two times.\n+    let llvm_env_data_type = val_ty(env_pointer).element_type().element_type();\n     let byte_offset_of_var_in_env = machine::llelement_offset(cx,\n                                                               llvm_env_data_type,\n                                                               env_index);"}, {"sha": "761d0f0be8f583309d5a682b6ddfdbb264693438", "filename": "src/test/debuginfo/var-captured-in-stack-closure.rs", "status": "modified", "additions": 43, "deletions": 6, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/src%2Ftest%2Fdebuginfo%2Fvar-captured-in-stack-closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2593070d57cb0b4cdc626cfc2924d6c590b0f9a8/src%2Ftest%2Fdebuginfo%2Fvar-captured-in-stack-closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fvar-captured-in-stack-closure.rs?ref=2593070d57cb0b4cdc626cfc2924d6c590b0f9a8", "patch": "@@ -28,6 +28,19 @@\n // gdb-command:print *owned\n // gdb-check:$5 = 6\n \n+// gdb-command:continue\n+\n+// gdb-command:print variable\n+// gdb-check:$6 = 2\n+// gdb-command:print constant\n+// gdb-check:$7 = 2\n+// gdb-command:print a_struct\n+// gdb-check:$8 = {a = -3, b = 4.5, c = 5}\n+// gdb-command:print *struct_ref\n+// gdb-check:$9 = {a = -3, b = 4.5, c = 5}\n+// gdb-command:print *owned\n+// gdb-check:$10 = 6\n+\n \n // === LLDB TESTS ==================================================================================\n \n@@ -44,6 +57,20 @@\n // lldb-command:print *owned\n // lldb-check:[...]$4 = 6\n \n+// lldb-command:continue\n+\n+// lldb-command:print variable\n+// lldb-check:[...]$5 = 2\n+// lldb-command:print constant\n+// lldb-check:[...]$6 = 2\n+// lldb-command:print a_struct\n+// lldb-check:[...]$7 = Struct { a: -3, b: 4.5, c: 5 }\n+// lldb-command:print *struct_ref\n+// lldb-check:[...]$8 = Struct { a: -3, b: 4.5, c: 5 }\n+// lldb-command:print *owned\n+// lldb-check:[...]$9 = 6\n+\n+#![feature(unboxed_closures)]\n #![allow(unused_variables)]\n \n struct Struct {\n@@ -65,12 +92,22 @@ fn main() {\n     let struct_ref = &a_struct;\n     let owned = box 6;\n \n-    let closure = || {\n-        zzz(); // #break\n-        variable = constant + a_struct.a + struct_ref.a + *owned;\n-    };\n-\n-    closure();\n+    {\n+        let closure = || {\n+            zzz(); // #break\n+            variable = constant + a_struct.a + struct_ref.a + *owned;\n+        };\n+\n+        closure();\n+    }\n+\n+    {\n+        let mut unboxed_closure = |&mut:| {\n+            zzz(); // #break\n+            variable = constant + a_struct.a + struct_ref.a + *owned;\n+        };\n+        unboxed_closure();\n+    }\n }\n \n fn zzz() {()}"}]}