{"sha": "27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3YzA5ODY0YmQwNGJjM2Y2NWU4Y2U1NzIxZWFhNTYyMWVlOWFjNmE=", "commit": {"author": {"name": "Mark-Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2016-11-11T00:30:01Z"}, "committer": {"name": "Mark-Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2016-11-12T13:42:40Z"}, "message": "Refactor parse_nt.", "tree": {"sha": "796efdc77fd3f8b11f44a9c921b79bb73f77e977", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/796efdc77fd3f8b11f44a9c921b79bb73f77e977"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a", "html_url": "https://github.com/rust-lang/rust/commit/27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "68abb24e8d99f0fb7175c2102da3638814b6b2c7", "url": "https://api.github.com/repos/rust-lang/rust/commits/68abb24e8d99f0fb7175c2102da3638814b6b2c7", "html_url": "https://github.com/rust-lang/rust/commit/68abb24e8d99f0fb7175c2102da3638814b6b2c7"}], "stats": {"total": 21, "additions": 13, "deletions": 8}, "files": [{"sha": "64acce19c1cc47bfc7abb977f1cafb97149455e6", "filename": "src/libsyntax/ext/tt/macro_parser.rs", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs?ref=27c09864bd04bc3f65e8ce5721eaa5621ee9ac6a", "patch": "@@ -479,14 +479,19 @@ pub fn parse_nt<'a>(p: &mut Parser<'a>, sp: Span, name: &str) -> Nonterminal {\n             p.quote_depth += 1; //but in theory, non-quoted tts might be useful\n             let mut tt = panictry!(p.parse_token_tree());\n             p.quote_depth -= 1;\n-            loop {\n-                let nt = match tt {\n-                    TokenTree::Token(_, token::Interpolated(ref nt)) => nt.clone(),\n-                    _ => break,\n-                };\n-                match *nt {\n-                    token::NtTT(ref sub_tt) => tt = sub_tt.clone(),\n-                    _ => break,\n+            while let TokenTree::Token(sp, token::Interpolated(nt)) = tt {\n+                if let token::NtTT(..) = *nt {\n+                    match Rc::try_unwrap(nt) {\n+                        Ok(token::NtTT(sub_tt)) => tt = sub_tt,\n+                        Ok(_) => unreachable!(),\n+                        Err(nt_rc) => match *nt_rc {\n+                            token::NtTT(ref sub_tt) => tt = sub_tt.clone(),\n+                            _ => unreachable!(),\n+                        },\n+                    }\n+                } else {\n+                    tt = TokenTree::Token(sp, token::Interpolated(nt.clone()));\n+                    break\n                 }\n             }\n             return token::NtTT(tt);"}]}