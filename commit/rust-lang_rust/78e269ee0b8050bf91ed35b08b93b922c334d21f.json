{"sha": "78e269ee0b8050bf91ed35b08b93b922c334d21f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc4ZTI2OWVlMGI4MDUwYmY5MWVkMzViMDhiOTNiOTIyYzMzNGQyMWY=", "commit": {"author": {"name": "Oliver Schneider", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2017-11-17T07:55:22Z"}, "committer": {"name": "Oliver Schneider", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2017-11-20T08:37:54Z"}, "message": "Include rendered diagnostic in json", "tree": {"sha": "9df61c46d43d1e8a6d84e28446dd1a12949320d7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9df61c46d43d1e8a6d84e28446dd1a12949320d7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/78e269ee0b8050bf91ed35b08b93b922c334d21f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEYFTdM4NKd7XQft77pp+NIls619kFAloSlGIACgkQpp+NIls6\n19nlkQ/+Jn5VkIFnuyUf5OcJpVq5D9F1wjNSDi2uXW03TIL94cuFkYXZ/2S5rLab\n3ziMxc7lh12gakfMiV70sefAYlKA8Cu4JNRT0zdwzPiaxShNOgee7c0XAN95QASw\nIUWrZeZODPu3AAr/tft2JqqZ56rCVNjbMO4QqYjlCVN8zMBYKZLdGbLjDlh2PS12\nwccEnrYpKh7+NKZOW3OpxTcs17h1gdIlsllkQhwE+LYL4hd7TM6JIXzmG3DHwl77\nM6kywLgBni6e25Ov9NX6qPurF3Soybj/195isnTeQh4ly4uzZkt74vY6jbKx4lIg\nCjftjo05eSDasjh/kmfsRAz9PGgyVkv8nI3JoqNCWG5v95zeh7/asIEuv3fW2M2W\nXlXBKtGHwK5g1eGl71dWZkBPxRKUV5y1lwL5GGy7hnsaTbSZl6gUF+usFxFzPWLc\nxPU1kayXvVk9zX6DEsjB5C57hd1q5AwXSF8mWcHy76/3WcctJnUNvyIEzAF36qRw\nZl2w/QNmWSCrABli8mh3+0OTL+Y+3QkdqPkdj6MBljOK/hgUqZgLs1qMxVNHNa9u\nwMisYNeH7QrM1HmJJcLep39K2tdaTle/MTPXk28BS6+fPbUlPD8sieBsYUjItF5G\n3ikSzvPKreQddzFr58xUnm9utR7ZwFQXThm4qPg6XEm51RuMtHI=\n=Cx7C\n-----END PGP SIGNATURE-----", "payload": "tree 9df61c46d43d1e8a6d84e28446dd1a12949320d7\nparent 580298680ca6500c537662f38b4f56dab9c8c9aa\nauthor Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de> 1510905322 +0100\ncommitter Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de> 1511167074 +0100\n\nInclude rendered diagnostic in json\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/78e269ee0b8050bf91ed35b08b93b922c334d21f", "html_url": "https://github.com/rust-lang/rust/commit/78e269ee0b8050bf91ed35b08b93b922c334d21f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/78e269ee0b8050bf91ed35b08b93b922c334d21f/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "580298680ca6500c537662f38b4f56dab9c8c9aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/580298680ca6500c537662f38b4f56dab9c8c9aa", "html_url": "https://github.com/rust-lang/rust/commit/580298680ca6500c537662f38b4f56dab9c8c9aa"}], "stats": {"total": 195, "additions": 172, "deletions": 23}, "files": [{"sha": "d3f69a66557e82ec00d952cf9ff6e003ed62b4bf", "filename": "src/libsyntax/json.rs", "status": "modified", "additions": 25, "deletions": 3, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Flibsyntax%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Flibsyntax%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fjson.rs?ref=78e269ee0b8050bf91ed35b08b93b922c334d21f", "patch": "@@ -24,11 +24,12 @@ use syntax_pos::{self, MacroBacktrace, Span, SpanLabel, MultiSpan};\n use errors::registry::Registry;\n use errors::{DiagnosticBuilder, SubDiagnostic, CodeSuggestion, CodeMapper};\n use errors::DiagnosticId;\n-use errors::emitter::Emitter;\n+use errors::emitter::{Emitter, EmitterWriter};\n \n use std::rc::Rc;\n use std::io::{self, Write};\n use std::vec;\n+use std::sync::{Arc, Mutex};\n \n use rustc_serialize::json::{as_json, as_pretty_json};\n \n@@ -95,7 +96,7 @@ struct Diagnostic {\n     spans: Vec<DiagnosticSpan>,\n     /// Associated diagnostic messages.\n     children: Vec<Diagnostic>,\n-    /// The message as rustc would render it. Currently this is always `None`\n+    /// The message as rustc would render it.\n     rendered: Option<String>,\n }\n \n@@ -170,6 +171,27 @@ impl Diagnostic {\n                 rendered: None,\n             }\n         });\n+\n+        // generate regular command line output and store it in the json\n+\n+        // A threadsafe buffer for writing.\n+        #[derive(Default, Clone)]\n+        struct BufWriter(Arc<Mutex<Vec<u8>>>);\n+\n+        impl Write for BufWriter {\n+            fn write(&mut self, buf: &[u8]) -> io::Result<usize> {\n+                self.0.lock().unwrap().write(buf)\n+            }\n+            fn flush(&mut self) -> io::Result<()> {\n+                self.0.lock().unwrap().flush()\n+            }\n+        }\n+        let buf = BufWriter::default();\n+        let output = buf.clone();\n+        EmitterWriter::new(Box::new(buf), Some(je.cm.clone()), false).emit(db);\n+        let output = Arc::try_unwrap(output.0).unwrap().into_inner().unwrap();\n+        let output = String::from_utf8(output).unwrap();\n+\n         Diagnostic {\n             message: db.message(),\n             code: DiagnosticCode::map_opt_string(db.code.clone(), je),\n@@ -178,7 +200,7 @@ impl Diagnostic {\n             children: db.children.iter().map(|c| {\n                 Diagnostic::from_sub_diagnostic(c, je)\n             }).chain(sugg).collect(),\n-            rendered: None,\n+            rendered: Some(output.to_owned()),\n         }\n     }\n "}, {"sha": "fe113eda3dd22ce6d67330b5a5d95b6b475183eb", "filename": "src/test/ui/lint/unused_parens_json_suggestion.stderr", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Ftest%2Fui%2Flint%2Funused_parens_json_suggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Ftest%2Fui%2Flint%2Funused_parens_json_suggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_parens_json_suggestion.stderr?ref=78e269ee0b8050bf91ed35b08b93b922c334d21f", "patch": "@@ -87,5 +87,17 @@\n       \"rendered\": null\n     }\n   ],\n-  \"rendered\": null\n+  \"rendered\": \"warning: unnecessary parentheses around assigned value\n+  --> $DIR/unused_parens_json_suggestion.rs:24:14\n+   |\n+24 |     let _a = (1 / (2 + 3));\n+   |              ^^^^^^^^^^^^^ help: remove these parentheses\n+   |\n+note: lint level defined here\n+  --> $DIR/unused_parens_json_suggestion.rs:19:9\n+   |\n+19 | #![warn(unused_parens)]\n+   |         ^^^^^^^^^^^^^\n+\n+\"\n }"}, {"sha": "d716dd53b97d5bd45ed994ff649da79ca2402132", "filename": "src/test/ui/lint/use_suggestion_json.stderr", "status": "modified", "additions": 124, "deletions": 15, "changes": 139, "blob_url": "https://github.com/rust-lang/rust/blob/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Ftest%2Fui%2Flint%2Fuse_suggestion_json.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Ftest%2Fui%2Flint%2Fuse_suggestion_json.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fuse_suggestion_json.stderr?ref=78e269ee0b8050bf91ed35b08b93b922c334d21f", "patch": "@@ -2,7 +2,72 @@\n   \"message\": \"cannot find type `Iter` in this scope\",\n   \"code\": {\n     \"code\": \"E0412\",\n-    \"explanation\": \"/nThe type name used is not in scope./n/nErroneous code examples:/n/n```compile_fail,E0412/nimpl Something {} // error: type name `Something` is not in scope/n/n// or:/n/ntrait Foo {/n    fn bar(N); // error: type name `N` is not in scope/n}/n/n// or:/n/nfn foo(x: T) {} // type name `T` is not in scope/n```/n/nTo fix this error, please verify you didn't misspell the type name, you did/ndeclare it or imported it into the scope. Examples:/n/n```/nstruct Something;/n/nimpl Something {} // ok!/n/n// or:/n/ntrait Foo {/n    type N;/n/n    fn bar(_: Self::N); // ok!/n}/n/n// or:/n/nfn foo<T>(x: T) {} // ok!/n```/n/nAnother case that causes this error is when a type is imported into a parent/nmodule. To fix this, you can follow the suggestion and use File directly or/n`use super::File;` which will import the types from the parent namespace. An/nexample that causes this error is below:/n/n```compile_fail,E0412/nuse std::fs::File;/n/nmod foo {/n    fn some_function(f: File) {}/n}/n```/n/n```/nuse std::fs::File;/n/nmod foo {/n    // either/n    use super::File;/n    // or/n    // use std::fs::File;/n    fn foo(f: File) {}/n}/n# fn main() {} // don't insert it for us; that'll break imports/n```/n\"\n+    \"explanation\": \"\n+The type name used is not in scope.\n+\n+Erroneous code examples:\n+\n+```compile_fail,E0412\n+impl Something {} // error: type name `Something` is not in scope\n+\n+// or:\n+\n+trait Foo {\n+    fn bar(N); // error: type name `N` is not in scope\n+}\n+\n+// or:\n+\n+fn foo(x: T) {} // type name `T` is not in scope\n+```\n+\n+To fix this error, please verify you didn't misspell the type name, you did\n+declare it or imported it into the scope. Examples:\n+\n+```\n+struct Something;\n+\n+impl Something {} // ok!\n+\n+// or:\n+\n+trait Foo {\n+    type N;\n+\n+    fn bar(_: Self::N); // ok!\n+}\n+\n+// or:\n+\n+fn foo<T>(x: T) {} // ok!\n+```\n+\n+Another case that causes this error is when a type is imported into a parent\n+module. To fix this, you can follow the suggestion and use File directly or\n+`use super::File;` which will import the types from the parent namespace. An\n+example that causes this error is below:\n+\n+```compile_fail,E0412\n+use std::fs::File;\n+\n+mod foo {\n+    fn some_function(f: File) {}\n+}\n+```\n+\n+```\n+use std::fs::File;\n+\n+mod foo {\n+    // either\n+    use super::File;\n+    // or\n+    // use std::fs::File;\n+    fn foo(f: File) {}\n+}\n+# fn main() {} // don't insert it for us; that'll break imports\n+```\n+\"\n   },\n   \"level\": \"error\",\n   \"spans\": [\n@@ -50,7 +115,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::binary_heap::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::binary_heap::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -70,7 +137,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::btree_map::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::btree_map::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -90,7 +159,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::btree_set::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::btree_set::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -110,7 +181,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::hash_map::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::hash_map::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -130,7 +203,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::hash_set::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::hash_set::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -150,7 +225,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::linked_list::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::linked_list::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -170,7 +247,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::collections::vec_deque::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::collections::vec_deque::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -190,7 +269,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::option::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::option::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -210,7 +291,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::path::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::path::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -230,7 +313,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::result::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::result::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -250,7 +335,9 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::slice::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::slice::Iter;\n+\n+\",\n           \"expansion\": null\n         },\n         {\n@@ -270,21 +357,43 @@\n             }\n           ],\n           \"label\": null,\n-          \"suggested_replacement\": \"use std::sync::mpsc::Iter;/n/n\",\n+          \"suggested_replacement\": \"use std::sync::mpsc::Iter;\n+\n+\",\n           \"expansion\": null\n         }\n       ],\n       \"children\": [],\n       \"rendered\": null\n     }\n   ],\n-  \"rendered\": null\n+  \"rendered\": \"error[E0412]: cannot find type `Iter` in this scope\n+  --> $DIR/use_suggestion_json.rs:20:12\n+   |\n+20 |     let x: Iter;\n+   |            ^^^^ not found in this scope\n+   |\n+help: possible candidates are found in other modules, you can import them into scope\n+   |\n+19 | use std::collections::binary_heap::Iter;\n+   |\n+19 | use std::collections::btree_map::Iter;\n+   |\n+19 | use std::collections::btree_set::Iter;\n+   |\n+19 | use std::collections::hash_map::Iter;\n+   |\n+and 8 other candidates\n+\n+\"\n }\n {\n   \"message\": \"aborting due to previous error\",\n   \"code\": null,\n   \"level\": \"error\",\n   \"spans\": [],\n   \"children\": [],\n-  \"rendered\": null\n+  \"rendered\": \"error: aborting due to previous error\n+\n+\"\n }"}, {"sha": "b74867aba2d74158fb2ef5ed27d66e79cdc35094", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/78e269ee0b8050bf91ed35b08b93b922c334d21f/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=78e269ee0b8050bf91ed35b08b93b922c334d21f", "patch": "@@ -2400,15 +2400,21 @@ actual:\\n\\\n     fn normalize_output(&self, output: &str, custom_rules: &[(String, String)]) -> String {\n         let parent_dir = self.testpaths.file.parent().unwrap();\n         let cflags = self.props.compile_flags.join(\" \");\n-        let parent_dir_str = if cflags.contains(\"--error-format json\")\n-                             || cflags.contains(\"--error-format pretty-json\") {\n+        let json = cflags.contains(\"--error-format json\") ||\n+                   cflags.contains(\"--error-format pretty-json\");\n+        let parent_dir_str = if json {\n             parent_dir.display().to_string().replace(\"\\\\\", \"\\\\\\\\\")\n         } else {\n             parent_dir.display().to_string()\n         };\n \n-        let mut normalized = output.replace(&parent_dir_str, \"$DIR\")\n-              .replace(\"\\\\\\\\\", \"\\\\\") // denormalize for paths on windows\n+        let mut normalized = output.replace(&parent_dir_str, \"$DIR\");\n+\n+        if json {\n+            normalized = normalized.replace(\"\\\\n\", \"\\n\"); // verbatim newline in json strings\n+        }\n+\n+        normalized = normalized.replace(\"\\\\\\\\\", \"\\\\\") // denormalize for paths on windows\n               .replace(\"\\\\\", \"/\") // normalize for paths on windows\n               .replace(\"\\r\\n\", \"\\n\") // normalize for linebreaks on windows\n               .replace(\"\\t\", \"\\\\t\"); // makes tabs visible"}]}