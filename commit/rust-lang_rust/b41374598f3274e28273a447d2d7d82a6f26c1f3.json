{"sha": "b41374598f3274e28273a447d2d7d82a6f26c1f3", "node_id": "C_kwDOAAsO6NoAKGI0MTM3NDU5OGYzMjc0ZTI4MjczYTQ0N2QyZDdkODJhNmYyNmMxZjM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-03-10T18:00:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-03-10T18:00:05Z"}, "message": "Rollup merge of #94440 - compiler-errors:issue-94282, r=lcnr\n\nBetter error for normalization errors from parent crates that use `#![feature(generic_const_exprs)]`\n\nThis PR implements a somewhat rudimentary heuristic to suggest using `#![feature(generic_const_exprs)]` in a child crate when a function from a foreign crate (that may have used `#![feature(generic_const_exprs)]`) fails to normalize during codegen.\n\ncc: #79018\ncc: #94287", "tree": {"sha": "4b77913b043c34b54088f7874dbe887be0980cb7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b77913b043c34b54088f7874dbe887be0980cb7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b41374598f3274e28273a447d2d7d82a6f26c1f3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiKjymCRBK7hj4Ov3rIwAAazUIAEfyza/jilukAfr9rpGJoKgi\ndNzv2QA945P9MRbFPU0/jm3OdlMUrkVwCMm9gMIAP3dOodh6n5BsfelWtMTlhaem\nqUmSElR+OgweY14Ae8jtNUewTZrtVjJ2Cgpol64/USgPpNmoXM6S9RWEuZYk/UXK\n6HqffBFIlAK5xvgSAfGw0C/acDmsgbgSFocP06j64uCzxAhwAHaE7gWny4t7L/J8\ne6SjgOfz7A9zmnStJSOaVq8ydrVJdr6qvSPhOgSCE1Pmf6VAkFo+/6GxouGzFAW2\nB42V5JVCCSNGHZGRddL7pt+JZps3h9r70UqS/Vfl0KkSa7n/eFFCvAx5nz9tvlI=\n=Z75Z\n-----END PGP SIGNATURE-----\n", "payload": "tree 4b77913b043c34b54088f7874dbe887be0980cb7\nparent ba14a836c7038da21f5e102aacc7e6d5964f79a6\nparent 109cdc754ed893edb25d2d2c1493023858c8eccb\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1646935205 +0100\ncommitter GitHub <noreply@github.com> 1646935205 +0100\n\nRollup merge of #94440 - compiler-errors:issue-94282, r=lcnr\n\nBetter error for normalization errors from parent crates that use `#![feature(generic_const_exprs)]`\n\nThis PR implements a somewhat rudimentary heuristic to suggest using `#![feature(generic_const_exprs)]` in a child crate when a function from a foreign crate (that may have used `#![feature(generic_const_exprs)]`) fails to normalize during codegen.\n\ncc: #79018\ncc: #94287\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b41374598f3274e28273a447d2d7d82a6f26c1f3", "html_url": "https://github.com/rust-lang/rust/commit/b41374598f3274e28273a447d2d7d82a6f26c1f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b41374598f3274e28273a447d2d7d82a6f26c1f3/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba14a836c7038da21f5e102aacc7e6d5964f79a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba14a836c7038da21f5e102aacc7e6d5964f79a6", "html_url": "https://github.com/rust-lang/rust/commit/ba14a836c7038da21f5e102aacc7e6d5964f79a6"}, {"sha": "109cdc754ed893edb25d2d2c1493023858c8eccb", "url": "https://api.github.com/repos/rust-lang/rust/commits/109cdc754ed893edb25d2d2c1493023858c8eccb", "html_url": "https://github.com/rust-lang/rust/commit/109cdc754ed893edb25d2d2c1493023858c8eccb"}], "stats": {"total": 133, "additions": 108, "deletions": 25}, "files": [{"sha": "f880b28b3c8dc2f12d7b26ca6304ff482190886d", "filename": "compiler/rustc_trait_selection/src/traits/const_evaluatable.rs", "status": "modified", "additions": 63, "deletions": 25, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/b41374598f3274e28273a447d2d7d82a6f26c1f3/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fconst_evaluatable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b41374598f3274e28273a447d2d7d82a6f26c1f3/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fconst_evaluatable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fconst_evaluatable.rs?ref=b41374598f3274e28273a447d2d7d82a6f26c1f3", "patch": "@@ -35,34 +35,14 @@ pub fn is_const_evaluatable<'cx, 'tcx>(\n     span: Span,\n ) -> Result<(), NotConstEvaluatable> {\n     debug!(\"is_const_evaluatable({:?})\", uv);\n-    if infcx.tcx.features().generic_const_exprs {\n-        let tcx = infcx.tcx;\n+    let tcx = infcx.tcx;\n+\n+    if tcx.features().generic_const_exprs {\n         match AbstractConst::new(tcx, uv)? {\n             // We are looking at a generic abstract constant.\n             Some(ct) => {\n-                for pred in param_env.caller_bounds() {\n-                    match pred.kind().skip_binder() {\n-                        ty::PredicateKind::ConstEvaluatable(uv) => {\n-                            if let Some(b_ct) = AbstractConst::new(tcx, uv)? {\n-                                // Try to unify with each subtree in the AbstractConst to allow for\n-                                // `N + 1` being const evaluatable even if theres only a `ConstEvaluatable`\n-                                // predicate for `(N + 1) * 2`\n-                                let result =\n-                                    walk_abstract_const(tcx, b_ct, |b_ct| {\n-                                        match try_unify(tcx, ct, b_ct) {\n-                                            true => ControlFlow::BREAK,\n-                                            false => ControlFlow::CONTINUE,\n-                                        }\n-                                    });\n-\n-                                if let ControlFlow::Break(()) = result {\n-                                    debug!(\"is_const_evaluatable: abstract_const ~~> ok\");\n-                                    return Ok(());\n-                                }\n-                            }\n-                        }\n-                        _ => {} // don't care\n-                    }\n+                if satisfied_from_param_env(tcx, ct, param_env)? {\n+                    return Ok(());\n                 }\n \n                 // We were unable to unify the abstract constant with\n@@ -163,6 +143,33 @@ pub fn is_const_evaluatable<'cx, 'tcx>(\n         }\n     }\n \n+    // If we're evaluating a foreign constant, under a nightly compiler without generic\n+    // const exprs, AND it would've passed if that expression had been evaluated with\n+    // generic const exprs, then suggest using generic const exprs.\n+    if concrete.is_err()\n+        && tcx.sess.is_nightly_build()\n+        && !uv.def.did.is_local()\n+        && !tcx.features().generic_const_exprs\n+        && let Ok(Some(ct)) = AbstractConst::new(tcx, uv)\n+        && satisfied_from_param_env(tcx, ct, param_env) == Ok(true)\n+    {\n+        tcx.sess\n+            .struct_span_fatal(\n+                // Slightly better span than just using `span` alone\n+                if span == rustc_span::DUMMY_SP { tcx.def_span(uv.def.did) } else { span },\n+                \"failed to evaluate generic const expression\",\n+            )\n+            .note(\"the crate this constant originates from uses `#![feature(generic_const_exprs)]`\")\n+            .span_suggestion_verbose(\n+                rustc_span::DUMMY_SP,\n+                \"consider enabling this feature\",\n+                \"#![feature(generic_const_exprs)]\\n\".to_string(),\n+                rustc_errors::Applicability::MaybeIncorrect,\n+            )\n+            .emit();\n+        rustc_errors::FatalError.raise();\n+    }\n+\n     debug!(?concrete, \"is_const_evaluatable\");\n     match concrete {\n         Err(ErrorHandled::TooGeneric) => Err(match uv.has_infer_types_or_consts() {\n@@ -178,6 +185,37 @@ pub fn is_const_evaluatable<'cx, 'tcx>(\n     }\n }\n \n+fn satisfied_from_param_env<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    ct: AbstractConst<'tcx>,\n+    param_env: ty::ParamEnv<'tcx>,\n+) -> Result<bool, NotConstEvaluatable> {\n+    for pred in param_env.caller_bounds() {\n+        match pred.kind().skip_binder() {\n+            ty::PredicateKind::ConstEvaluatable(uv) => {\n+                if let Some(b_ct) = AbstractConst::new(tcx, uv)? {\n+                    // Try to unify with each subtree in the AbstractConst to allow for\n+                    // `N + 1` being const evaluatable even if theres only a `ConstEvaluatable`\n+                    // predicate for `(N + 1) * 2`\n+                    let result =\n+                        walk_abstract_const(tcx, b_ct, |b_ct| match try_unify(tcx, ct, b_ct) {\n+                            true => ControlFlow::BREAK,\n+                            false => ControlFlow::CONTINUE,\n+                        });\n+\n+                    if let ControlFlow::Break(()) = result {\n+                        debug!(\"is_const_evaluatable: abstract_const ~~> ok\");\n+                        return Ok(true);\n+                    }\n+                }\n+            }\n+            _ => {} // don't care\n+        }\n+    }\n+\n+    Ok(false)\n+}\n+\n /// A tree representing an anonymous constant.\n ///\n /// This is only able to represent a subset of `MIR`,"}, {"sha": "df454dae7250f5f19cb42b9dbf261fbfb65f6225", "filename": "src/test/ui/const-generics/generic_const_exprs/auxiliary/issue-94287-aux.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/b41374598f3274e28273a447d2d7d82a6f26c1f3/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fauxiliary%2Fissue-94287-aux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b41374598f3274e28273a447d2d7d82a6f26c1f3/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fauxiliary%2Fissue-94287-aux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fauxiliary%2Fissue-94287-aux.rs?ref=b41374598f3274e28273a447d2d7d82a6f26c1f3", "patch": "@@ -0,0 +1,21 @@\n+#![feature(generic_const_exprs)]\n+\n+use std::str::FromStr;\n+\n+pub struct If<const CONDITION: bool>;\n+\n+pub trait True {}\n+\n+impl True for If<true> {}\n+\n+pub struct FixedI32<const FRAC: u32>;\n+\n+impl<const FRAC: u32> FromStr for FixedI32<FRAC>\n+where\n+    If<{ FRAC <= 32 }>: True,\n+{\n+    type Err = ();\n+    fn from_str(_s: &str) -> Result<Self, Self::Err> {\n+        unimplemented!()\n+    }\n+}"}, {"sha": "643126a4640a8896b0189f20bb674ab53b5f2666", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-94287.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b41374598f3274e28273a447d2d7d82a6f26c1f3/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-94287.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b41374598f3274e28273a447d2d7d82a6f26c1f3/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-94287.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-94287.rs?ref=b41374598f3274e28273a447d2d7d82a6f26c1f3", "patch": "@@ -0,0 +1,10 @@\n+// aux-build:issue-94287-aux.rs\n+// build-fail\n+\n+extern crate issue_94287_aux;\n+\n+use std::str::FromStr;\n+\n+fn main() {\n+    let _ = <issue_94287_aux::FixedI32<16>>::from_str(\"\");\n+}"}, {"sha": "c918651ba62d986d603e3df5c19d22e3e74ecc38", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-94287.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b41374598f3274e28273a447d2d7d82a6f26c1f3/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-94287.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b41374598f3274e28273a447d2d7d82a6f26c1f3/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-94287.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-94287.stderr?ref=b41374598f3274e28273a447d2d7d82a6f26c1f3", "patch": "@@ -0,0 +1,14 @@\n+error: failed to evaluate generic const expression\n+  --> $DIR/auxiliary/issue-94287-aux.rs:15:8\n+   |\n+LL |     If<{ FRAC <= 32 }>: True,\n+   |        ^^^^^^^^^^^^^^\n+   |\n+   = note: the crate this constant originates from uses `#![feature(generic_const_exprs)]`\n+help: consider enabling this feature\n+   |\n+LL | #![feature(generic_const_exprs)]\n+   |\n+\n+error: aborting due to previous error\n+"}]}