{"sha": "50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "node_id": "C_kwDOAAsO6NoAKDUwZTVkMDNlMTY3OTA0MDBmMGM1YjZjZTZkM2EyN2Y2YTcxYzUyOTg", "commit": {"author": {"name": "yukang", "email": "moorekang@gmail.com", "date": "2022-08-14T06:09:16Z"}, "committer": {"name": "yukang", "email": "moorekang@gmail.com", "date": "2022-09-08T15:26:57Z"}, "message": "Avoid infinite loop in function arguments checking", "tree": {"sha": "d1c7d93435bae87a0b9429f805f3c9db4f14a4d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1c7d93435bae87a0b9429f805f3c9db4f14a4d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "html_url": "https://github.com/rust-lang/rust/commit/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/comments", "author": {"login": "chenyukang", "id": 230646, "node_id": "MDQ6VXNlcjIzMDY0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/230646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chenyukang", "html_url": "https://github.com/chenyukang", "followers_url": "https://api.github.com/users/chenyukang/followers", "following_url": "https://api.github.com/users/chenyukang/following{/other_user}", "gists_url": "https://api.github.com/users/chenyukang/gists{/gist_id}", "starred_url": "https://api.github.com/users/chenyukang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chenyukang/subscriptions", "organizations_url": "https://api.github.com/users/chenyukang/orgs", "repos_url": "https://api.github.com/users/chenyukang/repos", "events_url": "https://api.github.com/users/chenyukang/events{/privacy}", "received_events_url": "https://api.github.com/users/chenyukang/received_events", "type": "User", "site_admin": false}, "committer": {"login": "chenyukang", "id": 230646, "node_id": "MDQ6VXNlcjIzMDY0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/230646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chenyukang", "html_url": "https://github.com/chenyukang", "followers_url": "https://api.github.com/users/chenyukang/followers", "following_url": "https://api.github.com/users/chenyukang/following{/other_user}", "gists_url": "https://api.github.com/users/chenyukang/gists{/gist_id}", "starred_url": "https://api.github.com/users/chenyukang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chenyukang/subscriptions", "organizations_url": "https://api.github.com/users/chenyukang/orgs", "repos_url": "https://api.github.com/users/chenyukang/repos", "events_url": "https://api.github.com/users/chenyukang/events{/privacy}", "received_events_url": "https://api.github.com/users/chenyukang/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c7278846102bb829c9a789e91bc43f0ed612943", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c7278846102bb829c9a789e91bc43f0ed612943", "html_url": "https://github.com/rust-lang/rust/commit/3c7278846102bb829c9a789e91bc43f0ed612943"}], "stats": {"total": 154, "additions": 147, "deletions": 7}, "files": [{"sha": "90a2589d747e0295dd851d19bc9b7f170f09e03b", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/arg_matrix.rs", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Farg_matrix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Farg_matrix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Farg_matrix.rs?ref=50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "patch": "@@ -130,21 +130,25 @@ impl<'tcx> ArgMatrix<'tcx> {\n         let ai = &self.expected_indices;\n         let ii = &self.provided_indices;\n \n+        // Issue: 100478, when we end the iteration,\n+        // `next_unmatched_idx` will point to the index of the first unmatched\n+        let mut next_unmatched_idx = 0;\n         for i in 0..cmp::max(ai.len(), ii.len()) {\n-            // If we eliminate the last row, any left-over inputs are considered missing\n+            // If we eliminate the last row, any left-over arguments are considered missing\n             if i >= mat.len() {\n-                return Some(Issue::Missing(i));\n+                return Some(Issue::Missing(next_unmatched_idx));\n             }\n-            // If we eliminate the last column, any left-over arguments are extra\n+            // If we eliminate the last column, any left-over inputs are extra\n             if mat[i].len() == 0 {\n-                return Some(Issue::Extra(i));\n+                return Some(Issue::Extra(next_unmatched_idx));\n             }\n \n             // Make sure we don't pass the bounds of our matrix\n             let is_arg = i < ai.len();\n             let is_input = i < ii.len();\n             if is_arg && is_input && matches!(mat[i][i], Compatibility::Compatible) {\n                 // This is a satisfied input, so move along\n+                next_unmatched_idx += 1;\n                 continue;\n             }\n \n@@ -163,7 +167,7 @@ impl<'tcx> ArgMatrix<'tcx> {\n             if is_input {\n                 for j in 0..ai.len() {\n                     // If we find at least one argument that could satisfy this input\n-                    // this argument isn't useless\n+                    // this input isn't useless\n                     if matches!(mat[i][j], Compatibility::Compatible) {\n                         useless = false;\n                         break;\n@@ -309,7 +313,8 @@ impl<'tcx> ArgMatrix<'tcx> {\n         }\n \n         while !self.provided_indices.is_empty() || !self.expected_indices.is_empty() {\n-            match self.find_issue() {\n+            let res = self.find_issue();\n+            match res {\n                 Some(Issue::Invalid(idx)) => {\n                     let compatibility = self.compatibility_matrix[idx][idx].clone();\n                     let input_idx = self.provided_indices[idx];\n@@ -364,7 +369,9 @@ impl<'tcx> ArgMatrix<'tcx> {\n                 None => {\n                     // We didn't find any issues, so we need to push the algorithm forward\n                     // First, eliminate any arguments that currently satisfy their inputs\n-                    for (inp, arg) in self.eliminate_satisfied() {\n+                    let eliminated = self.eliminate_satisfied();\n+                    assert!(!eliminated.is_empty(), \"didn't eliminated any indice in this round\");\n+                    for (inp, arg) in eliminated {\n                         matched_inputs[arg] = Some(inp);\n                     }\n                 }"}, {"sha": "6bef6ad103862dec8f851e7c1cdd4878f03c2b17", "filename": "src/test/ui/argument-suggestions/issue-100478.rs", "status": "added", "additions": 52, "deletions": 0, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/src%2Ftest%2Fui%2Fargument-suggestions%2Fissue-100478.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/src%2Ftest%2Fui%2Fargument-suggestions%2Fissue-100478.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fargument-suggestions%2Fissue-100478.rs?ref=50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "patch": "@@ -0,0 +1,52 @@\n+use std::sync::Arc;\n+macro_rules! GenT {\n+    ($name:tt) => {\n+        #[derive(Default, Debug)]\n+        struct $name {\n+            #[allow(unused)]\n+            val: i32,\n+        }\n+\n+        impl $name {\n+            #[allow(unused)]\n+            fn new(val: i32) -> Self {\n+                $name { val }\n+            }\n+        }\n+    };\n+}\n+\n+GenT!(T1);\n+GenT!(T2);\n+GenT!(T3);\n+GenT!(T4);\n+GenT!(T5);\n+GenT!(T6);\n+GenT!(T7);\n+GenT!(T8);\n+\n+#[allow(unused)]\n+fn foo(p1: T1, p2: Arc<T2>, p3: T3, p4: Arc<T4>, p5: T5, p6: T6, p7: T7, p8: Arc<T8>) {}\n+fn three_diff(_a: T1, _b: T2, _c: T3) {}\n+fn four_shuffle(_a: T1, _b: T2, _c: T3, _d: T4) {}\n+\n+fn main() {\n+    three_diff(T2::new(0)); //~ ERROR this function takes\n+    four_shuffle(T3::default(), T4::default(), T1::default(), T2::default()); //~ ERROR 35:5: 35:17: arguments to this function are incorrect [E0308]\n+    four_shuffle(T3::default(), T2::default(), T1::default(), T3::default()); //~ ERROR 36:5: 36:17: arguments to this function are incorrect [E0308]\n+\n+    let p1 = T1::new(0);\n+    let p2 = Arc::new(T2::new(0));\n+    let p3 = T3::new(0);\n+    let p4 = Arc::new(T4::new(1));\n+    let p5 = T5::new(0);\n+    let p6 = T6::new(0);\n+    let p7 = T7::new(0);\n+    let p8 = Arc::default();\n+\n+    foo(\n+        //~^ 47:5: 47:8: this function takes 8 arguments but 7 arguments were supplied [E0061]\n+        p1, //p2,\n+        p3, p4, p5, p6, p7, p8,\n+    );\n+}"}, {"sha": "a77889a9679cad839850083327751062a1bd4c65", "filename": "src/test/ui/argument-suggestions/issue-100478.stderr", "status": "added", "additions": 81, "deletions": 0, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/src%2Ftest%2Fui%2Fargument-suggestions%2Fissue-100478.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/50e5d03e16790400f0c5b6ce6d3a27f6a71c5298/src%2Ftest%2Fui%2Fargument-suggestions%2Fissue-100478.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fargument-suggestions%2Fissue-100478.stderr?ref=50e5d03e16790400f0c5b6ce6d3a27f6a71c5298", "patch": "@@ -0,0 +1,81 @@\n+error[E0061]: this function takes 3 arguments but 1 argument was supplied\n+  --> $DIR/issue-100478.rs:34:5\n+   |\n+LL |     three_diff(T2::new(0));\n+   |     ^^^^^^^^^^------------\n+   |               ||\n+   |               |an argument of type `T1` is missing\n+   |               an argument of type `T3` is missing\n+   |\n+note: function defined here\n+  --> $DIR/issue-100478.rs:30:4\n+   |\n+LL | fn three_diff(_a: T1, _b: T2, _c: T3) {}\n+   |    ^^^^^^^^^^ ------  ------  ------\n+help: provide the arguments\n+   |\n+LL |     three_diff(/* T1 */, T2::new(0), /* T3 */);\n+   |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+error[E0308]: arguments to this function are incorrect\n+  --> $DIR/issue-100478.rs:35:5\n+   |\n+LL |     four_shuffle(T3::default(), T4::default(), T1::default(), T2::default());\n+   |     ^^^^^^^^^^^^ -------------  -------------  -------------  ------------- expected `T4`, found `T2`\n+   |                  |              |              |\n+   |                  |              |              expected `T3`, found `T1`\n+   |                  |              expected `T2`, found `T4`\n+   |                  expected `T1`, found `T3`\n+   |\n+note: function defined here\n+  --> $DIR/issue-100478.rs:31:4\n+   |\n+LL | fn four_shuffle(_a: T1, _b: T2, _c: T3, _d: T4) {}\n+   |    ^^^^^^^^^^^^ ------  ------  ------  ------\n+help: did you mean\n+   |\n+LL |     four_shuffle(T1::default(), T2::default(), T3::default(), T4::default());\n+   |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+error[E0308]: arguments to this function are incorrect\n+  --> $DIR/issue-100478.rs:36:5\n+   |\n+LL |     four_shuffle(T3::default(), T2::default(), T1::default(), T3::default());\n+   |     ^^^^^^^^^^^^ -------------                 -------------  ------------- expected struct `T4`, found struct `T3`\n+   |                  |                             |\n+   |                  |                             expected `T3`, found `T1`\n+   |                  expected `T1`, found `T3`\n+   |\n+note: function defined here\n+  --> $DIR/issue-100478.rs:31:4\n+   |\n+LL | fn four_shuffle(_a: T1, _b: T2, _c: T3, _d: T4) {}\n+   |    ^^^^^^^^^^^^ ------  ------  ------  ------\n+help: swap these arguments\n+   |\n+LL |     four_shuffle(T1::default(), T2::default(), T3::default(), /* T4 */);\n+   |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+error[E0061]: this function takes 8 arguments but 7 arguments were supplied\n+  --> $DIR/issue-100478.rs:47:5\n+   |\n+LL |     foo(\n+   |     ^^^\n+...\n+LL |         p3, p4, p5, p6, p7, p8,\n+   |         -- an argument of type `Arc<T2>` is missing\n+   |\n+note: function defined here\n+  --> $DIR/issue-100478.rs:29:4\n+   |\n+LL | fn foo(p1: T1, p2: Arc<T2>, p3: T3, p4: Arc<T4>, p5: T5, p6: T6, p7: T7, p8: Arc<T8>) {}\n+   |    ^^^ ------  -----------  ------  -----------  ------  ------  ------  -----------\n+help: provide the argument\n+   |\n+LL |     foo(p1, /* Arc<T2> */, p3, p4, p5, p6, p7, p8);\n+   |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+error: aborting due to 4 previous errors\n+\n+Some errors have detailed explanations: E0061, E0308.\n+For more information about an error, try `rustc --explain E0061`."}]}