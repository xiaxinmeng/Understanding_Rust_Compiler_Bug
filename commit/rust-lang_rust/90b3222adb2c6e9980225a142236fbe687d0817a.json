{"sha": "90b3222adb2c6e9980225a142236fbe687d0817a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkwYjMyMjJhZGIyYzZlOTk4MDIyNWExNDIyMzZmYmU2ODdkMDgxN2E=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-10-27T09:48:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-10-27T09:48:13Z"}, "message": "Merge pull request #2090 from topecongiro/issue-2087\n\nOnly read the trailing comma of outermost fn call", "tree": {"sha": "b0b2bc7e0e5f1b06ff381796bb88d35e75ff15e8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0b2bc7e0e5f1b06ff381796bb88d35e75ff15e8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90b3222adb2c6e9980225a142236fbe687d0817a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90b3222adb2c6e9980225a142236fbe687d0817a", "html_url": "https://github.com/rust-lang/rust/commit/90b3222adb2c6e9980225a142236fbe687d0817a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90b3222adb2c6e9980225a142236fbe687d0817a/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f159d32c1f9cc497ac7d613c4e505877b9ed79fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/f159d32c1f9cc497ac7d613c4e505877b9ed79fa", "html_url": "https://github.com/rust-lang/rust/commit/f159d32c1f9cc497ac7d613c4e505877b9ed79fa"}, {"sha": "fa7d8de29fba0d691b3ba543e90f272afe499e36", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa7d8de29fba0d691b3ba543e90f272afe499e36", "html_url": "https://github.com/rust-lang/rust/commit/fa7d8de29fba0d691b3ba543e90f272afe499e36"}], "stats": {"total": 31, "additions": 27, "deletions": 4}, "files": [{"sha": "9a020646927599c683b1011414e26c77ba39b8b6", "filename": "src/expr.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/90b3222adb2c6e9980225a142236fbe687d0817a/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b3222adb2c6e9980225a142236fbe687d0817a/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=90b3222adb2c6e9980225a142236fbe687d0817a", "patch": "@@ -2365,11 +2365,24 @@ pub fn wrap_args_with_parens(\n     }\n }\n \n+/// Return true if a function call or a method call represented by the given span ends with a\n+/// trailing comma. This function is used when rewriting macro, as adding or removing a trailing\n+/// comma from macro can potentially break the code.\n fn span_ends_with_comma(context: &RewriteContext, span: Span) -> bool {\n-    let snippet = context.snippet(span);\n-    snippet\n-        .trim_right_matches(|c: char| c == ')' || c.is_whitespace())\n-        .ends_with(',')\n+    let mut encountered_closing_paren = false;\n+    for c in context.snippet(span).chars().rev() {\n+        match c {\n+            ',' => return true,\n+            ')' => if encountered_closing_paren {\n+                return false;\n+            } else {\n+                encountered_closing_paren = true;\n+            },\n+            _ if c.is_whitespace() => continue,\n+            _ => return false,\n+        }\n+    }\n+    false\n }\n \n fn rewrite_paren(context: &RewriteContext, subexpr: &ast::Expr, shape: Shape) -> Option<String> {"}, {"sha": "73044aa7ab2ca6f69271d41b973102ba95ec939a", "filename": "tests/source/macros.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/90b3222adb2c6e9980225a142236fbe687d0817a/tests%2Fsource%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b3222adb2c6e9980225a142236fbe687d0817a/tests%2Fsource%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmacros.rs?ref=90b3222adb2c6e9980225a142236fbe687d0817a", "patch": "@@ -21,6 +21,12 @@ fn main() {\n     kaas!(/* comments */ a /* post macro */, b /* another */);\n \n     trailingcomma!( a , b , c , );\n+    // Preserve trailing comma only when necessary.\n+    ok!(file.seek(\n+        SeekFrom::Start(\n+            table.map(|table| fixture.offset(table)).unwrap_or(0),\n+        )\n+    ));\n \n     noexpr!( i am not an expression, OK? );\n "}, {"sha": "a15dd14c9fb7806eab6b3c82fe3339fa999aabf8", "filename": "tests/target/macros.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/90b3222adb2c6e9980225a142236fbe687d0817a/tests%2Ftarget%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b3222adb2c6e9980225a142236fbe687d0817a/tests%2Ftarget%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacros.rs?ref=90b3222adb2c6e9980225a142236fbe687d0817a", "patch": "@@ -33,6 +33,10 @@ fn main() {\n     );\n \n     trailingcomma!(a, b, c,);\n+    // Preserve trailing comma only when necessary.\n+    ok!(file.seek(SeekFrom::Start(\n+        table.map(|table| fixture.offset(table)).unwrap_or(0),\n+    )));\n \n     noexpr!( i am not an expression, OK? );\n "}]}