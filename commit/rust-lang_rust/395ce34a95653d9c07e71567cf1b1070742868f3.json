{"sha": "395ce34a95653d9c07e71567cf1b1070742868f3", "node_id": "C_kwDOAAsO6NoAKDM5NWNlMzRhOTU2NTNkOWMwN2U3MTU2N2NmMWIxMDcwNzQyODY4ZjM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-08-29T11:19:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-29T11:19:43Z"}, "message": "Rollup merge of #100819 - WaffleLapkin:use_ptr_byte_methods, r=scottmcm\n\nMake use of `[wrapping_]byte_{add,sub}`\n\nThese new methods trivially replace old `.cast().wrapping_offset().cast()` & similar code.\nNote that [`arith_offset`](https://doc.rust-lang.org/std/intrinsics/fn.arith_offset.html) and `wrapping_offset` are the same thing.\n\nr? ``@scottmcm``\n\n_split off from #100746_", "tree": {"sha": "5ecffc7c79b97dabeca8b6de0dc22130a2cdb60c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ecffc7c79b97dabeca8b6de0dc22130a2cdb60c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/395ce34a95653d9c07e71567cf1b1070742868f3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjDKDPCRBK7hj4Ov3rIwAA/fUIAKOoO6KwdBPwcvQfUzoHx6DC\nEM4rh91q9L1SFxAEbJQ53ezB3PoNkrVxDrhPw6hedECfAZwbo6PHca3wifErfOL4\npqoCgBG+VOFEa2WEWuw61Hokildgf/DZBm1DCo7zYd4k7pDUtfmsclKyXLEbq2Br\nL6RDpTAy1LDbKZCFKenwR94STsWu78Ud7tJLzEuPmyb7Pgf920C9OmteucZCi12x\nIpZTJPN+bWXxDBWSXZKHQeRrWMgZLUJSugXRKbza0tu08FevVSCb2SUt8vmdJoc0\n4P2YnVukLf/8PtFfgBpRHZ2bvr7NQEfGdpz4jQk1KvpL6Tu/LtARQPUQ+MSS5LY=\n=PZJt\n-----END PGP SIGNATURE-----\n", "payload": "tree 5ecffc7c79b97dabeca8b6de0dc22130a2cdb60c\nparent 9f7e20ba3542d79150e33d181512494d37462400\nparent 53565b23ac21bc15be1feab9fb316fce7a73e21c\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1661771983 +0530\ncommitter GitHub <noreply@github.com> 1661771983 +0530\n\nRollup merge of #100819 - WaffleLapkin:use_ptr_byte_methods, r=scottmcm\n\nMake use of `[wrapping_]byte_{add,sub}`\n\nThese new methods trivially replace old `.cast().wrapping_offset().cast()` & similar code.\nNote that [`arith_offset`](https://doc.rust-lang.org/std/intrinsics/fn.arith_offset.html) and `wrapping_offset` are the same thing.\n\nr? ``@scottmcm``\n\n_split off from #100746_\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/395ce34a95653d9c07e71567cf1b1070742868f3", "html_url": "https://github.com/rust-lang/rust/commit/395ce34a95653d9c07e71567cf1b1070742868f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/395ce34a95653d9c07e71567cf1b1070742868f3/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f7e20ba3542d79150e33d181512494d37462400", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f7e20ba3542d79150e33d181512494d37462400", "html_url": "https://github.com/rust-lang/rust/commit/9f7e20ba3542d79150e33d181512494d37462400"}, {"sha": "53565b23ac21bc15be1feab9fb316fce7a73e21c", "url": "https://api.github.com/repos/rust-lang/rust/commits/53565b23ac21bc15be1feab9fb316fce7a73e21c", "html_url": "https://github.com/rust-lang/rust/commit/53565b23ac21bc15be1feab9fb316fce7a73e21c"}], "stats": {"total": 35, "additions": 17, "deletions": 18}, "files": [{"sha": "46dbbd83d19054e2c2aaf8e4751c68a9aaf974d0", "filename": "compiler/rustc_arena/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/compiler%2Frustc_arena%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/compiler%2Frustc_arena%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_arena%2Fsrc%2Flib.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -16,6 +16,7 @@\n #![feature(maybe_uninit_slice)]\n #![feature(min_specialization)]\n #![feature(decl_macro)]\n+#![feature(pointer_byte_offsets)]\n #![feature(rustc_attrs)]\n #![cfg_attr(test, feature(test))]\n #![feature(strict_provenance)]\n@@ -211,7 +212,7 @@ impl<T> TypedArena<T> {\n \n         unsafe {\n             if mem::size_of::<T>() == 0 {\n-                self.ptr.set((self.ptr.get() as *mut u8).wrapping_offset(1) as *mut T);\n+                self.ptr.set(self.ptr.get().wrapping_byte_add(1));\n                 let ptr = ptr::NonNull::<T>::dangling().as_ptr();\n                 // Don't drop the object. This `write` is equivalent to `forget`.\n                 ptr::write(ptr, object);"}, {"sha": "ed049194dd068d584c9f0604cfe09be892617508", "filename": "library/alloc/src/vec/into_iter.rs", "status": "modified", "additions": 5, "deletions": 8, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Falloc%2Fsrc%2Fvec%2Finto_iter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Falloc%2Fsrc%2Fvec%2Finto_iter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fvec%2Finto_iter.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -4,7 +4,6 @@ use crate::alloc::{Allocator, Global};\n use crate::raw_vec::RawVec;\n use core::array;\n use core::fmt;\n-use core::intrinsics::arith_offset;\n use core::iter::{\n     FusedIterator, InPlaceIterable, SourceIter, TrustedLen, TrustedRandomAccessNoCoerce,\n };\n@@ -154,7 +153,7 @@ impl<T, A: Allocator> Iterator for IntoIter<T, A> {\n             // purposefully don't use 'ptr.offset' because for\n             // vectors with 0-size elements this would return the\n             // same pointer.\n-            self.ptr = unsafe { arith_offset(self.ptr as *const i8, 1) as *mut T };\n+            self.ptr = self.ptr.wrapping_byte_add(1);\n \n             // Make up a value of this ZST.\n             Some(unsafe { mem::zeroed() })\n@@ -184,7 +183,7 @@ impl<T, A: Allocator> Iterator for IntoIter<T, A> {\n             // SAFETY: due to unchecked casts of unsigned amounts to signed offsets the wraparound\n             // effectively results in unsigned pointers representing positions 0..usize::MAX,\n             // which is valid for ZSTs.\n-            self.ptr = unsafe { arith_offset(self.ptr as *const i8, step_size as isize) as *mut T }\n+            self.ptr = self.ptr.wrapping_byte_add(step_size);\n         } else {\n             // SAFETY: the min() above ensures that step_size is in bounds\n             self.ptr = unsafe { self.ptr.add(step_size) };\n@@ -217,7 +216,7 @@ impl<T, A: Allocator> Iterator for IntoIter<T, A> {\n                 return Err(unsafe { array::IntoIter::new_unchecked(raw_ary, 0..len) });\n             }\n \n-            self.ptr = unsafe { arith_offset(self.ptr as *const i8, N as isize) as *mut T };\n+            self.ptr = self.ptr.wrapping_byte_add(N);\n             // Safety: ditto\n             return Ok(unsafe { MaybeUninit::array_assume_init(raw_ary) });\n         }\n@@ -267,7 +266,7 @@ impl<T, A: Allocator> DoubleEndedIterator for IntoIter<T, A> {\n             None\n         } else if mem::size_of::<T>() == 0 {\n             // See above for why 'ptr.offset' isn't used\n-            self.end = unsafe { arith_offset(self.end as *const i8, -1) as *mut T };\n+            self.end = self.ptr.wrapping_byte_sub(1);\n \n             // Make up a value of this ZST.\n             Some(unsafe { mem::zeroed() })\n@@ -283,9 +282,7 @@ impl<T, A: Allocator> DoubleEndedIterator for IntoIter<T, A> {\n         let step_size = self.len().min(n);\n         if mem::size_of::<T>() == 0 {\n             // SAFETY: same as for advance_by()\n-            self.end = unsafe {\n-                arith_offset(self.end as *const i8, step_size.wrapping_neg() as isize) as *mut T\n-            }\n+            self.end = self.end.wrapping_byte_sub(step_size);\n         } else {\n             // SAFETY: same as for advance_by()\n             self.end = unsafe { self.end.sub(step_size) };"}, {"sha": "1f19b9e594549d534ca82e9c314868ba45082b89", "filename": "library/alloc/src/vec/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Falloc%2Fsrc%2Fvec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Falloc%2Fsrc%2Fvec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fvec%2Fmod.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -59,7 +59,7 @@ use core::cmp::Ordering;\n use core::convert::TryFrom;\n use core::fmt;\n use core::hash::{Hash, Hasher};\n-use core::intrinsics::{arith_offset, assume};\n+use core::intrinsics::assume;\n use core::iter;\n #[cfg(not(no_global_oom_handling))]\n use core::iter::FromIterator;\n@@ -2678,7 +2678,7 @@ impl<T, A: Allocator> IntoIterator for Vec<T, A> {\n             let alloc = ManuallyDrop::new(ptr::read(me.allocator()));\n             let begin = me.as_mut_ptr();\n             let end = if mem::size_of::<T>() == 0 {\n-                arith_offset(begin as *const i8, me.len() as isize) as *const T\n+                begin.wrapping_byte_add(me.len())\n             } else {\n                 begin.add(me.len()) as *const T\n             };"}, {"sha": "ef7b3b1d1470a1778950922e5803339bc50dda4e", "filename": "library/core/src/ptr/const_ptr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -249,7 +249,7 @@ impl<T: ?Sized> *const T {\n         let offset = dest_addr.wrapping_sub(self_addr);\n \n         // This is the canonical desugarring of this operation\n-        self.cast::<u8>().wrapping_offset(offset).cast::<T>()\n+        self.wrapping_byte_offset(offset)\n     }\n \n     /// Creates a new pointer by mapping `self`'s address to a new one."}, {"sha": "6a3b9ee9a7daa618a19f9bf933a0067e5997e030", "filename": "library/core/src/ptr/mut_ptr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -255,7 +255,7 @@ impl<T: ?Sized> *mut T {\n         let offset = dest_addr.wrapping_sub(self_addr);\n \n         // This is the canonical desugarring of this operation\n-        self.cast::<u8>().wrapping_offset(offset).cast::<T>()\n+        self.wrapping_byte_offset(offset)\n     }\n \n     /// Creates a new pointer by mapping `self`'s address to a new one."}, {"sha": "47455760a4bd7f9199185a32d3d15bc68ab7b11a", "filename": "library/core/src/slice/iter/macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Fsrc%2Fslice%2Fiter%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Fsrc%2Fslice%2Fiter%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fslice%2Fiter%2Fmacros.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -64,7 +64,7 @@ macro_rules! iterator {\n         // backwards by `n`. `n` must not exceed `self.len()`.\n         macro_rules! zst_shrink {\n             ($self: ident, $n: ident) => {\n-                $self.end = ($self.end as * $raw_mut u8).wrapping_offset(-$n) as * $raw_mut T;\n+                $self.end = $self.end.wrapping_byte_offset(-$n);\n             }\n         }\n "}, {"sha": "94b0310603bf41ccd7d16675513a544098e7561e", "filename": "library/core/tests/atomic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Ftests%2Fatomic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Ftests%2Fatomic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fatomic.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -155,7 +155,7 @@ fn ptr_add_data() {\n \n     assert_eq!(atom.fetch_ptr_sub(1, SeqCst), n.wrapping_add(1));\n     assert_eq!(atom.load(SeqCst), n);\n-    let bytes_from_n = |b| n.cast::<u8>().wrapping_add(b).cast::<i64>();\n+    let bytes_from_n = |b| n.wrapping_byte_add(b);\n \n     assert_eq!(atom.fetch_byte_add(1, SeqCst), n);\n     assert_eq!(atom.load(SeqCst), bytes_from_n(1));"}, {"sha": "97a369810056dceefcdef14ad542fe4a0e15fd93", "filename": "library/core/tests/ptr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Ftests%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fcore%2Ftests%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fptr.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -650,7 +650,7 @@ fn thin_box() {\n                     .unwrap_or_else(|| handle_alloc_error(layout))\n                     .cast::<DynMetadata<T>>();\n                 ptr.as_ptr().write(meta);\n-                ptr.cast::<u8>().as_ptr().add(offset).cast::<Value>().write(value);\n+                ptr.as_ptr().byte_add(offset).cast::<Value>().write(value);\n                 Self { ptr, phantom: PhantomData }\n             }\n         }"}, {"sha": "781ae03ad45dcb865c66d90b45a6109d28c7fad8", "filename": "library/std/src/io/error/repr_bitpacked.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fstd%2Fsrc%2Fio%2Ferror%2Frepr_bitpacked.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fstd%2Fsrc%2Fio%2Ferror%2Frepr_bitpacked.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Ferror%2Frepr_bitpacked.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -269,10 +269,10 @@ where\n         }\n         TAG_SIMPLE_MESSAGE => ErrorData::SimpleMessage(&*ptr.cast::<SimpleMessage>().as_ptr()),\n         TAG_CUSTOM => {\n-            // It would be correct for us to use `ptr::sub` here (see the\n+            // It would be correct for us to use `ptr::byte_sub` here (see the\n             // comment above the `wrapping_add` call in `new_custom` for why),\n             // but it isn't clear that it makes a difference, so we don't.\n-            let custom = ptr.as_ptr().cast::<u8>().wrapping_sub(TAG_CUSTOM).cast::<Custom>();\n+            let custom = ptr.as_ptr().wrapping_byte_sub(TAG_CUSTOM).cast::<Custom>();\n             ErrorData::Custom(make_custom(custom))\n         }\n         _ => {"}, {"sha": "8936e11b8e02eb854d438a1a7ffdefb9e74fc098", "filename": "library/std/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fstd%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/395ce34a95653d9c07e71567cf1b1070742868f3/library%2Fstd%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flib.rs?ref=395ce34a95653d9c07e71567cf1b1070742868f3", "patch": "@@ -300,6 +300,7 @@\n #![feature(panic_can_unwind)]\n #![feature(panic_info_message)]\n #![feature(panic_internals)]\n+#![feature(pointer_byte_offsets)]\n #![feature(pointer_is_aligned)]\n #![feature(portable_simd)]\n #![feature(prelude_2024)]"}]}