{"sha": "a37ba96868d67b0631e7e50b75993eba4dadcdf3", "node_id": "C_kwDOAAsO6NoAKGEzN2JhOTY4NjhkNjdiMDYzMWU3ZTUwYjc1OTkzZWJhNGRhZGNkZjM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-05-15T06:10:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-15T06:10:44Z"}, "message": "Rollup merge of #97041 - eddyb:nixos-llvm-ci-patchelf, r=Mark-Simulacrum\n\nFix `download-ci-llvm` NixOS patching for `.so`s.\n\nSee https://github.com/rust-lang/rust/pull/95170#discussion_r872960686 - in short, `Path::ends_with` doesn't do the same thing as `str::ends_with`, and can only be used to check for whole file names, not extensions.\n\nWith this PR, I get the full suite of:\n```\nextracting /home/eddy/Projects/rust-A/build/cache/llvm-ebb80ec4e90f8622440f3e33562db0d6e6c66555-true/rust-dev-nightly-x86_64-unknown-linux-gnu.tar.xz to /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm\ninfo: you seem to be using Nix. Attempting to patch /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm/bin/llvm-config\n/nix/store/r4bzq2xilvv8fmqjg626hzwi22ah3hf4-rust-stage0-dependencies\ninfo: you seem to be using Nix. Attempting to patch /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm/bin/FileCheck\ninfo: you seem to be using Nix. Attempting to patch /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm/lib/libLLVM-14-rust-1.62.0-nightly.so\n```\n(that `libLLVM-14-rust-1.62.0-nightly.so` at the end having been missing before)\n\nr? `@Mark-Simulacrum` cc `@jyn514`", "tree": {"sha": "23d00ede7c4892ad5399145d5d2cb3f4083c8842", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23d00ede7c4892ad5399145d5d2cb3f4083c8842"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a37ba96868d67b0631e7e50b75993eba4dadcdf3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJigJlkCRBK7hj4Ov3rIwAAPOoIAFuvofgGUBugkybBZXgXM50f\ndGpN6XjEhM2uq1aLX1tI0Cc0016gXObNi0o0tg1yC+eub6VdU/NzcYLQ/W1t3d1G\nG625c6U5mkCdwPn3aFZsjc0Nho0Vb3ah9Mr4PNFAErVepfLE7UkhqAl31ROrGF+1\nGVlKsvXDzN1hl91QhJ83666TpYgfSliNi5mmkXqzQ7mMqswkO7ZEiSwqIz54loe5\nB4Ye3WseNWGJ27xZwtbfmsmCCgOhBtfubvsFvA/dagXZrrsSwliVfy4BBB+C3BWE\nsRkZ2fGKgTvCFJL0+unKiI69gGQQSOjQ0RKCDCINuBMm+f/qO+8+P5zPcqex9Bo=\n=Z0LL\n-----END PGP SIGNATURE-----\n", "payload": "tree 23d00ede7c4892ad5399145d5d2cb3f4083c8842\nparent 673d45124ba5369ffc0a1e9ccea0d299289e9981\nparent f38555c3b3a39b75e9016897f405c795c5afdf18\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1652595044 +0200\ncommitter GitHub <noreply@github.com> 1652595044 +0200\n\nRollup merge of #97041 - eddyb:nixos-llvm-ci-patchelf, r=Mark-Simulacrum\n\nFix `download-ci-llvm` NixOS patching for `.so`s.\n\nSee https://github.com/rust-lang/rust/pull/95170#discussion_r872960686 - in short, `Path::ends_with` doesn't do the same thing as `str::ends_with`, and can only be used to check for whole file names, not extensions.\n\nWith this PR, I get the full suite of:\n```\nextracting /home/eddy/Projects/rust-A/build/cache/llvm-ebb80ec4e90f8622440f3e33562db0d6e6c66555-true/rust-dev-nightly-x86_64-unknown-linux-gnu.tar.xz to /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm\ninfo: you seem to be using Nix. Attempting to patch /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm/bin/llvm-config\n/nix/store/r4bzq2xilvv8fmqjg626hzwi22ah3hf4-rust-stage0-dependencies\ninfo: you seem to be using Nix. Attempting to patch /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm/bin/FileCheck\ninfo: you seem to be using Nix. Attempting to patch /home/eddy/Projects/rust-A/build/x86_64-unknown-linux-gnu/ci-llvm/lib/libLLVM-14-rust-1.62.0-nightly.so\n```\n(that `libLLVM-14-rust-1.62.0-nightly.so` at the end having been missing before)\n\nr? `@Mark-Simulacrum` cc `@jyn514`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a37ba96868d67b0631e7e50b75993eba4dadcdf3", "html_url": "https://github.com/rust-lang/rust/commit/a37ba96868d67b0631e7e50b75993eba4dadcdf3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a37ba96868d67b0631e7e50b75993eba4dadcdf3/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "673d45124ba5369ffc0a1e9ccea0d299289e9981", "url": "https://api.github.com/repos/rust-lang/rust/commits/673d45124ba5369ffc0a1e9ccea0d299289e9981", "html_url": "https://github.com/rust-lang/rust/commit/673d45124ba5369ffc0a1e9ccea0d299289e9981"}, {"sha": "f38555c3b3a39b75e9016897f405c795c5afdf18", "url": "https://api.github.com/repos/rust-lang/rust/commits/f38555c3b3a39b75e9016897f405c795c5afdf18", "html_url": "https://github.com/rust-lang/rust/commit/f38555c3b3a39b75e9016897f405c795c5afdf18"}], "stats": {"total": 4, "additions": 2, "deletions": 2}, "files": [{"sha": "77292f62d387041e42bef6c34bdfa1613f5e3419", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a37ba96868d67b0631e7e50b75993eba4dadcdf3/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a37ba96868d67b0631e7e50b75993eba4dadcdf3/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=a37ba96868d67b0631e7e50b75993eba4dadcdf3", "patch": "@@ -156,7 +156,7 @@ pub(crate) fn maybe_download_ci_llvm(builder: &Builder<'_>) {\n         let llvm_lib = llvm_root.join(\"lib\");\n         for entry in t!(fs::read_dir(&llvm_lib)) {\n             let lib = t!(entry).path();\n-            if lib.ends_with(\".so\") {\n+            if lib.extension().map_or(false, |ext| ext == \"so\") {\n                 fix_bin_or_dylib(builder, &lib);\n             }\n         }\n@@ -284,7 +284,7 @@ fn fix_bin_or_dylib(builder: &Builder<'_>, fname: &Path) {\n         entries\n     };\n     patchelf.args(&[OsString::from(\"--set-rpath\"), rpath_entries]);\n-    if !fname.ends_with(\".so\") {\n+    if !fname.extension().map_or(false, |ext| ext == \"so\") {\n         // Finally, set the corret .interp for binaries\n         let dynamic_linker_path = nix_deps_dir.join(\"nix-support/dynamic-linker\");\n         // FIXME: can we support utf8 here? `args` doesn't accept Vec<u8>, only OsString ..."}]}