{"sha": "8193133f3548390559936fdaf377f5ef951ffd29", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxOTMxMzNmMzU0ODM5MDU1OTkzNmZkYWYzNzdmNWVmOTUxZmZkMjk=", "commit": {"author": {"name": "Steven Fackler", "email": "sfackler@gmail.com", "date": "2015-06-21T02:54:15Z"}, "committer": {"name": "Steven Fackler", "email": "sfackler@gmail.com", "date": "2015-06-21T02:54:15Z"}, "message": "Fix logic in panic printing with no stderr\n\nIf a local stderr is present but the normal stderr is missing, we still\nwant to print.", "tree": {"sha": "a0975a4809a2988f844b18e0d88e4e4f32d310e6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a0975a4809a2988f844b18e0d88e4e4f32d310e6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8193133f3548390559936fdaf377f5ef951ffd29", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8193133f3548390559936fdaf377f5ef951ffd29", "html_url": "https://github.com/rust-lang/rust/commit/8193133f3548390559936fdaf377f5ef951ffd29", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8193133f3548390559936fdaf377f5ef951ffd29/comments", "author": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ad0063a1772edca3299e2dc76187bbfa74e8b16", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ad0063a1772edca3299e2dc76187bbfa74e8b16", "html_url": "https://github.com/rust-lang/rust/commit/9ad0063a1772edca3299e2dc76187bbfa74e8b16"}], "stats": {"total": 23, "additions": 12, "deletions": 11}, "files": [{"sha": "bb4375c1b8826203aa47b35677bacf248c8a500b", "filename": "src/libstd/panicking.rs", "status": "modified", "additions": 12, "deletions": 11, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/8193133f3548390559936fdaf377f5ef951ffd29/src%2Flibstd%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8193133f3548390559936fdaf377f5ef951ffd29/src%2Flibstd%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpanicking.rs?ref=8193133f3548390559936fdaf377f5ef951ffd29", "patch": "@@ -31,15 +31,12 @@ pub fn on_panic(obj: &(Any+Send), file: &'static str, line: u32) {\n             None => \"Box<Any>\",\n         }\n     };\n-    let mut err = match Stderr::new() {\n-        Ok(err) => err,\n-        _ => return,\n-    };\n+    let mut err = Stderr::new().ok();\n     let thread = thread_info::current_thread();\n     let name = thread.as_ref().and_then(|t| t.name()).unwrap_or(\"<unnamed>\");\n     let prev = LOCAL_STDERR.with(|s| s.borrow_mut().take());\n-    match prev {\n-        Some(mut stderr) => {\n+    match (prev, err.as_mut()) {\n+        (Some(mut stderr), _) => {\n             // FIXME: what to do when the thread printing panics?\n             let _ = writeln!(stderr,\n                              \"thread '{}' panicked at '{}', {}:{}\\n\",\n@@ -52,18 +49,22 @@ pub fn on_panic(obj: &(Any+Send), file: &'static str, line: u32) {\n                 *slot.borrow_mut() = s.take();\n             });\n         }\n-        None => {\n-            let _ = writeln!(&mut err, \"thread '{}' panicked at '{}', {}:{}\",\n+        (None, Some(ref mut err)) => {\n+            let _ = writeln!(err, \"thread '{}' panicked at '{}', {}:{}\",\n                              name, msg, file, line);\n             if backtrace::log_enabled() {\n-                let _ = backtrace::write(&mut err);\n+                let _ = backtrace::write(err);\n             }\n         }\n+        _ => {}\n     }\n \n     // If this is a double panic, make sure that we printed a backtrace\n     // for this panic.\n-    if unwind::panicking() && !backtrace::log_enabled() {\n-        let _ = backtrace::write(&mut err);\n+    match err {\n+        Some(ref mut err) if unwind::panicking() && !backtrace::log_enabled() => {\n+            let _ = backtrace::write(err);\n+        }\n+        _ => {}\n     }\n }"}]}