{"sha": "f0e6ce8035a8c12d2342c68814f00529a410b77d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYwZTZjZTgwMzVhOGMxMmQyMzQyYzY4ODE0ZjAwNTI5YTQxMGI3N2Q=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-04T23:28:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-04T23:28:50Z"}, "message": "Auto merge of #6846 - matthiaskrgr:lintcheck_test, r=Manishearth\n\nlintcheck: add test (but don't run on ci)\n\nThis is the rest of https://github.com/rust-lang/rust-clippy/pull/6829 but without adding anything to ci\n\n*Please write a short comment explaining your change (or \"none\" for internal only changes)*\nchangelog: none", "tree": {"sha": "8f02541a374517ec9fc08497ab92a1a4d3d77b6e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f02541a374517ec9fc08497ab92a1a4d3d77b6e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f0e6ce8035a8c12d2342c68814f00529a410b77d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f0e6ce8035a8c12d2342c68814f00529a410b77d", "html_url": "https://github.com/rust-lang/rust/commit/f0e6ce8035a8c12d2342c68814f00529a410b77d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f0e6ce8035a8c12d2342c68814f00529a410b77d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7be3a32f25f514fa376cfbdfd6e89d77d0dd350e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7be3a32f25f514fa376cfbdfd6e89d77d0dd350e", "html_url": "https://github.com/rust-lang/rust/commit/7be3a32f25f514fa376cfbdfd6e89d77d0dd350e"}, {"sha": "3f7ad32a997c4947e7f010abe980862a2ff21f34", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f7ad32a997c4947e7f010abe980862a2ff21f34", "html_url": "https://github.com/rust-lang/rust/commit/3f7ad32a997c4947e7f010abe980862a2ff21f34"}], "stats": {"total": 42, "additions": 40, "deletions": 2}, "files": [{"sha": "01f3c9a5bd8a23ec4ff73d519bbc12f49fcf2c83", "filename": "clippy_dev/src/lintcheck.rs", "status": "modified", "additions": 31, "deletions": 1, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/f0e6ce8035a8c12d2342c68814f00529a410b77d/clippy_dev%2Fsrc%2Flintcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0e6ce8035a8c12d2342c68814f00529a410b77d/clippy_dev%2Fsrc%2Flintcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Flintcheck.rs?ref=f0e6ce8035a8c12d2342c68814f00529a410b77d", "patch": "@@ -503,6 +503,10 @@ fn gather_stats(clippy_warnings: &[ClippyWarning]) -> (String, HashMap<&String,\n /// check if the latest modification of the logfile is older than the modification date of the\n /// clippy binary, if this is true, we should clean the lintchec shared target directory and recheck\n fn lintcheck_needs_rerun(lintcheck_logs_path: &Path) -> bool {\n+    if !lintcheck_logs_path.exists() {\n+        return true;\n+    }\n+\n     let clippy_modified: std::time::SystemTime = {\n         let mut times = [CLIPPY_DRIVER_PATH, CARGO_CLIPPY_PATH].iter().map(|p| {\n             std::fs::metadata(p)\n@@ -665,7 +669,6 @@ fn read_stats_from_file(file_path: &Path) -> HashMap<String, usize> {\n     let file_content: String = match std::fs::read_to_string(file_path).ok() {\n         Some(content) => content,\n         None => {\n-            eprintln!(\"RETURND\");\n             return HashMap::new();\n         },\n     };\n@@ -734,3 +737,30 @@ fn print_stats(old_stats: HashMap<String, usize>, new_stats: HashMap<&String, us\n             println!(\"{} {} => 0\", old_key, old_value);\n         });\n }\n+\n+#[test]\n+fn lintcheck_test() {\n+    let args = [\n+        \"run\",\n+        \"--target-dir\",\n+        \"clippy_dev/target\",\n+        \"--package\",\n+        \"clippy_dev\",\n+        \"--bin\",\n+        \"clippy_dev\",\n+        \"--manifest-path\",\n+        \"clippy_dev/Cargo.toml\",\n+        \"--features\",\n+        \"lintcheck\",\n+        \"--\",\n+        \"lintcheck\",\n+        \"--crates-toml\",\n+        \"clippy_dev/test_sources.toml\",\n+    ];\n+    let status = std::process::Command::new(\"cargo\")\n+        .args(&args)\n+        .current_dir(\"../\" /* repo root */)\n+        .status();\n+\n+    assert!(status.unwrap().success());\n+}"}, {"sha": "4b0eb71ef4bfe1fa01c103e0c3e8be283ba18b1e", "filename": "clippy_dev/test_sources.toml", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f0e6ce8035a8c12d2342c68814f00529a410b77d/clippy_dev%2Ftest_sources.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f0e6ce8035a8c12d2342c68814f00529a410b77d/clippy_dev%2Ftest_sources.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Ftest_sources.toml?ref=f0e6ce8035a8c12d2342c68814f00529a410b77d", "patch": "@@ -0,0 +1,4 @@\n+[crates]\n+cc = {name = \"cc\", versions = ['1.0.67']}\n+home = {name = \"home\", git_url = \"https://github.com/brson/home\", git_hash = \"32044e53dfbdcd32bafad3109d1fbab805fc0f40\"}\n+rustc_tools_util = {name = \"rustc_tools_util\", versions = ['0.2.0']}"}, {"sha": "47453f362547ada294dc24bf7a6d3ca9fd8fb50e", "filename": "lintcheck-logs/lintcheck_crates_logs.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f0e6ce8035a8c12d2342c68814f00529a410b77d/lintcheck-logs%2Flintcheck_crates_logs.txt", "raw_url": "https://github.com/rust-lang/rust/raw/f0e6ce8035a8c12d2342c68814f00529a410b77d/lintcheck-logs%2Flintcheck_crates_logs.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lintcheck-logs%2Flintcheck_crates_logs.txt?ref=f0e6ce8035a8c12d2342c68814f00529a410b77d", "patch": "@@ -1,4 +1,4 @@\n-clippy 0.1.52 (70d952e75 2021-02-28)\n+clippy 0.1.52 (37c4b11a8 2021-03-04)\n \n target/lintcheck/sources/anyhow-1.0.38/build.rs:1:null clippy::cargo_common_metadata \"package `anyhow` is missing `package.keywords` metadata\"\n target/lintcheck/sources/anyhow-1.0.38/src/error.rs:350:5 clippy::missing_panics_doc \"docs for function which may panic missing `# Panics` section\"\n@@ -99,6 +99,7 @@ target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:1:null clippy::multi\n target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:1:null clippy::multiple_crate_versions \"multiple versions for dependency `hex`: 0.3.2, 0.4.0\"\n target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:1:null clippy::multiple_crate_versions \"multiple versions for dependency `humantime`: 1.3.0, 2.0.0\"\n target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:72:22 clippy::redundant_closure_for_method_calls \"redundant closure found\"\n+target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:79:40 clippy::manual_map \"manual implementation of `Option::map`\"\n target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:94:13 clippy::match_wildcard_for_single_variants \"wildcard match will miss any future added variants\"\n target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:96:41 clippy::redundant_closure_for_method_calls \"redundant closure found\"\n target/lintcheck/sources/cargo-0.49.0/src/bin/cargo/main.rs:98:60 clippy::redundant_closure_for_method_calls \"redundant closure found\"\n@@ -1208,6 +1209,7 @@ target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/mod.rs:689:20 clippy\n target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/mod.rs:699:5 clippy::fn_params_excessive_bools \"more than 3 bools in function parameters\"\n target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/mod.rs:699:5 clippy::missing_errors_doc \"docs for function returning `Result` missing `# Errors` section\"\n target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/mod.rs:719:58 clippy::redundant_closure_for_method_calls \"redundant closure found\"\n+target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/mod.rs:748:30 clippy::manual_map \"manual implementation of `Option::map`\"\n target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/mod.rs:816:5 clippy::missing_errors_doc \"docs for function returning `Result` missing `# Errors` section\"\n target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/path.rs:10:1 clippy::module_name_repetitions \"item name ends with its containing module's name\"\n target/lintcheck/sources/cargo-0.49.0/src/cargo/util/config/path.rs:14:5 clippy::must_use_candidate \"this method could have a `#[must_use]` attribute\"\n@@ -1463,6 +1465,7 @@ target/lintcheck/sources/cfg-expr-0.7.1/src/expr/mod.rs:464:5 clippy::missing_pa\n target/lintcheck/sources/cfg-expr-0.7.1/src/expr/mod.rs:57:13 clippy::enum_glob_use \"usage of wildcard import for enum variants\"\n target/lintcheck/sources/cfg-expr-0.7.1/src/expr/mod.rs:586:33 clippy::match_same_arms \"this `match` has identical arm bodies\"\n target/lintcheck/sources/cfg-expr-0.7.1/src/expr/mod.rs:599:32 clippy::match_same_arms \"this `match` has identical arm bodies\"\n+target/lintcheck/sources/cfg-expr-0.7.1/src/expr/mod.rs:609:9 clippy::manual_map \"manual implementation of `Option::map`\"\n target/lintcheck/sources/cfg-expr-0.7.1/src/expr/parser.rs:116:31 clippy::similar_names \"binding's name is too similar to existing binding\"\n target/lintcheck/sources/cfg-expr-0.7.1/src/expr/parser.rs:124:36 clippy::similar_names \"binding's name is too similar to existing binding\"\n target/lintcheck/sources/cfg-expr-0.7.1/src/expr/parser.rs:17:5 clippy::missing_errors_doc \"docs for function returning `Result` missing `# Errors` section\"\n@@ -3509,6 +3512,7 @@ clippy::filter_map_next 3\n clippy::fn_params_excessive_bools 3\n clippy::if_same_then_else 3\n clippy::inconsistent_struct_constructor 3\n+clippy::manual_map 3\n clippy::mut_mut 3\n clippy::ptr_arg 3\n clippy::zero_ptr 3"}]}