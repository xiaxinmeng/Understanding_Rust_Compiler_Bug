{"sha": "af7b00b68fc7960e98fb914be52d9a6a16fe2224", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmN2IwMGI2OGZjNzk2MGU5OGZiOTE0YmU1MmQ5YTZhMTZmZTIyMjQ=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-04-06T11:45:31Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-04-06T11:45:31Z"}, "message": "Rollup merge of #32682 - petrochenkov:field3, r=Manishearth\n\n The AST part of https://github.com/rust-lang/rust/pull/31937\n\nUnlike HIR, AST still uses `Option` for field names because parser can't know field indexes reliably due to constructions like\n```\nstruct S(#[cfg(false)] u8, u8); // The index of the second field changes from 1 during parsing to 0 after expansion.\n```\nand I wouldn't like to put the burden of renaming fields on expansion passes and syntax extensions.\n\nplugin-[breaking-change] cc https://github.com/rust-lang/rust/issues/31645\nr? @Manishearth", "tree": {"sha": "13260050b5b5463c491ae61c941f60477421fdc0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/13260050b5b5463c491ae61c941f60477421fdc0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af7b00b68fc7960e98fb914be52d9a6a16fe2224", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af7b00b68fc7960e98fb914be52d9a6a16fe2224", "html_url": "https://github.com/rust-lang/rust/commit/af7b00b68fc7960e98fb914be52d9a6a16fe2224", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af7b00b68fc7960e98fb914be52d9a6a16fe2224/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "772c600d4d6f39daa6d07d1a60ee0df3d3426978", "url": "https://api.github.com/repos/rust-lang/rust/commits/772c600d4d6f39daa6d07d1a60ee0df3d3426978", "html_url": "https://github.com/rust-lang/rust/commit/772c600d4d6f39daa6d07d1a60ee0df3d3426978"}, {"sha": "8fe4290f1cf87bf7b0a0661e6bbe84f3319e614d", "url": "https://api.github.com/repos/rust-lang/rust/commits/8fe4290f1cf87bf7b0a0661e6bbe84f3319e614d", "html_url": "https://github.com/rust-lang/rust/commit/8fe4290f1cf87bf7b0a0661e6bbe84f3319e614d"}], "stats": {"total": 248, "additions": 84, "deletions": 164}, "files": [{"sha": "46ac38467068537b5f0410418c4f12c0fb10943d", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -978,7 +978,7 @@ impl<'a, 'v> ast_visit::Visitor<'v> for EarlyContext<'a> {\n     }\n \n     fn visit_struct_field(&mut self, s: &ast::StructField) {\n-        self.with_lint_attrs(&s.node.attrs, |cx| {\n+        self.with_lint_attrs(&s.attrs, |cx| {\n             run_lints!(cx, check_struct_field, early_passes, s);\n             ast_visit::walk_struct_field(cx, s);\n         })"}, {"sha": "738a04dea585de7a7498e8eee67fc6ad68329f0d", "filename": "src/librustc_front/lowering.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc_front%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc_front%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Flowering.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -621,12 +621,11 @@ pub fn lower_struct_field(lctx: &LoweringContext,\n                           -> hir::StructField {\n     hir::StructField {\n         span: f.span,\n-        id: f.node.id,\n-        name: f.node.ident().map(|ident| ident.name)\n-                            .unwrap_or(token::intern(&index.to_string())),\n-        vis: lower_visibility(lctx, f.node.kind.visibility()),\n-        ty: lower_ty(lctx, &f.node.ty),\n-        attrs: lower_attrs(lctx, &f.node.attrs),\n+        id: f.id,\n+        name: f.ident.map(|ident| ident.name).unwrap_or(token::intern(&index.to_string())),\n+        vis: lower_visibility(lctx, &f.vis),\n+        ty: lower_ty(lctx, &f.ty),\n+        attrs: lower_attrs(lctx, &f.attrs),\n     }\n }\n "}, {"sha": "e9cfd24d41047f536439d50a0003bc974fce74b5", "filename": "src/librustc_save_analysis/dump_visitor.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdump_visitor.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -563,7 +563,7 @@ where D: Dump\n         // fields\n         for field in def.fields() {\n             self.process_struct_field_def(field, item.id);\n-            self.visit_ty(&field.node.ty);\n+            self.visit_ty(&field.ty);\n         }\n \n         self.process_generic_params(ty_params, item.span, &qualname, item.id);\n@@ -624,7 +624,7 @@ where D: Dump\n \n             for field in variant.node.data.fields() {\n                 self.process_struct_field_def(field, variant.node.data.id());\n-                self.visit_ty(&field.node.ty);\n+                self.visit_ty(&field.ty);\n             }\n         }\n         self.process_generic_params(ty_params, item.span, &enum_data.qualname, enum_data.id);"}, {"sha": "95339c7937161fd73417afaefb5ee3c277c3f201", "filename": "src/librustc_save_analysis/lib.rs", "status": "modified", "additions": 16, "deletions": 17, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc_save_analysis%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibrustc_save_analysis%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Flib.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -246,23 +246,22 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n \n     pub fn get_field_data(&self, field: &ast::StructField,\n                           scope: NodeId) -> Option<VariableData> {\n-        match field.node.kind {\n-            ast::NamedField(ident, _) => {\n-                let qualname = format!(\"::{}::{}\", self.tcx.map.path_to_string(scope), ident);\n-                let typ = self.tcx.node_types().get(&field.node.id).unwrap().to_string();\n-                let sub_span = self.span_utils.sub_span_before_token(field.span, token::Colon);\n-                filter!(self.span_utils, sub_span, field.span, None);\n-                Some(VariableData {\n-                    id: field.node.id,\n-                    name: ident.to_string(),\n-                    qualname: qualname,\n-                    span: sub_span.unwrap(),\n-                    scope: scope,\n-                    value: \"\".to_owned(),\n-                    type_value: typ,\n-                })\n-            }\n-            _ => None,\n+        if let Some(ident) = field.ident {\n+            let qualname = format!(\"::{}::{}\", self.tcx.map.path_to_string(scope), ident);\n+            let typ = self.tcx.node_types().get(&field.id).unwrap().to_string();\n+            let sub_span = self.span_utils.sub_span_before_token(field.span, token::Colon);\n+            filter!(self.span_utils, sub_span, field.span, None);\n+            Some(VariableData {\n+                id: field.id,\n+                name: ident.to_string(),\n+                qualname: qualname,\n+                span: sub_span.unwrap(),\n+                scope: scope,\n+                value: \"\".to_owned(),\n+                type_value: typ,\n+            })\n+        } else {\n+            None\n         }\n     }\n "}, {"sha": "dbe7b078498ea3ec96ddb020fe4c687e8ad2592c", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 4, "deletions": 36, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -10,7 +10,6 @@\n \n // The Rust abstract syntax tree.\n \n-pub use self::StructFieldKind::*;\n pub use self::TyParamBound::*;\n pub use self::UnsafeSource::*;\n pub use self::ViewPath_::*;\n@@ -1877,46 +1876,15 @@ pub enum Visibility {\n }\n \n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n-pub struct StructField_ {\n-    pub kind: StructFieldKind,\n+pub struct StructField {\n+    pub span: Span,\n+    pub ident: Option<Ident>,\n+    pub vis: Visibility,\n     pub id: NodeId,\n     pub ty: P<Ty>,\n     pub attrs: Vec<Attribute>,\n }\n \n-impl StructField_ {\n-    pub fn ident(&self) -> Option<Ident> {\n-        match self.kind {\n-            NamedField(ref ident, _) => Some(ident.clone()),\n-            UnnamedField(_) => None\n-        }\n-    }\n-}\n-\n-pub type StructField = Spanned<StructField_>;\n-\n-#[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n-pub enum StructFieldKind {\n-    NamedField(Ident, Visibility),\n-    /// Element of a tuple-like struct\n-    UnnamedField(Visibility),\n-}\n-\n-impl StructFieldKind {\n-    pub fn is_unnamed(&self) -> bool {\n-        match *self {\n-            UnnamedField(..) => true,\n-            NamedField(..) => false,\n-        }\n-    }\n-\n-    pub fn visibility(&self) -> &Visibility {\n-        match *self {\n-            NamedField(_, ref vis) | UnnamedField(ref vis) => vis\n-        }\n-    }\n-}\n-\n /// Fields and Ids of enum variants and structs\n ///\n /// For enum variants: `NodeId` represents both an Id of the variant itself (relevant for all"}, {"sha": "ffba9e824d4ad2779ffad7b46dc77f2271015a6d", "filename": "src/libsyntax/ast_util.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fast_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fast_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast_util.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -95,12 +95,6 @@ pub fn impl_pretty_name(trait_ref: &Option<TraitRef>, ty: Option<&Ty>) -> Ident\n     token::gensym_ident(&pretty[..])\n }\n \n-pub fn struct_field_visibility(field: ast::StructField) -> Visibility {\n-    match field.node.kind {\n-        ast::NamedField(_, v) | ast::UnnamedField(v) => v\n-    }\n-}\n-\n // ______________________________________________________________________\n // Enumerating the IDs which appear in an AST\n \n@@ -269,7 +263,7 @@ impl<'a, 'v, O: IdVisitingOperation> Visitor<'v> for IdVisitor<'a, O> {\n     }\n \n     fn visit_struct_field(&mut self, struct_field: &StructField) {\n-        self.operation.visit_id(struct_field.node.id);\n+        self.operation.visit_id(struct_field.id);\n         visit::walk_struct_field(self, struct_field)\n     }\n "}, {"sha": "4554a280e5f198c1ddf11fc0e7dbf7750e40603e", "filename": "src/libsyntax/config.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fconfig.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -180,12 +180,12 @@ fn fold_struct<F>(cx: &mut Context<F>, vdata: ast::VariantData) -> ast::VariantD\n     match vdata {\n         ast::VariantData::Struct(fields, id) => {\n             ast::VariantData::Struct(fields.into_iter().filter(|m| {\n-                (cx.in_cfg)(&m.node.attrs)\n+                (cx.in_cfg)(&m.attrs)\n             }).collect(), id)\n         }\n         ast::VariantData::Tuple(fields, id) => {\n             ast::VariantData::Tuple(fields.into_iter().filter(|m| {\n-                (cx.in_cfg)(&m.node.attrs)\n+                (cx.in_cfg)(&m.attrs)\n             }).collect(), id)\n         }\n         ast::VariantData::Unit(id) => ast::VariantData::Unit(id)\n@@ -434,7 +434,7 @@ impl<'v, 'a, 'b> visit::Visitor<'v> for StmtExprAttrFeatureVisitor<'a, 'b> {\n     }\n \n     fn visit_struct_field(&mut self, s: &'v ast::StructField) {\n-        if node_survives_cfg(&s.node.attrs, self.config) {\n+        if node_survives_cfg(&s.attrs, self.config) {\n             visit::walk_struct_field(self, s);\n         }\n     }"}, {"sha": "a4e5b68277d698799d8be41122f0ac335947854a", "filename": "src/libsyntax/ext/build.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fext%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fext%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbuild.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -1007,12 +1007,14 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n \n     fn variant(&self, span: Span, name: Ident, tys: Vec<P<ast::Ty>> ) -> ast::Variant {\n         let fields: Vec<_> = tys.into_iter().map(|ty| {\n-            Spanned { span: ty.span, node: ast::StructField_ {\n+            ast::StructField {\n+                span: ty.span,\n                 ty: ty,\n-                kind: ast::UnnamedField(ast::Visibility::Inherited),\n+                ident: None,\n+                vis: ast::Visibility::Inherited,\n                 attrs: Vec::new(),\n                 id: ast::DUMMY_NODE_ID,\n-            }}\n+            }\n         }).collect();\n \n         let vdata = if fields.is_empty() {"}, {"sha": "46191b95f81f65e246f5375e50ca68fe03b1b694", "filename": "src/libsyntax/fold.rs", "status": "modified", "additions": 7, "deletions": 9, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffold.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -847,15 +847,13 @@ pub fn noop_fold_poly_trait_ref<T: Folder>(p: PolyTraitRef, fld: &mut T) -> Poly\n }\n \n pub fn noop_fold_struct_field<T: Folder>(f: StructField, fld: &mut T) -> StructField {\n-    let StructField {node: StructField_ {id, kind, ty, attrs}, span} = f;\n-    Spanned {\n-        node: StructField_ {\n-            id: fld.new_id(id),\n-            kind: kind,\n-            ty: fld.fold_ty(ty),\n-            attrs: fold_attrs(attrs, fld),\n-        },\n-        span: fld.new_span(span)\n+    StructField {\n+        span: fld.new_span(f.span),\n+        id: fld.new_id(f.id),\n+        ident: f.ident.map(|ident| fld.fold_ident(ident)),\n+        vis: f.vis,\n+        ty: fld.fold_ty(f.ty),\n+        attrs: fold_attrs(f.attrs, fld),\n     }\n }\n "}, {"sha": "28e4682f66b7e87636470c5bfe8bb1637e488000", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 13, "deletions": 10, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -29,7 +29,6 @@ use ast::Local;\n use ast::MacStmtStyle;\n use ast::Mac_;\n use ast::{MutTy, Mutability};\n-use ast::NamedField;\n use ast::{Pat, PatKind};\n use ast::{PolyTraitRef, QSelf};\n use ast::{Stmt, StmtKind};\n@@ -38,7 +37,6 @@ use ast::StrStyle;\n use ast::SelfKind;\n use ast::{Delimited, SequenceRepetition, TokenTree, TraitItem, TraitRef};\n use ast::{Ty, TyKind, TypeBinding, TyParam, TyParamBounds};\n-use ast::UnnamedField;\n use ast::{ViewPath, ViewPathGlob, ViewPathList, ViewPathSimple};\n use ast::{Visibility, WhereClause};\n use attr::{ThinAttributes, ThinAttributesExt, AttributesExt};\n@@ -3847,12 +3845,14 @@ impl<'a> Parser<'a> {\n         let name = self.parse_ident()?;\n         self.expect(&token::Colon)?;\n         let ty = self.parse_ty_sum()?;\n-        Ok(spanned(lo, self.last_span.hi, ast::StructField_ {\n-            kind: NamedField(name, pr),\n+        Ok(StructField {\n+            span: mk_sp(lo, self.last_span.hi),\n+            ident: Some(name),\n+            vis: pr,\n             id: ast::DUMMY_NODE_ID,\n             ty: ty,\n             attrs: attrs,\n-        }))\n+        })\n     }\n \n     /// Emit an expected item after attributes error.\n@@ -5246,13 +5246,16 @@ impl<'a> Parser<'a> {\n             |p| {\n                 let attrs = p.parse_outer_attributes()?;\n                 let lo = p.span.lo;\n-                let struct_field_ = ast::StructField_ {\n-                    kind: UnnamedField(p.parse_visibility()?),\n+                let vis = p.parse_visibility()?;\n+                let ty = p.parse_ty_sum()?;\n+                Ok(StructField {\n+                    span: mk_sp(lo, p.span.hi),\n+                    vis: vis,\n+                    ident: None,\n                     id: ast::DUMMY_NODE_ID,\n-                    ty: p.parse_ty_sum()?,\n+                    ty: ty,\n                     attrs: attrs,\n-                };\n-                Ok(spanned(lo, p.span.hi, struct_field_))\n+                })\n             })?;\n \n         Ok(fields)"}, {"sha": "e2b1d2f5e7abeb85f9b3c7536e746a3ef1ad11e3", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 11, "deletions": 21, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -1407,14 +1407,9 @@ impl<'a> State<'a> {\n                 self.commasep(\n                     Inconsistent, struct_def.fields(),\n                     |s, field| {\n-                        match field.node.kind {\n-                            ast::NamedField(..) => panic!(\"unexpected named field\"),\n-                            ast::UnnamedField(ref vis) => {\n-                                s.print_visibility(vis)?;\n-                                s.maybe_print_comment(field.span.lo)?;\n-                                s.print_type(&field.node.ty)\n-                            }\n-                        }\n+                        s.print_visibility(&field.vis)?;\n+                        s.maybe_print_comment(field.span.lo)?;\n+                        s.print_type(&field.ty)\n                     }\n                 )?;\n                 self.pclose()?;\n@@ -1432,19 +1427,14 @@ impl<'a> State<'a> {\n             self.hardbreak_if_not_bol()?;\n \n             for field in struct_def.fields() {\n-                match field.node.kind {\n-                    ast::UnnamedField(..) => panic!(\"unexpected unnamed field\"),\n-                    ast::NamedField(ident, ref visibility) => {\n-                        self.hardbreak_if_not_bol()?;\n-                        self.maybe_print_comment(field.span.lo)?;\n-                        self.print_outer_attributes(&field.node.attrs)?;\n-                        self.print_visibility(visibility)?;\n-                        self.print_ident(ident)?;\n-                        self.word_nbsp(\":\")?;\n-                        self.print_type(&field.node.ty)?;\n-                        word(&mut self.s, \",\")?;\n-                    }\n-                }\n+                self.hardbreak_if_not_bol()?;\n+                self.maybe_print_comment(field.span.lo)?;\n+                self.print_outer_attributes(&field.attrs)?;\n+                self.print_visibility(&field.vis)?;\n+                self.print_ident(field.ident.unwrap())?;\n+                self.word_nbsp(\":\")?;\n+                self.print_type(&field.ty)?;\n+                word(&mut self.s, \",\")?;\n             }\n \n             self.bclose(span)"}, {"sha": "839bbf4805df20c27cacbebbcc209375d70e0e8f", "filename": "src/libsyntax/visit.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fvisit.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -619,9 +619,9 @@ pub fn walk_struct_def<'v, V: Visitor<'v>>(visitor: &mut V,\n \n pub fn walk_struct_field<'v, V: Visitor<'v>>(visitor: &mut V,\n                                              struct_field: &'v StructField) {\n-    walk_opt_ident(visitor, struct_field.span, struct_field.node.ident());\n-    visitor.visit_ty(&struct_field.node.ty);\n-    walk_list!(visitor, visit_attribute, &struct_field.node.attrs);\n+    walk_opt_ident(visitor, struct_field.span, struct_field.ident);\n+    visitor.visit_ty(&struct_field.ty);\n+    walk_list!(visitor, visit_attribute, &struct_field.attrs);\n }\n \n pub fn walk_block<'v, V: Visitor<'v>>(visitor: &mut V, block: &'v Block) {"}, {"sha": "a389165f71534f66930687aab4ee94e341846c65", "filename": "src/libsyntax_ext/deriving/generic/mod.rs", "status": "modified", "additions": 13, "deletions": 46, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7b00b68fc7960e98fb914be52d9a6a16fe2224/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs?ref=af7b00b68fc7960e98fb914be52d9a6a16fe2224", "patch": "@@ -186,7 +186,6 @@\n \n pub use self::StaticFields::*;\n pub use self::SubstructureFields::*;\n-use self::StructType::*;\n \n use std::cell::RefCell;\n use std::collections::HashSet;\n@@ -654,7 +653,7 @@ impl<'a> TraitDef<'a> {\n                          type_ident: Ident,\n                          generics: &Generics) -> P<ast::Item> {\n         let field_tys: Vec<P<ast::Ty>> = struct_def.fields().iter()\n-            .map(|field| field.node.ty.clone())\n+            .map(|field| field.ty.clone())\n             .collect();\n \n         let methods = self.methods.iter().map(|method_def| {\n@@ -702,7 +701,7 @@ impl<'a> TraitDef<'a> {\n \n         for variant in &enum_def.variants {\n             field_tys.extend(variant.node.data.fields().iter()\n-                .map(|field| field.node.ty.clone()));\n+                .map(|field| field.ty.clone()));\n         }\n \n         let methods = self.methods.iter().map(|method_def| {\n@@ -1409,11 +1408,6 @@ impl<'a> MethodDef<'a> {\n     }\n }\n \n-#[derive(PartialEq)] // dogfooding!\n-enum StructType {\n-    Unknown, Record, Tuple\n-}\n-\n // general helper methods.\n impl<'a> TraitDef<'a> {\n     fn set_expn_info(&self,\n@@ -1441,9 +1435,9 @@ impl<'a> TraitDef<'a> {\n         let mut just_spans = Vec::new();\n         for field in struct_def.fields(){\n             let sp = self.set_expn_info(cx, field.span);\n-            match field.node.kind {\n-                ast::NamedField(ident, _) => named_idents.push((ident, sp)),\n-                ast::UnnamedField(..) => just_spans.push(sp),\n+            match field.ident {\n+                Some(ident) => named_idents.push((ident, sp)),\n+                _ => just_spans.push(sp),\n             }\n         }\n \n@@ -1479,61 +1473,34 @@ impl<'a> TraitDef<'a> {\n                              -> (P<ast::Pat>, Vec<(Span, Option<Ident>,\n                                                    P<Expr>,\n                                                    &'a [ast::Attribute])>) {\n-        if struct_def.fields().is_empty() {\n-            if struct_def.is_struct() {\n-                return (cx.pat_struct(self.span, struct_path, vec![]), vec![]);\n-            } else {\n-                return (cx.pat_enum(self.span, struct_path, vec![]), vec![]);\n-            }\n-        }\n-\n         let mut paths = Vec::new();\n-        let mut ident_expr = Vec::new();\n-        let mut struct_type = Unknown;\n-\n+        let mut ident_exprs = Vec::new();\n         for (i, struct_field) in struct_def.fields().iter().enumerate() {\n             let sp = self.set_expn_info(cx, struct_field.span);\n-            let opt_id = match struct_field.node.kind {\n-                ast::NamedField(ident, _) if (struct_type == Unknown ||\n-                                              struct_type == Record) => {\n-                    struct_type = Record;\n-                    Some(ident)\n-                }\n-                ast::UnnamedField(..) if (struct_type == Unknown ||\n-                                          struct_type == Tuple) => {\n-                    struct_type = Tuple;\n-                    None\n-                }\n-                _ => {\n-                    cx.span_bug(sp, \"a struct with named and unnamed fields in `derive`\");\n-                }\n-            };\n             let ident = cx.ident_of(&format!(\"{}_{}\", prefix, i));\n             paths.push(codemap::Spanned{span: sp, node: ident});\n             let val = cx.expr_deref(sp, cx.expr_path(cx.path_ident(sp,ident)));\n             let val = cx.expr(sp, ast::ExprKind::Paren(val));\n-            ident_expr.push((sp, opt_id, val, &struct_field.node.attrs[..]));\n+            ident_exprs.push((sp, struct_field.ident, val, &struct_field.attrs[..]));\n         }\n \n         let subpats = self.create_subpatterns(cx, paths, mutbl);\n-\n-        // struct_type is definitely not Unknown, since struct_def.fields\n-        // must be nonempty to reach here\n         let pattern = if struct_def.is_struct() {\n-            let field_pats = subpats.into_iter().zip(&ident_expr)\n-                                    .map(|(pat, &(_, id, _, _))| {\n-                // id is guaranteed to be Some\n+            let field_pats = subpats.into_iter().zip(&ident_exprs).map(|(pat, &(sp, ident, _, _))| {\n+                if ident.is_none() {\n+                    cx.span_bug(sp, \"a braced struct with unnamed fields in `derive`\");\n+                }\n                 codemap::Spanned {\n                     span: pat.span,\n-                    node: ast::FieldPat { ident: id.unwrap(), pat: pat, is_shorthand: false },\n+                    node: ast::FieldPat { ident: ident.unwrap(), pat: pat, is_shorthand: false },\n                 }\n             }).collect();\n             cx.pat_struct(self.span, struct_path, field_pats)\n         } else {\n             cx.pat_enum(self.span, struct_path, subpats)\n         };\n \n-        (pattern, ident_expr)\n+        (pattern, ident_exprs)\n     }\n \n     fn create_enum_variant_pattern(&self,"}]}