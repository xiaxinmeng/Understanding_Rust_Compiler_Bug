{"sha": "d40a0b3dc17acd585d3e41d08db6d516842cea96", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0MGEwYjNkYzE3YWNkNTg1ZDNlNDFkMDhkYjZkNTE2ODQyY2VhOTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-02T12:20:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-02T12:20:31Z"}, "message": "Auto merge of #49943 - pnkfelix:fix-issue-49918, r=nikomatsakis\n\nTreat generators as if they have an arbitrary destructor\n\nConservatively assume dropping a generator touches its upvars, via locals' destructors.\n\nFix #49918", "tree": {"sha": "403dd0e867792a33c64ccdb922d3ebbb593b0263", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/403dd0e867792a33c64ccdb922d3ebbb593b0263"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d40a0b3dc17acd585d3e41d08db6d516842cea96", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d40a0b3dc17acd585d3e41d08db6d516842cea96", "html_url": "https://github.com/rust-lang/rust/commit/d40a0b3dc17acd585d3e41d08db6d516842cea96", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d40a0b3dc17acd585d3e41d08db6d516842cea96/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a87289fa4f49b6bdd62f33f69a580026223421f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a87289fa4f49b6bdd62f33f69a580026223421f", "html_url": "https://github.com/rust-lang/rust/commit/6a87289fa4f49b6bdd62f33f69a580026223421f"}, {"sha": "f12d7a55fca7215a08029c90634ab54f883a9f1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f12d7a55fca7215a08029c90634ab54f883a9f1c", "html_url": "https://github.com/rust-lang/rust/commit/f12d7a55fca7215a08029c90634ab54f883a9f1c"}], "stats": {"total": 146, "additions": 106, "deletions": 40}, "files": [{"sha": "ba31ce2692fbcabe38a67fcd0b3f3821d102d5e8", "filename": "src/librustc_traits/dropck_outlives.rs", "status": "modified", "additions": 32, "deletions": 8, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Flibrustc_traits%2Fdropck_outlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Flibrustc_traits%2Fdropck_outlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_traits%2Fdropck_outlives.rs?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -193,14 +193,38 @@ fn dtorck_constraint_for_ty<'a, 'gcx, 'tcx>(\n             .map(|ty| dtorck_constraint_for_ty(tcx, span, for_ty, depth + 1, ty))\n             .collect(),\n \n-        ty::TyGenerator(def_id, substs, _) => {\n-            // Note that the interior types are ignored here.\n-            // Any type reachable inside the interior must also be reachable\n-            // through the upvars.\n-            substs\n-                .upvar_tys(def_id, tcx)\n-                .map(|ty| dtorck_constraint_for_ty(tcx, span, for_ty, depth + 1, ty))\n-                .collect()\n+        ty::TyGenerator(def_id, substs, _interior) => {\n+            // rust-lang/rust#49918: types can be constructed, stored\n+            // in the interior, and sit idle when generator yields\n+            // (and is subsequently dropped).\n+            //\n+            // It would be nice to descend into interior of a\n+            // generator to determine what effects dropping it might\n+            // have (by looking at any drop effects associated with\n+            // its interior).\n+            //\n+            // However, the interior's representation uses things like\n+            // TyGeneratorWitness that explicitly assume they are not\n+            // traversed in such a manner. So instead, we will\n+            // simplify things for now by treating all generators as\n+            // if they were like trait objects, where its upvars must\n+            // all be alive for the generator's (potential)\n+            // destructor.\n+            //\n+            // In particular, skipping over `_interior` is safe\n+            // because any side-effects from dropping `_interior` can\n+            // only take place through references with lifetimes\n+            // derived from lifetimes attached to the upvars, and we\n+            // *do* incorporate the upvars here.\n+\n+            let constraint = DtorckConstraint {\n+                outlives: substs.upvar_tys(def_id, tcx).map(|t| t.into()).collect(),\n+                dtorck_types: vec![],\n+                overflows: vec![],\n+            };\n+            debug!(\"dtorck_constraint: generator {:?} => {:?}\", def_id, constraint);\n+\n+            Ok(constraint)\n         }\n \n         ty::TyAdt(def, substs) => {"}, {"sha": "243e9018585138442786b9830af0e71b0b978069", "filename": "src/test/ui/generator/borrowing.nll.stderr", "status": "modified", "additions": 27, "deletions": 11, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fborrowing.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fborrowing.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fborrowing.nll.stderr?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -1,14 +1,30 @@\n-error: compilation successful\n-  --> $DIR/borrowing.rs:15:1\n+error[E0597]: `a` does not live long enough\n+  --> $DIR/borrowing.rs:18:18\n    |\n-LL | / fn main() { #![rustc_error] // rust-lang/rust#49855\n-LL | |     let _b = {\n-LL | |         let a = 3;\n-LL | |         unsafe { (|| yield &a).resume() }\n-...  |\n-LL | |     };\n-LL | | }\n-   | |_^\n+LL |         unsafe { (|| yield &a).resume() }\n+   |                  ^^^^^^^^^^^^^\n+   |                  |\n+   |                  borrowed value does not live long enough\n+   |                  borrow may end up in a temporary, created here\n+LL |         //~^ ERROR: `a` does not live long enough\n+LL |     };\n+   |     -- temporary later dropped here, potentially using the reference\n+   |     |\n+   |     borrowed value only lives until here\n \n-error: aborting due to previous error\n+error[E0597]: `a` does not live long enough\n+  --> $DIR/borrowing.rs:24:9\n+   |\n+LL | /         || {\n+LL | |             yield &a\n+LL | |             //~^ ERROR: `a` does not live long enough\n+LL | |         }\n+   | |_________^ borrowed value does not live long enough\n+LL |       };\n+   |       - borrowed value only lives until here\n+LL |   }\n+   |   - borrow later used here, when `_b` is dropped\n+\n+error: aborting due to 2 previous errors\n \n+For more information about this error, try `rustc --explain E0597`."}, {"sha": "e56927d81823131b1e38e66cbff0394b743489fe", "filename": "src/test/ui/generator/borrowing.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fborrowing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fborrowing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fborrowing.rs?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -8,11 +8,11 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(generators, generator_trait, rustc_attrs)]\n+#![feature(generators, generator_trait)]\n \n use std::ops::Generator;\n \n-fn main() { #![rustc_error] // rust-lang/rust#49855\n+fn main() {\n     let _b = {\n         let a = 3;\n         unsafe { (|| yield &a).resume() }"}, {"sha": "c352fd6a62f28522f2fa1763579479dd94926b83", "filename": "src/test/ui/generator/dropck.nll.stderr", "status": "modified", "additions": 16, "deletions": 10, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fdropck.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fdropck.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fdropck.nll.stderr?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -1,14 +1,20 @@\n-error: compilation successful\n-  --> $DIR/dropck.rs:16:1\n+error[E0597]: `ref_` does not live long enough\n+  --> $DIR/dropck.rs:22:11\n    |\n-LL | / fn main() { #![rustc_error] // rust-lang/rust#49855\n-LL | |     let (cell, mut gen);\n-LL | |     cell = Box::new(RefCell::new(0));\n-LL | |     let ref_ = Box::leak(Box::new(Some(cell.borrow_mut())));\n-...  |\n-LL | |     // drops the RefCell and then the Ref, leading to use-after-free\n-LL | | }\n-   | |_^\n+LL |       gen = || {\n+   |  ___________^\n+LL | |         // but the generator can use it to drop a `Ref<'a, i32>`.\n+LL | |         let _d = ref_.take(); //~ ERROR `ref_` does not live long enough\n+LL | |         yield;\n+LL | |     };\n+   | |_____^ borrowed value does not live long enough\n+...\n+LL |   }\n+   |   -\n+   |   |\n+   |   borrowed value only lives until here\n+   |   borrow later used here, when `gen` is dropped\n \n error: aborting due to previous error\n \n+For more information about this error, try `rustc --explain E0597`."}, {"sha": "857288818c67c5e0f80a7bef0b77b0a80d8eef84", "filename": "src/test/ui/generator/dropck.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fdropck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fdropck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fdropck.rs?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -8,15 +8,16 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(generators, generator_trait, box_leak, rustc_attrs)]\n+#![feature(generators, generator_trait, box_leak)]\n \n use std::cell::RefCell;\n use std::ops::Generator;\n \n-fn main() { #![rustc_error] // rust-lang/rust#49855\n+fn main() {\n     let (cell, mut gen);\n     cell = Box::new(RefCell::new(0));\n     let ref_ = Box::leak(Box::new(Some(cell.borrow_mut())));\n+    //~^ ERROR `*cell` does not live long enough [E0597]\n     // the upvar is the non-dropck `&mut Option<Ref<'a, i32>>`.\n     gen = || {\n         // but the generator can use it to drop a `Ref<'a, i32>`."}, {"sha": "1a6fed2dd35944d0947eccee78ad7145e3b38a5e", "filename": "src/test/ui/generator/dropck.stderr", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fdropck.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fdropck.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fdropck.stderr?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -1,5 +1,16 @@\n+error[E0597]: `*cell` does not live long enough\n+  --> $DIR/dropck.rs:19:40\n+   |\n+LL |     let ref_ = Box::leak(Box::new(Some(cell.borrow_mut())));\n+   |                                        ^^^^ borrowed value does not live long enough\n+...\n+LL | }\n+   | - `*cell` dropped here while still borrowed\n+   |\n+   = note: values in a scope are dropped in the opposite order they are created\n+\n error[E0597]: `ref_` does not live long enough\n-  --> $DIR/dropck.rs:23:18\n+  --> $DIR/dropck.rs:24:18\n    |\n LL |     gen = || {\n    |           -- capture occurs here\n@@ -12,6 +23,6 @@ LL | }\n    |\n    = note: values in a scope are dropped in the opposite order they are created\n \n-error: aborting due to previous error\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0597`."}, {"sha": "70870b98365b9d1a1cb11fe0dd41f726273d5222", "filename": "src/test/ui/generator/ref-escapes-but-not-over-yield.nll.stderr", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fref-escapes-but-not-over-yield.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d40a0b3dc17acd585d3e41d08db6d516842cea96/src%2Ftest%2Fui%2Fgenerator%2Fref-escapes-but-not-over-yield.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fref-escapes-but-not-over-yield.nll.stderr?ref=d40a0b3dc17acd585d3e41d08db6d516842cea96", "patch": "@@ -1,11 +1,19 @@\n error[E0597]: `b` does not live long enough\n   --> $DIR/ref-escapes-but-not-over-yield.rs:24:13\n    |\n-LL |         a = &b;\n-   |             ^^ borrowed value does not live long enough\n-LL |         //~^ ERROR `b` does not live long enough\n-LL |     };\n-   |     - borrowed value only lives until here\n+LL |       let mut b = move || {\n+   |  _________________-\n+LL | |         yield();\n+LL | |         let b = 5;\n+LL | |         a = &b;\n+   | |             ^^ borrowed value does not live long enough\n+LL | |         //~^ ERROR `b` does not live long enough\n+LL | |     };\n+   | |     -\n+   | |     |\n+   | |     borrowed value only lives until here\n+   | |_____temporary later dropped here, potentially using the reference\n+   |       borrow may end up in a temporary, created here\n \n error: aborting due to previous error\n "}]}