{"sha": "ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d", "node_id": "C_kwDOAAsO6NoAKGVjZTUyNDUxZjYyNzhiZDRiM2JkZjAyZDgyMTUzZmZiNWMxYjdmMWQ", "commit": {"author": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2022-08-04T15:40:00Z"}, "committer": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2022-08-04T15:40:00Z"}, "message": "Do not collect lifetimes with Infer resolution", "tree": {"sha": "972ae14e398ae1e2613516856dba269717d330a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/972ae14e398ae1e2613516856dba269717d330a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF0ntrgrd9qf9uuThgTGiTgx5768FAmLr6FAACgkQgTGiTgx5\n769OfRAAivMI5PQXs931cgT5/8HGZmdgjvBu+bO8m9HdEqcXPLLc9nJvD4Gdaha7\nXh6iUQPeTJjzoPZzkW7XrV+mJDHhGTccctU3bauLJrIyT0iR8XisISnAvafIpJ8+\n4F/sSenVnZWqITnyx4FqzpdITESSyYwA8bM5i6RAgST9yrX857/JC1UMkSQ3xvov\nIA+LHwepCU6C/oEIkEi4kq9ulZMWyP4O7Nw/rS2GmNGAe+e/uzca6YH0fQyNd80D\nN+kqzK2DfS+4hGRsfT+/pG8BsYTshGXEmrgqEQ1Z9LKNxwFGratN9Zc9fbP2fePG\n5uGreycSXhYP1dVhqn39+e+Z2bDVcF9k1IvHsuKdqenBqObLsCPbPCQ5PEPcW8Yz\ntq8Is64Kb+vXgGRbLBOWzNbXhHubcM/DiPCfmY1JfkhPw6WnbWlrvOrirN/AYQfI\nwXBG2dXi7ig1llskuGhw9a72xUSjY66yXkA9wChEwju8leEAbrUbTrRg9FVzrXfD\nwx/aNpf/ywlE+dk6v11PIf77wd1jWTn8JkyhudcyZaoH67a0NfjQjQSSCh2yN7EU\ndMvMfhBa0D7jE+GTR/6ZYds3IB61uHuV9wesUJXHJyYERDJtQ8N96hsWr+tY6W6+\nPXcTIiJxIuElom9APLf8bjaNtXV45Crcy3kc3mBZFSvyBw1GvBg=\n=r5if\n-----END PGP SIGNATURE-----", "payload": "tree 972ae14e398ae1e2613516856dba269717d330a0\nparent 45991f9175604becdcf8592e22f41fa1acba58fe\nauthor Santiago Pastorino <spastorino@gmail.com> 1659627600 -0300\ncommitter Santiago Pastorino <spastorino@gmail.com> 1659627600 -0300\n\nDo not collect lifetimes with Infer resolution\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d", "html_url": "https://github.com/rust-lang/rust/commit/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d/comments", "author": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "committer": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45991f9175604becdcf8592e22f41fa1acba58fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/45991f9175604becdcf8592e22f41fa1acba58fe", "html_url": "https://github.com/rust-lang/rust/commit/45991f9175604becdcf8592e22f41fa1acba58fe"}], "stats": {"total": 35, "additions": 21, "deletions": 14}, "files": [{"sha": "81006e00fd4e51c8fb627510166c6b1678bed3f8", "filename": "compiler/rustc_ast_lowering/src/lifetime_collector.rs", "status": "modified", "additions": 21, "deletions": 5, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d/compiler%2Frustc_ast_lowering%2Fsrc%2Flifetime_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d/compiler%2Frustc_ast_lowering%2Fsrc%2Flifetime_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flifetime_collector.rs?ref=ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d", "patch": "@@ -5,6 +5,7 @@ use rustc_ast::{\n     TyKind,\n };\n use rustc_hir::def::LifetimeRes;\n+use rustc_middle::span_bug;\n use rustc_middle::ty::ResolverAstLowering;\n use rustc_span::symbol::{kw, Ident};\n use rustc_span::Span;\n@@ -21,11 +22,26 @@ impl<'ast> LifetimeCollectVisitor<'ast> {\n     }\n \n     fn record_lifetime_use(&mut self, lifetime: Lifetime) {\n-        let res = self.resolver.get_lifetime_res(lifetime.id).unwrap_or(LifetimeRes::Error);\n-\n-        if res.binder().map_or(true, |b| !self.current_binders.contains(&b)) {\n-            if !self.collected_lifetimes.contains(&lifetime) {\n-                self.collected_lifetimes.push(lifetime);\n+        match self.resolver.get_lifetime_res(lifetime.id).unwrap_or(LifetimeRes::Error) {\n+            LifetimeRes::Param { binder, .. } | LifetimeRes::Fresh { binder, .. } => {\n+                if !self.current_binders.contains(&binder) {\n+                    if !self.collected_lifetimes.contains(&lifetime) {\n+                        self.collected_lifetimes.push(lifetime);\n+                    }\n+                }\n+            }\n+            LifetimeRes::Static | LifetimeRes::Error => {\n+                if !self.collected_lifetimes.contains(&lifetime) {\n+                    self.collected_lifetimes.push(lifetime);\n+                }\n+            }\n+            LifetimeRes::Infer => {}\n+            res => {\n+                let bug_msg = format!(\n+                    \"Unexpected lifetime resolution {:?} for {:?} at {:?}\",\n+                    res, lifetime.ident, lifetime.ident.span\n+                );\n+                span_bug!(lifetime.ident.span, \"{}\", bug_msg);\n             }\n         }\n     }"}, {"sha": "be5b7eccbafb2ef34cc1bd53fd2924fe265ac2fe", "filename": "compiler/rustc_hir/src/def.rs", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d/compiler%2Frustc_hir%2Fsrc%2Fdef.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d/compiler%2Frustc_hir%2Fsrc%2Fdef.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fdef.rs?ref=ece52451f6278bd4b3bdf02d82153ffb5c1b7f1d", "patch": "@@ -747,12 +747,3 @@ pub enum LifetimeRes {\n     /// HACK: This is used to recover the NodeId of an elided lifetime.\n     ElidedAnchor { start: NodeId, end: NodeId },\n }\n-\n-impl LifetimeRes {\n-    pub fn binder(&self) -> Option<NodeId> {\n-        match self {\n-            LifetimeRes::Param { binder, .. } | LifetimeRes::Fresh { binder, .. } => Some(*binder),\n-            _ => None,\n-        }\n-    }\n-}"}]}