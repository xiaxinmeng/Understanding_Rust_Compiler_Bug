{"sha": "39633874ae7d0150669004a80740ff3b0708d08d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM5NjMzODc0YWU3ZDAxNTA2NjkwMDRhODA3NDBmZjNiMDcwOGQwOGQ=", "commit": {"author": {"name": "msizanoen1", "email": "qtmlabs@protonmail.com", "date": "2020-02-03T15:04:44Z"}, "committer": {"name": "msizanoen1", "email": "qtmlabs@protonmail.com", "date": "2020-02-04T10:28:16Z"}, "message": "Add tests for RISC-V C ABI", "tree": {"sha": "1ea983843b59fda7e6a66b8b07d7520d6b05508e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ea983843b59fda7e6a66b8b07d7520d6b05508e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39633874ae7d0150669004a80740ff3b0708d08d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39633874ae7d0150669004a80740ff3b0708d08d", "html_url": "https://github.com/rust-lang/rust/commit/39633874ae7d0150669004a80740ff3b0708d08d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39633874ae7d0150669004a80740ff3b0708d08d/comments", "author": {"login": "msizanoen1", "id": 55322658, "node_id": "MDQ6VXNlcjU1MzIyNjU4", "avatar_url": "https://avatars.githubusercontent.com/u/55322658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msizanoen1", "html_url": "https://github.com/msizanoen1", "followers_url": "https://api.github.com/users/msizanoen1/followers", "following_url": "https://api.github.com/users/msizanoen1/following{/other_user}", "gists_url": "https://api.github.com/users/msizanoen1/gists{/gist_id}", "starred_url": "https://api.github.com/users/msizanoen1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msizanoen1/subscriptions", "organizations_url": "https://api.github.com/users/msizanoen1/orgs", "repos_url": "https://api.github.com/users/msizanoen1/repos", "events_url": "https://api.github.com/users/msizanoen1/events{/privacy}", "received_events_url": "https://api.github.com/users/msizanoen1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "msizanoen1", "id": 55322658, "node_id": "MDQ6VXNlcjU1MzIyNjU4", "avatar_url": "https://avatars.githubusercontent.com/u/55322658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msizanoen1", "html_url": "https://github.com/msizanoen1", "followers_url": "https://api.github.com/users/msizanoen1/followers", "following_url": "https://api.github.com/users/msizanoen1/following{/other_user}", "gists_url": "https://api.github.com/users/msizanoen1/gists{/gist_id}", "starred_url": "https://api.github.com/users/msizanoen1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msizanoen1/subscriptions", "organizations_url": "https://api.github.com/users/msizanoen1/orgs", "repos_url": "https://api.github.com/users/msizanoen1/repos", "events_url": "https://api.github.com/users/msizanoen1/events{/privacy}", "received_events_url": "https://api.github.com/users/msizanoen1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5901641755dfd2e758c7e855b82ee0bcd8b29c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5901641755dfd2e758c7e855b82ee0bcd8b29c0", "html_url": "https://github.com/rust-lang/rust/commit/e5901641755dfd2e758c7e855b82ee0bcd8b29c0"}], "stats": {"total": 832, "additions": 831, "deletions": 1}, "files": [{"sha": "22bb54988365c0bb34a08ea874c639c78c251109", "filename": "src/test/auxiliary/rust_test_helpers.c", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fauxiliary%2Frust_test_helpers.c", "raw_url": "https://github.com/rust-lang/rust/raw/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fauxiliary%2Frust_test_helpers.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Frust_test_helpers.c?ref=39633874ae7d0150669004a80740ff3b0708d08d", "patch": "@@ -168,6 +168,18 @@ struct floats {\n     double c;\n };\n \n+struct char_char_double {\n+    uint8_t a;\n+    uint8_t b;\n+    double c;\n+};\n+\n+struct char_char_float {\n+    uint8_t a;\n+    uint8_t b;\n+    float c;\n+};\n+\n struct quad\n rust_dbg_abi_1(struct quad q) {\n     struct quad qq = { q.c + 1,\n@@ -185,6 +197,23 @@ rust_dbg_abi_2(struct floats f) {\n     return ff;\n }\n \n+struct char_char_double\n+rust_dbg_abi_3(struct char_char_double a) {\n+    struct char_char_double ccd = { a.a + 1,\n+                                    a.b - 1,\n+                                    a.c + 1.0 };\n+    return ccd;\n+}\n+\n+struct char_char_float\n+rust_dbg_abi_4(struct char_char_float a) {\n+    struct char_char_float ccd = { a.a + 1,\n+                                   a.b - 1,\n+                                   a.c + 1.0 };\n+    return ccd;\n+}\n+\n+\n int\n rust_dbg_static_mut = 3;\n "}, {"sha": "f0f052fe5c557ab4e93dcdaa65af81a1a9369efd", "filename": "src/test/codegen/riscv-abi/riscv64-lp64-lp64f-lp64d-abi.rs", "status": "added", "additions": 181, "deletions": 0, "changes": 181, "blob_url": "https://github.com/rust-lang/rust/blob/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64-lp64f-lp64d-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64-lp64f-lp64d-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64-lp64f-lp64d-abi.rs?ref=39633874ae7d0150669004a80740ff3b0708d08d", "patch": "@@ -0,0 +1,181 @@\n+// ignore-tidy-linelength\n+// compile-flags: -C no-prepopulate-passes\n+// only-riscv64\n+// only-linux\n+#![crate_type = \"lib\"]\n+#![allow(improper_ctypes)]\n+\n+// CHECK: define void @f_void()\n+#[no_mangle]\n+pub extern \"C\" fn f_void() {}\n+\n+// CHECK: define zeroext i1 @f_scalar_0(i1 zeroext %a)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_0(a: bool) -> bool {\n+    a\n+}\n+\n+// CHECK: define signext i8 @f_scalar_1(i8 signext %x)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_1(x: i8) -> i8 {\n+    x\n+}\n+\n+// CHECK: define zeroext i8 @f_scalar_2(i8 zeroext %x)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_2(x: u8) -> u8 {\n+    x\n+}\n+\n+// CHECK: define signext i32 @f_scalar_3(i32 signext %x)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_3(x: i32) -> u32 {\n+    x as u32\n+}\n+\n+// CHECK: define i64 @f_scalar_4(i64 %x)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_4(x: i64) -> i64 {\n+    x\n+}\n+\n+// CHECK: define float @f_fp_scalar_1(float)\n+#[no_mangle]\n+pub extern \"C\" fn f_fp_scalar_1(x: f32) -> f32 {\n+    x\n+}\n+// CHECK: define double @f_fp_scalar_2(double)\n+#[no_mangle]\n+pub extern \"C\" fn f_fp_scalar_2(x: f64) -> f64 {\n+    x\n+}\n+\n+#[repr(C)]\n+pub struct Empty {}\n+\n+// CHECK: define void @f_agg_empty_struct()\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_empty_struct(e: Empty) -> Empty {\n+    e\n+}\n+\n+#[repr(C)]\n+pub struct Tiny {\n+    a: u16,\n+    b: u16,\n+    c: u16,\n+    d: u16,\n+}\n+\n+// CHECK: define void @f_agg_tiny(i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_tiny(mut e: Tiny) {\n+    e.a += e.b;\n+    e.c += e.d;\n+}\n+\n+// CHECK: define i64 @f_agg_tiny_ret()\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_tiny_ret() -> Tiny {\n+    Tiny { a: 1, b: 2, c: 3, d: 4 }\n+}\n+\n+#[repr(C)]\n+pub struct Small {\n+    a: i64,\n+    b: *mut i64,\n+}\n+\n+// CHECK: define void @f_agg_small([2 x i64])\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_small(mut x: Small) {\n+    x.a += unsafe { *x.b };\n+    x.b = &mut x.a;\n+}\n+\n+// CHECK: define [2 x i64] @f_agg_small_ret()\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_small_ret() -> Small {\n+    Small { a: 1, b: core::ptr::null_mut() }\n+}\n+\n+#[repr(C)]\n+pub struct SmallAligned {\n+    a: i128,\n+}\n+\n+// CHECK: define void @f_agg_small_aligned(i128)\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_small_aligned(mut x: SmallAligned) {\n+    x.a += x.a;\n+}\n+\n+#[repr(C)]\n+pub struct Large {\n+    a: i64,\n+    b: i64,\n+    c: i64,\n+    d: i64,\n+}\n+\n+// CHECK: define void @f_agg_large(%Large* {{.*}}%x)\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_large(mut x: Large) {\n+    x.a = x.b + x.c + x.d;\n+}\n+\n+// CHECK: define void @f_agg_large_ret(%Large* {{.*}}sret{{.*}}, i32 signext %i, i8 signext %j)\n+#[no_mangle]\n+pub extern \"C\" fn f_agg_large_ret(i: i32, j: i8) -> Large {\n+    Large { a: 1, b: 2, c: 3, d: 4 }\n+}\n+\n+// CHECK: define void @f_scalar_stack_1(i64, [2 x i64], i128, %Large* {{.*}}%d, i8 zeroext %e, i8 signext %f, i8 %g, i8 %h)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_stack_1(\n+    a: Tiny,\n+    b: Small,\n+    c: SmallAligned,\n+    d: Large,\n+    e: u8,\n+    f: i8,\n+    g: u8,\n+    h: i8,\n+) {\n+}\n+\n+// CHECK: define void @f_scalar_stack_2(%Large* {{.*}}sret{{.*}}, i64 %a, i128, i128, i64 %d, i8 zeroext %e, i8 %f, i8 %g)\n+#[no_mangle]\n+pub extern \"C\" fn f_scalar_stack_2(\n+    a: u64,\n+    b: SmallAligned,\n+    c: SmallAligned,\n+    d: u64,\n+    e: u8,\n+    f: i8,\n+    g: u8,\n+) -> Large {\n+    Large { a: a as i64, b: e as i64, c: f as i64, d: g as i64 }\n+}\n+\n+extern \"C\" {\n+    fn f_va_callee(_: i32, ...) -> i32;\n+}\n+\n+#[no_mangle]\n+pub unsafe extern \"C\" fn f_va_caller() {\n+    // CHECK: call signext i32 (i32, ...) @f_va_callee(i32 signext 1, i32 signext 2, i64 3, double {{.*}}, double {{.*}}, i64 {{.*}}, [2 x i64] {{.*}}, i128 {{.*}}, %Large* {{.*}})\n+    f_va_callee(\n+        1,\n+        2i32,\n+        3i64,\n+        4.0f64,\n+        5.0f64,\n+        Tiny { a: 1, b: 2, c: 3, d: 4 },\n+        Small { a: 10, b: core::ptr::null_mut() },\n+        SmallAligned { a: 11 },\n+        Large { a: 12, b: 13, c: 14, d: 15 },\n+    );\n+    // CHECK: call signext i32 (i32, ...) @f_va_callee(i32 signext 1, i32 signext 2, i32 signext 3, i32 signext 4, i128 {{.*}}, i32 signext 6, i32 signext 7, i32 8, i32 9)\n+    f_va_callee(1, 2i32, 3i32, 4i32, SmallAligned { a: 5 }, 6i32, 7i32, 8i32, 9i32);\n+}"}, {"sha": "66a3b9e4952a9bad071e0df2621bf47830921976", "filename": "src/test/codegen/riscv-abi/riscv64-lp64d-abi.rs", "status": "added", "additions": 293, "deletions": 0, "changes": 293, "blob_url": "https://github.com/rust-lang/rust/blob/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64d-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64d-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64d-abi.rs?ref=39633874ae7d0150669004a80740ff3b0708d08d", "patch": "@@ -0,0 +1,293 @@\n+// ignore-tidy-linelength\n+// compile-flags: -C no-prepopulate-passes\n+// only-riscv64\n+// only-linux\n+#![crate_type = \"lib\"]\n+\n+// CHECK: define void @f_fpr_tracking(double, double, double, double, double, double, double, double, i8 zeroext %i)\n+#[no_mangle]\n+pub extern \"C\" fn f_fpr_tracking(\n+    a: f64,\n+    b: f64,\n+    c: f64,\n+    d: f64,\n+    e: f64,\n+    f: f64,\n+    g: f64,\n+    h: f64,\n+    i: u8,\n+) {\n+}\n+\n+#[repr(C)]\n+pub struct Double {\n+    f: f64,\n+}\n+\n+#[repr(C)]\n+pub struct DoubleDouble {\n+    f: f64,\n+    g: f64,\n+}\n+\n+#[repr(C)]\n+pub struct DoubleFloat {\n+    f: f64,\n+    g: f32,\n+}\n+\n+// CHECK: define void @f_double_s_arg(double)\n+#[no_mangle]\n+pub extern \"C\" fn f_double_s_arg(a: Double) {}\n+\n+// CHECK: define double @f_ret_double_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_s() -> Double {\n+    Double { f: 1. }\n+}\n+\n+// CHECK: define void @f_double_double_s_arg({ double, double })\n+#[no_mangle]\n+pub extern \"C\" fn f_double_double_s_arg(a: DoubleDouble) {}\n+\n+// CHECK: define { double, double } @f_ret_double_double_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_double_s() -> DoubleDouble {\n+    DoubleDouble { f: 1., g: 2. }\n+}\n+\n+// CHECK: define void @f_double_float_s_arg({ double, float })\n+#[no_mangle]\n+pub extern \"C\" fn f_double_float_s_arg(a: DoubleFloat) {}\n+\n+// CHECK: define { double, float } @f_ret_double_float_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_float_s() -> DoubleFloat {\n+    DoubleFloat { f: 1., g: 2. }\n+}\n+\n+// CHECK: define void @f_double_double_s_arg_insufficient_fprs(double, double, double, double, double, double, double, [2 x i64])\n+#[no_mangle]\n+pub extern \"C\" fn f_double_double_s_arg_insufficient_fprs(\n+    a: f64,\n+    b: f64,\n+    c: f64,\n+    d: f64,\n+    e: f64,\n+    f: f64,\n+    g: f64,\n+    h: DoubleDouble,\n+) {\n+}\n+\n+#[repr(C)]\n+pub struct DoubleInt8 {\n+    f: f64,\n+    i: i8,\n+}\n+\n+#[repr(C)]\n+pub struct DoubleUInt8 {\n+    f: f64,\n+    i: u8,\n+}\n+\n+#[repr(C)]\n+pub struct DoubleInt32 {\n+    f: f64,\n+    i: i32,\n+}\n+\n+#[repr(C)]\n+pub struct DoubleInt64 {\n+    f: f64,\n+    i: i64,\n+}\n+\n+// CHECK: define void @f_double_int8_s_arg({ double, i8 })\n+#[no_mangle]\n+pub extern \"C\" fn f_double_int8_s_arg(a: DoubleInt8) {}\n+\n+// CHECK: define { double, i8 } @f_ret_double_int8_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_int8_s() -> DoubleInt8 {\n+    DoubleInt8 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_double_int32_s_arg({ double, i32 })\n+#[no_mangle]\n+pub extern \"C\" fn f_double_int32_s_arg(a: DoubleInt32) {}\n+\n+// CHECK: define { double, i32 } @f_ret_double_int32_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_int32_s() -> DoubleInt32 {\n+    DoubleInt32 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_double_uint8_s_arg({ double, i8 })\n+#[no_mangle]\n+pub extern \"C\" fn f_double_uint8_s_arg(a: DoubleUInt8) {}\n+\n+// CHECK: define { double, i8 } @f_ret_double_uint8_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_uint8_s() -> DoubleUInt8 {\n+    DoubleUInt8 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_double_int64_s_arg({ double, i64 })\n+#[no_mangle]\n+pub extern \"C\" fn f_double_int64_s_arg(a: DoubleInt64) {}\n+\n+// CHECK: define { double, i64 } @f_ret_double_int64_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_int64_s() -> DoubleInt64 {\n+    DoubleInt64 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_double_int8_s_arg_insufficient_gprs(i32 signext %a, i32 signext %b, i32 signext %c, i32 signext %d, i32 signext %e, i32 signext %f, i32 signext %g, i32 signext %h, [2 x i64])\n+#[no_mangle]\n+pub extern \"C\" fn f_double_int8_s_arg_insufficient_gprs(\n+    a: i32,\n+    b: i32,\n+    c: i32,\n+    d: i32,\n+    e: i32,\n+    f: i32,\n+    g: i32,\n+    h: i32,\n+    i: DoubleInt8,\n+) {\n+}\n+\n+// CHECK: define void @f_struct_double_int8_insufficient_fprs(float, double, double, double, double, double, double, double, [2 x i64])\n+#[no_mangle]\n+pub extern \"C\" fn f_struct_double_int8_insufficient_fprs(\n+    a: f32,\n+    b: f64,\n+    c: f64,\n+    d: f64,\n+    e: f64,\n+    f: f64,\n+    g: f64,\n+    h: f64,\n+    i: DoubleInt8,\n+) {\n+}\n+\n+#[repr(C)]\n+pub struct DoubleArr1 {\n+    a: [f64; 1],\n+}\n+\n+// CHECK: define void @f_doublearr1_s_arg(double)\n+#[no_mangle]\n+pub extern \"C\" fn f_doublearr1_s_arg(a: DoubleArr1) {}\n+\n+// CHECK: define double @f_ret_doublearr1_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_doublearr1_s() -> DoubleArr1 {\n+    DoubleArr1 { a: [1.] }\n+}\n+\n+#[repr(C)]\n+pub struct DoubleArr2 {\n+    a: [f64; 2],\n+}\n+\n+// CHECK: define void @f_doublearr2_s_arg({ double, double })\n+#[no_mangle]\n+pub extern \"C\" fn f_doublearr2_s_arg(a: DoubleArr2) {}\n+\n+// CHECK: define { double, double } @f_ret_doublearr2_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_doublearr2_s() -> DoubleArr2 {\n+    DoubleArr2 { a: [1., 2.] }\n+}\n+\n+#[repr(C)]\n+pub struct Tricky1 {\n+    f: [f64; 1],\n+}\n+\n+#[repr(C)]\n+pub struct DoubleArr2Tricky1 {\n+    g: [Tricky1; 2],\n+}\n+\n+// CHECK: define void @f_doublearr2_tricky1_s_arg({ double, double })\n+#[no_mangle]\n+pub extern \"C\" fn f_doublearr2_tricky1_s_arg(a: DoubleArr2Tricky1) {}\n+\n+// CHECK: define { double, double } @f_ret_doublearr2_tricky1_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_doublearr2_tricky1_s() -> DoubleArr2Tricky1 {\n+    DoubleArr2Tricky1 { g: [Tricky1 { f: [1.] }, Tricky1 { f: [2.] }] }\n+}\n+\n+#[repr(C)]\n+pub struct EmptyStruct {}\n+\n+#[repr(C)]\n+pub struct DoubleArr2Tricky2 {\n+    s: EmptyStruct,\n+    g: [Tricky1; 2],\n+}\n+\n+// CHECK: define void @f_doublearr2_tricky2_s_arg({ double, double })\n+#[no_mangle]\n+pub extern \"C\" fn f_doublearr2_tricky2_s_arg(a: DoubleArr2Tricky2) {}\n+\n+// CHECK: define { double, double } @f_ret_doublearr2_tricky2_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_doublearr2_tricky2_s() -> DoubleArr2Tricky2 {\n+    DoubleArr2Tricky2 { s: EmptyStruct {}, g: [Tricky1 { f: [1.] }, Tricky1 { f: [2.] }] }\n+}\n+\n+#[repr(C)]\n+pub struct IntDoubleInt {\n+    a: i32,\n+    b: f64,\n+    c: i32,\n+}\n+\n+// CHECK: define void @f_int_double_int_s_arg(%IntDoubleInt* {{.*}}%a)\n+#[no_mangle]\n+pub extern \"C\" fn f_int_double_int_s_arg(a: IntDoubleInt) {}\n+\n+// CHECK: define void @f_ret_int_double_int_s(%IntDoubleInt* {{.*}}sret\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_int_double_int_s() -> IntDoubleInt {\n+    IntDoubleInt { a: 1, b: 2., c: 3 }\n+}\n+\n+#[repr(C)]\n+pub struct CharCharDouble {\n+    a: u8,\n+    b: u8,\n+    c: f64,\n+}\n+\n+// CHECK: define void @f_char_char_double_s_arg([2 x i64])\n+#[no_mangle]\n+pub extern \"C\" fn f_char_char_double_s_arg(a: CharCharDouble) {}\n+\n+// CHECK: define [2 x i64] @f_ret_char_char_double_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_char_char_double_s() -> CharCharDouble {\n+    CharCharDouble { a: 1, b: 2, c: 3. }\n+}\n+\n+#[repr(C)]\n+pub union DoubleU {\n+    a: f64,\n+}\n+\n+// CHECK: define void @f_double_u_arg(i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_double_u_arg(a: DoubleU) {}\n+\n+// CHECK: define i64 @f_ret_double_u()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_double_u() -> DoubleU {\n+    unsafe { DoubleU { a: 1. } }\n+}"}, {"sha": "d843331f425dec92b4b03db4a554ce4640902d66", "filename": "src/test/codegen/riscv-abi/riscv64-lp64f-lp64d-abi.rs", "status": "added", "additions": 277, "deletions": 0, "changes": 277, "blob_url": "https://github.com/rust-lang/rust/blob/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64f-lp64d-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64f-lp64d-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Friscv-abi%2Friscv64-lp64f-lp64d-abi.rs?ref=39633874ae7d0150669004a80740ff3b0708d08d", "patch": "@@ -0,0 +1,277 @@\n+// ignore-tidy-linelength\n+// compile-flags: -C no-prepopulate-passes\n+// only-riscv64\n+// only-linux\n+#![crate_type = \"lib\"]\n+\n+// CHECK: define void @f_fpr_tracking(float, float, float, float, float, float, float, float, i8 zeroext %i)\n+#[no_mangle]\n+pub extern \"C\" fn f_fpr_tracking(\n+    a: f32,\n+    b: f32,\n+    c: f32,\n+    d: f32,\n+    e: f32,\n+    f: f32,\n+    g: f32,\n+    h: f32,\n+    i: u8,\n+) {\n+}\n+\n+#[repr(C)]\n+pub struct Float {\n+    f: f32,\n+}\n+\n+#[repr(C)]\n+pub struct FloatFloat {\n+    f: f32,\n+    g: f32,\n+}\n+\n+// CHECK: define void @f_float_s_arg(float)\n+#[no_mangle]\n+pub extern \"C\" fn f_float_s_arg(a: Float) {}\n+\n+// CHECK: define float @f_ret_float_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_s() -> Float {\n+    Float { f: 1. }\n+}\n+\n+// CHECK: define void @f_float_float_s_arg({ float, float })\n+#[no_mangle]\n+pub extern \"C\" fn f_float_float_s_arg(a: FloatFloat) {}\n+\n+// CHECK: define { float, float } @f_ret_float_float_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_float_s() -> FloatFloat {\n+    FloatFloat { f: 1., g: 2. }\n+}\n+\n+// CHECK: define void @f_float_float_s_arg_insufficient_fprs(float, float, float, float, float, float, float, i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_float_float_s_arg_insufficient_fprs(\n+    a: f32,\n+    b: f32,\n+    c: f32,\n+    d: f32,\n+    e: f32,\n+    f: f32,\n+    g: f32,\n+    h: FloatFloat,\n+) {\n+}\n+\n+#[repr(C)]\n+pub struct FloatInt8 {\n+    f: f32,\n+    i: i8,\n+}\n+\n+#[repr(C)]\n+pub struct FloatUInt8 {\n+    f: f32,\n+    i: u8,\n+}\n+\n+#[repr(C)]\n+pub struct FloatInt32 {\n+    f: f32,\n+    i: i32,\n+}\n+\n+#[repr(C)]\n+pub struct FloatInt64 {\n+    f: f32,\n+    i: i64,\n+}\n+\n+// CHECK: define void @f_float_int8_s_arg({ float, i8 })\n+#[no_mangle]\n+pub extern \"C\" fn f_float_int8_s_arg(a: FloatInt8) {}\n+\n+// CHECK: define { float, i8 } @f_ret_float_int8_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_int8_s() -> FloatInt8 {\n+    FloatInt8 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_float_int32_s_arg({ float, i32 })\n+#[no_mangle]\n+pub extern \"C\" fn f_float_int32_s_arg(a: FloatInt32) {}\n+\n+// CHECK: define { float, i32 } @f_ret_float_int32_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_int32_s() -> FloatInt32 {\n+    FloatInt32 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_float_uint8_s_arg({ float, i8 })\n+#[no_mangle]\n+pub extern \"C\" fn f_float_uint8_s_arg(a: FloatUInt8) {}\n+\n+// CHECK: define { float, i8 } @f_ret_float_uint8_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_uint8_s() -> FloatUInt8 {\n+    FloatUInt8 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_float_int64_s_arg({ float, i64 })\n+#[no_mangle]\n+pub extern \"C\" fn f_float_int64_s_arg(a: FloatInt64) {}\n+\n+// CHECK: define { float, i64 } @f_ret_float_int64_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_int64_s() -> FloatInt64 {\n+    FloatInt64 { f: 1., i: 2 }\n+}\n+\n+// CHECK: define void @f_float_int8_s_arg_insufficient_gprs(i32 signext %a, i32 signext %b, i32 signext %c, i32 signext %d, i32 signext %e, i32 signext %f, i32 signext %g, i32 signext %h, i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_float_int8_s_arg_insufficient_gprs(\n+    a: i32,\n+    b: i32,\n+    c: i32,\n+    d: i32,\n+    e: i32,\n+    f: i32,\n+    g: i32,\n+    h: i32,\n+    i: FloatInt8,\n+) {\n+}\n+\n+// CHECK: define void @f_struct_float_int8_insufficient_fprs(float, float, float, float, float, float, float, float, i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_struct_float_int8_insufficient_fprs(\n+    a: f32,\n+    b: f32,\n+    c: f32,\n+    d: f32,\n+    e: f32,\n+    f: f32,\n+    g: f32,\n+    h: f32,\n+    i: FloatInt8,\n+) {\n+}\n+\n+#[repr(C)]\n+pub struct FloatArr1 {\n+    a: [f32; 1],\n+}\n+\n+// CHECK: define void @f_floatarr1_s_arg(float)\n+#[no_mangle]\n+pub extern \"C\" fn f_floatarr1_s_arg(a: FloatArr1) {}\n+\n+// CHECK: define float @f_ret_floatarr1_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_floatarr1_s() -> FloatArr1 {\n+    FloatArr1 { a: [1.] }\n+}\n+\n+#[repr(C)]\n+pub struct FloatArr2 {\n+    a: [f32; 2],\n+}\n+\n+// CHECK: define void @f_floatarr2_s_arg({ float, float })\n+#[no_mangle]\n+pub extern \"C\" fn f_floatarr2_s_arg(a: FloatArr2) {}\n+\n+// CHECK: define { float, float } @f_ret_floatarr2_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_floatarr2_s() -> FloatArr2 {\n+    FloatArr2 { a: [1., 2.] }\n+}\n+\n+#[repr(C)]\n+pub struct Tricky1 {\n+    f: [f32; 1],\n+}\n+\n+#[repr(C)]\n+pub struct FloatArr2Tricky1 {\n+    g: [Tricky1; 2],\n+}\n+\n+// CHECK: define void @f_floatarr2_tricky1_s_arg({ float, float })\n+#[no_mangle]\n+pub extern \"C\" fn f_floatarr2_tricky1_s_arg(a: FloatArr2Tricky1) {}\n+\n+// CHECK: define { float, float } @f_ret_floatarr2_tricky1_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_floatarr2_tricky1_s() -> FloatArr2Tricky1 {\n+    FloatArr2Tricky1 { g: [Tricky1 { f: [1.] }, Tricky1 { f: [2.] }] }\n+}\n+\n+#[repr(C)]\n+pub struct EmptyStruct {}\n+\n+#[repr(C)]\n+pub struct FloatArr2Tricky2 {\n+    s: EmptyStruct,\n+    g: [Tricky1; 2],\n+}\n+\n+// CHECK: define void @f_floatarr2_tricky2_s_arg({ float, float })\n+#[no_mangle]\n+pub extern \"C\" fn f_floatarr2_tricky2_s_arg(a: FloatArr2Tricky2) {}\n+\n+// CHECK: define { float, float } @f_ret_floatarr2_tricky2_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_floatarr2_tricky2_s() -> FloatArr2Tricky2 {\n+    FloatArr2Tricky2 { s: EmptyStruct {}, g: [Tricky1 { f: [1.] }, Tricky1 { f: [2.] }] }\n+}\n+\n+#[repr(C)]\n+pub struct IntFloatInt {\n+    a: i32,\n+    b: f32,\n+    c: i32,\n+}\n+\n+// CHECK: define void @f_int_float_int_s_arg([2 x i64])\n+#[no_mangle]\n+pub extern \"C\" fn f_int_float_int_s_arg(a: IntFloatInt) {}\n+\n+// CHECK: define [2 x i64] @f_ret_int_float_int_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_int_float_int_s() -> IntFloatInt {\n+    IntFloatInt { a: 1, b: 2., c: 3 }\n+}\n+\n+#[repr(C)]\n+pub struct CharCharFloat {\n+    a: u8,\n+    b: u8,\n+    c: f32,\n+}\n+\n+// CHECK: define void @f_char_char_float_s_arg(i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_char_char_float_s_arg(a: CharCharFloat) {}\n+\n+// CHECK: define i64 @f_ret_char_char_float_s()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_char_char_float_s() -> CharCharFloat {\n+    CharCharFloat { a: 1, b: 2, c: 3. }\n+}\n+\n+#[repr(C)]\n+pub union FloatU {\n+    a: f32,\n+}\n+\n+// CHECK: define void @f_float_u_arg(i64)\n+#[no_mangle]\n+pub extern \"C\" fn f_float_u_arg(a: FloatU) {}\n+\n+// CHECK: define i64 @f_ret_float_u()\n+#[no_mangle]\n+pub extern \"C\" fn f_ret_float_u() -> FloatU {\n+    unsafe { FloatU { a: 1. } }\n+}"}, {"sha": "a3e70bbdb08091485ca5133af8ed45ce8950d3c5", "filename": "src/test/ui/abi/struct-enums/struct-return.rs", "status": "modified", "additions": 51, "deletions": 1, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fui%2Fabi%2Fstruct-enums%2Fstruct-return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39633874ae7d0150669004a80740ff3b0708d08d/src%2Ftest%2Fui%2Fabi%2Fstruct-enums%2Fstruct-return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fabi%2Fstruct-enums%2Fstruct-return.rs?ref=39633874ae7d0150669004a80740ff3b0708d08d", "patch": "@@ -10,13 +10,23 @@ pub struct Quad { a: u64, b: u64, c: u64, d: u64 }\n #[derive(Copy, Clone)]\n pub struct Floats { a: f64, b: u8, c: f64 }\n \n+#[repr(C)]\n+#[derive(Copy, Clone)]\n+pub struct CharCharDouble { a: u8, b: u8, c: f64 }\n+\n+#[repr(C)]\n+#[derive(Copy, Clone)]\n+pub struct CharCharFloat { a: u8, b: u8, c: f32 }\n+\n mod rustrt {\n-    use super::{Floats, Quad};\n+    use super::{Floats, Quad, CharCharDouble, CharCharFloat};\n \n     #[link(name = \"rust_test_helpers\", kind = \"static\")]\n     extern {\n         pub fn rust_dbg_abi_1(q: Quad) -> Quad;\n         pub fn rust_dbg_abi_2(f: Floats) -> Floats;\n+        pub fn rust_dbg_abi_3(a: CharCharDouble) -> CharCharDouble;\n+        pub fn rust_dbg_abi_4(a: CharCharFloat) -> CharCharFloat;\n     }\n }\n \n@@ -58,7 +68,47 @@ fn test2() {\n fn test2() {\n }\n \n+#[cfg(target_pointer_width = \"64\")]\n+fn test3() {\n+    unsafe {\n+        let a = CharCharDouble {\n+            a: 1,\n+            b: 2,\n+            c: 3.,\n+        };\n+        let b = rustrt::rust_dbg_abi_3(a);\n+        println!(\"a: {}\", b.a);\n+        println!(\"b: {}\", b.b);\n+        println!(\"c: {}\", b.c);\n+        assert_eq!(b.a, a.a + 1);\n+        assert_eq!(b.b, a.b - 1);\n+        assert_eq!(b.c, a.c + 1.0);\n+    }\n+}\n+\n+#[cfg(target_pointer_width = \"32\")]\n+fn test3() {}\n+\n+fn test4() {\n+    unsafe {\n+        let a = CharCharFloat {\n+            a: 1,\n+            b: 2,\n+            c: 3.,\n+        };\n+        let b = rustrt::rust_dbg_abi_4(a);\n+        println!(\"a: {}\", b.a);\n+        println!(\"b: {}\", b.b);\n+        println!(\"c: {}\", b.c);\n+        assert_eq!(b.a, a.a + 1);\n+        assert_eq!(b.b, a.b - 1);\n+        assert_eq!(b.c, a.c + 1.0);\n+    }\n+}\n+\n pub fn main() {\n     test1();\n     test2();\n+    test3();\n+    test4();\n }"}]}