{"sha": "d1d4613ead1896eff612903edb5da42630821b29", "node_id": "C_kwDOAAsO6NoAKGQxZDQ2MTNlYWQxODk2ZWZmNjEyOTAzZWRiNWRhNDI2MzA4MjFiMjk", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-03-25T00:34:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-03-25T00:34:28Z"}, "message": "Rollup merge of #94391 - light4:issue-90319, r=estebank\n\nFix ice when error reporting recursion errors\n\nFixes: #90319, #92148, #93955", "tree": {"sha": "0203a834219c56d4501ad33f92faa307a62dfc3a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0203a834219c56d4501ad33f92faa307a62dfc3a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d1d4613ead1896eff612903edb5da42630821b29", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiPQ4UCRBK7hj4Ov3rIwAAb1IIAD314HOtt1msFeMGCrVEbsYl\nZrw4HJfM1j+gJ/y0LC+V/GQ5mmxzbhB/a/ccppVuWNPfACgTzUErW5aKn55Sr6sl\nH/oKW/XF/Cvqh5mSGV6ELHEwNvpISVa9puPa1ZnLuv8lsnWQpokIkMaa2yY6Kcxx\ncRu2F3+p6whxkWYK0NIuq7FpEHVJmBYfiyD1dFBgqTQRsv77fbEjpvcfPv/Gqnez\nBJ3J5W7R0dywtq95LThYvy44wl4SLGtSi5tjXzxGng0hfKTzzuDE9StPk1HZoToH\nCNlsK/LUWkFfeNGTl71wUxjq/1ItfXna8Vv0c9NvX9Rsf/0ihaPN98HbtR2yeBo=\n=EHPx\n-----END PGP SIGNATURE-----\n", "payload": "tree 0203a834219c56d4501ad33f92faa307a62dfc3a\nparent 63b8f01bb5ca277e7df8d7efe094ed4244c1790c\nparent 85e67b9a5917bc82bdba0aaa3a18595904cee629\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1648168468 +0100\ncommitter GitHub <noreply@github.com> 1648168468 +0100\n\nRollup merge of #94391 - light4:issue-90319, r=estebank\n\nFix ice when error reporting recursion errors\n\nFixes: #90319, #92148, #93955\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d1d4613ead1896eff612903edb5da42630821b29", "html_url": "https://github.com/rust-lang/rust/commit/d1d4613ead1896eff612903edb5da42630821b29", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d1d4613ead1896eff612903edb5da42630821b29/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "63b8f01bb5ca277e7df8d7efe094ed4244c1790c", "url": "https://api.github.com/repos/rust-lang/rust/commits/63b8f01bb5ca277e7df8d7efe094ed4244c1790c", "html_url": "https://github.com/rust-lang/rust/commit/63b8f01bb5ca277e7df8d7efe094ed4244c1790c"}, {"sha": "85e67b9a5917bc82bdba0aaa3a18595904cee629", "url": "https://api.github.com/repos/rust-lang/rust/commits/85e67b9a5917bc82bdba0aaa3a18595904cee629", "html_url": "https://github.com/rust-lang/rust/commit/85e67b9a5917bc82bdba0aaa3a18595904cee629"}], "stats": {"total": 80, "additions": 66, "deletions": 14}, "files": [{"sha": "d852531bc68672075ce0453ec1ca75e4f2a3984e", "filename": "compiler/rustc_middle/src/traits/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -491,7 +491,7 @@ pub enum SelectionError<'tcx> {\n     /// A given constant couldn't be evaluated.\n     NotConstEvaluatable(NotConstEvaluatable),\n     /// Exceeded the recursion depth during type projection.\n-    Overflow,\n+    Overflow(OverflowError),\n     /// Signaling that an error has already been emitted, to avoid\n     /// multiple errors being shown.\n     ErrorReporting,"}, {"sha": "5297825a92fcc225d78905463dea68a09421b9c9", "filename": "compiler/rustc_middle/src/traits/select.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fselect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fselect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fselect.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -5,6 +5,7 @@\n use self::EvaluationResult::*;\n \n use super::{SelectionError, SelectionResult};\n+use rustc_errors::ErrorGuaranteed;\n \n use crate::ty;\n \n@@ -264,14 +265,26 @@ impl EvaluationResult {\n /// Indicates that trait evaluation caused overflow and in which pass.\n #[derive(Copy, Clone, Debug, PartialEq, Eq, HashStable)]\n pub enum OverflowError {\n+    Error(ErrorGuaranteed),\n     Canonical,\n     ErrorReporting,\n }\n \n+impl From<ErrorGuaranteed> for OverflowError {\n+    fn from(e: ErrorGuaranteed) -> OverflowError {\n+        OverflowError::Error(e)\n+    }\n+}\n+\n+TrivialTypeFoldableAndLiftImpls! {\n+    OverflowError,\n+}\n+\n impl<'tcx> From<OverflowError> for SelectionError<'tcx> {\n     fn from(overflow_error: OverflowError) -> SelectionError<'tcx> {\n         match overflow_error {\n-            OverflowError::Canonical => SelectionError::Overflow,\n+            OverflowError::Error(e) => SelectionError::Overflow(OverflowError::Error(e)),\n+            OverflowError::Canonical => SelectionError::Overflow(OverflowError::Canonical),\n             OverflowError::ErrorReporting => SelectionError::ErrorReporting,\n         }\n     }"}, {"sha": "5e220173caeeac0cf5f191a9b15f33d1d425f625", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -22,6 +22,7 @@ use rustc_hir::GenericParam;\n use rustc_hir::Item;\n use rustc_hir::Node;\n use rustc_middle::thir::abstract_const::NotConstEvaluatable;\n+use rustc_middle::traits::select::OverflowError;\n use rustc_middle::ty::error::ExpectedFound;\n use rustc_middle::ty::fold::TypeFolder;\n use rustc_middle::ty::{\n@@ -928,8 +929,12 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                 self.tcx.sess.delay_span_bug(span, \"`ErrorGuaranteed` without an error\");\n                 return;\n             }\n-\n-            Overflow => {\n+            // Already reported.\n+            Overflow(OverflowError::Error(_)) => {\n+                self.tcx.sess.delay_span_bug(span, \"`OverflowError` has been reported\");\n+                return;\n+            }\n+            Overflow(_) => {\n                 bug!(\"overflow should be handled before the `report_selection_error` path\");\n             }\n             SelectionError::ErrorReporting => {"}, {"sha": "b61e68735712bee38fae0cf0a226dc9b1e279089", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -27,6 +27,7 @@ use rustc_hir::def::DefKind;\n use rustc_hir::def_id::DefId;\n use rustc_hir::lang_items::LangItem;\n use rustc_infer::infer::resolve::OpportunisticRegionResolver;\n+use rustc_middle::traits::select::OverflowError;\n use rustc_middle::ty::fold::{TypeFoldable, TypeFolder};\n use rustc_middle::ty::subst::Subst;\n use rustc_middle::ty::{self, Term, ToPredicate, Ty, TyCtxt};\n@@ -1139,7 +1140,9 @@ fn project<'cx, 'tcx>(\n     if !selcx.tcx().recursion_limit().value_within_limit(obligation.recursion_depth) {\n         // This should really be an immediate error, but some existing code\n         // relies on being able to recover from this.\n-        return Err(ProjectionError::TraitSelectionError(SelectionError::Overflow));\n+        return Err(ProjectionError::TraitSelectionError(SelectionError::Overflow(\n+            OverflowError::Canonical,\n+        )));\n     }\n \n     if obligation.predicate.references_error() {"}, {"sha": "db45ee3fed7db17fb2a0842e3685631dd2d225c8", "filename": "compiler/rustc_trait_selection/src/traits/query/evaluate_obligation.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fevaluate_obligation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fevaluate_obligation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fevaluate_obligation.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -108,9 +108,11 @@ impl<'cx, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'cx, 'tcx> {\n                         )\n                     }\n                     OverflowError::ErrorReporting => EvaluationResult::EvaluatedToErr,\n+                    OverflowError::Error(_) => EvaluationResult::EvaluatedToErr,\n                 })\n             }\n             Err(OverflowError::ErrorReporting) => EvaluationResult::EvaluatedToErr,\n+            Err(OverflowError::Error(_)) => EvaluationResult::EvaluatedToErr,\n         }\n     }\n }"}, {"sha": "3e7a2252318be550f92a4f808e9b5c3ee300ed2c", "filename": "compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -164,8 +164,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                     Ok(Some(EvaluatedCandidate { candidate: c, evaluation: eval }))\n                 }\n                 Ok(_) => Ok(None),\n-                Err(OverflowError::Canonical) => Err(Overflow),\n+                Err(OverflowError::Canonical) => Err(Overflow(OverflowError::Canonical)),\n                 Err(OverflowError::ErrorReporting) => Err(ErrorReporting),\n+                Err(OverflowError::Error(e)) => Err(Overflow(OverflowError::Error(e))),\n             })\n             .flat_map(Result::transpose)\n             .collect::<Result<Vec<_>, _>>()?;"}, {"sha": "b7c2f0f4832c02ae1bb44886c6fee40375326038", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -25,7 +25,7 @@ use crate::traits::project::ProjectionCacheKeyExt;\n use crate::traits::ProjectionCacheKey;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_data_structures::stack::ensure_sufficient_stack;\n-use rustc_errors::Diagnostic;\n+use rustc_errors::{Diagnostic, ErrorGuaranteed};\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n use rustc_infer::infer::LateBoundRegionConversionTime;\n@@ -316,11 +316,11 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         obligation: &TraitObligation<'tcx>,\n     ) -> SelectionResult<'tcx, Selection<'tcx>> {\n         let candidate = match self.select_from_obligation(obligation) {\n-            Err(SelectionError::Overflow) => {\n+            Err(SelectionError::Overflow(OverflowError::Canonical)) => {\n                 // In standard mode, overflow must have been caught and reported\n                 // earlier.\n                 assert!(self.query_mode == TraitQueryMode::Canonical);\n-                return Err(SelectionError::Overflow);\n+                return Err(SelectionError::Overflow(OverflowError::Canonical));\n             }\n             Err(SelectionError::Ambiguous(_)) => {\n                 return Ok(None);\n@@ -335,9 +335,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         };\n \n         match self.confirm_candidate(obligation, candidate) {\n-            Err(SelectionError::Overflow) => {\n+            Err(SelectionError::Overflow(OverflowError::Canonical)) => {\n                 assert!(self.query_mode == TraitQueryMode::Canonical);\n-                Err(SelectionError::Overflow)\n+                Err(SelectionError::Overflow(OverflowError::Canonical))\n             }\n             Err(e) => Err(e),\n             Ok(candidate) => {\n@@ -954,7 +954,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             Ok(Some(c)) => self.evaluate_candidate(stack, &c),\n             Err(SelectionError::Ambiguous(_)) => Ok(EvaluatedToAmbig),\n             Ok(None) => Ok(EvaluatedToAmbig),\n-            Err(Overflow) => Err(OverflowError::Canonical),\n+            Err(Overflow(OverflowError::Canonical)) => Err(OverflowError::Canonical),\n             Err(ErrorReporting) => Err(OverflowError::ErrorReporting),\n             Err(..) => Ok(EvaluatedToErr),\n         }\n@@ -1113,7 +1113,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             match self.query_mode {\n                 TraitQueryMode::Standard => {\n                     if self.infcx.is_tainted_by_errors() {\n-                        return Err(OverflowError::ErrorReporting);\n+                        return Err(OverflowError::Error(\n+                            ErrorGuaranteed::unchecked_claim_error_was_emitted(),\n+                        ));\n                     }\n                     self.infcx.report_overflow_error(error_obligation, true);\n                 }\n@@ -1349,7 +1351,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         }\n \n         if self.can_use_global_caches(param_env) {\n-            if let Err(Overflow) = candidate {\n+            if let Err(Overflow(OverflowError::Canonical)) = candidate {\n                 // Don't cache overflow globally; we only produce this in certain modes.\n             } else if !pred.needs_infer() {\n                 if !candidate.needs_infer() {"}, {"sha": "57e6ac7cf34f52d4b63e8753bf37e8b50aece5dc", "filename": "src/test/ui/typeck/issue-90319.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/src%2Ftest%2Fui%2Ftypeck%2Fissue-90319.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/src%2Ftest%2Fui%2Ftypeck%2Fissue-90319.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-90319.rs?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -0,0 +1,17 @@\n+struct Wrapper<T>(T);\n+\n+trait Trait {\n+    fn method(&self) {}\n+}\n+\n+impl<'a, T> Trait for Wrapper<&'a T> where Wrapper<T>: Trait {}\n+\n+fn get<T>() -> T {\n+    unimplemented!()\n+}\n+\n+fn main() {\n+    let thing = get::<Thing>();//~ERROR cannot find type `Thing` in this scope [E0412]\n+    let wrapper = Wrapper(thing);\n+    Trait::method(&wrapper);\n+}"}, {"sha": "61549dd701e747e2721683e8e02fa3e0acf2c33a", "filename": "src/test/ui/typeck/issue-90319.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d1d4613ead1896eff612903edb5da42630821b29/src%2Ftest%2Fui%2Ftypeck%2Fissue-90319.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d1d4613ead1896eff612903edb5da42630821b29/src%2Ftest%2Fui%2Ftypeck%2Fissue-90319.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-90319.stderr?ref=d1d4613ead1896eff612903edb5da42630821b29", "patch": "@@ -0,0 +1,9 @@\n+error[E0412]: cannot find type `Thing` in this scope\n+  --> $DIR/issue-90319.rs:14:23\n+   |\n+LL |     let thing = get::<Thing>();\n+   |                       ^^^^^ not found in this scope\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0412`."}]}