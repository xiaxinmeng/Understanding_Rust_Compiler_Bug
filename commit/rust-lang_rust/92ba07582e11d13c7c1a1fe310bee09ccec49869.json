{"sha": "92ba07582e11d13c7c1a1fe310bee09ccec49869", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkyYmEwNzU4MmUxMWQxM2M3YzFhMWZlMzEwYmVlMDljY2VjNDk4Njk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-07T17:06:27Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-07T17:06:27Z"}, "message": "Auto merge of #6134 - patrickelectric:as_utf8, r=llogiq\n\nCheck when `from_utf8` is called from sliced byte array from string\n\n---\n\n*Please keep the line below*\nchangelog: Fix #5487: Add linter to check when `from_utf8` is called from sliced byte array from string.", "tree": {"sha": "fe274bff6f349b55ca3b4e11cbdc12d7d136586b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe274bff6f349b55ca3b4e11cbdc12d7d136586b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/92ba07582e11d13c7c1a1fe310bee09ccec49869", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/92ba07582e11d13c7c1a1fe310bee09ccec49869", "html_url": "https://github.com/rust-lang/rust/commit/92ba07582e11d13c7c1a1fe310bee09ccec49869", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/92ba07582e11d13c7c1a1fe310bee09ccec49869/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "694cec12bed1fb01f10622511fd72a9a8e0606f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/694cec12bed1fb01f10622511fd72a9a8e0606f0", "html_url": "https://github.com/rust-lang/rust/commit/694cec12bed1fb01f10622511fd72a9a8e0606f0"}, {"sha": "bc27d1492d60ecfb0673629e28bc4bbe0b7fd886", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc27d1492d60ecfb0673629e28bc4bbe0b7fd886", "html_url": "https://github.com/rust-lang/rust/commit/bc27d1492d60ecfb0673629e28bc4bbe0b7fd886"}], "stats": {"total": 102, "additions": 99, "deletions": 3}, "files": [{"sha": "e0770a45c5334d244eeac402970763850c1c9518", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -1956,6 +1956,7 @@ Released 2018-09-13\n [`string_add`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_add\n [`string_add_assign`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_add_assign\n [`string_extend_chars`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_extend_chars\n+[`string_from_utf8_as_bytes`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_from_utf8_as_bytes\n [`string_lit_as_bytes`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_lit_as_bytes\n [`string_to_string`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_to_string\n [`struct_excessive_bools`]: https://rust-lang.github.io/rust-clippy/master/index.html#struct_excessive_bools"}, {"sha": "1f4bed92e695d62690d8b49d128b7258b7247a64", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -832,6 +832,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &stable_sort_primitive::STABLE_SORT_PRIMITIVE,\n         &strings::STRING_ADD,\n         &strings::STRING_ADD_ASSIGN,\n+        &strings::STRING_FROM_UTF8_AS_BYTES,\n         &strings::STRING_LIT_AS_BYTES,\n         &suspicious_trait_impl::SUSPICIOUS_ARITHMETIC_IMPL,\n         &suspicious_trait_impl::SUSPICIOUS_OP_ASSIGN_IMPL,\n@@ -1527,6 +1528,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&single_component_path_imports::SINGLE_COMPONENT_PATH_IMPORTS),\n         LintId::of(&slow_vector_initialization::SLOW_VECTOR_INITIALIZATION),\n         LintId::of(&stable_sort_primitive::STABLE_SORT_PRIMITIVE),\n+        LintId::of(&strings::STRING_FROM_UTF8_AS_BYTES),\n         LintId::of(&suspicious_trait_impl::SUSPICIOUS_ARITHMETIC_IMPL),\n         LintId::of(&suspicious_trait_impl::SUSPICIOUS_OP_ASSIGN_IMPL),\n         LintId::of(&swap::ALMOST_SWAPPED),\n@@ -1752,6 +1754,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&reference::DEREF_ADDROF),\n         LintId::of(&reference::REF_IN_DEREF),\n         LintId::of(&repeat_once::REPEAT_ONCE),\n+        LintId::of(&strings::STRING_FROM_UTF8_AS_BYTES),\n         LintId::of(&swap::MANUAL_SWAP),\n         LintId::of(&temporary_assignment::TEMPORARY_ASSIGNMENT),\n         LintId::of(&transmute::CROSSPOINTER_TRANSMUTE),"}, {"sha": "ede37624f71a4f1e7364cf4ae70af461c74dacf3", "filename": "clippy_lints/src/strings.rs", "status": "modified", "additions": 65, "deletions": 3, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/clippy_lints%2Fsrc%2Fstrings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/clippy_lints%2Fsrc%2Fstrings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fstrings.rs?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -1,5 +1,5 @@\n use rustc_errors::Applicability;\n-use rustc_hir::{BinOpKind, Expr, ExprKind};\n+use rustc_hir::{BinOpKind, BorrowKind, Expr, ExprKind, LangItem, QPath};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::lint::in_external_macro;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -9,7 +9,10 @@ use rustc_span::sym;\n use if_chain::if_chain;\n \n use crate::utils::SpanlessEq;\n-use crate::utils::{get_parent_expr, is_allowed, is_type_diagnostic_item, span_lint, span_lint_and_sugg};\n+use crate::utils::{\n+    get_parent_expr, is_allowed, is_type_diagnostic_item, match_function_call, method_calls, paths, span_lint,\n+    span_lint_and_sugg,\n+};\n \n declare_clippy_lint! {\n     /// **What it does:** Checks for string appends of the form `x = x + y` (without\n@@ -174,16 +177,75 @@ fn is_add(cx: &LateContext<'_>, src: &Expr<'_>, target: &Expr<'_>) -> bool {\n     }\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Check if the string is transformed to byte array and casted back to string.\n+    ///\n+    /// **Why is this bad?** It's unnecessary, the string can be used directly.\n+    ///\n+    /// **Known problems:** None\n+    ///\n+    /// **Example:**\n+    /// ```rust\n+    /// let _ = std::str::from_utf8(&\"Hello World!\".as_bytes()[6..11]).unwrap();\n+    /// ```\n+    /// could be written as\n+    /// ```rust\n+    /// let _ = &\"Hello World!\"[6..11];\n+    /// ```\n+    pub STRING_FROM_UTF8_AS_BYTES,\n+    complexity,\n+    \"casting string slices to byte slices and back\"\n+}\n+\n // Max length a b\"foo\" string can take\n const MAX_LENGTH_BYTE_STRING_LIT: usize = 32;\n \n-declare_lint_pass!(StringLitAsBytes => [STRING_LIT_AS_BYTES]);\n+declare_lint_pass!(StringLitAsBytes => [STRING_LIT_AS_BYTES, STRING_FROM_UTF8_AS_BYTES]);\n \n impl<'tcx> LateLintPass<'tcx> for StringLitAsBytes {\n     fn check_expr(&mut self, cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) {\n         use crate::utils::{snippet, snippet_with_applicability};\n         use rustc_ast::LitKind;\n \n+        if_chain! {\n+            // Find std::str::converts::from_utf8\n+            if let Some(args) = match_function_call(cx, e, &paths::STR_FROM_UTF8);\n+\n+            // Find string::as_bytes\n+            if let ExprKind::AddrOf(BorrowKind::Ref, _, ref args) = args[0].kind;\n+            if let ExprKind::Index(ref left, ref right) = args.kind;\n+            let (method_names, expressions, _) = method_calls(left, 1);\n+            if method_names.len() == 1;\n+            if expressions.len() == 1;\n+            if expressions[0].len() == 1;\n+            if method_names[0] == sym!(as_bytes);\n+\n+            // Check for slicer\n+            if let ExprKind::Struct(ref path, _, _) = right.kind;\n+            if let QPath::LangItem(LangItem::Range, _) = path;\n+\n+            then {\n+                let mut applicability = Applicability::MachineApplicable;\n+                let string_expression = &expressions[0][0];\n+\n+                let snippet_app = snippet_with_applicability(\n+                    cx,\n+                    string_expression.span, \"..\",\n+                    &mut applicability,\n+                );\n+\n+                span_lint_and_sugg(\n+                    cx,\n+                    STRING_FROM_UTF8_AS_BYTES,\n+                    e.span,\n+                    \"calling a slice of `as_bytes()` with `from_utf8` should be not necessary\",\n+                    \"try\",\n+                    format!(\"Some(&{}[{}])\", snippet_app, snippet(cx, right.span, \"..\")),\n+                    applicability\n+                )\n+            }\n+        }\n+\n         if_chain! {\n             if let ExprKind::MethodCall(path, _, args, _) = &e.kind;\n             if path.ident.name == sym!(as_bytes);"}, {"sha": "2be5ff93f86959efd637996f0805417359260170", "filename": "clippy_lints/src/utils/paths.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fpaths.rs?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -122,6 +122,7 @@ pub const STRING: [&str; 3] = [\"alloc\", \"string\", \"String\"];\n pub const STRING_AS_MUT_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_mut_str\"];\n pub const STRING_AS_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_str\"];\n pub const STR_ENDS_WITH: [&str; 4] = [\"core\", \"str\", \"<impl str>\", \"ends_with\"];\n+pub const STR_FROM_UTF8: [&str; 4] = [\"core\", \"str\", \"converts\", \"from_utf8\"];\n pub const STR_LEN: [&str; 4] = [\"core\", \"str\", \"<impl str>\", \"len\"];\n pub const STR_STARTS_WITH: [&str; 4] = [\"core\", \"str\", \"<impl str>\", \"starts_with\"];\n pub const SYNTAX_CONTEXT: [&str; 3] = [\"rustc_span\", \"hygiene\", \"SyntaxContext\"];"}, {"sha": "bc0a0ad2b179deb226b975b288bdc6560633fe62", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -2258,6 +2258,13 @@ vec![\n         deprecation: None,\n         module: \"methods\",\n     },\n+    Lint {\n+        name: \"string_from_utf8_as_bytes\",\n+        group: \"complexity\",\n+        desc: \"casting string slices to byte slices and back\",\n+        deprecation: None,\n+        module: \"strings\",\n+    },\n     Lint {\n         name: \"string_lit_as_bytes\",\n         group: \"nursery\","}, {"sha": "6e665cdd5630243264972ad317b061689176d3dd", "filename": "tests/ui/string_from_utf8_as_bytes.fixed", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/tests%2Fui%2Fstring_from_utf8_as_bytes.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/tests%2Fui%2Fstring_from_utf8_as_bytes.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_from_utf8_as_bytes.fixed?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -0,0 +1,6 @@\n+// run-rustfix\n+#![warn(clippy::string_from_utf8_as_bytes)]\n+\n+fn main() {\n+    let _ = Some(&\"Hello World!\"[6..11]);\n+}"}, {"sha": "670d206d3679c17cf6fded4040e49e83b2b2f736", "filename": "tests/ui/string_from_utf8_as_bytes.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/tests%2Fui%2Fstring_from_utf8_as_bytes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/tests%2Fui%2Fstring_from_utf8_as_bytes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_from_utf8_as_bytes.rs?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -0,0 +1,6 @@\n+// run-rustfix\n+#![warn(clippy::string_from_utf8_as_bytes)]\n+\n+fn main() {\n+    let _ = std::str::from_utf8(&\"Hello World!\".as_bytes()[6..11]);\n+}"}, {"sha": "bf5e5d33e8f9ab287f124f7ecb083c92dc327eb0", "filename": "tests/ui/string_from_utf8_as_bytes.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/92ba07582e11d13c7c1a1fe310bee09ccec49869/tests%2Fui%2Fstring_from_utf8_as_bytes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/92ba07582e11d13c7c1a1fe310bee09ccec49869/tests%2Fui%2Fstring_from_utf8_as_bytes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_from_utf8_as_bytes.stderr?ref=92ba07582e11d13c7c1a1fe310bee09ccec49869", "patch": "@@ -0,0 +1,10 @@\n+error: calling a slice of `as_bytes()` with `from_utf8` should be not necessary\n+  --> $DIR/string_from_utf8_as_bytes.rs:5:13\n+   |\n+LL |     let _ = std::str::from_utf8(&\"Hello World!\".as_bytes()[6..11]);\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `Some(&\"Hello World!\"[6..11])`\n+   |\n+   = note: `-D clippy::string-from-utf8-as-bytes` implied by `-D warnings`\n+\n+error: aborting due to previous error\n+"}]}