{"sha": "b3a4ba570e8e5066564c2e9a96cc381a443d544f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzYTRiYTU3MGU4ZTUwNjY1NjRjMmU5YTk2Y2MzODFhNDQzZDU0NGY=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-04-05T23:30:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-04-05T23:30:33Z"}, "message": "Merge pull request #1432 from topecongiro/parse-config\n\nPrint error and usage when decoding config file failed", "tree": {"sha": "f4c291f60bfecb7d4b757f7820969c70aec55423", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4c291f60bfecb7d4b757f7820969c70aec55423"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b3a4ba570e8e5066564c2e9a96cc381a443d544f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b3a4ba570e8e5066564c2e9a96cc381a443d544f", "html_url": "https://github.com/rust-lang/rust/commit/b3a4ba570e8e5066564c2e9a96cc381a443d544f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b3a4ba570e8e5066564c2e9a96cc381a443d544f/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d476bef7ed3e75ed79c87717ed351727d7c5d593", "url": "https://api.github.com/repos/rust-lang/rust/commits/d476bef7ed3e75ed79c87717ed351727d7c5d593", "html_url": "https://github.com/rust-lang/rust/commit/d476bef7ed3e75ed79c87717ed351727d7c5d593"}, {"sha": "6af096851124a515fa13e8cf07c646b70fce41d9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6af096851124a515fa13e8cf07c646b70fce41d9", "html_url": "https://github.com/rust-lang/rust/commit/6af096851124a515fa13e8cf07c646b70fce41d9"}], "stats": {"total": 41, "additions": 22, "deletions": 19}, "files": [{"sha": "400ee90702112a5212dfbd5344fc8cf4886cdcef", "filename": "src/bin/rustfmt.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b3a4ba570e8e5066564c2e9a96cc381a443d544f/src%2Fbin%2Frustfmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3a4ba570e8e5066564c2e9a96cc381a443d544f/src%2Fbin%2Frustfmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Frustfmt.rs?ref=b3a4ba570e8e5066564c2e9a96cc381a443d544f", "patch": "@@ -149,7 +149,10 @@ fn resolve_config(dir: &Path) -> FmtResult<(Config, Option<PathBuf>)> {\n     let mut file = try!(File::open(&path));\n     let mut toml = String::new();\n     try!(file.read_to_string(&mut toml));\n-    Ok((Config::from_toml(&toml), Some(path)))\n+    match Config::from_toml(&toml) {\n+        Ok(cfg) => Ok((cfg, Some(path))),\n+        Err(err) => Err(FmtError::from(err)),\n+    }\n }\n \n /// read the given config file path recursively if present else read the project file path\n@@ -211,8 +214,8 @@ fn execute(opts: &Options) -> FmtResult<Summary> {\n         }\n         Operation::Stdin { input, config_path } => {\n             // try to read config from local directory\n-            let (mut config, _) = match_cli_path_or_file(config_path, &env::current_dir().unwrap())\n-                .expect(\"Error resolving config\");\n+            let (mut config, _) = match_cli_path_or_file(config_path,\n+                                                         &env::current_dir().unwrap())?;\n \n             // write_mode is always Plain for Stdin.\n             config.write_mode = WriteMode::Plain;\n@@ -242,8 +245,7 @@ fn execute(opts: &Options) -> FmtResult<Summary> {\n             let mut path = None;\n             // Load the config path file if provided\n             if let Some(config_file) = config_path {\n-                let (cfg_tmp, path_tmp) = resolve_config(config_file.as_ref())\n-                    .expect(&format!(\"Error resolving config for {:?}\", config_file));\n+                let (cfg_tmp, path_tmp) = resolve_config(config_file.as_ref())?;\n                 config = cfg_tmp;\n                 path = path_tmp;\n             };\n@@ -258,8 +260,7 @@ fn execute(opts: &Options) -> FmtResult<Summary> {\n             for file in files {\n                 // Check the file directory if the config-path could not be read or not provided\n                 if path.is_none() {\n-                    let (config_tmp, path_tmp) = resolve_config(file.parent().unwrap())\n-                        .expect(&format!(\"Error resolving config for {}\", file.display()));\n+                    let (config_tmp, path_tmp) = resolve_config(file.parent().unwrap())?;\n                     if options.verbose {\n                         if let Some(path) = path_tmp.as_ref() {\n                             println!(\"Using rustfmt config file {} for {}\","}, {"sha": "21ab6cd54475e3d9db18dc501eb5ed2e5a181caf", "filename": "src/config.rs", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b3a4ba570e8e5066564c2e9a96cc381a443d544f/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3a4ba570e8e5066564c2e9a96cc381a443d544f/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=b3a4ba570e8e5066564c2e9a96cc381a443d544f", "patch": "@@ -12,7 +12,6 @@ extern crate toml;\n \n use file_lines::FileLines;\n use lists::{SeparatorTactic, ListTactic};\n-use std::io::Write;\n \n macro_rules! configuration_option_enum{\n     ($e:ident: $( $x:ident ),+ $(,)*) => {\n@@ -237,26 +236,29 @@ macro_rules! create_config {\n                 self\n             }\n \n-            pub fn from_toml(toml: &str) -> Config {\n+            pub fn from_toml(toml: &str) -> Result<Config, String> {\n                 let parsed: toml::Value = toml.parse().expect(\"Could not parse TOML\");\n+                let mut err: String = String::new();\n                 for (key, _) in parsed.as_table().expect(\"Parsed config was not table\") {\n                     match &**key {\n                         $(\n                             stringify!($i) => (),\n                         )+\n-                        _ => msg!(\"Warning: Unused configuration option {}\", key),\n+                        _ => {\n+                            let msg = &format!(\"Warning: Unknown configuration option `{}`\\n\", key);\n+                            err.push_str(msg)\n+                        }\n                     }\n                 }\n-                let parsed_config:ParsedConfig = match toml::decode(parsed) {\n-                    Some(decoded) => decoded,\n+                match toml::decode(parsed) {\n+                    Some(parsed_config) =>\n+                        Ok(Config::default().fill_from_parsed_config(parsed_config)),\n                     None => {\n-                        msg!(\"Decoding config file failed. Config:\\n{}\", toml);\n-                        let parsed: toml::Value = toml.parse().expect(\"Could not parse TOML\");\n-                        msg!(\"\\n\\nParsed:\\n{:?}\", parsed);\n-                        panic!();\n+                        err.push_str(\"Error: Decoding config file failed. \");\n+                        err.push_str(\"Please check your config file.\\n\");\n+                        Err(err)\n                     }\n-                };\n-                Config::default().fill_from_parsed_config(parsed_config)\n+                }\n             }\n \n             pub fn override_value(&mut self, key: &str, val: &str) {"}, {"sha": "0d7c47feb32fb43b1b1c4c8e1fddfc0844a10845", "filename": "tests/system.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b3a4ba570e8e5066564c2e9a96cc381a443d544f/tests%2Fsystem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3a4ba570e8e5066564c2e9a96cc381a443d544f/tests%2Fsystem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsystem.rs?ref=b3a4ba570e8e5066564c2e9a96cc381a443d544f", "patch": "@@ -285,7 +285,7 @@ fn get_config(config_file: Option<&str>) -> Config {\n         .read_to_string(&mut def_config)\n         .expect(\"Couldn't read config\");\n \n-    Config::from_toml(&def_config)\n+    Config::from_toml(&def_config).expect(\"Invalid toml\")\n }\n \n // Reads significant comments of the form: // rustfmt-key: value"}]}