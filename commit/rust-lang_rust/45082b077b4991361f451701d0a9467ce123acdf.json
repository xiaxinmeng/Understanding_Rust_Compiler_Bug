{"sha": "45082b077b4991361f451701d0a9467ce123acdf", "node_id": "C_kwDOAAsO6NoAKDQ1MDgyYjA3N2I0OTkxMzYxZjQ1MTcwMWQwYTk0NjdjZTEyM2FjZGY", "commit": {"author": {"name": "The 8472", "email": "git@infinite-source.de", "date": "2022-02-06T10:43:50Z"}, "committer": {"name": "The 8472", "email": "git@infinite-source.de", "date": "2022-02-06T10:43:50Z"}, "message": "Fix hashing for windows paths containing a CurDir component\n\n* the logic only checked for / but not for \\\n* verbatim paths shouldn't skip items at all since they don't get normalized\n* the extra branches get optimized out on unix since is_sep_byte is a trivial comparison and is_verbatim is always-false\n* tests lacked windows coverage for these cases\n\nThat lead to equal paths not having equal hashes and to unnecessary collisions.", "tree": {"sha": "6dd7fbcc61e17792dacf77d2e1b5e55c61b1780d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6dd7fbcc61e17792dacf77d2e1b5e55c61b1780d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/45082b077b4991361f451701d0a9467ce123acdf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/45082b077b4991361f451701d0a9467ce123acdf", "html_url": "https://github.com/rust-lang/rust/commit/45082b077b4991361f451701d0a9467ce123acdf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/45082b077b4991361f451701d0a9467ce123acdf/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "686663a49e57870c78a4cd047f23a44175fc67a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/686663a49e57870c78a4cd047f23a44175fc67a4", "html_url": "https://github.com/rust-lang/rust/commit/686663a49e57870c78a4cd047f23a44175fc67a4"}], "stats": {"total": 61, "additions": 52, "deletions": 9}, "files": [{"sha": "4c864663922568fe82b311290ccac4dc4302908b", "filename": "library/std/src/path.rs", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/45082b077b4991361f451701d0a9467ce123acdf/library%2Fstd%2Fsrc%2Fpath.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45082b077b4991361f451701d0a9467ce123acdf/library%2Fstd%2Fsrc%2Fpath.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fpath.rs?ref=45082b077b4991361f451701d0a9467ce123acdf", "patch": "@@ -2920,32 +2920,40 @@ impl cmp::PartialEq for Path {\n impl Hash for Path {\n     fn hash<H: Hasher>(&self, h: &mut H) {\n         let bytes = self.as_u8_slice();\n-        let prefix_len = match parse_prefix(&self.inner) {\n+        let (prefix_len, verbatim) = match parse_prefix(&self.inner) {\n             Some(prefix) => {\n                 prefix.hash(h);\n-                prefix.len()\n+                (prefix.len(), prefix.is_verbatim())\n             }\n-            None => 0,\n+            None => (0, false),\n         };\n         let bytes = &bytes[prefix_len..];\n \n         let mut component_start = 0;\n         let mut bytes_hashed = 0;\n \n         for i in 0..bytes.len() {\n-            if is_sep_byte(bytes[i]) {\n+            let is_sep = if verbatim { is_verbatim_sep(bytes[i]) } else { is_sep_byte(bytes[i]) };\n+            if is_sep {\n                 if i > component_start {\n                     let to_hash = &bytes[component_start..i];\n                     h.write(to_hash);\n                     bytes_hashed += to_hash.len();\n                 }\n \n                 // skip over separator and optionally a following CurDir item\n-                // since components() would normalize these away\n-                component_start = i + match bytes[i..] {\n-                    [_, b'.', b'/', ..] | [_, b'.'] => 2,\n-                    _ => 1,\n-                };\n+                // since components() would normalize these away.\n+                component_start = i + 1;\n+\n+                let tail = &bytes[component_start..];\n+\n+                if !verbatim {\n+                    component_start += match tail {\n+                        [b'.'] => 1,\n+                        [b'.', sep @ _, ..] if is_sep_byte(*sep) => 1,\n+                        _ => 0,\n+                    };\n+                }\n             }\n         }\n "}, {"sha": "0ab5956e1bc6beb45c43768678da5dac5f268d86", "filename": "library/std/src/path/tests.rs", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/45082b077b4991361f451701d0a9467ce123acdf/library%2Fstd%2Fsrc%2Fpath%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45082b077b4991361f451701d0a9467ce123acdf/library%2Fstd%2Fsrc%2Fpath%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fpath%2Ftests.rs?ref=45082b077b4991361f451701d0a9467ce123acdf", "patch": "@@ -1498,6 +1498,20 @@ pub fn test_compare() {\n     relative_from: Some(\"\")\n     );\n \n+    tc!(\"foo/.\", \"foo\",\n+    eq: true,\n+    starts_with: true,\n+    ends_with: true,\n+    relative_from: Some(\"\")\n+    );\n+\n+    tc!(\"foo/./bar\", \"foo/bar\",\n+    eq: true,\n+    starts_with: true,\n+    ends_with: true,\n+    relative_from: Some(\"\")\n+    );\n+\n     tc!(\"foo/bar\", \"foo\",\n     eq: false,\n     starts_with: true,\n@@ -1541,6 +1555,27 @@ pub fn test_compare() {\n         ends_with: true,\n         relative_from: Some(\"\")\n         );\n+\n+        tc!(r\"C:\\foo\\.\\bar.txt\", r\"C:\\foo\\bar.txt\",\n+        eq: true,\n+        starts_with: true,\n+        ends_with: true,\n+        relative_from: Some(\"\")\n+        );\n+\n+        tc!(r\"C:\\foo\\.\", r\"C:\\foo\",\n+        eq: true,\n+        starts_with: true,\n+        ends_with: true,\n+        relative_from: Some(\"\")\n+        );\n+\n+        tc!(r\"\\\\?\\C:\\foo\\.\\bar.txt\", r\"\\\\?\\C:\\foo\\bar.txt\",\n+        eq: false,\n+        starts_with: false,\n+        ends_with: false,\n+        relative_from: None\n+        );\n     }\n }\n "}]}