{"sha": "28a0e9c9992836becb9cb231343f95e691a642a3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4YTBlOWM5OTkyODM2YmVjYjljYjIzMTM0M2Y5NWU2OTFhNjQyYTM=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2012-04-03T00:37:59Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2012-04-03T00:38:06Z"}, "message": "Construct new strings through upcalls.", "tree": {"sha": "1579d54d42321c34042a322dc3ac80294b9fe241", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1579d54d42321c34042a322dc3ac80294b9fe241"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/28a0e9c9992836becb9cb231343f95e691a642a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/28a0e9c9992836becb9cb231343f95e691a642a3", "html_url": "https://github.com/rust-lang/rust/commit/28a0e9c9992836becb9cb231343f95e691a642a3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/28a0e9c9992836becb9cb231343f95e691a642a3/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "21be1379d561b6679a8a2ea47dce88f948c5acca", "url": "https://api.github.com/repos/rust-lang/rust/commits/21be1379d561b6679a8a2ea47dce88f948c5acca", "html_url": "https://github.com/rust-lang/rust/commit/21be1379d561b6679a8a2ea47dce88f948c5acca"}], "stats": {"total": 37, "additions": 29, "deletions": 8}, "files": [{"sha": "cf40e1500de62a6a05bc648ddb3bdc40ee6092ea", "filename": "src/rt/rust_upcall.cpp", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frt%2Frust_upcall.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frt%2Frust_upcall.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_upcall.cpp?ref=28a0e9c9992836becb9cb231343f95e691a642a3", "patch": "@@ -291,6 +291,27 @@ upcall_shared_realloc(void *ptr, size_t size) {\n \n /**********************************************************************/\n \n+struct s_str_new_args {\n+    const char *cstr;\n+    size_t len;\n+    rust_str *retval;\n+};\n+\n+extern \"C\" CDECL void\n+upcall_s_str_new(s_str_new_args *args) {\n+    rust_task *task = rust_get_current_task();\n+    LOG_UPCALL_ENTRY(task);\n+    args->retval = make_str(task->kernel, args->cstr, args->len, \"str_new\");\n+}\n+\n+extern \"C\" CDECL rust_str*\n+upcall_str_new(const char *cstr, size_t len) {\n+    s_str_new_args args = { cstr, len, 0 };\n+    UPCALL_SWITCH_STACK(&args, upcall_s_str_new);\n+    return args.retval;\n+}\n+\n+\n struct s_vec_grow_args {\n     rust_vec** vp;\n     size_t new_sz;"}, {"sha": "c9f46a45177f6a44fc4cc74cb42e92e7bfed5943", "filename": "src/rt/rustrt.def.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frt%2Frustrt.def.in", "raw_url": "https://github.com/rust-lang/rust/raw/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frt%2Frustrt.def.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frustrt.def.in?ref=28a0e9c9992836becb9cb231343f95e691a642a3", "patch": "@@ -69,6 +69,7 @@ upcall_shared_malloc\n upcall_shared_free\n upcall_shared_realloc\n upcall_vec_grow\n+upcall_str_new\n upcall_str_concat\n upcall_call_shim_on_c_stack\n upcall_call_shim_on_rust_stack"}, {"sha": "4158e881dccea7cd41c505cf50af539fb53ffc9f", "filename": "src/rustc/back/upcall.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frustc%2Fback%2Fupcall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frustc%2Fback%2Fupcall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fback%2Fupcall.rs?ref=28a0e9c9992836becb9cb231343f95e691a642a3", "patch": "@@ -17,6 +17,7 @@ type upcalls =\n      shared_realloc: ValueRef,\n      mark: ValueRef,\n      vec_grow: ValueRef,\n+     str_new: ValueRef,\n      str_concat: ValueRef,\n      cmp_type: ValueRef,\n      log_type: ValueRef,\n@@ -64,6 +65,8 @@ fn declare_upcalls(targ_cfg: @session::config,\n               d(\"mark\", [T_ptr(T_i8())], int_t),\n           vec_grow:\n               dv(\"vec_grow\", [T_ptr(T_ptr(opaque_vec_t)), int_t]),\n+          str_new:\n+              d(\"str_new\", [T_ptr(T_i8()), int_t], T_ptr(opaque_vec_t)),\n           str_concat:\n               d(\"str_concat\", [T_ptr(opaque_vec_t), T_ptr(opaque_vec_t)],\n                 T_ptr(opaque_vec_t)),"}, {"sha": "f3d0659194224508cd011e2b654b064e57271dca", "filename": "src/rustc/middle/trans/tvec.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frustc%2Fmiddle%2Ftrans%2Ftvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28a0e9c9992836becb9cb231343f95e691a642a3/src%2Frustc%2Fmiddle%2Ftrans%2Ftvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Ftvec.rs?ref=28a0e9c9992836becb9cb231343f95e691a642a3", "patch": "@@ -131,15 +131,11 @@ fn trans_vec(bcx: block, args: [@ast::expr], id: ast::node_id,\n \n fn trans_str(bcx: block, s: str, dest: dest) -> block {\n     let _icx = bcx.insn_ctxt(\"tvec::trans_str\");\n-    let veclen = str::len(s) + 1u; // +1 for \\0\n-    let {bcx: bcx, val: sptr, _} =\n-        alloc(bcx, ty::mk_str(bcx.tcx()), veclen);\n-\n     let ccx = bcx.ccx();\n-    let llcstr = C_cstr(ccx, s);\n-    call_memmove(bcx, get_dataptr(bcx, sptr, T_i8()), llcstr,\n-                 C_uint(ccx, veclen));\n-    ret base::store_in_dest(bcx, sptr, dest);\n+    let cs = PointerCast(bcx, C_cstr(ccx, s), T_ptr(T_i8()));\n+    let len = C_uint(ccx, str::len(s));\n+    let n = Call(bcx, ccx.upcalls.str_new, [cs, len]);\n+    ret base::store_in_dest(bcx, n, dest);\n }\n \n fn trans_append(bcx: block, vec_ty: ty::t, lhsptr: ValueRef,"}]}