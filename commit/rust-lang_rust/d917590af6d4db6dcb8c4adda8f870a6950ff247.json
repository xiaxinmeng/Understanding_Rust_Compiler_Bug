{"sha": "d917590af6d4db6dcb8c4adda8f870a6950ff247", "node_id": "C_kwDOAAsO6NoAKGQ5MTc1OTBhZjZkNGRiNmRjYjhjNGFkZGE4Zjg3MGE2OTUwZmYyNDc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-16T14:06:56Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-16T14:06:56Z"}, "message": "Auto merge of #9658 - TennyZhuang:partial-pub-fields, r=llogiq\n\nAdd new lint `partial_pub_fields`\n\nSigned-off-by: TennyZhuang <zty0826@gmail.com>\n\n*Please write a short comment explaining your change (or \"none\" for internal only changes)*\n\nchangelog: `partial_pub_fields`: new lint to disallow partial fields of a struct be pub\n\nResolve #9604", "tree": {"sha": "cac749e3e1d4f1c23b47bfc360ff9538f652e4a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cac749e3e1d4f1c23b47bfc360ff9538f652e4a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d917590af6d4db6dcb8c4adda8f870a6950ff247", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d917590af6d4db6dcb8c4adda8f870a6950ff247", "html_url": "https://github.com/rust-lang/rust/commit/d917590af6d4db6dcb8c4adda8f870a6950ff247", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d917590af6d4db6dcb8c4adda8f870a6950ff247/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "332b5b3d8b883087ea1632bf7cfb13721db6d9f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/332b5b3d8b883087ea1632bf7cfb13721db6d9f9", "html_url": "https://github.com/rust-lang/rust/commit/332b5b3d8b883087ea1632bf7cfb13721db6d9f9"}, {"sha": "360b48b1ab97471c0d122732a027b65f46980447", "url": "https://api.github.com/repos/rust-lang/rust/commits/360b48b1ab97471c0d122732a027b65f46980447", "html_url": "https://github.com/rust-lang/rust/commit/360b48b1ab97471c0d122732a027b65f46980447"}], "stats": {"total": 189, "additions": 189, "deletions": 0}, "files": [{"sha": "1e0ff5db0ee74f7702a1e54bebc83dc04521a706", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -4134,6 +4134,7 @@ Released 2018-09-13\n [`panic_in_result_fn`]: https://rust-lang.github.io/rust-clippy/master/index.html#panic_in_result_fn\n [`panic_params`]: https://rust-lang.github.io/rust-clippy/master/index.html#panic_params\n [`panicking_unwrap`]: https://rust-lang.github.io/rust-clippy/master/index.html#panicking_unwrap\n+[`partial_pub_fields`]: https://rust-lang.github.io/rust-clippy/master/index.html#partial_pub_fields\n [`partialeq_ne_impl`]: https://rust-lang.github.io/rust-clippy/master/index.html#partialeq_ne_impl\n [`partialeq_to_none`]: https://rust-lang.github.io/rust-clippy/master/index.html#partialeq_to_none\n [`path_buf_push_overwrite`]: https://rust-lang.github.io/rust-clippy/master/index.html#path_buf_push_overwrite"}, {"sha": "c188e9057f124249fc1b618a25a2de656b769313", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -479,6 +479,7 @@ store.register_lints(&[\n     panic_unimplemented::TODO,\n     panic_unimplemented::UNIMPLEMENTED,\n     panic_unimplemented::UNREACHABLE,\n+    partial_pub_fields::PARTIAL_PUB_FIELDS,\n     partialeq_ne_impl::PARTIALEQ_NE_IMPL,\n     partialeq_to_none::PARTIALEQ_TO_NONE,\n     pass_by_ref_or_value::LARGE_TYPES_PASSED_BY_VALUE,"}, {"sha": "9edced28408f16a12b666702ad3e74aa25b45e83", "filename": "clippy_lints/src/lib.register_restriction.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_restriction.rs?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -61,6 +61,7 @@ store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), ve\n     LintId::of(panic_unimplemented::TODO),\n     LintId::of(panic_unimplemented::UNIMPLEMENTED),\n     LintId::of(panic_unimplemented::UNREACHABLE),\n+    LintId::of(partial_pub_fields::PARTIAL_PUB_FIELDS),\n     LintId::of(pattern_type_mismatch::PATTERN_TYPE_MISMATCH),\n     LintId::of(pub_use::PUB_USE),\n     LintId::of(redundant_slicing::DEREF_BY_SLICING),"}, {"sha": "b9185b8a51499d850c7ea70a07c34819f9e58ef8", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -324,6 +324,7 @@ mod option_if_let_else;\n mod overflow_check_conditional;\n mod panic_in_result_fn;\n mod panic_unimplemented;\n+mod partial_pub_fields;\n mod partialeq_ne_impl;\n mod partialeq_to_none;\n mod pass_by_ref_or_value;\n@@ -914,6 +915,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|_| Box::new(bool_to_int_with_if::BoolToIntWithIf));\n     store.register_late_pass(|_| Box::new(box_default::BoxDefault));\n     store.register_late_pass(|_| Box::new(implicit_saturating_add::ImplicitSaturatingAdd));\n+    store.register_early_pass(|| Box::new(partial_pub_fields::PartialPubFields));\n     // add lints here, do not remove this comment, it's used in `new_lint`\n }\n "}, {"sha": "f60d9d65b1207a345698bde417aa7094ee1deae3", "filename": "clippy_lints/src/partial_pub_fields.rs", "status": "added", "additions": 81, "deletions": 0, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Fpartial_pub_fields.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/clippy_lints%2Fsrc%2Fpartial_pub_fields.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fpartial_pub_fields.rs?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -0,0 +1,81 @@\n+use clippy_utils::diagnostics::span_lint_and_help;\n+use rustc_ast::ast::{Item, ItemKind};\n+use rustc_lint::{EarlyContext, EarlyLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks whether partial fields of a struct are public.\n+    ///\n+    /// Either make all fields of a type public, or make none of them public\n+    ///\n+    /// ### Why is this bad?\n+    /// Most types should either be:\n+    /// * Abstract data types: complex objects with opaque implementation which guard\n+    /// interior invariants and expose intentionally limited API to the outside world.\n+    /// * Data:\u2009relatively simple objects which group a bunch of related attributes together.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// pub struct Color {\n+    ///     pub r: u8,\n+    ///     pub g: u8,\n+    ///     b: u8,\n+    /// }\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// pub struct Color {\n+    ///     pub r: u8,\n+    ///     pub g: u8,\n+    ///     pub b: u8,\n+    /// }\n+    /// ```\n+    #[clippy::version = \"1.66.0\"]\n+    pub PARTIAL_PUB_FIELDS,\n+    restriction,\n+    \"partial fields of a struct are public\"\n+}\n+declare_lint_pass!(PartialPubFields => [PARTIAL_PUB_FIELDS]);\n+\n+impl EarlyLintPass for PartialPubFields {\n+    fn check_item(&mut self, cx: &EarlyContext<'_>, item: &Item) {\n+        let ItemKind::Struct(ref st, _) = item.kind else {\n+            return;\n+        };\n+\n+        let mut fields = st.fields().iter();\n+        let Some(first_field) = fields.next() else {\n+            // Empty struct.\n+            return;\n+        };\n+        let all_pub = first_field.vis.kind.is_pub();\n+        let all_priv = !all_pub;\n+\n+        let msg = \"mixed usage of pub and non-pub fields\";\n+\n+        for field in fields {\n+            if all_priv && field.vis.kind.is_pub() {\n+                span_lint_and_help(\n+                    cx,\n+                    PARTIAL_PUB_FIELDS,\n+                    field.vis.span,\n+                    msg,\n+                    None,\n+                    \"consider using private field here\",\n+                );\n+                return;\n+            } else if all_pub && !field.vis.kind.is_pub() {\n+                span_lint_and_help(\n+                    cx,\n+                    PARTIAL_PUB_FIELDS,\n+                    field.vis.span,\n+                    msg,\n+                    None,\n+                    \"consider using public field here\",\n+                );\n+                return;\n+            }\n+        }\n+    }\n+}"}, {"sha": "b8b4286b488a4a956951836c3bfa097e17c7bdf3", "filename": "src/docs.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/src%2Fdocs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/src%2Fdocs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdocs.rs?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -395,6 +395,7 @@ docs! {\n     \"panic\",\n     \"panic_in_result_fn\",\n     \"panicking_unwrap\",\n+    \"partial_pub_fields\",\n     \"partialeq_ne_impl\",\n     \"partialeq_to_none\",\n     \"path_buf_push_overwrite\","}, {"sha": "b529adf1547de3fb465c03a63cda7640301c36a8", "filename": "src/docs/partial_pub_fields.txt", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/src%2Fdocs%2Fpartial_pub_fields.txt", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/src%2Fdocs%2Fpartial_pub_fields.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdocs%2Fpartial_pub_fields.txt?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -0,0 +1,27 @@\n+### What it does\n+Checks whether partial fields of a struct are public.\n+\n+Either make all fields of a type public, or make none of them public\n+\n+### Why is this bad?\n+Most types should either be:\n+* Abstract data types: complex objects with opaque implementation which guard\n+interior invariants and expose intentionally limited API to the outside world.\n+* Data:\u2009relatively simple objects which group a bunch of related attributes together.\n+\n+### Example\n+```\n+pub struct Color {\n+    pub r: u8,\n+    pub g: u8,\n+    b: u8,\n+}\n+```\n+Use instead:\n+```\n+pub struct Color {\n+    pub r: u8,\n+    pub g: u8,\n+    pub b: u8,\n+}\n+```\n\\ No newline at end of file"}, {"sha": "668545da8441952687a8a510735f6cdbd43b855f", "filename": "tests/ui/partial_pub_fields.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/tests%2Fui%2Fpartial_pub_fields.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/tests%2Fui%2Fpartial_pub_fields.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fpartial_pub_fields.rs?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -0,0 +1,40 @@\n+#![allow(unused)]\n+#![warn(clippy::partial_pub_fields)]\n+\n+fn main() {\n+    use std::collections::HashMap;\n+\n+    #[derive(Default)]\n+    pub struct FileSet {\n+        files: HashMap<String, u32>,\n+        pub paths: HashMap<u32, String>,\n+    }\n+\n+    pub struct Color {\n+        pub r: u8,\n+        pub g: u8,\n+        b: u8,\n+    }\n+\n+    pub struct Point(i32, pub i32);\n+\n+    pub struct Visibility {\n+        r#pub: bool,\n+        pub pos: u32,\n+    }\n+\n+    // Don't lint on empty structs;\n+    pub struct Empty1;\n+    pub struct Empty2();\n+    pub struct Empty3 {};\n+\n+    // Don't lint on structs with one field.\n+    pub struct Single1(i32);\n+    pub struct Single2(pub i32);\n+    pub struct Single3 {\n+        v1: i32,\n+    }\n+    pub struct Single4 {\n+        pub v1: i32,\n+    }\n+}"}, {"sha": "84cfc1a91940dcc9e69c0ac3945eb793867b5fd7", "filename": "tests/ui/partial_pub_fields.stderr", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/d917590af6d4db6dcb8c4adda8f870a6950ff247/tests%2Fui%2Fpartial_pub_fields.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d917590af6d4db6dcb8c4adda8f870a6950ff247/tests%2Fui%2Fpartial_pub_fields.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fpartial_pub_fields.stderr?ref=d917590af6d4db6dcb8c4adda8f870a6950ff247", "patch": "@@ -0,0 +1,35 @@\n+error: mixed usage of pub and non-pub fields\n+  --> $DIR/partial_pub_fields.rs:10:9\n+   |\n+LL |         pub paths: HashMap<u32, String>,\n+   |         ^^^\n+   |\n+   = help: consider using private field here\n+   = note: `-D clippy::partial-pub-fields` implied by `-D warnings`\n+\n+error: mixed usage of pub and non-pub fields\n+  --> $DIR/partial_pub_fields.rs:16:9\n+   |\n+LL |         b: u8,\n+   |         ^\n+   |\n+   = help: consider using public field here\n+\n+error: mixed usage of pub and non-pub fields\n+  --> $DIR/partial_pub_fields.rs:19:27\n+   |\n+LL |     pub struct Point(i32, pub i32);\n+   |                           ^^^\n+   |\n+   = help: consider using private field here\n+\n+error: mixed usage of pub and non-pub fields\n+  --> $DIR/partial_pub_fields.rs:23:9\n+   |\n+LL |         pub pos: u32,\n+   |         ^^^\n+   |\n+   = help: consider using private field here\n+\n+error: aborting due to 4 previous errors\n+"}]}