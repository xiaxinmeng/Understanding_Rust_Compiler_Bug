{"sha": "b71a09fda07efa16c4bdc0d4849f0b1b5e012dba", "node_id": "C_kwDOAAsO6NoAKGI3MWEwOWZkYTA3ZWZhMTZjNGJkYzBkNDg0OWYwYjFiNWUwMTJkYmE", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-15T03:45:23Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-15T17:32:34Z"}, "message": "Fix ICE in named_arguments_used_positionally lint", "tree": {"sha": "3de83c35104ea58ac9660ff770582012fedfce79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3de83c35104ea58ac9660ff770582012fedfce79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba", "html_url": "https://github.com/rust-lang/rust/commit/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0fe5390a885eb47f506bf481cd9ea2b449705d79", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fe5390a885eb47f506bf481cd9ea2b449705d79", "html_url": "https://github.com/rust-lang/rust/commit/0fe5390a885eb47f506bf481cd9ea2b449705d79"}], "stats": {"total": 34, "additions": 25, "deletions": 9}, "files": [{"sha": "d5eb8d4eeb9a831419adbabce5ad4c7782e0580b", "filename": "compiler/rustc_builtin_macros/src/format.rs", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs?ref=b71a09fda07efa16c4bdc0d4849f0b1b5e012dba", "patch": "@@ -16,7 +16,7 @@ use smallvec::SmallVec;\n \n use rustc_lint_defs::builtin::NAMED_ARGUMENTS_USED_POSITIONALLY;\n use rustc_lint_defs::{BufferedEarlyLint, BuiltinLintDiagnostics, LintId};\n-use rustc_parse_format::{Count, FormatSpec};\n+use rustc_parse_format::Count;\n use std::borrow::Cow;\n use std::collections::hash_map::Entry;\n \n@@ -985,20 +985,19 @@ fn lint_named_arguments_used_positionally(\n                 }\n                 _ => {}\n             };\n-            match a.format {\n-                FormatSpec { width: Count::CountIsName(s, _), .. }\n-                | FormatSpec { precision: Count::CountIsName(s, _), .. } => {\n-                    used_argument_names.insert(s);\n-                }\n-                _ => {}\n-            };\n+            if let Count::CountIsName(s, _) = a.format.width {\n+                used_argument_names.insert(s);\n+            }\n+            if let Count::CountIsName(s, _) = a.format.precision {\n+                used_argument_names.insert(s);\n+            }\n         }\n     }\n \n     for (symbol, (index, span)) in names {\n         if !used_argument_names.contains(symbol.as_str()) {\n             let msg = format!(\"named argument `{}` is not used by name\", symbol.as_str());\n-            let arg_span = cx.arg_spans[index];\n+            let arg_span = cx.arg_spans.get(index).copied().unwrap_or(span);\n             cx.ecx.buffered_early_lint.push(BufferedEarlyLint {\n                 span: MultiSpan::from_span(span),\n                 msg: msg.clone(),"}, {"sha": "40d26d08cba116db64c5f7557fcea6a319e66209", "filename": "src/test/ui/macros/issue-99261.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba/src%2Ftest%2Fui%2Fmacros%2Fissue-99261.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b71a09fda07efa16c4bdc0d4849f0b1b5e012dba/src%2Ftest%2Fui%2Fmacros%2Fissue-99261.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-99261.rs?ref=b71a09fda07efa16c4bdc0d4849f0b1b5e012dba", "patch": "@@ -0,0 +1,17 @@\n+// check-pass\n+\n+#![deny(named_arguments_used_positionally)]\n+\n+fn main() {\n+    let value: f64 = 314.15926;\n+    let digits_before_decimal = 1;\n+    let digits_after_decimal = 2;\n+    let width = digits_before_decimal + 1 + digits_after_decimal;\n+\n+    println!(\n+        \"{value:0>width$.digits_after_decimal$}\",\n+        value = value,\n+        width = width,\n+        digits_after_decimal = digits_after_decimal,\n+    );\n+}"}]}