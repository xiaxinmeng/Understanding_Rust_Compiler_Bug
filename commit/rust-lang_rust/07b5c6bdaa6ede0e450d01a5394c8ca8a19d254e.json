{"sha": "07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e", "node_id": "C_kwDOAAsO6NoAKDA3YjVjNmJkYWE2ZWRlMGU0NTBkMDFhNTM5NGM4Y2E4YTE5ZDI1NGU", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-10-29T12:18:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-29T12:18:02Z"}, "message": "Rollup merge of #103415 - compiler-errors:tiny-perf-increase-on-diagnostic, r=TaKO8Ki\n\nfilter candidates in pick probe for diagnostics\n\nFixes #103411, though also fine with closing this PR if my opinion (https://github.com/rust-lang/rust/issues/103411#issuecomment-1287900069) is shared that this doesn't need to  be fixed.\n\n```\n~/rust3$ time rustc +nightly ~/test.rs 2>/dev/null\n\nreal    0m4.853s\nuser    0m4.837s\nsys     0m0.016s\n\n~/rust3$ time rustc +rust3 ~/test.rs 2>/dev/null\n\nreal    0m0.193s\nuser    0m0.169s\nsys     0m0.024s\n```\n\nAlso fixes #103427.", "tree": {"sha": "c343ec8f7e0ad2aff53a901e4316a92ecf2c3561", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c343ec8f7e0ad2aff53a901e4316a92ecf2c3561"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjXRn6CRBK7hj4Ov3rIwAAglgIAHoHkR8sHxvCLpBXuuVQ3eEu\nqNnk+U+Y54rKy6UJDRnFsGXA5mQisohMOAYbvbs74x02sq5iKAdRVIAUivLmhINS\nasAIbS0NxuHPV5OFli7iPcPWFVGdvFXwldIFWSTRLf9SvIqY1ofPPNDg9wA8FfK/\nOv2Wng96i14+vHXC23krbw22GDjakniahjxgy92f6pUSL80EnmuUZahfetXf1636\nOsZldVNgTE/VcN8Cxi38Yr0SDDZ2OY2aR0FgKxSzg9NM5IPgIuAJHwOTEdOqn5bK\ntqJ1tg2L2JiNPh8Xk8r2TNbs0LS3tZHW8BOxKYZapM91Jh3zNgCEkJdlgG/96oE=\n=a3/e\n-----END PGP SIGNATURE-----\n", "payload": "tree c343ec8f7e0ad2aff53a901e4316a92ecf2c3561\nparent 6dd64d38a3621d9702cbffeaf491ce17903d16b5\nparent 4216caed31b56d1980812960b740af5d93de36b9\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1667045882 +0200\ncommitter GitHub <noreply@github.com> 1667045882 +0200\n\nRollup merge of #103415 - compiler-errors:tiny-perf-increase-on-diagnostic, r=TaKO8Ki\n\nfilter candidates in pick probe for diagnostics\n\nFixes #103411, though also fine with closing this PR if my opinion (https://github.com/rust-lang/rust/issues/103411#issuecomment-1287900069) is shared that this doesn't need to  be fixed.\n\n```\n~/rust3$ time rustc +nightly ~/test.rs 2>/dev/null\n\nreal    0m4.853s\nuser    0m4.837s\nsys     0m0.016s\n\n~/rust3$ time rustc +rust3 ~/test.rs 2>/dev/null\n\nreal    0m0.193s\nuser    0m0.169s\nsys     0m0.024s\n```\n\nAlso fixes #103427.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e", "html_url": "https://github.com/rust-lang/rust/commit/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6dd64d38a3621d9702cbffeaf491ce17903d16b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/6dd64d38a3621d9702cbffeaf491ce17903d16b5", "html_url": "https://github.com/rust-lang/rust/commit/6dd64d38a3621d9702cbffeaf491ce17903d16b5"}, {"sha": "4216caed31b56d1980812960b740af5d93de36b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/4216caed31b56d1980812960b740af5d93de36b9", "html_url": "https://github.com/rust-lang/rust/commit/4216caed31b56d1980812960b740af5d93de36b9"}], "stats": {"total": 54, "additions": 32, "deletions": 22}, "files": [{"sha": "16febfc46da902ae3333a2bce5ab8add720ac206", "filename": "compiler/rustc_hir_typeck/src/demand.rs", "status": "modified", "additions": 23, "deletions": 18, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e/compiler%2Frustc_hir_typeck%2Fsrc%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e/compiler%2Frustc_hir_typeck%2Fsrc%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fdemand.rs?ref=07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e", "patch": "@@ -530,24 +530,29 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         checked_ty: Ty<'tcx>,\n         hir_id: hir::HirId,\n     ) -> Vec<AssocItem> {\n-        let mut methods =\n-            self.probe_for_return_type(span, probe::Mode::MethodCall, expected, checked_ty, hir_id);\n-        methods.retain(|m| {\n-            self.has_only_self_parameter(m)\n-                && self\n-                    .tcx\n-                    // This special internal attribute is used to permit\n-                    // \"identity-like\" conversion methods to be suggested here.\n-                    //\n-                    // FIXME (#46459 and #46460): ideally\n-                    // `std::convert::Into::into` and `std::borrow:ToOwned` would\n-                    // also be `#[rustc_conversion_suggestion]`, if not for\n-                    // method-probing false-positives and -negatives (respectively).\n-                    //\n-                    // FIXME? Other potential candidate methods: `as_ref` and\n-                    // `as_mut`?\n-                    .has_attr(m.def_id, sym::rustc_conversion_suggestion)\n-        });\n+        let methods = self.probe_for_return_type(\n+            span,\n+            probe::Mode::MethodCall,\n+            expected,\n+            checked_ty,\n+            hir_id,\n+            |m| {\n+                self.has_only_self_parameter(m)\n+                    && self\n+                        .tcx\n+                        // This special internal attribute is used to permit\n+                        // \"identity-like\" conversion methods to be suggested here.\n+                        //\n+                        // FIXME (#46459 and #46460): ideally\n+                        // `std::convert::Into::into` and `std::borrow:ToOwned` would\n+                        // also be `#[rustc_conversion_suggestion]`, if not for\n+                        // method-probing false-positives and -negatives (respectively).\n+                        //\n+                        // FIXME? Other potential candidate methods: `as_ref` and\n+                        // `as_mut`?\n+                        .has_attr(m.def_id, sym::rustc_conversion_suggestion)\n+            },\n+        );\n \n         methods\n     }"}, {"sha": "28aa2302f882f92a03e4aaea45318f32c2046942", "filename": "compiler/rustc_hir_typeck/src/method/probe.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e/compiler%2Frustc_hir_typeck%2Fsrc%2Fmethod%2Fprobe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e/compiler%2Frustc_hir_typeck%2Fsrc%2Fmethod%2Fprobe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fmethod%2Fprobe.rs?ref=07b5c6bdaa6ede0e450d01a5394c8ca8a19d254e", "patch": "@@ -252,14 +252,15 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     /// would result in an error (basically, the same criteria we\n     /// would use to decide if a method is a plausible fit for\n     /// ambiguity purposes).\n-    #[instrument(level = \"debug\", skip(self))]\n+    #[instrument(level = \"debug\", skip(self, candidate_filter))]\n     pub fn probe_for_return_type(\n         &self,\n         span: Span,\n         mode: Mode,\n         return_type: Ty<'tcx>,\n         self_ty: Ty<'tcx>,\n         scope_expr_id: hir::HirId,\n+        candidate_filter: impl Fn(&ty::AssocItem) -> bool,\n     ) -> Vec<ty::AssocItem> {\n         let method_names = self\n             .probe_op(\n@@ -271,7 +272,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 self_ty,\n                 scope_expr_id,\n                 ProbeScope::AllTraits,\n-                |probe_cx| Ok(probe_cx.candidate_method_names()),\n+                |probe_cx| Ok(probe_cx.candidate_method_names(candidate_filter)),\n             )\n             .unwrap_or_default();\n         method_names\n@@ -966,12 +967,16 @@ impl<'a, 'tcx> ProbeContext<'a, 'tcx> {\n         }\n     }\n \n-    fn candidate_method_names(&self) -> Vec<Ident> {\n+    fn candidate_method_names(\n+        &self,\n+        candidate_filter: impl Fn(&ty::AssocItem) -> bool,\n+    ) -> Vec<Ident> {\n         let mut set = FxHashSet::default();\n         let mut names: Vec<_> = self\n             .inherent_candidates\n             .iter()\n             .chain(&self.extension_candidates)\n+            .filter(|candidate| candidate_filter(&candidate.item))\n             .filter(|candidate| {\n                 if let Some(return_ty) = self.return_type {\n                     self.matches_return_type(&candidate.item, None, return_ty)\n@@ -1689,7 +1694,7 @@ impl<'a, 'tcx> ProbeContext<'a, 'tcx> {\n             pcx.allow_similar_names = true;\n             pcx.assemble_inherent_candidates();\n \n-            let method_names = pcx.candidate_method_names();\n+            let method_names = pcx.candidate_method_names(|_| true);\n             pcx.allow_similar_names = false;\n             let applicable_close_candidates: Vec<ty::AssocItem> = method_names\n                 .iter()"}]}