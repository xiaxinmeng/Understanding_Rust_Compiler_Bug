{"sha": "529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyOWI5NGVhNmEzZjA2MDZkMzhlNGJiMzJlYzVlYjY5MmMzYzBkNzE=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-06-05T01:51:30Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-06-06T12:31:28Z"}, "message": "[const-prop] Fix ICE when casting function pointers\n\nThis fixes an ICE when building libcore with `-Z mir-opt-level=3`.", "tree": {"sha": "004dc3f436ef8623af4f893ef280fb09338134a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/004dc3f436ef8623af4f893ef280fb09338134a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "html_url": "https://github.com/rust-lang/rust/commit/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "daf1ed0e98e75c64c3b883fd845b37bfa42358de", "url": "https://api.github.com/repos/rust-lang/rust/commits/daf1ed0e98e75c64c3b883fd845b37bfa42358de", "html_url": "https://github.com/rust-lang/rust/commit/daf1ed0e98e75c64c3b883fd845b37bfa42358de"}], "stats": {"total": 35, "additions": 29, "deletions": 6}, "files": [{"sha": "1d4d01e60aad09a1748e1310be7c8feec73411c8", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "patch": "@@ -525,12 +525,10 @@ impl<'a, 'mir, 'tcx> ConstPropagator<'a, 'mir, 'tcx> {\n         source_info: SourceInfo,\n     ) {\n         trace!(\"attepting to replace {:?} with {:?}\", rval, value);\n-        self.ecx.validate_operand(\n-            value,\n-            vec![],\n-            None,\n-            true,\n-        ).expect(\"value should already be a valid const\");\n+        if let Err(e) = self.ecx.validate_operand(value, vec![], None, true) {\n+            trace!(\"validation error, attempt failed: {:?}\", e);\n+            return;\n+        }\n \n         // FIXME> figure out what tho do when try_read_immediate fails\n         let imm = self.use_ecx(source_info, |this| {"}, {"sha": "809eb19ade899194aedce53275369e2a770715ec", "filename": "src/test/mir-opt/const_prop/reify_fn_ptr.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71/src%2Ftest%2Fmir-opt%2Fconst_prop%2Freify_fn_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71/src%2Ftest%2Fmir-opt%2Fconst_prop%2Freify_fn_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Freify_fn_ptr.rs?ref=529b94ea6a3f0606d38e4bb32ec5eb692c3c0d71", "patch": "@@ -0,0 +1,25 @@\n+fn main() {\n+    let _ = main as usize as *const fn();\n+}\n+\n+// END RUST SOURCE\n+// START rustc.main.ConstProp.before.mir\n+//  bb0: {\n+//      ...\n+//      _3 = const main as fn() (Pointer(ReifyFnPointer));\n+//      _2 = move _3 as usize (Misc);\n+//      ...\n+//      _1 = move _2 as *const fn() (Misc);\n+//      ...\n+//  }\n+// END rustc.main.ConstProp.before.mir\n+// START rustc.main.ConstProp.after.mir\n+//  bb0: {\n+//      ...\n+//      _3 = const Scalar(AllocId(1).0x0) : fn();\n+//      _2 = move _3 as usize (Misc);\n+//      ...\n+//      _1 = const Scalar(AllocId(1).0x0) : *const fn();\n+//      ...\n+//  }\n+// END rustc.main.ConstProp.after.mir"}]}