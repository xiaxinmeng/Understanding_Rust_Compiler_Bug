{"sha": "2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlMDZkOWM5MWI5ZjBiY2NkZTRhMGU0NDVjZTIwMTRjM2ZlODU1MDY=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2019-01-18T08:12:09Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2019-01-18T08:12:09Z"}, "message": "Point at return type when appropriate", "tree": {"sha": "fceeeec96c8ea4d1f0319423a65f1921696133df", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fceeeec96c8ea4d1f0319423a65f1921696133df"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "html_url": "https://github.com/rust-lang/rust/commit/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "954769e2ed16a90bfda2b69395fc099b93581352", "url": "https://api.github.com/repos/rust-lang/rust/commits/954769e2ed16a90bfda2b69395fc099b93581352", "html_url": "https://github.com/rust-lang/rust/commit/954769e2ed16a90bfda2b69395fc099b93581352"}], "stats": {"total": 35, "additions": 30, "deletions": 5}, "files": [{"sha": "dd63b4f20fa55a4f92cfa832d205b52a56072eb1", "filename": "src/librustc_typeck/check/coercion.rs", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -1250,14 +1250,26 @@ impl<'gcx, 'tcx, 'exprs, E> CoerceMany<'gcx, 'tcx, 'exprs, E>\n                             }\n                         }\n                     }\n-                    _ => {\n+                    ObligationCauseCode::ReturnType(_id) => {\n                         db = fcx.report_mismatched_types(cause, expected, found, err);\n-                        if let Some(sp) = fcx.ret_coercion_span.borrow().as_ref() {\n+                        let _id = fcx.tcx.hir().get_parent_node(_id);\n+                        let mut pointing_at_return_type = false;\n+                        if let Some((fn_decl, can_suggest)) = fcx.get_fn_decl(_id) {\n+                            pointing_at_return_type = fcx.suggest_missing_return_type(\n+                                &mut db, &fn_decl, expected, found, can_suggest);\n+                        }\n+                        if let (Some(sp), false) = (\n+                            fcx.ret_coercion_span.borrow().as_ref(),\n+                            pointing_at_return_type,\n+                        ) {\n                             if !sp.overlaps(cause.span) {\n                                 db.span_label(*sp, reason_label);\n                             }\n                         }\n                     }\n+                    _ => {\n+                        db = fcx.report_mismatched_types(cause, expected, found, err);\n+                    }\n                 }\n \n                 if let Some(augment_error) = augment_error {"}, {"sha": "47bb5e475b473e5ee4ff2886e04fcb6dbc39bb74", "filename": "src/test/ui/fully-qualified-type/fully-qualified-type-name2.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Ffully-qualified-type%2Ffully-qualified-type-name2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Ffully-qualified-type%2Ffully-qualified-type-name2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffully-qualified-type%2Ffully-qualified-type-name2.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -1,6 +1,8 @@\n error[E0308]: mismatched types\n   --> $DIR/fully-qualified-type-name2.rs:12:12\n    |\n+LL | fn bar(x: x::Foo) -> y::Foo {\n+   |                      ------ expected `y::Foo` because of return type\n LL |     return x;\n    |            ^ expected enum `y::Foo`, found enum `x::Foo`\n    |"}, {"sha": "b341879ab919afaf78070b8058ad81f129da47a8", "filename": "src/test/ui/fully-qualified-type/fully-qualified-type-name4.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Ffully-qualified-type%2Ffully-qualified-type-name4.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Ffully-qualified-type%2Ffully-qualified-type-name4.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffully-qualified-type%2Ffully-qualified-type-name4.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -1,6 +1,8 @@\n error[E0308]: mismatched types\n   --> $DIR/fully-qualified-type-name4.rs:6:12\n    |\n+LL | fn bar(x: usize) -> Option<usize> {\n+   |                     ------------- expected `std::option::Option<usize>` because of return type\n LL |     return x;\n    |            ^ expected enum `std::option::Option`, found usize\n    |"}, {"sha": "a970b80fdbbd93e9da12b018c0207f75487675a5", "filename": "src/test/ui/liveness/liveness-forgot-ret.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Fliveness%2Fliveness-forgot-ret.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Fliveness%2Fliveness-forgot-ret.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fliveness%2Fliveness-forgot-ret.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -2,7 +2,7 @@ error[E0308]: mismatched types\n   --> $DIR/liveness-forgot-ret.rs:3:19\n    |\n LL | fn f(a: isize) -> isize { if god_exists(a) { return 5; }; }\n-   |    -              ^^^^^ expected isize, found ()    - expected because of this statement\n+   |    -              ^^^^^ expected isize, found ()\n    |    |\n    |    this function's body doesn't return\n    |"}, {"sha": "db524907b656f4760625c69c1cd1583bf8b52757", "filename": "src/test/ui/proc-macro/span-preservation.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Fproc-macro%2Fspan-preservation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Fproc-macro%2Fspan-preservation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fspan-preservation.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -15,6 +15,9 @@ LL |     let x: usize = \"hello\";;;;; //~ ERROR mismatched types\n error[E0308]: mismatched types\n   --> $DIR/span-preservation.rs:19:29\n    |\n+LL | fn b(x: Option<isize>) -> usize {\n+   |                           ----- expected `usize` because of return type\n+LL |     match x {\n LL |         Some(x) => { return x }, //~ ERROR mismatched types\n    |                             ^ expected usize, found isize\n "}, {"sha": "2862ae641df15b3341c6700cfd3f786e08a6a687", "filename": "src/test/ui/return/return-from-diverging.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Freturn%2Freturn-from-diverging.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Freturn%2Freturn-from-diverging.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Freturn%2Freturn-from-diverging.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -1,6 +1,8 @@\n error[E0308]: mismatched types\n   --> $DIR/return-from-diverging.rs:4:12\n    |\n+LL | fn fail() -> ! {\n+   |              - expected `!` because of return type\n LL |     return \"wow\"; //~ ERROR mismatched types\n    |            ^^^^^ expected !, found reference\n    |"}, {"sha": "1170f5c17c18ab648658a716562dec311259ef48", "filename": "src/test/ui/tail-typeck.stderr", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Ftail-typeck.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Ftail-typeck.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftail-typeck.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -2,7 +2,9 @@ error[E0308]: mismatched types\n   --> $DIR/tail-typeck.rs:3:26\n    |\n LL | fn f() -> isize { return g(); }\n-   |                          ^^^ expected isize, found usize\n+   |           -----          ^^^ expected isize, found usize\n+   |           |\n+   |           expected `isize` because of return type\n \n error: aborting due to previous error\n "}, {"sha": "cf59f42683d721647c54a17bfcf7165d6730b5f0", "filename": "src/test/ui/wrong-ret-type.stderr", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Fwrong-ret-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e06d9c91b9f0bccde4a0e445ce2014c3fe85506/src%2Ftest%2Fui%2Fwrong-ret-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwrong-ret-type.stderr?ref=2e06d9c91b9f0bccde4a0e445ce2014c3fe85506", "patch": "@@ -2,7 +2,9 @@ error[E0308]: mismatched types\n   --> $DIR/wrong-ret-type.rs:2:49\n    |\n LL | fn mk_int() -> usize { let i: isize = 3; return i; }\n-   |                                                 ^ expected usize, found isize\n+   |                -----                            ^ expected usize, found isize\n+   |                |\n+   |                expected `usize` because of return type\n \n error: aborting due to previous error\n "}]}