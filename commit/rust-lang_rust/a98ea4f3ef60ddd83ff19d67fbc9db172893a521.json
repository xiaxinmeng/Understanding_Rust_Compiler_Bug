{"sha": "a98ea4f3ef60ddd83ff19d67fbc9db172893a521", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5OGVhNGYzZWY2MGRkZDgzZmYxOWQ2N2ZiYzlkYjE3Mjg5M2E1MjE=", "commit": {"author": {"name": "Brian Anderson", "email": "andersrb@gmail.com", "date": "2011-05-18T00:35:37Z"}, "committer": {"name": "Brian Anderson", "email": "andersrb@gmail.com", "date": "2011-05-18T02:25:24Z"}, "message": "rustc: Run block cleanups on else if blocks\n\nWith the scheme used to translate 'else if' currently the if expression is\ntranslated in a new (else) scope context. If that if expression wants to\nresult in a value that requires refcounting then it will need to drop the\nrefcount in the cleanups of the else block.", "tree": {"sha": "68392780c55c2763ad7e22c4e0a83c0f44ecb51b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/68392780c55c2763ad7e22c4e0a83c0f44ecb51b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a98ea4f3ef60ddd83ff19d67fbc9db172893a521", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a98ea4f3ef60ddd83ff19d67fbc9db172893a521", "html_url": "https://github.com/rust-lang/rust/commit/a98ea4f3ef60ddd83ff19d67fbc9db172893a521", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a98ea4f3ef60ddd83ff19d67fbc9db172893a521/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e840a37f33869ddee5785473617a2b5f834dca9f", "url": "https://api.github.com/repos/rust-lang/rust/commits/e840a37f33869ddee5785473617a2b5f834dca9f", "html_url": "https://github.com/rust-lang/rust/commit/e840a37f33869ddee5785473617a2b5f834dca9f"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "96e92aeb85214a9d0c94c1462996c1bfd9253133", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a98ea4f3ef60ddd83ff19d67fbc9db172893a521/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a98ea4f3ef60ddd83ff19d67fbc9db172893a521/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=a98ea4f3ef60ddd83ff19d67fbc9db172893a521", "patch": "@@ -3706,8 +3706,15 @@ fn trans_if(&@block_ctxt cx, &@ast::expr cond,\n     alt (els) {\n         case (some[@ast::expr](?elexpr)) {\n             alt (elexpr.node) {\n-                case (ast::expr_if(_, _, _, _)) {\n-                    else_res = trans_expr(else_cx, elexpr);\n+                case (ast::expr_if(?cond, ?thn, ?els, _)) {\n+                    else_res = trans_if(else_cx, cond, thn, els);\n+                    // The if expression may need to use the else context to\n+                    // drop the refcount of its result so we need to run the\n+                    // cleanups\n+                    auto bcx = else_res.bcx;\n+                    bcx = trans_block_cleanups(bcx,\n+                                               find_scope_cx(bcx));\n+                    else_res = res(bcx, else_res.val);\n                 }\n                 case (ast::expr_block(?blk, _)) {\n                     // Calling trans_block directly instead of trans_expr"}, {"sha": "03ba523b709ff9db5101e22ee8e5dc4f3e9026bb", "filename": "src/test/run-pass/expr-elseif-ref.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/a98ea4f3ef60ddd83ff19d67fbc9db172893a521/src%2Ftest%2Frun-pass%2Fexpr-elseif-ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a98ea4f3ef60ddd83ff19d67fbc9db172893a521/src%2Ftest%2Frun-pass%2Fexpr-elseif-ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fexpr-elseif-ref.rs?ref=a98ea4f3ef60ddd83ff19d67fbc9db172893a521", "patch": "@@ -0,0 +1,17 @@\n+// xfail-stage0\n+\n+// Make sure we drop the refs of the temporaries needed to return the\n+// values from the else if branch\n+\n+fn main() {\n+  let vec[uint] y = [10u];\n+  auto x = if (false) {\n+    y\n+  } else if (true) {\n+    y\n+  } else {\n+    y\n+  };\n+\n+  assert y.(0) == 10u;\n+}"}]}