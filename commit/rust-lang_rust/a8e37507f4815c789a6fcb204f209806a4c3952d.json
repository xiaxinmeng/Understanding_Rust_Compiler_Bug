{"sha": "a8e37507f4815c789a6fcb204f209806a4c3952d", "node_id": "C_kwDOAAsO6NoAKGE4ZTM3NTA3ZjQ4MTVjNzg5YTZmY2IyMDRmMjA5ODA2YTRjMzk1MmQ", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-10-17T10:36:54Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2023-02-22T09:15:54Z"}, "message": "errors: fix translation's run-make test\n\n`run-make/translation` had some targets that weren't listed in `all` and\nthus weren't being tested - the behaviour that should have been being\ntested was basically correct fortunately.\n\nSigned-off-by: David Wood <david.wood@huawei.com>", "tree": {"sha": "87bc7cfd10418057ed067cfb80f6ba837fc0f353", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/87bc7cfd10418057ed067cfb80f6ba837fc0f353"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a8e37507f4815c789a6fcb204f209806a4c3952d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a8e37507f4815c789a6fcb204f209806a4c3952d", "html_url": "https://github.com/rust-lang/rust/commit/a8e37507f4815c789a6fcb204f209806a4c3952d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a8e37507f4815c789a6fcb204f209806a4c3952d/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d1fcf611175e695c35c6cc0537d710277c1a5c6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1fcf611175e695c35c6cc0537d710277c1a5c6f", "html_url": "https://github.com/rust-lang/rust/commit/d1fcf611175e695c35c6cc0537d710277c1a5c6f"}], "stats": {"total": 31, "additions": 22, "deletions": 9}, "files": [{"sha": "1ac9b8e03c7c30b03bfc920be30e02f379935ea5", "filename": "compiler/rustc_errors/src/translation.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a8e37507f4815c789a6fcb204f209806a4c3952d/compiler%2Frustc_errors%2Fsrc%2Ftranslation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8e37507f4815c789a6fcb204f209806a4c3952d/compiler%2Frustc_errors%2Fsrc%2Ftranslation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Ftranslation.rs?ref=a8e37507f4815c789a6fcb204f209806a4c3952d", "patch": "@@ -4,6 +4,7 @@ use crate::{DiagnosticArg, DiagnosticMessage, FluentBundle};\n use rustc_data_structures::sync::Lrc;\n use rustc_error_messages::FluentArgs;\n use std::borrow::Cow;\n+use std::env;\n use std::error::Report;\n \n /// Convert diagnostic arguments (a rustc internal type that exists to implement\n@@ -94,8 +95,16 @@ pub trait Translate {\n                 // The primary bundle was present and translation succeeded\n                 Some(Ok(t)) => t,\n \n-                // Always yeet out for errors on debug\n-                Some(Err(primary)) if cfg!(debug_assertions) => do yeet primary,\n+                // Always yeet out for errors on debug (unless\n+                // `RUSTC_TRANSLATION_NO_DEBUG_ASSERT` is set in the environment - this allows\n+                // local runs of the test suites, of builds with debug assertions, to test the\n+                // behaviour in a normal build).\n+                Some(Err(primary))\n+                    if cfg!(debug_assertions)\n+                        && env::var(\"RUSTC_TRANSLATION_NO_DEBUG_ASSERT\").is_err() =>\n+                {\n+                    do yeet primary\n+                }\n \n                 // If `translate_with_bundle` returns `Err` with the primary bundle, this is likely\n                 // just that the primary bundle doesn't contain the message being translated or"}, {"sha": "5b0b331ca468cd8c7eba2a33c92a63d384bade41", "filename": "tests/run-make/translation/Makefile", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a8e37507f4815c789a6fcb204f209806a4c3952d/tests%2Frun-make%2Ftranslation%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/a8e37507f4815c789a6fcb204f209806a4c3952d/tests%2Frun-make%2Ftranslation%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Ftranslation%2FMakefile?ref=a8e37507f4815c789a6fcb204f209806a4c3952d", "patch": "@@ -6,8 +6,10 @@ include ../../run-make-fulldeps/tools.mk\n \n SYSROOT:=$(shell $(RUSTC) --print sysroot)\n FAKEROOT=$(TMPDIR)/fakeroot\n+RUSTC_LOG:=rustc_error_messages\n+export RUSTC_TRANSLATION_NO_DEBUG_ASSERT:=1\n \n-all: normal custom sysroot\n+all: normal custom missing broken sysroot sysroot-invalid sysroot-missing\n \n # Check that the test works normally, using the built-in fallback bundle.\n normal: test.rs\n@@ -32,6 +34,7 @@ broken: test.rs broken.ftl\n # identifier by making a local copy of the sysroot and adding the custom locale\n # to it.\n sysroot: test.rs working.ftl\n+\trm -rf $(FAKEROOT)\n \tmkdir $(FAKEROOT)\n \tln -s $(SYSROOT)/* $(FAKEROOT)\n \trm -f $(FAKEROOT)/lib\n@@ -51,12 +54,12 @@ sysroot: test.rs working.ftl\n # found. This test might start failing if there actually exists a Klingon\n # translation of rustc's error messages.\n sysroot-missing: \n-\t$(RUSTC) $< -Ztranslate-lang=tlh 2>&1 || grep \"missing locale directory\"\n+\t$(RUSTC) $< -Ztranslate-lang=tlh 2>&1 | grep \"missing locale directory\"\n \n-# Check that the compiler errors out when the sysroot requested cannot be\n-# found. This test might start failing if there actually exists a Klingon\n-# translation of rustc's error messages.\n+# Check that the compiler errors out when the directory for the locale in the\n+# sysroot is actually a file.\n sysroot-invalid: test.rs working.ftl\n+\trm -rf $(FAKEROOT)\n \tmkdir $(FAKEROOT)\n \tln -s $(SYSROOT)/* $(FAKEROOT)\n \trm -f $(FAKEROOT)/lib\n@@ -68,5 +71,6 @@ sysroot-invalid: test.rs working.ftl\n \trm -f $(FAKEROOT)/lib/rustlib/src\n \tmkdir $(FAKEROOT)/lib/rustlib/src\n \tln -s $(SYSROOT)/lib/rustlib/src/* $(FAKEROOT)/lib/rustlib/src\n-\ttouch $(FAKEROOT)/share/locale/zh-CN/\n-\t$(RUSTC) $< --sysroot $(FAKEROOT) -Ztranslate-lang=zh-CN 2>&1 || grep \"`\\$sysroot/share/locales/\\$locale` is not a directory\"\n+\tmkdir -p $(FAKEROOT)/share/locale\n+\ttouch $(FAKEROOT)/share/locale/zh-CN\n+\t$(RUSTC) $< --sysroot $(FAKEROOT) -Ztranslate-lang=zh-CN 2>&1 | grep \"`\\$sysroot/share/locales/\\$locale` is not a directory\""}]}