{"sha": "399dd8049d4b27329350937e3e17077205bdc0bf", "node_id": "C_kwDOAAsO6NoAKDM5OWRkODA0OWQ0YjI3MzI5MzUwOTM3ZTNlMTcwNzcyMDViZGMwYmY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-09T07:53:34Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-09T07:53:34Z"}, "message": "Auto merge of #95724 - Kobzol:ci-update-rustc-perf, r=nnethercote\n\nCI: update `rustc-perf` version used in CI and also the corresponding PGO benchmarks\n\nThe old version was from May 2021. The `rustc-perf` benchmarks have seen a significant overhaul recently, so let's see if the new benchmarks can improve PGO performance.", "tree": {"sha": "99ea83b59ab4531a5123cc4f0df163359fd7dd7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/99ea83b59ab4531a5123cc4f0df163359fd7dd7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/399dd8049d4b27329350937e3e17077205bdc0bf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/399dd8049d4b27329350937e3e17077205bdc0bf", "html_url": "https://github.com/rust-lang/rust/commit/399dd8049d4b27329350937e3e17077205bdc0bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/399dd8049d4b27329350937e3e17077205bdc0bf/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4bb685e4714a2b310774f45c3d023d1743de8bd0", "url": "https://api.github.com/repos/rust-lang/rust/commits/4bb685e4714a2b310774f45c3d023d1743de8bd0", "html_url": "https://github.com/rust-lang/rust/commit/4bb685e4714a2b310774f45c3d023d1743de8bd0"}, {"sha": "49efa23d70c12c9a670b262a1fb717a12cea7489", "url": "https://api.github.com/repos/rust-lang/rust/commits/49efa23d70c12c9a670b262a1fb717a12cea7489", "html_url": "https://github.com/rust-lang/rust/commit/49efa23d70c12c9a670b262a1fb717a12cea7489"}], "stats": {"total": 22, "additions": 14, "deletions": 8}, "files": [{"sha": "5e6716baed6d9e9dbe5ac89da3468b469cab9370", "filename": "src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/399dd8049d4b27329350937e3e17077205bdc0bf/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/399dd8049d4b27329350937e3e17077205bdc0bf/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-linux%2FDockerfile?ref=399dd8049d4b27329350937e3e17077205bdc0bf", "patch": "@@ -98,7 +98,8 @@ COPY host-x86_64/dist-x86_64-linux/build-clang.sh /tmp/\n RUN ./build-clang.sh\n ENV CC=clang CXX=clang++\n \n-ENV PERF_COMMIT 1e19fc4c6168d2f7596e512f42f358f245d8f09d\n+# rustc-perf version from 2022-04-05\n+ENV PERF_COMMIT 04fccd80396f954b339c366e30221f4bd52c5e03\n RUN curl -LS -o perf.zip https://github.com/rust-lang/rustc-perf/archive/$PERF_COMMIT.zip && \\\n     unzip perf.zip && \\\n     mv rustc-perf-$PERF_COMMIT rustc-perf && \\"}, {"sha": "689e6a11d61106262911bec46e48295a30232299", "filename": "src/ci/pgo.sh", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/399dd8049d4b27329350937e3e17077205bdc0bf/src%2Fci%2Fpgo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/399dd8049d4b27329350937e3e17077205bdc0bf/src%2Fci%2Fpgo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fpgo.sh?ref=399dd8049d4b27329350937e3e17077205bdc0bf", "patch": "@@ -3,8 +3,8 @@\n set -euxo pipefail\n \n # Compile several crates to gather execution PGO profiles.\n-# Arg0 => builds (Debug, Opt)\n-# Arg1 => runs (Full, IncrFull, All)\n+# Arg0 => profiles (Debug, Opt)\n+# Arg1 => scenarios (Full, IncrFull, All)\n # Arg2 => crates (syn, cargo, ...)\n gather_profiles () {\n   cd /checkout/obj\n@@ -27,10 +27,10 @@ gather_profiles () {\n           profile_local \\\n           eprintln \\\n           /checkout/obj/build/$PGO_HOST/stage2/bin/rustc \\\n-          Test \\\n-          --builds $1 \\\n+          --id Test \\\n+          --profiles $1 \\\n           --cargo /checkout/obj/build/$PGO_HOST/stage0/bin/cargo \\\n-          --runs $2 \\\n+          --scenarios $2 \\\n           --include $3\n \n   cd /checkout/obj\n@@ -64,7 +64,10 @@ RUSTC=/checkout/obj/build/$PGO_HOST/stage0/bin/rustc \\\n RUSTC_BOOTSTRAP=1 \\\n /checkout/obj/build/$PGO_HOST/stage0/bin/cargo build -p collector\n \n-gather_profiles \"Debug,Opt\" \"Full\" \"syn,cargo,serde,ripgrep,regex,clap-rs,hyper-2\"\n+# Here we're profiling LLVM, so we only care about `Debug` and `Opt`, because we want to stress\n+# codegen. We also profile some of the most prolific crates.\n+gather_profiles \"Debug,Opt\" \"Full\" \\\n+\"syn-1.0.89,cargo-0.60.0,serde-1.0.136,ripgrep-13.0.0,regex-1.5.5,clap-3.1.6,hyper-0.14.18\"\n \n # Merge the profile data we gathered for LLVM\n # Note that this uses the profdata from the clang we used to build LLVM,\n@@ -83,8 +86,10 @@ python3 ../x.py build --target=$PGO_HOST --host=$PGO_HOST \\\n     --stage 2 library/std \\\n     --rust-profile-generate=/tmp/rustc-pgo\n \n+# Here we're profiling the `rustc` frontend, so we also include `Check`.\n+# The benchmark set includes various stress tests that put the frontend under pressure.\n gather_profiles \"Check,Debug,Opt\" \"All\" \\\n-  \"externs,ctfe-stress-4,inflate,cargo,token-stream-stress,match-stress-enum\"\n+  \"externs,ctfe-stress-4,cargo-0.60.0,token-stream-stress,match-stress,tuple-stress\"\n \n # Merge the profile data we gathered\n ./build/$PGO_HOST/llvm/bin/llvm-profdata \\"}]}