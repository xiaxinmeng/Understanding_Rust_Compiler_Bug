{"sha": "db8f2d590385786c176b5f7d9e887814d31db9ad", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiOGYyZDU5MDM4NTc4NmMxNzZiNWY3ZDllODg3ODE0ZDMxZGI5YWQ=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-09-04T11:36:39Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-02-04T19:06:17Z"}, "message": "Avoid unnecessary codegen in with_cond()\n\nCurrently \"k / 2\" generates one (k: uint) or two (k: int) \"br false,\n...\" instructions and the corresponding basic blocks, producing quite\nsome noise and making the code unnecessarily hard to read.\n\nAdditionally we can skip translation if the code would end up\nunreachable anyway.", "tree": {"sha": "586849a7359a13d49397dcf4ba56baf8808abda5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/586849a7359a13d49397dcf4ba56baf8808abda5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db8f2d590385786c176b5f7d9e887814d31db9ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db8f2d590385786c176b5f7d9e887814d31db9ad", "html_url": "https://github.com/rust-lang/rust/commit/db8f2d590385786c176b5f7d9e887814d31db9ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db8f2d590385786c176b5f7d9e887814d31db9ad/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac134f7ca435551964996ee88319241cd3c7c110", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac134f7ca435551964996ee88319241cd3c7c110", "html_url": "https://github.com/rust-lang/rust/commit/ac134f7ca435551964996ee88319241cd3c7c110"}], "stats": {"total": 12, "additions": 10, "deletions": 2}, "files": [{"sha": "6d9c157985fd9c8b809df354f0afed74566a3523", "filename": "src/librustc_trans/trans/_match.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/db8f2d590385786c176b5f7d9e887814d31db9ad/src%2Flibrustc_trans%2Ftrans%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db8f2d590385786c176b5f7d9e887814d31db9ad/src%2Flibrustc_trans%2Ftrans%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2F_match.rs?ref=db8f2d590385786c176b5f7d9e887814d31db9ad", "patch": "@@ -889,11 +889,13 @@ fn compile_guard<'a, 'p, 'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n         }\n     }\n \n+    for (_, &binding_info) in &data.bindings_map {\n+        bcx.fcx.lllocals.borrow_mut().remove(&binding_info.id);\n+    }\n+\n     with_cond(bcx, Not(bcx, val, guard_expr.debug_loc()), |bcx| {\n-        // Guard does not match: remove all bindings from the lllocals table\n         for (_, &binding_info) in &data.bindings_map {\n             call_lifetime_end(bcx, binding_info.llmatch);\n-            bcx.fcx.lllocals.borrow_mut().remove(&binding_info.id);\n         }\n         match chk {\n             // If the default arm is the only one left, move on to the next"}, {"sha": "1c43daf35bf82b4d56ee74059b175d3ed9fc98d7", "filename": "src/librustc_trans/trans/base.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/db8f2d590385786c176b5f7d9e887814d31db9ad/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db8f2d590385786c176b5f7d9e887814d31db9ad/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fbase.rs?ref=db8f2d590385786c176b5f7d9e887814d31db9ad", "patch": "@@ -1079,6 +1079,12 @@ pub fn with_cond<'blk, 'tcx, F>(bcx: Block<'blk, 'tcx>,\n     F: FnOnce(Block<'blk, 'tcx>) -> Block<'blk, 'tcx>,\n {\n     let _icx = push_ctxt(\"with_cond\");\n+\n+    if bcx.unreachable.get() ||\n+            (common::is_const(val) && common::const_to_uint(val) == 0) {\n+        return bcx;\n+    }\n+\n     let fcx = bcx.fcx;\n     let next_cx = fcx.new_temp_block(\"next\");\n     let cond_cx = fcx.new_temp_block(\"cond\");"}]}