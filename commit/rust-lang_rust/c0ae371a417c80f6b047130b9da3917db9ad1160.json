{"sha": "c0ae371a417c80f6b047130b9da3917db9ad1160", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwYWUzNzFhNDE3YzgwZjZiMDQ3MTMwYjlkYTM5MTdkYjlhZDExNjA=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-01-17T22:43:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-01-17T22:43:27Z"}, "message": "Rollup merge of #47313 - ollie27:rustdoc_record_extern_trait, r=QuietMisdreavus\n\nrustdoc: Populate external_traits with traits only seen in impls\n\nThis means default methods can always be found and \"Important traits\" will include all spotlight traits.", "tree": {"sha": "471cc8dc987ae38cca2258d08e0bd9bd12eabd08", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/471cc8dc987ae38cca2258d08e0bd9bd12eabd08"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0ae371a417c80f6b047130b9da3917db9ad1160", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0ae371a417c80f6b047130b9da3917db9ad1160", "html_url": "https://github.com/rust-lang/rust/commit/c0ae371a417c80f6b047130b9da3917db9ad1160", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0ae371a417c80f6b047130b9da3917db9ad1160/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6c64f0bff60026107c0535c91daa7d8d192efe38", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c64f0bff60026107c0535c91daa7d8d192efe38", "html_url": "https://github.com/rust-lang/rust/commit/6c64f0bff60026107c0535c91daa7d8d192efe38"}, {"sha": "45cad0456f6d8624e8c9d66709444106748a1f03", "url": "https://api.github.com/repos/rust-lang/rust/commits/45cad0456f6d8624e8c9d66709444106748a1f03", "html_url": "https://github.com/rust-lang/rust/commit/45cad0456f6d8624e8c9d66709444106748a1f03"}], "stats": {"total": 57, "additions": 52, "deletions": 5}, "files": [{"sha": "b8c34d78d305ef8490f26cd5066150477551df2c", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=c0ae371a417c80f6b047130b9da3917db9ad1160", "patch": "@@ -328,6 +328,9 @@ pub fn build_impl(cx: &DocContext, did: DefId, ret: &mut Vec<clean::Item>) {\n     if trait_.def_id() == tcx.lang_items().deref_trait() {\n         super::build_deref_target_impls(cx, &trait_items, ret);\n     }\n+    if let Some(trait_did) = trait_.def_id() {\n+        record_extern_trait(cx, trait_did);\n+    }\n \n     let provided = trait_.def_id().map(|did| {\n         tcx.provided_trait_methods(did)\n@@ -483,3 +486,9 @@ fn separate_supertrait_bounds(mut g: clean::Generics)\n     });\n     (g, ty_bounds)\n }\n+\n+pub fn record_extern_trait(cx: &DocContext, did: DefId) {\n+    cx.external_traits.borrow_mut().entry(did).or_insert_with(|| {\n+        build_external_trait(cx, did)\n+    });\n+}"}, {"sha": "cc75664cacbcce66745e3a6a0f8e630974feb165", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=c0ae371a417c80f6b047130b9da3917db9ad1160", "patch": "@@ -3163,8 +3163,7 @@ fn register_def(cx: &DocContext, def: Def) -> DefId {\n     if did.is_local() { return did }\n     inline::record_extern_fqn(cx, did, kind);\n     if let TypeKind::Trait = kind {\n-        let t = inline::build_external_trait(cx, did);\n-        cx.external_traits.borrow_mut().insert(did, t);\n+        inline::record_extern_trait(cx, did);\n     }\n     did\n }"}, {"sha": "cfa09ea30a8bed4ade5937c639383776767da02a", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=c0ae371a417c80f6b047130b9da3917db9ad1160", "patch": "@@ -3277,8 +3277,7 @@ fn spotlight_decl(decl: &clean::FnDecl) -> Result<String, fmt::Error> {\n         if let Some(impls) = c.impls.get(&did) {\n             for i in impls {\n                 let impl_ = i.inner_impl();\n-                if impl_.trait_.def_id().and_then(|d| c.traits.get(&d))\n-                                        .map_or(false, |t| t.is_spotlight) {\n+                if impl_.trait_.def_id().map_or(false, |d| c.traits[&d].is_spotlight) {\n                     if out.is_empty() {\n                         out.push_str(\n                             &format!(\"<h3 class=\\\"important\\\">Important traits for {}</h3>\\\n@@ -3444,7 +3443,7 @@ fn render_impl(w: &mut fmt::Formatter, cx: &Context, i: &Impl, link: AssocItemLi\n     }\n \n     let traits = &cache().traits;\n-    let trait_ = i.trait_did().and_then(|did| traits.get(&did));\n+    let trait_ = i.trait_did().map(|did| &traits[&did]);\n \n     if !show_def_docs {\n         write!(w, \"<span class='docblock autohide'>\")?;"}, {"sha": "5d4adb28cd83a83a3587ee6d6282afb26332548e", "filename": "src/test/rustdoc/inline_cross/auxiliary/impl-inline-without-trait.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fimpl-inline-without-trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fimpl-inline-without-trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fimpl-inline-without-trait.rs?ref=c0ae371a417c80f6b047130b9da3917db9ad1160", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub trait MyTrait {\n+    /// docs for my_trait_method\n+    fn my_trait_method() {}\n+}\n+\n+pub struct MyStruct;\n+\n+impl MyTrait for MyStruct {}"}, {"sha": "ea97d9d6ac2c2577bae046e2cae55d4095371199", "filename": "src/test/rustdoc/inline_cross/impl-inline-without-trait.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Ftest%2Frustdoc%2Finline_cross%2Fimpl-inline-without-trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0ae371a417c80f6b047130b9da3917db9ad1160/src%2Ftest%2Frustdoc%2Finline_cross%2Fimpl-inline-without-trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fimpl-inline-without-trait.rs?ref=c0ae371a417c80f6b047130b9da3917db9ad1160", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:impl-inline-without-trait.rs\n+// build-aux-docs\n+// ignore-cross-compile\n+\n+#![crate_name = \"foo\"]\n+\n+extern crate impl_inline_without_trait;\n+\n+// @has 'foo/struct.MyStruct.html'\n+// @has - '//*[@id=\"method.my_trait_method\"]' 'fn my_trait_method()'\n+// @has - '//*[@class=\"docblock\"]' 'docs for my_trait_method'\n+pub use impl_inline_without_trait::MyStruct;"}]}