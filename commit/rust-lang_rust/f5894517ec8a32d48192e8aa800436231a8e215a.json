{"sha": "f5894517ec8a32d48192e8aa800436231a8e215a", "node_id": "C_kwDOAAsO6NoAKGY1ODk0NTE3ZWM4YTMyZDQ4MTkyZThhYTgwMDQzNjIzMWE4ZTIxNWE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-31T05:07:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-31T05:07:01Z"}, "message": "Rollup merge of #112069 - clubby789:offset-of-sized-fields, r=WaffleLapkin\n\noffset_of: don't require type to be `Sized`\n\nFixes #112051\n\n~~The RFC [explicitly forbids](https://rust-lang.github.io/rfcs/3308-offset_of.html#limitations) non-`Sized` types, but it looks like only the fields being recursed into were checked. The sized check also seemed to have been completely missing for tuples~~", "tree": {"sha": "d29c8aa0f0505a328d62291176366357c2a1103f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d29c8aa0f0505a328d62291176366357c2a1103f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f5894517ec8a32d48192e8aa800436231a8e215a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkdtX1CRBK7hj4Ov3rIwAA1OIIAK7pR63+6T/2fp4iFbjvdpk7\n6cwkY9bdIXc68sMNT0Pn+MVc/xqJvB1bzWZVCI4uZQckvLn/QMm6n8D97+K+dMBk\nBdd/aCWMtSf3QFb5OH6l09S0BEhrdlChni6+ufxKw0bnOWqtLrwe0Rqf8vK3Pd3f\n/61XSqE6/sn6TSSAkLvdMYU5OxwNh8P5R1Kk+aUcHpbzdUJNQ7S3vYE4eWziPv5k\n9DxwwM4BfsOfClw4Xp2lLfchdUsiM7/VmRcMTKeK+fIhrkjfQ1RvXVBYfbQBdM1a\nYORTpt/B1qRCvSlsh4dc9Ap86FUQfzuwMwM04G+fZXK99o05BDgD93hs1ZOGVV4=\n=ptUJ\n-----END PGP SIGNATURE-----\n", "payload": "tree d29c8aa0f0505a328d62291176366357c2a1103f\nparent 7ca941f18e2b1bd3db325e6653ad76d7d407003a\nparent 6c18d1eceff68ede8b0692985fd9b704c7942530\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1685509621 +0200\ncommitter GitHub <noreply@github.com> 1685509621 +0200\n\nRollup merge of #112069 - clubby789:offset-of-sized-fields, r=WaffleLapkin\n\noffset_of: don't require type to be `Sized`\n\nFixes #112051\n\n~~The RFC [explicitly forbids](https://rust-lang.github.io/rfcs/3308-offset_of.html#limitations) non-`Sized` types, but it looks like only the fields being recursed into were checked. The sized check also seemed to have been completely missing for tuples~~\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f5894517ec8a32d48192e8aa800436231a8e215a", "html_url": "https://github.com/rust-lang/rust/commit/f5894517ec8a32d48192e8aa800436231a8e215a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f5894517ec8a32d48192e8aa800436231a8e215a/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ca941f18e2b1bd3db325e6653ad76d7d407003a", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ca941f18e2b1bd3db325e6653ad76d7d407003a", "html_url": "https://github.com/rust-lang/rust/commit/7ca941f18e2b1bd3db325e6653ad76d7d407003a"}, {"sha": "6c18d1eceff68ede8b0692985fd9b704c7942530", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c18d1eceff68ede8b0692985fd9b704c7942530", "html_url": "https://github.com/rust-lang/rust/commit/6c18d1eceff68ede8b0692985fd9b704c7942530"}], "stats": {"total": 26, "additions": 23, "deletions": 3}, "files": [{"sha": "0255b6603805d93fb274542b3af3f32dafe32d4d", "filename": "compiler/rustc_codegen_ssa/src/mir/rvalue.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f5894517ec8a32d48192e8aa800436231a8e215a/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f5894517ec8a32d48192e8aa800436231a8e215a/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs?ref=f5894517ec8a32d48192e8aa800436231a8e215a", "patch": "@@ -668,11 +668,16 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n \n             mir::Rvalue::NullaryOp(ref null_op, ty) => {\n                 let ty = self.monomorphize(ty);\n-                assert!(bx.cx().type_is_sized(ty));\n                 let layout = bx.cx().layout_of(ty);\n                 let val = match null_op {\n-                    mir::NullOp::SizeOf => layout.size.bytes(),\n-                    mir::NullOp::AlignOf => layout.align.abi.bytes(),\n+                    mir::NullOp::SizeOf => {\n+                        assert!(bx.cx().type_is_sized(ty));\n+                        layout.size.bytes()\n+                    }\n+                    mir::NullOp::AlignOf => {\n+                        assert!(bx.cx().type_is_sized(ty));\n+                        layout.align.abi.bytes()\n+                    }\n                     mir::NullOp::OffsetOf(fields) => {\n                         layout.offset_of_subfield(bx.cx(), fields.iter().map(|f| f.index())).bytes()\n                     }"}, {"sha": "666387e615ef2b426a66a21c6e43e539e25d7795", "filename": "tests/ui/offset-of/offset-of-unsized.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f5894517ec8a32d48192e8aa800436231a8e215a/tests%2Fui%2Foffset-of%2Foffset-of-unsized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f5894517ec8a32d48192e8aa800436231a8e215a/tests%2Fui%2Foffset-of%2Foffset-of-unsized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-unsized.rs?ref=f5894517ec8a32d48192e8aa800436231a8e215a", "patch": "@@ -0,0 +1,15 @@\n+// build-pass\n+// regression test for #112051\n+\n+#![feature(offset_of)]\n+\n+struct S<T: ?Sized> {\n+    a: u64,\n+    b: T,\n+}\n+trait Tr {}\n+\n+fn main() {\n+    let _a = core::mem::offset_of!(S<dyn Tr>, a);\n+    let _b = core::mem::offset_of!((u64, dyn Tr), 0);\n+}"}]}