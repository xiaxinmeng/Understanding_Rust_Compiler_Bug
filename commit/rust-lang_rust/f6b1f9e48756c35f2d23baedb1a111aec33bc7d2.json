{"sha": "f6b1f9e48756c35f2d23baedb1a111aec33bc7d2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2YjFmOWU0ODc1NmMzNWYyZDIzYmFlZGIxYTExMWFlYzMzYmM3ZDI=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-10-30T10:26:53Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-10-30T10:26:53Z"}, "message": "rewrite cargo-miri test in Python", "tree": {"sha": "f1827ad9714dd041ad6d8d8e9ea247e300e06a62", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f1827ad9714dd041ad6d8d8e9ea247e300e06a62"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2", "html_url": "https://github.com/rust-lang/rust/commit/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c57f2ba358e391c0c522d3023f69f2c278111ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c57f2ba358e391c0c522d3023f69f2c278111ca", "html_url": "https://github.com/rust-lang/rust/commit/9c57f2ba358e391c0c522d3023f69f2c278111ca"}], "stats": {"total": 70, "additions": 48, "deletions": 22}, "files": [{"sha": "d845eb0ec9f317f189cd71452666c668dd8b1990", "filename": ".travis.yml", "status": "modified", "additions": 5, "deletions": 22, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=f6b1f9e48756c35f2d23baedb1a111aec33bc7d2", "patch": "@@ -36,35 +36,18 @@ script:\n - |\n   # Test and install plain miri\n   cargo build --release --all-features &&\n-  #cargo test --release --all-features &&\n+  cargo test --release --all-features &&\n   cargo install --all-features --force --path .\n - |\n   # get ourselves a MIR-full libstd\n   xargo/build.sh &&\n   export MIRI_SYSROOT=~/.xargo/HOST\n-#- |\n-#  # run all tests with full mir\n-#  cargo test --release --all-features\n+- |\n+  # run all tests with full mir\n+  cargo test --release --all-features\n - |\n   # Test cargo integration\n-  cd cargo-miri-test &&\n-  # Test `cargo miri`\n-    # We ignore the exit code because we want to see the output even on failure, and\n-    # I found no way to preserve the exit code so that we can test for it later.\n-    # Variables set in this subshell in the parenthesis are not available\n-    # on the outside.\n-    # We assume that if this fails, it'll also print something about the failure on\n-    # stdout/stderr and we'll catch that.\n-    # FIXME: Disabling validation, still investigating whether there is UB here\n-    (cargo miri -q >stdout.real 2>stderr.real -- -Zmiri-disable-validation || true) &&\n-    # Print file names and contents (`cat` would just print contents)\n-    tail -n +0 stdout.real stderr.real &&\n-    # Verify output\n-    diff -u stdout.ref stdout.real &&\n-    diff -u stderr.ref stderr.real &&\n-  # test `cargo miri test`\n-    cargo miri test &&\n-  cd ..\n+  (cd cargo-miri-test && ./run-test.py)\n \n notifications:\n   email:"}, {"sha": "90f0a8ac6c88358a1acebe33dd8fcfde4d5326e4", "filename": "cargo-miri-test/run-test.py", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2/cargo-miri-test%2Frun-test.py", "raw_url": "https://github.com/rust-lang/rust/raw/f6b1f9e48756c35f2d23baedb1a111aec33bc7d2/cargo-miri-test%2Frun-test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/cargo-miri-test%2Frun-test.py?ref=f6b1f9e48756c35f2d23baedb1a111aec33bc7d2", "patch": "@@ -0,0 +1,43 @@\n+#!/usr/bin/python3\n+'''\n+Test whether cargo-miri works properly.\n+Assumes the `MIRI_SYSROOT` env var to be set appropriately,\n+and the working directory to contain the cargo-miri-test project.\n+'''\n+\n+import sys, subprocess\n+\n+def test_cargo_miri():\n+    print(\"==> Testing `cargo miri` <==\")\n+    ## Call `cargo miri`, capture all output\n+    # FIXME: Disabling validation, still investigating whether there is UB here\n+    p = subprocess.Popen(\n+        [\"cargo\", \"miri\", \"-q\", \"--\", \"-Zmiri-disable-validation\"],\n+        stdout=subprocess.PIPE,\n+        stderr=subprocess.PIPE\n+    )\n+    (stdout, stderr) = p.communicate()\n+    stdout = stdout.decode(\"UTF-8\")\n+    stderr = stderr.decode(\"UTF-8\")\n+    # Show output\n+    print(\"=> captured stdout <=\")\n+    print(stdout, end=\"\")\n+    print(\"=> captured stderr <=\")\n+    print(stderr, end=\"\")\n+    # Test for failures\n+    if p.returncode != 0:\n+        sys.exit(1)\n+    if stdout != open('stdout.ref').read():\n+        print(\"stdout does not match reference\")\n+        sys.exit(1)\n+    if stderr != open('stderr.ref').read():\n+        print(\"stderr does not match reference\")\n+        sys.exit(1)\n+\n+def test_cargo_miri_test():\n+    print(\"==> Testing `cargo miri test` <==\")\n+    subprocess.check_call([\"cargo\", \"miri\", \"test\"])\n+\n+test_cargo_miri()\n+test_cargo_miri_test()\n+sys.exit(0)"}]}