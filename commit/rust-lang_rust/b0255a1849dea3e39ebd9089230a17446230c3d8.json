{"sha": "b0255a1849dea3e39ebd9089230a17446230c3d8", "node_id": "C_kwDOAAsO6NoAKGIwMjU1YTE4NDlkZWEzZTM5ZWJkOTA4OTIzMGExNzQ0NjIzMGMzZDg", "commit": {"author": {"name": "Chayim Refael Friedman", "email": "chayimfr@gmail.com", "date": "2022-08-23T15:15:34Z"}, "committer": {"name": "Chayim Refael Friedman", "email": "chayimfr@gmail.com", "date": "2022-08-23T15:15:34Z"}, "message": "Suggest alternatives when trying to mutate a `HashMap`/`BTreeMap` via indexing\n\nThe error can be quite confusing to newcomers.", "tree": {"sha": "b5e1560f84101169b81a0fc18c8e4357db7e4352", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b5e1560f84101169b81a0fc18c8e4357db7e4352"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b0255a1849dea3e39ebd9089230a17446230c3d8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b0255a1849dea3e39ebd9089230a17446230c3d8", "html_url": "https://github.com/rust-lang/rust/commit/b0255a1849dea3e39ebd9089230a17446230c3d8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b0255a1849dea3e39ebd9089230a17446230c3d8/comments", "author": {"login": "ChayimFriedman2", "id": 24700207, "node_id": "MDQ6VXNlcjI0NzAwMjA3", "avatar_url": "https://avatars.githubusercontent.com/u/24700207?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChayimFriedman2", "html_url": "https://github.com/ChayimFriedman2", "followers_url": "https://api.github.com/users/ChayimFriedman2/followers", "following_url": "https://api.github.com/users/ChayimFriedman2/following{/other_user}", "gists_url": "https://api.github.com/users/ChayimFriedman2/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChayimFriedman2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChayimFriedman2/subscriptions", "organizations_url": "https://api.github.com/users/ChayimFriedman2/orgs", "repos_url": "https://api.github.com/users/ChayimFriedman2/repos", "events_url": "https://api.github.com/users/ChayimFriedman2/events{/privacy}", "received_events_url": "https://api.github.com/users/ChayimFriedman2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChayimFriedman2", "id": 24700207, "node_id": "MDQ6VXNlcjI0NzAwMjA3", "avatar_url": "https://avatars.githubusercontent.com/u/24700207?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChayimFriedman2", "html_url": "https://github.com/ChayimFriedman2", "followers_url": "https://api.github.com/users/ChayimFriedman2/followers", "following_url": "https://api.github.com/users/ChayimFriedman2/following{/other_user}", "gists_url": "https://api.github.com/users/ChayimFriedman2/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChayimFriedman2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChayimFriedman2/subscriptions", "organizations_url": "https://api.github.com/users/ChayimFriedman2/orgs", "repos_url": "https://api.github.com/users/ChayimFriedman2/repos", "events_url": "https://api.github.com/users/ChayimFriedman2/events{/privacy}", "received_events_url": "https://api.github.com/users/ChayimFriedman2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee8c31e64d229cac4eba6d8f03bb70e16f34a14b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee8c31e64d229cac4eba6d8f03bb70e16f34a14b", "html_url": "https://github.com/rust-lang/rust/commit/ee8c31e64d229cac4eba6d8f03bb70e16f34a14b"}], "stats": {"total": 59, "additions": 57, "deletions": 2}, "files": [{"sha": "56721cc3f5c75a383d1338f3c8654c44ceb9e499", "filename": "compiler/rustc_borrowck/src/diagnostics/mutability_errors.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -1,3 +1,4 @@\n+use rustc_errors::{Applicability, Diagnostic, DiagnosticBuilder, ErrorGuaranteed};\n use rustc_hir as hir;\n use rustc_hir::Node;\n use rustc_middle::hir::map::Map;\n@@ -12,12 +13,11 @@ use rustc_middle::{\n };\n use rustc_span::source_map::DesugaringKind;\n use rustc_span::symbol::{kw, Symbol};\n-use rustc_span::{BytePos, Span};\n+use rustc_span::{sym, BytePos, Span};\n \n use crate::diagnostics::BorrowedContentSource;\n use crate::MirBorrowckCtxt;\n use rustc_const_eval::util::collect_writes::FindAssignments;\n-use rustc_errors::{Applicability, Diagnostic};\n \n #[derive(Copy, Clone, Debug, Eq, PartialEq)]\n pub(crate) enum AccessKind {\n@@ -614,6 +614,7 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                             \"trait `IndexMut` is required to modify indexed content, \\\n                                 but it is not implemented for `{ty}`\",\n                         ));\n+                        self.suggest_map_index_mut_alternatives(ty, &mut err);\n                     }\n                     _ => (),\n                 }\n@@ -627,6 +628,20 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n         self.buffer_error(err);\n     }\n \n+    fn suggest_map_index_mut_alternatives(\n+        &self,\n+        ty: Ty<'_>,\n+        err: &mut DiagnosticBuilder<'_, ErrorGuaranteed>,\n+    ) {\n+        let Some(adt) = ty.ty_adt_def() else { return };\n+        let did = adt.did();\n+        if self.infcx.tcx.is_diagnostic_item(sym::HashMap, did)\n+            || self.infcx.tcx.is_diagnostic_item(sym::BTreeMap, did)\n+        {\n+            err.help(format!(\"to modify a `{ty}`, use `.get_mut()`, `.insert()` or the entry API\"));\n+        }\n+    }\n+\n     /// User cannot make signature of a trait mutable without changing the\n     /// trait. So we find if this error belongs to a trait and if so we move\n     /// suggestion to the trait or disable it if it is out of scope of this crate"}, {"sha": "0ce60e3eb1db811173eb44a229650d4971215c6a", "filename": "src/test/ui/borrowck/index-mut-help.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fborrowck%2Findex-mut-help.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fborrowck%2Findex-mut-help.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Findex-mut-help.stderr?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -5,6 +5,7 @@ LL |     map[\"peter\"].clear();\n    |     ^^^^^^^^^^^^^^^^^^^^ cannot borrow as mutable\n    |\n    = help: trait `IndexMut` is required to modify indexed content, but it is not implemented for `HashMap<&str, String>`\n+   = help: to modify a `HashMap<&str, String>`, use `.get_mut()`, `.insert()` or the entry API\n \n error[E0594]: cannot assign to data in an index of `HashMap<&str, String>`\n   --> $DIR/index-mut-help.rs:12:5\n@@ -13,6 +14,7 @@ LL |     map[\"peter\"] = \"0\".to_string();\n    |     ^^^^^^^^^^^^ cannot assign\n    |\n    = help: trait `IndexMut` is required to modify indexed content, but it is not implemented for `HashMap<&str, String>`\n+   = help: to modify a `HashMap<&str, String>`, use `.get_mut()`, `.insert()` or the entry API\n \n error[E0596]: cannot borrow data in an index of `HashMap<&str, String>` as mutable\n   --> $DIR/index-mut-help.rs:13:13\n@@ -21,6 +23,7 @@ LL |     let _ = &mut map[\"peter\"];\n    |             ^^^^^^^^^^^^^^^^^ cannot borrow as mutable\n    |\n    = help: trait `IndexMut` is required to modify indexed content, but it is not implemented for `HashMap<&str, String>`\n+   = help: to modify a `HashMap<&str, String>`, use `.get_mut()`, `.insert()` or the entry API\n \n error: aborting due to 3 previous errors\n "}, {"sha": "62972acab86ebcfc9b4e4d0b8bad4236bdb93921", "filename": "src/test/ui/btreemap/btreemap-index-mut.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fbtreemap%2Fbtreemap-index-mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fbtreemap%2Fbtreemap-index-mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbtreemap%2Fbtreemap-index-mut.rs?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -0,0 +1,6 @@\n+use std::collections::BTreeMap;\n+\n+fn main() {\n+    let mut map = BTreeMap::<u32, u32>::new();\n+    map[&0] = 1; //~ ERROR cannot assign\n+}"}, {"sha": "260f7100074262b495e0b0008ca15f951ef5e341", "filename": "src/test/ui/btreemap/btreemap-index-mut.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fbtreemap%2Fbtreemap-index-mut.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fbtreemap%2Fbtreemap-index-mut.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbtreemap%2Fbtreemap-index-mut.stderr?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -0,0 +1,12 @@\n+error[E0594]: cannot assign to data in an index of `BTreeMap<u32, u32>`\n+  --> $DIR/btreemap-index-mut.rs:5:5\n+   |\n+LL |     map[&0] = 1;\n+   |     ^^^^^^^^^^^ cannot assign\n+   |\n+   = help: trait `IndexMut` is required to modify indexed content, but it is not implemented for `BTreeMap<u32, u32>`\n+   = help: to modify a `BTreeMap<u32, u32>`, use `.get_mut()`, `.insert()` or the entry API\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0594`."}, {"sha": "98448e9d5f0f0080caa6d44fb008bfd5b57facee", "filename": "src/test/ui/hashmap/hashmap-index-mut.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fhashmap%2Fhashmap-index-mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fhashmap%2Fhashmap-index-mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhashmap%2Fhashmap-index-mut.rs?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -0,0 +1,6 @@\n+use std::collections::HashMap;\n+\n+fn main() {\n+    let mut map = HashMap::<u32, u32>::new();\n+    map[&0] = 1; //~ ERROR cannot assign\n+}"}, {"sha": "c72b380f4666d32d854791659607c23134f64ccb", "filename": "src/test/ui/hashmap/hashmap-index-mut.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fhashmap%2Fhashmap-index-mut.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fhashmap%2Fhashmap-index-mut.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhashmap%2Fhashmap-index-mut.stderr?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -0,0 +1,12 @@\n+error[E0594]: cannot assign to data in an index of `HashMap<u32, u32>`\n+  --> $DIR/hashmap-index-mut.rs:5:5\n+   |\n+LL |     map[&0] = 1;\n+   |     ^^^^^^^^^^^ cannot assign\n+   |\n+   = help: trait `IndexMut` is required to modify indexed content, but it is not implemented for `HashMap<u32, u32>`\n+   = help: to modify a `HashMap<u32, u32>`, use `.get_mut()`, `.insert()` or the entry API\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0594`."}, {"sha": "9c70ab7d9711d455f370ce372fdb2e582d913b16", "filename": "src/test/ui/issues/issue-41726.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fissues%2Fissue-41726.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b0255a1849dea3e39ebd9089230a17446230c3d8/src%2Ftest%2Fui%2Fissues%2Fissue-41726.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-41726.stderr?ref=b0255a1849dea3e39ebd9089230a17446230c3d8", "patch": "@@ -5,6 +5,7 @@ LL |         things[src.as_str()].sort();\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^ cannot borrow as mutable\n    |\n    = help: trait `IndexMut` is required to modify indexed content, but it is not implemented for `HashMap<String, Vec<String>>`\n+   = help: to modify a `HashMap<String, Vec<String>>`, use `.get_mut()`, `.insert()` or the entry API\n \n error: aborting due to previous error\n "}]}