{"sha": "2813afd0592957b327695e77fe75dd956700fd40", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4MTNhZmQwNTkyOTU3YjMyNzY5NWU3N2ZlNzVkZDk1NjcwMGZkNDA=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-19T17:25:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-19T17:25:09Z"}, "message": "Merge #8108\n\n8108: Fix handling of `#![cfg]` in outline module file r=jonas-schievink a=jonas-schievink\n\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "2d69a62693790a12c98bfd414ecfcd6bbac1b1eb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d69a62693790a12c98bfd414ecfcd6bbac1b1eb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2813afd0592957b327695e77fe75dd956700fd40", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgVN51CRBK7hj4Ov3rIwAAdHIIAG+XYOGBq3Ce9z/MjTb7m7yM\nHufVXVcd3eRH/uaBWr9cIhaOBPSyA2dTWWiIljcoBize2RR1wWqG6WSelLCMLya9\nYO7GKHsgoa1mzJOMq4UL59VvcpCddk/TwgnyIuv3wa7VKIlfvLsZqyjfnCCmyxZO\nYJoQ2cP9gI7z8ZStR0rJ9YV3CFJniWNjOZPRBUIV4+ZvcgrQcD00+Wag5vObUwQc\nPXeNdHvMeVC9yJtNRedVS/6f8LZ3gHj7tDb2U6fM2eq0OE7FLFGClM5e0TxBmI2q\nQASqKt6lapdGd53mMY99aUro5mzYd9EI/Ts2/kwj820GWGOtJjsUbFAQlJOZ/iY=\n=w7fQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 2d69a62693790a12c98bfd414ecfcd6bbac1b1eb\nparent dc8e2fea98aecbba0c587e5999b9e09533e0091c\nparent cf494a515ff70675a4531585aa24a792f5b5e896\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1616174709 +0000\ncommitter GitHub <noreply@github.com> 1616174709 +0000\n\nMerge #8108\n\n8108: Fix handling of `#![cfg]` in outline module file r=jonas-schievink a=jonas-schievink\n\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2813afd0592957b327695e77fe75dd956700fd40", "html_url": "https://github.com/rust-lang/rust/commit/2813afd0592957b327695e77fe75dd956700fd40", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2813afd0592957b327695e77fe75dd956700fd40/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc8e2fea98aecbba0c587e5999b9e09533e0091c", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc8e2fea98aecbba0c587e5999b9e09533e0091c", "html_url": "https://github.com/rust-lang/rust/commit/dc8e2fea98aecbba0c587e5999b9e09533e0091c"}, {"sha": "cf494a515ff70675a4531585aa24a792f5b5e896", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf494a515ff70675a4531585aa24a792f5b5e896", "html_url": "https://github.com/rust-lang/rust/commit/cf494a515ff70675a4531585aa24a792f5b5e896"}], "stats": {"total": 69, "additions": 48, "deletions": 21}, "files": [{"sha": "46a3c60cdd80b0992e0efce25da7b5e560457ac2", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 29, "deletions": 21, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/2813afd0592957b327695e77fe75dd956700fd40/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2813afd0592957b327695e77fe75dd956700fd40/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=2813afd0592957b327695e77fe75dd956700fd40", "patch": "@@ -1294,29 +1294,37 @@ impl ModCollector<'_, '_> {\n                 let db = self.def_collector.db;\n                 match self.mod_dir.resolve_declaration(db, self.file_id, &module.name, path_attr) {\n                     Ok((file_id, is_mod_rs, mod_dir)) => {\n-                        let module_id = self.push_child_module(\n-                            module.name.clone(),\n-                            ast_id,\n-                            Some((file_id, is_mod_rs)),\n-                            &self.item_tree[module.visibility],\n-                        );\n                         let item_tree = db.file_item_tree(file_id.into());\n-                        ModCollector {\n-                            def_collector: &mut *self.def_collector,\n-                            macro_depth: self.macro_depth,\n-                            module_id,\n-                            file_id: file_id.into(),\n-                            item_tree: &item_tree,\n-                            mod_dir,\n-                        }\n-                        .collect(item_tree.top_level_items());\n-                        if is_macro_use\n-                            || item_tree\n-                                .top_level_attrs(db, self.def_collector.def_map.krate)\n-                                .by_key(\"macro_use\")\n-                                .exists()\n+                        if item_tree\n+                            .top_level_attrs(db, self.def_collector.def_map.krate)\n+                            .cfg()\n+                            .map_or(true, |cfg| {\n+                                self.def_collector.cfg_options.check(&cfg) != Some(false)\n+                            })\n                         {\n-                            self.import_all_legacy_macros(module_id);\n+                            let module_id = self.push_child_module(\n+                                module.name.clone(),\n+                                ast_id,\n+                                Some((file_id, is_mod_rs)),\n+                                &self.item_tree[module.visibility],\n+                            );\n+                            ModCollector {\n+                                def_collector: &mut *self.def_collector,\n+                                macro_depth: self.macro_depth,\n+                                module_id,\n+                                file_id: file_id.into(),\n+                                item_tree: &item_tree,\n+                                mod_dir,\n+                            }\n+                            .collect(item_tree.top_level_items());\n+                            if is_macro_use\n+                                || item_tree\n+                                    .top_level_attrs(db, self.def_collector.def_map.krate)\n+                                    .by_key(\"macro_use\")\n+                                    .exists()\n+                            {\n+                                self.import_all_legacy_macros(module_id);\n+                            }\n                         }\n                     }\n                     Err(candidate) => {"}, {"sha": "16a2cd27af3afe860ba25f9da9e0a8966b092eee", "filename": "crates/hir_def/src/nameres/tests/mod_resolution.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/2813afd0592957b327695e77fe75dd956700fd40/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2813afd0592957b327695e77fe75dd956700fd40/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs?ref=2813afd0592957b327695e77fe75dd956700fd40", "patch": "@@ -819,3 +819,22 @@ pub mod hash { pub trait Hash {} }\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn cfg_in_module_file() {\n+    // Inner `#![cfg]` in a module file makes the whole module disappear.\n+    check(\n+        r#\"\n+//- /main.rs\n+mod module;\n+\n+//- /module.rs\n+#![cfg(NEVER)]\n+\n+struct AlsoShoulntAppear;\n+        \"#,\n+        expect![[r#\"\n+            crate\n+        \"#]],\n+    )\n+}"}]}