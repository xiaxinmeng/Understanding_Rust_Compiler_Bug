{"sha": "5e991e0afb403fab6edfac096ecd5bb0190449ad", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlOTkxZTBhZmI0MDNmYWI2ZWRmYWMwOTZlY2Q1YmIwMTkwNDQ5YWQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-13T04:01:13Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-13T08:13:14Z"}, "message": "Fix travis builds\n\nAfter reading some articles [1] [2] yesterday about Docker and the \"init\"\nprocess I got to thinking about the problems that we've been seeing on Travis.\nThe basic problem is that a Linux system may need an \"init\" process to work\nproperly when processes become zombies. Docker by default doesn't handle this\nand the root process typically isn't an init process, so this can occasionally\ncause quite a few problems.\n\nWe've been seeing spurious errors on Travis inside containers which look like\nOOM and such, but my guess is that zombie processes were being reparented to the\ntop-level shell. The shell didn't expect the zombies and then behaved very\nstrangely.\n\nThis commit fixes these problems by using Yelp's \"dumb-init\" program [2] as the\ninit process in all of our containers. This ensures that there's a valid init\nready to reap children when they're reparented, which our test suite apparently\ngenerates a bunch of throughout the tests and such.\n\n[1]: https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem/\n[2]: https://engineeringblog.yelp.com/2016/01/dumb-init-an-init-for-docker.html", "tree": {"sha": "f0205637fb880d1fdb03c03acdda95b4436e889f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f0205637fb880d1fdb03c03acdda95b4436e889f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e991e0afb403fab6edfac096ecd5bb0190449ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e991e0afb403fab6edfac096ecd5bb0190449ad", "html_url": "https://github.com/rust-lang/rust/commit/5e991e0afb403fab6edfac096ecd5bb0190449ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e991e0afb403fab6edfac096ecd5bb0190449ad/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b4b1e5ece21fb497877350c3d6defa143c88076c", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4b1e5ece21fb497877350c3d6defa143c88076c", "html_url": "https://github.com/rust-lang/rust/commit/b4b1e5ece21fb497877350c3d6defa143c88076c"}], "stats": {"total": 62, "additions": 61, "deletions": 1}, "files": [{"sha": "5489fb7304d1c7d8b5b6335673dfa91312fc3b66", "filename": "src/ci/docker/arm-android/Dockerfile", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Farm-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Farm-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Farm-android%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -25,8 +25,13 @@ COPY install-ndk.sh install-sdk.sh accept-licenses.sh /android/\n RUN sh /android/install-ndk.sh\n RUN sh /android/install-sdk.sh\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+\n COPY start-emulator.sh /android/\n-ENTRYPOINT [\"/android/start-emulator.sh\"]\n+\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\", \"/android/start-emulator.sh\"]\n \n ENV TARGETS=arm-linux-androideabi\n ENV TARGETS=$TARGETS,i686-linux-android"}, {"sha": "eeb6c79d69bccee81d2dfffb7d6aa9d789e5690d", "filename": "src/ci/docker/cross/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fcross%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fcross%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fcross%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -23,6 +23,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   gcc-powerpc64le-linux-gnu libc6-dev-ppc64el-cross \\\n   gcc-s390x-linux-gnu libc6-dev-s390x-cross\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV TARGETS=aarch64-unknown-linux-gnu\n ENV TARGETS=$TARGETS,arm-unknown-linux-gnueabi\n ENV TARGETS=$TARGETS,arm-unknown-linux-gnueabihf"}, {"sha": "51161997e222708f45121db2644f336c05d4f072", "filename": "src/ci/docker/i686-gnu-nopt/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fi686-gnu-nopt%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fi686-gnu-nopt%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fi686-gnu-nopt%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   sudo \\\n   gdb\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu --disable-optimize-tests\n ENV RUST_CHECK_TARGET check\n RUN mkdir /tmp/obj"}, {"sha": "1603d353275beaecdff7e73e2a2a76ebf839e67d", "filename": "src/ci/docker/i686-gnu/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fi686-gnu%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fi686-gnu%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fi686-gnu%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   sudo \\\n   gdb\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu\n ENV RUST_CHECK_TARGET check\n RUN mkdir /tmp/obj"}, {"sha": "629cfbc3a9c6f1f8f1244dc4667ee543f30e70e2", "filename": "src/ci/docker/x86_64-freebsd/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-freebsd%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-freebsd%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-freebsd%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -18,6 +18,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n COPY build-toolchain.sh /tmp/\n RUN sh /tmp/build-toolchain.sh\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV \\\n     AR_x86_64_unknown_freebsd=x86_64-unknown-freebsd10-ar \\\n     CC_x86_64_unknown_freebsd=x86_64-unknown-freebsd10-gcc"}, {"sha": "78aa510ec04235821e640701e6c343ebe5ff701f", "filename": "src/ci/docker/x86_64-gnu-cargotest/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-cargotest%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-cargotest%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-cargotest%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   libssl-dev \\\n   sudo\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu\n ENV RUST_CHECK_TARGET check-cargotest\n ENV NO_VENDOR 1"}, {"sha": "7d00f11cbb800fa0c0920a4f64de2d087c972dc5", "filename": "src/ci/docker/x86_64-gnu-debug/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-debug%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-debug%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-debug%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   sudo \\\n   gdb\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS \\\n       --build=x86_64-unknown-linux-gnu \\\n       --enable-debug \\"}, {"sha": "95484c660e67c1d9ab08418cc6c846d3426649de", "filename": "src/ci/docker/x86_64-gnu-llvm-3.7/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-3.7%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-3.7%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-3.7%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -16,6 +16,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   libedit-dev \\\n   zlib1g-dev\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS \\\n       --build=x86_64-unknown-linux-gnu \\\n       --llvm-root=/usr/lib/llvm-3.7"}, {"sha": "4a5c5b57ea7c402d5df486b101af4cc4ef49f0fa", "filename": "src/ci/docker/x86_64-gnu-make/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-make%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-make%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-make%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   sudo \\\n   gdb\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu --disable-rustbuild\n ENV RUST_CHECK_TARGET check\n RUN mkdir /tmp/obj"}, {"sha": "c2a5449d2e393f388890f4638b63eec365a20f6d", "filename": "src/ci/docker/x86_64-gnu-nopt/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-nopt%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu-nopt%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-nopt%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   sudo \\\n   gdb\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu --disable-optimize-tests\n ENV RUST_CHECK_TARGET check\n RUN mkdir /tmp/obj"}, {"sha": "54bbc9b342150477ab63f6b8a32b4f55416bb0f0", "filename": "src/ci/docker/x86_64-gnu/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-gnu%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -13,6 +13,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   sudo \\\n   gdb\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu\n ENV RUST_CHECK_TARGET check\n RUN mkdir /tmp/obj"}, {"sha": "b3068cacd04641e9612619590bc96dce33cb459d", "filename": "src/ci/docker/x86_64-musl/Dockerfile", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5e991e0afb403fab6edfac096ecd5bb0190449ad/src%2Fci%2Fdocker%2Fx86_64-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-musl%2FDockerfile?ref=5e991e0afb403fab6edfac096ecd5bb0190449ad", "patch": "@@ -18,6 +18,11 @@ WORKDIR /build/\n COPY build-musl.sh /build/\n RUN sh /build/build-musl.sh && rm -rf /build\n \n+RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\\n+    dpkg -i dumb-init_*.deb && \\\n+    rm dumb-init_*.deb\n+ENTRYPOINT [\"/usr/bin/dumb-init\", \"--\"]\n+\n ENV RUST_CONFIGURE_ARGS \\\n       --target=x86_64-unknown-linux-musl \\\n       --musl-root-x86_64=/musl-x86_64"}]}