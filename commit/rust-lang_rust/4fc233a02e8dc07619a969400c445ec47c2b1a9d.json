{"sha": "4fc233a02e8dc07619a969400c445ec47c2b1a9d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmYzIzM2EwMmU4ZGMwNzYxOWE5Njk0MDBjNDQ1ZWM0N2MyYjFhOWQ=", "commit": {"author": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2019-01-05T20:28:30Z"}, "committer": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2019-01-05T20:28:30Z"}, "message": "Implement type inference for boolean operators", "tree": {"sha": "dae33907a38b7c4ed9d1a63ff38803e99f1ae6df", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dae33907a38b7c4ed9d1a63ff38803e99f1ae6df"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fc233a02e8dc07619a969400c445ec47c2b1a9d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fc233a02e8dc07619a969400c445ec47c2b1a9d", "html_url": "https://github.com/rust-lang/rust/commit/4fc233a02e8dc07619a969400c445ec47c2b1a9d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fc233a02e8dc07619a969400c445ec47c2b1a9d/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e42a158787955ff9f2e81be43479dbe8f2b1bb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e42a158787955ff9f2e81be43479dbe8f2b1bb6", "html_url": "https://github.com/rust-lang/rust/commit/3e42a158787955ff9f2e81be43479dbe8f2b1bb6"}], "stats": {"total": 96, "additions": 92, "deletions": 4}, "files": [{"sha": "718e193f72c2b59de08109b22ee9e4af8dea59ce", "filename": "crates/ra_hir/src/ty.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_hir%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_hir%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty.rs?ref=4fc233a02e8dc07619a969400c445ec47c2b1a9d", "patch": "@@ -26,7 +26,7 @@ use ena::unify::{InPlaceUnificationTable, UnifyKey, UnifyValue, NoError};\n \n use ra_db::{LocalSyntaxPtr, Cancelable};\n use ra_syntax::{\n-    ast::{self, AstNode, LoopBodyOwner, ArgListOwner, PrefixOp},\n+    ast::{self, AstNode, LoopBodyOwner, ArgListOwner, PrefixOp, BinOp},\n     SyntaxNodeRef\n };\n \n@@ -906,7 +906,16 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                 }\n             }\n             ast::Expr::RangeExpr(_e) => Ty::Unknown,\n-            ast::Expr::BinExpr(_e) => Ty::Unknown,\n+            ast::Expr::BinExpr(e) => match e.op() {\n+                Some(BinOp::BooleanOr)\n+                | Some(BinOp::BooleanAnd)\n+                | Some(BinOp::EqualityTest)\n+                | Some(BinOp::LesserEqualTest)\n+                | Some(BinOp::GreaterEqualTest)\n+                | Some(BinOp::LesserTest)\n+                | Some(BinOp::GreaterTest) => Ty::Bool,\n+                _ => Ty::Unknown,\n+            },\n             ast::Expr::Literal(_e) => Ty::Unknown,\n         };\n         // use a new type variable if we got Ty::Unknown here"}, {"sha": "97c46689020369ed9a5f472dcd27de4ceb1c6b66", "filename": "crates/ra_hir/src/ty/tests.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs?ref=4fc233a02e8dc07619a969400c445ec47c2b1a9d", "patch": "@@ -153,6 +153,23 @@ impl S {\n     );\n }\n \n+#[test]\n+fn infer_boolean_op() {\n+    check_inference(\n+        r#\"\n+fn test() {\n+    let x = a && b;\n+    let y = true || false;\n+    let z = x == y;\n+    let h = CONST_1 <= CONST_2;\n+\n+    10 < 3\n+}\n+\"#,\n+        \"0008_boolean_op.txt\",\n+    );\n+}\n+\n fn infer(content: &str) -> String {\n     let (db, _, file_id) = MockDatabase::with_single_file(content);\n     let source_file = db.source_file(file_id);"}, {"sha": "cc07cdccb9c45f1c7e51acc8276a1c9b2f52b220", "filename": "crates/ra_hir/src/ty/tests/data/0008_boolean_op.txt", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_hir%2Fsrc%2Fty%2Ftests%2Fdata%2F0008_boolean_op.txt", "raw_url": "https://github.com/rust-lang/rust/raw/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_hir%2Fsrc%2Fty%2Ftests%2Fdata%2F0008_boolean_op.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests%2Fdata%2F0008_boolean_op.txt?ref=4fc233a02e8dc07619a969400c445ec47c2b1a9d", "patch": "@@ -0,0 +1,10 @@\n+[21; 22) 'x': bool\n+[68; 69) 'z': bool\n+[72; 78) 'x == y': bool\n+[45; 58) 'true || false': bool\n+[11; 125) '{     ... < 3 }': bool\n+[117; 123) '10 < 3': bool\n+[88; 89) 'h': bool\n+[41; 42) 'y': bool\n+[92; 110) 'CONST_...ONST_2': bool\n+[25; 31) 'a && b': bool"}, {"sha": "1bce6fa40b28c8ab3a7c038c60839b8b210e367a", "filename": "crates/ra_syntax/src/ast.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_syntax%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_syntax%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast.rs?ref=4fc233a02e8dc07619a969400c445ec47c2b1a9d", "patch": "@@ -488,6 +488,45 @@ impl<'a> PrefixExpr<'a> {\n     }\n }\n \n+#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash)]\n+pub enum BinOp {\n+    /// The `||` operator for boolean OR\n+    BooleanOr,\n+    /// The `&&` operator for boolean AND\n+    BooleanAnd,\n+    /// The `==` operator for equality testing\n+    EqualityTest,\n+    /// The `<=` operator for lesser-equal testing\n+    LesserEqualTest,\n+    /// The `>=` operator for greater-equal testing\n+    GreaterEqualTest,\n+    /// The `<` operator for comparison\n+    LesserTest,\n+    /// The `>` operator for comparison\n+    GreaterTest,\n+    // TODO: lots of others\n+}\n+\n+impl<'a> BinExpr<'a> {\n+    pub fn op(&self) -> Option<BinOp> {\n+        self.syntax()\n+            .children()\n+            .filter_map(|c| {\n+                match c.kind() {\n+                    PIPEPIPE => Some(BinOp::BooleanOr),\n+                    AMPAMP => Some(BinOp::BooleanAnd),\n+                    EQEQ => Some(BinOp::EqualityTest),\n+                    LTEQ => Some(BinOp::LesserEqualTest),\n+                    GTEQ => Some(BinOp::GreaterEqualTest),\n+                    L_ANGLE => Some(BinOp::LesserTest),\n+                    R_ANGLE => Some(BinOp::GreaterTest),\n+                    _ => None,\n+                }\n+            })\n+            .next()\n+    }\n+}\n+\n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash)]\n pub enum SelfParamFlavor {\n     /// self"}, {"sha": "ac320606dc3bd323a8d2218f0aee058a662e58b3", "filename": "crates/ra_syntax/src/ast/generated.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated.rs?ref=4fc233a02e8dc07619a969400c445ec47c2b1a9d", "patch": "@@ -217,7 +217,15 @@ impl<R: TreeRoot<RaTypes>> BinExprNode<R> {\n }\n \n \n-impl<'a> BinExpr<'a> {}\n+impl<'a> BinExpr<'a> {\n+    pub fn lhs(self) -> Option<Expr<'a>> {\n+        super::child_opt(self)\n+    }\n+\n+    pub fn rhs(self) -> Option<Expr<'a>> {\n+        super::child_opt(self)\n+    }\n+}\n \n // BindPat\n #[derive(Debug, Clone, Copy,)]"}, {"sha": "e59961da382bdfe7d24ceb397e30e859f9aede9f", "filename": "crates/ra_syntax/src/grammar.ron", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_syntax%2Fsrc%2Fgrammar.ron", "raw_url": "https://github.com/rust-lang/rust/raw/4fc233a02e8dc07619a969400c445ec47c2b1a9d/crates%2Fra_syntax%2Fsrc%2Fgrammar.ron", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fgrammar.ron?ref=4fc233a02e8dc07619a969400c445ec47c2b1a9d", "patch": "@@ -422,7 +422,12 @@ Grammar(\n         \"RefExpr\": (options: [\"Expr\"]),\n         \"PrefixExpr\": (options: [\"Expr\"]),\n         \"RangeExpr\": (),\n-        \"BinExpr\": (),\n+        \"BinExpr\": (\n+            options: [\n+                [\"lhs\", \"Expr\"],\n+                [\"rhs\", \"Expr\"]\n+            ]\n+        ),\n         \"String\": (),\n         \"Byte\": (),\n         \"ByteString\": (),"}]}