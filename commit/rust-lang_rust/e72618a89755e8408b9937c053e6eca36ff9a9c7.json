{"sha": "e72618a89755e8408b9937c053e6eca36ff9a9c7", "node_id": "C_kwDOAAsO6NoAKGU3MjYxOGE4OTc1NWU4NDA4Yjk5MzdjMDUzZTZlY2EzNmZmOWE5Yzc", "commit": {"author": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-06-14T22:27:17Z"}, "committer": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-06-15T11:42:20Z"}, "message": "Don't capture &[T; N] when contents isn't read", "tree": {"sha": "6df739c5ea75ca1fc29b2172d2883d7e1d8b9b9a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6df739c5ea75ca1fc29b2172d2883d7e1d8b9b9a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e72618a89755e8408b9937c053e6eca36ff9a9c7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e72618a89755e8408b9937c053e6eca36ff9a9c7", "html_url": "https://github.com/rust-lang/rust/commit/e72618a89755e8408b9937c053e6eca36ff9a9c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e72618a89755e8408b9937c053e6eca36ff9a9c7/comments", "author": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "committer": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b475c705f36fb3b0a63994b92f2bbd2f5865b07", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b475c705f36fb3b0a63994b92f2bbd2f5865b07", "html_url": "https://github.com/rust-lang/rust/commit/0b475c705f36fb3b0a63994b92f2bbd2f5865b07"}], "stats": {"total": 85, "additions": 66, "deletions": 19}, "files": [{"sha": "82d9f03b1451eee137c95d95e80455e72a6f6858", "filename": "compiler/rustc_hir_typeck/src/expr_use_visitor.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e72618a89755e8408b9937c053e6eca36ff9a9c7/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e72618a89755e8408b9937c053e6eca36ff9a9c7/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr_use_visitor.rs?ref=e72618a89755e8408b9937c053e6eca36ff9a9c7", "patch": "@@ -443,7 +443,7 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n                         if matches!((lhs, wild, rhs), (&[], Some(_), &[]))\n                             // Arrays have a statically known size, so\n                             // there is no need to read their length\n-                            || discr_place.place.base_ty.is_array()\n+                            || place.place.ty().peel_refs().is_array()\n                         {\n                         } else {\n                             needs_to_be_read = true;"}, {"sha": "c3898afa967f812dc8f71aed0b95d03010c00679", "filename": "tests/ui/closures/2229_closure_analysis/match/patterns-capture-analysis.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/e72618a89755e8408b9937c053e6eca36ff9a9c7/tests%2Fui%2Fclosures%2F2229_closure_analysis%2Fmatch%2Fpatterns-capture-analysis.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e72618a89755e8408b9937c053e6eca36ff9a9c7/tests%2Fui%2Fclosures%2F2229_closure_analysis%2Fmatch%2Fpatterns-capture-analysis.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fclosures%2F2229_closure_analysis%2Fmatch%2Fpatterns-capture-analysis.rs?ref=e72618a89755e8408b9937c053e6eca36ff9a9c7", "patch": "@@ -87,6 +87,31 @@ fn test_4_should_not_capture_array() {\n         }\n     };\n     c();\n+\n+    // We also do not need to capture an array\n+    // behind a reference (#112607)\n+    let array: &[i32; 3] = &[0; 3];\n+    let c = #[rustc_capture_analysis]\n+    || {\n+    //~^ First Pass analysis includes:\n+        match array {\n+            [_, _, _] => {}\n+        }\n+    };\n+    c();\n+\n+    // We should still not insert a read if the array is inside an\n+    // irrefutable pattern\n+    struct Foo<T>(T);\n+    let f = &Foo(&[10; 3]);\n+    let c = #[rustc_capture_analysis]\n+    || {\n+    //~^ First Pass analysis includes:\n+        match f {\n+            Foo([_, _, _]) => ()\n+        }\n+    };\n+    c();\n }\n \n // Testing MultiVariant patterns"}, {"sha": "c3c3f8b847772fe8d6bd1f0c6b9c799eb3a7108b", "filename": "tests/ui/closures/2229_closure_analysis/match/patterns-capture-analysis.stderr", "status": "modified", "additions": 40, "deletions": 18, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/e72618a89755e8408b9937c053e6eca36ff9a9c7/tests%2Fui%2Fclosures%2F2229_closure_analysis%2Fmatch%2Fpatterns-capture-analysis.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e72618a89755e8408b9937c053e6eca36ff9a9c7/tests%2Fui%2Fclosures%2F2229_closure_analysis%2Fmatch%2Fpatterns-capture-analysis.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fclosures%2F2229_closure_analysis%2Fmatch%2Fpatterns-capture-analysis.stderr?ref=e72618a89755e8408b9937c053e6eca36ff9a9c7", "patch": "@@ -109,7 +109,29 @@ LL | |     };\n    | |_____^\n \n error: First Pass analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:105:5\n+  --> $DIR/patterns-capture-analysis.rs:95:5\n+   |\n+LL | /     || {\n+LL | |\n+LL | |         match array {\n+LL | |             [_, _, _] => {}\n+LL | |         }\n+LL | |     };\n+   | |_____^\n+\n+error: First Pass analysis includes:\n+  --> $DIR/patterns-capture-analysis.rs:108:5\n+   |\n+LL | /     || {\n+LL | |\n+LL | |         match f {\n+LL | |             Foo([_, _, _]) => ()\n+LL | |         }\n+LL | |     };\n+   | |_____^\n+\n+error: First Pass analysis includes:\n+  --> $DIR/patterns-capture-analysis.rs:130:5\n    |\n LL | /     || {\n LL | |\n@@ -121,13 +143,13 @@ LL | |     };\n    | |_____^\n    |\n note: Capturing variant[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:108:15\n+  --> $DIR/patterns-capture-analysis.rs:133:15\n    |\n LL |         match variant {\n    |               ^^^^^^^\n \n error: Min Capture analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:105:5\n+  --> $DIR/patterns-capture-analysis.rs:130:5\n    |\n LL | /     || {\n LL | |\n@@ -139,13 +161,13 @@ LL | |     };\n    | |_____^\n    |\n note: Min Capture variant[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:108:15\n+  --> $DIR/patterns-capture-analysis.rs:133:15\n    |\n LL |         match variant {\n    |               ^^^^^^^\n \n error: First Pass analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:123:5\n+  --> $DIR/patterns-capture-analysis.rs:148:5\n    |\n LL | /     || {\n LL | |\n@@ -157,13 +179,13 @@ LL | |     };\n    | |_____^\n    |\n note: Capturing slice[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:126:15\n+  --> $DIR/patterns-capture-analysis.rs:151:15\n    |\n LL |         match slice {\n    |               ^^^^^\n \n error: Min Capture analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:123:5\n+  --> $DIR/patterns-capture-analysis.rs:148:5\n    |\n LL | /     || {\n LL | |\n@@ -175,13 +197,13 @@ LL | |     };\n    | |_____^\n    |\n note: Min Capture slice[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:126:15\n+  --> $DIR/patterns-capture-analysis.rs:151:15\n    |\n LL |         match slice {\n    |               ^^^^^\n \n error: First Pass analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:135:5\n+  --> $DIR/patterns-capture-analysis.rs:160:5\n    |\n LL | /     || {\n LL | |\n@@ -193,13 +215,13 @@ LL | |     };\n    | |_____^\n    |\n note: Capturing slice[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:138:15\n+  --> $DIR/patterns-capture-analysis.rs:163:15\n    |\n LL |         match slice {\n    |               ^^^^^\n \n error: Min Capture analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:135:5\n+  --> $DIR/patterns-capture-analysis.rs:160:5\n    |\n LL | /     || {\n LL | |\n@@ -211,13 +233,13 @@ LL | |     };\n    | |_____^\n    |\n note: Min Capture slice[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:138:15\n+  --> $DIR/patterns-capture-analysis.rs:163:15\n    |\n LL |         match slice {\n    |               ^^^^^\n \n error: First Pass analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:147:5\n+  --> $DIR/patterns-capture-analysis.rs:172:5\n    |\n LL | /     || {\n LL | |\n@@ -229,13 +251,13 @@ LL | |     };\n    | |_____^\n    |\n note: Capturing slice[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:150:15\n+  --> $DIR/patterns-capture-analysis.rs:175:15\n    |\n LL |         match slice {\n    |               ^^^^^\n \n error: Min Capture analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:147:5\n+  --> $DIR/patterns-capture-analysis.rs:172:5\n    |\n LL | /     || {\n LL | |\n@@ -247,13 +269,13 @@ LL | |     };\n    | |_____^\n    |\n note: Min Capture slice[] -> ImmBorrow\n-  --> $DIR/patterns-capture-analysis.rs:150:15\n+  --> $DIR/patterns-capture-analysis.rs:175:15\n    |\n LL |         match slice {\n    |               ^^^^^\n \n error: First Pass analysis includes:\n-  --> $DIR/patterns-capture-analysis.rs:164:5\n+  --> $DIR/patterns-capture-analysis.rs:189:5\n    |\n LL | /     || {\n LL | |\n@@ -264,5 +286,5 @@ LL | |         }\n LL | |     };\n    | |_____^\n \n-error: aborting due to 16 previous errors\n+error: aborting due to 18 previous errors\n "}]}