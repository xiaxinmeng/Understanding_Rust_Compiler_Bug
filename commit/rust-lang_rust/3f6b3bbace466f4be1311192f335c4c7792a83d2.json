{"sha": "3f6b3bbace466f4be1311192f335c4c7792a83d2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmNmIzYmJhY2U0NjZmNGJlMTMxMTE5MmYzMzVjNGM3NzkyYTgzZDI=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-05-10T16:09:58Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-05-10T16:09:58Z"}, "message": "Improve format string errors\n\n - Point at format string position inside the formatting string\n - Explain that argument names can't start with an underscore", "tree": {"sha": "afb5e7725fb3e258c87d9622fbfd4998407ecb0d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/afb5e7725fb3e258c87d9622fbfd4998407ecb0d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f6b3bbace466f4be1311192f335c4c7792a83d2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f6b3bbace466f4be1311192f335c4c7792a83d2", "html_url": "https://github.com/rust-lang/rust/commit/3f6b3bbace466f4be1311192f335c4c7792a83d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f6b3bbace466f4be1311192f335c4c7792a83d2/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5f80f2a4f016bf724a1cfb580619d71c8fd39ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5f80f2a4f016bf724a1cfb580619d71c8fd39ec", "html_url": "https://github.com/rust-lang/rust/commit/e5f80f2a4f016bf724a1cfb580619d71c8fd39ec"}], "stats": {"total": 153, "additions": 132, "deletions": 21}, "files": [{"sha": "a77751d65d08c3c7f164526688356acd35fd82ce", "filename": "src/libfmt_macros/lib.rs", "status": "modified", "additions": 68, "deletions": 14, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Flibfmt_macros%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Flibfmt_macros%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibfmt_macros%2Flib.rs?ref=3f6b3bbace466f4be1311192f335c4c7792a83d2", "patch": "@@ -127,6 +127,14 @@ pub enum Count<'a> {\n     CountImplied,\n }\n \n+pub struct ParseError {\n+    pub description: string::String,\n+    pub note: Option<string::String>,\n+    pub label: string::String,\n+    pub start: usize,\n+    pub end: usize,\n+}\n+\n /// The parser structure for interpreting the input format string. This is\n /// modeled as an iterator over `Piece` structures to form a stream of tokens\n /// being output.\n@@ -137,7 +145,7 @@ pub struct Parser<'a> {\n     input: &'a str,\n     cur: iter::Peekable<str::CharIndices<'a>>,\n     /// Error messages accumulated during parsing\n-    pub errors: Vec<(string::String, Option<string::String>)>,\n+    pub errors: Vec<ParseError>,\n     /// Current position of implicit positional argument pointer\n     curarg: usize,\n }\n@@ -160,12 +168,17 @@ impl<'a> Iterator for Parser<'a> {\n                 }\n                 '}' => {\n                     self.cur.next();\n+                    let pos = pos + 1;\n                     if self.consume('}') {\n-                        Some(String(self.string(pos + 1)))\n+                        Some(String(self.string(pos)))\n                     } else {\n-                        self.err_with_note(\"unmatched `}` found\",\n-                                           \"if you intended to print `}`, \\\n-                                           you can escape it using `}}`\");\n+                        self.err_with_note(\n+                            \"unmatched `}` found\",\n+                            \"unmatched `}`\",\n+                            \"if you intended to print `}`, you can escape it using `}}`\",\n+                            pos,\n+                            pos,\n+                        );\n                         None\n                     }\n                 }\n@@ -191,15 +204,40 @@ impl<'a> Parser<'a> {\n     /// Notifies of an error. The message doesn't actually need to be of type\n     /// String, but I think it does when this eventually uses conditions so it\n     /// might as well start using it now.\n-    fn err(&mut self, msg: &str) {\n-        self.errors.push((msg.to_owned(), None));\n+    fn err<S1: Into<string::String>, S2: Into<string::String>>(\n+        &mut self,\n+        description: S1,\n+        label: S2,\n+        start: usize,\n+        end: usize,\n+    ) {\n+        self.errors.push(ParseError {\n+            description: description.into(),\n+            note: None,\n+            label: label.into(),\n+            start,\n+            end,\n+        });\n     }\n \n     /// Notifies of an error. The message doesn't actually need to be of type\n     /// String, but I think it does when this eventually uses conditions so it\n     /// might as well start using it now.\n-    fn err_with_note(&mut self, msg: &str, note: &str) {\n-        self.errors.push((msg.to_owned(), Some(note.to_owned())));\n+    fn err_with_note<S1: Into<string::String>, S2: Into<string::String>, S3: Into<string::String>>(\n+        &mut self,\n+        description: S1,\n+        label: S2,\n+        note: S3,\n+        start: usize,\n+        end: usize,\n+    ) {\n+        self.errors.push(ParseError {\n+            description: description.into(),\n+            note: Some(note.into()),\n+            label: label.into(),\n+            start,\n+            end,\n+        });\n     }\n \n     /// Optionally consumes the specified character. If the character is not at\n@@ -222,19 +260,26 @@ impl<'a> Parser<'a> {\n     /// found, an error is emitted.\n     fn must_consume(&mut self, c: char) {\n         self.ws();\n-        if let Some(&(_, maybe)) = self.cur.peek() {\n+        if let Some(&(pos, maybe)) = self.cur.peek() {\n             if c == maybe {\n                 self.cur.next();\n             } else {\n-                self.err(&format!(\"expected `{:?}`, found `{:?}`\", c, maybe));\n+                self.err(format!(\"expected `{:?}`, found `{:?}`\", c, maybe),\n+                         format!(\"expected `{}`\", c),\n+                         pos + 1,\n+                         pos + 1);\n             }\n         } else {\n-            let msg = &format!(\"expected `{:?}` but string was terminated\", c);\n+            let msg = format!(\"expected `{:?}` but string was terminated\", c);\n+            let pos = self.input.len() + 1; // point at closing `\"`\n             if c == '}' {\n                 self.err_with_note(msg,\n-                                   \"if you intended to print `{`, you can escape it using `{{`\");\n+                                   format!(\"expected `{:?}`\", c),\n+                                   \"if you intended to print `{`, you can escape it using `{{`\",\n+                                   pos,\n+                                   pos);\n             } else {\n-                self.err(msg);\n+                self.err(msg, format!(\"expected `{:?}`\", c), pos, pos);\n             }\n         }\n     }\n@@ -300,6 +345,15 @@ impl<'a> Parser<'a> {\n         } else {\n             match self.cur.peek() {\n                 Some(&(_, c)) if c.is_alphabetic() => Some(ArgumentNamed(self.word())),\n+                Some(&(pos, c)) if c == '_' => {\n+                    let invalid_name = self.string(pos);\n+                    self.err_with_note(format!(\"invalid argument name `{}`\", invalid_name),\n+                                       \"invalid argument name\",\n+                                       \"argument names cannot start with an underscore\",\n+                                       pos + 1, // add 1 to account for leading `{`\n+                                       pos + 1 + invalid_name.len());\n+                    Some(ArgumentNamed(invalid_name))\n+                },\n \n                 // This is an `ArgumentNext`.\n                 // Record the fact and do the resolution after parsing the"}, {"sha": "de20cc910d32a32d39cc85eaa9618ce4ebd71048", "filename": "src/libsyntax_ext/format.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Flibsyntax_ext%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Flibsyntax_ext%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fformat.rs?ref=3f6b3bbace466f4be1311192f335c4c7792a83d2", "patch": "@@ -767,9 +767,12 @@ pub fn expand_preparsed_format_args(ecx: &mut ExtCtxt,\n     }\n \n     if !parser.errors.is_empty() {\n-        let (err, note) = parser.errors.remove(0);\n-        let mut e = cx.ecx.struct_span_err(cx.fmtsp, &format!(\"invalid format string: {}\", err));\n-        if let Some(note) = note {\n+        let err = parser.errors.remove(0);\n+        let sp = cx.fmtsp.from_inner_byte_pos(err.start, err.end);\n+        let mut e = cx.ecx.struct_span_err(sp, &format!(\"invalid format string: {}\",\n+                                                        err.description));\n+        e.span_label(sp, err.label + \" in format string\");\n+        if let Some(note) = err.note {\n             e.note(&note);\n         }\n         e.emit();"}, {"sha": "e1693ff4db67b2a5174983c7373bba517f6d28af", "filename": "src/libsyntax_pos/lib.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Flibsyntax_pos%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Flibsyntax_pos%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Flib.rs?ref=3f6b3bbace466f4be1311192f335c4c7792a83d2", "patch": "@@ -427,6 +427,13 @@ impl Span {\n         )\n     }\n \n+    pub fn from_inner_byte_pos(self, start: usize, end: usize) -> Span {\n+        let span = self.data();\n+        Span::new(span.lo + BytePos::from_usize(start),\n+                  span.lo + BytePos::from_usize(end),\n+                  span.ctxt)\n+    }\n+\n     #[inline]\n     pub fn apply_mark(self, mark: Mark) -> Span {\n         let span = self.data();"}, {"sha": "5b13686240e7c0de46e71ec8a31c981b6f55782d", "filename": "src/test/ui/fmt/format-string-error.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Ftest%2Fui%2Ffmt%2Fformat-string-error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Ftest%2Fui%2Ffmt%2Fformat-string-error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Fformat-string-error.rs?ref=3f6b3bbace466f4be1311192f335c4c7792a83d2", "patch": "@@ -12,5 +12,14 @@ fn main() {\n     println!(\"{\");\n     println!(\"{{}}\");\n     println!(\"}\");\n+    let _ = format!(\"{_foo}\", _foo = 6usize);\n+    //~^ ERROR invalid format string: invalid argument name `_foo`\n+    let _ = format!(\"{_}\", _ = 6usize);\n+    //~^ ERROR invalid format string: invalid argument name `_`\n+    let _ = format!(\"{\");\n+    //~^ ERROR invalid format string: expected `'}'` but string was terminated\n+    let _ = format!(\"}\");\n+    //~^ ERROR invalid format string: unmatched `}` found\n+    let _ = format!(\"{\\\\}\");\n+    //~^ ERROR invalid format string: expected `'}'`, found `'\\\\'`\n }\n-"}, {"sha": "ff766ddc8fa67ad132d1d1e137e4fc7ca427760a", "filename": "src/test/ui/fmt/format-string-error.stderr", "status": "modified", "additions": 41, "deletions": 3, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Ftest%2Fui%2Ffmt%2Fformat-string-error.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3f6b3bbace466f4be1311192f335c4c7792a83d2/src%2Ftest%2Fui%2Ffmt%2Fformat-string-error.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Fformat-string-error.stderr?ref=3f6b3bbace466f4be1311192f335c4c7792a83d2", "patch": "@@ -2,7 +2,7 @@ error: invalid format string: expected `'}'` but string was terminated\n   --> $DIR/format-string-error.rs:12:5\n    |\n LL |     println!(\"{\");\n-   |     ^^^^^^^^^^^^^^\n+   |     ^^^^^^^^^^^^^^ expected `'}'` in format string\n    |\n    = note: if you intended to print `{`, you can escape it using `{{`\n    = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)\n@@ -11,10 +11,48 @@ error: invalid format string: unmatched `}` found\n   --> $DIR/format-string-error.rs:14:5\n    |\n LL |     println!(\"}\");\n-   |     ^^^^^^^^^^^^^^\n+   |     ^^^^^^^^^^^^^^ unmatched `}` in format string\n    |\n    = note: if you intended to print `}`, you can escape it using `}}`\n    = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)\n \n-error: aborting due to 2 previous errors\n+error: invalid format string: invalid argument name `_foo`\n+  --> $DIR/format-string-error.rs:15:23\n+   |\n+LL |     let _ = format!(\"{_foo}\", _foo = 6usize);\n+   |                       ^^^^ invalid argument name in format string\n+   |\n+   = note: argument names cannot start with an underscore\n+\n+error: invalid format string: invalid argument name `_`\n+  --> $DIR/format-string-error.rs:17:23\n+   |\n+LL |     let _ = format!(\"{_}\", _ = 6usize);\n+   |                       ^ invalid argument name in format string\n+   |\n+   = note: argument names cannot start with an underscore\n+\n+error: invalid format string: expected `'}'` but string was terminated\n+  --> $DIR/format-string-error.rs:19:23\n+   |\n+LL |     let _ = format!(\"{\");\n+   |                       ^ expected `'}'` in format string\n+   |\n+   = note: if you intended to print `{`, you can escape it using `{{`\n+\n+error: invalid format string: unmatched `}` found\n+  --> $DIR/format-string-error.rs:21:22\n+   |\n+LL |     let _ = format!(\"}\");\n+   |                      ^ unmatched `}` in format string\n+   |\n+   = note: if you intended to print `}`, you can escape it using `}}`\n+\n+error: invalid format string: expected `'}'`, found `'/'`\n+  --> $DIR/format-string-error.rs:23:23\n+   |\n+LL |     let _ = format!(\"{/}\");\n+   |                       ^ expected `}` in format string\n+\n+error: aborting due to 7 previous errors\n "}]}