{"sha": "9f3929551724742c7637553e0fe7ccc0031615c9", "node_id": "C_kwDOAAsO6NoAKDlmMzkyOTU1MTcyNDc0MmM3NjM3NTUzZTBmZTdjY2MwMDMxNjE1Yzk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-20T15:59:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-20T15:59:54Z"}, "message": "Rollup merge of #110565 - weihanglo:linkchecker, r=ehuss\n\nlinkchecker: running from a directory separate from the book\n\nSince rust-lang/cargo#11851, Cargo became a Cargo workspace of\nitself. However, since `src/tools/linkchecker` cannot run inside\na workspace, Cargo needs a workaround that excludes `src/doc`\nfrom workspace member probing.\n\nTo remove this hack, this PR adds a new optional argument `--path`\nfor `linkchecker.sh`. With this new argument, `linkchecker.sh` can\nbe run from a directory separate from the book. This also benefits\nother projects using linkchecker, as they can run it under target\ndirectory or any other directory, reducing leftover.", "tree": {"sha": "ab3f09fbad5172a5fabc9ab70e087c5e56ba849c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ab3f09fbad5172a5fabc9ab70e087c5e56ba849c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9f3929551724742c7637553e0fe7ccc0031615c9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkQWF6CRBK7hj4Ov3rIwAAhSAIAD4DuijeBnQqoXjLTneyGLd0\nCoIQsu9rkaMm60UFeWfN3ZgBWIrMk6ZP4rw5tVAXv1I3TEM6wE2oVsS5R23CnP2q\nYmT5HYYT+faG87oKcpDOPhz0juw2732cjxkYuAI2OgyGOyLI912mIej0H5dqI7IE\n2fYklzqfEyZJgXUJonAtin4vYDvkEtrtceu8L6zE4eF10Qs4AE9GAWE7u0WLsSyG\n9vVyY7461qlezbFKHP/hxKgABh5qLZvaLL1dj3iEiKkD65ERwDgiZWQd2G0uBMsa\nm044GE8fpzMjiG+IRgYuzLwRR+tA+ZAUTya4F82gBkumHGGz8KOBLjkC4jorPqU=\n=QFDO\n-----END PGP SIGNATURE-----\n", "payload": "tree ab3f09fbad5172a5fabc9ab70e087c5e56ba849c\nparent 462461699aa78e08388fb32cf7b4ab05336a5763\nparent 60f17908fa57a8315f8ea7d238e7b3285d8f7d65\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1682006394 +0200\ncommitter GitHub <noreply@github.com> 1682006394 +0200\n\nRollup merge of #110565 - weihanglo:linkchecker, r=ehuss\n\nlinkchecker: running from a directory separate from the book\n\nSince rust-lang/cargo#11851, Cargo became a Cargo workspace of\nitself. However, since `src/tools/linkchecker` cannot run inside\na workspace, Cargo needs a workaround that excludes `src/doc`\nfrom workspace member probing.\n\nTo remove this hack, this PR adds a new optional argument `--path`\nfor `linkchecker.sh`. With this new argument, `linkchecker.sh` can\nbe run from a directory separate from the book. This also benefits\nother projects using linkchecker, as they can run it under target\ndirectory or any other directory, reducing leftover.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9f3929551724742c7637553e0fe7ccc0031615c9", "html_url": "https://github.com/rust-lang/rust/commit/9f3929551724742c7637553e0fe7ccc0031615c9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9f3929551724742c7637553e0fe7ccc0031615c9/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "462461699aa78e08388fb32cf7b4ab05336a5763", "url": "https://api.github.com/repos/rust-lang/rust/commits/462461699aa78e08388fb32cf7b4ab05336a5763", "html_url": "https://github.com/rust-lang/rust/commit/462461699aa78e08388fb32cf7b4ab05336a5763"}, {"sha": "60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "url": "https://api.github.com/repos/rust-lang/rust/commits/60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "html_url": "https://github.com/rust-lang/rust/commit/60f17908fa57a8315f8ea7d238e7b3285d8f7d65"}], "stats": {"total": 26, "additions": 18, "deletions": 8}, "files": [{"sha": "6c1e668a7f0d01772a91ddc961b1f1923c78982b", "filename": "src/tools/linkchecker/linkcheck.sh", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/9f3929551724742c7637553e0fe7ccc0031615c9/src%2Ftools%2Flinkchecker%2Flinkcheck.sh", "raw_url": "https://github.com/rust-lang/rust/raw/9f3929551724742c7637553e0fe7ccc0031615c9/src%2Ftools%2Flinkchecker%2Flinkcheck.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Flinkcheck.sh?ref=9f3929551724742c7637553e0fe7ccc0031615c9", "patch": "@@ -16,15 +16,13 @@\n #\n # --all     Check all books. This can help make sure you don't break links\n #           from other books into your book.\n+#\n+# --path <book-path>\n+#           Path to the root directory for the book. Default to the current\n+#           working directory if omitted.\n \n set -e\n \n-if [ ! -f book.toml ] && [ ! -f src/SUMMARY.md ]\n-then\n-    echo \"Run command in root directory of the book.\"\n-    exit 1\n-fi\n-\n html_dir=\"$(rustc +nightly --print sysroot)/share/doc/rust/html\"\n \n if [ ! -d \"$html_dir\" ]\n@@ -38,6 +36,8 @@ fi\n export MDBOOK_OUTPUT__HTML__INPUT_404=\"\"\n \n book_name=\"\"\n+# Default to the current directory\n+book_path=\".\"\n # Iterative will avoid cleaning up, so you can quickly run it repeatedly.\n iterative=0\n # If \"1\", test all books, else only this book.\n@@ -52,6 +52,10 @@ do\n         --all)\n             all_books=1\n             ;;\n+        --path)\n+            book_path=\"${2:-.}\"\n+            shift\n+            ;;\n         *)\n             if [ -n \"$book_name\" ]\n             then\n@@ -70,6 +74,12 @@ then\n     exit 1\n fi\n \n+if [ ! -f \"$book_path/book.toml\" ] && [ ! -f \"$book_path/src/SUMMARY.md\" ]\n+then\n+    echo \"Run command in root directory of the book or provide a path to the book\"\n+    exit 1\n+fi\n+\n if [ ! -d \"$html_dir/$book_name\" ]\n then\n     echo \"book name \\\"$book_name\\\" not found in sysroot \\\"$html_dir\\\"\"\n@@ -93,11 +103,11 @@ then\n fi\n \n echo \"Building book \\\"$book_name\\\"...\"\n-mdbook build\n+mdbook build \"$book_path\"\n \n cp -R \"$html_dir\" linkcheck\n rm -rf \"linkcheck/$book_name\"\n-cp -R book \"linkcheck/$book_name\"\n+cp -R \"$book_path/book\" \"linkcheck/$book_name\"\n \n if [ \"$all_books\" = \"1\" ]\n then"}]}