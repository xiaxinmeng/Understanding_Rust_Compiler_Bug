{"sha": "299c2fc69554998e8991715d09a611376a5b9cf3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5OWMyZmM2OTU1NDk5OGU4OTkxNzE1ZDA5YTYxMTM3NmE1YjljZjM=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-12-25T02:39:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-25T02:39:35Z"}, "message": "Rollup merge of #80160 - diondokter:move_async_fix, r=davidtwco\n\nImplemented a compiler diagnostic for move async mistake\n\nFixes #79694\n\nFirst time contributing, so I hope I'm doing everything right.\n(If not, please correct me!)\n\nThis code performs a check when a move capture clause is parsed. The check is to detect if the user has reversed the async move keywords and to provide a diagnostic with a suggestion to fix it.\n\nChecked code:\n```rust\nfn main() {\n    move async { };\n}\n```\n\nPrevious output:\n```txt\nPS C:\\Repos\\move_async_test> cargo build\n   Compiling move_async_test v0.1.0 (C:\\Repos\\move_async_test)\nerror: expected one of `|` or `||`, found keyword `async`\n --> src\\main.rs:2:10\n  |\n2 |     move async { };\n  |          ^^^^^ expected one of `|` or `||`\n\nerror: aborting due to previous error\n\nerror: could not compile `move_async_test`\n```\n\nNew output:\n```txt\nPS C:\\Repos\\move_async_test> cargo +dev build\n   Compiling move_async_test v0.1.0 (C:\\Repos\\move_async_test)\nerror: the order of `move` and `async` is incorrect\n --> src\\main.rs:2:13\n  |\n2 |     let _ = move async { };\n  |             ^^^^^^^^^^\n  |\nhelp: try switching the order\n  |\n2 |     let _ = async move { };\n  |             ^^^^^^^^^^\n\nerror: aborting due to previous error\n\nerror: could not compile `move_async_test`\n```\n\nIs there a file/module where these kind of things are tested?\nWould love some feedback \ud83d\ude04", "tree": {"sha": "05641710180166463da5ee00bc85217d0b80f838", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/05641710180166463da5ee00bc85217d0b80f838"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/299c2fc69554998e8991715d09a611376a5b9cf3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf5VDnCRBK7hj4Ov3rIwAAdHIIAK3+XokD0b9mYFfua3Vxgf7J\nxW0qwVvXzzMBpeyD6schJsJynKCjiWU79Zr5mg0zuBkGpFTVz1dSrWJsoonKcQa6\npWxZdJVQ12sLF/Xr+4q8UNWi6G3KqbOhgO4Xn8IygA7aoIBLTrbi30xCx43tPNN+\n50hsGpTa/xwxtCwm/mDX+tzSmsx8RmxRuCfsIhi1bpi8iwj3QaIHSiegx+8q5bpM\nQ+wIC01jJFTshrB58Ahg04U0A/9J8RiJW9jR5R03QEZJ0PS0QAAev0CSnvtekK+o\nw2hnpwG3YazdVu8vwiXj1aToLcK6x61Pzq+EaNjw18kpk7EvCyy3CGMXvZZ2i9M=\n=QUVH\n-----END PGP SIGNATURE-----\n", "payload": "tree 05641710180166463da5ee00bc85217d0b80f838\nparent 787b016957fd10148c6f9ac516348f307748524a\nparent a272d621bc7a2ca61d704fbe531dc532d49ab402\nauthor Dylan DPC <dylan.dpc@gmail.com> 1608863975 +0100\ncommitter GitHub <noreply@github.com> 1608863975 +0100\n\nRollup merge of #80160 - diondokter:move_async_fix, r=davidtwco\n\nImplemented a compiler diagnostic for move async mistake\n\nFixes #79694\n\nFirst time contributing, so I hope I'm doing everything right.\n(If not, please correct me!)\n\nThis code performs a check when a move capture clause is parsed. The check is to detect if the user has reversed the async move keywords and to provide a diagnostic with a suggestion to fix it.\n\nChecked code:\n```rust\nfn main() {\n    move async { };\n}\n```\n\nPrevious output:\n```txt\nPS C:\\Repos\\move_async_test> cargo build\n   Compiling move_async_test v0.1.0 (C:\\Repos\\move_async_test)\nerror: expected one of `|` or `||`, found keyword `async`\n --> src\\main.rs:2:10\n  |\n2 |     move async { };\n  |          ^^^^^ expected one of `|` or `||`\n\nerror: aborting due to previous error\n\nerror: could not compile `move_async_test`\n```\n\nNew output:\n```txt\nPS C:\\Repos\\move_async_test> cargo +dev build\n   Compiling move_async_test v0.1.0 (C:\\Repos\\move_async_test)\nerror: the order of `move` and `async` is incorrect\n --> src\\main.rs:2:13\n  |\n2 |     let _ = move async { };\n  |             ^^^^^^^^^^\n  |\nhelp: try switching the order\n  |\n2 |     let _ = async move { };\n  |             ^^^^^^^^^^\n\nerror: aborting due to previous error\n\nerror: could not compile `move_async_test`\n```\n\nIs there a file/module where these kind of things are tested?\nWould love some feedback \ud83d\ude04\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/299c2fc69554998e8991715d09a611376a5b9cf3", "html_url": "https://github.com/rust-lang/rust/commit/299c2fc69554998e8991715d09a611376a5b9cf3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/299c2fc69554998e8991715d09a611376a5b9cf3/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "787b016957fd10148c6f9ac516348f307748524a", "url": "https://api.github.com/repos/rust-lang/rust/commits/787b016957fd10148c6f9ac516348f307748524a", "html_url": "https://github.com/rust-lang/rust/commit/787b016957fd10148c6f9ac516348f307748524a"}, {"sha": "a272d621bc7a2ca61d704fbe531dc532d49ab402", "url": "https://api.github.com/repos/rust-lang/rust/commits/a272d621bc7a2ca61d704fbe531dc532d49ab402", "html_url": "https://github.com/rust-lang/rust/commit/a272d621bc7a2ca61d704fbe531dc532d49ab402"}], "stats": {"total": 65, "additions": 61, "deletions": 4}, "files": [{"sha": "98c7b9a63a55f60d8f54c0933e0bebdebd04bde8", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/299c2fc69554998e8991715d09a611376a5b9cf3/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/299c2fc69554998e8991715d09a611376a5b9cf3/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=299c2fc69554998e8991715d09a611376a5b9cf3", "patch": "@@ -1912,4 +1912,22 @@ impl<'a> Parser<'a> {\n         *self = snapshot;\n         Err(err)\n     }\n+\n+    /// Get the diagnostics for the cases where `move async` is found.\n+    ///\n+    /// `move_async_span` starts at the 'm' of the move keyword and ends with the 'c' of the async keyword\n+    pub(super) fn incorrect_move_async_order_found(\n+        &self,\n+        move_async_span: Span,\n+    ) -> DiagnosticBuilder<'a> {\n+        let mut err =\n+            self.struct_span_err(move_async_span, \"the order of `move` and `async` is incorrect\");\n+        err.span_suggestion_verbose(\n+            move_async_span,\n+            \"try switching the order\",\n+            \"async move\".to_owned(),\n+            Applicability::MaybeIncorrect,\n+        );\n+        err\n+    }\n }"}, {"sha": "b147f42fada25bfdf368c1ad27e66bba6d280cd5", "filename": "compiler/rustc_parse/src/parser/expr.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/299c2fc69554998e8991715d09a611376a5b9cf3/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/299c2fc69554998e8991715d09a611376a5b9cf3/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs?ref=299c2fc69554998e8991715d09a611376a5b9cf3", "patch": "@@ -1603,7 +1603,7 @@ impl<'a> Parser<'a> {\n             self.sess.gated_spans.gate(sym::async_closure, span);\n         }\n \n-        let capture_clause = self.parse_capture_clause();\n+        let capture_clause = self.parse_capture_clause()?;\n         let decl = self.parse_fn_block_decl()?;\n         let decl_hi = self.prev_token.span;\n         let body = match decl.output {\n@@ -1626,8 +1626,18 @@ impl<'a> Parser<'a> {\n     }\n \n     /// Parses an optional `move` prefix to a closure-like construct.\n-    fn parse_capture_clause(&mut self) -> CaptureBy {\n-        if self.eat_keyword(kw::Move) { CaptureBy::Value } else { CaptureBy::Ref }\n+    fn parse_capture_clause(&mut self) -> PResult<'a, CaptureBy> {\n+        if self.eat_keyword(kw::Move) {\n+            // Check for `move async` and recover\n+            if self.check_keyword(kw::Async) {\n+                let move_async_span = self.token.span.with_lo(self.prev_token.span.data().lo);\n+                Err(self.incorrect_move_async_order_found(move_async_span))\n+            } else {\n+                Ok(CaptureBy::Value)\n+            }\n+        } else {\n+            Ok(CaptureBy::Ref)\n+        }\n     }\n \n     /// Parses the `|arg, arg|` header of a closure.\n@@ -2019,7 +2029,7 @@ impl<'a> Parser<'a> {\n     fn parse_async_block(&mut self, mut attrs: AttrVec) -> PResult<'a, P<Expr>> {\n         let lo = self.token.span;\n         self.expect_keyword(kw::Async)?;\n-        let capture_clause = self.parse_capture_clause();\n+        let capture_clause = self.parse_capture_clause()?;\n         let (iattrs, body) = self.parse_inner_attrs_and_block()?;\n         attrs.extend(iattrs);\n         let kind = ExprKind::Async(capture_clause, DUMMY_NODE_ID, body);"}, {"sha": "055800d23b6c6ee39c287c24f9392dfc20e8ae61", "filename": "src/test/ui/parser/incorrect-move-async-order-issue-79694.fixed", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/299c2fc69554998e8991715d09a611376a5b9cf3/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/299c2fc69554998e8991715d09a611376a5b9cf3/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.fixed?ref=299c2fc69554998e8991715d09a611376a5b9cf3", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+// edition:2018\n+\n+// Regression test for issue 79694\n+\n+fn main() {\n+    let _ = async move { }; //~ ERROR 7:13: 7:23: the order of `move` and `async` is incorrect\n+}"}, {"sha": "e8be16516d6d3dfd50245899d724ddf41474e454", "filename": "src/test/ui/parser/incorrect-move-async-order-issue-79694.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/299c2fc69554998e8991715d09a611376a5b9cf3/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.rs", "raw_url": "https://github.com/rust-lang/rust/raw/299c2fc69554998e8991715d09a611376a5b9cf3/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.rs?ref=299c2fc69554998e8991715d09a611376a5b9cf3", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+// edition:2018\n+\n+// Regression test for issue 79694\n+\n+fn main() {\n+    let _ = move async { }; //~ ERROR 7:13: 7:23: the order of `move` and `async` is incorrect\n+}"}, {"sha": "2add9fb33c70eafe9246d6c85f799bab8b8748e2", "filename": "src/test/ui/parser/incorrect-move-async-order-issue-79694.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/299c2fc69554998e8991715d09a611376a5b9cf3/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/299c2fc69554998e8991715d09a611376a5b9cf3/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fincorrect-move-async-order-issue-79694.stderr?ref=299c2fc69554998e8991715d09a611376a5b9cf3", "patch": "@@ -0,0 +1,13 @@\n+error: the order of `move` and `async` is incorrect\n+  --> $DIR/incorrect-move-async-order-issue-79694.rs:7:13\n+   |\n+LL |     let _ = move async { };\n+   |             ^^^^^^^^^^\n+   |\n+help: try switching the order\n+   |\n+LL |     let _ = async move { };\n+   |             ^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}