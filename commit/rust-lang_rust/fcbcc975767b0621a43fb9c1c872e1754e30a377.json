{"sha": "fcbcc975767b0621a43fb9c1c872e1754e30a377", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjYmNjOTc1NzY3YjA2MjFhNDNmYjljMWM4NzJlMTc1NGUzMGEzNzc=", "commit": {"author": {"name": "Eric Huss", "email": "eric@huss.org", "date": "2021-01-08T21:15:43Z"}, "committer": {"name": "Eric Huss", "email": "eric@huss.org", "date": "2021-01-17T17:51:02Z"}, "message": "Add test for Command::current_dir behavior.", "tree": {"sha": "5e8341d1e03505e90554cf9fbbe4466383a78cde", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e8341d1e03505e90554cf9fbbe4466383a78cde"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fcbcc975767b0621a43fb9c1c872e1754e30a377", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fcbcc975767b0621a43fb9c1c872e1754e30a377", "html_url": "https://github.com/rust-lang/rust/commit/fcbcc975767b0621a43fb9c1c872e1754e30a377", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fcbcc975767b0621a43fb9c1c872e1754e30a377/comments", "author": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a938725ef715b90d0494529142ba8a3264f8e5db", "url": "https://api.github.com/repos/rust-lang/rust/commits/a938725ef715b90d0494529142ba8a3264f8e5db", "html_url": "https://github.com/rust-lang/rust/commit/a938725ef715b90d0494529142ba8a3264f8e5db"}], "stats": {"total": 43, "additions": 43, "deletions": 0}, "files": [{"sha": "a1a72a14958d03f191b0adb35543ff0876957860", "filename": "src/test/ui/command/command-current-dir.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/fcbcc975767b0621a43fb9c1c872e1754e30a377/src%2Ftest%2Fui%2Fcommand%2Fcommand-current-dir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fcbcc975767b0621a43fb9c1c872e1754e30a377/src%2Ftest%2Fui%2Fcommand%2Fcommand-current-dir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcommand%2Fcommand-current-dir.rs?ref=fcbcc975767b0621a43fb9c1c872e1754e30a377", "patch": "@@ -0,0 +1,43 @@\n+// run-pass\n+// ignore-emscripten no processes\n+// ignore-sgx no processes\n+\n+use std::env;\n+use std::fs;\n+use std::path::Path;\n+use std::process::Command;\n+\n+fn main() {\n+    // Checks the behavior of current_dir when used with a relative exe path.\n+    let me = env::current_exe().unwrap();\n+    if matches!(env::args().skip(1).next().as_deref(), Some(\"current-dir\")) {\n+        let cwd = env::current_dir().unwrap();\n+        assert_eq!(cwd.file_name().unwrap(), \"bar\");\n+        std::process::exit(0);\n+    }\n+    let exe = me.file_name().unwrap();\n+    let cwd = std::env::current_dir().unwrap();\n+    eprintln!(\"cwd={:?}\", cwd);\n+    let foo = cwd.join(\"foo\");\n+    let bar = cwd.join(\"bar\");\n+    fs::create_dir_all(&foo).unwrap();\n+    fs::create_dir_all(&bar).unwrap();\n+    fs::copy(&me, foo.join(exe)).unwrap();\n+\n+    // Unfortunately this is inconsistent based on the platform, see\n+    // https://github.com/rust-lang/rust/issues/37868. On Windows,\n+    // it is relative *before* changing the directory, and on Unix\n+    // it is *after* changing the directory.\n+    let relative_exe = if cfg!(windows) {\n+        Path::new(\"foo\").join(exe)\n+    } else {\n+        Path::new(\"../foo\").join(exe)\n+    };\n+\n+    let status = Command::new(relative_exe)\n+        .arg(\"current-dir\")\n+        .current_dir(\"bar\")\n+        .status()\n+        .unwrap();\n+    assert!(status.success());\n+}"}]}