{"sha": "b90a385f26ed16587cb17e28883f5aacd293b9af", "node_id": "C_kwDOAAsO6NoAKGI5MGEzODVmMjZlZDE2NTg3Y2IxN2UyODg4M2Y1YWFjZDI5M2I5YWY", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-02-25T19:53:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-25T19:53:08Z"}, "message": "Rollup merge of #105736 - chenyukang:yukang/add-mir-opt-level-testing, r=jyn514\n\nTest that the compiler/library builds with validate-mir\n\nFixes #105706", "tree": {"sha": "759105a405ab414ce2a55916cf14ef52e1f02a8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/759105a405ab414ce2a55916cf14ef52e1f02a8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b90a385f26ed16587cb17e28883f5aacd293b9af", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj+mckCRBK7hj4Ov3rIwAA74kIAKG2kjQJSwXXjkHrQLmCpe7l\nitFcWal/GYKyL5uETcLovm+7o9nukh2gHWk3fWMwTdFLCoQQ+GgvbC/wvMgukVnf\nfV+0o0/7DrvaV0altx6UpVz0HFTwJIhAVD331fO8MXEJ/X/ISJCJDhquD1gvZ9wx\nCCe9WjjmmM/8vmWE688IZAUeBGWbuiDlHhUipxa7Duhx+8HqMlP0W7WMkI8SW4sy\nzNoLkX35OMS2wVZncBUPzriXVwz2Gsa324x67XVvjLfuvTjiBJLTpMA2ZJBq99F8\nhV45+Jz9ToNSNwfHF296goeO8gowXyCqe6z70ExFTWx8ok3WCEFh/J5NDLk16vU=\n=9Pr6\n-----END PGP SIGNATURE-----\n", "payload": "tree 759105a405ab414ce2a55916cf14ef52e1f02a8b\nparent 31448badfd74ea72d2c8622cc60d3dca889ef7d4\nparent 001bceeb1ecd1239031a5c7ff711106b2b1c54cc\nauthor Michael Goulet <michael@errs.io> 1677354788 -0800\ncommitter GitHub <noreply@github.com> 1677354788 -0800\n\nRollup merge of #105736 - chenyukang:yukang/add-mir-opt-level-testing, r=jyn514\n\nTest that the compiler/library builds with validate-mir\n\nFixes #105706\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b90a385f26ed16587cb17e28883f5aacd293b9af", "html_url": "https://github.com/rust-lang/rust/commit/b90a385f26ed16587cb17e28883f5aacd293b9af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b90a385f26ed16587cb17e28883f5aacd293b9af/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31448badfd74ea72d2c8622cc60d3dca889ef7d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/31448badfd74ea72d2c8622cc60d3dca889ef7d4", "html_url": "https://github.com/rust-lang/rust/commit/31448badfd74ea72d2c8622cc60d3dca889ef7d4"}, {"sha": "001bceeb1ecd1239031a5c7ff711106b2b1c54cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/001bceeb1ecd1239031a5c7ff711106b2b1c54cc", "html_url": "https://github.com/rust-lang/rust/commit/001bceeb1ecd1239031a5c7ff711106b2b1c54cc"}], "stats": {"total": 17, "additions": 16, "deletions": 1}, "files": [{"sha": "69eb228a2d5a0df361a32c06dcc55c1cf4fcc7c5", "filename": "config.toml.example", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b90a385f26ed16587cb17e28883f5aacd293b9af/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/b90a385f26ed16587cb17e28883f5aacd293b9af/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=b90a385f26ed16587cb17e28883f5aacd293b9af", "patch": "@@ -666,6 +666,9 @@ changelog-seen = 2\n # LTO entirely.\n #lto = \"thin-local\"\n \n+# Build compiler with the optimization enabled and -Zvalidate-mir, currently only for `std`\n+#validate-mir-opts = 3\n+\n # =============================================================================\n # Options for specific targets\n #"}, {"sha": "fe92ee3c18ef49e2d5ce84743c50bb5e38e5c495", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b90a385f26ed16587cb17e28883f5aacd293b9af/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b90a385f26ed16587cb17e28883f5aacd293b9af/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=b90a385f26ed16587cb17e28883f5aacd293b9af", "patch": "@@ -1915,6 +1915,13 @@ impl<'a> Builder<'a> {\n             }\n         }\n \n+        if matches!(mode, Mode::Std) {\n+            if let Some(mir_opt_level) = self.config.rust_validate_mir_opts {\n+                rustflags.arg(\"-Zvalidate-mir\");\n+                rustflags.arg(&format!(\"-Zmir-opt-level={}\", mir_opt_level));\n+            }\n+        }\n+\n         Cargo { command: cargo, rustflags, rustdocflags, allow_features }\n     }\n "}, {"sha": "4a563bc396dc42713302593e0331feb380a0c709", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b90a385f26ed16587cb17e28883f5aacd293b9af/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b90a385f26ed16587cb17e28883f5aacd293b9af/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=b90a385f26ed16587cb17e28883f5aacd293b9af", "patch": "@@ -173,6 +173,7 @@ pub struct Config {\n     pub rust_profile_use: Option<String>,\n     pub rust_profile_generate: Option<String>,\n     pub rust_lto: RustcLto,\n+    pub rust_validate_mir_opts: Option<u32>,\n     pub llvm_profile_use: Option<String>,\n     pub llvm_profile_generate: bool,\n     pub llvm_libunwind_default: Option<LlvmLibunwind>,\n@@ -770,6 +771,7 @@ define_config! {\n         // ignored; this is set from an env var set by bootstrap.py\n         download_rustc: Option<StringOrBool> = \"download-rustc\",\n         lto: Option<String> = \"lto\",\n+        validate_mir_opts: Option<u32> = \"validate-mir-opts\",\n     }\n }\n \n@@ -1149,6 +1151,7 @@ impl Config {\n                 .as_deref()\n                 .map(|value| RustcLto::from_str(value).unwrap())\n                 .unwrap_or_default();\n+            config.rust_validate_mir_opts = rust.validate_mir_opts;\n         } else {\n             config.rust_profile_use = flags.rust_profile_use;\n             config.rust_profile_generate = flags.rust_profile_generate;"}, {"sha": "98bd90210d615e40f48f6843f275f3e5db19cd15", "filename": "src/ci/docker/host-x86_64/mingw-check/Dockerfile", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b90a385f26ed16587cb17e28883f5aacd293b9af/src%2Fci%2Fdocker%2Fhost-x86_64%2Fmingw-check%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/b90a385f26ed16587cb17e28883f5aacd293b9af/src%2Fci%2Fdocker%2Fhost-x86_64%2Fmingw-check%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fmingw-check%2FDockerfile?ref=b90a385f26ed16587cb17e28883f5aacd293b9af", "patch": "@@ -23,6 +23,8 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n \n RUN curl -sL https://nodejs.org/dist/v16.9.0/node-v16.9.0-linux-x64.tar.xz | tar -xJ\n ENV PATH=\"/node-v16.9.0-linux-x64/bin:${PATH}\"\n+ENV RUST_CONFIGURE_ARGS=\"--set rust.validate-mir-opts=3\"\n+\n # Install es-check\n # Pin its version to prevent unrelated CI failures due to future es-check versions.\n RUN npm install es-check@6.1.1 eslint@8.6.0 -g\n@@ -38,7 +40,7 @@ COPY host-x86_64/mingw-check/validate-error-codes.sh /scripts/\n \n ENV RUN_CHECK_WITH_PARALLEL_QUERIES 1\n ENV SCRIPT python3 ../x.py --stage 2 test src/tools/expand-yaml-anchors && \\\n-           python3 ../x.py check --target=i686-pc-windows-gnu --host=i686-pc-windows-gnu --all-targets && \\\n+           python3 ../x.py check --target=i686-pc-windows-gnu --host=i686-pc-windows-gnu && \\\n            python3 ../x.py build --stage 0 src/tools/build-manifest && \\\n            python3 ../x.py test --stage 0 src/tools/compiletest && \\\n            python3 ../x.py test --stage 0 core alloc std test proc_macro && \\"}]}