{"sha": "617faa90e5bfd02862681fe29f3bfd24b567a16f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYxN2ZhYTkwZTViZmQwMjg2MjY4MWZlMjlmM2JmZDI0YjU2N2ExNmY=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-10-18T02:47:22Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-10-18T04:54:53Z"}, "message": "Rollup merge of #55031 - nikic:verify_llvm_ir, r=Mark-Simulacrum\n\nImprove verify_llvm_ir config option\n\nLLVM IR verification has been disabled by default in #51230. However, the implementation doesn't quite match what was discussed in the discussion. This patch implements two changes:\n\n* Make `verify_llvm_ir` influence the behavior of the compiled rustc binary, rather than just the rustc build system. That is, if `verify_llvm_ir=true`, even manual invocations of the built rustc will verify LLVM IR.\n* Enable verification of LLVM IR in CI, for non-deploy and deploy-alt builds. This is similar to how LLVM assertions are handled.", "tree": {"sha": "8b4ba6d04b2fb94d38071c774478d0eba713aa3f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b4ba6d04b2fb94d38071c774478d0eba713aa3f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/617faa90e5bfd02862681fe29f3bfd24b567a16f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlvIEh0ACgkQ/vbIBR0O\nATzPtw//eKkJPqwk5dQ7Hm1hApf1ogSUIQ4vhknq1x3YmmCVnR6zNLuzhmNmozTh\n1GJZs/+yb97695XXnd0FcQKl8U6sjRmOmXwYNGBEJxEQA6N0iaOC+3VxlWnrvAuP\nggGMGV8YKDFVJzBZ3WL3Pw0Fu/5obd3lvDjxTFjXzeGuOGw2Dz/8F8iFnMJRU/Sb\n1an5MxFRcvRISEGT08ubXmUzmIXf0HU9J2e93PidO+lpD1Z5pyIW1OiR1exXTuUJ\n57EEuiEpB76SwReJKIVpbur/bn+l5EJx2ebD1ZId3sAoAuiBJ+L6eynGavFhsYCl\nOZbfVUPaIJ/bKQ2IxkzsDtLgIVJZm6jr9AuANXzi/u3pbInjOCrq+xZHjqSSyjY/\ncdpPpfNDW0SwmdHMsYwdg5rYsvx+pOTnwwvREd1z34UlNsBJSyUXA/bUTROwiLr5\nTTG9jPTZqJAdCWYticq31Byk+bYW6G5oThtSLiwUQn8rd/+hX7ByWx5PJNp4+6iP\nRgIPYpmP/KHMUWmCWlz+/RlaxqAh6Nx8OQ0Utp/MZ6bcLr+IyCiUfOuAZt3oetnN\nSbX8qi9rD9hnIgSftHn/gAT7hzNBSBE3FlBFL1IB/H9J258RKmMA10cDMMfB9Acr\niroTuNhEJdjxbKfM6tmCfyp9tFSki5AV0wiIbEzANqni15bfUnM=\n=XUAN\n-----END PGP SIGNATURE-----", "payload": "tree 8b4ba6d04b2fb94d38071c774478d0eba713aa3f\nparent 9ee49bbb88c2c7f4e06a14c95da2e0c0b843abd8\nparent b57366a85457ddf6c5cb8ff4f329776c5311c5a4\nauthor kennytm <kennytm@gmail.com> 1539830842 +0800\ncommitter kennytm <kennytm@gmail.com> 1539838493 +0800\n\nRollup merge of #55031 - nikic:verify_llvm_ir, r=Mark-Simulacrum\n\nImprove verify_llvm_ir config option\n\nLLVM IR verification has been disabled by default in #51230. However, the implementation doesn't quite match what was discussed in the discussion. This patch implements two changes:\n\n* Make `verify_llvm_ir` influence the behavior of the compiled rustc binary, rather than just the rustc build system. That is, if `verify_llvm_ir=true`, even manual invocations of the built rustc will verify LLVM IR.\n* Enable verification of LLVM IR in CI, for non-deploy and deploy-alt builds. This is similar to how LLVM assertions are handled.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/617faa90e5bfd02862681fe29f3bfd24b567a16f", "html_url": "https://github.com/rust-lang/rust/commit/617faa90e5bfd02862681fe29f3bfd24b567a16f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/617faa90e5bfd02862681fe29f3bfd24b567a16f/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ee49bbb88c2c7f4e06a14c95da2e0c0b843abd8", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ee49bbb88c2c7f4e06a14c95da2e0c0b843abd8", "html_url": "https://github.com/rust-lang/rust/commit/9ee49bbb88c2c7f4e06a14c95da2e0c0b843abd8"}, {"sha": "b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "html_url": "https://github.com/rust-lang/rust/commit/b57366a85457ddf6c5cb8ff4f329776c5311c5a4"}], "stats": {"total": 22, "additions": 14, "deletions": 8}, "files": [{"sha": "b6764c1aaeab6a22c3ef8af857c626b01529a601", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=617faa90e5bfd02862681fe29f3bfd24b567a16f", "patch": "@@ -287,10 +287,6 @@ fn main() {\n         cmd.arg(\"--cfg\").arg(\"parallel_queries\");\n     }\n \n-    if env::var_os(\"RUSTC_VERIFY_LLVM_IR\").is_some() {\n-        cmd.arg(\"-Z\").arg(\"verify-llvm-ir\");\n-    }\n-\n     if env::var_os(\"RUSTC_DENY_WARNINGS\").is_some() && env::var_os(\"RUSTC_EXTERNAL_TOOL\").is_none()\n     {\n         cmd.arg(\"-Dwarnings\");"}, {"sha": "aa4e44df2ef9401d53109f404a74bc6baf3ca8cb", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=617faa90e5bfd02862681fe29f3bfd24b567a16f", "patch": "@@ -1000,10 +1000,6 @@ impl<'a> Builder<'a> {\n             cargo.env(\"RUSTC_BACKTRACE_ON_ICE\", \"1\");\n         }\n \n-        if self.config.rust_verify_llvm_ir {\n-            cargo.env(\"RUSTC_VERIFY_LLVM_IR\", \"1\");\n-        }\n-\n         cargo.env(\"RUSTC_VERBOSE\", self.verbosity.to_string());\n \n         // in std, we want to avoid denying warnings for stage 0 as that makes cfg's painful."}, {"sha": "69d45acdedaf9dc0859a2ecca9e315bf78eed70d", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=617faa90e5bfd02862681fe29f3bfd24b567a16f", "patch": "@@ -569,6 +569,9 @@ pub fn rustc_cargo_env(builder: &Builder, cargo: &mut Command) {\n     if builder.config.rustc_parallel_queries {\n         cargo.env(\"RUSTC_PARALLEL_QUERIES\", \"1\");\n     }\n+    if builder.config.rust_verify_llvm_ir {\n+        cargo.env(\"RUSTC_VERIFY_LLVM_IR\", \"1\");\n+    }\n }\n \n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]"}, {"sha": "42561cf95d3ac56342b9c8881e69e132f696b565", "filename": "src/ci/run.sh", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=617faa90e5bfd02862681fe29f3bfd24b567a16f", "patch": "@@ -61,6 +61,7 @@ if [ \"$DEPLOY$DEPLOY_ALT\" != \"\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --disable-llvm-assertions\"\n   elif [ \"$DEPLOY_ALT\" != \"\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-llvm-assertions\"\n+    RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --set rust.verify-llvm-ir\"\n   fi\n else\n   # We almost always want debug assertions enabled, but sometimes this takes too\n@@ -74,6 +75,8 @@ else\n   if [ \"$NO_LLVM_ASSERTIONS\" = \"\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-llvm-assertions\"\n   fi\n+\n+  RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --set rust.verify-llvm-ir\"\n fi\n \n if [ \"$RUST_RELEASE_CHANNEL\" = \"nightly\" ] || [ \"$DIST_REQUIRE_ALL_TOOLS\" = \"\" ]; then"}, {"sha": "bde503d86de739fa7cc5171d87a49856cd28c9d9", "filename": "src/librustc/build.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Flibrustc%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Flibrustc%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fbuild.rs?ref=617faa90e5bfd02862681fe29f3bfd24b567a16f", "patch": "@@ -8,8 +8,15 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use std::env;\n+\n fn main() {\n     println!(\"cargo:rerun-if-changed=build.rs\");\n     println!(\"cargo:rerun-if-env-changed=CFG_LIBDIR_RELATIVE\");\n     println!(\"cargo:rerun-if-env-changed=CFG_COMPILER_HOST_TRIPLE\");\n+    println!(\"cargo:rerun-if-env-changed=RUSTC_VERIFY_LLVM_IR\");\n+\n+    if env::var_os(\"RUSTC_VERIFY_LLVM_IR\").is_some() {\n+        println!(\"cargo:rustc-cfg=always_verify_llvm_ir\");\n+    }\n }"}, {"sha": "2b90a27b6a8ceb2ac0b9b8c704d186f136260d06", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/617faa90e5bfd02862681fe29f3bfd24b567a16f/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=617faa90e5bfd02862681fe29f3bfd24b567a16f", "patch": "@@ -525,6 +525,7 @@ impl Session {\n     }\n     pub fn verify_llvm_ir(&self) -> bool {\n         self.opts.debugging_opts.verify_llvm_ir\n+            || cfg!(always_verify_llvm_ir)\n     }\n     pub fn borrowck_stats(&self) -> bool {\n         self.opts.debugging_opts.borrowck_stats"}]}