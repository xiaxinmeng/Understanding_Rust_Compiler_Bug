{"sha": "bd0c2344f24b96326c304edb0de68457bf28841f", "node_id": "C_kwDOAAsO6NoAKGJkMGMyMzQ0ZjI0Yjk2MzI2YzMwNGVkYjBkZTY4NDU3YmYyODg0MWY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-30T11:29:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-30T11:29:55Z"}, "message": "Auto merge of #12387 - 00nktk:fix-mod-rename, r=Veykril\n\nfix(ide-db): correct single-file module rename\n\nFixes a bug where rust-analyzer would emit `WorkspaceEdit`s with paths to dirs instead of files for the following project layout.\n\nlib.rs\n```rust\nmod foo;\n```\n\nfoo.rs\n```rust\nmod bar {\n    struct Bar;\n}\n```\nAlso fixes emitted paths for modules with mod.rs.\nThe bug resulted in panic in helix editor when attempting to rename a module.", "tree": {"sha": "d51b95aa90a7f7463b886e2a9488e4709aeea9fe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d51b95aa90a7f7463b886e2a9488e4709aeea9fe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd0c2344f24b96326c304edb0de68457bf28841f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd0c2344f24b96326c304edb0de68457bf28841f", "html_url": "https://github.com/rust-lang/rust/commit/bd0c2344f24b96326c304edb0de68457bf28841f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd0c2344f24b96326c304edb0de68457bf28841f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4ead8a7c6b45440b035e18947d8a98946a917c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4ead8a7c6b45440b035e18947d8a98946a917c2", "html_url": "https://github.com/rust-lang/rust/commit/e4ead8a7c6b45440b035e18947d8a98946a917c2"}, {"sha": "d98c04aac17d62ccddf26af501ee9e4d300ab6c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/d98c04aac17d62ccddf26af501ee9e4d300ab6c5", "html_url": "https://github.com/rust-lang/rust/commit/d98c04aac17d62ccddf26af501ee9e4d300ab6c5"}], "stats": {"total": 50, "additions": 42, "deletions": 8}, "files": [{"sha": "f8b01db3e3288df02b49ddd4fc0f09f63ea22a7e", "filename": "crates/hir/src/has_source.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bd0c2344f24b96326c304edb0de68457bf28841f/crates%2Fhir%2Fsrc%2Fhas_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd0c2344f24b96326c304edb0de68457bf28841f/crates%2Fhir%2Fsrc%2Fhas_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fhas_source.rs?ref=bd0c2344f24b96326c304edb0de68457bf28841f", "patch": "@@ -39,6 +39,11 @@ impl Module {\n         }\n     }\n \n+    pub fn is_inline(self, db: &dyn HirDatabase) -> bool {\n+        let def_map = self.id.def_map(db.upcast());\n+        def_map[self.id.local_id].origin.is_inline()\n+    }\n+\n     /// Returns a node which declares this module, either a `mod foo;` or a `mod foo {}`.\n     /// `None` for the crate root.\n     pub fn declaration_source(self, db: &dyn HirDatabase) -> Option<InFile<ast::Module>> {"}, {"sha": "8f83496e938be89c8f5be603da6e09a6f691ee3f", "filename": "crates/ide-db/src/rename.rs", "status": "modified", "additions": 24, "deletions": 6, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/bd0c2344f24b96326c304edb0de68457bf28841f/crates%2Fide-db%2Fsrc%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd0c2344f24b96326c304edb0de68457bf28841f/crates%2Fide-db%2Fsrc%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Frename.rs?ref=bd0c2344f24b96326c304edb0de68457bf28841f", "patch": "@@ -180,15 +180,33 @@ fn rename_mod(\n     let InFile { file_id, value: def_source } = module.definition_source(sema.db);\n     if let ModuleSource::SourceFile(..) = def_source {\n         let anchor = file_id.original_file(sema.db);\n-        // not mod.rs and doesn't has children, rename file only\n-        if !module.is_mod_rs(sema.db) && module.children(sema.db).next().is_none() {\n+\n+        let is_mod_rs = module.is_mod_rs(sema.db);\n+        let has_detached_child = module.children(sema.db).any(|child| !child.is_inline(sema.db));\n+\n+        // Module exists in a named file\n+        if !is_mod_rs {\n             let path = format!(\"{}.rs\", new_name);\n             let dst = AnchoredPathBuf { anchor, path };\n             source_change.push_file_system_edit(FileSystemEdit::MoveFile { src: anchor, dst })\n-        } else if let Some(mod_name) = module.name(sema.db) {\n-            // is mod.rs or has children, rename dir\n-            let src = AnchoredPathBuf { anchor, path: mod_name.to_string() };\n-            let dst = AnchoredPathBuf { anchor, path: new_name.to_string() };\n+        }\n+\n+        // Rename the dir if:\n+        //  - Module source is in mod.rs\n+        //  - Module has submodules defined in separate files\n+        let dir_paths = match (is_mod_rs, has_detached_child, module.name(sema.db)) {\n+            // Go up one level since the anchor is inside the dir we're trying to rename\n+            (true, _, Some(mod_name)) => {\n+                Some((format!(\"../{}\", mod_name), format!(\"../{}\", new_name)))\n+            }\n+            // The anchor is on the same level as target dir\n+            (false, true, Some(mod_name)) => Some((mod_name.to_string(), new_name.to_string())),\n+            _ => None,\n+        };\n+\n+        if let Some((src, dst)) = dir_paths {\n+            let src = AnchoredPathBuf { anchor, path: src };\n+            let dst = AnchoredPathBuf { anchor, path: dst };\n             source_change.push_file_system_edit(FileSystemEdit::MoveDir {\n                 src,\n                 src_id: anchor,"}, {"sha": "0f8033611a197e2a6d21872221520197719b61ef", "filename": "crates/ide/src/rename.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/bd0c2344f24b96326c304edb0de68457bf28841f/crates%2Fide%2Fsrc%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd0c2344f24b96326c304edb0de68457bf28841f/crates%2Fide%2Fsrc%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Frename.rs?ref=bd0c2344f24b96326c304edb0de68457bf28841f", "patch": "@@ -973,7 +973,7 @@ mod fo$0o;\n                                 anchor: FileId(\n                                     1,\n                                 ),\n-                                path: \"foo\",\n+                                path: \"../foo\",\n                             },\n                             src_id: FileId(\n                                 1,\n@@ -982,7 +982,7 @@ mod fo$0o;\n                                 anchor: FileId(\n                                     1,\n                                 ),\n-                                path: \"foo2\",\n+                                path: \"../foo2\",\n                             },\n                         },\n                     ],\n@@ -1158,6 +1158,17 @@ mod quux;\n                         },\n                     },\n                     file_system_edits: [\n+                        MoveFile {\n+                            src: FileId(\n+                                1,\n+                            ),\n+                            dst: AnchoredPathBuf {\n+                                anchor: FileId(\n+                                    1,\n+                                ),\n+                                path: \"foo2.rs\",\n+                            },\n+                        },\n                         MoveDir {\n                             src: AnchoredPathBuf {\n                                 anchor: FileId("}]}