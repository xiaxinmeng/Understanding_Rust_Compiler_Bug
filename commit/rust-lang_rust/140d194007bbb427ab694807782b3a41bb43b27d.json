{"sha": "140d194007bbb427ab694807782b3a41bb43b27d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0MGQxOTQwMDdiYmI0MjdhYjY5NDgwNzc4MmIzYTQxYmI0M2IyN2Q=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2012-03-16T14:14:33Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2012-03-16T14:14:44Z"}, "message": "make it possible to use snapshot core lib", "tree": {"sha": "0d79ec01c8f9add7c870eaa69b80f0df3da94b43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0d79ec01c8f9add7c870eaa69b80f0df3da94b43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/140d194007bbb427ab694807782b3a41bb43b27d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/140d194007bbb427ab694807782b3a41bb43b27d", "html_url": "https://github.com/rust-lang/rust/commit/140d194007bbb427ab694807782b3a41bb43b27d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/140d194007bbb427ab694807782b3a41bb43b27d/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15a325f26711d1d0161a9e199685ff2fb10fe870", "url": "https://api.github.com/repos/rust-lang/rust/commits/15a325f26711d1d0161a9e199685ff2fb10fe870", "html_url": "https://github.com/rust-lang/rust/commit/15a325f26711d1d0161a9e199685ff2fb10fe870"}], "stats": {"total": 68, "additions": 51, "deletions": 17}, "files": [{"sha": "34470e99f649056637a9da7a3560ff510be8f992", "filename": "mk/target.mk", "status": "modified", "additions": 51, "deletions": 17, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/140d194007bbb427ab694807782b3a41bb43b27d/mk%2Ftarget.mk", "raw_url": "https://github.com/rust-lang/rust/raw/140d194007bbb427ab694807782b3a41bb43b27d/mk%2Ftarget.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Ftarget.mk?ref=140d194007bbb427ab694807782b3a41bb43b27d", "patch": "@@ -4,10 +4,12 @@\n # $(2) is the target triple\n # $(3) is the host triple\n \n-# If you are making non-backwards compatible changes to the runtime,\n-# set this flag to 1.  It will cause stage1 to use the snapshot\n-# runtime rather than the runtime from the working directory.\n+# If you are making non-backwards compatible changes to the runtime\n+# (resp.  corelib), set this flag to 1.  It will cause stage1 to use\n+# the snapshot runtime (resp. corelib) rather than the runtime\n+# (resp. corelib) from the working directory.\n USE_SNAPSHOT_RUNTIME=0\n+USE_SNAPSHOT_CORELIB=0\n \n # Do not use --enforce-mut-vars in stage0, for now, as the snapshot\n # has an older version of the check.\n@@ -34,15 +36,9 @@ $$(TLIB$(1)_T_$(2)_H_$(3))/libmorestack.a: \\\n \t@$$(call E, cp: $$@)\n \t$$(Q)cp $$< $$@\n \n-$$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_CORELIB): \\\n-\t\t$$(CORELIB_CRATE) $$(CORELIB_INPUTS) \\\n-\t\t$$(TSREQ$(1)_T_$(2)_H_$(3))\n-\t@$$(call E, compile_and_link: $$@)\n-\t$$(STAGE$(1)_T_$(2)_H_$(3)) --enforce-mut-vars -o $$@ $$< && touch $$@\n-\n $$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_STDLIB): \\\n \t\t$$(STDLIB_CRATE) $$(STDLIB_INPUTS) \\\n-        $$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_CORELIB) \\\n+\t        $$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_CORELIB) \\\n \t\t$$(TSREQ$(1)_T_$(2)_H_$(3))\n \t@$$(call E, compile_and_link: $$@)\n \t$$(STAGE$(1)_T_$(2)_H_$(3)) $$(ENFORCE_MUT_VARS_$(1)) \\\n@@ -107,9 +103,35 @@ $$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_RUNTIME): \\\n \n endef\n \n+# As above, but builds the corelib either by taking it out of the\n+# snapshot or from the working directory.\n+\n+define TARGET_CORELIB_FROM_SNAPSHOT\n+\n+$$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_CORELIB): \\\n+\t\t$$(HLIB$(1)_H_$(3))/$$(CFG_CORELIB) \\\n+\t\t$$(CORELIB_INPUTS) \\\n+\t\t$$(TSREQ$(1)_T_$(2)_H_$(3))\n+\t@$$(call E, cp: $$@)\n+\t$$(Q)cp $$< $$@\n+\t$$(Q)cp $$(HLIB$(1)_H_$(3))/$$(CORELIB_GLOB) \\\n+\t\t$$(TLIB$(1)_T_$(2)_H_$(3))\n+\n+endef\n+\n+define TARGET_CORELIB_FROM_WD\n+\n+$$(TLIB$(1)_T_$(2)_H_$(3))/$$(CFG_CORELIB): \\\n+\t\t$$(CORELIB_CRATE) $$(CORELIB_INPUTS) \\\n+\t\t$$(TSREQ$(1)_T_$(2)_H_$(3))\n+\t@$$(call E, compile_and_link: $$@)\n+\t$$(STAGE$(1)_T_$(2)_H_$(3)) --enforce-mut-vars -o $$@ $$< && touch $$@\n+\n+endef\n+\n # In principle, each host can build each target:\n-$(foreach source,$(CFG_TARGET_TRIPLES),\t\t\t\t\t\t\\\n- $(foreach target,$(CFG_TARGET_TRIPLES),\t\t\t\t\t\\\n+$(foreach source,$(CFG_TARGET_TRIPLES),\t\t\t\t\\\n+ $(foreach target,$(CFG_TARGET_TRIPLES),\t\t\t\\\n   $(eval $(call TARGET_STAGE_N,0,$(target),$(source)))\t\t\\\n   $(eval $(call TARGET_STAGE_N,1,$(target),$(source)))\t\t\\\n   $(eval $(call TARGET_STAGE_N,2,$(target),$(source)))\t\t\\\n@@ -125,15 +147,27 @@ else\n \t\t$(eval $(call TARGET_RT_FROM_WD,0,$(src),$(src))))\n endif\n \n+ifeq ($(USE_SNAPSHOT_CORELIB),1)\n+    $(foreach src,$(CFG_HOST_TRIPLE),\\\n+\t\t$(eval $(call TARGET_CORELIB_FROM_SNAPSHOT,0,$(src),$(src))))\n+else \n+    $(foreach src,$(CFG_HOST_TRIPLE),\\\n+\t\t$(eval $(call TARGET_CORELIB_FROM_WD,0,$(src),$(src))))\n+endif\n+\n # Non-host triples build the stage0 runtime from the working directory\n-$(foreach source,$(CFG_TARGET_TRIPLES),\t\t\t\t\t\t\\\n- $(foreach target,$(NON_HOST_TRIPLES),\t\t\t\t\t\\\n+$(foreach source,$(CFG_TARGET_TRIPLES),\t\t\t\t\\\n+ $(foreach target,$(NON_HOST_TRIPLES),\t\t\t\t\\\n   $(eval $(call TARGET_RT_FROM_WD,0,$(target),$(source)))))\n \n # After stage0, always build the stage0 runtime from the working directory\n-$(foreach source,$(CFG_TARGET_TRIPLES),\t\t\t\t\t\t\\\n- $(foreach target,$(CFG_TARGET_TRIPLES),\t\t\t\t\t\\\n+$(foreach source,$(CFG_TARGET_TRIPLES),\t\t\t\t\\\n+ $(foreach target,$(CFG_TARGET_TRIPLES),\t\t\t\\\n   $(eval $(call TARGET_RT_FROM_WD,1,$(target),$(source)))\t\\\n   $(eval $(call TARGET_RT_FROM_WD,2,$(target),$(source)))\t\\\n-  $(eval $(call TARGET_RT_FROM_WD,3,$(target),$(source)))))\n+  $(eval $(call TARGET_RT_FROM_WD,3,$(target),$(source)))  \t\\\n+  $(eval $(call TARGET_CORELIB_FROM_WD,1,$(target),$(source)))\t\\\n+  $(eval $(call TARGET_CORELIB_FROM_WD,2,$(target),$(source)))\t\\\n+  $(eval $(call TARGET_CORELIB_FROM_WD,3,$(target),$(source)))\t\\\n+))\n "}]}