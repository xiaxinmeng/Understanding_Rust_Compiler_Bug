{"sha": "50fb57bb107b302f7d164e22aa75c8c2a2d48756", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwZmI1N2JiMTA3YjMwMmY3ZDE2NGUyMmFhNzVjOGMyYTJkNDg3NTY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-19T17:33:46Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-19T17:33:46Z"}, "message": "rustc: Ensure closures are \"split-stack\"\n\nIn upgrading LLVM, only rust functions had the \"split-stack\" attribute added.\nThis commit changes the addition of LLVM's \"split-stack\" attribute to *always*\noccur and then we remove it sometimes if the \"no_split_stack\" rust attribute is\npresent.\n\nCloses #13625", "tree": {"sha": "85677a3099045450ce4ff4ffe35f0ceef068813d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85677a3099045450ce4ff4ffe35f0ceef068813d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/50fb57bb107b302f7d164e22aa75c8c2a2d48756", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/50fb57bb107b302f7d164e22aa75c8c2a2d48756", "html_url": "https://github.com/rust-lang/rust/commit/50fb57bb107b302f7d164e22aa75c8c2a2d48756", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/50fb57bb107b302f7d164e22aa75c8c2a2d48756/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba25fecfeffdbc96d31172f483bd20cffa635b3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba25fecfeffdbc96d31172f483bd20cffa635b3e", "html_url": "https://github.com/rust-lang/rust/commit/ba25fecfeffdbc96d31172f483bd20cffa635b3e"}], "stats": {"total": 24, "additions": 22, "deletions": 2}, "files": [{"sha": "9e652536f6d21907680181c96fc0cf1baae7a06d", "filename": "src/librustc/lib/llvm.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50fb57bb107b302f7d164e22aa75c8c2a2d48756/src%2Flibrustc%2Flib%2Fllvm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50fb57bb107b302f7d164e22aa75c8c2a2d48756/src%2Flibrustc%2Flib%2Fllvm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib%2Fllvm.rs?ref=50fb57bb107b302f7d164e22aa75c8c2a2d48756", "patch": "@@ -709,6 +709,7 @@ pub mod llvm {\n         pub fn LLVMSetGC(Fn: ValueRef, Name: *c_char);\n         pub fn LLVMAddFunctionAttr(Fn: ValueRef, PA: c_uint);\n         pub fn LLVMAddFunctionAttrString(Fn: ValueRef, Name: *c_char);\n+        pub fn LLVMRemoveFunctionAttrString(Fn: ValueRef, Name: *c_char);\n         pub fn LLVMGetFunctionAttr(Fn: ValueRef) -> c_ulonglong;\n \n         pub fn LLVMAddReturnAttribute(Fn: ValueRef, PA: c_uint);"}, {"sha": "735b60622ed62572f3e4c4eb18556469c535dafa", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/50fb57bb107b302f7d164e22aa75c8c2a2d48756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50fb57bb107b302f7d164e22aa75c8c2a2d48756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=50fb57bb107b302f7d164e22aa75c8c2a2d48756", "patch": "@@ -199,6 +199,7 @@ fn decl_fn(llmod: ModuleRef, name: &str, cc: lib::llvm::CallConv,\n     lib::llvm::SetFunctionCallConv(llfn, cc);\n     // Function addresses in Rust are never significant, allowing functions to be merged.\n     lib::llvm::SetUnnamedAddr(llfn, true);\n+    set_split_stack(llfn);\n \n     llfn\n }\n@@ -445,8 +446,8 @@ pub fn set_llvm_fn_attrs(attrs: &[ast::Attribute], llfn: ValueRef) {\n     }\n \n     // Add the no-split-stack attribute if requested\n-    if !contains_name(attrs, \"no_split_stack\") {\n-        set_split_stack(llfn);\n+    if contains_name(attrs, \"no_split_stack\") {\n+        unset_split_stack(llfn);\n     }\n \n     if contains_name(attrs, \"cold\") {\n@@ -464,6 +465,12 @@ pub fn set_split_stack(f: ValueRef) {\n     })\n }\n \n+pub fn unset_split_stack(f: ValueRef) {\n+    \"split-stack\".with_c_str(|buf| {\n+        unsafe { llvm::LLVMRemoveFunctionAttrString(f, buf); }\n+    })\n+}\n+\n // Double-check that we never ask LLVM to declare the same symbol twice. It\n // silently mangles such symbols, breaking our linkage model.\n pub fn note_unique_llvm_symbol(ccx: &CrateContext, sym: ~str) {"}, {"sha": "3fe1b1380da01498eedcbeda9fbf8db3628d82b4", "filename": "src/rustllvm/RustWrapper.cpp", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/50fb57bb107b302f7d164e22aa75c8c2a2d48756/src%2Frustllvm%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/50fb57bb107b302f7d164e22aa75c8c2a2d48756/src%2Frustllvm%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FRustWrapper.cpp?ref=50fb57bb107b302f7d164e22aa75c8c2a2d48756", "patch": "@@ -77,6 +77,18 @@ extern \"C\" void LLVMAddFunctionAttrString(LLVMValueRef fn, const char *Name) {\n   unwrap<Function>(fn)->addFnAttr(Name);\n }\n \n+extern \"C\" void LLVMRemoveFunctionAttrString(LLVMValueRef fn, const char *Name) {\n+  Function *f = unwrap<Function>(fn);\n+  LLVMContext &C = f->getContext();\n+  AttrBuilder B;\n+  B.addAttribute(Name);\n+  AttributeSet to_remove = AttributeSet::get(C, AttributeSet::FunctionIndex, B);\n+\n+  AttributeSet attrs = f->getAttributes();\n+  f->setAttributes(attrs.removeAttributes(f->getContext(),\n+                                          AttributeSet::FunctionIndex,\n+                                          to_remove));\n+}\n \n extern \"C\" void LLVMAddReturnAttribute(LLVMValueRef Fn, LLVMAttribute PA) {\n   Function *A = unwrap<Function>(Fn);"}]}