{"sha": "138973335aba835a451ce7c9914c7ca020bcc753", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEzODk3MzMzNWFiYTgzNWE0NTFjZTdjOTkxNGM3Y2EwMjBiY2M3NTM=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-08-26T05:11:42Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-08-27T22:54:44Z"}, "message": "Add std::istr::as_buf for converting to cstrs. Issue #855", "tree": {"sha": "650da654e1d6cba0d2bd19c5c3686958a285c695", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/650da654e1d6cba0d2bd19c5c3686958a285c695"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/138973335aba835a451ce7c9914c7ca020bcc753", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/138973335aba835a451ce7c9914c7ca020bcc753", "html_url": "https://github.com/rust-lang/rust/commit/138973335aba835a451ce7c9914c7ca020bcc753", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/138973335aba835a451ce7c9914c7ca020bcc753/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7284f820d57e13b10fd9f1c3fc771fac52b6b66a", "url": "https://api.github.com/repos/rust-lang/rust/commits/7284f820d57e13b10fd9f1c3fc771fac52b6b66a", "html_url": "https://github.com/rust-lang/rust/commit/7284f820d57e13b10fd9f1c3fc771fac52b6b66a"}], "stats": {"total": 41, "additions": 38, "deletions": 3}, "files": [{"sha": "256e76d0041b4d3e1124f443ea2e38b726b27228", "filename": "src/lib/istr.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/138973335aba835a451ce7c9914c7ca020bcc753/src%2Flib%2Fistr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/138973335aba835a451ce7c9914c7ca020bcc753/src%2Flib%2Fistr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib%2Fistr.rs?ref=138973335aba835a451ce7c9914c7ca020bcc753", "patch": "@@ -3,7 +3,8 @@ index, rindex, find, starts_with, ends_with, substr, slice, split,\n concat, connect, to_upper, replace, char_slice, trim_left, trim_right, trim,\n unshift_char, shift_char, pop_char, push_char, is_utf8, from_chars, to_chars,\n char_len, char_at, bytes, is_ascii, shift_byte, pop_byte, unsafe_from_byte,\n-unsafe_from_bytes, from_char, char_range_at, str_from_cstr;\n+unsafe_from_bytes, from_char, char_range_at, str_from_cstr, sbuf,\n+as_buf;\n \n export from_estr, to_estr, from_estrs, to_estrs;\n \n@@ -467,7 +468,21 @@ fn trim(s: &istr) -> istr {\n     trim_left(trim_right(s))\n }\n \n-fn str_from_cstr(cstr: *u8) -> istr {\n+type sbuf = *u8;\n+\n+fn buf(s: &istr) -> sbuf {\n+    let saddr = ptr::addr_of(s);\n+    let vaddr: *[u8] = unsafe::reinterpret_cast(saddr);\n+    let buf = vec::to_ptr(*vaddr);\n+    ret buf;\n+}\n+\n+fn as_buf<T>(s: &istr, f: &block(sbuf) -> T) -> T {\n+    let buf = buf(s);\n+    f(buf)\n+}\n+\n+fn str_from_cstr(cstr: sbuf) -> istr {\n     let res = ~\"\";\n     let start = cstr;\n     let curr = start;"}, {"sha": "32497a8858b0d7e0d237880bcd5e196cf7f0a9f8", "filename": "src/test/stdtest/istr.rs", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/138973335aba835a451ce7c9914c7ca020bcc753/src%2Ftest%2Fstdtest%2Fistr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/138973335aba835a451ce7c9914c7ca020bcc753/src%2Ftest%2Fstdtest%2Fistr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fstdtest%2Fistr.rs?ref=138973335aba835a451ce7c9914c7ca020bcc753", "patch": "@@ -264,4 +264,24 @@ fn str_from_cstr() {\n     let b = vec::to_ptr(a);\n     let c = istr::str_from_cstr(b);\n     assert c == ~\"AAAAAAA\";\n-}\n\\ No newline at end of file\n+}\n+\n+#[test]\n+fn as_buf() {\n+    let a = ~\"Abcdefg\";\n+    let b = istr::as_buf(a, { |buf|\n+        assert *buf == 65u8;\n+        100\n+    });\n+    assert b == 100;\n+}\n+\n+#[test]\n+fn as_buf_small() {\n+    let a = ~\"A\";\n+    let b = istr::as_buf(a, { |buf|\n+        assert *buf == 65u8;\n+        100\n+    });\n+    assert b == 100;\n+}"}]}