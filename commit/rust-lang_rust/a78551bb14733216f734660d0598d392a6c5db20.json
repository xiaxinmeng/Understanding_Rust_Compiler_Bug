{"sha": "a78551bb14733216f734660d0598d392a6c5db20", "node_id": "C_kwDOAAsO6NoAKGE3ODU1MWJiMTQ3MzMyMTZmNzM0NjYwZDA1OThkMzkyYTZjNWRiMjA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-30T16:42:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-30T16:42:55Z"}, "message": "Auto merge of #9556 - evantypanski:et/issue-9369, r=Alexendoo\n\n[`redundant_closure`] Fix suggestion causes error for `impl FnMut`\n\nFixes #9369\n\nchangelog: [`redundant_closure`] Fix suggestion causes error with `impl FnMut` types", "tree": {"sha": "3edb7b2dcfb3150efb9c808bf48852f7187079dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3edb7b2dcfb3150efb9c808bf48852f7187079dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a78551bb14733216f734660d0598d392a6c5db20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a78551bb14733216f734660d0598d392a6c5db20", "html_url": "https://github.com/rust-lang/rust/commit/a78551bb14733216f734660d0598d392a6c5db20", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a78551bb14733216f734660d0598d392a6c5db20/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5f25f7e6053558e06c099603337d39d2de106299", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f25f7e6053558e06c099603337d39d2de106299", "html_url": "https://github.com/rust-lang/rust/commit/5f25f7e6053558e06c099603337d39d2de106299"}, {"sha": "dbadf37336825faae9c14814eace50468da06b48", "url": "https://api.github.com/repos/rust-lang/rust/commits/dbadf37336825faae9c14814eace50468da06b48", "html_url": "https://github.com/rust-lang/rust/commit/dbadf37336825faae9c14814eace50468da06b48"}], "stats": {"total": 61, "additions": 51, "deletions": 10}, "files": [{"sha": "3732410e71e57a9338ef71b6ab3a9e3f562c3789", "filename": "clippy_lints/src/eta_reduction.rs", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/a78551bb14733216f734660d0598d392a6c5db20/clippy_lints%2Fsrc%2Feta_reduction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a78551bb14733216f734660d0598d392a6c5db20/clippy_lints%2Fsrc%2Feta_reduction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Feta_reduction.rs?ref=a78551bb14733216f734660d0598d392a6c5db20", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::{span_lint_and_sugg, span_lint_and_then};\n use clippy_utils::higher::VecArgs;\n use clippy_utils::source::snippet_opt;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::{implements_trait, is_type_diagnostic_item};\n use clippy_utils::usage::local_used_after_expr;\n use clippy_utils::{higher, is_adjusted, path_to_local, path_to_local_id};\n use if_chain::if_chain;\n@@ -11,7 +11,7 @@ use rustc_hir::{Closure, Expr, ExprKind, Param, PatKind, Unsafety};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::ty::adjustment::{Adjust, Adjustment, AutoBorrow};\n use rustc_middle::ty::binding::BindingMode;\n-use rustc_middle::ty::{self, ClosureKind, Ty, TypeVisitable};\n+use rustc_middle::ty::{self, Ty, TypeVisitable};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::symbol::sym;\n \n@@ -122,15 +122,12 @@ impl<'tcx> LateLintPass<'tcx> for EtaReduction {\n             then {\n                 span_lint_and_then(cx, REDUNDANT_CLOSURE, expr.span, \"redundant closure\", |diag| {\n                     if let Some(mut snippet) = snippet_opt(cx, callee.span) {\n-                        if_chain! {\n-                            if let ty::Closure(_, substs) = callee_ty.peel_refs().kind();\n-                            if substs.as_closure().kind() == ClosureKind::FnMut;\n-                            if path_to_local(callee).map_or(false, |l| local_used_after_expr(cx, l, expr));\n-\n-                            then {\n+                        if let Some(fn_mut_id) = cx.tcx.lang_items().fn_mut_trait()\n+                            && implements_trait(cx, callee_ty.peel_refs(), fn_mut_id, &[])\n+                            && path_to_local(callee).map_or(false, |l| local_used_after_expr(cx, l, expr))\n+                        {\n                                 // Mutable closure is used after current expr; we cannot consume it.\n                                 snippet = format!(\"&mut {snippet}\");\n-                            }\n                         }\n                         diag.span_suggestion(\n                             expr.span,"}, {"sha": "e257b3b3afa6f7c0bda4152ebc4c5c016d85a831", "filename": "tests/ui/eta.fixed", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a78551bb14733216f734660d0598d392a6c5db20/tests%2Fui%2Feta.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a78551bb14733216f734660d0598d392a6c5db20/tests%2Fui%2Feta.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.fixed?ref=a78551bb14733216f734660d0598d392a6c5db20", "patch": "@@ -303,3 +303,16 @@ fn not_general_enough() {\n     fn f(_: impl FnMut(&Path) -> std::io::Result<()>) {}\n     f(|path| std::fs::remove_file(path));\n }\n+\n+// https://github.com/rust-lang/rust-clippy/issues/9369\n+pub fn mutable_impl_fn_mut(mut f: impl FnMut(), mut f_used_once: impl FnMut()) -> impl FnMut() {\n+    fn takes_fn_mut(_: impl FnMut()) {}\n+    takes_fn_mut(&mut f);\n+\n+    fn takes_fn_once(_: impl FnOnce()) {}\n+    takes_fn_once(&mut f);\n+\n+    f();\n+\n+    move || takes_fn_mut(&mut f_used_once)\n+}"}, {"sha": "486a251f30b0e5f5ec820acebab7936d1c84999c", "filename": "tests/ui/eta.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a78551bb14733216f734660d0598d392a6c5db20/tests%2Fui%2Feta.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a78551bb14733216f734660d0598d392a6c5db20/tests%2Fui%2Feta.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.rs?ref=a78551bb14733216f734660d0598d392a6c5db20", "patch": "@@ -303,3 +303,16 @@ fn not_general_enough() {\n     fn f(_: impl FnMut(&Path) -> std::io::Result<()>) {}\n     f(|path| std::fs::remove_file(path));\n }\n+\n+// https://github.com/rust-lang/rust-clippy/issues/9369\n+pub fn mutable_impl_fn_mut(mut f: impl FnMut(), mut f_used_once: impl FnMut()) -> impl FnMut() {\n+    fn takes_fn_mut(_: impl FnMut()) {}\n+    takes_fn_mut(|| f());\n+\n+    fn takes_fn_once(_: impl FnOnce()) {}\n+    takes_fn_once(|| f());\n+\n+    f();\n+\n+    move || takes_fn_mut(|| f_used_once())\n+}"}, {"sha": "434706b7e258f07d70cd75e9523b4807c06a739c", "filename": "tests/ui/eta.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a78551bb14733216f734660d0598d392a6c5db20/tests%2Fui%2Feta.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a78551bb14733216f734660d0598d392a6c5db20/tests%2Fui%2Feta.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.stderr?ref=a78551bb14733216f734660d0598d392a6c5db20", "patch": "@@ -116,5 +116,23 @@ error: redundant closure\n LL |         Some(1).map(|n| in_loop(n));\n    |                     ^^^^^^^^^^^^^^ help: replace the closure with the function itself: `in_loop`\n \n-error: aborting due to 19 previous errors\n+error: redundant closure\n+  --> $DIR/eta.rs:310:18\n+   |\n+LL |     takes_fn_mut(|| f());\n+   |                  ^^^^^^ help: replace the closure with the function itself: `&mut f`\n+\n+error: redundant closure\n+  --> $DIR/eta.rs:313:19\n+   |\n+LL |     takes_fn_once(|| f());\n+   |                   ^^^^^^ help: replace the closure with the function itself: `&mut f`\n+\n+error: redundant closure\n+  --> $DIR/eta.rs:317:26\n+   |\n+LL |     move || takes_fn_mut(|| f_used_once())\n+   |                          ^^^^^^^^^^^^^^^^ help: replace the closure with the function itself: `&mut f_used_once`\n+\n+error: aborting due to 22 previous errors\n "}]}