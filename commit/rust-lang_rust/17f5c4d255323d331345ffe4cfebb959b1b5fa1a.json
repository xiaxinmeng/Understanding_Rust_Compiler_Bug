{"sha": "17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "node_id": "C_kwDOAAsO6NoAKDE3ZjVjNGQyNTUzMjNkMzMxMzQ1ZmZlNGNmZWJiOTU5YjFiNWZhMWE", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-04-02T03:24:32Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-04-07T02:28:27Z"}, "message": "Fix unit struct/enum variant in destructuring assignment", "tree": {"sha": "d8f8c010c0e0f55bcf6a788339d5fce53d6798bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8f8c010c0e0f55bcf6a788339d5fce53d6798bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "html_url": "https://github.com/rust-lang/rust/commit/17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f36334ca939a67cce3f37f24953ff6f2d3f3d33", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f36334ca939a67cce3f37f24953ff6f2d3f3d33", "html_url": "https://github.com/rust-lang/rust/commit/8f36334ca939a67cce3f37f24953ff6f2d3f3d33"}], "stats": {"total": 87, "additions": 80, "deletions": 7}, "files": [{"sha": "c9dc36b785e4ec125ea5d3b1302c20368c2f8b54", "filename": "compiler/rustc_ast_lowering/src/expr.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs?ref=17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "patch": "@@ -1020,6 +1020,28 @@ impl<'hir> LoweringContext<'_, 'hir> {\n         None\n     }\n \n+    /// If the given expression is a path to a unit struct, returns that path.\n+    /// It is not a complete check, but just tries to reject most paths early\n+    /// if they are not unit structs.\n+    /// Type checking will take care of the full validation later.\n+    fn extract_unit_struct_path<'a>(\n+        &mut self,\n+        expr: &'a Expr,\n+    ) -> Option<(&'a Option<QSelf>, &'a Path)> {\n+        if let ExprKind::Path(qself, path) = &expr.kind {\n+            // Does the path resolve to something disallowed in a unit struct/variant pattern?\n+            if let Some(partial_res) = self.resolver.get_partial_res(expr.id) {\n+                if partial_res.unresolved_segments() == 0\n+                    && !partial_res.base_res().expected_in_unit_struct_pat()\n+                {\n+                    return None;\n+                }\n+            }\n+            return Some((qself, path));\n+        }\n+        None\n+    }\n+\n     /// Convert the LHS of a destructuring assignment to a pattern.\n     /// Each sub-assignment is recorded in `assignments`.\n     fn destructure_assign(\n@@ -1080,6 +1102,21 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                     return self.pat_without_dbm(lhs.span, tuple_struct_pat);\n                 }\n             }\n+            // Unit structs and enum variants.\n+            ExprKind::Path(..) => {\n+                if let Some((qself, path)) = self.extract_unit_struct_path(lhs) {\n+                    let qpath = self.lower_qpath(\n+                        lhs.id,\n+                        qself,\n+                        path,\n+                        ParamMode::Optional,\n+                        ImplTraitContext::Disallowed(ImplTraitPosition::Path),\n+                    );\n+                    // Destructure like a unit struct.\n+                    let unit_struct_pat = hir::PatKind::Path(qpath);\n+                    return self.pat_without_dbm(lhs.span, unit_struct_pat);\n+                }\n+            }\n             // Structs.\n             ExprKind::Struct(se) => {\n                 let field_pats = self.arena.alloc_from_iter(se.fields.iter().map(|f| {"}, {"sha": "9a872487bfb2cd78c9f83cbdb6dab91bdec6f6ce", "filename": "compiler/rustc_hir/src/def.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/compiler%2Frustc_hir%2Fsrc%2Fdef.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/compiler%2Frustc_hir%2Fsrc%2Fdef.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fdef.rs?ref=17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "patch": "@@ -657,4 +657,9 @@ impl<Id> Res<Id> {\n     pub fn expected_in_tuple_struct_pat(&self) -> bool {\n         matches!(self, Res::Def(DefKind::Ctor(_, CtorKind::Fn), _) | Res::SelfCtor(..))\n     }\n+\n+    /// Returns whether such a resolved path can occur in a unit struct/variant pattern\n+    pub fn expected_in_unit_struct_pat(&self) -> bool {\n+        matches!(self, Res::Def(DefKind::Ctor(_, CtorKind::Const), _) | Res::SelfCtor(..))\n+    }\n }"}, {"sha": "80918c20b6adccd37c9fba3339f2597a1e2eb34f", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "patch": "@@ -309,13 +309,10 @@ impl<'a> PathSource<'a> {\n                 ) | Res::Local(..)\n                     | Res::SelfCtor(..)\n             ),\n-            PathSource::Pat => matches!(\n-                res,\n-                Res::Def(\n-                    DefKind::Ctor(_, CtorKind::Const) | DefKind::Const | DefKind::AssocConst,\n-                    _,\n-                ) | Res::SelfCtor(..)\n-            ),\n+            PathSource::Pat => {\n+                res.expected_in_unit_struct_pat()\n+                    || matches!(res, Res::Def(DefKind::Const | DefKind::AssocConst, _))\n+            }\n             PathSource::TupleStruct(..) => res.expected_in_tuple_struct_pat(),\n             PathSource::Struct => matches!(\n                 res,"}, {"sha": "8da7f90c5246d97e959526f6bf305b6864bf422a", "filename": "src/test/ui/destructuring-assignment/struct-or-enum-variant-path.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/src%2Ftest%2Fui%2Fdestructuring-assignment%2Fstruct-or-enum-variant-path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17f5c4d255323d331345ffe4cfebb959b1b5fa1a/src%2Ftest%2Fui%2Fdestructuring-assignment%2Fstruct-or-enum-variant-path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdestructuring-assignment%2Fstruct-or-enum-variant-path.rs?ref=17f5c4d255323d331345ffe4cfebb959b1b5fa1a", "patch": "@@ -0,0 +1,34 @@\n+// check-pass\n+\n+struct S;\n+\n+enum E {\n+    V,\n+}\n+\n+type A = E;\n+\n+fn main() {\n+    let mut a;\n+\n+    (S, a) = (S, ());\n+\n+    (E::V, a) = (E::V, ());\n+\n+    (<E>::V, a) = (E::V, ());\n+    (A::V, a) = (E::V, ());\n+}\n+\n+impl S {\n+    fn check() {\n+        let a;\n+        (Self, a) = (S, ());\n+    }\n+}\n+\n+impl E {\n+    fn check() {\n+        let a;\n+        (Self::V, a) = (E::V, ());\n+    }\n+}"}]}