{"sha": "bb20dc124e15bb430b133de601660a4293228d0b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiMjBkYzEyNGUxNWJiNDMwYjEzM2RlNjAxNjYwYTQyOTMyMjhkMGI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-05-16T15:22:56Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-05-16T21:18:11Z"}, "message": "Rollup merge of #50740 - nnethercote:rm-LazyBTreeMap, r=cramertj\n\nRemove LazyBTreeMap.\n\nIt was introduced in #50240 to avoid an allocation when creating a new\nBTreeMap, which gave some speed-ups. But then #50352 made that the\ndefault behaviour for BTreeMap, so LazyBTreeMap is no longer necessary.", "tree": {"sha": "5c1c9cfd13c15a0dde03d90da2a744327ce0f1eb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5c1c9cfd13c15a0dde03d90da2a744327ce0f1eb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bb20dc124e15bb430b133de601660a4293228d0b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlr8oBMACgkQ/vbIBR0O\nATwGnhAArN1xa0gwWamb8bKbsqNU0d+NHN9QYEjqtmosdlgUqrL1I/QiMeza1VJJ\nb+jmVNfXaA9DVcgtYQH37fNguUfhLLgLYOceZgLBlgmgMQfbAOcQTioAV0bPOCYb\n2UL0O4naWhFbXtZsxdeKvluQAwZ63VYtY2w3KAR+aE1Rw4ZGkGVyBbB2yESitWgZ\nDFlzFakO1Ub8VeEh36zW6GXCe46wy/NaM061ixeWBKlmFMEsoFeXu+3Mit3OX49e\nk8a/WamP6BDBhSC69WUpKKvMlf1MXhGzgV10PGmHphSOSve43Uw1mBEQ3ILyQecm\n048fy20kvbOc8YvyPXnRP6RjxCsJYXEFkXtQJdz7tBilHmrKUDERjEYSDR5ubDMA\nO6TScUI6zQ1VCzc5+yDB0ixA/DnMjzTU5zrbuFSHq3yJudhO6ID2cGTt1mog6rdv\nC7AjSpIhofDOG1+Unn8yTVSb+QMudXwoa5fPCbRRHuw/VE0C9WJpI/ngOJDGfoK4\nCrqytkqkRNkRtwcmHIrah8hXbcWxrUC3KDXlSYLHjtANXUQBMb7r7HNOSz+Js/zl\nkUxpBOKzQWWh2mW18Q5ScC7DrRdzhszvL2dRW+07I/7E6O5jd04cRVUNzd10wznC\nihsNlyUJStRzYZvTWzNppOpNq2rqxzVSxj562fxcwGeqQOgEjhs=\n=xD4C\n-----END PGP SIGNATURE-----", "payload": "tree 5c1c9cfd13c15a0dde03d90da2a744327ce0f1eb\nparent 06e617386858a2a2b7d0ad11e3d59b932d6d378e\nparent f46b888f73d66149f1abe424489722283f60d6e1\nauthor kennytm <kennytm@gmail.com> 1526484176 +0800\ncommitter kennytm <kennytm@gmail.com> 1526505491 +0800\n\nRollup merge of #50740 - nnethercote:rm-LazyBTreeMap, r=cramertj\n\nRemove LazyBTreeMap.\n\nIt was introduced in #50240 to avoid an allocation when creating a new\nBTreeMap, which gave some speed-ups. But then #50352 made that the\ndefault behaviour for BTreeMap, so LazyBTreeMap is no longer necessary.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bb20dc124e15bb430b133de601660a4293228d0b", "html_url": "https://github.com/rust-lang/rust/commit/bb20dc124e15bb430b133de601660a4293228d0b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bb20dc124e15bb430b133de601660a4293228d0b/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06e617386858a2a2b7d0ad11e3d59b932d6d378e", "url": "https://api.github.com/repos/rust-lang/rust/commits/06e617386858a2a2b7d0ad11e3d59b932d6d378e", "html_url": "https://github.com/rust-lang/rust/commit/06e617386858a2a2b7d0ad11e3d59b932d6d378e"}, {"sha": "f46b888f73d66149f1abe424489722283f60d6e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/f46b888f73d66149f1abe424489722283f60d6e1", "html_url": "https://github.com/rust-lang/rust/commit/f46b888f73d66149f1abe424489722283f60d6e1"}], "stats": {"total": 135, "additions": 12, "deletions": 123}, "files": [{"sha": "acd5c44c1a4d807a71d5cab62a86a116b0dc0650", "filename": "src/librustc/infer/higher_ranked/mod.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc%2Finfer%2Fhigher_ranked%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc%2Finfer%2Fhigher_ranked%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fhigher_ranked%2Fmod.rs?ref=bb20dc124e15bb430b133de601660a4293228d0b", "patch": "@@ -19,10 +19,10 @@ use super::{CombinedSnapshot,\n use super::combine::CombineFields;\n use super::region_constraints::{TaintDirections};\n \n-use rustc_data_structures::lazy_btree_map::LazyBTreeMap;\n use ty::{self, TyCtxt, Binder, TypeFoldable};\n use ty::error::TypeError;\n use ty::relate::{Relate, RelateResult, TypeRelation};\n+use std::collections::BTreeMap;\n use syntax_pos::Span;\n use util::nodemap::{FxHashMap, FxHashSet};\n \n@@ -247,8 +247,7 @@ impl<'a, 'gcx, 'tcx> CombineFields<'a, 'gcx, 'tcx> {\n                                              snapshot: &CombinedSnapshot<'a, 'tcx>,\n                                              debruijn: ty::DebruijnIndex,\n                                              new_vars: &[ty::RegionVid],\n-                                             a_map: &LazyBTreeMap<ty::BoundRegion,\n-                                                                  ty::Region<'tcx>>,\n+                                             a_map: &BTreeMap<ty::BoundRegion, ty::Region<'tcx>>,\n                                              r0: ty::Region<'tcx>)\n                                              -> ty::Region<'tcx> {\n             // Regions that pre-dated the LUB computation stay as they are.\n@@ -344,8 +343,7 @@ impl<'a, 'gcx, 'tcx> CombineFields<'a, 'gcx, 'tcx> {\n                                              snapshot: &CombinedSnapshot<'a, 'tcx>,\n                                              debruijn: ty::DebruijnIndex,\n                                              new_vars: &[ty::RegionVid],\n-                                             a_map: &LazyBTreeMap<ty::BoundRegion,\n-                                                                  ty::Region<'tcx>>,\n+                                             a_map: &BTreeMap<ty::BoundRegion, ty::Region<'tcx>>,\n                                              a_vars: &[ty::RegionVid],\n                                              b_vars: &[ty::RegionVid],\n                                              r0: ty::Region<'tcx>)\n@@ -414,7 +412,7 @@ impl<'a, 'gcx, 'tcx> CombineFields<'a, 'gcx, 'tcx> {\n \n         fn rev_lookup<'a, 'gcx, 'tcx>(infcx: &InferCtxt<'a, 'gcx, 'tcx>,\n                                       span: Span,\n-                                      a_map: &LazyBTreeMap<ty::BoundRegion, ty::Region<'tcx>>,\n+                                      a_map: &BTreeMap<ty::BoundRegion, ty::Region<'tcx>>,\n                                       r: ty::Region<'tcx>) -> ty::Region<'tcx>\n         {\n             for (a_br, a_r) in a_map {\n@@ -437,7 +435,7 @@ impl<'a, 'gcx, 'tcx> CombineFields<'a, 'gcx, 'tcx> {\n }\n \n fn var_ids<'a, 'gcx, 'tcx>(fields: &CombineFields<'a, 'gcx, 'tcx>,\n-                           map: &LazyBTreeMap<ty::BoundRegion, ty::Region<'tcx>>)\n+                           map: &BTreeMap<ty::BoundRegion, ty::Region<'tcx>>)\n                            -> Vec<ty::RegionVid> {\n     map.iter()\n        .map(|(_, &r)| match *r {"}, {"sha": "f105ecf7ee4f8c63aea365128d5ea250adeae313", "filename": "src/librustc/infer/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc%2Finfer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc%2Finfer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fmod.rs?ref=bb20dc124e15bb430b133de601660a4293228d0b", "patch": "@@ -28,9 +28,9 @@ use ty::error::{ExpectedFound, TypeError, UnconstrainedNumeric};\n use ty::fold::TypeFoldable;\n use ty::relate::RelateResult;\n use traits::{self, ObligationCause, PredicateObligations};\n-use rustc_data_structures::lazy_btree_map::LazyBTreeMap;\n use rustc_data_structures::unify as ut;\n use std::cell::{Cell, RefCell, Ref, RefMut};\n+use std::collections::BTreeMap;\n use std::fmt;\n use syntax::ast;\n use errors::DiagnosticBuilder;\n@@ -198,7 +198,7 @@ pub struct InferCtxt<'a, 'gcx: 'a+'tcx, 'tcx: 'a> {\n \n /// A map returned by `skolemize_late_bound_regions()` indicating the skolemized\n /// region that each late-bound region was replaced with.\n-pub type SkolemizationMap<'tcx> = LazyBTreeMap<ty::BoundRegion, ty::Region<'tcx>>;\n+pub type SkolemizationMap<'tcx> = BTreeMap<ty::BoundRegion, ty::Region<'tcx>>;\n \n /// See `error_reporting` module for more details\n #[derive(Clone, Debug)]\n@@ -1235,7 +1235,7 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n         span: Span,\n         lbrct: LateBoundRegionConversionTime,\n         value: &ty::Binder<T>)\n-        -> (T, LazyBTreeMap<ty::BoundRegion, ty::Region<'tcx>>)\n+        -> (T, BTreeMap<ty::BoundRegion, ty::Region<'tcx>>)\n         where T : TypeFoldable<'tcx>\n     {\n         self.tcx.replace_late_bound_regions("}, {"sha": "250f33d9dbafb6800eb4ef27f7503f60e7f6877a", "filename": "src/librustc/ty/fold.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc%2Fty%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc%2Fty%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Ffold.rs?ref=bb20dc124e15bb430b133de601660a4293228d0b", "patch": "@@ -43,7 +43,7 @@ use middle::const_val::ConstVal;\n use hir::def_id::DefId;\n use ty::{self, Binder, Ty, TyCtxt, TypeFlags};\n \n-use rustc_data_structures::lazy_btree_map::LazyBTreeMap;\n+use std::collections::BTreeMap;\n use std::fmt;\n use util::nodemap::FxHashSet;\n \n@@ -332,7 +332,7 @@ struct RegionReplacer<'a, 'gcx: 'a+'tcx, 'tcx: 'a> {\n     tcx: TyCtxt<'a, 'gcx, 'tcx>,\n     current_depth: u32,\n     fld_r: &'a mut (dyn FnMut(ty::BoundRegion) -> ty::Region<'tcx> + 'a),\n-    map: LazyBTreeMap<ty::BoundRegion, ty::Region<'tcx>>\n+    map: BTreeMap<ty::BoundRegion, ty::Region<'tcx>>\n }\n \n impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n@@ -347,7 +347,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n     pub fn replace_late_bound_regions<T,F>(self,\n         value: &Binder<T>,\n         mut f: F)\n-        -> (T, LazyBTreeMap<ty::BoundRegion, ty::Region<'tcx>>)\n+        -> (T, BTreeMap<ty::BoundRegion, ty::Region<'tcx>>)\n         where F : FnMut(ty::BoundRegion) -> ty::Region<'tcx>,\n               T : TypeFoldable<'tcx>,\n     {\n@@ -460,7 +460,7 @@ impl<'a, 'gcx, 'tcx> RegionReplacer<'a, 'gcx, 'tcx> {\n             tcx,\n             current_depth: 1,\n             fld_r,\n-            map: LazyBTreeMap::default()\n+            map: BTreeMap::default()\n         }\n     }\n }"}, {"sha": "74f91af10fe637888342d6a7c39407a3e239cd3e", "filename": "src/librustc_data_structures/lazy_btree_map.rs", "status": "removed", "additions": 0, "deletions": 108, "changes": 108, "blob_url": "https://github.com/rust-lang/rust/blob/06e617386858a2a2b7d0ad11e3d59b932d6d378e/src%2Flibrustc_data_structures%2Flazy_btree_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06e617386858a2a2b7d0ad11e3d59b932d6d378e/src%2Flibrustc_data_structures%2Flazy_btree_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Flazy_btree_map.rs?ref=06e617386858a2a2b7d0ad11e3d59b932d6d378e", "patch": "@@ -1,108 +0,0 @@\n-// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-use std::collections::btree_map;\n-use std::collections::BTreeMap;\n-\n-/// A thin wrapper around BTreeMap that avoids allocating upon creation.\n-///\n-/// Vec, HashSet and HashMap all have the nice feature that they don't do any\n-/// heap allocation when creating a new structure of the default size. In\n-/// contrast, BTreeMap *does* allocate in that situation. The compiler uses\n-/// B-Tree maps in some places such that many maps are created but few are\n-/// inserted into, so having a BTreeMap alternative that avoids allocating on\n-/// creation is a performance win.\n-///\n-/// Only a fraction of BTreeMap's functionality is currently supported.\n-/// Additional functionality should be added on demand.\n-#[derive(Debug)]\n-pub struct LazyBTreeMap<K, V>(Option<BTreeMap<K, V>>);\n-\n-impl<K, V> LazyBTreeMap<K, V> {\n-    pub fn new() -> LazyBTreeMap<K, V> {\n-        LazyBTreeMap(None)\n-    }\n-\n-    pub fn iter(&self) -> Iter<K, V> {\n-        Iter(self.0.as_ref().map(|btm| btm.iter()))\n-    }\n-\n-    pub fn is_empty(&self) -> bool {\n-        self.0.as_ref().map_or(true, |btm| btm.is_empty())\n-    }\n-}\n-\n-impl<K: Ord, V> LazyBTreeMap<K, V> {\n-    fn instantiate(&mut self) -> &mut BTreeMap<K, V> {\n-        if let Some(ref mut btm) = self.0 {\n-            btm\n-        } else {\n-            let btm = BTreeMap::new();\n-            self.0 = Some(btm);\n-            self.0.as_mut().unwrap()\n-        }\n-    }\n-\n-    pub fn insert(&mut self, key: K, value: V) -> Option<V> {\n-        self.instantiate().insert(key, value)\n-    }\n-\n-    pub fn entry(&mut self, key: K) -> btree_map::Entry<K, V> {\n-        self.instantiate().entry(key)\n-    }\n-\n-    pub fn values<'a>(&'a self) -> Values<'a, K, V> {\n-        Values(self.0.as_ref().map(|btm| btm.values()))\n-    }\n-}\n-\n-impl<K: Ord, V> Default for LazyBTreeMap<K, V> {\n-    fn default() -> LazyBTreeMap<K, V> {\n-        LazyBTreeMap::new()\n-    }\n-}\n-\n-impl<'a, K: 'a, V: 'a> IntoIterator for &'a LazyBTreeMap<K, V> {\n-    type Item = (&'a K, &'a V);\n-    type IntoIter = Iter<'a, K, V>;\n-\n-    fn into_iter(self) -> Iter<'a, K, V> {\n-        self.iter()\n-    }\n-}\n-\n-pub struct Iter<'a, K: 'a, V: 'a>(Option<btree_map::Iter<'a, K, V>>);\n-\n-impl<'a, K: 'a, V: 'a> Iterator for Iter<'a, K, V> {\n-    type Item = (&'a K, &'a V);\n-\n-    fn next(&mut self) -> Option<(&'a K, &'a V)> {\n-        self.0.as_mut().and_then(|iter| iter.next())\n-    }\n-\n-    fn size_hint(&self) -> (usize, Option<usize>) {\n-        self.0.as_ref().map_or_else(|| (0, Some(0)), |iter| iter.size_hint())\n-    }\n-}\n-\n-pub struct Values<'a, K: 'a, V: 'a>(Option<btree_map::Values<'a, K, V>>);\n-\n-impl<'a, K, V> Iterator for Values<'a, K, V> {\n-    type Item = &'a V;\n-\n-    fn next(&mut self) -> Option<&'a V> {\n-        self.0.as_mut().and_then(|values| values.next())\n-    }\n-\n-    fn size_hint(&self) -> (usize, Option<usize>) {\n-        self.0.as_ref().map_or_else(|| (0, Some(0)), |values| values.size_hint())\n-    }\n-}\n-"}, {"sha": "5bac1bd9a7b08986b8c6231a77613caf4ee4995c", "filename": "src/librustc_data_structures/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc_data_structures%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb20dc124e15bb430b133de601660a4293228d0b/src%2Flibrustc_data_structures%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Flib.rs?ref=bb20dc124e15bb430b133de601660a4293228d0b", "patch": "@@ -61,7 +61,6 @@ pub mod bitvec;\n pub mod graph;\n pub mod indexed_set;\n pub mod indexed_vec;\n-pub mod lazy_btree_map;\n pub mod obligation_forest;\n pub mod sip128;\n pub mod snapshot_map;"}]}