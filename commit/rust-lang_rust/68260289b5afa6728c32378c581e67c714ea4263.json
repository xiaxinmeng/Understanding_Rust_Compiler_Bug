{"sha": "68260289b5afa6728c32378c581e67c714ea4263", "node_id": "C_kwDOAAsO6NoAKDY4MjYwMjg5YjVhZmE2NzI4YzMyMzc4YzU4MWU2N2M3MTRlYTQyNjM", "commit": {"author": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-10-10T17:43:36Z"}, "committer": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-10-10T17:43:36Z"}, "message": "fix #102878", "tree": {"sha": "a9c8f9fd139c7ba0ab80cf5ae2ee1a19fed8f47a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9c8f9fd139c7ba0ab80cf5ae2ee1a19fed8f47a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68260289b5afa6728c32378c581e67c714ea4263", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68260289b5afa6728c32378c581e67c714ea4263", "html_url": "https://github.com/rust-lang/rust/commit/68260289b5afa6728c32378c581e67c714ea4263", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68260289b5afa6728c32378c581e67c714ea4263/comments", "author": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "committer": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eed7f2f58bd44d32ac30e48425eb4bede7ea84f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/eed7f2f58bd44d32ac30e48425eb4bede7ea84f7", "html_url": "https://github.com/rust-lang/rust/commit/eed7f2f58bd44d32ac30e48425eb4bede7ea84f7"}], "stats": {"total": 102, "additions": 81, "deletions": 21}, "files": [{"sha": "9a7cb955f216f37f0b10928f5abe03a4e506731d", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/68260289b5afa6728c32378c581e67c714ea4263/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68260289b5afa6728c32378c581e67c714ea4263/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=68260289b5afa6728c32378c581e67c714ea4263", "patch": "@@ -336,19 +336,6 @@ impl DiagnosticMessage {\n             }\n         }\n     }\n-\n-    /// Returns the `String` contained within the `DiagnosticMessage::Str` variant, assuming that\n-    /// this diagnostic message is of the legacy, non-translatable variety. Panics if this\n-    /// assumption does not hold.\n-    ///\n-    /// Don't use this - it exists to support some places that do comparison with diagnostic\n-    /// strings.\n-    pub fn expect_str(&self) -> &str {\n-        match self {\n-            DiagnosticMessage::Str(s) => s,\n-            _ => panic!(\"expected non-translatable diagnostic message\"),\n-        }\n-    }\n }\n \n /// `From` impl that enables existing diagnostic calls to functions which now take"}, {"sha": "30aa4f0fa3482ea51b46e70a75fdc0e9b26d2e29", "filename": "compiler/rustc_expand/src/mbe/macro_rules.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/68260289b5afa6728c32378c581e67c714ea4263/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68260289b5afa6728c32378c581e67c714ea4263/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs?ref=68260289b5afa6728c32378c581e67c714ea4263", "patch": "@@ -14,7 +14,7 @@ use rustc_ast::{NodeId, DUMMY_NODE_ID};\n use rustc_ast_pretty::pprust;\n use rustc_attr::{self as attr, TransparencyError};\n use rustc_data_structures::fx::{FxHashMap, FxIndexMap};\n-use rustc_errors::{Applicability, Diagnostic, DiagnosticBuilder};\n+use rustc_errors::{Applicability, Diagnostic, DiagnosticBuilder, DiagnosticMessage};\n use rustc_feature::Features;\n use rustc_lint_defs::builtin::{\n     RUST_2021_INCOMPATIBLE_OR_PATTERNS, SEMICOLON_IN_EXPRESSIONS_FROM_MACROS,\n@@ -68,19 +68,22 @@ fn emit_frag_parse_err(\n     kind: AstFragmentKind,\n ) {\n     // FIXME(davidtwco): avoid depending on the error message text\n-    if parser.token == token::Eof && e.message[0].0.expect_str().ends_with(\", found `<eof>`\") {\n-        if !e.span.is_dummy() {\n-            // early end of macro arm (#52866)\n-            e.replace_span_with(parser.sess.source_map().next_point(parser.token.span));\n-        }\n+    if parser.token == token::Eof\n+        && let DiagnosticMessage::Str(message) = &e.message[0].0\n+        && message.ends_with(\", found `<eof>`\")\n+    {\n         let msg = &e.message[0];\n         e.message[0] = (\n-            rustc_errors::DiagnosticMessage::Str(format!(\n+            DiagnosticMessage::Str(format!(\n                 \"macro expansion ends with an incomplete expression: {}\",\n-                msg.0.expect_str().replace(\", found `<eof>`\", \"\"),\n+                message.replace(\", found `<eof>`\", \"\"),\n             )),\n             msg.1,\n         );\n+        if !e.span.is_dummy() {\n+            // early end of macro arm (#52866)\n+            e.replace_span_with(parser.sess.source_map().next_point(parser.token.span));\n+        }\n     }\n     if e.span.is_dummy() {\n         // Get around lack of span in error (#30128)"}, {"sha": "aac5891939e0ce823f9333fb7affcb831d3a0844", "filename": "src/test/ui/macros/issue-102878.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/68260289b5afa6728c32378c581e67c714ea4263/src%2Ftest%2Fui%2Fmacros%2Fissue-102878.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68260289b5afa6728c32378c581e67c714ea4263/src%2Ftest%2Fui%2Fmacros%2Fissue-102878.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-102878.rs?ref=68260289b5afa6728c32378c581e67c714ea4263", "patch": "@@ -0,0 +1,10 @@\n+macro_rules!test{($l:expr,$_:r)=>({const:y y)}\n+//~^ ERROR mismatched closing delimiter: `)`\n+//~| ERROR invalid fragment specifier `r`\n+//~| ERROR expected identifier, found keyword `const`\n+//~| ERROR expected identifier, found keyword `const`\n+//~| ERROR expected identifier, found `:`\n+\n+fn s(){test!(1,i)}\n+\n+fn main() {}"}, {"sha": "e0b8855a38d05c23dde3282070f2c8a4aebee95f", "filename": "src/test/ui/macros/issue-102878.stderr", "status": "added", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/68260289b5afa6728c32378c581e67c714ea4263/src%2Ftest%2Fui%2Fmacros%2Fissue-102878.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/68260289b5afa6728c32378c581e67c714ea4263/src%2Ftest%2Fui%2Fmacros%2Fissue-102878.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-102878.stderr?ref=68260289b5afa6728c32378c581e67c714ea4263", "patch": "@@ -0,0 +1,60 @@\n+error: mismatched closing delimiter: `)`\n+  --> $DIR/issue-102878.rs:1:35\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({const:y y)}\n+   |                                  -^         ^ mismatched closing delimiter\n+   |                                  ||\n+   |                                  |unclosed delimiter\n+   |                                  closing delimiter possibly meant for this\n+\n+error: invalid fragment specifier `r`\n+  --> $DIR/issue-102878.rs:1:27\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({const:y y)}\n+   |                           ^^^^\n+   |\n+   = help: valid fragment specifiers are `ident`, `block`, `stmt`, `expr`, `pat`, `ty`, `lifetime`, `literal`, `path`, `meta`, `tt`, `item` and `vis`\n+\n+error: expected identifier, found keyword `const`\n+  --> $DIR/issue-102878.rs:1:36\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({const:y y)}\n+   |                                    ^^^^^ expected identifier, found keyword\n+...\n+LL | fn s(){test!(1,i)}\n+   |        ---------- in this macro invocation\n+   |\n+   = note: this error originates in the macro `test` (in Nightly builds, run with -Z macro-backtrace for more info)\n+help: escape `const` to use it as an identifier\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({r#const:y y)}\n+   |                                    ++\n+\n+error: expected identifier, found keyword `const`\n+  --> $DIR/issue-102878.rs:1:36\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({const:y y)}\n+   |                                    ^^^^^ expected identifier, found keyword\n+...\n+LL | fn s(){test!(1,i)}\n+   |        ---------- in this macro invocation\n+   |\n+   = note: this error originates in the macro `test` (in Nightly builds, run with -Z macro-backtrace for more info)\n+help: escape `const` to use it as an identifier\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({r#const:y y)}\n+   |                                    ++\n+\n+error: expected identifier, found `:`\n+  --> $DIR/issue-102878.rs:1:41\n+   |\n+LL | macro_rules!test{($l:expr,$_:r)=>({const:y y)}\n+   |                                         ^ expected identifier\n+...\n+LL | fn s(){test!(1,i)}\n+   |        ---------- in this macro invocation\n+   |\n+   = note: this error originates in the macro `test` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 5 previous errors\n+"}]}