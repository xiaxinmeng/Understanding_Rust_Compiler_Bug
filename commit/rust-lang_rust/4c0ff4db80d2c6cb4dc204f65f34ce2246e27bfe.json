{"sha": "4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjMGZmNGRiODBkMmM2Y2I0ZGMyMDRmNjVmMzRjZTIyNDZlMjdiZmU=", "commit": {"author": {"name": "Maarten de Vries", "email": "maarten@de-vri.es", "date": "2021-07-15T19:25:11Z"}, "committer": {"name": "Maarten de Vries", "email": "maarten@de-vri.es", "date": "2021-07-28T08:04:23Z"}, "message": "Show discriminant before overflow in diagnostic.", "tree": {"sha": "54b350e1f5ec45f4c2db752ceba41f9580e74c9d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/54b350e1f5ec45f4c2db752ceba41f9580e74c9d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "html_url": "https://github.com/rust-lang/rust/commit/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/comments", "author": {"login": "de-vri-es", "id": 786213, "node_id": "MDQ6VXNlcjc4NjIxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/786213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/de-vri-es", "html_url": "https://github.com/de-vri-es", "followers_url": "https://api.github.com/users/de-vri-es/followers", "following_url": "https://api.github.com/users/de-vri-es/following{/other_user}", "gists_url": "https://api.github.com/users/de-vri-es/gists{/gist_id}", "starred_url": "https://api.github.com/users/de-vri-es/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/de-vri-es/subscriptions", "organizations_url": "https://api.github.com/users/de-vri-es/orgs", "repos_url": "https://api.github.com/users/de-vri-es/repos", "events_url": "https://api.github.com/users/de-vri-es/events{/privacy}", "received_events_url": "https://api.github.com/users/de-vri-es/received_events", "type": "User", "site_admin": false}, "committer": {"login": "de-vri-es", "id": 786213, "node_id": "MDQ6VXNlcjc4NjIxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/786213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/de-vri-es", "html_url": "https://github.com/de-vri-es", "followers_url": "https://api.github.com/users/de-vri-es/followers", "following_url": "https://api.github.com/users/de-vri-es/following{/other_user}", "gists_url": "https://api.github.com/users/de-vri-es/gists{/gist_id}", "starred_url": "https://api.github.com/users/de-vri-es/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/de-vri-es/subscriptions", "organizations_url": "https://api.github.com/users/de-vri-es/orgs", "repos_url": "https://api.github.com/users/de-vri-es/repos", "events_url": "https://api.github.com/users/de-vri-es/events{/privacy}", "received_events_url": "https://api.github.com/users/de-vri-es/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8b50cc9a2c408caef30a1cf950c948509b2f648e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8b50cc9a2c408caef30a1cf950c948509b2f648e", "html_url": "https://github.com/rust-lang/rust/commit/8b50cc9a2c408caef30a1cf950c948509b2f648e"}], "stats": {"total": 60, "additions": 52, "deletions": 8}, "files": [{"sha": "9b555df4b92de689de1c1100990fbaa4ba8f87aa", "filename": "compiler/rustc_typeck/src/check/check.rs", "status": "modified", "additions": 24, "deletions": 3, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs?ref=4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "patch": "@@ -1472,15 +1472,17 @@ fn check_enum<'tcx>(\n                 Some(ref expr) => tcx.hir().span(expr.hir_id),\n                 None => v.span,\n             };\n+            let display_discr = display_discriminant_value(tcx, v, discr.val);\n+            let display_discr_i = display_discriminant_value(tcx, variant_i, disr_vals[i].val);\n             struct_span_err!(\n                 tcx.sess,\n                 span,\n                 E0081,\n                 \"discriminant value `{}` already exists\",\n-                disr_vals[i]\n+                discr.val,\n             )\n-            .span_label(i_span, format!(\"first use of `{}`\", disr_vals[i]))\n-            .span_label(span, format!(\"enum already has `{}`\", disr_vals[i]))\n+            .span_label(i_span, format!(\"first use of {}\", display_discr_i))\n+            .span_label(span, format!(\"enum already has {}\", display_discr))\n             .emit();\n         }\n         disr_vals.push(discr);\n@@ -1490,6 +1492,25 @@ fn check_enum<'tcx>(\n     check_transparent(tcx, sp, def);\n }\n \n+/// Format an enum discriminant value for use in a diagnostic message.\n+fn display_discriminant_value<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    variant: &hir::Variant<'_>,\n+    evaluated: u128,\n+) -> String {\n+    if let Some(expr) = &variant.disr_expr {\n+        let body = &tcx.hir().body(expr.body).value;\n+        if let hir::ExprKind::Lit(lit) = &body.kind {\n+            if let rustc_ast::LitKind::Int(lit_value, _int_kind) = &lit.node {\n+                if evaluated != *lit_value {\n+                    return format!(\"`{}` (overflowed from `{}`)\", evaluated, lit_value);\n+                }\n+            }\n+        }\n+    }\n+    format!(\"`{}`\", evaluated)\n+}\n+\n pub(super) fn check_type_params_are_used<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     generics: &ty::Generics,"}, {"sha": "473a0ad6f7a1384b6c4f5b3815548442048bbed2", "filename": "src/test/ui/enum/enum-discrim-autosizing.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Fenum%2Fenum-discrim-autosizing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Fenum%2Fenum-discrim-autosizing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fenum%2Fenum-discrim-autosizing.rs?ref=4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "patch": "@@ -4,8 +4,10 @@\n // so force the repr.\n #[cfg_attr(not(target_pointer_width = \"32\"), repr(i32))]\n enum Eu64 {\n-    Au64 = 0,\n-    Bu64 = 0x8000_0000_0000_0000 //~ERROR already exists\n+    Au64 = 0, //~NOTE first use of `0`\n+    Bu64 = 0x8000_0000_0000_0000\n+    //~^ ERROR discriminant value `0` already exists\n+    //~| NOTE enum already has `0` (overflowed from `9223372036854775808`)\n }\n \n fn main() {}"}, {"sha": "a0f39098a2e98dcac51b194fa3b0b3b72446b766", "filename": "src/test/ui/enum/enum-discrim-autosizing.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Fenum%2Fenum-discrim-autosizing.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Fenum%2Fenum-discrim-autosizing.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fenum%2Fenum-discrim-autosizing.stderr?ref=4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "patch": "@@ -4,7 +4,7 @@ error[E0081]: discriminant value `0` already exists\n LL |     Au64 = 0,\n    |            - first use of `0`\n LL |     Bu64 = 0x8000_0000_0000_0000\n-   |            ^^^^^^^^^^^^^^^^^^^^^ enum already has `0`\n+   |            ^^^^^^^^^^^^^^^^^^^^^ enum already has `0` (overflowed from `9223372036854775808`)\n \n error: aborting due to previous error\n "}, {"sha": "255e05ced19f722c3fee9a576ab8fe9b6d607741", "filename": "src/test/ui/error-codes/E0081.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Ferror-codes%2FE0081.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Ferror-codes%2FE0081.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0081.rs?ref=4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "patch": "@@ -1,9 +1,20 @@\n enum Enum {\n     P = 3,\n+    //~^ NOTE first use of `3`\n     X = 3,\n     //~^ ERROR discriminant value `3` already exists\n+    //~| NOTE enum already has `3`\n     Y = 5\n }\n \n+#[repr(u8)]\n+enum EnumOverflowRepr {\n+    P = 257,\n+    //~^ NOTE first use of `1` (overflowed from `257`)\n+    X = 513,\n+    //~^ ERROR discriminant value `1` already exists\n+    //~| NOTE enum already has `1` (overflowed from `513`)\n+}\n+\n fn main() {\n }"}, {"sha": "9b279bb0214c6eb129223aea0f73bab42face8e1", "filename": "src/test/ui/error-codes/E0081.stderr", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Ferror-codes%2FE0081.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe/src%2Ftest%2Fui%2Ferror-codes%2FE0081.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0081.stderr?ref=4c0ff4db80d2c6cb4dc204f65f34ce2246e27bfe", "patch": "@@ -1,11 +1,21 @@\n error[E0081]: discriminant value `3` already exists\n-  --> $DIR/E0081.rs:3:9\n+  --> $DIR/E0081.rs:4:9\n    |\n LL |     P = 3,\n    |         - first use of `3`\n+LL |\n LL |     X = 3,\n    |         ^ enum already has `3`\n \n-error: aborting due to previous error\n+error[E0081]: discriminant value `1` already exists\n+  --> $DIR/E0081.rs:14:9\n+   |\n+LL |     P = 257,\n+   |         --- first use of `1` (overflowed from `257`)\n+LL |\n+LL |     X = 513,\n+   |         ^^^ enum already has `1` (overflowed from `513`)\n+\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0081`."}]}