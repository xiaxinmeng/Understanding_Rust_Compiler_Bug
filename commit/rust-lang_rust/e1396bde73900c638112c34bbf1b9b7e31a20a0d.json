{"sha": "e1396bde73900c638112c34bbf1b9b7e31a20a0d", "node_id": "C_kwDOAAsO6NoAKGUxMzk2YmRlNzM5MDBjNjM4MTEyYzM0YmJmMWI5YjdlMzFhMjBhMGQ", "commit": {"author": {"name": "Duong Quoc Khanh", "email": "dqkqdlot@gmail.com", "date": "2023-02-11T12:26:00Z"}, "committer": {"name": "Duong Quoc Khanh", "email": "dqkqdlot@gmail.com", "date": "2023-02-11T12:26:00Z"}, "message": "Don't trigger postfix completion `if` block which has an `else` block\n\nDiscard postfix completion if the next_non_trivia_sibling of dot_token\nis an ELSE_KW.", "tree": {"sha": "a8240733e804225e433b4645769733ab59f43d05", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8240733e804225e433b4645769733ab59f43d05"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1396bde73900c638112c34bbf1b9b7e31a20a0d", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEwZYQ1XvHmidXWoT/2lKnToBKAOcFAmPnidEACgkQ2lKnToBK\nAOfJuBAAlbLtzfY7rzPpKsVVv2wy46zCTmYZbXBhNGmexvubNTz/Jp8LhgGNQC6+\ncQ9UIl1NsZrCsColNZxwPka8YMalJghi1e8SBOLz+0bxeg6/QDkT5TV25sbcJpVr\n/yx0zOIwYKSo3aLJ8WWxdonpYcV1Fsoc7MDUymOsjKAO2pYP+lsZLb5hfD18NwmI\nKUQyOKwVDuuwEddzEL9QS1HKzj8ATk0GhV+emQboAhgheN23nt/rHjrA5WBR/hXV\n6nWHZrg77VHQcrHNJ9r/5QJ07wZZ6eCgm+O2zjqNPjJgqXG9GBfnDqV9ivZLZ9NL\nicWiFEy5FMUKY6RMfFc0fe5uK2HXgt7r6b/brbzzyk78H237InZFBuMfHdf9hq21\n+5MNGH7UyAREqmmkrFFl+0pBp7E2cngeoEdmWEnKMRdcoDyiIjJEUWJf22P1tZ1/\nHW8P/3S7XocOPe1Pgd815hiy+SvnhMUUX4xo8FmaTOsNpaat+2ucSJfUVEu3e7tl\nBzMVJTW6FJpHAcd+IRW51CfgGJYeuiUQTw17b2xOKmgMT371sLSUUrh76LPPIRmL\nmm500UssLJEq3s5iG12V9V28YBPq1IGK7GaXryFrX5mFkd6nLtbPEhZy0B3elx/R\n/EDx8OIiuIDW45i3r4x6Ssj/XnoOEkI2RpFTMDnoffBSkL0ACMU=\n=vZnu\n-----END PGP SIGNATURE-----", "payload": "tree a8240733e804225e433b4645769733ab59f43d05\nparent 8011029d3a0f4014217e1ade75688c0f3c5305db\nauthor Duong Quoc Khanh <dqkqdlot@gmail.com> 1676118360 +0900\ncommitter Duong Quoc Khanh <dqkqdlot@gmail.com> 1676118360 +0900\n\nDon't trigger postfix completion `if` block which has an `else` block\n\nDiscard postfix completion if the next_non_trivia_sibling of dot_token\nis an ELSE_KW.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1396bde73900c638112c34bbf1b9b7e31a20a0d", "html_url": "https://github.com/rust-lang/rust/commit/e1396bde73900c638112c34bbf1b9b7e31a20a0d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1396bde73900c638112c34bbf1b9b7e31a20a0d/comments", "author": {"login": "dqkqd", "id": 24296517, "node_id": "MDQ6VXNlcjI0Mjk2NTE3", "avatar_url": "https://avatars.githubusercontent.com/u/24296517?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dqkqd", "html_url": "https://github.com/dqkqd", "followers_url": "https://api.github.com/users/dqkqd/followers", "following_url": "https://api.github.com/users/dqkqd/following{/other_user}", "gists_url": "https://api.github.com/users/dqkqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/dqkqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dqkqd/subscriptions", "organizations_url": "https://api.github.com/users/dqkqd/orgs", "repos_url": "https://api.github.com/users/dqkqd/repos", "events_url": "https://api.github.com/users/dqkqd/events{/privacy}", "received_events_url": "https://api.github.com/users/dqkqd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dqkqd", "id": 24296517, "node_id": "MDQ6VXNlcjI0Mjk2NTE3", "avatar_url": "https://avatars.githubusercontent.com/u/24296517?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dqkqd", "html_url": "https://github.com/dqkqd", "followers_url": "https://api.github.com/users/dqkqd/followers", "following_url": "https://api.github.com/users/dqkqd/following{/other_user}", "gists_url": "https://api.github.com/users/dqkqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/dqkqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dqkqd/subscriptions", "organizations_url": "https://api.github.com/users/dqkqd/orgs", "repos_url": "https://api.github.com/users/dqkqd/repos", "events_url": "https://api.github.com/users/dqkqd/events{/privacy}", "received_events_url": "https://api.github.com/users/dqkqd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8011029d3a0f4014217e1ade75688c0f3c5305db", "url": "https://api.github.com/repos/rust-lang/rust/commits/8011029d3a0f4014217e1ade75688c0f3c5305db", "html_url": "https://github.com/rust-lang/rust/commit/8011029d3a0f4014217e1ade75688c0f3c5305db"}], "stats": {"total": 32, "additions": 32, "deletions": 0}, "files": [{"sha": "c55bd9aaae521b250d4d9217c51d1ad6220c7061", "filename": "crates/ide-completion/src/completions/postfix.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e1396bde73900c638112c34bbf1b9b7e31a20a0d/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fpostfix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1396bde73900c638112c34bbf1b9b7e31a20a0d/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fpostfix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fpostfix.rs?ref=e1396bde73900c638112c34bbf1b9b7e31a20a0d", "patch": "@@ -747,4 +747,16 @@ fn main() {\n             \"#,\n         );\n     }\n+\n+    #[test]\n+    fn no_postfix_completions_in_if_block_that_has_an_else() {\n+        check(\n+            r#\"\n+fn test() {\n+    if true {}.$0 else {}\n+}\n+\"#,\n+            expect![[r#\"\"#]],\n+        );\n+    }\n }"}, {"sha": "48066736c516bc123843e82ed24a9863538ccb3b", "filename": "crates/ide-completion/src/context/analysis.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e1396bde73900c638112c34bbf1b9b7e31a20a0d/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1396bde73900c638112c34bbf1b9b7e31a20a0d/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs?ref=e1396bde73900c638112c34bbf1b9b7e31a20a0d", "patch": "@@ -605,6 +605,26 @@ fn classify_name_ref(\n                     },\n                     _ => false,\n                 };\n+\n+                let reciever_is_part_of_indivisible_expression = match &receiver {\n+                    Some(ast::Expr::IfExpr(_)) => {\n+                        let next_sibling = field.dot_token().and_then(|token| {\n+                            let dot_token = original_file.covering_element(token.text_range());\n+                            let next_sibling = dot_token.as_token().and_then(|t| t.next_token()).and_then(|t| next_non_trivia_sibling(t.into()));\n+                            next_sibling\n+                        });\n+                        match next_sibling {\n+                            Some(syntax::NodeOrToken::Node(n)) => n.first_child_or_token().map(|t| t.kind()) == Some(SyntaxKind::ELSE_KW),\n+                            Some(syntax::NodeOrToken::Token(t)) => t.kind()  == SyntaxKind::ELSE_KW,\n+                            None => false\n+                        }\n+                    },\n+                    _ => false\n+                };\n+                if reciever_is_part_of_indivisible_expression {\n+                    return None;\n+                }\n+\n                 let kind = NameRefKind::DotAccess(DotAccess {\n                     receiver_ty: receiver.as_ref().and_then(|it| sema.type_of_expr(it)),\n                     kind: DotAccessKind::Field { receiver_is_ambiguous_float_literal },"}]}