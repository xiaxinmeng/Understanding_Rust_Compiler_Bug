{"sha": "a2bbcb594fff51ecad2f9077467a29a6b2713319", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyYmJjYjU5NGZmZjUxZWNhZDJmOTA3NzQ2N2EyOWE2YjI3MTMzMTk=", "commit": {"author": {"name": "Jakub Wieczorek", "email": "jakub@jakub.cc", "date": "2014-06-08T17:37:45Z"}, "committer": {"name": "Jakub Wieczorek", "email": "jakub@jakub.cc", "date": "2014-06-08T17:43:38Z"}, "message": "Fix an LLVM assertion when matching against static strings\n\nFixes #8315\nFixes #11940", "tree": {"sha": "40143cfdd47851c46b83a3a8aa9b10a0de37b960", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/40143cfdd47851c46b83a3a8aa9b10a0de37b960"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2bbcb594fff51ecad2f9077467a29a6b2713319", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2bbcb594fff51ecad2f9077467a29a6b2713319", "html_url": "https://github.com/rust-lang/rust/commit/a2bbcb594fff51ecad2f9077467a29a6b2713319", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2bbcb594fff51ecad2f9077467a29a6b2713319/comments", "author": null, "committer": null, "parents": [{"sha": "17ba0cf4289d6da632aab4cf242ad74dea94fe37", "url": "https://api.github.com/repos/rust-lang/rust/commits/17ba0cf4289d6da632aab4cf242ad74dea94fe37", "html_url": "https://github.com/rust-lang/rust/commit/17ba0cf4289d6da632aab4cf242ad74dea94fe37"}], "stats": {"total": 38, "additions": 30, "deletions": 8}, "files": [{"sha": "f6fb6c8ba2013e6c4f0dacdab5c96d6c009ce500", "filename": "src/librustc/middle/trans/_match.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2F_match.rs?ref=a2bbcb594fff51ecad2f9077467a29a6b2713319", "patch": "@@ -312,9 +312,12 @@ fn trans_opt<'a>(bcx: &'a Block<'a>, o: &Opt) -> opt_result<'a> {\n             let datum = datum::rvalue_scratch_datum(bcx, struct_ty, \"\");\n             return single_result(Result::new(bcx, datum.val));\n         }\n-        lit(ConstLit(lit_id)) => {\n-            let (llval, _) = consts::get_const_val(bcx.ccx(), lit_id);\n-            return single_result(Result::new(bcx, llval));\n+        lit(l @ ConstLit(ref def_id)) => {\n+            let lit_ty = ty::node_id_to_type(bcx.tcx(), lit_to_expr(bcx.tcx(), &l).id);\n+            let (llval, _) = consts::get_const_val(bcx.ccx(), *def_id);\n+            let lit_datum = immediate_rvalue(llval, lit_ty);\n+            let lit_datum = unpack_datum!(bcx, lit_datum.to_appropriate_datum(bcx));\n+            return single_result(Result::new(bcx, lit_datum.val));\n         }\n         var(disr_val, ref repr) => {\n             return adt::trans_case(bcx, &**repr, disr_val);"}, {"sha": "9bd6b8ed3618c97b57397d274a6212b0af441960", "filename": "src/librustc/middle/trans/common.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs?ref=a2bbcb594fff51ecad2f9077467a29a6b2713319", "patch": "@@ -599,7 +599,7 @@ pub fn C_str_slice(cx: &CrateContext, s: InternedString) -> ValueRef {\n         let len = s.get().len();\n         let cs = llvm::LLVMConstPointerCast(C_cstr(cx, s, false),\n                                             Type::i8p(cx).to_ref());\n-        C_struct(cx, [cs, C_uint(cx, len)], false)\n+        C_named_struct(cx.tn.find_type(\"str_slice\").unwrap(), [cs, C_uint(cx, len)])\n     }\n }\n "}, {"sha": "a80ae9e2596da0c16a2f0c2ad488f2a215dfb43e", "filename": "src/librustc/middle/trans/context.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcontext.rs?ref=a2bbcb594fff51ecad2f9077467a29a6b2713319", "patch": "@@ -233,12 +233,12 @@ impl CrateContext {\n             ccx.int_type = Type::int(&ccx);\n             ccx.opaque_vec_type = Type::opaque_vec(&ccx);\n \n-            ccx.tn.associate_type(\"tydesc\", &Type::tydesc(&ccx));\n-\n             let mut str_slice_ty = Type::named_struct(&ccx, \"str_slice\");\n             str_slice_ty.set_struct_body([Type::i8p(&ccx), ccx.int_type], false);\n             ccx.tn.associate_type(\"str_slice\", &str_slice_ty);\n \n+            ccx.tn.associate_type(\"tydesc\", &Type::tydesc(&ccx, str_slice_ty));\n+\n             if ccx.sess().count_llvm_insns() {\n                 base::init_insn_ctxt()\n             }"}, {"sha": "5d58500f761a4581044d0af023814b4c5a4391ee", "filename": "src/librustc/middle/trans/type_.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_.rs?ref=a2bbcb594fff51ecad2f9077467a29a6b2713319", "patch": "@@ -186,7 +186,7 @@ impl Type {\n         Type::func([t], &Type::void(ccx))\n     }\n \n-    pub fn tydesc(ccx: &CrateContext) -> Type {\n+    pub fn tydesc(ccx: &CrateContext, str_slice_ty: Type) -> Type {\n         let mut tydesc = Type::named_struct(ccx, \"tydesc\");\n         let glue_fn_ty = Type::glue_fn(ccx, Type::i8p(ccx)).ptr_to();\n \n@@ -200,7 +200,7 @@ impl Type {\n                      int_ty,     // align\n                      glue_fn_ty, // drop\n                      glue_fn_ty, // visit\n-                     Type::struct_(ccx, [Type::i8p(ccx), Type::int(ccx)], false)]; // name\n+                     str_slice_ty]; // name\n         tydesc.set_struct_body(elems, false);\n \n         tydesc"}, {"sha": "bbe7eff229b0016beabb6b2e1263339428d4d652", "filename": "src/test/run-pass/issue-11940.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Ftest%2Frun-pass%2Fissue-11940.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2bbcb594fff51ecad2f9077467a29a6b2713319/src%2Ftest%2Frun-pass%2Fissue-11940.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-11940.rs?ref=a2bbcb594fff51ecad2f9077467a29a6b2713319", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+static TEST_STR: &'static str = \"abcd\";\n+\n+fn main() {\n+    let s = \"abcd\";\n+    match s {\n+        TEST_STR => (),\n+        _ => unreachable!()\n+    }\n+}"}]}