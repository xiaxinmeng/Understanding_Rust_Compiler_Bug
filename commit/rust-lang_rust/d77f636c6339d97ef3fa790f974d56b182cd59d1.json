{"sha": "d77f636c6339d97ef3fa790f974d56b182cd59d1", "node_id": "C_kwDOAAsO6NoAKGQ3N2Y2MzZjNjMzOWQ5N2VmM2ZhNzkwZjk3NGQ1NmIxODJjZDU5ZDE", "commit": {"author": {"name": "Augie Fackler", "email": "augie@google.com", "date": "2023-04-21T16:48:16Z"}, "committer": {"name": "Augie Fackler", "email": "augie@google.com", "date": "2023-04-21T17:15:04Z"}, "message": "libtest: add tests for junit output format\n\nI'm about to make some changes here, and it was making me uneasy to\nmodify the output format without test coverage.", "tree": {"sha": "80ea36009f15993c2c99a25ec9e27ad73508b54c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/80ea36009f15993c2c99a25ec9e27ad73508b54c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d77f636c6339d97ef3fa790f974d56b182cd59d1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d77f636c6339d97ef3fa790f974d56b182cd59d1", "html_url": "https://github.com/rust-lang/rust/commit/d77f636c6339d97ef3fa790f974d56b182cd59d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d77f636c6339d97ef3fa790f974d56b182cd59d1/comments", "author": {"login": "durin42", "id": 20269, "node_id": "MDQ6VXNlcjIwMjY5", "avatar_url": "https://avatars.githubusercontent.com/u/20269?v=4", "gravatar_id": "", "url": "https://api.github.com/users/durin42", "html_url": "https://github.com/durin42", "followers_url": "https://api.github.com/users/durin42/followers", "following_url": "https://api.github.com/users/durin42/following{/other_user}", "gists_url": "https://api.github.com/users/durin42/gists{/gist_id}", "starred_url": "https://api.github.com/users/durin42/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/durin42/subscriptions", "organizations_url": "https://api.github.com/users/durin42/orgs", "repos_url": "https://api.github.com/users/durin42/repos", "events_url": "https://api.github.com/users/durin42/events{/privacy}", "received_events_url": "https://api.github.com/users/durin42/received_events", "type": "User", "site_admin": false}, "committer": {"login": "durin42", "id": 20269, "node_id": "MDQ6VXNlcjIwMjY5", "avatar_url": "https://avatars.githubusercontent.com/u/20269?v=4", "gravatar_id": "", "url": "https://api.github.com/users/durin42", "html_url": "https://github.com/durin42", "followers_url": "https://api.github.com/users/durin42/followers", "following_url": "https://api.github.com/users/durin42/following{/other_user}", "gists_url": "https://api.github.com/users/durin42/gists{/gist_id}", "starred_url": "https://api.github.com/users/durin42/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/durin42/subscriptions", "organizations_url": "https://api.github.com/users/durin42/orgs", "repos_url": "https://api.github.com/users/durin42/repos", "events_url": "https://api.github.com/users/durin42/events{/privacy}", "received_events_url": "https://api.github.com/users/durin42/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1151ea6006020e227c74285b24ab53b7964524e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/1151ea6006020e227c74285b24ab53b7964524e6", "html_url": "https://github.com/rust-lang/rust/commit/1151ea6006020e227c74285b24ab53b7964524e6"}], "stats": {"total": 56, "additions": 56, "deletions": 0}, "files": [{"sha": "d97cafccf1fd46163e53487af6f93dbc5f1c9d17", "filename": "tests/run-make/libtest-junit/Makefile", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Flibtest-junit%2FMakefile?ref=d77f636c6339d97ef3fa790f974d56b182cd59d1", "patch": "@@ -0,0 +1,19 @@\n+# ignore-cross-compile\n+include ../tools.mk\n+\n+# Test expected libtest's junit output\n+\n+OUTPUT_FILE_DEFAULT := $(TMPDIR)/libtest-junit-output-default.xml\n+OUTPUT_FILE_STDOUT_SUCCESS := $(TMPDIR)/libtest-junit-output-stdout-success.xml\n+\n+all: f.rs validate_junit.py output-default.xml output-stdout-success.xml\n+\t$(RUSTC) --test f.rs\n+\tRUST_BACKTRACE=0 $(call RUN,f) -Z unstable-options --test-threads=1 --format=junit > $(OUTPUT_FILE_DEFAULT) || true\n+\tRUST_BACKTRACE=0 $(call RUN,f) -Z unstable-options --test-threads=1 --format=junit --show-output > $(OUTPUT_FILE_STDOUT_SUCCESS) || true\n+\n+\tcat $(OUTPUT_FILE_DEFAULT) | \"$(PYTHON)\" validate_junit.py\n+\tcat $(OUTPUT_FILE_STDOUT_SUCCESS) | \"$(PYTHON)\" validate_junit.py\n+\n+\t# Normalize the actual output and compare to expected output file\n+\tcat $(OUTPUT_FILE_DEFAULT) | sed 's/time=\"[0-9.]*\"/time=\"$$TIME\"/g' | diff output-default.xml -\n+\tcat $(OUTPUT_FILE_STDOUT_SUCCESS) | sed 's/time=\"[0-9.]*\"/time=\"$$TIME\"/g' | diff output-stdout-success.xml -"}, {"sha": "d360d77317d78543451ababb0f5ff3297883b14e", "filename": "tests/run-make/libtest-junit/f.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Ff.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Ff.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Flibtest-junit%2Ff.rs?ref=d77f636c6339d97ef3fa790f974d56b182cd59d1", "patch": "@@ -0,0 +1,23 @@\n+#[test]\n+fn a() {\n+    println!(\"print from successful test\");\n+    // Should pass\n+}\n+\n+#[test]\n+fn b() {\n+    println!(\"print from failing test\");\n+    assert!(false);\n+}\n+\n+#[test]\n+#[should_panic]\n+fn c() {\n+    assert!(false);\n+}\n+\n+#[test]\n+#[ignore = \"msg\"]\n+fn d() {\n+    assert!(false);\n+}"}, {"sha": "ea61562a33ccc523c655fd6c3835b84ead2beced", "filename": "tests/run-make/libtest-junit/output-default.xml", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Foutput-default.xml", "raw_url": "https://github.com/rust-lang/rust/raw/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Foutput-default.xml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Flibtest-junit%2Foutput-default.xml?ref=d77f636c6339d97ef3fa790f974d56b182cd59d1", "patch": "@@ -0,0 +1 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?><testsuites><testsuite name=\"test\" package=\"test\" id=\"0\" errors=\"0\" failures=\"1\" tests=\"4\" skipped=\"1\" ><testcase classname=\"unknown\" name=\"a\" time=\"$TIME\"/><testcase classname=\"unknown\" name=\"b\" time=\"$TIME\"><failure type=\"assert\"/></testcase><testcase classname=\"unknown\" name=\"c\" time=\"$TIME\"/><system-out/><system-err/></testsuite></testsuites>"}, {"sha": "ea61562a33ccc523c655fd6c3835b84ead2beced", "filename": "tests/run-make/libtest-junit/output-stdout-success.xml", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Foutput-stdout-success.xml", "raw_url": "https://github.com/rust-lang/rust/raw/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Foutput-stdout-success.xml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Flibtest-junit%2Foutput-stdout-success.xml?ref=d77f636c6339d97ef3fa790f974d56b182cd59d1", "patch": "@@ -0,0 +1 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?><testsuites><testsuite name=\"test\" package=\"test\" id=\"0\" errors=\"0\" failures=\"1\" tests=\"4\" skipped=\"1\" ><testcase classname=\"unknown\" name=\"a\" time=\"$TIME\"/><testcase classname=\"unknown\" name=\"b\" time=\"$TIME\"><failure type=\"assert\"/></testcase><testcase classname=\"unknown\" name=\"c\" time=\"$TIME\"/><system-out/><system-err/></testsuite></testsuites>"}, {"sha": "47a8e70ccc38c522fceecd99c899d0a875f6fa7f", "filename": "tests/run-make/libtest-junit/validate_junit.py", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Fvalidate_junit.py", "raw_url": "https://github.com/rust-lang/rust/raw/d77f636c6339d97ef3fa790f974d56b182cd59d1/tests%2Frun-make%2Flibtest-junit%2Fvalidate_junit.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Flibtest-junit%2Fvalidate_junit.py?ref=d77f636c6339d97ef3fa790f974d56b182cd59d1", "patch": "@@ -0,0 +1,12 @@\n+#!/usr/bin/env python\n+\n+import sys\n+import xml.etree.ElementTree as ET\n+\n+# Try to decode line in order to ensure it is a valid XML document\n+for line in sys.stdin:\n+    try:\n+        ET.fromstring(line)\n+    except ET.ParseError as pe:\n+        print(\"Invalid xml: %r\" % line)\n+        raise"}]}