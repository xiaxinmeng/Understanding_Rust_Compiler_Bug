{"sha": "98c8619502093f34ca82f8f26ccf32e753924440", "node_id": "C_kwDOAAsO6NoAKDk4Yzg2MTk1MDIwOTNmMzRjYTgyZjhmMjZjY2YzMmU3NTM5MjQ0NDA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-27T18:21:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-27T18:21:14Z"}, "message": "Auto merge of #89214 - smoelius:register_tool, r=petrochenkov\n\nPass real crate-level attributes to `pre_expansion_lint`\n\nThe PR concerns the unstable feature `register_tool` (#66079).\n\nThe feature's implementation requires the attributes of the crate being compiled, so that when attributes like `allow(foo::bar)` are encountered, it can be verified that `register_tool(foo)` appears in the crate root.\n\nHowever, the crate's attributes are not readily available during early lint passes. Specifically, on this line, `krate.attrs` appears to be the attributes of the current source file, not the attributes of the whole crate: https://github.com/rust-lang/rust/blob/bf642323d621dcefeef1d8ab4711aae36e357615/compiler/rustc_lint/src/context.rs#L815\n\nConsequently, \"unknown tool\" errors were being produced when `allow(foo::bar)` appeared in a submodule, even though `register_tool(foo)` appeared in the crate root.\n\nEDITED: The proposed fix is to obtain the real crate-level attributes in `configure_and_expand` and pass them to `pre_expansion_lint`. (See `@petrochenkov's` [comment](https://github.com/rust-lang/rust/pull/89214#issuecomment-926927072) below.)\n\nThe original \"prosed fix\" text follows.\n\n---\n\nThe proposed fix is to add an `error_on_unknown_tool` flag to `LintLevelsBuilder`. The flag controls whether \"unknown tool\" errors are emitted. The flag is set during late passes, but not earlier.\n\nMore specifically, this PR contains two commits:\n\n* The first adds a `known-tool-in-submodule` UI test that does not currently pass.\n* The second adds the `error_on_unknown_tool` flag. The new test passes with the addition of this flag.\n\nThis change has the added benefit of eliminating some errors that were duplicated in existing tests.\n\nTo the reviewer: please check that I implemented the UI test correctly.", "tree": {"sha": "b82a6ad2a09d4e6861de78dc9ed8c94aa07b529a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b82a6ad2a09d4e6861de78dc9ed8c94aa07b529a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/98c8619502093f34ca82f8f26ccf32e753924440", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/98c8619502093f34ca82f8f26ccf32e753924440", "html_url": "https://github.com/rust-lang/rust/commit/98c8619502093f34ca82f8f26ccf32e753924440", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/98c8619502093f34ca82f8f26ccf32e753924440/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b6ed3b675475abc01ce7e68bb75b457f0c85684", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b6ed3b675475abc01ce7e68bb75b457f0c85684", "html_url": "https://github.com/rust-lang/rust/commit/2b6ed3b675475abc01ce7e68bb75b457f0c85684"}, {"sha": "1e15bbe55214e5b9c56fae5809d387a12c98fd6e", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e15bbe55214e5b9c56fae5809d387a12c98fd6e", "html_url": "https://github.com/rust-lang/rust/commit/1e15bbe55214e5b9c56fae5809d387a12c98fd6e"}], "stats": {"total": 49, "additions": 43, "deletions": 6}, "files": [{"sha": "45ad2df82455b68f95ade12e96bc45c7924dbd69", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/98c8619502093f34ca82f8f26ccf32e753924440/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98c8619502093f34ca82f8f26ccf32e753924440/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=98c8619502093f34ca82f8f26ccf32e753924440", "patch": "@@ -240,13 +240,15 @@ fn pre_expansion_lint(\n     sess: &Session,\n     lint_store: &LintStore,\n     krate: &ast::Crate,\n+    crate_attrs: &[ast::Attribute],\n     crate_name: &str,\n ) {\n     sess.prof.generic_activity_with_arg(\"pre_AST_expansion_lint_checks\", crate_name).run(|| {\n         rustc_lint::check_ast_crate(\n             sess,\n             lint_store,\n             &krate,\n+            crate_attrs,\n             true,\n             None,\n             rustc_lint::BuiltinCombinedPreExpansionLintPass::new(),\n@@ -266,7 +268,7 @@ pub fn configure_and_expand(\n     resolver: &mut Resolver<'_>,\n ) -> Result<ast::Crate> {\n     tracing::trace!(\"configure_and_expand\");\n-    pre_expansion_lint(sess, lint_store, &krate, crate_name);\n+    pre_expansion_lint(sess, lint_store, &krate, &krate.attrs, crate_name);\n     rustc_builtin_macros::register_builtin_macros(resolver);\n \n     krate = sess.time(\"crate_injection\", || {\n@@ -322,9 +324,10 @@ pub fn configure_and_expand(\n             ..rustc_expand::expand::ExpansionConfig::default(crate_name.to_string())\n         };\n \n+        let crate_attrs = krate.attrs.clone();\n         let extern_mod_loaded = |ident: Ident, attrs, items, span| {\n             let krate = ast::Crate { attrs, items, span };\n-            pre_expansion_lint(sess, lint_store, &krate, &ident.name.as_str());\n+            pre_expansion_lint(sess, lint_store, &krate, &crate_attrs, &ident.name.as_str());\n             (krate.attrs, krate.items)\n         };\n         let mut ecx = ExtCtxt::new(&sess, cfg, resolver, Some(&extern_mod_loaded));\n@@ -468,6 +471,7 @@ pub fn lower_to_hir<'res, 'tcx>(\n             sess,\n             lint_store,\n             &krate,\n+            &krate.attrs,\n             false,\n             Some(std::mem::take(resolver.lint_buffer())),\n             rustc_lint::BuiltinCombinedEarlyLintPass::new(),"}, {"sha": "8cbd2ddcbfdf733028ac1f350df837d2471eadb1", "filename": "compiler/rustc_lint/src/context.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/98c8619502093f34ca82f8f26ccf32e753924440/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98c8619502093f34ca82f8f26ccf32e753924440/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs?ref=98c8619502093f34ca82f8f26ccf32e753924440", "patch": "@@ -805,14 +805,15 @@ impl<'a> EarlyContext<'a> {\n         sess: &'a Session,\n         lint_store: &'a LintStore,\n         krate: &'a ast::Crate,\n+        crate_attrs: &'a [ast::Attribute],\n         buffered: LintBuffer,\n         warn_about_weird_lints: bool,\n     ) -> EarlyContext<'a> {\n         EarlyContext {\n             sess,\n             krate,\n             lint_store,\n-            builder: LintLevelsBuilder::new(sess, warn_about_weird_lints, lint_store, &krate.attrs),\n+            builder: LintLevelsBuilder::new(sess, warn_about_weird_lints, lint_store, crate_attrs),\n             buffered,\n         }\n     }"}, {"sha": "0bba66d383869469c4728ad299a40ea6342a7d26", "filename": "compiler/rustc_lint/src/early.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/98c8619502093f34ca82f8f26ccf32e753924440/compiler%2Frustc_lint%2Fsrc%2Fearly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98c8619502093f34ca82f8f26ccf32e753924440/compiler%2Frustc_lint%2Fsrc%2Fearly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fearly.rs?ref=98c8619502093f34ca82f8f26ccf32e753924440", "patch": "@@ -329,12 +329,20 @@ fn early_lint_crate<T: EarlyLintPass>(\n     sess: &Session,\n     lint_store: &LintStore,\n     krate: &ast::Crate,\n+    crate_attrs: &[ast::Attribute],\n     pass: T,\n     buffered: LintBuffer,\n     warn_about_weird_lints: bool,\n ) -> LintBuffer {\n     let mut cx = EarlyContextAndPass {\n-        context: EarlyContext::new(sess, lint_store, krate, buffered, warn_about_weird_lints),\n+        context: EarlyContext::new(\n+            sess,\n+            lint_store,\n+            krate,\n+            crate_attrs,\n+            buffered,\n+            warn_about_weird_lints,\n+        ),\n         pass,\n     };\n \n@@ -355,6 +363,7 @@ pub fn check_ast_crate<T: EarlyLintPass>(\n     sess: &Session,\n     lint_store: &LintStore,\n     krate: &ast::Crate,\n+    crate_attrs: &[ast::Attribute],\n     pre_expansion: bool,\n     lint_buffer: Option<LintBuffer>,\n     builtin_lints: T,\n@@ -365,14 +374,22 @@ pub fn check_ast_crate<T: EarlyLintPass>(\n     let mut buffered = lint_buffer.unwrap_or_default();\n \n     if !sess.opts.debugging_opts.no_interleave_lints {\n-        buffered =\n-            early_lint_crate(sess, lint_store, krate, builtin_lints, buffered, pre_expansion);\n+        buffered = early_lint_crate(\n+            sess,\n+            lint_store,\n+            krate,\n+            crate_attrs,\n+            builtin_lints,\n+            buffered,\n+            pre_expansion,\n+        );\n \n         if !passes.is_empty() {\n             buffered = early_lint_crate(\n                 sess,\n                 lint_store,\n                 krate,\n+                crate_attrs,\n                 EarlyLintPassObjects { lints: &mut passes[..] },\n                 buffered,\n                 false,\n@@ -386,6 +403,7 @@ pub fn check_ast_crate<T: EarlyLintPass>(\n                         sess,\n                         lint_store,\n                         krate,\n+                        crate_attrs,\n                         EarlyLintPassObjects { lints: slice::from_mut(pass) },\n                         buffered,\n                         pre_expansion && i == 0,"}, {"sha": "80806dcbd280a4e1acd9747e9dc3afc6fd44c65d", "filename": "src/test/ui/lint/known-tool-in-submodule/root.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/98c8619502093f34ca82f8f26ccf32e753924440/src%2Ftest%2Fui%2Flint%2Fknown-tool-in-submodule%2Froot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98c8619502093f34ca82f8f26ccf32e753924440/src%2Ftest%2Fui%2Flint%2Fknown-tool-in-submodule%2Froot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fknown-tool-in-submodule%2Froot.rs?ref=98c8619502093f34ca82f8f26ccf32e753924440", "patch": "@@ -0,0 +1,10 @@\n+// check-pass\n+\n+#![feature(register_tool)]\n+#![register_tool(tool)]\n+\n+mod submodule;\n+\n+fn main() {\n+    submodule::foo();\n+}"}, {"sha": "bb25e10056fae845fcd1165ad06483df0cecedd7", "filename": "src/test/ui/lint/known-tool-in-submodule/submodule.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/98c8619502093f34ca82f8f26ccf32e753924440/src%2Ftest%2Fui%2Flint%2Fknown-tool-in-submodule%2Fsubmodule.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98c8619502093f34ca82f8f26ccf32e753924440/src%2Ftest%2Fui%2Flint%2Fknown-tool-in-submodule%2Fsubmodule.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fknown-tool-in-submodule%2Fsubmodule.rs?ref=98c8619502093f34ca82f8f26ccf32e753924440", "patch": "@@ -0,0 +1,4 @@\n+// ignore-test: not a test\n+\n+#[allow(tool::lint)]\n+pub fn foo() {}"}]}