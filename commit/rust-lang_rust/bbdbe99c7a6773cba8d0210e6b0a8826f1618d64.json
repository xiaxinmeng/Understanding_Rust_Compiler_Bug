{"sha": "bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiZGJlOTljN2E2NzczY2JhOGQwMjEwZTZiMGE4ODI2ZjE2MThkNjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-07-04T01:17:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-04T01:17:36Z"}, "message": "Auto merge of #34480 - jseyfried:remove_entry_points, r=nrc\n\nRemove redundant `CompileController` entry points\n\nRemove the `after_expand` and `after_write_deps` `CompileController` entry points.\n\nThe only things that separate these entry points from `after_hir_lowering` are dep-info generation and HIR map construction, neither of which is computationally intensive or has the potential to error.\n\nr? @nrc", "tree": {"sha": "5e5d28a3a3206f4af78f2e74989cfb1b2d93e44a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e5d28a3a3206f4af78f2e74989cfb1b2d93e44a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "html_url": "https://github.com/rust-lang/rust/commit/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "696b703b5a58816bb0e549ac332a98fa7e635949", "url": "https://api.github.com/repos/rust-lang/rust/commits/696b703b5a58816bb0e549ac332a98fa7e635949", "html_url": "https://github.com/rust-lang/rust/commit/696b703b5a58816bb0e549ac332a98fa7e635949"}, {"sha": "d1e3d6272e5128e15ba0ea3bd7c4588b5e8c444a", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1e3d6272e5128e15ba0ea3bd7c4588b5e8c444a", "html_url": "https://github.com/rust-lang/rust/commit/d1e3d6272e5128e15ba0ea3bd7c4588b5e8c444a"}], "stats": {"total": 138, "additions": 57, "deletions": 81}, "files": [{"sha": "7fd4e3643be57a429992a7e4c02d3b595eb213ce", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 36, "deletions": 52, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -116,34 +116,20 @@ pub fn compile_input(sess: &Session,\n         let outputs = build_output_filenames(input, outdir, output, &krate.attrs, sess);\n         let id = link::find_crate_name(Some(sess), &krate.attrs, input);\n         let ExpansionResult { expanded_crate, defs, analysis, resolutions, mut hir_forest } = {\n-            let make_glob_map = control.make_glob_map;\n-            phase_2_configure_and_expand(sess, &cstore, krate, &id, addl_plugins, make_glob_map)?\n+            phase_2_configure_and_expand(\n+                sess, &cstore, krate, &id, addl_plugins, control.make_glob_map,\n+                |expanded_crate| {\n+                    let mut state = CompileState::state_after_expand(\n+                        input, sess, outdir, output, &cstore, expanded_crate, &id,\n+                    );\n+                    controller_entry_point!(after_expand, sess, state, Ok(()));\n+                    Ok(())\n+                }\n+            )?\n         };\n \n-        controller_entry_point!(after_expand,\n-                                sess,\n-                                CompileState::state_after_expand(input,\n-                                                                 sess,\n-                                                                 outdir,\n-                                                                 output,\n-                                                                 &cstore,\n-                                                                 &expanded_crate,\n-                                                                 &id),\n-                                Ok(()));\n-\n         write_out_deps(sess, &outputs, &id);\n \n-        controller_entry_point!(after_write_deps,\n-                                sess,\n-                                CompileState::state_after_write_deps(input,\n-                                                                     sess,\n-                                                                     outdir,\n-                                                                     output,\n-                                                                     &cstore,\n-                                                                     &expanded_crate,\n-                                                                     &id),\n-                                Ok(()));\n-\n         let arenas = ty::CtxtArenas::new();\n \n         // Construct the HIR map\n@@ -285,7 +271,6 @@ pub fn source_name(input: &Input) -> String {\n pub struct CompileController<'a> {\n     pub after_parse: PhaseController<'a>,\n     pub after_expand: PhaseController<'a>,\n-    pub after_write_deps: PhaseController<'a>,\n     pub after_hir_lowering: PhaseController<'a>,\n     pub after_analysis: PhaseController<'a>,\n     pub after_llvm: PhaseController<'a>,\n@@ -298,7 +283,6 @@ impl<'a> CompileController<'a> {\n         CompileController {\n             after_parse: PhaseController::basic(),\n             after_expand: PhaseController::basic(),\n-            after_write_deps: PhaseController::basic(),\n             after_hir_lowering: PhaseController::basic(),\n             after_analysis: PhaseController::basic(),\n             after_llvm: PhaseController::basic(),\n@@ -406,23 +390,6 @@ impl<'a, 'b, 'ast, 'tcx> CompileState<'a, 'b, 'ast, 'tcx> {\n         }\n     }\n \n-    fn state_after_write_deps(input: &'a Input,\n-                              session: &'ast Session,\n-                              out_dir: &'a Option<PathBuf>,\n-                              out_file: &'a Option<PathBuf>,\n-                              cstore: &'a CStore,\n-                              krate: &'a ast::Crate,\n-                              crate_name: &'a str)\n-                              -> CompileState<'a, 'b, 'ast, 'tcx> {\n-        CompileState {\n-            crate_name: Some(crate_name),\n-            cstore: Some(cstore),\n-            expanded_crate: Some(krate),\n-            out_file: out_file.as_ref().map(|s| &**s),\n-            ..CompileState::empty(input, session, out_dir)\n-        }\n-    }\n-\n     fn state_after_hir_lowering(input: &'a Input,\n                                 session: &'ast Session,\n                                 out_dir: &'a Option<PathBuf>,\n@@ -556,13 +523,16 @@ pub struct ExpansionResult<'a> {\n /// standard library and prelude, and name resolution.\n ///\n /// Returns `None` if we're aborting after handling -W help.\n-pub fn phase_2_configure_and_expand<'a>(sess: &Session,\n-                                        cstore: &CStore,\n-                                        mut krate: ast::Crate,\n-                                        crate_name: &'a str,\n-                                        addl_plugins: Option<Vec<String>>,\n-                                        make_glob_map: MakeGlobMap)\n-                                        -> Result<ExpansionResult<'a>, usize> {\n+pub fn phase_2_configure_and_expand<'a, F>(sess: &Session,\n+                                           cstore: &CStore,\n+                                           mut krate: ast::Crate,\n+                                           crate_name: &'a str,\n+                                           addl_plugins: Option<Vec<String>>,\n+                                           make_glob_map: MakeGlobMap,\n+                                           after_expand: F)\n+                                           -> Result<ExpansionResult<'a>, usize>\n+    where F: FnOnce(&ast::Crate) -> CompileResult,\n+{\n     let time_passes = sess.time_passes();\n \n     // strip before anything else because crate metadata may use #[cfg_attr]\n@@ -745,9 +715,23 @@ pub fn phase_2_configure_and_expand<'a>(sess: &Session,\n          \"AST validation\",\n          || ast_validation::check_crate(sess, &krate));\n \n-    time(sess.time_passes(), \"name resolution\", || {\n+    time(sess.time_passes(), \"name resolution\", || -> CompileResult {\n+        // Currently, we ignore the name resolution data structures for the purposes of dependency\n+        // tracking. Instead we will run name resolution and include its output in the hash of each\n+        // item, much like we do for macro expansion. In other words, the hash reflects not just\n+        // its contents but the results of name resolution on those contents. Hopefully we'll push\n+        // this back at some point.\n+        let _ignore = sess.dep_graph.in_ignore();\n+        resolver.build_reduced_graph(&krate);\n+        resolver.resolve_imports();\n+\n+        // Since import resolution will eventually happen in expansion,\n+        // don't perform `after_expand` until after import resolution.\n+        after_expand(&krate)?;\n+\n         resolver.resolve_crate(&krate);\n-    });\n+        Ok(())\n+    })?;\n \n     // Lower ast -> hir.\n     let hir_forest = time(sess.time_passes(), \"lowering ast -> hir\", || {"}, {"sha": "c9569a63436f5f1b2e5a891d1260d1324d54704d", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -511,7 +511,7 @@ impl<'a> CompilerCalls<'a> for RustcDefaultCalls {\n         }\n \n         if sess.opts.no_analysis || sess.opts.debugging_opts.ast_json {\n-            control.after_write_deps.stop = Compilation::Stop;\n+            control.after_hir_lowering.stop = Compilation::Stop;\n         }\n \n         if !sess.opts.output_types.keys().any(|&i| i == OutputType::Exe) {"}, {"sha": "15a0ab0f284b3efdde3be345078029b4be4446af", "filename": "src/librustc_driver/test.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_driver%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_driver%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Ftest.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -116,9 +116,11 @@ fn test_env<F>(source_string: &str,\n         input: source_string.to_string(),\n     };\n     let krate = driver::phase_1_parse_input(&sess, krate_config, &input).unwrap();\n-    let driver::ExpansionResult { defs, resolutions, mut hir_forest, .. } =\n-        driver::phase_2_configure_and_expand(&sess, &cstore, krate, \"test\", None, MakeGlobMap::No)\n-            .expect(\"phase 2 aborted\");\n+    let driver::ExpansionResult { defs, resolutions, mut hir_forest, .. } = {\n+        driver::phase_2_configure_and_expand(\n+            &sess, &cstore, krate, \"test\", None, MakeGlobMap::No, |_| Ok(()),\n+        ).expect(\"phase 2 aborted\")\n+    };\n     let _ignore = dep_graph.in_ignore();\n \n     let arenas = ty::CtxtArenas::new();"}, {"sha": "66b0d663424aa829a95c673de86b76e27b63ae8e", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -1167,18 +1167,6 @@ impl<'a> Resolver<'a> {\n \n     /// Entry point to crate resolution.\n     pub fn resolve_crate(&mut self, krate: &Crate) {\n-        // Currently, we ignore the name resolution data structures for\n-        // the purposes of dependency tracking. Instead we will run name\n-        // resolution and include its output in the hash of each item,\n-        // much like we do for macro expansion. In other words, the hash\n-        // reflects not just its contents but the results of name\n-        // resolution on those contents. Hopefully we'll push this back at\n-        // some point.\n-        let _ignore = self.session.dep_graph.in_ignore();\n-\n-        self.build_reduced_graph(krate);\n-        resolve_imports::resolve_imports(self);\n-\n         self.current_module = self.graph_root;\n         visit::walk_crate(self, krate);\n "}, {"sha": "16a59fbb800024afcd24c43de94a8b15307da684", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -30,6 +30,12 @@ use syntax_pos::{Span, DUMMY_SP};\n \n use std::cell::{Cell, RefCell};\n \n+impl<'a> Resolver<'a> {\n+    pub fn resolve_imports(&mut self) {\n+        ImportResolver { resolver: self }.resolve_imports();\n+    }\n+}\n+\n /// Contains data for specific types of import directives.\n #[derive(Clone, Debug)]\n pub enum ImportDirectiveSubclass {\n@@ -722,8 +728,3 @@ fn import_directive_subclass_to_string(subclass: &ImportDirectiveSubclass) -> St\n         GlobImport { .. } => \"*\".to_string(),\n     }\n }\n-\n-pub fn resolve_imports(resolver: &mut Resolver) {\n-    let mut import_resolver = ImportResolver { resolver: resolver };\n-    import_resolver.resolve_imports();\n-}"}, {"sha": "85ea94e02e8d794014a13263b2d9db970337abe6", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -149,9 +149,9 @@ pub fn run_core(search_paths: SearchPaths,\n     let name = link::find_crate_name(Some(&sess), &krate.attrs, &input);\n \n     let driver::ExpansionResult { defs, analysis, resolutions, mut hir_forest, .. } = {\n-        let make_glob_map = resolve::MakeGlobMap::No;\n-        driver::phase_2_configure_and_expand(&sess, &cstore, krate, &name, None, make_glob_map)\n-            .expect(\"phase_2_configure_and_expand aborted in rustdoc!\")\n+        driver::phase_2_configure_and_expand(\n+            &sess, &cstore, krate, &name, None, resolve::MakeGlobMap::No, |_| Ok(()),\n+        ).expect(\"phase_2_configure_and_expand aborted in rustdoc!\")\n     };\n \n     let arenas = ty::CtxtArenas::new();"}, {"sha": "e3bc8037d13b67b0395baeb7560bb6b964a8c283", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -95,9 +95,9 @@ pub fn run(input: &str,\n     cfg.extend(config::parse_cfgspecs(cfgs.clone()));\n     let krate = panictry!(driver::phase_1_parse_input(&sess, cfg, &input));\n     let driver::ExpansionResult { defs, mut hir_forest, .. } = {\n-        let make_glob_map = MakeGlobMap::No;\n-        phase_2_configure_and_expand(&sess, &cstore, krate, \"rustdoc-test\", None, make_glob_map)\n-            .expect(\"phase_2_configure_and_expand aborted in rustdoc!\")\n+        phase_2_configure_and_expand(\n+            &sess, &cstore, krate, \"rustdoc-test\", None, MakeGlobMap::No, |_| Ok(())\n+        ).expect(\"phase_2_configure_and_expand aborted in rustdoc!\")\n     };\n \n     let dep_graph = DepGraph::new(false);"}, {"sha": "21e1463b6ef955efdf9929e42acf2f4944c7deaa", "filename": "src/test/run-make/execution-engine/test.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Ftest%2Frun-make%2Fexecution-engine%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbdbe99c7a6773cba8d0210e6b0a8826f1618d64/src%2Ftest%2Frun-make%2Fexecution-engine%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fexecution-engine%2Ftest.rs?ref=bbdbe99c7a6773cba8d0210e6b0a8826f1618d64", "patch": "@@ -241,8 +241,9 @@ fn compile_program(input: &str, sysroot: PathBuf)\n         let krate = panictry!(driver::phase_1_parse_input(&sess, cfg, &input));\n \n         let driver::ExpansionResult { defs, analysis, resolutions, mut hir_forest, .. } = {\n-            driver::phase_2_configure_and_expand(&sess, &cstore, krate, &id, None, MakeGlobMap::No)\n-                .expect(\"phase_2 returned `None`\")\n+            driver::phase_2_configure_and_expand(\n+                &sess, &cstore, krate, &id, None, MakeGlobMap::No, |_| Ok(()),\n+            ).expect(\"phase_2 returned `None`\")\n         };\n \n         let arenas = ty::CtxtArenas::new();"}]}