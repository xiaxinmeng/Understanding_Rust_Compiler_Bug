{"sha": "5a25e1dad4b50fcda0f86fd188536f212d751c6f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVhMjVlMWRhZDRiNTBmY2RhMGY4NmZkMTg4NTM2ZjIxMmQ3NTFjNmY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2017-08-20T14:49:03Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2017-08-20T14:57:36Z"}, "message": "Make sure crates not opting in to staged_api don't use staged_api", "tree": {"sha": "8bf292aacca9b20b4214c8febee30a93ecc4cc11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8bf292aacca9b20b4214c8febee30a93ecc4cc11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5a25e1dad4b50fcda0f86fd188536f212d751c6f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5a25e1dad4b50fcda0f86fd188536f212d751c6f", "html_url": "https://github.com/rust-lang/rust/commit/5a25e1dad4b50fcda0f86fd188536f212d751c6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5a25e1dad4b50fcda0f86fd188536f212d751c6f/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "350434370d72bd29cd7ba190b34f2734ca4f314a", "url": "https://api.github.com/repos/rust-lang/rust/commits/350434370d72bd29cd7ba190b34f2734ca4f314a", "html_url": "https://github.com/rust-lang/rust/commit/350434370d72bd29cd7ba190b34f2734ca4f314a"}], "stats": {"total": 13, "additions": 12, "deletions": 1}, "files": [{"sha": "d2ed29a3a0ff636c3d778b9ed9c26e81e62c85f6", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5a25e1dad4b50fcda0f86fd188536f212d751c6f/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a25e1dad4b50fcda0f86fd188536f212d751c6f/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=5a25e1dad4b50fcda0f86fd188536f212d751c6f", "patch": "@@ -123,7 +123,8 @@ impl<'a, 'tcx: 'a> Annotator<'a, 'tcx> {\n                    item_sp: Span, kind: AnnotationKind, visit_children: F)\n         where F: FnOnce(&mut Self)\n     {\n-        if self.index.staged_api[&LOCAL_CRATE] {\n+        if self.tcx.sess.features.borrow().staged_api {\n+            // This crate explicitly wants staged API.\n             debug!(\"annotate(id = {:?}, attrs = {:?})\", id, attrs);\n             if let Some(..) = attr::find_deprecation(self.tcx.sess.diagnostic(), attrs, item_sp) {\n                 self.tcx.sess.span_err(item_sp, \"`#[deprecated]` cannot be used in staged api, \\\n@@ -204,6 +205,15 @@ impl<'a, 'tcx: 'a> Annotator<'a, 'tcx> {\n                 }\n             }\n \n+            // Propagate unstability.  This can happen even for non-staged-api crates in case\n+            // -Zforce-unstable-if-unmarked is set.\n+            if let Some(stab) = self.parent_stab {\n+                if stab.level.is_unstable() {\n+                    let def_id = self.tcx.hir.local_def_id(id);\n+                    self.index.stab_map.insert(def_id, Some(stab));\n+                }\n+            }\n+\n             if let Some(depr) = attr::find_deprecation(self.tcx.sess.diagnostic(), attrs, item_sp) {\n                 if kind == AnnotationKind::Prohibited {\n                     self.tcx.sess.span_err(item_sp, \"This deprecation annotation is useless\");"}, {"sha": "5e34688f8cb8f0e7ffc6997cee5aa353bf728843", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5a25e1dad4b50fcda0f86fd188536f212d751c6f/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a25e1dad4b50fcda0f86fd188536f212d751c6f/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=5a25e1dad4b50fcda0f86fd188536f212d751c6f", "patch": "@@ -37,6 +37,7 @@\n #![feature(libc)]\n #![feature(set_stdio)]\n #![feature(panic_unwind)]\n+#![feature(staged_api)]\n \n extern crate getopts;\n extern crate term;"}]}