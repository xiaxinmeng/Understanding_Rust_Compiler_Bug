{"sha": "67ec96955f4a08c1005bda843d48ca73ea171c9e", "node_id": "C_kwDOAAsO6NoAKDY3ZWM5Njk1NWY0YTA4YzEwMDViZGE4NDNkNDhjYTczZWExNzFjOWU", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-06-05T15:14:30Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-06-05T16:27:08Z"}, "message": "validating the vtable can lead to Stacked Borrows errors", "tree": {"sha": "e19a28f74ca0d79f0848d13f1aa4a8a2abdf6a56", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e19a28f74ca0d79f0848d13f1aa4a8a2abdf6a56"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/67ec96955f4a08c1005bda843d48ca73ea171c9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/67ec96955f4a08c1005bda843d48ca73ea171c9e", "html_url": "https://github.com/rust-lang/rust/commit/67ec96955f4a08c1005bda843d48ca73ea171c9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/67ec96955f4a08c1005bda843d48ca73ea171c9e/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4322a785cc99ea5fc81dd7f5fc8ba7f7a64b08ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/4322a785cc99ea5fc81dd7f5fc8ba7f7a64b08ef", "html_url": "https://github.com/rust-lang/rust/commit/4322a785cc99ea5fc81dd7f5fc8ba7f7a64b08ef"}], "stats": {"total": 8, "additions": 8, "deletions": 0}, "files": [{"sha": "630281bb09254ec90b401737ed88c94970e72898", "filename": "compiler/rustc_const_eval/src/interpret/validity.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/67ec96955f4a08c1005bda843d48ca73ea171c9e/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/67ec96955f4a08c1005bda843d48ca73ea171c9e/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs?ref=67ec96955f4a08c1005bda843d48ca73ea171c9e", "patch": "@@ -338,6 +338,10 @@ impl<'rt, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> ValidityVisitor<'rt, 'mir, '\n                         { \"invalid drop function pointer in vtable (not pointing to a function)\" },\n                     err_ub!(InvalidVtableDropFn(..)) =>\n                         { \"invalid drop function pointer in vtable (function has incompatible signature)\" },\n+                    // Stacked Borrows errors can happen here, see https://github.com/rust-lang/miri/issues/2123.\n+                    // (We assume there are no other MachineStop errors possible here.)\n+                    InterpError::MachineStop(_) =>\n+                        { \"vtable pointer does not have permission to read drop function pointer\" },\n                 );\n                 try_validation!(\n                     self.ecx.read_size_and_align_from_vtable(vtable),\n@@ -347,6 +351,10 @@ impl<'rt, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> ValidityVisitor<'rt, 'mir, '\n                     err_ub!(InvalidVtableAlignment(msg)) =>\n                         { \"invalid vtable: alignment {}\", msg },\n                     err_unsup!(ReadPointerAsBytes) => { \"invalid size or align in vtable\" },\n+                    // Stacked Borrows errors can happen here, see https://github.com/rust-lang/miri/issues/2123.\n+                    // (We assume there are no other MachineStop errors possible here.)\n+                    InterpError::MachineStop(_) =>\n+                        { \"vtable pointer does not have permission to read size and alignment\" },\n                 );\n                 // FIXME: More checks for the vtable.\n             }"}]}