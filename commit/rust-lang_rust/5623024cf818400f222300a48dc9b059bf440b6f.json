{"sha": "5623024cf818400f222300a48dc9b059bf440b6f", "node_id": "C_kwDOAAsO6NoAKDU2MjMwMjRjZjgxODQwMGYyMjIzMDBhNDhkYzliMDU5YmY0NDBiNmY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-10-27T13:03:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-27T13:03:57Z"}, "message": "Rollup merge of #103505 - notriddle:notriddle/rustdoc-self-closing-tags, r=GuillaumeGomez\n\nrustdoc: parse self-closing tags and attributes in `invalid_html_tags`\n\nFixes #103460", "tree": {"sha": "a90b3b9cb2467fe7c1de44b0682ddfc68a60e415", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a90b3b9cb2467fe7c1de44b0682ddfc68a60e415"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5623024cf818400f222300a48dc9b059bf440b6f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjWoG9CRBK7hj4Ov3rIwAABwoIABi++xvtfi1dY23VjyvT4ilu\nld6jt210VKWVWx4mG1RNRZWwgq3xb+XPqEnYSuK3BevHEPDwM07nKoduA2rLTOhg\nrUlEHB6YMNMRKPdb0jXTkjlf+kaHb0Y1C5OKsGV7kdY/zsjiimcInUmWbCyy/I6q\nfGOyLupmEPexWAl8kes8VcdlAEvHNERdqL572NactU33J7IVK6xS3HXAaBWWPMi5\nQEyoJV7zrSjDnuX6Ve3/32HB0Uid9ZDqaLxdSvM17QVRn702S7tf8TzmcirUmIcN\n8GYK7gQuq5/Z6yTl75PnrOVnI6CFoeA7njEFrmZ30wgdQ+VSe+Sge2GvNvNOIBo=\n=kbzQ\n-----END PGP SIGNATURE-----\n", "payload": "tree a90b3b9cb2467fe7c1de44b0682ddfc68a60e415\nparent 571771e54aa858978d6b636c41f90941ea1ad3b7\nparent f9cace081d27469d4f8c4f50218cd5b7c0fbf419\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1666875837 +0200\ncommitter GitHub <noreply@github.com> 1666875837 +0200\n\nRollup merge of #103505 - notriddle:notriddle/rustdoc-self-closing-tags, r=GuillaumeGomez\n\nrustdoc: parse self-closing tags and attributes in `invalid_html_tags`\n\nFixes #103460\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5623024cf818400f222300a48dc9b059bf440b6f", "html_url": "https://github.com/rust-lang/rust/commit/5623024cf818400f222300a48dc9b059bf440b6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5623024cf818400f222300a48dc9b059bf440b6f/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "571771e54aa858978d6b636c41f90941ea1ad3b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/571771e54aa858978d6b636c41f90941ea1ad3b7", "html_url": "https://github.com/rust-lang/rust/commit/571771e54aa858978d6b636c41f90941ea1ad3b7"}, {"sha": "f9cace081d27469d4f8c4f50218cd5b7c0fbf419", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9cace081d27469d4f8c4f50218cd5b7c0fbf419", "html_url": "https://github.com/rust-lang/rust/commit/f9cace081d27469d4f8c4f50218cd5b7c0fbf419"}], "stats": {"total": 205, "additions": 204, "deletions": 1}, "files": [{"sha": "a89ed7c7ed4546082e8d407d784efe92f41396bd", "filename": "src/librustdoc/passes/html_tags.rs", "status": "modified", "additions": 54, "deletions": 1, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/5623024cf818400f222300a48dc9b059bf440b6f/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5623024cf818400f222300a48dc9b059bf440b6f/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs?ref=5623024cf818400f222300a48dc9b059bf440b6f", "patch": "@@ -184,7 +184,60 @@ fn extract_html_tag(\n                     }\n                     drop_tag(tags, tag_name, r, f);\n                 } else {\n-                    tags.push((tag_name, r));\n+                    let mut is_self_closing = false;\n+                    let mut quote_pos = None;\n+                    if c != '>' {\n+                        let mut quote = None;\n+                        let mut after_eq = false;\n+                        for (i, c) in text[pos..].char_indices() {\n+                            if !c.is_whitespace() {\n+                                if let Some(q) = quote {\n+                                    if c == q {\n+                                        quote = None;\n+                                        quote_pos = None;\n+                                        after_eq = false;\n+                                    }\n+                                } else if c == '>' {\n+                                    break;\n+                                } else if c == '/' && !after_eq {\n+                                    is_self_closing = true;\n+                                } else {\n+                                    if is_self_closing {\n+                                        is_self_closing = false;\n+                                    }\n+                                    if (c == '\"' || c == '\\'') && after_eq {\n+                                        quote = Some(c);\n+                                        quote_pos = Some(pos + i);\n+                                    } else if c == '=' {\n+                                        after_eq = true;\n+                                    }\n+                                }\n+                            } else if quote.is_none() {\n+                                after_eq = false;\n+                            }\n+                        }\n+                    }\n+                    if let Some(quote_pos) = quote_pos {\n+                        let qr = Range { start: quote_pos, end: quote_pos };\n+                        f(\n+                            &format!(\"unclosed quoted HTML attribute on tag `{}`\", tag_name),\n+                            &qr,\n+                            false,\n+                        );\n+                    }\n+                    if is_self_closing {\n+                        // https://html.spec.whatwg.org/#parse-error-non-void-html-element-start-tag-with-trailing-solidus\n+                        let valid = ALLOWED_UNCLOSED.contains(&&tag_name[..])\n+                            || tags.iter().take(pos + 1).any(|(at, _)| {\n+                                let at = at.to_lowercase();\n+                                at == \"svg\" || at == \"math\"\n+                            });\n+                        if !valid {\n+                            f(&format!(\"invalid self-closing HTML tag `{}`\", tag_name), &r, false);\n+                        }\n+                    } else {\n+                        tags.push((tag_name, r));\n+                    }\n                 }\n             }\n             break;"}, {"sha": "d973a53cbc7cea9d5cddfa83438d3f0bbf3435af", "filename": "src/test/rustdoc-ui/invalid-html-self-closing-tag.rs", "status": "added", "additions": 70, "deletions": 0, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/5623024cf818400f222300a48dc9b059bf440b6f/src%2Ftest%2Frustdoc-ui%2Finvalid-html-self-closing-tag.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5623024cf818400f222300a48dc9b059bf440b6f/src%2Ftest%2Frustdoc-ui%2Finvalid-html-self-closing-tag.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-html-self-closing-tag.rs?ref=5623024cf818400f222300a48dc9b059bf440b6f", "patch": "@@ -0,0 +1,70 @@\n+#![deny(rustdoc::invalid_html_tags)]\n+\n+/// <p/>\n+//~^ ERROR invalid self-closing HTML tag `p`\n+pub struct A;\n+\n+/// <p style/>\n+//~^ ERROR invalid self-closing HTML tag `p`\n+pub struct B;\n+\n+/// <p style=\"\"/>\n+//~^ ERROR invalid self-closing HTML tag `p`\n+pub struct C;\n+\n+/// <p style=\"x\"/>\n+//~^ ERROR invalid self-closing HTML tag `p`\n+pub struct D;\n+\n+/// <p style=\"x/></p>\n+//~^ ERROR unclosed quoted HTML attribute\n+pub struct E;\n+\n+/// <p style='x/></p>\n+//~^ ERROR unclosed quoted HTML attribute\n+pub struct F;\n+\n+/// <p style=\"x/\"></p>\n+pub struct G;\n+\n+/// <p style=\"x/\"/>\n+//~^ ERROR invalid self-closing HTML tag `p`\n+pub struct H;\n+\n+/// <p / >\n+//~^ ERROR invalid self-closing HTML tag `p`\n+pub struct I;\n+\n+/// <br/>\n+pub struct J;\n+\n+/// <a href=/></a>\n+pub struct K;\n+\n+/// <a href=//></a>\n+pub struct L;\n+\n+/// <a href=\"/\"/>\n+//~^ ERROR invalid self-closing HTML tag `a`\n+pub struct M;\n+\n+/// <a href=x />\n+//~^ ERROR invalid self-closing HTML tag `a`\n+pub struct N;\n+\n+/// <a href= />\n+//~^ ERROR invalid self-closing HTML tag `a`\n+pub struct O;\n+\n+/// <a href=x/></a>\n+pub struct P;\n+\n+/// <svg><rect width=1 height=1 /></svg>\n+pub struct Q;\n+\n+/// <svg><rect width=1 height=/></svg>\n+//~^ ERROR unclosed HTML tag `rect`\n+pub struct R;\n+\n+/// <svg / q>\n+pub struct S;"}, {"sha": "e45edfb43ff8e7f1c481014a85e5de3a0447a461", "filename": "src/test/rustdoc-ui/invalid-html-self-closing-tag.stderr", "status": "added", "additions": 80, "deletions": 0, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/5623024cf818400f222300a48dc9b059bf440b6f/src%2Ftest%2Frustdoc-ui%2Finvalid-html-self-closing-tag.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5623024cf818400f222300a48dc9b059bf440b6f/src%2Ftest%2Frustdoc-ui%2Finvalid-html-self-closing-tag.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-html-self-closing-tag.stderr?ref=5623024cf818400f222300a48dc9b059bf440b6f", "patch": "@@ -0,0 +1,80 @@\n+error: invalid self-closing HTML tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:3:5\n+   |\n+LL | /// <p/>\n+   |     ^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/invalid-html-self-closing-tag.rs:1:9\n+   |\n+LL | #![deny(rustdoc::invalid_html_tags)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: invalid self-closing HTML tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:7:5\n+   |\n+LL | /// <p style/>\n+   |     ^^\n+\n+error: invalid self-closing HTML tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:11:5\n+   |\n+LL | /// <p style=\"\"/>\n+   |     ^^\n+\n+error: invalid self-closing HTML tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:15:5\n+   |\n+LL | /// <p style=\"x\"/>\n+   |     ^^\n+\n+error: unclosed quoted HTML attribute on tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:19:14\n+   |\n+LL | /// <p style=\"x/></p>\n+   |              ^\n+\n+error: unclosed quoted HTML attribute on tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:23:14\n+   |\n+LL | /// <p style='x/></p>\n+   |              ^\n+\n+error: invalid self-closing HTML tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:30:5\n+   |\n+LL | /// <p style=\"x/\"/>\n+   |     ^^\n+\n+error: invalid self-closing HTML tag `p`\n+  --> $DIR/invalid-html-self-closing-tag.rs:34:5\n+   |\n+LL | /// <p / >\n+   |     ^^\n+\n+error: invalid self-closing HTML tag `a`\n+  --> $DIR/invalid-html-self-closing-tag.rs:47:5\n+   |\n+LL | /// <a href=\"/\"/>\n+   |     ^^\n+\n+error: invalid self-closing HTML tag `a`\n+  --> $DIR/invalid-html-self-closing-tag.rs:51:5\n+   |\n+LL | /// <a href=x />\n+   |     ^^\n+\n+error: invalid self-closing HTML tag `a`\n+  --> $DIR/invalid-html-self-closing-tag.rs:55:5\n+   |\n+LL | /// <a href= />\n+   |     ^^\n+\n+error: unclosed HTML tag `rect`\n+  --> $DIR/invalid-html-self-closing-tag.rs:65:10\n+   |\n+LL | /// <svg><rect width=1 height=/></svg>\n+   |          ^^^^^\n+\n+error: aborting due to 12 previous errors\n+"}]}