{"sha": "df0d9b492da81a647eedf17210cf55b86a44888c", "node_id": "C_kwDOAAsO6NoAKGRmMGQ5YjQ5MmRhODFhNjQ3ZWVkZjE3MjEwY2Y1NWI4NmE0NDg4OGM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-19T17:01:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-19T17:01:06Z"}, "message": "Auto merge of #110496 - WaffleLapkin:\ud83c\udff3\ufe0f\u200d\u26a7\ufe0fsound, r=compiler-errors\n\nDon't transmute `&List<GenericArg>` <-> `&List<Ty>`\n\nIn #93505 we allowed safely transmuting between `&List<GenericArg<'_>>` and `&List<Ty<'_>>`. This was possible because `GenericArg` is a tagged pointer and the tag for types is `0b00`, such that a `GenericArg` with a type inside has the same layout as `Ty`.\n\nWhile this was meant as an optimization, it doesn't look like it was actually any perf or max-rss win (see https://github.com/rust-lang/rust/pull/94799#issuecomment-1064340003, https://github.com/rust-lang/rust/pull/94841, https://github.com/rust-lang/rust/pull/110496#issuecomment-1513799140).\n\nAdditionally the way it was done is quite fragile \u2014 `unsafe` code was not properly documented or contained in a module, types were not marked as `repr(C)` (making the transmutes possibly unsound). All of this makes the code maintenance harder and blocks other possible optimizations (as an example I've found out about these `transmutes` when my change caused them to sigsegv compiler).\n\nThus, I think we can safely (pun intended) remove those transmutes, making maintenance easier, optimizations possible, code less cursed, etc.\n\nr? `@compiler-errors`", "tree": {"sha": "34bd07a1e2076879a4dee6c01856236e47e7c60d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/34bd07a1e2076879a4dee6c01856236e47e7c60d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df0d9b492da81a647eedf17210cf55b86a44888c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df0d9b492da81a647eedf17210cf55b86a44888c", "html_url": "https://github.com/rust-lang/rust/commit/df0d9b492da81a647eedf17210cf55b86a44888c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df0d9b492da81a647eedf17210cf55b86a44888c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a5c8e91f094bb1cb1346651fe3512f0b603d826", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a5c8e91f094bb1cb1346651fe3512f0b603d826", "html_url": "https://github.com/rust-lang/rust/commit/3a5c8e91f094bb1cb1346651fe3512f0b603d826"}, {"sha": "10ec03c3fb4509f96df3aa8264858b76e81c9aa1", "url": "https://api.github.com/repos/rust-lang/rust/commits/10ec03c3fb4509f96df3aa8264858b76e81c9aa1", "html_url": "https://github.com/rust-lang/rust/commit/10ec03c3fb4509f96df3aa8264858b76e81c9aa1"}], "stats": {"total": 89, "additions": 32, "deletions": 57}, "files": [{"sha": "f9d3ffc8f0063e4c8835dfd9370c9d7e9f23b1b2", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 4, "deletions": 31, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=df0d9b492da81a647eedf17210cf55b86a44888c", "patch": "@@ -141,6 +141,7 @@ pub struct CtxtInterners<'tcx> {\n     type_: InternedSet<'tcx, WithCachedTypeInfo<TyKind<'tcx>>>,\n     const_lists: InternedSet<'tcx, List<ty::Const<'tcx>>>,\n     substs: InternedSet<'tcx, InternalSubsts<'tcx>>,\n+    type_lists: InternedSet<'tcx, List<Ty<'tcx>>>,\n     canonical_var_infos: InternedSet<'tcx, List<CanonicalVarInfo<'tcx>>>,\n     region: InternedSet<'tcx, RegionKind<'tcx>>,\n     poly_existential_predicates: InternedSet<'tcx, List<PolyExistentialPredicate<'tcx>>>,\n@@ -163,6 +164,7 @@ impl<'tcx> CtxtInterners<'tcx> {\n             type_: Default::default(),\n             const_lists: Default::default(),\n             substs: Default::default(),\n+            type_lists: Default::default(),\n             region: Default::default(),\n             poly_existential_predicates: Default::default(),\n             canonical_var_infos: Default::default(),\n@@ -1278,25 +1280,6 @@ macro_rules! nop_lift {\n     };\n }\n \n-// Can't use the macros as we have reuse the `substs` here.\n-//\n-// See `mk_type_list` for more info.\n-impl<'a, 'tcx> Lift<'tcx> for &'a List<Ty<'a>> {\n-    type Lifted = &'tcx List<Ty<'tcx>>;\n-    fn lift_to_tcx(self, tcx: TyCtxt<'tcx>) -> Option<Self::Lifted> {\n-        if self.is_empty() {\n-            return Some(List::empty());\n-        }\n-\n-        tcx.interners\n-            .substs\n-            .contains_pointer_to(&InternedInSet(self.as_substs()))\n-            // SAFETY: `self` is interned and therefore valid\n-            // for the entire lifetime of the `TyCtxt`.\n-            .then(|| unsafe { mem::transmute::<&'a List<Ty<'a>>, &'tcx List<Ty<'tcx>>>(self) })\n-    }\n-}\n-\n macro_rules! nop_list_lift {\n     ($set:ident; $ty:ty => $lifted:ty) => {\n         impl<'a, 'tcx> Lift<'tcx> for &'a List<$ty> {\n@@ -1320,6 +1303,7 @@ nop_lift! {const_; Const<'a> => Const<'tcx>}\n nop_lift! {const_allocation; ConstAllocation<'a> => ConstAllocation<'tcx>}\n nop_lift! {predicate; Predicate<'a> => Predicate<'tcx>}\n \n+nop_list_lift! {type_lists; Ty<'a> => Ty<'tcx>}\n nop_list_lift! {poly_existential_predicates; PolyExistentialPredicate<'a> => PolyExistentialPredicate<'tcx>}\n nop_list_lift! {predicates; Predicate<'a> => Predicate<'tcx>}\n nop_list_lift! {canonical_var_infos; CanonicalVarInfo<'a> => CanonicalVarInfo<'tcx>}\n@@ -1594,6 +1578,7 @@ macro_rules! slice_interners {\n slice_interners!(\n     const_lists: pub mk_const_list(Const<'tcx>),\n     substs: pub mk_substs(GenericArg<'tcx>),\n+    type_lists: pub mk_type_list(Ty<'tcx>),\n     canonical_var_infos: pub mk_canonical_var_infos(CanonicalVarInfo<'tcx>),\n     poly_existential_predicates: intern_poly_existential_predicates(PolyExistentialPredicate<'tcx>),\n     predicates: intern_predicates(Predicate<'tcx>),\n@@ -2193,18 +2178,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         T::collect_and_apply(iter, |xs| self.mk_const_list(xs))\n     }\n \n-    pub fn mk_type_list(self, ts: &[Ty<'tcx>]) -> &'tcx List<Ty<'tcx>> {\n-        // Actually intern type lists as lists of `GenericArg`s.\n-        //\n-        // Transmuting from `Ty<'tcx>` to `GenericArg<'tcx>` is sound\n-        // as explained in `ty_slice_as_generic_arg`. With this,\n-        // we guarantee that even when transmuting between `List<Ty<'tcx>>`\n-        // and `List<GenericArg<'tcx>>`, the uniqueness requirement for\n-        // lists is upheld.\n-        let substs = self.mk_substs(ty::subst::ty_slice_as_generic_args(ts));\n-        substs.try_as_type_list().unwrap()\n-    }\n-\n     // Unlike various other `mk_*_from_iter` functions, this one uses `I:\n     // IntoIterator` instead of `I: Iterator`, and it doesn't have a slice\n     // variant, because of the need to combine `inputs` and `output`. This"}, {"sha": "da3cd27f3884451bff484bee2effc800e35c8b28", "filename": "compiler/rustc_middle/src/ty/subst.rs", "status": "modified", "additions": 10, "deletions": 20, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs?ref=df0d9b492da81a647eedf17210cf55b86a44888c", "patch": "@@ -67,19 +67,6 @@ pub fn ty_slice_as_generic_args<'a, 'tcx>(ts: &'a [Ty<'tcx>]) -> &'a [GenericArg\n     unsafe { slice::from_raw_parts(ts.as_ptr().cast(), ts.len()) }\n }\n \n-impl<'tcx> List<Ty<'tcx>> {\n-    /// Allows to freely switch between `List<Ty<'tcx>>` and `List<GenericArg<'tcx>>`.\n-    ///\n-    /// As lists are interned, `List<Ty<'tcx>>` and `List<GenericArg<'tcx>>` have\n-    /// be interned together, see `mk_type_list` for more details.\n-    #[inline]\n-    pub fn as_substs(&'tcx self) -> SubstsRef<'tcx> {\n-        assert_eq!(TYPE_TAG, 0);\n-        // SAFETY: `List<T>` is `#[repr(C)]`. `Ty` and `GenericArg` is explained above.\n-        unsafe { &*(self as *const List<Ty<'tcx>> as *const List<GenericArg<'tcx>>) }\n-    }\n-}\n-\n impl<'tcx> GenericArgKind<'tcx> {\n     #[inline]\n     fn pack(self) -> GenericArg<'tcx> {\n@@ -268,13 +255,16 @@ pub type InternalSubsts<'tcx> = List<GenericArg<'tcx>>;\n pub type SubstsRef<'tcx> = &'tcx InternalSubsts<'tcx>;\n \n impl<'tcx> InternalSubsts<'tcx> {\n-    /// Checks whether all elements of this list are types, if so, transmute.\n-    pub fn try_as_type_list(&'tcx self) -> Option<&'tcx List<Ty<'tcx>>> {\n-        self.iter().all(|arg| matches!(arg.unpack(), GenericArgKind::Type(_))).then(|| {\n-            assert_eq!(TYPE_TAG, 0);\n-            // SAFETY: All elements are types, see `List<Ty<'tcx>>::as_substs`.\n-            unsafe { &*(self as *const List<GenericArg<'tcx>> as *const List<Ty<'tcx>>) }\n-        })\n+    /// Converts substs to a type list.\n+    ///\n+    /// # Panics\n+    ///\n+    /// If any of the generic arguments are not types.\n+    pub fn into_type_list(&self, tcx: TyCtxt<'tcx>) -> &'tcx List<Ty<'tcx>> {\n+        tcx.mk_type_list_from_iter(self.iter().map(|arg| match arg.unpack() {\n+            GenericArgKind::Type(ty) => ty,\n+            _ => bug!(\"`into_type_list` called on substs with non-types\"),\n+        }))\n     }\n \n     /// Interpret these substitutions as the substitutions of a closure type."}, {"sha": "04a635a68034ddd179829bb3dd83c72b686d136e", "filename": "compiler/rustc_middle/src/ty/walk.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fwalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fwalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fwalk.rs?ref=df0d9b492da81a647eedf17210cf55b86a44888c", "patch": "@@ -194,7 +194,7 @@ fn push_inner<'tcx>(stack: &mut TypeWalkerStack<'tcx>, parent: GenericArg<'tcx>)\n             | ty::FnDef(_, substs) => {\n                 stack.extend(substs.iter().rev());\n             }\n-            ty::Tuple(ts) => stack.extend(ts.as_substs().iter().rev()),\n+            ty::Tuple(ts) => stack.extend(ts.iter().rev().map(GenericArg::from)),\n             ty::GeneratorWitness(ts) => {\n                 stack.extend(ts.skip_binder().iter().rev().map(|ty| ty.into()));\n             }"}, {"sha": "4d225e36b22cd4bad80e3873606cbafd55309c98", "filename": "compiler/rustc_traits/src/chalk/lowering.rs", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df0d9b492da81a647eedf17210cf55b86a44888c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Flowering.rs?ref=df0d9b492da81a647eedf17210cf55b86a44888c", "patch": "@@ -60,6 +60,20 @@ impl<'tcx> LowerInto<'tcx, chalk_ir::Substitution<RustInterner<'tcx>>> for Subst\n     }\n }\n \n+impl<'tcx> LowerInto<'tcx, chalk_ir::Substitution<RustInterner<'tcx>>>\n+    for &'tcx ty::List<Ty<'tcx>>\n+{\n+    fn lower_into(\n+        self,\n+        interner: RustInterner<'tcx>,\n+    ) -> chalk_ir::Substitution<RustInterner<'tcx>> {\n+        chalk_ir::Substitution::from_iter(\n+            interner,\n+            self.iter().map(|ty| GenericArg::from(ty).lower_into(interner)),\n+        )\n+    }\n+}\n+\n impl<'tcx> LowerInto<'tcx, SubstsRef<'tcx>> for &chalk_ir::Substitution<RustInterner<'tcx>> {\n     fn lower_into(self, interner: RustInterner<'tcx>) -> SubstsRef<'tcx> {\n         interner\n@@ -351,9 +365,7 @@ impl<'tcx> LowerInto<'tcx, chalk_ir::Ty<RustInterner<'tcx>>> for Ty<'tcx> {\n             ty::GeneratorWitness(_) => unimplemented!(),\n             ty::GeneratorWitnessMIR(..) => unimplemented!(),\n             ty::Never => chalk_ir::TyKind::Never,\n-            ty::Tuple(types) => {\n-                chalk_ir::TyKind::Tuple(types.len(), types.as_substs().lower_into(interner))\n-            }\n+            ty::Tuple(types) => chalk_ir::TyKind::Tuple(types.len(), types.lower_into(interner)),\n             ty::Alias(ty::Projection, ty::AliasTy { def_id, substs, .. }) => {\n                 chalk_ir::TyKind::Alias(chalk_ir::AliasTy::Projection(chalk_ir::ProjectionTy {\n                     associated_ty_id: chalk_ir::AssocTypeId(def_id),\n@@ -435,7 +447,7 @@ impl<'tcx> LowerInto<'tcx, Ty<'tcx>> for &chalk_ir::Ty<RustInterner<'tcx>> {\n             TyKind::GeneratorWitness(..) => unimplemented!(),\n             TyKind::Never => ty::Never,\n             TyKind::Tuple(_len, substitution) => {\n-                ty::Tuple(substitution.lower_into(interner).try_as_type_list().unwrap())\n+                ty::Tuple(substitution.lower_into(interner).into_type_list(interner.tcx))\n             }\n             TyKind::Slice(ty) => ty::Slice(ty.lower_into(interner)),\n             TyKind::Raw(mutbl, ty) => ty::RawPtr(ty::TypeAndMut {"}, {"sha": "8b996c188161d1a59cec8a02cfc4512df5a5aa41", "filename": "src/tools/clippy/clippy_utils/src/ty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df0d9b492da81a647eedf17210cf55b86a44888c/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df0d9b492da81a647eedf17210cf55b86a44888c/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fty.rs?ref=df0d9b492da81a647eedf17210cf55b86a44888c", "patch": "@@ -975,7 +975,7 @@ pub fn approx_ty_size<'tcx>(cx: &LateContext<'tcx>, ty: Ty<'tcx>) -> u64 {\n     }\n     match (cx.layout_of(ty).map(|layout| layout.size.bytes()), ty.kind()) {\n         (Ok(size), _) => size,\n-        (Err(_), ty::Tuple(list)) => list.as_substs().types().map(|t| approx_ty_size(cx, t)).sum(),\n+        (Err(_), ty::Tuple(list)) => list.iter().map(|t| approx_ty_size(cx, t)).sum(),\n         (Err(_), ty::Array(t, n)) => {\n             n.try_eval_target_usize(cx.tcx, cx.param_env).unwrap_or_default() * approx_ty_size(cx, *t)\n         },"}]}