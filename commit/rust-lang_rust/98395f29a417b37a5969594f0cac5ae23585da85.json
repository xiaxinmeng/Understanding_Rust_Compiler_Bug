{"sha": "98395f29a417b37a5969594f0cac5ae23585da85", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk4Mzk1ZjI5YTQxN2IzN2E1OTY5NTk0ZjBjYWM1YWUyMzU4NWRhODU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-06-04T17:45:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-04T17:45:37Z"}, "message": "Merge #9138\n\n9138: feat: Implement hover for lints r=Veykril a=Veykril\n\nfixes https://github.com/rust-analyzer/rust-analyzer/issues/8857, fixes https://github.com/rust-analyzer/rust-analyzer/issues/3941\r\n\r\n![URXBanNxYe](https://user-images.githubusercontent.com/3757771/120830905-4bd8da80-c55f-11eb-9f55-ff5a321726fa.gif)\r\n\r\nWe also generate the default lints(and lint groups \ud83c\udf89) instead now by invoking `rustc -W help` and parsing the output from that.\r\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "3a13913003723f3da843dae8580287b9d33c68eb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a13913003723f3da843dae8580287b9d33c68eb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/98395f29a417b37a5969594f0cac5ae23585da85", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgumbBCRBK7hj4Ov3rIwAAjpEIAG7HcPmq464m1ZIOghQLzAxq\n+WRhXxetB+bIkI08QbmgvpNJhQy00f+XtJaxiDRtqZTohV6oNHFL2yzhWQ2PcF6T\n4tCGciSWwINdAeYFZMeO2f0sysqkj3KQtUzfAxeaY9SvEuRfVVpxUNGQWlFqPfcW\n6y+oPCgeUriDfOk2td5sRrGDd98G0ieS2JIR69OeVMoq4USIgJrG4RNdyz/VbrBG\nxs29e1SvAT3oCcYmv27sNU4HxOO1lGNm0qCpb44hkKAwEfBFmA069NlbBVywbIcU\nDrriPZbZ3P4UNWin/vCKFtFnmniSRLP2FGgqdTZBnRJ4B581EJGvli1bein1aB4=\n=yYrQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 3a13913003723f3da843dae8580287b9d33c68eb\nparent 92d91050c4aa48732e7af3bf979aa7ed5aed924d\nparent ae1c63fcdd0caf34f41fba62b04e3d868a589f1d\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1622828737 +0000\ncommitter GitHub <noreply@github.com> 1622828737 +0000\n\nMerge #9138\n\n9138: feat: Implement hover for lints r=Veykril a=Veykril\n\nfixes https://github.com/rust-analyzer/rust-analyzer/issues/8857, fixes https://github.com/rust-analyzer/rust-analyzer/issues/3941\r\n\r\n![URXBanNxYe](https://user-images.githubusercontent.com/3757771/120830905-4bd8da80-c55f-11eb-9f55-ff5a321726fa.gif)\r\n\r\nWe also generate the default lints(and lint groups \ud83c\udf89) instead now by invoking `rustc -W help` and parsing the output from that.\r\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/98395f29a417b37a5969594f0cac5ae23585da85", "html_url": "https://github.com/rust-lang/rust/commit/98395f29a417b37a5969594f0cac5ae23585da85", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/98395f29a417b37a5969594f0cac5ae23585da85/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "92d91050c4aa48732e7af3bf979aa7ed5aed924d", "url": "https://api.github.com/repos/rust-lang/rust/commits/92d91050c4aa48732e7af3bf979aa7ed5aed924d", "html_url": "https://github.com/rust-lang/rust/commit/92d91050c4aa48732e7af3bf979aa7ed5aed924d"}, {"sha": "ae1c63fcdd0caf34f41fba62b04e3d868a589f1d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae1c63fcdd0caf34f41fba62b04e3d868a589f1d", "html_url": "https://github.com/rust-lang/rust/commit/ae1c63fcdd0caf34f41fba62b04e3d868a589f1d"}], "stats": {"total": 8653, "additions": 4622, "deletions": 4031}, "files": [{"sha": "ed4f18e1f9d5d69e989073ff42ac518918102dde", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 133, "deletions": 12, "changes": 145, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -6,12 +6,18 @@ use hir::{\n use ide_db::{\n     base_db::SourceDatabase,\n     defs::{Definition, NameClass, NameRefClass},\n-    helpers::FamousDefs,\n+    helpers::{\n+        generated_lints::{CLIPPY_LINTS, DEFAULT_LINTS, FEATURES},\n+        FamousDefs,\n+    },\n     RootDatabase,\n };\n use itertools::Itertools;\n use stdx::format_to;\n-use syntax::{ast, match_ast, AstNode, AstToken, SyntaxKind::*, SyntaxToken, TokenAtOffset, T};\n+use syntax::{\n+    algo, ast, match_ast, AstNode, AstToken, Direction, SyntaxKind::*, SyntaxToken, TokenAtOffset,\n+    T,\n+};\n \n use crate::{\n     display::{macro_label, TryToNav},\n@@ -118,8 +124,9 @@ pub(crate) fn hover(\n                 |d| d.defined(db),\n             ),\n \n-            _ => ast::Comment::cast(token.clone())\n-                .and_then(|_| {\n+            _ => {\n+                if ast::Comment::cast(token.clone()).is_some() {\n+                    cov_mark::hit!(no_highlight_on_comment_hover);\n                     let (attributes, def) = doc_attributes(&sema, &node)?;\n                     let (docs, doc_mapping) = attributes.docs_with_rangemap(db)?;\n                     let (idl_range, link, ns) =\n@@ -132,9 +139,13 @@ pub(crate) fn hover(\n                             }\n                         })?;\n                     range = Some(idl_range);\n-                    resolve_doc_path_for_def(db, def, &link, ns)\n-                })\n-                .map(Definition::ModuleDef),\n+                    resolve_doc_path_for_def(db, def, &link, ns).map(Definition::ModuleDef)\n+                } else if let res@Some(_) = try_hover_for_attribute(&token) {\n+                    return res;\n+                } else {\n+                    None\n+                }\n+            },\n         }\n     };\n \n@@ -168,11 +179,6 @@ pub(crate) fn hover(\n         }\n     }\n \n-    if token.kind() == syntax::SyntaxKind::COMMENT {\n-        cov_mark::hit!(no_highlight_on_comment_hover);\n-        return None;\n-    }\n-\n     if let res @ Some(_) = hover_for_keyword(&sema, links_in_hover, markdown, &token) {\n         return res;\n     }\n@@ -201,6 +207,51 @@ pub(crate) fn hover(\n     Some(RangeInfo::new(range, res))\n }\n \n+fn try_hover_for_attribute(token: &SyntaxToken) -> Option<RangeInfo<HoverResult>> {\n+    let attr = token.ancestors().nth(1).and_then(ast::Attr::cast)?;\n+    let (path, tt) = attr.as_simple_call()?;\n+    if !tt.syntax().text_range().contains(token.text_range().start()) {\n+        return None;\n+    }\n+    let (is_clippy, lints) = match &*path {\n+        \"feature\" => (false, FEATURES),\n+        \"allow\" | \"deny\" | \"forbid\" | \"warn\" => {\n+            let is_clippy = algo::non_trivia_sibling(token.clone().into(), Direction::Prev)\n+                .filter(|t| t.kind() == T![:])\n+                .and_then(|t| algo::non_trivia_sibling(t, Direction::Prev))\n+                .filter(|t| t.kind() == T![:])\n+                .and_then(|t| algo::non_trivia_sibling(t, Direction::Prev))\n+                .map_or(false, |t| {\n+                    t.kind() == T![ident] && t.into_token().map_or(false, |t| t.text() == \"clippy\")\n+                });\n+            if is_clippy {\n+                (true, CLIPPY_LINTS)\n+            } else {\n+                (false, DEFAULT_LINTS)\n+            }\n+        }\n+        _ => return None,\n+    };\n+\n+    let tmp;\n+    let needle = if is_clippy {\n+        tmp = format!(\"clippy::{}\", token.text());\n+        &tmp\n+    } else {\n+        &*token.text()\n+    };\n+\n+    let lint =\n+        lints.binary_search_by_key(&needle, |lint| lint.label).ok().map(|idx| &lints[idx])?;\n+    Some(RangeInfo::new(\n+        token.text_range(),\n+        HoverResult {\n+            markup: Markup::from(format!(\"```\\n{}\\n```\\n___\\n\\n{}\", lint.label, lint.description)),\n+            ..Default::default()\n+        },\n+    ))\n+}\n+\n fn show_implementations_action(db: &RootDatabase, def: Definition) -> Option<HoverAction> {\n     fn to_action(nav_target: NavigationTarget) -> HoverAction {\n         HoverAction::Implementation(FilePosition {\n@@ -4004,4 +4055,74 @@ pub fn foo() {}\n             \"#]],\n         )\n     }\n+\n+    #[test]\n+    fn hover_feature() {\n+        check(\n+            r#\"#![feature(box_syntax$0)]\"#,\n+            expect![[r##\"\n+                *box_syntax*\n+                ```\n+                box_syntax\n+                ```\n+                ___\n+\n+                # `box_syntax`\n+\n+                The tracking issue for this feature is: [#49733]\n+\n+                [#49733]: https://github.com/rust-lang/rust/issues/49733\n+\n+                See also [`box_patterns`](box-patterns.md)\n+\n+                ------------------------\n+\n+                Currently the only stable way to create a `Box` is via the `Box::new` method.\n+                Also it is not possible in stable Rust to destructure a `Box` in a match\n+                pattern. The unstable `box` keyword can be used to create a `Box`. An example\n+                usage would be:\n+\n+                ```rust\n+                #![feature(box_syntax)]\n+\n+                fn main() {\n+                    let b = box 5;\n+                }\n+                ```\n+\n+            \"##]],\n+        )\n+    }\n+\n+    #[test]\n+    fn hover_lint() {\n+        check(\n+            r#\"#![allow(arithmetic_overflow$0)]\"#,\n+            expect![[r#\"\n+                *arithmetic_overflow*\n+                ```\n+                arithmetic_overflow\n+                ```\n+                ___\n+\n+                arithmetic operation overflows\n+            \"#]],\n+        )\n+    }\n+\n+    #[test]\n+    fn hover_clippy_lint() {\n+        check(\n+            r#\"#![allow(clippy::almost_swapped$0)]\"#,\n+            expect![[r#\"\n+                *almost_swapped*\n+                ```\n+                clippy::almost_swapped\n+                ```\n+                ___\n+\n+                Checks for `foo = bar; bar = foo` sequences.\n+            \"#]],\n+        )\n+    }\n }"}, {"sha": "f80d7eec345c10221dc5a0521986e18e5919a29e", "filename": "crates/ide_completion/src/completions/attribute.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -3,20 +3,19 @@\n //! This module uses a bit of static metadata to provide completions\n //! for built-in attributes.\n \n+use ide_db::helpers::generated_lints::{CLIPPY_LINTS, DEFAULT_LINTS, FEATURES};\n use once_cell::sync::Lazy;\n use rustc_hash::{FxHashMap, FxHashSet};\n use syntax::{algo::non_trivia_sibling, ast, AstNode, Direction, NodeOrToken, SyntaxKind, T};\n \n use crate::{\n     context::CompletionContext,\n-    generated_lint_completions::{CLIPPY_LINTS, FEATURES},\n     item::{CompletionItem, CompletionItemKind, CompletionKind},\n     Completions,\n };\n \n mod derive;\n mod lint;\n-pub(crate) use self::lint::LintCompletion;\n \n pub(crate) fn complete_attribute(acc: &mut Completions, ctx: &CompletionContext) -> Option<()> {\n     let attribute = ctx.attribute_under_caret.as_ref()?;\n@@ -25,7 +24,7 @@ pub(crate) fn complete_attribute(acc: &mut Completions, ctx: &CompletionContext)\n             \"derive\" => derive::complete_derive(acc, ctx, token_tree),\n             \"feature\" => lint::complete_lint(acc, ctx, token_tree, FEATURES),\n             \"allow\" | \"warn\" | \"deny\" | \"forbid\" => {\n-                lint::complete_lint(acc, ctx, token_tree.clone(), lint::DEFAULT_LINT_COMPLETIONS);\n+                lint::complete_lint(acc, ctx, token_tree.clone(), DEFAULT_LINTS);\n                 lint::complete_lint(acc, ctx, token_tree, CLIPPY_LINTS);\n             }\n             _ => (),"}, {"sha": "b486c90938518443597293f64e84044163269ff4", "filename": "crates/ide_completion/src/completions/attribute/lint.rs", "status": "modified", "additions": 2, "deletions": 125, "changes": 127, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute%2Flint.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -1,4 +1,5 @@\n //! Completion for lints\n+use ide_db::helpers::generated_lints::Lint;\n use syntax::ast;\n \n use crate::{\n@@ -11,7 +12,7 @@ pub(super) fn complete_lint(\n     acc: &mut Completions,\n     ctx: &CompletionContext,\n     derive_input: ast::TokenTree,\n-    lints_completions: &[LintCompletion],\n+    lints_completions: &[Lint],\n ) {\n     if let Some(existing_lints) = super::parse_comma_sep_input(derive_input) {\n         for lint_completion in lints_completions\n@@ -29,130 +30,6 @@ pub(super) fn complete_lint(\n     }\n }\n \n-pub(crate) struct LintCompletion {\n-    pub(crate) label: &'static str,\n-    pub(crate) description: &'static str,\n-}\n-\n-#[rustfmt::skip]\n-pub(super) const DEFAULT_LINT_COMPLETIONS: &[LintCompletion] = &[\n-    LintCompletion { label: \"absolute_paths_not_starting_with_crate\", description: r#\"fully qualified paths that start with a module name instead of `crate`, `self`, or an extern crate name\"# },\n-    LintCompletion { label: \"anonymous_parameters\", description: r#\"detects anonymous parameters\"# },\n-    LintCompletion { label: \"box_pointers\", description: r#\"use of owned (Box type) heap memory\"# },\n-    LintCompletion { label: \"deprecated_in_future\", description: r#\"detects use of items that will be deprecated in a future version\"# },\n-    LintCompletion { label: \"elided_lifetimes_in_paths\", description: r#\"hidden lifetime parameters in types are deprecated\"# },\n-    LintCompletion { label: \"explicit_outlives_requirements\", description: r#\"outlives requirements can be inferred\"# },\n-    LintCompletion { label: \"indirect_structural_match\", description: r#\"pattern with const indirectly referencing non-structural-match type\"# },\n-    LintCompletion { label: \"keyword_idents\", description: r#\"detects edition keywords being used as an identifier\"# },\n-    LintCompletion { label: \"macro_use_extern_crate\", description: r#\"the `#[macro_use]` attribute is now deprecated in favor of using macros via the module system\"# },\n-    LintCompletion { label: \"meta_variable_misuse\", description: r#\"possible meta-variable misuse at macro definition\"# },\n-    LintCompletion { label: \"missing_copy_implementations\", description: r#\"detects potentially-forgotten implementations of `Copy`\"# },\n-    LintCompletion { label: \"missing_crate_level_docs\", description: r#\"detects crates with no crate-level documentation\"# },\n-    LintCompletion { label: \"missing_debug_implementations\", description: r#\"detects missing implementations of Debug\"# },\n-    LintCompletion { label: \"missing_docs\", description: r#\"detects missing documentation for public members\"# },\n-    LintCompletion { label: \"missing_doc_code_examples\", description: r#\"detects publicly-exported items without code samples in their documentation\"# },\n-    LintCompletion { label: \"non_ascii_idents\", description: r#\"detects non-ASCII identifiers\"# },\n-    LintCompletion { label: \"private_doc_tests\", description: r#\"detects code samples in docs of private items not documented by rustdoc\"# },\n-    LintCompletion { label: \"single_use_lifetimes\", description: r#\"detects lifetime parameters that are only used once\"# },\n-    LintCompletion { label: \"trivial_casts\", description: r#\"detects trivial casts which could be removed\"# },\n-    LintCompletion { label: \"trivial_numeric_casts\", description: r#\"detects trivial casts of numeric types which could be removed\"# },\n-    LintCompletion { label: \"unaligned_references\", description: r#\"detects unaligned references to fields of packed structs\"# },\n-    LintCompletion { label: \"unreachable_pub\", description: r#\"`pub` items not reachable from crate root\"# },\n-    LintCompletion { label: \"unsafe_code\", description: r#\"usage of `unsafe` code\"# },\n-    LintCompletion { label: \"unsafe_op_in_unsafe_fn\", description: r#\"unsafe operations in unsafe functions without an explicit unsafe block are deprecated\"# },\n-    LintCompletion { label: \"unstable_features\", description: r#\"enabling unstable features (deprecated. do not use)\"# },\n-    LintCompletion { label: \"unused_crate_dependencies\", description: r#\"crate dependencies that are never used\"# },\n-    LintCompletion { label: \"unused_extern_crates\", description: r#\"extern crates that are never used\"# },\n-    LintCompletion { label: \"unused_import_braces\", description: r#\"unnecessary braces around an imported item\"# },\n-    LintCompletion { label: \"unused_lifetimes\", description: r#\"detects lifetime parameters that are never used\"# },\n-    LintCompletion { label: \"unused_qualifications\", description: r#\"detects unnecessarily qualified names\"# },\n-    LintCompletion { label: \"unused_results\", description: r#\"unused result of an expression in a statement\"# },\n-    LintCompletion { label: \"variant_size_differences\", description: r#\"detects enums with widely varying variant sizes\"# },\n-    LintCompletion { label: \"array_into_iter\", description: r#\"detects calling `into_iter` on arrays\"# },\n-    LintCompletion { label: \"asm_sub_register\", description: r#\"using only a subset of a register for inline asm inputs\"# },\n-    LintCompletion { label: \"bare_trait_objects\", description: r#\"suggest using `dyn Trait` for trait objects\"# },\n-    LintCompletion { label: \"bindings_with_variant_name\", description: r#\"detects pattern bindings with the same name as one of the matched variants\"# },\n-    LintCompletion { label: \"cenum_impl_drop_cast\", description: r#\"a C-like enum implementing Drop is cast\"# },\n-    LintCompletion { label: \"clashing_extern_declarations\", description: r#\"detects when an extern fn has been declared with the same name but different types\"# },\n-    LintCompletion { label: \"coherence_leak_check\", description: r#\"distinct impls distinguished only by the leak-check code\"# },\n-    LintCompletion { label: \"confusable_idents\", description: r#\"detects visually confusable pairs between identifiers\"# },\n-    LintCompletion { label: \"dead_code\", description: r#\"detect unused, unexported items\"# },\n-    LintCompletion { label: \"deprecated\", description: r#\"detects use of deprecated items\"# },\n-    LintCompletion { label: \"ellipsis_inclusive_range_patterns\", description: r#\"`...` range patterns are deprecated\"# },\n-    LintCompletion { label: \"exported_private_dependencies\", description: r#\"public interface leaks type from a private dependency\"# },\n-    LintCompletion { label: \"illegal_floating_point_literal_pattern\", description: r#\"floating-point literals cannot be used in patterns\"# },\n-    LintCompletion { label: \"improper_ctypes\", description: r#\"proper use of libc types in foreign modules\"# },\n-    LintCompletion { label: \"improper_ctypes_definitions\", description: r#\"proper use of libc types in foreign item definitions\"# },\n-    LintCompletion { label: \"incomplete_features\", description: r#\"incomplete features that may function improperly in some or all cases\"# },\n-    LintCompletion { label: \"inline_no_sanitize\", description: r#\"detects incompatible use of `#[inline(always)]` and `#[no_sanitize(...)]`\"# },\n-    LintCompletion { label: \"intra_doc_link_resolution_failure\", description: r#\"failures in resolving intra-doc link targets\"# },\n-    LintCompletion { label: \"invalid_codeblock_attributes\", description: r#\"codeblock attribute looks a lot like a known one\"# },\n-    LintCompletion { label: \"invalid_value\", description: r#\"an invalid value is being created (such as a NULL reference)\"# },\n-    LintCompletion { label: \"irrefutable_let_patterns\", description: r#\"detects irrefutable patterns in if-let and while-let statements\"# },\n-    LintCompletion { label: \"late_bound_lifetime_arguments\", description: r#\"detects generic lifetime arguments in path segments with late bound lifetime parameters\"# },\n-    LintCompletion { label: \"mixed_script_confusables\", description: r#\"detects Unicode scripts whose mixed script confusables codepoints are solely used\"# },\n-    LintCompletion { label: \"mutable_borrow_reservation_conflict\", description: r#\"reservation of a two-phased borrow conflicts with other shared borrows\"# },\n-    LintCompletion { label: \"non_camel_case_types\", description: r#\"types, variants, traits and type parameters should have camel case names\"# },\n-    LintCompletion { label: \"non_shorthand_field_patterns\", description: r#\"using `Struct { x: x }` instead of `Struct { x }` in a pattern\"# },\n-    LintCompletion { label: \"non_snake_case\", description: r#\"variables, methods, functions, lifetime parameters and modules should have snake case names\"# },\n-    LintCompletion { label: \"non_upper_case_globals\", description: r#\"static constants should have uppercase identifiers\"# },\n-    LintCompletion { label: \"no_mangle_generic_items\", description: r#\"generic items must be mangled\"# },\n-    LintCompletion { label: \"overlapping_patterns\", description: r#\"detects overlapping patterns\"# },\n-    LintCompletion { label: \"path_statements\", description: r#\"path statements with no effect\"# },\n-    LintCompletion { label: \"private_in_public\", description: r#\"detect private items in public interfaces not caught by the old implementation\"# },\n-    LintCompletion { label: \"proc_macro_derive_resolution_fallback\", description: r#\"detects proc macro derives using inaccessible names from parent modules\"# },\n-    LintCompletion { label: \"redundant_semicolons\", description: r#\"detects unnecessary trailing semicolons\"# },\n-    LintCompletion { label: \"renamed_and_removed_lints\", description: r#\"lints that have been renamed or removed\"# },\n-    LintCompletion { label: \"safe_packed_borrows\", description: r#\"safe borrows of fields of packed structs were erroneously allowed\"# },\n-    LintCompletion { label: \"stable_features\", description: r#\"stable features found in `#[feature]` directive\"# },\n-    LintCompletion { label: \"trivial_bounds\", description: r#\"these bounds don't depend on an type parameters\"# },\n-    LintCompletion { label: \"type_alias_bounds\", description: r#\"bounds in type aliases are not enforced\"# },\n-    LintCompletion { label: \"tyvar_behind_raw_pointer\", description: r#\"raw pointer to an inference variable\"# },\n-    LintCompletion { label: \"uncommon_codepoints\", description: r#\"detects uncommon Unicode codepoints in identifiers\"# },\n-    LintCompletion { label: \"unconditional_recursion\", description: r#\"functions that cannot return without calling themselves\"# },\n-    LintCompletion { label: \"unknown_lints\", description: r#\"unrecognized lint attribute\"# },\n-    LintCompletion { label: \"unnameable_test_items\", description: r#\"detects an item that cannot be named being marked as `#[test_case]`\"# },\n-    LintCompletion { label: \"unreachable_code\", description: r#\"detects unreachable code paths\"# },\n-    LintCompletion { label: \"unreachable_patterns\", description: r#\"detects unreachable patterns\"# },\n-    LintCompletion { label: \"unstable_name_collisions\", description: r#\"detects name collision with an existing but unstable method\"# },\n-    LintCompletion { label: \"unused_allocation\", description: r#\"detects unnecessary allocations that can be eliminated\"# },\n-    LintCompletion { label: \"unused_assignments\", description: r#\"detect assignments that will never be read\"# },\n-    LintCompletion { label: \"unused_attributes\", description: r#\"detects attributes that were not used by the compiler\"# },\n-    LintCompletion { label: \"unused_braces\", description: r#\"unnecessary braces around an expression\"# },\n-    LintCompletion { label: \"unused_comparisons\", description: r#\"comparisons made useless by limits of the types involved\"# },\n-    LintCompletion { label: \"unused_doc_comments\", description: r#\"detects doc comments that aren't used by rustdoc\"# },\n-    LintCompletion { label: \"unused_features\", description: r#\"unused features found in crate-level `#[feature]` directives\"# },\n-    LintCompletion { label: \"unused_imports\", description: r#\"imports that are never used\"# },\n-    LintCompletion { label: \"unused_labels\", description: r#\"detects labels that are never used\"# },\n-    LintCompletion { label: \"unused_macros\", description: r#\"detects macros that were not used\"# },\n-    LintCompletion { label: \"unused_must_use\", description: r#\"unused result of a type flagged as `#[must_use]`\"# },\n-    LintCompletion { label: \"unused_mut\", description: r#\"detect mut variables which don't need to be mutable\"# },\n-    LintCompletion { label: \"unused_parens\", description: r#\"`if`, `match`, `while` and `return` do not need parentheses\"# },\n-    LintCompletion { label: \"unused_unsafe\", description: r#\"unnecessary use of an `unsafe` block\"# },\n-    LintCompletion { label: \"unused_variables\", description: r#\"detect variables which are not used in any way\"# },\n-    LintCompletion { label: \"warnings\", description: r#\"mass-change the level for lints which produce warnings\"# },\n-    LintCompletion { label: \"where_clauses_object_safety\", description: r#\"checks the object safety of where clauses\"# },\n-    LintCompletion { label: \"while_true\", description: r#\"suggest using `loop { }` instead of `while true { }`\"# },\n-    LintCompletion { label: \"ambiguous_associated_items\", description: r#\"ambiguous associated items\"# },\n-    LintCompletion { label: \"arithmetic_overflow\", description: r#\"arithmetic operation overflows\"# },\n-    LintCompletion { label: \"conflicting_repr_hints\", description: r#\"conflicts between `#[repr(..)]` hints that were previously accepted and used in practice\"# },\n-    LintCompletion { label: \"const_err\", description: r#\"constant evaluation detected erroneous expression\"# },\n-    LintCompletion { label: \"ill_formed_attribute_input\", description: r#\"ill-formed attribute inputs that were previously accepted and used in practice\"# },\n-    LintCompletion { label: \"incomplete_include\", description: r#\"trailing content in included file\"# },\n-    LintCompletion { label: \"invalid_type_param_default\", description: r#\"type parameter default erroneously allowed in invalid location\"# },\n-    LintCompletion { label: \"macro_expanded_macro_exports_accessed_by_absolute_paths\", description: r#\"macro-expanded `macro_export` macros from the current crate cannot be referred to by absolute paths\"# },\n-    LintCompletion { label: \"missing_fragment_specifier\", description: r#\"detects missing fragment specifiers in unused `macro_rules!` patterns\"# },\n-    LintCompletion { label: \"mutable_transmutes\", description: r#\"mutating transmuted &mut T from &T may cause undefined behavior\"# },\n-    LintCompletion { label: \"no_mangle_const_items\", description: r#\"const items will not have their symbols exported\"# },\n-    LintCompletion { label: \"order_dependent_trait_objects\", description: r#\"trait-object types were treated as different depending on marker-trait order\"# },\n-    LintCompletion { label: \"overflowing_literals\", description: r#\"literal out of range for its type\"# },\n-    LintCompletion { label: \"patterns_in_fns_without_body\", description: r#\"patterns in functions without body were erroneously allowed\"# },\n-    LintCompletion { label: \"pub_use_of_private_extern_crate\", description: r#\"detect public re-exports of private extern crates\"# },\n-    LintCompletion { label: \"soft_unstable\", description: r#\"a feature gate that doesn't break dependent crates\"# },\n-    LintCompletion { label: \"unconditional_panic\", description: r#\"operation will cause a panic at runtime\"# },\n-    LintCompletion { label: \"unknown_crate_types\", description: r#\"unknown crate type found in `#[crate_type]` directive\"# },\n-];\n-\n #[cfg(test)]\n mod tests {\n "}, {"sha": "6fb38f50d05c1eb193d4184ae085d6aa2a0f77bf", "filename": "crates/ide_completion/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_completion%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_completion%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Flib.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -4,7 +4,6 @@ mod config;\n mod item;\n mod context;\n mod patterns;\n-mod generated_lint_completions;\n #[cfg(test)]\n mod test_utils;\n mod render;"}, {"sha": "00900cdc222960646cafabcceaf3dd29b583e6e5", "filename": "crates/ide_db/src/helpers.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -3,6 +3,7 @@ pub mod import_assets;\n pub mod insert_use;\n pub mod merge_imports;\n pub mod rust_doc;\n+pub mod generated_lints;\n \n use std::collections::VecDeque;\n "}, {"sha": "6ccb0478e3b6c4009c51c52e87c1adac077f7524", "filename": "crates/ide_db/src/helpers/generated_lints.rs", "status": "renamed", "additions": 4411, "deletions": 3873, "changes": 8284, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_db%2Fsrc%2Fhelpers%2Fgenerated_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/crates%2Fide_db%2Fsrc%2Fhelpers%2Fgenerated_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Fgenerated_lints.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "previous_filename": "crates/ide_completion/src/generated_lint_completions.rs"}, {"sha": "a28b6cb59c6c0cd4510a4db180188f87256a6abd", "filename": "xtask/src/codegen/gen_lint_completions.rs", "status": "modified", "additions": 68, "deletions": 14, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/xtask%2Fsrc%2Fcodegen%2Fgen_lint_completions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/xtask%2Fsrc%2Fcodegen%2Fgen_lint_completions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fcodegen%2Fgen_lint_completions.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -1,4 +1,5 @@\n //! Generates descriptors structure for unstable feature from Unstable Book\n+use std::borrow::Cow;\n use std::fmt::Write;\n use std::path::{Path, PathBuf};\n \n@@ -12,39 +13,92 @@ pub(crate) fn generate_lint_completions() -> Result<()> {\n         cmd!(\"git clone --depth=1 https://github.com/rust-lang/rust ./target/rust\").run()?;\n     }\n \n-    let mut contents = String::from(\"use crate::completions::attribute::LintCompletion;\\n\\n\");\n-    generate_descriptor(&mut contents, \"./target/rust/src/doc/unstable-book/src\".into())?;\n+    let mut contents = String::from(\n+        r#\"pub struct Lint {\n+    pub label: &'static str,\n+    pub description: &'static str,\n+}\n+\n+\"#,\n+    );\n+    generate_lint_descriptor(&mut contents)?;\n+    contents.push('\\n');\n+\n+    generate_feature_descriptor(&mut contents, \"./target/rust/src/doc/unstable-book/src\".into())?;\n     contents.push('\\n');\n \n     cmd!(\"curl http://rust-lang.github.io/rust-clippy/master/lints.json --output ./target/clippy_lints.json\").run()?;\n     generate_descriptor_clippy(&mut contents, &Path::new(\"./target/clippy_lints.json\"))?;\n     let contents = reformat(&contents)?;\n \n-    let destination =\n-        project_root().join(\"crates/ide_completion/src/generated_lint_completions.rs\");\n+    let destination = project_root().join(\"crates/ide_db/src/helpers/generated_lints.rs\");\n     ensure_file_contents(destination.as_path(), &contents)?;\n \n     Ok(())\n }\n \n-fn generate_descriptor(buf: &mut String, src_dir: PathBuf) -> Result<()> {\n-    buf.push_str(r#\"pub(super) const FEATURES: &[LintCompletion] = &[\"#);\n+fn generate_lint_descriptor(buf: &mut String) -> Result<()> {\n+    let stdout = cmd!(\"rustc -W help\").read()?;\n+    let start_lints =\n+        stdout.find(\"----  -------  -------\").ok_or_else(|| anyhow::format_err!(\"\"))?;\n+    let start_lint_groups =\n+        stdout.find(\"----  ---------\").ok_or_else(|| anyhow::format_err!(\"\"))?;\n+    let end_lints =\n+        stdout.find(\"Lint groups provided by rustc:\").ok_or_else(|| anyhow::format_err!(\"\"))?;\n+    let end_lint_groups = stdout\n+        .find(\"Lint tools like Clippy can provide additional lints and lint groups.\")\n+        .ok_or_else(|| anyhow::format_err!(\"\"))?;\n+    buf.push_str(r#\"pub const DEFAULT_LINTS: &[Lint] = &[\"#);\n+    buf.push('\\n');\n+    let mut lints = stdout[start_lints..end_lints]\n+        .lines()\n+        .skip(1)\n+        .filter(|l| !l.is_empty())\n+        .map(|line| {\n+            let (name, rest) = line.trim().split_once(char::is_whitespace).unwrap();\n+            let (_default_level, description) =\n+                rest.trim().split_once(char::is_whitespace).unwrap();\n+            (name.trim(), Cow::Borrowed(description.trim()))\n+        })\n+        .collect::<Vec<_>>();\n+    lints.extend(\n+        stdout[start_lint_groups..end_lint_groups].lines().skip(1).filter(|l| !l.is_empty()).map(\n+            |line| {\n+                let (name, lints) = line.trim().split_once(char::is_whitespace).unwrap();\n+                (name.trim(), format!(\"lint group for: {}\", lints.trim()).into())\n+            },\n+        ),\n+    );\n+\n+    lints.sort_by(|(ident, _), (ident2, _)| ident.cmp(ident2));\n+    lints.into_iter().for_each(|(name, description)| {\n+        push_lint_completion(buf, &name.replace(\"-\", \"_\"), &description)\n+    });\n+    buf.push_str(\"];\\n\");\n+    Ok(())\n+}\n+\n+fn generate_feature_descriptor(buf: &mut String, src_dir: PathBuf) -> Result<()> {\n+    buf.push_str(r#\"pub const FEATURES: &[Lint] = &[\"#);\n     buf.push('\\n');\n-    [\"language-features\", \"library-features\"]\n+    let mut vec = [\"language-features\", \"library-features\"]\n         .iter()\n         .flat_map(|it| WalkDir::new(src_dir.join(it)))\n         .filter_map(|e| e.ok())\n         .filter(|entry| {\n             // Get all `.md ` files\n             entry.file_type().is_file() && entry.path().extension().unwrap_or_default() == \"md\"\n         })\n-        .for_each(|entry| {\n+        .map(|entry| {\n             let path = entry.path();\n             let feature_ident = path.file_stem().unwrap().to_str().unwrap().replace(\"-\", \"_\");\n             let doc = read_file(path).unwrap();\n-\n-            push_lint_completion(buf, &feature_ident, &doc);\n-        });\n+            (feature_ident, doc)\n+        })\n+        .collect::<Vec<_>>();\n+    vec.sort_by(|(feature_ident, _), (feature_ident2, _)| feature_ident.cmp(feature_ident2));\n+    vec.into_iter()\n+        .for_each(|(feature_ident, doc)| push_lint_completion(buf, &feature_ident, &doc));\n     buf.push_str(\"];\\n\");\n     Ok(())\n }\n@@ -85,8 +139,8 @@ fn generate_descriptor_clippy(buf: &mut String, path: &Path) -> Result<()> {\n                 .into();\n         }\n     }\n-\n-    buf.push_str(r#\"pub(super) const CLIPPY_LINTS: &[LintCompletion] = &[\"#);\n+    clippy_lints.sort_by(|lint, lint2| lint.id.cmp(&lint2.id));\n+    buf.push_str(r#\"pub const CLIPPY_LINTS: &[Lint] = &[\"#);\n     buf.push('\\n');\n     clippy_lints.into_iter().for_each(|clippy_lint| {\n         let lint_ident = format!(\"clippy::{}\", clippy_lint.id);\n@@ -102,7 +156,7 @@ fn generate_descriptor_clippy(buf: &mut String, path: &Path) -> Result<()> {\n fn push_lint_completion(buf: &mut String, label: &str, description: &str) {\n     writeln!(\n         buf,\n-        r###\"    LintCompletion {{\n+        r###\"    Lint {{\n         label: \"{}\",\n         description: r##\"{}\"##\n     }},\"###,"}, {"sha": "9447d463d0fd5f8b392fccedc641839a0a0e2ea3", "filename": "xtask/src/tidy.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/98395f29a417b37a5969594f0cac5ae23585da85/xtask%2Fsrc%2Ftidy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98395f29a417b37a5969594f0cac5ae23585da85/xtask%2Fsrc%2Ftidy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Ftidy.rs?ref=98395f29a417b37a5969594f0cac5ae23585da85", "patch": "@@ -193,7 +193,9 @@ https://github.blog/2015-06-08-how-to-undo-almost-anything-with-git/#redo-after-\n fn deny_clippy(path: &Path, text: &str) {\n     let ignore = &[\n         // The documentation in string literals may contain anything for its own purposes\n-        \"ide_completion/src/generated_lint_completions.rs\",\n+        \"ide_db/src/helpers/generated_lints.rs\",\n+        // The tests test clippy lint hovers\n+        \"ide/src/hover.rs\",\n     ];\n     if ignore.iter().any(|p| path.ends_with(p)) {\n         return;\n@@ -280,7 +282,7 @@ fn check_todo(path: &Path, text: &str) {\n         // `ast::make`.\n         \"ast/make.rs\",\n         // The documentation in string literals may contain anything for its own purposes\n-        \"ide_completion/src/generated_lint_completions.rs\",\n+        \"ide_db/src/helpers/generated_lints.rs\",\n     ];\n     if need_todo.iter().any(|p| path.ends_with(p)) {\n         return;\n@@ -310,7 +312,7 @@ fn check_dbg(path: &Path, text: &str) {\n         \"ide_completion/src/completions/postfix.rs\",\n         // The documentation in string literals may contain anything for its own purposes\n         \"ide_completion/src/lib.rs\",\n-        \"ide_completion/src/generated_lint_completions.rs\",\n+        \"ide_db/src/helpers/generated_lints.rs\",\n         // test for doc test for remove_dbg\n         \"src/tests/generated.rs\",\n     ];"}]}