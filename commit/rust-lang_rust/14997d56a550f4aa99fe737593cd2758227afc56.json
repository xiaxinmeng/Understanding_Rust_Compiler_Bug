{"sha": "14997d56a550f4aa99fe737593cd2758227afc56", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0OTk3ZDU2YTU1MGY0YWE5OWZlNzM3NTkzY2QyNzU4MjI3YWZjNTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-05T20:27:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-05T20:27:17Z"}, "message": "Auto merge of #55933 - euclio:doc-panic, r=QuietMisdreavus\n\nemit error when doc generation fails\n\nFixes #41813.\n\nThe diagnostic looks something like this:\n\n```\nerror: couldn't generate documentation: No space left on device (os error 28)\n  |\n  = note: failed to create or modify \"/path/to/crate/target/doc/src/lazycell\"\n```", "tree": {"sha": "41d01a5ff23751fb7fa25b7f94280f283889fae8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41d01a5ff23751fb7fa25b7f94280f283889fae8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14997d56a550f4aa99fe737593cd2758227afc56", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14997d56a550f4aa99fe737593cd2758227afc56", "html_url": "https://github.com/rust-lang/rust/commit/14997d56a550f4aa99fe737593cd2758227afc56", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14997d56a550f4aa99fe737593cd2758227afc56/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b866f7d258a2428e004039eb0f3fabd73cc9d6ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/b866f7d258a2428e004039eb0f3fabd73cc9d6ae", "html_url": "https://github.com/rust-lang/rust/commit/b866f7d258a2428e004039eb0f3fabd73cc9d6ae"}, {"sha": "c359f98c7a0cd6f2af10fb1369477b9a03b32c44", "url": "https://api.github.com/repos/rust-lang/rust/commits/c359f98c7a0cd6f2af10fb1369477b9a03b32c44", "html_url": "https://github.com/rust-lang/rust/commit/c359f98c7a0cd6f2af10fb1369477b9a03b32c44"}], "stats": {"total": 48, "additions": 43, "deletions": 5}, "files": [{"sha": "3365eb6d780d6a16319bdd644ef73f81e73da678", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/14997d56a550f4aa99fe737593cd2758227afc56/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14997d56a550f4aa99fe737593cd2758227afc56/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=14997d56a550f4aa99fe737593cd2758227afc56", "patch": "@@ -202,8 +202,8 @@ impl Impl {\n \n #[derive(Debug)]\n pub struct Error {\n-    file: PathBuf,\n-    error: io::Error,\n+    pub file: PathBuf,\n+    pub error: io::Error,\n }\n \n impl error::Error for Error {"}, {"sha": "b21f005c06bff5cc205368cc0ea938d4851e011f", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/14997d56a550f4aa99fe737593cd2758227afc56/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14997d56a550f4aa99fe737593cd2758227afc56/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=14997d56a550f4aa99fe737593cd2758227afc56", "patch": "@@ -387,9 +387,21 @@ fn main_args(args: &[String]) -> isize {\n         info!(\"going to format\");\n         let (error_format, treat_err_as_bug, ui_testing) = diag_opts;\n         let diag = core::new_handler(error_format, None, treat_err_as_bug, ui_testing);\n-        html::render::run(krate, renderopts, passes.into_iter().collect(), renderinfo, &diag)\n-            .expect(\"failed to generate documentation\");\n-        0\n+        match html::render::run(\n+            krate,\n+            renderopts,\n+            passes.into_iter().collect(),\n+            renderinfo,\n+            &diag,\n+        ) {\n+            Ok(_) => rustc_driver::EXIT_SUCCESS,\n+            Err(e) => {\n+                diag.struct_err(&format!(\"couldn't generate documentation: {}\", e.error))\n+                    .note(&format!(\"failed to create or modify \\\"{}\\\"\", e.file.display()))\n+                    .emit();\n+                rustc_driver::EXIT_FAILURE\n+            }\n+        }\n     })\n }\n "}, {"sha": "2055c9cbf2da055c18db2ab27ce60dc44872febb", "filename": "src/test/run-make-fulldeps/rustdoc-io-error/Makefile", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/14997d56a550f4aa99fe737593cd2758227afc56/src%2Ftest%2Frun-make-fulldeps%2Frustdoc-io-error%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/14997d56a550f4aa99fe737593cd2758227afc56/src%2Ftest%2Frun-make-fulldeps%2Frustdoc-io-error%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Frustdoc-io-error%2FMakefile?ref=14997d56a550f4aa99fe737593cd2758227afc56", "patch": "@@ -0,0 +1,25 @@\n+-include ../tools.mk\n+\n+# This test verifies that rustdoc doesn't ICE when it encounters an IO error\n+# while generating files. Ideally this would be a rustdoc-ui test, so we could\n+# verify the error message as well.\n+\n+OUTPUT_DIR := \"$(TMPDIR)/rustdoc-io-error\"\n+\n+# Ignore Windows: the test uses `chmod`.\n+ifndef IS_WINDOWS\n+\n+# This test operates by creating a temporary directory and modifying its\n+# permissions so that it is not writable. We have to take special care to set\n+# the permissions back to normal so that it's able to be deleted later.\n+all:\n+\tmkdir -p $(OUTPUT_DIR)\n+\tchmod u-w $(OUTPUT_DIR)\n+\t-$(shell $(RUSTDOC) -o $(OUTPUT_DIR) foo.rs)\n+\tchmod u+w $(OUTPUT_DIR)\n+\texit $($(.SHELLSTATUS) -eq 1)\n+\n+else\n+all:\n+\n+endif"}, {"sha": "4a835673a596bcd05404f43d34082bf2785f2a9d", "filename": "src/test/run-make-fulldeps/rustdoc-io-error/foo.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/14997d56a550f4aa99fe737593cd2758227afc56/src%2Ftest%2Frun-make-fulldeps%2Frustdoc-io-error%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14997d56a550f4aa99fe737593cd2758227afc56/src%2Ftest%2Frun-make-fulldeps%2Frustdoc-io-error%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Frustdoc-io-error%2Ffoo.rs?ref=14997d56a550f4aa99fe737593cd2758227afc56", "patch": "@@ -0,0 +1 @@\n+pub struct Foo;"}]}