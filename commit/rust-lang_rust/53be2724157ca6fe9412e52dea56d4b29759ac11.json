{"sha": "53be2724157ca6fe9412e52dea56d4b29759ac11", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzYmUyNzI0MTU3Y2E2ZmU5NDEyZTUyZGVhNTZkNGIyOTc1OWFjMTE=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-10-23T13:56:21Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-10-29T09:01:27Z"}, "message": "ci: enable \"run when submodule changes\" with environment variables\n\nWe have a job in our CI (PR's x86_64-gnu-tools) that's supposed to run\nonly when a submodule is changed in the PR, and it works by having a\ntask at the start of the build that skips all the following tasks if the\ncondition isn't met.\n\nBefore this commit that task was gated with template parameters, which\nis a unique feature of Azure Pipelines. To make our CI more generic this\ncommit switches the gate to use a simple environment variable plus a\ncondition, which should be supported on more CI providers.", "tree": {"sha": "6ab3506eb3b82b4967517d6b7486ca5c2cfe3395", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ab3506eb3b82b4967517d6b7486ca5c2cfe3395"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/53be2724157ca6fe9412e52dea56d4b29759ac11", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl23/+cACgkQPgar6Auq\n8ZwvwA//eP4EZ6vdjmhKQC9hX1rssegR+iolkNc9mdIKDajFfZzztA+fqlso474G\nGhTQsEi7xq7ff4fBLF2b3aWaHDHQ+6oeOD2UEqw4TDvYjk22BGeO4EznQuBBkQeP\ng5rY7bYYLKF4ZG7xQV+JkixLf0bdgRUt67s2KrxWyD9QcEa9xilW9MkP2TwA2mQA\no5/rVNeUEw3rTqm4OaZ4lLkzPaI8ocl6A/wLr2yOieriVbKoPKM1wLk7qzB2Djqf\naREKdtui+bdmwaIls2sY28+RDFVwOD8nSG/+UWVD3cUpg8HALuJzZ6BjfEDE0TSF\nBgyt+O4HucnFLxjGACFXchk9p1D78UlAm3QOZCdvmH2rfOQoujG6tMXkX8JZN+CR\n4qRWd5w/2WBOvbFP+j/C3ioBhHO/41+9IK/M7mzakudsyYTvmkQko7xmcrvTEMbe\necFEpsdxshmsQJLiHuBGXPZ/WlguRYiJc2hEskHvdP/i4eERDOd3o30Odndoq8G5\nYhDDyMbKZ98B7zCxbanmdMFh6XKNNPVE6tZ4LRTOVPZtHb4cvhv36cMy8HsxwsJu\n8nXy0JzupaUX1x7orULBkjnyWAIqnbMj4tljzSHYYl3jeXePRljzRtjaAxvS26Pn\nGYe+goUjYQkBzy1rwmgvUZcBdqIt4mUsdZdjv2Qm+Yt6yIkY3e8=\n=Mirs\n-----END PGP SIGNATURE-----", "payload": "tree 6ab3506eb3b82b4967517d6b7486ca5c2cfe3395\nparent 2dd4e7320e620dc9a59423c55a7db3520ba8b553\nauthor Pietro Albini <pietro@pietroalbini.org> 1571838981 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1572339687 +0100\n\nci: enable \"run when submodule changes\" with environment variables\n\nWe have a job in our CI (PR's x86_64-gnu-tools) that's supposed to run\nonly when a submodule is changed in the PR, and it works by having a\ntask at the start of the build that skips all the following tasks if the\ncondition isn't met.\n\nBefore this commit that task was gated with template parameters, which\nis a unique feature of Azure Pipelines. To make our CI more generic this\ncommit switches the gate to use a simple environment variable plus a\ncondition, which should be supported on more CI providers.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/53be2724157ca6fe9412e52dea56d4b29759ac11", "html_url": "https://github.com/rust-lang/rust/commit/53be2724157ca6fe9412e52dea56d4b29759ac11", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/53be2724157ca6fe9412e52dea56d4b29759ac11/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2dd4e7320e620dc9a59423c55a7db3520ba8b553", "url": "https://api.github.com/repos/rust-lang/rust/commits/2dd4e7320e620dc9a59423c55a7db3520ba8b553", "html_url": "https://github.com/rust-lang/rust/commit/2dd4e7320e620dc9a59423c55a7db3520ba8b553"}], "stats": {"total": 43, "additions": 15, "deletions": 28}, "files": [{"sha": "566e654fdb3f0f8ffb62fa70415f57af8070f367", "filename": "src/ci/azure-pipelines/pr.yml", "status": "modified", "additions": 3, "deletions": 11, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/53be2724157ca6fe9412e52dea56d4b29759ac11/src%2Fci%2Fazure-pipelines%2Fpr.yml", "raw_url": "https://github.com/rust-lang/rust/raw/53be2724157ca6fe9412e52dea56d4b29759ac11/src%2Fci%2Fazure-pipelines%2Fpr.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fpr.yml?ref=53be2724157ca6fe9412e52dea56d4b29759ac11", "patch": "@@ -22,14 +22,6 @@ jobs:\n         IMAGE: x86_64-gnu-llvm-6.0\n       mingw-check:\n         IMAGE: mingw-check\n-\n-- job: LinuxTools\n-  timeoutInMinutes: 600\n-  pool:\n-    vmImage: ubuntu-16.04\n-  steps:\n-    - template: steps/run.yml\n-      parameters:\n-        only_on_updated_submodules: 'yes'\n-  variables:\n-    IMAGE: x86_64-gnu-tools\n+      x86_64-gnu-tools:\n+        IMAGE: x86_64-gnu-tools\n+        CI_ONLY_WHEN_SUBMODULES_CHANGED: 1"}, {"sha": "f3339808567e72a042bb0045ccb2502137f54874", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 12, "deletions": 17, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/53be2724157ca6fe9412e52dea56d4b29759ac11/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/53be2724157ca6fe9412e52dea56d4b29759ac11/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=53be2724157ca6fe9412e52dea56d4b29759ac11", "patch": "@@ -6,11 +6,6 @@\n #\n # Check travis config for `gdb --batch` command to print all crash logs\n \n-parameters:\n-  # When this parameter is set to anything other than an empty string the tests\n-  # will only be executed when the commit updates submodules\n-  only_on_updated_submodules: ''\n-\n steps:\n \n # Disable automatic line ending conversion, which is enabled by default on\n@@ -29,18 +24,18 @@ steps:\n # Set the SKIP_JOB environment variable if this job is supposed to only run\n # when submodules are updated and they were not. The following time consuming\n # tasks will be skipped when the environment variable is present.\n-- ${{ if parameters.only_on_updated_submodules }}:\n-  - bash: |\n-      set -e\n-      # Submodules pseudo-files inside git have the 160000 permissions, so when\n-      # those files are present in the diff a submodule was updated.\n-      if git diff HEAD^ | grep \"^index .* 160000\" >/dev/null 2>&1; then\n-          echo \"Executing the job since submodules are updated\"\n-      else\n-          echo \"Not executing this job since no submodules were updated\"\n-          echo \"##vso[task.setvariable variable=SKIP_JOB;]1\"\n-      fi\n-    displayName: Decide whether to run this job\n+- bash: |\n+    set -e\n+    # Submodules pseudo-files inside git have the 160000 permissions, so when\n+    # those files are present in the diff a submodule was updated.\n+    if git diff HEAD^ | grep \"^index .* 160000\" >/dev/null 2>&1; then\n+        echo \"Executing the job since submodules are updated\"\n+    else\n+        echo \"Not executing this job since no submodules were updated\"\n+        echo \"##vso[task.setvariable variable=SKIP_JOB;]1\"\n+    fi\n+  displayName: Decide whether to run this job\n+  condition: and(succeeded(), variables.CI_ONLY_WHEN_SUBMODULES_CHANGED)\n \n # Spawn a background process to collect CPU usage statistics which we'll upload\n # at the end of the build. See the comments in the script here for more"}]}