{"sha": "3760c91252b1a6697fbd05e98e72c7e78493a72e", "node_id": "C_kwDOAAsO6NoAKDM3NjBjOTEyNTJiMWE2Njk3ZmJkMDVlOThlNzJjN2U3ODQ5M2E3MmU", "commit": {"author": {"name": "Nicholas-Baron", "email": "nicholas.baron.ten@gmail.com", "date": "2021-10-04T00:07:43Z"}, "committer": {"name": "Nicholas-Baron", "email": "nicholas.baron.ten@gmail.com", "date": "2021-10-04T00:07:43Z"}, "message": "Make write_rustdoc_diff a more generic function", "tree": {"sha": "5d8872e891e33bbf0c22ba5174fe8e5f692dfe64", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d8872e891e33bbf0c22ba5174fe8e5f692dfe64"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3760c91252b1a6697fbd05e98e72c7e78493a72e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3760c91252b1a6697fbd05e98e72c7e78493a72e", "html_url": "https://github.com/rust-lang/rust/commit/3760c91252b1a6697fbd05e98e72c7e78493a72e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3760c91252b1a6697fbd05e98e72c7e78493a72e/comments", "author": {"login": "Nicholas-Baron", "id": 35079404, "node_id": "MDQ6VXNlcjM1MDc5NDA0", "avatar_url": "https://avatars.githubusercontent.com/u/35079404?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nicholas-Baron", "html_url": "https://github.com/Nicholas-Baron", "followers_url": "https://api.github.com/users/Nicholas-Baron/followers", "following_url": "https://api.github.com/users/Nicholas-Baron/following{/other_user}", "gists_url": "https://api.github.com/users/Nicholas-Baron/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nicholas-Baron/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nicholas-Baron/subscriptions", "organizations_url": "https://api.github.com/users/Nicholas-Baron/orgs", "repos_url": "https://api.github.com/users/Nicholas-Baron/repos", "events_url": "https://api.github.com/users/Nicholas-Baron/events{/privacy}", "received_events_url": "https://api.github.com/users/Nicholas-Baron/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nicholas-Baron", "id": 35079404, "node_id": "MDQ6VXNlcjM1MDc5NDA0", "avatar_url": "https://avatars.githubusercontent.com/u/35079404?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nicholas-Baron", "html_url": "https://github.com/Nicholas-Baron", "followers_url": "https://api.github.com/users/Nicholas-Baron/followers", "following_url": "https://api.github.com/users/Nicholas-Baron/following{/other_user}", "gists_url": "https://api.github.com/users/Nicholas-Baron/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nicholas-Baron/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nicholas-Baron/subscriptions", "organizations_url": "https://api.github.com/users/Nicholas-Baron/orgs", "repos_url": "https://api.github.com/users/Nicholas-Baron/repos", "events_url": "https://api.github.com/users/Nicholas-Baron/events{/privacy}", "received_events_url": "https://api.github.com/users/Nicholas-Baron/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a57a462498e3ce954e0b5b7ddd2502bd74875f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a57a462498e3ce954e0b5b7ddd2502bd74875f4", "html_url": "https://github.com/rust-lang/rust/commit/2a57a462498e3ce954e0b5b7ddd2502bd74875f4"}], "stats": {"total": 29, "additions": 21, "deletions": 8}, "files": [{"sha": "92c80c27de03bea3ced5f5b696ea0e856ace9e72", "filename": "src/tools/compiletest/src/compute_diff.rs", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3760c91252b1a6697fbd05e98e72c7e78493a72e/src%2Ftools%2Fcompiletest%2Fsrc%2Fcompute_diff.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3760c91252b1a6697fbd05e98e72c7e78493a72e/src%2Ftools%2Fcompiletest%2Fsrc%2Fcompute_diff.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcompute_diff.rs?ref=3760c91252b1a6697fbd05e98e72c7e78493a72e", "patch": "@@ -1,4 +1,5 @@\n use std::collections::VecDeque;\n+use std::fs::{File, FileType};\n use std::path::Path;\n \n #[derive(Debug, PartialEq)]\n@@ -106,23 +107,26 @@ pub(crate) fn write_diff(expected: &str, actual: &str, context_size: usize) -> S\n     output\n }\n \n+/// Filters based on filetype and extension whether to diff a file.\n+///\n /// Returns whether any data was actually written.\n-pub(crate) fn write_rustdoc_diff(\n+pub(crate) fn write_filtered_diff<Filter>(\n     diff_filename: &str,\n     out_dir: &Path,\n     compare_dir: &Path,\n     verbose: bool,\n-) -> bool {\n-    use std::fs::File;\n+    filter: Filter,\n+) -> bool\n+where\n+    Filter: Fn(FileType, Option<&str>) -> bool,\n+{\n     use std::io::{Read, Write};\n     let mut diff_output = File::create(diff_filename).unwrap();\n     let mut wrote_data = false;\n     for entry in walkdir::WalkDir::new(out_dir) {\n         let entry = entry.expect(\"failed to read file\");\n         let extension = entry.path().extension().and_then(|p| p.to_str());\n-        if entry.file_type().is_file()\n-            && (extension == Some(\"html\".into()) || extension == Some(\"js\".into()))\n-        {\n+        if filter(entry.file_type(), extension) {\n             let expected_path = compare_dir.join(entry.path().strip_prefix(&out_dir).unwrap());\n             let expected = if let Ok(s) = std::fs::read(&expected_path) { s } else { continue };\n             let actual_path = entry.path();"}, {"sha": "0821e279d2485a9efeb2cc64e34772024a42a969", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3760c91252b1a6697fbd05e98e72c7e78493a72e/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3760c91252b1a6697fbd05e98e72c7e78493a72e/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=3760c91252b1a6697fbd05e98e72c7e78493a72e", "patch": "@@ -8,7 +8,7 @@ use crate::common::{CompareMode, FailMode, PassMode};\n use crate::common::{Config, TestPaths};\n use crate::common::{Pretty, RunPassValgrind};\n use crate::common::{UI_RUN_STDERR, UI_RUN_STDOUT};\n-use crate::compute_diff::{write_diff, write_rustdoc_diff};\n+use crate::compute_diff::{write_diff, write_filtered_diff};\n use crate::errors::{self, Error, ErrorKind};\n use crate::header::TestProps;\n use crate::json;\n@@ -2403,7 +2403,16 @@ impl<'test> TestCx<'test> {\n \n         let diff_filename = format!(\"build/tmp/rustdoc-compare-{}.diff\", std::process::id());\n \n-        if !write_rustdoc_diff(&diff_filename, out_dir, &compare_dir, self.config.verbose) {\n+        if !write_filtered_diff(\n+            &diff_filename,\n+            out_dir,\n+            &compare_dir,\n+            self.config.verbose,\n+            |file_type, extension| {\n+                file_type.is_file()\n+                    && (extension == Some(\"html\".into()) || extension == Some(\"js\".into()))\n+            },\n+        ) {\n             return;\n         }\n "}]}