{"sha": "c0451f73b2094d7edccb77d7ea8be48f64887e67", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwNDUxZjczYjIwOTRkN2VkY2NiNzdkN2VhOGJlNDhmNjQ4ODdlNjc=", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-09-06T07:09:32Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-09-06T07:10:48Z"}, "message": "Correctly handle niche of enum", "tree": {"sha": "fe89ca4480c65c7158412c20bf1b479dfa2e1441", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe89ca4480c65c7158412c20bf1b479dfa2e1441"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0451f73b2094d7edccb77d7ea8be48f64887e67", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEQ7Fl7qPq2YcWF1dqAn35M4hird0FAmE1vvsACgkQAn35M4hi\nrd0maQ/+J1BkqYNrhtLtENMET/xf+Xj+67S7gjqFO6RaTmHWbvmPqdsP/VX4Yibc\n+vPHRUySJRsayPozQREfXfuyTSM0a0X+6m66RzpMCBLzycphpMW2OoD32v1+7ZKQ\nh2hu6IarDR2PmMnDGW5O/HRtx40oEk/wBL6wQeZU0FuNhU76HWtKVgL3CYwV8/qO\nLUOJGeQz0aY+syhRGTn3NraaWbrYSL5ylDANxJWnmPTifkyOBu10h8fy2U9c/zFM\nyeFVuViOjlOcZbwAnSXiBuQ8Mpj5zfJyhHA+1TcKo5wqSZ+bRIGWjbzOXcp+cxqT\nCtljAOX/FFFoWCQCOfqsTUZLJZ3aP1WyqzKTUtD1kVKKMp2UeV02/KocMMylmuU7\nhp+8VR2SwTjWe9+MlXNd0m5Y6BcxeDewhSu2tqq/sF7UfbdwchQw+w1F7++d+pKu\n7Fz8jBn1nXDAMbXkwDDT58YUYSv95CIfYHJWd4sgd6uV6pDGYVE4HgOUS91NWq2T\nnKYHliKonC+UkhAGBOzAvg89T+so5J5l2ZHhgrJ6ZECQVAVAlbTV3Vqml0IqoQx8\nJ0W27QjyZ5aInwGCvoSZhnAtBfOaSte4roa8ftk+87tci0AzxckRywKnY/PDLWnZ\n2Q8YyK7AtFBxilrZ3ZS4qlOewskgrzxmCfPc/Kim8hLbB3MRK8c=\n=8v5A\n-----END PGP SIGNATURE-----", "payload": "tree fe89ca4480c65c7158412c20bf1b479dfa2e1441\nparent 5f1505e7f13fdea3f2d626059010cf26edfce4f8\nauthor Deadbeef <ent3rm4n@gmail.com> 1630912172 +0000\ncommitter Deadbeef <ent3rm4n@gmail.com> 1630912248 +0000\n\nCorrectly handle niche of enum\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0451f73b2094d7edccb77d7ea8be48f64887e67", "html_url": "https://github.com/rust-lang/rust/commit/c0451f73b2094d7edccb77d7ea8be48f64887e67", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0451f73b2094d7edccb77d7ea8be48f64887e67/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5f1505e7f13fdea3f2d626059010cf26edfce4f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f1505e7f13fdea3f2d626059010cf26edfce4f8", "html_url": "https://github.com/rust-lang/rust/commit/5f1505e7f13fdea3f2d626059010cf26edfce4f8"}], "stats": {"total": 21, "additions": 17, "deletions": 4}, "files": [{"sha": "aac631a1cfcddfb95cc49ec669cf407b9218545a", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c0451f73b2094d7edccb77d7ea8be48f64887e67/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0451f73b2094d7edccb77d7ea8be48f64887e67/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=c0451f73b2094d7edccb77d7ea8be48f64887e67", "patch": "@@ -13,7 +13,7 @@ use rustc_middle::ty::layout::LayoutError;\n use rustc_middle::ty::{Adt, TyCtxt};\n use rustc_span::hygiene::MacroKind;\n use rustc_span::symbol::{kw, sym, Symbol};\n-use rustc_target::abi::{Layout, Primitive, Variants};\n+use rustc_target::abi::{Layout, Primitive, TagEncoding, Variants};\n \n use super::{\n     collect_paths_for_type, document, ensure_trailing_slash, item_ty_to_strs, notable_traits_decl,\n@@ -1639,7 +1639,9 @@ fn document_type_layout(w: &mut Buffer, cx: &Context<'_>, ty_def_id: DefId) {\n             w.write_str(\"<p><strong>Size:</strong> \");\n             write_size_of_layout(w, ty_layout.layout, 0);\n             writeln!(w, \"</p>\");\n-            if let Variants::Multiple { variants, tag, .. } = &ty_layout.layout.variants {\n+            if let Variants::Multiple { variants, tag, tag_encoding, .. } =\n+                &ty_layout.layout.variants\n+            {\n                 if !variants.is_empty() {\n                     w.write_str(\n                         \"<p><strong>Size for each variant:</strong></p>\\\n@@ -1652,10 +1654,12 @@ fn document_type_layout(w: &mut Buffer, cx: &Context<'_>, ty_def_id: DefId) {\n                         span_bug!(tcx.def_span(ty_def_id), \"not an adt\")\n                     };\n \n-                    let tag_size = if let Primitive::Int(i, _) = tag.value {\n+                    let tag_size = if let TagEncoding::Niche { .. } = tag_encoding {\n+                        0\n+                    } else if let Primitive::Int(i, _) = tag.value {\n                         i.size().bytes()\n                     } else {\n-                        span_bug!(tcx.def_span(ty_def_id), \"tag is not int\")\n+                        span_bug!(tcx.def_span(ty_def_id), \"tag is neither niche nor int\")\n                     };\n \n                     for (index, layout) in variants.iter_enumerated() {"}, {"sha": "0868486fa59cd017a7d16c6a0c8c275bb345d0e7", "filename": "src/test/rustdoc/type-layout.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c0451f73b2094d7edccb77d7ea8be48f64887e67/src%2Ftest%2Frustdoc%2Ftype-layout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0451f73b2094d7edccb77d7ea8be48f64887e67/src%2Ftest%2Frustdoc%2Ftype-layout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Ftype-layout.rs?ref=c0451f73b2094d7edccb77d7ea8be48f64887e67", "patch": "@@ -61,3 +61,12 @@ pub enum Variants {\n     A,\n     B(u8),\n }\n+\n+// @has type_layout/enum.WithNiche.html 'Size: '\n+// @has - //p '4 bytes'\n+// @has - '<code>None</code>: 0 bytes'\n+// @has - '<code>Some</code>: 4 bytes'\n+pub enum WithNiche {\n+    None,\n+    Some(std::num::NonZeroU32),\n+}"}]}