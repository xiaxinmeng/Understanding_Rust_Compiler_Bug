{"sha": "0976a1ec8ad72df333f746439e26b139ea5ae3e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5NzZhMWVjOGFkNzJkZjMzM2Y3NDY0MzllMjZiMTM5ZWE1YWUzZTI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-16T20:08:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-16T20:08:10Z"}, "message": "Merge #7300\n\n7300: When building an item-tree, keep fewer nodes in memory r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "612d3deafdcd6ae6801f65b1e7eab9fde1d24276", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/612d3deafdcd6ae6801f65b1e7eab9fde1d24276"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0976a1ec8ad72df333f746439e26b139ea5ae3e2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgA0eqCRBK7hj4Ov3rIwAAdHIIAKcJYzxCJz9K8EDYQVmYi03o\n/31u5nXYTRbU0SJ5uucc0I58Lzmp6cjLlI7Dsj0GBszB1h3Sldh7Blz1Ln4MCnzT\nOpOPH+E85hcPDfAV1p2KN6RGAXKmt9Zm/5QxoUeLKc/9cdWaUaj8i5i0rPzoUW1f\nzyNAzpvBQGB5NSvG+BX43PDoK/4YmLXRelUnLaGENW5WJcMJWLHR8IiuEysXdTpR\nIQLl2Cdi++D1iv2xA8gL4IOh7kVMT4OqnXfE9NZkYJxrVmArpx7ndqmXsByhh9P+\nZBflqwZH5gdnJ3WDuh0EHFVgOHOQ9xCAEyhvQVH880Ru3rXHi/T5dEhIuobU9Qw=\n=9/X3\n-----END PGP SIGNATURE-----\n", "payload": "tree 612d3deafdcd6ae6801f65b1e7eab9fde1d24276\nparent 397b5e5d8e03e7e00041e19e5cc647f43b7fc0d4\nparent b38414c7f4e2e62baa8f09e6ce162ac39391bb8c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1610827690 +0000\ncommitter GitHub <noreply@github.com> 1610827690 +0000\n\nMerge #7300\n\n7300: When building an item-tree, keep fewer nodes in memory r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0976a1ec8ad72df333f746439e26b139ea5ae3e2", "html_url": "https://github.com/rust-lang/rust/commit/0976a1ec8ad72df333f746439e26b139ea5ae3e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0976a1ec8ad72df333f746439e26b139ea5ae3e2/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "397b5e5d8e03e7e00041e19e5cc647f43b7fc0d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/397b5e5d8e03e7e00041e19e5cc647f43b7fc0d4", "html_url": "https://github.com/rust-lang/rust/commit/397b5e5d8e03e7e00041e19e5cc647f43b7fc0d4"}, {"sha": "b38414c7f4e2e62baa8f09e6ce162ac39391bb8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/b38414c7f4e2e62baa8f09e6ce162ac39391bb8c", "html_url": "https://github.com/rust-lang/rust/commit/b38414c7f4e2e62baa8f09e6ce162ac39391bb8c"}], "stats": {"total": 36, "additions": 27, "deletions": 9}, "files": [{"sha": "0c6e9ff61e28a0ec2c2be20cbc160e967337845e", "filename": "Cargo.lock", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0976a1ec8ad72df333f746439e26b139ea5ae3e2/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/0976a1ec8ad72df333f746439e26b139ea5ae3e2/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=0976a1ec8ad72df333f746439e26b139ea5ae3e2", "patch": "@@ -1325,9 +1325,9 @@ checksum = \"3b181ba2dcf07aaccad5448e8ead58db5b742cf85dfe035e2227f137a539a189\"\n \n [[package]]\n name = \"rowan\"\n-version = \"0.10.2\"\n+version = \"0.10.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"5093b337dccf58ace6c6d1fe7e28a0b8229c1e72579ae66bae258fbe53df3e0e\"\n+checksum = \"d55d358c5fda3d5c4484f71a4808f5eeb39a0aff93bf3acebc680a6d15376f3c\"\n dependencies = [\n  \"rustc-hash\",\n  \"smol_str\","}, {"sha": "2401b0cc59dd34871238d8521c7d290a6c71b45d", "filename": "crates/hir_expand/src/ast_id_map.rs", "status": "modified", "additions": 24, "deletions": 6, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/0976a1ec8ad72df333f746439e26b139ea5ae3e2/crates%2Fhir_expand%2Fsrc%2Fast_id_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0976a1ec8ad72df333f746439e26b139ea5ae3e2/crates%2Fhir_expand%2Fsrc%2Fast_id_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fast_id_map.rs?ref=0976a1ec8ad72df333f746439e26b139ea5ae3e2", "patch": "@@ -72,10 +72,12 @@ impl AstIdMap {\n         // get lower ids then children. That is, adding a new child does not\n         // change parent's id. This means that, say, adding a new function to a\n         // trait does not change ids of top-level items, which helps caching.\n-        bfs(node, |it| {\n-            if let Some(module_item) = ast::Item::cast(it) {\n+        bdfs(node, |it| match ast::Item::cast(it) {\n+            Some(module_item) => {\n                 res.alloc(module_item.syntax());\n+                true\n             }\n+            None => false,\n         });\n         res\n     }\n@@ -105,14 +107,30 @@ impl AstIdMap {\n     }\n }\n \n-/// Walks the subtree in bfs order, calling `f` for each node.\n-fn bfs(node: &SyntaxNode, mut f: impl FnMut(SyntaxNode)) {\n+/// Walks the subtree in bdfs order, calling `f` for each node. What is bdfs\n+/// order? It is a mix of breadth-first and depth first orders. Nodes for which\n+/// `f` returns true are visited breadth-first, all the other nodes are explored\n+/// depth-first.\n+///\n+/// In other words, the size of the bfs queue is bound by the number of \"true\"\n+/// nodes.\n+fn bdfs(node: &SyntaxNode, mut f: impl FnMut(SyntaxNode) -> bool) {\n     let mut curr_layer = vec![node.clone()];\n     let mut next_layer = vec![];\n     while !curr_layer.is_empty() {\n         curr_layer.drain(..).for_each(|node| {\n-            next_layer.extend(node.children());\n-            f(node);\n+            let mut preorder = node.preorder();\n+            while let Some(event) = preorder.next() {\n+                match event {\n+                    syntax::WalkEvent::Enter(node) => {\n+                        if f(node.clone()) {\n+                            next_layer.extend(node.children());\n+                            preorder.skip_subtree();\n+                        }\n+                    }\n+                    syntax::WalkEvent::Leave(_) => {}\n+                }\n+            }\n         });\n         std::mem::swap(&mut curr_layer, &mut next_layer);\n     }"}, {"sha": "52394b3373cbd7a94ad4255ce2b63278cfc371cc", "filename": "crates/syntax/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0976a1ec8ad72df333f746439e26b139ea5ae3e2/crates%2Fsyntax%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/0976a1ec8ad72df333f746439e26b139ea5ae3e2/crates%2Fsyntax%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2FCargo.toml?ref=0976a1ec8ad72df333f746439e26b139ea5ae3e2", "patch": "@@ -12,7 +12,7 @@ doctest = false\n \n [dependencies]\n itertools = \"0.10.0\"\n-rowan = \"0.10.1\"\n+rowan = \"0.10.3\"\n rustc_lexer = { version = \"697.0.0\", package = \"rustc-ap-rustc_lexer\" }\n rustc-hash = \"1.1.0\"\n arrayvec = \"0.5.1\""}]}