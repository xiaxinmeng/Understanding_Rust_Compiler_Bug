{"sha": "f8303ada90e1a314cf37875f8285d3d174553c33", "node_id": "C_kwDOAAsO6NoAKGY4MzAzYWRhOTBlMWEzMTRjZjM3ODc1ZjgyODVkM2QxNzQ1NTNjMzM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-30T19:08:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-30T19:08:22Z"}, "message": "Auto merge of #7338 - camsteffen:shadow, r=llogic\n\nRe-write shadow lints\n\nchangelog: Move shadow_unrelated to restriction\nchangelog: The shadow lints find a lot more shadows and are not limited to certain patterns\n\nDrastically simplifies the implementation. Catches a lot more cases.\n\nI removed the \"initialization happens here\" note. It is not helpful IMO.\n\nCloses #318\nFixes #2890\nFixes #6563\nFixes #7588\nFixes #7620", "tree": {"sha": "289f29ebec36d82a51737ec417527eb4eb9c0ff4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/289f29ebec36d82a51737ec417527eb4eb9c0ff4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f8303ada90e1a314cf37875f8285d3d174553c33", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f8303ada90e1a314cf37875f8285d3d174553c33", "html_url": "https://github.com/rust-lang/rust/commit/f8303ada90e1a314cf37875f8285d3d174553c33", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f8303ada90e1a314cf37875f8285d3d174553c33/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a893eb993b2227a0c814b3cd2ea3f5d32c81613b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a893eb993b2227a0c814b3cd2ea3f5d32c81613b", "html_url": "https://github.com/rust-lang/rust/commit/a893eb993b2227a0c814b3cd2ea3f5d32c81613b"}, {"sha": "a17359c696c2b2b01637397882f5657d5bea874f", "url": "https://api.github.com/repos/rust-lang/rust/commits/a17359c696c2b2b01637397882f5657d5bea874f", "html_url": "https://github.com/rust-lang/rust/commit/a17359c696c2b2b01637397882f5657d5bea874f"}], "stats": {"total": 1043, "additions": 471, "deletions": 572}, "files": [{"sha": "6533b94e82bd5ce10c539392ca6a3c627480dbd1", "filename": "clippy_lints/src/lib.register_pedantic.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Flib.register_pedantic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Flib.register_pedantic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_pedantic.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -81,7 +81,6 @@ store.register_group(true, \"clippy::pedantic\", Some(\"clippy_pedantic\"), vec![\n     LintId::of(redundant_else::REDUNDANT_ELSE),\n     LintId::of(ref_option_ref::REF_OPTION_REF),\n     LintId::of(semicolon_if_nothing_returned::SEMICOLON_IF_NOTHING_RETURNED),\n-    LintId::of(shadow::SHADOW_UNRELATED),\n     LintId::of(strings::STRING_ADD_ASSIGN),\n     LintId::of(trait_bounds::TRAIT_DUPLICATION_IN_BOUNDS),\n     LintId::of(trait_bounds::TYPE_REPETITION_IN_BOUNDS),"}, {"sha": "4463dea5fcb8436a12f82721865750869fc16cf1", "filename": "clippy_lints/src/lib.register_restriction.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_restriction.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -50,6 +50,7 @@ store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), ve\n     LintId::of(same_name_method::SAME_NAME_METHOD),\n     LintId::of(shadow::SHADOW_REUSE),\n     LintId::of(shadow::SHADOW_SAME),\n+    LintId::of(shadow::SHADOW_UNRELATED),\n     LintId::of(strings::STRING_ADD),\n     LintId::of(strings::STRING_TO_STRING),\n     LintId::of(strings::STR_TO_STRING),"}, {"sha": "4e21b03217dfa71b27f06482aa41073892252389", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -324,7 +324,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(same_name_method::SameNameMethod));\n     store.register_late_pass(|| Box::new(map_clone::MapClone));\n     store.register_late_pass(|| Box::new(map_err_ignore::MapErrIgnore));\n-    store.register_late_pass(|| Box::new(shadow::Shadow));\n+    store.register_late_pass(|| Box::new(shadow::Shadow::default()));\n     store.register_late_pass(|| Box::new(unit_types::UnitTypes));\n     store.register_late_pass(|| Box::new(loops::Loops));\n     store.register_late_pass(|| Box::new(main_recursion::MainRecursion::default()));"}, {"sha": "2ca7c18800ee2e362e299393058239cf35324ce3", "filename": "clippy_lints/src/shadow.rs", "status": "modified", "additions": 127, "deletions": 300, "changes": 427, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Fshadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_lints%2Fsrc%2Fshadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fshadow.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,17 +1,14 @@\n-use clippy_utils::diagnostics::span_lint_and_then;\n+use clippy_utils::diagnostics::span_lint_and_note;\n use clippy_utils::source::snippet;\n-use clippy_utils::{contains_name, higher, iter_input_pats};\n-use rustc_hir::intravisit::FnKind;\n-use rustc_hir::{\n-    Block, Body, Expr, ExprKind, FnDecl, Guard, HirId, Local, MutTy, Pat, PatKind, Path, QPath, StmtKind, Ty, TyKind,\n-    UnOp,\n-};\n-use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::lint::in_external_macro;\n-use rustc_middle::ty;\n-use rustc_session::{declare_lint_pass, declare_tool_lint};\n-use rustc_span::source_map::Span;\n-use rustc_span::symbol::Symbol;\n+use clippy_utils::visitors::is_local_used;\n+use rustc_data_structures::fx::FxHashMap;\n+use rustc_hir::def::Res;\n+use rustc_hir::def_id::LocalDefId;\n+use rustc_hir::hir_id::ItemLocalId;\n+use rustc_hir::{Block, Body, BodyOwnerKind, Expr, ExprKind, HirId, Node, Pat, PatKind, QPath, UnOp};\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_tool_lint, impl_lint_pass};\n+use rustc_span::{Span, Symbol};\n \n declare_clippy_lint! {\n     /// ### What it does\n@@ -23,10 +20,6 @@ declare_clippy_lint! {\n     /// code. Still, some may opt to avoid it in their code base, they can set this\n     /// lint to `Warn`.\n     ///\n-    /// ### Known problems\n-    /// This lint, as the other shadowing related lints,\n-    /// currently only catches very simple patterns.\n-    ///\n     /// ### Example\n     /// ```rust\n     /// # let x = 1;\n@@ -52,10 +45,6 @@ declare_clippy_lint! {\n     /// because a value may be bound to different things depending on position in\n     /// the code.\n     ///\n-    /// ### Known problems\n-    /// This lint, as the other shadowing related lints,\n-    /// currently only catches very simple patterns.\n-    ///\n     /// ### Example\n     /// ```rust\n     /// let x = 2;\n@@ -83,12 +72,6 @@ declare_clippy_lint! {\n     /// any place in the code. This can be alleviated by either giving more specific\n     /// names to bindings or introducing more scopes to contain the bindings.\n     ///\n-    /// ### Known problems\n-    /// This lint, as the other shadowing related lints,\n-    /// currently only catches very simple patterns. Note that\n-    /// `allow`/`warn`/`deny`/`forbid` attributes only work on the function level\n-    /// for this lint.\n-    ///\n     /// ### Example\n     /// ```rust\n     /// # let y = 1;\n@@ -102,307 +85,151 @@ declare_clippy_lint! {\n     /// let w = z; // use different variable name\n     /// ```\n     pub SHADOW_UNRELATED,\n-    pedantic,\n+    restriction,\n     \"rebinding a name without even using the original value\"\n }\n \n-declare_lint_pass!(Shadow => [SHADOW_SAME, SHADOW_REUSE, SHADOW_UNRELATED]);\n+#[derive(Default)]\n+pub(crate) struct Shadow {\n+    bindings: Vec<FxHashMap<Symbol, Vec<ItemLocalId>>>,\n+}\n+\n+impl_lint_pass!(Shadow => [SHADOW_SAME, SHADOW_REUSE, SHADOW_UNRELATED]);\n \n impl<'tcx> LateLintPass<'tcx> for Shadow {\n-    fn check_fn(\n-        &mut self,\n-        cx: &LateContext<'tcx>,\n-        _: FnKind<'tcx>,\n-        decl: &'tcx FnDecl<'_>,\n-        body: &'tcx Body<'_>,\n-        _: Span,\n-        _: HirId,\n-    ) {\n-        if in_external_macro(cx.sess(), body.value.span) {\n+    fn check_pat(&mut self, cx: &LateContext<'tcx>, pat: &'tcx Pat<'_>) {\n+        let (id, ident) = match pat.kind {\n+            PatKind::Binding(_, hir_id, ident, _) => (hir_id, ident),\n+            _ => return,\n+        };\n+        if ident.span.from_expansion() || ident.span.is_dummy() {\n             return;\n         }\n-        check_fn(cx, decl, body);\n-    }\n-}\n+        let HirId { owner, local_id } = id;\n \n-fn check_fn<'tcx>(cx: &LateContext<'tcx>, decl: &'tcx FnDecl<'_>, body: &'tcx Body<'_>) {\n-    let mut bindings = Vec::with_capacity(decl.inputs.len());\n-    for arg in iter_input_pats(decl, body) {\n-        if let PatKind::Binding(.., ident, _) = arg.pat.kind {\n-            bindings.push((ident.name, ident.span));\n+        // get (or insert) the list of items for this owner and symbol\n+        let data = self.bindings.last_mut().unwrap();\n+        let items_with_name = data.entry(ident.name).or_default();\n+\n+        // check other bindings with the same name, most recently seen first\n+        for &prev in items_with_name.iter().rev() {\n+            if prev == local_id {\n+                // repeated binding in an `Or` pattern\n+                return;\n+            }\n+\n+            if is_shadow(cx, owner, prev, local_id) {\n+                let prev_hir_id = HirId { owner, local_id: prev };\n+                lint_shadow(cx, pat, prev_hir_id, ident.span);\n+                // only lint against the \"nearest\" shadowed binding\n+                break;\n+            }\n         }\n+        // store the binding\n+        items_with_name.push(local_id);\n     }\n-    check_expr(cx, &body.value, &mut bindings);\n-}\n \n-fn check_block<'tcx>(cx: &LateContext<'tcx>, block: &'tcx Block<'_>, bindings: &mut Vec<(Symbol, Span)>) {\n-    let len = bindings.len();\n-    for stmt in block.stmts {\n-        match stmt.kind {\n-            StmtKind::Local(local) => check_local(cx, local, bindings),\n-            StmtKind::Expr(e) | StmtKind::Semi(e) => check_expr(cx, e, bindings),\n-            StmtKind::Item(..) => {},\n+    fn check_body(&mut self, cx: &LateContext<'_>, body: &Body<'_>) {\n+        let hir = cx.tcx.hir();\n+        if !matches!(hir.body_owner_kind(hir.body_owner(body.id())), BodyOwnerKind::Closure) {\n+            self.bindings.push(FxHashMap::default());\n         }\n     }\n-    if let Some(o) = block.expr {\n-        check_expr(cx, o, bindings);\n-    }\n-    bindings.truncate(len);\n-}\n \n-fn check_local<'tcx>(cx: &LateContext<'tcx>, local: &'tcx Local<'_>, bindings: &mut Vec<(Symbol, Span)>) {\n-    if in_external_macro(cx.sess(), local.span) {\n-        return;\n-    }\n-    if higher::is_from_for_desugar(local) {\n-        return;\n-    }\n-    let Local {\n-        pat,\n-        ref ty,\n-        ref init,\n-        span,\n-        ..\n-    } = *local;\n-    if let Some(t) = *ty {\n-        check_ty(cx, t, bindings);\n-    }\n-    if let Some(o) = *init {\n-        check_expr(cx, o, bindings);\n-        check_pat(cx, pat, Some(o), span, bindings);\n-    } else {\n-        check_pat(cx, pat, None, span, bindings);\n+    fn check_body_post(&mut self, cx: &LateContext<'_>, body: &Body<'_>) {\n+        let hir = cx.tcx.hir();\n+        if !matches!(hir.body_owner_kind(hir.body_owner(body.id())), BodyOwnerKind::Closure) {\n+            self.bindings.pop();\n+        }\n     }\n }\n \n-fn is_binding(cx: &LateContext<'_>, pat_id: HirId) -> bool {\n-    let var_ty = cx.typeck_results().node_type_opt(pat_id);\n-    var_ty.map_or(false, |var_ty| !matches!(var_ty.kind(), ty::Adt(..)))\n+fn is_shadow(cx: &LateContext<'_>, owner: LocalDefId, first: ItemLocalId, second: ItemLocalId) -> bool {\n+    let scope_tree = cx.tcx.region_scope_tree(owner.to_def_id());\n+    let first_scope = scope_tree.var_scope(first);\n+    let second_scope = scope_tree.var_scope(second);\n+    scope_tree.is_subscope_of(second_scope, first_scope)\n }\n \n-fn check_pat<'tcx>(\n-    cx: &LateContext<'tcx>,\n-    pat: &'tcx Pat<'_>,\n-    init: Option<&'tcx Expr<'_>>,\n-    span: Span,\n-    bindings: &mut Vec<(Symbol, Span)>,\n-) {\n-    // TODO: match more stuff / destructuring\n-    match pat.kind {\n-        PatKind::Binding(.., ident, ref inner) => {\n-            let name = ident.name;\n-            if is_binding(cx, pat.hir_id) {\n-                let mut new_binding = true;\n-                for tup in bindings.iter_mut() {\n-                    if tup.0 == name {\n-                        lint_shadow(cx, name, span, pat.span, init, tup.1);\n-                        tup.1 = ident.span;\n-                        new_binding = false;\n-                        break;\n-                    }\n-                }\n-                if new_binding {\n-                    bindings.push((name, ident.span));\n-                }\n-            }\n-            if let Some(p) = *inner {\n-                check_pat(cx, p, init, span, bindings);\n-            }\n-        },\n-        PatKind::Struct(_, pfields, _) => {\n-            if let Some(init_struct) = init {\n-                if let ExprKind::Struct(_, efields, _) = init_struct.kind {\n-                    for field in pfields {\n-                        let name = field.ident.name;\n-                        let efield = efields\n-                            .iter()\n-                            .find_map(|f| if f.ident.name == name { Some(&*f.expr) } else { None });\n-                        check_pat(cx, field.pat, efield, span, bindings);\n-                    }\n-                } else {\n-                    for field in pfields {\n-                        check_pat(cx, field.pat, init, span, bindings);\n-                    }\n-                }\n-            } else {\n-                for field in pfields {\n-                    check_pat(cx, field.pat, None, span, bindings);\n-                }\n-            }\n+fn lint_shadow(cx: &LateContext<'_>, pat: &Pat<'_>, shadowed: HirId, span: Span) {\n+    let (lint, msg) = match find_init(cx, pat.hir_id) {\n+        Some(expr) if is_self_shadow(cx, pat, expr, shadowed) => {\n+            let msg = format!(\n+                \"`{}` is shadowed by itself in `{}`\",\n+                snippet(cx, pat.span, \"_\"),\n+                snippet(cx, expr.span, \"..\")\n+            );\n+            (SHADOW_SAME, msg)\n         },\n-        PatKind::Tuple(inner, _) => {\n-            if let Some(init_tup) = init {\n-                if let ExprKind::Tup(tup) = init_tup.kind {\n-                    for (i, p) in inner.iter().enumerate() {\n-                        check_pat(cx, p, Some(&tup[i]), p.span, bindings);\n-                    }\n-                } else {\n-                    for p in inner {\n-                        check_pat(cx, p, init, span, bindings);\n-                    }\n-                }\n-            } else {\n-                for p in inner {\n-                    check_pat(cx, p, None, span, bindings);\n-                }\n-            }\n+        Some(expr) if is_local_used(cx, expr, shadowed) => {\n+            let msg = format!(\n+                \"`{}` is shadowed by `{}` which reuses the original value\",\n+                snippet(cx, pat.span, \"_\"),\n+                snippet(cx, expr.span, \"..\")\n+            );\n+            (SHADOW_REUSE, msg)\n         },\n-        PatKind::Box(inner) => {\n-            if let Some(initp) = init {\n-                if let ExprKind::Box(inner_init) = initp.kind {\n-                    check_pat(cx, inner, Some(inner_init), span, bindings);\n-                } else {\n-                    check_pat(cx, inner, init, span, bindings);\n-                }\n-            } else {\n-                check_pat(cx, inner, init, span, bindings);\n-            }\n+        _ => {\n+            let msg = format!(\"`{}` shadows a previous, unrelated binding\", snippet(cx, pat.span, \"_\"));\n+            (SHADOW_UNRELATED, msg)\n         },\n-        PatKind::Ref(inner, _) => check_pat(cx, inner, init, span, bindings),\n-        // PatVec(Vec<P<Pat>>, Option<P<Pat>>, Vec<P<Pat>>),\n-        _ => (),\n-    }\n+    };\n+    span_lint_and_note(\n+        cx,\n+        lint,\n+        span,\n+        &msg,\n+        Some(cx.tcx.hir().span(shadowed)),\n+        \"previous binding is here\",\n+    );\n }\n \n-fn lint_shadow<'tcx>(\n-    cx: &LateContext<'tcx>,\n-    name: Symbol,\n-    span: Span,\n-    pattern_span: Span,\n-    init: Option<&'tcx Expr<'_>>,\n-    prev_span: Span,\n-) {\n-    if let Some(expr) = init {\n-        if is_self_shadow(name, expr) {\n-            span_lint_and_then(\n-                cx,\n-                SHADOW_SAME,\n-                span,\n-                &format!(\n-                    \"`{}` is shadowed by itself in `{}`\",\n-                    snippet(cx, pattern_span, \"_\"),\n-                    snippet(cx, expr.span, \"..\")\n-                ),\n-                |diag| {\n-                    diag.span_note(prev_span, \"previous binding is here\");\n-                },\n-            );\n-        } else if contains_name(name, expr) {\n-            span_lint_and_then(\n-                cx,\n-                SHADOW_REUSE,\n-                pattern_span,\n-                &format!(\n-                    \"`{}` is shadowed by `{}` which reuses the original value\",\n-                    snippet(cx, pattern_span, \"_\"),\n-                    snippet(cx, expr.span, \"..\")\n-                ),\n-                |diag| {\n-                    diag.span_note(expr.span, \"initialization happens here\");\n-                    diag.span_note(prev_span, \"previous binding is here\");\n-                },\n-            );\n-        } else {\n-            span_lint_and_then(\n-                cx,\n-                SHADOW_UNRELATED,\n-                pattern_span,\n-                &format!(\"`{}` is being shadowed\", snippet(cx, pattern_span, \"_\")),\n-                |diag| {\n-                    diag.span_note(expr.span, \"initialization happens here\");\n-                    diag.span_note(prev_span, \"previous binding is here\");\n+/// Returns true if the expression is a simple transformation of a local binding such as `&x`\n+fn is_self_shadow(cx: &LateContext<'_>, pat: &Pat<'_>, mut expr: &Expr<'_>, hir_id: HirId) -> bool {\n+    let hir = cx.tcx.hir();\n+    let is_direct_binding = hir\n+        .parent_iter(pat.hir_id)\n+        .map_while(|(_id, node)| match node {\n+            Node::Pat(pat) => Some(pat),\n+            _ => None,\n+        })\n+        .all(|pat| matches!(pat.kind, PatKind::Ref(..) | PatKind::Or(_)));\n+    if !is_direct_binding {\n+        return false;\n+    }\n+    loop {\n+        expr = match expr.kind {\n+            ExprKind::Box(e)\n+            | ExprKind::AddrOf(_, _, e)\n+            | ExprKind::Block(\n+                &Block {\n+                    stmts: [],\n+                    expr: Some(e),\n+                    ..\n                 },\n-            );\n+                _,\n+            )\n+            | ExprKind::Unary(UnOp::Deref, e) => e,\n+            ExprKind::Path(QPath::Resolved(None, path)) => break path.res == Res::Local(hir_id),\n+            _ => break false,\n         }\n-    } else {\n-        span_lint_and_then(\n-            cx,\n-            SHADOW_UNRELATED,\n-            span,\n-            &format!(\"`{}` shadows a previous declaration\", snippet(cx, pattern_span, \"_\")),\n-            |diag| {\n-                diag.span_note(prev_span, \"previous binding is here\");\n-            },\n-        );\n     }\n }\n \n-fn check_expr<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>, bindings: &mut Vec<(Symbol, Span)>) {\n-    if in_external_macro(cx.sess(), expr.span) {\n-        return;\n-    }\n-    match expr.kind {\n-        ExprKind::Unary(_, e) | ExprKind::Field(e, _) | ExprKind::AddrOf(_, _, e) | ExprKind::Box(e) => {\n-            check_expr(cx, e, bindings);\n-        },\n-        ExprKind::Block(block, _) | ExprKind::Loop(block, ..) => check_block(cx, block, bindings),\n-        // ExprKind::Call\n-        // ExprKind::MethodCall\n-        ExprKind::Array(v) | ExprKind::Tup(v) => {\n-            for e in v {\n-                check_expr(cx, e, bindings);\n-            }\n-        },\n-        ExprKind::If(cond, then, ref otherwise) => {\n-            check_expr(cx, cond, bindings);\n-            check_expr(cx, then, bindings);\n-            if let Some(o) = *otherwise {\n-                check_expr(cx, o, bindings);\n-            }\n-        },\n-        ExprKind::Match(init, arms, _) => {\n-            check_expr(cx, init, bindings);\n-            let len = bindings.len();\n-            for arm in arms {\n-                check_pat(cx, arm.pat, Some(init), arm.pat.span, bindings);\n-                // This is ugly, but needed to get the right type\n-                if let Some(ref guard) = arm.guard {\n-                    match guard {\n-                        Guard::If(if_expr) => check_expr(cx, if_expr, bindings),\n-                        Guard::IfLet(guard_pat, guard_expr) => {\n-                            check_pat(cx, guard_pat, Some(*guard_expr), guard_pat.span, bindings);\n-                            check_expr(cx, guard_expr, bindings);\n-                        },\n-                    }\n-                }\n-                check_expr(cx, arm.body, bindings);\n-                bindings.truncate(len);\n-            }\n-        },\n-        _ => (),\n-    }\n-}\n-\n-fn check_ty<'tcx>(cx: &LateContext<'tcx>, ty: &'tcx Ty<'_>, bindings: &mut Vec<(Symbol, Span)>) {\n-    match ty.kind {\n-        TyKind::Slice(sty) => check_ty(cx, sty, bindings),\n-        TyKind::Array(fty, ref anon_const) => {\n-            check_ty(cx, fty, bindings);\n-            check_expr(cx, &cx.tcx.hir().body(anon_const.body).value, bindings);\n-        },\n-        TyKind::Ptr(MutTy { ty: mty, .. }) | TyKind::Rptr(_, MutTy { ty: mty, .. }) => check_ty(cx, mty, bindings),\n-        TyKind::Tup(tup) => {\n-            for t in tup {\n-                check_ty(cx, t, bindings);\n-            }\n-        },\n-        TyKind::Typeof(ref anon_const) => check_expr(cx, &cx.tcx.hir().body(anon_const.body).value, bindings),\n-        _ => (),\n-    }\n-}\n-\n-fn is_self_shadow(name: Symbol, expr: &Expr<'_>) -> bool {\n-    match expr.kind {\n-        ExprKind::Box(inner) | ExprKind::AddrOf(_, _, inner) => is_self_shadow(name, inner),\n-        ExprKind::Block(block, _) => {\n-            block.stmts.is_empty() && block.expr.as_ref().map_or(false, |e| is_self_shadow(name, e))\n-        },\n-        ExprKind::Unary(op, inner) => (UnOp::Deref == op) && is_self_shadow(name, inner),\n-        ExprKind::Path(QPath::Resolved(_, path)) => path_eq_name(name, path),\n-        _ => false,\n+/// Finds the \"init\" expression for a pattern: `let <pat> = <init>;` or\n+/// `match <init> { .., <pat> => .., .. }`\n+fn find_init<'tcx>(cx: &LateContext<'tcx>, hir_id: HirId) -> Option<&'tcx Expr<'tcx>> {\n+    for (_, node) in cx.tcx.hir().parent_iter(hir_id) {\n+        let init = match node {\n+            Node::Arm(_) | Node::Pat(_) => continue,\n+            Node::Expr(expr) => match expr.kind {\n+                ExprKind::Match(e, _, _) => Some(e),\n+                _ => None,\n+            },\n+            Node::Local(local) => local.init,\n+            _ => None,\n+        };\n+        return init;\n     }\n-}\n-\n-fn path_eq_name(name: Symbol, path: &Path<'_>) -> bool {\n-    !path.is_global() && path.segments.len() == 1 && path.segments[0].ident.name == name\n+    None\n }"}, {"sha": "231b5b80d18a43a161e442a9cf98585967776115", "filename": "clippy_utils/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/clippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Flib.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -510,7 +510,6 @@ pub fn path_to_local_id(expr: &Expr<'_>, id: HirId) -> bool {\n }\n \n /// Gets the definition associated to a path.\n-#[allow(clippy::shadow_unrelated)] // false positive #6563\n pub fn path_to_res(cx: &LateContext<'_>, path: &[&str]) -> Res {\n     macro_rules! try_res {\n         ($e:expr) => {"}, {"sha": "ccdbd34f7ec7bb587980db53285bded7fe1ddb32", "filename": "tests/ui/approx_const.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fapprox_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fapprox_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fapprox_const.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,5 +1,5 @@\n #[warn(clippy::approx_constant)]\n-#[allow(unused, clippy::shadow_unrelated, clippy::similar_names)]\n+#[allow(clippy::similar_names)]\n fn main() {\n     let my_e = 2.7182;\n     let almost_e = 2.718;"}, {"sha": "f373e905d05cad19c78608b6dd8008db6d4224e2", "filename": "tests/ui/for_loop_fixable.fixed", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_fixable.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_fixable.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop_fixable.fixed?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -23,12 +23,7 @@ impl Unrelated {\n     clippy::iter_next_loop,\n     clippy::for_kv_map\n )]\n-#[allow(\n-    clippy::linkedlist,\n-    clippy::shadow_unrelated,\n-    clippy::unnecessary_mut_passed,\n-    clippy::similar_names\n-)]\n+#[allow(clippy::linkedlist, clippy::unnecessary_mut_passed, clippy::similar_names)]\n #[allow(unused_variables)]\n fn main() {\n     let mut vec = vec![1, 2, 3, 4];"}, {"sha": "3814583bb6ef42d51f9732372d1fb11d2ded5ebb", "filename": "tests/ui/for_loop_fixable.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_fixable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_fixable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop_fixable.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -23,12 +23,7 @@ impl Unrelated {\n     clippy::iter_next_loop,\n     clippy::for_kv_map\n )]\n-#[allow(\n-    clippy::linkedlist,\n-    clippy::shadow_unrelated,\n-    clippy::unnecessary_mut_passed,\n-    clippy::similar_names\n-)]\n+#[allow(clippy::linkedlist, clippy::unnecessary_mut_passed, clippy::similar_names)]\n #[allow(unused_variables)]\n fn main() {\n     let mut vec = vec![1, 2, 3, 4];"}, {"sha": "009dbe1a0bfaf49f2a967696b471e5e4b541475e", "filename": "tests/ui/for_loop_fixable.stderr", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_fixable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_fixable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop_fixable.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,93 +1,93 @@\n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:43:15\n+  --> $DIR/for_loop_fixable.rs:38:15\n    |\n LL |     for _v in vec.iter() {}\n    |               ^^^^^^^^^^ help: to write this more concisely, try: `&vec`\n    |\n    = note: `-D clippy::explicit-iter-loop` implied by `-D warnings`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:45:15\n+  --> $DIR/for_loop_fixable.rs:40:15\n    |\n LL |     for _v in vec.iter_mut() {}\n    |               ^^^^^^^^^^^^^^ help: to write this more concisely, try: `&mut vec`\n \n error: it is more concise to loop over containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:48:15\n+  --> $DIR/for_loop_fixable.rs:43:15\n    |\n LL |     for _v in out_vec.into_iter() {}\n    |               ^^^^^^^^^^^^^^^^^^^ help: to write this more concisely, try: `out_vec`\n    |\n    = note: `-D clippy::explicit-into-iter-loop` implied by `-D warnings`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:53:15\n+  --> $DIR/for_loop_fixable.rs:48:15\n    |\n LL |     for _v in [1, 2, 3].iter() {}\n    |               ^^^^^^^^^^^^^^^^ help: to write this more concisely, try: `&[1, 2, 3]`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:57:15\n+  --> $DIR/for_loop_fixable.rs:52:15\n    |\n LL |     for _v in [0; 32].iter() {}\n    |               ^^^^^^^^^^^^^^ help: to write this more concisely, try: `&[0; 32]`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:62:15\n+  --> $DIR/for_loop_fixable.rs:57:15\n    |\n LL |     for _v in ll.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&ll`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:65:15\n+  --> $DIR/for_loop_fixable.rs:60:15\n    |\n LL |     for _v in vd.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&vd`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:68:15\n+  --> $DIR/for_loop_fixable.rs:63:15\n    |\n LL |     for _v in bh.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&bh`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:71:15\n+  --> $DIR/for_loop_fixable.rs:66:15\n    |\n LL |     for _v in hm.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&hm`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:74:15\n+  --> $DIR/for_loop_fixable.rs:69:15\n    |\n LL |     for _v in bt.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&bt`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:77:15\n+  --> $DIR/for_loop_fixable.rs:72:15\n    |\n LL |     for _v in hs.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&hs`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:80:15\n+  --> $DIR/for_loop_fixable.rs:75:15\n    |\n LL |     for _v in bs.iter() {}\n    |               ^^^^^^^^^ help: to write this more concisely, try: `&bs`\n \n error: it is more concise to loop over containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:255:18\n+  --> $DIR/for_loop_fixable.rs:250:18\n    |\n LL |         for i in iterator.into_iter() {\n    |                  ^^^^^^^^^^^^^^^^^^^^ help: to write this more concisely, try: `iterator`\n \n error: it is more concise to loop over references to containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:275:18\n+  --> $DIR/for_loop_fixable.rs:270:18\n    |\n LL |         for _ in t.into_iter() {}\n    |                  ^^^^^^^^^^^^^ help: to write this more concisely, try: `&t`\n \n error: it is more concise to loop over containers instead of using explicit iteration methods\n-  --> $DIR/for_loop_fixable.rs:277:18\n+  --> $DIR/for_loop_fixable.rs:272:18\n    |\n LL |         for _ in r.into_iter() {}\n    |                  ^^^^^^^^^^^^^ help: to write this more concisely, try: `r`"}, {"sha": "efcaffce24ea4d3fc3689d943bde12d444a7644c", "filename": "tests/ui/for_loop_unfixable.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_unfixable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_unfixable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop_unfixable.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -7,14 +7,7 @@\n     clippy::iter_next_loop,\n     clippy::for_kv_map\n )]\n-#[allow(\n-    clippy::linkedlist,\n-    clippy::shadow_unrelated,\n-    clippy::unnecessary_mut_passed,\n-    clippy::similar_names,\n-    unused,\n-    dead_code\n-)]\n+#[allow(clippy::linkedlist, clippy::unnecessary_mut_passed, clippy::similar_names)]\n fn main() {\n     let vec = vec![1, 2, 3, 4];\n "}, {"sha": "f769b4bdc941180c2a5587924192016138f2458a", "filename": "tests/ui/for_loop_unfixable.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_unfixable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Ffor_loop_unfixable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffor_loop_unfixable.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,5 +1,5 @@\n error: you are iterating over `Iterator::next()` which is an Option; this will compile but is probably not what you want\n-  --> $DIR/for_loop_unfixable.rs:21:15\n+  --> $DIR/for_loop_unfixable.rs:14:15\n    |\n LL |     for _v in vec.iter().next() {}\n    |               ^^^^^^^^^^^^^^^^^"}, {"sha": "67f24b4548aacacf20ffaea675236c314ff003de", "filename": "tests/ui/integer_arithmetic.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Finteger_arithmetic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Finteger_arithmetic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finteger_arithmetic.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,12 +1,5 @@\n #![warn(clippy::integer_arithmetic, clippy::float_arithmetic)]\n-#![allow(\n-    unused,\n-    clippy::shadow_reuse,\n-    clippy::shadow_unrelated,\n-    clippy::no_effect,\n-    clippy::unnecessary_operation,\n-    clippy::op_ref\n-)]\n+#![allow(clippy::no_effect, clippy::unnecessary_operation, clippy::op_ref)]\n \n #[rustfmt::skip]\n fn main() {"}, {"sha": "9a795b1f291547c9f8e3a06990a7901761d3ce7d", "filename": "tests/ui/integer_arithmetic.stderr", "status": "modified", "additions": 27, "deletions": 27, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Finteger_arithmetic.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Finteger_arithmetic.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finteger_arithmetic.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,166 +1,166 @@\n error: this operation will panic at runtime\n-  --> $DIR/integer_arithmetic.rs:37:5\n+  --> $DIR/integer_arithmetic.rs:30:5\n    |\n LL |     i /= 0;\n    |     ^^^^^^ attempt to divide `_` by zero\n    |\n    = note: `#[deny(unconditional_panic)]` on by default\n \n error: this operation will panic at runtime\n-  --> $DIR/integer_arithmetic.rs:42:5\n+  --> $DIR/integer_arithmetic.rs:35:5\n    |\n LL |     i %= 0;\n    |     ^^^^^^ attempt to calculate the remainder of `_` with a divisor of zero\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:16:5\n+  --> $DIR/integer_arithmetic.rs:9:5\n    |\n LL |     1 + i;\n    |     ^^^^^\n    |\n    = note: `-D clippy::integer-arithmetic` implied by `-D warnings`\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:17:5\n+  --> $DIR/integer_arithmetic.rs:10:5\n    |\n LL |     i * 2;\n    |     ^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:18:5\n+  --> $DIR/integer_arithmetic.rs:11:5\n    |\n LL | /     1 %\n LL | |     i / 2; // no error, this is part of the expression in the preceding line\n    | |_____^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:20:5\n+  --> $DIR/integer_arithmetic.rs:13:5\n    |\n LL |     i - 2 + 2 - i;\n    |     ^^^^^^^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:21:5\n+  --> $DIR/integer_arithmetic.rs:14:5\n    |\n LL |     -i;\n    |     ^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:22:5\n+  --> $DIR/integer_arithmetic.rs:15:5\n    |\n LL |     i >> 1;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:23:5\n+  --> $DIR/integer_arithmetic.rs:16:5\n    |\n LL |     i << 1;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:33:5\n+  --> $DIR/integer_arithmetic.rs:26:5\n    |\n LL |     i += 1;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:34:5\n+  --> $DIR/integer_arithmetic.rs:27:5\n    |\n LL |     i -= 1;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:35:5\n+  --> $DIR/integer_arithmetic.rs:28:5\n    |\n LL |     i *= 2;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:38:11\n+  --> $DIR/integer_arithmetic.rs:31:11\n    |\n LL |     i /= -1;\n    |           ^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:39:5\n+  --> $DIR/integer_arithmetic.rs:32:5\n    |\n LL |     i /= var1;\n    |     ^^^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:40:5\n+  --> $DIR/integer_arithmetic.rs:33:5\n    |\n LL |     i /= var2;\n    |     ^^^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:43:11\n+  --> $DIR/integer_arithmetic.rs:36:11\n    |\n LL |     i %= -1;\n    |           ^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:44:5\n+  --> $DIR/integer_arithmetic.rs:37:5\n    |\n LL |     i %= var1;\n    |     ^^^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:45:5\n+  --> $DIR/integer_arithmetic.rs:38:5\n    |\n LL |     i %= var2;\n    |     ^^^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:46:5\n+  --> $DIR/integer_arithmetic.rs:39:5\n    |\n LL |     i <<= 3;\n    |     ^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:47:5\n+  --> $DIR/integer_arithmetic.rs:40:5\n    |\n LL |     i >>= 2;\n    |     ^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:89:5\n+  --> $DIR/integer_arithmetic.rs:82:5\n    |\n LL |     3 + &1;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:90:5\n+  --> $DIR/integer_arithmetic.rs:83:5\n    |\n LL |     &3 + 1;\n    |     ^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:91:5\n+  --> $DIR/integer_arithmetic.rs:84:5\n    |\n LL |     &3 + &1;\n    |     ^^^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:96:5\n+  --> $DIR/integer_arithmetic.rs:89:5\n    |\n LL |     a + x\n    |     ^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:100:5\n+  --> $DIR/integer_arithmetic.rs:93:5\n    |\n LL |     x + y\n    |     ^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:104:5\n+  --> $DIR/integer_arithmetic.rs:97:5\n    |\n LL |     x + y\n    |     ^^^^^\n \n error: integer arithmetic detected\n-  --> $DIR/integer_arithmetic.rs:108:5\n+  --> $DIR/integer_arithmetic.rs:101:5\n    |\n LL |     (&x + &y)\n    |     ^^^^^^^^^"}, {"sha": "0860dcf8e0ddb610a1ec41cb65f0fd23b94752d7", "filename": "tests/ui/map_clone.fixed", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmap_clone.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmap_clone.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmap_clone.fixed?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,11 +1,11 @@\n // run-rustfix\n-#![warn(clippy::all, clippy::pedantic)]\n-#![allow(clippy::iter_cloned_collect)]\n-#![allow(clippy::clone_on_copy, clippy::redundant_clone)]\n-#![allow(clippy::let_underscore_drop)]\n-#![allow(clippy::missing_docs_in_private_items)]\n-#![allow(clippy::redundant_closure_for_method_calls)]\n-#![allow(clippy::many_single_char_names)]\n+#![warn(clippy::map_clone)]\n+#![allow(\n+    clippy::clone_on_copy,\n+    clippy::iter_cloned_collect,\n+    clippy::many_single_char_names,\n+    clippy::redundant_clone\n+)]\n \n fn main() {\n     let _: Vec<i8> = vec![5_i8; 6].iter().copied().collect();"}, {"sha": "b6987336834b84dec65af32aba776a0facbd0150", "filename": "tests/ui/map_clone.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmap_clone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmap_clone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmap_clone.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,11 +1,11 @@\n // run-rustfix\n-#![warn(clippy::all, clippy::pedantic)]\n-#![allow(clippy::iter_cloned_collect)]\n-#![allow(clippy::clone_on_copy, clippy::redundant_clone)]\n-#![allow(clippy::let_underscore_drop)]\n-#![allow(clippy::missing_docs_in_private_items)]\n-#![allow(clippy::redundant_closure_for_method_calls)]\n-#![allow(clippy::many_single_char_names)]\n+#![warn(clippy::map_clone)]\n+#![allow(\n+    clippy::clone_on_copy,\n+    clippy::iter_cloned_collect,\n+    clippy::many_single_char_names,\n+    clippy::redundant_clone\n+)]\n \n fn main() {\n     let _: Vec<i8> = vec![5_i8; 6].iter().map(|x| *x).collect();"}, {"sha": "b1861f07cd189f4454f5238364825d8f072fccae", "filename": "tests/ui/modulo_arithmetic_float.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_float.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_float.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_float.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,12 +1,5 @@\n #![warn(clippy::modulo_arithmetic)]\n-#![allow(\n-    unused,\n-    clippy::shadow_reuse,\n-    clippy::shadow_unrelated,\n-    clippy::no_effect,\n-    clippy::unnecessary_operation,\n-    clippy::modulo_one\n-)]\n+#![allow(clippy::no_effect, clippy::unnecessary_operation, clippy::modulo_one)]\n \n fn main() {\n     // Lint when both sides are const and of the opposite sign"}, {"sha": "97844aaaa7598d2587fae9e02cfdbf2dc56ed471", "filename": "tests/ui/modulo_arithmetic_float.stderr", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_float.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_float.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_float.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,5 +1,5 @@\n error: you are using modulo operator on constants with different signs: `-1.600 % 2.100`\n-  --> $DIR/modulo_arithmetic_float.rs:13:5\n+  --> $DIR/modulo_arithmetic_float.rs:6:5\n    |\n LL |     -1.6 % 2.1;\n    |     ^^^^^^^^^^\n@@ -8,71 +8,71 @@ LL |     -1.6 % 2.1;\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on constants with different signs: `1.600 % -2.100`\n-  --> $DIR/modulo_arithmetic_float.rs:14:5\n+  --> $DIR/modulo_arithmetic_float.rs:7:5\n    |\n LL |     1.6 % -2.1;\n    |     ^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on constants with different signs: `-1.200 % 3.400`\n-  --> $DIR/modulo_arithmetic_float.rs:15:5\n+  --> $DIR/modulo_arithmetic_float.rs:8:5\n    |\n LL |     (1.1 - 2.3) % (1.1 + 2.3);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on constants with different signs: `3.400 % -1.200`\n-  --> $DIR/modulo_arithmetic_float.rs:16:5\n+  --> $DIR/modulo_arithmetic_float.rs:9:5\n    |\n LL |     (1.1 + 2.3) % (1.1 - 2.3);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_float.rs:21:5\n+  --> $DIR/modulo_arithmetic_float.rs:14:5\n    |\n LL |     a_f32 % b_f32;\n    |     ^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_float.rs:22:5\n+  --> $DIR/modulo_arithmetic_float.rs:15:5\n    |\n LL |     b_f32 % a_f32;\n    |     ^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_float.rs:23:5\n+  --> $DIR/modulo_arithmetic_float.rs:16:5\n    |\n LL |     b_f32 %= a_f32;\n    |     ^^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_float.rs:27:5\n+  --> $DIR/modulo_arithmetic_float.rs:20:5\n    |\n LL |     a_f64 % b_f64;\n    |     ^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_float.rs:28:5\n+  --> $DIR/modulo_arithmetic_float.rs:21:5\n    |\n LL |     b_f64 % a_f64;\n    |     ^^^^^^^^^^^^^\n    |\n    = note: double check for expected result especially when interoperating with different languages\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_float.rs:29:5\n+  --> $DIR/modulo_arithmetic_float.rs:22:5\n    |\n LL |     b_f64 %= a_f64;\n    |     ^^^^^^^^^^^^^^"}, {"sha": "fc1acc39ebc776828508b1d2a6a69cfcb5573616", "filename": "tests/ui/modulo_arithmetic_integral.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_integral.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,12 +1,5 @@\n #![warn(clippy::modulo_arithmetic)]\n-#![allow(\n-    unused,\n-    clippy::shadow_reuse,\n-    clippy::shadow_unrelated,\n-    clippy::no_effect,\n-    clippy::unnecessary_operation,\n-    clippy::modulo_one\n-)]\n+#![allow(clippy::no_effect, clippy::unnecessary_operation, clippy::modulo_one)]\n \n fn main() {\n     // Lint on signed integral numbers"}, {"sha": "f71adf5b0d014f3f640e51bdc3d7e87595a34c5a", "filename": "tests/ui/modulo_arithmetic_integral.stderr", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_integral.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,5 +1,5 @@\n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:15:5\n+  --> $DIR/modulo_arithmetic_integral.rs:8:5\n    |\n LL |     a % b;\n    |     ^^^^^\n@@ -9,7 +9,7 @@ LL |     a % b;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:16:5\n+  --> $DIR/modulo_arithmetic_integral.rs:9:5\n    |\n LL |     b % a;\n    |     ^^^^^\n@@ -18,7 +18,7 @@ LL |     b % a;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:17:5\n+  --> $DIR/modulo_arithmetic_integral.rs:10:5\n    |\n LL |     b %= a;\n    |     ^^^^^^\n@@ -27,7 +27,7 @@ LL |     b %= a;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:21:5\n+  --> $DIR/modulo_arithmetic_integral.rs:14:5\n    |\n LL |     a_i8 % b_i8;\n    |     ^^^^^^^^^^^\n@@ -36,7 +36,7 @@ LL |     a_i8 % b_i8;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:22:5\n+  --> $DIR/modulo_arithmetic_integral.rs:15:5\n    |\n LL |     b_i8 %= a_i8;\n    |     ^^^^^^^^^^^^\n@@ -45,7 +45,7 @@ LL |     b_i8 %= a_i8;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:26:5\n+  --> $DIR/modulo_arithmetic_integral.rs:19:5\n    |\n LL |     a_i16 % b_i16;\n    |     ^^^^^^^^^^^^^\n@@ -54,7 +54,7 @@ LL |     a_i16 % b_i16;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:27:5\n+  --> $DIR/modulo_arithmetic_integral.rs:20:5\n    |\n LL |     b_i16 %= a_i16;\n    |     ^^^^^^^^^^^^^^\n@@ -63,7 +63,7 @@ LL |     b_i16 %= a_i16;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:31:5\n+  --> $DIR/modulo_arithmetic_integral.rs:24:5\n    |\n LL |     a_i32 % b_i32;\n    |     ^^^^^^^^^^^^^\n@@ -72,7 +72,7 @@ LL |     a_i32 % b_i32;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:32:5\n+  --> $DIR/modulo_arithmetic_integral.rs:25:5\n    |\n LL |     b_i32 %= a_i32;\n    |     ^^^^^^^^^^^^^^\n@@ -81,7 +81,7 @@ LL |     b_i32 %= a_i32;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:36:5\n+  --> $DIR/modulo_arithmetic_integral.rs:29:5\n    |\n LL |     a_i64 % b_i64;\n    |     ^^^^^^^^^^^^^\n@@ -90,7 +90,7 @@ LL |     a_i64 % b_i64;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:37:5\n+  --> $DIR/modulo_arithmetic_integral.rs:30:5\n    |\n LL |     b_i64 %= a_i64;\n    |     ^^^^^^^^^^^^^^\n@@ -99,7 +99,7 @@ LL |     b_i64 %= a_i64;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:41:5\n+  --> $DIR/modulo_arithmetic_integral.rs:34:5\n    |\n LL |     a_i128 % b_i128;\n    |     ^^^^^^^^^^^^^^^\n@@ -108,7 +108,7 @@ LL |     a_i128 % b_i128;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:42:5\n+  --> $DIR/modulo_arithmetic_integral.rs:35:5\n    |\n LL |     b_i128 %= a_i128;\n    |     ^^^^^^^^^^^^^^^^\n@@ -117,7 +117,7 @@ LL |     b_i128 %= a_i128;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:46:5\n+  --> $DIR/modulo_arithmetic_integral.rs:39:5\n    |\n LL |     a_isize % b_isize;\n    |     ^^^^^^^^^^^^^^^^^\n@@ -126,7 +126,7 @@ LL |     a_isize % b_isize;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:47:5\n+  --> $DIR/modulo_arithmetic_integral.rs:40:5\n    |\n LL |     b_isize %= a_isize;\n    |     ^^^^^^^^^^^^^^^^^^\n@@ -135,7 +135,7 @@ LL |     b_isize %= a_isize;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:51:5\n+  --> $DIR/modulo_arithmetic_integral.rs:44:5\n    |\n LL |     a % b;\n    |     ^^^^^\n@@ -144,7 +144,7 @@ LL |     a % b;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on types that might have different signs\n-  --> $DIR/modulo_arithmetic_integral.rs:52:5\n+  --> $DIR/modulo_arithmetic_integral.rs:45:5\n    |\n LL |     b %= a;\n    |     ^^^^^^"}, {"sha": "047a29fa1e327201d12847ff71452f51cea4ec9d", "filename": "tests/ui/modulo_arithmetic_integral_const.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_integral_const.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,12 +1,5 @@\n #![warn(clippy::modulo_arithmetic)]\n-#![allow(\n-    unused,\n-    clippy::shadow_reuse,\n-    clippy::shadow_unrelated,\n-    clippy::no_effect,\n-    clippy::unnecessary_operation,\n-    clippy::modulo_one\n-)]\n+#![allow(clippy::no_effect, clippy::unnecessary_operation, clippy::modulo_one)]\n \n fn main() {\n     // Lint when both sides are const and of the opposite sign"}, {"sha": "64335f35f0f82d997a2b4e1e14f52fa9af68df28", "filename": "tests/ui/modulo_arithmetic_integral_const.stderr", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral_const.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fmodulo_arithmetic_integral_const.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_integral_const.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,5 +1,5 @@\n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:13:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:6:5\n    |\n LL |     -1 % 2;\n    |     ^^^^^^\n@@ -9,7 +9,7 @@ LL |     -1 % 2;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:14:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:7:5\n    |\n LL |     1 % -2;\n    |     ^^^^^^\n@@ -18,7 +18,7 @@ LL |     1 % -2;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 3`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:15:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:8:5\n    |\n LL |     (1 - 2) % (1 + 2);\n    |     ^^^^^^^^^^^^^^^^^\n@@ -27,7 +27,7 @@ LL |     (1 - 2) % (1 + 2);\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `3 % -1`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:16:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:9:5\n    |\n LL |     (1 + 2) % (1 - 2);\n    |     ^^^^^^^^^^^^^^^^^\n@@ -36,7 +36,7 @@ LL |     (1 + 2) % (1 - 2);\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-35 % 300000`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:17:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:10:5\n    |\n LL |     35 * (7 - 4 * 2) % (-500 * -600);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -45,7 +45,7 @@ LL |     35 * (7 - 4 * 2) % (-500 * -600);\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:19:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:12:5\n    |\n LL |     -1i8 % 2i8;\n    |     ^^^^^^^^^^\n@@ -54,7 +54,7 @@ LL |     -1i8 % 2i8;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:20:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:13:5\n    |\n LL |     1i8 % -2i8;\n    |     ^^^^^^^^^^\n@@ -63,7 +63,7 @@ LL |     1i8 % -2i8;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:21:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:14:5\n    |\n LL |     -1i16 % 2i16;\n    |     ^^^^^^^^^^^^\n@@ -72,7 +72,7 @@ LL |     -1i16 % 2i16;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:22:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:15:5\n    |\n LL |     1i16 % -2i16;\n    |     ^^^^^^^^^^^^\n@@ -81,7 +81,7 @@ LL |     1i16 % -2i16;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:23:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:16:5\n    |\n LL |     -1i32 % 2i32;\n    |     ^^^^^^^^^^^^\n@@ -90,7 +90,7 @@ LL |     -1i32 % 2i32;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:24:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:17:5\n    |\n LL |     1i32 % -2i32;\n    |     ^^^^^^^^^^^^\n@@ -99,7 +99,7 @@ LL |     1i32 % -2i32;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:25:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:18:5\n    |\n LL |     -1i64 % 2i64;\n    |     ^^^^^^^^^^^^\n@@ -108,7 +108,7 @@ LL |     -1i64 % 2i64;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:26:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:19:5\n    |\n LL |     1i64 % -2i64;\n    |     ^^^^^^^^^^^^\n@@ -117,7 +117,7 @@ LL |     1i64 % -2i64;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:27:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:20:5\n    |\n LL |     -1i128 % 2i128;\n    |     ^^^^^^^^^^^^^^\n@@ -126,7 +126,7 @@ LL |     -1i128 % 2i128;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:28:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:21:5\n    |\n LL |     1i128 % -2i128;\n    |     ^^^^^^^^^^^^^^\n@@ -135,7 +135,7 @@ LL |     1i128 % -2i128;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:29:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:22:5\n    |\n LL |     -1isize % 2isize;\n    |     ^^^^^^^^^^^^^^^^\n@@ -144,7 +144,7 @@ LL |     -1isize % 2isize;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:30:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:23:5\n    |\n LL |     1isize % -2isize;\n    |     ^^^^^^^^^^^^^^^^"}, {"sha": "02e838456d0b574559f34404e79f22ffa158100e", "filename": "tests/ui/shadow.rs", "status": "modified", "additions": 68, "deletions": 45, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fshadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fshadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fshadow.rs?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,54 +1,77 @@\n-#![warn(\n-    clippy::all,\n-    clippy::pedantic,\n-    clippy::shadow_same,\n-    clippy::shadow_reuse,\n-    clippy::shadow_unrelated\n-)]\n-#![allow(\n-    unused_parens,\n-    unused_variables,\n-    clippy::manual_unwrap_or,\n-    clippy::missing_docs_in_private_items,\n-    clippy::single_match\n-)]\n-\n-fn id<T>(x: T) -> T {\n-    x\n+#![warn(clippy::shadow_same, clippy::shadow_reuse, clippy::shadow_unrelated)]\n+\n+fn shadow_same() {\n+    let x = 1;\n+    let x = x;\n+    let mut x = &x;\n+    let x = &mut x;\n+    let x = *x;\n }\n \n-#[must_use]\n-fn first(x: (isize, isize)) -> isize {\n-    x.0\n+fn shadow_reuse() -> Option<()> {\n+    let x = ([[0]], ());\n+    let x = x.0;\n+    let x = x[0];\n+    let [x] = x;\n+    let x = Some(x);\n+    let x = foo(x);\n+    let x = || x;\n+    let x = Some(1).map(|_| x)?;\n+    None\n }\n \n-fn main() {\n-    let mut x = 1;\n-    let x = &mut x;\n-    let x = { x };\n-    let x = (&*x);\n-    let x = { *x + 1 };\n-    let x = id(x);\n-    let x = (1, x);\n-    let x = first(x);\n-    let y = 1;\n-    let x = y;\n-\n-    let x;\n-    x = 42;\n-\n-    let o = Some(1_u8);\n-\n-    if let Some(p) = o {\n-        assert_eq!(1, p);\n+fn shadow_unrelated() {\n+    let x = 1;\n+    let x = 2;\n+}\n+\n+fn syntax() {\n+    fn f(x: u32) {\n+        let x = 1;\n+    }\n+    let x = 1;\n+    match Some(1) {\n+        Some(1) => {},\n+        Some(x) => {\n+            let x = 1;\n+        },\n+        _ => {},\n     }\n-    match o {\n-        Some(p) => p, // no error, because the p above is in its own scope\n-        None => 0,\n+    if let Some(x) = Some(1) {}\n+    while let Some(x) = Some(1) {}\n+    let _ = |[x]: [u32; 1]| {\n+        let x = 1;\n     };\n+}\n \n-    match (x, o) {\n-        (1, Some(a)) | (a, Some(1)) => (), // no error though `a` appears twice\n-        _ => (),\n+fn negative() {\n+    match Some(1) {\n+        Some(x) if x == 1 => {},\n+        Some(x) => {},\n+        None => {},\n     }\n+    match [None, Some(1)] {\n+        [Some(x), None] | [None, Some(x)] => {},\n+        _ => {},\n+    }\n+    if let Some(x) = Some(1) {\n+        let y = 1;\n+    } else {\n+        let x = 1;\n+        let y = 1;\n+    }\n+    let x = 1;\n+    #[allow(clippy::shadow_unrelated)]\n+    let x = 1;\n+}\n+\n+fn foo<T>(_: T) {}\n+\n+fn question_mark() -> Option<()> {\n+    let val = 1;\n+    // `?` expands with a `val` binding\n+    None?;\n+    None\n }\n+\n+fn main() {}"}, {"sha": "8b60e072c9342c9c763dc6b8de1740cef3f99dac", "filename": "tests/ui/shadow.stderr", "status": "modified", "additions": 165, "deletions": 70, "changes": 235, "blob_url": "https://github.com/rust-lang/rust/blob/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fshadow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f8303ada90e1a314cf37875f8285d3d174553c33/tests%2Fui%2Fshadow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fshadow.stderr?ref=f8303ada90e1a314cf37875f8285d3d174553c33", "patch": "@@ -1,138 +1,233 @@\n-error: `x` is shadowed by itself in `&mut x`\n-  --> $DIR/shadow.rs:27:5\n+error: `x` is shadowed by itself in `x`\n+  --> $DIR/shadow.rs:5:9\n    |\n-LL |     let x = &mut x;\n-   |     ^^^^^^^^^^^^^^^\n+LL |     let x = x;\n+   |         ^\n    |\n    = note: `-D clippy::shadow-same` implied by `-D warnings`\n note: previous binding is here\n-  --> $DIR/shadow.rs:26:13\n+  --> $DIR/shadow.rs:4:9\n    |\n-LL |     let mut x = 1;\n-   |             ^\n+LL |     let x = 1;\n+   |         ^\n \n-error: `x` is shadowed by itself in `{ x }`\n-  --> $DIR/shadow.rs:28:5\n+error: `mut x` is shadowed by itself in `&x`\n+  --> $DIR/shadow.rs:6:13\n    |\n-LL |     let x = { x };\n-   |     ^^^^^^^^^^^^^^\n+LL |     let mut x = &x;\n+   |             ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:27:9\n+  --> $DIR/shadow.rs:5:9\n+   |\n+LL |     let x = x;\n+   |         ^\n+\n+error: `x` is shadowed by itself in `&mut x`\n+  --> $DIR/shadow.rs:7:9\n    |\n LL |     let x = &mut x;\n    |         ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:6:9\n+   |\n+LL |     let mut x = &x;\n+   |         ^^^^^\n \n-error: `x` is shadowed by itself in `(&*x)`\n-  --> $DIR/shadow.rs:29:5\n+error: `x` is shadowed by itself in `*x`\n+  --> $DIR/shadow.rs:8:9\n    |\n-LL |     let x = (&*x);\n-   |     ^^^^^^^^^^^^^^\n+LL |     let x = *x;\n+   |         ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:28:9\n+  --> $DIR/shadow.rs:7:9\n    |\n-LL |     let x = { x };\n+LL |     let x = &mut x;\n    |         ^\n \n-error: `x` is shadowed by `{ *x + 1 }` which reuses the original value\n-  --> $DIR/shadow.rs:30:9\n+error: `x` is shadowed by `x.0` which reuses the original value\n+  --> $DIR/shadow.rs:13:9\n    |\n-LL |     let x = { *x + 1 };\n+LL |     let x = x.0;\n    |         ^\n    |\n    = note: `-D clippy::shadow-reuse` implied by `-D warnings`\n-note: initialization happens here\n-  --> $DIR/shadow.rs:30:13\n-   |\n-LL |     let x = { *x + 1 };\n-   |             ^^^^^^^^^^\n note: previous binding is here\n-  --> $DIR/shadow.rs:29:9\n+  --> $DIR/shadow.rs:12:9\n    |\n-LL |     let x = (&*x);\n+LL |     let x = ([[0]], ());\n    |         ^\n \n-error: `x` is shadowed by `id(x)` which reuses the original value\n-  --> $DIR/shadow.rs:31:9\n+error: `x` is shadowed by `x[0]` which reuses the original value\n+  --> $DIR/shadow.rs:14:9\n    |\n-LL |     let x = id(x);\n+LL |     let x = x[0];\n    |         ^\n    |\n-note: initialization happens here\n-  --> $DIR/shadow.rs:31:13\n+note: previous binding is here\n+  --> $DIR/shadow.rs:13:9\n+   |\n+LL |     let x = x.0;\n+   |         ^\n+\n+error: `x` is shadowed by `x` which reuses the original value\n+  --> $DIR/shadow.rs:15:10\n+   |\n+LL |     let [x] = x;\n+   |          ^\n    |\n-LL |     let x = id(x);\n-   |             ^^^^^\n note: previous binding is here\n-  --> $DIR/shadow.rs:30:9\n+  --> $DIR/shadow.rs:14:9\n    |\n-LL |     let x = { *x + 1 };\n+LL |     let x = x[0];\n    |         ^\n \n-error: `x` is shadowed by `(1, x)` which reuses the original value\n-  --> $DIR/shadow.rs:32:9\n+error: `x` is shadowed by `Some(x)` which reuses the original value\n+  --> $DIR/shadow.rs:16:9\n    |\n-LL |     let x = (1, x);\n+LL |     let x = Some(x);\n    |         ^\n    |\n-note: initialization happens here\n-  --> $DIR/shadow.rs:32:13\n+note: previous binding is here\n+  --> $DIR/shadow.rs:15:10\n+   |\n+LL |     let [x] = x;\n+   |          ^\n+\n+error: `x` is shadowed by `foo(x)` which reuses the original value\n+  --> $DIR/shadow.rs:17:9\n+   |\n+LL |     let x = foo(x);\n+   |         ^\n    |\n-LL |     let x = (1, x);\n-   |             ^^^^^^\n note: previous binding is here\n-  --> $DIR/shadow.rs:31:9\n+  --> $DIR/shadow.rs:16:9\n    |\n-LL |     let x = id(x);\n+LL |     let x = Some(x);\n    |         ^\n \n-error: `x` is shadowed by `first(x)` which reuses the original value\n-  --> $DIR/shadow.rs:33:9\n+error: `x` is shadowed by `|| x` which reuses the original value\n+  --> $DIR/shadow.rs:18:9\n    |\n-LL |     let x = first(x);\n+LL |     let x = || x;\n    |         ^\n    |\n-note: initialization happens here\n-  --> $DIR/shadow.rs:33:13\n+note: previous binding is here\n+  --> $DIR/shadow.rs:17:9\n+   |\n+LL |     let x = foo(x);\n+   |         ^\n+\n+error: `x` is shadowed by `Some(1).map(|_| x)?` which reuses the original value\n+  --> $DIR/shadow.rs:19:9\n+   |\n+LL |     let x = Some(1).map(|_| x)?;\n+   |         ^\n    |\n-LL |     let x = first(x);\n-   |             ^^^^^^^^\n note: previous binding is here\n-  --> $DIR/shadow.rs:32:9\n+  --> $DIR/shadow.rs:18:9\n    |\n-LL |     let x = (1, x);\n+LL |     let x = || x;\n    |         ^\n \n-error: `x` is being shadowed\n-  --> $DIR/shadow.rs:35:9\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:25:9\n    |\n-LL |     let x = y;\n+LL |     let x = 2;\n    |         ^\n    |\n    = note: `-D clippy::shadow-unrelated` implied by `-D warnings`\n-note: initialization happens here\n-  --> $DIR/shadow.rs:35:13\n+note: previous binding is here\n+  --> $DIR/shadow.rs:24:9\n    |\n-LL |     let x = y;\n+LL |     let x = 1;\n+   |         ^\n+\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:30:13\n+   |\n+LL |         let x = 1;\n    |             ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:29:10\n+   |\n+LL |     fn f(x: u32) {\n+   |          ^\n+\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:35:14\n+   |\n+LL |         Some(x) => {\n+   |              ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:32:9\n+   |\n+LL |     let x = 1;\n+   |         ^\n+\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:36:17\n+   |\n+LL |             let x = 1;\n+   |                 ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:35:14\n+   |\n+LL |         Some(x) => {\n+   |              ^\n+\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:40:17\n+   |\n+LL |     if let Some(x) = Some(1) {}\n+   |                 ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:32:9\n+   |\n+LL |     let x = 1;\n+   |         ^\n+\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:41:20\n+   |\n+LL |     while let Some(x) = Some(1) {}\n+   |                    ^\n+   |\n note: previous binding is here\n-  --> $DIR/shadow.rs:33:9\n+  --> $DIR/shadow.rs:32:9\n    |\n-LL |     let x = first(x);\n+LL |     let x = 1;\n    |         ^\n \n-error: `x` shadows a previous declaration\n-  --> $DIR/shadow.rs:37:5\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:42:15\n    |\n-LL |     let x;\n-   |     ^^^^^^\n+LL |     let _ = |[x]: [u32; 1]| {\n+   |               ^\n    |\n note: previous binding is here\n-  --> $DIR/shadow.rs:35:9\n+  --> $DIR/shadow.rs:32:9\n    |\n-LL |     let x = y;\n+LL |     let x = 1;\n    |         ^\n \n-error: aborting due to 9 previous errors\n+error: `x` shadows a previous, unrelated binding\n+  --> $DIR/shadow.rs:43:13\n+   |\n+LL |         let x = 1;\n+   |             ^\n+   |\n+note: previous binding is here\n+  --> $DIR/shadow.rs:42:15\n+   |\n+LL |     let _ = |[x]: [u32; 1]| {\n+   |               ^\n+\n+error: aborting due to 19 previous errors\n "}]}