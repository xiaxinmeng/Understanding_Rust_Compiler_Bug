{"sha": "beaa4c577963e4d1a401296b9e42067ff3890015", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlYWE0YzU3Nzk2M2U0ZDFhNDAxMjk2YjllNDIwNjdmZjM4OTAwMTU=", "commit": {"author": {"name": "Eduard-Mihai Burtescu", "email": "edy.burt@gmail.com", "date": "2016-10-19T05:00:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-10-19T05:00:02Z"}, "message": "Rollup merge of #37224 - petrochenkov:nz, r=eddyb\n\nMark enums with non-zero discriminant as non-zero\n\ncc https://github.com/rust-lang/rfcs/issues/1230\nr? @eddyb", "tree": {"sha": "f42f82ef5c988e0ca640c664c63b3cc697dcb318", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f42f82ef5c988e0ca640c664c63b3cc697dcb318"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/beaa4c577963e4d1a401296b9e42067ff3890015", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/beaa4c577963e4d1a401296b9e42067ff3890015", "html_url": "https://github.com/rust-lang/rust/commit/beaa4c577963e4d1a401296b9e42067ff3890015", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/beaa4c577963e4d1a401296b9e42067ff3890015/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "184ee985f846dfea0275412a794c17a455148307", "url": "https://api.github.com/repos/rust-lang/rust/commits/184ee985f846dfea0275412a794c17a455148307", "html_url": "https://github.com/rust-lang/rust/commit/184ee985f846dfea0275412a794c17a455148307"}, {"sha": "49e6b466e953e5cb56e29cf546204a004f26a985", "url": "https://api.github.com/repos/rust-lang/rust/commits/49e6b466e953e5cb56e29cf546204a004f26a985", "html_url": "https://github.com/rust-lang/rust/commit/49e6b466e953e5cb56e29cf546204a004f26a985"}], "stats": {"total": 71, "additions": 56, "deletions": 15}, "files": [{"sha": "5ce43d905ec717cd84ec4c2d83d27f405314f880", "filename": "src/librustc/ty/layout.rs", "status": "modified", "additions": 17, "deletions": 15, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/beaa4c577963e4d1a401296b9e42067ff3890015/src%2Flibrustc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beaa4c577963e4d1a401296b9e42067ff3890015/src%2Flibrustc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Flayout.rs?ref=beaa4c577963e4d1a401296b9e42067ff3890015", "patch": "@@ -597,7 +597,8 @@ impl<'a, 'gcx, 'tcx> Struct {\n                                   -> Result<Option<FieldPath>, LayoutError<'gcx>> {\n         let tcx = infcx.tcx.global_tcx();\n         match (ty.layout(infcx)?, &ty.sty) {\n-            (&Scalar { non_zero: true, .. }, _) => Ok(Some(vec![])),\n+            (&Scalar { non_zero: true, .. }, _) |\n+            (&CEnum { non_zero: true, .. }, _) => Ok(Some(vec![])),\n             (&FatPointer { non_zero: true, .. }, _) => {\n                 Ok(Some(vec![FAT_PTR_ADDR as u32]))\n             }\n@@ -769,6 +770,7 @@ pub enum Layout {\n     CEnum {\n         discr: Integer,\n         signed: bool,\n+        non_zero: bool,\n         // Inclusive discriminant range.\n         // If min > max, it represents min...u64::MAX followed by 0...max.\n         // FIXME(eddyb) always use the shortest range, e.g. by finding\n@@ -1002,9 +1004,10 @@ impl<'a, 'gcx, 'tcx> Layout {\n \n                 if def.is_enum() && def.variants.iter().all(|v| v.fields.is_empty()) {\n                     // All bodies empty -> intlike\n-                    let (mut min, mut max) = (i64::MAX, i64::MIN);\n+                    let (mut min, mut max, mut non_zero) = (i64::MAX, i64::MIN, true);\n                     for v in &def.variants {\n                         let x = v.disr_val.to_u64_unchecked() as i64;\n+                        if x == 0 { non_zero = false; }\n                         if x < min { min = x; }\n                         if x > max { max = x; }\n                     }\n@@ -1013,6 +1016,7 @@ impl<'a, 'gcx, 'tcx> Layout {\n                     return success(CEnum {\n                         discr: discr,\n                         signed: signed,\n+                        non_zero: non_zero,\n                         min: min as u64,\n                         max: max as u64\n                     });\n@@ -1069,19 +1073,17 @@ impl<'a, 'gcx, 'tcx> Layout {\n \n                         // FIXME(eddyb) should take advantage of a newtype.\n                         if path == &[0] && variants[discr].len() == 1 {\n-                            match *variants[discr][0].layout(infcx)? {\n-                                Scalar { value, .. } => {\n-                                    return success(RawNullablePointer {\n-                                        nndiscr: discr as u64,\n-                                        value: value\n-                                    });\n-                                }\n-                                _ => {\n-                                    bug!(\"Layout::compute: `{}`'s non-zero \\\n-                                        `{}` field not scalar?!\",\n-                                        ty, variants[discr][0])\n-                                }\n-                            }\n+                            let value = match *variants[discr][0].layout(infcx)? {\n+                                Scalar { value, .. } => value,\n+                                CEnum { discr, .. } => Int(discr),\n+                                _ => bug!(\"Layout::compute: `{}`'s non-zero \\\n+                                           `{}` field not scalar?!\",\n+                                           ty, variants[discr][0])\n+                            };\n+                            return success(RawNullablePointer {\n+                                nndiscr: discr as u64,\n+                                value: value,\n+                            });\n                         }\n \n                         path.push(0); // For GEP through a pointer."}, {"sha": "266506e04b74d0360a8fa33947b8b97d0135d875", "filename": "src/test/run-pass/nonzero-enum.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/beaa4c577963e4d1a401296b9e42067ff3890015/src%2Ftest%2Frun-pass%2Fnonzero-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beaa4c577963e4d1a401296b9e42067ff3890015/src%2Ftest%2Frun-pass%2Fnonzero-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fnonzero-enum.rs?ref=beaa4c577963e4d1a401296b9e42067ff3890015", "patch": "@@ -0,0 +1,39 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::mem::size_of;\n+\n+enum E {\n+    A = 1,\n+    B = 2,\n+    C = 3,\n+}\n+\n+struct S {\n+    a: u16,\n+    b: u8,\n+    e: E,\n+}\n+\n+fn main() {\n+    assert_eq!(size_of::<E>(), 1);\n+    assert_eq!(size_of::<Option<E>>(), 1);\n+    assert_eq!(size_of::<Result<E, ()>>(), 1);\n+    assert_eq!(size_of::<S>(), 4);\n+    assert_eq!(size_of::<Option<S>>(), 4);\n+    let enone = None::<E>;\n+    let esome = Some(E::A);\n+    if let Some(..) = enone {\n+        panic!();\n+    }\n+    if let None = esome {\n+        panic!();\n+    }\n+}"}]}