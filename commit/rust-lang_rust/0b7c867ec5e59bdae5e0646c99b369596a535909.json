{"sha": "0b7c867ec5e59bdae5e0646c99b369596a535909", "node_id": "C_kwDOAAsO6NoAKDBiN2M4NjdlYzVlNTliZGFlNWUwNjQ2Yzk5YjM2OTU5NmE1MzU5MDk", "commit": {"author": {"name": "Chris Denton", "email": "chris@chrisdenton.dev", "date": "2023-02-18T14:47:01Z"}, "committer": {"name": "Chris Denton", "email": "chris@chrisdenton.dev", "date": "2023-02-22T04:27:35Z"}, "message": "Quote more batch file arguments\n\nMake sure to quote batch file arguments that contain command prompt special characters.\n\nAdditionally add `/d` command line parameter to disable any commands that may change the way variable expansion works.", "tree": {"sha": "9c000b0ec28f5e3bc3650afe86a93508f23542a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9c000b0ec28f5e3bc3650afe86a93508f23542a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b7c867ec5e59bdae5e0646c99b369596a535909", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE+p/jD6jrzmnSIWJLcTRy8vRWJ94FAmP1mbgACgkQcTRy8vRW\nJ95cfw//fG+1cVA4Kh+aVjT4uVQq8kKX4txQTS9NCBXBBw2TOYEXM2NY9sFGVlmP\n4HX1kIvlIdKOWb84YtOeaovZ3GdsOGLupC1sMSHQatt9aDa7dlGReIYjObiDiGdb\nGk3WcWAK9Pzo7IhABb24m17MDQitvwdBaGFCiLGHLByR0UnnRceenp3slchX0ZpE\n9m/NXH+s0b8w3dWV4MwABTvqnF8Deh05G8I+ZDmCWtQuYdCOkthC4JD7/BfHriWS\nvLRPtX6c3lipP8XK5kfDPpv0JCo/YH1XzGwKCPeB29mwsjPpJ6sDvnAVcaNLjiRF\nFOkMZTrzpOw5Yh+JOf8BjPv1vHmglBO/kDQhUum3BHHg1gzanFroTtOXzQHqqViN\nBYuz57pnTztUtAg2o8Y9Et8qYqP9bHYl3V8LjIjZE6NAgomoOe7Dz9McEqvLPx2e\nloU3S7RC1bQJWfvnycniy1PWKgFb5zLUonAGgVsK+FPq2bmGN/kKTehw+jBZpriZ\nmSJwqbDjlYPDVGExfpLkhoaGc7wh1ckTdtyynOqlJ9l3eJA9clrBnICYZubAOMpB\nL632geeaREuLZsOI5vAVRZHOVqbdwXoTWGHSI7ob6ZXB0hyWxyUlDyaJsaUX4+H7\nBQVXsojjMGvL/xVrNFI7+/X2gG5Hbuxr6VivW5kYht8wER1lqzs=\n=xGqa\n-----END PGP SIGNATURE-----", "payload": "tree 9c000b0ec28f5e3bc3650afe86a93508f23542a8\nparent f722b24eb9ea35a7cc187a1cb5c50d4d324f5855\nauthor Chris Denton <chris@chrisdenton.dev> 1676731621 +0000\ncommitter Chris Denton <chris@chrisdenton.dev> 1677040055 +0000\n\nQuote more batch file arguments\n\nMake sure to quote batch file arguments that contain command prompt special characters.\n\nAdditionally add `/d` command line parameter to disable any commands that may change the way variable expansion works.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b7c867ec5e59bdae5e0646c99b369596a535909", "html_url": "https://github.com/rust-lang/rust/commit/0b7c867ec5e59bdae5e0646c99b369596a535909", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b7c867ec5e59bdae5e0646c99b369596a535909/comments", "author": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f722b24eb9ea35a7cc187a1cb5c50d4d324f5855", "url": "https://api.github.com/repos/rust-lang/rust/commits/f722b24eb9ea35a7cc187a1cb5c50d4d324f5855", "html_url": "https://github.com/rust-lang/rust/commit/f722b24eb9ea35a7cc187a1cb5c50d4d324f5855"}], "stats": {"total": 11, "additions": 10, "deletions": 1}, "files": [{"sha": "30356fa851985da1536584c6866d0dc2ee02f1ff", "filename": "library/std/src/sys/windows/args.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0b7c867ec5e59bdae5e0646c99b369596a535909/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b7c867ec5e59bdae5e0646c99b369596a535909/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs?ref=0b7c867ec5e59bdae5e0646c99b369596a535909", "patch": "@@ -270,7 +270,7 @@ pub(crate) fn make_bat_command_line(\n     // It is necessary to surround the command in an extra pair of quotes,\n     // hence the trailing quote here. It will be closed after all arguments\n     // have been added.\n-    let mut cmd: Vec<u16> = \"cmd.exe /c \\\"\".encode_utf16().collect();\n+    let mut cmd: Vec<u16> = \"cmd.exe /d /c \\\"\".encode_utf16().collect();\n \n     // Push the script name surrounded by its quote pair.\n     cmd.push(b'\"' as u16);\n@@ -290,6 +290,15 @@ pub(crate) fn make_bat_command_line(\n     // reconstructed by the batch script by default.\n     for arg in args {\n         cmd.push(' ' as u16);\n+        // Make sure to always quote special command prompt characters, including:\n+        // * Characters `cmd /?` says require quotes.\n+        // * `%` for environment variables, as in `%TMP%`.\n+        // * `|<>` pipe/redirect characters.\n+        const SPECIAL: &[u8] = b\"\\t &()[]{}^=;!'+,`~%|<>\";\n+        let force_quotes = match arg {\n+            Arg::Regular(arg) if !force_quotes => arg.bytes().iter().any(|c| SPECIAL.contains(c)),\n+            _ => force_quotes,\n+        };\n         append_arg(&mut cmd, arg, force_quotes)?;\n     }\n "}]}