{"sha": "34e2bc6a541cca670307cec94cfc5546016705d6", "node_id": "C_kwDOAAsO6NoAKDM0ZTJiYzZhNTQxY2NhNjcwMzA3Y2VjOTRjZmM1NTQ2MDE2NzA1ZDY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-26T17:55:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-26T17:55:00Z"}, "message": "Auto merge of #13611 - yue4u:fix/completion-after-colon, r=yue4u\n\nfix: filter unnecessary completions after colon\n\nclose #13597\nrelated: #10173\n\nThis PR also happens to fix two extra issues:\n\n1. The test case in https://github.com/rust-lang/rust-analyzer/blob/master/crates/ide-completion/src/tests/attribute.rs#L778-L801 was never triggered in previous behavior.\n\nafter:\n\nhttps://user-images.githubusercontent.com/26110087/201476995-56adf955-0fa7-4f75-ab32-28a8e6cb9504.mp4\n\n<del>\n2. completions were triggered even in invalid paths, like\n\n```rust\nfn main() {\n    core:::::$0\n}\n```\n\n```rust\n#[:::::$0]\nstruct X;\n```\n\n</del>\n\nonly `:::` is excluded as discussed in https://github.com/rust-lang/rust-analyzer/pull/13611#discussion_r1031845205", "tree": {"sha": "83d4abfb49a1cb1b93a1934fb330a7d4d7baac5a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83d4abfb49a1cb1b93a1934fb330a7d4d7baac5a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/34e2bc6a541cca670307cec94cfc5546016705d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/34e2bc6a541cca670307cec94cfc5546016705d6", "html_url": "https://github.com/rust-lang/rust/commit/34e2bc6a541cca670307cec94cfc5546016705d6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/34e2bc6a541cca670307cec94cfc5546016705d6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d2281f0367ba85c34ee9bce07d3cca40e1424721", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2281f0367ba85c34ee9bce07d3cca40e1424721", "html_url": "https://github.com/rust-lang/rust/commit/d2281f0367ba85c34ee9bce07d3cca40e1424721"}, {"sha": "1ca5cb7ed9928fad4222cb26727da41ff9ac148f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ca5cb7ed9928fad4222cb26727da41ff9ac148f", "html_url": "https://github.com/rust-lang/rust/commit/1ca5cb7ed9928fad4222cb26727da41ff9ac148f"}], "stats": {"total": 157, "additions": 141, "deletions": 16}, "files": [{"sha": "aa77f449530e5d413dc448bf3a90b82dc158780d", "filename": "crates/ide-completion/src/context.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext.rs?ref=34e2bc6a541cca670307cec94cfc5546016705d6", "patch": "@@ -19,7 +19,7 @@ use syntax::{\n     ast::{self, AttrKind, NameOrNameRef},\n     AstNode,\n     SyntaxKind::{self, *},\n-    SyntaxToken, TextRange, TextSize,\n+    SyntaxToken, TextRange, TextSize, T,\n };\n use text_edit::Indel;\n \n@@ -569,6 +569,32 @@ impl<'a> CompletionContext<'a> {\n         // completing on\n         let original_token = original_file.syntax().token_at_offset(offset).left_biased()?;\n \n+        // try to skip completions on path with invalid colons\n+        // this approach works in normal path and inside token tree\n+        match original_token.kind() {\n+            T![:] => {\n+                // return if no prev token before colon\n+                let prev_token = original_token.prev_token()?;\n+\n+                // only has a single colon\n+                if prev_token.kind() != T![:] {\n+                    return None;\n+                }\n+\n+                // has 3 colon or 2 coloncolon in a row\n+                // special casing this as per discussion in https://github.com/rust-lang/rust-analyzer/pull/13611#discussion_r1031845205\n+                // and https://github.com/rust-lang/rust-analyzer/pull/13611#discussion_r1032812751\n+                if prev_token\n+                    .prev_token()\n+                    .map(|t| t.kind() == T![:] || t.kind() == T![::])\n+                    .unwrap_or(false)\n+                {\n+                    return None;\n+                }\n+            }\n+            _ => {}\n+        }\n+\n         let AnalysisResult {\n             analysis,\n             expected: (expected_type, expected_name),"}, {"sha": "4b48ec6bc33930f5b68493311a8dd6defea63413", "filename": "crates/ide-completion/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Flib.rs?ref=34e2bc6a541cca670307cec94cfc5546016705d6", "patch": "@@ -164,7 +164,6 @@ pub fn completions(\n                 completions::vis::complete_vis_path(&mut completions, ctx, path_ctx, has_in_token);\n             }\n         }\n-        // prevent `(` from triggering unwanted completion noise\n         return Some(completions.into());\n     }\n "}, {"sha": "4e60820dd6d60c6a936b93027ddab6d0c7d14131", "filename": "crates/ide-completion/src/tests/attribute.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Ftests%2Fattribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Ftests%2Fattribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fattribute.rs?ref=34e2bc6a541cca670307cec94cfc5546016705d6", "patch": "@@ -607,6 +607,30 @@ fn attr_in_source_file_end() {\n     );\n }\n \n+#[test]\n+fn invalid_path() {\n+    check(\n+        r#\"\n+//- proc_macros: identity\n+#[proc_macros:::$0]\n+struct Foo;\n+\"#,\n+        expect![[r#\"\"#]],\n+    );\n+\n+    check(\n+        r#\"\n+//- minicore: derive, copy\n+mod foo {\n+    pub use Copy as Bar;\n+}\n+#[derive(foo:::::$0)]\n+struct Foo;\n+\"#,\n+        expect![\"\"],\n+    );\n+}\n+\n mod cfg {\n     use super::*;\n "}, {"sha": "cad4af4937de5b69b2610cb46a9ca8af3dbdc942", "filename": "crates/ide-completion/src/tests/special.rs", "status": "modified", "additions": 89, "deletions": 1, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Ftests%2Fspecial.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Fide-completion%2Fsrc%2Ftests%2Fspecial.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fspecial.rs?ref=34e2bc6a541cca670307cec94cfc5546016705d6", "patch": "@@ -2,13 +2,22 @@\n \n use expect_test::{expect, Expect};\n \n-use crate::tests::{check_edit, completion_list_no_kw};\n+use crate::tests::{check_edit, completion_list_no_kw, completion_list_with_trigger_character};\n \n fn check(ra_fixture: &str, expect: Expect) {\n     let actual = completion_list_no_kw(ra_fixture);\n     expect.assert_eq(&actual)\n }\n \n+pub(crate) fn check_with_trigger_character(\n+    ra_fixture: &str,\n+    trigger_character: Option<char>,\n+    expect: Expect,\n+) {\n+    let actual = completion_list_with_trigger_character(ra_fixture, trigger_character);\n+    expect.assert_eq(&actual)\n+}\n+\n #[test]\n fn completes_if_prefix_is_keyword() {\n     check_edit(\n@@ -893,3 +902,82 @@ fn f() {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn completes_after_colon_with_trigger() {\n+    check_with_trigger_character(\n+        r#\"\n+//- minicore: option\n+fn foo { ::$0 }\n+\"#,\n+        Some(':'),\n+        expect![[r#\"\n+            md core\n+        \"#]],\n+    );\n+    check_with_trigger_character(\n+        r#\"\n+//- minicore: option\n+fn foo { /* test */::$0 }\n+\"#,\n+        Some(':'),\n+        expect![[r#\"\n+            md core\n+        \"#]],\n+    );\n+\n+    check_with_trigger_character(\n+        r#\"\n+fn foo { crate::$0 }\n+\"#,\n+        Some(':'),\n+        expect![[r#\"\n+            fn foo() fn()\n+        \"#]],\n+    );\n+\n+    check_with_trigger_character(\n+        r#\"\n+fn foo { crate:$0 }\n+\"#,\n+        Some(':'),\n+        expect![\"\"],\n+    );\n+}\n+\n+#[test]\n+fn completes_after_colon_without_trigger() {\n+    check_with_trigger_character(\n+        r#\"\n+fn foo { crate::$0 }\n+\"#,\n+        None,\n+        expect![[r#\"\n+            fn foo() fn()\n+        \"#]],\n+    );\n+\n+    check_with_trigger_character(\n+        r#\"\n+fn foo { crate:$0 }\n+\"#,\n+        None,\n+        expect![\"\"],\n+    );\n+}\n+\n+#[test]\n+fn no_completions_in_invalid_path() {\n+    check(\n+        r#\"\n+fn foo { crate:::$0 }\n+\"#,\n+        expect![\"\"],\n+    );\n+    check(\n+        r#\"\n+fn foo { crate::::$0 }\n+\"#,\n+        expect![\"\"],\n+    )\n+}"}, {"sha": "4f318f39de5f476ced36ec7df9548ce375b1b6d0", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34e2bc6a541cca670307cec94cfc5546016705d6/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=34e2bc6a541cca670307cec94cfc5546016705d6", "patch": "@@ -28,7 +28,7 @@ use lsp_types::{\n use project_model::{ManifestPath, ProjectWorkspace, TargetKind};\n use serde_json::json;\n use stdx::{format_to, never};\n-use syntax::{algo, ast, AstNode, TextRange, TextSize, T};\n+use syntax::{algo, ast, AstNode, TextRange, TextSize};\n use vfs::AbsPathBuf;\n \n use crate::{\n@@ -812,18 +812,6 @@ pub(crate) fn handle_completion(\n     let completion_trigger_character =\n         params.context.and_then(|ctx| ctx.trigger_character).and_then(|s| s.chars().next());\n \n-    if Some(':') == completion_trigger_character {\n-        let source_file = snap.analysis.parse(position.file_id)?;\n-        let left_token = source_file.syntax().token_at_offset(position.offset).left_biased();\n-        let completion_triggered_after_single_colon = match left_token {\n-            Some(left_token) => left_token.kind() == T![:],\n-            None => true,\n-        };\n-        if completion_triggered_after_single_colon {\n-            return Ok(None);\n-        }\n-    }\n-\n     let completion_config = &snap.config.completion();\n     let items = match snap.analysis.completions(\n         completion_config,"}]}