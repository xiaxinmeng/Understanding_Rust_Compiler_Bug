{"sha": "eb6d4cdac0dd2151a910109161588ffa52556dbb", "node_id": "C_kwDOAAsO6NoAKGViNmQ0Y2RhYzBkZDIxNTFhOTEwMTA5MTYxNTg4ZmZhNTI1NTZkYmI", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-05-31T12:42:22Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-05-31T12:43:17Z"}, "message": "reduce some code duplication", "tree": {"sha": "1a63187cfe6cead80df8fd5a499102c298238c9e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a63187cfe6cead80df8fd5a499102c298238c9e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eb6d4cdac0dd2151a910109161588ffa52556dbb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eb6d4cdac0dd2151a910109161588ffa52556dbb", "html_url": "https://github.com/rust-lang/rust/commit/eb6d4cdac0dd2151a910109161588ffa52556dbb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eb6d4cdac0dd2151a910109161588ffa52556dbb/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "360186b11437b924f89064d77246e4f1eb435eb0", "url": "https://api.github.com/repos/rust-lang/rust/commits/360186b11437b924f89064d77246e4f1eb435eb0", "html_url": "https://github.com/rust-lang/rust/commit/360186b11437b924f89064d77246e4f1eb435eb0"}], "stats": {"total": 59, "additions": 29, "deletions": 30}, "files": [{"sha": "e2e63f8a52a297788956b344fb494344b8d81240", "filename": "src/stacked_borrows.rs", "status": "modified", "additions": 29, "deletions": 30, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/eb6d4cdac0dd2151a910109161588ffa52556dbb/src%2Fstacked_borrows.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb6d4cdac0dd2151a910109161588ffa52556dbb/src%2Fstacked_borrows.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstacked_borrows.rs?ref=eb6d4cdac0dd2151a910109161588ffa52556dbb", "patch": "@@ -705,6 +705,30 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         protect: bool,\n     ) -> InterpResult<'tcx> {\n         let this = self.eval_context_mut();\n+        let current_span = &mut this.machine.current_span();\n+\n+        let log_creation = |this: &MiriEvalContext<'mir, 'tcx>,\n+                            current_span: &mut CurrentSpan<'_, '_, '_>,\n+                            alloc_id,\n+                            base_offset,\n+                            orig_tag|\n+         -> InterpResult<'tcx> {\n+            let extra = this.get_alloc_extra(alloc_id)?;\n+            let stacked_borrows =\n+                extra.stacked_borrows.as_ref().expect(\"we should have Stacked Borrows data\");\n+            let mut alloc_history = stacked_borrows.history.borrow_mut();\n+            alloc_history.log_creation(\n+                Some(orig_tag),\n+                new_tag,\n+                alloc_range(base_offset, size),\n+                current_span,\n+            );\n+            if protect {\n+                alloc_history.log_protector(orig_tag, new_tag, current_span);\n+            }\n+            Ok(())\n+        };\n+\n         if size == Size::ZERO {\n             // Don't update any stacks for a zero-sized access; borrow stacks are per-byte and this\n             // touches no bytes so there is no stack to put this tag in.\n@@ -714,16 +738,7 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             // Dangling slices are a common case here; it's valid to get their length but with raw\n             // pointer tagging for example all calls to get_unchecked on them are invalid.\n             if let Ok((alloc_id, base_offset, orig_tag)) = this.ptr_try_get_alloc_id(place.ptr) {\n-                let extra = this.get_alloc_extra(alloc_id)?;\n-                let stacked_borrows =\n-                    extra.stacked_borrows.as_ref().expect(\"we should have Stacked Borrows data\");\n-                let mut alloc_history = stacked_borrows.history.borrow_mut();\n-                alloc_history.log_creation(\n-                    Some(orig_tag),\n-                    new_tag,\n-                    alloc_range(base_offset, Size::ZERO),\n-                    &mut this.machine.current_span(),\n-                );\n+                log_creation(this, current_span, alloc_id, base_offset, orig_tag)?;\n             }\n \n             trace!(\n@@ -736,23 +751,7 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             return Ok(());\n         }\n         let (alloc_id, base_offset, orig_tag) = this.ptr_get_alloc_id(place.ptr)?;\n-\n-        let mut current_span = this.machine.current_span();\n-        {\n-            let extra = this.get_alloc_extra(alloc_id)?;\n-            let stacked_borrows =\n-                extra.stacked_borrows.as_ref().expect(\"we should have Stacked Borrows data\");\n-            let mut alloc_history = stacked_borrows.history.borrow_mut();\n-            alloc_history.log_creation(\n-                Some(orig_tag),\n-                new_tag,\n-                alloc_range(base_offset, size),\n-                &mut current_span,\n-            );\n-            if protect {\n-                alloc_history.log_protector(orig_tag, new_tag, &mut current_span);\n-            }\n-        }\n+        log_creation(this, current_span, alloc_id, base_offset, orig_tag)?;\n \n         // Ensure we bail out if the pointer goes out-of-bounds (see miri#1050).\n         let (alloc_size, _) =\n@@ -819,7 +818,7 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                             item,\n                             (alloc_id, range, offset),\n                             &mut *global,\n-                            &mut current_span,\n+                            current_span,\n                             history,\n                         )\n                     })\n@@ -836,14 +835,14 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         let item = Item { perm, tag: new_tag, protector };\n         let range = alloc_range(base_offset, size);\n         let mut global = machine.stacked_borrows.as_ref().unwrap().borrow_mut();\n-        let mut current_span = machine.current_span();\n+        let current_span = &mut machine.current_span(); // `get_alloc_extra_mut` invalidated our old `current_span`\n         stacked_borrows.for_each_mut(range, |offset, stack, history| {\n             stack.grant(\n                 orig_tag,\n                 item,\n                 (alloc_id, range, offset),\n                 &mut global,\n-                &mut current_span,\n+                current_span,\n                 history,\n             )\n         })?;"}]}