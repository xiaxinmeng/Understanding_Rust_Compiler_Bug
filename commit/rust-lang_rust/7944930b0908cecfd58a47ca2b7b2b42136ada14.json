{"sha": "7944930b0908cecfd58a47ca2b7b2b42136ada14", "node_id": "C_kwDOAAsO6NoAKDc5NDQ5MzBiMDkwOGNlY2ZkNThhNDdjYTJiN2IyYjQyMTM2YWRhMTQ", "commit": {"author": {"name": "James Farrell", "email": "jamesfarrell@google.com", "date": "2023-04-06T18:53:29Z"}, "committer": {"name": "James Farrell", "email": "jamesfarrell@google.com", "date": "2023-04-06T18:53:29Z"}, "message": "Pass host linker to compiletest.\n\nTests marked `// force-host` were using the default linker, even if a\ncustom linker was configured in config.toml.\n\nThis change adds a new flag, --host-linker, to compiletest, and renames\n--linker to --target-linker.", "tree": {"sha": "0fba9c9f648433c12be81eed341c177afdc54e2c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0fba9c9f648433c12be81eed341c177afdc54e2c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7944930b0908cecfd58a47ca2b7b2b42136ada14", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7944930b0908cecfd58a47ca2b7b2b42136ada14", "html_url": "https://github.com/rust-lang/rust/commit/7944930b0908cecfd58a47ca2b7b2b42136ada14", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7944930b0908cecfd58a47ca2b7b2b42136ada14/comments", "author": {"login": "jfgoog", "id": 83229348, "node_id": "MDQ6VXNlcjgzMjI5MzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/83229348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jfgoog", "html_url": "https://github.com/jfgoog", "followers_url": "https://api.github.com/users/jfgoog/followers", "following_url": "https://api.github.com/users/jfgoog/following{/other_user}", "gists_url": "https://api.github.com/users/jfgoog/gists{/gist_id}", "starred_url": "https://api.github.com/users/jfgoog/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jfgoog/subscriptions", "organizations_url": "https://api.github.com/users/jfgoog/orgs", "repos_url": "https://api.github.com/users/jfgoog/repos", "events_url": "https://api.github.com/users/jfgoog/events{/privacy}", "received_events_url": "https://api.github.com/users/jfgoog/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jfgoog", "id": 83229348, "node_id": "MDQ6VXNlcjgzMjI5MzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/83229348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jfgoog", "html_url": "https://github.com/jfgoog", "followers_url": "https://api.github.com/users/jfgoog/followers", "following_url": "https://api.github.com/users/jfgoog/following{/other_user}", "gists_url": "https://api.github.com/users/jfgoog/gists{/gist_id}", "starred_url": "https://api.github.com/users/jfgoog/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jfgoog/subscriptions", "organizations_url": "https://api.github.com/users/jfgoog/orgs", "repos_url": "https://api.github.com/users/jfgoog/repos", "events_url": "https://api.github.com/users/jfgoog/events{/privacy}", "received_events_url": "https://api.github.com/users/jfgoog/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60660371efe59dfc99644e9d709a1b71e25ae2ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/60660371efe59dfc99644e9d709a1b71e25ae2ac", "html_url": "https://github.com/rust-lang/rust/commit/60660371efe59dfc99644e9d709a1b71e25ae2ac"}], "stats": {"total": 28, "additions": 20, "deletions": 8}, "files": [{"sha": "0d5672305e8b5dcc1865b259bbf870dec1186217", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=7944930b0908cecfd58a47ca2b7b2b42136ada14", "patch": "@@ -1535,7 +1535,10 @@ note: if you're sure you want to do this, please open an issue as to why. In the\n         flags.extend(builder.config.cmd.rustc_args().iter().map(|s| s.to_string()));\n \n         if let Some(linker) = builder.linker(target) {\n-            cmd.arg(\"--linker\").arg(linker);\n+            cmd.arg(\"--target-linker\").arg(linker);\n+        }\n+        if let Some(linker) = builder.linker(compiler.host) {\n+            cmd.arg(\"--host-linker\").arg(linker);\n         }\n \n         let mut hostflags = flags.clone();"}, {"sha": "f61d6f25213770eb30c8207905260631c3b11653", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=7944930b0908cecfd58a47ca2b7b2b42136ada14", "patch": "@@ -369,7 +369,8 @@ pub struct Config {\n     pub cflags: String,\n     pub cxxflags: String,\n     pub ar: String,\n-    pub linker: Option<String>,\n+    pub target_linker: Option<String>,\n+    pub host_linker: Option<String>,\n     pub llvm_components: String,\n \n     /// Path to a NodeJS executable. Used for JS doctests, emscripten and WASM tests"}, {"sha": "8537d72cd872456169388d4e7623fe35e0d6b00b", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=7944930b0908cecfd58a47ca2b7b2b42136ada14", "patch": "@@ -132,7 +132,8 @@ pub fn parse_config(args: Vec<String>) -> Config {\n         .reqopt(\"\", \"cflags\", \"flags for the C compiler\", \"FLAGS\")\n         .reqopt(\"\", \"cxxflags\", \"flags for the CXX compiler\", \"FLAGS\")\n         .optopt(\"\", \"ar\", \"path to an archiver\", \"PATH\")\n-        .optopt(\"\", \"linker\", \"path to a linker\", \"PATH\")\n+        .optopt(\"\", \"target-linker\", \"path to a linker for the target\", \"PATH\")\n+        .optopt(\"\", \"host-linker\", \"path to a linker for the host\", \"PATH\")\n         .reqopt(\"\", \"llvm-components\", \"list of LLVM components built in\", \"LIST\")\n         .optopt(\"\", \"llvm-bin-dir\", \"Path to LLVM's `bin` directory\", \"PATH\")\n         .optopt(\"\", \"nodejs\", \"the name of nodejs\", \"PATH\")\n@@ -303,7 +304,8 @@ pub fn parse_config(args: Vec<String>) -> Config {\n         cflags: matches.opt_str(\"cflags\").unwrap(),\n         cxxflags: matches.opt_str(\"cxxflags\").unwrap(),\n         ar: matches.opt_str(\"ar\").unwrap_or_else(|| String::from(\"ar\")),\n-        linker: matches.opt_str(\"linker\"),\n+        target_linker: matches.opt_str(\"target-linker\"),\n+        host_linker: matches.opt_str(\"host-linker\"),\n         llvm_components: matches.opt_str(\"llvm-components\").unwrap(),\n         nodejs: matches.opt_str(\"nodejs\"),\n         npm: matches.opt_str(\"npm\"),\n@@ -346,7 +348,8 @@ pub fn log_config(config: &Config) {\n     logv(c, format!(\"adb_test_dir: {:?}\", config.adb_test_dir));\n     logv(c, format!(\"adb_device_status: {}\", config.adb_device_status));\n     logv(c, format!(\"ar: {}\", config.ar));\n-    logv(c, format!(\"linker: {:?}\", config.linker));\n+    logv(c, format!(\"target-linker: {:?}\", config.target_linker));\n+    logv(c, format!(\"host-linker: {:?}\", config.host_linker));\n     logv(c, format!(\"verbose: {}\", config.verbose));\n     logv(c, format!(\"format: {:?}\", config.format));\n     logv(c, \"\\n\".to_string());"}, {"sha": "957560fcee5ed6cbe45fec09b61cd4c975964be4", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7944930b0908cecfd58a47ca2b7b2b42136ada14/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=7944930b0908cecfd58a47ca2b7b2b42136ada14", "patch": "@@ -1567,7 +1567,7 @@ impl<'test> TestCx<'test> {\n             rustdoc.arg(\"--output-format\").arg(\"json\").arg(\"-Zunstable-options\");\n         }\n \n-        if let Some(ref linker) = self.config.linker {\n+        if let Some(ref linker) = self.config.target_linker {\n             rustdoc.arg(format!(\"-Clinker={}\", linker));\n         }\n \n@@ -2080,10 +2080,15 @@ impl<'test> TestCx<'test> {\n \n         if self.props.force_host {\n             self.maybe_add_external_args(&mut rustc, &self.config.host_rustcflags);\n+            if !is_rustdoc {\n+                if let Some(ref linker) = self.config.host_linker {\n+                    rustc.arg(format!(\"-Clinker={}\", linker));\n+                }\n+            }\n         } else {\n             self.maybe_add_external_args(&mut rustc, &self.config.target_rustcflags);\n             if !is_rustdoc {\n-                if let Some(ref linker) = self.config.linker {\n+                if let Some(ref linker) = self.config.target_linker {\n                     rustc.arg(format!(\"-Clinker={}\", linker));\n                 }\n             }\n@@ -3035,7 +3040,7 @@ impl<'test> TestCx<'test> {\n             cmd.env(\"NODE\", node);\n         }\n \n-        if let Some(ref linker) = self.config.linker {\n+        if let Some(ref linker) = self.config.target_linker {\n             cmd.env(\"RUSTC_LINKER\", linker);\n         }\n "}]}