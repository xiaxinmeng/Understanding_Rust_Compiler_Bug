{"sha": "26e881d00fee7f28bdb7f0562dbcb7f24db43d1a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI2ZTg4MWQwMGZlZTdmMjhiZGI3ZjA1NjJkYmNiN2YyNGRiNDNkMWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-11-20T12:10:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-11-20T12:10:14Z"}, "message": "Auto merge of #45998 - ollie27:doc_book_css, r=steveklabnik\n\nFix broken CSS for book redirect pages\n\nrust.css has to be next to the font files so we shouldn't copy it for\nonly the book redirect pages, instead just use the version that is\nalready there.\n\nThis also removes the duplicate code creating version_info.html.\n\nFixes: #45974", "tree": {"sha": "286d6b190dec4512f3eaaf4635c81abba60dc620", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/286d6b190dec4512f3eaaf4635c81abba60dc620"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/26e881d00fee7f28bdb7f0562dbcb7f24db43d1a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/26e881d00fee7f28bdb7f0562dbcb7f24db43d1a", "html_url": "https://github.com/rust-lang/rust/commit/26e881d00fee7f28bdb7f0562dbcb7f24db43d1a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/26e881d00fee7f28bdb7f0562dbcb7f24db43d1a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41e03c3c469d1c89735fa518a9af4eb3df8b0728", "url": "https://api.github.com/repos/rust-lang/rust/commits/41e03c3c469d1c89735fa518a9af4eb3df8b0728", "html_url": "https://github.com/rust-lang/rust/commit/41e03c3c469d1c89735fa518a9af4eb3df8b0728"}, {"sha": "9833fd336097446f952257d2d43bb2ec554830a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/9833fd336097446f952257d2d43bb2ec554830a6", "html_url": "https://github.com/rust-lang/rust/commit/9833fd336097446f952257d2d43bb2ec554830a6"}], "stats": {"total": 27, "additions": 11, "deletions": 16}, "files": [{"sha": "9186699a3b58363ad6adf388a2093120e0b43648", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 11, "deletions": 16, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/26e881d00fee7f28bdb7f0562dbcb7f24db43d1a/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26e881d00fee7f28bdb7f0562dbcb7f24db43d1a/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=26e881d00fee7f28bdb7f0562dbcb7f24db43d1a", "patch": "@@ -251,10 +251,12 @@ impl Step for TheBook {\n     ///\n     /// * Book (first edition)\n     /// * Book (second edition)\n+    /// * Version info and CSS\n     /// * Index page\n     /// * Redirect pages\n     fn run(self, builder: &Builder) {\n         let build = builder.build;\n+        let compiler = self.compiler;\n         let target = self.target;\n         let name = self.name;\n         // build book first edition\n@@ -269,10 +271,16 @@ impl Step for TheBook {\n             name: INTERNER.intern_string(format!(\"{}/second-edition\", name)),\n         });\n \n+        // build the version info page and CSS\n+        builder.ensure(Standalone {\n+            compiler,\n+            target,\n+        });\n+\n         // build the index page\n         let index = format!(\"{}/index.md\", name);\n         println!(\"Documenting book index ({})\", target);\n-        invoke_rustdoc(builder, self.compiler, target, &index);\n+        invoke_rustdoc(builder, compiler, target, &index);\n \n         // build the redirect pages\n         println!(\"Documenting book redirect pages ({})\", target);\n@@ -281,7 +289,7 @@ impl Step for TheBook {\n             let path = file.path();\n             let path = path.to_str().unwrap();\n \n-            invoke_rustdoc(builder, self.compiler, target, path);\n+            invoke_rustdoc(builder, compiler, target, path);\n         }\n     }\n }\n@@ -294,25 +302,12 @@ fn invoke_rustdoc(builder: &Builder, compiler: Compiler, target: Interned<String\n \n     let favicon = build.src.join(\"src/doc/favicon.inc\");\n     let footer = build.src.join(\"src/doc/footer.inc\");\n-\n-    let version_input = build.src.join(\"src/doc/version_info.html.template\");\n     let version_info = out.join(\"version_info.html\");\n \n-    if !up_to_date(&version_input, &version_info) {\n-        let mut info = String::new();\n-        t!(t!(File::open(&version_input)).read_to_string(&mut info));\n-        let info = info.replace(\"VERSION\", &build.rust_release())\n-                       .replace(\"SHORT_HASH\", build.rust_info.sha_short().unwrap_or(\"\"))\n-                       .replace(\"STAMP\", build.rust_info.sha().unwrap_or(\"\"));\n-        t!(t!(File::create(&version_info)).write_all(info.as_bytes()));\n-    }\n-\n     let mut cmd = builder.rustdoc_cmd(compiler.host);\n \n     let out = out.join(\"book\");\n \n-    t!(fs::copy(build.src.join(\"src/doc/rust.css\"), out.join(\"rust.css\")));\n-\n     cmd.arg(\"--html-after-content\").arg(&footer)\n         .arg(\"--html-before-content\").arg(&version_info)\n         .arg(\"--html-in-header\").arg(&favicon)\n@@ -321,7 +316,7 @@ fn invoke_rustdoc(builder: &Builder, compiler: Compiler, target: Interned<String\n         .arg(\"-o\").arg(&out)\n         .arg(&path)\n         .arg(\"--markdown-css\")\n-        .arg(\"rust.css\");\n+        .arg(\"../rust.css\");\n \n     build.run(&mut cmd);\n }"}]}