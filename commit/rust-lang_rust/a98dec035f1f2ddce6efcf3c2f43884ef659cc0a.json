{"sha": "a98dec035f1f2ddce6efcf3c2f43884ef659cc0a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5OGRlYzAzNWYxZjJkZGNlNmVmY2YzYzJmNDM4ODRlZjY1OWNjMGE=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-12-13T02:25:17Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-12-13T02:25:17Z"}, "message": "fix track alloc code", "tree": {"sha": "ca3898af40d25e78ea817dbe5a5ea2e0278efb37", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ca3898af40d25e78ea817dbe5a5ea2e0278efb37"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a", "html_url": "https://github.com/rust-lang/rust/commit/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1c1bc2f1cde93a27dbee690280ee81fde8b2ceeb", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c1bc2f1cde93a27dbee690280ee81fde8b2ceeb", "html_url": "https://github.com/rust-lang/rust/commit/1c1bc2f1cde93a27dbee690280ee81fde8b2ceeb"}], "stats": {"total": 15, "additions": 9, "deletions": 6}, "files": [{"sha": "42eb1c6d9acbba247caf7ef9bfcb13a3ab17d718", "filename": "src/rt/memory_region.cpp", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a/src%2Frt%2Fmemory_region.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a/src%2Frt%2Fmemory_region.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Fmemory_region.cpp?ref=a98dec035f1f2ddce6efcf3c2f43884ef659cc0a", "patch": "@@ -2,7 +2,8 @@\n #include \"memory_region.h\"\n \n #if RUSTRT_TRACK_ALLOCATIONS >= 1\n-#  define PTR_SIZE (sizeof(void*))\n+// For some platforms, 16 byte alignment is required.\n+#  define PTR_SIZE 16\n #  define ALIGN_PTR(x) (((x)+PTR_SIZE-1)/PTR_SIZE*PTR_SIZE)\n #  define HEADER_SIZE ALIGN_PTR(sizeof(alloc_header))\n #  define MAGIC 0xbadc0ffe\n@@ -65,11 +66,15 @@ memory_region::realloc(void *mem, size_t orig_size) {\n     }\n \n     alloc_header *alloc = get_header(mem);\n+#   if RUSTRT_TRACK_ALLOCATIONS >= 1\n+    assert(alloc->magic == MAGIC);\n+#   endif\n+\n     size_t size = orig_size + HEADER_SIZE;\n     alloc_header *newMem = (alloc_header *)_srv->realloc(alloc, size);\n \n #   if RUSTRT_TRACK_ALLOCATIONS >= 1\n-    assert(alloc->magic == MAGIC);\n+    assert(newMem->magic == MAGIC);\n     newMem->size = orig_size;\n #   endif\n \n@@ -141,7 +146,7 @@ memory_region::~memory_region() {\n                 alloc_header *header = (alloc_header*)_allocation_list[i];\n                 printf(\"allocation (%s) 0x%\" PRIxPTR \" was not freed\\n\",\n                        header->tag,\n-                       (uintptr_t) &header->data);\n+                       (uintptr_t) get_data(header));\n                 ++leak_count;\n             }\n         }\n@@ -167,7 +172,7 @@ memory_region::release_alloc(void *mem) {\n     if (_synchronized) { _lock.lock(); }\n     if (_allocation_list[alloc->index] != alloc) {\n         printf(\"free: ptr 0x%\" PRIxPTR \" (%s) is not in allocation_list\\n\",\n-               (uintptr_t) &alloc->data, alloc->tag);\n+               (uintptr_t) get_data(alloc), alloc->tag);\n         _srv->fatal(\"not in allocation_list\", __FILE__, __LINE__, \"\");\n     }\n     else {\n@@ -222,6 +227,5 @@ memory_region::maybe_poison(void *mem) {\n // indent-tabs-mode: nil\n // c-basic-offset: 4\n // buffer-file-coding-system: utf-8-unix\n-// compile-command: \"make -k -C $RBUILD 2>&1 | sed -e 's/\\\\/x\\\\//x:\\\\//g'\";\n // End:\n //"}, {"sha": "4caecb3cd5df7d73faca74c797826b66802c6b48", "filename": "src/rt/memory_region.h", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a/src%2Frt%2Fmemory_region.h", "raw_url": "https://github.com/rust-lang/rust/raw/a98dec035f1f2ddce6efcf3c2f43884ef659cc0a/src%2Frt%2Fmemory_region.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Fmemory_region.h?ref=a98dec035f1f2ddce6efcf3c2f43884ef659cc0a", "patch": "@@ -80,7 +80,6 @@ inline void *operator new(size_t size, memory_region *region,\n // indent-tabs-mode: nil\n // c-basic-offset: 4\n // buffer-file-coding-system: utf-8-unix\n-// compile-command: \"make -k -C $RBUILD 2>&1 | sed -e 's/\\\\/x\\\\//x:\\\\//g'\";\n // End:\n //\n "}]}