{"sha": "4c90b987b54389bf8323d63be8796951b44d622f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjOTBiOTg3YjU0Mzg5YmY4MzIzZDYzYmU4Nzk2OTUxYjQ0ZDYyMmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-06-17T21:58:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-06-17T21:58:01Z"}, "message": "auto merge of #7131 : Blei/rust/windows-dynamic-lib, r=graydon\n\nThe code compiles and runs under windows now, but I couldn't look up any\r\nsymbol from the current executable (dlopen(NULL)), and calling looked\r\nup external function handles doesn't seem to work correctly under windows.\r\n\r\nThis the beginning of a fix for #7095.", "tree": {"sha": "b28d91b8884fb58b2e5e245daee12b3bced3501b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b28d91b8884fb58b2e5e245daee12b3bced3501b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4c90b987b54389bf8323d63be8796951b44d622f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4c90b987b54389bf8323d63be8796951b44d622f", "html_url": "https://github.com/rust-lang/rust/commit/4c90b987b54389bf8323d63be8796951b44d622f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4c90b987b54389bf8323d63be8796951b44d622f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4bf074cc66974143178a6add3a7c2e2196ea5a32", "url": "https://api.github.com/repos/rust-lang/rust/commits/4bf074cc66974143178a6add3a7c2e2196ea5a32", "html_url": "https://github.com/rust-lang/rust/commit/4bf074cc66974143178a6add3a7c2e2196ea5a32"}, {"sha": "c7013ba1fcad7fcc84d7e6e93d7a0306c13bce47", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7013ba1fcad7fcc84d7e6e93d7a0306c13bce47", "html_url": "https://github.com/rust-lang/rust/commit/c7013ba1fcad7fcc84d7e6e93d7a0306c13bce47"}], "stats": {"total": 54, "additions": 33, "deletions": 21}, "files": [{"sha": "f5f88f2bb8808716f2a683d1e2b3cd3c95a78ec6", "filename": "src/libstd/unstable/dynamic_lib.rs", "status": "modified", "additions": 33, "deletions": 16, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/4c90b987b54389bf8323d63be8796951b44d622f/src%2Flibstd%2Funstable%2Fdynamic_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c90b987b54389bf8323d63be8796951b44d622f/src%2Flibstd%2Funstable%2Fdynamic_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Funstable%2Fdynamic_lib.rs?ref=4c90b987b54389bf8323d63be8796951b44d622f", "patch": "@@ -42,19 +42,15 @@ impl DynamicLibrary {\n     /// Lazily open a dynamic library. When passed None it gives a\n     /// handle to the calling process\n     pub fn open(filename: Option<&path::Path>) -> Result<DynamicLibrary, ~str> {\n-        let open_wrapper = |raw_ptr| {\n-            do dl::check_for_errors_in {\n-                unsafe {\n-                    DynamicLibrary { handle: dl::open(raw_ptr) }\n+        do dl::check_for_errors_in {\n+            unsafe {\n+                DynamicLibrary { handle:\n+                    match filename {\n+                        Some(name) => dl::open_external(name),\n+                        None => dl::open_internal()\n+                    }\n                 }\n             }\n-        };\n-\n-        match filename {\n-            Some(name) => do name.to_str().as_c_str |raw_name| {\n-                open_wrapper(raw_name)\n-            },\n-            None => open_wrapper(ptr::null())\n         }\n     }\n \n@@ -74,6 +70,7 @@ impl DynamicLibrary {\n }\n \n #[test]\n+#[ignore(cfg(windows))]\n priv fn test_loading_cosine () {\n     // The math library does not need to be loaded since it is already\n     // statically linked in\n@@ -106,13 +103,20 @@ priv fn test_loading_cosine () {\n #[cfg(target_os = \"freebsd\")]\n mod dl {\n     use libc;\n+    use path;\n     use ptr;\n     use str;\n     use task;\n     use result::*;\n \n-    pub unsafe fn open(filename: *libc::c_char) -> *libc::c_void {\n-        dlopen(filename, Lazy as libc::c_int)\n+    pub unsafe fn open_external(filename: &path::Path) -> *libc::c_void {\n+        do filename.to_str().as_c_str |raw_name| {\n+            dlopen(raw_name, Lazy as libc::c_int)\n+        }\n+    }\n+\n+    pub unsafe fn open_internal() -> *libc::c_void {\n+        dlopen(ptr::null(), Lazy as libc::c_int)\n     }\n \n     pub fn check_for_errors_in<T>(f: &fn()->T) -> Result<T, ~str> {\n@@ -159,11 +163,22 @@ mod dl {\n mod dl {\n     use os;\n     use libc;\n+    use path;\n+    use ptr;\n+    use str;\n     use task;\n     use result::*;\n \n-    pub unsafe fn open(filename: *libc::c_char) -> *libc::c_void {\n-        LoadLibrary(filename)\n+    pub unsafe fn open_external(filename: &path::Path) -> *libc::c_void {\n+        do os::win32::as_utf16_p(filename.to_str()) |raw_name| {\n+            LoadLibraryW(raw_name)\n+        }\n+    }\n+\n+    pub unsafe fn open_internal() -> *libc::c_void {\n+        let mut handle = ptr::null();\n+        GetModuleHandleExW(0 as libc::DWORD, ptr::null(), &handle as **libc::c_void);\n+        handle\n     }\n \n     pub fn check_for_errors_in<T>(f: &fn()->T) -> Result<T, ~str> {\n@@ -192,7 +207,9 @@ mod dl {\n     #[link_name = \"kernel32\"]\n     extern \"stdcall\" {\n         fn SetLastError(error: u32);\n-        fn LoadLibrary(name: *libc::c_char) -> *libc::c_void;\n+        fn LoadLibraryW(name: *u16) -> *libc::c_void;\n+        fn GetModuleHandleExW(dwFlags: libc::DWORD, name: *u16,\n+                              handle: **libc::c_void) -> *libc::c_void;\n         fn GetProcAddress(handle: *libc::c_void, name: *libc::c_char) -> *libc::c_void;\n         fn FreeLibrary(handle: *libc::c_void);\n     }"}, {"sha": "0a46ef619afd9d9381a9d11d5b3fda994cfa0f95", "filename": "src/libstd/unstable/mod.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4c90b987b54389bf8323d63be8796951b44d622f/src%2Flibstd%2Funstable%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c90b987b54389bf8323d63be8796951b44d622f/src%2Flibstd%2Funstable%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Funstable%2Fmod.rs?ref=4c90b987b54389bf8323d63be8796951b44d622f", "patch": "@@ -18,11 +18,6 @@ use task;\n \n pub mod at_exit;\n \n-// Currently only works for *NIXes\n-#[cfg(target_os = \"linux\")]\n-#[cfg(target_os = \"android\")]\n-#[cfg(target_os = \"macos\")]\n-#[cfg(target_os = \"freebsd\")]\n pub mod dynamic_lib;\n \n pub mod global;"}]}