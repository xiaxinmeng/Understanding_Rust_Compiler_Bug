{"sha": "f9b4976d60b51d6006c869e6362ce5b178e0f55e", "node_id": "C_kwDOAAsO6NoAKGY5YjQ5NzZkNjBiNTFkNjAwNmM4NjllNjM2MmNlNWIxNzhlMGY1NWU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-03-04T16:31:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-03-04T16:31:08Z"}, "message": "Rollup merge of #94593 - estebank:issue-94510, r=davidtwco\n\nDo not recover from `Ty?` in macro parsing\n\nFollow up to #92746. Address #94510.", "tree": {"sha": "24e6d7a0b9f63577c0a620a2035da801f0a13eb9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24e6d7a0b9f63577c0a620a2035da801f0a13eb9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f9b4976d60b51d6006c869e6362ce5b178e0f55e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiIj7MCRBK7hj4Ov3rIwAAzl8IABE5MCnRWGMZvRFyMsezXhil\nReigX/B0nFbxtfzplMwIlLr8WiPkho6yMqzgUQBmjkAZxvd9jTBYjX3YS8GRhwNM\ncwv6ly3wu/+qvtO0DN+m35UrkDYlml7lHZe35vGkXmmjMFNs/ORubnLwFaGztQPw\nvoGv9BxjN//pCQQX3+7fLR0jE+m+Bm0wgnb+lRDQ1F53id6zwBbyG8iOm7/HIXcK\n3fD2ECYjxvZCIS4tjzAKOqU7MbuyHUikOhwvjjDTgCsqWwQ1+1XlDNtV5shAUoQ5\nbVZUfYXIv/af6TubO6qwaweLTRonv1xMQsDgiqhDxusgxcPsbGDNgvGwV/xYKkM=\n=tr/X\n-----END PGP SIGNATURE-----\n", "payload": "tree 24e6d7a0b9f63577c0a620a2035da801f0a13eb9\nparent 4014e159c902f2ceba9274b8d2c0d83a899b989b\nparent 004f2ed219378235c24a5d6bdb34337200e6eeed\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1646411468 +0100\ncommitter GitHub <noreply@github.com> 1646411468 +0100\n\nRollup merge of #94593 - estebank:issue-94510, r=davidtwco\n\nDo not recover from `Ty?` in macro parsing\n\nFollow up to #92746. Address #94510.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f9b4976d60b51d6006c869e6362ce5b178e0f55e", "html_url": "https://github.com/rust-lang/rust/commit/f9b4976d60b51d6006c869e6362ce5b178e0f55e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f9b4976d60b51d6006c869e6362ce5b178e0f55e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4014e159c902f2ceba9274b8d2c0d83a899b989b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4014e159c902f2ceba9274b8d2c0d83a899b989b", "html_url": "https://github.com/rust-lang/rust/commit/4014e159c902f2ceba9274b8d2c0d83a899b989b"}, {"sha": "004f2ed219378235c24a5d6bdb34337200e6eeed", "url": "https://api.github.com/repos/rust-lang/rust/commits/004f2ed219378235c24a5d6bdb34337200e6eeed", "html_url": "https://github.com/rust-lang/rust/commit/004f2ed219378235c24a5d6bdb34337200e6eeed"}], "stats": {"total": 65, "additions": 50, "deletions": 15}, "files": [{"sha": "40daf4eb28fc1b558e78fbf8e1b016b048b731ac", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f9b4976d60b51d6006c869e6362ce5b178e0f55e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b4976d60b51d6006c869e6362ce5b178e0f55e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=f9b4976d60b51d6006c869e6362ce5b178e0f55e", "patch": "@@ -1,5 +1,5 @@\n use super::pat::Expected;\n-use super::ty::{AllowPlus, IsAsCast};\n+use super::ty::{AllowPlus, RecoverQuestionMark};\n use super::{\n     BlockMode, CommaRecoveryMode, Parser, PathStyle, RecoverColon, RecoverComma, Restrictions,\n     SemiColonMode, SeqSep, TokenExpectType, TokenType,\n@@ -1049,9 +1049,9 @@ impl<'a> Parser<'a> {\n     pub(super) fn maybe_recover_from_question_mark(\n         &mut self,\n         ty: P<Ty>,\n-        is_as_cast: IsAsCast,\n+        recover_question_mark: RecoverQuestionMark,\n     ) -> P<Ty> {\n-        if let IsAsCast::Yes = is_as_cast {\n+        if let RecoverQuestionMark::No = recover_question_mark {\n             return ty;\n         }\n         if self.token == token::Question {"}, {"sha": "40902fa18331333568612d39c47405282c111909", "filename": "compiler/rustc_parse/src/parser/nonterminal.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f9b4976d60b51d6006c869e6362ce5b178e0f55e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fnonterminal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b4976d60b51d6006c869e6362ce5b178e0f55e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fnonterminal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fnonterminal.rs?ref=f9b4976d60b51d6006c869e6362ce5b178e0f55e", "patch": "@@ -140,7 +140,7 @@ impl<'a> Parser<'a> {\n             }\n \n             NonterminalKind::Ty => {\n-                token::NtTy(self.collect_tokens_no_attrs(|this| this.parse_ty())?)\n+                token::NtTy(self.collect_tokens_no_attrs(|this| this.parse_no_question_mark_recover())?)\n             }\n             // this could be handled like a token, since it is one\n             NonterminalKind::Ident"}, {"sha": "436c5bd4fcac23fc7b62f5f305d0442530613c21", "filename": "compiler/rustc_parse/src/parser/ty.rs", "status": "modified", "additions": 23, "deletions": 11, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/f9b4976d60b51d6006c869e6362ce5b178e0f55e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b4976d60b51d6006c869e6362ce5b178e0f55e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fty.rs?ref=f9b4976d60b51d6006c869e6362ce5b178e0f55e", "patch": "@@ -44,7 +44,7 @@ pub(super) enum RecoverQPath {\n     No,\n }\n \n-pub(super) enum IsAsCast {\n+pub(super) enum RecoverQuestionMark {\n     Yes,\n     No,\n }\n@@ -105,7 +105,7 @@ impl<'a> Parser<'a> {\n             RecoverQPath::Yes,\n             RecoverReturnSign::Yes,\n             None,\n-            IsAsCast::No,\n+            RecoverQuestionMark::Yes,\n         )\n     }\n \n@@ -119,7 +119,7 @@ impl<'a> Parser<'a> {\n             RecoverQPath::Yes,\n             RecoverReturnSign::Yes,\n             Some(ty_params),\n-            IsAsCast::No,\n+            RecoverQuestionMark::Yes,\n         )\n     }\n \n@@ -133,7 +133,7 @@ impl<'a> Parser<'a> {\n             RecoverQPath::Yes,\n             RecoverReturnSign::Yes,\n             None,\n-            IsAsCast::No,\n+            RecoverQuestionMark::Yes,\n         )\n     }\n \n@@ -150,7 +150,7 @@ impl<'a> Parser<'a> {\n             RecoverQPath::Yes,\n             RecoverReturnSign::Yes,\n             None,\n-            IsAsCast::No,\n+            RecoverQuestionMark::Yes,\n         )\n     }\n \n@@ -163,9 +163,21 @@ impl<'a> Parser<'a> {\n             RecoverQPath::Yes,\n             RecoverReturnSign::Yes,\n             None,\n-            IsAsCast::Yes,\n+            RecoverQuestionMark::No,\n         )\n     }\n+\n+    pub(super) fn parse_no_question_mark_recover(&mut self) -> PResult<'a, P<Ty>> {\n+        self.parse_ty_common(\n+            AllowPlus::Yes,\n+            AllowCVariadic::No,\n+            RecoverQPath::Yes,\n+            RecoverReturnSign::Yes,\n+            None,\n+            RecoverQuestionMark::No,\n+        )\n+    }\n+\n     /// Parse a type without recovering `:` as `->` to avoid breaking code such as `where fn() : for<'a>`\n     pub(super) fn parse_ty_for_where_clause(&mut self) -> PResult<'a, P<Ty>> {\n         self.parse_ty_common(\n@@ -174,7 +186,7 @@ impl<'a> Parser<'a> {\n             RecoverQPath::Yes,\n             RecoverReturnSign::OnlyFatArrow,\n             None,\n-            IsAsCast::No,\n+            RecoverQuestionMark::Yes,\n         )\n     }\n \n@@ -193,7 +205,7 @@ impl<'a> Parser<'a> {\n                 recover_qpath,\n                 recover_return_sign,\n                 None,\n-                IsAsCast::No,\n+                RecoverQuestionMark::Yes,\n             )?;\n             FnRetTy::Ty(ty)\n         } else if recover_return_sign.can_recover(&self.token.kind) {\n@@ -214,7 +226,7 @@ impl<'a> Parser<'a> {\n                 recover_qpath,\n                 recover_return_sign,\n                 None,\n-                IsAsCast::No,\n+                RecoverQuestionMark::Yes,\n             )?;\n             FnRetTy::Ty(ty)\n         } else {\n@@ -229,7 +241,7 @@ impl<'a> Parser<'a> {\n         recover_qpath: RecoverQPath,\n         recover_return_sign: RecoverReturnSign,\n         ty_generics: Option<&Generics>,\n-        is_as_cast: IsAsCast,\n+        recover_question_mark: RecoverQuestionMark,\n     ) -> PResult<'a, P<Ty>> {\n         let allow_qpath_recovery = recover_qpath == RecoverQPath::Yes;\n         maybe_recover_from_interpolated_ty_qpath!(self, allow_qpath_recovery);\n@@ -305,7 +317,7 @@ impl<'a> Parser<'a> {\n         // Try to recover from use of `+` with incorrect priority.\n         self.maybe_report_ambiguous_plus(allow_plus, impl_dyn_multi, &ty);\n         self.maybe_recover_from_bad_type_plus(allow_plus, &ty)?;\n-        let ty = self.maybe_recover_from_question_mark(ty, is_as_cast);\n+        let ty = self.maybe_recover_from_question_mark(ty, recover_question_mark);\n         self.maybe_recover_from_bad_qpath(ty, allow_qpath_recovery)\n     }\n "}, {"sha": "e2a681ddd11155a07290586ddd46c14630fb8342", "filename": "src/test/ui/parser/trailing-question-in-macro-type.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f9b4976d60b51d6006c869e6362ce5b178e0f55e/src%2Ftest%2Fui%2Fparser%2Ftrailing-question-in-macro-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9b4976d60b51d6006c869e6362ce5b178e0f55e/src%2Ftest%2Fui%2Fparser%2Ftrailing-question-in-macro-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Ftrailing-question-in-macro-type.rs?ref=f9b4976d60b51d6006c869e6362ce5b178e0f55e", "patch": "@@ -0,0 +1,14 @@\n+macro_rules! fn_expr {\n+    ($return_type:ty : $body:expr) => {\n+        (|| -> $return_type { $body })()\n+    };\n+    ($body:expr) => {\n+        (|| $body)()\n+    };\n+}\n+\n+\n+fn main() {\n+    fn_expr!{ o?.when(|&i| i > 0)?.when(|&i| i%2 == 0) };\n+    //~^ ERROR cannot find value `o` in this scope\n+}"}, {"sha": "c096ae04fbbb6dd277ab9a4049baee571b1baab3", "filename": "src/test/ui/parser/trailing-question-in-macro-type.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f9b4976d60b51d6006c869e6362ce5b178e0f55e/src%2Ftest%2Fui%2Fparser%2Ftrailing-question-in-macro-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f9b4976d60b51d6006c869e6362ce5b178e0f55e/src%2Ftest%2Fui%2Fparser%2Ftrailing-question-in-macro-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Ftrailing-question-in-macro-type.stderr?ref=f9b4976d60b51d6006c869e6362ce5b178e0f55e", "patch": "@@ -0,0 +1,9 @@\n+error[E0425]: cannot find value `o` in this scope\n+  --> $DIR/trailing-question-in-macro-type.rs:12:15\n+   |\n+LL |     fn_expr!{ o?.when(|&i| i > 0)?.when(|&i| i%2 == 0) };\n+   |               ^ not found in this scope\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0425`."}]}