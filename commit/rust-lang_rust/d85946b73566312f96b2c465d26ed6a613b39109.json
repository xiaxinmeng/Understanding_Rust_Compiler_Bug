{"sha": "d85946b73566312f96b2c465d26ed6a613b39109", "node_id": "C_kwDOAAsO6NoAKGQ4NTk0NmI3MzU2NjMxMmY5NmIyYzQ2NWQyNmVkNmE2MTNiMzkxMDk", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-10-19T11:43:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-19T11:43:08Z"}, "message": "Merge #10585\n\n10585: fix: Resolve derive attributes even when shadowed r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "f84331e0b35b11a0ed3a03c2bcac9b0febc343da", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f84331e0b35b11a0ed3a03c2bcac9b0febc343da"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d85946b73566312f96b2c465d26ed6a613b39109", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhbq9MCRBK7hj4Ov3rIwAAbokIAKZvvcBEUMm+QSTpx913zjsL\n8m2+sUrURrJC50D0H+n3jmC0Edm8WLfJk9V8FcZuazpDj4VOt556ZqWArUmGt5BE\n6n7x7KzLZ4g5tiduZPkoVvD+tbt/qHegIrzeiU6rGMePOldindV3J68BGfJrdkCx\nnEVcEHCo1PPn+djHrDysmm7XL3Hwylue5xtsj3lK5/qu1rw12FuhGGW7cUK+ag2a\n/WxNbcIOfyLooJW/26LOaSu4z59atMPKXlTU0CvNsY71WhxhCZGZKj+42CZj1flJ\nM2Yl6EnGgx9KaYS40lHEF5sRWxcu1sZBmQyElCEVtuPAiJjHDnBKsGMaGea2a6I=\n=IYdv\n-----END PGP SIGNATURE-----\n", "payload": "tree f84331e0b35b11a0ed3a03c2bcac9b0febc343da\nparent 87d5ef8c4a367d112d085827e8ad4f84b8ff809f\nparent aa9d0934887fced0437c1e09ea5255185cac5631\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1634643788 +0000\ncommitter GitHub <noreply@github.com> 1634643788 +0000\n\nMerge #10585\n\n10585: fix: Resolve derive attributes even when shadowed r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d85946b73566312f96b2c465d26ed6a613b39109", "html_url": "https://github.com/rust-lang/rust/commit/d85946b73566312f96b2c465d26ed6a613b39109", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d85946b73566312f96b2c465d26ed6a613b39109/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87d5ef8c4a367d112d085827e8ad4f84b8ff809f", "url": "https://api.github.com/repos/rust-lang/rust/commits/87d5ef8c4a367d112d085827e8ad4f84b8ff809f", "html_url": "https://github.com/rust-lang/rust/commit/87d5ef8c4a367d112d085827e8ad4f84b8ff809f"}, {"sha": "aa9d0934887fced0437c1e09ea5255185cac5631", "url": "https://api.github.com/repos/rust-lang/rust/commits/aa9d0934887fced0437c1e09ea5255185cac5631", "html_url": "https://github.com/rust-lang/rust/commit/aa9d0934887fced0437c1e09ea5255185cac5631"}], "stats": {"total": 30, "additions": 23, "deletions": 7}, "files": [{"sha": "ca23d85cb24f60450f73d53c9e7569f5328dbfb7", "filename": "crates/hir/src/semantics.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d85946b73566312f96b2c465d26ed6a613b39109/crates%2Fhir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d85946b73566312f96b2c465d26ed6a613b39109/crates%2Fhir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics.rs?ref=d85946b73566312f96b2c465d26ed6a613b39109", "patch": "@@ -24,7 +24,7 @@ use syntax::{\n use crate::{\n     db::HirDatabase,\n     semantics::source_to_def::{ChildContainer, SourceToDefCache, SourceToDefCtx},\n-    source_analyzer::{resolve_hir_path, SourceAnalyzer},\n+    source_analyzer::{resolve_hir_path, resolve_hir_path_as_macro, SourceAnalyzer},\n     Access, AssocItem, Callable, ConstParam, Crate, Field, Function, HasSource, HirFileId, Impl,\n     InFile, Label, LifetimeParam, Local, MacroDef, Module, ModuleDef, Name, Path, ScopeDef, Trait,\n     Type, TypeAlias, TypeParam, VariantDef,\n@@ -1134,4 +1134,14 @@ impl<'a> SemanticsScope<'a> {\n         let path = Path::from_src(path.clone(), &ctx)?;\n         resolve_hir_path(self.db, &self.resolver, &path)\n     }\n+\n+    /// Resolve a path as-if it was written at the given scope. This is\n+    /// necessary a heuristic, as it doesn't take hygiene into account.\n+    // FIXME: This special casing solely exists for attributes for now\n+    // ideally we should have a path resolution infra that properly knows about overlapping namespaces\n+    pub fn speculative_resolve_as_mac(&self, path: &ast::Path) -> Option<MacroDef> {\n+        let ctx = body::LowerCtx::new(self.db.upcast(), self.file_id);\n+        let path = Path::from_src(path.clone(), &ctx)?;\n+        resolve_hir_path_as_macro(self.db, &self.resolver, &path)\n+    }\n }"}, {"sha": "08d0a02d796e69b5d82809ffda24138fcda03db1", "filename": "crates/hir/src/source_analyzer.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d85946b73566312f96b2c465d26ed6a613b39109/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d85946b73566312f96b2c465d26ed6a613b39109/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs?ref=d85946b73566312f96b2c465d26ed6a613b39109", "patch": "@@ -502,6 +502,15 @@ pub(crate) fn resolve_hir_path(\n     resolve_hir_path_(db, resolver, path, false)\n }\n \n+#[inline]\n+pub(crate) fn resolve_hir_path_as_macro(\n+    db: &dyn HirDatabase,\n+    resolver: &Resolver,\n+    path: &Path,\n+) -> Option<MacroDef> {\n+    resolver.resolve_path_as_macro(db.upcast(), path.mod_path()).map(Into::into)\n+}\n+\n fn resolve_hir_path_(\n     db: &dyn HirDatabase,\n     resolver: &Resolver,"}, {"sha": "173e55b33f6ac7b6579b96d4a0065639be65740e", "filename": "crates/ide_db/src/helpers.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d85946b73566312f96b2c465d26ed6a613b39109/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d85946b73566312f96b2c465d26ed6a613b39109/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers.rs?ref=d85946b73566312f96b2c465d26ed6a613b39109", "patch": "@@ -53,12 +53,9 @@ pub fn try_resolve_derive_input_at(\n         .take_while(|tok| tok.kind() != T!['('] && tok.kind() != T![,])\n         .collect();\n     let path = ast::Path::parse(&tokens.into_iter().rev().join(\"\")).ok()?;\n-    match sema.scope(tt.syntax()).speculative_resolve(&path) {\n-        Some(hir::PathResolution::Macro(makro)) if makro.kind() == hir::MacroKind::Derive => {\n-            Some(makro)\n-        }\n-        _ => None,\n-    }\n+    sema.scope(tt.syntax())\n+        .speculative_resolve_as_mac(&path)\n+        .filter(|mac| mac.kind() == hir::MacroKind::Derive)\n }\n \n /// Picks the token with the highest rank returned by the passed in function."}]}