{"sha": "e9aa0e7540b2bc0e644dde84aeca41d055e7511f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU5YWEwZTc1NDBiMmJjMGU2NDRkZGU4NGFlY2E0MWQwNTVlNzUxMWY=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2019-09-26T20:17:00Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2019-09-26T20:17:00Z"}, "message": "Use existing Handler to print query stack\n\nWhen the panic handler is run, the existing Handler may be in a weird\nstate if it was responsible for triggering the panic. By using a freshly\ncreated Handler, we avoid trying to re-entrantly lock a HandlerInner,\nwhich was causing a double panic on ICEs.", "tree": {"sha": "7099969a5a450fe11cbb27c9873d369ff89809ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7099969a5a450fe11cbb27c9873d369ff89809ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e9aa0e7540b2bc0e644dde84aeca41d055e7511f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl2NHQYACgkQtAh+UQ6Y\nsWQgWw//an3DhdWAiLtBvXqLMmcQpUrODQJzbbVXBB5CgFVQ6u5wovuA8Piak7BR\nWO3aF1vz0DDz3uInTBwDT9xVz3xxeraPVTX3PlTgYVVc42VTNaBn89DEY5/Oy+/M\npkGIih9iH713DP7TzMGj0NMbeAAVLlBFf1CveopQzk9fNEH7rhWbqV04LFPfN8x1\nM7qKzUZlE76sk8XT1TNZWONd1uLKaSBIlzGAEgP8udcsHslMWE2tYQ92gt8wL6u6\ndyPSP5xoN3t3Ci9We30mLOd7WcsJBPPX98vHCl0C8JvIaRP3gflxwbycZbmpHWB6\noJsWFIuu+wnRU27zYyZEFMSfT+OYcuKRwg8ioHF9Sm1jfAWhqK+ZHM2S/YV/usGv\nD9iEtdUqRIpwpJm2lM+8vgnzLyJBR7RD50y/0HB+VBb8NjCnxNH6vXlVXY45t/oY\nnnfL7IB1nEP4OghPGT7vWeWy5VtNd0Qcky/cQkt1BWVgnOCKNvOJpECNUrUX5uMU\nOQR6c/Cve3VZWMg7EEvnFKmdw+PXd3znChlmB/gAY4BI0wuZlLqU/zB7JzzzhaC+\njSbSLzhajXr0kshxLZep1EddryDBX4Jq4Lf087cNoOu83NJ2IxI6p/3OiwTZVRq2\nNMT0JFdS9lbAevCEx1a2ZZ5vV6XUmyzl380DmgeJLyI0jggNXw0=\n=ri+B\n-----END PGP SIGNATURE-----", "payload": "tree 7099969a5a450fe11cbb27c9873d369ff89809ce\nparent ddf43867a9cbb3766b48552632a602498fae2699\nauthor Aaron Hill <aa1ronham@gmail.com> 1569529020 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1569529020 -0400\n\nUse existing Handler to print query stack\n\nWhen the panic handler is run, the existing Handler may be in a weird\nstate if it was responsible for triggering the panic. By using a freshly\ncreated Handler, we avoid trying to re-entrantly lock a HandlerInner,\nwhich was causing a double panic on ICEs.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e9aa0e7540b2bc0e644dde84aeca41d055e7511f", "html_url": "https://github.com/rust-lang/rust/commit/e9aa0e7540b2bc0e644dde84aeca41d055e7511f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e9aa0e7540b2bc0e644dde84aeca41d055e7511f/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ddf43867a9cbb3766b48552632a602498fae2699", "url": "https://api.github.com/repos/rust-lang/rust/commits/ddf43867a9cbb3766b48552632a602498fae2699", "html_url": "https://github.com/rust-lang/rust/commit/ddf43867a9cbb3766b48552632a602498fae2699"}], "stats": {"total": 7, "additions": 4, "deletions": 3}, "files": [{"sha": "e2dff46d18b16b67941f3f412a0a21b3fe3fac68", "filename": "src/librustc/ty/query/plumbing.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e9aa0e7540b2bc0e644dde84aeca41d055e7511f/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9aa0e7540b2bc0e644dde84aeca41d055e7511f/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs?ref=e9aa0e7540b2bc0e644dde84aeca41d055e7511f", "patch": "@@ -15,6 +15,7 @@ use errors::DiagnosticBuilder;\n use errors::Level;\n use errors::Diagnostic;\n use errors::FatalError;\n+use errors::Handler;\n use rustc_data_structures::fx::{FxHashMap};\n use rustc_data_structures::sync::{Lrc, Lock};\n use rustc_data_structures::sharded::Sharded;\n@@ -321,7 +322,7 @@ impl<'tcx> TyCtxt<'tcx> {\n         })\n     }\n \n-    pub fn try_print_query_stack() {\n+    pub fn try_print_query_stack(handler: &Handler) {\n         eprintln!(\"query stack during panic:\");\n \n         tls::with_context_opt(|icx| {\n@@ -336,7 +337,7 @@ impl<'tcx> TyCtxt<'tcx> {\n                                  query.info.query.name(),\n                                  query.info.query.describe(icx.tcx)));\n                     diag.span = icx.tcx.sess.source_map().def_span(query.info.span).into();\n-                    icx.tcx.sess.diagnostic().force_print_diagnostic(diag);\n+                    handler.force_print_diagnostic(diag);\n \n                     current_query = query.parent.clone();\n                     i += 1;"}, {"sha": "d0a319df2e6dc3058e146519ef137a676bfe6bc4", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e9aa0e7540b2bc0e644dde84aeca41d055e7511f/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9aa0e7540b2bc0e644dde84aeca41d055e7511f/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=e9aa0e7540b2bc0e644dde84aeca41d055e7511f", "patch": "@@ -1231,7 +1231,7 @@ pub fn report_ice(info: &panic::PanicInfo<'_>, bug_report_url: &str) {\n     let backtrace = env::var_os(\"RUST_BACKTRACE\").map(|x| &x != \"0\").unwrap_or(false);\n \n     if backtrace {\n-        TyCtxt::try_print_query_stack();\n+        TyCtxt::try_print_query_stack(&handler);\n     }\n \n     #[cfg(windows)]"}]}