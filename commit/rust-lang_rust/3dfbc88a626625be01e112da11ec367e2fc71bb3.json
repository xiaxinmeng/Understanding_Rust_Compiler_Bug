{"sha": "3dfbc88a626625be01e112da11ec367e2fc71bb3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkZmJjODhhNjI2NjI1YmUwMWUxMTJkYTExZWMzNjdlMmZjNzFiYjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-13T11:09:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-13T11:09:55Z"}, "message": "Auto merge of #46550 - jseyfried:cleanup_builtin_hygiene, r=nrc\n\nmacros: hygienize use of `core`/`std` in builtin macros\n\nToday, if a builtin macro wants to access an item from `core` or `std` (depending `#![no_std]`), it generates `::core::path::to::item` or `::std::path::to::item` respectively (c.f. `fn std_path()` in `libsyntax/ext/base.rs`).\n\nThis PR refactors the builtin macros to instead always emit `$crate::path::to::item` here. That is, the def site of builtin macros is taken to be in `extern crate core;` or `extern crate std;`. Since builtin macros are macros 1.0 (i.e. mostly unhygienic), changing the def site can only effect the resolution of `$crate`.\n\nr? @nrc", "tree": {"sha": "3123349d2f450ac5317944d5f5803b20c3eca65b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3123349d2f450ac5317944d5f5803b20c3eca65b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3dfbc88a626625be01e112da11ec367e2fc71bb3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3dfbc88a626625be01e112da11ec367e2fc71bb3", "html_url": "https://github.com/rust-lang/rust/commit/3dfbc88a626625be01e112da11ec367e2fc71bb3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3dfbc88a626625be01e112da11ec367e2fc71bb3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61100840e5c978a99b0489e8eaa922da06c05f65", "url": "https://api.github.com/repos/rust-lang/rust/commits/61100840e5c978a99b0489e8eaa922da06c05f65", "html_url": "https://github.com/rust-lang/rust/commit/61100840e5c978a99b0489e8eaa922da06c05f65"}, {"sha": "85d19b33357897c51d80727a4208f46b19c5c5a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/85d19b33357897c51d80727a4208f46b19c5c5a6", "html_url": "https://github.com/rust-lang/rust/commit/85d19b33357897c51d80727a4208f46b19c5c5a6"}], "stats": {"total": 314, "additions": 174, "deletions": 140}, "files": [{"sha": "e3a5e835bb9f693e2b53fb2f158290a0d0296a9f", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -175,7 +175,7 @@ pub fn lower_crate(sess: &Session,\n     let _ignore = dep_graph.in_ignore();\n \n     LoweringContext {\n-        crate_root: std_inject::injected_crate_name(krate),\n+        crate_root: std_inject::injected_crate_name(),\n         sess,\n         cstore,\n         parent_def: None,"}, {"sha": "8df6458b72e183d0e173f633948c6fa4fbf62605", "filename": "src/librustc_resolve/build_reduced_graph.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -40,6 +40,7 @@ use syntax::ext::base::Determinacy::Undetermined;\n use syntax::ext::hygiene::Mark;\n use syntax::ext::tt::macro_rules;\n use syntax::parse::token::{self, Token};\n+use syntax::std_inject::injected_crate_name;\n use syntax::symbol::keywords;\n use syntax::symbol::Symbol;\n use syntax::visit::{self, Visitor};\n@@ -262,6 +263,10 @@ impl<'a> Resolver<'a> {\n                 let module =\n                     self.get_module(DefId { krate: crate_id, index: CRATE_DEF_INDEX });\n                 self.populate_module_if_necessary(module);\n+                if injected_crate_name().map_or(false, |name| item.ident.name == name) {\n+                    self.injected_crate = Some(module);\n+                }\n+\n                 let used = self.process_legacy_macro_imports(item, module, expansion);\n                 let binding =\n                     (module, ty::Visibility::Public, sp, expansion).to_name_binding(self.arenas);\n@@ -558,8 +563,7 @@ impl<'a> Resolver<'a> {\n         if let Some(id) = self.definitions.as_local_node_id(def_id) {\n             self.local_macro_def_scopes[&id]\n         } else if def_id.krate == BUILTIN_MACROS_CRATE {\n-            // FIXME(jseyfried): This happens when `include!()`ing a `$crate::` path, c.f, #40469.\n-            self.graph_root\n+            self.injected_crate.unwrap_or(self.graph_root)\n         } else {\n             let module_def_id = ty::DefIdTree::parent(&*self, def_id).unwrap();\n             self.get_module(module_def_id)"}, {"sha": "33e57b2d180d6e2472d3bc8bfe813842bdcf4c60", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -1338,6 +1338,8 @@ pub struct Resolver<'a> {\n \n     // Only used for better errors on `fn(): fn()`\n     current_type_ascription: Vec<Span>,\n+\n+    injected_crate: Option<Module<'a>>,\n }\n \n pub struct ResolverArenas<'a> {\n@@ -1537,6 +1539,7 @@ impl<'a> Resolver<'a> {\n             found_unresolved_macro: false,\n             unused_macros: FxHashSet(),\n             current_type_ascription: Vec::new(),\n+            injected_crate: None,\n         }\n     }\n "}, {"sha": "260a0cd7cd7337d8616c926795e4d285dd45451e", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -25,7 +25,7 @@ use syntax::errors::DiagnosticBuilder;\n use syntax::ext::base::{self, Annotatable, Determinacy, MultiModifier, MultiDecorator};\n use syntax::ext::base::{MacroKind, SyntaxExtension, Resolver as SyntaxResolver};\n use syntax::ext::expand::{Expansion, ExpansionKind, Invocation, InvocationKind, find_attr_invoc};\n-use syntax::ext::hygiene::Mark;\n+use syntax::ext::hygiene::{Mark, MarkKind};\n use syntax::ext::placeholders::placeholder;\n use syntax::ext::tt::macro_rules;\n use syntax::feature_gate::{self, emit_feature_err, GateIssue};\n@@ -297,16 +297,19 @@ impl<'a> base::Resolver for Resolver<'a> {\n             InvocationKind::Attr { attr: None, .. } => return Ok(None),\n             _ => self.resolve_invoc_to_def(invoc, scope, force)?,\n         };\n+        let def_id = def.def_id();\n \n-        self.macro_defs.insert(invoc.expansion_data.mark, def.def_id());\n+        self.macro_defs.insert(invoc.expansion_data.mark, def_id);\n         let normal_module_def_id =\n             self.macro_def_scope(invoc.expansion_data.mark).normal_ancestor_id;\n         self.definitions.add_macro_def_scope(invoc.expansion_data.mark, normal_module_def_id);\n \n-        self.unused_macros.remove(&def.def_id());\n+        self.unused_macros.remove(&def_id);\n         let ext = self.get_macro(def);\n         if ext.is_modern() {\n-            invoc.expansion_data.mark.set_modern();\n+            invoc.expansion_data.mark.set_kind(MarkKind::Modern);\n+        } else if def_id.krate == BUILTIN_MACROS_CRATE {\n+            invoc.expansion_data.mark.set_kind(MarkKind::Builtin);\n         }\n         Ok(Some(ext))\n     }"}, {"sha": "bb1b7da7dbab2c4f9d2a0628b2c277325adb4c36", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -21,10 +21,11 @@ use fold::{self, Folder};\n use parse::{self, parser, DirectoryOwnership};\n use parse::token;\n use ptr::P;\n-use symbol::Symbol;\n+use symbol::{keywords, Ident, Symbol};\n use util::small_vector::SmallVector;\n \n use std::collections::HashMap;\n+use std::iter;\n use std::path::PathBuf;\n use std::rc::Rc;\n use std::default::Default;\n@@ -664,7 +665,6 @@ pub struct ExpansionData {\n pub struct ExtCtxt<'a> {\n     pub parse_sess: &'a parse::ParseSess,\n     pub ecfg: expand::ExpansionConfig<'a>,\n-    pub crate_root: Option<&'static str>,\n     pub root_path: PathBuf,\n     pub resolver: &'a mut Resolver,\n     pub resolve_err_count: usize,\n@@ -680,7 +680,6 @@ impl<'a> ExtCtxt<'a> {\n         ExtCtxt {\n             parse_sess,\n             ecfg,\n-            crate_root: None,\n             root_path: PathBuf::new(),\n             resolver,\n             resolve_err_count: 0,\n@@ -822,12 +821,10 @@ impl<'a> ExtCtxt<'a> {\n         ast::Ident::from_str(st)\n     }\n     pub fn std_path(&self, components: &[&str]) -> Vec<ast::Ident> {\n-        let mut v = Vec::new();\n-        if let Some(s) = self.crate_root {\n-            v.push(self.ident_of(s));\n-        }\n-        v.extend(components.iter().map(|s| self.ident_of(s)));\n-        v\n+        let def_site = SyntaxContext::empty().apply_mark(self.current_expansion.mark);\n+        iter::once(Ident { ctxt: def_site, ..keywords::DollarCrate.ident() })\n+            .chain(components.iter().map(|s| self.ident_of(s)))\n+            .collect()\n     }\n     pub fn name_of(&self, st: &str) -> ast::Name {\n         Symbol::intern(st)"}, {"sha": "82e7747b014618485bbc00cebbf1c2cf559d5207", "filename": "src/libsyntax/ext/build.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fext%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fext%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbuild.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -319,9 +319,12 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n                 types: Vec<P<ast::Ty>>,\n                 bindings: Vec<ast::TypeBinding> )\n                 -> ast::Path {\n+        use syntax::parse::token;\n+\n         let last_identifier = idents.pop().unwrap();\n         let mut segments: Vec<ast::PathSegment> = Vec::new();\n-        if global {\n+        if global &&\n+           !idents.first().map_or(false, |&ident| token::Ident(ident).is_path_segment_keyword()) {\n             segments.push(ast::PathSegment::crate_root(span));\n         }\n "}, {"sha": "ecb396f259f7386e9ab89a4cfbf16da99229fada", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -25,7 +25,6 @@ use parse::{DirectoryOwnership, PResult};\n use parse::token::{self, Token};\n use parse::parser::Parser;\n use ptr::P;\n-use std_inject;\n use symbol::Symbol;\n use symbol::keywords;\n use syntax_pos::{Span, DUMMY_SP};\n@@ -219,7 +218,6 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n     }\n \n     pub fn expand_crate(&mut self, mut krate: ast::Crate) -> ast::Crate {\n-        self.cx.crate_root = std_inject::injected_crate_name(&krate);\n         let mut module = ModuleData {\n             mod_path: vec![Ident::from_str(&self.cx.ecfg.crate_name)],\n             directory: self.cx.codemap().span_to_unmapped_path(krate.span),"}, {"sha": "17f37d0f2c0ee7e54d6a2af2e29c54f6b693d945", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -18,6 +18,7 @@ use util::parser::{self, AssocOp, Fixity};\n use attr;\n use codemap::{self, CodeMap};\n use syntax_pos::{self, BytePos};\n+use syntax_pos::hygiene::{Mark, MarkKind, SyntaxContext};\n use parse::token::{self, BinOpToken, Token};\n use parse::lexer::comments;\n use parse::{self, ParseSess};\n@@ -93,7 +94,7 @@ pub fn print_crate<'a>(cm: &'a CodeMap,\n                        is_expanded: bool) -> io::Result<()> {\n     let mut s = State::new_from_input(cm, sess, filename, input, out, ann, is_expanded);\n \n-    if is_expanded && !std_inject::injected_crate_name(krate).is_none() {\n+    if is_expanded && !std_inject::injected_crate_name().is_none() {\n         // We need to print `#![no_std]` (and its feature gate) so that\n         // compiling pretty-printed source won't inject libstd again.\n         // However we don't want these attributes in the AST because\n@@ -734,6 +735,8 @@ pub trait PrintState<'a> {\n                     if segment.identifier.name != keywords::CrateRoot.name() &&\n                        segment.identifier.name != keywords::DollarCrate.name() {\n                         self.writer().word(&segment.identifier.name.as_str())?;\n+                    } else if segment.identifier.name == keywords::DollarCrate.name() {\n+                        self.print_dollar_crate(segment.identifier.ctxt)?;\n                     }\n                 }\n                 self.writer().space()?;\n@@ -822,6 +825,19 @@ pub trait PrintState<'a> {\n     }\n \n     fn nbsp(&mut self) -> io::Result<()> { self.writer().word(\" \") }\n+\n+    fn print_dollar_crate(&mut self, mut ctxt: SyntaxContext) -> io::Result<()> {\n+        if let Some(mark) = ctxt.adjust(Mark::root()) {\n+            // Make a best effort to print something that complies\n+            if mark.kind() == MarkKind::Builtin {\n+                if let Some(name) = std_inject::injected_crate_name() {\n+                    self.writer().word(\"::\")?;\n+                    self.writer().word(name)?;\n+                }\n+            }\n+        }\n+        Ok(())\n+    }\n }\n \n impl<'a> PrintState<'a> for State<'a> {\n@@ -2411,6 +2427,8 @@ impl<'a> State<'a> {\n             if let Some(ref parameters) = segment.parameters {\n                 self.print_path_parameters(parameters, colons_before_params)?;\n             }\n+        } else if segment.identifier.name == keywords::DollarCrate.name() {\n+            self.print_dollar_crate(segment.identifier.ctxt)?;\n         }\n         Ok(())\n     }"}, {"sha": "00546400bb54265d557a31b8b0a2458663c26a90", "filename": "src/libsyntax/std_inject.rs", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fstd_inject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Fstd_inject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fstd_inject.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -10,6 +10,7 @@\n \n use ast;\n use attr;\n+use std::cell::Cell;\n use ext::hygiene::{Mark, SyntaxContext};\n use symbol::{Symbol, keywords};\n use syntax_pos::{DUMMY_SP, Span};\n@@ -34,22 +35,25 @@ fn ignored_span(sp: Span) -> Span {\n     sp.with_ctxt(SyntaxContext::empty().apply_mark(mark))\n }\n \n-pub fn injected_crate_name(krate: &ast::Crate) -> Option<&'static str> {\n-    if attr::contains_name(&krate.attrs, \"no_core\") {\n-        None\n-    } else if attr::contains_name(&krate.attrs, \"no_std\") {\n-        Some(\"core\")\n-    } else {\n-        Some(\"std\")\n-    }\n+pub fn injected_crate_name() -> Option<&'static str> {\n+    INJECTED_CRATE_NAME.with(|name| name.get())\n+}\n+\n+thread_local! {\n+    static INJECTED_CRATE_NAME: Cell<Option<&'static str>> = Cell::new(None);\n }\n \n pub fn maybe_inject_crates_ref(mut krate: ast::Crate, alt_std_name: Option<String>) -> ast::Crate {\n-    let name = match injected_crate_name(&krate) {\n-        Some(name) => name,\n-        None => return krate,\n+    let name = if attr::contains_name(&krate.attrs, \"no_core\") {\n+        return krate;\n+    } else if attr::contains_name(&krate.attrs, \"no_std\") {\n+        \"core\"\n+    } else {\n+        \"std\"\n     };\n \n+    INJECTED_CRATE_NAME.with(|opt_name| opt_name.set(Some(name)));\n+\n     let crate_name = Symbol::intern(&alt_std_name.unwrap_or_else(|| name.to_string()));\n \n     krate.module.items.insert(0, P(ast::Item {"}, {"sha": "9f097169d973e6ef9aeaa58e06a6bb61435a1dc3", "filename": "src/libsyntax/test.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftest.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -272,7 +272,7 @@ fn generate_test_harness(sess: &ParseSess,\n \n     let mark = Mark::fresh(Mark::root());\n \n-    let mut cx: TestCtxt = TestCtxt {\n+    let cx = TestCtxt {\n         span_diagnostic: sd,\n         ext_cx: ExtCtxt::new(sess, ExpansionConfig::default(\"test\".to_string()), resolver),\n         path: Vec::new(),\n@@ -283,7 +283,6 @@ fn generate_test_harness(sess: &ParseSess,\n         toplevel_reexport: None,\n         ctxt: SyntaxContext::empty().apply_mark(mark),\n     };\n-    cx.ext_cx.crate_root = Some(\"std\");\n \n     mark.set_expn_info(ExpnInfo {\n         call_site: DUMMY_SP,"}, {"sha": "7f03001d9c6ebf92259aba08c3211a2a95560d7d", "filename": "src/libsyntax_ext/deriving/bounds.rs", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fbounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fbounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fbounds.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,9 +8,9 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::path_std;\n use deriving::generic::*;\n use deriving::generic::ty::*;\n-\n use syntax::ast::MetaItem;\n use syntax::ext::base::{Annotatable, ExtCtxt};\n use syntax_pos::Span;\n@@ -28,15 +28,10 @@ pub fn expand_deriving_copy(cx: &mut ExtCtxt,\n                             mitem: &MetaItem,\n                             item: &Annotatable,\n                             push: &mut FnMut(Annotatable)) {\n-    let mut v = cx.crate_root.map(|s| vec![s]).unwrap_or(Vec::new());\n-    v.push(\"marker\");\n-    v.push(\"Copy\");\n-    let path = Path::new(v);\n-\n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path,\n+        path: path_std!(cx, marker::Copy),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "35def632fc1883ba2ca6ffab1310f0f0b0cd0532", "filename": "src/libsyntax_ext/deriving/clone.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fclone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fclone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fclone.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::path_std;\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -55,7 +56,7 @@ pub fn expand_deriving_clone(cx: &mut ExtCtxt,\n                     }));\n                 }\n                 ItemKind::Union(..) => {\n-                    bounds = vec![Literal(path_std!(cx, core::marker::Copy))];\n+                    bounds = vec![Literal(path_std!(cx, marker::Copy))];\n                     is_shallow = true;\n                     substructure = combine_substructure(Box::new(|c, s, sub| {\n                         cs_clone_shallow(\"Clone\", c, s, sub, true)\n@@ -79,7 +80,7 @@ pub fn expand_deriving_clone(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: path_std!(cx, core::clone::Clone),\n+        path: path_std!(cx, clone::Clone),\n         additional_bounds: bounds,\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "237c8654edf6ea127ca5873be4afba2b6ba6243d", "filename": "src/libsyntax_ext/deriving/cmp/eq.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Feq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Feq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Feq.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::path_std;\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -30,7 +31,7 @@ pub fn expand_deriving_eq(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: path_std!(cx, core::cmp::Eq),\n+        path: path_std!(cx, cmp::Eq),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "1a392ac376537b40aba9cd413d6fd02c3ac5c125", "filename": "src/libsyntax_ext/deriving/cmp/ord.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Ford.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Ford.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Ford.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::path_std;\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -28,7 +29,7 @@ pub fn expand_deriving_ord(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: path_std!(cx, core::cmp::Ord),\n+        path: path_std!(cx, cmp::Ord),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,\n@@ -38,7 +39,7 @@ pub fn expand_deriving_ord(cx: &mut ExtCtxt,\n                           generics: LifetimeBounds::empty(),\n                           explicit_self: borrowed_explicit_self(),\n                           args: vec![borrowed_self()],\n-                          ret_ty: Literal(path_std!(cx, core::cmp::Ordering)),\n+                          ret_ty: Literal(path_std!(cx, cmp::Ordering)),\n                           attributes: attrs,\n                           is_unsafe: false,\n                           unify_fieldless_variants: true,"}, {"sha": "75db7cc1e4c074ab2143adb7496d58985e40fcd2", "filename": "src/libsyntax_ext/deriving/cmp/partial_eq.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Fpartial_eq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Fpartial_eq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Fpartial_eq.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::{path_local, path_std};\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -93,7 +94,7 @@ pub fn expand_deriving_partial_eq(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: path_std!(cx, core::cmp::PartialEq),\n+        path: path_std!(cx, cmp::PartialEq),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "92183c58eb269673bd2e053735d956a37a34793d", "filename": "src/libsyntax_ext/deriving/cmp/partial_ord.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Fpartial_ord.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Fpartial_ord.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fcmp%2Fpartial_ord.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -10,6 +10,7 @@\n \n pub use self::OrderingOp::*;\n \n+use deriving::{path_local, pathvec_std, path_std};\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -45,11 +46,11 @@ pub fn expand_deriving_partial_ord(cx: &mut ExtCtxt,\n         } }\n     }\n \n-    let ordering_ty = Literal(path_std!(cx, core::cmp::Ordering));\n-    let ret_ty = Literal(Path::new_(pathvec_std!(cx, core::option::Option),\n+    let ordering_ty = Literal(path_std!(cx, cmp::Ordering));\n+    let ret_ty = Literal(Path::new_(pathvec_std!(cx, option::Option),\n                                     None,\n                                     vec![Box::new(ordering_ty)],\n-                                    true));\n+                                    PathKind::Std));\n \n     let inline = cx.meta_word(span, Symbol::intern(\"inline\"));\n     let attrs = vec![cx.attribute(span, inline)];\n@@ -84,7 +85,7 @@ pub fn expand_deriving_partial_ord(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span,\n         attributes: vec![],\n-        path: path_std!(cx, core::cmp::PartialOrd),\n+        path: path_std!(cx, cmp::PartialOrd),\n         additional_bounds: vec![],\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "82fc09fca69af733767c1e2e9a4cb7a2e598fa0c", "filename": "src/libsyntax_ext/deriving/debug.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fdebug.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fdebug.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fdebug.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::path_std;\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -24,13 +25,13 @@ pub fn expand_deriving_debug(cx: &mut ExtCtxt,\n                              item: &Annotatable,\n                              push: &mut FnMut(Annotatable)) {\n     // &mut ::std::fmt::Formatter\n-    let fmtr = Ptr(Box::new(Literal(path_std!(cx, core::fmt::Formatter))),\n+    let fmtr = Ptr(Box::new(Literal(path_std!(cx, fmt::Formatter))),\n                    Borrowed(None, ast::Mutability::Mutable));\n \n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: path_std!(cx, core::fmt::Debug),\n+        path: path_std!(cx, fmt::Debug),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,\n@@ -40,7 +41,7 @@ pub fn expand_deriving_debug(cx: &mut ExtCtxt,\n                           generics: LifetimeBounds::empty(),\n                           explicit_self: borrowed_explicit_self(),\n                           args: vec![fmtr],\n-                          ret_ty: Literal(path_std!(cx, core::fmt::Result)),\n+                          ret_ty: Literal(path_std!(cx, fmt::Result)),\n                           attributes: Vec::new(),\n                           is_unsafe: false,\n                           unify_fieldless_variants: false,"}, {"sha": "46dada256b8208c7d1f5bf2ef9f7277068e0b204", "filename": "src/libsyntax_ext/deriving/decodable.rs", "status": "modified", "additions": 6, "deletions": 14, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fdecodable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fdecodable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fdecodable.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -10,7 +10,7 @@\n \n //! The compiler code necessary for `#[derive(Decodable)]`. See encodable.rs for more.\n \n-use deriving;\n+use deriving::{self, pathvec_std};\n use deriving::generic::*;\n use deriving::generic::ty::*;\n use deriving::warn_if_deprecated;\n@@ -46,20 +46,12 @@ fn expand_deriving_decodable_imp(cx: &mut ExtCtxt,\n                                  item: &Annotatable,\n                                  push: &mut FnMut(Annotatable),\n                                  krate: &'static str) {\n-    if cx.crate_root != Some(\"std\") {\n-        // FIXME(#21880): lift this requirement.\n-        cx.span_err(span,\n-                    \"this trait cannot be derived with #![no_std] \\\n-                           or #![no_core]\");\n-        return;\n-    }\n-\n     let typaram = &*deriving::hygienic_type_parameter(item, \"__D\");\n \n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: Path::new_(vec![krate, \"Decodable\"], None, vec![], true),\n+        path: Path::new_(vec![krate, \"Decodable\"], None, vec![], PathKind::Global),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,\n@@ -72,18 +64,18 @@ fn expand_deriving_decodable_imp(cx: &mut ExtCtxt,\n                                             vec![Path::new_(vec![krate, \"Decoder\"],\n                                                             None,\n                                                             vec![],\n-                                                            true)])],\n+                                                            PathKind::Global)])],\n                           },\n                           explicit_self: None,\n                           args: vec![Ptr(Box::new(Literal(Path::new_local(typaram))),\n                                          Borrowed(None, Mutability::Mutable))],\n                           ret_ty:\n-                              Literal(Path::new_(pathvec_std!(cx, core::result::Result),\n+                              Literal(Path::new_(pathvec_std!(cx, result::Result),\n                                                  None,\n                                                  vec![Box::new(Self_), Box::new(Literal(Path::new_(\n-                        vec![typaram, \"Error\"], None, vec![], false\n+                        vec![typaram, \"Error\"], None, vec![], PathKind::Local\n                     )))],\n-                                                 true)),\n+                                                 PathKind::Std)),\n                           attributes: Vec::new(),\n                           is_unsafe: false,\n                           unify_fieldless_variants: false,"}, {"sha": "99e7bb4baeff4bf23dbea2f05179ca36525ef588", "filename": "src/libsyntax_ext/deriving/default.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fdefault.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fdefault.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fdefault.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use deriving::path_std;\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -28,7 +29,7 @@ pub fn expand_deriving_default(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: path_std!(cx, core::default::Default),\n+        path: path_std!(cx, default::Default),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "0e6e96438d8176ffc16065ee9fc21d3d5c41ae1c", "filename": "src/libsyntax_ext/deriving/encodable.rs", "status": "modified", "additions": 9, "deletions": 15, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fencodable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fencodable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fencodable.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -92,7 +92,7 @@\n //! }\n //! ```\n \n-use deriving;\n+use deriving::{self, pathvec_std};\n use deriving::generic::*;\n use deriving::generic::ty::*;\n use deriving::warn_if_deprecated;\n@@ -127,20 +127,12 @@ fn expand_deriving_encodable_imp(cx: &mut ExtCtxt,\n                                  item: &Annotatable,\n                                  push: &mut FnMut(Annotatable),\n                                  krate: &'static str) {\n-    if cx.crate_root != Some(\"std\") {\n-        // FIXME(#21880): lift this requirement.\n-        cx.span_err(span,\n-                    \"this trait cannot be derived with #![no_std] \\\n-                           or #![no_core]\");\n-        return;\n-    }\n-\n     let typaram = &*deriving::hygienic_type_parameter(item, \"__S\");\n \n     let trait_def = TraitDef {\n         span,\n         attributes: Vec::new(),\n-        path: Path::new_(vec![krate, \"Encodable\"], None, vec![], true),\n+        path: Path::new_(vec![krate, \"Encodable\"], None, vec![], PathKind::Global),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,\n@@ -150,19 +142,21 @@ fn expand_deriving_encodable_imp(cx: &mut ExtCtxt,\n                 name: \"encode\",\n                 generics: LifetimeBounds {\n                     lifetimes: Vec::new(),\n-                    bounds: vec![(typaram,\n-                                  vec![Path::new_(vec![krate, \"Encoder\"], None, vec![], true)])]\n+                    bounds: vec![\n+                        (typaram,\n+                         vec![Path::new_(vec![krate, \"Encoder\"], None, vec![], PathKind::Global)])\n+                    ],\n                 },\n                 explicit_self: borrowed_explicit_self(),\n                 args: vec![Ptr(Box::new(Literal(Path::new_local(typaram))),\n                            Borrowed(None, Mutability::Mutable))],\n                 ret_ty: Literal(Path::new_(\n-                    pathvec_std!(cx, core::result::Result),\n+                    pathvec_std!(cx, result::Result),\n                     None,\n                     vec![Box::new(Tuple(Vec::new())), Box::new(Literal(Path::new_(\n-                        vec![typaram, \"Error\"], None, vec![], false\n+                        vec![typaram, \"Error\"], None, vec![], PathKind::Local\n                     )))],\n-                    true\n+                    PathKind::Std\n                 )),\n                 attributes: Vec::new(),\n                 is_unsafe: false,"}, {"sha": "e4faf652389a019245660a93a98259e10f55e110", "filename": "src/libsyntax_ext/deriving/generic/ty.rs", "status": "modified", "additions": 28, "deletions": 10, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fty.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -21,6 +21,8 @@ use syntax::ext::build::AstBuilder;\n use syntax::codemap::respan;\n use syntax::ptr::P;\n use syntax_pos::Span;\n+use syntax_pos::hygiene::SyntaxContext;\n+use syntax_pos::symbol::keywords;\n \n /// The types of pointers\n #[derive(Clone, Eq, PartialEq)]\n@@ -36,29 +38,36 @@ pub enum PtrTy<'a> {\n /// for type parameters and a lifetime.\n #[derive(Clone, Eq, PartialEq)]\n pub struct Path<'a> {\n-    pub path: Vec<&'a str>,\n-    pub lifetime: Option<&'a str>,\n-    pub params: Vec<Box<Ty<'a>>>,\n-    pub global: bool,\n+    path: Vec<&'a str>,\n+    lifetime: Option<&'a str>,\n+    params: Vec<Box<Ty<'a>>>,\n+    kind: PathKind,\n+}\n+\n+#[derive(Clone, Eq, PartialEq)]\n+pub enum PathKind {\n+    Local,\n+    Global,\n+    Std,\n }\n \n impl<'a> Path<'a> {\n     pub fn new<'r>(path: Vec<&'r str>) -> Path<'r> {\n-        Path::new_(path, None, Vec::new(), true)\n+        Path::new_(path, None, Vec::new(), PathKind::Std)\n     }\n     pub fn new_local<'r>(path: &'r str) -> Path<'r> {\n-        Path::new_(vec![path], None, Vec::new(), false)\n+        Path::new_(vec![path], None, Vec::new(), PathKind::Local)\n     }\n     pub fn new_<'r>(path: Vec<&'r str>,\n                     lifetime: Option<&'r str>,\n                     params: Vec<Box<Ty<'r>>>,\n-                    global: bool)\n+                    kind: PathKind)\n                     -> Path<'r> {\n         Path {\n             path,\n             lifetime,\n             params,\n-            global,\n+            kind,\n         }\n     }\n \n@@ -76,11 +85,20 @@ impl<'a> Path<'a> {\n                    self_ty: Ident,\n                    self_generics: &Generics)\n                    -> ast::Path {\n-        let idents = self.path.iter().map(|s| cx.ident_of(*s)).collect();\n+        let mut idents = self.path.iter().map(|s| cx.ident_of(*s)).collect();\n         let lt = mk_lifetimes(cx, span, &self.lifetime);\n         let tys = self.params.iter().map(|t| t.to_ty(cx, span, self_ty, self_generics)).collect();\n \n-        cx.path_all(span, self.global, idents, lt, tys, Vec::new())\n+        match self.kind {\n+            PathKind::Global => cx.path_all(span, true, idents, lt, tys, Vec::new()),\n+            PathKind::Local => cx.path_all(span, false, idents, lt, tys, Vec::new()),\n+            PathKind::Std => {\n+                let def_site = SyntaxContext::empty().apply_mark(cx.current_expansion.mark);\n+                idents.insert(0, Ident { ctxt: def_site, ..keywords::DollarCrate.ident() });\n+                cx.path_all(span, false, idents, lt, tys, Vec::new())\n+            }\n+        }\n+\n     }\n }\n "}, {"sha": "b192ab2527e4b8f04319cfb6e006f3665bff8643", "filename": "src/libsyntax_ext/deriving/hash.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fhash.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fhash.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fhash.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,7 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-use deriving;\n+use deriving::{self, pathvec_std, path_std};\n use deriving::generic::*;\n use deriving::generic::ty::*;\n \n@@ -24,7 +24,7 @@ pub fn expand_deriving_hash(cx: &mut ExtCtxt,\n                             item: &Annotatable,\n                             push: &mut FnMut(Annotatable)) {\n \n-    let path = Path::new_(pathvec_std!(cx, core::hash::Hash), None, vec![], true);\n+    let path = Path::new_(pathvec_std!(cx, hash::Hash), None, vec![], PathKind::Std);\n \n     let typaram = &*deriving::hygienic_type_parameter(item, \"__H\");\n \n@@ -41,7 +41,7 @@ pub fn expand_deriving_hash(cx: &mut ExtCtxt,\n                           name: \"hash\",\n                           generics: LifetimeBounds {\n                               lifetimes: Vec::new(),\n-                              bounds: vec![(typaram, vec![path_std!(cx, core::hash::Hasher)])],\n+                              bounds: vec![(typaram, vec![path_std!(cx, hash::Hasher)])],\n                           },\n                           explicit_self: borrowed_explicit_self(),\n                           args: vec![Ptr(Box::new(Literal(arg)),"}, {"sha": "a6696b533694e9680946442030ac98389f73d741", "filename": "src/libsyntax_ext/deriving/mod.rs", "status": "modified", "additions": 7, "deletions": 23, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Fderiving%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fmod.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -19,32 +19,16 @@ use syntax::ptr::P;\n use syntax::symbol::Symbol;\n use syntax_pos::Span;\n \n-macro_rules! pathvec {\n-    ($($x:ident)::+) => (\n-        vec![ $( stringify!($x) ),+ ]\n-    )\n+macro path_local($x:ident) {\n+    generic::ty::Path::new_local(stringify!($x))\n }\n \n-macro_rules! path_local {\n-    ($x:ident) => (\n-        ::deriving::generic::ty::Path::new_local(stringify!($x))\n-    )\n-}\n-\n-macro_rules! pathvec_std {\n-    ($cx:expr, $first:ident :: $($rest:ident)::+) => ({\n-        let mut v = pathvec![$($rest)::+];\n-        if let Some(s) = $cx.crate_root {\n-            v.insert(0, s);\n-        }\n-        v\n-    })\n-}\n+macro pathvec_std($cx:expr, $($rest:ident)::+) {{\n+    vec![ $( stringify!($rest) ),+ ]\n+}}\n \n-macro_rules! path_std {\n-    ($($x:tt)*) => (\n-        ::deriving::generic::ty::Path::new( pathvec_std!( $($x)* ) )\n-    )\n+macro path_std($($x:tt)*) {\n+    generic::ty::Path::new( pathvec_std!( $($x)* ) )\n }\n \n pub mod bounds;"}, {"sha": "82d6ee5afa05b4aa23b5e8f4c18cdecda47e5a73", "filename": "src/libsyntax_ext/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_ext%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Flib.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -16,6 +16,7 @@\n #![deny(warnings)]\n \n #![feature(proc_macro_internals)]\n+#![feature(decl_macro)]\n \n extern crate fmt_macros;\n #[macro_use]"}, {"sha": "ab6c3f7d62d76c17b0ea0e224f865d6d3acf07df", "filename": "src/libsyntax_pos/hygiene.rs", "status": "modified", "additions": 28, "deletions": 14, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_pos%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Flibsyntax_pos%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fhygiene.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -27,28 +27,34 @@ use std::fmt;\n #[derive(Clone, Copy, PartialEq, Eq, Default, PartialOrd, Ord, Hash)]\n pub struct SyntaxContext(pub(super) u32);\n \n-#[derive(Copy, Clone, Default)]\n+#[derive(Copy, Clone)]\n pub struct SyntaxContextData {\n     pub outer_mark: Mark,\n     pub prev_ctxt: SyntaxContext,\n     pub modern: SyntaxContext,\n }\n \n /// A mark is a unique id associated with a macro expansion.\n-#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug, Default, RustcEncodable, RustcDecodable)]\n+#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug, RustcEncodable, RustcDecodable)]\n pub struct Mark(u32);\n \n-#[derive(Default)]\n struct MarkData {\n     parent: Mark,\n-    modern: bool,\n+    kind: MarkKind,\n     expn_info: Option<ExpnInfo>,\n }\n \n+#[derive(Copy, Clone, PartialEq, Eq)]\n+pub enum MarkKind {\n+    Modern,\n+    Builtin,\n+    Legacy,\n+}\n+\n impl Mark {\n     pub fn fresh(parent: Mark) -> Self {\n         HygieneData::with(|data| {\n-            data.marks.push(MarkData { parent: parent, modern: false, expn_info: None });\n+            data.marks.push(MarkData { parent: parent, kind: MarkKind::Legacy, expn_info: None });\n             Mark(data.marks.len() as u32 - 1)\n         })\n     }\n@@ -77,20 +83,20 @@ impl Mark {\n     pub fn modern(mut self) -> Mark {\n         HygieneData::with(|data| {\n             loop {\n-                if self == Mark::root() || data.marks[self.0 as usize].modern {\n+                if self == Mark::root() || data.marks[self.0 as usize].kind == MarkKind::Modern {\n                     return self;\n                 }\n                 self = data.marks[self.0 as usize].parent;\n             }\n         })\n     }\n \n-    pub fn is_modern(self) -> bool {\n-        HygieneData::with(|data| data.marks[self.0 as usize].modern)\n+    pub fn kind(self) -> MarkKind {\n+        HygieneData::with(|data| data.marks[self.0 as usize].kind)\n     }\n \n-    pub fn set_modern(self) {\n-        HygieneData::with(|data| data.marks[self.0 as usize].modern = true)\n+    pub fn set_kind(self, kind: MarkKind) {\n+        HygieneData::with(|data| data.marks[self.0 as usize].kind = kind)\n     }\n \n     pub fn is_descendant_of(mut self, ancestor: Mark) -> bool {\n@@ -116,8 +122,16 @@ struct HygieneData {\n impl HygieneData {\n     fn new() -> Self {\n         HygieneData {\n-            marks: vec![MarkData::default()],\n-            syntax_contexts: vec![SyntaxContextData::default()],\n+            marks: vec![MarkData {\n+                parent: Mark::root(),\n+                kind: MarkKind::Builtin,\n+                expn_info: None,\n+            }],\n+            syntax_contexts: vec![SyntaxContextData {\n+                outer_mark: Mark::root(),\n+                prev_ctxt: SyntaxContext(0),\n+                modern: SyntaxContext(0),\n+            }],\n             markings: HashMap::new(),\n             gensym_to_ctxt: HashMap::new(),\n         }\n@@ -150,7 +164,7 @@ impl SyntaxContext {\n         HygieneData::with(|data| {\n             data.marks.push(MarkData {\n                 parent: Mark::root(),\n-                modern: false,\n+                kind: MarkKind::Legacy,\n                 expn_info: Some(expansion_info)\n             });\n \n@@ -170,7 +184,7 @@ impl SyntaxContext {\n         HygieneData::with(|data| {\n             let syntax_contexts = &mut data.syntax_contexts;\n             let mut modern = syntax_contexts[self.0 as usize].modern;\n-            if data.marks[mark.0 as usize].modern {\n+            if data.marks[mark.0 as usize].kind == MarkKind::Modern {\n                 modern = *data.markings.entry((modern, mark)).or_insert_with(|| {\n                     let len = syntax_contexts.len() as u32;\n                     syntax_contexts.push(SyntaxContextData {"}, {"sha": "81518b0b87271c85d5168bc4ec076240a604ea35", "filename": "src/test/pretty/issue-4264.pp", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Fpretty%2Fissue-4264.pp", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Fpretty%2Fissue-4264.pp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Fissue-4264.pp?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -40,7 +40,7 @@\n \n \n                   ((::fmt::format as\n-                       for<'r> fn(std::fmt::Arguments<'r>) -> std::string::String {std::fmt::format})(((<::std::fmt::Arguments>::new_v1\n+                       for<'r> fn(std::fmt::Arguments<'r>) -> std::string::String {std::fmt::format})(((<::fmt::Arguments>::new_v1\n                                                                                                            as\n                                                                                                            fn(&[&str], &[std::fmt::ArgumentV1<'_>]) -> std::fmt::Arguments<'_> {std::fmt::Arguments<'_>::new_v1})((&([(\"test\"\n                                                                                                                                                                                                                           as"}, {"sha": "f485982e2d3bc2c1b6eed767e972661e33c88ba6", "filename": "src/test/run-pass-fulldeps/auxiliary/custom_derive_partial_eq.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_partial_eq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_partial_eq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_partial_eq.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -69,7 +69,7 @@ fn expand_deriving_partial_eq(cx: &mut ExtCtxt, span: Span, mitem: &MetaItem, it\n     let trait_def = TraitDef {\n         span: span,\n         attributes: Vec::new(),\n-        path: deriving::generic::ty::Path::new(vec![\"std\", \"cmp\", \"PartialEq\"]),\n+        path: deriving::generic::ty::Path::new(vec![\"cmp\", \"PartialEq\"]),\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds::empty(),\n         is_unsafe: false,"}, {"sha": "449cd29ada3e0b9bf2ea6838876b2617830080af", "filename": "src/test/run-pass-fulldeps/auxiliary/custom_derive_plugin.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_plugin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_plugin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_plugin.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -50,7 +50,7 @@ fn expand(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span: span,\n         attributes: vec![],\n-        path: Path::new(vec![\"TotalSum\"]),\n+        path: Path::new_local(\"TotalSum\"),\n         additional_bounds: vec![],\n         generics: LifetimeBounds::empty(),\n         associated_types: vec![],"}, {"sha": "1a9358f22bfce683852781886e16ff18ea7e5e73", "filename": "src/test/run-pass-fulldeps/auxiliary/custom_derive_plugin_attr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_plugin_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_plugin_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fcustom_derive_plugin_attr.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -46,7 +46,7 @@ fn expand(cx: &mut ExtCtxt,\n     let trait_def = TraitDef {\n         span: span,\n         attributes: vec![],\n-        path: Path::new(vec![\"TotalSum\"]),\n+        path: Path::new_local(\"TotalSum\"),\n         additional_bounds: vec![],\n         generics: LifetimeBounds::empty(),\n         associated_types: vec![],"}, {"sha": "a0747e0fbf59f9d94081d7173fdcf2ef212899fb", "filename": "src/test/run-pass-fulldeps/derive-no-std-not-supported.rs", "status": "renamed", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fderive-no-std-not-supported.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dfbc88a626625be01e112da11ec367e2fc71bb3/src%2Ftest%2Frun-pass-fulldeps%2Fderive-no-std-not-supported.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fderive-no-std-not-supported.rs?ref=3dfbc88a626625be01e112da11ec367e2fc71bb3", "patch": "@@ -8,22 +8,22 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+#![feature(rustc_private)]\n #![no_std]\n \n extern crate serialize as rustc_serialize;\n \n-#[derive(RustcEncodable)]  //~ ERROR this trait cannot be derived\n+#[derive(RustcEncodable)]\n struct Bar {\n     x: u32,\n }\n \n-#[derive(RustcDecodable)]  //~ ERROR this trait cannot be derived\n+#[derive(RustcDecodable)]\n struct Baz {\n     x: u32,\n }\n \n fn main() {\n-    Foo { x: 0 };\n     Bar { x: 0 };\n     Baz { x: 0 };\n }", "previous_filename": "src/test/compile-fail-fulldeps/derive-no-std-not-supported.rs"}]}