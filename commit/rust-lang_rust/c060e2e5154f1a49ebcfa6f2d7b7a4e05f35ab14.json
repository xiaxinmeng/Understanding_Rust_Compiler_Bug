{"sha": "c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwNjBlMmU1MTU0ZjFhNDllYmNmYTZmMmQ3YjdhNGUwNWYzNWFiMTQ=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2014-03-27T01:51:55Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2014-03-27T01:52:23Z"}, "message": "install: Don't allow installation over the install files", "tree": {"sha": "81e1c2c557f73b84a923f7bd4fbe0e8fa7b3f4ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81e1c2c557f73b84a923f7bd4fbe0e8fa7b3f4ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14", "html_url": "https://github.com/rust-lang/rust/commit/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "92d0ec2ec7d71c5e42f6a6682b081b8ef6212913", "url": "https://api.github.com/repos/rust-lang/rust/commits/92d0ec2ec7d71c5e42f6a6682b081b8ef6212913", "html_url": "https://github.com/rust-lang/rust/commit/92d0ec2ec7d71c5e42f6a6682b081b8ef6212913"}], "stats": {"total": 21, "additions": 16, "deletions": 5}, "files": [{"sha": "92990767d084a792c1316f907afb3a30ec535fe9", "filename": "mk/dist.mk", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14/mk%2Fdist.mk", "raw_url": "https://github.com/rust-lang/rust/raw/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14/mk%2Fdist.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fdist.mk?ref=c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14", "patch": "@@ -199,10 +199,9 @@ dist-install-dir-$(1): PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)\n dist-install-dir-$(1): PREPARE_MAN_CMD=$(DEFAULT_PREPARE_MAN_CMD)\n dist-install-dir-$(1): PREPARE_CLEAN=true\n dist-install-dir-$(1): prepare-base-dir-$(1)\n-# Write the install manifest, making sure the manifest contains itself\n-\t$$(Q)touch $$(PREPARE_DEST_DIR)/$$(CFG_LIBDIR_RELATIVE)/rustlib/manifest-$(1).in\n \t$$(Q)(cd $$(PREPARE_DEST_DIR)/ && find -type f | sed 's/^\\.\\///') \\\n-      > $$(PREPARE_DEST_DIR)/$$(CFG_LIBDIR_RELATIVE)/rustlib/manifest-$(1).in\n+      > tmp/dist/manifest-$(1).in\n+\t$$(Q)mv tmp/dist/manifest-$(1).in $$(PREPARE_DEST_DIR)/$$(CFG_LIBDIR_RELATIVE)/rustlib/manifest.in\n # Add remaining non-installed files\n \t$$(Q)$$(PREPARE_MAN_CMD) $$(S)COPYRIGHT $$(PREPARE_DEST_DIR)\n \t$$(Q)$$(PREPARE_MAN_CMD) $$(S)LICENSE-APACHE $$(PREPARE_DEST_DIR)"}, {"sha": "3a1ba91d01f23c377c533e1c5dd387daa239e152", "filename": "src/etc/install.sh", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14/src%2Fetc%2Finstall.sh", "raw_url": "https://github.com/rust-lang/rust/raw/c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14/src%2Fetc%2Finstall.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Finstall.sh?ref=c060e2e5154f1a49ebcfa6f2d7b7a4e05f35ab14", "patch": "@@ -227,17 +227,29 @@ fi\n step_msg \"validating $CFG_SELF args\"\n validate_opt\n \n+\n+# OK, let's get installing ...\n+\n # Sanity check: can we can write to the destination?\n umask 022 && mkdir -p \"${CFG_LIBDIR}\"\n-need_ok \"can't write to destination. consider `sudo`.\"\n+need_ok \"can't write to destination. consider 'sudo'.\"\n touch \"${CFG_LIBDIR}/rust-install-probe\" 2> /dev/null\n if [ $? -ne 0 ]\n then\n-    err \"can't write to destination. consider `sudo`.\"\n+    err \"can't write to destination. consider 'sudo'.\"\n fi\n rm \"${CFG_LIBDIR}/rust-install-probe\"\n need_ok \"failed to remove install probe\"\n \n+# Sanity check: don't install to the directory containing the installer.\n+# That would surely cause chaos.\n+INSTALLER_DIR=\"$(cd $(dirname $0) && pwd)\"\n+PREFIX_DIR=\"$(cd ${CFG_PREFIX} && pwd)\"\n+if [ \"${INSTALLER_DIR}\" = \"${PREFIX_DIR}\" ]\n+then\n+    err \"can't install to same directory as installer\"\n+fi\n+\n # The file name of the manifest we're going to create during install\n INSTALLED_MANIFEST=\"${CFG_LIBDIR}/rustlib/manifest\"\n "}]}