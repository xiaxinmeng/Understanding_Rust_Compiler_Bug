{"sha": "b4446cdd06caa32e1e9e255312a15feb770d4935", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0NDQ2Y2RkMDZjYWEzMmUxZTllMjU1MzEyYTE1ZmViNzcwZDQ5MzU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-15T12:13:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-15T12:13:01Z"}, "message": "Merge #8025\n\n8025: Goto definition works for `S { a: }` case r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "5a9d98a215a2adf82dbd2d3c9b74602e0c7debf8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5a9d98a215a2adf82dbd2d3c9b74602e0c7debf8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b4446cdd06caa32e1e9e255312a15feb770d4935", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgT09NCRBK7hj4Ov3rIwAAdHIIAFIiInKveRwrT/dLvHBbI2b9\nanH808Llo0MA6kjHNId7OdiQ8AschQn6QgDb0pP+inXZxeZki0KrkbcxG5xIVTvl\n0OLjoZYx0fPgaHU1auKXxPUYvVMwbe1nrPYEP7p1Q/GdeqoD06CuitEEuxMCSTzr\nJLvftMSq5DNmpnJwWHIHMRUncqXu/WwPj4I6uwQ0c4hBUPw2MCSs0mnvzdD47JYn\n7g0tMmRX/CbCqzWMaceEb7j6oUKAevF0K/0II5DAXsmhwOvSz1s02KVYxKFRnn44\n3gus0TikaPOHSQi3+0NguAHB3yK35M15B8sdXxDxCQv5E6lhiwouxXNYUu/PO3k=\n=C6BE\n-----END PGP SIGNATURE-----\n", "payload": "tree 5a9d98a215a2adf82dbd2d3c9b74602e0c7debf8\nparent 5138baf2ac742de601f29d22fc64e386da56c4c2\nparent af2366acdf1321702e54e01c88052ed5a674716c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1615810381 +0000\ncommitter GitHub <noreply@github.com> 1615810381 +0000\n\nMerge #8025\n\n8025: Goto definition works for `S { a: }` case r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b4446cdd06caa32e1e9e255312a15feb770d4935", "html_url": "https://github.com/rust-lang/rust/commit/b4446cdd06caa32e1e9e255312a15feb770d4935", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b4446cdd06caa32e1e9e255312a15feb770d4935/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5138baf2ac742de601f29d22fc64e386da56c4c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/5138baf2ac742de601f29d22fc64e386da56c4c2", "html_url": "https://github.com/rust-lang/rust/commit/5138baf2ac742de601f29d22fc64e386da56c4c2"}, {"sha": "af2366acdf1321702e54e01c88052ed5a674716c", "url": "https://api.github.com/repos/rust-lang/rust/commits/af2366acdf1321702e54e01c88052ed5a674716c", "html_url": "https://github.com/rust-lang/rust/commit/af2366acdf1321702e54e01c88052ed5a674716c"}], "stats": {"total": 36, "additions": 33, "deletions": 3}, "files": [{"sha": "055a3e5d0c7c30808d575905edbf20529a4aa5e5", "filename": "crates/hir/src/source_analyzer.rs", "status": "modified", "additions": 22, "deletions": 3, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b4446cdd06caa32e1e9e255312a15feb770d4935/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4446cdd06caa32e1e9e255312a15feb770d4935/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs?ref=b4446cdd06caa32e1e9e255312a15feb770d4935", "patch": "@@ -24,7 +24,7 @@ use hir_ty::{\n };\n use syntax::{\n     ast::{self, AstNode},\n-    SyntaxNode, TextRange, TextSize,\n+    AstPtr, SyntaxNode, TextRange, TextSize,\n };\n \n use crate::{\n@@ -161,8 +161,27 @@ impl SourceAnalyzer {\n         db: &dyn HirDatabase,\n         field: &ast::RecordExprField,\n     ) -> Option<(Field, Option<Local>)> {\n-        let expr = field.expr()?;\n-        let expr_id = self.expr_id(db, &expr)?;\n+        let expr_id = {\n+            let record_lit = field.parent_record_lit();\n+            let record_lit_expr = self.expr_id(db, &ast::Expr::from(record_lit))?;\n+            let body = self.body.as_ref()?;\n+            let body_source_map = self.body_source_map.as_ref()?;\n+            match &body[record_lit_expr] {\n+                hir_def::expr::Expr::RecordLit { fields, .. } => {\n+                    let field_ptr = InFile::new(self.file_id, AstPtr::new(field));\n+                    fields.iter().enumerate().find_map(|(i, f)| {\n+                        let ptr = body_source_map.field_syntax(record_lit_expr, i);\n+                        if ptr == field_ptr {\n+                            Some(f.expr)\n+                        } else {\n+                            None\n+                        }\n+                    })?\n+                }\n+                _ => return None,\n+            }\n+        };\n+\n         let local = if field.name_ref().is_some() {\n             None\n         } else {"}, {"sha": "e8f31e4b1be5b751ed02bf53def591f5e1c51e0c", "filename": "crates/ide/src/goto_definition.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b4446cdd06caa32e1e9e255312a15feb770d4935/crates%2Fide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4446cdd06caa32e1e9e255312a15feb770d4935/crates%2Fide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fgoto_definition.rs?ref=b4446cdd06caa32e1e9e255312a15feb770d4935", "patch": "@@ -1158,6 +1158,17 @@ struct S;\n \n //- /m.rs\n //! [`super::S$0`]\n+\"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn goto_incomplete_field() {\n+        check(\n+            r#\"\n+struct A { a: u32 }\n+         //^\n+fn foo() { A { a$0: }; }\n \"#,\n         )\n     }"}]}