{"sha": "a5288a7803e52d75d9101bb47225b187fd88272f", "node_id": "C_kwDOAAsO6NoAKGE1Mjg4YTc4MDNlNTJkNzVkOTEwMWJiNDcyMjViMTg3ZmQ4ODI3MmY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-06T20:16:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-06T20:16:41Z"}, "message": "Rollup merge of #107692 - Swatinem:printsizeyield, r=compiler-errors\n\nSort Generator `print-type-sizes` according to their yield points\n\nEspecially when trying to diagnose runaway future sizes, it might be more intuitive to sort the variants according to the control flow (aka their yield points) rather than the size of the variants.", "tree": {"sha": "0d9c4fedb5034fcdee780c1b24f538f2eddd7179", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0d9c4fedb5034fcdee780c1b24f538f2eddd7179"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a5288a7803e52d75d9101bb47225b187fd88272f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj4WApCRBK7hj4Ov3rIwAAefkIAG6S19R0YURqN9jZd2Ze9Dxr\nkAw7pdlUcb13yCZh4CiGzf5SnusA1a8VYeMVP/kSfZey5KknXTACl4EeEVlVDITl\n/JWTfVSFJiJyyknc6O6l0tHQ55vjVxoeKkay9VNUEWtuyvZ6HEmxxI92ceMKkmIh\nGdaZbuwGdfUDNWOkBaTFkgqG+v2/it0aYKtm7kT5GAa5M5mL1vxHhPGVO/oz7XaB\n1QAorUyOhqcq2r3U+xWxPTH1Sdons4K90+0E5a5AHz/3GLtsAFnX+HzQIzWN7qx/\ntc1OQ3fasaFfO0z9vxESUVysMC7ga8fJ80aLn0WQ0y/RxjSKiTBhbZxKWIekTrY=\n=6n4R\n-----END PGP SIGNATURE-----\n", "payload": "tree 0d9c4fedb5034fcdee780c1b24f538f2eddd7179\nparent 64db7fb115d93672649635b67e94193117e64e02\nparent dae00152e7d95c98a085d56583415551acb9151c\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1675714601 +0100\ncommitter GitHub <noreply@github.com> 1675714601 +0100\n\nRollup merge of #107692 - Swatinem:printsizeyield, r=compiler-errors\n\nSort Generator `print-type-sizes` according to their yield points\n\nEspecially when trying to diagnose runaway future sizes, it might be more intuitive to sort the variants according to the control flow (aka their yield points) rather than the size of the variants.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a5288a7803e52d75d9101bb47225b187fd88272f", "html_url": "https://github.com/rust-lang/rust/commit/a5288a7803e52d75d9101bb47225b187fd88272f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a5288a7803e52d75d9101bb47225b187fd88272f/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64db7fb115d93672649635b67e94193117e64e02", "url": "https://api.github.com/repos/rust-lang/rust/commits/64db7fb115d93672649635b67e94193117e64e02", "html_url": "https://github.com/rust-lang/rust/commit/64db7fb115d93672649635b67e94193117e64e02"}, {"sha": "dae00152e7d95c98a085d56583415551acb9151c", "url": "https://api.github.com/repos/rust-lang/rust/commits/dae00152e7d95c98a085d56583415551acb9151c", "html_url": "https://github.com/rust-lang/rust/commit/dae00152e7d95c98a085d56583415551acb9151c"}], "stats": {"total": 37, "additions": 25, "deletions": 12}, "files": [{"sha": "55178250472ef94bc08d45ba429ea02f7f83458b", "filename": "compiler/rustc_session/src/code_stats.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a5288a7803e52d75d9101bb47225b187fd88272f/compiler%2Frustc_session%2Fsrc%2Fcode_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5288a7803e52d75d9101bb47225b187fd88272f/compiler%2Frustc_session%2Fsrc%2Fcode_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fcode_stats.rs?ref=a5288a7803e52d75d9101bb47225b187fd88272f", "patch": "@@ -84,7 +84,11 @@ impl CodeStats {\n         // Sort variants so the largest ones are shown first. A stable sort is\n         // used here so that source code order is preserved for all variants\n         // that have the same size.\n-        variants.sort_by(|info1, info2| info2.size.cmp(&info1.size));\n+        // Except for Generators, whose variants are already sorted according to\n+        // their yield points in `variant_info_for_generator`.\n+        if kind != DataTypeKind::Generator {\n+            variants.sort_by(|info1, info2| info2.size.cmp(&info1.size));\n+        }\n         let info = TypeSizeInfo {\n             kind,\n             type_description: type_desc.to_string(),"}, {"sha": "2aeb255c1641c61b6329110582aa8bd8ea06808d", "filename": "compiler/rustc_ty_utils/src/layout.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a5288a7803e52d75d9101bb47225b187fd88272f/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5288a7803e52d75d9101bb47225b187fd88272f/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs?ref=a5288a7803e52d75d9101bb47225b187fd88272f", "patch": "@@ -970,7 +970,7 @@ fn variant_info_for_generator<'tcx>(\n         })\n         .collect();\n \n-    let variant_infos: Vec<_> = generator\n+    let mut variant_infos: Vec<_> = generator\n         .variant_fields\n         .iter_enumerated()\n         .map(|(variant_idx, variant_def)| {\n@@ -1033,6 +1033,15 @@ fn variant_info_for_generator<'tcx>(\n             }\n         })\n         .collect();\n+\n+    // The first three variants are hardcoded to be `UNRESUMED`, `RETURNED` and `POISONED`.\n+    // We will move the `RETURNED` and `POISONED` elements to the end so we\n+    // are left with a sorting order according to the generators yield points:\n+    // First `Unresumed`, then the `SuspendN` followed by `Returned` and `Panicked` (POISONED).\n+    let end_states = variant_infos.drain(1..=2);\n+    let end_states: Vec<_> = end_states.collect();\n+    variant_infos.extend(end_states);\n+\n     (\n         variant_infos,\n         match tag_encoding {"}, {"sha": "91db4b1531f541177ba1944d798f9d68b9fc24e0", "filename": "tests/ui/async-await/future-sizes/large-arg.stdout", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Flarge-arg.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Flarge-arg.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Flarge-arg.stdout?ref=a5288a7803e52d75d9101bb47225b187fd88272f", "patch": "@@ -1,17 +1,17 @@\n print-type-size type: `[async fn body@$DIR/large-arg.rs:6:21: 8:2]`: 3076 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Suspend0`: 3075 bytes\n print-type-size         local `.__awaitee`: 3075 bytes, offset: 0 bytes, alignment: 1 bytes\n-print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Returned`: 0 bytes\n print-type-size     variant `Panicked`: 0 bytes\n print-type-size type: `[async fn body@$DIR/large-arg.rs:10:30: 12:2]`: 3075 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 1024 bytes\n+print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Suspend0`: 3074 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size         local `.__awaitee`: 2050 bytes\n-print-type-size     variant `Unresumed`: 1024 bytes\n-print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 1024 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 1024 bytes\n@@ -24,11 +24,11 @@ print-type-size         field `.uninit`: 0 bytes\n print-type-size         field `.value`: 3075 bytes\n print-type-size type: `[async fn body@$DIR/large-arg.rs:13:26: 15:2]`: 2050 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 1024 bytes\n+print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Suspend0`: 2049 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size         local `.__awaitee`: 1025 bytes\n-print-type-size     variant `Unresumed`: 1024 bytes\n-print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 1024 bytes\n print-type-size         upvar `.t`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 1024 bytes"}, {"sha": "8fe936efc8983ed96b21ecdb7ef781b6227cbe39", "filename": "tests/ui/print_type_sizes/async.stdout", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fprint_type_sizes%2Fasync.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fprint_type_sizes%2Fasync.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_type_sizes%2Fasync.stdout?ref=a5288a7803e52d75d9101bb47225b187fd88272f", "patch": "@@ -1,11 +1,11 @@\n print-type-size type: `[async fn body@$DIR/async.rs:8:36: 11:2]`: 16386 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 8192 bytes\n+print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Suspend0`: 16385 bytes\n print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size         local `.arg`: 8192 bytes\n print-type-size         local `.__awaitee`: 1 bytes\n-print-type-size     variant `Unresumed`: 8192 bytes\n-print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 8192 bytes\n print-type-size         upvar `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 8192 bytes"}, {"sha": "7c58d6ce5ffa1e79785cd7577cbe5174c8d8f082", "filename": "tests/ui/print_type_sizes/generator.stdout", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fprint_type_sizes%2Fgenerator.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fprint_type_sizes%2Fgenerator.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_type_sizes%2Fgenerator.stdout?ref=a5288a7803e52d75d9101bb47225b187fd88272f", "patch": "@@ -2,9 +2,9 @@ print-type-size type: `[generator@$DIR/generator.rs:10:5: 10:14]`: 8193 bytes, a\n print-type-size     discriminant: 1 bytes\n print-type-size     variant `Unresumed`: 8192 bytes\n print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size     variant `Suspend0`: 8192 bytes\n+print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Returned`: 8192 bytes\n print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n print-type-size     variant `Panicked`: 8192 bytes\n print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n-print-type-size     variant `Suspend0`: 8192 bytes\n-print-type-size         upvar `.array`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes"}, {"sha": "f2a11c7a33bab49c2d8f343d8fb63f610be500dc", "filename": "tests/ui/print_type_sizes/generator_discr_placement.stdout", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/a5288a7803e52d75d9101bb47225b187fd88272f/tests%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout?ref=a5288a7803e52d75d9101bb47225b187fd88272f", "patch": "@@ -1,11 +1,11 @@\n print-type-size type: `[generator@$DIR/generator_discr_placement.rs:11:13: 11:15]`: 8 bytes, alignment: 4 bytes\n print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Suspend0`: 7 bytes\n print-type-size         padding: 3 bytes\n print-type-size         local `.w`: 4 bytes, alignment: 4 bytes\n print-type-size     variant `Suspend1`: 7 bytes\n print-type-size         padding: 3 bytes\n print-type-size         local `.z`: 4 bytes, alignment: 4 bytes\n-print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Returned`: 0 bytes\n print-type-size     variant `Panicked`: 0 bytes"}]}