{"sha": "aab2cca046670295bc1a430a8b1c23d755f9bd5a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhYjJjY2EwNDY2NzAyOTViYzFhNDMwYThiMWMyM2Q3NTVmOWJkNWE=", "commit": {"author": {"name": "Taylor Cramer", "email": "cramertaylorj@gmail.com", "date": "2017-03-27T22:55:56Z"}, "committer": {"name": "Taylor Cramer", "email": "cramertaylorj@gmail.com", "date": "2017-04-04T14:46:18Z"}, "message": "On-demandify reachability", "tree": {"sha": "b34e5e1082a2f569e1d3e34267834736fd8052d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b34e5e1082a2f569e1d3e34267834736fd8052d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aab2cca046670295bc1a430a8b1c23d755f9bd5a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aab2cca046670295bc1a430a8b1c23d755f9bd5a", "html_url": "https://github.com/rust-lang/rust/commit/aab2cca046670295bc1a430a8b1c23d755f9bd5a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aab2cca046670295bc1a430a8b1c23d755f9bd5a/comments", "author": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5309a3e31d88def1f3ea966162ed4f81f161d500", "url": "https://api.github.com/repos/rust-lang/rust/commits/5309a3e31d88def1f3ea966162ed4f81f161d500", "html_url": "https://github.com/rust-lang/rust/commit/5309a3e31d88def1f3ea966162ed4f81f161d500"}], "stats": {"total": 30, "additions": 27, "deletions": 3}, "files": [{"sha": "e5dd48534a6a136ad452e09c9a01226dd1f7196e", "filename": "src/librustc/middle/reachable.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/aab2cca046670295bc1a430a8b1c23d755f9bd5a/src%2Flibrustc%2Fmiddle%2Freachable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aab2cca046670295bc1a430a8b1c23d755f9bd5a/src%2Flibrustc%2Fmiddle%2Freachable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Freachable.rs?ref=aab2cca046670295bc1a430a8b1c23d755f9bd5a", "patch": "@@ -15,11 +15,11 @@\n // makes all other generics or inline functions that it references\n // reachable as well.\n \n-use dep_graph::DepNode;\n use hir::map as hir_map;\n use hir::def::Def;\n-use hir::def_id::DefId;\n+use hir::def_id::{DefId, CrateNum};\n use ty::{self, TyCtxt};\n+use ty::maps::Providers;\n use middle::privacy;\n use session::config;\n use util::nodemap::{NodeSet, FxHashSet};\n@@ -362,7 +362,11 @@ impl<'a, 'tcx: 'a> ItemLikeVisitor<'tcx> for CollectPrivateImplItemsVisitor<'a,\n }\n \n pub fn find_reachable<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) -> NodeSet {\n-    let _task = tcx.dep_graph.in_task(DepNode::Reachability);\n+    ty::queries::reachable_set::get(tcx, DUMMY_SP, LOCAL_CRATE)\n+}\n+\n+fn reachable_set<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, crate_num: CrateNum) -> NodeSet {\n+    debug_assert!(crate_num == LOCAL_CRATE);\n \n     let access_levels = &ty::queries::privacy_access_levels::get(tcx, DUMMY_SP, LOCAL_CRATE);\n \n@@ -408,3 +412,10 @@ pub fn find_reachable<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) -> NodeSet {\n     // Return the set of reachable symbols.\n     reachable_context.reachable_symbols\n }\n+\n+pub fn provide(providers: &mut Providers) {\n+    *providers = Providers {\n+        reachable_set,\n+        ..*providers\n+    };\n+}"}, {"sha": "823bdc9e092ac8290801a25a1b8b3e7ac83a61dd", "filename": "src/librustc/ty/maps.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/aab2cca046670295bc1a430a8b1c23d755f9bd5a/src%2Flibrustc%2Fty%2Fmaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aab2cca046670295bc1a430a8b1c23d755f9bd5a/src%2Flibrustc%2Fty%2Fmaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps.rs?ref=aab2cca046670295bc1a430a8b1c23d755f9bd5a", "patch": "@@ -15,6 +15,7 @@ use middle::privacy::AccessLevels;\n use mir;\n use session::CompileResult;\n use ty::{self, CrateInherentImpls, Ty, TyCtxt};\n+use util::nodemap::NodeSet;\n \n use rustc_data_structures::indexed_vec::IndexVec;\n use std::cell::{RefCell, RefMut};\n@@ -209,6 +210,11 @@ impl<'tcx> QueryDescription for queries::typeck_item_bodies<'tcx> {\n     }\n }\n \n+impl<'tcx> QueryDescription for queries::reachable_set<'tcx> {\n+    fn describe(_: TyCtxt, _: CrateNum) -> String {\n+        format!(\"reachability\")\n+    }\n+}\n \n macro_rules! define_maps {\n     (<$tcx:tt>\n@@ -440,6 +446,8 @@ define_maps! { <'tcx>\n     /// Performs the privacy check and computes \"access levels\".\n     pub privacy_access_levels: PrivacyAccessLevels(CrateNum) -> Rc<AccessLevels>,\n \n+    pub reachable_set: reachability_dep_node(CrateNum) -> NodeSet,\n+\n     pub mir_shims: mir_shim(ty::InstanceDef<'tcx>) -> &'tcx RefCell<mir::Mir<'tcx>>\n }\n \n@@ -451,6 +459,10 @@ fn crate_inherent_impls_dep_node(_: CrateNum) -> DepNode<DefId> {\n     DepNode::Coherence\n }\n \n+fn reachability_dep_node(_: CrateNum) -> DepNode<DefId> {\n+    DepNode::Reachability\n+}\n+\n fn mir_shim(instance: ty::InstanceDef) -> DepNode<DefId> {\n     instance.dep_node()\n }"}, {"sha": "3f99d5123c9e8681c8468db58f2caf0e2f42394e", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aab2cca046670295bc1a430a8b1c23d755f9bd5a/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aab2cca046670295bc1a430a8b1c23d755f9bd5a/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=aab2cca046670295bc1a430a8b1c23d755f9bd5a", "patch": "@@ -889,6 +889,7 @@ pub fn phase_3_run_analysis_passes<'tcx, F, R>(sess: &'tcx Session,\n     rustc_privacy::provide(&mut local_providers);\n     typeck::provide(&mut local_providers);\n     ty::provide(&mut local_providers);\n+    reachable::provide(&mut local_providers);\n \n     let mut extern_providers = ty::maps::Providers::default();\n     cstore::provide(&mut extern_providers);"}]}