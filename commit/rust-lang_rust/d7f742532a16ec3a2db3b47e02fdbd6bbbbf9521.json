{"sha": "d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "node_id": "C_kwDOAAsO6NoAKGQ3Zjc0MjUzMmExNmVjM2EyZGIzYjQ3ZTAyZmRiZDZiYmJiZjk1MjE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-14T06:21:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-14T06:21:39Z"}, "message": "Rollup merge of #111477 - y21:extra-impl-in-trait-impl, r=compiler-errors\n\nbetter diagnostics for `impl<..> impl Trait for Type`\n\nFixes #109963", "tree": {"sha": "e2914700b1046ac7c003ace870c62ae5150988ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2914700b1046ac7c003ace870c62ae5150988ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkYH3zCRBK7hj4Ov3rIwAAkeQIAKHUa31QFPvwO72yddi5Gm7f\nDFMugwCQu9xvjHEZghyr0L8qxd23ZqYbapMFsLVEuj4Ud2Vx/n440K1AzzyJIu5V\ninA8S/W/6CQ6S90CcVlsf260OswmlRA62YvGpQ8NG14TNk7uCv6s25jLWlNGyWod\nis2k2FijpteWVbCEKjPdnbUj34z3Zki/8GHb0txnlLqGdzNwykkQgZIm3TckfoEd\nNKlGE/4ZCyfD9Vaujo2O1n5VhkmYu16I8A5wAAaODA7y7v6GqOvGX67oMj0qZosT\ngE1YY5NhDfw5gGdUy0sxx+OLoSf96VSudCPOPcBGgwMQVs1zRfSGLv68FDiFjAs=\n=1dc9\n-----END PGP SIGNATURE-----\n", "payload": "tree e2914700b1046ac7c003ace870c62ae5150988ce\nparent 0b8f2bfe5f9f405162cfeaea9753c020885f2efb\nparent 7fe83345ef0204eedd8ac3847a527466f6853c0b\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1684045299 +0200\ncommitter GitHub <noreply@github.com> 1684045299 +0200\n\nRollup merge of #111477 - y21:extra-impl-in-trait-impl, r=compiler-errors\n\nbetter diagnostics for `impl<..> impl Trait for Type`\n\nFixes #109963\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "html_url": "https://github.com/rust-lang/rust/commit/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b8f2bfe5f9f405162cfeaea9753c020885f2efb", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b8f2bfe5f9f405162cfeaea9753c020885f2efb", "html_url": "https://github.com/rust-lang/rust/commit/0b8f2bfe5f9f405162cfeaea9753c020885f2efb"}, {"sha": "7fe83345ef0204eedd8ac3847a527466f6853c0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/7fe83345ef0204eedd8ac3847a527466f6853c0b", "html_url": "https://github.com/rust-lang/rust/commit/7fe83345ef0204eedd8ac3847a527466f6853c0b"}], "stats": {"total": 101, "additions": 97, "deletions": 4}, "files": [{"sha": "2d0f466e236cea87c8cd6ef5f68f04e259c0552e", "filename": "compiler/rustc_parse/messages.ftl", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/compiler%2Frustc_parse%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/compiler%2Frustc_parse%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fmessages.ftl?ref=d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "patch": "@@ -478,6 +478,11 @@ parse_missing_for_in_trait_impl = missing `for` in a trait impl\n \n parse_expected_trait_in_trait_impl_found_type = expected a trait, found type\n \n+parse_extra_impl_keyword_in_trait_impl = unexpected `impl` keyword\n+    .suggestion = remove the extra `impl`\n+    .note = this is parsed as an `impl Trait` type, but a trait is expected at this position\n+\n+\n parse_non_item_in_item_list = non-item in item list\n     .suggestion_use_const_not_let = consider using `const` instead of `let` for associated const\n     .label_list_start = item list starts here"}, {"sha": "84494eab855c4ffcedbd08b2be79517c083be1eb", "filename": "compiler/rustc_parse/src/errors.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/compiler%2Frustc_parse%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/compiler%2Frustc_parse%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Ferrors.rs?ref=d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "patch": "@@ -1519,6 +1519,16 @@ pub(crate) struct ExpectedTraitInTraitImplFoundType {\n     pub span: Span,\n }\n \n+#[derive(Diagnostic)]\n+#[diag(parse_extra_impl_keyword_in_trait_impl)]\n+pub(crate) struct ExtraImplKeywordInTraitImpl {\n+    #[primary_span]\n+    #[suggestion(code = \"\", applicability = \"maybe-incorrect\")]\n+    pub extra_impl_kw: Span,\n+    #[note]\n+    pub impl_trait_span: Span,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(parse_bounds_not_allowed_on_trait_aliases)]\n pub(crate) struct BoundsNotAllowedOnTraitAliases {"}, {"sha": "dc18d400f1e9d1059195c623f78982ab64e86807", "filename": "compiler/rustc_parse/src/parser/item.rs", "status": "modified", "additions": 18, "deletions": 4, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs?ref=d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "patch": "@@ -603,10 +603,24 @@ impl<'a> Parser<'a> {\n                 let path = match ty_first.kind {\n                     // This notably includes paths passed through `ty` macro fragments (#46438).\n                     TyKind::Path(None, path) => path,\n-                    _ => {\n-                        self.sess.emit_err(errors::ExpectedTraitInTraitImplFoundType {\n-                            span: ty_first.span,\n-                        });\n+                    other => {\n+                        if let TyKind::ImplTrait(_, bounds) = other\n+                            && let [bound] = bounds.as_slice()\n+                        {\n+                            // Suggest removing extra `impl` keyword:\n+                            // `impl<T: Default> impl Default for Wrapper<T>`\n+                            //                   ^^^^^\n+                            let extra_impl_kw = ty_first.span.until(bound.span());\n+                            self.sess\n+                                .emit_err(errors::ExtraImplKeywordInTraitImpl {\n+                                    extra_impl_kw,\n+                                    impl_trait_span: ty_first.span\n+                                });\n+                        } else {\n+                            self.sess.emit_err(errors::ExpectedTraitInTraitImplFoundType {\n+                                span: ty_first.span,\n+                            });\n+                        }\n                         err_path(ty_first.span)\n                     }\n                 };"}, {"sha": "cd4f2610d3f04c6a088d2be38617cf2317c694e0", "filename": "tests/ui/impl-trait/extra-impl-in-trait-impl.fixed", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.fixed?ref=d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "patch": "@@ -0,0 +1,19 @@\n+// run-rustfix\n+\n+struct S<T>(T);\n+struct S2;\n+\n+impl<T: Default> Default for S<T> {\n+    //~^ ERROR: unexpected `impl` keyword\n+    //~| HELP: remove the extra `impl`\n+    fn default() -> Self { todo!() }\n+}\n+\n+impl Default for S2 {\n+    //~^ ERROR: unexpected `impl` keyword\n+    //~| HELP: remove the extra `impl`\n+    fn default() -> Self { todo!() }\n+}\n+\n+\n+fn main() {}"}, {"sha": "024b703e6f23549103d0170724892b7b5c8a4f9c", "filename": "tests/ui/impl-trait/extra-impl-in-trait-impl.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.rs?ref=d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "patch": "@@ -0,0 +1,19 @@\n+// run-rustfix\n+\n+struct S<T>(T);\n+struct S2;\n+\n+impl<T: Default> impl Default for S<T> {\n+    //~^ ERROR: unexpected `impl` keyword\n+    //~| HELP: remove the extra `impl`\n+    fn default() -> Self { todo!() }\n+}\n+\n+impl impl Default for S2 {\n+    //~^ ERROR: unexpected `impl` keyword\n+    //~| HELP: remove the extra `impl`\n+    fn default() -> Self { todo!() }\n+}\n+\n+\n+fn main() {}"}, {"sha": "5aafc8b64d4ff476784edab9dfdbd2d4991b3ba5", "filename": "tests/ui/impl-trait/extra-impl-in-trait-impl.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fextra-impl-in-trait-impl.stderr?ref=d7f742532a16ec3a2db3b47e02fdbd6bbbbf9521", "patch": "@@ -0,0 +1,26 @@\n+error: unexpected `impl` keyword\n+  --> $DIR/extra-impl-in-trait-impl.rs:6:18\n+   |\n+LL | impl<T: Default> impl Default for S<T> {\n+   |                  ^^^^^ help: remove the extra `impl`\n+   |\n+note: this is parsed as an `impl Trait` type, but a trait is expected at this position\n+  --> $DIR/extra-impl-in-trait-impl.rs:6:18\n+   |\n+LL | impl<T: Default> impl Default for S<T> {\n+   |                  ^^^^^^^^^^^^\n+\n+error: unexpected `impl` keyword\n+  --> $DIR/extra-impl-in-trait-impl.rs:12:6\n+   |\n+LL | impl impl Default for S2 {\n+   |      ^^^^^ help: remove the extra `impl`\n+   |\n+note: this is parsed as an `impl Trait` type, but a trait is expected at this position\n+  --> $DIR/extra-impl-in-trait-impl.rs:12:6\n+   |\n+LL | impl impl Default for S2 {\n+   |      ^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}]}