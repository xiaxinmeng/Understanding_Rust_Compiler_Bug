{"sha": "74140603444716b257a060c3c467295d580c9afc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0MTQwNjAzNDQ0NzE2YjI1N2EwNjBjM2M0NjcyOTVkNTgwYzlhZmM=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2017-10-25T14:59:50Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2017-10-31T16:41:39Z"}, "message": "update the format of liveness debug dumps to be more readable", "tree": {"sha": "f1f07e6dd0686a20675ada7017a00dfae638809c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f1f07e6dd0686a20675ada7017a00dfae638809c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74140603444716b257a060c3c467295d580c9afc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74140603444716b257a060c3c467295d580c9afc", "html_url": "https://github.com/rust-lang/rust/commit/74140603444716b257a060c3c467295d580c9afc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74140603444716b257a060c3c467295d580c9afc/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24442ffa666925b7c98fb9e9197811700bc36d26", "url": "https://api.github.com/repos/rust-lang/rust/commits/24442ffa666925b7c98fb9e9197811700bc36d26", "html_url": "https://github.com/rust-lang/rust/commit/24442ffa666925b7c98fb9e9197811700bc36d26"}], "stats": {"total": 154, "additions": 84, "deletions": 70}, "files": [{"sha": "1498a6b23c094d07d6c1ea9d54857921f8c26a66", "filename": "src/librustc_mir/transform/nll/mod.rs", "status": "modified", "additions": 61, "deletions": 24, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/74140603444716b257a060c3c467295d580c9afc/src%2Flibrustc_mir%2Ftransform%2Fnll%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74140603444716b257a060c3c467295d580c9afc/src%2Flibrustc_mir%2Ftransform%2Fnll%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fnll%2Fmod.rs?ref=74140603444716b257a060c3c467295d580c9afc", "patch": "@@ -16,7 +16,7 @@ use rustc::util::nodemap::FxHashMap;\n use rustc_data_structures::indexed_vec::Idx;\n use std::collections::BTreeSet;\n use std::fmt;\n-use util::liveness::{self, LivenessResult, LivenessMode};\n+use util::liveness::{self, LivenessMode, LivenessResult, LocalSet};\n \n use util as mir_util;\n use self::mir_util::PassWhere;\n@@ -51,15 +51,21 @@ impl MirPass for NLL {\n \n             // Compute what is live where.\n             let liveness = &LivenessResults {\n-                regular: liveness::liveness_of_locals(mir, LivenessMode {\n-                    include_regular_use: true,\n-                    include_drops: false,\n-                }),\n-\n-                drop: liveness::liveness_of_locals(mir, LivenessMode {\n-                    include_regular_use: false,\n-                    include_drops: true,\n-                })\n+                regular: liveness::liveness_of_locals(\n+                    mir,\n+                    LivenessMode {\n+                        include_regular_use: true,\n+                        include_drops: false,\n+                    },\n+                ),\n+\n+                drop: liveness::liveness_of_locals(\n+                    mir,\n+                    LivenessMode {\n+                        include_regular_use: false,\n+                        include_drops: true,\n+                    },\n+                ),\n             };\n \n             // Create the region inference context, generate the constraints,\n@@ -94,9 +100,11 @@ fn dump_mir_results<'a, 'gcx, 'tcx>(\n         .indices()\n         .flat_map(|bb| {\n             let mut results = vec![];\n-            liveness.regular.simulate_block(&mir, bb, |location, local_set| {\n-                results.push((location, local_set.clone()));\n-            });\n+            liveness\n+                .regular\n+                .simulate_block(&mir, bb, |location, local_set| {\n+                    results.push((location, local_set.clone()));\n+                });\n             results\n         })\n         .collect();\n@@ -105,9 +113,11 @@ fn dump_mir_results<'a, 'gcx, 'tcx>(\n         .indices()\n         .flat_map(|bb| {\n             let mut results = vec![];\n-            liveness.drop.simulate_block(&mir, bb, |location, local_set| {\n-                results.push((location, local_set.clone()));\n-            });\n+            liveness\n+                .drop\n+                .simulate_block(&mir, bb, |location, local_set| {\n+                    results.push((location, local_set.clone()));\n+                });\n             results\n         })\n         .collect();\n@@ -122,17 +132,21 @@ fn dump_mir_results<'a, 'gcx, 'tcx>(\n             // Before each basic block, dump out the values\n             // that are live on entry to the basic block.\n             PassWhere::BeforeBlock(bb) => {\n-                writeln!(out, \"    | Variables regular-live on entry to the block {:?}: {:?}\",\n-                         bb, liveness.regular.ins[bb])?;\n-                writeln!(out, \"    | Variables drop-live on entry to the block {:?}: {:?}\",\n-                         bb, liveness.drop.ins[bb])?;\n+                let s = live_variable_set(&liveness.regular.ins[bb], &liveness.drop.ins[bb]);\n+                writeln!(out, \"    | Live variables on entry to {:?}: {}\", bb, s)?;\n             }\n \n             PassWhere::InCFG(location) => {\n-                let local_set = &regular_liveness_per_location[&location];\n-                writeln!(out, \"        | Regular-Live variables here: {:?}\", local_set)?;\n-                let local_set = &drop_liveness_per_location[&location];\n-                writeln!(out, \"        | Drop-Live variables here: {:?}\", local_set)?;\n+                let s = live_variable_set(\n+                    &regular_liveness_per_location[&location],\n+                    &drop_liveness_per_location[&location],\n+                );\n+                writeln!(\n+                    out,\n+                    \"            | Live variables at {:?}: {}\",\n+                    location,\n+                    s\n+                )?;\n             }\n \n             PassWhere::AfterCFG => {}\n@@ -184,3 +198,26 @@ impl ToRegionIndex for RegionKind {\n         }\n     }\n }\n+\n+fn live_variable_set(regular: &LocalSet, drops: &LocalSet) -> String {\n+    // sort and deduplicate:\n+    let all_locals: BTreeSet<_> = regular.iter().chain(drops.iter()).collect();\n+\n+    // construct a string with each local, including `(drop)` if it is\n+    // only dropped, versus a regular use.\n+    let mut string = String::new();\n+    for local in all_locals {\n+        string.push_str(&format!(\"{:?}\", local));\n+\n+        if !regular.contains(&local) {\n+            assert!(drops.contains(&local));\n+            string.push_str(\" (drop)\");\n+        }\n+\n+        string.push_str(\", \");\n+    }\n+\n+    let len = if string.is_empty() { 0 } else { string.len() - 2  };\n+\n+    format!(\"[{}]\", &string[..len])\n+}"}, {"sha": "551aff8454aa7d393cde28fc8a902fa59b20b8f2", "filename": "src/test/mir-opt/nll/liveness-call-subtlety.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-call-subtlety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-call-subtlety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-call-subtlety.rs?ref=74140603444716b257a060c3c467295d580c9afc", "patch": "@@ -26,26 +26,20 @@ fn main() {\n //\n // END RUST SOURCE\n // START rustc.node12.nll.0.mir\n-//    | Variables regular-live on entry to the block bb0: []\n-//    | Variables drop-live on entry to the block bb0: []\n+//    | Live variables on entry to bb0: []\n //    bb0: {\n-//        | Regular-Live variables here: []\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb0[0]: []\n //        StorageLive(_1);\n-//        | Regular-Live variables here: []\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb0[1]: []\n //        _1 = const <std::boxed::Box<T>>::new(const 22usize) -> bb1;\n //    }\n // END rustc.node12.nll.0.mir\n // START rustc.node12.nll.0.mir\n-//    | Variables regular-live on entry to the block bb1: []\n-//    | Variables drop-live on entry to the block bb1: [_1]\n+//    | Live variables on entry to bb1: [_1 (drop)]\n //    bb1: {\n-//        | Regular-Live variables here: []\n-//        | Drop-Live variables here: [_1]\n+//             | Live variables at bb1[0]: [_1 (drop)]\n //        StorageLive(_2);\n-//        | Regular-Live variables here: []\n-//        | Drop-Live variables here: [_1]\n+//             | Live variables at bb1[1]: [_1 (drop)]\n //        _2 = const can_panic() -> [return: bb2, unwind: bb4];\n //    }\n // END rustc.node12.nll.0.mir"}, {"sha": "96fd29dfe2fd9eb0ac3be46b68b9c391dc71a510", "filename": "src/test/mir-opt/nll/liveness-drop-intra-block.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-drop-intra-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-drop-intra-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-drop-intra-block.rs?ref=74140603444716b257a060c3c467295d580c9afc", "patch": "@@ -25,23 +25,17 @@ fn main() {\n \n // END RUST SOURCE\n // START rustc.node12.nll.0.mir\n-//    | Variables regular-live on entry to the block bb1: []\n-//    | Variables drop-live on entry to the block bb1: []\n+//    | Live variables on entry to bb1: []\n //    bb1: {\n-//        | Regular-Live variables here: []\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[0]: []\n //        _1 = const 55usize;\n-//        | Regular-Live variables here: [_1]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[1]: [_1]\n //        StorageLive(_3);\n-//        | Regular-Live variables here: [_1]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[2]: [_1]\n //        StorageLive(_4);\n-//        | Regular-Live variables here: [_1]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[3]: [_1]\n //        _4 = _1;\n-//        | Regular-Live variables here: [_4]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[4]: [_4]\n //        _3 = const use_x(_4) -> bb2;\n //    }\n // END rustc.node12.nll.0.mir"}, {"sha": "c557763c004bff84db7f7ea38752d93e36714e39", "filename": "src/test/mir-opt/nll/liveness-interblock.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-interblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-interblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fnll%2Fliveness-interblock.rs?ref=74140603444716b257a060c3c467295d580c9afc", "patch": "@@ -29,26 +29,20 @@ fn main() {\n \n // END RUST SOURCE\n // START rustc.node18.nll.0.mir\n-//    | Variables regular-live on entry to the block bb2: [_1]\n-//    | Variables drop-live on entry to the block bb2: []\n+//     | Live variables on entry to bb2: [_1]\n //     bb2: {\n-//         | Regular-Live variables here: [_1]\n-//         | Drop-Live variables here: []\n+//             | Live variables at bb2[0]: [_1]\n //         StorageLive(_4);\n-//         | Regular-Live variables here: [_1]\n-//         | Drop-Live variables here: []\n+//             | Live variables at bb2[1]: [_1]\n //         _4 = _1;\n-//         | Regular-Live variables here: [_4]\n-//         | Drop-Live variables here: []\n+//             | Live variables at bb2[2]: [_4]\n //         _3 = const make_live(_4) -> bb4;\n //     }\n // END rustc.node18.nll.0.mir\n // START rustc.node18.nll.0.mir\n-//     | Variables regular-live on entry to the block bb3: []\n-//     | Variables drop-live on entry to the block bb3: []\n+//     | Live variables on entry to bb3: []\n //     bb3: {\n-//         | Regular-Live variables here: []\n-//         | Drop-Live variables here: []\n+//             | Live variables at bb3[0]: []\n //         _5 = const make_dead() -> bb5;\n //     }\n // END rustc.node18.nll.0.mir"}, {"sha": "fa4eb9627db5e0669aa80c29cd4f51af5c7c5c33", "filename": "src/test/mir-opt/nll/region-liveness-basic.rs", "status": "modified", "additions": 5, "deletions": 10, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fregion-liveness-basic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74140603444716b257a060c3c467295d580c9afc/src%2Ftest%2Fmir-opt%2Fnll%2Fregion-liveness-basic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fnll%2Fregion-liveness-basic.rs?ref=74140603444716b257a060c3c467295d580c9afc", "patch": "@@ -38,24 +38,19 @@ fn main() {\n // END rustc.node12.nll.0.mir\n // START rustc.node12.nll.0.mir\n //    bb1: {\n-//        | Regular-Live variables here: [_1, _3]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[0]: [_1, _3]\n //        _2 = &'_#0r _1[_3];\n-//        | Regular-Live variables here: [_2]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb1[1]: [_2]\n //        switchInt(const true) -> [0u8: bb3, otherwise: bb2];\n //    }\n // END rustc.node12.nll.0.mir\n // START rustc.node12.nll.0.mir\n //    bb2: {\n-//        | Regular-Live variables here: [_2]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb2[0]: [_2]\n //        StorageLive(_7);\n-//        | Regular-Live variables here: [_2]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb2[1]: [_2]\n //        _7 = (*_2);\n-//        | Regular-Live variables here: [_7]\n-//        | Drop-Live variables here: []\n+//            | Live variables at bb2[2]: [_7]\n //        _6 = const use_x(_7) -> bb4;\n //    }\n // END rustc.node12.nll.0.mir"}]}