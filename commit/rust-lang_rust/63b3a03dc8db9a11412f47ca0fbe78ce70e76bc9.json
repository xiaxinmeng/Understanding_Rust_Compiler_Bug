{"sha": "63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzYjNhMDNkYzhkYjlhMTE0MTJmNDdjYTBmYmU3OGNlNzBlNzZiYzk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-07-28T00:49:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-07-28T00:49:39Z"}, "message": "Auto merge of #43217 - pnkfelix:alloc-requires-align-it-in-u32, r=alexcrichton\n\nAdd precondition to `Layout` that the `align` fit in a u32.\n\nAdd precondition to `Layout` that the `align` not exceed 2^31.\n\nThis precondition takes the form of a behavorial change in `Layout::from_size_align` (so it returns `None` if the input `align` is too large) and a new requirement for safe usage of `Layout::from_size_align_unchecked`.\n\nFix #30170.", "tree": {"sha": "52fdc95489cec0c15b3febfda38e8b03d0136549", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/52fdc95489cec0c15b3febfda38e8b03d0136549"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9", "html_url": "https://github.com/rust-lang/rust/commit/63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a78a12a55621f22475dedacc0f6b42bff87a4c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a78a12a55621f22475dedacc0f6b42bff87a4c1", "html_url": "https://github.com/rust-lang/rust/commit/8a78a12a55621f22475dedacc0f6b42bff87a4c1"}, {"sha": "ef8804ba277b055fdc3e6d148e680e3c1b597ad8", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef8804ba277b055fdc3e6d148e680e3c1b597ad8", "html_url": "https://github.com/rust-lang/rust/commit/ef8804ba277b055fdc3e6d148e680e3c1b597ad8"}], "stats": {"total": 22, "additions": 15, "deletions": 7}, "files": [{"sha": "66e0bf81c9078c90f796f27db47ae1b1b692617a", "filename": "src/liballoc/allocator.rs", "status": "modified", "additions": 15, "deletions": 7, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9/src%2Fliballoc%2Fallocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9/src%2Fliballoc%2Fallocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fallocator.rs?ref=63b3a03dc8db9a11412f47ca0fbe78ce70e76bc9", "patch": "@@ -65,11 +65,13 @@ pub struct Layout {\n \n impl Layout {\n     /// Constructs a `Layout` from a given `size` and `align`,\n-    /// or returns `None` if either of the following conditions\n+    /// or returns `None` if any of the following conditions\n     /// are not met:\n     ///\n     /// * `align` must be a power of two,\n     ///\n+    /// * `align` must not exceed 2^31 (i.e. `1 << 31`),\n+    ///\n     /// * `size`, when rounded up to the nearest multiple of `align`,\n     ///    must not overflow (i.e. the rounded value must be less than\n     ///    `usize::MAX`).\n@@ -79,6 +81,10 @@ impl Layout {\n             return None;\n         }\n \n+        if align > (1 << 31) {\n+            return None;\n+        }\n+\n         // (power-of-two implies align != 0.)\n \n         // Rounded up size is:\n@@ -106,8 +112,10 @@ impl Layout {\n     ///\n     /// # Unsafety\n     ///\n-    /// This function is unsafe as it does not verify that `align` is a power of\n-    /// two nor that `size` aligned to `align` fits within the address space.\n+    /// This function is unsafe as it does not verify that `align` is\n+    /// a power-of-two that is also less than or equal to 2^31, nor\n+    /// that `size` aligned to `align` fits within the address space\n+    /// (i.e. the `Layout::from_size_align` preconditions).\n     #[inline]\n     pub unsafe fn from_size_align_unchecked(size: usize, align: usize) -> Layout {\n         Layout { size: size, align: align }\n@@ -217,10 +225,10 @@ impl Layout {\n             Some(alloc_size) => alloc_size,\n         };\n \n-        // We can assume that `self.align` is a power-of-two.\n-        // Furthermore, `alloc_size` has alreayd been rounded up\n-        // to a multiple of `self.align`; therefore, the call\n-        // to `Layout::from_size_align` below should never panic.\n+        // We can assume that `self.align` is a power-of-two that does\n+        // not exceed 2^31. Furthermore, `alloc_size` has already been\n+        // rounded up to a multiple of `self.align`; therefore, the\n+        // call to `Layout::from_size_align` below should never panic.\n         Some((Layout::from_size_align(alloc_size, self.align).unwrap(), padded_size))\n     }\n "}]}