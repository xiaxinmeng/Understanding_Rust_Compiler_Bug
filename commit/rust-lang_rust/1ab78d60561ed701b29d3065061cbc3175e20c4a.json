{"sha": "1ab78d60561ed701b29d3065061cbc3175e20c4a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhYjc4ZDYwNTYxZWQ3MDFiMjlkMzA2NTA2MWNiYzMxNzVlMjBjNGE=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-04-05T10:23:01Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-04-05T10:23:01Z"}, "message": "Fix literal support in token tree to ast item list", "tree": {"sha": "3302dd6d1fbc89ad11e5a9a519a20d7c1a109e77", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3302dd6d1fbc89ad11e5a9a519a20d7c1a109e77"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ab78d60561ed701b29d3065061cbc3175e20c4a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ab78d60561ed701b29d3065061cbc3175e20c4a", "html_url": "https://github.com/rust-lang/rust/commit/1ab78d60561ed701b29d3065061cbc3175e20c4a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ab78d60561ed701b29d3065061cbc3175e20c4a/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "be9a44e9bad262ac5e615730e540fd434f846a0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/be9a44e9bad262ac5e615730e540fd434f846a0e", "html_url": "https://github.com/rust-lang/rust/commit/be9a44e9bad262ac5e615730e540fd434f846a0e"}], "stats": {"total": 49, "additions": 45, "deletions": 4}, "files": [{"sha": "3b127526d1fa84bdb9a207e1945517ab9b78ceb2", "filename": "crates/ra_mbe/src/lib.rs", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_mbe%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_mbe%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_mbe%2Fsrc%2Flib.rs?ref=1ab78d60561ed701b29d3065061cbc3175e20c4a", "patch": "@@ -337,4 +337,45 @@ SOURCE_FILE@[0; 40)\n         );\n     }\n \n+    #[test]\n+    fn expand_literals_to_item_list() {\n+        fn to_subtree(tt: &tt::TokenTree) -> &tt::Subtree {\n+            if let tt::TokenTree::Subtree(subtree) = tt {\n+                return &subtree;\n+            }\n+            assert!(false, \"It is not a subtree\");\n+            unreachable!();\n+        }\n+\n+        fn to_literal(tt: &tt::TokenTree) -> &tt::Literal {\n+            if let tt::TokenTree::Leaf(tt::Leaf::Literal(lit)) = tt {\n+                return lit;\n+            }\n+            assert!(false, \"It is not a literal\");\n+            unreachable!();\n+        }\n+\n+        let rules = create_rules(\n+            r#\"\n+            macro_rules! literals {\n+                ($i:ident) => {\n+                    {\n+                        let a = 'c';\n+                        let c = 1000;\n+                        let f = 12E+99_f64;\n+                    }\n+                }\n+            }\n+            \"#,\n+        );\n+        let expansion = expand(&rules, \"literals!(foo)\");\n+        let stm_tokens = &to_subtree(&expansion.token_trees[0]).token_trees;\n+\n+        // [let] [a] [=] ['c'] [;]\n+        assert_eq!(to_literal(&stm_tokens[3]).text, \"'c'\");\n+        // [let] [c] [=] [1000] [;]\n+        assert_eq!(to_literal(&stm_tokens[5 + 3]).text, \"1000\");\n+        // [let] [f] [=] [12E+99_f64] [;]\n+        assert_eq!(to_literal(&stm_tokens[10 + 3]).text, \"12E+99_f64\");\n+    }\n }"}, {"sha": "fbf3d2e7142c0ae6ae18c840ac5cbd4d56235876", "filename": "crates/ra_mbe/src/syntax_bridge.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_mbe%2Fsrc%2Fsyntax_bridge.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_mbe%2Fsrc%2Fsyntax_bridge.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_mbe%2Fsrc%2Fsyntax_bridge.rs?ref=1ab78d60561ed701b29d3065061cbc3175e20c4a", "patch": "@@ -1,7 +1,7 @@\n use ra_parser::{TokenSource, TreeSink, ParseError};\n use ra_syntax::{\n     AstNode, SyntaxNode, TextRange, SyntaxKind, SmolStr, SyntaxTreeBuilder, TreeArc, SyntaxElement,\n-    ast, SyntaxKind::*, TextUnit\n+    ast, SyntaxKind::*, TextUnit, next_token\n };\n \n /// Maps `tt::TokenId` to the relative range of the original token.\n@@ -189,7 +189,7 @@ impl TtTokenSource {\n     {\n         let tok = match token {\n             tt::Leaf::Literal(l) => TtToken {\n-                kind: SyntaxKind::INT_NUMBER, // FIXME\n+                kind: next_token(&l.text).kind,\n                 is_joint_to_next: false,\n                 text: l.text.clone(),\n             },"}, {"sha": "1cbc3e9e1bf2386b9dcfeeb9f82fba2c674f1b5f", "filename": "crates/ra_syntax/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_syntax%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_syntax%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Flib.rs?ref=1ab78d60561ed701b29d3065061cbc3175e20c4a", "patch": "@@ -40,7 +40,7 @@ pub use crate::{\n     syntax_text::SyntaxText,\n     syntax_node::{Direction,  SyntaxNode, WalkEvent, TreeArc, SyntaxTreeBuilder, SyntaxElement, SyntaxToken},\n     ptr::{SyntaxNodePtr, AstPtr},\n-    parsing::{tokenize, Token},\n+    parsing::{tokenize, next_token, Token},\n };\n \n use ra_text_edit::AtomTextEdit;"}, {"sha": "f0750d7374552ad4e5e516fb64b527923367aebb", "filename": "crates/ra_syntax/src/parsing.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_syntax%2Fsrc%2Fparsing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab78d60561ed701b29d3065061cbc3175e20c4a/crates%2Fra_syntax%2Fsrc%2Fparsing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fparsing.rs?ref=1ab78d60561ed701b29d3065061cbc3175e20c4a", "patch": "@@ -11,7 +11,7 @@ use crate::{\n     syntax_node::GreenNode,\n };\n \n-pub use self::lexer::{tokenize, Token};\n+pub use self::lexer::{tokenize, next_token, Token};\n \n pub(crate) use self::reparsing::incremental_reparse;\n "}]}