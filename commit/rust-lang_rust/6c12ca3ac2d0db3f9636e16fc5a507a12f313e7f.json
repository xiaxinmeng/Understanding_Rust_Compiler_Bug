{"sha": "6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjMTJjYTNhYzJkMGRiM2Y5NjM2ZTE2ZmM1YTUwN2ExMmYzMTNlN2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-08-05T02:52:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-08-05T02:52:57Z"}, "message": "auto merge of #8297 : brson/rust/dlist-dtor, r=brson\n\nThe compiler-generated dtor for DList recurses deeply to drop Nodes.\r\nFor big lists this can overflow the stack.\r\n\r\nThis is a problem for the new scheduler, where split stacks are not implemented.\r\n\r\nThanks @blake2-ppc", "tree": {"sha": "2d75d8ba37f5d36072016bc26691239a9649fa8f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d75d8ba37f5d36072016bc26691239a9649fa8f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f", "html_url": "https://github.com/rust-lang/rust/commit/6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc5b0b94101a1fb9094b62ed1bb1b0be3b073fcc", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc5b0b94101a1fb9094b62ed1bb1b0be3b073fcc", "html_url": "https://github.com/rust-lang/rust/commit/dc5b0b94101a1fb9094b62ed1bb1b0be3b073fcc"}, {"sha": "4898a0de04600afefcb095b55ea0d924f125a892", "url": "https://api.github.com/repos/rust-lang/rust/commits/4898a0de04600afefcb095b55ea0d924f125a892", "html_url": "https://github.com/rust-lang/rust/commit/4898a0de04600afefcb095b55ea0d924f125a892"}], "stats": {"total": 42, "additions": 38, "deletions": 4}, "files": [{"sha": "75487a44f2600253e4d50091eaccc1517c299e06", "filename": "src/libextra/dlist.rs", "status": "modified", "additions": 38, "deletions": 4, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f/src%2Flibextra%2Fdlist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f/src%2Flibextra%2Fdlist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Fdlist.rs?ref=6c12ca3ac2d0db3f9636e16fc5a507a12f313e7f", "patch": "@@ -92,6 +92,11 @@ impl<T> Rawlink<T> {\n             Some(unsafe { cast::transmute(self.p) })\n         }\n     }\n+\n+    /// Return the `Rawlink` and replace with `Rawlink::none()`\n+    fn take(&mut self) -> Rawlink<T> {\n+        util::replace(self, Rawlink::none())\n+    }\n }\n \n impl<T> Clone for Rawlink<T> {\n@@ -280,13 +285,16 @@ impl<T> DList<T> {\n     /// Add all elements from `other` to the end of the list\n     ///\n     /// O(1)\n-    pub fn append(&mut self, other: DList<T>) {\n+    pub fn append(&mut self, mut other: DList<T>) {\n         match self.list_tail.resolve() {\n             None => *self = other,\n             Some(tail) => {\n-                match other {\n-                    DList{list_head: None, _} => return,\n-                    DList{list_head: Some(node), list_tail: o_tail, length: o_length} => {\n+                // Carefully empty `other`.\n+                let o_tail = other.list_tail.take();\n+                let o_length = other.length;\n+                match other.list_head.take() {\n+                    None => return,\n+                    Some(node) => {\n                         tail.next = link_with_prev(node, self.list_tail);\n                         self.list_tail = o_tail;\n                         self.length += o_length;\n@@ -404,6 +412,32 @@ impl<T: Ord> DList<T> {\n     }\n }\n \n+#[unsafe_destructor]\n+impl<T> Drop for DList<T> {\n+    fn drop(&self) {\n+        let mut_self = unsafe {\n+            cast::transmute_mut(self)\n+        };\n+        // Dissolve the dlist in backwards direction\n+        // Just dropping the list_head can lead to stack exhaustion\n+        // when length is >> 1_000_000\n+        let mut tail = mut_self.list_tail;\n+        loop {\n+            match tail.resolve() {\n+                None => break,\n+                Some(prev) => {\n+                    prev.next.take(); // release ~Node<T>\n+                    tail = prev.prev;\n+                }\n+            }\n+        }\n+        mut_self.length = 0;\n+        mut_self.list_head = None;\n+        mut_self.list_tail = Rawlink::none();\n+    }\n+}\n+\n+\n impl<'self, A> Iterator<&'self A> for DListIterator<'self, A> {\n     #[inline]\n     fn next(&mut self) -> Option<&'self A> {"}]}