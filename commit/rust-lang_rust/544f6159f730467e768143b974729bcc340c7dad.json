{"sha": "544f6159f730467e768143b974729bcc340c7dad", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0NGY2MTU5ZjczMDQ2N2U3NjgxNDNiOTc0NzI5YmNjMzQwYzdkYWQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-06-21T14:52:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-06-21T14:52:55Z"}, "message": "auto merge of #7259 : dotdash/rust/ir_improvement, r=graydon\n\nThe changes in these commits improve the IR codegen by removing unnecessary copies for certain function call arguments and stopping to allocate return values for functions returning nil. They reduce compile times by about 10% in total.", "tree": {"sha": "6ce85a675de5564a668da6b74c5fbaa2a94c0208", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ce85a675de5564a668da6b74c5fbaa2a94c0208"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/544f6159f730467e768143b974729bcc340c7dad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/544f6159f730467e768143b974729bcc340c7dad", "html_url": "https://github.com/rust-lang/rust/commit/544f6159f730467e768143b974729bcc340c7dad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/544f6159f730467e768143b974729bcc340c7dad/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45f588e8fd938c65df056ab72861e144cf35e674", "url": "https://api.github.com/repos/rust-lang/rust/commits/45f588e8fd938c65df056ab72861e144cf35e674", "html_url": "https://github.com/rust-lang/rust/commit/45f588e8fd938c65df056ab72861e144cf35e674"}, {"sha": "4fb2c09541a5cb7ea91785a9c972ee57ff110c62", "url": "https://api.github.com/repos/rust-lang/rust/commits/4fb2c09541a5cb7ea91785a9c972ee57ff110c62", "html_url": "https://github.com/rust-lang/rust/commit/4fb2c09541a5cb7ea91785a9c972ee57ff110c62"}], "stats": {"total": 125, "additions": 76, "deletions": 49}, "files": [{"sha": "1ba2f15ebda81f24f4551d2d699ed2f9075c6e67", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -1653,7 +1653,9 @@ pub fn new_fn_ctxt_w_id(ccx: @mut CrateContext,\n     fcx.llenv = unsafe {\n           llvm::LLVMGetParam(llfndecl, fcx.env_arg_pos() as c_uint)\n     };\n-    fcx.llretptr = Some(make_return_pointer(fcx, substd_output_type));\n+    if !ty::type_is_nil(substd_output_type) {\n+        fcx.llretptr = Some(make_return_pointer(fcx, substd_output_type));\n+    }\n     fcx\n }\n \n@@ -1808,7 +1810,7 @@ pub fn build_return_block(fcx: fn_ctxt) {\n     let ret_cx = raw_block(fcx, false, fcx.llreturn);\n \n     // Return the value if this function immediate; otherwise, return void.\n-    if fcx.has_immediate_return_value {\n+    if fcx.llretptr.is_some() && fcx.has_immediate_return_value {\n         Ret(ret_cx, Load(ret_cx, fcx.llretptr.get()))\n     } else {\n         RetVoid(ret_cx)\n@@ -2340,8 +2342,7 @@ pub fn create_entry_wrapper(ccx: @mut CrateContext,\n             llvm::LLVMGetParam(llfdecl, env_arg as c_uint)\n         };\n         let args = ~[llenvarg];\n-        let llresult = Call(bcx, main_llfn, args);\n-        Store(bcx, llresult, fcx.llretptr.get());\n+        Call(bcx, main_llfn, args);\n \n         build_return(bcx);\n         finish_fn(fcx, lltop);"}, {"sha": "ced19ce57ad5f639b804b615707beb4c0658c9bb", "filename": "src/librustc/middle/trans/cabi.rs", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -179,16 +179,18 @@ impl FnType {\n             }\n         }\n \n-        let llretval = load_inbounds(bcx, llargbundle, [ 0, arg_tys.len() ]);\n-        let llretval = if self.ret_ty.cast {\n-            let retptr = BitCast(bcx, llretval, T_ptr(self.ret_ty.ty));\n-            Load(bcx, retptr)\n-        } else {\n-            Load(bcx, llretval)\n-        };\n-        let llretptr = BitCast(bcx,\n-                               bcx.fcx.llretptr.get(),\n-                               T_ptr(self.ret_ty.ty));\n-        Store(bcx, llretval, llretptr);\n+        if bcx.fcx.llretptr.is_some() {\n+            let llretval = load_inbounds(bcx, llargbundle, [ 0, arg_tys.len() ]);\n+            let llretval = if self.ret_ty.cast {\n+                let retptr = BitCast(bcx, llretval, T_ptr(self.ret_ty.ty));\n+                Load(bcx, retptr)\n+            } else {\n+                Load(bcx, llretval)\n+            };\n+            let llretptr = BitCast(bcx,\n+                                   bcx.fcx.llretptr.get(),\n+                                   T_ptr(self.ret_ty.ty));\n+            Store(bcx, llretval, llretptr);\n+        }\n     }\n }"}, {"sha": "da7c0d5272da8851c4bb94b37a1212ae9b1e51f6", "filename": "src/librustc/middle/trans/cabi_x86.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi_x86.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi_x86.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi_x86.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -60,6 +60,11 @@ impl ABIInfo for X86_ABIInfo {\n                 cast: false,\n                 ty: T_void(),\n             };\n+        } else if !ret_def {\n+            ret_ty = LLVMType {\n+                cast: false,\n+                ty: T_void()\n+            };\n         }\n \n         return FnType {"}, {"sha": "7666684f2579b7664b64cf87df17b95957732f9c", "filename": "src/librustc/middle/trans/callee.rs", "status": "modified", "additions": 27, "deletions": 18, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -801,24 +801,33 @@ pub fn trans_arg_expr(bcx: block,\n                         val = arg_datum.to_ref_llval(bcx);\n                     }\n                     ty::ByCopy => {\n-                        debug!(\"by copy arg with type %s, storing to scratch\",\n-                               bcx.ty_to_str(arg_datum.ty));\n-                        let scratch = scratch_datum(bcx, arg_datum.ty, false);\n-\n-                        arg_datum.store_to_datum(bcx,\n-                                                 arg_expr.id,\n-                                                 INIT,\n-                                                 scratch);\n-\n-                        // Technically, ownership of val passes to the callee.\n-                        // However, we must cleanup should we fail before the\n-                        // callee is actually invoked.\n-                        scratch.add_clean(bcx);\n-                        temp_cleanups.push(scratch.val);\n-\n-                        match arg_datum.appropriate_mode() {\n-                            ByValue => val = Load(bcx, scratch.val),\n-                            ByRef(_) => val = scratch.val,\n+                        if ty::type_needs_drop(bcx.tcx(), arg_datum.ty) ||\n+                                arg_datum.appropriate_mode().is_by_ref() {\n+                            debug!(\"by copy arg with type %s, storing to scratch\",\n+                                   bcx.ty_to_str(arg_datum.ty));\n+                            let scratch = scratch_datum(bcx, arg_datum.ty, false);\n+\n+                            arg_datum.store_to_datum(bcx,\n+                                                     arg_expr.id,\n+                                                     INIT,\n+                                                     scratch);\n+\n+                            // Technically, ownership of val passes to the callee.\n+                            // However, we must cleanup should we fail before the\n+                            // callee is actually invoked.\n+                            scratch.add_clean(bcx);\n+                            temp_cleanups.push(scratch.val);\n+\n+                            match scratch.appropriate_mode() {\n+                                ByValue => val = Load(bcx, scratch.val),\n+                                ByRef(_) => val = scratch.val,\n+                            }\n+                        } else {\n+                            debug!(\"by copy arg with type %s\");\n+                            match arg_datum.mode {\n+                                ByRef(_) => val = Load(bcx, arg_datum.val),\n+                                ByValue => val = arg_datum.val,\n+                            }\n                         }\n                     }\n                 }"}, {"sha": "acb89755c7fa51cfaca72a7a631e5660b9bca808", "filename": "src/librustc/middle/trans/closure.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fclosure.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -297,7 +297,10 @@ pub fn build_closure(bcx0: block,\n         // the right thing):\n         let ret_true = match bcx.fcx.loop_ret {\n             Some((_, retptr)) => retptr,\n-            None => bcx.fcx.llretptr.get()\n+            None => match bcx.fcx.llretptr {\n+                None => C_null(T_ptr(T_nil())),\n+                Some(retptr) => retptr,\n+            }\n         };\n         let ret_casted = PointerCast(bcx, ret_true, T_ptr(T_nil()));\n         let ret_datum = Datum {val: ret_casted, ty: ty::mk_nil(),"}, {"sha": "55436e5946ef5629bd930350c507b730d275ca9c", "filename": "src/librustc/middle/trans/controlflow.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcontrolflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcontrolflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcontrolflow.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -298,24 +298,27 @@ pub fn trans_cont(bcx: block, label_opt: Option<ident>) -> block {\n pub fn trans_ret(bcx: block, e: Option<@ast::expr>) -> block {\n     let _icx = bcx.insn_ctxt(\"trans_ret\");\n     let mut bcx = bcx;\n-    let retptr = match copy bcx.fcx.loop_ret {\n+    let dest = match copy bcx.fcx.loop_ret {\n       Some((flagptr, retptr)) => {\n         // This is a loop body return. Must set continue flag (our retptr)\n         // to false, return flag to true, and then store the value in the\n         // parent's retptr.\n         Store(bcx, C_bool(true), flagptr);\n         Store(bcx, C_bool(false), bcx.fcx.llretptr.get());\n-        match e {\n+        expr::SaveIn(match e {\n           Some(x) => PointerCast(bcx, retptr,\n                                  T_ptr(type_of(bcx.ccx(), expr_ty(bcx, x)))),\n           None => retptr\n-        }\n+        })\n+      }\n+      None => match bcx.fcx.llretptr {\n+        None => expr::Ignore,\n+        Some(retptr) => expr::SaveIn(retptr),\n       }\n-      None => bcx.fcx.llretptr.get()\n     };\n     match e {\n       Some(x) => {\n-        bcx = expr::trans_into(bcx, x, expr::SaveIn(retptr));\n+        bcx = expr::trans_into(bcx, x, dest);\n       }\n       _ => ()\n     }"}, {"sha": "9516a8b83ab3580d80fd877f462d8e2cd287dc6a", "filename": "src/librustc/middle/trans/foreign.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -127,7 +127,7 @@ fn shim_types(ccx: @mut CrateContext, id: ast::node_id) -> ShimTypes {\n         llsig: llsig,\n         ret_def: ret_def,\n         bundle_ty: bundle_ty,\n-        shim_fn_ty: T_fn([T_ptr(bundle_ty)], T_nil()),\n+        shim_fn_ty: T_fn([T_ptr(bundle_ty)], T_void()),\n         fn_ty: fn_ty\n     }\n }\n@@ -170,7 +170,7 @@ fn build_shim_fn_(ccx: @mut CrateContext,\n     tie_up_header_blocks(fcx, lltop);\n \n     let ret_cx = raw_block(fcx, false, fcx.llreturn);\n-    Ret(ret_cx, C_null(T_nil()));\n+    RetVoid(ret_cx);\n \n     return llshimfn;\n }\n@@ -530,17 +530,21 @@ pub fn trans_foreign_mod(ccx: @mut CrateContext,\n \n                 store_inbounds(bcx, llargval, llargbundle, [0u, i]);\n             }\n-            let llretptr = bcx.fcx.llretptr.get();\n-            store_inbounds(bcx, llretptr, llargbundle, [0u, n]);\n+\n+            for bcx.fcx.llretptr.iter().advance |&retptr| {\n+                store_inbounds(bcx, retptr, llargbundle, [0u, n]);\n+            }\n         }\n \n         fn build_ret(bcx: block,\n                      shim_types: &ShimTypes,\n                      llargbundle: ValueRef) {\n             let _icx = bcx.insn_ctxt(\"foreign::wrap::build_ret\");\n             let arg_count = shim_types.fn_sig.inputs.len();\n-            let llretptr = load_inbounds(bcx, llargbundle, [0, arg_count]);\n-            Store(bcx, Load(bcx, llretptr), bcx.fcx.llretptr.get());\n+            for bcx.fcx.llretptr.iter().advance |&retptr| {\n+                let llretptr = load_inbounds(bcx, llargbundle, [0, arg_count]);\n+                Store(bcx, Load(bcx, llretptr), retptr);\n+            }\n             build_return(bcx);\n         }\n     }\n@@ -1294,7 +1298,7 @@ pub fn trans_foreign_fn(ccx: @mut CrateContext,\n                      shim_types: &ShimTypes,\n                      llargbundle: ValueRef,\n                      llretval: ValueRef) {\n-            if ty::type_is_immediate(shim_types.fn_sig.output) {\n+            if bcx.fcx.llretptr.is_some() && ty::type_is_immediate(shim_types.fn_sig.output) {\n                 // Write the value into the argument bundle.\n                 let arg_count = shim_types.fn_sig.inputs.len();\n                 let llretptr = load_inbounds(bcx,"}, {"sha": "058a6b9f48ef42a9ba23063b28560aa8445fced1", "filename": "src/librustc/middle/trans/type_of.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/544f6159f730467e768143b974729bcc340c7dad/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_of.rs?ref=544f6159f730467e768143b974729bcc340c7dad", "patch": "@@ -55,7 +55,7 @@ pub fn type_of_fn(cx: &mut CrateContext, inputs: &[ty::t], output: ty::t)\n         atys.push_all(type_of_explicit_args(cx, inputs));\n \n         // Use the output as the actual return value if it's immediate.\n-        if output_is_immediate {\n+        if output_is_immediate && !ty::type_is_nil(output) {\n             T_fn(atys, lloutputtype)\n         } else {\n             T_fn(atys, llvm::LLVMVoidTypeInContext(cx.llcx))\n@@ -352,7 +352,7 @@ pub fn llvm_type_name(cx: &CrateContext,\n }\n \n pub fn type_of_dtor(ccx: &mut CrateContext, self_ty: ty::t) -> TypeRef {\n-    T_fn([T_ptr(type_of(ccx, self_ty))] /* self */, T_nil())\n+    T_fn([T_ptr(type_of(ccx, self_ty))] /* self */, T_void())\n }\n \n pub fn type_of_rooted(ccx: &mut CrateContext, t: ty::t) -> TypeRef {\n@@ -364,5 +364,5 @@ pub fn type_of_rooted(ccx: &mut CrateContext, t: ty::t) -> TypeRef {\n \n pub fn type_of_glue_fn(ccx: &CrateContext) -> TypeRef {\n     let tydescpp = T_ptr(T_ptr(ccx.tydesc_type));\n-    return T_fn([T_ptr(T_nil()), tydescpp, T_ptr(T_i8())], T_nil());\n+    return T_fn([T_ptr(T_nil()), tydescpp, T_ptr(T_i8())], T_void());\n }"}]}