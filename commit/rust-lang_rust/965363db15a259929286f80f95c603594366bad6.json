{"sha": "965363db15a259929286f80f95c603594366bad6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2NTM2M2RiMTVhMjU5OTI5Mjg2ZjgwZjk1YzYwMzU5NDM2NmJhZDY=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2019-03-25T07:04:47Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2019-03-25T07:04:47Z"}, "message": "Merge #1036\n\n1036: Assist to flip equality (==) and negated equality (!=) operands. r=matklad a=marcogroppo\n\nThis PR adds an assist to flip the equality operands.\r\n\r\nI hope this is the right way to do this (I'm a newbie...)\r\n\r\nFixes #1023.\r\n\n\nCo-authored-by: Marco Groppo <marco.groppo@gmail.com>", "tree": {"sha": "7d404561e0b8a9b2f23274c07895e6ee14692910", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d404561e0b8a9b2f23274c07895e6ee14692910"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/965363db15a259929286f80f95c603594366bad6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/965363db15a259929286f80f95c603594366bad6", "html_url": "https://github.com/rust-lang/rust/commit/965363db15a259929286f80f95c603594366bad6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/965363db15a259929286f80f95c603594366bad6/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "219b1573377caafaca1dc071f8513ec8be01f199", "url": "https://api.github.com/repos/rust-lang/rust/commits/219b1573377caafaca1dc071f8513ec8be01f199", "html_url": "https://github.com/rust-lang/rust/commit/219b1573377caafaca1dc071f8513ec8be01f199"}, {"sha": "67055c47da2c94188540847b33921af25652156a", "url": "https://api.github.com/repos/rust-lang/rust/commits/67055c47da2c94188540847b33921af25652156a", "html_url": "https://github.com/rust-lang/rust/commit/67055c47da2c94188540847b33921af25652156a"}], "stats": {"total": 170, "additions": 135, "deletions": 35}, "files": [{"sha": "df0bb689da55e5614d565846c8b694391de38ae1", "filename": "crates/ra_assists/src/flip_eq_operands.rs", "status": "added", "additions": 86, "deletions": 0, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/965363db15a259929286f80f95c603594366bad6/crates%2Fra_assists%2Fsrc%2Fflip_eq_operands.rs", "raw_url": "https://github.com/rust-lang/rust/raw/965363db15a259929286f80f95c603594366bad6/crates%2Fra_assists%2Fsrc%2Fflip_eq_operands.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fflip_eq_operands.rs?ref=965363db15a259929286f80f95c603594366bad6", "patch": "@@ -0,0 +1,86 @@\n+use hir::db::HirDatabase;\n+use ra_syntax::ast::{AstNode, BinExpr, BinOp};\n+\n+use crate::{AssistCtx, Assist, AssistId};\n+\n+pub(crate) fn flip_eq_operands(mut ctx: AssistCtx<impl HirDatabase>) -> Option<Assist> {\n+    let expr = ctx.node_at_offset::<BinExpr>()?;\n+    let lhs = expr.lhs()?.syntax();\n+    let rhs = expr.rhs()?.syntax();\n+    let op_range = expr.op()?.range();\n+    let cursor_in_range = ctx.frange.range.is_subrange(&op_range);\n+    let allowed_ops = [BinOp::EqualityTest, BinOp::NegatedEqualityTest];\n+    let expr_op = expr.op_kind()?;\n+    if !cursor_in_range || !allowed_ops.iter().any(|o| *o == expr_op) {\n+        return None;\n+    }\n+    ctx.add_action(AssistId(\"flip_eq_operands\"), \"flip equality operands\", |edit| {\n+        edit.target(op_range);\n+        edit.replace(lhs.range(), rhs.text());\n+        edit.replace(rhs.range(), lhs.text());\n+    });\n+\n+    ctx.build()\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+\n+    use crate::helpers::{check_assist, check_assist_target};\n+\n+    #[test]\n+    fn flip_eq_operands_for_simple_stmt() {\n+        check_assist(\n+            flip_eq_operands,\n+            \"fn f() { let res = 1 ==<|> 2; }\",\n+            \"fn f() { let res = 2 ==<|> 1; }\",\n+        )\n+    }\n+\n+    #[test]\n+    fn flip_neq_operands_for_simple_stmt() {\n+        check_assist(\n+            flip_eq_operands,\n+            \"fn f() { let res = 1 !=<|> 2; }\",\n+            \"fn f() { let res = 2 !=<|> 1; }\",\n+        )\n+    }\n+\n+    #[test]\n+    fn flip_eq_operands_for_complex_stmt() {\n+        check_assist(\n+            flip_eq_operands,\n+            \"fn f() { let res = (1 + 1) ==<|> (2 + 2); }\",\n+            \"fn f() { let res = (2 + 2) ==<|> (1 + 1); }\",\n+        )\n+    }\n+\n+    #[test]\n+    fn flip_eq_operands_in_match_expr() {\n+        check_assist(\n+            flip_eq_operands,\n+            r#\"\n+            fn dyn_eq(&self, other: &dyn Diagnostic) -> bool {\n+                match other.downcast_ref::<Self>() {\n+                    None => false,\n+                    Some(it) => it ==<|> self,\n+                }\n+            }\n+            \"#,\n+            r#\"\n+            fn dyn_eq(&self, other: &dyn Diagnostic) -> bool {\n+                match other.downcast_ref::<Self>() {\n+                    None => false,\n+                    Some(it) => self ==<|> it,\n+                }\n+            }\n+            \"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn flip_eq_operands_target() {\n+        check_assist_target(flip_eq_operands, \"fn f() { let res = 1 ==<|> 2; }\", \"==\")\n+    }\n+}"}, {"sha": "8900fbc4bef2dede8749d1e40f8b9fc01ca9d156", "filename": "crates/ra_assists/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/965363db15a259929286f80f95c603594366bad6/crates%2Fra_assists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/965363db15a259929286f80f95c603594366bad6/crates%2Fra_assists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Flib.rs?ref=965363db15a259929286f80f95c603594366bad6", "patch": "@@ -88,6 +88,7 @@ where\n mod add_derive;\n mod add_impl;\n mod flip_comma;\n+mod flip_eq_operands;\n mod change_visibility;\n mod fill_match_arms;\n mod fill_struct_fields;\n@@ -106,6 +107,7 @@ fn all_assists<DB: HirDatabase>() -> &'static [fn(AssistCtx<DB>) -> Option<Assis\n         fill_match_arms::fill_match_arms,\n         fill_struct_fields::fill_struct_fields,\n         flip_comma::flip_comma,\n+        flip_eq_operands::flip_eq_operands,\n         introduce_variable::introduce_variable,\n         replace_if_let_with_match::replace_if_let_with_match,\n         split_import::split_import,"}, {"sha": "c37fd0454bcb1889bf7a740976d1bf8f56c0d93f", "filename": "crates/ra_hir/src/expr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/965363db15a259929286f80f95c603594366bad6/crates%2Fra_hir%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/965363db15a259929286f80f95c603594366bad6/crates%2Fra_hir%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fexpr.rs?ref=965363db15a259929286f80f95c603594366bad6", "patch": "@@ -680,7 +680,7 @@ impl ExprCollector {\n             }\n             ast::ExprKind::PrefixExpr(e) => {\n                 let expr = self.collect_expr_opt(e.expr());\n-                if let Some(op) = e.op() {\n+                if let Some(op) = e.op_kind() {\n                     self.alloc_expr(Expr::UnaryOp { expr, op }, syntax_ptr)\n                 } else {\n                     self.alloc_expr(Expr::Missing, syntax_ptr)\n@@ -703,7 +703,7 @@ impl ExprCollector {\n             ast::ExprKind::BinExpr(e) => {\n                 let lhs = self.collect_expr_opt(e.lhs());\n                 let rhs = self.collect_expr_opt(e.rhs());\n-                let op = e.op();\n+                let op = e.op_kind();\n                 self.alloc_expr(Expr::BinaryOp { lhs, rhs, op }, syntax_ptr)\n             }\n             ast::ExprKind::TupleExpr(e) => {"}, {"sha": "226208700eb38d6640d8cea42ce5f7248e311351", "filename": "crates/ra_syntax/src/ast.rs", "status": "modified", "additions": 45, "deletions": 33, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/965363db15a259929286f80f95c603594366bad6/crates%2Fra_syntax%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/965363db15a259929286f80f95c603594366bad6/crates%2Fra_syntax%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast.rs?ref=965363db15a259929286f80f95c603594366bad6", "patch": "@@ -521,14 +521,18 @@ pub enum PrefixOp {\n }\n \n impl PrefixExpr {\n-    pub fn op(&self) -> Option<PrefixOp> {\n+    pub fn op_kind(&self) -> Option<PrefixOp> {\n         match self.syntax().first_child()?.kind() {\n             STAR => Some(PrefixOp::Deref),\n             EXCL => Some(PrefixOp::Not),\n             MINUS => Some(PrefixOp::Neg),\n             _ => None,\n         }\n     }\n+\n+    pub fn op(&self) -> Option<&SyntaxNode> {\n+        self.syntax().first_child()\n+    }\n }\n \n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash)]\n@@ -598,46 +602,54 @@ pub enum BinOp {\n }\n \n impl BinExpr {\n-    pub fn op(&self) -> Option<BinOp> {\n+    fn op_details(&self) -> Option<(&SyntaxNode, BinOp)> {\n         self.syntax()\n             .children()\n             .filter_map(|c| match c.kind() {\n-                PIPEPIPE => Some(BinOp::BooleanOr),\n-                AMPAMP => Some(BinOp::BooleanAnd),\n-                EQEQ => Some(BinOp::EqualityTest),\n-                NEQ => Some(BinOp::NegatedEqualityTest),\n-                LTEQ => Some(BinOp::LesserEqualTest),\n-                GTEQ => Some(BinOp::GreaterEqualTest),\n-                L_ANGLE => Some(BinOp::LesserTest),\n-                R_ANGLE => Some(BinOp::GreaterTest),\n-                PLUS => Some(BinOp::Addition),\n-                STAR => Some(BinOp::Multiplication),\n-                MINUS => Some(BinOp::Subtraction),\n-                SLASH => Some(BinOp::Division),\n-                PERCENT => Some(BinOp::Remainder),\n-                SHL => Some(BinOp::LeftShift),\n-                SHR => Some(BinOp::RightShift),\n-                CARET => Some(BinOp::BitwiseXor),\n-                PIPE => Some(BinOp::BitwiseOr),\n-                AMP => Some(BinOp::BitwiseAnd),\n-                DOTDOT => Some(BinOp::RangeRightOpen),\n-                DOTDOTEQ => Some(BinOp::RangeRightClosed),\n-                EQ => Some(BinOp::Assignment),\n-                PLUSEQ => Some(BinOp::AddAssign),\n-                SLASHEQ => Some(BinOp::DivAssign),\n-                STAREQ => Some(BinOp::MulAssign),\n-                PERCENTEQ => Some(BinOp::RemAssign),\n-                SHREQ => Some(BinOp::ShrAssign),\n-                SHLEQ => Some(BinOp::ShlAssign),\n-                MINUSEQ => Some(BinOp::SubAssign),\n-                PIPEEQ => Some(BinOp::BitOrAssign),\n-                AMPEQ => Some(BinOp::BitAndAssign),\n-                CARETEQ => Some(BinOp::BitXorAssign),\n+                PIPEPIPE => Some((c, BinOp::BooleanOr)),\n+                AMPAMP => Some((c, BinOp::BooleanAnd)),\n+                EQEQ => Some((c, BinOp::EqualityTest)),\n+                NEQ => Some((c, BinOp::NegatedEqualityTest)),\n+                LTEQ => Some((c, BinOp::LesserEqualTest)),\n+                GTEQ => Some((c, BinOp::GreaterEqualTest)),\n+                L_ANGLE => Some((c, BinOp::LesserTest)),\n+                R_ANGLE => Some((c, BinOp::GreaterTest)),\n+                PLUS => Some((c, BinOp::Addition)),\n+                STAR => Some((c, BinOp::Multiplication)),\n+                MINUS => Some((c, BinOp::Subtraction)),\n+                SLASH => Some((c, BinOp::Division)),\n+                PERCENT => Some((c, BinOp::Remainder)),\n+                SHL => Some((c, BinOp::LeftShift)),\n+                SHR => Some((c, BinOp::RightShift)),\n+                CARET => Some((c, BinOp::BitwiseXor)),\n+                PIPE => Some((c, BinOp::BitwiseOr)),\n+                AMP => Some((c, BinOp::BitwiseAnd)),\n+                DOTDOT => Some((c, BinOp::RangeRightOpen)),\n+                DOTDOTEQ => Some((c, BinOp::RangeRightClosed)),\n+                EQ => Some((c, BinOp::Assignment)),\n+                PLUSEQ => Some((c, BinOp::AddAssign)),\n+                SLASHEQ => Some((c, BinOp::DivAssign)),\n+                STAREQ => Some((c, BinOp::MulAssign)),\n+                PERCENTEQ => Some((c, BinOp::RemAssign)),\n+                SHREQ => Some((c, BinOp::ShrAssign)),\n+                SHLEQ => Some((c, BinOp::ShlAssign)),\n+                MINUSEQ => Some((c, BinOp::SubAssign)),\n+                PIPEEQ => Some((c, BinOp::BitOrAssign)),\n+                AMPEQ => Some((c, BinOp::BitAndAssign)),\n+                CARETEQ => Some((c, BinOp::BitXorAssign)),\n                 _ => None,\n             })\n             .next()\n     }\n \n+    pub fn op_kind(&self) -> Option<BinOp> {\n+        self.op_details().map(|t| t.1)\n+    }\n+\n+    pub fn op(&self) -> Option<&SyntaxNode> {\n+        self.op_details().map(|t| t.0)\n+    }\n+\n     pub fn lhs(&self) -> Option<&Expr> {\n         children(self).nth(0)\n     }"}]}