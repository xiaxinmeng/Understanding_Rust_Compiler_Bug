{"sha": "4d56f09650a62485fd9f9414e401e12f03959855", "node_id": "C_kwDOAAsO6NoAKDRkNTZmMDk2NTBhNjI0ODVmZDlmOTQxNGU0MDFlMTJmMDM5NTk4NTU", "commit": {"author": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-03-04T01:48:26Z"}, "committer": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-03-10T04:35:43Z"}, "message": "Fallback to top-level config.toml if not present in current directory\n\nThis also preserves the behavior where x.py will only give a hard error on a missing config file\nif it was configured through `--config` or RUST_BOOTSTRAP_CONFIG.\nIt also removes the top-level fallback for everything except the default path.", "tree": {"sha": "29f2c87c6536387dac79e6ff5b15dcc223b574dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29f2c87c6536387dac79e6ff5b15dcc223b574dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4d56f09650a62485fd9f9414e401e12f03959855", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4d56f09650a62485fd9f9414e401e12f03959855", "html_url": "https://github.com/rust-lang/rust/commit/4d56f09650a62485fd9f9414e401e12f03959855", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4d56f09650a62485fd9f9414e401e12f03959855/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85ce7fdfa2f4af87516aac0b3878dc8c144015be", "url": "https://api.github.com/repos/rust-lang/rust/commits/85ce7fdfa2f4af87516aac0b3878dc8c144015be", "html_url": "https://github.com/rust-lang/rust/commit/85ce7fdfa2f4af87516aac0b3878dc8c144015be"}], "stats": {"total": 35, "additions": 24, "deletions": 11}, "files": [{"sha": "71b8f3c4553bce5140bc6df271b2b181fd58c661", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4d56f09650a62485fd9f9414e401e12f03959855/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/4d56f09650a62485fd9f9414e401e12f03959855/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=4d56f09650a62485fd9f9414e401e12f03959855", "patch": "@@ -1233,16 +1233,18 @@ def bootstrap(help_triggered):\n     build.verbose = args.verbose\n     build.clean = args.clean\n \n-    # Read from `--config`, then `RUST_BOOTSTRAP_CONFIG`, then fallback to `config.toml` (if it\n-    # exists).\n+    # Read from `--config`, then `RUST_BOOTSTRAP_CONFIG`, then `./config.toml`,\n+    # then `config.toml` in the root directory.\n     toml_path = args.config or os.getenv('RUST_BOOTSTRAP_CONFIG')\n-    if not toml_path and os.path.exists('config.toml'):\n+    using_default_path = toml_path is None\n+    if using_default_path:\n         toml_path = 'config.toml'\n-\n-    if toml_path:\n         if not os.path.exists(toml_path):\n             toml_path = os.path.join(build.rust_root, toml_path)\n \n+    # Give a hard error if `--config` or `RUST_BOOTSTRAP_CONFIG` are set to a missing path,\n+    # but not if `config.toml` hasn't been created.\n+    if not using_default_path or os.path.exists(toml_path):\n         with open(toml_path) as config:\n             build.config_toml = config.read()\n "}, {"sha": "0c0a4733231d22e07bbbcc910eb1bda673a01f0d", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/4d56f09650a62485fd9f9414e401e12f03959855/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d56f09650a62485fd9f9414e401e12f03959855/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=4d56f09650a62485fd9f9414e401e12f03959855", "patch": "@@ -647,7 +647,8 @@ impl Config {\n         let get_toml = |file: &Path| {\n             use std::process;\n \n-            let contents = t!(fs::read_to_string(file), \"`include` config not found\");\n+            let contents =\n+                t!(fs::read_to_string(file), format!(\"config file {} not found\", file.display()));\n             match toml::from_str(&contents) {\n                 Ok(table) => table,\n                 Err(err) => {\n@@ -657,14 +658,24 @@ impl Config {\n             }\n         };\n \n-        // check --config first, then `$RUST_BOOTSTRAP_CONFIG` first, then `config.toml`\n+        // Read from `--config`, then `RUST_BOOTSTRAP_CONFIG`, then `./config.toml`, then `config.toml` in the root directory.\n         let toml_path = flags\n             .config\n             .clone()\n-            .or_else(|| env::var_os(\"RUST_BOOTSTRAP_CONFIG\").map(PathBuf::from))\n-            .unwrap_or_else(|| PathBuf::from(\"config.toml\"));\n-        let mut toml =\n-            if toml_path.exists() { get_toml(&toml_path) } else { TomlConfig::default() };\n+            .or_else(|| env::var_os(\"RUST_BOOTSTRAP_CONFIG\").map(PathBuf::from));\n+        let using_default_path = toml_path.is_none();\n+        let mut toml_path = toml_path.unwrap_or_else(|| PathBuf::from(\"config.toml\"));\n+        if using_default_path && !toml_path.exists() {\n+            toml_path = config.src.join(toml_path);\n+        }\n+\n+        // Give a hard error if `--config` or `RUST_BOOTSTRAP_CONFIG` are set to a missing path,\n+        // but not if `config.toml` hasn't been created.\n+        let mut toml = if !using_default_path || toml_path.exists() {\n+            get_toml(&toml_path)\n+        } else {\n+            TomlConfig::default()\n+        };\n \n         if let Some(include) = &toml.profile {\n             let mut include_path = config.src.clone();"}]}