{"sha": "fc47ce53c8ed91dec1f791d79eb4566988266e73", "node_id": "C_kwDOAAsO6NoAKGZjNDdjZTUzYzhlZDkxZGVjMWY3OTFkNzllYjQ1NjY5ODgyNjZlNzM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-13T09:57:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-13T09:57:51Z"}, "message": "Auto merge of #12696 - hi-rustin:rustin-patch-fix, r=Veykril\n\nAdd str_ref_to_string fix\n\nclose https://github.com/rust-lang/rust-analyzer/issues/11383\nWhen type mismatch is `&str` -> `String` try to fix it.", "tree": {"sha": "b38523a6a8ccfa187e5cd030721a43ff371e25ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b38523a6a8ccfa187e5cd030721a43ff371e25ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc47ce53c8ed91dec1f791d79eb4566988266e73", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc47ce53c8ed91dec1f791d79eb4566988266e73", "html_url": "https://github.com/rust-lang/rust/commit/fc47ce53c8ed91dec1f791d79eb4566988266e73", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc47ce53c8ed91dec1f791d79eb4566988266e73/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84a6bc99ad7ac14fd15b1026d52ce7bc321e311a", "url": "https://api.github.com/repos/rust-lang/rust/commits/84a6bc99ad7ac14fd15b1026d52ce7bc321e311a", "html_url": "https://github.com/rust-lang/rust/commit/84a6bc99ad7ac14fd15b1026d52ce7bc321e311a"}, {"sha": "638abba05cbd8488bd62547ad8f6c1131615f7e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/638abba05cbd8488bd62547ad8f6c1131615f7e9", "html_url": "https://github.com/rust-lang/rust/commit/638abba05cbd8488bd62547ad8f6c1131615f7e9"}], "stats": {"total": 47, "additions": 47, "deletions": 0}, "files": [{"sha": "223938247229290a36faabc3eeeb459dfe265733", "filename": "crates/ide-diagnostics/src/handlers/type_mismatch.rs", "status": "modified", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/fc47ce53c8ed91dec1f791d79eb4566988266e73/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc47ce53c8ed91dec1f791d79eb4566988266e73/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs?ref=fc47ce53c8ed91dec1f791d79eb4566988266e73", "patch": "@@ -35,6 +35,7 @@ fn fixes(ctx: &DiagnosticsContext<'_>, d: &hir::TypeMismatch) -> Option<Vec<Assi\n     add_reference(ctx, d, &mut fixes);\n     add_missing_ok_or_some(ctx, d, &mut fixes);\n     remove_semicolon(ctx, d, &mut fixes);\n+    str_ref_to_string(ctx, d, &mut fixes);\n \n     if fixes.is_empty() {\n         None\n@@ -134,6 +135,32 @@ fn remove_semicolon(\n     Some(())\n }\n \n+fn str_ref_to_string(\n+    ctx: &DiagnosticsContext<'_>,\n+    d: &hir::TypeMismatch,\n+    acc: &mut Vec<Assist>,\n+) -> Option<()> {\n+    let expected = d.expected.display(ctx.sema.db);\n+    let actual = d.actual.display(ctx.sema.db);\n+\n+    if expected.to_string() != \"String\" || actual.to_string() != \"&str\" {\n+        return None;\n+    }\n+\n+    let root = ctx.sema.db.parse_or_expand(d.expr.file_id)?;\n+    let expr = d.expr.value.to_node(&root);\n+    let expr_range = expr.syntax().text_range();\n+\n+    let to_string = format!(\".to_string()\");\n+\n+    let edit = TextEdit::insert(expr.syntax().text_range().end(), to_string);\n+    let source_change =\n+        SourceChange::from_text_edit(d.expr.file_id.original_file(ctx.sema.db), edit);\n+    acc.push(fix(\"str_ref_to_string\", \"Add .to_string() here\", source_change, expr_range));\n+\n+    Some(())\n+}\n+\n #[cfg(test)]\n mod tests {\n     use crate::tests::{check_diagnostics, check_fix, check_no_fix};\n@@ -498,4 +525,24 @@ fn foo() -> SomeOtherEnum { 0$0 }\n     fn remove_semicolon() {\n         check_fix(r#\"fn f() -> i32 { 92$0; }\"#, r#\"fn f() -> i32 { 92 }\"#);\n     }\n+\n+    #[test]\n+    fn str_ref_to_string() {\n+        check_fix(\n+            r#\"\n+struct String;\n+\n+fn test() -> String {\n+    \"a\"$0\n+}\n+            \"#,\n+            r#\"\n+struct String;\n+\n+fn test() -> String {\n+    \"a\".to_string()\n+}\n+            \"#,\n+        );\n+    }\n }"}]}