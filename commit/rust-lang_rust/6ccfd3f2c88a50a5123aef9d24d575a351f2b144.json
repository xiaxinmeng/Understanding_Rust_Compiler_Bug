{"sha": "6ccfd3f2c88a50a5123aef9d24d575a351f2b144", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjY2ZkM2YyYzg4YTUwYTUxMjNhZWY5ZDI0ZDU3NWEzNTFmMmIxNDQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-01-06T23:24:58Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-01-06T23:24:58Z"}, "message": "rollup merge of #20612: retep998/winsize\n\nThis calculates the width and height using the bounding box of the window in the buffer. Bounding box coordinates are inclusive so I have to add 1 to both dimensions.", "tree": {"sha": "e8265402cfc812a1852fa0706c6605006c9c419f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e8265402cfc812a1852fa0706c6605006c9c419f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ccfd3f2c88a50a5123aef9d24d575a351f2b144", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ccfd3f2c88a50a5123aef9d24d575a351f2b144", "html_url": "https://github.com/rust-lang/rust/commit/6ccfd3f2c88a50a5123aef9d24d575a351f2b144", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ccfd3f2c88a50a5123aef9d24d575a351f2b144/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cc20935ad8948b4120375903708af48d16ed1eba", "url": "https://api.github.com/repos/rust-lang/rust/commits/cc20935ad8948b4120375903708af48d16ed1eba", "html_url": "https://github.com/rust-lang/rust/commit/cc20935ad8948b4120375903708af48d16ed1eba"}, {"sha": "351e6b7255bbe43687c9275d63b99da3e8f5fe62", "url": "https://api.github.com/repos/rust-lang/rust/commits/351e6b7255bbe43687c9275d63b99da3e8f5fe62", "html_url": "https://github.com/rust-lang/rust/commit/351e6b7255bbe43687c9275d63b99da3e8f5fe62"}], "stats": {"total": 46, "additions": 39, "deletions": 7}, "files": [{"sha": "dea5d71080a4227446ad2b43ba18733584cd8781", "filename": "src/libstd/sys/windows/c.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/6ccfd3f2c88a50a5123aef9d24d575a351f2b144/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ccfd3f2c88a50a5123aef9d24d575a351f2b144/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs?ref=6ccfd3f2c88a50a5123aef9d24d575a351f2b144", "patch": "@@ -84,6 +84,32 @@ pub fn fd_set(set: &mut fd_set, s: libc::SOCKET) {\n     set.fd_count += 1;\n }\n \n+pub type SHORT = libc::c_short;\n+\n+#[repr(C)]\n+pub struct COORD {\n+    pub X: SHORT,\n+    pub Y: SHORT,\n+}\n+\n+#[repr(C)]\n+pub struct SMALL_RECT {\n+    pub Left: SHORT,\n+    pub Top: SHORT,\n+    pub Right: SHORT,\n+    pub Bottom: SHORT,\n+}\n+\n+#[repr(C)]\n+pub struct CONSOLE_SCREEN_BUFFER_INFO {\n+    pub dwSize: COORD,\n+    pub dwCursorPosition: COORD,\n+    pub wAttributes: libc::WORD,\n+    pub srWindow: SMALL_RECT,\n+    pub dwMaximumWindowSize: COORD,\n+}\n+pub type PCONSOLE_SCREEN_BUFFER_INFO = *mut CONSOLE_SCREEN_BUFFER_INFO;\n+\n #[link(name = \"ws2_32\")]\n extern \"system\" {\n     pub fn WSAStartup(wVersionRequested: libc::WORD,\n@@ -246,4 +272,8 @@ extern \"system\" {\n \n     pub fn SetConsoleMode(hConsoleHandle: libc::HANDLE,\n                           lpMode: libc::DWORD) -> libc::BOOL;\n+    pub fn GetConsoleScreenBufferInfo(\n+        hConsoleOutput: libc::HANDLE,\n+        lpConsoleScreenBufferInfo: PCONSOLE_SCREEN_BUFFER_INFO,\n+    ) -> libc::BOOL;\n }"}, {"sha": "f9e1f0d3ed0aa42d9e934c8d94842318d54dadab", "filename": "src/libstd/sys/windows/tty.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/6ccfd3f2c88a50a5123aef9d24d575a351f2b144/src%2Flibstd%2Fsys%2Fwindows%2Ftty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ccfd3f2c88a50a5123aef9d24d575a351f2b144/src%2Flibstd%2Fsys%2Fwindows%2Ftty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Ftty.rs?ref=6ccfd3f2c88a50a5123aef9d24d575a351f2b144", "patch": "@@ -32,13 +32,15 @@ use iter::repeat;\n use libc::types::os::arch::extra::LPCVOID;\n use libc::{c_int, HANDLE, LPDWORD, DWORD, LPVOID};\n use libc::{get_osfhandle, CloseHandle};\n+use mem;\n use ptr;\n use str::from_utf8;\n use super::c::{ENABLE_ECHO_INPUT, ENABLE_EXTENDED_FLAGS};\n use super::c::{ENABLE_INSERT_MODE, ENABLE_LINE_INPUT};\n use super::c::{ENABLE_PROCESSED_INPUT, ENABLE_QUICK_EDIT_MODE};\n-use super::c::{ERROR_ILLEGAL_CHARACTER};\n+use super::c::{ERROR_ILLEGAL_CHARACTER, CONSOLE_SCREEN_BUFFER_INFO};\n use super::c::{ReadConsoleW, WriteConsoleW, GetConsoleMode, SetConsoleMode};\n+use super::c::{GetConsoleScreenBufferInfo};\n \n fn invalid_encoding() -> IoError {\n     IoError {\n@@ -146,12 +148,12 @@ impl TTY {\n     }\n \n     pub fn get_winsize(&mut self) -> IoResult<(int, int)> {\n-        // FIXME\n-        // Get console buffer via CreateFile with CONOUT$\n-        // Make a CONSOLE_SCREEN_BUFFER_INFO\n-        // Call GetConsoleScreenBufferInfo\n-        // Maybe call GetLargestConsoleWindowSize instead?\n-        Err(super::unimpl())\n+        let mut info: CONSOLE_SCREEN_BUFFER_INFO = unsafe { mem::zeroed() };\n+        match unsafe { GetConsoleScreenBufferInfo(self.handle, &mut info as *mut _) } {\n+            0 => Err(super::last_error()),\n+            _ => Ok(((info.srWindow.Right + 1 - info.srWindow.Left) as int,\n+                     (info.srWindow.Bottom + 1 - info.srWindow.Top) as int)),\n+        }\n     }\n \n     // Let us magically declare this as a TTY"}]}