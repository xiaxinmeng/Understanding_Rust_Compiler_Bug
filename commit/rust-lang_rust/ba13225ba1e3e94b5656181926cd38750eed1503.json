{"sha": "ba13225ba1e3e94b5656181926cd38750eed1503", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhMTMyMjViYTFlM2U5NGI1NjU2MTgxOTI2Y2QzODc1MGVlZDE1MDM=", "commit": {"author": {"name": "Camelid", "email": "camelidcamel@gmail.com", "date": "2021-05-08T22:03:15Z"}, "committer": {"name": "Camelid", "email": "camelidcamel@gmail.com", "date": "2021-05-08T22:35:44Z"}, "message": "Remove `FakeDefId::expect_local()`\n\nThis function returned a fake `DefIndex`, with no indication that it was\nfake, when it was provided with a `FakeDefId::Fake`. Every use of the\nfunction uses the returned `DefIndex` in a call to\n`tcx.local_def_id_to_hir_id()`, which I'm pretty sure would panic if it\nwere given a fake `DefIndex`.\n\nI removed the function and replaced all calls to it with a call to\n`expect_real()` followed by `DefId::expect_local()` (that's a function\non the *real* `DefId`).", "tree": {"sha": "122ac6b1cebea59f4485bf594d451927b2d01f33", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/122ac6b1cebea59f4485bf594d451927b2d01f33"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ba13225ba1e3e94b5656181926cd38750eed1503", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ba13225ba1e3e94b5656181926cd38750eed1503", "html_url": "https://github.com/rust-lang/rust/commit/ba13225ba1e3e94b5656181926cd38750eed1503", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ba13225ba1e3e94b5656181926cd38750eed1503/comments", "author": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff34b919075f35a1787659e9c448a34b06bab8de", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff34b919075f35a1787659e9c448a34b06bab8de", "html_url": "https://github.com/rust-lang/rust/commit/ff34b919075f35a1787659e9c448a34b06bab8de"}], "stats": {"total": 36, "additions": 16, "deletions": 20}, "files": [{"sha": "550df203a9fee704c10bd293844aa03b87fa5401", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 1, "deletions": 17, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=ba13225ba1e3e94b5656181926cd38750eed1503", "patch": "@@ -18,7 +18,7 @@ use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_data_structures::thin_vec::ThinVec;\n use rustc_hir as hir;\n use rustc_hir::def::{CtorKind, DefKind, Res};\n-use rustc_hir::def_id::{CrateNum, DefId, DefIndex, LocalDefId, CRATE_DEF_INDEX, LOCAL_CRATE};\n+use rustc_hir::def_id::{CrateNum, DefId, DefIndex, CRATE_DEF_INDEX, LOCAL_CRATE};\n use rustc_hir::lang_items::LangItem;\n use rustc_hir::{BodyId, Mutability};\n use rustc_index::vec::IndexVec;\n@@ -85,22 +85,6 @@ impl FakeDefId {\n         }\n     }\n \n-    #[inline]\n-    crate fn as_local(self) -> Option<LocalDefId> {\n-        match self {\n-            FakeDefId::Real(id) => id.as_local(),\n-            FakeDefId::Fake(idx, krate) => {\n-                (krate == LOCAL_CRATE).then(|| LocalDefId { local_def_index: idx })\n-            }\n-        }\n-    }\n-\n-    #[inline]\n-    crate fn expect_local(self) -> LocalDefId {\n-        self.as_local()\n-            .unwrap_or_else(|| panic!(\"FakeDefId::expect_local: `{:?}` isn't local\", self))\n-    }\n-\n     #[inline]\n     crate fn expect_real(self) -> rustc_hir::def_id::DefId {\n         self.as_real().unwrap_or_else(|| panic!(\"FakeDefId::expect_real: `{:?}` isn't real\", self))"}, {"sha": "e65fcf057f15c1605bd09865c214a90f604e1b8a", "filename": "src/librustdoc/passes/calculate_doc_coverage.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs?ref=ba13225ba1e3e94b5656181926cd38750eed1503", "patch": "@@ -213,7 +213,13 @@ impl<'a, 'b> fold::DocFolder for CoverageCalculator<'a, 'b> {\n \n                 let filename = i.span(self.ctx.tcx).filename(self.ctx.sess());\n                 let has_doc_example = tests.found_tests != 0;\n-                let hir_id = self.ctx.tcx.hir().local_def_id_to_hir_id(i.def_id.expect_local());\n+                // The `expect_real()` should be okay because `local_def_id_to_hir_id`\n+                // would presumably panic if a fake `DefIndex` were passed.\n+                let hir_id = self\n+                    .ctx\n+                    .tcx\n+                    .hir()\n+                    .local_def_id_to_hir_id(i.def_id.expect_real().expect_local());\n                 let (level, source) = self.ctx.tcx.lint_level_at_node(MISSING_DOCS, hir_id);\n                 // `missing_docs` is allow-by-default, so don't treat this as ignoring the item\n                 // unless the user had an explicit `allow`"}, {"sha": "8838dc57d5a059f96bcdf1a0af5e4b5b8aefcb21", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=ba13225ba1e3e94b5656181926cd38750eed1503", "patch": "@@ -1207,7 +1207,11 @@ impl LinkCollector<'_, '_> {\n             // item can be non-local e.g. when using #[doc(primitive = \"pointer\")]\n             if let Some((src_id, dst_id)) = id\n                 .as_local()\n-                .and_then(|dst_id| item.def_id.as_local().map(|src_id| (src_id, dst_id)))\n+                // The `expect_real()` should be okay because `local_def_id_to_hir_id`\n+                // would presumably panic if a fake `DefIndex` were passed.\n+                .and_then(|dst_id| {\n+                    item.def_id.expect_real().as_local().map(|src_id| (src_id, dst_id))\n+                })\n             {\n                 use rustc_hir::def_id::LOCAL_CRATE;\n "}, {"sha": "ba698474f16298386a2596b1890ffc90d65e3e44", "filename": "src/librustdoc/passes/doc_test_lints.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba13225ba1e3e94b5656181926cd38750eed1503/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs?ref=ba13225ba1e3e94b5656181926cd38750eed1503", "patch": "@@ -71,7 +71,9 @@ crate fn should_have_doc_example(cx: &DocContext<'_>, item: &clean::Item) -> boo\n     {\n         return false;\n     }\n-    let hir_id = cx.tcx.hir().local_def_id_to_hir_id(item.def_id.expect_local());\n+    // The `expect_real()` should be okay because `local_def_id_to_hir_id`\n+    // would presumably panic if a fake `DefIndex` were passed.\n+    let hir_id = cx.tcx.hir().local_def_id_to_hir_id(item.def_id.expect_real().expect_local());\n     if cx.tcx.hir().attrs(hir_id).lists(sym::doc).has_word(sym::hidden)\n         || inherits_doc_hidden(cx.tcx, hir_id)\n     {"}]}