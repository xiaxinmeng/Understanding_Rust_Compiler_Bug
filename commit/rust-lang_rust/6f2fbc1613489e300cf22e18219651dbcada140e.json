{"sha": "6f2fbc1613489e300cf22e18219651dbcada140e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmMmZiYzE2MTM0ODllMzAwY2YyMmUxODIxOTY1MWRiY2FkYTE0MGU=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-12-04T02:30:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-04T02:30:17Z"}, "message": "Rollup merge of #77686 - camelid:rustdoc-render-search-results, r=GuillaumeGomez\n\nRender Markdown in search results\n\nFixes #32040.\n\nPreviously Markdown documentation was not rendered to HTML for search results,\nwhich led to the output not being very readable, particularly for inline code.\nThis PR fixes that by rendering Markdown to HTML with the help of pulldown-cmark\n(the library rustdoc uses to parse Markdown for the main text of documentation).\nHowever, the text for the title attribute (the text shown when you hover over an\nelement) still uses the plain-text rendering since it is displayed in browsers\nas plain-text.\n\nOnly these styles will be rendered; everything else is stripped away:\n\n* *italics*\n* **bold**\n* `inline code`", "tree": {"sha": "38274820d86d17f2118c832a980742db5f0c221f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/38274820d86d17f2118c832a980742db5f0c221f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f2fbc1613489e300cf22e18219651dbcada140e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfyZ85CRBK7hj4Ov3rIwAAdHIIAKCN6Rd+GJ3J+LJ3xO+vsoLF\nCBFhtSTs/DWWgfYCzTe9Qag9yD8fJy1FYkjuPDiMGPrXfgWXAZLCSpl61Q0e1YAW\nwwC01f/rqI7+tOe9Wx7L5WaqNIwpn/F+uprNr5pb3pEyhws+gglKccuRLp7hHgSI\nRMfxwqH3ZQVzO/E2G9gJ/P4rkvhGcRJt5x+Eyl1Ptraw0LIkndZZWcbg0oIuGN+u\n4rM0y8cL1MjAUiJ5uiky51O5IWCKWhOvs1niuwPY3Df9rpxcGdcwFCQF5hIo1uf3\nQs1QZv3E5y6BkKkmL0IafE2AS9cOmTa1sAWckDX4H7E6T3OJRj8TmcAcFXLajFY=\n=Gb78\n-----END PGP SIGNATURE-----\n", "payload": "tree 38274820d86d17f2118c832a980742db5f0c221f\nparent 5be3f9f10e9fd59ea03816840a6051413fbdefae\nparent 376507f47b5f16c0a9c210005de2bcdb270d8920\nauthor Dylan DPC <dylan.dpc@gmail.com> 1607049017 +0100\ncommitter GitHub <noreply@github.com> 1607049017 +0100\n\nRollup merge of #77686 - camelid:rustdoc-render-search-results, r=GuillaumeGomez\n\nRender Markdown in search results\n\nFixes #32040.\n\nPreviously Markdown documentation was not rendered to HTML for search results,\nwhich led to the output not being very readable, particularly for inline code.\nThis PR fixes that by rendering Markdown to HTML with the help of pulldown-cmark\n(the library rustdoc uses to parse Markdown for the main text of documentation).\nHowever, the text for the title attribute (the text shown when you hover over an\nelement) still uses the plain-text rendering since it is displayed in browsers\nas plain-text.\n\nOnly these styles will be rendered; everything else is stripped away:\n\n* *italics*\n* **bold**\n* `inline code`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f2fbc1613489e300cf22e18219651dbcada140e", "html_url": "https://github.com/rust-lang/rust/commit/6f2fbc1613489e300cf22e18219651dbcada140e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f2fbc1613489e300cf22e18219651dbcada140e/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5be3f9f10e9fd59ea03816840a6051413fbdefae", "url": "https://api.github.com/repos/rust-lang/rust/commits/5be3f9f10e9fd59ea03816840a6051413fbdefae", "html_url": "https://github.com/rust-lang/rust/commit/5be3f9f10e9fd59ea03816840a6051413fbdefae"}, {"sha": "376507f47b5f16c0a9c210005de2bcdb270d8920", "url": "https://api.github.com/repos/rust-lang/rust/commits/376507f47b5f16c0a9c210005de2bcdb270d8920", "html_url": "https://github.com/rust-lang/rust/commit/376507f47b5f16c0a9c210005de2bcdb270d8920"}], "stats": {"total": 254, "additions": 203, "deletions": 51}, "files": [{"sha": "bf3b994c52a8f4bb3dfd017b78b488886cb6867b", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -1000,7 +1000,7 @@ impl<'tcx> Clean<FnDecl> for (DefId, ty::PolyFnSig<'tcx>) {\n                     .iter()\n                     .map(|t| Argument {\n                         type_: t.clean(cx),\n-                        name: names.next().map_or(String::new(), |name| name.to_string()),\n+                        name: names.next().map_or_else(|| String::new(), |name| name.to_string()),\n                     })\n                     .collect(),\n             },"}, {"sha": "e82bc540e95af25bfee284c8f5e97ad16a3c1b97", "filename": "src/librustdoc/formats/cache.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fformats%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fformats%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fformats%2Fcache.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -14,13 +14,13 @@ use crate::config::RenderInfo;\n use crate::fold::DocFolder;\n use crate::formats::item_type::ItemType;\n use crate::formats::Impl;\n+use crate::html::markdown::short_markdown_summary;\n use crate::html::render::cache::{extern_location, get_index_search_type, ExternalLocation};\n use crate::html::render::IndexItem;\n-use crate::html::render::{plain_text_summary, shorten};\n \n thread_local!(crate static CACHE_KEY: RefCell<Arc<Cache>> = Default::default());\n \n-/// This cache is used to store information about the `clean::Crate` being\n+/// This cache is used to store information about the [`clean::Crate`] being\n /// rendered in order to provide more useful documentation. This contains\n /// information like all implementors of a trait, all traits a type implements,\n /// documentation for all known traits, etc.\n@@ -313,7 +313,9 @@ impl DocFolder for Cache {\n                             ty: item.type_(),\n                             name: s.to_string(),\n                             path: path.join(\"::\"),\n-                            desc: shorten(plain_text_summary(item.doc_value())),\n+                            desc: item\n+                                .doc_value()\n+                                .map_or_else(|| String::new(), short_markdown_summary),\n                             parent,\n                             parent_idx: None,\n                             search_type: get_index_search_type(&item),"}, {"sha": "0e4c5410abe1e17255a1ec1dc9687967e1f63f2a", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 88, "deletions": 2, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -17,8 +17,6 @@\n //! // ... something using html\n //! ```\n \n-#![allow(non_camel_case_types)]\n-\n use rustc_data_structures::fx::FxHashMap;\n use rustc_hir::def_id::DefId;\n use rustc_hir::HirId;\n@@ -1037,7 +1035,95 @@ impl MarkdownSummaryLine<'_> {\n     }\n }\n \n+/// Renders a subset of Markdown in the first paragraph of the provided Markdown.\n+///\n+/// - *Italics*, **bold**, and `inline code` styles **are** rendered.\n+/// - Headings and links are stripped (though the text *is* rendered).\n+/// - HTML, code blocks, and everything else are ignored.\n+///\n+/// Returns a tuple of the rendered HTML string and whether the output was shortened\n+/// due to the provided `length_limit`.\n+fn markdown_summary_with_limit(md: &str, length_limit: usize) -> (String, bool) {\n+    if md.is_empty() {\n+        return (String::new(), false);\n+    }\n+\n+    let mut s = String::with_capacity(md.len() * 3 / 2);\n+    let mut text_length = 0;\n+    let mut stopped_early = false;\n+\n+    fn push(s: &mut String, text_length: &mut usize, text: &str) {\n+        s.push_str(text);\n+        *text_length += text.len();\n+    };\n+\n+    'outer: for event in Parser::new_ext(md, Options::ENABLE_STRIKETHROUGH) {\n+        match &event {\n+            Event::Text(text) => {\n+                for word in text.split_inclusive(char::is_whitespace) {\n+                    if text_length + word.len() >= length_limit {\n+                        stopped_early = true;\n+                        break 'outer;\n+                    }\n+\n+                    push(&mut s, &mut text_length, word);\n+                }\n+            }\n+            Event::Code(code) => {\n+                if text_length + code.len() >= length_limit {\n+                    stopped_early = true;\n+                    break;\n+                }\n+\n+                s.push_str(\"<code>\");\n+                push(&mut s, &mut text_length, code);\n+                s.push_str(\"</code>\");\n+            }\n+            Event::Start(tag) => match tag {\n+                Tag::Emphasis => s.push_str(\"<em>\"),\n+                Tag::Strong => s.push_str(\"<strong>\"),\n+                Tag::CodeBlock(..) => break,\n+                _ => {}\n+            },\n+            Event::End(tag) => match tag {\n+                Tag::Emphasis => s.push_str(\"</em>\"),\n+                Tag::Strong => s.push_str(\"</strong>\"),\n+                Tag::Paragraph => break,\n+                _ => {}\n+            },\n+            Event::HardBreak | Event::SoftBreak => {\n+                if text_length + 1 >= length_limit {\n+                    stopped_early = true;\n+                    break;\n+                }\n+\n+                push(&mut s, &mut text_length, \" \");\n+            }\n+            _ => {}\n+        }\n+    }\n+\n+    (s, stopped_early)\n+}\n+\n+/// Renders a shortened first paragraph of the given Markdown as a subset of Markdown,\n+/// making it suitable for contexts like the search index.\n+///\n+/// Will shorten to 59 or 60 characters, including an ellipsis (\u2026) if it was shortened.\n+///\n+/// See [`markdown_summary_with_limit`] for details about what is rendered and what is not.\n+crate fn short_markdown_summary(markdown: &str) -> String {\n+    let (mut s, was_shortened) = markdown_summary_with_limit(markdown, 59);\n+\n+    if was_shortened {\n+        s.push('\u2026');\n+    }\n+\n+    s\n+}\n+\n /// Renders the first paragraph of the provided markdown as plain text.\n+/// Useful for alt-text.\n ///\n /// - Headings, links, and formatting are stripped.\n /// - Inline code is rendered as-is, surrounded by backticks."}, {"sha": "9807d8632c75d272486bbb839cdd484dbd1e49b4", "filename": "src/librustdoc/html/markdown/tests.rs", "status": "modified", "additions": 32, "deletions": 1, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Fmarkdown%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Fmarkdown%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown%2Ftests.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -1,4 +1,4 @@\n-use super::plain_text_summary;\n+use super::{plain_text_summary, short_markdown_summary};\n use super::{ErrorCodes, IdMap, Ignore, LangString, Markdown, MarkdownHtml};\n use rustc_span::edition::{Edition, DEFAULT_EDITION};\n use std::cell::RefCell;\n@@ -204,6 +204,33 @@ fn test_header_ids_multiple_blocks() {\n     );\n }\n \n+#[test]\n+fn test_short_markdown_summary() {\n+    fn t(input: &str, expect: &str) {\n+        let output = short_markdown_summary(input);\n+        assert_eq!(output, expect, \"original: {}\", input);\n+    }\n+\n+    t(\"hello [Rust](https://www.rust-lang.org) :)\", \"hello Rust :)\");\n+    t(\"*italic*\", \"<em>italic</em>\");\n+    t(\"**bold**\", \"<strong>bold</strong>\");\n+    t(\"Multi-line\\nsummary\", \"Multi-line summary\");\n+    t(\"Hard-break  \\nsummary\", \"Hard-break summary\");\n+    t(\"hello [Rust] :)\\n\\n[Rust]: https://www.rust-lang.org\", \"hello Rust :)\");\n+    t(\"hello [Rust](https://www.rust-lang.org \\\"Rust\\\") :)\", \"hello Rust :)\");\n+    t(\"code `let x = i32;` ...\", \"code <code>let x = i32;</code> ...\");\n+    t(\"type `Type<'static>` ...\", \"type <code>Type<'static></code> ...\");\n+    t(\"# top header\", \"top header\");\n+    t(\"## header\", \"header\");\n+    t(\"first paragraph\\n\\nsecond paragraph\", \"first paragraph\");\n+    t(\"```\\nfn main() {}\\n```\", \"\");\n+    t(\"<div>hello</div>\", \"\");\n+    t(\n+        \"a *very*, **very** long first paragraph. it has lots of `inline code: Vec<T>`. and it has a [link](https://www.rust-lang.org).\\nthat was a soft line break!  \\nthat was a hard one\\n\\nsecond paragraph.\",\n+        \"a <em>very</em>, <strong>very</strong> long first paragraph. it has lots of \u2026\",\n+    );\n+}\n+\n #[test]\n fn test_plain_text_summary() {\n     fn t(input: &str, expect: &str) {\n@@ -224,6 +251,10 @@ fn test_plain_text_summary() {\n     t(\"first paragraph\\n\\nsecond paragraph\", \"first paragraph\");\n     t(\"```\\nfn main() {}\\n```\", \"\");\n     t(\"<div>hello</div>\", \"\");\n+    t(\n+        \"a *very*, **very** long first paragraph. it has lots of `inline code: Vec<T>`. and it has a [link](https://www.rust-lang.org).\\nthat was a soft line break!  \\nthat was a hard one\\n\\nsecond paragraph.\",\n+        \"a very, very long first paragraph. it has lots of `inline code: Vec<T>`. and it has a link. that was a soft line break! that was a hard one\",\n+    );\n }\n \n #[test]"}, {"sha": "97f764517faf6e8b71b2e2ebd381c7d1e6fe9142", "filename": "src/librustdoc/html/render/cache.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -9,7 +9,7 @@ use crate::clean::types::GetDefId;\n use crate::clean::{self, AttributesExt};\n use crate::formats::cache::Cache;\n use crate::formats::item_type::ItemType;\n-use crate::html::render::{plain_text_summary, shorten};\n+use crate::html::markdown::short_markdown_summary;\n use crate::html::render::{Generic, IndexItem, IndexItemFunctionType, RenderType, TypeWithKind};\n \n /// Indicates where an external crate can be found.\n@@ -78,7 +78,7 @@ crate fn build_index(krate: &clean::Crate, cache: &mut Cache) -> String {\n                 ty: item.type_(),\n                 name: item.name.clone().unwrap(),\n                 path: fqp[..fqp.len() - 1].join(\"::\"),\n-                desc: shorten(plain_text_summary(item.doc_value())),\n+                desc: item.doc_value().map_or_else(|| String::new(), short_markdown_summary),\n                 parent: Some(did),\n                 parent_idx: None,\n                 search_type: get_index_search_type(&item),\n@@ -127,7 +127,7 @@ crate fn build_index(krate: &clean::Crate, cache: &mut Cache) -> String {\n     let crate_doc = krate\n         .module\n         .as_ref()\n-        .map(|module| shorten(plain_text_summary(module.doc_value())))\n+        .map(|module| module.doc_value().map_or_else(|| String::new(), short_markdown_summary))\n         .unwrap_or_default();\n \n     #[derive(Serialize)]"}, {"sha": "901f00b21da9d7cb63383bbb3d8b5306d0f3a302", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 7, "deletions": 34, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -76,7 +76,9 @@ use crate::html::format::fmt_impl_for_trait_page;\n use crate::html::format::Function;\n use crate::html::format::{href, print_default_space, print_generic_bounds, WhereClause};\n use crate::html::format::{print_abi_with_space, Buffer, PrintWithSpace};\n-use crate::html::markdown::{self, ErrorCodes, IdMap, Markdown, MarkdownHtml, MarkdownSummaryLine};\n+use crate::html::markdown::{\n+    self, plain_text_summary, ErrorCodes, IdMap, Markdown, MarkdownHtml, MarkdownSummaryLine,\n+};\n use crate::html::sources;\n use crate::html::{highlight, layout, static_files};\n use cache::{build_index, ExternalLocation};\n@@ -1604,9 +1606,10 @@ impl Context {\n                 Some(ref s) => s.to_string(),\n             };\n             let short = short.to_string();\n-            map.entry(short)\n-                .or_default()\n-                .push((myname, Some(plain_text_summary(item.doc_value()))));\n+            map.entry(short).or_default().push((\n+                myname,\n+                Some(item.doc_value().map_or_else(|| String::new(), plain_text_summary)),\n+            ));\n         }\n \n         if self.shared.sort_modules_alphabetically {\n@@ -1810,36 +1813,6 @@ fn full_path(cx: &Context, item: &clean::Item) -> String {\n     s\n }\n \n-/// Renders the first paragraph of the given markdown as plain text, making it suitable for\n-/// contexts like alt-text or the search index.\n-///\n-/// If no markdown is supplied, the empty string is returned.\n-///\n-/// See [`markdown::plain_text_summary`] for further details.\n-#[inline]\n-crate fn plain_text_summary(s: Option<&str>) -> String {\n-    s.map(markdown::plain_text_summary).unwrap_or_default()\n-}\n-\n-crate fn shorten(s: String) -> String {\n-    if s.chars().count() > 60 {\n-        let mut len = 0;\n-        let mut ret = s\n-            .split_whitespace()\n-            .take_while(|p| {\n-                // + 1 for the added character after the word.\n-                len += p.chars().count() + 1;\n-                len < 60\n-            })\n-            .collect::<Vec<_>>()\n-            .join(\" \");\n-        ret.push('\u2026');\n-        ret\n-    } else {\n-        s\n-    }\n-}\n-\n fn document(w: &mut Buffer, cx: &Context, item: &clean::Item, parent: Option<&clean::Item>) {\n     if let Some(ref name) = item.name {\n         info!(\"Documenting {}\", name);"}, {"sha": "0884351a9fd80a9172c5e252456a40841140abb6", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -1611,7 +1611,7 @@ function defocusSearchBar() {\n                               item.displayPath + \"<span class=\\\"\" + type + \"\\\">\" +\n                               name + \"</span></a></td><td>\" +\n                               \"<a href=\\\"\" + item.href + \"\\\">\" +\n-                              \"<span class=\\\"desc\\\">\" + escape(item.desc) +\n+                              \"<span class=\\\"desc\\\">\" + item.desc +\n                               \"&nbsp;</span></a></td></tr>\";\n                 });\n                 output += \"</table>\";\n@@ -2013,7 +2013,9 @@ function defocusSearchBar() {\n                     }\n                     var link = document.createElement(\"a\");\n                     link.href = rootPath + crates[i] + \"/index.html\";\n-                    link.title = rawSearchIndex[crates[i]].doc;\n+                    // The summary in the search index has HTML, so we need to\n+                    // dynamically render it as plaintext.\n+                    link.title = convertHTMLToPlaintext(rawSearchIndex[crates[i]].doc);\n                     link.className = klass;\n                     link.textContent = crates[i];\n \n@@ -2026,6 +2028,23 @@ function defocusSearchBar() {\n         }\n     };\n \n+    /**\n+     * Convert HTML to plaintext:\n+     *\n+     *   * Replace \"<code>foo</code>\" with \"`foo`\"\n+     *   * Strip all other HTML tags\n+     *\n+     * Used by the dynamic sidebar crate list renderer.\n+     *\n+     * @param  {[string]} html [The HTML to convert]\n+     * @return {[string]}      [The resulting plaintext]\n+     */\n+    function convertHTMLToPlaintext(html) {\n+        var x = document.createElement(\"div\");\n+        x.innerHTML = html.replace('<code>', '`').replace('</code>', '`');\n+        return x.innerText;\n+    }\n+\n \n     // delayed sidebar rendering.\n     window.initSidebarItems = function(items) {"}, {"sha": "26bf4b569ff4bc499ba6075f7b37d500e1afbece", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -15,6 +15,7 @@\n #![feature(never_type)]\n #![feature(once_cell)]\n #![feature(type_ascription)]\n+#![feature(split_inclusive)]\n #![recursion_limit = \"256\"]\n \n #[macro_use]"}, {"sha": "da946a58b1c88f84e2ed2bdb7b605899d3913dd9", "filename": "src/test/rustdoc-js/basic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc-js%2Fbasic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc-js%2Fbasic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-js%2Fbasic.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -1,2 +1,2 @@\n-/// Foo\n+/// Docs for Foo\n pub struct Foo;"}, {"sha": "f175e47342df64d64321297dd9d8f0c12d2349ce", "filename": "src/test/rustdoc-js/summaries.js", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc-js%2Fsummaries.js", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc-js%2Fsummaries.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-js%2Fsummaries.js?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -0,0 +1,21 @@\n+// ignore-tidy-linelength\n+\n+const QUERY = ['summaries', 'summaries::Sidebar', 'summaries::Sidebar2'];\n+\n+const EXPECTED = [\n+    {\n+        'others': [\n+           { 'path': '', 'name': 'summaries', 'desc': 'This <em>summary</em> has a link and <code>code</code>.' },\n+        ],\n+    },\n+    {\n+        'others': [\n+            { 'path': 'summaries', 'name': 'Sidebar', 'desc': 'This <code>code</code> will be rendered in a code tag.' },\n+        ],\n+    },\n+    {\n+        'others': [\n+            { 'path': 'summaries', 'name': 'Sidebar2', 'desc': '' },\n+        ],\n+    },\n+];"}, {"sha": "beb91e286b61080b127cbcefb420fdb632e82ea7", "filename": "src/test/rustdoc-js/summaries.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc-js%2Fsummaries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc-js%2Fsummaries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-js%2Fsummaries.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -0,0 +1,18 @@\n+#![crate_type = \"lib\"]\n+#![crate_name = \"summaries\"]\n+\n+//! This *summary* has a [link] and `code`.\n+//!\n+//! This is the second paragraph.\n+//!\n+//! [link]: https://example.com\n+\n+/// This `code` will be rendered in a code tag.\n+///\n+/// This text should not be rendered.\n+pub struct Sidebar;\n+\n+/// ```text\n+/// this block should not be rendered\n+/// ```\n+pub struct Sidebar2;"}, {"sha": "b843e28e7b0d3a9e7ccd1c06e659618eeed01eb4", "filename": "src/test/rustdoc/markdown-summaries.rs", "status": "renamed", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc%2Fmarkdown-summaries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f2fbc1613489e300cf22e18219651dbcada140e/src%2Ftest%2Frustdoc%2Fmarkdown-summaries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fmarkdown-summaries.rs?ref=6f2fbc1613489e300cf22e18219651dbcada140e", "patch": "@@ -1,21 +1,22 @@\n #![crate_type = \"lib\"]\n #![crate_name = \"summaries\"]\n \n-//! This summary has a [link] and `code`.\n+//! This *summary* has a [link] and `code`.\n //!\n //! This is the second paragraph.\n //!\n //! [link]: https://example.com\n \n-// @has search-index.js 'This summary has a link and `code`.'\n+// @has search-index.js 'This <em>summary</em> has a link and <code>code</code>.'\n // @!has - 'second paragraph'\n \n-/// This `code` should be in backticks.\n+/// This `code` will be rendered in a code tag.\n ///\n /// This text should not be rendered.\n pub struct Sidebar;\n \n-// @has summaries/sidebar-items.js 'This `code` should be in backticks.'\n+// @has search-index.js 'This <code>code</code> will be rendered in a code tag.'\n+// @has summaries/sidebar-items.js 'This `code` will be rendered in a code tag.'\n // @!has - 'text should not be rendered'\n \n /// ```text", "previous_filename": "src/test/rustdoc/plain-text-summaries.rs"}]}