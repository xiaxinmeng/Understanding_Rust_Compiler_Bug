{"sha": "ba15da40183b686b98d99aa826a6f83c48ee9245", "node_id": "C_kwDOAAsO6NoAKGJhMTVkYTQwMTgzYjY4NmI5OGQ5OWFhODI2YTZmODNjNDhlZTkyNDU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-07T18:14:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-07T18:14:33Z"}, "message": "Auto merge of #2212 - RalfJung:cargo-miri, r=RalfJung\n\nupdate and move cargo-miri operational description", "tree": {"sha": "1a558101a9ddfd5da05403ae5a1b449a00677ef7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a558101a9ddfd5da05403ae5a1b449a00677ef7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ba15da40183b686b98d99aa826a6f83c48ee9245", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ba15da40183b686b98d99aa826a6f83c48ee9245", "html_url": "https://github.com/rust-lang/rust/commit/ba15da40183b686b98d99aa826a6f83c48ee9245", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ba15da40183b686b98d99aa826a6f83c48ee9245/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d7258076d9f7c7099fdf4d619ac48242935f5c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d7258076d9f7c7099fdf4d619ac48242935f5c5", "html_url": "https://github.com/rust-lang/rust/commit/4d7258076d9f7c7099fdf4d619ac48242935f5c5"}, {"sha": "cca3dea37974a8f624a41c603e0ec5ca6a450299", "url": "https://api.github.com/repos/rust-lang/rust/commits/cca3dea37974a8f624a41c603e0ec5ca6a450299", "html_url": "https://github.com/rust-lang/rust/commit/cca3dea37974a8f624a41c603e0ec5ca6a450299"}], "stats": {"total": 21, "additions": 13, "deletions": 8}, "files": [{"sha": "8b11016ca1be0d818c6f886a535aa1105c7a4ba0", "filename": "cargo-miri/bin.rs", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ba15da40183b686b98d99aa826a6f83c48ee9245/cargo-miri%2Fbin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba15da40183b686b98d99aa826a6f83c48ee9245/cargo-miri%2Fbin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/cargo-miri%2Fbin.rs?ref=ba15da40183b686b98d99aa826a6f83c48ee9245", "patch": "@@ -1063,6 +1063,19 @@ fn main() {\n     // Skip binary name.\n     args.next().unwrap();\n \n+    // Dispatch to `cargo-miri` phase. There are four phases:\n+    // - When we are called via `cargo miri`, we run as the frontend and invoke the underlying\n+    //   cargo. We set RUSTDOC, RUSTC_WRAPPER and CARGO_TARGET_RUNNER to ourselves.\n+    // - When we are executed due to RUSTDOC, we run rustdoc and set both `--test-builder` and\n+    //   `--runtool` to ourselves.\n+    // - When we are executed due to RUSTC_WRAPPER (or as the rustdoc test builder), we build crates\n+    //   or store the flags of binary crates for later interpretation.\n+    // - When we are executed due to CARGO_TARGET_RUNNER (or as the rustdoc runtool), we start\n+    //   interpretation based on the flags that were stored earlier.\n+    //\n+    // Additionally, we also set ourselves as RUSTC when calling xargo to build the sysroot, which\n+    // has to be treated slightly differently than when we build regular crates.\n+\n     // Dispatch running as part of sysroot compilation.\n     if env::var_os(\"MIRI_CALLED_FROM_XARGO\").is_some() {\n         phase_rustc(args, RustcPhase::Setup);\n@@ -1094,14 +1107,6 @@ fn main() {\n         return;\n     }\n \n-    // Dispatch to `cargo-miri` phase. There are three phases:\n-    // - When we are called via `cargo miri`, we run as the frontend and invoke the underlying\n-    //   cargo. We set RUSTC_WRAPPER and CARGO_TARGET_RUNNER to ourselves.\n-    // - When we are executed due to RUSTC_WRAPPER, we build crates or store the flags of\n-    //   binary crates for later interpretation.\n-    // - When we are executed due to CARGO_TARGET_RUNNER, we start interpretation based on the\n-    //   flags that were stored earlier.\n-    // On top of that, we are also called as RUSTDOC, but that is just a stub currently.\n     match args.next().as_deref() {\n         Some(\"miri\") => phase_cargo_miri(args),\n         Some(\"rustc\") => phase_rustc(args, RustcPhase::Build),"}]}