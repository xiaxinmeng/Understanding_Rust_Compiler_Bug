{"sha": "89d09953733e72d61876c633dc0658180aefc4d6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5ZDA5OTUzNzMzZTcyZDYxODc2YzYzM2RjMDY1ODE4MGFlZmM0ZDY=", "commit": {"author": {"name": "Luqman Aden", "email": "me@luqman.ca", "date": "2014-12-02T23:23:35Z"}, "committer": {"name": "Luqman Aden", "email": "me@luqman.ca", "date": "2014-12-02T23:28:43Z"}, "message": "gdb: Fix pretty printer for nullable-opt enums with fat pointers.", "tree": {"sha": "bc86b1d7f84dc5ed4b7335e5fe92b62d56d22f34", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc86b1d7f84dc5ed4b7335e5fe92b62d56d22f34"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/89d09953733e72d61876c633dc0658180aefc4d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/89d09953733e72d61876c633dc0658180aefc4d6", "html_url": "https://github.com/rust-lang/rust/commit/89d09953733e72d61876c633dc0658180aefc4d6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/89d09953733e72d61876c633dc0658180aefc4d6/comments", "author": {"login": "luqmana", "id": 287063, "node_id": "MDQ6VXNlcjI4NzA2Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luqmana", "html_url": "https://github.com/luqmana", "followers_url": "https://api.github.com/users/luqmana/followers", "following_url": "https://api.github.com/users/luqmana/following{/other_user}", "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}", "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions", "organizations_url": "https://api.github.com/users/luqmana/orgs", "repos_url": "https://api.github.com/users/luqmana/repos", "events_url": "https://api.github.com/users/luqmana/events{/privacy}", "received_events_url": "https://api.github.com/users/luqmana/received_events", "type": "User", "site_admin": false}, "committer": {"login": "luqmana", "id": 287063, "node_id": "MDQ6VXNlcjI4NzA2Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luqmana", "html_url": "https://github.com/luqmana", "followers_url": "https://api.github.com/users/luqmana/followers", "following_url": "https://api.github.com/users/luqmana/following{/other_user}", "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}", "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions", "organizations_url": "https://api.github.com/users/luqmana/orgs", "repos_url": "https://api.github.com/users/luqmana/repos", "events_url": "https://api.github.com/users/luqmana/events{/privacy}", "received_events_url": "https://api.github.com/users/luqmana/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "886ff4f3c3d05d4dda13390f045a6eb577f1e509", "url": "https://api.github.com/repos/rust-lang/rust/commits/886ff4f3c3d05d4dda13390f045a6eb577f1e509", "html_url": "https://github.com/rust-lang/rust/commit/886ff4f3c3d05d4dda13390f045a6eb577f1e509"}], "stats": {"total": 28, "additions": 21, "deletions": 7}, "files": [{"sha": "7e5918ea39e1edf6173bb397859f20727e69de57", "filename": "src/etc/gdb_rust_pretty_printing.py", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/89d09953733e72d61876c633dc0658180aefc4d6/src%2Fetc%2Fgdb_rust_pretty_printing.py", "raw_url": "https://github.com/rust-lang/rust/raw/89d09953733e72d61876c633dc0658180aefc4d6/src%2Fetc%2Fgdb_rust_pretty_printing.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fgdb_rust_pretty_printing.py?ref=89d09953733e72d61876c633dc0658180aefc4d6", "patch": "@@ -54,21 +54,27 @@ def rust_pretty_printer_lookup_function(val):\n       return RustStructPrinter(val, false)\n \n     if enum_member_count == 1:\n-      if enum_members[0].name == None:\n+      first_variant_name = enum_members[0].name\n+      if first_variant_name == None:\n         # This is a singleton enum\n         return rust_pretty_printer_lookup_function(val[enum_members[0]])\n       else:\n-        assert enum_members[0].name.startswith(\"RUST$ENCODED$ENUM$\")\n+        assert first_variant_name.startswith(\"RUST$ENCODED$ENUM$\")\n         # This is a space-optimized enum\n-        last_separator_index = enum_members[0].name.rfind(\"$\")\n+        last_separator_index = first_variant_name.rfind(\"$\")\n         second_last_separator_index = first_variant_name.rfind(\"$\", 0, last_separator_index)\n         disr_field_index = first_variant_name[second_last_separator_index + 1 :\n                                               last_separator_index]\n         disr_field_index = int(disr_field_index)\n \n         sole_variant_val = val[enum_members[0]]\n         disr_field = get_field_at_index(sole_variant_val, disr_field_index)\n-        discriminant = int(sole_variant_val[disr_field])\n+        discriminant = sole_variant_val[disr_field]\n+\n+        # If the discriminant field is a fat pointer we have to consider the\n+        # first word as the true discriminant\n+        if discriminant.type.code == gdb.TYPE_CODE_STRUCT:\n+            discriminant = discriminant[get_field_at_index(discriminant, 0)]\n \n         if discriminant == 0:\n           null_variant_name = first_variant_name[last_separator_index + 1:]\n@@ -173,7 +179,7 @@ def to_string(self):\n \n class IdentityPrinter:\n   def __init__(self, string):\n-    self.string\n+    self.string = string\n \n   def to_string(self):\n     return self.string"}, {"sha": "76cf3c1149dd552e8665965cabeb1d2b0e3f921b", "filename": "src/test/debuginfo/gdb-pretty-struct-and-enums.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/89d09953733e72d61876c633dc0658180aefc4d6/src%2Ftest%2Fdebuginfo%2Fgdb-pretty-struct-and-enums.rs", "raw_url": "https://github.com/rust-lang/rust/raw/89d09953733e72d61876c633dc0658180aefc4d6/src%2Ftest%2Fdebuginfo%2Fgdb-pretty-struct-and-enums.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fgdb-pretty-struct-and-enums.rs?ref=89d09953733e72d61876c633dc0658180aefc4d6", "patch": "@@ -58,11 +58,17 @@\n // gdb-command: print none\n // gdb-check:$12 = None\n \n+// gdb-command: print some_fat\n+// gdb-check:$13 = Some = {\"abc\"}\n+\n+// gdb-command: print none_fat\n+// gdb-check:$14 = None\n+\n // gdb-command: print nested_variant1\n-// gdb-check:$13 = NestedVariant1 = {NestedStruct = {regular_struct = RegularStruct = {the_first_field = 111, the_second_field = 112.5, the_third_field = true, the_fourth_field = \"NestedStructString1\"}, tuple_struct = TupleStruct = {113.5, 114}, empty_struct = EmptyStruct, c_style_enum = CStyleEnumVar2, mixed_enum = MixedEnumTupleVar = {115, 116, false}}}\n+// gdb-check:$15 = NestedVariant1 = {NestedStruct = {regular_struct = RegularStruct = {the_first_field = 111, the_second_field = 112.5, the_third_field = true, the_fourth_field = \"NestedStructString1\"}, tuple_struct = TupleStruct = {113.5, 114}, empty_struct = EmptyStruct, c_style_enum = CStyleEnumVar2, mixed_enum = MixedEnumTupleVar = {115, 116, false}}}\n \n // gdb-command: print nested_variant2\n-// gdb-check:$14 = NestedVariant2 = {abc = NestedStruct = {regular_struct = RegularStruct = {the_first_field = 117, the_second_field = 118.5, the_third_field = false, the_fourth_field = \"NestedStructString10\"}, tuple_struct = TupleStruct = {119.5, 120}, empty_struct = EmptyStruct, c_style_enum = CStyleEnumVar3, mixed_enum = MixedEnumStructVar = {field1 = 121.5, field2 = -122}}}\n+// gdb-check:$16 = NestedVariant2 = {abc = NestedStruct = {regular_struct = RegularStruct = {the_first_field = 117, the_second_field = 118.5, the_third_field = false, the_fourth_field = \"NestedStructString10\"}, tuple_struct = TupleStruct = {119.5, 120}, empty_struct = EmptyStruct, c_style_enum = CStyleEnumVar3, mixed_enum = MixedEnumStructVar = {field1 = 121.5, field2 = -122}}}\n \n use self::CStyleEnum::{CStyleEnumVar1, CStyleEnumVar2, CStyleEnumVar3};\n use self::MixedEnum::{MixedEnumCStyleVar, MixedEnumTupleVar, MixedEnumStructVar};\n@@ -129,6 +135,8 @@ fn main() {\n \n     let some = Some(110u);\n     let none: Option<int> = None;\n+    let some_fat = Some(\"abc\");\n+    let none_fat: Option<&'static str> = None;\n \n     let nested_variant1 = NestedVariant1(\n         NestedStruct {"}]}