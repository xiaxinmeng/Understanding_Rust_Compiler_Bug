{"sha": "ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFiNjE0YjBmMDEwZTY4Yjc0YjhmOGE2Y2UyNmQ1MzMwMmZiNGYxNGE=", "commit": {"author": {"name": "Antoine Martin", "email": "antoine97.martin@gmail.com", "date": "2020-10-13T14:57:58Z"}, "committer": {"name": "Antoine Martin", "email": "antoine97.martin@gmail.com", "date": "2020-10-13T16:00:25Z"}, "message": "Implement \"if-available\" option for download-ci-llvm", "tree": {"sha": "9786d9ed190b6c02daa5110b3c7c108d1f6cae62", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9786d9ed190b6c02daa5110b3c7c108d1f6cae62"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "html_url": "https://github.com/rust-lang/rust/commit/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/comments", "author": {"login": "alarsyo", "id": 15170378, "node_id": "MDQ6VXNlcjE1MTcwMzc4", "avatar_url": "https://avatars.githubusercontent.com/u/15170378?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alarsyo", "html_url": "https://github.com/alarsyo", "followers_url": "https://api.github.com/users/alarsyo/followers", "following_url": "https://api.github.com/users/alarsyo/following{/other_user}", "gists_url": "https://api.github.com/users/alarsyo/gists{/gist_id}", "starred_url": "https://api.github.com/users/alarsyo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alarsyo/subscriptions", "organizations_url": "https://api.github.com/users/alarsyo/orgs", "repos_url": "https://api.github.com/users/alarsyo/repos", "events_url": "https://api.github.com/users/alarsyo/events{/privacy}", "received_events_url": "https://api.github.com/users/alarsyo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alarsyo", "id": 15170378, "node_id": "MDQ6VXNlcjE1MTcwMzc4", "avatar_url": "https://avatars.githubusercontent.com/u/15170378?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alarsyo", "html_url": "https://github.com/alarsyo", "followers_url": "https://api.github.com/users/alarsyo/followers", "following_url": "https://api.github.com/users/alarsyo/following{/other_user}", "gists_url": "https://api.github.com/users/alarsyo/gists{/gist_id}", "starred_url": "https://api.github.com/users/alarsyo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alarsyo/subscriptions", "organizations_url": "https://api.github.com/users/alarsyo/orgs", "repos_url": "https://api.github.com/users/alarsyo/repos", "events_url": "https://api.github.com/users/alarsyo/events{/privacy}", "received_events_url": "https://api.github.com/users/alarsyo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d772879df35b8ce28e9533676b277ec43a73e6eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/d772879df35b8ce28e9533676b277ec43a73e6eb", "html_url": "https://github.com/rust-lang/rust/commit/d772879df35b8ce28e9533676b277ec43a73e6eb"}], "stats": {"total": 26, "additions": 22, "deletions": 4}, "files": [{"sha": "87b53df3c5f57c31b175ae68f0a548a9e8eb8ce7", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "patch": "@@ -447,7 +447,8 @@ def download_stage0(self):\n \n     def downloading_llvm(self):\n         opt = self.get_toml('download-ci-llvm', 'llvm')\n-        return opt == \"true\"\n+        return opt == \"true\" \\\n+            or (opt == \"if-available\" and self.build == \"x86_64-unknown-linux-gnu\")\n \n     def _download_stage0_helper(self, filename, pattern, tarball_suffix, date=None):\n         if date is None:\n@@ -892,7 +893,7 @@ def update_submodules(self):\n         submodules_names = []\n         for module in submodules:\n             if module.endswith(\"llvm-project\"):\n-                if self.get_toml('llvm-config') or self.get_toml('download-ci-llvm') == 'true':\n+                if self.get_toml('llvm-config') or self.downloading_llvm():\n                     if self.get_toml('lld') != 'true':\n                         continue\n             check = self.check_submodule(module, slow_submodules)"}, {"sha": "3c1249f8de43445f257f381a5f5a07fdc3373f82", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "patch": "@@ -391,7 +391,7 @@ struct Llvm {\n     use_libcxx: Option<bool>,\n     use_linker: Option<String>,\n     allow_old_toolchain: Option<bool>,\n-    download_ci_llvm: Option<bool>,\n+    download_ci_llvm: Option<StringOrBool>,\n }\n \n #[derive(Deserialize, Default, Clone, Merge)]\n@@ -735,7 +735,14 @@ impl Config {\n             set(&mut config.llvm_use_libcxx, llvm.use_libcxx);\n             config.llvm_use_linker = llvm.use_linker.clone();\n             config.llvm_allow_old_toolchain = llvm.allow_old_toolchain;\n-            config.llvm_from_ci = llvm.download_ci_llvm.unwrap_or(false);\n+            config.llvm_from_ci = match llvm.download_ci_llvm {\n+                Some(StringOrBool::String(s)) => {\n+                    assert!(s == \"if-available\", \"unknown option `{}` for download-ci-llvm\", s);\n+                    config.build.triple == \"x86_64-unknown-linux-gnu\"\n+                }\n+                Some(StringOrBool::Bool(b)) => b,\n+                None => false,\n+            };\n \n             if config.llvm_from_ci {\n                 // None of the LLVM options, except assertions, are supported"}, {"sha": "0ca928843d5896cce3186dbec3cd0d501612eb8e", "filename": "src/bootstrap/defaults/config.compiler.toml", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml", "raw_url": "https://github.com/rust-lang/rust/raw/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml?ref=ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "patch": "@@ -6,3 +6,8 @@\n debug-logging = true\n # This greatly increases the speed of rebuilds, especially when there are only minor changes. However, it makes the initial build slightly slower.\n incremental = true\n+\n+[llvm]\n+# Will download LLVM from CI if available on your platform (Linux only for now)\n+# https://github.com/rust-lang/rust/issues/77084 tracks support for more platforms\n+download-ci-llvm = \"if-available\""}, {"sha": "9874fdb767f62fdd3d3cb9bb2f8df0dd0c5b85d7", "filename": "src/bootstrap/defaults/config.library.toml", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml", "raw_url": "https://github.com/rust-lang/rust/raw/ab614b0f010e68b74b8f8a6ce26d53302fb4f14a/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml?ref=ab614b0f010e68b74b8f8a6ce26d53302fb4f14a", "patch": "@@ -8,3 +8,8 @@ bench-stage = 0\n [rust]\n # This greatly increases the speed of rebuilds, especially when there are only minor changes. However, it makes the initial build slightly slower.\n incremental = true\n+\n+[llvm]\n+# Will download LLVM from CI if available on your platform (Linux only for now)\n+# https://github.com/rust-lang/rust/issues/77084 tracks support for more platforms\n+download-ci-llvm = \"if-available\""}]}