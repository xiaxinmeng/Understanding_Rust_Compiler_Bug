{"sha": "f1097c2d26b68741612ecd3411fe41dc13fb005a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYxMDk3YzJkMjZiNjg3NDE2MTJlY2QzNDExZmU0MWRjMTNmYjAwNWE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-06-20T14:08:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-20T14:08:19Z"}, "message": "Merge #9344\n\n9344: fix: rename works when invoked on a reference r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "121822f527fe52875401624e437a5f05ea220b8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/121822f527fe52875401624e437a5f05ea220b8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f1097c2d26b68741612ecd3411fe41dc13fb005a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgz0vTCRBK7hj4Ov3rIwAAu4YIABb8mhFXWr2OO4VSHlOTqLAU\nKFgLKJNpEsOD6jkQI8cLf8m17wx8dJQzyXAmkEg4GuByLAPhHT0Xpm/o2Pq31jsY\nEJngQblkv4SukVKi/ye/SEJSpXhcN4RbUT9YQnL8zEiAFatxrsTV95GGAC5HhJbt\nBBGgegFCMt638+AA1reNvxB7HaPuSf0DruQmCPrgvxBFZxCZpxTps3B28lUIygw6\nNwusM6rbLtcc7Wp2qAVCwqbqfGWqPM27txflTDDaTX9Z8Fqp0L+gEPsae1lX2Z6v\nrlKTDrDt5KI1/QUqhFTidwQ3ZoPS+m6CCRIovoYzP8UuNs8TgxMvZVEt1PZaIsM=\n=4gdr\n-----END PGP SIGNATURE-----\n", "payload": "tree 121822f527fe52875401624e437a5f05ea220b8b\nparent 3843bd02a01e97ab2e73bda43d0313cd87c173ac\nparent cbb1979c19c1b8a87b8f5d806f801db1e9c1eeaa\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1624198099 +0000\ncommitter GitHub <noreply@github.com> 1624198099 +0000\n\nMerge #9344\n\n9344: fix: rename works when invoked on a reference r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f1097c2d26b68741612ecd3411fe41dc13fb005a", "html_url": "https://github.com/rust-lang/rust/commit/f1097c2d26b68741612ecd3411fe41dc13fb005a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f1097c2d26b68741612ecd3411fe41dc13fb005a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3843bd02a01e97ab2e73bda43d0313cd87c173ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/3843bd02a01e97ab2e73bda43d0313cd87c173ac", "html_url": "https://github.com/rust-lang/rust/commit/3843bd02a01e97ab2e73bda43d0313cd87c173ac"}, {"sha": "cbb1979c19c1b8a87b8f5d806f801db1e9c1eeaa", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbb1979c19c1b8a87b8f5d806f801db1e9c1eeaa", "html_url": "https://github.com/rust-lang/rust/commit/cbb1979c19c1b8a87b8f5d806f801db1e9c1eeaa"}], "stats": {"total": 46, "additions": 22, "deletions": 24}, "files": [{"sha": "96bd07708c8793cef59cc6c579e1a4e1ac4bdc43", "filename": "crates/ide/src/rename.rs", "status": "modified", "additions": 22, "deletions": 24, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/f1097c2d26b68741612ecd3411fe41dc13fb005a/crates%2Fide%2Fsrc%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1097c2d26b68741612ecd3411fe41dc13fb005a/crates%2Fide%2Fsrc%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Frename.rs?ref=f1097c2d26b68741612ecd3411fe41dc13fb005a", "patch": "@@ -10,7 +10,7 @@ use ide_db::{\n     rename::{bail, format_err, source_edit_from_references, IdentifierKind},\n     RootDatabase,\n };\n-use stdx::never;\n+use stdx::{always, never};\n use syntax::{ast, AstNode, SyntaxNode};\n \n use text_edit::TextEdit;\n@@ -31,10 +31,13 @@ pub(crate) fn prepare_rename(\n     let source_file = sema.parse(position.file_id);\n     let syntax = source_file.syntax();\n \n-    let def = find_definition(&sema, syntax, position)?;\n-    let frange = def\n-        .range_for_rename(&sema)\n-        .ok_or_else(|| format_err!(\"No references found at position\"))?;\n+    let (name_like, def) = find_definition(&sema, syntax, position)?;\n+    if def.range_for_rename(&sema).is_none() {\n+        bail!(\"No references found at position\")\n+    }\n+\n+    let frange = sema.original_range(name_like.syntax());\n+    always!(frange.range.contains_inclusive(position.offset) && frange.file_id == position.file_id);\n     Ok(RangeInfo::new(frange.range, ()))\n }\n \n@@ -55,31 +58,23 @@ pub(crate) fn rename(\n     new_name: &str,\n ) -> RenameResult<SourceChange> {\n     let sema = Semantics::new(db);\n-    rename_with_semantics(&sema, position, new_name)\n-}\n-\n-pub(crate) fn rename_with_semantics(\n-    sema: &Semantics<RootDatabase>,\n-    position: FilePosition,\n-    new_name: &str,\n-) -> RenameResult<SourceChange> {\n     let source_file = sema.parse(position.file_id);\n     let syntax = source_file.syntax();\n \n-    let def = find_definition(sema, syntax, position)?;\n+    let (_name_like, def) = find_definition(&sema, syntax, position)?;\n \n     if let Definition::Local(local) = def {\n         if let Some(self_param) = local.as_self_param(sema.db) {\n             cov_mark::hit!(rename_self_to_param);\n-            return rename_self_to_param(sema, local, self_param, new_name);\n+            return rename_self_to_param(&sema, local, self_param, new_name);\n         }\n         if new_name == \"self\" {\n             cov_mark::hit!(rename_to_self);\n-            return rename_to_self(sema, local);\n+            return rename_to_self(&sema, local);\n         }\n     }\n \n-    def.rename(sema, new_name)\n+    def.rename(&sema, new_name)\n }\n \n /// Called by the client when it is about to rename a file.\n@@ -100,11 +95,12 @@ fn find_definition(\n     sema: &Semantics<RootDatabase>,\n     syntax: &SyntaxNode,\n     position: FilePosition,\n-) -> RenameResult<Definition> {\n-    match sema\n-        .find_node_at_offset_with_descend(syntax, position.offset)\n-        .ok_or_else(|| format_err!(\"No references found at position\"))?\n-    {\n+) -> RenameResult<(ast::NameLike, Definition)> {\n+    let name_like = sema\n+        .find_node_at_offset_with_descend::<ast::NameLike>(syntax, position.offset)\n+        .ok_or_else(|| format_err!(\"No references found at position\"))?;\n+\n+    let def = match &name_like {\n         // renaming aliases would rename the item being aliased as the HIR doesn't track aliases yet\n         ast::NameLike::Name(name)\n             if name.syntax().parent().map_or(false, |it| ast::Rename::can_cast(it.kind())) =>\n@@ -134,7 +130,9 @@ fn find_definition(\n                     .map(|it| it.referenced_or_defined(sema.db))\n             }),\n     }\n-    .ok_or_else(|| format_err!(\"No references found at position\"))\n+    .ok_or_else(|| format_err!(\"No references found at position\"))?;\n+\n+    Ok((name_like, def))\n }\n \n fn rename_to_self(sema: &Semantics<RootDatabase>, local: hir::Local) -> RenameResult<SourceChange> {\n@@ -328,7 +326,7 @@ mod tests {\n     fn test_prepare_rename_namelikes() {\n         check_prepare(r\"fn name$0<'lifetime>() {}\", expect![[r#\"3..7: name\"#]]);\n         check_prepare(r\"fn name<'lifetime$0>() {}\", expect![[r#\"8..17: 'lifetime\"#]]);\n-        check_prepare(r\"fn name<'lifetime>() { name$0(); }\", expect![[r#\"3..7: name\"#]]);\n+        check_prepare(r\"fn name<'lifetime>() { name$0(); }\", expect![[r#\"23..27: name\"#]]);\n     }\n \n     #[test]"}]}