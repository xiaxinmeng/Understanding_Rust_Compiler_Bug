{"sha": "68db72d8cd613f88ea69d37bcd159c4ff659aab1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4ZGI3MmQ4Y2Q2MTNmODhlYTY5ZDM3YmNkMTU5YzRmZjY1OWFhYjE=", "commit": {"author": {"name": "Marco A L Barbosa", "email": "malbarbo@gmail.com", "date": "2018-01-12T23:22:06Z"}, "committer": {"name": "Marco A L Barbosa", "email": "malbarbo@gmail.com", "date": "2018-01-22T18:14:51Z"}, "message": "Do not assume dynamic linking for musl/mips[el] targets\n\nAll musl targets except mips[el] assume static linking by default. This\ncan be confusing\nhttps://users.rust-lang.org/t/static-cross-compiled-binaries-arent-really-static/6084\n\nWhen the musl/mips[el] targets was\n[added](https://github.com/rust-lang/rust/pull/31298), dynamic linking\nwas chosen because of binary size concerns, and probably also because\nlibunwind\n[didn't](https://users.rust-lang.org/t/static-cross-compiled-binaries-arent-really-static/6084/8)\nsupported mips.\n\nNow that we have `crt-static` target-feature (the user can choose\ndynamic link for musl targets), and libunwind\n[6.0](https://github.com/llvm-mirror/libunwind/commits/release_60) add\nsupport to mips, we do not need to assume dynamic linking.", "tree": {"sha": "051cbd9f58fa05e54443ba553f1de9f720fdf6ba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/051cbd9f58fa05e54443ba553f1de9f720fdf6ba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68db72d8cd613f88ea69d37bcd159c4ff659aab1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68db72d8cd613f88ea69d37bcd159c4ff659aab1", "html_url": "https://github.com/rust-lang/rust/commit/68db72d8cd613f88ea69d37bcd159c4ff659aab1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68db72d8cd613f88ea69d37bcd159c4ff659aab1/comments", "author": {"login": "malbarbo", "id": 1678126, "node_id": "MDQ6VXNlcjE2NzgxMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1678126?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malbarbo", "html_url": "https://github.com/malbarbo", "followers_url": "https://api.github.com/users/malbarbo/followers", "following_url": "https://api.github.com/users/malbarbo/following{/other_user}", "gists_url": "https://api.github.com/users/malbarbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/malbarbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malbarbo/subscriptions", "organizations_url": "https://api.github.com/users/malbarbo/orgs", "repos_url": "https://api.github.com/users/malbarbo/repos", "events_url": "https://api.github.com/users/malbarbo/events{/privacy}", "received_events_url": "https://api.github.com/users/malbarbo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "malbarbo", "id": 1678126, "node_id": "MDQ6VXNlcjE2NzgxMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1678126?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malbarbo", "html_url": "https://github.com/malbarbo", "followers_url": "https://api.github.com/users/malbarbo/followers", "following_url": "https://api.github.com/users/malbarbo/following{/other_user}", "gists_url": "https://api.github.com/users/malbarbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/malbarbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malbarbo/subscriptions", "organizations_url": "https://api.github.com/users/malbarbo/orgs", "repos_url": "https://api.github.com/users/malbarbo/repos", "events_url": "https://api.github.com/users/malbarbo/events{/privacy}", "received_events_url": "https://api.github.com/users/malbarbo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fdc18b3067b5bad257ccbe7400e3c4fb617e9e18", "url": "https://api.github.com/repos/rust-lang/rust/commits/fdc18b3067b5bad257ccbe7400e3c4fb617e9e18", "html_url": "https://github.com/rust-lang/rust/commit/fdc18b3067b5bad257ccbe7400e3c4fb617e9e18"}], "stats": {"total": 94, "additions": 56, "deletions": 38}, "files": [{"sha": "c40b0ccbd780c526f93084d8e3ab4b7f95e9209a", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -80,7 +80,7 @@ impl Step for Std {\n \n             // Even if we're not building std this stage, the new sysroot must\n             // still contain the musl startup objects.\n-            if target.contains(\"musl\") && !target.contains(\"mips\") {\n+            if target.contains(\"musl\") {\n                 let libdir = builder.sysroot_libdir(compiler, target);\n                 copy_musl_third_party_objects(build, target, &libdir);\n             }\n@@ -97,7 +97,7 @@ impl Step for Std {\n         println!(\"Building stage{} std artifacts ({} -> {})\", compiler.stage,\n                 &compiler.host, target);\n \n-        if target.contains(\"musl\") && !target.contains(\"mips\") {\n+        if target.contains(\"musl\") {\n             let libdir = builder.sysroot_libdir(compiler, target);\n             copy_musl_third_party_objects(build, target, &libdir);\n         }"}, {"sha": "9a4b5e786e1923f697b24745bfab2c1c9445c344", "filename": "src/bootstrap/configure.py", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fbootstrap%2Fconfigure.py", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fbootstrap%2Fconfigure.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfigure.py?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -120,6 +120,10 @@ def v(*args):\n   \"armv7-unknown-linux-musleabihf install directory\")\n v(\"musl-root-aarch64\", \"target.aarch64-unknown-linux-musl.musl-root\",\n   \"aarch64-unknown-linux-musl install directory\")\n+v(\"musl-root-mips\", \"target.mips-unknown-linux-musl.musl-root\",\n+  \"mips-unknown-linux-musl install directory\")\n+v(\"musl-root-mipsel\", \"target.mipsel-unknown-linux-musl.musl-root\",\n+  \"mipsel-unknown-linux-musl install directory\")\n v(\"qemu-armhf-rootfs\", \"target.arm-unknown-linux-gnueabihf.qemu-rootfs\",\n   \"rootfs in qemu testing, you probably don't want to use this\")\n v(\"qemu-aarch64-rootfs\", \"target.aarch64-unknown-linux-gnu.qemu-rootfs\","}, {"sha": "5184cca653c4b156b55dded68955fff8921897f4", "filename": "src/bootstrap/sanity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fbootstrap%2Fsanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fbootstrap%2Fsanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsanity.rs?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -170,7 +170,7 @@ pub fn check(build: &mut Build) {\n         }\n \n         // Make sure musl-root is valid\n-        if target.contains(\"musl\") && !target.contains(\"mips\") {\n+        if target.contains(\"musl\") {\n             // If this is a native target (host is also musl) and no musl-root is given,\n             // fall back to the system toolchain in /usr before giving up\n             if build.musl_root(*target).is_none() && build.config.build == *target {"}, {"sha": "c195645efad4bcca062a4233623e2fb5b0675312", "filename": "src/ci/docker/dist-various-1/Dockerfile", "status": "modified", "additions": 21, "deletions": 10, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fci%2Fdocker%2Fdist-various-1%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fci%2Fdocker%2Fdist-various-1%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-1%2FDockerfile?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -30,6 +30,15 @@ RUN ./build-rumprun.sh\n COPY dist-various-1/install-x86_64-redox.sh /build\n RUN ./install-x86_64-redox.sh\n \n+COPY dist-various-1/install-mips-musl.sh /build\n+RUN ./install-mips-musl.sh\n+\n+COPY dist-various-1/install-mipsel-musl.sh /build\n+RUN ./install-mipsel-musl.sh\n+\n+# Suppress some warnings in the openwrt toolchains we downloaded\n+ENV STAGING_DIR=/tmp\n+\n COPY scripts/musl.sh /build\n RUN env \\\n     CC=arm-linux-gnueabi-gcc CFLAGS=\"-march=armv6 -marm\" \\\n@@ -47,14 +56,16 @@ RUN env \\\n     CC=aarch64-linux-gnu-gcc \\\n     CXX=aarch64-linux-gnu-g++ \\\n     bash musl.sh aarch64 && \\\n+    env \\\n+    CC=mips-openwrt-linux-gcc \\\n+    CXX=mips-openwrt-linux-g++ \\\n+    bash musl.sh mips && \\\n+    env \\\n+    CC=mipsel-openwrt-linux-gcc \\\n+    CXX=mipsel-openwrt-linux-g++ \\\n+    bash musl.sh mipsel && \\\n     rm -rf /build/*\n \n-COPY dist-various-1/install-mips-musl.sh /build\n-RUN ./install-mips-musl.sh\n-\n-COPY dist-various-1/install-mipsel-musl.sh /build\n-RUN ./install-mipsel-musl.sh\n-\n ENV TARGETS=asmjs-unknown-emscripten\n ENV TARGETS=$TARGETS,wasm32-unknown-emscripten\n ENV TARGETS=$TARGETS,x86_64-rumprun-netbsd\n@@ -77,16 +88,16 @@ ENV CC_mipsel_unknown_linux_musl=mipsel-openwrt-linux-gcc \\\n     CC_armv5te_unknown_linux_gnueabi=arm-linux-gnueabi-gcc \\\n     CFLAGS_armv5te_unknown_linux_gnueabi=\"-march=armv5te -marm -mfloat-abi=soft\"\n \n-# Suppress some warnings in the openwrt toolchains we downloaded\n-ENV STAGING_DIR=/tmp\n-\n ENV RUST_CONFIGURE_ARGS \\\n       --enable-extended \\\n       --target=$TARGETS \\\n       --musl-root-arm=/musl-arm \\\n       --musl-root-armhf=/musl-armhf \\\n       --musl-root-armv7=/musl-armv7 \\\n-      --musl-root-aarch64=/musl-aarch64\n+      --musl-root-aarch64=/musl-aarch64 \\\n+      --musl-root-mips=/musl-mips \\\n+      --musl-root-mipsel=/musl-mipsel\n+\n ENV SCRIPT python2.7 ../x.py dist --target $TARGETS\n \n # sccache"}, {"sha": "d08cdfeb445f261fb0d0f433c6664f02e95fe050", "filename": "src/ci/docker/scripts/musl.sh", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -49,7 +49,16 @@ hide_output make clean\n \n cd ..\n \n-LLVM=39\n+# use version 60 for all targets after llvm 6.0 release\n+case $TAG in\n+  mips|mipsel)\n+    LLVM=60\n+    ;;\n+  *)\n+    LLVM=39\n+    ;;\n+esac\n+\n # may have been downloaded in a previous run\n if [ ! -d libunwind-release_$LLVM ]; then\n   curl -L https://github.com/llvm-mirror/llvm/archive/release_$LLVM.tar.gz | tar xzf -"}, {"sha": "e1a3de34d018dc3250b07bbbea821ce987c38e90", "filename": "src/librustc_back/target/mips_unknown_linux_musl.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibrustc_back%2Ftarget%2Fmips_unknown_linux_musl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibrustc_back%2Ftarget%2Fmips_unknown_linux_musl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Ftarget%2Fmips_unknown_linux_musl.rs?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -9,9 +9,15 @@\n // except according to those terms.\n \n use LinkerFlavor;\n-use target::{Target, TargetOptions, TargetResult};\n+use target::{Target, TargetResult};\n \n pub fn target() -> TargetResult {\n+    let mut base = super::linux_musl_base::opts();\n+    base.cpu = \"mips32r2\".to_string();\n+    base.features = \"+mips32r2,+soft-float\".to_string();\n+    base.max_atomic_width = Some(32);\n+    // see #36994\n+    base.exe_allocation_crate = None;\n     Ok(Target {\n         llvm_target: \"mips-unknown-linux-musl\".to_string(),\n         target_endian: \"big\".to_string(),\n@@ -23,15 +29,6 @@ pub fn target() -> TargetResult {\n         target_env: \"musl\".to_string(),\n         target_vendor: \"unknown\".to_string(),\n         linker_flavor: LinkerFlavor::Gcc,\n-        options: TargetOptions {\n-            cpu: \"mips32r2\".to_string(),\n-            features: \"+mips32r2,+soft-float\".to_string(),\n-            max_atomic_width: Some(32),\n-\n-            // see #36994\n-            exe_allocation_crate: None,\n-\n-            ..super::linux_base::opts()\n-        }\n+        options: base,\n     })\n }"}, {"sha": "08c16af70d3a14d8ff653b7cd3e528167f3a42ae", "filename": "src/librustc_back/target/mipsel_unknown_linux_musl.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibrustc_back%2Ftarget%2Fmipsel_unknown_linux_musl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibrustc_back%2Ftarget%2Fmipsel_unknown_linux_musl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Ftarget%2Fmipsel_unknown_linux_musl.rs?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -9,9 +9,15 @@\n // except according to those terms.\n \n use LinkerFlavor;\n-use target::{Target, TargetOptions, TargetResult};\n+use target::{Target, TargetResult};\n \n pub fn target() -> TargetResult {\n+    let mut base = super::linux_musl_base::opts();\n+    base.cpu = \"mips32\".to_string();\n+    base.features = \"+mips32,+soft-float\".to_string();\n+    base.max_atomic_width = Some(32);\n+    // see #36994\n+    base.exe_allocation_crate = None;\n     Ok(Target {\n         llvm_target: \"mipsel-unknown-linux-musl\".to_string(),\n         target_endian: \"little\".to_string(),\n@@ -23,15 +29,6 @@ pub fn target() -> TargetResult {\n         target_env: \"musl\".to_string(),\n         target_vendor: \"unknown\".to_string(),\n         linker_flavor: LinkerFlavor::Gcc,\n-        options: TargetOptions {\n-            cpu: \"mips32\".to_string(),\n-            features: \"+mips32,+soft-float\".to_string(),\n-            max_atomic_width: Some(32),\n-\n-            // see #36994\n-            exe_allocation_crate: None,\n-\n-            ..super::linux_base::opts()\n-        }\n+        options: base,\n     })\n }"}, {"sha": "11c4c2faf134278e0650a1163b3b54c28c6bfad5", "filename": "src/libunwind/build.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibunwind%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibunwind%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibunwind%2Fbuild.rs?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -15,7 +15,7 @@ fn main() {\n     let target = env::var(\"TARGET\").expect(\"TARGET was not set\");\n \n     if target.contains(\"linux\") {\n-        if target.contains(\"musl\") && !target.contains(\"mips\") {\n+        if target.contains(\"musl\") {\n             // musl is handled in lib.rs\n         } else if !target.contains(\"android\") {\n             println!(\"cargo:rustc-link-lib=gcc_s\");"}, {"sha": "5347c781218ce4b947f10a3d2e11529a686abf04", "filename": "src/libunwind/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibunwind%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68db72d8cd613f88ea69d37bcd159c4ff659aab1/src%2Flibunwind%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibunwind%2Flib.rs?ref=68db72d8cd613f88ea69d37bcd159c4ff659aab1", "patch": "@@ -35,7 +35,7 @@ cfg_if! {\n     }\n }\n \n-#[cfg(all(target_env = \"musl\", not(target_arch = \"mips\")))]\n+#[cfg(target_env = \"musl\")]\n #[link(name = \"unwind\", kind = \"static\", cfg(target_feature = \"crt-static\"))]\n #[link(name = \"gcc_s\", cfg(not(target_feature = \"crt-static\")))]\n extern {}"}]}