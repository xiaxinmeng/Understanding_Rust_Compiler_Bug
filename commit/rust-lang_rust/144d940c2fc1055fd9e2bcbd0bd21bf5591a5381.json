{"sha": "144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0NGQ5NDBjMmZjMTA1NWZkOWUyYmNiZDBiZDIxYmY1NTkxYTUzODE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-09-09T14:13:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-09-09T14:13:55Z"}, "message": "Auto merge of #4510 - lzutao:unsep-literals-regression-macro-attr, r=flip1995\n\nFix regression in case of proc-macro attribute expansion\n\ncc  #4507\nchangelog: none\nr? @flip1995", "tree": {"sha": "2fb8e161ef970158e0b49e2290278064ab652298", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2fb8e161ef970158e0b49e2290278064ab652298"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "html_url": "https://github.com/rust-lang/rust/commit/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58e01ea4d7df69e658c034afbfa6d0abd90808ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/58e01ea4d7df69e658c034afbfa6d0abd90808ed", "html_url": "https://github.com/rust-lang/rust/commit/58e01ea4d7df69e658c034afbfa6d0abd90808ed"}, {"sha": "ca1c0aa8196c439b385f6038b5bb52924c4808f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca1c0aa8196c439b385f6038b5bb52924c4808f9", "html_url": "https://github.com/rust-lang/rust/commit/ca1c0aa8196c439b385f6038b5bb52924c4808f9"}], "stats": {"total": 50, "additions": 33, "deletions": 17}, "files": [{"sha": "7fcd9b7734c7ecaa338dc843b3242c2c4d4e62b5", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "patch": "@@ -1,5 +1,6 @@\n // error-pattern:cargo-clippy\n \n+#![feature(bind_by_move_pattern_guards)] // proposed to be stabilized in Rust v1.39\n #![feature(box_syntax)]\n #![feature(box_patterns)]\n #![feature(never_type)]"}, {"sha": "a9907ed132d01bc76a15dd4670d0edfefec4cce3", "filename": "clippy_lints/src/misc_early.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/clippy_lints%2Fsrc%2Fmisc_early.rs", "raw_url": "https://github.com/rust-lang/rust/raw/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/clippy_lints%2Fsrc%2Fmisc_early.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc_early.rs?ref=144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "patch": "@@ -430,15 +430,13 @@ impl EarlyLintPass for MiscEarlyLints {\n \n impl MiscEarlyLints {\n     fn check_lit(self, cx: &EarlyContext<'_>, lit: &Lit) {\n-        // The `line!()` macro is compiler built-in and a special case for these lints.\n+        // We test if first character in snippet is a number, because the snippet could be an expansion\n+        // from a built-in macro like `line!()` or a proc-macro like `#[wasm_bindgen]`.\n+        // Note that this check also covers special case that `line!()` is eagerly expanded by compiler.\n+        // See <https://github.com/rust-lang/rust-clippy/issues/4507> for a regression.\n+        // FIXME: Find a better way to detect those cases.\n         let lit_snip = match snippet_opt(cx, lit.span) {\n-            Some(snip) => {\n-                // The snip could be empty in case of expand from procedure macro\n-                if snip.is_empty() || snip.contains('!') {\n-                    return;\n-                }\n-                snip\n-            },\n+            Some(snip) if snip.chars().next().map_or(false, |c| c.is_digit(10)) => snip,\n             _ => return,\n         };\n "}, {"sha": "60ffd94e733236a14c1e126d5e9923ebedba76a7", "filename": "mini-macro/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/mini-macro%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/mini-macro%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mini-macro%2Fsrc%2Flib.rs?ref=144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "patch": "@@ -17,5 +17,8 @@ pub fn mini_macro(_: TokenStream) -> TokenStream {\n                 println!(\"{}\", items[i]);\n             }\n         }\n+        fn line_wrapper() {\n+            println!(\"{}\", line!());\n+        }\n     )\n }"}, {"sha": "3c422cc4fee72c5c8cfb2462e173cd88c84c40f7", "filename": "tests/ui/unseparated_prefix_literals.fixed", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/tests%2Fui%2Funseparated_prefix_literals.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/tests%2Fui%2Funseparated_prefix_literals.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funseparated_prefix_literals.fixed?ref=144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "patch": "@@ -3,6 +3,13 @@\n #![warn(clippy::unseparated_literal_suffix)]\n #![allow(dead_code)]\n \n+#[macro_use]\n+extern crate clippy_mini_macro_test;\n+\n+// Test for proc-macro attribute\n+#[derive(ClippyMiniMacroTest)]\n+struct Foo;\n+\n macro_rules! lit_from_macro {\n     () => {\n         42_usize"}, {"sha": "09608661e0ef58585afbb94a1d2fdc1fa2c36fee", "filename": "tests/ui/unseparated_prefix_literals.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/tests%2Fui%2Funseparated_prefix_literals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/tests%2Fui%2Funseparated_prefix_literals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funseparated_prefix_literals.rs?ref=144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "patch": "@@ -3,6 +3,13 @@\n #![warn(clippy::unseparated_literal_suffix)]\n #![allow(dead_code)]\n \n+#[macro_use]\n+extern crate clippy_mini_macro_test;\n+\n+// Test for proc-macro attribute\n+#[derive(ClippyMiniMacroTest)]\n+struct Foo;\n+\n macro_rules! lit_from_macro {\n     () => {\n         42usize"}, {"sha": "d353d34fb3575d30c2ed56ca8ccfef7022953b7d", "filename": "tests/ui/unseparated_prefix_literals.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/tests%2Fui%2Funseparated_prefix_literals.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/144d940c2fc1055fd9e2bcbd0bd21bf5591a5381/tests%2Fui%2Funseparated_prefix_literals.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funseparated_prefix_literals.stderr?ref=144d940c2fc1055fd9e2bcbd0bd21bf5591a5381", "patch": "@@ -1,49 +1,49 @@\n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:16:18\n+  --> $DIR/unseparated_prefix_literals.rs:23:18\n    |\n LL |     let _fail1 = 1234i32;\n    |                  ^^^^^^^ help: add an underscore: `1234_i32`\n    |\n    = note: `-D clippy::unseparated-literal-suffix` implied by `-D warnings`\n \n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:17:18\n+  --> $DIR/unseparated_prefix_literals.rs:24:18\n    |\n LL |     let _fail2 = 1234u32;\n    |                  ^^^^^^^ help: add an underscore: `1234_u32`\n \n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:18:18\n+  --> $DIR/unseparated_prefix_literals.rs:25:18\n    |\n LL |     let _fail3 = 1234isize;\n    |                  ^^^^^^^^^ help: add an underscore: `1234_isize`\n \n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:19:18\n+  --> $DIR/unseparated_prefix_literals.rs:26:18\n    |\n LL |     let _fail4 = 1234usize;\n    |                  ^^^^^^^^^ help: add an underscore: `1234_usize`\n \n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:20:18\n+  --> $DIR/unseparated_prefix_literals.rs:27:18\n    |\n LL |     let _fail5 = 0x123isize;\n    |                  ^^^^^^^^^^ help: add an underscore: `0x123_isize`\n \n error: float type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:24:19\n+  --> $DIR/unseparated_prefix_literals.rs:31:19\n    |\n LL |     let _failf1 = 1.5f32;\n    |                   ^^^^^^ help: add an underscore: `1.5_f32`\n \n error: float type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:25:19\n+  --> $DIR/unseparated_prefix_literals.rs:32:19\n    |\n LL |     let _failf2 = 1f32;\n    |                   ^^^^ help: add an underscore: `1_f32`\n \n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:8:9\n+  --> $DIR/unseparated_prefix_literals.rs:15:9\n    |\n LL |         42usize\n    |         ^^^^^^^ help: add an underscore: `42_usize`\n@@ -52,7 +52,7 @@ LL |     let _ = lit_from_macro!();\n    |             ----------------- in this macro invocation\n \n error: integer type suffix should be separated by an underscore\n-  --> $DIR/unseparated_prefix_literals.rs:33:16\n+  --> $DIR/unseparated_prefix_literals.rs:40:16\n    |\n LL |     assert_eq!(4897u32, 32223);\n    |                ^^^^^^^ help: add an underscore: `4897_u32`"}]}