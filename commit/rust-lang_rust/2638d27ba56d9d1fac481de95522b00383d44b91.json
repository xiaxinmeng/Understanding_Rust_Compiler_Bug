{"sha": "2638d27ba56d9d1fac481de95522b00383d44b91", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI2MzhkMjdiYTU2ZDlkMWZhYzQ4MWRlOTU1MjJiMDAzODNkNDRiOTE=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-08-22T18:52:53Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-22T18:52:53Z"}, "message": "Rollup merge of #88164 - durin42:llvm-14-san-opts, r=nikic\n\nPassWrapper: adapt for LLVM 14 changes\n\nThese API changes appear to have all taken place in\nhttps://reviews.llvm.org/D105007, which moved HWAddressSanitizerPass and\nAddressSanitizerPass to only accept their options type as a ctor\nargument instead of the sequence of bools etc. This required a couple of\nparameter additions, which I made match the default prior to the\nmentioned upstream LLVM change.\n\nThis patch restores rustc to building (though not quite passing all\ntests, I've mailed other patches for those issues) against LLVM HEAD.", "tree": {"sha": "8a2806c5d43b7790db41e8132b8eb8bfdc124341", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8a2806c5d43b7790db41e8132b8eb8bfdc124341"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2638d27ba56d9d1fac481de95522b00383d44b91", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhIp0FCRBK7hj4Ov3rIwAAJtAIAECeZi5AP0gbMw/VgUA+Y6E/\njjU8Wv350VCkW1vUVinxK285iHWG2U8AIQHWqeMBVLnkLaOWGlz7Jz5VzpZwgBDh\nbReQh+WIlUZMHkz+Scj3GlErOwxqKfXSwO3IMNI3hKM3OjQyOOhEtB/bZhrN7h2h\nF7niWzJL59WvuFh+D4ppd4Z6H2QaWcXBgxXpWZSnlKnmtvoJgkRvZa5kkozQpSXm\nj+YDvTsA+ZQLtskfCV7A/jZEBO1UZxjkFvlarYv6W87/oxmjylOMh3TiPJdIMDC7\noirgrGuKF8osnUpL12fw3R55cAyPT8sA0JRQmeLyn0PA0ucGafU2WZp0rlCtnbU=\n=m59O\n-----END PGP SIGNATURE-----\n", "payload": "tree 8a2806c5d43b7790db41e8132b8eb8bfdc124341\nparent c6da5b08e0177d0b9053cd7dd6be422ee047d671\nparent c4e6185385148ec964d2765957a83bdf3df7b112\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1629658373 +0200\ncommitter GitHub <noreply@github.com> 1629658373 +0200\n\nRollup merge of #88164 - durin42:llvm-14-san-opts, r=nikic\n\nPassWrapper: adapt for LLVM 14 changes\n\nThese API changes appear to have all taken place in\nhttps://reviews.llvm.org/D105007, which moved HWAddressSanitizerPass and\nAddressSanitizerPass to only accept their options type as a ctor\nargument instead of the sequence of bools etc. This required a couple of\nparameter additions, which I made match the default prior to the\nmentioned upstream LLVM change.\n\nThis patch restores rustc to building (though not quite passing all\ntests, I've mailed other patches for those issues) against LLVM HEAD.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2638d27ba56d9d1fac481de95522b00383d44b91", "html_url": "https://github.com/rust-lang/rust/commit/2638d27ba56d9d1fac481de95522b00383d44b91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2638d27ba56d9d1fac481de95522b00383d44b91/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c6da5b08e0177d0b9053cd7dd6be422ee047d671", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6da5b08e0177d0b9053cd7dd6be422ee047d671", "html_url": "https://github.com/rust-lang/rust/commit/c6da5b08e0177d0b9053cd7dd6be422ee047d671"}, {"sha": "c4e6185385148ec964d2765957a83bdf3df7b112", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4e6185385148ec964d2765957a83bdf3df7b112", "html_url": "https://github.com/rust-lang/rust/commit/c4e6185385148ec964d2765957a83bdf3df7b112"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "b3f86f3295ae90f602a1f5272f7221956815d56d", "filename": "compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/2638d27ba56d9d1fac481de95522b00383d44b91/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/2638d27ba56d9d1fac481de95522b00383d44b91/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp?ref=2638d27ba56d9d1fac481de95522b00383d44b91", "patch": "@@ -922,9 +922,17 @@ LLVMRustOptimizeWithNewPassManager(\n           MPM.addPass(RequireAnalysisPass<ASanGlobalsMetadataAnalysis, Module>());\n           MPM.addPass(ModuleAddressSanitizerPass(\n               /*CompileKernel=*/false, SanitizerOptions->SanitizeAddressRecover));\n+#if LLVM_VERSION_GE(14, 0)\n+          AddressSanitizerOptions opts(/*CompileKernel=*/false,\n+                                       SanitizerOptions->SanitizeAddressRecover,\n+                                       /*UseAfterScope=*/true,\n+                                       AsanDetectStackUseAfterReturnMode::Runtime);\n+          MPM.addPass(createModuleToFunctionPassAdaptor(AddressSanitizerPass(opts)));\n+#else\n           MPM.addPass(createModuleToFunctionPassAdaptor(AddressSanitizerPass(\n               /*CompileKernel=*/false, SanitizerOptions->SanitizeAddressRecover,\n               /*UseAfterScope=*/true)));\n+#endif\n         }\n       );\n #else\n@@ -952,8 +960,15 @@ LLVMRustOptimizeWithNewPassManager(\n #if LLVM_VERSION_GE(11, 0)\n       OptimizerLastEPCallbacks.push_back(\n         [SanitizerOptions](ModulePassManager &MPM, OptimizationLevel Level) {\n+#if LLVM_VERSION_GE(14, 0)\n+          HWAddressSanitizerOptions opts(\n+              /*CompileKernel=*/false, SanitizerOptions->SanitizeHWAddressRecover,\n+              /*DisableOptimization=*/false);\n+          MPM.addPass(HWAddressSanitizerPass(opts));\n+#else\n           MPM.addPass(HWAddressSanitizerPass(\n               /*CompileKernel=*/false, SanitizerOptions->SanitizeHWAddressRecover));\n+#endif\n         }\n       );\n #else"}]}