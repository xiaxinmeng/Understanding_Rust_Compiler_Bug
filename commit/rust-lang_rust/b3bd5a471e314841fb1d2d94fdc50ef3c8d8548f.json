{"sha": "b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "node_id": "C_kwDOAAsO6NoAKGIzYmQ1YTQ3MWUzMTQ4NDFmYjFkMmQ5NGZkYzUwZWYzYzhkODU0OGY", "commit": {"author": {"name": "Crauzer", "email": "filip.quitko@gmail.com", "date": "2022-11-28T23:32:13Z"}, "committer": {"name": "Crauzer", "email": "filip.quitko@gmail.com", "date": "2022-11-28T23:32:13Z"}, "message": "implement vararg type collection from function params", "tree": {"sha": "134b526742108abec41dc37eeba6a7ac7d6dd1df", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/134b526742108abec41dc37eeba6a7ac7d6dd1df"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "html_url": "https://github.com/rust-lang/rust/commit/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/comments", "author": {"login": "Crauzer", "id": 18646077, "node_id": "MDQ6VXNlcjE4NjQ2MDc3", "avatar_url": "https://avatars.githubusercontent.com/u/18646077?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Crauzer", "html_url": "https://github.com/Crauzer", "followers_url": "https://api.github.com/users/Crauzer/followers", "following_url": "https://api.github.com/users/Crauzer/following{/other_user}", "gists_url": "https://api.github.com/users/Crauzer/gists{/gist_id}", "starred_url": "https://api.github.com/users/Crauzer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Crauzer/subscriptions", "organizations_url": "https://api.github.com/users/Crauzer/orgs", "repos_url": "https://api.github.com/users/Crauzer/repos", "events_url": "https://api.github.com/users/Crauzer/events{/privacy}", "received_events_url": "https://api.github.com/users/Crauzer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Crauzer", "id": 18646077, "node_id": "MDQ6VXNlcjE4NjQ2MDc3", "avatar_url": "https://avatars.githubusercontent.com/u/18646077?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Crauzer", "html_url": "https://github.com/Crauzer", "followers_url": "https://api.github.com/users/Crauzer/followers", "following_url": "https://api.github.com/users/Crauzer/following{/other_user}", "gists_url": "https://api.github.com/users/Crauzer/gists{/gist_id}", "starred_url": "https://api.github.com/users/Crauzer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Crauzer/subscriptions", "organizations_url": "https://api.github.com/users/Crauzer/orgs", "repos_url": "https://api.github.com/users/Crauzer/repos", "events_url": "https://api.github.com/users/Crauzer/events{/privacy}", "received_events_url": "https://api.github.com/users/Crauzer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d61be8e65ac0fd45eaf178e1f7a1ec6b582de1f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d61be8e65ac0fd45eaf178e1f7a1ec6b582de1f", "html_url": "https://github.com/rust-lang/rust/commit/6d61be8e65ac0fd45eaf178e1f7a1ec6b582de1f"}], "stats": {"total": 32, "additions": 31, "deletions": 1}, "files": [{"sha": "259fe1327f888d1bdf932809ef6ba18801ea5b57", "filename": "crates/hir-expand/src/name.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/crates%2Fhir-expand%2Fsrc%2Fname.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/crates%2Fhir-expand%2Fsrc%2Fname.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-expand%2Fsrc%2Fname.rs?ref=b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "patch": "@@ -419,6 +419,7 @@ pub mod known {\n         shr,\n         sub_assign,\n         sub,\n+        va_list\n     );\n \n     // self/Self cannot be used as an identifier"}, {"sha": "112eb5bd84cde62a1672b019b804057254659a37", "filename": "crates/hir-ty/src/infer.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/crates%2Fhir-ty%2Fsrc%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/crates%2Fhir-ty%2Fsrc%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer.rs?ref=b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "patch": "@@ -537,8 +537,20 @@ impl<'a> InferenceContext<'a> {\n         let data = self.db.function_data(func);\n         let ctx = crate::lower::TyLoweringContext::new(self.db, &self.resolver)\n             .with_impl_trait_mode(ImplTraitLoweringMode::Param);\n-        let param_tys =\n+        let mut param_tys =\n             data.params.iter().map(|(_, type_ref)| ctx.lower_ty(type_ref)).collect::<Vec<_>>();\n+        // Check if function contains a va_list, if it does then we append it to the parameter types\n+        // that are collected from the function data\n+        if data.is_varargs() {\n+            let va_list_ty = match self.resolve_va_list() {\n+                Some(va_list) => TyBuilder::adt(self.db, va_list)\n+                    .fill_with_defaults(self.db, || self.table.new_type_var())\n+                    .build(),\n+                None => self.err_ty(),\n+            };\n+\n+            param_tys.push(va_list_ty)\n+        }\n         for (ty, pat) in param_tys.into_iter().zip(self.body.params.iter()) {\n             let ty = self.insert_type_vars(ty);\n             let ty = self.normalize_associated_types_in(ty);\n@@ -983,6 +995,11 @@ impl<'a> InferenceContext<'a> {\n         let trait_ = self.resolve_ops_index()?;\n         self.db.trait_data(trait_).associated_type_by_name(&name![Output])\n     }\n+\n+    fn resolve_va_list(&self) -> Option<AdtId> {\n+        let struct_ = self.resolve_lang_item(name![va_list])?.as_struct()?;\n+        Some(struct_.into())\n+    }\n }\n \n /// When inferring an expression, we propagate downward whatever type hint we"}, {"sha": "9333e2693522bceba97bb55e2ea20a7cf8c3b0b7", "filename": "crates/hir-ty/src/tests/patterns.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/crates%2Fhir-ty%2Fsrc%2Ftests%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f/crates%2Fhir-ty%2Fsrc%2Ftests%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fpatterns.rs?ref=b3bd5a471e314841fb1d2d94fdc50ef3c8d8548f", "patch": "@@ -1080,3 +1080,15 @@ fn my_fn(#[cfg(feature = \"feature\")] u8: u8, u32: u32) {}\n \"#,\n     );\n }\n+\n+#[test]\n+fn var_args() {\n+    check_types(\n+        r#\"\n+#[lang = \"va_list\"]\n+pub struct VaListImpl<'f>;\n+fn my_fn(foo: ...) {}\n+       //^^^ VaListImpl\n+\"#,\n+    );\n+}"}]}