{"sha": "44b964147e8bed485ff5993e86f8e32a5c915489", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0Yjk2NDE0N2U4YmVkNDg1ZmY1OTkzZTg2ZjhlMzJhNWM5MTU0ODk=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-01-30T09:10:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-01-30T09:10:54Z"}, "message": "Rollup merge of #47780 - varkor:cross-file-errors-line-col, r=estebank\n\nAdd line numbers and columns to error messages spanning multiple files\n\nIf an error message is emitted that spans several files, only the\nprimary file currently has line and column data attached. This is\nuseful information, even in files other than the one in which the error\noccurs. We can often work out which line and column the error\ncorresponds to in other files \u2014 in this case it is helpful to add them\n(in the case of ambiguity, the first relevant line/column is picked,\nwhich is still helpful than none).", "tree": {"sha": "f098d25452fff0b58de440222c7e3d9a006733dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f098d25452fff0b58de440222c7e3d9a006733dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/44b964147e8bed485ff5993e86f8e32a5c915489", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/44b964147e8bed485ff5993e86f8e32a5c915489", "html_url": "https://github.com/rust-lang/rust/commit/44b964147e8bed485ff5993e86f8e32a5c915489", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/44b964147e8bed485ff5993e86f8e32a5c915489/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4dbfc8ddbfd091aefa4b0af674b6625378ce34fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/4dbfc8ddbfd091aefa4b0af674b6625378ce34fe", "html_url": "https://github.com/rust-lang/rust/commit/4dbfc8ddbfd091aefa4b0af674b6625378ce34fe"}, {"sha": "a21b7b3b162932011b83f4703fb87030c216e962", "url": "https://api.github.com/repos/rust-lang/rust/commits/a21b7b3b162932011b83f4703fb87030c216e962", "html_url": "https://github.com/rust-lang/rust/commit/a21b7b3b162932011b83f4703fb87030c216e962"}], "stats": {"total": 77, "additions": 69, "deletions": 8}, "files": [{"sha": "ffb5efd93ed54fad04029b4638b20703e95ab719", "filename": "src/librustc_errors/emitter.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Flibrustc_errors%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Flibrustc_errors%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Femitter.rs?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -1014,8 +1014,21 @@ impl EmitterWriter {\n \n                 // Then, the secondary file indicator\n                 buffer.prepend(buffer_msg_line_offset + 1, \"::: \", Style::LineNumber);\n+                let loc = if let Some(first_line) = annotated_file.lines.first() {\n+                    let col = if let Some(first_annotation) = first_line.annotations.first() {\n+                        format!(\":{}\", first_annotation.start_col + 1)\n+                    } else {\n+                        \"\".to_string()\n+                    };\n+                    format!(\"{}:{}{}\",\n+                            annotated_file.file.name,\n+                            cm.doctest_offset_line(first_line.line_index),\n+                            col)\n+                } else {\n+                    annotated_file.file.name.to_string()\n+                };\n                 buffer.append(buffer_msg_line_offset + 1,\n-                              &annotated_file.file.name.to_string(),\n+                              &loc,\n                               Style::LineAndColumn);\n                 for _ in 0..max_line_num_len {\n                     buffer.prepend(buffer_msg_line_offset + 1, \" \", Style::NoStyle);"}, {"sha": "6035f33c822cee1eedf6b87ad412c1b4d9f87fb8", "filename": "src/librustc_errors/snippet.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Flibrustc_errors%2Fsnippet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Flibrustc_errors%2Fsnippet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Fsnippet.rs?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -27,7 +27,8 @@ pub struct FileInfo {\n \n     /// The \"primary file\", if any, gets a `-->` marker instead of\n     /// `>>>`, and has a line-number/column printed and not just a\n-    /// filename.  It appears first in the listing. It is known to\n+    /// filename (other files are not guaranteed to have line numbers\n+    /// or columns). It appears first in the listing. It is known to\n     /// contain at least one primary span, though primary spans (which\n     /// are designated with `^^^`) may also occur in other files.\n     primary_span: Option<Span>,"}, {"sha": "8eae79a21a9832c2946df3deea3cf662c7f6904a", "filename": "src/test/ui/cross-file-errors/main.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fcross-file-errors%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fcross-file-errors%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcross-file-errors%2Fmain.rs?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[macro_use]\n+mod underscore;\n+\n+fn main() {\n+    underscore!();\n+}"}, {"sha": "a1cdae10edfcdf631b98b172c665d6395f20d28d", "filename": "src/test/ui/cross-file-errors/main.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fcross-file-errors%2Fmain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fcross-file-errors%2Fmain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcross-file-errors%2Fmain.stderr?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -0,0 +1,11 @@\n+error: expected expression, found `_`\n+  --> $DIR/underscore.rs:18:9\n+   |\n+18 |         _\n+   |         ^\n+   | \n+  ::: $DIR/main.rs:15:5\n+   |\n+15 |     underscore!();\n+   |     -------------- in this macro invocation\n+"}, {"sha": "312b3b8f4ddd5b8823248cd9a5cf7ee248533a8a", "filename": "src/test/ui/cross-file-errors/underscore.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fcross-file-errors%2Funderscore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fcross-file-errors%2Funderscore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcross-file-errors%2Funderscore.rs?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// We want this file only so we can test cross-file error\n+// messages, but we don't want it in an external crate.\n+// ignore-test\n+#![crate_type = \"lib\"]\n+\n+macro_rules! underscore {\n+    () => (\n+        _\n+    )\n+}"}, {"sha": "48138ee711b3fbb01d0a4854e0b2544ffbcdfbd8", "filename": "src/test/ui/macro_backtrace/main.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.stderr?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -22,7 +22,7 @@ error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found\n 27 |       ping!();\n    |       -------- in this macro invocation\n    | \n-  ::: <ping macros>\n+  ::: <ping macros>:1:1\n    |\n 1  |   (  ) => { pong ! (  ) ; }\n    |   -------------------------\n@@ -42,31 +42,31 @@ error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found\n 28 |       deep!();\n    |       -------- in this macro invocation (#1)\n    | \n-  ::: <deep macros>\n+  ::: <deep macros>:1:1\n    |\n 1  |   (  ) => { foo ! (  ) ; }\n    |   ------------------------\n    |   |         |\n    |   |         in this macro invocation (#2)\n    |   in this expansion of `deep!` (#1)\n    | \n-  ::: <foo macros>\n+  ::: <foo macros>:1:1\n    |\n 1  |   (  ) => { bar ! (  ) ; }\n    |   ------------------------\n    |   |         |\n    |   |         in this macro invocation (#3)\n    |   in this expansion of `foo!` (#2)\n    | \n-  ::: <bar macros>\n+  ::: <bar macros>:1:1\n    |\n 1  |   (  ) => { ping ! (  ) ; }\n    |   -------------------------\n    |   |         |\n    |   |         in this macro invocation (#4)\n    |   in this expansion of `bar!` (#3)\n    | \n-  ::: <ping macros>\n+  ::: <ping macros>:1:1\n    |\n 1  |   (  ) => { pong ! (  ) ; }\n    |   -------------------------"}, {"sha": "abf62a060b83b388f77c00a8c6f3d355891ebb27", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44b964147e8bed485ff5993e86f8e32a5c915489/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=44b964147e8bed485ff5993e86f8e32a5c915489", "patch": "@@ -1402,7 +1402,7 @@ impl<'test> TestCx<'test> {\n     }\n \n     /// For each `aux-build: foo/bar` annotation, we check to find the\n-    /// file in a `aux` directory relative to the test itself.\n+    /// file in a `auxiliary` directory relative to the test itself.\n     fn compute_aux_test_paths(&self, rel_ab: &str) -> TestPaths {\n         let test_ab = self.testpaths\n             .file"}]}