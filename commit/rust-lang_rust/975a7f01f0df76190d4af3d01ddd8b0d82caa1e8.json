{"sha": "975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3NWE3ZjAxZjBkZjc2MTkwZDRhZjNkMDFkZGQ4YjBkODJjYWExZTg=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2018-12-23T22:09:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-12-23T22:09:14Z"}, "message": "Rollup merge of #57067 - Centril:stabilize-min_const_unsafe_fn, r=oli-obk\n\nStabilize min_const_unsafe_fn in 1.33\n\nFixes #55607\n\nr? @oli-obk", "tree": {"sha": "95ce350f74f1802b25e3cdcef283710e995a2391", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/95ce350f74f1802b25e3cdcef283710e995a2391"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcIAeKCRBK7hj4Ov3rIwAAdHIIABSiT4xx9557DIoyysrAHMo8\nqLgWAwyQr+RK/zQznzNuY+zMyfppWUzxb2peyKKdm0c4ZpG+P5+uSpkH6BnXtbKi\nhU6jwfAirtJChZOLFpcrqAFlEvisSjF+qMVlzU8MYLnCcgEw3k0FFTRQ2t9ynCt0\n8jRXGnLwafJVBAh9Q8XQRgMSKMGBqdWxZ3bvebrhoFrh5j6laNNT3c8oP3+lvICa\ne1F+mxz97YBQTjzWb606ckClbbsTjV4cRahxDsuP8zFWiVXzdj98aTcWJEQcjPyr\nWnVoxGDuQ+1NSNF/MPb1OPq2QqbKd2WSF3LYOK/k9tzTnkCI73BgmugMkNsuqgc=\n=9KlI\n-----END PGP SIGNATURE-----\n", "payload": "tree 95ce350f74f1802b25e3cdcef283710e995a2391\nparent e4826775f2a590c75659ba002b0461363ee4a386\nparent 7ae6fb215250d7515cc1ff7545c37d589104eda0\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1545602954 +0100\ncommitter GitHub <noreply@github.com> 1545602954 +0100\n\nRollup merge of #57067 - Centril:stabilize-min_const_unsafe_fn, r=oli-obk\n\nStabilize min_const_unsafe_fn in 1.33\n\nFixes #55607\n\nr? @oli-obk\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "html_url": "https://github.com/rust-lang/rust/commit/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4826775f2a590c75659ba002b0461363ee4a386", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4826775f2a590c75659ba002b0461363ee4a386", "html_url": "https://github.com/rust-lang/rust/commit/e4826775f2a590c75659ba002b0461363ee4a386"}, {"sha": "7ae6fb215250d7515cc1ff7545c37d589104eda0", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ae6fb215250d7515cc1ff7545c37d589104eda0", "html_url": "https://github.com/rust-lang/rust/commit/7ae6fb215250d7515cc1ff7545c37d589104eda0"}], "stats": {"total": 263, "additions": 79, "deletions": 184}, "files": [{"sha": "6852e2c69618b302c5ae21d9a1cf79528b1f127d", "filename": "src/librustc/ich/impls_mir.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_mir.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -47,7 +47,6 @@ impl_stable_hash_for!(enum mir::BorrowKind {\n impl_stable_hash_for!(enum mir::UnsafetyViolationKind {\n     General,\n     GeneralAndConstFn,\n-    GatedConstFnCall,\n     ExternStatic(lint_node_id),\n     BorrowPacked(lint_node_id),\n });"}, {"sha": "120350a573b6e502245daeb0de379e52da60edfe", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -2792,9 +2792,6 @@ impl Location {\n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, RustcEncodable, RustcDecodable)]\n pub enum UnsafetyViolationKind {\n     General,\n-    /// Right now function calls to `const unsafe fn` are only permitted behind a feature gate\n-    /// Also, even `const unsafe fn` need an `unsafe` block to do the allowed operations.\n-    GatedConstFnCall,\n     /// Permitted in const fn and regular fns\n     GeneralAndConstFn,\n     ExternStatic(ast::NodeId),"}, {"sha": "89d9c03f74e3e9baf40ca5ed5dfc86487f2f62c2", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 1, "deletions": 28, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -23,7 +23,6 @@ use rustc::mir::visit::{PlaceContext, Visitor, MutatingUseContext};\n \n use syntax::ast;\n use syntax::symbol::Symbol;\n-use syntax::feature_gate::{emit_feature_err, GateIssue};\n \n use std::ops::Bound;\n \n@@ -97,7 +96,7 @@ impl<'a, 'tcx> Visitor<'tcx> for UnsafetyChecker<'a, 'tcx> {\n                 if let hir::Unsafety::Unsafe = sig.unsafety() {\n                     self.require_unsafe(\"call to unsafe function\",\n                         \"consult the function's documentation for information on how to avoid \\\n-                         undefined behavior\", UnsafetyViolationKind::GatedConstFnCall)\n+                         undefined behavior\", UnsafetyViolationKind::GeneralAndConstFn)\n                 }\n             }\n         }\n@@ -325,11 +324,6 @@ impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n                             // compat lint\n                             violation.kind = UnsafetyViolationKind::General;\n                         },\n-                        UnsafetyViolationKind::GatedConstFnCall => {\n-                            // safe code can't call unsafe const fns, this `UnsafetyViolationKind`\n-                            // is only relevant for `Safety::ExplicitUnsafe` in `unsafe const fn`s\n-                            violation.kind = UnsafetyViolationKind::General;\n-                        }\n                     }\n                     if !self.violations.contains(&violation) {\n                         self.violations.push(violation)\n@@ -346,19 +340,8 @@ impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n                 }\n                 // only some unsafety is allowed in const fn\n                 if self.min_const_fn {\n-                    let min_const_unsafe_fn = self.tcx.features().min_const_unsafe_fn;\n                     for violation in violations {\n                         match violation.kind {\n-                            UnsafetyViolationKind::GatedConstFnCall if min_const_unsafe_fn => {\n-                                // these function calls to unsafe functions are allowed\n-                                // if `#![feature(min_const_unsafe_fn)]` is active\n-                            },\n-                            UnsafetyViolationKind::GatedConstFnCall => {\n-                                // without the feature gate, we report errors\n-                                if !self.violations.contains(&violation) {\n-                                    self.violations.push(violation.clone())\n-                                }\n-                            }\n                             // these unsafe things are stable in const fn\n                             UnsafetyViolationKind::GeneralAndConstFn => {},\n                             // these things are forbidden in const fns\n@@ -620,16 +603,6 @@ pub fn check_unsafety<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, def_id: DefId) {\n                     .note(&details.as_str()[..])\n                     .emit();\n             }\n-            UnsafetyViolationKind::GatedConstFnCall => {\n-                emit_feature_err(\n-                    &tcx.sess.parse_sess,\n-                    \"min_const_unsafe_fn\",\n-                    source_info.span,\n-                    GateIssue::Language,\n-                    \"calls to `const unsafe fn` in const fns are unstable\",\n-                );\n-\n-            }\n             UnsafetyViolationKind::ExternStatic(lint_node_id) => {\n                 tcx.lint_node_note(SAFE_EXTERN_STATICS,\n                               lint_node_id,"}, {"sha": "5bede9eafc14d8e8236f6cb537f41a95f52bc4f7", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -273,7 +273,6 @@\n #![feature(libc)]\n #![feature(link_args)]\n #![feature(linkage)]\n-#![cfg_attr(not(stage0), feature(min_const_unsafe_fn))]\n #![feature(needs_panic_runtime)]\n #![feature(never_type)]\n #![feature(nll)]"}, {"sha": "2238e429a58e01a1c077667cf496538cfd6c341c", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -486,9 +486,6 @@ declare_features! (\n \n     // `extern crate self as foo;` puts local crate root into extern prelude under name `foo`.\n     (active, extern_crate_self, \"1.31.0\", Some(56409), None),\n-\n-    // Allows calling `const unsafe fn` inside `unsafe` blocks in `const fn` functions.\n-    (active, min_const_unsafe_fn, \"1.31.0\", Some(55607), None),\n );\n \n declare_features! (\n@@ -694,6 +691,8 @@ declare_features! (\n     (accepted, underscore_imports, \"1.33.0\", Some(48216), None),\n     // Allows `#[repr(packed(N))]` attribute on structs.\n     (accepted, repr_packed, \"1.33.0\", Some(33158), None),\n+    // Allows calling `const unsafe fn` inside `unsafe` blocks in `const fn` functions.\n+    (accepted, min_const_unsafe_fn, \"1.33.0\", Some(55607), None),\n );\n \n // If you change this, please modify `src/doc/unstable-book` as well. You must"}, {"sha": "3cd622a33b173afdbed2fb60bd59e4c7eb9aa46c", "filename": "src/test/run-pass-fulldeps/newtype_index.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Frun-pass-fulldeps%2Fnewtype_index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Frun-pass-fulldeps%2Fnewtype_index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fnewtype_index.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -1,4 +1,4 @@\n-#![feature(rustc_attrs, rustc_private, step_trait, min_const_unsafe_fn)]\n+#![feature(rustc_attrs, rustc_private, step_trait)]\n \n #[macro_use] extern crate rustc_data_structures;\n extern crate rustc_serialize;"}, {"sha": "f38fab91de7c4b1a501b2fd122482689ccec36bb", "filename": "src/test/rustdoc/const-display.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Frustdoc%2Fconst-display.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Frustdoc%2Fconst-display.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fconst-display.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -15,7 +15,6 @@\n             issue = \"0\")]\n \n #![feature(rustc_const_unstable, const_fn, foo, foo2)]\n-#![feature(min_const_unsafe_fn)]\n #![feature(staged_api)]\n \n // @has 'foo/fn.foo.html' '//pre' 'pub unsafe fn foo() -> u32'"}, {"sha": "da875fe7a6b77ce7618ab6a9721ad94ebbbbd1ff", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_unsafe.rs", "status": "modified", "additions": 43, "deletions": 8, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -8,27 +8,62 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// gate-test-min_const_unsafe_fn\n+//------------------------------------------------------------------------------\n+// OK\n+//------------------------------------------------------------------------------\n \n-// ok\n const unsafe fn ret_i32_no_unsafe() -> i32 { 42 }\n const unsafe fn ret_null_ptr_no_unsafe<T>() -> *const T { 0 as *const T }\n const unsafe fn ret_null_mut_ptr_no_unsafe<T>() -> *mut T { 0 as *mut T }\n const fn no_unsafe() { unsafe {} }\n \n-// not ok\n const fn call_unsafe_const_fn() -> i32 {\n-    unsafe { ret_i32_no_unsafe() } //~ ERROR calls to `const unsafe fn` in const fns are unstable\n+    unsafe { ret_i32_no_unsafe() }\n }\n const fn call_unsafe_generic_const_fn() -> *const String {\n     unsafe { ret_null_ptr_no_unsafe::<String>() }\n-    //~^ ERROR calls to `const unsafe fn` in const fns are unstable\n }\n-const fn call_unsafe_generic_cell_const_fn() -> *const Vec<std::cell::Cell<u32>> {\n+const fn call_unsafe_generic_cell_const_fn()\n+    -> *const Vec<std::cell::Cell<u32>>\n+{\n     unsafe { ret_null_mut_ptr_no_unsafe::<Vec<std::cell::Cell<u32>>>() }\n-    //~^ ERROR calls to `const unsafe fn` in const fns\n }\n-const unsafe fn deref_forbidden(x: *mut usize) -> usize { *x }\n+\n+const unsafe fn call_unsafe_const_unsafe_fn() -> i32 {\n+    unsafe { ret_i32_no_unsafe() }\n+}\n+const unsafe fn call_unsafe_generic_const_unsafe_fn() -> *const String {\n+    unsafe { ret_null_ptr_no_unsafe::<String>() }\n+}\n+const unsafe fn call_unsafe_generic_cell_const_unsafe_fn()\n+    -> *const Vec<std::cell::Cell<u32>>\n+{\n+    unsafe { ret_null_mut_ptr_no_unsafe::<Vec<std::cell::Cell<u32>>>() }\n+}\n+\n+const unsafe fn call_unsafe_const_unsafe_fn_immediate() -> i32 {\n+    ret_i32_no_unsafe()\n+}\n+const unsafe fn call_unsafe_generic_const_unsafe_fn_immediate() -> *const String {\n+    ret_null_ptr_no_unsafe::<String>()\n+}\n+const unsafe fn call_unsafe_generic_cell_const_unsafe_fn_immediate()\n+    -> *const Vec<std::cell::Cell<u32>>\n+{\n+    ret_null_mut_ptr_no_unsafe::<Vec<std::cell::Cell<u32>>>()\n+}\n+\n+//------------------------------------------------------------------------------\n+// NOT OK\n+//------------------------------------------------------------------------------\n+\n+const fn bad_const_fn_deref_raw(x: *mut usize) -> &'static usize { unsafe { &*x } } //~ is unsafe\n+//~^ dereferencing raw pointers in constant functions\n+\n+const unsafe fn bad_const_unsafe_deref_raw(x: *mut usize) -> usize { *x }\n+//~^ dereferencing raw pointers in constant functions\n+\n+const unsafe fn bad_const_unsafe_deref_raw_ref(x: *mut usize) -> &'static usize { &*x }\n //~^ dereferencing raw pointers in constant functions\n \n fn main() {}"}, {"sha": "68b782bf0e7eaed960d7290072b082a137e2082a", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_unsafe.stderr", "status": "modified", "additions": 25, "deletions": 24, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe.stderr?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -1,43 +1,44 @@\n error[E0658]: dereferencing raw pointers in constant functions is unstable (see issue #51911)\n-  --> $DIR/min_const_fn_unsafe.rs:31:59\n+  --> $DIR/min_const_fn_unsafe.rs:60:77\n    |\n-LL | const unsafe fn deref_forbidden(x: *mut usize) -> usize { *x }\n-   |                                                           ^^\n+LL | const fn bad_const_fn_deref_raw(x: *mut usize) -> &'static usize { unsafe { &*x } } //~ is unsafe\n+   |                                                                             ^^^\n    |\n    = help: add #![feature(const_raw_ptr_deref)] to the crate attributes to enable\n \n-error[E0658]: unions in const fn are unstable (see issue #51909)\n-  --> $DIR/min_const_fn_unsafe.rs:38:5\n+error[E0658]: dereferencing raw pointers in constant functions is unstable (see issue #51911)\n+  --> $DIR/min_const_fn_unsafe.rs:63:70\n    |\n-LL |     Foo { x: () }.y\n-   |     ^^^^^^^^^^^^^^^\n+LL | const unsafe fn bad_const_unsafe_deref_raw(x: *mut usize) -> usize { *x }\n+   |                                                                      ^^\n    |\n-   = help: add #![feature(const_fn_union)] to the crate attributes to enable\n+   = help: add #![feature(const_raw_ptr_deref)] to the crate attributes to enable\n \n-error[E0658]: calls to `const unsafe fn` in const fns are unstable (see issue #55607)\n-  --> $DIR/min_const_fn_unsafe.rs:21:14\n+error[E0658]: dereferencing raw pointers in constant functions is unstable (see issue #51911)\n+  --> $DIR/min_const_fn_unsafe.rs:66:83\n    |\n-LL |     unsafe { ret_i32_no_unsafe() } //~ ERROR calls to `const unsafe fn` in const fns are unstable\n-   |              ^^^^^^^^^^^^^^^^^^^\n+LL | const unsafe fn bad_const_unsafe_deref_raw_ref(x: *mut usize) -> &'static usize { &*x }\n+   |                                                                                   ^^^\n    |\n-   = help: add #![feature(min_const_unsafe_fn)] to the crate attributes to enable\n+   = help: add #![feature(const_raw_ptr_deref)] to the crate attributes to enable\n \n-error[E0658]: calls to `const unsafe fn` in const fns are unstable (see issue #55607)\n-  --> $DIR/min_const_fn_unsafe.rs:24:14\n+error[E0658]: unions in const fn are unstable (see issue #51909)\n+  --> $DIR/min_const_fn_unsafe.rs:73:5\n    |\n-LL |     unsafe { ret_null_ptr_no_unsafe::<String>() }\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |     Foo { x: () }.y\n+   |     ^^^^^^^^^^^^^^^\n    |\n-   = help: add #![feature(min_const_unsafe_fn)] to the crate attributes to enable\n+   = help: add #![feature(const_fn_union)] to the crate attributes to enable\n \n-error[E0658]: calls to `const unsafe fn` in const fns are unstable (see issue #55607)\n-  --> $DIR/min_const_fn_unsafe.rs:28:14\n+error[E0133]: dereference of raw pointer is unsafe and requires unsafe function or block\n+  --> $DIR/min_const_fn_unsafe.rs:60:77\n    |\n-LL |     unsafe { ret_null_mut_ptr_no_unsafe::<Vec<std::cell::Cell<u32>>>() }\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | const fn bad_const_fn_deref_raw(x: *mut usize) -> &'static usize { unsafe { &*x } } //~ is unsafe\n+   |                                                                             ^^^ dereference of raw pointer\n    |\n-   = help: add #![feature(min_const_unsafe_fn)] to the crate attributes to enable\n+   = note: raw pointers may be NULL, dangling or unaligned; they can violate aliasing rules and cause data races: all of these are undefined behavior\n \n error: aborting due to 5 previous errors\n \n-For more information about this error, try `rustc --explain E0658`.\n+Some errors occurred: E0133, E0658.\n+For more information about an error, try `rustc --explain E0133`."}, {"sha": "67a48206126421f973e497d0c1ad2eae03dda04b", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_unsafe_feature_gate.rs", "status": "removed", "additions": 0, "deletions": 61, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/e4826775f2a590c75659ba002b0461363ee4a386/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe_feature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4826775f2a590c75659ba002b0461363ee4a386/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe_feature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe_feature_gate.rs?ref=e4826775f2a590c75659ba002b0461363ee4a386", "patch": "@@ -1,61 +0,0 @@\n-// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-#![feature(min_const_unsafe_fn)]\n-\n-// ok\n-const unsafe fn foo4() -> i32 { 42 }\n-const unsafe fn foo5<T>() -> *const T { 0 as *const T }\n-const unsafe fn foo6<T>() -> *mut T { 0 as *mut T }\n-const fn no_unsafe() { unsafe {} }\n-\n-const fn foo8() -> i32 {\n-    unsafe { foo4() }\n-}\n-const fn foo9() -> *const String {\n-    unsafe { foo5::<String>() }\n-}\n-const fn foo10() -> *const Vec<std::cell::Cell<u32>> {\n-    unsafe { foo6::<Vec<std::cell::Cell<u32>>>() }\n-}\n-const unsafe fn foo8_3() -> i32 {\n-    unsafe { foo4() }\n-}\n-const unsafe fn foo9_3() -> *const String {\n-    unsafe { foo5::<String>() }\n-}\n-const unsafe fn foo10_3() -> *const Vec<std::cell::Cell<u32>> {\n-    unsafe { foo6::<Vec<std::cell::Cell<u32>>>() }\n-}\n-const unsafe fn foo8_2() -> i32 {\n-    foo4()\n-}\n-const unsafe fn foo9_2() -> *const String {\n-    foo5::<String>()\n-}\n-const unsafe fn foo10_2() -> *const Vec<std::cell::Cell<u32>> {\n-    foo6::<Vec<std::cell::Cell<u32>>>()\n-}\n-const unsafe fn foo30_3(x: *mut usize) -> usize { *x }\n-//~^ dereferencing raw pointers in constant functions\n-\n-const unsafe fn foo30_4(x: *mut usize) -> &'static usize { &*x }\n-//~^ dereferencing raw pointers in constant functions\n-\n-const fn foo30_5(x: *mut usize) -> &'static usize { unsafe { &*x } } //~ is unsafe\n-//~^ dereferencing raw pointers in constant functions\n-\n-fn main() {}\n-\n-const unsafe fn no_union() {\n-    union Foo { x: (), y: () }\n-    Foo { x: () }.y\n-    //~^ unions in const fn\n-}"}, {"sha": "63bf9a53e509cc7a908b2813d23c5d92b00bbdd8", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_unsafe_feature_gate.stderr", "status": "removed", "additions": 0, "deletions": 44, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/e4826775f2a590c75659ba002b0461363ee4a386/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe_feature_gate.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e4826775f2a590c75659ba002b0461363ee4a386/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe_feature_gate.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_unsafe_feature_gate.stderr?ref=e4826775f2a590c75659ba002b0461363ee4a386", "patch": "@@ -1,44 +0,0 @@\n-error[E0658]: dereferencing raw pointers in constant functions is unstable (see issue #51911)\n-  --> $DIR/min_const_fn_unsafe_feature_gate.rs:46:51\n-   |\n-LL | const unsafe fn foo30_3(x: *mut usize) -> usize { *x }\n-   |                                                   ^^\n-   |\n-   = help: add #![feature(const_raw_ptr_deref)] to the crate attributes to enable\n-\n-error[E0658]: dereferencing raw pointers in constant functions is unstable (see issue #51911)\n-  --> $DIR/min_const_fn_unsafe_feature_gate.rs:49:60\n-   |\n-LL | const unsafe fn foo30_4(x: *mut usize) -> &'static usize { &*x }\n-   |                                                            ^^^\n-   |\n-   = help: add #![feature(const_raw_ptr_deref)] to the crate attributes to enable\n-\n-error[E0658]: dereferencing raw pointers in constant functions is unstable (see issue #51911)\n-  --> $DIR/min_const_fn_unsafe_feature_gate.rs:52:62\n-   |\n-LL | const fn foo30_5(x: *mut usize) -> &'static usize { unsafe { &*x } } //~ is unsafe\n-   |                                                              ^^^\n-   |\n-   = help: add #![feature(const_raw_ptr_deref)] to the crate attributes to enable\n-\n-error[E0658]: unions in const fn are unstable (see issue #51909)\n-  --> $DIR/min_const_fn_unsafe_feature_gate.rs:59:5\n-   |\n-LL |     Foo { x: () }.y\n-   |     ^^^^^^^^^^^^^^^\n-   |\n-   = help: add #![feature(const_fn_union)] to the crate attributes to enable\n-\n-error[E0133]: dereference of raw pointer is unsafe and requires unsafe function or block\n-  --> $DIR/min_const_fn_unsafe_feature_gate.rs:52:62\n-   |\n-LL | const fn foo30_5(x: *mut usize) -> &'static usize { unsafe { &*x } } //~ is unsafe\n-   |                                                              ^^^ dereference of raw pointer\n-   |\n-   = note: raw pointers may be NULL, dangling or unaligned; they can violate aliasing rules and cause data races: all of these are undefined behavior\n-\n-error: aborting due to 5 previous errors\n-\n-Some errors occurred: E0133, E0658.\n-For more information about an error, try `rustc --explain E0133`."}, {"sha": "33fcea9818959f3c5ffecc5dd5c5c1004ce535e3", "filename": "src/test/ui/consts/min_const_fn/min_const_unsafe_fn_libstd_stability.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -14,7 +14,6 @@\n             issue = \"0\")]\n \n #![feature(rustc_const_unstable, const_fn, foo, foo2)]\n-#![feature(min_const_unsafe_fn)]\n #![feature(staged_api)]\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]"}, {"sha": "2a0ef0e6b96515a5a482497ccdf9e3145a508b87", "filename": "src/test/ui/consts/min_const_fn/min_const_unsafe_fn_libstd_stability.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability.stderr?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -1,23 +1,23 @@\n error: can only call other `min_const_fn` within a `min_const_fn`\n-  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:26:41\n+  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:25:41\n    |\n LL | const unsafe fn bar() -> u32 { unsafe { foo() } } //~ ERROR can only call other `min_const_fn`\n    |                                         ^^^^^\n \n error: can only call other `min_const_fn` within a `min_const_fn`\n-  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:33:42\n+  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:32:42\n    |\n LL | const unsafe fn bar2() -> u32 { unsafe { foo2() } } //~ ERROR can only call other `min_const_fn`\n    |                                          ^^^^^^\n \n error: only int, `bool` and `char` operations are stable in const fn\n-  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:37:33\n+  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:36:33\n    |\n LL | const unsafe fn bar3() -> u32 { (5f32 + 6f32) as u32 } //~ ERROR only int, `bool` and `char` op\n    |                                 ^^^^^^^^^^^^^\n \n error: can only call other `min_const_fn` within a `min_const_fn`\n-  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:45:48\n+  --> $DIR/min_const_unsafe_fn_libstd_stability.rs:44:48\n    |\n LL | const unsafe fn bar2_gated() -> u32 { unsafe { foo2_gated() } } //~ ERROR can only call other\n    |                                                ^^^^^^^^^^^^"}, {"sha": "68205edd63bc9f2bfc1b72c25c03de276c0f817b", "filename": "src/test/ui/consts/min_const_fn/min_const_unsafe_fn_libstd_stability2.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability2.rs?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -14,7 +14,6 @@\n             issue = \"0\")]\n \n #![feature(rustc_const_unstable, const_fn, foo, foo2)]\n-#![feature(min_const_unsafe_fn)]\n #![feature(staged_api)]\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]"}, {"sha": "6153301518563c7a8533613679a7918b6ea0c1e8", "filename": "src/test/ui/consts/min_const_fn/min_const_unsafe_fn_libstd_stability2.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/975a7f01f0df76190d4af3d01ddd8b0d82caa1e8/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_unsafe_fn_libstd_stability2.stderr?ref=975a7f01f0df76190d4af3d01ddd8b0d82caa1e8", "patch": "@@ -1,17 +1,17 @@\n error: can only call other `min_const_fn` within a `min_const_fn`\n-  --> $DIR/min_const_unsafe_fn_libstd_stability2.rs:26:32\n+  --> $DIR/min_const_unsafe_fn_libstd_stability2.rs:25:32\n    |\n LL | const unsafe fn bar() -> u32 { foo() } //~ ERROR can only call other `min_const_fn`\n    |                                ^^^^^\n \n error: can only call other `min_const_fn` within a `min_const_fn`\n-  --> $DIR/min_const_unsafe_fn_libstd_stability2.rs:33:33\n+  --> $DIR/min_const_unsafe_fn_libstd_stability2.rs:32:33\n    |\n LL | const unsafe fn bar2() -> u32 { foo2() } //~ ERROR can only call other `min_const_fn`\n    |                                 ^^^^^^\n \n error: can only call other `min_const_fn` within a `min_const_fn`\n-  --> $DIR/min_const_unsafe_fn_libstd_stability2.rs:41:39\n+  --> $DIR/min_const_unsafe_fn_libstd_stability2.rs:40:39\n    |\n LL | const unsafe fn bar2_gated() -> u32 { foo2_gated() } //~ ERROR can only call other `min_const_fn`\n    |                                       ^^^^^^^^^^^^"}]}