{"sha": "982b92f966518a0e24632fafdc18d7b5ab6928b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk4MmI5MmY5NjY1MThhMGUyNDYzMmZhZmRjMThkN2I1YWI2OTI4YjQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-05-15T10:17:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-15T10:17:42Z"}, "message": "Merge #4431\n\n4431: Store proc-macro result in salsa db r=matklad a=edwin0cheng\n\nFixed #4315 \n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "41aa35146d8b3b2b039d79a38a157d0f2d5cab8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41aa35146d8b3b2b039d79a38a157d0f2d5cab8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/982b92f966518a0e24632fafdc18d7b5ab6928b4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJevmxGCRBK7hj4Ov3rIwAAdHIIAAnfCE6N49P3m12PwtkW9Tju\nKgbeLm594dKG/3a0YRCAzqkaO0O5kAtmby+iMuG/yczxyencqdOCLDc7+qz5wS0R\nWdxPwELaLW5WgPd+21brGOY0J65cVj/a9tTUdVs57X9BOqgysl1sOooQ1pBlMYN7\nlQYTDsNgoT5tKMBxKAHHhGFkvpbvAwxLs1cvkSxuS2ESgY7EcidMA064RyoHjz3U\nhuK8d/fOxjnWNb+4wt/NA/yTGYreRartxserENK5Q704pt3uA4JFy99CLCktNJLw\nx0mx31OOOCWCNg8RxEKOJwvu/snK7sMipNhBq1BfPxug1E1fV6knAJvmiS+28Hk=\n=Uoz0\n-----END PGP SIGNATURE-----\n", "payload": "tree 41aa35146d8b3b2b039d79a38a157d0f2d5cab8d\nparent 05db35dafb47db355e202c9176bd8a752b7390d7\nparent 20f7068b68b99610926b375d53d3721b878ff86c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1589537862 +0000\ncommitter GitHub <noreply@github.com> 1589537862 +0000\n\nMerge #4431\n\n4431: Store proc-macro result in salsa db r=matklad a=edwin0cheng\n\nFixed #4315 \n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/982b92f966518a0e24632fafdc18d7b5ab6928b4", "html_url": "https://github.com/rust-lang/rust/commit/982b92f966518a0e24632fafdc18d7b5ab6928b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/982b92f966518a0e24632fafdc18d7b5ab6928b4/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05db35dafb47db355e202c9176bd8a752b7390d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/05db35dafb47db355e202c9176bd8a752b7390d7", "html_url": "https://github.com/rust-lang/rust/commit/05db35dafb47db355e202c9176bd8a752b7390d7"}, {"sha": "20f7068b68b99610926b375d53d3721b878ff86c", "url": "https://api.github.com/repos/rust-lang/rust/commits/20f7068b68b99610926b375d53d3721b878ff86c", "html_url": "https://github.com/rust-lang/rust/commit/20f7068b68b99610926b375d53d3721b878ff86c"}], "stats": {"total": 40, "additions": 37, "deletions": 3}, "files": [{"sha": "bf30d71519e10b7b08270619b3b11e02cce330ea", "filename": "crates/ra_hir_expand/src/db.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/982b92f966518a0e24632fafdc18d7b5ab6928b4/crates%2Fra_hir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982b92f966518a0e24632fafdc18d7b5ab6928b4/crates%2Fra_hir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fdb.rs?ref=982b92f966518a0e24632fafdc18d7b5ab6928b4", "patch": "@@ -34,7 +34,12 @@ impl TokenExpander {\n             // FIXME switch these to ExpandResult as well\n             TokenExpander::Builtin(it) => it.expand(db, id, tt).into(),\n             TokenExpander::BuiltinDerive(it) => it.expand(db, id, tt).into(),\n-            TokenExpander::ProcMacro(it) => it.expand(db, id, tt).into(),\n+            TokenExpander::ProcMacro(_) => {\n+                // We store the result in salsa db to prevent non-determinisc behavior in\n+                // some proc-macro implementation\n+                // See #4315 for details\n+                db.expand_proc_macro(id.into()).into()\n+            }\n         }\n     }\n \n@@ -75,6 +80,8 @@ pub trait AstDatabase: SourceDatabase {\n \n     #[salsa::interned]\n     fn intern_eager_expansion(&self, eager: EagerCallLoc) -> EagerMacroId;\n+\n+    fn expand_proc_macro(&self, call: MacroCallId) -> Result<tt::Subtree, mbe::ExpandError>;\n }\n \n /// This expands the given macro call, but with different arguments. This is\n@@ -216,6 +223,33 @@ fn macro_expand_with_arg(\n     (Some(Arc::new(tt)), err.map(|e| format!(\"{:?}\", e)))\n }\n \n+pub(crate) fn expand_proc_macro(\n+    db: &dyn AstDatabase,\n+    id: MacroCallId,\n+) -> Result<tt::Subtree, mbe::ExpandError> {\n+    let lazy_id = match id {\n+        MacroCallId::LazyMacro(id) => id,\n+        MacroCallId::EagerMacro(_) => unreachable!(),\n+    };\n+\n+    let loc = db.lookup_intern_macro(lazy_id);\n+    let macro_arg = match db.macro_arg(id) {\n+        Some(it) => it,\n+        None => {\n+            return Err(\n+                tt::ExpansionError::Unknown(\"No arguments for proc-macro\".to_string()).into()\n+            )\n+        }\n+    };\n+\n+    let expander = match loc.def.kind {\n+        MacroDefKind::CustomDerive(expander) => expander,\n+        _ => unreachable!(),\n+    };\n+\n+    expander.expand(db, lazy_id, &macro_arg.0)\n+}\n+\n pub(crate) fn parse_or_expand(db: &dyn AstDatabase, file_id: HirFileId) -> Option<SyntaxNode> {\n     match file_id.0 {\n         HirFileIdRepr::FileId(file_id) => Some(db.parse(file_id).tree().syntax().clone()),"}, {"sha": "9c450eabaed018f7e42f607fbdcf046da54a6cb7", "filename": "crates/ra_mbe/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/982b92f966518a0e24632fafdc18d7b5ab6928b4/crates%2Fra_mbe%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982b92f966518a0e24632fafdc18d7b5ab6928b4/crates%2Fra_mbe%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_mbe%2Fsrc%2Flib.rs?ref=982b92f966518a0e24632fafdc18d7b5ab6928b4", "patch": "@@ -22,7 +22,7 @@ pub enum ParseError {\n     RepetitionEmtpyTokenTree,\n }\n \n-#[derive(Debug, PartialEq, Eq)]\n+#[derive(Debug, PartialEq, Eq, Clone)]\n pub enum ExpandError {\n     NoMatchingRule,\n     UnexpectedToken,"}, {"sha": "342ddbe32947766a52b04a1e839f5b7a0eb9fc4b", "filename": "crates/ra_tt/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/982b92f966518a0e24632fafdc18d7b5ab6928b4/crates%2Fra_tt%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982b92f966518a0e24632fafdc18d7b5ab6928b4/crates%2Fra_tt%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_tt%2Fsrc%2Flib.rs?ref=982b92f966518a0e24632fafdc18d7b5ab6928b4", "patch": "@@ -243,7 +243,7 @@ impl Subtree {\n \n pub mod buffer;\n \n-#[derive(Debug, PartialEq, Eq)]\n+#[derive(Debug, PartialEq, Eq, Clone)]\n pub enum ExpansionError {\n     IOError(String),\n     JsonError(String),"}]}