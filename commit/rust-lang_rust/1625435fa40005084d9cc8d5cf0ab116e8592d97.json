{"sha": "1625435fa40005084d9cc8d5cf0ab116e8592d97", "node_id": "C_kwDOAAsO6NoAKDE2MjU0MzVmYTQwMDA1MDg0ZDljYzhkNWNmMGFiMTE2ZTg1OTJkOTc", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2022-11-22T06:26:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-22T06:26:07Z"}, "message": "Rollup merge of #102207 - CraftSpider:const-layout, r=scottmcm\n\nConstify remaining `Layout` methods\n\nMakes the methods on `Layout` that aren't yet unstably const, under the same feature and issue, #67521. Most of them required no changes, only non-trivial change is probably constifying `ValidAlignment` which may affect #102072", "tree": {"sha": "002f6ca2489f89edbe90374947eb872aff52ad69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/002f6ca2489f89edbe90374947eb872aff52ad69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1625435fa40005084d9cc8d5cf0ab116e8592d97", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjfGt/CRBK7hj4Ov3rIwAAsDYIAIaXFKW2QisMG/5rF5rXy+EH\nAJVnvpQ7tJYexRxUf/n9DB0RCr77MBg0UaMNhcL7pfIzRXSMgdyHaAY7cv7L3ZmT\nei4COWxtw97gHXpm6MXJ6MMVQ+nxEu7wso3K4MTeIZNBm6O1hA8qPAVY3GtZOhde\ngsvPrZe/VYas7IGuASN+nPTgxVB7V9qNWFd5c1AwHYQ93p/LlJ5BhAtyHn+4dkfe\n6W9shYdmlJI2KO8MfNmg8DkKFEsdLkSPZV3xWMJ/+dzqk1SHD7XzuWVDMcwogNpE\nrwjjNOZ5WedbK0UvJy8q9hE3qj1hb4Ju7wja5b7hckkr2WvpOuqvQ3XWZUGAQa0=\n=znU4\n-----END PGP SIGNATURE-----\n", "payload": "tree 002f6ca2489f89edbe90374947eb872aff52ad69\nparent 2f8dbe3797aec9a37d16d80db2f9285f74d27786\nparent 8998711d9bbd75aad32ef4ade36fa042da7fde13\nauthor Manish Goregaokar <manishsmail@gmail.com> 1669098367 -0500\ncommitter GitHub <noreply@github.com> 1669098367 -0500\n\nRollup merge of #102207 - CraftSpider:const-layout, r=scottmcm\n\nConstify remaining `Layout` methods\n\nMakes the methods on `Layout` that aren't yet unstably const, under the same feature and issue, #67521. Most of them required no changes, only non-trivial change is probably constifying `ValidAlignment` which may affect #102072\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1625435fa40005084d9cc8d5cf0ab116e8592d97", "html_url": "https://github.com/rust-lang/rust/commit/1625435fa40005084d9cc8d5cf0ab116e8592d97", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1625435fa40005084d9cc8d5cf0ab116e8592d97/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f8dbe3797aec9a37d16d80db2f9285f74d27786", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f8dbe3797aec9a37d16d80db2f9285f74d27786", "html_url": "https://github.com/rust-lang/rust/commit/2f8dbe3797aec9a37d16d80db2f9285f74d27786"}, {"sha": "8998711d9bbd75aad32ef4ade36fa042da7fde13", "url": "https://api.github.com/repos/rust-lang/rust/commits/8998711d9bbd75aad32ef4ade36fa042da7fde13", "html_url": "https://github.com/rust-lang/rust/commit/8998711d9bbd75aad32ef4ade36fa042da7fde13"}], "stats": {"total": 63, "additions": 45, "deletions": 18}, "files": [{"sha": "ac3d84718d54e0e8fd95ff674960251a3e55a257", "filename": "library/core/src/alloc/layout.rs", "status": "modified", "additions": 25, "deletions": 11, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/1625435fa40005084d9cc8d5cf0ab116e8592d97/library%2Fcore%2Fsrc%2Falloc%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1625435fa40005084d9cc8d5cf0ab116e8592d97/library%2Fcore%2Fsrc%2Falloc%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Falloc%2Flayout.rs?ref=1625435fa40005084d9cc8d5cf0ab116e8592d97", "patch": "@@ -157,9 +157,10 @@ impl Layout {\n     /// allocate backing structure for `T` (which could be a trait\n     /// or other unsized type like a slice).\n     #[stable(feature = \"alloc_layout\", since = \"1.28.0\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[must_use]\n     #[inline]\n-    pub fn for_value<T: ?Sized>(t: &T) -> Self {\n+    pub const fn for_value<T: ?Sized>(t: &T) -> Self {\n         let (size, align) = (mem::size_of_val(t), mem::align_of_val(t));\n         // SAFETY: see rationale in `new` for why this is using the unsafe variant\n         unsafe { Layout::from_size_align_unchecked(size, align) }\n@@ -191,8 +192,9 @@ impl Layout {\n     /// [trait object]: ../../book/ch17-02-trait-objects.html\n     /// [extern type]: ../../unstable-book/language-features/extern-types.html\n     #[unstable(feature = \"layout_for_ptr\", issue = \"69835\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[must_use]\n-    pub unsafe fn for_value_raw<T: ?Sized>(t: *const T) -> Self {\n+    pub const unsafe fn for_value_raw<T: ?Sized>(t: *const T) -> Self {\n         // SAFETY: we pass along the prerequisites of these functions to the caller\n         let (size, align) = unsafe { (mem::size_of_val_raw(t), mem::align_of_val_raw(t)) };\n         // SAFETY: see rationale in `new` for why this is using the unsafe variant\n@@ -229,8 +231,9 @@ impl Layout {\n     /// Returns an error if the combination of `self.size()` and the given\n     /// `align` violates the conditions listed in [`Layout::from_size_align`].\n     #[stable(feature = \"alloc_layout_manipulation\", since = \"1.44.0\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[inline]\n-    pub fn align_to(&self, align: usize) -> Result<Self, LayoutError> {\n+    pub const fn align_to(&self, align: usize) -> Result<Self, LayoutError> {\n         Layout::from_size_align(self.size(), cmp::max(self.align(), align))\n     }\n \n@@ -287,10 +290,11 @@ impl Layout {\n     /// This is equivalent to adding the result of `padding_needed_for`\n     /// to the layout's current size.\n     #[stable(feature = \"alloc_layout_manipulation\", since = \"1.44.0\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[must_use = \"this returns a new `Layout`, \\\n                   without modifying the original\"]\n     #[inline]\n-    pub fn pad_to_align(&self) -> Layout {\n+    pub const fn pad_to_align(&self) -> Layout {\n         let pad = self.padding_needed_for(self.align());\n         // This cannot overflow. Quoting from the invariant of Layout:\n         // > `size`, when rounded up to the nearest multiple of `align`,\n@@ -311,8 +315,9 @@ impl Layout {\n     ///\n     /// On arithmetic overflow, returns `LayoutError`.\n     #[unstable(feature = \"alloc_layout_extra\", issue = \"55724\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[inline]\n-    pub fn repeat(&self, n: usize) -> Result<(Self, usize), LayoutError> {\n+    pub const fn repeat(&self, n: usize) -> Result<(Self, usize), LayoutError> {\n         // This cannot overflow. Quoting from the invariant of Layout:\n         // > `size`, when rounded up to the nearest multiple of `align`,\n         // > must not overflow isize (i.e., the rounded value must be\n@@ -321,7 +326,8 @@ impl Layout {\n         let alloc_size = padded_size.checked_mul(n).ok_or(LayoutError)?;\n \n         // The safe constructor is called here to enforce the isize size limit.\n-        Layout::from_size_alignment(alloc_size, self.align).map(|layout| (layout, padded_size))\n+        let layout = Layout::from_size_alignment(alloc_size, self.align)?;\n+        Ok((layout, padded_size))\n     }\n \n     /// Creates a layout describing the record for `self` followed by\n@@ -370,8 +376,9 @@ impl Layout {\n     /// # assert_eq!(repr_c(&[u64, u32, u16, u32]), Ok((s, vec![0, 8, 12, 16])));\n     /// ```\n     #[stable(feature = \"alloc_layout_manipulation\", since = \"1.44.0\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[inline]\n-    pub fn extend(&self, next: Self) -> Result<(Self, usize), LayoutError> {\n+    pub const fn extend(&self, next: Self) -> Result<(Self, usize), LayoutError> {\n         let new_align = cmp::max(self.align, next.align);\n         let pad = self.padding_needed_for(next.align());\n \n@@ -396,8 +403,9 @@ impl Layout {\n     ///\n     /// On arithmetic overflow, returns `LayoutError`.\n     #[unstable(feature = \"alloc_layout_extra\", issue = \"55724\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[inline]\n-    pub fn repeat_packed(&self, n: usize) -> Result<Self, LayoutError> {\n+    pub const fn repeat_packed(&self, n: usize) -> Result<Self, LayoutError> {\n         let size = self.size().checked_mul(n).ok_or(LayoutError)?;\n         // The safe constructor is called here to enforce the isize size limit.\n         Layout::from_size_alignment(size, self.align)\n@@ -410,8 +418,9 @@ impl Layout {\n     ///\n     /// On arithmetic overflow, returns `LayoutError`.\n     #[unstable(feature = \"alloc_layout_extra\", issue = \"55724\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[inline]\n-    pub fn extend_packed(&self, next: Self) -> Result<Self, LayoutError> {\n+    pub const fn extend_packed(&self, next: Self) -> Result<Self, LayoutError> {\n         let new_size = self.size().checked_add(next.size()).ok_or(LayoutError)?;\n         // The safe constructor is called here to enforce the isize size limit.\n         Layout::from_size_alignment(new_size, self.align)\n@@ -422,13 +431,18 @@ impl Layout {\n     /// On arithmetic overflow or when the total size would exceed\n     /// `isize::MAX`, returns `LayoutError`.\n     #[stable(feature = \"alloc_layout_manipulation\", since = \"1.44.0\")]\n+    #[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n     #[inline]\n-    pub fn array<T>(n: usize) -> Result<Self, LayoutError> {\n+    pub const fn array<T>(n: usize) -> Result<Self, LayoutError> {\n         // Reduce the amount of code we need to monomorphize per `T`.\n         return inner(mem::size_of::<T>(), Alignment::of::<T>(), n);\n \n         #[inline]\n-        fn inner(element_size: usize, align: Alignment, n: usize) -> Result<Layout, LayoutError> {\n+        const fn inner(\n+            element_size: usize,\n+            align: Alignment,\n+            n: usize,\n+        ) -> Result<Layout, LayoutError> {\n             // We need to check two things about the size:\n             //  - That the total size won't overflow a `usize`, and\n             //  - That the total size still fits in an `isize`."}, {"sha": "1823fd3006279d1c7bacddb75892b04b3fd93204", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1625435fa40005084d9cc8d5cf0ab116e8592d97/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1625435fa40005084d9cc8d5cf0ab116e8592d97/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=1625435fa40005084d9cc8d5cf0ab116e8592d97", "patch": "@@ -99,6 +99,8 @@\n // Library features:\n #![feature(const_align_offset)]\n #![feature(const_align_of_val)]\n+#![feature(const_align_of_val_raw)]\n+#![feature(const_alloc_layout)]\n #![feature(const_arguments_as_str)]\n #![feature(const_array_into_iter_constructors)]\n #![feature(const_bigint_helper_methods)]\n@@ -141,6 +143,7 @@\n #![feature(const_ptr_write)]\n #![feature(const_raw_ptr_comparison)]\n #![feature(const_size_of_val)]\n+#![feature(const_size_of_val_raw)]\n #![feature(const_slice_from_raw_parts_mut)]\n #![feature(const_slice_ptr_len)]\n #![feature(const_slice_split_at_mut)]"}, {"sha": "64a5290c3a267d6c378ea2680859a9c60fc0fc21", "filename": "library/core/src/ptr/alignment.rs", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1625435fa40005084d9cc8d5cf0ab116e8592d97/library%2Fcore%2Fsrc%2Fptr%2Falignment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1625435fa40005084d9cc8d5cf0ab116e8592d97/library%2Fcore%2Fsrc%2Fptr%2Falignment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Falignment.rs?ref=1625435fa40005084d9cc8d5cf0ab116e8592d97", "patch": "@@ -9,7 +9,9 @@ use crate::{cmp, fmt, hash, mem, num};\n /// Note that particularly large alignments, while representable in this type,\n /// are likely not to be supported by actual allocators and linkers.\n #[unstable(feature = \"ptr_alignment_type\", issue = \"102070\")]\n-#[derive(Copy, Clone, Eq, PartialEq)]\n+#[derive(Copy, Clone, Eq)]\n+#[cfg_attr(bootstrap, derive(PartialEq))]\n+#[cfg_attr(not(bootstrap), derive_const(PartialEq))]\n #[repr(transparent)]\n pub struct Alignment(AlignmentEnum);\n \n@@ -167,16 +169,18 @@ impl From<Alignment> for usize {\n     }\n }\n \n+#[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n #[unstable(feature = \"ptr_alignment_type\", issue = \"102070\")]\n-impl cmp::Ord for Alignment {\n+impl const cmp::Ord for Alignment {\n     #[inline]\n     fn cmp(&self, other: &Self) -> cmp::Ordering {\n-        self.as_nonzero().cmp(&other.as_nonzero())\n+        self.as_nonzero().get().cmp(&other.as_nonzero().get())\n     }\n }\n \n+#[rustc_const_unstable(feature = \"const_alloc_layout\", issue = \"67521\")]\n #[unstable(feature = \"ptr_alignment_type\", issue = \"102070\")]\n-impl cmp::PartialOrd for Alignment {\n+impl const cmp::PartialOrd for Alignment {\n     #[inline]\n     fn partial_cmp(&self, other: &Self) -> Option<cmp::Ordering> {\n         Some(self.cmp(other))\n@@ -198,7 +202,9 @@ type AlignmentEnum = AlignmentEnum32;\n #[cfg(target_pointer_width = \"64\")]\n type AlignmentEnum = AlignmentEnum64;\n \n-#[derive(Copy, Clone, Eq, PartialEq)]\n+#[derive(Copy, Clone, Eq)]\n+#[cfg_attr(bootstrap, derive(PartialEq))]\n+#[cfg_attr(not(bootstrap), derive_const(PartialEq))]\n #[repr(u16)]\n enum AlignmentEnum16 {\n     _Align1Shl0 = 1 << 0,\n@@ -219,7 +225,9 @@ enum AlignmentEnum16 {\n     _Align1Shl15 = 1 << 15,\n }\n \n-#[derive(Copy, Clone, Eq, PartialEq)]\n+#[derive(Copy, Clone, Eq)]\n+#[cfg_attr(bootstrap, derive(PartialEq))]\n+#[cfg_attr(not(bootstrap), derive_const(PartialEq))]\n #[repr(u32)]\n enum AlignmentEnum32 {\n     _Align1Shl0 = 1 << 0,\n@@ -256,7 +264,9 @@ enum AlignmentEnum32 {\n     _Align1Shl31 = 1 << 31,\n }\n \n-#[derive(Copy, Clone, Eq, PartialEq)]\n+#[derive(Copy, Clone, Eq)]\n+#[cfg_attr(bootstrap, derive(PartialEq))]\n+#[cfg_attr(not(bootstrap), derive_const(PartialEq))]\n #[repr(u64)]\n enum AlignmentEnum64 {\n     _Align1Shl0 = 1 << 0,"}]}