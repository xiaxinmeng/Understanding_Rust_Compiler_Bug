{"sha": "ebcea405f3bc9a8325cbced1dd9718332e7561b3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmViY2VhNDA1ZjNiYzlhODMyNWNiY2VkMWRkOTcxODMzMmU3NTYxYjM=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-11-03T08:12:10Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-11-03T08:12:10Z"}, "message": "Merge #3123\n\n3123: Lint #[cfg_attr(rustfmt, rustfmt_skip)] and suggest #[rustfmt::skip] r=phansch a=flip1995\n\nCloses #3121 \n\nCo-authored-by: flip1995 <9744647+flip1995@users.noreply.github.com>\nCo-authored-by: flip1995 <hello@philkrones.com>", "tree": {"sha": "b8102fc27b5b79d78bf119674c7a5d0f3538a058", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b8102fc27b5b79d78bf119674c7a5d0f3538a058"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ebcea405f3bc9a8325cbced1dd9718332e7561b3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ebcea405f3bc9a8325cbced1dd9718332e7561b3", "html_url": "https://github.com/rust-lang/rust/commit/ebcea405f3bc9a8325cbced1dd9718332e7561b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ebcea405f3bc9a8325cbced1dd9718332e7561b3/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "dc1e4091546c1416fb031ada9ad8a821c039b732", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc1e4091546c1416fb031ada9ad8a821c039b732", "html_url": "https://github.com/rust-lang/rust/commit/dc1e4091546c1416fb031ada9ad8a821c039b732"}, {"sha": "318f84ffcf4d919373ab4a025891d591e81070d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/318f84ffcf4d919373ab4a025891d591e81070d6", "html_url": "https://github.com/rust-lang/rust/commit/318f84ffcf4d919373ab4a025891d591e81070d6"}], "stats": {"total": 142, "additions": 139, "deletions": 3}, "files": [{"sha": "bdd01bfeecddf92d2acb8bd1923871d442bca8d6", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ebcea405f3bc9a8325cbced1dd9718332e7561b3/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/ebcea405f3bc9a8325cbced1dd9718332e7561b3/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=ebcea405f3bc9a8325cbced1dd9718332e7561b3", "patch": "@@ -651,6 +651,7 @@ All notable changes to this project will be documented in this file.\n [`decimal_literal_representation`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#decimal_literal_representation\n [`declare_interior_mutable_const`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#declare_interior_mutable_const\n [`default_trait_access`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#default_trait_access\n+[`deprecated_cfg_attr`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#deprecated_cfg_attr\n [`deprecated_semver`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#deprecated_semver\n [`deref_addrof`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#deref_addrof\n [`derive_hash_xor_eq`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#derive_hash_xor_eq"}, {"sha": "0525788e64e155ffed37ede0ab3d6090b9c7c876", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ebcea405f3bc9a8325cbced1dd9718332e7561b3/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/ebcea405f3bc9a8325cbced1dd9718332e7561b3/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=ebcea405f3bc9a8325cbced1dd9718332e7561b3", "patch": "@@ -9,7 +9,7 @@ We are currently in the process of discussing Clippy 1.0 via the RFC process in\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 286 lints included in this crate!](https://rust-lang-nursery.github.io/rust-clippy/master/index.html)\n+[There are 287 lints included in this crate!](https://rust-lang-nursery.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "593484aa1c61ace55246ce637f961f59b1edc2f0", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 74, "deletions": 2, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/ebcea405f3bc9a8325cbced1dd9718332e7561b3/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebcea405f3bc9a8325cbced1dd9718332e7561b3/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=ebcea405f3bc9a8325cbced1dd9718332e7561b3", "patch": "@@ -12,13 +12,13 @@\n \n use crate::reexport::*;\n use crate::utils::{\n-    in_macro, last_line_of_span, match_def_path, opt_def_id, paths, snippet_opt, span_lint,\n+    in_macro, last_line_of_span, match_def_path, opt_def_id, paths, snippet_opt, span_lint, span_lint_and_sugg,\n     span_lint_and_then, without_block_comments,\n };\n use if_chain::if_chain;\n use crate::rustc::hir::*;\n use crate::rustc::lint::{\n-    CheckLintNameResult, LateContext, LateLintPass, LintArray, LintContext, LintPass,\n+    CheckLintNameResult, EarlyContext, EarlyLintPass, LateContext, LateLintPass, LintArray, LintContext, LintPass,\n };\n use crate::rustc::ty::{self, TyCtxt};\n use crate::rustc::{declare_tool_lint, lint_array};\n@@ -169,6 +169,35 @@ declare_clippy_lint! {\n     \"unknown_lints for scoped Clippy lints\"\n }\n \n+/// **What it does:** Checks for `#[cfg_attr(rustfmt, rustfmt_skip)]` and suggests to replace it\n+/// with `#[rustfmt::skip]`.\n+///\n+/// **Why is this bad?** Since tool_attributes ([rust-lang/rust#44690](https://github.com/rust-lang/rust/issues/44690))\n+/// are stable now, they should be used instead of the old `cfg_attr(rustfmt)` attributes.\n+///\n+/// **Known problems:** This lint doesn't detect crate level inner attributes, because they get\n+/// processed before the PreExpansionPass lints get executed. See\n+/// [#3123](https://github.com/rust-lang-nursery/rust-clippy/pull/3123#issuecomment-422321765)\n+///\n+/// **Example:**\n+///\n+/// Bad:\n+/// ```rust\n+/// #[cfg_attr(rustfmt, rustfmt_skip)]\n+/// fn main() { }\n+/// ```\n+///\n+/// Good:\n+/// ```rust\n+/// #[rustfmt::skip]\n+/// fn main() { }\n+/// ```\n+declare_clippy_lint! {\n+    pub DEPRECATED_CFG_ATTR,\n+    complexity,\n+    \"usage of `cfg_attr(rustfmt)` instead of `tool_attributes`\"\n+}\n+\n #[derive(Copy, Clone)]\n pub struct AttrPass;\n \n@@ -466,3 +495,46 @@ fn is_present_in_source(cx: &LateContext<'_, '_>, span: Span) -> bool {\n     }\n     true\n }\n+\n+#[derive(Copy, Clone)]\n+pub struct CfgAttrPass;\n+\n+impl LintPass for CfgAttrPass {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(\n+            DEPRECATED_CFG_ATTR,\n+        )\n+    }\n+}\n+\n+impl EarlyLintPass for CfgAttrPass {\n+    fn check_attribute(&mut self, cx: &EarlyContext<'_>, attr: &Attribute) {\n+        if_chain! {\n+            // check cfg_attr\n+            if attr.name() == \"cfg_attr\";\n+            if let Some(ref items) = attr.meta_item_list();\n+            if items.len() == 2;\n+            // check for `rustfmt`\n+            if let Some(feature_item) = items[0].meta_item();\n+            if feature_item.name() == \"rustfmt\";\n+            // check for `rustfmt_skip` and `rustfmt::skip`\n+            if let Some(skip_item) = &items[1].meta_item();\n+            if skip_item.name() == \"rustfmt_skip\" || skip_item.name() == \"skip\";\n+            then {\n+                let attr_style = match attr.style {\n+                    AttrStyle::Outer => \"#[\",\n+                    AttrStyle::Inner => \"#![\",\n+                };\n+                span_lint_and_sugg(\n+                    cx,\n+                    DEPRECATED_CFG_ATTR,\n+                    attr.span,\n+                    \"`cfg_attr` is deprecated for rustfmt and got replaced by tool_attributes\",\n+                    \"use\",\n+                    format!(\"{}rustfmt::skip]\", attr_style),\n+                );\n+            }\n+        }\n+    }\n+}\n+"}, {"sha": "f3fce54f910e65390ae418f6b10312d67f49adfe", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ebcea405f3bc9a8325cbced1dd9718332e7561b3/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebcea405f3bc9a8325cbced1dd9718332e7561b3/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=ebcea405f3bc9a8325cbced1dd9718332e7561b3", "patch": "@@ -220,6 +220,7 @@ pub fn register_pre_expansion_lints(session: &rustc::session::Session, store: &m\n     store.register_pre_expansion_pass(Some(session), box non_expressive_names::NonExpressiveNames {\n         single_char_binding_names_threshold: conf.single_char_binding_names_threshold,\n     });\n+    store.register_pre_expansion_pass(Some(session), box attrs::CfgAttrPass);\n }\n \n pub fn read_conf(reg: &rustc_plugin::Registry<'_>) -> Conf {\n@@ -532,6 +533,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         approx_const::APPROX_CONSTANT,\n         assign_ops::ASSIGN_OP_PATTERN,\n         assign_ops::MISREFACTORED_ASSIGN_OP,\n+        attrs::DEPRECATED_CFG_ATTR,\n         attrs::DEPRECATED_SEMVER,\n         attrs::UNKNOWN_CLIPPY_LINTS,\n         attrs::USELESS_ATTRIBUTE,\n@@ -839,6 +841,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n \n     reg.register_lint_group(\"clippy::complexity\", Some(\"clippy_complexity\"), vec![\n         assign_ops::MISREFACTORED_ASSIGN_OP,\n+        attrs::DEPRECATED_CFG_ATTR,\n         booleans::NONMINIMAL_BOOL,\n         cyclomatic_complexity::CYCLOMATIC_COMPLEXITY,\n         double_comparison::DOUBLE_COMPARISONS,"}, {"sha": "614cd3e30ec3ff14f5a3007c2036b0a8bda893c4", "filename": "tests/ui/cfg_attr_rustfmt.rs", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/ebcea405f3bc9a8325cbced1dd9718332e7561b3/tests%2Fui%2Fcfg_attr_rustfmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebcea405f3bc9a8325cbced1dd9718332e7561b3/tests%2Fui%2Fcfg_attr_rustfmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcfg_attr_rustfmt.rs?ref=ebcea405f3bc9a8325cbced1dd9718332e7561b3", "patch": "@@ -0,0 +1,38 @@\n+// Copyright 2014-2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(stmt_expr_attributes)]\n+\n+#![warn(clippy::deprecated_cfg_attr)]\n+\n+// This doesn't get linted, see known problems\n+#![cfg_attr(rustfmt, rustfmt_skip)]\n+\n+#[rustfmt::skip]\n+trait Foo\n+{\n+fn foo(\n+);\n+}\n+\n+fn skip_on_statements() {\n+    #[cfg_attr(rustfmt, rustfmt::skip)]\n+    5+3;\n+}\n+\n+#[cfg_attr(rustfmt, rustfmt_skip)]\n+fn main() {\n+    foo::f();\n+}\n+\n+mod foo {\n+    #![cfg_attr(rustfmt, rustfmt_skip)]\n+\n+    pub fn f() {}\n+}"}, {"sha": "a6a27bd2ee8fd24e3e047aa87ca73d7fa6553a88", "filename": "tests/ui/cfg_attr_rustfmt.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/ebcea405f3bc9a8325cbced1dd9718332e7561b3/tests%2Fui%2Fcfg_attr_rustfmt.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ebcea405f3bc9a8325cbced1dd9718332e7561b3/tests%2Fui%2Fcfg_attr_rustfmt.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcfg_attr_rustfmt.stderr?ref=ebcea405f3bc9a8325cbced1dd9718332e7561b3", "patch": "@@ -0,0 +1,22 @@\n+error: `cfg_attr` is deprecated for rustfmt and got replaced by tool_attributes\n+  --> $DIR/cfg_attr_rustfmt.rs:25:5\n+   |\n+25 |     #[cfg_attr(rustfmt, rustfmt::skip)]\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use: `#[rustfmt::skip]`\n+   |\n+   = note: `-D clippy::deprecated-cfg-attr` implied by `-D warnings`\n+\n+error: `cfg_attr` is deprecated for rustfmt and got replaced by tool_attributes\n+  --> $DIR/cfg_attr_rustfmt.rs:29:1\n+   |\n+29 | #[cfg_attr(rustfmt, rustfmt_skip)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use: `#[rustfmt::skip]`\n+\n+error: `cfg_attr` is deprecated for rustfmt and got replaced by tool_attributes\n+  --> $DIR/cfg_attr_rustfmt.rs:35:5\n+   |\n+35 |     #![cfg_attr(rustfmt, rustfmt_skip)]\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use: `#![rustfmt::skip]`\n+\n+error: aborting due to 3 previous errors\n+"}]}