{"sha": "2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4NDRjOGZkZmExODg5ZTc0Y2UyNmM3MTM3MWY4YWY0M2YwZjZmNGU=", "commit": {"author": {"name": "Jeremy A. Kolb", "email": "jkolb@ara.com", "date": "2018-10-18T21:56:22Z"}, "committer": {"name": "Jeremy A. Kolb", "email": "jkolb@ara.com", "date": "2018-10-18T21:56:22Z"}, "message": "Handle renaming of local variables", "tree": {"sha": "3e38e04f74f574b9637ed72e13f4fb01c2f22aa7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3e38e04f74f574b9637ed72e13f4fb01c2f22aa7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "html_url": "https://github.com/rust-lang/rust/commit/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/comments", "author": {"login": "kjeremy", "id": 4325700, "node_id": "MDQ6VXNlcjQzMjU3MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/4325700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjeremy", "html_url": "https://github.com/kjeremy", "followers_url": "https://api.github.com/users/kjeremy/followers", "following_url": "https://api.github.com/users/kjeremy/following{/other_user}", "gists_url": "https://api.github.com/users/kjeremy/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjeremy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjeremy/subscriptions", "organizations_url": "https://api.github.com/users/kjeremy/orgs", "repos_url": "https://api.github.com/users/kjeremy/repos", "events_url": "https://api.github.com/users/kjeremy/events{/privacy}", "received_events_url": "https://api.github.com/users/kjeremy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kjeremy", "id": 4325700, "node_id": "MDQ6VXNlcjQzMjU3MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/4325700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjeremy", "html_url": "https://github.com/kjeremy", "followers_url": "https://api.github.com/users/kjeremy/followers", "following_url": "https://api.github.com/users/kjeremy/following{/other_user}", "gists_url": "https://api.github.com/users/kjeremy/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjeremy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjeremy/subscriptions", "organizations_url": "https://api.github.com/users/kjeremy/orgs", "repos_url": "https://api.github.com/users/kjeremy/repos", "events_url": "https://api.github.com/users/kjeremy/events{/privacy}", "received_events_url": "https://api.github.com/users/kjeremy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3746689e9ddea455d10a41d9fc3af33b22a3707d", "url": "https://api.github.com/repos/rust-lang/rust/commits/3746689e9ddea455d10a41d9fc3af33b22a3707d", "html_url": "https://github.com/rust-lang/rust/commit/3746689e9ddea455d10a41d9fc3af33b22a3707d"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "b6436b646c47ca2e8981ee2aabba179e339622fd", "filename": "crates/ra_lsp_server/src/caps.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs?ref=2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "patch": "@@ -2,7 +2,7 @@ use languageserver_types::{\n     CodeActionProviderCapability, CompletionOptions, DocumentOnTypeFormattingOptions,\n     ExecuteCommandOptions, FoldingRangeProviderCapability, ServerCapabilities,\n     SignatureHelpOptions, TextDocumentSyncCapability, TextDocumentSyncKind,\n-    TextDocumentSyncOptions,\n+    TextDocumentSyncOptions, RenameProviderCapability, RenameOptions\n };\n \n pub fn server_capabilities() -> ServerCapabilities {\n@@ -40,7 +40,9 @@ pub fn server_capabilities() -> ServerCapabilities {\n             more_trigger_character: None,\n         }),\n         folding_range_provider: Some(FoldingRangeProviderCapability::Simple(true)),\n-        rename_provider: None,\n+        rename_provider: Some(RenameProviderCapability::Options(RenameOptions{\n+            prepare_provider: Some(true)\n+        })),\n         color_provider: None,\n         execute_command_provider: Some(ExecuteCommandOptions {\n             commands: vec![\"apply_code_action\".to_string()],"}, {"sha": "3de440e1fdc8a3dc6d84bf300ba0a0a373a0c70e", "filename": "crates/ra_lsp_server/src/main_loop/handlers.rs", "status": "modified", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "patch": "@@ -4,6 +4,7 @@ use languageserver_types::{\n     CodeActionResponse, Command, CompletionItem, CompletionItemKind, Diagnostic,\n     DiagnosticSeverity, DocumentSymbol, FoldingRange, FoldingRangeKind, FoldingRangeParams,\n     InsertTextFormat, Location, Position, SymbolInformation, TextDocumentIdentifier, TextEdit,\n+    RenameParams, WorkspaceEdit\n };\n use ra_analysis::{FileId, FoldKind, JobToken, Query, RunnableKind};\n use ra_syntax::text_utils::contains_offset_nonstrict;\n@@ -17,6 +18,8 @@ use crate::{\n     Result,\n };\n \n+use std::collections::HashMap;\n+\n pub fn handle_syntax_tree(\n     world: ServerWorld,\n     params: req::SyntaxTreeParams,\n@@ -460,6 +463,43 @@ pub fn handle_signature_help(\n     }\n }\n \n+pub fn handle_rename(\n+    world: ServerWorld,\n+    params: RenameParams,\n+    token: JobToken,\n+) -> Result<Option<WorkspaceEdit>> {\n+    let file_id = params.text_document.try_conv_with(&world)?;\n+    let line_index = world.analysis().file_line_index(file_id);\n+    let offset = params.position.conv_with(&line_index);\n+\n+    if params.new_name.is_empty() {\n+        return Ok(None);\n+    }\n+\n+    let refs = world.analysis().find_all_refs(file_id, offset, &token);\n+    if refs.is_empty() {\n+        return Ok(None);\n+    }\n+\n+    let mut changes = HashMap::new();\n+    for r in refs {\n+        if let Ok(loc) = to_location(r.0, r.1, &world, &line_index) {\n+            changes.entry(loc.uri).or_insert(Vec::new()).push(\n+                TextEdit {\n+                    range: loc.range,\n+                    new_text: params.new_name.clone()\n+                });\n+        }\n+    }\n+\n+    Ok(Some(WorkspaceEdit {\n+        changes: Some(changes),\n+\n+        // TODO: return this instead if client/server support it. See #144\n+        document_changes : None,\n+    }))\n+}\n+\n pub fn handle_references(\n     world: ServerWorld,\n     params: req::ReferenceParams,"}, {"sha": "2367464471052b18187c035c7174f17259030466", "filename": "crates/ra_lsp_server/src/main_loop/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2844c8fdfa1889e74ce26c71371f8af43f0f6f4e/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fmod.rs?ref=2844c8fdfa1889e74ce26c71371f8af43f0f6f4e", "patch": "@@ -248,6 +248,7 @@ fn on_request(\n         .on::<req::CodeActionRequest>(handlers::handle_code_action)?\n         .on::<req::FoldingRangeRequest>(handlers::handle_folding_range)?\n         .on::<req::SignatureHelpRequest>(handlers::handle_signature_help)?\n+        .on::<req::Rename>(handlers::handle_rename)?\n         .on::<req::References>(handlers::handle_references)?\n         .finish();\n     match req {"}]}