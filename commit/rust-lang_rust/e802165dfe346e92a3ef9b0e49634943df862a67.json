{"sha": "e802165dfe346e92a3ef9b0e49634943df862a67", "node_id": "C_kwDOAAsO6NoAKGU4MDIxNjVkZmUzNDZlOTJhM2VmOWIwZTQ5NjM0OTQzZGY4NjJhNjc", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-11-28T08:03:57Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-12-06T04:43:41Z"}, "message": "On E0195 point at where clause lifetime bounds\n\nFix #104733", "tree": {"sha": "feafba8dd65274173e2f57e8bfd059f9b94fca2c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/feafba8dd65274173e2f57e8bfd059f9b94fca2c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e802165dfe346e92a3ef9b0e49634943df862a67", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e802165dfe346e92a3ef9b0e49634943df862a67", "html_url": "https://github.com/rust-lang/rust/commit/e802165dfe346e92a3ef9b0e49634943df862a67", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e802165dfe346e92a3ef9b0e49634943df862a67/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "203c8765ea33c65d888febe0e8219c4bb11b0d89", "url": "https://api.github.com/repos/rust-lang/rust/commits/203c8765ea33c65d888febe0e8219c4bb11b0d89", "html_url": "https://github.com/rust-lang/rust/commit/203c8765ea33c65d888febe0e8219c4bb11b0d89"}], "stats": {"total": 114, "additions": 103, "deletions": 11}, "files": [{"sha": "a5cb8a88819df2d09a4ecd141748f5c5000de062", "filename": "compiler/rustc_error_messages/locales/en-US/hir_analysis.ftl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e802165dfe346e92a3ef9b0e49634943df862a67/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fhir_analysis.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/e802165dfe346e92a3ef9b0e49634943df862a67/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fhir_analysis.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fhir_analysis.ftl?ref=e802165dfe346e92a3ef9b0e49634943df862a67", "patch": "@@ -17,6 +17,8 @@ hir_analysis_lifetimes_or_bounds_mismatch_on_trait =\n     lifetime parameters or bounds on {$item_kind} `{$ident}` do not match the trait declaration\n     .label = lifetimes do not match {$item_kind} in trait\n     .generics_label = lifetimes in impl do not match this {$item_kind} in trait\n+    .where_label = this `where` clause might not match the one in the trait\n+    .bounds_label = this bound might be missing in the impl\n \n hir_analysis_drop_impl_on_wrong_item =\n     the `Drop` trait may only be implemented for local structs, enums, and unions"}, {"sha": "1d6f9b29176518a30f487dca7eab58e0610b3ccf", "filename": "compiler/rustc_hir_analysis/src/check/compare_method.rs", "status": "modified", "additions": 40, "deletions": 11, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/e802165dfe346e92a3ef9b0e49634943df862a67/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e802165dfe346e92a3ef9b0e49634943df862a67/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs?ref=e802165dfe346e92a3ef9b0e49634943df862a67", "patch": "@@ -751,27 +751,56 @@ fn check_region_bounds_on_impl_item<'tcx>(\n             .get_generics(impl_m.def_id.expect_local())\n             .expect(\"expected impl item to have generics or else we can't compare them\")\n             .span;\n-        let generics_span = if let Some(local_def_id) = trait_m.def_id.as_local() {\n-            Some(\n-                tcx.hir()\n-                    .get_generics(local_def_id)\n-                    .expect(\"expected trait item to have generics or else we can't compare them\")\n-                    .span,\n-            )\n-        } else {\n-            None\n-        };\n \n+        let mut generics_span = None;\n+        let mut bounds_span = vec![];\n+        let mut where_span = None;\n+        if let Some(trait_node) = tcx.hir().get_if_local(trait_m.def_id)\n+            && let Some(trait_generics) = trait_node.generics()\n+        {\n+            generics_span = Some(trait_generics.span);\n+            // FIXME: we could potentially look at the impl's bounds to not point at bounds that\n+            // *are* present in the impl.\n+            for p in trait_generics.predicates {\n+                if let hir::WherePredicate::BoundPredicate(pred) = p {\n+                    for b in pred.bounds {\n+                        if let hir::GenericBound::Outlives(lt) = b {\n+                            bounds_span.push(lt.ident.span);\n+                        }\n+                    }\n+                }\n+            }\n+            if let Some(impl_node) = tcx.hir().get_if_local(impl_m.def_id)\n+                && let Some(impl_generics) = impl_node.generics()\n+            {\n+                let mut impl_bounds = 0;\n+                for p in impl_generics.predicates {\n+                    if let hir::WherePredicate::BoundPredicate(pred) = p {\n+                        for b in pred.bounds {\n+                            if let hir::GenericBound::Outlives(_) = b {\n+                                impl_bounds += 1;\n+                            }\n+                        }\n+                    }\n+                }\n+                if impl_bounds == bounds_span.len() {\n+                    bounds_span = vec![];\n+                } else if impl_generics.has_where_clause_predicates {\n+                    where_span = Some(impl_generics.where_clause_span);\n+                }\n+            }\n+        }\n         let reported = tcx\n             .sess\n             .create_err(LifetimesOrBoundsMismatchOnTrait {\n                 span,\n                 item_kind: assoc_item_kind_str(impl_m),\n                 ident: impl_m.ident(tcx),\n                 generics_span,\n+                bounds_span,\n+                where_span,\n             })\n             .emit_unless(delay);\n-\n         return Err(reported);\n     }\n "}, {"sha": "5156d432b5b3720cbdfc7acdd57fcfbbc0ca2007", "filename": "compiler/rustc_hir_analysis/src/errors.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e802165dfe346e92a3ef9b0e49634943df862a67/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e802165dfe346e92a3ef9b0e49634943df862a67/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs?ref=e802165dfe346e92a3ef9b0e49634943df862a67", "patch": "@@ -43,6 +43,10 @@ pub struct LifetimesOrBoundsMismatchOnTrait {\n     pub span: Span,\n     #[label(generics_label)]\n     pub generics_span: Option<Span>,\n+    #[label(where_label)]\n+    pub where_span: Option<Span>,\n+    #[label(bounds_label)]\n+    pub bounds_span: Vec<Span>,\n     pub item_kind: &'static str,\n     pub ident: Ident,\n }"}, {"sha": "1994120ce1466063282893adfaa3a12dbcf63c5b", "filename": "src/test/ui/trait-bounds/impl-missing-where-clause-lifetimes-from-trait.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e802165dfe346e92a3ef9b0e49634943df862a67/src%2Ftest%2Fui%2Ftrait-bounds%2Fimpl-missing-where-clause-lifetimes-from-trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e802165dfe346e92a3ef9b0e49634943df862a67/src%2Ftest%2Fui%2Ftrait-bounds%2Fimpl-missing-where-clause-lifetimes-from-trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftrait-bounds%2Fimpl-missing-where-clause-lifetimes-from-trait.rs?ref=e802165dfe346e92a3ef9b0e49634943df862a67", "patch": "@@ -0,0 +1,30 @@\n+trait Trait<T> {\n+    fn foo<'a, K>(self, _: T, _: K) where T: 'a, K: 'a;\n+}\n+\n+impl Trait<()> for () {\n+    fn foo<'a, K>(self, _: (), _: K) where { //~ ERROR E0195\n+        todo!();\n+    }\n+}\n+\n+struct State;\n+\n+trait Foo<T> {\n+    fn foo<'a>(&self, state: &'a State) -> &'a T\n+    where\n+        T: 'a;\n+}\n+\n+impl<F, T> Foo<T> for F\n+where\n+    F: Fn(&State) -> &T,\n+{\n+    fn foo<'a>(&self, state: &'a State) -> &'a T { //~ ERROR E0195\n+        self(state)\n+    }\n+}\n+\n+fn main() {\n+    ().foo((), ());\n+}"}, {"sha": "3a02369e2ee8a3bc34f33b100c36cc821c967494", "filename": "src/test/ui/trait-bounds/impl-missing-where-clause-lifetimes-from-trait.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/e802165dfe346e92a3ef9b0e49634943df862a67/src%2Ftest%2Fui%2Ftrait-bounds%2Fimpl-missing-where-clause-lifetimes-from-trait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e802165dfe346e92a3ef9b0e49634943df862a67/src%2Ftest%2Fui%2Ftrait-bounds%2Fimpl-missing-where-clause-lifetimes-from-trait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftrait-bounds%2Fimpl-missing-where-clause-lifetimes-from-trait.stderr?ref=e802165dfe346e92a3ef9b0e49634943df862a67", "patch": "@@ -0,0 +1,27 @@\n+error[E0195]: lifetime parameters or bounds on method `foo` do not match the trait declaration\n+  --> $DIR/impl-missing-where-clause-lifetimes-from-trait.rs:6:11\n+   |\n+LL |     fn foo<'a, K>(self, _: T, _: K) where T: 'a, K: 'a;\n+   |           -------                            --     -- this bound might be missing in the impl\n+   |           |                                  |\n+   |           |                                  this bound might be missing in the impl\n+   |           lifetimes in impl do not match this method in trait\n+...\n+LL |     fn foo<'a, K>(self, _: (), _: K) where {\n+   |           ^^^^^^^ lifetimes do not match method in trait\n+\n+error[E0195]: lifetime parameters or bounds on method `foo` do not match the trait declaration\n+  --> $DIR/impl-missing-where-clause-lifetimes-from-trait.rs:23:11\n+   |\n+LL |     fn foo<'a>(&self, state: &'a State) -> &'a T\n+   |           ---- lifetimes in impl do not match this method in trait\n+LL |     where\n+LL |         T: 'a;\n+   |            -- this bound might be missing in the impl\n+...\n+LL |     fn foo<'a>(&self, state: &'a State) -> &'a T {\n+   |           ^^^^ lifetimes do not match method in trait\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0195`."}]}