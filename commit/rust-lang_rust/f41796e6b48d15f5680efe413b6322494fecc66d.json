{"sha": "f41796e6b48d15f5680efe413b6322494fecc66d", "node_id": "C_kwDOAAsO6NoAKGY0MTc5NmU2YjQ4ZDE1ZjU2ODBlZmU0MTNiNjMyMjQ5NGZlY2M2NmQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-03-12T19:44:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-12T19:44:49Z"}, "message": "Rollup merge of #108651 - LeSeulArtichaut:108645-target-feature-on-main, r=Nilstrieb\n\nForbid the use of `#[target_feature]` on `main`\n\nFixes #108645.", "tree": {"sha": "4ef6cfc7a750b5d014188af29029bf748eda1e0f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ef6cfc7a750b5d014188af29029bf748eda1e0f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f41796e6b48d15f5680efe413b6322494fecc66d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkDiuxCRBK7hj4Ov3rIwAAPBUIAD4tTmmJ9mKtnaRUCIZyiKQJ\nNbB8m+JXDXX3OgYd+DK3ixqxq/DsZ9hVsMVwEc6Dlzfvc95k+ZUraUcfo7xxw5dz\nbMegxQq01Ft86IvAQqESd8BQ3QZeakg4Jm2/N8t7emHqD+ygDZ18KQQG3SnrS0U7\ngqXaFa7LOFyDKfYvZeqlH101J8ufEjZJxdAc/s4TGedJ0IKf3bcvUCv5Zw13RAnG\nhoaxQOMOg+HGYM9ThQ7DqRs/dYNsl3JhMx2t0DwvQgsxeSIi3+ZQwrJlyGbOJxc3\n+k2iYjnt61OJsdoCyeVTbb+OCOqMa8NO6vmEgj7aZqMDGjHMaucdWgTFZfdqQHI=\n=JSN9\n-----END PGP SIGNATURE-----\n", "payload": "tree 4ef6cfc7a750b5d014188af29029bf748eda1e0f\nparent f41927f30943e4d57af62cfcedc9f07b819013e7\nparent 29b1789a75c988cedb75dbdd8ebd0397a922e174\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1678650289 +0100\ncommitter GitHub <noreply@github.com> 1678650289 +0100\n\nRollup merge of #108651 - LeSeulArtichaut:108645-target-feature-on-main, r=Nilstrieb\n\nForbid the use of `#[target_feature]` on `main`\n\nFixes #108645.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f41796e6b48d15f5680efe413b6322494fecc66d", "html_url": "https://github.com/rust-lang/rust/commit/f41796e6b48d15f5680efe413b6322494fecc66d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f41796e6b48d15f5680efe413b6322494fecc66d/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f41927f30943e4d57af62cfcedc9f07b819013e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/f41927f30943e4d57af62cfcedc9f07b819013e7", "html_url": "https://github.com/rust-lang/rust/commit/f41927f30943e4d57af62cfcedc9f07b819013e7"}, {"sha": "29b1789a75c988cedb75dbdd8ebd0397a922e174", "url": "https://api.github.com/repos/rust-lang/rust/commits/29b1789a75c988cedb75dbdd8ebd0397a922e174", "html_url": "https://github.com/rust-lang/rust/commit/29b1789a75c988cedb75dbdd8ebd0397a922e174"}], "stats": {"total": 85, "additions": 84, "deletions": 1}, "files": [{"sha": "8b6bf886b0d0ba93b763a3cf9e740c4e668e6c31", "filename": "compiler/rustc_codegen_ssa/src/codegen_attrs.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcodegen_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcodegen_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcodegen_attrs.rs?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -242,6 +242,9 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, did: DefId) -> CodegenFnAttrs {\n                     // Note that this is also allowed if `actually_rustdoc` so\n                     // if a target is documenting some wasm-specific code then\n                     // it's not spuriously denied.\n+                    //\n+                    // This exception needs to be kept in sync with allowing\n+                    // `#[target_feature]` on `main` and `start`.\n                 } else if !tcx.features().target_feature_11 {\n                     let mut err = feature_err(\n                         &tcx.sess.parse_sess,"}, {"sha": "0105cbf36dee2459d8b761e0ae0f871e4424249e", "filename": "compiler/rustc_hir_analysis/messages.ftl", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_hir_analysis%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_hir_analysis%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fmessages.ftl?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -128,9 +128,14 @@ hir_analysis_where_clause_on_main = `main` function is not allowed to have a `wh\n hir_analysis_track_caller_on_main = `main` function is not allowed to be `#[track_caller]`\n     .suggestion = remove this annotation\n \n+hir_analysis_target_feature_on_main = `main` function is not allowed to have `#[target_feature]`\n+\n hir_analysis_start_not_track_caller = `start` is not allowed to be `#[track_caller]`\n     .label = `start` is not allowed to be `#[track_caller]`\n \n+hir_analysis_start_not_target_feature = `start` is not allowed to have `#[target_feature]`\n+    .label = `start` is not allowed to have `#[target_feature]`\n+\n hir_analysis_start_not_async = `start` is not allowed to be `async`\n     .label = `start` is not allowed to be `async`\n "}, {"sha": "f57197edeb74dd377bfff053220be6484a593977", "filename": "compiler/rustc_hir_analysis/src/errors.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -327,6 +327,14 @@ pub(crate) struct TrackCallerOnMain {\n     pub annotated: Span,\n }\n \n+#[derive(Diagnostic)]\n+#[diag(hir_analysis_target_feature_on_main)]\n+pub(crate) struct TargetFeatureOnMain {\n+    #[primary_span]\n+    #[label(hir_analysis_target_feature_on_main)]\n+    pub main: Span,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(hir_analysis_start_not_track_caller)]\n pub(crate) struct StartTrackCaller {\n@@ -336,6 +344,15 @@ pub(crate) struct StartTrackCaller {\n     pub start: Span,\n }\n \n+#[derive(Diagnostic)]\n+#[diag(hir_analysis_start_not_target_feature)]\n+pub(crate) struct StartTargetFeature {\n+    #[primary_span]\n+    pub span: Span,\n+    #[label]\n+    pub start: Span,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(hir_analysis_start_not_async, code = \"E0752\")]\n pub(crate) struct StartAsync {"}, {"sha": "62abcbbdc9f6ead17c722c393c587dee83234b38", "filename": "compiler/rustc_hir_analysis/src/lib.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -283,6 +283,15 @@ fn check_main_fn_ty(tcx: TyCtxt<'_>, main_def_id: DefId) {\n         error = true;\n     }\n \n+    if !tcx.codegen_fn_attrs(main_def_id).target_features.is_empty()\n+        // Calling functions with `#[target_feature]` is not unsafe on WASM, see #84988\n+        && !tcx.sess.target.is_like_wasm\n+        && !tcx.sess.opts.actually_rustdoc\n+    {\n+        tcx.sess.emit_err(errors::TargetFeatureOnMain { main: main_span });\n+        error = true;\n+    }\n+\n     if error {\n         return;\n     }\n@@ -373,6 +382,18 @@ fn check_start_fn_ty(tcx: TyCtxt<'_>, start_def_id: DefId) {\n                             });\n                             error = true;\n                         }\n+                        if attr.has_name(sym::target_feature)\n+                            // Calling functions with `#[target_feature]` is\n+                            // not unsafe on WASM, see #84988\n+                            && !tcx.sess.target.is_like_wasm\n+                            && !tcx.sess.opts.actually_rustdoc\n+                        {\n+                            tcx.sess.emit_err(errors::StartTargetFeature {\n+                                span: attr.span,\n+                                start: start_span,\n+                            });\n+                            error = true;\n+                        }\n                     }\n \n                     if error {"}, {"sha": "39c645640222379d09ab374c6815eb224c0c4da6", "filename": "tests/ui/asm/x86_64/issue-89875.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Fasm%2Fx86_64%2Fissue-89875.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Fasm%2Fx86_64%2Fissue-89875.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasm%2Fx86_64%2Fissue-89875.rs?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -7,11 +7,13 @@\n use std::arch::asm;\n \n #[target_feature(enable = \"avx\")]\n-fn main() {\n+fn foo() {\n     unsafe {\n         asm!(\n             \"/* {} */\",\n             out(ymm_reg) _,\n         );\n     }\n }\n+\n+fn main() {}"}, {"sha": "0d59e50264e1be2c9810a3f9e9e39194dc22c8a0", "filename": "tests/ui/rfcs/rfc-2396-target_feature-11/issue-108645-target-feature-on-main.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-main.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-main.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-main.rs?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -0,0 +1,7 @@\n+// only-x86_64\n+\n+#![feature(target_feature_11)]\n+\n+#[target_feature(enable = \"avx2\")]\n+fn main() {}\n+//~^ ERROR `main` function is not allowed to have `#[target_feature]`"}, {"sha": "cfafbd52286a788d3057bb7475ffbdb1928ad418", "filename": "tests/ui/rfcs/rfc-2396-target_feature-11/issue-108645-target-feature-on-main.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-main.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-main.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-main.stderr?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -0,0 +1,8 @@\n+error: `main` function is not allowed to have `#[target_feature]`\n+  --> $DIR/issue-108645-target-feature-on-main.rs:6:1\n+   |\n+LL | fn main() {}\n+   | ^^^^^^^^^ `main` function is not allowed to have `#[target_feature]`\n+\n+error: aborting due to previous error\n+"}, {"sha": "50e8ce2fdd5ed6a12aad0ed940fdbea06c625521", "filename": "tests/ui/rfcs/rfc-2396-target_feature-11/issue-108645-target-feature-on-start.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.rs?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -0,0 +1,9 @@\n+// only-x86_64\n+\n+#![feature(start)]\n+#![feature(target_feature_11)]\n+\n+#[start]\n+#[target_feature(enable = \"avx2\")]\n+//~^ ERROR `start` is not allowed to have `#[target_feature]`\n+fn start(_argc: isize, _argv: *const *const u8) -> isize { 0 }"}, {"sha": "07687f3c7f4a2f03adc543fd3495342a79ee5555", "filename": "tests/ui/rfcs/rfc-2396-target_feature-11/issue-108645-target-feature-on-start.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f41796e6b48d15f5680efe413b6322494fecc66d/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.stderr?ref=f41796e6b48d15f5680efe413b6322494fecc66d", "patch": "@@ -0,0 +1,11 @@\n+error: `start` is not allowed to have `#[target_feature]`\n+  --> $DIR/issue-108645-target-feature-on-start.rs:7:1\n+   |\n+LL | #[target_feature(enable = \"avx2\")]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL | fn start(_argc: isize, _argv: *const *const u8) -> isize { 0 }\n+   | -------------------------------------------------------- `start` is not allowed to have `#[target_feature]`\n+\n+error: aborting due to previous error\n+"}]}