{"sha": "8e0df32ad6dd4e171742dc159a08f247c1a256ab", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlMGRmMzJhZDZkZDRlMTcxNzQyZGMxNTlhMDhmMjQ3YzFhMjU2YWI=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-07-31T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-08-04T13:51:30Z"}, "message": "Replace LLVMConstInBoundsGEP with LLVMConstInBoundsGEP2*\n\nA custom reimplementation of LLVMConstInBoundsGEP2 is used, since the\nLLVM contains a declaration of LLVMConstInBoundsGEP2 but not the\nimplementation.", "tree": {"sha": "8b67fcdabb9cad9c6e64b5ceb7ee8bcb12edfd42", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b67fcdabb9cad9c6e64b5ceb7ee8bcb12edfd42"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8e0df32ad6dd4e171742dc159a08f247c1a256ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8e0df32ad6dd4e171742dc159a08f247c1a256ab", "html_url": "https://github.com/rust-lang/rust/commit/8e0df32ad6dd4e171742dc159a08f247c1a256ab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8e0df32ad6dd4e171742dc159a08f247c1a256ab/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77e5e17231af060cc5ab17ec63494064ecc51076", "url": "https://api.github.com/repos/rust-lang/rust/commits/77e5e17231af060cc5ab17ec63494064ecc51076", "html_url": "https://github.com/rust-lang/rust/commit/77e5e17231af060cc5ab17ec63494064ecc51076"}], "stats": {"total": 19, "additions": 16, "deletions": 3}, "files": [{"sha": "5532f53e40823fc0ede2a3e56ed85206001637e7", "filename": "compiler/rustc_codegen_llvm/src/common.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8e0df32ad6dd4e171742dc159a08f247c1a256ab/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e0df32ad6dd4e171742dc159a08f247c1a256ab/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcommon.rs?ref=8e0df32ad6dd4e171742dc159a08f247c1a256ab", "patch": "@@ -268,7 +268,8 @@ impl ConstMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n                     }\n                 };\n                 let llval = unsafe {\n-                    llvm::LLVMConstInBoundsGEP(\n+                    llvm::LLVMRustConstInBoundsGEP2(\n+                        self.type_i8(),\n                         self.const_bitcast(base_addr, self.type_i8p_ext(base_addr_space)),\n                         &self.const_usize(offset.bytes()),\n                         1,\n@@ -303,7 +304,8 @@ impl ConstMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n             let base_addr = self.static_addr_of(init, alloc.align, None);\n \n             let llval = unsafe {\n-                llvm::LLVMConstInBoundsGEP(\n+                llvm::LLVMRustConstInBoundsGEP2(\n+                    self.type_i8(),\n                     self.const_bitcast(base_addr, self.type_i8p()),\n                     &self.const_usize(offset.bytes()),\n                     1,"}, {"sha": "e803ad6d88e3c05a5b0cf93275778766aeaeda32", "filename": "compiler/rustc_codegen_llvm/src/llvm/ffi.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8e0df32ad6dd4e171742dc159a08f247c1a256ab/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e0df32ad6dd4e171742dc159a08f247c1a256ab/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs?ref=8e0df32ad6dd4e171742dc159a08f247c1a256ab", "patch": "@@ -1011,7 +1011,8 @@ extern \"C\" {\n     pub fn LLVMConstVector(ScalarConstantVals: *const &Value, Size: c_uint) -> &Value;\n \n     // Constant expressions\n-    pub fn LLVMConstInBoundsGEP(\n+    pub fn LLVMRustConstInBoundsGEP2(\n+        ty: &'a Type,\n         ConstantVal: &'a Value,\n         ConstantIndices: *const &'a Value,\n         NumIndices: c_uint,"}, {"sha": "7666803911e0b6d12fc3c5e19a93aeb8c3741904", "filename": "compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8e0df32ad6dd4e171742dc159a08f247c1a256ab/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/8e0df32ad6dd4e171742dc159a08f247c1a256ab/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp?ref=8e0df32ad6dd4e171742dc159a08f247c1a256ab", "patch": "@@ -1551,6 +1551,16 @@ extern \"C\" void LLVMRustSetLinkage(LLVMValueRef V,\n   LLVMSetLinkage(V, fromRust(RustLinkage));\n }\n \n+extern \"C\" LLVMValueRef LLVMRustConstInBoundsGEP2(LLVMTypeRef Ty,\n+                                                  LLVMValueRef ConstantVal,\n+                                                  LLVMValueRef *ConstantIndices,\n+                                                  unsigned NumIndices) {\n+  ArrayRef<Constant *> IdxList(unwrap<Constant>(ConstantIndices, NumIndices),\n+                               NumIndices);\n+  Constant *Val = unwrap<Constant>(ConstantVal);\n+  return wrap(ConstantExpr::getInBoundsGetElementPtr(unwrap(Ty), Val, IdxList));\n+}\n+\n // Returns true if both high and low were successfully set. Fails in case constant wasn\u2019t any of\n // the common sizes (1, 8, 16, 32, 64, 128 bits)\n extern \"C\" bool LLVMRustConstInt128Get(LLVMValueRef CV, bool sext, uint64_t *high, uint64_t *low)"}]}