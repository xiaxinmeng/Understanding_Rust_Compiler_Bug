{"sha": "c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0OWQ1Zjc1N2NjY2M3ZmMyZWYwMmY2YThiM2NmOGE0NTljOGYzMjY=", "commit": {"author": {"name": "Jesse Bakker", "email": "github@jessebakker.com", "date": "2021-01-05T21:29:53Z"}, "committer": {"name": "Jesse Bakker", "email": "github@jessebakker.com", "date": "2021-01-05T22:58:51Z"}, "message": "Normalize line endings when formatting", "tree": {"sha": "66364e586f95934c40937983ac700e4acfa3127b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/66364e586f95934c40937983ac700e4acfa3127b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326", "html_url": "https://github.com/rust-lang/rust/commit/c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326/comments", "author": {"login": "Jesse-Bakker", "id": 22473248, "node_id": "MDQ6VXNlcjIyNDczMjQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22473248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jesse-Bakker", "html_url": "https://github.com/Jesse-Bakker", "followers_url": "https://api.github.com/users/Jesse-Bakker/followers", "following_url": "https://api.github.com/users/Jesse-Bakker/following{/other_user}", "gists_url": "https://api.github.com/users/Jesse-Bakker/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jesse-Bakker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jesse-Bakker/subscriptions", "organizations_url": "https://api.github.com/users/Jesse-Bakker/orgs", "repos_url": "https://api.github.com/users/Jesse-Bakker/repos", "events_url": "https://api.github.com/users/Jesse-Bakker/events{/privacy}", "received_events_url": "https://api.github.com/users/Jesse-Bakker/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jesse-Bakker", "id": 22473248, "node_id": "MDQ6VXNlcjIyNDczMjQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22473248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jesse-Bakker", "html_url": "https://github.com/Jesse-Bakker", "followers_url": "https://api.github.com/users/Jesse-Bakker/followers", "following_url": "https://api.github.com/users/Jesse-Bakker/following{/other_user}", "gists_url": "https://api.github.com/users/Jesse-Bakker/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jesse-Bakker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jesse-Bakker/subscriptions", "organizations_url": "https://api.github.com/users/Jesse-Bakker/orgs", "repos_url": "https://api.github.com/users/Jesse-Bakker/repos", "events_url": "https://api.github.com/users/Jesse-Bakker/events{/privacy}", "received_events_url": "https://api.github.com/users/Jesse-Bakker/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41454eb1ebc87c0f35d247bfb600e775abe022f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/41454eb1ebc87c0f35d247bfb600e775abe022f4", "html_url": "https://github.com/rust-lang/rust/commit/41454eb1ebc87c0f35d247bfb600e775abe022f4"}], "stats": {"total": 18, "additions": 15, "deletions": 3}, "files": [{"sha": "3e49904c337cff564864e66f08117dcbe6de2754", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=c49d5f757cccc7fc2ef02f6a8b3cf8a459c8f326", "patch": "@@ -31,12 +31,13 @@ use serde_json::to_value;\n use stdx::{format_to, split_once};\n use syntax::{algo, ast, AstNode, TextRange, TextSize};\n \n-use crate::diff::diff;\n use crate::{\n     cargo_target_spec::CargoTargetSpec,\n     config::RustfmtConfig,\n+    diff::diff,\n     from_json, from_proto,\n     global_state::{GlobalState, GlobalStateSnapshot},\n+    line_endings::LineEndings,\n     lsp_ext::{self, InlayHint, InlayHintsParams},\n     lsp_utils::all_edits_are_disjoint,\n     to_proto, LspError, Result,\n@@ -909,14 +910,25 @@ pub(crate) fn handle_formatting(\n         }\n     }\n \n-    if *file == captured_stdout {\n+    let (new_text, new_line_endings) = LineEndings::normalize(captured_stdout);\n+\n+    if file_line_endings != new_line_endings {\n+        // If line endings are different, send the entire file.\n+        // Diffing would not work here, as the line endings might be the only\n+        // difference.\n+        Ok(Some(to_proto::text_edit_vec(\n+            &file_line_index,\n+            new_line_endings,\n+            TextEdit::replace(TextRange::up_to(TextSize::of(&*file)), new_text),\n+        )))\n+    } else if *file == new_text {\n         // The document is already formatted correctly -- no edits needed.\n         Ok(None)\n     } else {\n         Ok(Some(to_proto::text_edit_vec(\n             &file_line_index,\n             file_line_endings,\n-            diff(&file, &captured_stdout),\n+            diff(&file, &new_text),\n         )))\n     }\n }"}]}