{"sha": "cf9340113efcf5c7bea4a143f42c8ea47da4550e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmOTM0MDExM2VmY2Y1YzdiZWE0YTE0M2Y0MmM4ZWE0N2RhNDU1MGU=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-10-24T08:15:30Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-10-24T08:15:30Z"}, "message": "rustup: more flexible write_bytes avoids allocations and removes itertools dependency", "tree": {"sha": "78f81d75cbedee204204d567981b2b7c7f46fddd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/78f81d75cbedee204204d567981b2b7c7f46fddd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf9340113efcf5c7bea4a143f42c8ea47da4550e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf9340113efcf5c7bea4a143f42c8ea47da4550e", "html_url": "https://github.com/rust-lang/rust/commit/cf9340113efcf5c7bea4a143f42c8ea47da4550e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf9340113efcf5c7bea4a143f42c8ea47da4550e/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a05f2aa3ab6caddd2fde2a823bcee63a16b6dd6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a05f2aa3ab6caddd2fde2a823bcee63a16b6dd6c", "html_url": "https://github.com/rust-lang/rust/commit/a05f2aa3ab6caddd2fde2a823bcee63a16b6dd6c"}], "stats": {"total": 37, "additions": 11, "deletions": 26}, "files": [{"sha": "1aa15f8b6846a50f421b1e1164341a55c2b13914", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 16, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/cf9340113efcf5c7bea4a143f42c8ea47da4550e/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/cf9340113efcf5c7bea4a143f42c8ea47da4550e/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=cf9340113efcf5c7bea4a143f42c8ea47da4550e", "patch": "@@ -215,11 +215,6 @@ dependencies = [\n  \"winapi 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n-[[package]]\n-name = \"either\"\n-version = \"1.5.3\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-\n [[package]]\n name = \"env_logger\"\n version = \"0.6.2\"\n@@ -299,14 +294,6 @@ dependencies = [\n  \"quick-error 1.2.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n-[[package]]\n-name = \"itertools\"\n-version = \"0.8.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-dependencies = [\n- \"either 1.5.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n-]\n-\n [[package]]\n name = \"itoa\"\n version = \"0.4.4\"\n@@ -365,7 +352,6 @@ dependencies = [\n  \"env_logger 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"getrandom 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"hex 0.3.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"itertools 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"num-traits 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rand 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -849,7 +835,6 @@ dependencies = [\n \"checksum diff 0.1.11 (registry+https://github.com/rust-lang/crates.io-index)\" = \"3c2b69f912779fbb121ceb775d74d51e915af17aaebc38d28a592843a2dd0a3a\"\n \"checksum directories 2.0.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"551a778172a450d7fc12e629ca3b0428d00f6afa9a43da1b630d54604e97371c\"\n \"checksum dirs-sys 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"afa0b23de8fd801745c471deffa6e12d248f962c9fd4b4c33787b055599bde7b\"\n-\"checksum either 1.5.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bb1f6b1ce1c140482ea30ddd3335fc0024ac7ee112895426e0a629a6c20adfe3\"\n \"checksum env_logger 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"aafcde04e90a5226a6443b7aabdb016ba2f8307c847d524724bd9b346dd1a2d3\"\n \"checksum failure 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"f8273f13c977665c5db7eb2b99ae520952fe5ac831ae4cd09d80c4c7042b5ed9\"\n \"checksum failure_derive 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0bc225b78e0391e4b8683440bf2e63c2deeeb2ce5189eab46e2b68c6d3725d08\"\n@@ -859,7 +844,6 @@ dependencies = [\n \"checksum getrandom 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)\" = \"473a1265acc8ff1e808cd0a1af8cee3c2ee5200916058a2ca113c29f2d903571\"\n \"checksum hex 0.3.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"805026a5d0141ffc30abb3be3173848ad46a1b1664fe632428479619a3644d77\"\n \"checksum humantime 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"df004cfca50ef23c36850aaaa59ad52cc70d0e90243c3c7737a4dd32dc7a3c4f\"\n-\"checksum itertools 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5b8467d9c1cebe26feb08c640139247fac215782d35371ade9a2136ed6085358\"\n \"checksum itoa 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"501266b7edd0174f8530248f87f99c88fbe60ca4ef3dd486835b8d8d53136f7f\"\n \"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d\"\n \"checksum lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"e2abad23fbc42b3700f2f279844dc832adb2b2eb069b2df918f455c4e18cc646\""}, {"sha": "6e317ce9459704460419664c95813efb0ea2d637", "filename": "Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cf9340113efcf5c7bea4a143f42c8ea47da4550e/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/cf9340113efcf5c7bea4a143f42c8ea47da4550e/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=cf9340113efcf5c7bea4a143f42c8ea47da4550e", "patch": "@@ -40,7 +40,6 @@ log = \"0.4\"\n shell-escape = \"0.1.4\"\n hex = \"0.3.2\"\n rand = \"0.7\"\n-itertools = \"0.8\"\n \n # A noop dependency that changes in the Rust repository, it's a bit of a hack.\n # See the `src/tools/rustc-workspace-hack/README.md` file in `rust-lang/rust`"}, {"sha": "543d4e269d410c996b0ef876ad567f8b3d59bcc8", "filename": "rust-version", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf9340113efcf5c7bea4a143f42c8ea47da4550e/rust-version", "raw_url": "https://github.com/rust-lang/rust/raw/cf9340113efcf5c7bea4a143f42c8ea47da4550e/rust-version", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rust-version?ref=cf9340113efcf5c7bea4a143f42c8ea47da4550e", "patch": "@@ -1 +1 @@\n-f466f52c1bf8f2e4454e31c683a88625ad4b4033\n+55e00631e5bc5b16d40232914e57deeea197a8e4"}, {"sha": "f7be3de8e481227ba2d0077d757ec4d146bf9822", "filename": "src/helpers.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf9340113efcf5c7bea4a143f42c8ea47da4550e/src%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf9340113efcf5c7bea4a143f42c8ea47da4550e/src%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fhelpers.rs?ref=cf9340113efcf5c7bea4a143f42c8ea47da4550e", "patch": "@@ -1,4 +1,4 @@\n-use std::mem;\n+use std::{mem, iter};\n use std::ffi::{OsStr, OsString};\n \n use rustc::hir::def_id::{DefId, CRATE_DEF_INDEX};\n@@ -428,7 +428,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             return Ok(false);\n         }\n         // FIXME: We should use `Iterator::chain` instead when rust-lang/rust#65704 lands.\n-        self.eval_context_mut().memory.write_bytes(scalar, [bytes, &[0]].concat())?;\n+        self.eval_context_mut().memory.write_bytes(scalar, bytes.iter().copied().chain(iter::once(0u8)))?;\n         Ok(true)\n     }\n }"}, {"sha": "dea01c63a05b9fb61052c4636d75235f7585c427", "filename": "src/shims/foreign_items.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cf9340113efcf5c7bea4a143f42c8ea47da4550e/src%2Fshims%2Fforeign_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf9340113efcf5c7bea4a143f42c8ea47da4550e/src%2Fshims%2Fforeign_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fforeign_items.rs?ref=cf9340113efcf5c7bea4a143f42c8ea47da4550e", "patch": "@@ -1,4 +1,4 @@\n-use std::convert::TryInto;\n+use std::{iter, convert::TryInto};\n \n use rustc::hir::def_id::DefId;\n use rustc::mir;\n@@ -52,7 +52,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             if zero_init {\n                 // We just allocated this, the access is definitely in-bounds.\n                 this.memory\n-                    .write_bytes(ptr.into(), itertools::repeat_n(0u8, size as usize))\n+                    .write_bytes(ptr.into(), iter::repeat(0u8).take(size as usize))\n                     .unwrap();\n             }\n             Scalar::Ptr(ptr)\n@@ -227,7 +227,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 );\n                 // We just allocated this, the access is definitely in-bounds.\n                 this.memory\n-                    .write_bytes(ptr.into(), itertools::repeat_n(0u8, size as usize))\n+                    .write_bytes(ptr.into(), iter::repeat(0u8).take(size as usize))\n                     .unwrap();\n                 this.write_scalar(Scalar::Ptr(ptr), dest)?;\n             }\n@@ -839,7 +839,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 let system_info = this.deref_operand(args[0])?;\n                 // Initialize with `0`.\n                 this.memory\n-                    .write_bytes(system_info.ptr, itertools::repeat_n(0, system_info.layout.size.bytes() as usize))?;\n+                    .write_bytes(system_info.ptr, iter::repeat(0u8).take(system_info.layout.size.bytes() as usize))?;\n                 // Set number of processors.\n                 let dword_size = Size::from_bytes(4);\n                 let num_cpus = this.mplace_field(system_info, 6)?;"}, {"sha": "5ef7fba7f59083b093902b40a094b4b2fe851d95", "filename": "src/shims/intrinsics.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cf9340113efcf5c7bea4a143f42c8ea47da4550e/src%2Fshims%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf9340113efcf5c7bea4a143f42c8ea47da4550e/src%2Fshims%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fintrinsics.rs?ref=cf9340113efcf5c7bea4a143f42c8ea47da4550e", "patch": "@@ -1,3 +1,5 @@\n+use std::iter;\n+\n use rustc_apfloat::Float;\n use rustc::mir;\n use rustc::mir::interpret::{InterpResult, PointerArithmetic};\n@@ -357,7 +359,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                             // Do it in memory\n                             let mplace = this.force_allocation(dest)?;\n                             mplace.meta.unwrap_none(); // must be sized\n-                            this.memory.write_bytes(mplace.ptr, itertools::repeat_n(0, dest.layout.size.bytes() as usize))?;\n+                            this.memory.write_bytes(mplace.ptr, iter::repeat(0u8).take(dest.layout.size.bytes() as usize))?;\n                         }\n                     }\n                 }\n@@ -562,7 +564,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 let ptr = this.read_scalar(args[0])?.not_undef()?;\n                 let count = this.read_scalar(args[2])?.to_usize(this)?;\n                 let byte_count = ty_layout.size * count;\n-                this.memory.write_bytes(ptr, itertools::repeat_n(val_byte, byte_count.bytes() as usize))?;\n+                this.memory.write_bytes(ptr, iter::repeat(val_byte).take(byte_count.bytes() as usize))?;\n             }\n \n             name => throw_unsup_format!(\"unimplemented intrinsic: {}\", name),"}]}