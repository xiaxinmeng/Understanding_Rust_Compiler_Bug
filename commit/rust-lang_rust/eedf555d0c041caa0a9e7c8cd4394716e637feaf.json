{"sha": "eedf555d0c041caa0a9e7c8cd4394716e637feaf", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlZGY1NTVkMGMwNDFjYWEwYTllN2M4Y2Q0Mzk0NzE2ZTYzN2ZlYWY=", "commit": {"author": {"name": "Eduard-Mihai Burtescu", "email": "edy.burt@gmail.com", "date": "2019-09-04T12:21:46Z"}, "committer": {"name": "Eduard-Mihai Burtescu", "email": "edy.burt@gmail.com", "date": "2019-09-06T13:57:20Z"}, "message": "rustc_codegen_llvm: give names to non-alloca variable values.", "tree": {"sha": "d8b83038e8981d4f38b6d1eb97c47e44ec4cb1cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8b83038e8981d4f38b6d1eb97c47e44ec4cb1cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eedf555d0c041caa0a9e7c8cd4394716e637feaf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eedf555d0c041caa0a9e7c8cd4394716e637feaf", "html_url": "https://github.com/rust-lang/rust/commit/eedf555d0c041caa0a9e7c8cd4394716e637feaf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eedf555d0c041caa0a9e7c8cd4394716e637feaf/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1fb3c4ec7ca37d33bd1e68cce669d171c2752615", "url": "https://api.github.com/repos/rust-lang/rust/commits/1fb3c4ec7ca37d33bd1e68cce669d171c2752615", "html_url": "https://github.com/rust-lang/rust/commit/1fb3c4ec7ca37d33bd1e68cce669d171c2752615"}], "stats": {"total": 86, "additions": 73, "deletions": 13}, "files": [{"sha": "6dedf10f0ab837e41fb5f3094e02c757df62868a", "filename": "src/librustc_codegen_llvm/debuginfo/mod.rs", "status": "modified", "additions": 32, "deletions": 3, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs?ref=eedf555d0c041caa0a9e7c8cd4394716e637feaf", "patch": "@@ -32,7 +32,7 @@ use rustc_codegen_ssa::debuginfo::{FunctionDebugContext, MirDebugScope, Variable\n \n use libc::c_uint;\n use std::cell::RefCell;\n-use std::ffi::CString;\n+use std::ffi::{CStr, CString};\n \n use syntax_pos::{self, Span, Pos};\n use syntax::ast;\n@@ -224,8 +224,37 @@ impl DebugInfoBuilderMethods<'tcx> for Builder<'a, 'll, 'tcx> {\n         gdb::insert_reference_to_gdb_debug_scripts_section_global(self)\n     }\n \n-    fn set_value_name(&mut self, value: &'ll Value, name: &str) {\n-        let cname = SmallCStr::new(name);\n+    fn set_var_name(&mut self, value: &'ll Value, name: impl ToString) {\n+        // Avoid wasting time if LLVM value names aren't even enabled.\n+        if self.sess().fewer_names() {\n+            return;\n+        }\n+\n+        // Only function parameters and instructions are local to a function,\n+        // don't change the name of anything else (e.g. globals).\n+        let param_or_inst = unsafe {\n+            llvm::LLVMIsAArgument(value).is_some() ||\n+            llvm::LLVMIsAInstruction(value).is_some()\n+        };\n+        if !param_or_inst {\n+            return;\n+        }\n+\n+        let old_name = unsafe {\n+            CStr::from_ptr(llvm::LLVMGetValueName(value))\n+        };\n+        match old_name.to_str() {\n+            Ok(\"\") => {}\n+            Ok(_) => {\n+                // Avoid replacing the name if it already exists.\n+                // While we could combine the names somehow, it'd\n+                // get noisy quick, and the usefulness is dubious.\n+                return;\n+            }\n+            Err(_) => return,\n+        }\n+\n+        let cname = CString::new(name.to_string()).unwrap();\n         unsafe {\n             llvm::LLVMSetValueName(value, cname.as_ptr());\n         }"}, {"sha": "b07214fdc03f3c22b4f93d2e462369ca87cd1bff", "filename": "src/librustc_codegen_llvm/llvm/ffi.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_llvm%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_llvm%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fllvm%2Fffi.rs?ref=eedf555d0c041caa0a9e7c8cd4394716e637feaf", "patch": "@@ -806,6 +806,7 @@ extern \"C\" {\n     pub fn LLVMRustRemoveFunctionAttributes(Fn: &Value, index: c_uint, attr: Attribute);\n \n     // Operations on parameters\n+    pub fn LLVMIsAArgument(Val: &Value) -> Option<&Value>;\n     pub fn LLVMCountParams(Fn: &Value) -> c_uint;\n     pub fn LLVMGetParam(Fn: &Value, Index: c_uint) -> &Value;\n \n@@ -818,6 +819,7 @@ extern \"C\" {\n     pub fn LLVMDeleteBasicBlock(BB: &BasicBlock);\n \n     // Operations on instructions\n+    pub fn LLVMIsAInstruction(Val: &Value) -> Option<&Value>;\n     pub fn LLVMGetFirstBasicBlock(Fn: &Value) -> &BasicBlock;\n \n     // Operations on call sites"}, {"sha": "00e9ca01f4dd257c6a78d5eb6229da08e3bd8f2a", "filename": "src/librustc_codegen_ssa/mir/mod.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs?ref=eedf555d0c041caa0a9e7c8cd4394716e637feaf", "patch": "@@ -518,19 +518,19 @@ fn arg_local_refs<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n                 PassMode::Ignore(IgnoreMode::CVarArgs) => {}\n                 PassMode::Direct(_) => {\n                     let llarg = bx.get_param(llarg_idx);\n-                    bx.set_value_name(llarg, &name);\n+                    bx.set_var_name(llarg, &name);\n                     llarg_idx += 1;\n                     return local(\n                         OperandRef::from_immediate_or_packed_pair(bx, llarg, arg.layout));\n                 }\n                 PassMode::Pair(..) => {\n-                    let a = bx.get_param(llarg_idx);\n-                    bx.set_value_name(a, &(name.clone() + \".0\"));\n-                    llarg_idx += 1;\n+                    let (a, b) = (bx.get_param(llarg_idx), bx.get_param(llarg_idx + 1));\n+                    llarg_idx += 2;\n \n-                    let b = bx.get_param(llarg_idx);\n-                    bx.set_value_name(b, &(name + \".1\"));\n-                    llarg_idx += 1;\n+                    // FIXME(eddyb) these are scalar components,\n+                    // maybe extract the high-level fields?\n+                    bx.set_var_name(a, format_args!(\"{}.0\", name));\n+                    bx.set_var_name(b, format_args!(\"{}.1\", name));\n \n                     return local(OperandRef {\n                         val: OperandValue::Pair(a, b),\n@@ -546,7 +546,7 @@ fn arg_local_refs<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n             // already put it in a temporary alloca and gave it up.\n             // FIXME: lifetimes\n             let llarg = bx.get_param(llarg_idx);\n-            bx.set_value_name(llarg, &name);\n+            bx.set_var_name(llarg, &name);\n             llarg_idx += 1;\n             PlaceRef::new_sized(llarg, arg.layout)\n         } else if arg.is_unsized_indirect() {"}, {"sha": "594f45c833758874caf2d4220bdc9cfe1784f35a", "filename": "src/librustc_codegen_ssa/mir/statement.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_ssa%2Fmir%2Fstatement.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_ssa%2Fmir%2Fstatement.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fstatement.rs?ref=eedf555d0c041caa0a9e7c8cd4394716e637feaf", "patch": "@@ -29,7 +29,21 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                             self.codegen_rvalue_unsized(bx, cg_indirect_dest, rvalue)\n                         }\n                         LocalRef::Operand(None) => {\n-                            let (bx, operand) = self.codegen_rvalue_operand(bx, rvalue);\n+                            let (mut bx, operand) = self.codegen_rvalue_operand(bx, rvalue);\n+                            if let Some(name) = self.mir.local_decls[index].name {\n+                                match operand.val {\n+                                    OperandValue::Ref(x, ..) |\n+                                    OperandValue::Immediate(x) => {\n+                                        bx.set_var_name(x, name);\n+                                    }\n+                                    OperandValue::Pair(a, b) => {\n+                                        // FIXME(eddyb) these are scalar components,\n+                                        // maybe extract the high-level fields?\n+                                        bx.set_var_name(a, format_args!(\"{}.0\", name));\n+                                        bx.set_var_name(b, format_args!(\"{}.1\", name));\n+                                    }\n+                                }\n+                            }\n                             self.locals[index] = LocalRef::Operand(Some(operand));\n                             bx\n                         }"}, {"sha": "9c16b864ef21dce3b48d1c017b16cb8b885848ac", "filename": "src/librustc_codegen_ssa/traits/debuginfo.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_ssa%2Ftraits%2Fdebuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Flibrustc_codegen_ssa%2Ftraits%2Fdebuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Ftraits%2Fdebuginfo.rs?ref=eedf555d0c041caa0a9e7c8cd4394716e637feaf", "patch": "@@ -57,5 +57,5 @@ pub trait DebugInfoBuilderMethods<'tcx>: BackendTypes {\n         span: Span,\n     );\n     fn insert_reference_to_gdb_debug_scripts_section_global(&mut self);\n-    fn set_value_name(&mut self, value: Self::Value, name: &str);\n+    fn set_var_name(&mut self, value: Self::Value, name: impl ToString);\n }"}, {"sha": "3140a7c6b6cc2fef663d5ed682c37f43b6c498d2", "filename": "src/test/codegen/var-names.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Ftest%2Fcodegen%2Fvar-names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eedf555d0c041caa0a9e7c8cd4394716e637feaf/src%2Ftest%2Fcodegen%2Fvar-names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fvar-names.rs?ref=eedf555d0c041caa0a9e7c8cd4394716e637feaf", "patch": "@@ -0,0 +1,15 @@\n+// compile-flags: -O -C no-prepopulate-passes\n+\n+#![crate_type = \"lib\"]\n+\n+// CHECK-LABEL: define i32 @test(i32 %a, i32 %b)\n+#[no_mangle]\n+pub fn test(a: u32, b: u32) -> u32 {\n+    let c = a + b;\n+    // CHECK: %c = add i32 %a, %b\n+    let d = c;\n+    let e = d * a;\n+    // CHECK-NEXT: %e = mul i32 %c, %a\n+    e\n+    // CHECK-NEXT: ret i32 %e\n+}"}]}