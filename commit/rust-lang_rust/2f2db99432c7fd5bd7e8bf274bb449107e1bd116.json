{"sha": "2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmMmRiOTk0MzJjN2ZkNWJkN2U4YmYyNzRiYjQ0OTEwN2UxYmQxMTY=", "commit": {"author": {"name": "inquisitivecrystal", "email": "22333129+inquisitivecrystal@users.noreply.github.com", "date": "2021-07-08T07:05:38Z"}, "committer": {"name": "inquisitivecrystal", "email": "22333129+inquisitivecrystal@users.noreply.github.com", "date": "2021-07-18T06:13:59Z"}, "message": "Make `--force-warns` a normal lint level option", "tree": {"sha": "10fc444777af210ebdb37bd12feb738b86dd2a6b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/10fc444777af210ebdb37bd12feb738b86dd2a6b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "html_url": "https://github.com/rust-lang/rust/commit/2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/comments", "author": {"login": "inquisitivecrystal", "id": 22333129, "node_id": "MDQ6VXNlcjIyMzMzMTI5", "avatar_url": "https://avatars.githubusercontent.com/u/22333129?v=4", "gravatar_id": "", "url": "https://api.github.com/users/inquisitivecrystal", "html_url": "https://github.com/inquisitivecrystal", "followers_url": "https://api.github.com/users/inquisitivecrystal/followers", "following_url": "https://api.github.com/users/inquisitivecrystal/following{/other_user}", "gists_url": "https://api.github.com/users/inquisitivecrystal/gists{/gist_id}", "starred_url": "https://api.github.com/users/inquisitivecrystal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/inquisitivecrystal/subscriptions", "organizations_url": "https://api.github.com/users/inquisitivecrystal/orgs", "repos_url": "https://api.github.com/users/inquisitivecrystal/repos", "events_url": "https://api.github.com/users/inquisitivecrystal/events{/privacy}", "received_events_url": "https://api.github.com/users/inquisitivecrystal/received_events", "type": "User", "site_admin": false}, "committer": {"login": "inquisitivecrystal", "id": 22333129, "node_id": "MDQ6VXNlcjIyMzMzMTI5", "avatar_url": "https://avatars.githubusercontent.com/u/22333129?v=4", "gravatar_id": "", "url": "https://api.github.com/users/inquisitivecrystal", "html_url": "https://github.com/inquisitivecrystal", "followers_url": "https://api.github.com/users/inquisitivecrystal/followers", "following_url": "https://api.github.com/users/inquisitivecrystal/following{/other_user}", "gists_url": "https://api.github.com/users/inquisitivecrystal/gists{/gist_id}", "starred_url": "https://api.github.com/users/inquisitivecrystal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/inquisitivecrystal/subscriptions", "organizations_url": "https://api.github.com/users/inquisitivecrystal/orgs", "repos_url": "https://api.github.com/users/inquisitivecrystal/repos", "events_url": "https://api.github.com/users/inquisitivecrystal/events{/privacy}", "received_events_url": "https://api.github.com/users/inquisitivecrystal/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77d155973c6c22a0e1af49a4a9bac024f697851d", "url": "https://api.github.com/repos/rust-lang/rust/commits/77d155973c6c22a0e1af49a4a9bac024f697851d", "html_url": "https://github.com/rust-lang/rust/commit/77d155973c6c22a0e1af49a4a9bac024f697851d"}], "stats": {"total": 66, "additions": 19, "deletions": 47}, "files": [{"sha": "069fa41fa886ab175b09186fbbabe2a70e3e401d", "filename": "compiler/rustc_lint/src/levels.rs", "status": "modified", "additions": 5, "deletions": 19, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flevels.rs?ref=2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "patch": "@@ -26,8 +26,6 @@ use rustc_span::symbol::{sym, Symbol};\n use rustc_span::{source_map::MultiSpan, Span, DUMMY_SP};\n use tracing::debug;\n \n-use std::cmp;\n-\n fn lint_levels(tcx: TyCtxt<'_>, (): ()) -> LintLevelMap {\n     let store = unerased_lint_store(tcx);\n     let crate_attrs = tcx.hir().attrs(CRATE_HIR_ID);\n@@ -91,36 +89,24 @@ impl<'s> LintLevelsBuilder<'s> {\n         for &(ref lint_name, level) in &sess.opts.lint_opts {\n             store.check_lint_name_cmdline(sess, &lint_name, level, self.crate_attrs);\n             let orig_level = level;\n-\n-            // If the cap is less than this specified level, e.g., if we've got\n-            // `--cap-lints allow` but we've also got `-D foo` then we ignore\n-            // this specification as the lint cap will set it to allow anyway.\n-            let level = cmp::min(level, self.sets.lint_cap);\n-\n             let lint_flag_val = Symbol::intern(lint_name);\n \n             let ids = match store.find_lints(&lint_name) {\n                 Ok(ids) => ids,\n                 Err(_) => continue, // errors handled in check_lint_name_cmdline above\n             };\n             for id in ids {\n+                // ForceWarn and Forbid cannot be overriden\n+                if let Some((Level::ForceWarn | Level::Forbid, _)) = specs.get(&id) {\n+                    continue;\n+                }\n+\n                 self.check_gated_lint(id, DUMMY_SP);\n                 let src = LintLevelSource::CommandLine(lint_flag_val, orig_level);\n                 specs.insert(id, (level, src));\n             }\n         }\n \n-        for lint_name in &sess.opts.force_warns {\n-            store.check_lint_name_cmdline(sess, lint_name, Level::ForceWarn, self.crate_attrs);\n-            let lints = store\n-                .find_lints(lint_name)\n-                .unwrap_or_else(|_| bug!(\"A valid lint failed to produce a lint ids\"));\n-            for id in lints {\n-                let src = LintLevelSource::CommandLine(Symbol::intern(lint_name), Level::ForceWarn);\n-                specs.insert(id, (Level::ForceWarn, src));\n-            }\n-        }\n-\n         self.cur = self.sets.list.push(LintSet { specs, parent: COMMAND_LINE });\n     }\n "}, {"sha": "9e5a38b8dc0b1e8c934ec62d476bb3f1cf321bcc", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 13, "deletions": 26, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "patch": "@@ -677,7 +677,6 @@ impl Default for Options {\n             optimize: OptLevel::No,\n             debuginfo: DebugInfo::None,\n             lint_opts: Vec::new(),\n-            force_warns: Vec::new(),\n             lint_cap: None,\n             describe_lints: false,\n             output_types: OutputTypes(BTreeMap::new()),\n@@ -1172,20 +1171,20 @@ pub fn get_cmd_lint_options(\n     matches: &getopts::Matches,\n     error_format: ErrorOutputType,\n     debugging_opts: &DebuggingOptions,\n-) -> (Vec<(String, lint::Level)>, bool, Option<lint::Level>, Vec<String>) {\n+) -> (Vec<(String, lint::Level)>, bool, Option<lint::Level>) {\n     let mut lint_opts_with_position = vec![];\n     let mut describe_lints = false;\n \n-    for level in [lint::Allow, lint::Warn, lint::Deny, lint::Forbid] {\n-        for (passed_arg_pos, lint_name) in matches.opt_strs_pos(level.as_str()) {\n-            let arg_pos = if let lint::Forbid = level {\n-                // HACK: forbid is always specified last, so it can't be overridden.\n-                // FIXME: remove this once <https://github.com/rust-lang/rust/issues/70819> is\n-                // fixed and `forbid` works as expected.\n-                usize::MAX\n-            } else {\n-                passed_arg_pos\n-            };\n+    if !debugging_opts.unstable_options && matches.opt_present(\"force-warns\") {\n+        early_error(\n+            error_format,\n+            \"the `-Z unstable-options` flag must also be passed to enable \\\n+            the flag `--force-warns=lints`\",\n+        );\n+    }\n+\n+    for level in [lint::Allow, lint::Warn, lint::ForceWarn, lint::Deny, lint::Forbid] {\n+        for (arg_pos, lint_name) in matches.opt_strs_pos(level.as_str()) {\n             if lint_name == \"help\" {\n                 describe_lints = true;\n             } else {\n@@ -1206,18 +1205,7 @@ pub fn get_cmd_lint_options(\n             .unwrap_or_else(|| early_error(error_format, &format!(\"unknown lint level: `{}`\", cap)))\n     });\n \n-    if !debugging_opts.unstable_options && matches.opt_present(\"force-warns\") {\n-        early_error(\n-            error_format,\n-            \"the `-Z unstable-options` flag must also be passed to enable \\\n-            the flag `--force-warns=lints`\",\n-        );\n-    }\n-\n-    let force_warns =\n-        matches.opt_strs(\"force-warns\").into_iter().map(|name| name.replace('-', \"_\")).collect();\n-\n-    (lint_opts, describe_lints, lint_cap, force_warns)\n+    (lint_opts, describe_lints, lint_cap)\n }\n \n /// Parses the `--color` flag.\n@@ -1955,7 +1943,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         .unwrap_or_else(|e| early_error(error_format, &e[..]));\n \n     let mut debugging_opts = DebuggingOptions::build(matches, error_format);\n-    let (lint_opts, describe_lints, lint_cap, force_warns) =\n+    let (lint_opts, describe_lints, lint_cap) =\n         get_cmd_lint_options(matches, error_format, &debugging_opts);\n \n     check_debug_option_stability(&debugging_opts, error_format, json_rendered);\n@@ -2129,7 +2117,6 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         optimize: opt_level,\n         debuginfo,\n         lint_opts,\n-        force_warns,\n         lint_cap,\n         describe_lints,\n         output_types,"}, {"sha": "d7b9c91173754da37c8ff18aa48c73de0b1ff708", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "patch": "@@ -135,7 +135,6 @@ top_level_options!(\n         debuginfo: DebugInfo [TRACKED],\n         lint_opts: Vec<(String, lint::Level)> [TRACKED_NO_CRATE_HASH],\n         lint_cap: Option<lint::Level> [TRACKED_NO_CRATE_HASH],\n-        force_warns: Vec<String> [TRACKED_NO_CRATE_HASH],\n         describe_lints: bool [UNTRACKED],\n         output_types: OutputTypes [TRACKED],\n         search_paths: Vec<SearchPath> [UNTRACKED],"}, {"sha": "d601d948555fb4e89101db2af815f29115916563", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f2db99432c7fd5bd7e8bf274bb449107e1bd116/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=2f2db99432c7fd5bd7e8bf274bb449107e1bd116", "patch": "@@ -628,7 +628,7 @@ impl Options {\n         let generate_redirect_map = matches.opt_present(\"generate-redirect-map\");\n         let show_type_layout = matches.opt_present(\"show-type-layout\");\n \n-        let (lint_opts, describe_lints, lint_cap, _) =\n+        let (lint_opts, describe_lints, lint_cap) =\n             get_cmd_lint_options(matches, error_format, &debugging_opts);\n \n         Ok(Options {"}]}