{"sha": "4e136d1fd9bd5536d441c062d41e7b71b375a942", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlMTM2ZDFmZDliZDU1MzZkNDQxYzA2MmQ0MWU3YjcxYjM3NWE5NDI=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-08-26T19:22:33Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-08-26T20:20:23Z"}, "message": "Add rustc::middle::cstrcache for getting c string bufs safely\n\nWe continue to leak string buffers in trans so this creates a way to get c\nstring buffers from strings while guaranteeing that they are not freed before\nuse.\n\nHopefully this can be made efficient in the istr regime.", "tree": {"sha": "004b199b79917efabbb804050bd60acc8c8686e8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/004b199b79917efabbb804050bd60acc8c8686e8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e136d1fd9bd5536d441c062d41e7b71b375a942", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e136d1fd9bd5536d441c062d41e7b71b375a942", "html_url": "https://github.com/rust-lang/rust/commit/4e136d1fd9bd5536d441c062d41e7b71b375a942", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e136d1fd9bd5536d441c062d41e7b71b375a942/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3aef2c1d7db86ff842796e9ea93acf8c09aac44c", "url": "https://api.github.com/repos/rust-lang/rust/commits/3aef2c1d7db86ff842796e9ea93acf8c09aac44c", "html_url": "https://github.com/rust-lang/rust/commit/3aef2c1d7db86ff842796e9ea93acf8c09aac44c"}], "stats": {"total": 30, "additions": 30, "deletions": 0}, "files": [{"sha": "0b0cd320578eaafa0b8b7a4c8fac5f360757e3c8", "filename": "src/comp/middle/cstrcache.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/4e136d1fd9bd5536d441c062d41e7b71b375a942/src%2Fcomp%2Fmiddle%2Fcstrcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e136d1fd9bd5536d441c062d41e7b71b375a942/src%2Fcomp%2Fmiddle%2Fcstrcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Fcstrcache.rs?ref=4e136d1fd9bd5536d441c062d41e7b71b375a942", "patch": "@@ -0,0 +1,29 @@\n+// Provides a safe way to get C pointers to strings, because in many\n+// places LLVM wants a string but doesn't take a copy.\n+\n+import std::str;\n+\n+export t;\n+export mk;\n+export get_cstr;\n+\n+type t_ = @{\n+    // This string is boxed so that I remember that it has to be boxed\n+    // after the ivec conversion.\n+    mutable cache: [@str]\n+};\n+\n+tag t {\n+    private(t_);\n+}\n+\n+fn mk() -> t {\n+    ret private(@{mutable cache: []});\n+}\n+\n+fn get_cstr(t: &t, s: &str) -> str::rustrt::sbuf {\n+    let boxed = @s;\n+    let buf = str::buf(*boxed);\n+    (*t).cache += [boxed];\n+    ret buf;\n+}\n\\ No newline at end of file"}, {"sha": "0dd9f004ad8f2352f247bb922404cd31d3929d26", "filename": "src/comp/rustc.rc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e136d1fd9bd5536d441c062d41e7b71b375a942/src%2Fcomp%2Frustc.rc", "raw_url": "https://github.com/rust-lang/rust/raw/4e136d1fd9bd5536d441c062d41e7b71b375a942/src%2Fcomp%2Frustc.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Frustc.rc?ref=4e136d1fd9bd5536d441c062d41e7b71b375a942", "patch": "@@ -30,6 +30,7 @@ mod middle {\n     mod freevars;\n     mod shape;\n     mod gc;\n+    mod cstrcache;\n \n     mod tstate {\n         mod ck;"}]}