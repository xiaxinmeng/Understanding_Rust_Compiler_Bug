{"sha": "74de78a414043202ed70c239b2aca74dceb4c1a8", "node_id": "C_kwDOAAsO6NoAKDc0ZGU3OGE0MTQwNDMyMDJlZDcwYzIzOWIyYWNhNzRkY2ViNGMxYTg", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-11-26T16:52:58Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-11-26T17:19:22Z"}, "message": "rustdoc: improve popover focus handling JS\n\nThis commit fixes a few inconsistencies and erratic behavior from the\nnotable traits, settings, and sidebar popups:\n\n* It makes it so that pressing Escape closes the mobile sidebar.\n  This is a bit difficult to do on iPhone, but on other setups like\n  desktop tiling window managers, it's easy and makes sense.\n* It makes sure that pressing escape while a notable trait popover is\n  open focuses the popover's toggle button, instead of leaving nothing\n  focused, since that makes more sense with keyboard navigation. Clicking\n  the settings, help, or sidebar buttons, however, will not focus the\n  notable trait popover toggle button.\n* It ensures that notable trait and settings popovers are exclusive\n  with the mobile sidebar. Nothing should ever overlap a popover, and\n  there should never be more than one popover open at once.", "tree": {"sha": "b1ba3cb1418e87942da3bd8cd658c17c9c8a9692", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1ba3cb1418e87942da3bd8cd658c17c9c8a9692"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74de78a414043202ed70c239b2aca74dceb4c1a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74de78a414043202ed70c239b2aca74dceb4c1a8", "html_url": "https://github.com/rust-lang/rust/commit/74de78a414043202ed70c239b2aca74dceb4c1a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74de78a414043202ed70c239b2aca74dceb4c1a8/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "579c993b35a02dc439b74bba18b0a14f77911c95", "url": "https://api.github.com/repos/rust-lang/rust/commits/579c993b35a02dc439b74bba18b0a14f77911c95", "html_url": "https://github.com/rust-lang/rust/commit/579c993b35a02dc439b74bba18b0a14f77911c95"}], "stats": {"total": 78, "additions": 73, "deletions": 5}, "files": [{"sha": "ef1ae68c59eb159530329cf4da005b6d9022cd4c", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=74de78a414043202ed70c239b2aca74dceb4c1a8", "patch": "@@ -202,6 +202,7 @@ function loadCss(cssUrl) {\n         if (event.ctrlKey || event.altKey || event.metaKey) {\n             return;\n         }\n+        window.hideAllModals();\n         addClass(getSettingsButton(), \"rotate\");\n         event.preventDefault();\n         // Sending request for the CSS and the JS files at the same time so it will\n@@ -377,7 +378,10 @@ function loadCss(cssUrl) {\n         }\n         ev.preventDefault();\n         searchState.defocus();\n-        window.hidePopoverMenus();\n+        // If the notable traits popover is open, and the user presses Escape,\n+        // reset focus back to the link.\n+        hideNotable(true);\n+        window.hideAllModals();\n     }\n \n     function handleShortcut(ev) {\n@@ -767,6 +771,7 @@ function loadCss(cssUrl) {\n     };\n \n     function showSidebar() {\n+        window.hideAllModals();\n         window.rustdocMobileScrollLock();\n         const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n         addClass(sidebar, \"shown\");\n@@ -843,7 +848,7 @@ function loadCss(cssUrl) {\n             // Make this function idempotent.\n             return;\n         }\n-        hideNotable(false);\n+        window.hideAllModals();\n         const ty = e.getAttribute(\"data-ty\");\n         const wrapper = document.createElement(\"div\");\n         wrapper.innerHTML = \"<div class=\\\"docblock\\\">\" + window.NOTABLE_TRAITS[ty] + \"</div>\";\n@@ -1049,14 +1054,25 @@ function loadCss(cssUrl) {\n         return container;\n     }\n \n+    /**\n+     * Hide popover menus, notable trait tooltips, and the sidebar (if applicable).\n+     *\n+     * This version does not do anything to tweak the focused element. The caller\n+     * should make sure it behaves reasonably.\n+     */\n+    window.hideAllModals = function() {\n+        hideSidebar();\n+        window.hidePopoverMenus();\n+        hideNotable(false);\n+    };\n+\n     /**\n      * Hide all the popover menus.\n      */\n     window.hidePopoverMenus = function() {\n         onEachLazy(document.querySelectorAll(\".search-form .popover\"), elem => {\n             elem.style.display = \"none\";\n         });\n-        hideNotable(false);\n     };\n \n     /**\n@@ -1081,7 +1097,7 @@ function loadCss(cssUrl) {\n     function showHelp() {\n         const menu = getHelpMenu(true);\n         if (menu.style.display === \"none\") {\n-            window.hidePopoverMenus();\n+            window.hideAllModals();\n             menu.style.display = \"\";\n         }\n     }"}, {"sha": "589bfc79360ce17f1bdf2d8bcb9c2026b2339e28", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=74de78a414043202ed70c239b2aca74dceb4c1a8", "patch": "@@ -268,7 +268,7 @@\n             event.preventDefault();\n             const shouldDisplaySettings = settingsMenu.style.display === \"none\";\n \n-            window.hidePopoverMenus();\n+            window.hideAllModals();\n             if (shouldDisplaySettings) {\n                 displaySettings();\n             }"}, {"sha": "7e24af47ee8176462e051333c7b2b868bb75e9da", "filename": "src/test/rustdoc-gui/notable-trait.goml", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Ftest%2Frustdoc-gui%2Fnotable-trait.goml", "raw_url": "https://github.com/rust-lang/rust/raw/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Ftest%2Frustdoc-gui%2Fnotable-trait.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fnotable-trait.goml?ref=74de78a414043202ed70c239b2aca74dceb4c1a8", "patch": "@@ -200,12 +200,14 @@ move-cursor-to: \"//*[@class='notable popover']\"\n assert-count: (\"//*[@class='notable popover']\", 1)\n press-key: \"Escape\"\n assert-count: (\"//*[@class='notable popover']\", 0)\n+assert: \"#method\\.create_an_iterator_from_read .notable-traits:focus\"\n \n // Check that clicking outside works.\n click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n assert-count: (\"//*[@class='notable popover']\", 1)\n click: \".search-input\"\n assert-count: (\"//*[@class='notable popover']\", 0)\n+assert-false: \"#method\\.create_an_iterator_from_read .notable-traits:focus\"\n \n // Check that pressing tab over and over works.\n click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n@@ -249,3 +251,26 @@ click: \"#settings-menu a\"\n press-key: \"Escape\"\n // We ensure we didn't come back to the previous focused item.\n assert-window-property-false: {\"scrollY\": |scroll|}\n+\n+// Opening the mobile sidebar should close the popover.\n+size: (650, 600)\n+click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n+assert-count: (\"//*[@class='notable popover']\", 1)\n+click: \".sidebar-menu-toggle\"\n+assert: \"//*[@class='sidebar shown']\"\n+assert-count: (\"//*[@class='notable popover']\", 0)\n+assert-false: \"#method\\.create_an_iterator_from_read .notable-traits:focus\"\n+// Clicking a notable popover should close the sidebar.\n+click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n+assert-count: (\"//*[@class='notable popover']\", 1)\n+assert-false: \"//*[@class='sidebar shown']\"\n+\n+// Also check the focus handling for the help button.\n+size: (1100, 600)\n+reload:\n+assert-count: (\"//*[@class='notable popover']\", 0)\n+click: \"//*[@id='method.create_an_iterator_from_read']//*[@class='notable-traits']\"\n+assert-count: (\"//*[@class='notable popover']\", 1)\n+click: \"#help-button a\"\n+assert-count: (\"//*[@class='notable popover']\", 0)\n+assert-false: \"#method\\.create_an_iterator_from_read .notable-traits:focus\""}, {"sha": "c3649dc7bda20211ce124c53231a93821224ac96", "filename": "src/test/rustdoc-gui/pocket-menu.goml", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml", "raw_url": "https://github.com/rust-lang/rust/raw/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml?ref=74de78a414043202ed70c239b2aca74dceb4c1a8", "patch": "@@ -75,3 +75,24 @@ assert-css: (\n )\n compare-elements-css: (\"#help-button .popover\", \"#help-button .top\", [\"border-color\"])\n compare-elements-css: (\"#help-button .popover\", \"#help-button .bottom\", [\"border-color\"])\n+\n+// Opening the mobile sidebar should close the settings popover.\n+size: (650, 600)\n+click: \"#settings-menu a\"\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"block\"})\n+click: \".sidebar-menu-toggle\"\n+assert: \"//*[@class='sidebar shown']\"\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"none\"})\n+// Opening the settings popover should close the sidebar.\n+click: \"#settings-menu a\"\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"block\"})\n+assert-false: \"//*[@class='sidebar shown']\"\n+\n+// Opening the settings popover at start (which async loads stuff) should also close.\n+reload:\n+click: \".sidebar-menu-toggle\"\n+assert: \"//*[@class='sidebar shown']\"\n+assert-false: \"#settings-menu .popover\"\n+click: \"#settings-menu a\"\n+assert-false: \"//*[@class='sidebar shown']\"\n+wait-for: \"#settings-menu .popover\""}, {"sha": "840091799a7787f498ede523af7ae0a8d0c9b227", "filename": "src/test/rustdoc-gui/sidebar-mobile.goml", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile.goml", "raw_url": "https://github.com/rust-lang/rust/raw/74de78a414043202ed70c239b2aca74dceb4c1a8/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile.goml?ref=74de78a414043202ed70c239b2aca74dceb4c1a8", "patch": "@@ -32,6 +32,12 @@ assert-css: (\"//nav[contains(@class, 'sidebar')]//h2/a[text()='In test_docs']/pa\n click: \"body\"\n assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n \n+// Open the sidebar menu, and make sure pressing Escape closes it.\n+click: \".sidebar-menu-toggle\"\n+assert-css: (\".sidebar\", {\"left\": \"0px\"})\n+press-key: \"Escape\"\n+assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n+\n // Check that the topbar is visible\n assert-property: (\".mobile-topbar\", {\"clientHeight\": \"45\"})\n "}]}