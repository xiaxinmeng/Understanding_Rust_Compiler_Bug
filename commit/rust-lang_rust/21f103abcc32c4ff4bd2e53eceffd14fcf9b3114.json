{"sha": "21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "node_id": "C_kwDOAAsO6NoAKDIxZjEwM2FiY2MzMmM0ZmY0YmQyZTUzZWNlZmZkMTRmY2Y5YjMxMTQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-26T12:05:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-26T12:05:57Z"}, "message": "Auto merge of #9379 - royrustdev:multi_assignments, r=llogiq\n\nnew lint\n\nThis fixes #6576\n\nIf you added a new lint, here's a checklist for things that will be\nchecked during review or continuous integration.\n\n- \\[x] Followed [lint naming conventions][lint_naming]\n- \\[x] Added passing UI tests (including committed `.stderr` file)\n- \\[x] `cargo test` passes locally\n- \\[x] Executed `cargo dev update_lints`\n- \\[x] Added lint documentation\n- \\[x] Run `cargo dev fmt`\n\n---\n\nchangelog: add [`multi_assignments`] lint", "tree": {"sha": "3b700f15cea758f8a5f80c45a84c3d04fb49db3e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b700f15cea758f8a5f80c45a84c3d04fb49db3e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "html_url": "https://github.com/rust-lang/rust/commit/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "79a439a48afbb96f764d0decdda77bb3f87902c3", "url": "https://api.github.com/repos/rust-lang/rust/commits/79a439a48afbb96f764d0decdda77bb3f87902c3", "html_url": "https://github.com/rust-lang/rust/commit/79a439a48afbb96f764d0decdda77bb3f87902c3"}, {"sha": "fb7dffeac9df2f15c70c84c5defa5918af63b6af", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb7dffeac9df2f15c70c84c5defa5918af63b6af", "html_url": "https://github.com/rust-lang/rust/commit/fb7dffeac9df2f15c70c84c5defa5918af63b6af"}], "stats": {"total": 120, "additions": 120, "deletions": 0}, "files": [{"sha": "964f339b26ce3d66af8853a84199bc6cd7e055d6", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -3897,6 +3897,7 @@ Released 2018-09-13\n [`module_name_repetitions`]: https://rust-lang.github.io/rust-clippy/master/index.html#module_name_repetitions\n [`modulo_arithmetic`]: https://rust-lang.github.io/rust-clippy/master/index.html#modulo_arithmetic\n [`modulo_one`]: https://rust-lang.github.io/rust-clippy/master/index.html#modulo_one\n+[`multi_assignments`]: https://rust-lang.github.io/rust-clippy/master/index.html#multi_assignments\n [`multiple_crate_versions`]: https://rust-lang.github.io/rust-clippy/master/index.html#multiple_crate_versions\n [`multiple_inherent_impl`]: https://rust-lang.github.io/rust-clippy/master/index.html#multiple_inherent_impl\n [`must_use_candidate`]: https://rust-lang.github.io/rust-clippy/master/index.html#must_use_candidate"}, {"sha": "61bb5d1337c3e22788a32081b27626876c8dd5e4", "filename": "clippy_lints/src/lib.register_all.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.register_all.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.register_all.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_all.rs?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -232,6 +232,7 @@ store.register_group(true, \"clippy::all\", Some(\"clippy_all\"), vec![\n     LintId::of(misc_early::UNNEEDED_WILDCARD_PATTERN),\n     LintId::of(misc_early::ZERO_PREFIXED_LITERAL),\n     LintId::of(mixed_read_write_in_expression::DIVERGING_SUB_EXPRESSION),\n+    LintId::of(multi_assignments::MULTI_ASSIGNMENTS),\n     LintId::of(mut_key::MUTABLE_KEY_TYPE),\n     LintId::of(mut_reference::UNNECESSARY_MUT_PASSED),\n     LintId::of(needless_arbitrary_self_type::NEEDLESS_ARBITRARY_SELF_TYPE),"}, {"sha": "0ec2884cb6baab6f67aae78d01a32dbe152ecd1a", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -398,6 +398,7 @@ store.register_lints(&[\n     mixed_read_write_in_expression::MIXED_READ_WRITE_IN_EXPRESSION,\n     module_style::MOD_MODULE_FILES,\n     module_style::SELF_NAMED_MODULE_FILES,\n+    multi_assignments::MULTI_ASSIGNMENTS,\n     mut_key::MUTABLE_KEY_TYPE,\n     mut_mut::MUT_MUT,\n     mut_reference::UNNECESSARY_MUT_PASSED,"}, {"sha": "6f480c52cc9429a8a19533a4fcda2c476884e1f0", "filename": "clippy_lints/src/lib.register_suspicious.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_suspicious.rs?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -24,6 +24,7 @@ store.register_group(true, \"clippy::suspicious\", Some(\"clippy_suspicious\"), vec!\n     LintId::of(loops::MUT_RANGE_BOUND),\n     LintId::of(methods::NO_EFFECT_REPLACE),\n     LintId::of(methods::SUSPICIOUS_MAP),\n+    LintId::of(multi_assignments::MULTI_ASSIGNMENTS),\n     LintId::of(mut_key::MUTABLE_KEY_TYPE),\n     LintId::of(octal_escapes::OCTAL_ESCAPES),\n     LintId::of(operators::FLOAT_EQUALITY_WITHOUT_ABS),"}, {"sha": "05d4dbd685991e3f4cba42afca5324db30580fe6", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -289,6 +289,7 @@ mod missing_enforced_import_rename;\n mod missing_inline;\n mod mixed_read_write_in_expression;\n mod module_style;\n+mod multi_assignments;\n mod mut_key;\n mod mut_mut;\n mod mut_reference;\n@@ -896,6 +897,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(partialeq_to_none::PartialeqToNone));\n     store.register_late_pass(|| Box::new(manual_string_new::ManualStringNew));\n     store.register_late_pass(|| Box::new(unused_peekable::UnusedPeekable));\n+    store.register_early_pass(|| Box::new(multi_assignments::MultiAssignments));\n     // add lints here, do not remove this comment, it's used in `new_lint`\n }\n "}, {"sha": "81eb1a085aea9163eca1c0029766d95f99d9d280", "filename": "clippy_lints/src/multi_assignments.rs", "status": "added", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Fmulti_assignments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/clippy_lints%2Fsrc%2Fmulti_assignments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmulti_assignments.rs?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -0,0 +1,65 @@\n+use clippy_utils::diagnostics::span_lint;\n+use rustc_ast::ast::{Expr, ExprKind, Stmt, StmtKind};\n+use rustc_lint::{EarlyContext, EarlyLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for nested assignments.\n+    ///\n+    /// ### Why is this bad?\n+    /// While this is in most cases already a type mismatch,\n+    /// the result of an assignment being `()` can throw off people coming from languages like python or C,\n+    /// where such assignments return a copy of the assigned value.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    ///# let (a, b);\n+    /// a = b = 42;\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    ///# let (a, b);\n+    /// b = 42;\n+    /// a = b;\n+    /// ```\n+    #[clippy::version = \"1.65.0\"]\n+    pub MULTI_ASSIGNMENTS,\n+    suspicious,\n+    \"instead of using `a = b = c;` use `a = c; b = c;`\"\n+}\n+\n+declare_lint_pass!(MultiAssignments => [MULTI_ASSIGNMENTS]);\n+\n+fn strip_paren_blocks(expr: &Expr) -> &Expr {\n+    match &expr.kind {\n+        ExprKind::Paren(e) => strip_paren_blocks(e),\n+        ExprKind::Block(b, _) => {\n+            if let [\n+                Stmt {\n+                    kind: StmtKind::Expr(e),\n+                    ..\n+                },\n+            ] = &b.stmts[..]\n+            {\n+                strip_paren_blocks(e)\n+            } else {\n+                expr\n+            }\n+        },\n+        _ => expr,\n+    }\n+}\n+\n+impl EarlyLintPass for MultiAssignments {\n+    fn check_expr(&mut self, cx: &EarlyContext<'_>, expr: &Expr) {\n+        if let ExprKind::Assign(target, source, _) = &expr.kind {\n+            if let ExprKind::Assign(_target, _source, _) = &strip_paren_blocks(target).kind {\n+                span_lint(cx, MULTI_ASSIGNMENTS, expr.span, \"assignments don't nest intuitively\");\n+            };\n+            if let ExprKind::Assign(_target, _source, _) = &strip_paren_blocks(source).kind {\n+                span_lint(cx, MULTI_ASSIGNMENTS, expr.span, \"assignments don't nest intuitively\");\n+            }\n+        };\n+    }\n+}"}, {"sha": "b186bf8bbdb424874495f06e80a9a1ddd6cedef3", "filename": "tests/ui/multi_assignments.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/tests%2Fui%2Fmulti_assignments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/tests%2Fui%2Fmulti_assignments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmulti_assignments.rs?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -0,0 +1,9 @@\n+#![warn(clippy::multi_assignments)]\n+fn main() {\n+    let (mut a, mut b, mut c, mut d) = ((), (), (), ());\n+    a = b = c;\n+    a = b = c = d;\n+    a = b = { c };\n+    a = { b = c };\n+    a = (b = c);\n+}"}, {"sha": "d6c42bb698cf97f34c5c02e30f9fd9e456bf6551", "filename": "tests/ui/multi_assignments.stderr", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/tests%2Fui%2Fmulti_assignments.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/21f103abcc32c4ff4bd2e53eceffd14fcf9b3114/tests%2Fui%2Fmulti_assignments.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmulti_assignments.stderr?ref=21f103abcc32c4ff4bd2e53eceffd14fcf9b3114", "patch": "@@ -0,0 +1,40 @@\n+error: assignments don't nest intuitively\n+  --> $DIR/multi_assignments.rs:4:5\n+   |\n+LL |     a = b = c;\n+   |     ^^^^^^^^^\n+   |\n+   = note: `-D clippy::multi-assignments` implied by `-D warnings`\n+\n+error: assignments don't nest intuitively\n+  --> $DIR/multi_assignments.rs:5:5\n+   |\n+LL |     a = b = c = d;\n+   |     ^^^^^^^^^^^^^\n+\n+error: assignments don't nest intuitively\n+  --> $DIR/multi_assignments.rs:5:9\n+   |\n+LL |     a = b = c = d;\n+   |         ^^^^^^^^^\n+\n+error: assignments don't nest intuitively\n+  --> $DIR/multi_assignments.rs:6:5\n+   |\n+LL |     a = b = { c };\n+   |     ^^^^^^^^^^^^^\n+\n+error: assignments don't nest intuitively\n+  --> $DIR/multi_assignments.rs:7:5\n+   |\n+LL |     a = { b = c };\n+   |     ^^^^^^^^^^^^^\n+\n+error: assignments don't nest intuitively\n+  --> $DIR/multi_assignments.rs:8:5\n+   |\n+LL |     a = (b = c);\n+   |     ^^^^^^^^^^^\n+\n+error: aborting due to 6 previous errors\n+"}]}