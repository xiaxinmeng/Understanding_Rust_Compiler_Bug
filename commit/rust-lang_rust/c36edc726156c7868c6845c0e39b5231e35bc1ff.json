{"sha": "c36edc726156c7868c6845c0e39b5231e35bc1ff", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzNmVkYzcyNjE1NmM3ODY4YzY4NDVjMGUzOWI1MjMxZTM1YmMxZmY=", "commit": {"author": {"name": "Ulrik Sverdrup", "email": "bluss@users.noreply.github.com", "date": "2016-11-13T00:09:27Z"}, "committer": {"name": "Ulrik Sverdrup", "email": "bluss@users.noreply.github.com", "date": "2016-11-13T00:30:42Z"}, "message": "vec: Use less code bloat specialized Vec::from_iter\n\nVec::from_iter's general case allocates the vector up front;\nthis is redundant for the TrustedLen case, and can then be avoided\nto reduce the size of the code.", "tree": {"sha": "9adb88f4b0f0bc06c5f88a6ddd9b9fac41b47f50", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9adb88f4b0f0bc06c5f88a6ddd9b9fac41b47f50"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c36edc726156c7868c6845c0e39b5231e35bc1ff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c36edc726156c7868c6845c0e39b5231e35bc1ff", "html_url": "https://github.com/rust-lang/rust/commit/c36edc726156c7868c6845c0e39b5231e35bc1ff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c36edc726156c7868c6845c0e39b5231e35bc1ff/comments", "author": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b3a37bd2e35458b4d66f13c4d3ad924455ac2bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b3a37bd2e35458b4d66f13c4d3ad924455ac2bb", "html_url": "https://github.com/rust-lang/rust/commit/2b3a37bd2e35458b4d66f13c4d3ad924455ac2bb"}], "stats": {"total": 51, "additions": 31, "deletions": 20}, "files": [{"sha": "24f8e3a2d918144a8cbda94dccfb1545ef292a95", "filename": "src/libcollections/vec.rs", "status": "modified", "additions": 31, "deletions": 20, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/c36edc726156c7868c6845c0e39b5231e35bc1ff/src%2Flibcollections%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c36edc726156c7868c6845c0e39b5231e35bc1ff/src%2Flibcollections%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fvec.rs?ref=c36edc726156c7868c6845c0e39b5231e35bc1ff", "patch": "@@ -1499,26 +1499,7 @@ impl<T> ops::DerefMut for Vec<T> {\n impl<T> FromIterator<T> for Vec<T> {\n     #[inline]\n     fn from_iter<I: IntoIterator<Item = T>>(iter: I) -> Vec<T> {\n-        // Unroll the first iteration, as the vector is going to be\n-        // expanded on this iteration in every case when the iterable is not\n-        // empty, but the loop in extend_desugared() is not going to see the\n-        // vector being full in the few subsequent loop iterations.\n-        // So we get better branch prediction.\n-        let mut iterator = iter.into_iter();\n-        let mut vector = match iterator.next() {\n-            None => return Vec::new(),\n-            Some(element) => {\n-                let (lower, _) = iterator.size_hint();\n-                let mut vector = Vec::with_capacity(lower.saturating_add(1));\n-                unsafe {\n-                    ptr::write(vector.get_unchecked_mut(0), element);\n-                    vector.set_len(1);\n-                }\n-                vector\n-            }\n-        };\n-        vector.extend(iterator);\n-        vector\n+        <Self as SpecExtend<_>>::from_iter(iter.into_iter())\n     }\n }\n \n@@ -1590,13 +1571,37 @@ impl<T> Extend<T> for Vec<T> {\n     }\n }\n \n+// Specialization trait used for Vec::from_iter and Vec::extend\n trait SpecExtend<I> {\n+    fn from_iter(iter: I) -> Self;\n     fn spec_extend(&mut self, iter: I);\n }\n \n impl<I, T> SpecExtend<I> for Vec<T>\n     where I: Iterator<Item=T>,\n {\n+    default fn from_iter(mut iterator: I) -> Self {\n+        // Unroll the first iteration, as the vector is going to be\n+        // expanded on this iteration in every case when the iterable is not\n+        // empty, but the loop in extend_desugared() is not going to see the\n+        // vector being full in the few subsequent loop iterations.\n+        // So we get better branch prediction.\n+        let mut vector = match iterator.next() {\n+            None => return Vec::new(),\n+            Some(element) => {\n+                let (lower, _) = iterator.size_hint();\n+                let mut vector = Vec::with_capacity(lower.saturating_add(1));\n+                unsafe {\n+                    ptr::write(vector.get_unchecked_mut(0), element);\n+                    vector.set_len(1);\n+                }\n+                vector\n+            }\n+        };\n+        vector.spec_extend(iterator);\n+        vector\n+    }\n+\n     default fn spec_extend(&mut self, iter: I) {\n         self.extend_desugared(iter)\n     }\n@@ -1605,6 +1610,12 @@ impl<I, T> SpecExtend<I> for Vec<T>\n impl<I, T> SpecExtend<I> for Vec<T>\n     where I: TrustedLen<Item=T>,\n {\n+    fn from_iter(iterator: I) -> Self {\n+        let mut vector = Vec::new();\n+        vector.spec_extend(iterator);\n+        vector\n+    }\n+\n     fn spec_extend(&mut self, iterator: I) {\n         // This is the case for a TrustedLen iterator.\n         let (low, high) = iterator.size_hint();"}]}