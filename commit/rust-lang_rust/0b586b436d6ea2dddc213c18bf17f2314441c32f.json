{"sha": "0b586b436d6ea2dddc213c18bf17f2314441c32f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiNTg2YjQzNmQ2ZWEyZGRkYzIxM2MxOGJmMTdmMjMxNDQ0MWMzMmY=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-09-07T14:03:15Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-09-17T13:30:44Z"}, "message": "Take Diagnostic in Handler::emit_diagnostic", "tree": {"sha": "c3d0d1bc1363af060db603c0c0199b050474ad74", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c3d0d1bc1363af060db603c0c0199b050474ad74"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b586b436d6ea2dddc213c18bf17f2314441c32f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b586b436d6ea2dddc213c18bf17f2314441c32f", "html_url": "https://github.com/rust-lang/rust/commit/0b586b436d6ea2dddc213c18bf17f2314441c32f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b586b436d6ea2dddc213c18bf17f2314441c32f/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cdd805506e7a01d60906f8b153afb697d687609d", "url": "https://api.github.com/repos/rust-lang/rust/commits/cdd805506e7a01d60906f8b153afb697d687609d", "html_url": "https://github.com/rust-lang/rust/commit/cdd805506e7a01d60906f8b153afb697d687609d"}], "stats": {"total": 26, "additions": 10, "deletions": 16}, "files": [{"sha": "5eda3df378126dd3215e6a51baedce568382c27c", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b586b436d6ea2dddc213c18bf17f2314441c32f/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b586b436d6ea2dddc213c18bf17f2314441c32f/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=0b586b436d6ea2dddc213c18bf17f2314441c32f", "patch": "@@ -1855,7 +1855,7 @@ pub fn rustc_optgroups() -> Vec<RustcOptGroup> {\n struct NullEmitter;\n \n impl errors::emitter::Emitter for NullEmitter {\n-    fn emit_diagnostic(&mut self, _: &errors::DiagnosticBuilder<'_>) {}\n+    fn emit_diagnostic(&mut self, _: &errors::Diagnostic) {}\n }\n \n // Converts strings provided as `--cfg [cfgspec]` into a `crate_cfg`."}, {"sha": "25ffb146da7568a4b4b3480b61509b7c9271ccaa", "filename": "src/librustc_errors/diagnostic_builder.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0b586b436d6ea2dddc213c18bf17f2314441c32f/src%2Flibrustc_errors%2Fdiagnostic_builder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b586b436d6ea2dddc213c18bf17f2314441c32f/src%2Flibrustc_errors%2Fdiagnostic_builder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Fdiagnostic_builder.rs?ref=0b586b436d6ea2dddc213c18bf17f2314441c32f", "patch": "@@ -99,17 +99,9 @@ impl<'a> DerefMut for DiagnosticBuilder<'a> {\n }\n \n impl<'a> DiagnosticBuilder<'a> {\n-    pub fn handler(&self) -> &'a Handler{\n-        self.0.handler\n-    }\n-\n     /// Emit the diagnostic.\n     pub fn emit(&mut self) {\n-        if self.cancelled() {\n-            return;\n-        }\n-\n-        self.0.handler.emit_db(&self);\n+        self.0.handler.emit_diagnostic(&self);\n         self.cancel();\n     }\n "}, {"sha": "11e2265cf3618962b95e01f82139be606b2e1f68", "filename": "src/librustc_errors/lib.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0b586b436d6ea2dddc213c18bf17f2314441c32f/src%2Flibrustc_errors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b586b436d6ea2dddc213c18bf17f2314441c32f/src%2Flibrustc_errors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Flib.rs?ref=0b586b436d6ea2dddc213c18bf17f2314441c32f", "patch": "@@ -589,7 +589,7 @@ impl Handler {\n     }\n     fn delay_as_bug(&self, diagnostic: Diagnostic) {\n         if self.flags.report_delayed_bugs {\n-            DiagnosticBuilder::new_diagnostic(self, diagnostic.clone()).emit();\n+            self.emit_diagnostic(&diagnostic);\n         }\n         self.delayed_span_bugs.borrow_mut().push(diagnostic);\n     }\n@@ -747,8 +747,10 @@ impl Handler {\n         db.cancel();\n     }\n \n-    fn emit_db(&self, db: &DiagnosticBuilder<'_>) {\n-        let diagnostic = &**db;\n+    fn emit_diagnostic(&self, diagnostic: &Diagnostic) {\n+        if diagnostic.cancelled() {\n+            return;\n+        }\n \n         TRACK_DIAGNOSTICS.with(|track_diagnostics| {\n             track_diagnostics.get()(diagnostic);\n@@ -768,12 +770,12 @@ impl Handler {\n         // Only emit the diagnostic if we haven't already emitted an equivalent\n         // one:\n         if self.emitted_diagnostics.borrow_mut().insert(diagnostic_hash) {\n-            self.emitter.borrow_mut().emit_diagnostic(db);\n-            if db.is_error() {\n+            self.emitter.borrow_mut().emit_diagnostic(diagnostic);\n+            if diagnostic.is_error() {\n                 self.deduplicated_err_count.fetch_add(1, SeqCst);\n             }\n         }\n-        if db.is_error() {\n+        if diagnostic.is_error() {\n             self.bump_err_count();\n         }\n     }"}]}