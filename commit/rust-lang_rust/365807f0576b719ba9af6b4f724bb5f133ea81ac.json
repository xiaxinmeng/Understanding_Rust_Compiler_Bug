{"sha": "365807f0576b719ba9af6b4f724bb5f133ea81ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2NTgwN2YwNTc2YjcxOWJhOWFmNmI0ZjcyNGJiNWYxMzNlYTgxYWM=", "commit": {"author": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2020-04-17T12:27:35Z"}, "committer": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2020-04-18T17:37:44Z"}, "message": "Make Box<dyn FnOnce> respect self alignment", "tree": {"sha": "68f8083c7fd21b1dee8f6233310e057919c08b14", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/68f8083c7fd21b1dee8f6233310e057919c08b14"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/365807f0576b719ba9af6b4f724bb5f133ea81ac", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF0ntrgrd9qf9uuThgTGiTgx5768FAl6bOukACgkQgTGiTgx5\n768Mbw//XDcBlHbrJiJxEFYO21NTSahUMZk7+s9FA93KJU8LRq31XSUM12pdaJwh\nJHOutqZ2jaiQJq/FeE+EclP6qn89dRjBKxnBPk0sIueojx0BS0XBRF9R8XQGkbEl\nLembXiu5Uy6ouSLUWEdkiKKHO7MKmygT68YqsoT3ndPZE5KQ509yjLbYJEC0dhPp\ns50NNdyns3HcwaJGg0UkMszuW16BWNFZMGlvTsAGPWmfXZnThtUE6xcefNlxFuHf\ncAa4IAjtPn8b/WWvV1eZPeViycqFRgZjXiXG9BDzRInM8GStf1WJOSi10uI+tZKD\nK9+nxYflUizMp8pBwxaMfEIAX1RFLtFRs6rfww9KGlEXYo7+kGbacH3uKGMMdchw\nuxHZDSpNy2keTMd0TszQhraBTdciPJDwuBTDwa2KMlh12skjKPOaNOPvZcXt9Wfh\nKXYt/eBbupTYpsxrGF31hFVbzrO9cqzBpdGWVESbCFJHYsUxhrzSnxLhNbyGJfIG\n05rvQEuynNp7SB8/rxb7p/JbNDgVNCZGI9m1bcj+wtGbTCmaFJFsyQzYSw0uUziG\nqrNeDIybzcFHoiA9ZNN6f4cLZsjQTMNl84TxXGBY3QmIj60+g2kF78lQ2zMuIxf4\n+YTuRLbI0cJqvix+HHD+IoAptEgfBleiEUG3igvculXjoOwKaBc=\n=I3UY\n-----END PGP SIGNATURE-----", "payload": "tree 68f8083c7fd21b1dee8f6233310e057919c08b14\nparent 5179ebe2064e15196c5be1f8df950736140b8fdd\nauthor Santiago Pastorino <spastorino@gmail.com> 1587126455 -0300\ncommitter Santiago Pastorino <spastorino@gmail.com> 1587231464 -0300\n\nMake Box<dyn FnOnce> respect self alignment\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/365807f0576b719ba9af6b4f724bb5f133ea81ac", "html_url": "https://github.com/rust-lang/rust/commit/365807f0576b719ba9af6b4f724bb5f133ea81ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/365807f0576b719ba9af6b4f724bb5f133ea81ac/comments", "author": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "committer": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5179ebe2064e15196c5be1f8df950736140b8fdd", "url": "https://api.github.com/repos/rust-lang/rust/commits/5179ebe2064e15196c5be1f8df950736140b8fdd", "html_url": "https://github.com/rust-lang/rust/commit/5179ebe2064e15196c5be1f8df950736140b8fdd"}], "stats": {"total": 175, "additions": 160, "deletions": 15}, "files": [{"sha": "5216d305ffbd93054ba46b52f4de41c7e3b7bfb0", "filename": "src/librustc_mir_build/build/expr/as_operand.rs", "status": "modified", "additions": 121, "deletions": 0, "changes": 121, "blob_url": "https://github.com/rust-lang/rust/blob/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Fas_operand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Fas_operand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Fas_operand.rs?ref=365807f0576b719ba9af6b4f724bb5f133ea81ac", "patch": "@@ -21,6 +21,64 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         self.as_operand(block, local_scope, expr)\n     }\n \n+    /// Returns an operand suitable for use until the end of the current scope expression and\n+    /// suitable also to be passed as function arguments.\n+    ///\n+    /// The operand returned from this function will *not be valid* after an ExprKind::Scope is\n+    /// passed, so please do *not* return it from functions to avoid bad miscompiles.  Returns an\n+    /// operand suitable for use as a call argument. This is almost always equivalent to\n+    /// `as_operand`, except for the particular case of passing values of (potentially) unsized\n+    /// types \"by value\" (see details below).\n+    ///\n+    /// As with `as_operand`, the operand returned from this function will *not be valid* after an\n+    /// `ExprKind::Scope` is passed, so do not return it from functions.\n+    ///\n+    /// # Parameters of unsized types\n+    ///\n+    /// We tweak the handling of parameters of unsized type slightly to avoid the need to create a\n+    /// local variable of unsized type. For example, consider this program:\n+    ///\n+    /// ```rust\n+    /// fn foo(p: dyn Debug) { ... }\n+    ///\n+    /// fn bar(box_p: Box<dyn Debug>) { foo(*p); }\n+    /// ```\n+    ///\n+    /// Ordinarily, for sized types, we would compile the call `foo(*p)` like so:\n+    ///\n+    /// ```rust\n+    /// let tmp0 = *box_p; // tmp0 would be the operand returned by this function call\n+    /// foo(tmp0)\n+    /// ```\n+    ///\n+    /// But because the parameter to `foo` is of the unsized type `dyn Debug`, and because it is\n+    /// being moved the deref of a box, we compile it slightly differently. The temporary `tmp0`\n+    /// that we create *stores the entire box*, and the parameter to the call itself will be\n+    /// `*tmp0`:\n+    ///\n+    /// ```rust\n+    /// let tmp0 = box_p; call foo(*tmp0)\n+    /// ```\n+    ///\n+    /// This way, the temporary `tmp0` that we create has type `Box<dyn Debug>`, which is sized.\n+    /// The value passed to the call (`*tmp0`) still has the `dyn Debug` type -- but the way that\n+    /// calls are compiled means that this parameter will be passed \"by reference\", meaning that we\n+    /// will actually provide a pointer to the interior of the box, and not move the `dyn Debug`\n+    /// value to the stack.\n+    ///\n+    /// See #68034 for more details.\n+    crate fn as_local_call_operand<M>(\n+        &mut self,\n+        block: BasicBlock,\n+        expr: M,\n+    ) -> BlockAnd<Operand<'tcx>>\n+    where\n+        M: Mirror<'tcx, Output = Expr<'tcx>>,\n+    {\n+        let local_scope = self.local_scope();\n+        self.as_call_operand(block, local_scope, expr)\n+    }\n+\n     /// Compile `expr` into a value that can be used as an operand.\n     /// If `expr` is a place like `x`, this will introduce a\n     /// temporary `tmp = x`, so that we capture the value of `x` at\n@@ -40,6 +98,19 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         self.expr_as_operand(block, scope, expr)\n     }\n \n+    fn as_call_operand<M>(\n+        &mut self,\n+        block: BasicBlock,\n+        scope: Option<region::Scope>,\n+        expr: M,\n+    ) -> BlockAnd<Operand<'tcx>>\n+    where\n+        M: Mirror<'tcx, Output = Expr<'tcx>>,\n+    {\n+        let expr = self.hir.mirror(expr);\n+        self.expr_as_call_operand(block, scope, expr)\n+    }\n+\n     fn expr_as_operand(\n         &mut self,\n         mut block: BasicBlock,\n@@ -69,4 +140,54 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             }\n         }\n     }\n+\n+    fn expr_as_call_operand(\n+        &mut self,\n+        mut block: BasicBlock,\n+        scope: Option<region::Scope>,\n+        expr: Expr<'tcx>,\n+    ) -> BlockAnd<Operand<'tcx>> {\n+        debug!(\"expr_as_call_operand(block={:?}, expr={:?})\", block, expr);\n+        let this = self;\n+\n+        if let ExprKind::Scope { region_scope, lint_level, value } = expr.kind {\n+            let source_info = this.source_info(expr.span);\n+            let region_scope = (region_scope, source_info);\n+            return this.in_scope(region_scope, lint_level, |this| {\n+                this.as_call_operand(block, scope, value)\n+            });\n+        }\n+\n+        let tcx = this.hir.tcx();\n+\n+        if tcx.features().unsized_locals {\n+            let ty = expr.ty;\n+            let span = expr.span;\n+            let param_env = this.hir.param_env;\n+\n+            if !ty.is_sized(tcx.at(span), param_env) {\n+                // !sized means !copy, so this is an unsized move\n+                assert!(!ty.is_copy_modulo_regions(tcx, param_env, span));\n+\n+                // As described above, detect the case where we are passing a value of unsized\n+                // type, and that value is coming from the deref of a box.\n+                if let ExprKind::Deref { ref arg } = expr.kind {\n+                    let arg = this.hir.mirror(arg.clone());\n+\n+                    // Generate let tmp0 = arg0\n+                    let operand = unpack!(block = this.as_temp(block, scope, arg, Mutability::Mut));\n+\n+                    // Return the operand *tmp0 to be used as the call argument\n+                    let place = Place {\n+                        local: operand,\n+                        projection: tcx.intern_place_elems(&[PlaceElem::Deref]),\n+                    };\n+\n+                    return block.and(Operand::Move(place));\n+                }\n+            }\n+        }\n+\n+        this.expr_as_operand(block, scope, expr)\n+    }\n }"}, {"sha": "3e073ec3ab5be2c81f101eebb5ceb3b3a4e892de", "filename": "src/librustc_mir_build/build/expr/into.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Finto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Finto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Finto.rs?ref=365807f0576b719ba9af6b4f724bb5f133ea81ac", "patch": "@@ -3,10 +3,10 @@\n use crate::build::expr::category::{Category, RvalueFunc};\n use crate::build::{BlockAnd, BlockAndExtension, BlockFrame, Builder};\n use crate::hair::*;\n-use rustc_middle::mir::*;\n-use rustc_middle::ty::{self, CanonicalUserTypeAnnotation};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_hir as hir;\n+use rustc_middle::mir::*;\n+use rustc_middle::ty::{self, CanonicalUserTypeAnnotation};\n use rustc_span::symbol::sym;\n \n use rustc_target::spec::abi::Abi;\n@@ -207,7 +207,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                 } else {\n                     let args: Vec<_> = args\n                         .into_iter()\n-                        .map(|arg| unpack!(block = this.as_local_operand(block, arg)))\n+                        .map(|arg| unpack!(block = this.as_local_call_operand(block, arg)))\n                         .collect();\n \n                     let success = this.cfg.start_new_block();"}, {"sha": "125f44bbf0093071599e8fab4fa76f9b12e37fe7", "filename": "src/test/ui/fn/dyn-fn-alignment.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Ffn%2Fdyn-fn-alignment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Ffn%2Fdyn-fn-alignment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffn%2Fdyn-fn-alignment.rs?ref=365807f0576b719ba9af6b4f724bb5f133ea81ac", "patch": "@@ -0,0 +1,24 @@\n+// run-pass\n+\n+#![feature(unsized_locals)]\n+#![allow(dead_code)]\n+#[repr(align(256))]\n+struct A {\n+    v: u8,\n+}\n+\n+impl A {\n+    fn f(&self) -> *const A {\n+        self\n+    }\n+}\n+\n+fn f2(v: u8) -> Box<dyn FnOnce() -> *const A> {\n+    let a = A { v };\n+    Box::new(move || a.f())\n+}\n+\n+fn main() {\n+    let addr = f2(0)();\n+    assert_eq!(addr as usize % 256, 0, \"addr: {:?}\", addr);\n+}"}, {"sha": "110edab69be871d08c4d5c676123c6650666ca44", "filename": "src/test/ui/unsized-locals/borrow-after-move.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Funsized-locals%2Fborrow-after-move.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Funsized-locals%2Fborrow-after-move.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsized-locals%2Fborrow-after-move.stderr?ref=365807f0576b719ba9af6b4f724bb5f133ea81ac", "patch": "@@ -45,12 +45,12 @@ LL |         println!(\"{}\", &y);\n error[E0382]: borrow of moved value: `x`\n   --> $DIR/borrow-after-move.rs:39:24\n    |\n+LL |         let x = \"hello\".to_owned().into_boxed_str();\n+   |             - move occurs because `x` has type `std::boxed::Box<str>`, which does not implement the `Copy` trait\n LL |         x.foo();\n    |         - value moved here\n LL |         println!(\"{}\", &x);\n-   |                        ^^ value borrowed here after partial move\n-   |\n-   = note: move occurs because `*x` has type `str`, which does not implement the `Copy` trait\n+   |                        ^^ value borrowed here after move\n \n error: aborting due to 5 previous errors\n "}, {"sha": "5b936fb64474f3ccd8af16f71cf262da7d05dafc", "filename": "src/test/ui/unsized-locals/double-move.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Funsized-locals%2Fdouble-move.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Funsized-locals%2Fdouble-move.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsized-locals%2Fdouble-move.stderr?ref=365807f0576b719ba9af6b4f724bb5f133ea81ac", "patch": "@@ -38,25 +38,25 @@ LL |         y.foo();\n LL |         y.foo();\n    |         ^ value used here after move\n \n-error[E0382]: use of moved value: `*x`\n+error[E0382]: use of moved value: `x`\n   --> $DIR/double-move.rs:45:9\n    |\n LL |         let _y = *x;\n    |                  -- value moved here\n LL |         x.foo();\n-   |         ^ value used here after move\n+   |         ^ value used here after partial move\n    |\n    = note: move occurs because `*x` has type `str`, which does not implement the `Copy` trait\n \n error[E0382]: use of moved value: `*x`\n   --> $DIR/double-move.rs:51:18\n    |\n+LL |         let x = \"hello\".to_owned().into_boxed_str();\n+   |             - move occurs because `x` has type `std::boxed::Box<str>`, which does not implement the `Copy` trait\n LL |         x.foo();\n    |         - value moved here\n LL |         let _y = *x;\n    |                  ^^ value used here after move\n-   |\n-   = note: move occurs because `*x` has type `str`, which does not implement the `Copy` trait\n \n error: aborting due to 6 previous errors\n "}, {"sha": "88269f237afb7d613601da9f3479a849691e71f1", "filename": "src/test/ui/unsized-locals/unsized-exprs2.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Funsized-locals%2Funsized-exprs2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/365807f0576b719ba9af6b4f724bb5f133ea81ac/src%2Ftest%2Fui%2Funsized-locals%2Funsized-exprs2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsized-locals%2Funsized-exprs2.stderr?ref=365807f0576b719ba9af6b4f724bb5f133ea81ac", "patch": "@@ -1,11 +1,11 @@\n error[E0508]: cannot move out of type `[u8]`, a non-copy slice\n-  --> $DIR/unsized-exprs2.rs:22:19\n+  --> $DIR/unsized-exprs2.rs:22:5\n    |\n LL |     udrop::<[u8]>(foo()[..]);\n-   |                   ^^^^^^^^^\n-   |                   |\n-   |                   cannot move out of here\n-   |                   move occurs because value has type `[u8]`, which does not implement the `Copy` trait\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^\n+   |     |\n+   |     cannot move out of here\n+   |     move occurs because value has type `[u8]`, which does not implement the `Copy` trait\n \n error: aborting due to previous error\n "}]}