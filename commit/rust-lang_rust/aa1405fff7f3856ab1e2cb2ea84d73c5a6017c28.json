{"sha": "aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhMTQwNWZmZjdmMzg1NmFiMWUyY2IyZWE4NGQ3M2M1YTYwMTdjMjg=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-02-23T15:10:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-23T15:10:29Z"}, "message": "Rollup merge of #82362 - osa1:issue81918, r=oli-obk\n\nFix mir-cfg dumps\n\nFixes #81918\nFixes #82326 (duplicate)\nFixes #82325\n\n---\n\nr? ``@oli-obk``", "tree": {"sha": "fdbc855c0a9eec5ace437656eccc102c7b2810c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fdbc855c0a9eec5ace437656eccc102c7b2810c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgNRrlCRBK7hj4Ov3rIwAAdHIIABqGPNqbI4YxTa2GJy0Dadh7\nG/JwO/oB0IACUIos9gUfKj/VKfiTkhM7K2UVhezX3OL+i3WpGv3uBv4mniIsITfI\nICgFLIWYaaq7CUtpRENWZmfLk57VoWcoOttjrLMPHl1a6myPa7zFtKcapC3yfhxd\njojEp503oeavs/pj5/zFmhopAjrgImaUOYCk7bwdEAR4AEgOD36GXnPav0sFxh5w\nQpf9aRRz9O2oVMzn5TfaNBP27loepOTw0/AYD7kYSMICOlaTuyDJJxc9AmKogh+Z\nzkf4JQwKKMrc/oN6DpHxcVLwsZnQawo3WfA5ZLxGPmIX8EVbg8uZyBjNq62RyqU=\n=kE3p\n-----END PGP SIGNATURE-----\n", "payload": "tree fdbc855c0a9eec5ace437656eccc102c7b2810c6\nparent 619e47b8866ee84b4ddd23e04a486922f5921c11\nparent 2145a8770c941f79e28cfdabd524ca2aea8ab2b4\nauthor Dylan DPC <dylan.dpc@gmail.com> 1614093029 +0100\ncommitter GitHub <noreply@github.com> 1614093029 +0100\n\nRollup merge of #82362 - osa1:issue81918, r=oli-obk\n\nFix mir-cfg dumps\n\nFixes #81918\nFixes #82326 (duplicate)\nFixes #82325\n\n---\n\nr? ``@oli-obk``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28", "html_url": "https://github.com/rust-lang/rust/commit/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "619e47b8866ee84b4ddd23e04a486922f5921c11", "url": "https://api.github.com/repos/rust-lang/rust/commits/619e47b8866ee84b4ddd23e04a486922f5921c11", "html_url": "https://github.com/rust-lang/rust/commit/619e47b8866ee84b4ddd23e04a486922f5921c11"}, {"sha": "2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2145a8770c941f79e28cfdabd524ca2aea8ab2b4", "html_url": "https://github.com/rust-lang/rust/commit/2145a8770c941f79e28cfdabd524ca2aea8ab2b4"}], "stats": {"total": 34, "additions": 29, "deletions": 5}, "files": [{"sha": "92c7a358c0a41d59b9552a99ede510c04f0f0f84", "filename": "compiler/rustc_mir/src/util/graphviz.rs", "status": "modified", "additions": 18, "deletions": 5, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs?ref=aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28", "patch": "@@ -2,7 +2,7 @@ use gsgdt::GraphvizSettings;\n use rustc_graphviz as dot;\n use rustc_hir::def_id::DefId;\n use rustc_middle::mir::*;\n-use rustc_middle::ty::TyCtxt;\n+use rustc_middle::ty::{self, TyCtxt};\n use std::fmt::Debug;\n use std::io::{self, Write};\n \n@@ -16,14 +16,27 @@ where\n {\n     let def_ids = dump_mir_def_ids(tcx, single);\n \n-    let use_subgraphs = def_ids.len() > 1;\n+    let mirs =\n+        def_ids\n+            .iter()\n+            .flat_map(|def_id| {\n+                if tcx.is_const_fn_raw(*def_id) {\n+                    vec![tcx.optimized_mir(*def_id), tcx.mir_for_ctfe(*def_id)]\n+                } else {\n+                    vec![tcx.instance_mir(ty::InstanceDef::Item(ty::WithOptConstParam::unknown(\n+                        *def_id,\n+                    )))]\n+                }\n+            })\n+            .collect::<Vec<_>>();\n+\n+    let use_subgraphs = mirs.len() > 1;\n     if use_subgraphs {\n         writeln!(w, \"digraph __crate__ {{\")?;\n     }\n \n-    for def_id in def_ids {\n-        let body = &tcx.optimized_mir(def_id);\n-        write_mir_fn_graphviz(tcx, body, use_subgraphs, w)?;\n+    for mir in mirs {\n+        write_mir_fn_graphviz(tcx, mir, use_subgraphs, w)?;\n     }\n \n     if use_subgraphs {"}, {"sha": "8938b8a6f2c52856bca6e94da4ca7d1f77fec7a3", "filename": "src/test/ui/issues/issue-81918.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28/src%2Ftest%2Fui%2Fissues%2Fissue-81918.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28/src%2Ftest%2Fui%2Fissues%2Fissue-81918.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-81918.rs?ref=aa1405fff7f3856ab1e2cb2ea84d73c5a6017c28", "patch": "@@ -0,0 +1,11 @@\n+// check-pass\n+// dont-check-compiler-stdout\n+// compile-flags: -Z unpretty=mir-cfg\n+\n+// This checks that unpretty=mir-cfg does not panic. See #81918.\n+\n+const TAG: &'static str = \"ABCD\";\n+\n+fn main() {\n+    if TAG == \"\" {}\n+}"}]}