{"sha": "0833d8776282b39740345bbb5710037eabc67180", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4MzNkODc3NjI4MmIzOTc0MDM0NWJiYjU3MTAwMzdlYWJjNjcxODA=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-08-27T22:08:37Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-08-27T22:08:37Z"}, "message": "Rollup merge of #28033 - Manishearth:compilerexpn, r=eddyb\n\nWe were using them for every expansion, instead of using `Name`.\n\nAlso converted `CompilerExpansion` into an enum so its nicer to use and takes up less space.\n\nWill profile later, but this should be a small improvement in memory usage.\n\nr? @eddyb", "tree": {"sha": "5055b1ffdd51c0875b881a243e3915d992d433b7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5055b1ffdd51c0875b881a243e3915d992d433b7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0833d8776282b39740345bbb5710037eabc67180", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0833d8776282b39740345bbb5710037eabc67180", "html_url": "https://github.com/rust-lang/rust/commit/0833d8776282b39740345bbb5710037eabc67180", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0833d8776282b39740345bbb5710037eabc67180/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aebe352794bfe28ed62f0c4ffa17f5bbf3baeaca", "url": "https://api.github.com/repos/rust-lang/rust/commits/aebe352794bfe28ed62f0c4ffa17f5bbf3baeaca", "html_url": "https://github.com/rust-lang/rust/commit/aebe352794bfe28ed62f0c4ffa17f5bbf3baeaca"}, {"sha": "25cbb4385ee58804cb2483af56d1333fbee6e27d", "url": "https://api.github.com/repos/rust-lang/rust/commits/25cbb4385ee58804cb2483af56d1333fbee6e27d", "html_url": "https://github.com/rust-lang/rust/commit/25cbb4385ee58804cb2483af56d1333fbee6e27d"}], "stats": {"total": 154, "additions": 84, "deletions": 70}, "files": [{"sha": "e07cd7b5847e89ad6f812a92287012c1b18b0cf2", "filename": "src/libsyntax/codemap.rs", "status": "modified", "additions": 36, "deletions": 7, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fcodemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fcodemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fcodemap.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -29,6 +29,8 @@ use std::io::{self, Read};\n \n use serialize::{Encodable, Decodable, Encoder, Decoder};\n \n+use parse::token::intern;\n+use ast::Name;\n \n // _____________________________________________________________________________\n // Pos, BytePos, CharPos\n@@ -257,21 +259,38 @@ pub struct FileMapAndBytePos { pub fm: Rc<FileMap>, pub pos: BytePos }\n //\n \n /// The source of expansion.\n-#[derive(Clone, Copy, Hash, Debug, PartialEq, Eq)]\n+#[derive(Clone, Hash, Debug, PartialEq, Eq)]\n pub enum ExpnFormat {\n     /// e.g. #[derive(...)] <item>\n-    MacroAttribute,\n+    MacroAttribute(Name),\n     /// e.g. `format!()`\n-    MacroBang,\n+    MacroBang(Name),\n     /// Syntax sugar expansion performed by the compiler (libsyntax::expand).\n-    CompilerExpansion,\n+    CompilerExpansion(CompilerExpansionFormat),\n+}\n+\n+#[derive(Clone, Copy, Hash, Debug, PartialEq, Eq)]\n+pub enum CompilerExpansionFormat {\n+    IfLet,\n+    PlacementIn,\n+    WhileLet,\n+    ForLoop,\n+    Closure,\n }\n \n+impl CompilerExpansionFormat {\n+    pub fn name(self) -> &'static str {\n+        match self {\n+            CompilerExpansionFormat::IfLet => \"if let expansion\",\n+            CompilerExpansionFormat::PlacementIn => \"placement-in expansion\",\n+            CompilerExpansionFormat::WhileLet => \"while let expansion\",\n+            CompilerExpansionFormat::ForLoop => \"for loop expansion\",\n+            CompilerExpansionFormat::Closure => \"closure expansion\",\n+        }\n+    }\n+}\n #[derive(Clone, Hash, Debug)]\n pub struct NameAndSpan {\n-    /// The name of the macro that was invoked to create the thing\n-    /// with this Span.\n-    pub name: String,\n     /// The format with which the macro was invoked.\n     pub format: ExpnFormat,\n     /// Whether the macro is allowed to use #[unstable]/feature-gated\n@@ -284,6 +303,16 @@ pub struct NameAndSpan {\n     pub span: Option<Span>\n }\n \n+impl NameAndSpan {\n+    pub fn name(&self) -> Name {\n+        match self.format {\n+            ExpnFormat::MacroAttribute(s) => s,\n+            ExpnFormat::MacroBang(s) => s,\n+            ExpnFormat::CompilerExpansion(ce) => intern(ce.name()),\n+        }\n+    }\n+}\n+\n /// Extra information for tracking spans of macro and syntax sugar expansion\n #[derive(Hash, Debug)]\n pub struct ExpnInfo {"}, {"sha": "067e3fff3eb299a1ca6ab403069d191126871fe6", "filename": "src/libsyntax/diagnostic.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fdiagnostic.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -733,14 +733,14 @@ impl EmitterWriter {\n                     let ss = ei.callee.span.map_or(String::new(),\n                                                    |span| cm.span_to_string(span));\n                     let (pre, post) = match ei.callee.format {\n-                        codemap::MacroAttribute => (\"#[\", \"]\"),\n-                        codemap::MacroBang => (\"\", \"!\"),\n-                        codemap::CompilerExpansion => (\"\", \"\"),\n+                        codemap::MacroAttribute(..) => (\"#[\", \"]\"),\n+                        codemap::MacroBang(..) => (\"\", \"!\"),\n+                        codemap::CompilerExpansion(..) => (\"\", \"\"),\n                     };\n                     try!(self.print_diagnostic(&ss, Note,\n                                                &format!(\"in expansion of {}{}{}\",\n                                                         pre,\n-                                                        ei.callee.name,\n+                                                        ei.callee.name(),\n                                                         post),\n                                                None));\n                     let ss = cm.span_to_string(ei.call_site);"}, {"sha": "c48b740d83ae5b3e4830e6e91725c9d755a3b2a0", "filename": "src/libsyntax/ext/asm.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fasm.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -19,7 +19,7 @@ use codemap::Span;\n use ext::base;\n use ext::base::*;\n use feature_gate;\n-use parse::token::InternedString;\n+use parse::token::{intern, InternedString};\n use parse::token;\n use ptr::P;\n \n@@ -211,8 +211,7 @@ pub fn expand_asm<'cx>(cx: &'cx mut ExtCtxt, sp: Span, tts: &[ast::TokenTree])\n     let expn_id = cx.codemap().record_expansion(codemap::ExpnInfo {\n         call_site: sp,\n         callee: codemap::NameAndSpan {\n-            name: \"asm\".to_string(),\n-            format: codemap::MacroBang,\n+            format: codemap::MacroBang(intern(\"asm\")),\n             span: None,\n             allow_internal_unstable: false,\n         },"}, {"sha": "ef49ef11497fc585509e6ebbb408fbbe5f44ce3e", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -714,13 +714,14 @@ impl<'a> ExtCtxt<'a> {\n         loop {\n             if self.codemap().with_expn_info(expn_id, |info| {\n                 info.map_or(None, |i| {\n-                    if i.callee.name == \"include\" {\n+                    if i.callee.name() == \"include\" {\n                         // Stop going up the backtrace once include! is encountered\n                         return None;\n                     }\n                     expn_id = i.call_site.expn_id;\n-                    if i.callee.format != CompilerExpansion {\n-                        last_macro = Some(i.call_site)\n+                    match i.callee.format {\n+                        CompilerExpansion(..) => (),\n+                        _ => last_macro = Some(i.call_site),\n                     }\n                     return Some(());\n                 })\n@@ -744,7 +745,7 @@ impl<'a> ExtCtxt<'a> {\n         if self.recursion_count > self.ecfg.recursion_limit {\n             panic!(self.span_fatal(ei.call_site,\n                             &format!(\"recursion limit reached while expanding the macro `{}`\",\n-                                    ei.callee.name)));\n+                                    ei.callee.name())));\n         }\n \n         let mut call_site = ei.call_site;"}, {"sha": "3196380ec6c36797805a458da22b4f50fc298501", "filename": "src/libsyntax/ext/deriving/generic/mod.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -205,7 +205,7 @@ use codemap::Span;\n use diagnostic::SpanHandler;\n use fold::MoveMap;\n use owned_slice::OwnedSlice;\n-use parse::token::InternedString;\n+use parse::token::{intern, InternedString};\n use parse::token::special_idents;\n use ptr::P;\n \n@@ -1436,8 +1436,7 @@ impl<'a> TraitDef<'a> {\n         to_set.expn_id = cx.codemap().record_expansion(codemap::ExpnInfo {\n             call_site: to_set,\n             callee: codemap::NameAndSpan {\n-                name: format!(\"derive({})\", trait_name),\n-                format: codemap::MacroAttribute,\n+                format: codemap::MacroAttribute(intern(&format!(\"derive({})\", trait_name))),\n                 span: Some(self.span),\n                 allow_internal_unstable: false,\n             }"}, {"sha": "3459caecb260a21c5c9aa06e7e806f28f989e116", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 26, "deletions": 34, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -19,7 +19,8 @@ use ext::build::AstBuilder;\n use attr;\n use attr::AttrMetaMethods;\n use codemap;\n-use codemap::{Span, Spanned, ExpnInfo, NameAndSpan, MacroBang, MacroAttribute, CompilerExpansion};\n+use codemap::{Span, Spanned, ExpnInfo, NameAndSpan, MacroBang, MacroAttribute};\n+use codemap::{CompilerExpansion, CompilerExpansionFormat};\n use ext::base::*;\n use feature_gate::{self, Features, GatedCfg};\n use fold;\n@@ -43,12 +44,12 @@ fn mk_core_path(fld: &mut MacroExpander,\n }\n \n pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n-    fn push_compiler_expansion(fld: &mut MacroExpander, span: Span, expansion_desc: &str) {\n+    fn push_compiler_expansion(fld: &mut MacroExpander, span: Span,\n+                               expansion_type: CompilerExpansionFormat) {\n         fld.cx.bt_push(ExpnInfo {\n             call_site: span,\n             callee: NameAndSpan {\n-                name: expansion_desc.to_string(),\n-                format: CompilerExpansion,\n+                format: CompilerExpansion(expansion_type),\n \n                 // This does *not* mean code generated after\n                 // `push_compiler_expansion` is automatically exempt\n@@ -111,7 +112,7 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n                 &fld.cx.parse_sess.span_diagnostic,\n                 expr_span);\n \n-            push_compiler_expansion(fld, expr_span, \"placement-in expansion\");\n+            push_compiler_expansion(fld, expr_span, CompilerExpansionFormat::PlacementIn);\n \n             let value_span = value_expr.span;\n             let placer_span = placer.span;\n@@ -223,7 +224,7 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             //     }\n             //   }\n \n-            push_compiler_expansion(fld, span, \"while let expansion\");\n+            push_compiler_expansion(fld, span, CompilerExpansionFormat::WhileLet);\n \n             // `<pat> => <body>`\n             let pat_arm = {\n@@ -262,7 +263,7 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             //     _ => [<elseopt> | ()]\n             //   }\n \n-            push_compiler_expansion(fld, span, \"if let expansion\");\n+            push_compiler_expansion(fld, span, CompilerExpansionFormat::IfLet);\n \n             // `<pat> => <body>`\n             let pat_arm = {\n@@ -334,7 +335,7 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n         ast::ExprIf(cond, blk, elseopt) => {\n             let elseopt = elseopt.map(|els| els.and_then(|els| match els.node {\n                 ast::ExprIfLet(..) => {\n-                    push_compiler_expansion(fld, span, \"if let expansion\");\n+                    push_compiler_expansion(fld, span, CompilerExpansionFormat::IfLet);\n                     // wrap the if-let expr in a block\n                     let span = els.span;\n                     let blk = P(ast::Block {\n@@ -378,7 +379,7 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n             //     result\n             //   }\n \n-            push_compiler_expansion(fld, span, \"for loop expansion\");\n+            push_compiler_expansion(fld, span, CompilerExpansionFormat::ForLoop);\n \n             let span = fld.new_span(span);\n \n@@ -458,7 +459,7 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n         }\n \n         ast::ExprClosure(capture_clause, fn_decl, block) => {\n-            push_compiler_expansion(fld, span, \"closure expansion\");\n+            push_compiler_expansion(fld, span, CompilerExpansionFormat::Closure);\n             let (rewritten_fn_decl, rewritten_block)\n                 = expand_and_rename_fn_decl_and_block(fn_decl, block, fld);\n             let new_node = ast::ExprClosure(capture_clause,\n@@ -542,8 +543,7 @@ fn expand_mac_invoc<T, F, G>(mac: ast::Mac,\n                         fld.cx.bt_push(ExpnInfo {\n                                 call_site: span,\n                                 callee: NameAndSpan {\n-                                    name: extname.to_string(),\n-                                    format: MacroBang,\n+                                    format: MacroBang(extname),\n                                     span: exp_span,\n                                     allow_internal_unstable: allow_internal_unstable,\n                                 },\n@@ -721,8 +721,7 @@ pub fn expand_item_mac(it: P<ast::Item>,\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: it.span,\n                         callee: NameAndSpan {\n-                            name: extname.to_string(),\n-                            format: MacroBang,\n+                            format: MacroBang(extname),\n                             span: span,\n                             allow_internal_unstable: allow_internal_unstable,\n                         }\n@@ -741,8 +740,7 @@ pub fn expand_item_mac(it: P<ast::Item>,\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: it.span,\n                         callee: NameAndSpan {\n-                            name: extname.to_string(),\n-                            format: MacroBang,\n+                            format: MacroBang(extname),\n                             span: span,\n                             allow_internal_unstable: allow_internal_unstable,\n                         }\n@@ -762,8 +760,7 @@ pub fn expand_item_mac(it: P<ast::Item>,\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: it.span,\n                         callee: NameAndSpan {\n-                            name: extname.to_string(),\n-                            format: MacroBang,\n+                            format: MacroBang(extname),\n                             span: None,\n                             // `macro_rules!` doesn't directly allow\n                             // unstable (this is orthogonal to whether\n@@ -1090,8 +1087,7 @@ fn expand_pat(p: P<ast::Pat>, fld: &mut MacroExpander) -> P<ast::Pat> {\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: span,\n                         callee: NameAndSpan {\n-                            name: extname.to_string(),\n-                            format: MacroBang,\n+                            format: MacroBang(extname),\n                             span: tt_span,\n                             allow_internal_unstable: allow_internal_unstable,\n                         }\n@@ -1293,17 +1289,16 @@ fn expand_decorators(a: Annotatable,\n                      new_attrs: &mut Vec<ast::Attribute>)\n {\n     for attr in a.attrs() {\n-        let mname = attr.name();\n-        match fld.cx.syntax_env.find(&intern(&mname)) {\n+        let mname = intern(&attr.name());\n+        match fld.cx.syntax_env.find(&mname) {\n             Some(rc) => match *rc {\n                 Decorator(ref dec) => {\n                     attr::mark_used(&attr);\n \n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: attr.span,\n                         callee: NameAndSpan {\n-                            name: mname.to_string(),\n-                            format: MacroAttribute,\n+                            format: MacroAttribute(mname),\n                             span: Some(attr.span),\n                             // attributes can do whatever they like,\n                             // for now.\n@@ -1330,8 +1325,7 @@ fn expand_decorators(a: Annotatable,\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: attr.span,\n                         callee: NameAndSpan {\n-                            name: mname.to_string(),\n-                            format: MacroAttribute,\n+                            format: MacroAttribute(mname),\n                             span: Some(attr.span),\n                             // attributes can do whatever they like,\n                             // for now.\n@@ -1372,17 +1366,16 @@ fn expand_item_multi_modifier(mut it: Annotatable,\n     }\n \n     for attr in &modifiers {\n-        let mname = attr.name();\n+        let mname = intern(&attr.name());\n \n-        match fld.cx.syntax_env.find(&intern(&mname)) {\n+        match fld.cx.syntax_env.find(&mname) {\n             Some(rc) => match *rc {\n                 MultiModifier(ref mac) => {\n                     attr::mark_used(attr);\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: attr.span,\n                         callee: NameAndSpan {\n-                            name: mname.to_string(),\n-                            format: MacroAttribute,\n+                            format: MacroAttribute(mname),\n                             span: Some(attr.span),\n                             // attributes can do whatever they like,\n                             // for now\n@@ -1421,17 +1414,16 @@ fn expand_item_modifiers(mut it: P<ast::Item>,\n     }\n \n     for attr in &modifiers {\n-        let mname = attr.name();\n+        let mname = intern(&attr.name());\n \n-        match fld.cx.syntax_env.find(&intern(&mname)) {\n+        match fld.cx.syntax_env.find(&mname) {\n             Some(rc) => match *rc {\n                 Modifier(ref mac) => {\n                     attr::mark_used(attr);\n                     fld.cx.bt_push(ExpnInfo {\n                         call_site: attr.span,\n                         callee: NameAndSpan {\n-                            name: mname.to_string(),\n-                            format: MacroAttribute,\n+                            format: MacroAttribute(mname),\n                             span: Some(attr.span),\n                             // attributes can do whatever they like,\n                             // for now"}, {"sha": "d6974abd394f9bdaa9788b8c83b4912e26b51a60", "filename": "src/libsyntax/std_inject.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fstd_inject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Fstd_inject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fstd_inject.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -14,8 +14,7 @@ use codemap::{DUMMY_SP, Span, ExpnInfo, NameAndSpan, MacroAttribute};\n use codemap;\n use fold::Folder;\n use fold;\n-use parse::token::InternedString;\n-use parse::token::special_idents;\n+use parse::token::{intern, InternedString, special_idents};\n use parse::{token, ParseSess};\n use ptr::P;\n use util::small_vector::SmallVector;\n@@ -27,8 +26,7 @@ fn ignored_span(sess: &ParseSess, sp: Span) -> Span {\n     let info = ExpnInfo {\n         call_site: DUMMY_SP,\n         callee: NameAndSpan {\n-            name: \"std_inject\".to_string(),\n-            format: MacroAttribute,\n+            format: MacroAttribute(intern(\"std_inject\")),\n             span: None,\n             allow_internal_unstable: true,\n         }"}, {"sha": "7cd44e5fb4eff2d82a7fc1226fe9d6e8e5fac678", "filename": "src/libsyntax/test.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Flibsyntax%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftest.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -32,7 +32,7 @@ use ext::expand::ExpansionConfig;\n use fold::{Folder, MoveMap};\n use fold;\n use owned_slice::OwnedSlice;\n-use parse::token::InternedString;\n+use parse::token::{intern, InternedString};\n use parse::{token, ParseSess};\n use print::pprust;\n use {ast, ast_util};\n@@ -298,8 +298,7 @@ fn generate_test_harness(sess: &ParseSess,\n     cx.ext_cx.bt_push(ExpnInfo {\n         call_site: DUMMY_SP,\n         callee: NameAndSpan {\n-            name: \"test\".to_string(),\n-            format: MacroAttribute,\n+            format: MacroAttribute(intern(\"test\")),\n             span: None,\n             allow_internal_unstable: false,\n         }\n@@ -331,8 +330,7 @@ fn ignored_span(cx: &TestCtxt, sp: Span) -> Span {\n     let info = ExpnInfo {\n         call_site: DUMMY_SP,\n         callee: NameAndSpan {\n-            name: \"test\".to_string(),\n-            format: MacroAttribute,\n+            format: MacroAttribute(intern(\"test\")),\n             span: None,\n             allow_internal_unstable: true,\n         }"}, {"sha": "7ffbbe69c3d6bd503148d7d65a6cf5e2968d4922", "filename": "src/test/compile-fail-fulldeps/qquote.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Ftest%2Fcompile-fail-fulldeps%2Fqquote.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Ftest%2Fcompile-fail-fulldeps%2Fqquote.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fqquote.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -27,8 +27,7 @@ fn main() {\n     cx.bt_push(syntax::codemap::ExpnInfo {\n         call_site: DUMMY_SP,\n         callee: syntax::codemap::NameAndSpan {\n-            name: \"\".to_string(),\n-            format: syntax::codemap::MacroBang,\n+            format: syntax::codemap::MacroBang(parse::token::intern(\"\")),\n             allow_internal_unstable: false,\n             span: None,\n         }"}, {"sha": "d42a777a019a30bd03d797aa7ae0f6eb981fa89f", "filename": "src/test/run-fail-fulldeps/qquote.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Ftest%2Frun-fail-fulldeps%2Fqquote.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Ftest%2Frun-fail-fulldeps%2Fqquote.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail-fulldeps%2Fqquote.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -31,8 +31,7 @@ fn main() {\n     cx.bt_push(syntax::codemap::ExpnInfo {\n         call_site: DUMMY_SP,\n         callee: syntax::codemap::NameAndSpan {\n-            name: \"\".to_string(),\n-            format: syntax::codemap::MacroBang,\n+            format: syntax::codemap::MacroBang(parse::token::intern(\"\")),\n             allow_internal_unstable: false,\n             span: None,\n         }"}, {"sha": "ba713bb98f8547a71e8728b08fe14f78ccc9a8e0", "filename": "src/test/run-pass-fulldeps/qquote.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0833d8776282b39740345bbb5710037eabc67180/src%2Ftest%2Frun-pass-fulldeps%2Fqquote.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0833d8776282b39740345bbb5710037eabc67180/src%2Ftest%2Frun-pass-fulldeps%2Fqquote.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fqquote.rs?ref=0833d8776282b39740345bbb5710037eabc67180", "patch": "@@ -16,6 +16,7 @@ extern crate syntax;\n \n use syntax::codemap::DUMMY_SP;\n use syntax::print::pprust::*;\n+use syntax::parse::token::intern;\n \n fn main() {\n     let ps = syntax::parse::ParseSess::new();\n@@ -27,8 +28,7 @@ fn main() {\n     cx.bt_push(syntax::codemap::ExpnInfo {\n         call_site: DUMMY_SP,\n         callee: syntax::codemap::NameAndSpan {\n-            name: \"\".to_string(),\n-            format: syntax::codemap::MacroBang,\n+            format: syntax::codemap::MacroBang(intern(\"\")),\n             allow_internal_unstable: false,\n             span: None,\n         }"}]}