{"sha": "75f2263cf724d125afc2582d4f60df39e8f20097", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1ZjIyNjNjZjcyNGQxMjVhZmMyNTgyZDRmNjBkZjM5ZThmMjAwOTc=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-07-01T09:15:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-01T09:15:39Z"}, "message": "Rollup merge of #86558 - Smittyvb:link-error-sugg, r=petrochenkov\n\nAdd suggestions for \"undefined reference\" link errors\n\nThis adds a suggestion for \"undefined reference to ...\" linking errors to install or specify the location to an external library. Since there is no defined error format for linkers, we just check if there was a failure and if that failure contains the string `undefined reference to`. This also makes it impossible to test this, since the output depends on the system linker. The output now looks like:\n```\nerror: linking with `cc` failed: exit status: 1\n  |\n  = note: \"cc\" \"-m64\" \"linking_failure.linking_failure.7rcbfp3g-cgu.0.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.1.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.2.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.3.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.4.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.5.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.6.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.7.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.8.rcgu.o\" \"linking_failure.53u64zklswtfazes.rcgu.o\" \"-Wl,--as-needed\" \"-L\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,--start-group\" \"-Wl,-Bstatic\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-01ce3ba5c629d02f.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libpanic_unwind-f1f2102409186354.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libminiz_oxide-1e8b6b56a999f838.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libadler-d0e93eb4e14f1d19.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libobject-1d7e39d75d082b43.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libaddr2line-ade42e945045b261.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libgimli-1a65064fccf4ebc1.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd_detect-4d699c310fdfe72d.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_demangle-1cafa68a696ec800.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libhashbrown-e9f1c8c4dab2f046.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_alloc-ecc1a743be25c7f7.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libunwind-e074031c4b66b6b6.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcfg_if-9aa6ed9f1d3bfd53.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/liblibc-7862bf96c2250ca0.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/liballoc-f02ce0dc7895b5fd.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_core-3af9c60917570521.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-ca16fc7bb3645684.rlib\" \"-Wl,--end-group\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-d8e1a5b7299604cc.rlib\" \"-Wl,-Bdynamic\" \"-lgcc_s\" \"-lutil\" \"-lrt\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-o\" \"linking_failure\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-nodefaultlibs\"\n  = note: /usr/bin/ld: linking_failure.linking_failure.7rcbfp3g-cgu.3.rcgu.o: in function `linking_failure::main':\n          linking_failure.7rcbfp3g-cgu.3:(.text._ZN15linking_failure4main17h52b6e3052e444479E+0x3): undefined reference to `doesnt_exist_thiwthwfyl'\n          clang: error: linker command failed with exit code 1 (use -v to see invocation)\n\n  = help: some `extern` functions couldn't be found; you may need to install or specify the path to some dependencies\n  = note: use the -L flag to specify the library lookup path\n  = note: use the cargo:rustc-link-search directive to specify the library lookup path with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#rustc-link-search)\n\nerror: aborting due to previous error\n```", "tree": {"sha": "3068fcac3c07b904ccebf0495fc57f12e6ef0021", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3068fcac3c07b904ccebf0495fc57f12e6ef0021"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75f2263cf724d125afc2582d4f60df39e8f20097", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg3Ye7CRBK7hj4Ov3rIwAA9gwIAHLjO4s4VC6NXSelVIjsS0vh\nkeUZLmKogYfXQrjrL6M7VNpEexccS9QxM4NwnupIYC932GB/7kBEXZte00oHh3FB\nVru4YWR7O7HNY08b+YH+Kl+YVTmPvsoGdWKf7cC6m8lgPTJLjpDs8eGSSwjVwkly\nk5ren//ulZlw5/3AfFEK0fnoAhCpvC570XbIJPKYwnwFjwfC6nWn000uY2/97gn8\nlIEoirXw+ITjKM6mcx/BCT7BJx1Vu3cT5tGBTX/arTWhPiOaOZqmLc+6YdYiyAOn\nD2OYKNx0ILeOE6k/44NVVOI7U+PbvQaebalXIQr9v3lr4AR9tdr507juFkGQezg=\n=41fv\n-----END PGP SIGNATURE-----\n", "payload": "tree 3068fcac3c07b904ccebf0495fc57f12e6ef0021\nparent 1034282bca4402b2a9d913c981002c45dc3e2425\nparent ce63d55bc7d1a1cd65d175e22787ea964bba0e2a\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1625130939 +0200\ncommitter GitHub <noreply@github.com> 1625130939 +0200\n\nRollup merge of #86558 - Smittyvb:link-error-sugg, r=petrochenkov\n\nAdd suggestions for \"undefined reference\" link errors\n\nThis adds a suggestion for \"undefined reference to ...\" linking errors to install or specify the location to an external library. Since there is no defined error format for linkers, we just check if there was a failure and if that failure contains the string `undefined reference to`. This also makes it impossible to test this, since the output depends on the system linker. The output now looks like:\n```\nerror: linking with `cc` failed: exit status: 1\n  |\n  = note: \"cc\" \"-m64\" \"linking_failure.linking_failure.7rcbfp3g-cgu.0.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.1.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.2.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.3.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.4.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.5.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.6.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.7.rcgu.o\" \"linking_failure.linking_failure.7rcbfp3g-cgu.8.rcgu.o\" \"linking_failure.53u64zklswtfazes.rcgu.o\" \"-Wl,--as-needed\" \"-L\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,--start-group\" \"-Wl,-Bstatic\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd-01ce3ba5c629d02f.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libpanic_unwind-f1f2102409186354.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libminiz_oxide-1e8b6b56a999f838.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libadler-d0e93eb4e14f1d19.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libobject-1d7e39d75d082b43.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libaddr2line-ade42e945045b261.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libgimli-1a65064fccf4ebc1.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libstd_detect-4d699c310fdfe72d.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_demangle-1cafa68a696ec800.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libhashbrown-e9f1c8c4dab2f046.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_alloc-ecc1a743be25c7f7.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libunwind-e074031c4b66b6b6.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcfg_if-9aa6ed9f1d3bfd53.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/liblibc-7862bf96c2250ca0.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/liballoc-f02ce0dc7895b5fd.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_core-3af9c60917570521.rlib\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-ca16fc7bb3645684.rlib\" \"-Wl,--end-group\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-d8e1a5b7299604cc.rlib\" \"-Wl,-Bdynamic\" \"-lgcc_s\" \"-lutil\" \"-lrt\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-znoexecstack\" \"-L\" \"/home/smit/rustc-dev/rust/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-o\" \"linking_failure\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-nodefaultlibs\"\n  = note: /usr/bin/ld: linking_failure.linking_failure.7rcbfp3g-cgu.3.rcgu.o: in function `linking_failure::main':\n          linking_failure.7rcbfp3g-cgu.3:(.text._ZN15linking_failure4main17h52b6e3052e444479E+0x3): undefined reference to `doesnt_exist_thiwthwfyl'\n          clang: error: linker command failed with exit code 1 (use -v to see invocation)\n\n  = help: some `extern` functions couldn't be found; you may need to install or specify the path to some dependencies\n  = note: use the -L flag to specify the library lookup path\n  = note: use the cargo:rustc-link-search directive to specify the library lookup path with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#rustc-link-search)\n\nerror: aborting due to previous error\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75f2263cf724d125afc2582d4f60df39e8f20097", "html_url": "https://github.com/rust-lang/rust/commit/75f2263cf724d125afc2582d4f60df39e8f20097", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75f2263cf724d125afc2582d4f60df39e8f20097/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1034282bca4402b2a9d913c981002c45dc3e2425", "url": "https://api.github.com/repos/rust-lang/rust/commits/1034282bca4402b2a9d913c981002c45dc3e2425", "html_url": "https://github.com/rust-lang/rust/commit/1034282bca4402b2a9d913c981002c45dc3e2425"}, {"sha": "ce63d55bc7d1a1cd65d175e22787ea964bba0e2a", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce63d55bc7d1a1cd65d175e22787ea964bba0e2a", "html_url": "https://github.com/rust-lang/rust/commit/ce63d55bc7d1a1cd65d175e22787ea964bba0e2a"}], "stats": {"total": 19, "additions": 14, "deletions": 5}, "files": [{"sha": "d47624da79a73f934e68d4cdf6f55cdbbd26c0fb", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/75f2263cf724d125afc2582d4f60df39e8f20097/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75f2263cf724d125afc2582d4f60df39e8f20097/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=75f2263cf724d125afc2582d4f60df39e8f20097", "patch": "@@ -912,14 +912,23 @@ fn link_natively<'a, B: ArchiveBuilder<'a>>(\n             if !prog.status.success() {\n                 let mut output = prog.stderr.clone();\n                 output.extend_from_slice(&prog.stdout);\n-                sess.struct_err(&format!(\n+                let escaped_output = escape_stdout_stderr_string(&output);\n+                let mut err = sess.struct_err(&format!(\n                     \"linking with `{}` failed: {}\",\n                     linker_path.display(),\n                     prog.status\n-                ))\n-                .note(&format!(\"{:?}\", &cmd))\n-                .note(&escape_stdout_stderr_string(&output))\n-                .emit();\n+                ));\n+                err.note(&format!(\"{:?}\", &cmd)).note(&escaped_output);\n+                if escaped_output.contains(\"undefined reference to\") {\n+                    err.help(\n+                        \"some `extern` functions couldn't be found; some native libraries may \\\n+                         need to be installed or have their path specified\",\n+                    );\n+                    err.note(\"use the `-l` flag to specify native libraries to link\");\n+                    err.note(\"use the `cargo:rustc-link-lib` directive to specify the native \\\n+                              libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#cargorustc-link-libkindname)\");\n+                }\n+                err.emit();\n \n                 // If MSVC's `link.exe` was expected but the return code\n                 // is not a Microsoft LNK error then suggest a way to fix or"}]}