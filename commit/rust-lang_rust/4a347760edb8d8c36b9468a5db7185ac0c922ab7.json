{"sha": "4a347760edb8d8c36b9468a5db7185ac0c922ab7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRhMzQ3NzYwZWRiOGQ4YzM2Yjk0NjhhNWRiNzE4NWFjMGM5MjJhYjc=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-07-15T05:24:19Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-07-15T17:07:32Z"}, "message": "Run test functions in isolated tasks. Issue #428\n\nEach test is run in its own task so that the failure can be trapped and the\ntest runner can continue. The easiest way to get the test functions into tasks\ncurrently is by treating them as unsafe pointers.", "tree": {"sha": "6c69b3027f5fe7b0ee1aaabc1423acf6c08744c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6c69b3027f5fe7b0ee1aaabc1423acf6c08744c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a347760edb8d8c36b9468a5db7185ac0c922ab7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a347760edb8d8c36b9468a5db7185ac0c922ab7", "html_url": "https://github.com/rust-lang/rust/commit/4a347760edb8d8c36b9468a5db7185ac0c922ab7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a347760edb8d8c36b9468a5db7185ac0c922ab7/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d475530a0aecbe243813b7cc23136058d114f2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d475530a0aecbe243813b7cc23136058d114f2d", "html_url": "https://github.com/rust-lang/rust/commit/7d475530a0aecbe243813b7cc23136058d114f2d"}], "stats": {"total": 23, "additions": 21, "deletions": 2}, "files": [{"sha": "1ffe59b3842eecd10916b388f7f4b72b74c7788a", "filename": "src/lib/test.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/4a347760edb8d8c36b9468a5db7185ac0c922ab7/src%2Flib%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a347760edb8d8c36b9468a5db7185ac0c922ab7/src%2Flib%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib%2Ftest.rs?ref=4a347760edb8d8c36b9468a5db7185ac0c922ab7", "patch": "@@ -212,13 +212,32 @@ fn filter_tests(&test_opts opts, &test_desc[] tests) -> test_desc[] {\n \n fn run_test(&test_desc test) -> test_result {\n     if (!test.ignore) {\n-        test.fn();\n-        ret tr_ok;\n+        if (run_test_fn_in_task(test.fn)) {\n+            ret tr_ok;\n+        } else {\n+            ret tr_failed;\n+        }\n     } else {\n         ret tr_ignored;\n     }\n }\n \n+// We need to run our tests in another task in order to trap test failures.\n+// But, at least currently, functions can't be used as spawn arguments so\n+// we've got to treat our test functions as unsafe pointers.\n+fn run_test_fn_in_task(&fn() f) -> bool {\n+    fn run_task(*mutable fn() fptr) {\n+        task::unsupervise();\n+        (*fptr)()\n+    }\n+    auto fptr = ptr::addr_of(f);\n+    auto test_task = spawn run_task(fptr);\n+    ret alt (task::join(test_task)) {\n+        task::tr_success { true }\n+        task::tr_failure { false }\n+    }\n+}\n+\n \n // Local Variables:\n // mode: rust;"}]}