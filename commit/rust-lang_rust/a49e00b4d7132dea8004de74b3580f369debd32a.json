{"sha": "a49e00b4d7132dea8004de74b3580f369debd32a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE0OWUwMGI0ZDcxMzJkZWE4MDA0ZGU3NGIzNTgwZjM2OWRlYmQzMmE=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-03-28T09:14:51Z"}, "committer": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-03-28T09:14:51Z"}, "message": "Avoid panicking on macro call with a single comma\n\n`parse_item` from libsyntax may return `None`, so we need to discard\nthe result in that case.", "tree": {"sha": "3f5f9697c7e240070dd16ad8b104d8b0e2acc726", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3f5f9697c7e240070dd16ad8b104d8b0e2acc726"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a49e00b4d7132dea8004de74b3580f369debd32a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a49e00b4d7132dea8004de74b3580f369debd32a", "html_url": "https://github.com/rust-lang/rust/commit/a49e00b4d7132dea8004de74b3580f369debd32a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a49e00b4d7132dea8004de74b3580f369debd32a/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f55350c7d7658cc0701b1b8b83ab7d72591bc43", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f55350c7d7658cc0701b1b8b83ab7d72591bc43", "html_url": "https://github.com/rust-lang/rust/commit/0f55350c7d7658cc0701b1b8b83ab7d72591bc43"}], "stats": {"total": 24, "additions": 14, "deletions": 10}, "files": [{"sha": "649abdca3e7720cabbe0f271e4b35596143cfecf", "filename": "src/macros.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a49e00b4d7132dea8004de74b3580f369debd32a/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a49e00b4d7132dea8004de74b3580f369debd32a/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=a49e00b4d7132dea8004de74b3580f369debd32a", "patch": "@@ -76,8 +76,7 @@ pub enum MacroArg {\n     Expr(ptr::P<ast::Expr>),\n     Ty(ptr::P<ast::Ty>),\n     Pat(ptr::P<ast::Pat>),\n-    // `parse_item` returns `Option<ptr::P<ast::Item>>`.\n-    Item(Option<ptr::P<ast::Item>>),\n+    Item(ptr::P<ast::Item>),\n }\n \n impl Rewrite for ast::Item {\n@@ -96,14 +95,14 @@ impl Rewrite for MacroArg {\n             MacroArg::Expr(ref expr) => expr.rewrite(context, shape),\n             MacroArg::Ty(ref ty) => ty.rewrite(context, shape),\n             MacroArg::Pat(ref pat) => pat.rewrite(context, shape),\n-            MacroArg::Item(ref item) => item.as_ref().and_then(|item| item.rewrite(context, shape)),\n+            MacroArg::Item(ref item) => item.rewrite(context, shape),\n         }\n     }\n }\n \n fn parse_macro_arg(parser: &mut Parser) -> Option<MacroArg> {\n     macro_rules! parse_macro_arg {\n-        ($macro_arg:ident, $parser:ident) => {\n+        ($macro_arg:ident, $parser:ident, $f:expr) => {\n             let mut cloned_parser = (*parser).clone();\n             match cloned_parser.$parser() {\n                 Ok(x) => {\n@@ -112,7 +111,7 @@ fn parse_macro_arg(parser: &mut Parser) -> Option<MacroArg> {\n                     } else {\n                         // Parsing succeeded.\n                         *parser = cloned_parser;\n-                        return Some(MacroArg::$macro_arg(x.clone()));\n+                        return Some(MacroArg::$macro_arg($f(x)?));\n                     }\n                 }\n                 Err(mut e) => {\n@@ -123,10 +122,11 @@ fn parse_macro_arg(parser: &mut Parser) -> Option<MacroArg> {\n         };\n     }\n \n-    parse_macro_arg!(Expr, parse_expr);\n-    parse_macro_arg!(Ty, parse_ty);\n-    parse_macro_arg!(Pat, parse_pat);\n-    parse_macro_arg!(Item, parse_item);\n+    parse_macro_arg!(Expr, parse_expr, |x: ptr::P<ast::Expr>| Some(x));\n+    parse_macro_arg!(Ty, parse_ty, |x: ptr::P<ast::Ty>| Some(x));\n+    parse_macro_arg!(Pat, parse_pat, |x: ptr::P<ast::Pat>| Some(x));\n+    // `parse_item` returns `Option<ptr::P<ast::Item>>`.\n+    parse_macro_arg!(Item, parse_item, |x: Option<ptr::P<ast::Item>>| x);\n \n     None\n }"}, {"sha": "41fa0da8dd1c502f7795a9cd1d04a246c995a7a9", "filename": "src/spanned.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a49e00b4d7132dea8004de74b3580f369debd32a/src%2Fspanned.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a49e00b4d7132dea8004de74b3580f369debd32a/src%2Fspanned.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fspanned.rs?ref=a49e00b4d7132dea8004de74b3580f369debd32a", "patch": "@@ -187,7 +187,7 @@ impl Spanned for MacroArg {\n             MacroArg::Expr(ref expr) => expr.span(),\n             MacroArg::Ty(ref ty) => ty.span(),\n             MacroArg::Pat(ref pat) => pat.span(),\n-            MacroArg::Item(ref item) => item.as_ref().unwrap().span(),\n+            MacroArg::Item(ref item) => item.span(),\n         }\n     }\n }"}, {"sha": "030c56b5f8297139dc1e7e1fe8686d828507b4df", "filename": "tests/source/macros.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a49e00b4d7132dea8004de74b3580f369debd32a/tests%2Fsource%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a49e00b4d7132dea8004de74b3580f369debd32a/tests%2Fsource%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmacros.rs?ref=a49e00b4d7132dea8004de74b3580f369debd32a", "patch": "@@ -10,6 +10,8 @@ peg_file!   modname  (\"mygrammarfile.rustpeg\");\n fn main() {\n     foo! ( );\n \n+    foo!(,);\n+\n     bar!( a , b , c );\n \n     bar!( a , b , c , );"}, {"sha": "0a103d5d61b2dc86e3b2511dc0cb199473ec56de", "filename": "tests/target/macros.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a49e00b4d7132dea8004de74b3580f369debd32a/tests%2Ftarget%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a49e00b4d7132dea8004de74b3580f369debd32a/tests%2Ftarget%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacros.rs?ref=a49e00b4d7132dea8004de74b3580f369debd32a", "patch": "@@ -15,6 +15,8 @@ peg_file! modname(\"mygrammarfile.rustpeg\");\n fn main() {\n     foo!();\n \n+    foo!(,);\n+\n     bar!(a, b, c);\n \n     bar!(a, b, c,);"}]}