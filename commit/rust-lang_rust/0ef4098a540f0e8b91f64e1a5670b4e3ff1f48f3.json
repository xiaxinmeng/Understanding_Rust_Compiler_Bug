{"sha": "0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "node_id": "C_kwDOAAsO6NoAKDBlZjQwOThhNTQwZjBlOGI5MWY2NGUxYTU2NzBiNGUzZmYxZjQ4ZjM", "commit": {"author": {"name": "Chayim Refael Friedman", "email": "chayimfr@gmail.com", "date": "2022-05-24T23:41:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-16T02:19:31Z"}, "message": "Do not suggest adding semicolon/changing delimiters for macros in item position that originates in macros", "tree": {"sha": "83c7c2bfc3a7e460dc67a9e52cdd255aa0c1ed2d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83c7c2bfc3a7e460dc67a9e52cdd255aa0c1ed2d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "html_url": "https://github.com/rust-lang/rust/commit/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/comments", "author": {"login": "ChayimFriedman2", "id": 24700207, "node_id": "MDQ6VXNlcjI0NzAwMjA3", "avatar_url": "https://avatars.githubusercontent.com/u/24700207?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChayimFriedman2", "html_url": "https://github.com/ChayimFriedman2", "followers_url": "https://api.github.com/users/ChayimFriedman2/followers", "following_url": "https://api.github.com/users/ChayimFriedman2/following{/other_user}", "gists_url": "https://api.github.com/users/ChayimFriedman2/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChayimFriedman2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChayimFriedman2/subscriptions", "organizations_url": "https://api.github.com/users/ChayimFriedman2/orgs", "repos_url": "https://api.github.com/users/ChayimFriedman2/repos", "events_url": "https://api.github.com/users/ChayimFriedman2/events{/privacy}", "received_events_url": "https://api.github.com/users/ChayimFriedman2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b31f9cc22bcd720b37ddf927afe378108a5b9a54", "url": "https://api.github.com/repos/rust-lang/rust/commits/b31f9cc22bcd720b37ddf927afe378108a5b9a54", "html_url": "https://github.com/rust-lang/rust/commit/b31f9cc22bcd720b37ddf927afe378108a5b9a54"}], "stats": {"total": 144, "additions": 123, "deletions": 21}, "files": [{"sha": "bf685aa8cadc34005755d89ccade55924b2b79f6", "filename": "compiler/rustc_parse/src/parser/item.rs", "status": "modified", "additions": 25, "deletions": 21, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs?ref=0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "patch": "@@ -1775,30 +1775,34 @@ impl<'a> Parser<'a> {\n             span,\n             \"macros that expand to items must be delimited with braces or followed by a semicolon\",\n         );\n-        if self.unclosed_delims.is_empty() {\n-            let DelimSpan { open, close } = match args {\n-                MacArgs::Empty | MacArgs::Eq(..) => unreachable!(),\n-                MacArgs::Delimited(dspan, ..) => *dspan,\n-            };\n-            err.multipart_suggestion(\n-                \"change the delimiters to curly braces\",\n-                vec![(open, \"{\".to_string()), (close, '}'.to_string())],\n-                Applicability::MaybeIncorrect,\n-            );\n-        } else {\n+        // FIXME: This will make us not emit the help even for declarative\n+        // macros within the same crate (that we can fix), which is sad.\n+        if !span.from_expansion() {\n+            if self.unclosed_delims.is_empty() {\n+                let DelimSpan { open, close } = match args {\n+                    MacArgs::Empty | MacArgs::Eq(..) => unreachable!(),\n+                    MacArgs::Delimited(dspan, ..) => *dspan,\n+                };\n+                err.multipart_suggestion(\n+                    \"change the delimiters to curly braces\",\n+                    vec![(open, \"{\".to_string()), (close, '}'.to_string())],\n+                    Applicability::MaybeIncorrect,\n+                );\n+            } else {\n+                err.span_suggestion(\n+                    span,\n+                    \"change the delimiters to curly braces\",\n+                    \" { /* items */ }\",\n+                    Applicability::HasPlaceholders,\n+                );\n+            }\n             err.span_suggestion(\n-                span,\n-                \"change the delimiters to curly braces\",\n-                \" { /* items */ }\",\n-                Applicability::HasPlaceholders,\n+                span.shrink_to_hi(),\n+                \"add a semicolon\",\n+                ';',\n+                Applicability::MaybeIncorrect,\n             );\n         }\n-        err.span_suggestion(\n-            span.shrink_to_hi(),\n-            \"add a semicolon\",\n-            ';',\n-            Applicability::MaybeIncorrect,\n-        );\n         err.emit();\n     }\n "}, {"sha": "958a8bed9e2d19e4bc2c4786bece56bb7b2641d4", "filename": "src/test/ui/proc-macro/auxiliary/issue-91800-macro.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fissue-91800-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fissue-91800-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fissue-91800-macro.rs?ref=0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "patch": "@@ -0,0 +1,26 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::TokenStream;\n+\n+fn compile_error() -> TokenStream {\n+    r#\"compile_error!(\"\")\"#.parse().unwrap()\n+}\n+\n+#[proc_macro_derive(MyTrait)]\n+pub fn derive(input: TokenStream) -> TokenStream {\n+    compile_error()\n+}\n+#[proc_macro_attribute]\n+pub fn attribute_macro(_attr: TokenStream, mut input: TokenStream) -> TokenStream {\n+    input.extend(compile_error());\n+    input\n+}\n+#[proc_macro]\n+pub fn fn_macro(_item: TokenStream) -> TokenStream {\n+    compile_error()\n+}"}, {"sha": "0c1281de4f8c25ad0060c459fadf5358d2e2c289", "filename": "src/test/ui/proc-macro/issue-91800.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/src%2Ftest%2Fui%2Fproc-macro%2Fissue-91800.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/src%2Ftest%2Fui%2Fproc-macro%2Fissue-91800.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-91800.rs?ref=0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "patch": "@@ -0,0 +1,16 @@\n+// aux-build: issue-91800-macro.rs\n+\n+#[macro_use]\n+extern crate issue_91800_macro;\n+\n+#[derive(MyTrait)]\n+//~^ ERROR macros that expand to items must be delimited with braces or followed by a semicolon\n+//~| ERROR proc-macro derive produced unparseable tokens\n+#[attribute_macro]\n+//~^ ERROR macros that expand to items must be delimited with braces or followed by a semicolon\n+struct MyStruct;\n+\n+fn_macro! {}\n+//~^ ERROR macros that expand to items must be delimited with braces or followed by a semicolon\n+\n+fn main() {}"}, {"sha": "9c356263a36b20ae2ee69b2d484ffe1a418f90de", "filename": "src/test/ui/proc-macro/issue-91800.stderr", "status": "added", "additions": 56, "deletions": 0, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/src%2Ftest%2Fui%2Fproc-macro%2Fissue-91800.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3/src%2Ftest%2Fui%2Fproc-macro%2Fissue-91800.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-91800.stderr?ref=0ef4098a540f0e8b91f64e1a5670b4e3ff1f48f3", "patch": "@@ -0,0 +1,56 @@\n+error: macros that expand to items must be delimited with braces or followed by a semicolon\n+  --> $DIR/issue-91800.rs:6:10\n+   |\n+LL | #[derive(MyTrait)]\n+   |          ^^^^^^^\n+   |\n+   = note: this error originates in the derive macro `MyTrait` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: proc-macro derive produced unparseable tokens\n+  --> $DIR/issue-91800.rs:6:10\n+   |\n+LL | #[derive(MyTrait)]\n+   |          ^^^^^^^\n+\n+error: \n+  --> $DIR/issue-91800.rs:6:10\n+   |\n+LL | #[derive(MyTrait)]\n+   |          ^^^^^^^\n+   |\n+   = note: this error originates in the derive macro `MyTrait` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: macros that expand to items must be delimited with braces or followed by a semicolon\n+  --> $DIR/issue-91800.rs:9:1\n+   |\n+LL | #[attribute_macro]\n+   | ^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: this error originates in the attribute macro `attribute_macro` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: \n+  --> $DIR/issue-91800.rs:9:1\n+   |\n+LL | #[attribute_macro]\n+   | ^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: this error originates in the attribute macro `attribute_macro` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: macros that expand to items must be delimited with braces or followed by a semicolon\n+  --> $DIR/issue-91800.rs:13:1\n+   |\n+LL | fn_macro! {}\n+   | ^^^^^^^^^^^^\n+   |\n+   = note: this error originates in the macro `fn_macro` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: \n+  --> $DIR/issue-91800.rs:13:1\n+   |\n+LL | fn_macro! {}\n+   | ^^^^^^^^^^^^\n+   |\n+   = note: this error originates in the macro `fn_macro` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 7 previous errors\n+"}]}