{"sha": "a359a1f2e31e9d03947197f5ab179aa59361fdd5", "node_id": "C_kwDOAAsO6NoAKGEzNTlhMWYyZTMxZTlkMDM5NDcxOTdmNWFiMTc5YWE1OTM2MWZkZDU", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-10-03T09:09:49Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-10-03T09:09:49Z"}, "message": "Fix extract_variable not allowing to extract macro calls", "tree": {"sha": "5d0079fbfcc778c1062a8d4364ac6f03b2810f7b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d0079fbfcc778c1062a8d4364ac6f03b2810f7b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a359a1f2e31e9d03947197f5ab179aa59361fdd5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a359a1f2e31e9d03947197f5ab179aa59361fdd5", "html_url": "https://github.com/rust-lang/rust/commit/a359a1f2e31e9d03947197f5ab179aa59361fdd5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a359a1f2e31e9d03947197f5ab179aa59361fdd5/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "745fd9903c804a6810cd3a1e050116f2c3575ac0", "url": "https://api.github.com/repos/rust-lang/rust/commits/745fd9903c804a6810cd3a1e050116f2c3575ac0", "html_url": "https://github.com/rust-lang/rust/commit/745fd9903c804a6810cd3a1e050116f2c3575ac0"}], "stats": {"total": 31, "additions": 20, "deletions": 11}, "files": [{"sha": "55e5da7fe7f5d58d855c3880d598a6ee91514e0b", "filename": "crates/ide_assists/src/handlers/extract_variable.rs", "status": "modified", "additions": 20, "deletions": 11, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/a359a1f2e31e9d03947197f5ab179aa59361fdd5/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_variable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a359a1f2e31e9d03947197f5ab179aa59361fdd5/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_variable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_variable.rs?ref=a359a1f2e31e9d03947197f5ab179aa59361fdd5", "patch": "@@ -1,6 +1,7 @@\n use stdx::format_to;\n use syntax::{\n     ast::{self, AstNode},\n+    NodeOrToken,\n     SyntaxKind::{\n         BLOCK_EXPR, BREAK_EXPR, CLOSURE_EXPR, COMMENT, LOOP_EXPR, MATCH_ARM, MATCH_GUARD,\n         PATH_EXPR, RETURN_EXPR,\n@@ -30,20 +31,26 @@ pub(crate) fn extract_variable(acc: &mut Assists, ctx: &AssistContext) -> Option\n     if ctx.frange.range.is_empty() {\n         return None;\n     }\n-    let node = ctx.covering_element();\n-    if node.kind() == COMMENT {\n-        cov_mark::hit!(extract_var_in_comment_is_not_applicable);\n-        return None;\n-    }\n+    let node = match ctx.covering_element() {\n+        NodeOrToken::Node(it) => it,\n+        NodeOrToken::Token(it) if it.kind() == COMMENT => {\n+            cov_mark::hit!(extract_var_in_comment_is_not_applicable);\n+            return None;\n+        }\n+        NodeOrToken::Token(it) => it.parent()?,\n+    };\n+    let node = node.ancestors().take_while(|anc| anc.text_range() == node.text_range()).last()?;\n     let to_extract = node\n-        .ancestors()\n-        .take_while(|it| it.text_range().contains_range(ctx.frange.range))\n+        .descendants()\n+        .take_while(|it| ctx.frange.range.contains_range(it.text_range()))\n         .find_map(valid_target_expr)?;\n+\n     if let Some(ty_info) = ctx.sema.type_of_expr(&to_extract) {\n         if ty_info.adjusted().is_unit() {\n             return None;\n         }\n     }\n+\n     let anchor = Anchor::from(&to_extract)?;\n     let indent = anchor.syntax().prev_sibling_or_token()?.as_token()?.clone();\n     let target = to_extract.syntax().text_range();\n@@ -146,8 +153,11 @@ enum Anchor {\n \n impl Anchor {\n     fn from(to_extract: &ast::Expr) -> Option<Anchor> {\n-        to_extract.syntax().ancestors().take_while(|it| !ast::Item::can_cast(it.kind())).find_map(\n-            |node| {\n+        to_extract\n+            .syntax()\n+            .ancestors()\n+            .take_while(|it| !ast::Item::can_cast(it.kind()) || ast::MacroCall::can_cast(it.kind()))\n+            .find_map(|node| {\n                 if let Some(expr) =\n                     node.parent().and_then(ast::StmtList::cast).and_then(|it| it.tail_expr())\n                 {\n@@ -181,8 +191,7 @@ impl Anchor {\n                     return Some(Anchor::Before(node));\n                 }\n                 None\n-            },\n-        )\n+            })\n     }\n \n     fn syntax(&self) -> &SyntaxNode {"}]}