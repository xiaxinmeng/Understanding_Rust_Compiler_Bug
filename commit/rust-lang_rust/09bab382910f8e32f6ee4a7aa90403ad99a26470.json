{"sha": "09bab382910f8e32f6ee4a7aa90403ad99a26470", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5YmFiMzgyOTEwZjhlMzJmNmVlNGE3YWE5MDQwM2FkOTlhMjY0NzA=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2021-03-22T17:09:33Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.de", "date": "2021-03-26T08:59:10Z"}, "message": "Fix #83045 by moving some crate loading verification code to a better place.", "tree": {"sha": "ef0a22fc8e838924f7d415d06f933401568404d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ef0a22fc8e838924f7d415d06f933401568404d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/09bab382910f8e32f6ee4a7aa90403ad99a26470", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/09bab382910f8e32f6ee4a7aa90403ad99a26470", "html_url": "https://github.com/rust-lang/rust/commit/09bab382910f8e32f6ee4a7aa90403ad99a26470", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/09bab382910f8e32f6ee4a7aa90403ad99a26470/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bba40880c0750f880119b4517821ffe0a96f74d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/bba40880c0750f880119b4517821ffe0a96f74d1", "html_url": "https://github.com/rust-lang/rust/commit/bba40880c0750f880119b4517821ffe0a96f74d1"}], "stats": {"total": 47, "additions": 44, "deletions": 3}, "files": [{"sha": "9578f5d58638e6504ec9bd253660acce70b48c49", "filename": "compiler/rustc_metadata/src/creader.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/09bab382910f8e32f6ee4a7aa90403ad99a26470/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09bab382910f8e32f6ee4a7aa90403ad99a26470/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs?ref=09bab382910f8e32f6ee4a7aa90403ad99a26470", "patch": "@@ -350,16 +350,13 @@ impl<'a> CrateLoader<'a> {\n         let Library { source, metadata } = lib;\n         let crate_root = metadata.get_root();\n         let host_hash = host_lib.as_ref().map(|lib| lib.metadata.get_root().hash());\n-        self.verify_no_symbol_conflicts(&crate_root)?;\n \n         let private_dep =\n             self.sess.opts.externs.get(&name.as_str()).map_or(false, |e| e.is_private_dep);\n \n         // Claim this crate number and cache it\n         let cnum = self.cstore.alloc_new_crate_num();\n \n-        self.verify_no_stable_crate_id_hash_conflicts(&crate_root, cnum)?;\n-\n         info!(\n             \"register crate `{}` (cnum = {}. private_dep = {})\",\n             crate_root.name(),\n@@ -394,6 +391,14 @@ impl<'a> CrateLoader<'a> {\n             None\n         };\n \n+        // Perform some verification *after* resolve_crate_deps() above is\n+        // known to have been successful. It seems that - in error cases - the\n+        // cstore can be in a temporarily invalid state between cnum allocation\n+        // and dependency resolution and the verification code would produce\n+        // ICEs in that case (see #83045).\n+        self.verify_no_symbol_conflicts(&crate_root)?;\n+        self.verify_no_stable_crate_id_hash_conflicts(&crate_root, cnum)?;\n+\n         let crate_metadata = CrateMetadata::new(\n             self.sess,\n             metadata,"}, {"sha": "34853cb1d31e57928f53febc70e97fee5e13a694", "filename": "src/test/run-make-fulldeps/issue-83045/Makefile", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2FMakefile?ref=09bab382910f8e32f6ee4a7aa90403ad99a26470", "patch": "@@ -0,0 +1,33 @@\n+include ../../run-make-fulldeps/tools.mk\n+\n+# This test case creates a situation where the crate loader would run\n+# into an ICE when confronted with an invalid setup where it cannot\n+# find the dependency of a direct dependency.\n+#\n+# The test case makes sure that the compiler produces the expected\n+# error message but does not ICE immediately after.\n+#\n+# See https://github.com/rust-lang/rust/issues/83045\n+\n+# This is a platform-independent issue, no need to waste time testing\n+# everywhere.\n+# only-x86_64\n+# only-linux\n+\n+# NOTE: We use BARE_RUSTC below so that the compiler can't find liba.rlib\n+#       If we used RUSTC the additional '-L TMPDIR' option would allow rustc to\n+#       actually find the crate.\n+#\n+#       We check that we get the expected error message\n+#       But that we do not get an ICE\n+\n+all:\n+\t$(RUSTC) --crate-name=a --crate-type=rlib a.rs --verbose\n+\t$(RUSTC) --crate-name=b --crate-type=rlib --extern a=$(TMPDIR)/liba.rlib b.rs --verbose\n+\t$(BARE_RUSTC) --out-dir $(TMPDIR) \\\n+\t              --extern b=$(TMPDIR)/libb.rlib \\\n+\t\t\t\t  --crate-type=rlib \\\n+\t\t\t\t  --edition=2018 \\\n+\t\t\t\t  c.rs 2>&1 | tee $(TMPDIR)/output.txt || exit 0\n+\t$(CGREP) E0463 < $(TMPDIR)/output.txt\n+\t$(CGREP) -v \"internal compiler error\" < $(TMPDIR)/output.txt"}, {"sha": "66d9f758e9dde91e34fa87eb0b33161b1cac5e68", "filename": "src/test/run-make-fulldeps/issue-83045/a.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fa.rs?ref=09bab382910f8e32f6ee4a7aa90403ad99a26470", "patch": "@@ -0,0 +1 @@\n+// empty on purpose"}, {"sha": "f4876cfa45736b96a43220f327316a896bed5cc5", "filename": "src/test/run-make-fulldeps/issue-83045/b.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fb.rs?ref=09bab382910f8e32f6ee4a7aa90403ad99a26470", "patch": "@@ -0,0 +1 @@\n+extern crate a;"}, {"sha": "e0c4525499ed7150a9cb3e5167ed7b37a7ce5ebe", "filename": "src/test/run-make-fulldeps/issue-83045/c.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09bab382910f8e32f6ee4a7aa90403ad99a26470/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-83045%2Fc.rs?ref=09bab382910f8e32f6ee4a7aa90403ad99a26470", "patch": "@@ -0,0 +1 @@\n+use b as _;"}]}