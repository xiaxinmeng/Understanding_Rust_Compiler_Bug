{"sha": "e4c28bf61a0631b6bf4bd9e53da53611399c1129", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0YzI4YmY2MWEwNjMxYjZiZjRiZDllNTNkYTUzNjExMzk5YzExMjk=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-09-14T00:15:01Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-09-14T00:15:01Z"}, "message": "Upgrade to pulldown-cmark 0.8.0\n\nThanks to marcusklaas' hard work in https://github.com/raphlinus/pulldown-cmark/pull/469, this fixes a lot of rustdoc bugs!\n\n- Get rid of unnecessary `RefCell`\n- Fix duplicate warnings for broken implicit reference link\n- Remove unnecessary copy of links", "tree": {"sha": "4780dc3538dcd76a7c214eb37d01c7f4cb25f7a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4780dc3538dcd76a7c214eb37d01c7f4cb25f7a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e4c28bf61a0631b6bf4bd9e53da53611399c1129", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e4c28bf61a0631b6bf4bd9e53da53611399c1129", "html_url": "https://github.com/rust-lang/rust/commit/e4c28bf61a0631b6bf4bd9e53da53611399c1129", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e4c28bf61a0631b6bf4bd9e53da53611399c1129/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7402a394471a6738a40fea7d4f1891666e5a80c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/7402a394471a6738a40fea7d4f1891666e5a80c5", "html_url": "https://github.com/rust-lang/rust/commit/7402a394471a6738a40fea7d4f1891666e5a80c5"}], "stats": {"total": 70, "additions": 50, "deletions": 20}, "files": [{"sha": "acf7980a0354c4743d4bb4059988dc9698cd60c7", "filename": "Cargo.lock", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e4c28bf61a0631b6bf4bd9e53da53611399c1129/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/e4c28bf61a0631b6bf4bd9e53da53611399c1129/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=e4c28bf61a0631b6bf4bd9e53da53611399c1129", "patch": "@@ -534,7 +534,7 @@ dependencies = [\n  \"if_chain\",\n  \"itertools 0.9.0\",\n  \"lazy_static\",\n- \"pulldown-cmark\",\n+ \"pulldown-cmark 0.7.2\",\n  \"quine-mc_cluskey\",\n  \"quote\",\n  \"regex-syntax\",\n@@ -1844,7 +1844,7 @@ dependencies = [\n  \"log\",\n  \"memchr\",\n  \"open\",\n- \"pulldown-cmark\",\n+ \"pulldown-cmark 0.7.2\",\n  \"regex\",\n  \"serde\",\n  \"serde_derive\",\n@@ -2502,6 +2502,17 @@ dependencies = [\n  \"unicase\",\n ]\n \n+[[package]]\n+name = \"pulldown-cmark\"\n+version = \"0.8.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"ffade02495f22453cd593159ea2f59827aae7f53fa8323f756799b670881dcf8\"\n+dependencies = [\n+ \"bitflags\",\n+ \"memchr\",\n+ \"unicase\",\n+]\n+\n [[package]]\n name = \"punycode\"\n version = \"0.4.1\"\n@@ -4112,7 +4123,7 @@ dependencies = [\n  \"expect-test\",\n  \"itertools 0.9.0\",\n  \"minifier\",\n- \"pulldown-cmark\",\n+ \"pulldown-cmark 0.8.0\",\n  \"rustc-rayon\",\n  \"serde\",\n  \"serde_json\","}, {"sha": "a40a44fe27da3edb9aace137a22d08ed93c4239a", "filename": "src/librustdoc/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Flibrustdoc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Flibrustdoc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2FCargo.toml?ref=e4c28bf61a0631b6bf4bd9e53da53611399c1129", "patch": "@@ -8,7 +8,7 @@ edition = \"2018\"\n path = \"lib.rs\"\n \n [dependencies]\n-pulldown-cmark = { version = \"0.7\", default-features = false }\n+pulldown-cmark = { version = \"0.8\", default-features = false }\n minifier = \"0.0.33\"\n rayon = { version = \"0.3.0\", package = \"rustc-rayon\" }\n serde = { version = \"1.0\", features = [\"derive\"] }"}, {"sha": "178c9b0fad38a2a02fec8037ac304fe08fb0a604", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 18, "deletions": 16, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=e4c28bf61a0631b6bf4bd9e53da53611399c1129", "patch": "@@ -27,7 +27,6 @@ use rustc_session::lint;\n use rustc_span::edition::Edition;\n use rustc_span::Span;\n use std::borrow::Cow;\n-use std::cell::RefCell;\n use std::collections::VecDeque;\n use std::default::Default;\n use std::fmt::Write;\n@@ -39,7 +38,7 @@ use crate::doctest;\n use crate::html::highlight;\n use crate::html::toc::TocBuilder;\n \n-use pulldown_cmark::{html, CodeBlockKind, CowStr, Event, Options, Parser, Tag};\n+use pulldown_cmark::{html, BrokenLink, CodeBlockKind, CowStr, Event, Options, Parser, Tag};\n \n #[cfg(test)]\n mod tests;\n@@ -931,15 +930,17 @@ impl Markdown<'_> {\n         if md.is_empty() {\n             return String::new();\n         }\n-        let replacer = |_: &str, s: &str| {\n-            if let Some(link) = links.iter().find(|link| &*link.original_text == s) {\n-                Some((link.href.clone(), link.new_text.clone()))\n+        let mut replacer = |broken_link: BrokenLink<'_>| {\n+            if let Some(link) =\n+                links.iter().find(|link| &*link.original_text == broken_link.reference)\n+            {\n+                Some((CowStr::Borrowed(&link.href), CowStr::Borrowed(&link.new_text)))\n             } else {\n                 None\n             }\n         };\n \n-        let p = Parser::new_with_broken_link_callback(md, opts(), Some(&replacer));\n+        let p = Parser::new_with_broken_link_callback(md, opts(), Some(&mut replacer));\n \n         let mut s = String::with_capacity(md.len() * 3 / 2);\n \n@@ -1009,9 +1010,11 @@ impl MarkdownSummaryLine<'_> {\n             return String::new();\n         }\n \n-        let replacer = |_: &str, s: &str| {\n-            if let Some(link) = links.iter().find(|link| &*link.original_text == s) {\n-                Some((link.href.clone(), link.new_text.clone()))\n+        let mut replacer = |broken_link: BrokenLink<'_>| {\n+            if let Some(link) =\n+                links.iter().find(|link| &*link.original_text == broken_link.reference)\n+            {\n+                Some((CowStr::Borrowed(&link.href), CowStr::Borrowed(&link.new_text)))\n             } else {\n                 None\n             }\n@@ -1020,7 +1023,7 @@ impl MarkdownSummaryLine<'_> {\n         let p = Parser::new_with_broken_link_callback(\n             md,\n             Options::ENABLE_STRIKETHROUGH,\n-            Some(&replacer),\n+            Some(&mut replacer),\n         );\n \n         let mut s = String::new();\n@@ -1067,7 +1070,7 @@ pub fn markdown_links(md: &str) -> Vec<(String, Option<Range<usize>>)> {\n     }\n \n     let mut links = vec![];\n-    let shortcut_links = RefCell::new(vec![]);\n+    let mut shortcut_links = vec![];\n \n     {\n         let locate = |s: &str| unsafe {\n@@ -1084,11 +1087,11 @@ pub fn markdown_links(md: &str) -> Vec<(String, Option<Range<usize>>)> {\n             }\n         };\n \n-        let push = |_: &str, s: &str| {\n-            shortcut_links.borrow_mut().push((s.to_owned(), locate(s)));\n+        let mut push = |link: BrokenLink<'_>| {\n+            shortcut_links.push((link.reference.to_owned(), Some(link.span)));\n             None\n         };\n-        let p = Parser::new_with_broken_link_callback(md, opts(), Some(&push));\n+        let p = Parser::new_with_broken_link_callback(md, opts(), Some(&mut push));\n \n         // There's no need to thread an IdMap through to here because\n         // the IDs generated aren't going to be emitted anywhere.\n@@ -1106,8 +1109,7 @@ pub fn markdown_links(md: &str) -> Vec<(String, Option<Range<usize>>)> {\n         }\n     }\n \n-    let mut shortcut_links = shortcut_links.into_inner();\n-    links.extend(shortcut_links.drain(..));\n+    links.append(&mut shortcut_links);\n \n     links\n }"}, {"sha": "a01211c4f32b1b8479e37c37cf476be43a6c1339", "filename": "src/test/rustdoc-ui/intra-link-double-anchor.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Ftest%2Frustdoc-ui%2Fintra-link-double-anchor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Ftest%2Frustdoc-ui%2Fintra-link-double-anchor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-link-double-anchor.rs?ref=e4c28bf61a0631b6bf4bd9e53da53611399c1129", "patch": "@@ -0,0 +1,7 @@\n+// check-pass\n+\n+// regression test for #73264\n+// should only give one error\n+/// docs [label][with#anchor#error]\n+//~^ WARNING multiple anchors\n+pub struct S;"}, {"sha": "55636d5c2f4b5d8cae0b34983257d18a29b102a0", "filename": "src/test/rustdoc-ui/intra-link-double-anchor.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Ftest%2Frustdoc-ui%2Fintra-link-double-anchor.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e4c28bf61a0631b6bf4bd9e53da53611399c1129/src%2Ftest%2Frustdoc-ui%2Fintra-link-double-anchor.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-link-double-anchor.stderr?ref=e4c28bf61a0631b6bf4bd9e53da53611399c1129", "patch": "@@ -0,0 +1,10 @@\n+warning: `with#anchor#error` contains multiple anchors\n+  --> $DIR/intra-link-double-anchor.rs:5:10\n+   |\n+LL | /// docs [label][with#anchor#error]\n+   |          ^^^^^^^^^^^^^^^^^^^^^^^^^^ contains invalid anchor\n+   |\n+   = note: `#[warn(broken_intra_doc_links)]` on by default\n+\n+warning: 1 warning emitted\n+"}]}