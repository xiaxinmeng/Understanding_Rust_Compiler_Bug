{"sha": "ada714d9ce80748d6820565135397e46662ace9b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkYTcxNGQ5Y2U4MDc0OGQ2ODIwNTY1MTM1Mzk3ZTQ2NjYyYWNlOWI=", "commit": {"author": {"name": "Kogia-sima", "email": "orcinus4627@gmail.com", "date": "2021-01-28T17:27:20Z"}, "committer": {"name": "Kogia-sima", "email": "orcinus4627@gmail.com", "date": "2021-01-28T17:27:20Z"}, "message": "Optimize udiv_1e19() function", "tree": {"sha": "d2ecf82211b38881ffdd93cde55e5ffd13335da9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2ecf82211b38881ffdd93cde55e5ffd13335da9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ada714d9ce80748d6820565135397e46662ace9b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ada714d9ce80748d6820565135397e46662ace9b", "html_url": "https://github.com/rust-lang/rust/commit/ada714d9ce80748d6820565135397e46662ace9b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ada714d9ce80748d6820565135397e46662ace9b/comments", "author": {"login": "Kogia-sima", "id": 20660712, "node_id": "MDQ6VXNlcjIwNjYwNzEy", "avatar_url": "https://avatars.githubusercontent.com/u/20660712?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kogia-sima", "html_url": "https://github.com/Kogia-sima", "followers_url": "https://api.github.com/users/Kogia-sima/followers", "following_url": "https://api.github.com/users/Kogia-sima/following{/other_user}", "gists_url": "https://api.github.com/users/Kogia-sima/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kogia-sima/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kogia-sima/subscriptions", "organizations_url": "https://api.github.com/users/Kogia-sima/orgs", "repos_url": "https://api.github.com/users/Kogia-sima/repos", "events_url": "https://api.github.com/users/Kogia-sima/events{/privacy}", "received_events_url": "https://api.github.com/users/Kogia-sima/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Kogia-sima", "id": 20660712, "node_id": "MDQ6VXNlcjIwNjYwNzEy", "avatar_url": "https://avatars.githubusercontent.com/u/20660712?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kogia-sima", "html_url": "https://github.com/Kogia-sima", "followers_url": "https://api.github.com/users/Kogia-sima/followers", "following_url": "https://api.github.com/users/Kogia-sima/following{/other_user}", "gists_url": "https://api.github.com/users/Kogia-sima/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kogia-sima/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kogia-sima/subscriptions", "organizations_url": "https://api.github.com/users/Kogia-sima/orgs", "repos_url": "https://api.github.com/users/Kogia-sima/repos", "events_url": "https://api.github.com/users/Kogia-sima/events{/privacy}", "received_events_url": "https://api.github.com/users/Kogia-sima/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b", "url": "https://api.github.com/repos/rust-lang/rust/commits/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b", "html_url": "https://github.com/rust-lang/rust/commit/643a79af3d5a31fa87c8a4c9d7f8bc4ebe2add4b"}], "stats": {"total": 55, "additions": 36, "deletions": 19}, "files": [{"sha": "cdd731fdd4d4e34aa65ef93f84c86a9d6247777c", "filename": "library/core/src/fmt/num.rs", "status": "modified", "additions": 36, "deletions": 19, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/ada714d9ce80748d6820565135397e46662ace9b/library%2Fcore%2Fsrc%2Ffmt%2Fnum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ada714d9ce80748d6820565135397e46662ace9b/library%2Fcore%2Fsrc%2Ffmt%2Fnum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Ffmt%2Fnum.rs?ref=ada714d9ce80748d6820565135397e46662ace9b", "patch": "@@ -643,25 +643,42 @@ fn fmt_u128(n: u128, is_nonnegative: bool, f: &mut fmt::Formatter<'_>) -> fmt::R\n }\n \n /// Partition of `n` into n > 1e19 and rem <= 1e19\n+///\n+/// Integer division algorithm is based on the following paper:\n+///\n+///   T. Granlund and P. Montgomery, \u201cDivision by Invariant Integers Using Multiplication\u201d\n+///   in Proc. of the SIGPLAN94 Conference on Programming Language Design and\n+///   Implementation, 1994, pp. 61\u201372\n+///\n fn udiv_1e19(n: u128) -> (u128, u64) {\n     const DIV: u64 = 1e19 as u64;\n-    let high = (n >> 64) as u64;\n-    if high == 0 {\n-        let low = n as u64;\n-        return ((low / DIV) as u128, low % DIV);\n-    }\n-    let sr = 65 - high.leading_zeros();\n-    let mut q = n << (128 - sr);\n-    let mut r = n >> sr;\n-    let mut carry = 0;\n-\n-    for _ in 0..sr {\n-        r = (r << 1) | (q >> 127);\n-        q = (q << 1) | carry as u128;\n-\n-        let s = (DIV as u128).wrapping_sub(r).wrapping_sub(1) as i128 >> 127;\n-        carry = (s & 1) as u64;\n-        r -= (DIV as u128) & s as u128;\n-    }\n-    ((q << 1) | carry as u128, r as u64)\n+    const FACTOR: u128 = 156927543384667019095894735580191660403;\n+\n+    let quot = if n < 1 << 83 {\n+        ((n >> 19) as u64 / (DIV >> 19)) as u128\n+    } else {\n+        u128_mulhi(n, FACTOR) >> 62\n+    };\n+\n+    let rem = (n - quot * DIV as u128) as u64;\n+    (quot, rem)\n+}\n+\n+/// Multiply unsigned 128 bit integers, return upper 128 bits of the result\n+#[inline]\n+fn u128_mulhi(x: u128, y: u128) -> u128 {\n+    let x_lo = x as u64;\n+    let x_hi = (x >> 64) as u64;\n+    let y_lo = y as u64;\n+    let y_hi = (y >> 64) as u64;\n+\n+    // handle possibility of overflow\n+    let carry = (x_lo as u128 * y_lo as u128) >> 64;\n+    let m = x_lo as u128 * y_hi as u128 + carry;\n+    let high1 = m >> 64;\n+\n+    let m_lo = m as u64;\n+    let high2 = (x_hi as u128 * y_lo as u128 + m_lo as u128) >> 64;\n+\n+    x_hi as u128 * y_hi as u128 + high1 + high2\n }"}]}