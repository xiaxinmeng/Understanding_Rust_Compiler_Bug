{"sha": "39329d1d404d38437270acf3cb1337a231367efc", "node_id": "C_kwDOAAsO6NoAKDM5MzI5ZDFkNDA0ZDM4NDM3MjcwYWNmM2NiMTMzN2EyMzEzNjdlZmM", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-03-17T20:04:45Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-03-17T23:57:35Z"}, "message": "Add lint `cast_enum_constructor`", "tree": {"sha": "8cfda07b3ed78e15e0d04983ecc692ec7f95b8b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8cfda07b3ed78e15e0d04983ecc692ec7f95b8b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39329d1d404d38437270acf3cb1337a231367efc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39329d1d404d38437270acf3cb1337a231367efc", "html_url": "https://github.com/rust-lang/rust/commit/39329d1d404d38437270acf3cb1337a231367efc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39329d1d404d38437270acf3cb1337a231367efc/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "65e5cd0e95b9854a0d8c0cae34e9d923d52ae12d", "url": "https://api.github.com/repos/rust-lang/rust/commits/65e5cd0e95b9854a0d8c0cae34e9d923d52ae12d", "html_url": "https://github.com/rust-lang/rust/commit/65e5cd0e95b9854a0d8c0cae34e9d923d52ae12d"}], "stats": {"total": 79, "additions": 79, "deletions": 0}, "files": [{"sha": "04e072d0abf61d95ec780fe8b949028fba1aa0f9", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -3069,6 +3069,7 @@ Released 2018-09-13\n [`bytes_nth`]: https://rust-lang.github.io/rust-clippy/master/index.html#bytes_nth\n [`cargo_common_metadata`]: https://rust-lang.github.io/rust-clippy/master/index.html#cargo_common_metadata\n [`case_sensitive_file_extension_comparisons`]: https://rust-lang.github.io/rust-clippy/master/index.html#case_sensitive_file_extension_comparisons\n+[`cast_enum_constructor`]: https://rust-lang.github.io/rust-clippy/master/index.html#cast_enum_constructor\n [`cast_enum_truncation`]: https://rust-lang.github.io/rust-clippy/master/index.html#cast_enum_truncation\n [`cast_lossless`]: https://rust-lang.github.io/rust-clippy/master/index.html#cast_lossless\n [`cast_possible_truncation`]: https://rust-lang.github.io/rust-clippy/master/index.html#cast_possible_truncation"}, {"sha": "1973692e105f74050c0d191185667111aefcd061", "filename": "clippy_lints/src/casts/cast_enum_constructor.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Fcasts%2Fcast_enum_constructor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Fcasts%2Fcast_enum_constructor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Fcast_enum_constructor.rs?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -0,0 +1,21 @@\n+use clippy_utils::diagnostics::span_lint;\n+use rustc_hir::def::{CtorKind, CtorOf, DefKind, Res};\n+use rustc_hir::{Expr, ExprKind};\n+use rustc_lint::LateContext;\n+use rustc_middle::ty::{self, Ty};\n+\n+use super::CAST_ENUM_CONSTRUCTOR;\n+\n+pub(super) fn check(cx: &LateContext<'_>, expr: &Expr<'_>, cast_expr: &Expr<'_>, cast_from: Ty<'_>) {\n+    if matches!(cast_from.kind(), ty::FnDef(..))\n+        && let ExprKind::Path(path) = &cast_expr.kind\n+        && let Res::Def(DefKind::Ctor(CtorOf::Variant, CtorKind::Fn), _) = cx.qpath_res(path, cast_expr.hir_id)\n+    {\n+        span_lint(\n+            cx,\n+            CAST_ENUM_CONSTRUCTOR,\n+            expr.span,\n+            \"cast of an enum tuple constructor to an integer\",\n+        );\n+    }\n+}"}, {"sha": "be59145afa0032a3cd7c8882c770dd48f4a53288", "filename": "clippy_lints/src/casts/mod.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -1,3 +1,4 @@\n+mod cast_enum_constructor;\n mod cast_lossless;\n mod cast_possible_truncation;\n mod cast_possible_wrap;\n@@ -454,6 +455,24 @@ declare_clippy_lint! {\n     \"casting using `as` between raw pointers to slices of types with different sizes\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for casts from an enum tuple constructor to an integer.\n+    ///\n+    /// ### Why is this bad?\n+    /// The cast is easily confused with casting a c-like enum value to an integer.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// enum E { X(i32) };\n+    /// let _ = E::X as usize;\n+    /// ```\n+    #[clippy::version = \"1.61.0\"]\n+    pub CAST_ENUM_CONSTRUCTOR,\n+    suspicious,\n+    \"casts from an enum tuple constructor to an integer\"\n+}\n+\n pub struct Casts {\n     msrv: Option<RustcVersion>,\n }\n@@ -481,6 +500,7 @@ impl_lint_pass!(Casts => [\n     CHAR_LIT_AS_U8,\n     PTR_AS_PTR,\n     CAST_ENUM_TRUNCATION,\n+    CAST_ENUM_CONSTRUCTOR\n ]);\n \n impl<'tcx> LateLintPass<'tcx> for Casts {\n@@ -518,6 +538,7 @@ impl<'tcx> LateLintPass<'tcx> for Casts {\n                     cast_sign_loss::check(cx, expr, cast_expr, cast_from, cast_to);\n                 }\n                 cast_lossless::check(cx, expr, cast_expr, cast_from, cast_to, &self.msrv);\n+                cast_enum_constructor::check(cx, expr, cast_expr, cast_from);\n             }\n         }\n "}, {"sha": "e360757f781fe7b8495693aaf177be50bca77c51", "filename": "clippy_lints/src/lib.register_all.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Flib.register_all.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Flib.register_all.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_all.rs?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -23,6 +23,7 @@ store.register_group(true, \"clippy::all\", Some(\"clippy_all\"), vec![\n     LintId::of(bool_assert_comparison::BOOL_ASSERT_COMPARISON),\n     LintId::of(booleans::LOGIC_BUG),\n     LintId::of(booleans::NONMINIMAL_BOOL),\n+    LintId::of(casts::CAST_ENUM_CONSTRUCTOR),\n     LintId::of(casts::CAST_ENUM_TRUNCATION),\n     LintId::of(casts::CAST_REF_TO_MUT),\n     LintId::of(casts::CAST_SLICE_DIFFERENT_SIZES),"}, {"sha": "a1a9ca37c95b923c19fa189e6bc2b0d132feef10", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -70,6 +70,7 @@ store.register_lints(&[\n     cargo::REDUNDANT_FEATURE_NAMES,\n     cargo::WILDCARD_DEPENDENCIES,\n     case_sensitive_file_extension_comparisons::CASE_SENSITIVE_FILE_EXTENSION_COMPARISONS,\n+    casts::CAST_ENUM_CONSTRUCTOR,\n     casts::CAST_ENUM_TRUNCATION,\n     casts::CAST_LOSSLESS,\n     casts::CAST_POSSIBLE_TRUNCATION,"}, {"sha": "fa3a88e1368ce5cde3ff9aee911e993d4231c604", "filename": "clippy_lints/src/lib.register_suspicious.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_suspicious.rs?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -7,6 +7,7 @@ store.register_group(true, \"clippy::suspicious\", Some(\"clippy_suspicious\"), vec!\n     LintId::of(attrs::BLANKET_CLIPPY_RESTRICTION_LINTS),\n     LintId::of(await_holding_invalid::AWAIT_HOLDING_LOCK),\n     LintId::of(await_holding_invalid::AWAIT_HOLDING_REFCELL_REF),\n+    LintId::of(casts::CAST_ENUM_CONSTRUCTOR),\n     LintId::of(casts::CAST_ENUM_TRUNCATION),\n     LintId::of(eval_order_dependence::EVAL_ORDER_DEPENDENCE),\n     LintId::of(float_equality_without_abs::FLOAT_EQUALITY_WITHOUT_ABS),"}, {"sha": "0193454ad144c0b3136b186ed4be2ecb535d4c48", "filename": "tests/ui/cast_enum_constructor.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/tests%2Fui%2Fcast_enum_constructor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/tests%2Fui%2Fcast_enum_constructor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcast_enum_constructor.rs?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -0,0 +1,17 @@\n+#![warn(clippy::cast_enum_constructor)]\n+#![allow(clippy::fn_to_numeric_cast)]\n+\n+fn main() {\n+    enum Foo {\n+        Y(u32),\n+    }\n+\n+    enum Bar {\n+        X,\n+    }\n+\n+    let _ = Foo::Y as usize;\n+    let _ = Foo::Y as isize;\n+    let _ = Foo::Y as fn(u32) -> Foo;\n+    let _ = Bar::X as usize;\n+}"}, {"sha": "710909dd26fa8ac9458035b90f22a55d4b8b5ea7", "filename": "tests/ui/cast_enum_constructor.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/39329d1d404d38437270acf3cb1337a231367efc/tests%2Fui%2Fcast_enum_constructor.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/39329d1d404d38437270acf3cb1337a231367efc/tests%2Fui%2Fcast_enum_constructor.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcast_enum_constructor.stderr?ref=39329d1d404d38437270acf3cb1337a231367efc", "patch": "@@ -0,0 +1,16 @@\n+error: cast of an enum tuple constructor to an integer\n+  --> $DIR/cast_enum_constructor.rs:13:13\n+   |\n+LL |     let _ = Foo::Y as usize;\n+   |             ^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::cast-enum-constructor` implied by `-D warnings`\n+\n+error: cast of an enum tuple constructor to an integer\n+  --> $DIR/cast_enum_constructor.rs:14:13\n+   |\n+LL |     let _ = Foo::Y as isize;\n+   |             ^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}]}