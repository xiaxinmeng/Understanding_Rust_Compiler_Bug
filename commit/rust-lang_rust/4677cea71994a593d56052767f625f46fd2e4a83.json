{"sha": "4677cea71994a593d56052767f625f46fd2e4a83", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2NzdjZWE3MTk5NGE1OTNkNTYwNTI3NjdmNjI1ZjQ2ZmQyZTRhODM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-05-20T21:33:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-20T21:33:36Z"}, "message": "Merge #4540\n\n4540: More snippets r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "f3c08d05d1ac2c8525cc37e42c175364970014b1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f3c08d05d1ac2c8525cc37e42c175364970014b1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4677cea71994a593d56052767f625f46fd2e4a83", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJexaIwCRBK7hj4Ov3rIwAAdHIIAFj/rdBpGVPKYlDTYLvcAcgI\nF00+7JKb6mQDvo/VmXrVPbmK2yz5vxwNr6agAvTaIbFf45sikC85ciie8c09crkr\nbS0kTPR5RlZ1troF24c7wZqcHwrQhbwHhZ7m+aFmtS1Zrd3BSJhBOngq2Vd7KRSM\nmf3dA1X3nj0bcO9twwLK5fLNd6jQSiQX8C//bTZWhKoU5EBWLOoQAKN0/2g1Iqul\nwri1YNkR5eSt0WQ03IbW5O8aNyFB7iOLUzF8umwgWdcTQMH/BrxWnZn77IAh80WQ\ngGLEATB39wmV34mu30PnS5KIXPd+kvNpgVWes9wlkITdy2uyFLdgR+vkytjagZs=\n=jhLK\n-----END PGP SIGNATURE-----\n", "payload": "tree f3c08d05d1ac2c8525cc37e42c175364970014b1\nparent 64afbf8d95386cde666311bcddf14d8420e9793d\nparent 5e13e4eba17fe0d55afa76c8d5ff495228283c4e\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1590010416 +0000\ncommitter GitHub <noreply@github.com> 1590010416 +0000\n\nMerge #4540\n\n4540: More snippets r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4677cea71994a593d56052767f625f46fd2e4a83", "html_url": "https://github.com/rust-lang/rust/commit/4677cea71994a593d56052767f625f46fd2e4a83", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4677cea71994a593d56052767f625f46fd2e4a83/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64afbf8d95386cde666311bcddf14d8420e9793d", "url": "https://api.github.com/repos/rust-lang/rust/commits/64afbf8d95386cde666311bcddf14d8420e9793d", "html_url": "https://github.com/rust-lang/rust/commit/64afbf8d95386cde666311bcddf14d8420e9793d"}, {"sha": "5e13e4eba17fe0d55afa76c8d5ff495228283c4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e13e4eba17fe0d55afa76c8d5ff495228283c4e", "html_url": "https://github.com/rust-lang/rust/commit/5e13e4eba17fe0d55afa76c8d5ff495228283c4e"}], "stats": {"total": 305, "additions": 133, "deletions": 172}, "files": [{"sha": "4cc75a7ce2dcda9733ff936908485520aa0b0808", "filename": "crates/ra_assists/src/handlers/early_return.rs", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fearly_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fearly_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fearly_return.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -97,7 +97,6 @@ pub(crate) fn convert_to_guarded_return(acc: &mut Assists, ctx: &AssistContext)\n     }\n \n     then_block.syntax().last_child_or_token().filter(|t| t.kind() == R_CURLY)?;\n-    let cursor_position = ctx.offset();\n \n     let target = if_expr.syntax().text_range();\n     acc.add(AssistId(\"convert_to_guarded_return\"), \"Convert to guarded return\", target, |edit| {\n@@ -148,7 +147,6 @@ pub(crate) fn convert_to_guarded_return(acc: &mut Assists, ctx: &AssistContext)\n             }\n         };\n         edit.replace_ast(parent_block, ast::BlockExpr::cast(new_block).unwrap());\n-        edit.set_cursor(cursor_position);\n \n         fn replace(\n             new_expr: &SyntaxNode,\n@@ -207,7 +205,7 @@ mod tests {\n             r#\"\n             fn main() {\n                 bar();\n-                if<|> !true {\n+                if !true {\n                     return;\n                 }\n                 foo();\n@@ -237,7 +235,7 @@ mod tests {\n             r#\"\n             fn main(n: Option<String>) {\n                 bar();\n-                le<|>t n = match n {\n+                let n = match n {\n                     Some(it) => it,\n                     _ => return,\n                 };\n@@ -263,7 +261,7 @@ mod tests {\n             \"#,\n             r#\"\n             fn main() {\n-                le<|>t x = match Err(92) {\n+                let x = match Err(92) {\n                     Ok(it) => it,\n                     _ => return,\n                 };\n@@ -291,7 +289,7 @@ mod tests {\n             r#\"\n             fn main(n: Option<String>) {\n                 bar();\n-                le<|>t n = match n {\n+                let n = match n {\n                     Ok(it) => it,\n                     _ => return,\n                 };\n@@ -321,7 +319,7 @@ mod tests {\n             r#\"\n             fn main() {\n                 while true {\n-                    if<|> !true {\n+                    if !true {\n                         continue;\n                     }\n                     foo();\n@@ -349,7 +347,7 @@ mod tests {\n             r#\"\n             fn main() {\n                 while true {\n-                    le<|>t n = match n {\n+                    let n = match n {\n                         Some(it) => it,\n                         _ => continue,\n                     };\n@@ -378,7 +376,7 @@ mod tests {\n             r#\"\n             fn main() {\n                 loop {\n-                    if<|> !true {\n+                    if !true {\n                         continue;\n                     }\n                     foo();\n@@ -406,7 +404,7 @@ mod tests {\n             r#\"\n             fn main() {\n                 loop {\n-                    le<|>t n = match n {\n+                    let n = match n {\n                         Some(it) => it,\n                         _ => continue,\n                     };"}, {"sha": "d26e68847984a20b0e63fcfbb266986a9c8b9fa4", "filename": "crates/ra_assists/src/handlers/inline_local_variable.rs", "status": "modified", "additions": 23, "deletions": 24, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Finline_local_variable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Finline_local_variable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Finline_local_variable.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -116,7 +116,6 @@ pub(crate) fn inline_local_variable(acc: &mut Assists, ctx: &AssistContext) -> O\n             let replacement = if should_wrap { init_in_paren.clone() } else { init_str.clone() };\n             builder.replace(desc.file_range.range, replacement)\n         }\n-        builder.set_cursor(delete_range.start())\n     })\n }\n \n@@ -149,7 +148,7 @@ fn foo() {\n             r\"\n fn bar(a: usize) {}\n fn foo() {\n-    <|>1 + 1;\n+    1 + 1;\n     if 1 > 10 {\n     }\n \n@@ -183,7 +182,7 @@ fn foo() {\n             r\"\n fn bar(a: usize) {}\n fn foo() {\n-    <|>(1 + 1) + 1;\n+    (1 + 1) + 1;\n     if (1 + 1) > 10 {\n     }\n \n@@ -217,7 +216,7 @@ fn foo() {\n             r\"\n fn bar(a: usize) {}\n fn foo() {\n-    <|>bar(1) + 1;\n+    bar(1) + 1;\n     if bar(1) > 10 {\n     }\n \n@@ -251,7 +250,7 @@ fn foo() {\n             r\"\n fn bar(a: usize): usize { a }\n fn foo() {\n-    <|>(bar(1) as u64) + 1;\n+    (bar(1) as u64) + 1;\n     if (bar(1) as u64) > 10 {\n     }\n \n@@ -283,7 +282,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>{ 10 + 1 } + 1;\n+    { 10 + 1 } + 1;\n     if { 10 + 1 } > 10 {\n     }\n \n@@ -315,7 +314,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>( 10 + 1 ) + 1;\n+    ( 10 + 1 ) + 1;\n     if ( 10 + 1 ) > 10 {\n     }\n \n@@ -353,7 +352,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>let b = bar(10 + 1) * 10;\n+    let b = bar(10 + 1) * 10;\n     let c = bar(10 + 1) as usize;\n }\",\n         );\n@@ -373,7 +372,7 @@ fn foo() {\n             r\"\n fn foo() {\n     let x = vec![1, 2, 3];\n-    <|>let b = x[0] * 10;\n+    let b = x[0] * 10;\n     let c = x[0] as usize;\n }\",\n         );\n@@ -393,7 +392,7 @@ fn foo() {\n             r\"\n fn foo() {\n     let bar = vec![1];\n-    <|>let b = bar.len() * 10;\n+    let b = bar.len() * 10;\n     let c = bar.len() as usize;\n }\",\n         );\n@@ -421,7 +420,7 @@ struct Bar {\n \n fn foo() {\n     let bar = Bar { foo: 1 };\n-    <|>let b = bar.foo * 10;\n+    let b = bar.foo * 10;\n     let c = bar.foo as usize;\n }\",\n         );\n@@ -442,7 +441,7 @@ fn foo() -> Option<usize> {\n             r\"\n fn foo() -> Option<usize> {\n     let bar = Some(1);\n-    <|>let b = bar? * 10;\n+    let b = bar? * 10;\n     let c = bar? as usize;\n     None\n }\",\n@@ -462,7 +461,7 @@ fn foo() {\n             r\"\n fn foo() {\n     let bar = 10;\n-    <|>let b = &bar * 10;\n+    let b = &bar * 10;\n }\",\n         );\n     }\n@@ -478,7 +477,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>let b = (10, 20)[0];\n+    let b = (10, 20)[0];\n }\",\n         );\n     }\n@@ -494,7 +493,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>let b = [1, 2, 3].len();\n+    let b = [1, 2, 3].len();\n }\",\n         );\n     }\n@@ -511,7 +510,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>let b = (10 + 20) * 10;\n+    let b = (10 + 20) * 10;\n     let c = (10 + 20) as usize;\n }\",\n         );\n@@ -531,7 +530,7 @@ fn foo() {\n             r\"\n fn foo() {\n     let d = 10;\n-    <|>let b = d * 10;\n+    let b = d * 10;\n     let c = d as usize;\n }\",\n         );\n@@ -549,7 +548,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>let b = { 10 } * 10;\n+    let b = { 10 } * 10;\n     let c = { 10 } as usize;\n }\",\n         );\n@@ -569,7 +568,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>let b = (10 + 20) * 10;\n+    let b = (10 + 20) * 10;\n     let c = (10 + 20, 20);\n     let d = [10 + 20, 10];\n     let e = (10 + 20);\n@@ -588,7 +587,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>for i in vec![10, 20] {}\n+    for i in vec![10, 20] {}\n }\",\n         );\n     }\n@@ -604,7 +603,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>while 1 > 0 {}\n+    while 1 > 0 {}\n }\",\n         );\n     }\n@@ -622,7 +621,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>loop {\n+    loop {\n         break 1 + 1;\n     }\n }\",\n@@ -640,7 +639,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>return 1 > 0;\n+    return 1 > 0;\n }\",\n         );\n     }\n@@ -656,7 +655,7 @@ fn foo() {\n }\",\n             r\"\n fn foo() {\n-    <|>match 1 > 0 {}\n+    match 1 > 0 {}\n }\",\n         );\n     }"}, {"sha": "31d6539f7a77b46866102aefe0e553903aef6162", "filename": "crates/ra_assists/src/handlers/introduce_variable.rs", "status": "modified", "additions": 63, "deletions": 49, "changes": 112, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fintroduce_variable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fintroduce_variable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fintroduce_variable.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -4,7 +4,7 @@ use ra_syntax::{\n         BLOCK_EXPR, BREAK_EXPR, COMMENT, LAMBDA_EXPR, LOOP_EXPR, MATCH_ARM, PATH_EXPR, RETURN_EXPR,\n         WHITESPACE,\n     },\n-    SyntaxNode, TextSize,\n+    SyntaxNode,\n };\n use stdx::format_to;\n use test_utils::mark;\n@@ -23,7 +23,7 @@ use crate::{AssistContext, AssistId, Assists};\n // ->\n // ```\n // fn main() {\n-//     let var_name = (1 + 2);\n+//     let $0var_name = (1 + 2);\n //     var_name * 4;\n // }\n // ```\n@@ -46,14 +46,13 @@ pub(crate) fn introduce_variable(acc: &mut Assists, ctx: &AssistContext) -> Opti\n     acc.add(AssistId(\"introduce_variable\"), \"Extract into variable\", target, move |edit| {\n         let mut buf = String::new();\n \n-        let cursor_offset = if wrap_in_block {\n+        if wrap_in_block {\n             buf.push_str(\"{ let var_name = \");\n-            TextSize::of(\"{ let \")\n         } else {\n             buf.push_str(\"let var_name = \");\n-            TextSize::of(\"let \")\n         };\n         format_to!(buf, \"{}\", expr.syntax());\n+\n         let full_stmt = ast::ExprStmt::cast(anchor_stmt.clone());\n         let is_full_stmt = if let Some(expr_stmt) = &full_stmt {\n             Some(expr.syntax().clone()) == expr_stmt.expr().map(|e| e.syntax().clone())\n@@ -65,28 +64,43 @@ pub(crate) fn introduce_variable(acc: &mut Assists, ctx: &AssistContext) -> Opti\n             if full_stmt.unwrap().semicolon_token().is_none() {\n                 buf.push_str(\";\");\n             }\n-            edit.replace(expr.syntax().text_range(), buf);\n-        } else {\n-            buf.push_str(\";\");\n-\n-            // We want to maintain the indent level,\n-            // but we do not want to duplicate possible\n-            // extra newlines in the indent block\n-            let text = indent.text();\n-            if text.starts_with('\\n') {\n-                buf.push_str(\"\\n\");\n-                buf.push_str(text.trim_start_matches('\\n'));\n-            } else {\n-                buf.push_str(text);\n+            let offset = expr.syntax().text_range();\n+            match ctx.config.snippet_cap {\n+                Some(cap) => {\n+                    let snip = buf.replace(\"let var_name\", \"let $0var_name\");\n+                    edit.replace_snippet(cap, offset, snip)\n+                }\n+                None => edit.replace(offset, buf),\n             }\n+            return;\n+        }\n \n-            edit.replace(expr.syntax().text_range(), \"var_name\".to_string());\n-            edit.insert(anchor_stmt.text_range().start(), buf);\n-            if wrap_in_block {\n-                edit.insert(anchor_stmt.text_range().end(), \" }\");\n+        buf.push_str(\";\");\n+\n+        // We want to maintain the indent level,\n+        // but we do not want to duplicate possible\n+        // extra newlines in the indent block\n+        let text = indent.text();\n+        if text.starts_with('\\n') {\n+            buf.push_str(\"\\n\");\n+            buf.push_str(text.trim_start_matches('\\n'));\n+        } else {\n+            buf.push_str(text);\n+        }\n+\n+        edit.replace(expr.syntax().text_range(), \"var_name\".to_string());\n+        let offset = anchor_stmt.text_range().start();\n+        match ctx.config.snippet_cap {\n+            Some(cap) => {\n+                let snip = buf.replace(\"let var_name\", \"let $0var_name\");\n+                edit.insert_snippet(cap, offset, snip)\n             }\n+            None => edit.insert(offset, buf),\n+        }\n+\n+        if wrap_in_block {\n+            edit.insert(anchor_stmt.text_range().end(), \" }\");\n         }\n-        edit.set_cursor(anchor_stmt.text_range().start() + cursor_offset);\n     })\n }\n \n@@ -144,15 +158,15 @@ mod tests {\n     fn test_introduce_var_simple() {\n         check_assist(\n             introduce_variable,\n-            \"\n+            r#\"\n fn foo() {\n     foo(<|>1 + 1<|>);\n-}\",\n-            \"\n+}\"#,\n+            r#\"\n fn foo() {\n-    let <|>var_name = 1 + 1;\n+    let $0var_name = 1 + 1;\n     foo(var_name);\n-}\",\n+}\"#,\n         );\n     }\n \n@@ -167,14 +181,14 @@ fn foo() {\n         mark::check!(test_introduce_var_expr_stmt);\n         check_assist(\n             introduce_variable,\n-            \"\n+            r#\"\n fn foo() {\n     <|>1 + 1<|>;\n-}\",\n-            \"\n+}\"#,\n+            r#\"\n fn foo() {\n-    let <|>var_name = 1 + 1;\n-}\",\n+    let $0var_name = 1 + 1;\n+}\"#,\n         );\n         check_assist(\n             introduce_variable,\n@@ -185,7 +199,7 @@ fn foo() {\n }\",\n             \"\n fn foo() {\n-    let <|>var_name = { let x = 0; x };\n+    let $0var_name = { let x = 0; x };\n     something_else();\n }\",\n         );\n@@ -201,7 +215,7 @@ fn foo() {\n }\",\n             \"\n fn foo() {\n-    let <|>var_name = 1;\n+    let $0var_name = 1;\n     var_name + 1;\n }\",\n         );\n@@ -218,7 +232,7 @@ fn foo() {\n }\",\n             \"\n fn foo() {\n-    let <|>var_name = 1 + 1;\n+    let $0var_name = 1 + 1;\n     bar(var_name)\n }\",\n         );\n@@ -230,7 +244,7 @@ fn foo() {\n }\",\n             \"\n fn foo() {\n-    let <|>var_name = bar(1 + 1);\n+    let $0var_name = bar(1 + 1);\n     var_name\n }\",\n         )\n@@ -253,7 +267,7 @@ fn main() {\n fn main() {\n     let x = true;\n     let tuple = match x {\n-        true => { let <|>var_name = 2 + 2; (var_name, true) }\n+        true => { let $0var_name = 2 + 2; (var_name, true) }\n         _ => (0, false)\n     };\n }\n@@ -283,7 +297,7 @@ fn main() {\n     let tuple = match x {\n         true => {\n             let y = 1;\n-            let <|>var_name = 2 + y;\n+            let $0var_name = 2 + y;\n             (var_name, true)\n         }\n         _ => (0, false)\n@@ -304,7 +318,7 @@ fn main() {\n \",\n             \"\n fn main() {\n-    let lambda = |x: u32| { let <|>var_name = x * 2; var_name };\n+    let lambda = |x: u32| { let $0var_name = x * 2; var_name };\n }\n \",\n         );\n@@ -321,7 +335,7 @@ fn main() {\n \",\n             \"\n fn main() {\n-    let lambda = |x: u32| { let <|>var_name = x * 2; var_name };\n+    let lambda = |x: u32| { let $0var_name = x * 2; var_name };\n }\n \",\n         );\n@@ -338,7 +352,7 @@ fn main() {\n \",\n             \"\n fn main() {\n-    let <|>var_name = Some(true);\n+    let $0var_name = Some(true);\n     let o = var_name;\n }\n \",\n@@ -356,7 +370,7 @@ fn main() {\n \",\n             \"\n fn main() {\n-    let <|>var_name = bar.foo();\n+    let $0var_name = bar.foo();\n     let v = var_name;\n }\n \",\n@@ -374,7 +388,7 @@ fn foo() -> u32 {\n \",\n             \"\n fn foo() -> u32 {\n-    let <|>var_name = 2 + 2;\n+    let $0var_name = 2 + 2;\n     return var_name;\n }\n \",\n@@ -396,7 +410,7 @@ fn foo() -> u32 {\n fn foo() -> u32 {\n \n \n-    let <|>var_name = 2 + 2;\n+    let $0var_name = 2 + 2;\n     return var_name;\n }\n \",\n@@ -413,7 +427,7 @@ fn foo() -> u32 {\n             \"\n fn foo() -> u32 {\n \n-        let <|>var_name = 2 + 2;\n+        let $0var_name = 2 + 2;\n         return var_name;\n }\n \",\n@@ -438,7 +452,7 @@ fn foo() -> u32 {\n     // bar\n \n \n-    let <|>var_name = 2 + 2;\n+    let $0var_name = 2 + 2;\n     return var_name;\n }\n \",\n@@ -459,7 +473,7 @@ fn main() {\n             \"\n fn main() {\n     let result = loop {\n-        let <|>var_name = 2 + 2;\n+        let $0var_name = 2 + 2;\n         break var_name;\n     };\n }\n@@ -478,7 +492,7 @@ fn main() {\n \",\n             \"\n fn main() {\n-    let <|>var_name = 0f32 as u32;\n+    let $0var_name = 0f32 as u32;\n     let v = var_name;\n }\n \","}, {"sha": "972d162419468d830b8aa08ea6595b4db840b791", "filename": "crates/ra_assists/src/handlers/merge_imports.rs", "status": "modified", "additions": 10, "deletions": 12, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -58,8 +58,6 @@ pub(crate) fn merge_imports(acc: &mut Assists, ctx: &AssistContext) -> Option<()\n     let target = tree.syntax().text_range();\n     acc.add(AssistId(\"merge_imports\"), \"Merge imports\", target, |builder| {\n         builder.rewrite(rewriter);\n-        // FIXME: we only need because our diff is imprecise\n-        builder.set_cursor(offset);\n     })\n }\n \n@@ -142,7 +140,7 @@ use std::fmt<|>::Debug;\n use std::fmt::Display;\n \",\n             r\"\n-use std::fmt<|>::{Debug, Display};\n+use std::fmt::{Debug, Display};\n \",\n         )\n     }\n@@ -156,7 +154,7 @@ use std::fmt::Debug;\n use std::fmt<|>::Display;\n \",\n             r\"\n-use std::fmt:<|>:{Display, Debug};\n+use std::fmt::{Display, Debug};\n \",\n         );\n     }\n@@ -169,7 +167,7 @@ use std::fmt:<|>:{Display, Debug};\n use std::{fmt<|>::Debug, fmt::Display};\n \",\n             r\"\n-use std::{fmt<|>::{Debug, Display}};\n+use std::{fmt::{Debug, Display}};\n \",\n         );\n         check_assist(\n@@ -178,7 +176,7 @@ use std::{fmt<|>::{Debug, Display}};\n use std::{fmt::Debug, fmt<|>::Display};\n \",\n             r\"\n-use std::{fmt::<|>{Display, Debug}};\n+use std::{fmt::{Display, Debug}};\n \",\n         );\n     }\n@@ -192,7 +190,7 @@ use std<|>::cell::*;\n use std::str;\n \",\n             r\"\n-use std<|>::{cell::*, str};\n+use std::{cell::*, str};\n \",\n         )\n     }\n@@ -206,7 +204,7 @@ use std<|>::cell::*;\n use std::str::*;\n \",\n             r\"\n-use std<|>::{cell::*, str::*};\n+use std::{cell::*, str::*};\n \",\n         )\n     }\n@@ -222,7 +220,7 @@ use foo::baz;\n /// Doc comment\n \",\n             r\"\n-use foo<|>::{bar, baz};\n+use foo::{bar, baz};\n \n /// Doc comment\n \",\n@@ -241,7 +239,7 @@ use {\n \",\n             r\"\n use {\n-    foo<|>::{bar, baz},\n+    foo::{bar, baz},\n };\n \",\n         );\n@@ -255,7 +253,7 @@ use {\n \",\n             r\"\n use {\n-    foo::{bar<|>, baz},\n+    foo::{bar, baz},\n };\n \",\n         );\n@@ -272,7 +270,7 @@ use foo::<|>{\n };\n \",\n             r\"\n-use foo::{<|>\n+use foo::{\n     FooBar,\n bar::baz};\n \","}, {"sha": "ca04ec671a0f0761cd6568c0d71b3ef6a74fd81f", "filename": "crates/ra_assists/src/handlers/merge_match_arms.rs", "status": "modified", "additions": 5, "deletions": 20, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmerge_match_arms.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmerge_match_arms.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmerge_match_arms.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -3,7 +3,7 @@ use std::iter::successors;\n use ra_syntax::{\n     algo::neighbor,\n     ast::{self, AstNode},\n-    Direction, TextSize,\n+    Direction,\n };\n \n use crate::{AssistContext, AssistId, Assists, TextRange};\n@@ -41,17 +41,6 @@ pub(crate) fn merge_match_arms(acc: &mut Assists, ctx: &AssistContext) -> Option\n     let current_expr = current_arm.expr()?;\n     let current_text_range = current_arm.syntax().text_range();\n \n-    enum CursorPos {\n-        InExpr(TextSize),\n-        InPat(TextSize),\n-    }\n-    let cursor_pos = ctx.offset();\n-    let cursor_pos = if current_expr.syntax().text_range().contains(cursor_pos) {\n-        CursorPos::InExpr(current_text_range.end() - cursor_pos)\n-    } else {\n-        CursorPos::InPat(cursor_pos)\n-    };\n-\n     // We check if the following match arms match this one. We could, but don't,\n     // compare to the previous match arm as well.\n     let arms_to_merge = successors(Some(current_arm), |it| neighbor(it, Direction::Next))\n@@ -87,10 +76,6 @@ pub(crate) fn merge_match_arms(acc: &mut Assists, ctx: &AssistContext) -> Option\n         let start = arms_to_merge.first().unwrap().syntax().text_range().start();\n         let end = arms_to_merge.last().unwrap().syntax().text_range().end();\n \n-        edit.set_cursor(match cursor_pos {\n-            CursorPos::InExpr(back_offset) => start + TextSize::of(&arm) - back_offset,\n-            CursorPos::InPat(offset) => offset,\n-        });\n         edit.replace(TextRange::new(start, end), arm);\n     })\n }\n@@ -132,7 +117,7 @@ mod tests {\n             fn main() {\n                 let x = X::A;\n                 let y = match x {\n-                    X::A | X::B => { 1i32<|> }\n+                    X::A | X::B => { 1i32 }\n                     X::C => { 2i32 }\n                 }\n             }\n@@ -164,7 +149,7 @@ mod tests {\n             fn main() {\n                 let x = X::A;\n                 let y = match x {\n-                    X::A | X::B | X::C | X::D => {<|> 1i32 },\n+                    X::A | X::B | X::C | X::D => { 1i32 },\n                     X::E => { 2i32 },\n                 }\n             }\n@@ -197,7 +182,7 @@ mod tests {\n                 let x = X::A;\n                 let y = match x {\n                     X::A => { 1i32 },\n-                    _ => { 2i<|>32 }\n+                    _ => { 2i32 }\n                 }\n             }\n             \"#,\n@@ -226,7 +211,7 @@ mod tests {\n \n             fn main() {\n                 match X::A {\n-                    X::A<|> | X::B | X::C => 92,\n+                    X::A | X::B | X::C => 92,\n                     X::D => 62,\n                     _ => panic!(),\n                 }"}, {"sha": "7edcf07489584d1df0571c38c2f33b14db33faeb", "filename": "crates/ra_assists/src/handlers/move_guard.rs", "status": "modified", "additions": 11, "deletions": 22, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmove_guard.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmove_guard.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fmove_guard.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -1,7 +1,6 @@\n use ra_syntax::{\n-    ast,\n-    ast::{AstNode, AstToken, IfExpr, MatchArm},\n-    TextSize,\n+    ast::{AstNode, IfExpr, MatchArm},\n+    SyntaxKind::WHITESPACE,\n };\n \n use crate::{AssistContext, AssistId, Assists};\n@@ -42,24 +41,15 @@ pub(crate) fn move_guard_to_arm_body(acc: &mut Assists, ctx: &AssistContext) ->\n \n     let target = guard.syntax().text_range();\n     acc.add(AssistId(\"move_guard_to_arm_body\"), \"Move guard to arm body\", target, |edit| {\n-        let offseting_amount = match space_before_guard.and_then(|it| it.into_token()) {\n-            Some(tok) => {\n-                if ast::Whitespace::cast(tok.clone()).is_some() {\n-                    let ele = tok.text_range();\n-                    edit.delete(ele);\n-                    ele.len()\n-                } else {\n-                    TextSize::from(0)\n-                }\n+        match space_before_guard {\n+            Some(element) if element.kind() == WHITESPACE => {\n+                edit.delete(element.text_range());\n             }\n-            _ => TextSize::from(0),\n+            _ => (),\n         };\n \n         edit.delete(guard.syntax().text_range());\n         edit.replace_node_and_indent(arm_expr.syntax(), buf);\n-        edit.set_cursor(\n-            arm_expr.syntax().text_range().start() + TextSize::from(3) - offseting_amount,\n-        );\n     })\n }\n \n@@ -124,7 +114,6 @@ pub(crate) fn move_arm_cond_to_match_guard(acc: &mut Assists, ctx: &AssistContex\n             }\n \n             edit.insert(match_pat.syntax().text_range().end(), buf);\n-            edit.set_cursor(match_pat.syntax().text_range().end() + TextSize::from(1));\n         },\n     )\n }\n@@ -172,7 +161,7 @@ mod tests {\n                 let t = 'a';\n                 let chars = \"abcd\";\n                 match t {\n-                    '\\r' => if chars.clone().next() == Some('\\n') { <|>false },\n+                    '\\r' => if chars.clone().next() == Some('\\n') { false },\n                     _ => true\n                 }\n             }\n@@ -195,7 +184,7 @@ mod tests {\n             r#\"\n             fn f() {\n                 match x {\n-                    y @ 4 | y @ 5 => if y > 5 { <|>true },\n+                    y @ 4 | y @ 5 => if y > 5 { true },\n                     _ => false\n                 }\n             }\n@@ -222,7 +211,7 @@ mod tests {\n                 let t = 'a';\n                 let chars = \"abcd\";\n                 match t {\n-                    '\\r' <|>if chars.clone().next() == Some('\\n') => false,\n+                    '\\r' if chars.clone().next() == Some('\\n') => false,\n                     _ => true\n                 }\n             }\n@@ -266,7 +255,7 @@ mod tests {\n                 let t = 'a';\n                 let chars = \"abcd\";\n                 match t {\n-                    '\\r' <|>if chars.clone().next().is_some() => {  },\n+                    '\\r' if chars.clone().next().is_some() => {  },\n                     _ => true\n                 }\n             }\n@@ -296,7 +285,7 @@ mod tests {\n                 let mut t = 'a';\n                 let chars = \"abcd\";\n                 match t {\n-                    '\\r' <|>if chars.clone().next().is_some() => {\n+                    '\\r' if chars.clone().next().is_some() => {\n                         t = 'e';\n                         false\n                     },"}, {"sha": "961ee1731ad0f79106552985f59cd62e50ed60e3", "filename": "crates/ra_assists/src/handlers/remove_dbg.rs", "status": "modified", "additions": 9, "deletions": 30, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fremove_dbg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fremove_dbg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fremove_dbg.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -29,26 +29,6 @@ pub(crate) fn remove_dbg(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n \n     let macro_range = macro_call.syntax().text_range();\n \n-    // If the cursor is inside the macro call, we'll try to maintain the cursor\n-    // position by subtracting the length of dbg!( from the start of the file\n-    // range, otherwise we'll default to using the start of the macro call\n-    let cursor_pos = {\n-        let file_range = ctx.frange.range;\n-\n-        let offset_start = file_range\n-            .start()\n-            .checked_sub(macro_range.start())\n-            .unwrap_or_else(|| TextSize::from(0));\n-\n-        let dbg_size = TextSize::of(\"dbg!(\");\n-\n-        if offset_start > dbg_size {\n-            file_range.start() - dbg_size\n-        } else {\n-            macro_range.start()\n-        }\n-    };\n-\n     let macro_content = {\n         let macro_args = macro_call.token_tree()?.syntax().clone();\n \n@@ -58,9 +38,8 @@ pub(crate) fn remove_dbg(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n     };\n \n     let target = macro_call.syntax().text_range();\n-    acc.add(AssistId(\"remove_dbg\"), \"Remove dbg!()\", target, |edit| {\n-        edit.replace(macro_range, macro_content);\n-        edit.set_cursor(cursor_pos);\n+    acc.add(AssistId(\"remove_dbg\"), \"Remove dbg!()\", target, |builder| {\n+        builder.replace(macro_range, macro_content);\n     })\n }\n \n@@ -94,13 +73,13 @@ mod tests {\n \n     #[test]\n     fn test_remove_dbg() {\n-        check_assist(remove_dbg, \"<|>dbg!(1 + 1)\", \"<|>1 + 1\");\n+        check_assist(remove_dbg, \"<|>dbg!(1 + 1)\", \"1 + 1\");\n \n-        check_assist(remove_dbg, \"dbg!<|>((1 + 1))\", \"<|>(1 + 1)\");\n+        check_assist(remove_dbg, \"dbg!<|>((1 + 1))\", \"(1 + 1)\");\n \n-        check_assist(remove_dbg, \"dbg!(1 <|>+ 1)\", \"1 <|>+ 1\");\n+        check_assist(remove_dbg, \"dbg!(1 <|>+ 1)\", \"1 + 1\");\n \n-        check_assist(remove_dbg, \"let _ = <|>dbg!(1 + 1)\", \"let _ = <|>1 + 1\");\n+        check_assist(remove_dbg, \"let _ = <|>dbg!(1 + 1)\", \"let _ = 1 + 1\");\n \n         check_assist(\n             remove_dbg,\n@@ -113,7 +92,7 @@ fn foo(n: usize) {\n \",\n             \"\n fn foo(n: usize) {\n-    if let Some(_) = n.<|>checked_sub(4) {\n+    if let Some(_) = n.checked_sub(4) {\n         // ...\n     }\n }\n@@ -122,8 +101,8 @@ fn foo(n: usize) {\n     }\n     #[test]\n     fn test_remove_dbg_with_brackets_and_braces() {\n-        check_assist(remove_dbg, \"dbg![<|>1 + 1]\", \"<|>1 + 1\");\n-        check_assist(remove_dbg, \"dbg!{<|>1 + 1}\", \"<|>1 + 1\");\n+        check_assist(remove_dbg, \"dbg![<|>1 + 1]\", \"1 + 1\");\n+        check_assist(remove_dbg, \"dbg!{<|>1 + 1}\", \"1 + 1\");\n     }\n \n     #[test]"}, {"sha": "fe4eada0340876ef9bbc9d5fd2bae8bf1ec99538", "filename": "crates/ra_assists/src/handlers/remove_mut.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fremove_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fremove_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fremove_mut.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -26,8 +26,7 @@ pub(crate) fn remove_mut(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n     };\n \n     let target = mut_token.text_range();\n-    acc.add(AssistId(\"remove_mut\"), \"Remove `mut` keyword\", target, |edit| {\n-        edit.set_cursor(delete_from);\n-        edit.delete(TextRange::new(delete_from, delete_to));\n+    acc.add(AssistId(\"remove_mut\"), \"Remove `mut` keyword\", target, |builder| {\n+        builder.delete(TextRange::new(delete_from, delete_to));\n     })\n }"}, {"sha": "0eeb5c19941019b29bcc465cff3a21134019dd84", "filename": "crates/ra_assists/src/tests/generated.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Ftests%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/crates%2Fra_assists%2Fsrc%2Ftests%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Ftests%2Fgenerated.rs?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -443,7 +443,7 @@ fn main() {\n \"#####,\n         r#####\"\n fn main() {\n-    let var_name = (1 + 2);\n+    let $0var_name = (1 + 2);\n     var_name * 4;\n }\n \"#####,"}, {"sha": "a6e27d67f3c34b2fe425a49798eade9a1d4fbc07", "filename": "docs/user/assists.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4677cea71994a593d56052767f625f46fd2e4a83/docs%2Fuser%2Fassists.md", "raw_url": "https://github.com/rust-lang/rust/raw/4677cea71994a593d56052767f625f46fd2e4a83/docs%2Fuser%2Fassists.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fassists.md?ref=4677cea71994a593d56052767f625f46fd2e4a83", "patch": "@@ -426,7 +426,7 @@ fn main() {\n \n // AFTER\n fn main() {\n-    let var_name = (1 + 2);\n+    let $0var_name = (1 + 2);\n     var_name * 4;\n }\n ```"}]}