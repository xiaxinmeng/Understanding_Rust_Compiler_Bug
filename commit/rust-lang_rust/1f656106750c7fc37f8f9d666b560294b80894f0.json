{"sha": "1f656106750c7fc37f8f9d666b560294b80894f0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmNjU2MTA2NzUwYzdmYzM3ZjhmOWQ2NjZiNTYwMjk0YjgwODk0ZjA=", "commit": {"author": {"name": "Tim Neumann", "email": "mail@timnn.me", "date": "2017-03-17T19:52:44Z"}, "committer": {"name": "Tim Neumann", "email": "mail@timnn.me", "date": "2017-03-21T19:37:50Z"}, "message": "ci/netbsd: use the \"official\" cross compiler", "tree": {"sha": "211482f8b9719ea4aafffe1bf0f2a2d54041a232", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/211482f8b9719ea4aafffe1bf0f2a2d54041a232"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f656106750c7fc37f8f9d666b560294b80894f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f656106750c7fc37f8f9d666b560294b80894f0", "html_url": "https://github.com/rust-lang/rust/commit/1f656106750c7fc37f8f9d666b560294b80894f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f656106750c7fc37f8f9d666b560294b80894f0/comments", "author": {"login": "TimNN", "id": 1178249, "node_id": "MDQ6VXNlcjExNzgyNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/1178249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TimNN", "html_url": "https://github.com/TimNN", "followers_url": "https://api.github.com/users/TimNN/followers", "following_url": "https://api.github.com/users/TimNN/following{/other_user}", "gists_url": "https://api.github.com/users/TimNN/gists{/gist_id}", "starred_url": "https://api.github.com/users/TimNN/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TimNN/subscriptions", "organizations_url": "https://api.github.com/users/TimNN/orgs", "repos_url": "https://api.github.com/users/TimNN/repos", "events_url": "https://api.github.com/users/TimNN/events{/privacy}", "received_events_url": "https://api.github.com/users/TimNN/received_events", "type": "User", "site_admin": false}, "committer": {"login": "TimNN", "id": 1178249, "node_id": "MDQ6VXNlcjExNzgyNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/1178249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TimNN", "html_url": "https://github.com/TimNN", "followers_url": "https://api.github.com/users/TimNN/followers", "following_url": "https://api.github.com/users/TimNN/following{/other_user}", "gists_url": "https://api.github.com/users/TimNN/gists{/gist_id}", "starred_url": "https://api.github.com/users/TimNN/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TimNN/subscriptions", "organizations_url": "https://api.github.com/users/TimNN/orgs", "repos_url": "https://api.github.com/users/TimNN/repos", "events_url": "https://api.github.com/users/TimNN/events{/privacy}", "received_events_url": "https://api.github.com/users/TimNN/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58c701f5c7dc26d9b55c631006ece52abe1ddce2", "url": "https://api.github.com/repos/rust-lang/rust/commits/58c701f5c7dc26d9b55c631006ece52abe1ddce2", "html_url": "https://github.com/rust-lang/rust/commit/58c701f5c7dc26d9b55c631006ece52abe1ddce2"}], "stats": {"total": 163, "additions": 63, "deletions": 100}, "files": [{"sha": "c68f30a6e563b4fe39e2b2e59c4f5db28fb0fe88", "filename": "src/ci/docker/dist-s390x-linux-netbsd/Dockerfile", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/1f656106750c7fc37f8f9d666b560294b80894f0/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/1f656106750c7fc37f8f9d666b560294b80894f0/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2FDockerfile?ref=1f656106750c7fc37f8f9d666b560294b80894f0", "patch": "@@ -64,17 +64,17 @@ COPY patches/ /tmp/patches/\n COPY s390x-linux-gnu.config build-s390x-toolchain.sh /tmp/\n RUN ./build-s390x-toolchain.sh\n \n-USER root\n-\n COPY build-netbsd-toolchain.sh /tmp/\n RUN ./build-netbsd-toolchain.sh\n \n-ENV PATH=$PATH:/x-tools/s390x-ibm-linux-gnu/bin\n+USER root\n+\n+ENV PATH=$PATH:/x-tools/s390x-ibm-linux-gnu/bin:/x-tools/x86_64-unknown-netbsd/bin\n \n ENV \\\n-    AR_x86_64_unknown_netbsd=x86_64-unknown-netbsd-ar \\\n-    CC_x86_64_unknown_netbsd=x86_64-unknown-netbsd-gcc \\\n-    CXX_x86_64_unknown_netbsd=x86_64-unknown-netbsd-g++ \\\n+    AR_x86_64_unknown_netbsd=x86_64--netbsd-ar \\\n+    CC_x86_64_unknown_netbsd=x86_64--netbsd-gcc-sysroot \\\n+    CXX_x86_64_unknown_netbsd=x86_64--netbsd-g++-sysroot \\\n     CC_s390x_unknown_linux_gnu=s390x-ibm-linux-gnu-gcc \\\n     AR_s390x_unknown_linux_gnu=s390x-ibm-linux-gnu-ar \\\n     CXX_s390x_unknown_linux_gnu=s390x-ibm-linux-gnu-g++"}, {"sha": "ad5db04179262b7d15c47d0b6c986c8ccecef1c4", "filename": "src/ci/docker/dist-s390x-linux-netbsd/build-netbsd-toolchain.sh", "status": "modified", "additions": 51, "deletions": 94, "changes": 145, "blob_url": "https://github.com/rust-lang/rust/blob/1f656106750c7fc37f8f9d666b560294b80894f0/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2Fbuild-netbsd-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1f656106750c7fc37f8f9d666b560294b80894f0/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2Fbuild-netbsd-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-s390x-linux-netbsd%2Fbuild-netbsd-toolchain.sh?ref=1f656106750c7fc37f8f9d666b560294b80894f0", "patch": "@@ -13,108 +13,65 @@\n \n set -ex\n \n-BINUTILS=2.25.1\n-GCC=5.3.0\n+hide_output() {\n+  set +x\n+  on_err=\"\n+echo ERROR: An error was encountered with the build.\n+cat /tmp/build.log\n+exit 1\n+\"\n+  trap \"$on_err\" ERR\n+  bash -c \"while true; do sleep 30; echo \\$(date) - building ...; done\" &\n+  PING_LOOP_PID=$!\n+  $@ &> /tmp/build.log\n+  rm /tmp/build.log\n+  trap - ERR\n+  kill $PING_LOOP_PID\n+  set -x\n+}\n \n-# First up, build binutils\n-mkdir binutils\n-cd binutils\n-curl https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS.tar.bz2 | tar xjf -\n-mkdir binutils-build\n-cd binutils-build\n-../binutils-$BINUTILS/configure \\\n-  --target=x86_64-unknown-netbsd\n-make -j10\n-make install\n-cd ../..\n-rm -rf binutils\n-\n-# Next, download the NetBSD libc and relevant header files\n mkdir netbsd\n-# originally from:\n-# https://ftp.netbsd.org/pub/NetBSD/NetBSD-7.0/amd64/binary/sets/base.tgz\n-curl https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-16-netbsd-base.tgz | \\\n-  tar xzf - -C netbsd ./usr/include ./usr/lib ./lib\n-# originally from:\n-# https://ftp.netbsd.org/pub/NetBSD/NetBSD-7.0/amd64/binary/sets/comp.tgz\n-curl https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-16-netbsd-comp.tgz | \\\n-  tar xzf - -C netbsd ./usr/include ./usr/lib\n+cd netbsd\n \n-dst=/usr/local/x86_64-unknown-netbsd\n-cp -r netbsd/usr/include $dst\n-cp netbsd/usr/lib/crt0.o $dst/lib\n-cp netbsd/usr/lib/crti.o $dst/lib\n-cp netbsd/usr/lib/crtn.o $dst/lib\n-cp netbsd/usr/lib/crtbeginS.o $dst/lib\n-cp netbsd/usr/lib/crtendS.o $dst/lib\n-cp netbsd/usr/lib/crtbegin.o $dst/lib\n-cp netbsd/usr/lib/crtend.o $dst/lib\n-cp netbsd/usr/lib/gcrt0.o $dst/lib\n-cp netbsd/usr/lib/libc.a $dst/lib\n-cp netbsd/usr/lib/libc_p.a $dst/lib\n-cp netbsd/usr/lib/libc_pic.a $dst/lib\n-cp netbsd/lib/libc.so.12.193.1 $dst/lib\n-cp netbsd/lib/libutil.so.7.21 $dst/lib\n-cp netbsd/usr/lib/libm.a $dst/lib\n-cp netbsd/usr/lib/libm_p.a $dst/lib\n-cp netbsd/usr/lib/libm_pic.a $dst/lib\n-cp netbsd/lib/libm.so.0.11 $dst/lib\n-cp netbsd/usr/lib/librt.so.1.1 $dst/lib\n-cp netbsd/usr/lib/libpthread.a $dst/lib\n-cp netbsd/usr/lib/libpthread_p.a $dst/lib\n-cp netbsd/usr/lib/libpthread_pic.a $dst/lib\n-cp netbsd/usr/lib/libpthread.so.1.2 $dst/lib\n+mkdir -p /x-tools/x86_64-unknown-netbsd/sysroot\n \n-ln -s libc.so.12.193.1 $dst/lib/libc.so\n-ln -s libc.so.12.193.1 $dst/lib/libc.so.12\n-ln -s libm.so.0.11 $dst/lib/libm.so\n-ln -s libm.so.0.11 $dst/lib/libm.so.0\n-ln -s libutil.so.7.21 $dst/lib/libutil.so\n-ln -s libutil.so.7.21 $dst/lib/libutil.so.7\n-ln -s libpthread.so.1.2 $dst/lib/libpthread.so\n-ln -s libpthread.so.1.2 $dst/lib/libpthread.so.1\n-ln -s librt.so.1.1 $dst/lib/librt.so\n+BSD=7.0.2\n \n-rm -rf netbsd\n+# Originally from ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-$BSD/source/sets/*.tgz\n+curl https://dl.timnn.me/69608745091236e7/$BSD/src.tgz | tar xzf -\n+curl https://dl.timnn.me/69608745091236e7/$BSD/gnusrc.tgz | tar xzf -\n+curl https://dl.timnn.me/69608745091236e7/$BSD/sharesrc.tgz | tar xzf -\n+curl https://dl.timnn.me/69608745091236e7/$BSD/syssrc.tgz | tar xzf -\n \n-# Finally, download and build gcc to target NetBSD\n-mkdir gcc\n-cd gcc\n-curl https://ftp.gnu.org/gnu/gcc/gcc-$GCC/gcc-$GCC.tar.bz2 | tar xjf -\n-cd gcc-$GCC\n-./contrib/download_prerequisites\n+# Originally from ftp://ftp.netbsd.org/pub/NetBSD/NetBSD-$BSD/amd64/binary/sets/*.tgz\n+curl https://dl.timnn.me/69608745091236e7/$BSD/base.tgz | \\\n+  tar xzf - -C /x-tools/x86_64-unknown-netbsd/sysroot ./usr/include ./usr/lib ./lib\n+curl https://dl.timnn.me/69608745091236e7/$BSD/comp.tgz | \\\n+  tar xzf - -C /x-tools/x86_64-unknown-netbsd/sysroot ./usr/include ./usr/lib\n \n-# Originally from\n-# ftp://ftp.netbsd.org/pub/pkgsrc/pkgsrc-2016Q4/pkgsrc/lang/gcc5/patches/patch-libstdc%2B%2B-v3_config_os_bsd_netbsd_ctype__base.h\n-PATCHES=\"https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-13-netbsd-patch1.patch\"\n+cd usr/src\n \n-# Originally from\n-# ftp://ftp.netbsd.org/pub/pkgsrc/pkgsrc-2016Q4/pkgsrc/lang/gcc5/patches/patch-libstdc%2B%2B-v3_config_os_bsd_netbsd_ctype__configure__char.cc\n-PATCHES=\"$PATCHES https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-01-13-netbsd-patch2.patch\"\n+# The options, in order, do the following\n+# * this is an unpriviledged build\n+# * output to a predictable location\n+# * disable various uneeded stuff\n+MKUNPRIVED=yes TOOLDIR=/x-tools/x86_64-unknown-netbsd \\\n+MKSHARE=no MKDOC=no MKHTML=no MKINFO=no MKKMOD=no MKLINT=no MKMAN=no MKNLS=no MKPROFILE=no \\\n+hide_output ./build.sh -j10 -m amd64 tools\n \n-for patch in $PATCHES; do\n-  curl $patch | patch -Np0\n-done\n+cd ../..\n \n-mkdir ../gcc-build\n-cd ../gcc-build\n-../gcc-$GCC/configure                            \\\n-  --enable-languages=c,c++                       \\\n-  --target=x86_64-unknown-netbsd                 \\\n-  --disable-libcilkrts                           \\\n-  --disable-multilib                             \\\n-  --disable-nls                                  \\\n-  --disable-libgomp                              \\\n-  --disable-libquadmath                          \\\n-  --disable-libssp                               \\\n-  --disable-libvtv                               \\\n-  --disable-libcilkrt                            \\\n-  --disable-libada                               \\\n-  --disable-libsanitizer                         \\\n-  --disable-libquadmath-support                  \\\n-  --disable-lto\n-make -j10\n-make install\n+rm -rf usr\n \n-cd ../..\n-rm -rf gcc\n+cat > /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc-sysroot <<'EOF'\n+#!/bin/bash\n+exec /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc --sysroot=/x-tools/x86_64-unknown-netbsd/sysroot \"$@\"\n+EOF\n+\n+cat > /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++-sysroot <<'EOF'\n+#!/bin/bash\n+exec /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++ --sysroot=/x-tools/x86_64-unknown-netbsd/sysroot \"$@\"\n+EOF\n+\n+chmod +x /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-gcc-sysroot\n+chmod +x /x-tools/x86_64-unknown-netbsd/bin/x86_64--netbsd-g++-sysroot"}, {"sha": "7f53e21675c781798dc56453abdb57cd33a3f54e", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1f656106750c7fc37f8f9d666b560294b80894f0/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f656106750c7fc37f8f9d666b560294b80894f0/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=1f656106750c7fc37f8f9d666b560294b80894f0", "patch": "@@ -131,6 +131,12 @@ fn main() {\n         if is_crossed && flag.starts_with(\"-m\") {\n             continue;\n         }\n+\n+        // -Wdate-time is not supported by the netbsd cross compiler\n+        if is_crossed && target.contains(\"netbsd\") && flag.contains(\"date-time\") {\n+            continue;\n+        }\n+\n         cfg.flag(flag);\n     }\n "}]}