{"sha": "3712e11a828af2eea273a3e7300115e65833fbc5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3MTJlMTFhODI4YWYyZWVhMjczYTNlNzMwMDExNWU2NTgzM2ZiYzU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-04-12T18:09:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-04-12T18:09:46Z"}, "message": "Auto merge of #71059 - Dylan-DPC:rollup-zgu6jmx, r=Dylan-DPC\n\nRollup of 6 pull requests\n\nSuccessful merges:\n\n - #71029 (Partial work on building with Cargo)\n - #71034 (Clean up E0515 explanation)\n - #71041 (Update links of `rustc guide`)\n - #71048 (Normalize source when loading external foreign source into SourceMap)\n - #71053 (Add some basic docs to `sym` and `kw` modules)\n - #71057 (Clean up E0516 explanation)\n\nFailed merges:\n\nr? @ghost", "tree": {"sha": "25f15900e3c1fbcf71c284c230826a2fe47bdfcf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/25f15900e3c1fbcf71c284c230826a2fe47bdfcf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3712e11a828af2eea273a3e7300115e65833fbc5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3712e11a828af2eea273a3e7300115e65833fbc5", "html_url": "https://github.com/rust-lang/rust/commit/3712e11a828af2eea273a3e7300115e65833fbc5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3712e11a828af2eea273a3e7300115e65833fbc5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d1fbaccb822b6d52dc786589de7918d3c5effb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d1fbaccb822b6d52dc786589de7918d3c5effb1", "html_url": "https://github.com/rust-lang/rust/commit/4d1fbaccb822b6d52dc786589de7918d3c5effb1"}, {"sha": "e6846306667ae12a8c31ccac5352bde7cfe79dfc", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6846306667ae12a8c31ccac5352bde7cfe79dfc", "html_url": "https://github.com/rust-lang/rust/commit/e6846306667ae12a8c31ccac5352bde7cfe79dfc"}], "stats": {"total": 158, "additions": 118, "deletions": 40}, "files": [{"sha": "73d276d1776489d6200e3b087678500881c15bab", "filename": "Cargo.lock", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -3694,6 +3694,7 @@ dependencies = [\n  \"indexmap\",\n  \"jobserver\",\n  \"lazy_static 1.4.0\",\n+ \"libc\",\n  \"log\",\n  \"measureme\",\n  \"parking_lot 0.10.0\",\n@@ -3713,6 +3714,7 @@ version = \"0.0.0\"\n dependencies = [\n  \"env_logger 0.7.1\",\n  \"lazy_static 1.4.0\",\n+ \"libc\",\n  \"log\",\n  \"rustc_ast\",\n  \"rustc_ast_pretty\",\n@@ -3867,6 +3869,7 @@ dependencies = [\n name = \"rustc_interface\"\n version = \"0.0.0\"\n dependencies = [\n+ \"libc\",\n  \"log\",\n  \"once_cell\",\n  \"rustc-rayon\",\n@@ -3960,6 +3963,7 @@ name = \"rustc_metadata\"\n version = \"0.0.0\"\n dependencies = [\n  \"flate2\",\n+ \"libc\",\n  \"log\",\n  \"memmap\",\n  \"rustc_ast\",\n@@ -4197,6 +4201,7 @@ dependencies = [\n name = \"rustc_session\"\n version = \"0.0.0\"\n dependencies = [\n+ \"getopts\",\n  \"log\",\n  \"num_cpus\",\n  \"rustc_ast\","}, {"sha": "f44096af6dd53bb9c7a314de2f075f54278368e3", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -186,6 +186,8 @@ pub fn std_cargo(builder: &Builder<'_>, target: Interned<String>, cargo: &mut Ca\n     // `compiler-rt` is located.\n     let compiler_builtins_root = builder.src.join(\"src/llvm-project/compiler-rt\");\n     let compiler_builtins_c_feature = if compiler_builtins_root.exists() {\n+        // Note that `libprofiler_builtins/build.rs` also computes this so if\n+        // you're changing something here please also change that.\n         cargo.env(\"RUST_COMPILER_RT_ROOT\", &compiler_builtins_root);\n         \" compiler-builtins-c\".to_string()\n     } else {"}, {"sha": "e23e2f2c1306f6a4caece4226eba825a4b9bbd63", "filename": "src/libprofiler_builtins/build.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibprofiler_builtins%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibprofiler_builtins%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibprofiler_builtins%2Fbuild.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -63,8 +63,9 @@ fn main() {\n         cfg.define(\"COMPILER_RT_HAS_ATOMICS\", Some(\"1\"));\n     }\n \n-    let root = env::var_os(\"RUST_COMPILER_RT_ROOT\").unwrap();\n-    let root = Path::new(&root);\n+    // Note that this should exist if we're going to run (otherwise we just\n+    // don't build profiler builtins at all).\n+    let root = Path::new(\"../llvm-project/compiler-rt\");\n \n     let src_root = root.join(\"lib\").join(\"profile\");\n     for src in profile_sources {"}, {"sha": "6d7022acc7863d54aafbeec27c08725f5f845ba3", "filename": "src/librustc_data_structures/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_data_structures%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_data_structures%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2FCargo.toml?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -27,6 +27,7 @@ smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }\n rustc_index = { path = \"../librustc_index\", package = \"rustc_index\" }\n bitflags = \"1.2.1\"\n measureme = \"0.7.1\"\n+libc = \"0.2\"\n \n [dependencies.parking_lot]\n version = \"0.10\""}, {"sha": "d0180911567c7e0244ca39954e5eb1d445e350db", "filename": "src/librustc_data_structures/lib.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_data_structures%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_data_structures%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -26,8 +26,6 @@\n \n #[macro_use]\n extern crate log;\n-#[cfg(unix)]\n-extern crate libc;\n #[macro_use]\n extern crate cfg_if;\n "}, {"sha": "cfd103aed3240832e0c2eb83b9da6e0e179a58ee", "filename": "src/librustc_driver/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_driver%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_driver%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2FCargo.toml?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -11,6 +11,7 @@ crate-type = [\"dylib\"]\n \n [dependencies]\n lazy_static = \"1.0\"\n+libc = \"0.2\"\n log = \"0.4\"\n env_logger = { version = \"0.7\", default-features = false }\n rustc_middle = { path = \"../librustc_middle\" }"}, {"sha": "0e3199975f9becf3d1a6125f8b5be5440851eb7a", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -8,9 +8,6 @@\n #![feature(nll)]\n #![recursion_limit = \"256\"]\n \n-pub extern crate getopts;\n-#[cfg(unix)]\n-extern crate libc;\n #[macro_use]\n extern crate log;\n #[macro_use]\n@@ -37,6 +34,7 @@ use rustc_save_analysis::DumpHandler;\n use rustc_serialize::json::{self, ToJson};\n use rustc_session::config::nightly_options;\n use rustc_session::config::{ErrorOutputType, Input, OutputType, PrintRequest};\n+use rustc_session::getopts;\n use rustc_session::lint::{Lint, LintId};\n use rustc_session::{config, DiagnosticOutput, Session};\n use rustc_session::{early_error, early_warn};"}, {"sha": "0f4fbf672239c83c6ad8e6e73f918f43586e7a79", "filename": "src/librustc_error_codes/error_codes/E0515.md", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_error_codes%2Ferror_codes%2FE0515.md", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_error_codes%2Ferror_codes%2FE0515.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_error_codes%2Ferror_codes%2FE0515.md?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1,7 +1,4 @@\n-Cannot return value that references local variable\n-\n-Local variables, function parameters and temporaries are all dropped before the\n-end of the function body. So a reference to them cannot be returned.\n+A reference to a local variable was returned.\n \n Erroneous code example:\n \n@@ -20,6 +17,9 @@ fn get_dangling_iterator<'a>() -> Iter<'a, i32> {\n }\n ```\n \n+Local variables, function parameters and temporaries are all dropped before the\n+end of the function body. So a reference to them cannot be returned.\n+\n Consider returning an owned value instead:\n \n ```"}, {"sha": "935c31bbab98a5797921d9ccc5e781751414dc08", "filename": "src/librustc_error_codes/error_codes/E0516.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_error_codes%2Ferror_codes%2FE0516.md", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_error_codes%2Ferror_codes%2FE0516.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_error_codes%2Ferror_codes%2FE0516.md?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1,4 +1,5 @@\n The `typeof` keyword is currently reserved but unimplemented.\n+\n Erroneous code example:\n \n ```compile_fail,E0516"}, {"sha": "2210c663d146940673ab52392c028d73a249b42b", "filename": "src/librustc_infer/traits/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_infer%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_infer%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_infer%2Ftraits%2Fmod.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1,6 +1,6 @@\n-//! Trait Resolution. See the [rustc guide] for more information on how this works.\n+//! Trait Resolution. See the [rustc-dev-guide] for more information on how this works.\n //!\n-//! [rustc guide]: https://rust-lang.github.io/rustc-guide/traits/resolution.html\n+//! [rustc-dev-guide]: https://rustc-dev-guide.rust-lang.org/traits/resolution.html\n \n mod engine;\n pub mod error_reporting;"}, {"sha": "8ea866d7cab5ca76a74ea79da4880a611e7792b1", "filename": "src/librustc_interface/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_interface%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_interface%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2FCargo.toml?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -10,6 +10,7 @@ path = \"lib.rs\"\n doctest = false\n \n [dependencies]\n+libc = \"0.2\"\n log = \"0.4\"\n rayon = { version = \"0.3.0\", package = \"rustc-rayon\" }\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }"}, {"sha": "0650d09003486d620bde8fdee48d3709de8079cc", "filename": "src/librustc_interface/lib.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_interface%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_interface%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -6,9 +6,6 @@\n #![feature(generators)]\n #![recursion_limit = \"256\"]\n \n-#[cfg(unix)]\n-extern crate libc;\n-\n mod callbacks;\n pub mod interface;\n mod passes;"}, {"sha": "c75f3b279a258396935b6fd0b17a312bdc972563", "filename": "src/librustc_interface/tests.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_interface%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_interface%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Ftests.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1,5 +1,3 @@\n-extern crate getopts;\n-\n use crate::interface::parse_cfgspecs;\n \n use rustc_data_structures::fx::FxHashSet;\n@@ -9,6 +7,7 @@ use rustc_session::config::{build_configuration, build_session_options, to_crate\n use rustc_session::config::{rustc_optgroups, ErrorOutputType, ExternLocation, Options, Passes};\n use rustc_session::config::{ExternEntry, LinkerPluginLto, LtoCli, SwitchWithOptPath};\n use rustc_session::config::{Externs, OutputType, OutputTypes, SymbolManglingVersion};\n+use rustc_session::getopts;\n use rustc_session::lint::Level;\n use rustc_session::search_paths::SearchPath;\n use rustc_session::{build_session, Session};"}, {"sha": "f14fc9fc2eba8897fc47462cdf10145f47ae17cb", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 20, "deletions": 10, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -24,18 +24,28 @@ fn main() {\n     build_helper::restore_library_path();\n \n     let target = env::var(\"TARGET\").expect(\"TARGET was not set\");\n-    let llvm_config = env::var_os(\"LLVM_CONFIG\").map(PathBuf::from).unwrap_or_else(|| {\n-        if let Some(dir) = env::var_os(\"CARGO_TARGET_DIR\").map(PathBuf::from) {\n-            let to_test =\n-                dir.parent().unwrap().parent().unwrap().join(&target).join(\"llvm/bin/llvm-config\");\n-            if Command::new(&to_test).output().is_ok() {\n-                return to_test;\n+    let llvm_config =\n+        env::var_os(\"LLVM_CONFIG\").map(|x| Some(PathBuf::from(x))).unwrap_or_else(|| {\n+            if let Some(dir) = env::var_os(\"CARGO_TARGET_DIR\").map(PathBuf::from) {\n+                let to_test = dir\n+                    .parent()\n+                    .unwrap()\n+                    .parent()\n+                    .unwrap()\n+                    .join(&target)\n+                    .join(\"llvm/bin/llvm-config\");\n+                if Command::new(&to_test).output().is_ok() {\n+                    return Some(to_test);\n+                }\n             }\n-        }\n-        PathBuf::from(\"llvm-config\")\n-    });\n+            None\n+        });\n+\n+    if let Some(llvm_config) = &llvm_config {\n+        println!(\"cargo:rerun-if-changed={}\", llvm_config.display());\n+    }\n+    let llvm_config = llvm_config.unwrap_or_else(|| PathBuf::from(\"llvm-config\"));\n \n-    println!(\"cargo:rerun-if-changed={}\", llvm_config.display());\n     println!(\"cargo:rerun-if-env-changed=LLVM_CONFIG\");\n \n     // Test whether we're cross-compiling LLVM. This is a pretty rare case"}, {"sha": "b03e884cdaf7ac3f62623820b19619b793ce1fbd", "filename": "src/librustc_metadata/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_metadata%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_metadata%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2FCargo.toml?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -11,6 +11,7 @@ doctest = false\n \n [dependencies]\n flate2 = \"1.0\"\n+libc = \"0.2\"\n log = \"0.4\"\n memmap = \"0.7\"\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }"}, {"sha": "4659be8c195adb84c732cf5d82b06bbdc55df6b8", "filename": "src/librustc_metadata/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_metadata%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_metadata%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -10,7 +10,6 @@\n #![feature(stmt_expr_attributes)]\n #![recursion_limit = \"256\"]\n \n-extern crate libc;\n extern crate proc_macro;\n \n #[macro_use]"}, {"sha": "814073bb4f7be06b202f3825e1be1a3a64675422", "filename": "src/librustc_session/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_session%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_session%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2FCargo.toml?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -9,6 +9,7 @@ name = \"rustc_session\"\n path = \"lib.rs\"\n \n [dependencies]\n+getopts = \"0.2\"\n log = \"0.4\"\n rustc_errors = { path = \"../librustc_errors\" }\n rustc_feature = { path = \"../librustc_feature\" }"}, {"sha": "2ff92c46d12514c7b05d8b94f58a56c1c9200da0", "filename": "src/librustc_session/lib.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_session%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_session%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1,10 +1,4 @@\n #![feature(crate_visibility_modifier)]\n-#![feature(test)]\n-\n-// Use the test crate here so we depend on getopts through it. This allow tools to link to both\n-// librustc_session and libtest.\n-extern crate getopts;\n-extern crate test as _;\n \n pub mod cgu_reuse_tracker;\n pub mod utils;\n@@ -23,3 +17,5 @@ mod session;\n pub use session::*;\n \n pub mod output;\n+\n+pub use getopts;"}, {"sha": "85a870ae34c11b0bbd97a5fdb96b3c1a3ba63a39", "filename": "src/librustc_span/lib.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_span%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_span%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1192,8 +1192,10 @@ impl SourceFile {\n                 kind: src_kind @ ExternalSourceKind::AbsentOk, ..\n             } = &mut *external_src\n             {\n-                if let Some(src) = src {\n+                if let Some(mut src) = src {\n+                    // The src_hash needs to be computed on the pre-normalized src.\n                     if self.src_hash.matches(&src) {\n+                        normalize_src(&mut src, BytePos::from_usize(0));\n                         *src_kind = ExternalSourceKind::Present(Lrc::new(src));\n                         return true;\n                     }"}, {"sha": "b8459eee4ecf0e6a84ba86cd6e0ff48b32a5c114", "filename": "src/librustc_span/source_map/tests.rs", "status": "modified", "additions": 56, "deletions": 0, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_span%2Fsource_map%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_span%2Fsource_map%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Fsource_map%2Ftests.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -168,6 +168,62 @@ fn span_merging_fail() {\n     assert!(sm.merge_spans(span1, span2).is_none());\n }\n \n+/// Tests loading an external source file that requires normalization.\n+#[test]\n+fn t10() {\n+    let sm = SourceMap::new(FilePathMapping::empty());\n+    let unnormalized = \"first line.\\r\\nsecond line\";\n+    let normalized = \"first line.\\nsecond line\";\n+\n+    let src_file = sm.new_source_file(PathBuf::from(\"blork.rs\").into(), unnormalized.to_string());\n+\n+    assert_eq!(src_file.src.as_ref().unwrap().as_ref(), normalized);\n+    assert!(\n+        src_file.src_hash.matches(unnormalized),\n+        \"src_hash should use the source before normalization\"\n+    );\n+\n+    let SourceFile {\n+        name,\n+        name_was_remapped,\n+        src_hash,\n+        start_pos,\n+        end_pos,\n+        lines,\n+        multibyte_chars,\n+        non_narrow_chars,\n+        normalized_pos,\n+        name_hash,\n+        ..\n+    } = (*src_file).clone();\n+\n+    let imported_src_file = sm.new_imported_source_file(\n+        name,\n+        name_was_remapped,\n+        src_hash,\n+        name_hash,\n+        (end_pos - start_pos).to_usize(),\n+        CrateNum::new(0),\n+        lines,\n+        multibyte_chars,\n+        non_narrow_chars,\n+        normalized_pos,\n+        start_pos,\n+        end_pos,\n+    );\n+\n+    assert!(\n+        imported_src_file.external_src.borrow().get_source().is_none(),\n+        \"imported source file should not have source yet\"\n+    );\n+    imported_src_file.add_external_src(|| Some(unnormalized.to_string()));\n+    assert_eq!(\n+        imported_src_file.external_src.borrow().get_source().unwrap().as_ref(),\n+        normalized,\n+        \"imported source file should be normalized\"\n+    );\n+}\n+\n /// Returns the span corresponding to the `n`th occurrence of `substring` in `source_text`.\n trait SourceMapExtension {\n     fn span_substr("}, {"sha": "4c963ac84dc85c1f3b93f1013bb1ebcbd467efdb", "filename": "src/librustc_span/symbol.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_span%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_span%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Fsymbol.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -1153,12 +1153,20 @@ impl Interner {\n }\n \n // This module has a very short name because it's used a lot.\n+/// This module contains all the defined keyword `Symbol`s.\n+///\n+/// Given that `kw` is imported, use them like `kw::keyword_name`.\n+/// For example `kw::Loop` or `kw::Break`.\n pub mod kw {\n     use super::Symbol;\n     keywords!();\n }\n \n // This module has a very short name because it's used a lot.\n+/// This module contains all the defined non-keyword `Symbol`s.\n+///\n+/// Given that `sym` is imported, use them like `sym::symbol_name`.\n+/// For example `sym::rustfmt` or `sym::u8`.\n #[allow(rustc::default_hash_types)]\n pub mod sym {\n     use super::Symbol;"}, {"sha": "4796b431d8dca0c260794f4d20c50fbf1bda802f", "filename": "src/librustc_trait_selection/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_trait_selection%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustc_trait_selection%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -2,9 +2,9 @@\n //!\n //! - **Traits.** Trait resolution is implemented in the `traits` module.\n //!\n-//! For more information about how rustc works, see the [rustc guide].\n+//! For more information about how rustc works, see the [rustc-dev-guide].\n //!\n-//! [rustc guide]: https://rust-lang.github.io/rustc-guide/\n+//! [rustc-dev-guide]: https://rustc-dev-guide.rust-lang.org/\n //!\n //! # Note\n //!"}, {"sha": "a5a1e20396cafd5f79e8fd4d85f0c7dfadf2f02a", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -10,6 +10,7 @@ use rustc_session::config::{\n     nightly_options,\n };\n use rustc_session::config::{CodegenOptions, DebuggingOptions, ErrorOutputType, Externs};\n+use rustc_session::getopts;\n use rustc_session::lint::Level;\n use rustc_session::search_paths::SearchPath;\n use rustc_span::edition::{Edition, DEFAULT_EDITION};"}, {"sha": "b0d5a8e58e1201f84c6ff76f2638b1abf6615008", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -15,7 +15,6 @@\n #![recursion_limit = \"256\"]\n \n extern crate env_logger;\n-extern crate getopts;\n extern crate rustc_ast;\n extern crate rustc_ast_pretty;\n extern crate rustc_attr;\n@@ -51,6 +50,7 @@ use std::panic;\n use std::process;\n \n use rustc_session::config::{make_crate_type_option, ErrorOutputType, RustcOptGroup};\n+use rustc_session::getopts;\n use rustc_session::{early_error, early_warn};\n \n #[macro_use]"}, {"sha": "ceb39c01c6723442d8ff7ec15d8d20c5f9d79644", "filename": "src/libstd/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibstd%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3712e11a828af2eea273a3e7300115e65833fbc5/src%2Flibstd%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2FCargo.toml?ref=3712e11a828af2eea273a3e7300115e65833fbc5", "patch": "@@ -47,7 +47,7 @@ hermit-abi = { version = \"0.1.10\", features = ['rustc-dep-of-std'] }\n wasi = { version = \"0.9.0\", features = ['rustc-dep-of-std'], default-features = false }\n \n [features]\n-default = [\"std_detect_file_io\", \"std_detect_dlsym_getauxval\"]\n+default = [\"std_detect_file_io\", \"std_detect_dlsym_getauxval\", \"panic-unwind\"]\n \n backtrace = [\n   \"backtrace_rs/dbghelp\",          # backtrace/symbolize on MSVC"}]}