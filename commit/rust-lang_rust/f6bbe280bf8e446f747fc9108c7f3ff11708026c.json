{"sha": "f6bbe280bf8e446f747fc9108c7f3ff11708026c", "node_id": "C_kwDOAAsO6NoAKGY2YmJlMjgwYmY4ZTQ0NmY3NDdmYzkxMDhjN2YzZmYxMTcwODAyNmM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-07T12:36:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-07T12:36:48Z"}, "message": "Rollup merge of #96856 - DrMeepster:fix_projection_validation, r=Icnr\n\nFix ProjectionElem validation\n\n`TypeChecker::visit_projection_elem` was not actually being called.", "tree": {"sha": "6143a2033b6b9f23dab46eb030cb4f3827bddb36", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6143a2033b6b9f23dab46eb030cb4f3827bddb36"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6bbe280bf8e446f747fc9108c7f3ff11708026c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJixtNgCRBK7hj4Ov3rIwAAGEwIAEFZexcbG8vAl27YsIz6LpQX\n/Kmex4iFnayPMNGwIbwN/1pWy9K98OMhKyaahZSsPh7Nz6zNJ8dlZfuj4l2DTIaz\nnMoe4bo3uFgRqLsLkgvGjQcaWYVXDaUslyK8Bg2QWggcjPBWKGXQaTjCzX9DA2j+\n8Vpqfj2tq/Id3Uiuu8jPOFu6YgTwWxBiFpa2sMBr1AmILbVmh1C7jEUdS2d9flQ9\nT66iOOB2Sf3f5hn6LYBJzmvUzlZFnMN2ek7gKjQ66pADNCVoeH6BpvkkfRTN3nIF\nDXdwAxY8tJ95mqN0AidKo0IusPUcyDcbxU9nNb4ygkLNo8edE4zN+n3qALf/f/g=\n=gRfl\n-----END PGP SIGNATURE-----\n", "payload": "tree 6143a2033b6b9f23dab46eb030cb4f3827bddb36\nparent c461f7a16e8372216dbf7a54ab86ee958bec83b5\nparent a2799b2de80bafe8039c2cf7ea33754e0558acb1\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1657197408 +0530\ncommitter GitHub <noreply@github.com> 1657197408 +0530\n\nRollup merge of #96856 - DrMeepster:fix_projection_validation, r=Icnr\n\nFix ProjectionElem validation\n\n`TypeChecker::visit_projection_elem` was not actually being called.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6bbe280bf8e446f747fc9108c7f3ff11708026c", "html_url": "https://github.com/rust-lang/rust/commit/f6bbe280bf8e446f747fc9108c7f3ff11708026c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6bbe280bf8e446f747fc9108c7f3ff11708026c/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c461f7a16e8372216dbf7a54ab86ee958bec83b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/c461f7a16e8372216dbf7a54ab86ee958bec83b5", "html_url": "https://github.com/rust-lang/rust/commit/c461f7a16e8372216dbf7a54ab86ee958bec83b5"}, {"sha": "a2799b2de80bafe8039c2cf7ea33754e0558acb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2799b2de80bafe8039c2cf7ea33754e0558acb1", "html_url": "https://github.com/rust-lang/rust/commit/a2799b2de80bafe8039c2cf7ea33754e0558acb1"}], "stats": {"total": 53, "additions": 45, "deletions": 8}, "files": [{"sha": "56ecc5535285bcc5393f71d18a6b7bd6069b33e0", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 43, "deletions": 6, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/f6bbe280bf8e446f747fc9108c7f3ff11708026c/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6bbe280bf8e446f747fc9108c7f3ff11708026c/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=f6bbe280bf8e446f747fc9108c7f3ff11708026c", "patch": "@@ -12,6 +12,7 @@ use rustc_middle::mir::{\n     Statement, StatementKind, Terminator, TerminatorKind, UnOp, START_BLOCK,\n };\n use rustc_middle::ty::fold::BottomUpFolder;\n+use rustc_middle::ty::subst::Subst;\n use rustc_middle::ty::{self, InstanceDef, ParamEnv, Ty, TyCtxt, TypeFoldable, TypeVisitable};\n use rustc_mir_dataflow::impls::MaybeStorageLive;\n use rustc_mir_dataflow::storage::always_live_locals;\n@@ -275,7 +276,14 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                     }\n                 };\n \n-                match parent_ty.ty.kind() {\n+                let kind = match parent_ty.ty.kind() {\n+                    &ty::Opaque(def_id, substs) => {\n+                        self.tcx.bound_type_of(def_id).subst(self.tcx, substs).kind()\n+                    }\n+                    kind => kind,\n+                };\n+\n+                match kind {\n                     ty::Tuple(fields) => {\n                         let Some(f_ty) = fields.get(f.as_usize()) else {\n                             fail_out_of_bounds(self, location);\n@@ -299,12 +307,39 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                         };\n                         check_equal(self, location, f_ty);\n                     }\n-                    ty::Generator(_, substs, _) => {\n-                        let substs = substs.as_generator();\n-                        let Some(f_ty) = substs.upvar_tys().nth(f.as_usize()) else {\n-                            fail_out_of_bounds(self, location);\n-                            return;\n+                    &ty::Generator(def_id, substs, _) => {\n+                        let f_ty = if let Some(var) = parent_ty.variant_index {\n+                            let gen_body = if def_id == self.body.source.def_id() {\n+                                self.body\n+                            } else {\n+                                self.tcx.optimized_mir(def_id)\n+                            };\n+\n+                            let Some(layout) = gen_body.generator_layout() else {\n+                                self.fail(location, format!(\"No generator layout for {:?}\", parent_ty));\n+                                return;\n+                            };\n+\n+                            let Some(&local) = layout.variant_fields[var].get(f) else {\n+                                fail_out_of_bounds(self, location);\n+                                return;\n+                            };\n+\n+                            let Some(&f_ty) = layout.field_tys.get(local) else {\n+                                self.fail(location, format!(\"Out of bounds local {:?} for {:?}\", local, parent_ty));\n+                                return;\n+                            };\n+\n+                            f_ty\n+                        } else {\n+                            let Some(f_ty) = substs.as_generator().prefix_tys().nth(f.index()) else {\n+                                fail_out_of_bounds(self, location);\n+                                return;\n+                            };\n+\n+                            f_ty\n                         };\n+\n                         check_equal(self, location, f_ty);\n                     }\n                     _ => {\n@@ -328,6 +363,8 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n         {\n             self.fail(location, format!(\"{:?}, has deref at the wrong place\", place));\n         }\n+\n+        self.super_place(place, cntxt, location);\n     }\n \n     fn visit_rvalue(&mut self, rvalue: &Rvalue<'tcx>, location: Location) {"}, {"sha": "ebc3e2f8c0e314fcf2beba517bca0b533699ff2b", "filename": "src/test/ui/mir/ssa-analysis-regression-50041.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f6bbe280bf8e446f747fc9108c7f3ff11708026c/src%2Ftest%2Fui%2Fmir%2Fssa-analysis-regression-50041.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6bbe280bf8e446f747fc9108c7f3ff11708026c/src%2Ftest%2Fui%2Fmir%2Fssa-analysis-regression-50041.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fssa-analysis-regression-50041.rs?ref=f6bbe280bf8e446f747fc9108c7f3ff11708026c", "patch": "@@ -5,7 +5,7 @@\n #![feature(lang_items)]\n #![no_std]\n \n-struct NonNull<T: ?Sized>(*mut T);\n+struct NonNull<T: ?Sized>(*const T);\n \n struct Unique<T: ?Sized>(NonNull<T>);\n \n@@ -23,7 +23,7 @@ unsafe fn box_free<T: ?Sized>(ptr: Unique<T>) {\n }\n \n #[inline(never)]\n-fn dealloc<T: ?Sized>(_: *mut T) {}\n+fn dealloc<T: ?Sized>(_: *const T) {}\n \n pub struct Foo<T>(T);\n "}]}