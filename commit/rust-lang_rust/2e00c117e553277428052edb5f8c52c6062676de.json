{"sha": "2e00c117e553277428052edb5f8c52c6062676de", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlMDBjMTE3ZTU1MzI3NzQyODA1MmVkYjVmOGM1MmM2MDYyNjc2ZGU=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-04-14T11:25:47Z"}, "committer": {"name": "Seiichi Uchida", "email": "topecongiro@localhost.localdomain", "date": "2017-05-02T01:21:39Z"}, "message": "Handle empty tuple struct def properly", "tree": {"sha": "08b192253fb97615969d57f509fe745511bffc96", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08b192253fb97615969d57f509fe745511bffc96"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e00c117e553277428052edb5f8c52c6062676de", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e00c117e553277428052edb5f8c52c6062676de", "html_url": "https://github.com/rust-lang/rust/commit/2e00c117e553277428052edb5f8c52c6062676de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e00c117e553277428052edb5f8c52c6062676de/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "b4794dbd9fafc4e889dab9690addaf482a59641d", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4794dbd9fafc4e889dab9690addaf482a59641d", "html_url": "https://github.com/rust-lang/rust/commit/b4794dbd9fafc4e889dab9690addaf482a59641d"}], "stats": {"total": 124, "additions": 74, "deletions": 50}, "files": [{"sha": "ff24a87ec60621afdacab52228af895d8ab73b8a", "filename": "src/items.rs", "status": "modified", "additions": 74, "deletions": 50, "changes": 124, "blob_url": "https://github.com/rust-lang/rust/blob/2e00c117e553277428052edb5f8c52c6062676de/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e00c117e553277428052edb5f8c52c6062676de/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=2e00c117e553277428052edb5f8c52c6062676de", "patch": "@@ -908,7 +908,6 @@ fn format_struct_struct(context: &RewriteContext,\n     };\n     result.push_str(&generics_str);\n \n-    // FIXME(#919): properly format empty structs and their comments.\n     if fields.is_empty() {\n         let snippet = context.snippet(mk_sp(body_lo, span.hi - BytePos(1)));\n         if snippet.trim().is_empty() {\n@@ -995,9 +994,8 @@ fn format_tuple_struct(context: &RewriteContext,\n     let header_str = format_header(item_name, ident, vis);\n     result.push_str(&header_str);\n \n-    // FIXME(#919): don't lose comments on empty tuple structs.\n     let body_lo = if fields.is_empty() {\n-        span.hi\n+        context.codemap.span_after(span, \"(\")\n     } else {\n         fields[0].span.lo\n     };\n@@ -1027,58 +1025,84 @@ fn format_tuple_struct(context: &RewriteContext,\n         None => \"\".to_owned(),\n     };\n \n-    let (tactic, item_indent) = match context.config.fn_args_layout {\n-        IndentStyle::Visual => {\n-            // 1 = `(`\n-            (ListTactic::HorizontalVertical, offset.block_only() + result.len() + 1)\n-        }\n-        IndentStyle::Block => {\n-            (ListTactic::HorizontalVertical, offset.block_only().block_indent(&context.config))\n-        }\n-    };\n-    // 3 = `();`\n-    let item_budget = try_opt!(context\n-                                   .config\n-                                   .max_width\n-                                   .checked_sub(item_indent.width() + 3));\n-    let shape = Shape::legacy(item_budget, item_indent);\n-\n-    let items = itemize_list(context.codemap,\n-                             fields.iter(),\n-                             \")\",\n-                             |field| {\n-                                 // Include attributes and doc comments, if present\n-                                 if !field.attrs.is_empty() {\n-                                     field.attrs[0].span.lo\n-                                 } else {\n-                                     field.span.lo\n-                                 }\n-                             },\n-                             |field| field.ty.span.hi,\n-                             |field| field.rewrite(context, shape),\n-                             context.codemap.span_after(span, \"(\"),\n-                             span.hi);\n-    let body = try_opt!(list_helper(items, shape, context.config, tactic));\n-\n-    if context.config.fn_args_layout == IndentStyle::Visual || !body.contains('\\n') {\n+    if fields.is_empty() {\n         result.push('(');\n-        if context.config.spaces_within_parens && body.len() > 0 {\n-            result.push(' ');\n+        let snippet = context.snippet(mk_sp(body_lo, context.codemap.span_before(span, \")\")));\n+        if snippet.is_empty() {\n+            //\n+        } else if snippet\n+                      .trim_right_matches(&[' ', '\\t'][..])\n+                      .ends_with('\\n') {\n+            result.push_str(&snippet.trim_right());\n+            result.push('\\n');\n+            result.push_str(&offset.to_string(context.config));\n+        } else {\n+            result.push_str(&snippet);\n         }\n+        result.push(')');\n+    } else {\n+        let (tactic, item_indent) = match context.config.fn_args_layout {\n+            IndentStyle::Visual => {\n+                // 1 = `(`\n+                (ListTactic::HorizontalVertical, offset.block_only() + result.len() + 1)\n+            }\n+            IndentStyle::Block => {\n+                (ListTactic::HorizontalVertical, offset.block_only().block_indent(&context.config))\n+            }\n+        };\n+        // 3 = `();`\n+        let item_budget = try_opt!(context\n+                                       .config\n+                                       .max_width\n+                                       .checked_sub(item_indent.width() + 3));\n+\n+        let items =\n+            itemize_list(context.codemap,\n+                         fields.iter(),\n+                         \")\",\n+                         |field| {\n+                             // Include attributes and doc comments, if present\n+                             if !field.attrs.is_empty() {\n+                                 field.attrs[0].span.lo\n+                             } else {\n+                                 field.span.lo\n+                             }\n+                         },\n+                         |field| field.ty.span.hi,\n+                         |field| field.rewrite(context, Shape::legacy(item_budget, item_indent)),\n+                         context.codemap.span_after(span, \"(\"),\n+                         span.hi);\n+        let body_budget = try_opt!(context\n+                                       .config\n+                                       .max_width\n+                                       .checked_sub(offset.block_only().width() + result.len() +\n+                                                    3));\n+        let body = try_opt!(list_helper(items,\n+                                        // TODO budget is wrong in block case\n+                                        Shape::legacy(body_budget, item_indent),\n+                                        context.config,\n+                                        tactic));\n+\n+        if context.config.fn_args_layout == IndentStyle::Visual || !body.contains('\\n') {\n+            result.push('(');\n+            if context.config.spaces_within_parens && body.len() > 0 {\n+                result.push(' ');\n+            }\n \n-        result.push_str(&body);\n+            result.push_str(&body);\n \n-        if context.config.spaces_within_parens && body.len() > 0 {\n-            result.push(' ');\n+            if context.config.spaces_within_parens && body.len() > 0 {\n+                result.push(' ');\n+            }\n+            result.push(')');\n+        } else {\n+            result.push_str(\"(\\n\");\n+            result.push_str(&item_indent.to_string(&context.config));\n+            result.push_str(&body);\n+            result.push('\\n');\n+            result.push_str(&offset.block_only().to_string(&context.config));\n+            result.push(')');\n         }\n-        result.push(')');\n-    } else {\n-        result.push_str(\"(\\n\");\n-        result.push_str(&item_indent.to_string(&context.config));\n-        result.push_str(&body);\n-        result.push('\\n');\n-        result.push_str(&offset.block_only().to_string(&context.config));\n-        result.push(')');\n     }\n \n     if !where_clause_str.is_empty() && !where_clause_str.contains('\\n') &&"}]}