{"sha": "04bff17668be1305d9efe235665a32727ff3e0b5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA0YmZmMTc2NjhiZTEzMDVkOWVmZTIzNTY2NWEzMjcyN2ZmM2UwYjU=", "commit": {"author": {"name": "Takayuki Nakata", "email": "f.seasons017@gmail.com", "date": "2020-08-27T14:37:47Z"}, "committer": {"name": "Takayuki Nakata", "email": "f.seasons017@gmail.com", "date": "2020-08-27T14:37:47Z"}, "message": "Fix FP in `to_string_in_display`\n\nDon't emit a lint when `.to_string()` on anything that is not `self`", "tree": {"sha": "5585c6f3c783355770fd3a03a02945b4c613e2f1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5585c6f3c783355770fd3a03a02945b4c613e2f1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/04bff17668be1305d9efe235665a32727ff3e0b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/04bff17668be1305d9efe235665a32727ff3e0b5", "html_url": "https://github.com/rust-lang/rust/commit/04bff17668be1305d9efe235665a32727ff3e0b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/04bff17668be1305d9efe235665a32727ff3e0b5/comments", "author": {"login": "giraffate", "id": 17407489, "node_id": "MDQ6VXNlcjE3NDA3NDg5", "avatar_url": "https://avatars.githubusercontent.com/u/17407489?v=4", "gravatar_id": "", "url": "https://api.github.com/users/giraffate", "html_url": "https://github.com/giraffate", "followers_url": "https://api.github.com/users/giraffate/followers", "following_url": "https://api.github.com/users/giraffate/following{/other_user}", "gists_url": "https://api.github.com/users/giraffate/gists{/gist_id}", "starred_url": "https://api.github.com/users/giraffate/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/giraffate/subscriptions", "organizations_url": "https://api.github.com/users/giraffate/orgs", "repos_url": "https://api.github.com/users/giraffate/repos", "events_url": "https://api.github.com/users/giraffate/events{/privacy}", "received_events_url": "https://api.github.com/users/giraffate/received_events", "type": "User", "site_admin": false}, "committer": {"login": "giraffate", "id": 17407489, "node_id": "MDQ6VXNlcjE3NDA3NDg5", "avatar_url": "https://avatars.githubusercontent.com/u/17407489?v=4", "gravatar_id": "", "url": "https://api.github.com/users/giraffate", "html_url": "https://github.com/giraffate", "followers_url": "https://api.github.com/users/giraffate/followers", "following_url": "https://api.github.com/users/giraffate/following{/other_user}", "gists_url": "https://api.github.com/users/giraffate/gists{/gist_id}", "starred_url": "https://api.github.com/users/giraffate/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/giraffate/subscriptions", "organizations_url": "https://api.github.com/users/giraffate/orgs", "repos_url": "https://api.github.com/users/giraffate/repos", "events_url": "https://api.github.com/users/giraffate/events{/privacy}", "received_events_url": "https://api.github.com/users/giraffate/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64c4bb0d2bac5f7810d7d0fa6ad846417b3ca60a", "url": "https://api.github.com/repos/rust-lang/rust/commits/64c4bb0d2bac5f7810d7d0fa6ad846417b3ca60a", "html_url": "https://github.com/rust-lang/rust/commit/64c4bb0d2bac5f7810d7d0fa6ad846417b3ca60a"}], "stats": {"total": 46, "additions": 41, "deletions": 5}, "files": [{"sha": "006d7a3a12d9ae56d06f0774abc75532d97f095f", "filename": "clippy_lints/src/to_string_in_display.rs", "status": "modified", "additions": 27, "deletions": 5, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/04bff17668be1305d9efe235665a32727ff3e0b5/clippy_lints%2Fsrc%2Fto_string_in_display.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04bff17668be1305d9efe235665a32727ff3e0b5/clippy_lints%2Fsrc%2Fto_string_in_display.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fto_string_in_display.rs?ref=04bff17668be1305d9efe235665a32727ff3e0b5", "patch": "@@ -1,6 +1,7 @@\n-use crate::utils::{match_def_path, match_trait_method, paths, span_lint};\n+use crate::utils::{match_def_path, match_trait_method, paths, qpath_res, span_lint};\n use if_chain::if_chain;\n-use rustc_hir::{Expr, ExprKind, Item, ItemKind};\n+use rustc_hir::def::Res;\n+use rustc_hir::{Expr, ExprKind, HirId, ImplItem, ImplItemKind, Item, ItemKind};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n \n@@ -45,11 +46,15 @@ declare_clippy_lint! {\n #[derive(Default)]\n pub struct ToStringInDisplay {\n     in_display_impl: bool,\n+    self_hir_id: Option<HirId>,\n }\n \n impl ToStringInDisplay {\n     pub fn new() -> Self {\n-        Self { in_display_impl: false }\n+        Self {\n+            in_display_impl: false,\n+            self_hir_id: None,\n+        }\n     }\n }\n \n@@ -65,16 +70,33 @@ impl LateLintPass<'_> for ToStringInDisplay {\n     fn check_item_post(&mut self, cx: &LateContext<'_>, item: &Item<'_>) {\n         if is_display_impl(cx, item) {\n             self.in_display_impl = false;\n+            self.self_hir_id = None;\n+        }\n+    }\n+\n+    fn check_impl_item(&mut self, cx: &LateContext<'_>, impl_item: &ImplItem<'_>) {\n+        if_chain! {\n+            if self.in_display_impl;\n+            if let ImplItemKind::Fn(.., body_id) = &impl_item.kind;\n+            let body = cx.tcx.hir().body(*body_id);\n+            if !body.params.is_empty();\n+            then {\n+                let self_param = &body.params[0];\n+                self.self_hir_id = Some(self_param.pat.hir_id);\n+            }\n         }\n     }\n \n     fn check_expr(&mut self, cx: &LateContext<'_>, expr: &Expr<'_>) {\n         if_chain! {\n-            if let ExprKind::MethodCall(ref path, _, _, _) = expr.kind;\n+            if let ExprKind::MethodCall(ref path, _, args, _) = expr.kind;\n             if path.ident.name == sym!(to_string);\n             if match_trait_method(cx, expr, &paths::TO_STRING);\n             if self.in_display_impl;\n-\n+            if let ExprKind::Path(ref qpath) = args[0].kind;\n+            if let Res::Local(hir_id) = qpath_res(cx, qpath, args[0].hir_id);\n+            if let Some(self_hir_id) = self.self_hir_id;\n+            if hir_id == self_hir_id;\n             then {\n                 span_lint(\n                     cx,"}, {"sha": "eb8105c6b6da0f28a50ee521f4550e065a96de55", "filename": "tests/ui/to_string_in_display.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/04bff17668be1305d9efe235665a32727ff3e0b5/tests%2Fui%2Fto_string_in_display.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04bff17668be1305d9efe235665a32727ff3e0b5/tests%2Fui%2Fto_string_in_display.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fto_string_in_display.rs?ref=04bff17668be1305d9efe235665a32727ff3e0b5", "patch": "@@ -44,6 +44,20 @@ impl fmt::Display for C {\n     }\n }\n \n+enum D {\n+    E(String),\n+    F,\n+}\n+\n+impl std::fmt::Display for D {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        match &self {\n+            Self::E(string) => write!(f, \"E {}\", string.to_string()),\n+            Self::F => write!(f, \"F\"),\n+        }\n+    }\n+}\n+\n fn main() {\n     let a = A;\n     a.to_string();"}]}