{"sha": "6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "node_id": "C_kwDOAAsO6NoAKDZmMWM3YjI0NzA1ZDhlNzQ0ZGRlYTliNDQ1Y2I3MGUwYTBkMzI4Y2I", "commit": {"author": {"name": "Alex Pinkus", "email": "pinkus@amazon.com", "date": "2022-11-20T01:50:48Z"}, "committer": {"name": "Alex Pinkus", "email": "pinkus@amazon.com", "date": "2022-11-20T02:48:26Z"}, "message": "Revert \"Update CI to use Android NDK r25b\"\n\nThis reverts commit bf7f1ca316a249cf99d722d79a0db12fef687142.", "tree": {"sha": "23cd1f5606876064392da809d7cc1aba93a58e12", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23cd1f5606876064392da809d7cc1aba93a58e12"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "html_url": "https://github.com/rust-lang/rust/commit/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/comments", "author": null, "committer": null, "parents": [{"sha": "cd1f782b742f2c83d91648efae35dfd0d79cec08", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd1f782b742f2c83d91648efae35dfd0d79cec08", "html_url": "https://github.com/rust-lang/rust/commit/cd1f782b742f2c83d91648efae35dfd0d79cec08"}], "stats": {"total": 71, "additions": 42, "deletions": 29}, "files": [{"sha": "7128d542acfe9d0609c165c3c7b074bd904c2d0c", "filename": "src/bootstrap/cc_detect.rs", "status": "modified", "additions": 6, "deletions": 18, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fbootstrap%2Fcc_detect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fbootstrap%2Fcc_detect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcc_detect.rs?ref=6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "patch": "@@ -47,8 +47,6 @@ fn cc2ar(cc: &Path, target: TargetSelection) -> Option<PathBuf> {\n         Some(PathBuf::from(\"ar\"))\n     } else if target.contains(\"vxworks\") {\n         Some(PathBuf::from(\"wr-ar\"))\n-    } else if target.contains(\"android\") {\n-        Some(cc.parent().unwrap().join(PathBuf::from(\"llvm-ar\")))\n     } else {\n         let parent = cc.parent().unwrap();\n         let file = cc.file_name().unwrap().to_str().unwrap();\n@@ -221,22 +219,12 @@ fn set_compiler(\n }\n \n pub(crate) fn ndk_compiler(compiler: Language, triple: &str, ndk: &Path) -> PathBuf {\n-    let mut triple_iter = triple.split(\"-\");\n-    let triple_translated = if let Some(arch) = triple_iter.next() {\n-        let arch_new = match arch {\n-            \"arm\" | \"armv7\" | \"armv7neon\" | \"thumbv7\" | \"thumbv7neon\" => \"armv7a\",\n-            other => other,\n-        };\n-        std::iter::once(arch_new).chain(triple_iter).collect::<Vec<&str>>().join(\"-\")\n-    } else {\n-        triple.to_string()\n-    };\n-\n-    // API 19 is the earliest API level supported by NDK r25b but AArch64 and x86_64 support\n-    // begins at API level 21.\n-    let api_level =\n-        if triple.contains(\"aarch64\") || triple.contains(\"x86_64\") { \"21\" } else { \"19\" };\n-    let compiler = format!(\"{}{}-{}\", triple_translated, api_level, compiler.clang());\n+    let triple_translated = triple\n+        .replace(\"armv7neon\", \"arm\")\n+        .replace(\"armv7\", \"arm\")\n+        .replace(\"thumbv7neon\", \"arm\")\n+        .replace(\"thumbv7\", \"arm\");\n+    let compiler = format!(\"{}-{}\", triple_translated, compiler.clang());\n     ndk.join(\"bin\").join(compiler)\n }\n "}, {"sha": "7a875c960e13312d77d11983c0f4bab304b4c554", "filename": "src/ci/docker/host-x86_64/arm-android/Dockerfile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile?ref=6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "patch": "@@ -6,7 +6,7 @@ RUN sh /scripts/android-base-apt-get.sh\n \n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_ndk android-ndk-r25b-linux.zip\n+    download_and_make_toolchain android-ndk-r15c-linux-x86_64.zip arm 14\n \n RUN dpkg --add-architecture i386 && \\\n     apt-get update && \\\n@@ -30,7 +30,7 @@ ENV PATH=$PATH:/android/sdk/platform-tools\n \n ENV TARGETS=arm-linux-androideabi\n \n-ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/\n+ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/arm-14\n \n ENV SCRIPT python3 ../x.py --stage 2 test --host='' --target $TARGETS\n "}, {"sha": "2328db4ab8b1d126dd774a67a744afb990bde1e0", "filename": "src/ci/docker/host-x86_64/dist-android/Dockerfile", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile?ref=6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "patch": "@@ -6,7 +6,14 @@ RUN sh /scripts/android-base-apt-get.sh\n # ndk\n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_ndk android-ndk-r25b-linux.zip\n+    download_ndk android-ndk-r15c-linux-x86_64.zip && \\\n+    make_standalone_toolchain arm 14 && \\\n+    make_standalone_toolchain x86 14 && \\\n+    make_standalone_toolchain arm 21 && \\\n+    make_standalone_toolchain x86 21 && \\\n+    make_standalone_toolchain arm64 21 && \\\n+    make_standalone_toolchain x86_64 21 && \\\n+    remove_ndk\n \n # env\n ENV TARGETS=arm-linux-androideabi\n@@ -19,12 +26,12 @@ ENV TARGETS=$TARGETS,x86_64-linux-android\n ENV RUST_CONFIGURE_ARGS \\\n       --enable-extended \\\n       --enable-profiler \\\n-      --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --armv7-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --thumbv7neon-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --i686-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --aarch64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --x86_64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --arm-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+      --armv7-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+      --thumbv7neon-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+      --i686-linux-android-ndk=/android/ndk/x86-14 \\\n+      --aarch64-linux-android-ndk=/android/ndk/arm64-21 \\\n+      --x86_64-linux-android-ndk=/android/ndk/x86_64-21 \\\n       --disable-docs\n \n ENV SCRIPT python3 ../x.py dist --host='' --target $TARGETS"}, {"sha": "ba70c62ea3081a96725e3c942e9b21b3d46100f7", "filename": "src/ci/docker/scripts/android-ndk.sh", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh?ref=6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "patch": "@@ -4,10 +4,28 @@ set -ex\n URL=https://dl.google.com/android/repository\n \n download_ndk() {\n-    mkdir /android/\n-    cd /android\n+    mkdir -p /android/ndk\n+    cd /android/ndk\n     curl -fO $URL/$1\n     unzip -q $1\n     rm $1\n     mv android-ndk-* ndk\n }\n+\n+make_standalone_toolchain() {\n+    # See https://developer.android.com/ndk/guides/standalone_toolchain.htm\n+    python3 /android/ndk/ndk/build/tools/make_standalone_toolchain.py \\\n+        --install-dir /android/ndk/$1-$2 \\\n+        --arch $1 \\\n+        --api $2\n+}\n+\n+remove_ndk() {\n+    rm -rf /android/ndk/ndk\n+}\n+\n+download_and_make_toolchain() {\n+    download_ndk $1 && \\\n+    make_standalone_toolchain $2 $3 && \\\n+    remove_ndk\n+}"}]}