{"sha": "101e59361e3648468e900b04e0f8a94f628c4681", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwMWU1OTM2MWUzNjQ4NDY4ZTkwMGIwNGUwZjhhOTRmNjI4YzQ2ODE=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-06-07T00:28:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-07T00:28:58Z"}, "message": "Rollup merge of #72993 - cuviper:beta-number, r=Mark-Simulacrum\n\nCount the beta prerelease number just from master\n\nWe were computing a merge-base between the remote beta and master\nbranches, but this was giving incorrect answers for the first beta if\nthe remote hadn't been pushed yet. For instance, `1.45.0-beta.3359`\ncorresponds to the number of merges since the 1.44 beta, but we really\nwant just `.1` for the sole 1.45 beta promotion merge.\n\nWe don't really need to query the remote beta at all -- `master..HEAD`\nsuffices if we assume that we're on the intended beta branch already.", "tree": {"sha": "42345a9e533ddda1a6d2c64d0848528901f3e4d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/42345a9e533ddda1a6d2c64d0848528901f3e4d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/101e59361e3648468e900b04e0f8a94f628c4681", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe3DTKCRBK7hj4Ov3rIwAAdHIIAKSXUyLIcinGhfmFindESZe+\nmwr//UZZ/mf8FvT2CiNG84XUjXPoLEQAq2bZZkF3EUthyqNoFabpt8mN3lpbpT9z\n35mD202EiWnXroFAaYfhevqn52bWdaHLV8JH9OUo5CWMQCOZEdMBliSqJJU5Zogs\ni7yEH7JdxPhu7c8flK1/ZraE91PlwX0sFgm3PqY0EA+CuIkQSKoiiXWm1AMIrD9Y\nNu7n8oFP2JKNI1Zvi6J6BAbPPSFcdZpb1Lj+VRgJ4ZcZAkik9jYqXXQaV02kNUxc\nidLnYhYFn3HLTjW0combu09FquEt0+whigiWHjBHfRpNseb639Ve6HUZ99SFnr0=\n=EDNA\n-----END PGP SIGNATURE-----\n", "payload": "tree 42345a9e533ddda1a6d2c64d0848528901f3e4d5\nparent 6f8760bda39d66ceb9b98e4966a9f7b1e3000e66\nparent 37a24b34c74790ee593aaead775ad5f4d96dacd1\nauthor Dylan DPC <dylan.dpc@gmail.com> 1591489738 +0200\ncommitter GitHub <noreply@github.com> 1591489738 +0200\n\nRollup merge of #72993 - cuviper:beta-number, r=Mark-Simulacrum\n\nCount the beta prerelease number just from master\n\nWe were computing a merge-base between the remote beta and master\nbranches, but this was giving incorrect answers for the first beta if\nthe remote hadn't been pushed yet. For instance, `1.45.0-beta.3359`\ncorresponds to the number of merges since the 1.44 beta, but we really\nwant just `.1` for the sole 1.45 beta promotion merge.\n\nWe don't really need to query the remote beta at all -- `master..HEAD`\nsuffices if we assume that we're on the intended beta branch already.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/101e59361e3648468e900b04e0f8a94f628c4681", "html_url": "https://github.com/rust-lang/rust/commit/101e59361e3648468e900b04e0f8a94f628c4681", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/101e59361e3648468e900b04e0f8a94f628c4681/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f8760bda39d66ceb9b98e4966a9f7b1e3000e66", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f8760bda39d66ceb9b98e4966a9f7b1e3000e66", "html_url": "https://github.com/rust-lang/rust/commit/6f8760bda39d66ceb9b98e4966a9f7b1e3000e66"}, {"sha": "37a24b34c74790ee593aaead775ad5f4d96dacd1", "url": "https://api.github.com/repos/rust-lang/rust/commits/37a24b34c74790ee593aaead775ad5f4d96dacd1", "html_url": "https://github.com/rust-lang/rust/commit/37a24b34c74790ee593aaead775ad5f4d96dacd1"}], "stats": {"total": 22, "additions": 4, "deletions": 18}, "files": [{"sha": "8d8a036caef88c8c4586a8a0f0e9f7456b1646a5", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 4, "deletions": 18, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/101e59361e3648468e900b04e0f8a94f628c4681/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/101e59361e3648468e900b04e0f8a94f628c4681/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=101e59361e3648468e900b04e0f8a94f628c4681", "patch": "@@ -963,29 +963,15 @@ impl Build {\n             return s;\n         }\n \n-        let beta = output(\n-            Command::new(\"git\").arg(\"ls-remote\").arg(\"origin\").arg(\"beta\").current_dir(&self.src),\n-        );\n-        let beta = beta.trim().split_whitespace().next().unwrap();\n-        let master = output(\n-            Command::new(\"git\").arg(\"ls-remote\").arg(\"origin\").arg(\"master\").current_dir(&self.src),\n-        );\n-        let master = master.trim().split_whitespace().next().unwrap();\n-\n-        // Figure out where the current beta branch started.\n-        let base = output(\n-            Command::new(\"git\").arg(\"merge-base\").arg(beta).arg(master).current_dir(&self.src),\n-        );\n-        let base = base.trim();\n-\n-        // Next figure out how many merge commits happened since we branched off\n-        // beta. That's our beta number!\n+        // Figure out how many merge commits happened since we branched off master.\n+        // That's our beta number!\n+        // (Note that we use a `..` range, not the `...` symmetric difference.)\n         let count = output(\n             Command::new(\"git\")\n                 .arg(\"rev-list\")\n                 .arg(\"--count\")\n                 .arg(\"--merges\")\n-                .arg(format!(\"{}...HEAD\", base))\n+                .arg(\"refs/remotes/origin/master..HEAD\")\n                 .current_dir(&self.src),\n         );\n         let n = count.trim().parse().unwrap();"}]}