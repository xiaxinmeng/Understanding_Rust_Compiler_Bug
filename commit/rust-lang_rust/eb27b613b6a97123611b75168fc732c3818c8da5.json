{"sha": "eb27b613b6a97123611b75168fc732c3818c8da5", "node_id": "C_kwDOAAsO6NoAKGViMjdiNjEzYjZhOTcxMjM2MTFiNzUxNjhmYzczMmMzODE4YzhkYTU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-01-06T20:26:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-06T20:26:11Z"}, "message": "Rollup merge of #106466 - clubby789:relative-module-fix, r=notriddle\n\nFix rustdoc source code rendering for `#[path = \"../path/to/mod.rs\"]` links\n\nFixes #103517\n\nWhile generating the location for modules source HTML to be saved at, a `..` path component appeared to be translated to `/up/`.\nAdditionally, while generating the navigation sidebar, `..` path components were ignored. This means that (as in the issue above), a *real* directory structure of:\n```\nsys/\n  unix/\n    mod.rs  <-- contains #![path = \"../unix/mod.rs]\n    cmath.rs\n```\nwas rendered as:\n```\nsys/\n  unix/\n    mod.rs\n    unix/\n      cmath.rs  <-- links to sys/unix/unix/cmath.rs.html, 404\n```\nWhile the *files* were stored as\n```\nsys/\n  unix/\n    mod.rs.html\n    up/\n      unix/\n        cmath.rs.html\n```", "tree": {"sha": "505e5c73be8b3d2fd9bc7fa5c772dafcfdae2c49", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/505e5c73be8b3d2fd9bc7fa5c772dafcfdae2c49"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eb27b613b6a97123611b75168fc732c3818c8da5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjuIPjCRBK7hj4Ov3rIwAAOAkIAJgsR1Mf0OsZy1LNZJ7zOt2u\nBa7QMr2p9LgPdrQKBh1xbmjkMtVseq7QjUAmIYc116Jz9KrlsdxAbe59mkj3VIqC\nSHFW9s5PM4+I7gjDGLBilpBPeYvSzAZGmQ8lAJcesQQIn9ym2qTJGw1UZS5+l4qq\n8UTcY7lqe8+X1rW6rvN6NbfHPhu5Od0gBHmrLC+zBTKpgdfLZUiyiS+edd0NUsGo\nHvLmFYlcE/cCp59PnC6u3x5PSRW4LTg40U7zfnx3hLQd4P0O+Tt1h4iGz4JgqYh6\nNPOFc2v+7LEryNpIkQ5vF+fIvRVGfSNVQmPWaMgoNVIHzxRMfvpy+97glANvifg=\n=wZeT\n-----END PGP SIGNATURE-----\n", "payload": "tree 505e5c73be8b3d2fd9bc7fa5c772dafcfdae2c49\nparent 72d650f47a7c23d31e16f54d71f7356fbcd651f5\nparent d5d1c5716747ded8ca9746be71e70cceeaa9f422\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1673036771 +0100\ncommitter GitHub <noreply@github.com> 1673036771 +0100\n\nRollup merge of #106466 - clubby789:relative-module-fix, r=notriddle\n\nFix rustdoc source code rendering for `#[path = \"../path/to/mod.rs\"]` links\n\nFixes #103517\n\nWhile generating the location for modules source HTML to be saved at, a `..` path component appeared to be translated to `/up/`.\nAdditionally, while generating the navigation sidebar, `..` path components were ignored. This means that (as in the issue above), a *real* directory structure of:\n```\nsys/\n  unix/\n    mod.rs  <-- contains #![path = \"../unix/mod.rs]\n    cmath.rs\n```\nwas rendered as:\n```\nsys/\n  unix/\n    mod.rs\n    unix/\n      cmath.rs  <-- links to sys/unix/unix/cmath.rs.html, 404\n```\nWhile the *files* were stored as\n```\nsys/\n  unix/\n    mod.rs.html\n    up/\n      unix/\n        cmath.rs.html\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eb27b613b6a97123611b75168fc732c3818c8da5", "html_url": "https://github.com/rust-lang/rust/commit/eb27b613b6a97123611b75168fc732c3818c8da5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eb27b613b6a97123611b75168fc732c3818c8da5/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "72d650f47a7c23d31e16f54d71f7356fbcd651f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/72d650f47a7c23d31e16f54d71f7356fbcd651f5", "html_url": "https://github.com/rust-lang/rust/commit/72d650f47a7c23d31e16f54d71f7356fbcd651f5"}, {"sha": "d5d1c5716747ded8ca9746be71e70cceeaa9f422", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5d1c5716747ded8ca9746be71e70cceeaa9f422", "html_url": "https://github.com/rust-lang/rust/commit/d5d1c5716747ded8ca9746be71e70cceeaa9f422"}], "stats": {"total": 150, "additions": 109, "deletions": 41}, "files": [{"sha": "c8899ee62b5f9c7456c96eacc3eaa44600c5a6e8", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 18, "deletions": 4, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=eb27b613b6a97123611b75168fc732c3818c8da5", "patch": "@@ -309,7 +309,7 @@ impl<'tcx> Context<'tcx> {\n \n     pub(crate) fn href_from_span(&self, span: clean::Span, with_lines: bool) -> Option<String> {\n         let mut root = self.root_path();\n-        let mut path = String::new();\n+        let mut path: String;\n         let cnum = span.cnum(self.sess());\n \n         // We can safely ignore synthetic `SourceFile`s.\n@@ -340,10 +340,24 @@ impl<'tcx> Context<'tcx> {\n                 ExternalLocation::Unknown => return None,\n             };\n \n-            sources::clean_path(&src_root, file, false, |component| {\n-                path.push_str(&component.to_string_lossy());\n+            let href = RefCell::new(PathBuf::new());\n+            sources::clean_path(\n+                &src_root,\n+                file,\n+                |component| {\n+                    href.borrow_mut().push(component);\n+                },\n+                || {\n+                    href.borrow_mut().pop();\n+                },\n+            );\n+\n+            path = href.into_inner().to_string_lossy().to_string();\n+\n+            if let Some(c) = path.as_bytes().last() && *c != b'/' {\n                 path.push('/');\n-            });\n+            }\n+\n             let mut fname = file.file_name().expect(\"source has no filename\").to_os_string();\n             fname.push(\".html\");\n             path.push_str(&fname.to_string_lossy());"}, {"sha": "3ea4c4bea8828fbc4fbfdb8738b76b6501d9726a", "filename": "src/librustdoc/html/render/write_shared.rs", "status": "modified", "additions": 41, "deletions": 21, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs?ref=eb27b613b6a97123611b75168fc732c3818c8da5", "patch": "@@ -1,8 +1,9 @@\n+use std::cell::RefCell;\n use std::fs::{self, File};\n use std::io::prelude::*;\n use std::io::{self, BufReader};\n use std::path::{Component, Path};\n-use std::rc::Rc;\n+use std::rc::{Rc, Weak};\n \n use itertools::Itertools;\n use rustc_data_structures::flock;\n@@ -184,23 +185,26 @@ pub(super) fn write_shared(\n \n     use std::ffi::OsString;\n \n-    #[derive(Debug)]\n+    #[derive(Debug, Default)]\n     struct Hierarchy {\n+        parent: Weak<Self>,\n         elem: OsString,\n-        children: FxHashMap<OsString, Hierarchy>,\n-        elems: FxHashSet<OsString>,\n+        children: RefCell<FxHashMap<OsString, Rc<Self>>>,\n+        elems: RefCell<FxHashSet<OsString>>,\n     }\n \n     impl Hierarchy {\n-        fn new(elem: OsString) -> Hierarchy {\n-            Hierarchy { elem, children: FxHashMap::default(), elems: FxHashSet::default() }\n+        fn with_parent(elem: OsString, parent: &Rc<Self>) -> Self {\n+            Self { elem, parent: Rc::downgrade(parent), ..Self::default() }\n         }\n \n         fn to_json_string(&self) -> String {\n-            let mut subs: Vec<&Hierarchy> = self.children.values().collect();\n+            let borrow = self.children.borrow();\n+            let mut subs: Vec<_> = borrow.values().collect();\n             subs.sort_unstable_by(|a, b| a.elem.cmp(&b.elem));\n             let mut files = self\n                 .elems\n+                .borrow()\n                 .iter()\n                 .map(|s| format!(\"\\\"{}\\\"\", s.to_str().expect(\"invalid osstring conversion\")))\n                 .collect::<Vec<_>>();\n@@ -220,36 +224,52 @@ pub(super) fn write_shared(\n                 files = files\n             )\n         }\n-    }\n \n-    if cx.include_sources {\n-        let mut hierarchy = Hierarchy::new(OsString::new());\n-        for source in cx\n-            .shared\n-            .local_sources\n-            .iter()\n-            .filter_map(|p| p.0.strip_prefix(&cx.shared.src_root).ok())\n-        {\n-            let mut h = &mut hierarchy;\n-            let mut elems = source\n+        fn add_path(self: &Rc<Self>, path: &Path) {\n+            let mut h = Rc::clone(&self);\n+            let mut elems = path\n                 .components()\n                 .filter_map(|s| match s {\n                     Component::Normal(s) => Some(s.to_owned()),\n+                    Component::ParentDir => Some(OsString::from(\"..\")),\n                     _ => None,\n                 })\n                 .peekable();\n             loop {\n                 let cur_elem = elems.next().expect(\"empty file path\");\n+                if cur_elem == \"..\" {\n+                    if let Some(parent) = h.parent.upgrade() {\n+                        h = parent;\n+                    }\n+                    continue;\n+                }\n                 if elems.peek().is_none() {\n-                    h.elems.insert(cur_elem);\n+                    h.elems.borrow_mut().insert(cur_elem);\n                     break;\n                 } else {\n-                    let e = cur_elem.clone();\n-                    h = h.children.entry(cur_elem.clone()).or_insert_with(|| Hierarchy::new(e));\n+                    let entry = Rc::clone(\n+                        h.children\n+                            .borrow_mut()\n+                            .entry(cur_elem.clone())\n+                            .or_insert_with(|| Rc::new(Self::with_parent(cur_elem, &h))),\n+                    );\n+                    h = entry;\n                 }\n             }\n         }\n+    }\n \n+    if cx.include_sources {\n+        let hierarchy = Rc::new(Hierarchy::default());\n+        for source in cx\n+            .shared\n+            .local_sources\n+            .iter()\n+            .filter_map(|p| p.0.strip_prefix(&cx.shared.src_root).ok())\n+        {\n+            hierarchy.add_path(source);\n+        }\n+        let hierarchy = Rc::try_unwrap(hierarchy).unwrap();\n         let dst = cx.dst.join(&format!(\"source-files{}.js\", cx.shared.resource_suffix));\n         let make_sources = || {\n             let (mut all_sources, _krates) ="}, {"sha": "799c497d13709a00d95c7fcf6a07dc2fc482f8c4", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 44, "deletions": 16, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=eb27b613b6a97123611b75168fc732c3818c8da5", "patch": "@@ -13,6 +13,7 @@ use rustc_middle::ty::TyCtxt;\n use rustc_session::Session;\n use rustc_span::source_map::FileName;\n \n+use std::cell::RefCell;\n use std::ffi::OsStr;\n use std::fs;\n use std::path::{Component, Path, PathBuf};\n@@ -72,12 +73,22 @@ impl LocalSourcesCollector<'_, '_> {\n             return;\n         }\n \n-        let mut href = String::new();\n-        clean_path(self.src_root, &p, false, |component| {\n-            href.push_str(&component.to_string_lossy());\n-            href.push('/');\n-        });\n+        let href = RefCell::new(PathBuf::new());\n+        clean_path(\n+            &self.src_root,\n+            &p,\n+            |component| {\n+                href.borrow_mut().push(component);\n+            },\n+            || {\n+                href.borrow_mut().pop();\n+            },\n+        );\n \n+        let mut href = href.into_inner().to_string_lossy().to_string();\n+        if let Some(c) = href.as_bytes().last() && *c != b'/' {\n+            href.push('/');\n+        }\n         let mut src_fname = p.file_name().expect(\"source has no filename\").to_os_string();\n         src_fname.push(\".html\");\n         href.push_str(&src_fname.to_string_lossy());\n@@ -180,13 +191,28 @@ impl SourceCollector<'_, '_> {\n \n         let shared = Rc::clone(&self.cx.shared);\n         // Create the intermediate directories\n-        let mut cur = self.dst.clone();\n-        let mut root_path = String::from(\"../../\");\n-        clean_path(&shared.src_root, &p, false, |component| {\n-            cur.push(component);\n-            root_path.push_str(\"../\");\n-        });\n+        let cur = RefCell::new(PathBuf::new());\n+        let root_path = RefCell::new(PathBuf::new());\n+\n+        clean_path(\n+            &shared.src_root,\n+            &p,\n+            |component| {\n+                cur.borrow_mut().push(component);\n+                root_path.borrow_mut().push(\"..\");\n+            },\n+            || {\n+                cur.borrow_mut().pop();\n+                root_path.borrow_mut().pop();\n+            },\n+        );\n \n+        let root_path = PathBuf::from(\"../../\").join(root_path.into_inner());\n+        let mut root_path = root_path.to_string_lossy();\n+        if let Some(c) = root_path.as_bytes().last() && *c != b'/' {\n+            root_path += \"/\";\n+        }\n+        let mut cur = self.dst.join(cur.into_inner());\n         shared.ensure_dir(&cur)?;\n \n         let src_fname = p.file_name().expect(\"source has no filename\").to_os_string();\n@@ -232,24 +258,26 @@ impl SourceCollector<'_, '_> {\n /// Takes a path to a source file and cleans the path to it. This canonicalizes\n /// things like \"..\" to components which preserve the \"top down\" hierarchy of a\n /// static HTML tree. Each component in the cleaned path will be passed as an\n-/// argument to `f`. The very last component of the path (ie the file name) will\n-/// be passed to `f` if `keep_filename` is true, and ignored otherwise.\n-pub(crate) fn clean_path<F>(src_root: &Path, p: &Path, keep_filename: bool, mut f: F)\n+/// argument to `f`. The very last component of the path (ie the file name) is ignored.\n+/// If a `..` is encountered, the `parent` closure will be called to allow the callee to\n+/// handle it.\n+pub(crate) fn clean_path<F, P>(src_root: &Path, p: &Path, mut f: F, mut parent: P)\n where\n     F: FnMut(&OsStr),\n+    P: FnMut(),\n {\n     // make it relative, if possible\n     let p = p.strip_prefix(src_root).unwrap_or(p);\n \n     let mut iter = p.components().peekable();\n \n     while let Some(c) = iter.next() {\n-        if !keep_filename && iter.peek().is_none() {\n+        if iter.peek().is_none() {\n             break;\n         }\n \n         match c {\n-            Component::ParentDir => f(\"up\".as_ref()),\n+            Component::ParentDir => parent(),\n             Component::Normal(c) => f(c),\n             _ => continue,\n         }"}, {"sha": "7a6c733d464ce9d38b3b78306c3cd5628ab5793d", "filename": "src/test/rustdoc/src-links.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Ftest%2Frustdoc%2Fsrc-links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Ftest%2Frustdoc%2Fsrc-links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fsrc-links.rs?ref=eb27b613b6a97123611b75168fc732c3818c8da5", "patch": "@@ -7,6 +7,11 @@\n #[path = \"src-links/mod.rs\"]\n pub mod qux;\n \n+// @has src/foo/src-links.rs.html\n+// @has foo/fizz/index.html '//a/@href' '../src/foo/src-links/fizz.rs.html'\n+#[path = \"src-links/../src-links/fizz.rs\"]\n+pub mod fizz;\n+\n // @has foo/bar/index.html '//a/@href' '../../src/foo/src-links.rs.html'\n pub mod bar {\n "}, {"sha": "d2b76b1cec859d42d3855d69371d37100a76fcb5", "filename": "src/test/rustdoc/src-links/fizz.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Ftest%2Frustdoc%2Fsrc-links%2Ffizz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb27b613b6a97123611b75168fc732c3818c8da5/src%2Ftest%2Frustdoc%2Fsrc-links%2Ffizz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fsrc-links%2Ffizz.rs?ref=eb27b613b6a97123611b75168fc732c3818c8da5", "patch": "@@ -0,0 +1 @@\n+pub struct Buzz;"}]}