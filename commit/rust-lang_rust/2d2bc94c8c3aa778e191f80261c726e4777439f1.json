{"sha": "2d2bc94c8c3aa778e191f80261c726e4777439f1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJkMmJjOTRjOGMzYWE3NzhlMTkxZjgwMjYxYzcyNmU0Nzc3NDM5ZjE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-15T17:57:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-15T17:57:39Z"}, "message": "Auto merge of #87982 - m-ou-se:non-fmt-panic-assert-str, r=cjgillot\n\nAdd automatic migration for assert!(.., string).\n\nFixes part of #87313.", "tree": {"sha": "15103f5b7e90501ca6fb4c15c90310e96c034e73", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/15103f5b7e90501ca6fb4c15c90310e96c034e73"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d2bc94c8c3aa778e191f80261c726e4777439f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d2bc94c8c3aa778e191f80261c726e4777439f1", "html_url": "https://github.com/rust-lang/rust/commit/2d2bc94c8c3aa778e191f80261c726e4777439f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d2bc94c8c3aa778e191f80261c726e4777439f1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0490a2dbbb94f8244fb6a15ca5d33dc3fcd268a", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0490a2dbbb94f8244fb6a15ca5d33dc3fcd268a", "html_url": "https://github.com/rust-lang/rust/commit/c0490a2dbbb94f8244fb6a15ca5d33dc3fcd268a"}, {"sha": "8fedb31649d5bb9ec9b961e666a5b0b7d97d6041", "url": "https://api.github.com/repos/rust-lang/rust/commits/8fedb31649d5bb9ec9b961e666a5b0b7d97d6041", "html_url": "https://github.com/rust-lang/rust/commit/8fedb31649d5bb9ec9b961e666a5b0b7d97d6041"}], "stats": {"total": 119, "additions": 90, "deletions": 29}, "files": [{"sha": "3349063e5dcd96b42ccd4e644ca9ca8aea777211", "filename": "compiler/rustc_lint/src/non_fmt_panic.rs", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2d2bc94c8c3aa778e191f80261c726e4777439f1/compiler%2Frustc_lint%2Fsrc%2Fnon_fmt_panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d2bc94c8c3aa778e191f80261c726e4777439f1/compiler%2Frustc_lint%2Fsrc%2Fnon_fmt_panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fnon_fmt_panic.rs?ref=2d2bc94c8c3aa778e191f80261c726e4777439f1", "patch": "@@ -120,13 +120,26 @@ fn check_panic<'tcx>(cx: &LateContext<'tcx>, f: &'tcx hir::Expr<'tcx>, arg: &'tc\n                 );\n             }\n         } else {\n+            let ty = cx.typeck_results().expr_ty(arg);\n+            // If this is a &str or String, we can confidently give the `\"{}\", ` suggestion.\n+            let is_str = matches!(\n+                ty.kind(),\n+                ty::Ref(_, r, _) if *r.kind() == ty::Str,\n+            ) || matches!(\n+                ty.ty_adt_def(),\n+                Some(ty_def) if cx.tcx.is_diagnostic_item(sym::string_type, ty_def.did),\n+            );\n             l.span_suggestion_verbose(\n                 arg_span.shrink_to_lo(),\n                 \"add a \\\"{}\\\" format string to Display the message\",\n                 \"\\\"{}\\\", \".into(),\n-                Applicability::MaybeIncorrect,\n+                if is_str {\n+                    Applicability::MachineApplicable\n+                } else {\n+                    Applicability::MaybeIncorrect\n+                },\n             );\n-            if panic == sym::std_panic_macro {\n+            if !is_str && panic == sym::std_panic_macro {\n                 if let Some((open, close, del)) = find_delimiters(cx, span) {\n                     l.multipart_suggestion(\n                         \"or use std::panic::panic_any instead\","}, {"sha": "c85e1887d9603073e125928c7aaa34552a59ddad", "filename": "src/test/ui/non-fmt-panic.fixed", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/2d2bc94c8c3aa778e191f80261c726e4777439f1/src%2Ftest%2Fui%2Fnon-fmt-panic.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2d2bc94c8c3aa778e191f80261c726e4777439f1/src%2Ftest%2Fui%2Fnon-fmt-panic.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnon-fmt-panic.fixed?ref=2d2bc94c8c3aa778e191f80261c726e4777439f1", "patch": "@@ -0,0 +1,54 @@\n+// run-rustfix\n+// rustfix-only-machine-applicable\n+// build-pass (FIXME(62277): should be check-pass)\n+// aux-build:fancy-panic.rs\n+\n+extern crate fancy_panic;\n+\n+const C: &str = \"abc {}\";\n+static S: &str = \"{bla}\";\n+\n+#[allow(unreachable_code)]\n+fn main() {\n+    panic!(\"{}\", \"here's a brace: {\"); //~ WARN panic message contains a brace\n+    std::panic!(\"{}\", \"another one: }\"); //~ WARN panic message contains a brace\n+    core::panic!(\"{}\", \"Hello {}\"); //~ WARN panic message contains an unused formatting placeholder\n+    assert!(false, \"{}\", \"{:03x} {test} bla\");\n+    //~^ WARN panic message contains unused formatting placeholders\n+    assert!(false, \"{}\", S);\n+    //~^ WARN panic message is not a string literal\n+    debug_assert!(false, \"{}\", \"{{}} bla\"); //~ WARN panic message contains braces\n+    panic!(\"{}\", C); //~ WARN panic message is not a string literal\n+    panic!(\"{}\", S); //~ WARN panic message is not a string literal\n+    std::panic::panic_any(123); //~ WARN panic message is not a string literal\n+    core::panic!(\"{}\", &*\"abc\"); //~ WARN panic message is not a string literal\n+    panic!(\"{}\", concat!(\"{\", \"}\")); //~ WARN panic message contains an unused formatting placeholder\n+    panic!(\"{}\", concat!(\"{\", \"{\")); //~ WARN panic message contains braces\n+\n+    fancy_panic::fancy_panic!(\"test {} 123\");\n+    //~^ WARN panic message contains an unused formatting placeholder\n+\n+    fancy_panic::fancy_panic!(); // OK\n+    fancy_panic::fancy_panic!(S); // OK\n+\n+    macro_rules! a {\n+        () => { 123 };\n+    }\n+\n+    std::panic::panic_any(a!()); //~ WARN panic message is not a string literal\n+\n+    panic!(\"{}\", 1); //~ WARN panic message is not a string literal\n+    assert!(false, \"{}\", 1); //~ WARN panic message is not a string literal\n+    debug_assert!(false, \"{}\", 1); //~ WARN panic message is not a string literal\n+\n+    std::panic::panic_any(123); //~ WARN panic message is not a string literal\n+    std::panic::panic_any(123); //~ WARN panic message is not a string literal\n+\n+    // Check that the lint only triggers for std::panic and core::panic,\n+    // not any panic macro:\n+    macro_rules! panic {\n+        ($e:expr) => ();\n+    }\n+    panic!(\"{}\"); // OK\n+    panic!(S); // OK\n+}"}, {"sha": "020bcf00a016de49489bc752a43ace541912d527", "filename": "src/test/ui/non-fmt-panic.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2d2bc94c8c3aa778e191f80261c726e4777439f1/src%2Ftest%2Fui%2Fnon-fmt-panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d2bc94c8c3aa778e191f80261c726e4777439f1/src%2Ftest%2Fui%2Fnon-fmt-panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnon-fmt-panic.rs?ref=2d2bc94c8c3aa778e191f80261c726e4777439f1", "patch": "@@ -1,3 +1,5 @@\n+// run-rustfix\n+// rustfix-only-machine-applicable\n // build-pass (FIXME(62277): should be check-pass)\n // aux-build:fancy-panic.rs\n "}, {"sha": "513ffd37dc3c8d5036ee7adf9ca6170e95c10060", "filename": "src/test/ui/non-fmt-panic.stderr", "status": "modified", "additions": 19, "deletions": 27, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/2d2bc94c8c3aa778e191f80261c726e4777439f1/src%2Ftest%2Fui%2Fnon-fmt-panic.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2d2bc94c8c3aa778e191f80261c726e4777439f1/src%2Ftest%2Fui%2Fnon-fmt-panic.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnon-fmt-panic.stderr?ref=2d2bc94c8c3aa778e191f80261c726e4777439f1", "patch": "@@ -1,5 +1,5 @@\n warning: panic message contains a brace\n-  --> $DIR/non-fmt-panic.rs:11:29\n+  --> $DIR/non-fmt-panic.rs:13:29\n    |\n LL |     panic!(\"here's a brace: {\");\n    |                             ^\n@@ -12,7 +12,7 @@ LL |     panic!(\"{}\", \"here's a brace: {\");\n    |            +++++\n \n warning: panic message contains a brace\n-  --> $DIR/non-fmt-panic.rs:12:31\n+  --> $DIR/non-fmt-panic.rs:14:31\n    |\n LL |     std::panic!(\"another one: }\");\n    |                               ^\n@@ -24,7 +24,7 @@ LL |     std::panic!(\"{}\", \"another one: }\");\n    |                 +++++\n \n warning: panic message contains an unused formatting placeholder\n-  --> $DIR/non-fmt-panic.rs:13:25\n+  --> $DIR/non-fmt-panic.rs:15:25\n    |\n LL |     core::panic!(\"Hello {}\");\n    |                         ^^\n@@ -40,7 +40,7 @@ LL |     core::panic!(\"{}\", \"Hello {}\");\n    |                  +++++\n \n warning: panic message contains unused formatting placeholders\n-  --> $DIR/non-fmt-panic.rs:14:21\n+  --> $DIR/non-fmt-panic.rs:16:21\n    |\n LL |     assert!(false, \"{:03x} {test} bla\");\n    |                     ^^^^^^ ^^^^^^\n@@ -56,7 +56,7 @@ LL |     assert!(false, \"{}\", \"{:03x} {test} bla\");\n    |                    +++++\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:16:20\n+  --> $DIR/non-fmt-panic.rs:18:20\n    |\n LL |     assert!(false, S);\n    |                    ^\n@@ -69,7 +69,7 @@ LL |     assert!(false, \"{}\", S);\n    |                    +++++\n \n warning: panic message contains braces\n-  --> $DIR/non-fmt-panic.rs:18:27\n+  --> $DIR/non-fmt-panic.rs:20:27\n    |\n LL |     debug_assert!(false, \"{{}} bla\");\n    |                           ^^^^\n@@ -81,7 +81,7 @@ LL |     debug_assert!(false, \"{}\", \"{{}} bla\");\n    |                          +++++\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:19:12\n+  --> $DIR/non-fmt-panic.rs:21:12\n    |\n LL |     panic!(C);\n    |            ^\n@@ -92,13 +92,9 @@ help: add a \"{}\" format string to Display the message\n    |\n LL |     panic!(\"{}\", C);\n    |            +++++\n-help: or use std::panic::panic_any instead\n-   |\n-LL |     std::panic::panic_any(C);\n-   |     ~~~~~~~~~~~~~~~~~~~~~\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:20:12\n+  --> $DIR/non-fmt-panic.rs:22:12\n    |\n LL |     panic!(S);\n    |            ^\n@@ -109,13 +105,9 @@ help: add a \"{}\" format string to Display the message\n    |\n LL |     panic!(\"{}\", S);\n    |            +++++\n-help: or use std::panic::panic_any instead\n-   |\n-LL |     std::panic::panic_any(S);\n-   |     ~~~~~~~~~~~~~~~~~~~~~\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:21:17\n+  --> $DIR/non-fmt-panic.rs:23:17\n    |\n LL |     std::panic!(123);\n    |                 ^^^\n@@ -132,7 +124,7 @@ LL |     std::panic::panic_any(123);\n    |     ~~~~~~~~~~~~~~~~~~~~~\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:22:18\n+  --> $DIR/non-fmt-panic.rs:24:18\n    |\n LL |     core::panic!(&*\"abc\");\n    |                  ^^^^^^^\n@@ -145,7 +137,7 @@ LL |     core::panic!(\"{}\", &*\"abc\");\n    |                  +++++\n \n warning: panic message contains an unused formatting placeholder\n-  --> $DIR/non-fmt-panic.rs:23:12\n+  --> $DIR/non-fmt-panic.rs:25:12\n    |\n LL |     panic!(concat!(\"{\", \"}\"));\n    |            ^^^^^^^^^^^^^^^^^\n@@ -161,7 +153,7 @@ LL |     panic!(\"{}\", concat!(\"{\", \"}\"));\n    |            +++++\n \n warning: panic message contains braces\n-  --> $DIR/non-fmt-panic.rs:24:5\n+  --> $DIR/non-fmt-panic.rs:26:5\n    |\n LL |     panic!(concat!(\"{\", \"{\"));\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -173,15 +165,15 @@ LL |     panic!(\"{}\", concat!(\"{\", \"{\"));\n    |            +++++\n \n warning: panic message contains an unused formatting placeholder\n-  --> $DIR/non-fmt-panic.rs:26:37\n+  --> $DIR/non-fmt-panic.rs:28:37\n    |\n LL |     fancy_panic::fancy_panic!(\"test {} 123\");\n    |                                     ^^\n    |\n    = note: this message is not used as a format string when given without arguments, but will be in Rust 2021\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:36:12\n+  --> $DIR/non-fmt-panic.rs:38:12\n    |\n LL |     panic!(a!());\n    |            ^^^^\n@@ -198,7 +190,7 @@ LL |     std::panic::panic_any(a!());\n    |     ~~~~~~~~~~~~~~~~~~~~~\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:38:12\n+  --> $DIR/non-fmt-panic.rs:40:12\n    |\n LL |     panic!(format!(\"{}\", 1));\n    |            ^^^^^^^^^^^^^^^^\n@@ -213,7 +205,7 @@ LL +     panic!(\"{}\", 1);\n    | \n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:39:20\n+  --> $DIR/non-fmt-panic.rs:41:20\n    |\n LL |     assert!(false, format!(\"{}\", 1));\n    |                    ^^^^^^^^^^^^^^^^\n@@ -228,7 +220,7 @@ LL +     assert!(false, \"{}\", 1);\n    | \n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:40:26\n+  --> $DIR/non-fmt-panic.rs:42:26\n    |\n LL |     debug_assert!(false, format!(\"{}\", 1));\n    |                          ^^^^^^^^^^^^^^^^\n@@ -243,7 +235,7 @@ LL +     debug_assert!(false, \"{}\", 1);\n    | \n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:42:12\n+  --> $DIR/non-fmt-panic.rs:44:12\n    |\n LL |     panic![123];\n    |            ^^^\n@@ -260,7 +252,7 @@ LL |     std::panic::panic_any(123);\n    |     ~~~~~~~~~~~~~~~~~~~~~~   ~\n \n warning: panic message is not a string literal\n-  --> $DIR/non-fmt-panic.rs:43:12\n+  --> $DIR/non-fmt-panic.rs:45:12\n    |\n LL |     panic!{123};\n    |            ^^^"}]}