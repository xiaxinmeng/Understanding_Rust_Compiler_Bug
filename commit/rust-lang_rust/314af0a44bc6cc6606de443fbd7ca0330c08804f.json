{"sha": "314af0a44bc6cc6606de443fbd7ca0330c08804f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxNGFmMGE0NGJjNmNjNjYwNmRlNDQzZmJkN2NhMDMzMGMwODgwNGY=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-07-02T02:29:03Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-07-02T02:29:03Z"}, "message": "Split out and improve trans_init_box.", "tree": {"sha": "d077c368db3fb48d2b2630b57605d9828f05cefd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d077c368db3fb48d2b2630b57605d9828f05cefd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/314af0a44bc6cc6606de443fbd7ca0330c08804f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/314af0a44bc6cc6606de443fbd7ca0330c08804f", "html_url": "https://github.com/rust-lang/rust/commit/314af0a44bc6cc6606de443fbd7ca0330c08804f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/314af0a44bc6cc6606de443fbd7ca0330c08804f/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7df949af40164c8f02fed2126ea11f89f228a106", "url": "https://api.github.com/repos/rust-lang/rust/commits/7df949af40164c8f02fed2126ea11f89f228a106", "html_url": "https://github.com/rust-lang/rust/commit/7df949af40164c8f02fed2126ea11f89f228a106"}], "stats": {"total": 26, "additions": 18, "deletions": 8}, "files": [{"sha": "1183a23ef3bcff2615d470a62ae050abd3b36290", "filename": "src/boot/me/trans.ml", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/314af0a44bc6cc6606de443fbd7ca0330c08804f/src%2Fboot%2Fme%2Ftrans.ml", "raw_url": "https://github.com/rust-lang/rust/raw/314af0a44bc6cc6606de443fbd7ca0330c08804f/src%2Fboot%2Fme%2Ftrans.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Ftrans.ml?ref=314af0a44bc6cc6606de443fbd7ca0330c08804f", "patch": "@@ -2189,6 +2189,23 @@ let trans_visitor\n             atoms;\n             mov (get_element_ptr vec Abi.vec_elt_fill) (Il.Cell fill);\n \n+\n+  and trans_init_box (dst:Ast.lval) (src:Ast.atom) : unit =\n+    let src_op = trans_atom src in\n+    let src_cell = Il.Mem (force_to_mem src_op) in\n+    let src_ty = simplified_ty (atom_type cx src) in\n+    let dst_sloti = lval_base_to_slot cx dst in\n+    let dst_cell = cell_of_block_slot dst_sloti.id in\n+    let dst_cell = deref_slot true dst_cell dst_sloti.node in\n+    let dst_ty = slot_ty dst_sloti.node in\n+    let (dst_cell, dst_ty) =\n+      deref_ty DEREF_one_box true dst_cell dst_ty\n+    in\n+    let _ = assert (dst_ty = src_ty) in\n+      trans_copy_ty (get_ty_params_of_current_frame()) true\n+        dst_cell dst_ty src_cell src_ty None\n+\n+\n   and get_dynamic_tydesc (idopt:node_id option) (t:Ast.ty) : Il.cell =\n     let td = next_vreg_cell Il.voidptr_t in\n     let root_desc =\n@@ -4244,14 +4261,7 @@ let trans_visitor\n           end\n \n       | Ast.STMT_init_box (dst, src) ->\n-          let sloti = lval_base_to_slot cx dst in\n-          let dst_cell = cell_of_block_slot sloti.id in\n-          let dst_cell = deref_slot true dst_cell sloti.node in\n-          let ty = slot_ty sloti.node in\n-          let (dst_cell, ty) = deref_ty DEREF_one_box true dst_cell ty in\n-          let src_cell = need_cell (trans_atom src) in\n-            trans_copy_ty (get_ty_params_of_current_frame()) true\n-              dst_cell ty src_cell ty None;\n+          trans_init_box dst src\n \n       | Ast.STMT_block block ->\n           trans_block block"}]}