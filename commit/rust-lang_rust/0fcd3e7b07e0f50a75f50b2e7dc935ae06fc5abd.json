{"sha": "0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmY2QzZTdiMDdlMGY1MGE3NWY1MGIyZTdkYzkzNWFlMDZmYzVhYmQ=", "commit": {"author": {"name": "Mark Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2017-10-16T17:40:47Z"}, "committer": {"name": "Mark Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2017-10-18T22:30:33Z"}, "message": "Make sure to clear out the stageN-{rustc,std,tools} directories.\n\nWe copy built tool binaries into a dedicated directory to avoid deleting\nthem, stageN-tools-bin. These aren't ever cleared out by code, since\nthere should be no reason to do so, and we'll simply overwrite them as\nnecessary.\n\nWhen clearing out the stageN-{std,rustc,tools} directories, make sure to\ndelete both Cargo directories -- per-target and build scripts. This\nensures that changing libstd doesn't cause problems due to build scripts\nnot being rebuilt, even though they should be.", "tree": {"sha": "28f3df2b3cd37f0b0ecc228ffa93f9f4016727db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/28f3df2b3cd37f0b0ecc228ffa93f9f4016727db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "html_url": "https://github.com/rust-lang/rust/commit/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b7960878ba77124505aabe7dc99d0a898354c326", "url": "https://api.github.com/repos/rust-lang/rust/commits/b7960878ba77124505aabe7dc99d0a898354c326", "html_url": "https://github.com/rust-lang/rust/commit/b7960878ba77124505aabe7dc99d0a898354c326"}], "stats": {"total": 103, "additions": 72, "deletions": 31}, "files": [{"sha": "dee4999879ca384e721e7a9bccb58dfaf0a03611", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "patch": "@@ -612,7 +612,7 @@ impl<'a> Builder<'a> {\n         // Set this for all builds to make sure doc builds also get it.\n         cargo.env(\"CFG_RELEASE_CHANNEL\", &self.build.config.channel);\n \n-        if self.is_verbose() {\n+        if self.is_very_verbose() {\n             cargo.arg(\"-v\");\n         }\n         // FIXME: cargo bench does not accept `--release`"}, {"sha": "f837371bebecbe737cf2be50428236b69da1c3c8", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 9, "deletions": 14, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "patch": "@@ -29,7 +29,7 @@ use build_helper::{output, mtime, up_to_date};\n use filetime::FileTime;\n use serde_json;\n \n-use util::{exe, libdir, is_dylib, copy};\n+use util::{exe, libdir, is_dylib, copy, read_stamp_file};\n use {Build, Compiler, Mode};\n use native;\n use tool;\n@@ -102,7 +102,7 @@ impl Step for Std {\n             copy_musl_third_party_objects(build, target, &libdir);\n         }\n \n-        let out_dir = build.cargo_out(compiler, Mode::Libstd, target);\n+        let out_dir = build.stage_out(compiler, Mode::Libstd);\n         build.clear_if_dirty(&out_dir, &builder.rustc(compiler));\n         let mut cargo = builder.cargo(compiler, Mode::Libstd, target, \"build\");\n         std_cargo(build, &compiler, target, &mut cargo);\n@@ -354,7 +354,7 @@ impl Step for Test {\n         let _folder = build.fold_output(|| format!(\"stage{}-test\", compiler.stage));\n         println!(\"Building stage{} test artifacts ({} -> {})\", compiler.stage,\n                 &compiler.host, target);\n-        let out_dir = build.cargo_out(compiler, Mode::Libtest, target);\n+        let out_dir = build.stage_out(compiler, Mode::Libtest);\n         build.clear_if_dirty(&out_dir, &libstd_stamp(build, compiler, target));\n         let mut cargo = builder.cargo(compiler, Mode::Libtest, target, \"build\");\n         test_cargo(build, &compiler, target, &mut cargo);\n@@ -480,8 +480,9 @@ impl Step for Rustc {\n         println!(\"Building stage{} compiler artifacts ({} -> {})\",\n                  compiler.stage, &compiler.host, target);\n \n-        let out_dir = build.cargo_out(compiler, Mode::Librustc, target);\n-        build.clear_if_dirty(&out_dir, &libtest_stamp(build, compiler, target));\n+        let stage_out = builder.stage_out(compiler, Mode::Librustc);\n+        build.clear_if_dirty(&stage_out, &libstd_stamp(build, compiler, target));\n+        build.clear_if_dirty(&stage_out, &libtest_stamp(build, compiler, target));\n \n         let mut cargo = builder.cargo(compiler, Mode::Librustc, target, \"build\");\n         rustc_cargo(build, &compiler, target, &mut cargo);\n@@ -757,15 +758,7 @@ impl Step for Assemble {\n /// `sysroot_dst` provided.\n fn add_to_sysroot(sysroot_dst: &Path, stamp: &Path) {\n     t!(fs::create_dir_all(&sysroot_dst));\n-    let mut contents = Vec::new();\n-    t!(t!(File::open(stamp)).read_to_end(&mut contents));\n-    // This is the method we use for extracting paths from the stamp file passed to us. See\n-    // run_cargo for more information (in this file).\n-    for part in contents.split(|b| *b == 0) {\n-        if part.is_empty() {\n-            continue\n-        }\n-        let path = Path::new(t!(str::from_utf8(part)));\n+    for path in read_stamp_file(stamp) {\n         copy(&path, &sysroot_dst.join(path.file_name().unwrap()));\n     }\n }\n@@ -938,6 +931,8 @@ fn run_cargo(build: &Build, cargo: &mut Command, stamp: &Path) {\n     let max = max.unwrap();\n     let max_path = max_path.unwrap();\n     if stamp_contents == new_contents && max <= stamp_mtime {\n+        build.verbose(&format!(\"not updating {:?}; contents equal and {} <= {}\",\n+                stamp, max, stamp_mtime));\n         return\n     }\n     if max > stamp_mtime {"}, {"sha": "479283b3595548adf366c437e7ff80a74e63f415", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "patch": "@@ -385,16 +385,19 @@ impl Build {\n     /// Clear out `dir` if `input` is newer.\n     ///\n     /// After this executes, it will also ensure that `dir` exists.\n-    fn clear_if_dirty(&self, dir: &Path, input: &Path) {\n+    fn clear_if_dirty(&self, dir: &Path, input: &Path) -> bool {\n         let stamp = dir.join(\".stamp\");\n+        let mut cleared = false;\n         if mtime(&stamp) < mtime(input) {\n             self.verbose(&format!(\"Dirty - {}\", dir.display()));\n             let _ = fs::remove_dir_all(dir);\n+            cleared = true;\n         } else if stamp.exists() {\n-            return\n+            return cleared;\n         }\n         t!(fs::create_dir_all(dir));\n         t!(File::create(stamp));\n+        cleared\n     }\n \n     /// Get the space-separated set of activated features for the standard\n@@ -435,6 +438,12 @@ impl Build {\n         if self.config.rust_optimize {\"release\"} else {\"debug\"}\n     }\n \n+    fn tools_dir(&self, compiler: Compiler) -> PathBuf {\n+        let out = self.out.join(&*compiler.host).join(format!(\"stage{}-tools-bin\", compiler.stage));\n+        t!(fs::create_dir_all(&out));\n+        out\n+    }\n+\n     /// Get the directory for incremental by-products when using the\n     /// given compiler.\n     fn incremental_dir(&self, compiler: Compiler) -> PathBuf {"}, {"sha": "bdbef3a943b9068e66855f436fc6a700d498069f", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 32, "deletions": 12, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "patch": "@@ -38,24 +38,40 @@ impl Step for CleanTools {\n         run.never()\n     }\n \n-    /// Build a tool in `src/tools`\n-    ///\n-    /// This will build the specified tool with the specified `host` compiler in\n-    /// `stage` into the normal cargo output directory.\n     fn run(self, builder: &Builder) {\n         let build = builder.build;\n         let compiler = self.compiler;\n         let target = self.target;\n         let mode = self.mode;\n \n-        let stamp = match mode {\n-            Mode::Libstd => libstd_stamp(build, compiler, target),\n-            Mode::Libtest => libtest_stamp(build, compiler, target),\n-            Mode::Librustc => librustc_stamp(build, compiler, target),\n-            _ => panic!(),\n+        // This is for the original compiler, but if we're forced to use stage 1, then\n+        // std/test/rustc stamps won't exist in stage 2, so we need to get those from stage 1, since\n+        // we copy the libs forward.\n+        let tools_dir = build.stage_out(compiler, Mode::Tool);\n+        let compiler = if builder.force_use_stage1(compiler, target) {\n+            builder.compiler(1, compiler.host)\n+        } else {\n+            compiler\n         };\n-        let out_dir = build.cargo_out(compiler, Mode::Tool, target);\n-        build.clear_if_dirty(&out_dir, &stamp);\n+\n+        for &cur_mode in &[Mode::Libstd, Mode::Libtest, Mode::Librustc] {\n+            let stamp = match cur_mode {\n+                Mode::Libstd => libstd_stamp(build, compiler, target),\n+                Mode::Libtest => libtest_stamp(build, compiler, target),\n+                Mode::Librustc => librustc_stamp(build, compiler, target),\n+                _ => panic!(),\n+            };\n+\n+            if build.clear_if_dirty(&tools_dir, &stamp) {\n+                break;\n+            }\n+\n+            // If we are a rustc tool, and std changed, we also need to clear ourselves out -- our\n+            // dependencies depend on std. Therefore, we iterate up until our own mode.\n+            if mode == cur_mode {\n+                break;\n+            }\n+        }\n     }\n }\n \n@@ -100,7 +116,11 @@ impl Step for ToolBuild {\n \n         let mut cargo = prepare_tool_cargo(builder, compiler, target, \"build\", path);\n         build.run_expecting(&mut cargo, expectation);\n-        build.cargo_out(compiler, Mode::Tool, target).join(exe(tool, &compiler.host))\n+        let cargo_out = build.cargo_out(compiler, Mode::Tool, target)\n+            .join(exe(tool, &compiler.host));\n+        let bin = build.tools_dir(compiler).join(exe(tool, &compiler.host));\n+        copy(&cargo_out, &bin);\n+        bin\n     }\n }\n "}, {"sha": "2506048858f2b67dadf83f970214815c062cc2a8", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=0fcd3e7b07e0f50a75f50b2e7dc935ae06fc5abd", "patch": "@@ -14,8 +14,9 @@\n //! not a lot of interesting happenings here unfortunately.\n \n use std::env;\n-use std::fs;\n-use std::io::{self, Write};\n+use std::str;\n+use std::fs::{self, File};\n+use std::io::{self, Read, Write};\n use std::path::{Path, PathBuf};\n use std::process::Command;\n use std::time::{SystemTime, Instant};\n@@ -50,6 +51,22 @@ pub fn copy(src: &Path, dst: &Path) {\n     t!(filetime::set_file_times(dst, atime, mtime));\n }\n \n+pub fn read_stamp_file(stamp: &Path) -> Vec<PathBuf> {\n+    let mut paths = Vec::new();\n+    let mut contents = Vec::new();\n+    t!(t!(File::open(stamp)).read_to_end(&mut contents));\n+    // This is the method we use for extracting paths from the stamp file passed to us. See\n+    // run_cargo for more information (in compile.rs).\n+    for part in contents.split(|b| *b == 0) {\n+        if part.is_empty() {\n+            continue\n+        }\n+        let path = PathBuf::from(t!(str::from_utf8(part)));\n+        paths.push(path);\n+    }\n+    paths\n+}\n+\n /// Copies the `src` directory recursively to `dst`. Both are assumed to exist\n /// when this function is called.\n pub fn cp_r(src: &Path, dst: &Path) {"}]}