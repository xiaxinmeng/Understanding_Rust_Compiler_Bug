{"sha": "8c95b205a27a27bed6434644e8016caa49aeffc1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjOTViMjA1YTI3YTI3YmVkNjQzNDY0NGU4MDE2Y2FhNDlhZWZmYzE=", "commit": {"author": {"name": "Jesse Bakker", "email": "github@jessebakker.com", "date": "2021-05-12T13:06:54Z"}, "committer": {"name": "Jesse Bakker", "email": "github@jessebakker.com", "date": "2021-05-13T05:51:00Z"}, "message": "fix: Keep doc comments and outer attrs on \"Move module to file\" assist", "tree": {"sha": "276a3141108990d2718b912f41a8299307f8d999", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/276a3141108990d2718b912f41a8299307f8d999"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8c95b205a27a27bed6434644e8016caa49aeffc1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8c95b205a27a27bed6434644e8016caa49aeffc1", "html_url": "https://github.com/rust-lang/rust/commit/8c95b205a27a27bed6434644e8016caa49aeffc1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8c95b205a27a27bed6434644e8016caa49aeffc1/comments", "author": {"login": "Jesse-Bakker", "id": 22473248, "node_id": "MDQ6VXNlcjIyNDczMjQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22473248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jesse-Bakker", "html_url": "https://github.com/Jesse-Bakker", "followers_url": "https://api.github.com/users/Jesse-Bakker/followers", "following_url": "https://api.github.com/users/Jesse-Bakker/following{/other_user}", "gists_url": "https://api.github.com/users/Jesse-Bakker/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jesse-Bakker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jesse-Bakker/subscriptions", "organizations_url": "https://api.github.com/users/Jesse-Bakker/orgs", "repos_url": "https://api.github.com/users/Jesse-Bakker/repos", "events_url": "https://api.github.com/users/Jesse-Bakker/events{/privacy}", "received_events_url": "https://api.github.com/users/Jesse-Bakker/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jesse-Bakker", "id": 22473248, "node_id": "MDQ6VXNlcjIyNDczMjQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22473248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jesse-Bakker", "html_url": "https://github.com/Jesse-Bakker", "followers_url": "https://api.github.com/users/Jesse-Bakker/followers", "following_url": "https://api.github.com/users/Jesse-Bakker/following{/other_user}", "gists_url": "https://api.github.com/users/Jesse-Bakker/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jesse-Bakker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jesse-Bakker/subscriptions", "organizations_url": "https://api.github.com/users/Jesse-Bakker/orgs", "repos_url": "https://api.github.com/users/Jesse-Bakker/repos", "events_url": "https://api.github.com/users/Jesse-Bakker/events{/privacy}", "received_events_url": "https://api.github.com/users/Jesse-Bakker/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9a431c26f4528e2649de0ca171a38c93e473c94e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a431c26f4528e2649de0ca171a38c93e473c94e", "html_url": "https://github.com/rust-lang/rust/commit/9a431c26f4528e2649de0ca171a38c93e473c94e"}], "stats": {"total": 38, "additions": 33, "deletions": 5}, "files": [{"sha": "93f702c556881af6d55197a2c519072194298765", "filename": "crates/ide_assists/src/handlers/move_module_to_file.rs", "status": "modified", "additions": 33, "deletions": 5, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/8c95b205a27a27bed6434644e8016caa49aeffc1/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmove_module_to_file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c95b205a27a27bed6434644e8016caa49aeffc1/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmove_module_to_file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmove_module_to_file.rs?ref=8c95b205a27a27bed6434644e8016caa49aeffc1", "patch": "@@ -1,4 +1,4 @@\n-use ast::{edit::IndentLevel, VisibilityOwner};\n+use ast::edit::IndentLevel;\n use ide_db::base_db::AnchoredPathBuf;\n use stdx::format_to;\n use syntax::{\n@@ -60,12 +60,18 @@ pub(crate) fn move_module_to_file(acc: &mut Assists, ctx: &AssistContext) -> Opt\n             };\n \n             let mut buf = String::new();\n-            if let Some(v) = module_ast.visibility() {\n-                format_to!(buf, \"{} \", v);\n-            }\n             format_to!(buf, \"mod {};\", module_name);\n \n-            builder.replace(module_ast.syntax().text_range(), buf);\n+            let replacement_start = if let Some(mod_token) = module_ast.mod_token() {\n+                mod_token.text_range().start()\n+            } else {\n+                module_ast.syntax().text_range().start()\n+            };\n+\n+            builder.replace(\n+                TextRange::new(replacement_start, module_ast.syntax().text_range().end()),\n+                buf,\n+            );\n \n             let dst = AnchoredPathBuf { anchor: ctx.frange.file_id, path };\n             builder.create_file(dst, contents);\n@@ -184,4 +190,26 @@ pub(crate) mod tests;\n         cov_mark::check!(available_before_curly);\n         check_assist_not_applicable(move_module_to_file, r#\"mod m { $0 }\"#);\n     }\n+\n+    #[test]\n+    fn keep_outer_comments_and_attributes() {\n+        check_assist(\n+            move_module_to_file,\n+            r#\"\n+/// doc comment\n+#[attribute]\n+mod $0tests {\n+    #[test] fn t() {}\n+}\n+\"#,\n+            r#\"\n+//- /main.rs\n+/// doc comment\n+#[attribute]\n+mod tests;\n+//- /tests.rs\n+#[test] fn t() {}\n+\"#,\n+        );\n+    }\n }"}]}