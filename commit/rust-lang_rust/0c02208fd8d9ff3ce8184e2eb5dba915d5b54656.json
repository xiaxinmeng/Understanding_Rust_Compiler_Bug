{"sha": "0c02208fd8d9ff3ce8184e2eb5dba915d5b54656", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjMDIyMDhmZDhkOWZmM2NlODE4NGUyZWI1ZGJhOTE1ZDViNTQ2NTY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-13T10:06:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-13T10:06:36Z"}, "message": "Merge #8489\n\n8489: Indent block expressions on enter r=matklad a=jonas-schievink\n\nThis improves on https://github.com/rust-analyzer/rust-analyzer/pull/8388 by also indenting the created block expression on enter.\r\n\r\n![on enter](https://user-images.githubusercontent.com/1786438/114444123-cb38d600-9bce-11eb-8af2-8e8d1c0f9908.gif)\r\n\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "11c6ca3707baa3ac18dde89020b96c1f4c5b2334", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/11c6ca3707baa3ac18dde89020b96c1f4c5b2334"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c02208fd8d9ff3ce8184e2eb5dba915d5b54656", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgdW0sCRBK7hj4Ov3rIwAAdHIIAFjoPOX7yap9LNHu3aQargoz\n0yGCP1VstjsU5BmTghoojsjVMNNmDkou41w9eUb/EkoNc+bU2ex1sLeJk12jgq+y\nQZVD0piTvbbfyreFh8+sxKVPbIKtxwOueoJ8BOiJ5ls4U21aQ4YiTOmKrx0G7Vme\nEDbz1YIwzdrffxUIi3PCsMDgF27DFrlHlddl/8BKiSH8NwziLzInGOhIYqCrjfha\nM4ca64N9J9E4QBfdoI2fqTFM3+dSIFvQYylqJuNCXxgqi4HHZninW0SZPRx3IacA\nS4q3SgE/RKPEJdGMsgPCTVO+13ONw2IbCudThUkkGN1VoefAH8QDJzOcVssjfN4=\n=ibRm\n-----END PGP SIGNATURE-----\n", "payload": "tree 11c6ca3707baa3ac18dde89020b96c1f4c5b2334\nparent d8120ed1a09c3b882631dc1f8e2e3fcc739c421b\nparent a8ca4666f119b33349151a0a97ef51bce5913fd3\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1618308396 +0000\ncommitter GitHub <noreply@github.com> 1618308396 +0000\n\nMerge #8489\n\n8489: Indent block expressions on enter r=matklad a=jonas-schievink\n\nThis improves on https://github.com/rust-analyzer/rust-analyzer/pull/8388 by also indenting the created block expression on enter.\r\n\r\n![on enter](https://user-images.githubusercontent.com/1786438/114444123-cb38d600-9bce-11eb-8af2-8e8d1c0f9908.gif)\r\n\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c02208fd8d9ff3ce8184e2eb5dba915d5b54656", "html_url": "https://github.com/rust-lang/rust/commit/0c02208fd8d9ff3ce8184e2eb5dba915d5b54656", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c02208fd8d9ff3ce8184e2eb5dba915d5b54656/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d8120ed1a09c3b882631dc1f8e2e3fcc739c421b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8120ed1a09c3b882631dc1f8e2e3fcc739c421b", "html_url": "https://github.com/rust-lang/rust/commit/d8120ed1a09c3b882631dc1f8e2e3fcc739c421b"}, {"sha": "a8ca4666f119b33349151a0a97ef51bce5913fd3", "url": "https://api.github.com/repos/rust-lang/rust/commits/a8ca4666f119b33349151a0a97ef51bce5913fd3", "html_url": "https://github.com/rust-lang/rust/commit/a8ca4666f119b33349151a0a97ef51bce5913fd3"}], "stats": {"total": 210, "additions": 199, "deletions": 11}, "files": [{"sha": "7d2db201a0e935ae88802550664fca47f538c4d6", "filename": "crates/ide/src/typing/on_enter.rs", "status": "modified", "additions": 199, "deletions": 11, "changes": 210, "blob_url": "https://github.com/rust-lang/rust/blob/0c02208fd8d9ff3ce8184e2eb5dba915d5b54656/crates%2Fide%2Fsrc%2Ftyping%2Fon_enter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c02208fd8d9ff3ce8184e2eb5dba915d5b54656/crates%2Fide%2Fsrc%2Ftyping%2Fon_enter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Ftyping%2Fon_enter.rs?ref=0c02208fd8d9ff3ce8184e2eb5dba915d5b54656", "patch": "@@ -4,10 +4,11 @@\n use ide_db::base_db::{FilePosition, SourceDatabase};\n use ide_db::RootDatabase;\n use syntax::{\n-    ast::{self, AstToken},\n+    algo::find_node_at_offset,\n+    ast::{self, edit::IndentLevel, AstToken},\n     AstNode, SmolStr, SourceFile,\n     SyntaxKind::*,\n-    SyntaxToken, TextRange, TextSize, TokenAtOffset,\n+    SyntaxNode, SyntaxToken, TextRange, TextSize, TokenAtOffset,\n };\n \n use text_edit::TextEdit;\n@@ -19,6 +20,7 @@ use text_edit::TextEdit;\n // - kbd:[Enter] inside triple-slash comments automatically inserts `///`\n // - kbd:[Enter] in the middle or after a trailing space in `//` inserts `//`\n // - kbd:[Enter] inside `//!` doc comments automatically inserts `//!`\n+// - kbd:[Enter] after `{` indents contents and closing `}` of single-line block\n //\n // This action needs to be assigned to shortcut explicitly.\n //\n@@ -38,25 +40,43 @@ use text_edit::TextEdit;\n pub(crate) fn on_enter(db: &RootDatabase, position: FilePosition) -> Option<TextEdit> {\n     let parse = db.parse(position.file_id);\n     let file = parse.tree();\n-    let comment = file\n-        .syntax()\n-        .token_at_offset(position.offset)\n-        .left_biased()\n-        .and_then(ast::Comment::cast)?;\n+    let token = file.syntax().token_at_offset(position.offset).left_biased()?;\n \n+    if let Some(comment) = ast::Comment::cast(token.clone()) {\n+        return on_enter_in_comment(&comment, &file, position.offset);\n+    }\n+\n+    if token.kind() == L_CURLY {\n+        // Typing enter after the `{` of a block expression, where the `}` is on the same line\n+        if let Some(edit) = find_node_at_offset(file.syntax(), position.offset - TextSize::of('{'))\n+            .and_then(|block| on_enter_in_block(block, position))\n+        {\n+            cov_mark::hit!(indent_block_contents);\n+            return Some(edit);\n+        }\n+    }\n+\n+    None\n+}\n+\n+fn on_enter_in_comment(\n+    comment: &ast::Comment,\n+    file: &ast::SourceFile,\n+    offset: TextSize,\n+) -> Option<TextEdit> {\n     if comment.kind().shape.is_block() {\n         return None;\n     }\n \n     let prefix = comment.prefix();\n     let comment_range = comment.syntax().text_range();\n-    if position.offset < comment_range.start() + TextSize::of(prefix) {\n+    if offset < comment_range.start() + TextSize::of(prefix) {\n         return None;\n     }\n \n     let mut remove_trailing_whitespace = false;\n     // Continuing single-line non-doc comments (like this one :) ) is annoying\n-    if prefix == \"//\" && comment_range.end() == position.offset {\n+    if prefix == \"//\" && comment_range.end() == offset {\n         if comment.text().ends_with(' ') {\n             cov_mark::hit!(continues_end_of_line_comment_with_space);\n             remove_trailing_whitespace = true;\n@@ -70,14 +90,42 @@ pub(crate) fn on_enter(db: &RootDatabase, position: FilePosition) -> Option<Text\n     let delete = if remove_trailing_whitespace {\n         let trimmed_len = comment.text().trim_end().len() as u32;\n         let trailing_whitespace_len = comment.text().len() as u32 - trimmed_len;\n-        TextRange::new(position.offset - TextSize::from(trailing_whitespace_len), position.offset)\n+        TextRange::new(offset - TextSize::from(trailing_whitespace_len), offset)\n     } else {\n-        TextRange::empty(position.offset)\n+        TextRange::empty(offset)\n     };\n     let edit = TextEdit::replace(delete, inserted);\n     Some(edit)\n }\n \n+fn on_enter_in_block(block: ast::BlockExpr, position: FilePosition) -> Option<TextEdit> {\n+    let contents = block_contents(&block)?;\n+\n+    if block.syntax().text().contains_char('\\n') {\n+        return None;\n+    }\n+\n+    let indent = IndentLevel::from_node(block.syntax());\n+    let mut edit = TextEdit::insert(position.offset, format!(\"\\n{}$0\", indent + 1));\n+    edit.union(TextEdit::insert(contents.text_range().end(), format!(\"\\n{}\", indent))).ok()?;\n+    Some(edit)\n+}\n+\n+fn block_contents(block: &ast::BlockExpr) -> Option<SyntaxNode> {\n+    let mut node = block.tail_expr().map(|e| e.syntax().clone());\n+\n+    for stmt in block.statements() {\n+        if node.is_some() {\n+            // More than 1 node in the block\n+            return None;\n+        }\n+\n+        node = Some(stmt.syntax().clone());\n+    }\n+\n+    node\n+}\n+\n fn followed_by_comment(comment: &ast::Comment) -> bool {\n     let ws = match comment.syntax().next_token().and_then(ast::Whitespace::cast) {\n         Some(it) => it,\n@@ -296,4 +344,144 @@ fn main() {\n \",\n         );\n     }\n+\n+    #[test]\n+    fn indents_fn_body_block() {\n+        cov_mark::check!(indent_block_contents);\n+        do_check(\n+            r#\"\n+fn f() {$0()}\n+        \"#,\n+            r#\"\n+fn f() {\n+    $0()\n+}\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn indents_block_expr() {\n+        do_check(\n+            r#\"\n+fn f() {\n+    let x = {$0()};\n+}\n+        \"#,\n+            r#\"\n+fn f() {\n+    let x = {\n+        $0()\n+    };\n+}\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn indents_match_arm() {\n+        do_check(\n+            r#\"\n+fn f() {\n+    match 6 {\n+        1 => {$0f()},\n+        _ => (),\n+    }\n+}\n+        \"#,\n+            r#\"\n+fn f() {\n+    match 6 {\n+        1 => {\n+            $0f()\n+        },\n+        _ => (),\n+    }\n+}\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn indents_block_with_statement() {\n+        do_check(\n+            r#\"\n+fn f() {$0a = b}\n+        \"#,\n+            r#\"\n+fn f() {\n+    $0a = b\n+}\n+        \"#,\n+        );\n+        do_check(\n+            r#\"\n+fn f() {$0fn f() {}}\n+        \"#,\n+            r#\"\n+fn f() {\n+    $0fn f() {}\n+}\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn indents_nested_blocks() {\n+        do_check(\n+            r#\"\n+fn f() {$0{}}\n+        \"#,\n+            r#\"\n+fn f() {\n+    $0{}\n+}\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn does_not_indent_empty_block() {\n+        do_check_noop(\n+            r#\"\n+fn f() {$0}\n+        \"#,\n+        );\n+        do_check_noop(\n+            r#\"\n+fn f() {{$0}}\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn does_not_indent_block_with_too_much_content() {\n+        do_check_noop(\n+            r#\"\n+fn f() {$0 a = b; ()}\n+        \"#,\n+        );\n+        do_check_noop(\n+            r#\"\n+fn f() {$0 a = b; a = b; }\n+        \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn does_not_indent_multiline_block() {\n+        do_check_noop(\n+            r#\"\n+fn f() {$0\n+}\n+        \"#,\n+        );\n+        do_check_noop(\n+            r#\"\n+fn f() {$0\n+\n+}\n+        \"#,\n+        );\n+    }\n }"}]}