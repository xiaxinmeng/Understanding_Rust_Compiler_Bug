{"sha": "d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwMDBmYjFjYTgzN2YxNzVkYzU3MjJiYmJjNGZlMTU0MTZlYjVjZDk=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2020-08-14T01:00:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-14T01:00:19Z"}, "message": "Rollup merge of #75471 - richkadel:llvm-program-name, r=wesleywiser\n\nChange registered \"program name\" for -Cllvm-args usage messages\n\nWhile debugging a codegen issue, I tried adding LLVM options with\nthe rustc -Cllvm-args option, and was confused by the error and usage\nmessaging.\n\nThe LLVM \"program name\" argument is set to \"rustc\", and command line\nerror messages make it look like invalid arguments are \"rustc\"\narguments, not LLVM.\n\nI changed this argument so error messages and the \"-help\" usage feedback\nis easier to understand and react to. (Clang does something similar.)\n\nr? @wesleywiser", "tree": {"sha": "9c3409e5bfc32afcf146f638c60a4f751576c5cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9c3409e5bfc32afcf146f638c60a4f751576c5cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfNeIkCRBK7hj4Ov3rIwAAdHIIAHA/dpks20lYCnO/Kid4HPzE\nsxoEaAXBhyH3zha3hrEuXrJGUi/PBPthR4l7fCzapeATxkvEF3d0NB6PI9u4T0Pw\nFSPdPl3zaF7jg55ksWtxu1y3Sh57suNAS19436HPjrwRl4jF1VP4zvVVy945JYK7\nNAVhqu1/AE/QKeBEGrgOumGBZOiY1S+3Bq8EX2And7wMCINRUcOC0RBfqqAW/33J\nrbf86GnLlNhgVUd/yMk2/UzVu85L2pqYhMD2LIMFkXJACBakldAkVXGIg3J9UwVY\nU9fmoYctcfq0dBhE3p3FqGqVHfk0jm+zM9aIGXpVsc2Lpgga4doDKbO7+8LT35U=\n=/6Wl\n-----END PGP SIGNATURE-----\n", "payload": "tree 9c3409e5bfc32afcf146f638c60a4f751576c5cf\nparent b4966a8936be55bc2d95aa134127daae58cd47bf\nparent d4593af78fb2929f0c46e5e4fc041092b7195f81\nauthor Tyler Mandry <tmandry@gmail.com> 1597366819 -0700\ncommitter GitHub <noreply@github.com> 1597366819 -0700\n\nRollup merge of #75471 - richkadel:llvm-program-name, r=wesleywiser\n\nChange registered \"program name\" for -Cllvm-args usage messages\n\nWhile debugging a codegen issue, I tried adding LLVM options with\nthe rustc -Cllvm-args option, and was confused by the error and usage\nmessaging.\n\nThe LLVM \"program name\" argument is set to \"rustc\", and command line\nerror messages make it look like invalid arguments are \"rustc\"\narguments, not LLVM.\n\nI changed this argument so error messages and the \"-help\" usage feedback\nis easier to understand and react to. (Clang does something similar.)\n\nr? @wesleywiser\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "html_url": "https://github.com/rust-lang/rust/commit/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b4966a8936be55bc2d95aa134127daae58cd47bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4966a8936be55bc2d95aa134127daae58cd47bf", "html_url": "https://github.com/rust-lang/rust/commit/b4966a8936be55bc2d95aa134127daae58cd47bf"}, {"sha": "d4593af78fb2929f0c46e5e4fc041092b7195f81", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4593af78fb2929f0c46e5e4fc041092b7195f81", "html_url": "https://github.com/rust-lang/rust/commit/d4593af78fb2929f0c46e5e4fc041092b7195f81"}], "stats": {"total": 26, "additions": 25, "deletions": 1}, "files": [{"sha": "f0b50459837e93d3bb8793ad0800e64144e69f29", "filename": "src/librustc_codegen_llvm/llvm_util.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/src%2Flibrustc_codegen_llvm%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/src%2Flibrustc_codegen_llvm%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fllvm_util.rs?ref=d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "patch": "@@ -73,7 +73,8 @@ unsafe fn configure_llvm(sess: &Session) {\n                 llvm_c_strs.push(s);\n             }\n         };\n-        add(\"rustc\", true); // fake program name\n+        // Set the llvm \"program name\" to make usage and invalid argument messages more clear.\n+        add(\"rustc -Cllvm-args=\\\"...\\\" with\", true);\n         if sess.time_llvm_passes() {\n             add(\"-time-passes\", false);\n         }"}, {"sha": "289bae24f810ecb73c41a9cb0bf88ccb4d463eb0", "filename": "src/test/ui/unknown-llvm-arg.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/src%2Ftest%2Fui%2Funknown-llvm-arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/src%2Ftest%2Fui%2Funknown-llvm-arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funknown-llvm-arg.rs?ref=d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "patch": "@@ -0,0 +1,22 @@\n+// compile-flags: -Cllvm-args=-not-a-real-llvm-arg\n+// normalize-stderr-test \"--help\" -> \"-help\"\n+// normalize-stderr-test \"\\n(\\n|.)*\" -> \"\"\n+\n+// I'm seeing \"--help\" locally, but \"-help\" in CI, so I'm normalizing it to just \"-help\".\n+\n+// Note that the rustc-supplied \"program name\", given when invoking LLVM, is used by LLVM to\n+// generate user-facing error messages and a usage (--help) messages. If the program name is\n+// `rustc`, the usage message in response to `--llvm-args=\"--help\"` starts with:\n+// ```\n+//   USAGE: rustc [options]\n+// ```\n+// followed by the list of options not to `rustc` but to `llvm`.\n+//\n+// On the other hand, if the program name is set to `rustc -Cllvm-args=\"...\" with`, the usage\n+// message is more clear:\n+// ```\n+//   USAGE: rustc -Cllvm-args=\"...\" with [options]\n+// ```\n+// This test captures the effect of the current program name setting on LLVM command line\n+// error messages.\n+fn main() {}"}, {"sha": "e1d3cfea28fdf41df3e7c11796eff408ee56f106", "filename": "src/test/ui/unknown-llvm-arg.stderr", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/src%2Ftest%2Fui%2Funknown-llvm-arg.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d000fb1ca837f175dc5722bbbc4fe15416eb5cd9/src%2Ftest%2Fui%2Funknown-llvm-arg.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funknown-llvm-arg.stderr?ref=d000fb1ca837f175dc5722bbbc4fe15416eb5cd9", "patch": "@@ -0,0 +1 @@\n+rustc -Cllvm-args=\"...\" with: Unknown command line argument '-not-a-real-llvm-arg'.  Try: 'rustc -Cllvm-args=\"...\" with -help'\n\\ No newline at end of file"}]}