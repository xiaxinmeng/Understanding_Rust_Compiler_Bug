{"sha": "7eba13f45164f42892b1430badae197ec2a77c5a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlYmExM2Y0NTE2NGY0Mjg5MmIxNDMwYmFkYWUxOTdlYzJhNzdjNWE=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-07-04T19:08:15Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-07-04T19:08:15Z"}, "message": "Correctly handle an activation from dead code.", "tree": {"sha": "835d65da3f0351a331e67a5e47d2ee4fb415a4cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/835d65da3f0351a331e67a5e47d2ee4fb415a4cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7eba13f45164f42892b1430badae197ec2a77c5a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAls9Gx8ACgkQAXYLT59T\n8VTOEA/+N0l8m+xR2o0ozZxWAXzTcYZCXlEb3JufO3Q0rDiFWhqnuN6XCkkoUKVk\nQpxk/8UMTKdsJ4nOLpr5tJWTOdv8s5IRB425maUlDHqTzXrwPf1mhkPt26uqnGsZ\n0OJXKMd3sdQ7zyOeSofKTgc3bCRSsy0Q3T1zQycDY5Ioq0wkMHeYSJZm8AcqkZjV\nrcTdIlEMcF0q2ZZt8ALBGMsti5utp0vU8RmS71zG3p2k1HQe3W4KR/B1ZGIre2+V\n/z8pBeAGjVKiSoPkkDc4uSn7pXejZRvkEQ3xNfh5wO5DtTTCCw53Vqhe1usYr8bm\nIotIxypSKUcAUQRCZbzDzCipWmHeIsf8ZdGT41PcKTNS3tKgQxX7Cd+IK25jqlxk\nLs9c4toD0lPfeTaTR9QgpIxJE/kcMAXAGIvpiyKx/sL3auSWHZWOFzCTp+mrVay7\nouQ0Lv+aTHhHX4knBl15SPRDT/+vDOvUWdfsZjDu8+wMUVKzaRZ/yKHF2tu8kfop\nysQzNOSsaZ7ZjOLm9mgEO1jF0bf9QjMhUWUHZ1QVSur4CEOHtFY0aCVUVI3M5TVr\nH1CfXBiR0OwxUpKA5gth1D+vFE+xavmk6D9KIrS0L0FfVpX36wIHFyhzTuDv13lk\nWX9PXjLyb77uDMftRLh1jBaKLEQeTcBMdx9n013tRd0JPaaBiQY=\n=g+e9\n-----END PGP SIGNATURE-----", "payload": "tree 835d65da3f0351a331e67a5e47d2ee4fb415a4cd\nparent 860d169474acabdc53b9a698f8ce02eba7e0daeb\nauthor David Wood <david@davidtw.co> 1530731295 +0100\ncommitter David Wood <david@davidtw.co> 1530731295 +0100\n\nCorrectly handle an activation from dead code.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7eba13f45164f42892b1430badae197ec2a77c5a", "html_url": "https://github.com/rust-lang/rust/commit/7eba13f45164f42892b1430badae197ec2a77c5a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7eba13f45164f42892b1430badae197ec2a77c5a/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "860d169474acabdc53b9a698f8ce02eba7e0daeb", "url": "https://api.github.com/repos/rust-lang/rust/commits/860d169474acabdc53b9a698f8ce02eba7e0daeb", "html_url": "https://github.com/rust-lang/rust/commit/860d169474acabdc53b9a698f8ce02eba7e0daeb"}], "stats": {"total": 79, "additions": 38, "deletions": 41}, "files": [{"sha": "ce02a7dc16602cc4130f830f437c9f4f8c0d119f", "filename": "src/librustc_mir/borrow_check/borrow_set.rs", "status": "modified", "additions": 16, "deletions": 36, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/7eba13f45164f42892b1430badae197ec2a77c5a/src%2Flibrustc_mir%2Fborrow_check%2Fborrow_set.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7eba13f45164f42892b1430badae197ec2a77c5a/src%2Flibrustc_mir%2Fborrow_check%2Fborrow_set.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fborrow_set.rs?ref=7eba13f45164f42892b1430badae197ec2a77c5a", "patch": "@@ -53,25 +53,22 @@ impl<'tcx> Index<BorrowIndex> for BorrowSet<'tcx> {\n     }\n }\n \n-/// Every two-phase borrow has *exactly one* use (or else it is not a\n-/// proper two-phase borrow under our current definition). However, not\n-/// all uses are actually ones that activate the reservation.. In\n-/// particular, a shared borrow of a `&mut` does not activate the\n-/// reservation.\n+/// Location where a two phase borrow is activated, if a borrow\n+/// is in fact a two phase borrow.\n #[derive(Copy, Clone, PartialEq, Eq, Debug)]\n-crate enum TwoPhaseUse {\n-    MutActivate,\n-    SharedUse,\n+crate enum TwoPhaseActivation {\n+    NotTwoPhase,\n+    NotActivated,\n+    ActivatedAt(Location),\n }\n \n #[derive(Debug)]\n crate struct BorrowData<'tcx> {\n     /// Location where the borrow reservation starts.\n     /// In many cases, this will be equal to the activation location but not always.\n     crate reserve_location: Location,\n-    /// Location where the borrow is activated. None if this is not a\n-    /// 2-phase borrow.\n-    crate activation_location: Option<(TwoPhaseUse, Location)>,\n+    /// Location where the borrow is activated.\n+    crate activation_location: TwoPhaseActivation,\n     /// What kind of borrow this is\n     crate kind: mir::BorrowKind,\n     /// The region for which this borrow is live\n@@ -116,19 +113,6 @@ impl<'tcx> BorrowSet<'tcx> {\n             visitor.visit_basic_block_data(block, block_data);\n         }\n \n-        // Double check: We should have found an activation for every pending\n-        // activation.\n-        assert_eq!(\n-            visitor\n-                .pending_activations\n-                .iter()\n-                .find(|&(_local, &borrow_index)| visitor.idx_vec[borrow_index]\n-                    .activation_location\n-                    .is_none()),\n-            None,\n-            \"never found an activation for this borrow!\",\n-        );\n-\n         BorrowSet {\n             borrows: visitor.idx_vec,\n             location_map: visitor.location_map,\n@@ -183,7 +167,7 @@ impl<'a, 'gcx, 'tcx> Visitor<'tcx> for GatherBorrows<'a, 'gcx, 'tcx> {\n                 kind,\n                 region,\n                 reserve_location: location,\n-                activation_location: None,\n+                activation_location: TwoPhaseActivation::NotTwoPhase,\n                 borrowed_place: borrowed_place.clone(),\n                 assigned_place: assigned_place.clone(),\n             };\n@@ -232,38 +216,34 @@ impl<'a, 'gcx, 'tcx> Visitor<'tcx> for GatherBorrows<'a, 'gcx, 'tcx> {\n                         return;\n                     }\n \n-                    if let Some(other_activation) = borrow_data.activation_location {\n+                    if let TwoPhaseActivation::ActivatedAt(other_location) =\n+                            borrow_data.activation_location {\n                         span_bug!(\n                             self.mir.source_info(location).span,\n                             \"found two uses for 2-phase borrow temporary {:?}: \\\n                              {:?} and {:?}\",\n                             temp,\n                             location,\n-                            other_activation,\n+                            other_location,\n                         );\n                     }\n \n                     // Otherwise, this is the unique later use\n                     // that we expect.\n-\n-                    let two_phase_use;\n-\n-                    match context {\n+                    borrow_data.activation_location = match context {\n                         // The use of TMP in a shared borrow does not\n                         // count as an actual activation.\n                         PlaceContext::Borrow { kind: mir::BorrowKind::Shared, .. } => {\n-                            two_phase_use = TwoPhaseUse::SharedUse;\n+                            TwoPhaseActivation::NotActivated\n                         }\n                         _ => {\n-                            two_phase_use = TwoPhaseUse::MutActivate;\n                             self.activation_map\n                                 .entry(location)\n                                 .or_insert(Vec::new())\n                                 .push(borrow_index);\n+                            TwoPhaseActivation::ActivatedAt(location)\n                         }\n-                    }\n-\n-                    borrow_data.activation_location = Some((two_phase_use, location));\n+                    };\n                 }\n \n                 None => {}"}, {"sha": "ca2a120ceb7375e3ece7b6eb3ed23e376a41fdbc", "filename": "src/librustc_mir/borrow_check/path_utils.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7eba13f45164f42892b1430badae197ec2a77c5a/src%2Flibrustc_mir%2Fborrow_check%2Fpath_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7eba13f45164f42892b1430badae197ec2a77c5a/src%2Flibrustc_mir%2Fborrow_check%2Fpath_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fpath_utils.rs?ref=7eba13f45164f42892b1430badae197ec2a77c5a", "patch": "@@ -8,7 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-use borrow_check::borrow_set::{BorrowSet, BorrowData, TwoPhaseUse};\n+use borrow_check::borrow_set::{BorrowSet, BorrowData, TwoPhaseActivation};\n use borrow_check::places_conflict;\n use borrow_check::Context;\n use borrow_check::ShallowOrDeep;\n@@ -83,11 +83,11 @@ pub(super) fn is_active<'tcx>(\n \n     let activation_location = match borrow_data.activation_location {\n         // If this is not a 2-phase borrow, it is always active.\n-        None => return true,\n+        TwoPhaseActivation::NotTwoPhase => return true,\n         // And if the unique 2-phase use is not an activation, then it is *never* active.\n-        Some((TwoPhaseUse::SharedUse, _)) => return false,\n-        // Otherwise, we derive info from the activation point `v`:\n-        Some((TwoPhaseUse::MutActivate, v)) => v,\n+        TwoPhaseActivation::NotActivated => return false,\n+        // Otherwise, we derive info from the activation point `loc`:\n+        TwoPhaseActivation::ActivatedAt(loc) => loc,\n     };\n \n     // Otherwise, it is active for every location *except* in between"}, {"sha": "7d392944685b830b39c5a7828d0990f87ad87e44", "filename": "src/test/run-pass/issue-51345.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/7eba13f45164f42892b1430badae197ec2a77c5a/src%2Ftest%2Frun-pass%2Fissue-51345.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7eba13f45164f42892b1430badae197ec2a77c5a/src%2Ftest%2Frun-pass%2Fissue-51345.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-51345.rs?ref=7eba13f45164f42892b1430badae197ec2a77c5a", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(nll)]\n+\n+fn main() {\n+    let mut v = Vec::new();\n+\n+    loop { v.push(break) }\n+}"}]}