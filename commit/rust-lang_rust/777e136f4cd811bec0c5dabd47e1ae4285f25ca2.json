{"sha": "777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "node_id": "C_kwDOAAsO6NoAKDc3N2UxMzZmNGNkODExYmVjMGM1ZGFiZDQ3ZTFhZTQyODVmMjVjYTI", "commit": {"author": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-06-09T21:34:06Z"}, "committer": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-06-09T21:34:06Z"}, "message": "Suppress the unused_macro_rules lint if malformed rules are encountered\n\nPrior to this commit, if a macro had any malformed rules, all rules would\nbe reported as unused, regardless of whether they were used or not.\nSo we just turn off unused rule checking completely for macros with\nmalformed rules.", "tree": {"sha": "a1b8b12186959d8ae8a472bd8c9826219d31530d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a1b8b12186959d8ae8a472bd8c9826219d31530d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "html_url": "https://github.com/rust-lang/rust/commit/777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/comments", "author": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "committer": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eb3c611e1d3829e05aec8f9887efa164ea2c6da5", "url": "https://api.github.com/repos/rust-lang/rust/commits/eb3c611e1d3829e05aec8f9887efa164ea2c6da5", "html_url": "https://github.com/rust-lang/rust/commit/eb3c611e1d3829e05aec8f9887efa164ea2c6da5"}], "stats": {"total": 29, "additions": 25, "deletions": 4}, "files": [{"sha": "04af1eaf67b6d187d9c6d1a81bf9405f46bf45b5", "filename": "compiler/rustc_expand/src/mbe/macro_rules.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs?ref=777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "patch": "@@ -539,18 +539,20 @@ pub fn compile_declarative_macro(\n         None => {}\n     }\n \n-    // Compute the spans of the macro rules\n-    // We only take the span of the lhs here,\n-    // so that the spans of created warnings are smaller.\n+    // Compute the spans of the macro rules for unused rule linting.\n+    // To avoid warning noise, only consider the rules of this\n+    // macro for the lint, if all rules are valid.\n     // Also, we are only interested in non-foreign macros.\n-    let rule_spans = if def.id != DUMMY_NODE_ID {\n+    let rule_spans = if valid && def.id != DUMMY_NODE_ID {\n         lhses\n             .iter()\n             .zip(rhses.iter())\n             .enumerate()\n             // If the rhs contains an invocation like compile_error!,\n             // don't consider the rule for the unused rule lint.\n             .filter(|(_idx, (_lhs, rhs))| !has_compile_error_macro(rhs))\n+            // We only take the span of the lhs here,\n+            // so that the spans of created warnings are smaller.\n             .map(|(idx, (lhs, _rhs))| (idx, lhs.span()))\n             .collect::<Vec<_>>()\n     } else {"}, {"sha": "a826026ec405cc66cdef1cfbabc8bbae67f96dbf", "filename": "src/test/ui/lint/unused/unused-macro-rules-malformed-rule.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.rs", "raw_url": "https://github.com/rust-lang/rust/raw/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.rs?ref=777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "patch": "@@ -0,0 +1,11 @@\n+#![deny(unused_macro_rules)]\n+\n+macro_rules! foo {\n+    (v) => {};\n+    (w) => {};\n+    () => 0; //~ ERROR: macro rhs must be delimited\n+}\n+\n+fn main() {\n+    foo!(v);\n+}"}, {"sha": "797c867103f030f88491294099e4651969a0785c", "filename": "src/test/ui/lint/unused/unused-macro-rules-malformed-rule.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/777e136f4cd811bec0c5dabd47e1ae4285f25ca2/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules-malformed-rule.stderr?ref=777e136f4cd811bec0c5dabd47e1ae4285f25ca2", "patch": "@@ -0,0 +1,8 @@\n+error: macro rhs must be delimited\n+  --> $DIR/unused-macro-rules-malformed-rule.rs:6:11\n+   |\n+LL |     () => 0;\n+   |           ^\n+\n+error: aborting due to previous error\n+"}]}