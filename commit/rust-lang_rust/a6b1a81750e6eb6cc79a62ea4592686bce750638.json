{"sha": "a6b1a81750e6eb6cc79a62ea4592686bce750638", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2YjFhODE3NTBlNmViNmNjNzlhNjJlYTQ1OTI2ODZiY2U3NTA2Mzg=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-11-05T14:48:22Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-11-06T14:36:49Z"}, "message": "fix unsafety checking for generators\n\nFixes #45729", "tree": {"sha": "dc3e8fd40db2b1571018a64019a93096b1343cdd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dc3e8fd40db2b1571018a64019a93096b1343cdd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6b1a81750e6eb6cc79a62ea4592686bce750638", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6b1a81750e6eb6cc79a62ea4592686bce750638", "html_url": "https://github.com/rust-lang/rust/commit/a6b1a81750e6eb6cc79a62ea4592686bce750638", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6b1a81750e6eb6cc79a62ea4592686bce750638/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19402f11e12042367f2b711155cdde61a608b660", "url": "https://api.github.com/repos/rust-lang/rust/commits/19402f11e12042367f2b711155cdde61a608b660", "html_url": "https://github.com/rust-lang/rust/commit/19402f11e12042367f2b711155cdde61a608b660"}], "stats": {"total": 38, "additions": 31, "deletions": 7}, "files": [{"sha": "dd5914e46ec14ea60fcfa53fb28cbcd718932934", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a6b1a81750e6eb6cc79a62ea4592686bce750638/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b1a81750e6eb6cc79a62ea4592686bce750638/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=a6b1a81750e6eb6cc79a62ea4592686bce750638", "patch": "@@ -75,7 +75,7 @@ impl<'a, 'tcx> Visitor<'tcx> for UnsafetyChecker<'a, 'tcx> {\n             TerminatorKind::Return |\n             TerminatorKind::Unreachable |\n             TerminatorKind::FalseEdges { .. } => {\n-                                // safe (at least as emitted during MIR construction)\n+                // safe (at least as emitted during MIR construction)\n             }\n \n             TerminatorKind::Call { ref func, .. } => {\n@@ -117,12 +117,17 @@ impl<'a, 'tcx> Visitor<'tcx> for UnsafetyChecker<'a, 'tcx> {\n                     rvalue: &Rvalue<'tcx>,\n                     location: Location)\n     {\n-        if let &Rvalue::Aggregate(\n-            box AggregateKind::Closure(def_id, _),\n-            _\n-        ) = rvalue {\n-            let unsafety_violations = self.tcx.unsafety_violations(def_id);\n-            self.register_violations(&unsafety_violations);\n+        if let &Rvalue::Aggregate(box ref aggregate, _) = rvalue {\n+            match aggregate {\n+                &AggregateKind::Array(..) |\n+                &AggregateKind::Tuple |\n+                &AggregateKind::Adt(..) => {}\n+                &AggregateKind::Closure(def_id, _) |\n+                &AggregateKind::Generator(def_id, _, _) => {\n+                    let unsafety_violations = self.tcx.unsafety_violations(def_id);\n+                    self.register_violations(&unsafety_violations);\n+                }\n+            }\n         }\n         self.super_rvalue(rvalue, location);\n     }"}, {"sha": "489e91797f3d76ccd79166cee1df25a0cc24ef48", "filename": "src/test/compile-fail/issue-45729-unsafe-in-generator.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a6b1a81750e6eb6cc79a62ea4592686bce750638/src%2Ftest%2Fcompile-fail%2Fissue-45729-unsafe-in-generator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b1a81750e6eb6cc79a62ea4592686bce750638/src%2Ftest%2Fcompile-fail%2Fissue-45729-unsafe-in-generator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-45729-unsafe-in-generator.rs?ref=a6b1a81750e6eb6cc79a62ea4592686bce750638", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(generators)]\n+\n+fn main() {\n+    let _ = || {\n+        *(1 as *mut u32) = 42;\n+        //~^ ERROR dereference of raw pointer requires unsafe\n+        yield;\n+    };\n+}"}]}