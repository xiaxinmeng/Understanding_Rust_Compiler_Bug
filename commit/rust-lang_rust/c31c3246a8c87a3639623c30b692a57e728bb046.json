{"sha": "c31c3246a8c87a3639623c30b692a57e728bb046", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzMWMzMjQ2YThjODdhMzYzOTYyM2MzMGI2OTJhNTdlNzI4YmIwNDY=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-15T17:43:19Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-15T17:43:34Z"}, "message": "Basic support for decl macros 2.0", "tree": {"sha": "e66cdc459e249767c69c1b29b13e85fe30bdc935", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e66cdc459e249767c69c1b29b13e85fe30bdc935"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c31c3246a8c87a3639623c30b692a57e728bb046", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c31c3246a8c87a3639623c30b692a57e728bb046", "html_url": "https://github.com/rust-lang/rust/commit/c31c3246a8c87a3639623c30b692a57e728bb046", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c31c3246a8c87a3639623c30b692a57e728bb046/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd4c352831662762ee7a66da77ec9adf623b0a0a", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd4c352831662762ee7a66da77ec9adf623b0a0a", "html_url": "https://github.com/rust-lang/rust/commit/bd4c352831662762ee7a66da77ec9adf623b0a0a"}], "stats": {"total": 223, "additions": 195, "deletions": 28}, "files": [{"sha": "ff1999ee0c10ac0ab0d0c28bca56e5827e7130e0", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -1828,8 +1828,6 @@ checksum = \"56dee185309b50d1f11bfedef0fe6d036842e3fb77413abef29f8f8d1c5d4c1c\"\n [[package]]\n name = \"ungrammar\"\n version = \"1.2.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"873186a460627379e7e28880a0d33b729c205634f6f021321f50b323235e62d7\"\n \n [[package]]\n name = \"unicase\""}, {"sha": "fdf2a71a06833a189c5f84b4a61632e6e42c64bf", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -26,4 +26,4 @@ debug = 0 # Set this to 1 or 2 to get more useful backtraces in debugger.\n # chalk-ir = { path = \"../chalk/chalk-ir\" }\n # chalk-recursive = { path = \"../chalk/chalk-recursive\" }\n \n-# ungrammar = { path = \"../ungrammar\" }\n+ungrammar = { path = \"../ungrammar\" }"}, {"sha": "ecf3194c6ad87f3f2848ed517b101d235a9ad665", "filename": "crates/hir/src/has_source.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir%2Fsrc%2Fhas_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir%2Fsrc%2Fhas_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fhas_source.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -110,8 +110,8 @@ impl HasSource for TypeAlias {\n     }\n }\n impl HasSource for MacroDef {\n-    type Ast = ast::MacroRules;\n-    fn source(self, db: &dyn HirDatabase) -> InFile<ast::MacroRules> {\n+    type Ast = ast::Macro;\n+    fn source(self, db: &dyn HirDatabase) -> InFile<ast::Macro> {\n         InFile {\n             file_id: self.id.ast_id.expect(\"MacroDef without ast_id\").file_id,\n             value: self.id.ast_id.expect(\"MacroDef without ast_id\").to_node(db.upcast()),"}, {"sha": "d499ae340221e5ac6a2f2ba54ba153d01f9b2175", "filename": "crates/hir/src/semantics/source_to_def.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir%2Fsrc%2Fsemantics%2Fsource_to_def.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir%2Fsrc%2Fsemantics%2Fsource_to_def.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics%2Fsource_to_def.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -157,7 +157,7 @@ impl SourceToDefCtx<'_, '_> {\n         let file_id = src.file_id.original_file(self.db.upcast());\n         let krate = self.file_to_def(file_id)?.krate;\n         let file_ast_id = self.db.ast_id_map(src.file_id).ast_id(&src.value);\n-        let ast_id = Some(AstId::new(src.file_id, file_ast_id));\n+        let ast_id = Some(AstId::new(src.file_id, file_ast_id.upcast()));\n         Some(MacroDefId { krate: Some(krate), ast_id, kind, local_inner: false })\n     }\n "}, {"sha": "e4bf5603c7e86ee3667106acbe137f5deed7338e", "filename": "crates/hir_def/src/body/lower.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -772,7 +772,10 @@ impl ExprCollector<'_> {\n                     | ast::Item::Module(_)\n                     | ast::Item::MacroCall(_) => return None,\n                     ast::Item::MacroRules(def) => {\n-                        return Some(Either::Right(def));\n+                        return Some(Either::Right(ast::Macro::from(def)));\n+                    }\n+                    ast::Item::MacroDef(def) => {\n+                        return Some(Either::Right(ast::Macro::from(def)));\n                     }\n                 };\n "}, {"sha": "8cd0b18ccdad342041815164827a858a5f61bbf2", "filename": "crates/hir_def/src/item_tree.rs", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -143,6 +143,7 @@ impl ItemTree {\n                 mods,\n                 macro_calls,\n                 macro_rules,\n+                macro_defs,\n                 exprs,\n                 vis,\n                 generics,\n@@ -164,6 +165,7 @@ impl ItemTree {\n             mods.shrink_to_fit();\n             macro_calls.shrink_to_fit();\n             macro_rules.shrink_to_fit();\n+            macro_defs.shrink_to_fit();\n             exprs.shrink_to_fit();\n \n             vis.arena.shrink_to_fit();\n@@ -283,6 +285,7 @@ struct ItemTreeData {\n     mods: Arena<Mod>,\n     macro_calls: Arena<MacroCall>,\n     macro_rules: Arena<MacroRules>,\n+    macro_defs: Arena<MacroDef>,\n     exprs: Arena<Expr>,\n \n     vis: ItemVisibilities,\n@@ -431,6 +434,7 @@ mod_items! {\n     Mod in mods -> ast::Module,\n     MacroCall in macro_calls -> ast::MacroCall,\n     MacroRules in macro_rules -> ast::MacroRules,\n+    MacroDef in macro_defs -> ast::MacroDef,\n }\n \n macro_rules! impl_index {\n@@ -640,7 +644,7 @@ pub struct MacroCall {\n \n #[derive(Debug, Clone, Eq, PartialEq)]\n pub struct MacroRules {\n-    /// For `macro_rules!` declarations, this is the name of the declared macro.\n+    /// The name of the declared macro.\n     pub name: Name,\n     /// Has `#[macro_export]`.\n     pub is_export: bool,\n@@ -651,6 +655,16 @@ pub struct MacroRules {\n     pub ast_id: FileAstId<ast::MacroRules>,\n }\n \n+/// \"Macros 2.0\" macro definition.\n+#[derive(Debug, Clone, Eq, PartialEq)]\n+pub struct MacroDef {\n+    pub name: Name,\n+    pub visibility: RawVisibilityId,\n+    /// Has `#[rustc_builtin_macro]`.\n+    pub is_builtin: bool,\n+    pub ast_id: FileAstId<ast::MacroDef>,\n+}\n+\n // NB: There's no `FileAstId` for `Expr`. The only case where this would be useful is for array\n // lengths, but we don't do much with them yet.\n #[derive(Debug, Clone, Eq, PartialEq)]\n@@ -680,7 +694,8 @@ impl ModItem {\n             | ModItem::Trait(_)\n             | ModItem::Impl(_)\n             | ModItem::Mod(_)\n-            | ModItem::MacroRules(_) => None,\n+            | ModItem::MacroRules(_)\n+            | ModItem::MacroDef(_) => None,\n             ModItem::MacroCall(call) => Some(AssocItem::MacroCall(*call)),\n             ModItem::Const(konst) => Some(AssocItem::Const(*konst)),\n             ModItem::TypeAlias(alias) => Some(AssocItem::TypeAlias(*alias)),\n@@ -708,6 +723,7 @@ impl ModItem {\n             ModItem::Mod(it) => tree[it.index].ast_id().upcast(),\n             ModItem::MacroCall(it) => tree[it.index].ast_id().upcast(),\n             ModItem::MacroRules(it) => tree[it.index].ast_id().upcast(),\n+            ModItem::MacroDef(it) => tree[it.index].ast_id().upcast(),\n         }\n     }\n }"}, {"sha": "1dc06a211556ec00e375877d4934448ed3c156e1", "filename": "crates/hir_def/src/item_tree/lower.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -101,7 +101,8 @@ impl Ctx {\n             | ast::Item::ExternCrate(_)\n             | ast::Item::Use(_)\n             | ast::Item::MacroCall(_)\n-            | ast::Item::MacroRules(_) => {}\n+            | ast::Item::MacroRules(_)\n+            | ast::Item::MacroDef(_) => {}\n         };\n \n         let attrs = Attrs::new(item, &self.hygiene);\n@@ -122,6 +123,7 @@ impl Ctx {\n             ast::Item::ExternCrate(ast) => self.lower_extern_crate(ast).map(Into::into),\n             ast::Item::MacroCall(ast) => self.lower_macro_call(ast).map(Into::into),\n             ast::Item::MacroRules(ast) => self.lower_macro_rules(ast).map(Into::into),\n+            ast::Item::MacroDef(ast) => self.lower_macro_def(ast).map(Into::into),\n             ast::Item::ExternBlock(ast) => {\n                 Some(ModItems(self.lower_extern_block(ast).into_iter().collect::<SmallVec<_>>()))\n             }\n@@ -561,6 +563,18 @@ impl Ctx {\n         Some(id(self.data().macro_rules.alloc(res)))\n     }\n \n+    fn lower_macro_def(&mut self, m: &ast::MacroDef) -> Option<FileItemTreeId<MacroDef>> {\n+        let name = m.name().map(|it| it.as_name())?;\n+        let attrs = Attrs::new(m, &self.hygiene);\n+\n+        let ast_id = self.source_ast_id_map.ast_id(m);\n+        let visibility = self.lower_visibility(m);\n+\n+        let is_builtin = attrs.by_key(\"rustc_builtin_macro\").exists();\n+        let res = MacroDef { name, is_builtin, ast_id, visibility };\n+        Some(id(self.data().macro_defs.alloc(res)))\n+    }\n+\n     fn lower_extern_block(&mut self, block: &ast::ExternBlock) -> Vec<ModItem> {\n         block.extern_item_list().map_or(Vec::new(), |list| {\n             list.extern_items()"}, {"sha": "c2f741060f5ca58ce5fbc7742d38c79b87b71b11", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 28, "deletions": 1, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -976,6 +976,33 @@ impl ModCollector<'_, '_> {\n                 }\n                 ModItem::MacroCall(mac) => self.collect_macro_call(&self.item_tree[mac]),\n                 ModItem::MacroRules(mac) => self.collect_macro_rules(&self.item_tree[mac]),\n+                ModItem::MacroDef(id) => {\n+                    let mac = &self.item_tree[id];\n+                    let ast_id = InFile::new(self.file_id, mac.ast_id.upcast());\n+\n+                    // \"Macro 2.0\" is not currently supported by rust-analyzer, but libcore uses it\n+                    // to define builtin macros, so we support at least that part.\n+                    if mac.is_builtin {\n+                        let krate = self.def_collector.def_map.krate;\n+                        if let Some(macro_id) = find_builtin_macro(&mac.name, krate, ast_id) {\n+                            let vis = self\n+                                .def_collector\n+                                .def_map\n+                                .resolve_visibility(\n+                                    self.def_collector.db,\n+                                    self.module_id,\n+                                    &self.item_tree[mac.visibility],\n+                                )\n+                                .unwrap_or(Visibility::Public);\n+                            self.def_collector.update(\n+                                self.module_id,\n+                                &[(Some(mac.name.clone()), PerNs::macros(macro_id, vis))],\n+                                vis,\n+                                ImportType::Named,\n+                            );\n+                        }\n+                    }\n+                }\n                 ModItem::Impl(imp) => {\n                     let module = ModuleId {\n                         krate: self.def_collector.def_map.krate,\n@@ -1280,7 +1307,7 @@ impl ModCollector<'_, '_> {\n     }\n \n     fn collect_macro_rules(&mut self, mac: &MacroRules) {\n-        let ast_id = InFile::new(self.file_id, mac.ast_id);\n+        let ast_id = InFile::new(self.file_id, mac.ast_id.upcast());\n \n         // Case 1: builtin macros\n         if mac.is_builtin {"}, {"sha": "df82cf8e65f729b6329c8122f72ec6bfa4a29c29", "filename": "crates/hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -63,7 +63,7 @@ macro_rules! register_builtin {\n pub fn find_builtin_macro(\n     ident: &name::Name,\n     krate: CrateId,\n-    ast_id: AstId<ast::MacroRules>,\n+    ast_id: AstId<ast::Macro>,\n ) -> Option<MacroDefId> {\n     let kind = find_by_name(ident)?;\n \n@@ -515,24 +515,27 @@ mod tests {\n     fn expand_builtin_macro(ra_fixture: &str) -> String {\n         let (db, file_id) = TestDB::with_single_file(&ra_fixture);\n         let parsed = db.parse(file_id);\n-        let macro_rules: Vec<_> =\n+        let mut macro_rules: Vec<_> =\n             parsed.syntax_node().descendants().filter_map(ast::MacroRules::cast).collect();\n-        let macro_calls: Vec<_> =\n+        let mut macro_calls: Vec<_> =\n             parsed.syntax_node().descendants().filter_map(ast::MacroCall::cast).collect();\n \n         let ast_id_map = db.ast_id_map(file_id.into());\n \n         assert_eq!(macro_rules.len(), 1, \"test must contain exactly 1 `macro_rules!`\");\n         assert_eq!(macro_calls.len(), 1, \"test must contain exactly 1 macro call\");\n-        let expander = find_by_name(&macro_rules[0].name().unwrap().as_name()).unwrap();\n+        let macro_rules = ast::Macro::from(macro_rules.pop().unwrap());\n+        let macro_call = macro_calls.pop().unwrap();\n+\n+        let expander = find_by_name(&macro_rules.name().unwrap().as_name()).unwrap();\n \n         let krate = CrateId(0);\n         let file_id = match expander {\n             Either::Left(expander) => {\n                 // the first one should be a macro_rules\n                 let def = MacroDefId {\n                     krate: Some(CrateId(0)),\n-                    ast_id: Some(AstId::new(file_id.into(), ast_id_map.ast_id(&macro_rules[0]))),\n+                    ast_id: Some(AstId::new(file_id.into(), ast_id_map.ast_id(&macro_rules))),\n                     kind: MacroDefKind::BuiltIn(expander),\n                     local_inner: false,\n                 };\n@@ -542,7 +545,7 @@ mod tests {\n                     krate,\n                     kind: MacroCallKind::FnLike(AstId::new(\n                         file_id.into(),\n-                        ast_id_map.ast_id(&macro_calls[0]),\n+                        ast_id_map.ast_id(&macro_call),\n                     )),\n                 };\n \n@@ -553,12 +556,12 @@ mod tests {\n                 // the first one should be a macro_rules\n                 let def = MacroDefId {\n                     krate: Some(krate),\n-                    ast_id: Some(AstId::new(file_id.into(), ast_id_map.ast_id(&macro_rules[0]))),\n+                    ast_id: Some(AstId::new(file_id.into(), ast_id_map.ast_id(&macro_rules))),\n                     kind: MacroDefKind::BuiltInEager(expander),\n                     local_inner: false,\n                 };\n \n-                let args = macro_calls[0].token_tree().unwrap();\n+                let args = macro_call.token_tree().unwrap();\n                 let parsed_args = mbe::ast_to_token_tree(&args).unwrap().0;\n \n                 let arg_id = db.intern_eager_expansion({"}, {"sha": "4477d867f7cfaf35084843cae5b67b5587e968a5", "filename": "crates/hir_expand/src/db.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdb.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -129,7 +129,10 @@ fn ast_id_map(db: &dyn AstDatabase, file_id: HirFileId) -> Arc<AstIdMap> {\n fn macro_def(db: &dyn AstDatabase, id: MacroDefId) -> Option<Arc<(TokenExpander, mbe::TokenMap)>> {\n     match id.kind {\n         MacroDefKind::Declarative => {\n-            let macro_call = id.ast_id?.to_node(db);\n+            let macro_call = match id.ast_id?.to_node(db) {\n+                syntax::ast::Macro::MacroRules(mac) => mac,\n+                syntax::ast::Macro::MacroDef(_) => return None,\n+            };\n             let arg = macro_call.token_tree()?;\n             let (tt, tmap) = mbe::ast_to_token_tree(&arg).or_else(|| {\n                 log::warn!(\"fail on macro_def to token tree: {:#?}\", arg);"}, {"sha": "55f026c7be9b21a014782ad67b63f6d4b065f294", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -145,7 +145,10 @@ impl HirFileId {\n                 let arg_tt = loc.kind.arg(db)?;\n \n                 let def = loc.def.ast_id.and_then(|id| {\n-                    let def_tt = id.to_node(db).token_tree()?;\n+                    let def_tt = match id.to_node(db) {\n+                        ast::Macro::MacroRules(mac) => mac.token_tree()?,\n+                        ast::Macro::MacroDef(_) => return None,\n+                    };\n                     Some(InFile::new(id.file_id, def_tt))\n                 });\n \n@@ -228,7 +231,7 @@ pub struct MacroDefId {\n     // (which will probably require touching this code), we can instead use\n     // that (and also remove the hacks for resolving built-in derives).\n     pub krate: Option<CrateId>,\n-    pub ast_id: Option<AstId<ast::MacroRules>>,\n+    pub ast_id: Option<AstId<ast::Macro>>,\n     pub kind: MacroDefKind,\n \n     pub local_inner: bool,"}, {"sha": "70c568ea1e7fbe51bd4f278a504d77b03924ca58", "filename": "crates/syntax/src/ast.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -19,8 +19,8 @@ pub use self::{\n     expr_ext::{ArrayExprKind, BinOp, Effect, ElseBranch, LiteralKind, PrefixOp, RangeOp},\n     generated::{nodes::*, tokens::*},\n     node_ext::{\n-        AttrKind, FieldKind, NameOrNameRef, PathSegmentKind, SelfParamKind, SlicePatComponents,\n-        StructKind, TypeBoundKind, VisibilityKind,\n+        AttrKind, FieldKind, Macro, NameOrNameRef, PathSegmentKind, SelfParamKind,\n+        SlicePatComponents, StructKind, TypeBoundKind, VisibilityKind,\n     },\n     token_ext::*,\n     traits::*,"}, {"sha": "6eae323f4a24bdd3c9196028ea3889874db4ead0", "filename": "crates/syntax/src/ast/generated/nodes.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -286,6 +286,18 @@ impl MacroRules {\n     pub fn token_tree(&self) -> Option<TokenTree> { support::child(&self.syntax) }\n }\n #[derive(Debug, Clone, PartialEq, Eq, Hash)]\n+pub struct MacroDef {\n+    pub(crate) syntax: SyntaxNode,\n+}\n+impl ast::AttrsOwner for MacroDef {}\n+impl ast::NameOwner for MacroDef {}\n+impl ast::VisibilityOwner for MacroDef {}\n+impl MacroDef {\n+    pub fn macro_token(&self) -> Option<SyntaxToken> { support::token(&self.syntax, T![macro]) }\n+    pub fn args(&self) -> Option<TokenTree> { support::child(&self.syntax) }\n+    pub fn body(&self) -> Option<TokenTree> { support::child(&self.syntax) }\n+}\n+#[derive(Debug, Clone, PartialEq, Eq, Hash)]\n pub struct Module {\n     pub(crate) syntax: SyntaxNode,\n }\n@@ -1332,6 +1344,7 @@ pub enum Item {\n     Impl(Impl),\n     MacroCall(MacroCall),\n     MacroRules(MacroRules),\n+    MacroDef(MacroDef),\n     Module(Module),\n     Static(Static),\n     Struct(Struct),\n@@ -1689,6 +1702,17 @@ impl AstNode for MacroRules {\n     }\n     fn syntax(&self) -> &SyntaxNode { &self.syntax }\n }\n+impl AstNode for MacroDef {\n+    fn can_cast(kind: SyntaxKind) -> bool { kind == MACRO_DEF }\n+    fn cast(syntax: SyntaxNode) -> Option<Self> {\n+        if Self::can_cast(syntax.kind()) {\n+            Some(Self { syntax })\n+        } else {\n+            None\n+        }\n+    }\n+    fn syntax(&self) -> &SyntaxNode { &self.syntax }\n+}\n impl AstNode for Module {\n     fn can_cast(kind: SyntaxKind) -> bool { kind == MODULE }\n     fn cast(syntax: SyntaxNode) -> Option<Self> {\n@@ -3086,6 +3110,9 @@ impl From<MacroCall> for Item {\n impl From<MacroRules> for Item {\n     fn from(node: MacroRules) -> Item { Item::MacroRules(node) }\n }\n+impl From<MacroDef> for Item {\n+    fn from(node: MacroDef) -> Item { Item::MacroDef(node) }\n+}\n impl From<Module> for Item {\n     fn from(node: Module) -> Item { Item::Module(node) }\n }\n@@ -3111,7 +3138,7 @@ impl AstNode for Item {\n     fn can_cast(kind: SyntaxKind) -> bool {\n         match kind {\n             CONST | ENUM | EXTERN_BLOCK | EXTERN_CRATE | FN | IMPL | MACRO_CALL | MACRO_RULES\n-            | MODULE | STATIC | STRUCT | TRAIT | TYPE_ALIAS | UNION | USE => true,\n+            | MACRO_DEF | MODULE | STATIC | STRUCT | TRAIT | TYPE_ALIAS | UNION | USE => true,\n             _ => false,\n         }\n     }\n@@ -3125,6 +3152,7 @@ impl AstNode for Item {\n             IMPL => Item::Impl(Impl { syntax }),\n             MACRO_CALL => Item::MacroCall(MacroCall { syntax }),\n             MACRO_RULES => Item::MacroRules(MacroRules { syntax }),\n+            MACRO_DEF => Item::MacroDef(MacroDef { syntax }),\n             MODULE => Item::Module(Module { syntax }),\n             STATIC => Item::Static(Static { syntax }),\n             STRUCT => Item::Struct(Struct { syntax }),\n@@ -3146,6 +3174,7 @@ impl AstNode for Item {\n             Item::Impl(it) => &it.syntax,\n             Item::MacroCall(it) => &it.syntax,\n             Item::MacroRules(it) => &it.syntax,\n+            Item::MacroDef(it) => &it.syntax,\n             Item::Module(it) => &it.syntax,\n             Item::Static(it) => &it.syntax,\n             Item::Struct(it) => &it.syntax,\n@@ -3615,6 +3644,11 @@ impl std::fmt::Display for MacroRules {\n         std::fmt::Display::fmt(self.syntax(), f)\n     }\n }\n+impl std::fmt::Display for MacroDef {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        std::fmt::Display::fmt(self.syntax(), f)\n+    }\n+}\n impl std::fmt::Display for Module {\n     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n         std::fmt::Display::fmt(self.syntax(), f)"}, {"sha": "40dec3c7f99c84a6659a34a7556d3ec2ca5f3824", "filename": "crates/syntax/src/ast/node_ext.rs", "status": "modified", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -3,6 +3,7 @@\n \n use std::fmt;\n \n+use ast::AttrsOwner;\n use itertools::Itertools;\n use parser::SyntaxKind;\n \n@@ -31,6 +32,57 @@ fn text_of_first_token(node: &SyntaxNode) -> &SmolStr {\n     node.green().children().next().and_then(|it| it.into_token()).unwrap().text()\n }\n \n+pub enum Macro {\n+    MacroRules(ast::MacroRules),\n+    MacroDef(ast::MacroDef),\n+}\n+\n+impl From<ast::MacroRules> for Macro {\n+    fn from(it: ast::MacroRules) -> Self {\n+        Macro::MacroRules(it)\n+    }\n+}\n+\n+impl From<ast::MacroDef> for Macro {\n+    fn from(it: ast::MacroDef) -> Self {\n+        Macro::MacroDef(it)\n+    }\n+}\n+\n+impl AstNode for Macro {\n+    fn can_cast(kind: SyntaxKind) -> bool {\n+        match kind {\n+            SyntaxKind::MACRO_RULES | SyntaxKind::MACRO_DEF => true,\n+            _ => false,\n+        }\n+    }\n+    fn cast(syntax: SyntaxNode) -> Option<Self> {\n+        let res = match syntax.kind() {\n+            SyntaxKind::MACRO_RULES => Macro::MacroRules(ast::MacroRules { syntax }),\n+            SyntaxKind::MACRO_DEF => Macro::MacroDef(ast::MacroDef { syntax }),\n+            _ => return None,\n+        };\n+        Some(res)\n+    }\n+    fn syntax(&self) -> &SyntaxNode {\n+        match self {\n+            Macro::MacroRules(it) => it.syntax(),\n+            Macro::MacroDef(it) => it.syntax(),\n+        }\n+    }\n+}\n+\n+impl NameOwner for Macro {\n+    fn name(&self) -> Option<ast::Name> {\n+        match self {\n+            Macro::MacroRules(mac) => mac.name(),\n+            Macro::MacroDef(mac) => mac.name(),\n+        }\n+    }\n+}\n+\n+impl AttrsOwner for Macro {}\n+\n #[derive(Debug, Clone, PartialEq, Eq)]\n pub enum AttrKind {\n     Inner,\n@@ -462,4 +514,6 @@ impl ast::DocCommentsOwner for ast::Const {}\n impl ast::DocCommentsOwner for ast::TypeAlias {}\n impl ast::DocCommentsOwner for ast::Impl {}\n impl ast::DocCommentsOwner for ast::MacroRules {}\n+impl ast::DocCommentsOwner for ast::MacroDef {}\n+impl ast::DocCommentsOwner for ast::Macro {}\n impl ast::DocCommentsOwner for ast::Use {}"}, {"sha": "391647fc67168fa3cb44a0aa9d989f893af17ab1", "filename": "crates/syntax/src/display.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c31c3246a8c87a3639623c30b692a57e728bb046/crates%2Fsyntax%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fdisplay.rs?ref=c31c3246a8c87a3639623c30b692a57e728bb046", "patch": "@@ -76,8 +76,20 @@ pub fn type_label(node: &ast::TypeAlias) -> String {\n     label.trim().to_owned()\n }\n \n-pub fn macro_label(node: &ast::MacroRules) -> String {\n+pub fn macro_label(node: &ast::Macro) -> String {\n     let name = node.name().map(|name| name.syntax().text().to_string()).unwrap_or_default();\n-    let vis = if node.has_atom_attr(\"macro_export\") { \"#[macro_export]\\n\" } else { \"\" };\n-    format!(\"{}macro_rules! {}\", vis, name)\n+    match node {\n+        ast::Macro::MacroRules(node) => {\n+            let vis = if node.has_atom_attr(\"macro_export\") { \"#[macro_export]\\n\" } else { \"\" };\n+            format!(\"{}macro_rules! {}\", vis, name)\n+        }\n+        ast::Macro::MacroDef(node) => {\n+            let mut s = String::new();\n+            if let Some(vis) = node.visibility() {\n+                format_to!(s, \"{} \", vis);\n+            }\n+            format_to!(s, \"macro {}\", name);\n+            s\n+        }\n+    }\n }"}]}