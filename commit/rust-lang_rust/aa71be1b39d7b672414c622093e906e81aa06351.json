{"sha": "aa71be1b39d7b672414c622093e906e81aa06351", "node_id": "C_kwDOAAsO6NoAKGFhNzFiZTFiMzlkN2I2NzI0MTRjNjIyMDkzZTkwNmU4MWFhMDYzNTE", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-06-13T22:47:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-13T22:47:25Z"}, "message": "Rollup merge of #97508 - JohnTitor:more-strict-placeholder-dyn-obj, r=pnkfelix\n\nHarden bad placeholder checks on statics/consts\n\nResubmission of #89161\nFixes https://github.com/rust-lang/rust/issues/88643\n\nIn #83739, I added a check for trait objects on statics/consts but it wasn't robust. `is_suggestable_infer_ty` fn does a more strict check and finds more bad placeholders. See https://github.com/rust-lang/rust/pull/89161#issuecomment-934690300 for the more detailed explanation.\n\nr? `@pnkfelix` as you're the reviewer of the previous PR", "tree": {"sha": "b72fb84b835e64cc9e6de4c5fc71491b96711fb0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b72fb84b835e64cc9e6de4c5fc71491b96711fb0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa71be1b39d7b672414c622093e906e81aa06351", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJip759CRBK7hj4Ov3rIwAAoEIIAAIbBUdCubEAgr2toa7SaaTo\nwuSJ9TwNXI3QZnJle/Kf6Pz3TWfSoGea5uc7EpNtt9FwDI0GK4MePpFuARODtch+\nMU72zW8DONxOPDEhlFIXvlJ3nEynNac0rUsvsVxRzVPBlZr+eIs2vio878Tz/nca\nKITs4rMBVfc3KmItDab+41mMPnDt5RmRJb9vk9xCnQfOvUvEnm/hB/ZdodkQoPdM\nJp1/hu2O0yH0abAuakXy8hpoCLb+qaeAZ5yDG5lTX57Hx1UjHK8bWvAC2xLwXeo/\nUshdRSbtoNuTA5Lk2nAubAMjM/TaB+ddnE8k/zC3KBB3PiA3IZnJsZzWZQM8uv4=\n=zMpM\n-----END PGP SIGNATURE-----\n", "payload": "tree b72fb84b835e64cc9e6de4c5fc71491b96711fb0\nparent 9688594d0040c7e80e3efe6efa5a0c4d155ba5ce\nparent 344feef0cbff3f52e0c1238ba470977e7e2e6cf5\nauthor Yuki Okushi <jtitor@2k36.org> 1655160445 +0900\ncommitter GitHub <noreply@github.com> 1655160445 +0900\n\nRollup merge of #97508 - JohnTitor:more-strict-placeholder-dyn-obj, r=pnkfelix\n\nHarden bad placeholder checks on statics/consts\n\nResubmission of #89161\nFixes https://github.com/rust-lang/rust/issues/88643\n\nIn #83739, I added a check for trait objects on statics/consts but it wasn't robust. `is_suggestable_infer_ty` fn does a more strict check and finds more bad placeholders. See https://github.com/rust-lang/rust/pull/89161#issuecomment-934690300 for the more detailed explanation.\n\nr? `@pnkfelix` as you're the reviewer of the previous PR\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa71be1b39d7b672414c622093e906e81aa06351", "html_url": "https://github.com/rust-lang/rust/commit/aa71be1b39d7b672414c622093e906e81aa06351", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa71be1b39d7b672414c622093e906e81aa06351/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9688594d0040c7e80e3efe6efa5a0c4d155ba5ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/9688594d0040c7e80e3efe6efa5a0c4d155ba5ce", "html_url": "https://github.com/rust-lang/rust/commit/9688594d0040c7e80e3efe6efa5a0c4d155ba5ce"}, {"sha": "344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "url": "https://api.github.com/repos/rust-lang/rust/commits/344feef0cbff3f52e0c1238ba470977e7e2e6cf5", "html_url": "https://github.com/rust-lang/rust/commit/344feef0cbff3f52e0c1238ba470977e7e2e6cf5"}], "stats": {"total": 84, "additions": 75, "deletions": 9}, "files": [{"sha": "a74cce5d13ee0c6bfe894318fe69ba7630fdc41b", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -806,8 +806,7 @@ fn convert_item(tcx: TyCtxt<'_>, item_id: hir::ItemId) {\n                 hir::ItemKind::Fn(..) => tcx.ensure().fn_sig(def_id),\n                 hir::ItemKind::OpaqueTy(..) => tcx.ensure().item_bounds(def_id),\n                 hir::ItemKind::Const(ty, ..) | hir::ItemKind::Static(ty, ..) => {\n-                    // (#75889): Account for `const C: dyn Fn() -> _ = \"\";`\n-                    if let hir::TyKind::TraitObject(..) = ty.kind {\n+                    if !is_suggestable_infer_ty(ty) {\n                         let mut visitor = HirPlaceholderCollector::default();\n                         visitor.visit_item(it);\n                         placeholder_type_error(tcx, None, visitor.0, false, None, it.kind.descr());"}, {"sha": "9b7c0d7cc6e2e4671c31ea8234674dda1b7afbc4", "filename": "src/test/ui/typeck/issue-74086.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.rs?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -1,4 +1,5 @@\n fn main() {\n     static BUG: fn(_) -> u8 = |_| 8;\n     //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions [E0121]\n+    //~| ERROR the placeholder `_` is not allowed within types on item signatures for static items\n }"}, {"sha": "95ebf9a906c142beac58223f9f84cb8aed9b255a", "filename": "src/test/ui/typeck/issue-74086.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-74086.stderr?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -4,6 +4,12 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL |     static BUG: fn(_) -> u8 = |_| 8;\n    |                    ^ not allowed in type signatures\n \n-error: aborting due to previous error\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-74086.rs:2:20\n+   |\n+LL |     static BUG: fn(_) -> u8 = |_| 8;\n+   |                    ^ not allowed in type signatures\n+\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0121`."}, {"sha": "fb3949478a4d3e758ecd33a2ed602a2341d49de4", "filename": "src/test/ui/typeck/issue-81885.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.rs?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -1,8 +1,9 @@\n const TEST4: fn() -> _ = 42;\n                   //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions\n+                  //~| ERROR the placeholder `_` is not allowed within types on item signatures for constant items\n \n fn main() {\n     const TEST5: fn() -> _ = 42;\n                       //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions\n-\n+                      //~| ERROR the placeholder `_` is not allowed within types on item signatures for constant items\n }"}, {"sha": "91c08bd8235029634b22313c37754ecd02746b0f", "filename": "src/test/ui/typeck/issue-81885.stderr", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-81885.stderr?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -4,12 +4,24 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL | const TEST4: fn() -> _ = 42;\n    |                      ^ not allowed in type signatures\n \n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constant items\n+  --> $DIR/issue-81885.rs:1:22\n+   |\n+LL | const TEST4: fn() -> _ = 42;\n+   |                      ^ not allowed in type signatures\n+\n error[E0121]: the placeholder `_` is not allowed within types on item signatures for functions\n-  --> $DIR/issue-81885.rs:5:26\n+  --> $DIR/issue-81885.rs:6:26\n+   |\n+LL |     const TEST5: fn() -> _ = 42;\n+   |                          ^ not allowed in type signatures\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constant items\n+  --> $DIR/issue-81885.rs:6:26\n    |\n LL |     const TEST5: fn() -> _ = 42;\n    |                          ^ not allowed in type signatures\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0121`."}, {"sha": "4435cba0207651dbc1c87f9fa61f6e73b58db997", "filename": "src/test/ui/typeck/issue-88643.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.rs?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -0,0 +1,19 @@\n+// Regression test for the ICE described in #88643. Specifically:\n+// https://github.com/rust-lang/rust/issues/88643#issuecomment-913128893\n+// and https://github.com/rust-lang/rust/issues/88643#issuecomment-913171935\n+// and https://github.com/rust-lang/rust/issues/88643#issuecomment-913765984\n+\n+use std::collections::HashMap;\n+\n+pub trait T {}\n+\n+static CALLBACKS: HashMap<*const dyn T, dyn FnMut(&mut _) + 'static> = HashMap::new();\n+//~^ ERROR: the placeholder `_` is not allowed within types on item signatures for static items [E0121]\n+\n+static CALLBACKS2: Vec<dyn Fn(& _)> = Vec::new();\n+//~^ ERROR: the placeholder `_` is not allowed within types on item signatures for static items [E0121]\n+\n+static CALLBACKS3: Option<dyn Fn(& _)> = None;\n+//~^ ERROR: the placeholder `_` is not allowed within types on item signatures for static items [E0121]\n+\n+fn main() {}"}, {"sha": "d5d596b6f428444b6a3b96adaa819aba54e0f1bc", "filename": "src/test/ui/typeck/issue-88643.stderr", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-88643.stderr?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -0,0 +1,21 @@\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-88643.rs:10:56\n+   |\n+LL | static CALLBACKS: HashMap<*const dyn T, dyn FnMut(&mut _) + 'static> = HashMap::new();\n+   |                                                        ^ not allowed in type signatures\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-88643.rs:13:33\n+   |\n+LL | static CALLBACKS2: Vec<dyn Fn(& _)> = Vec::new();\n+   |                                 ^ not allowed in type signatures\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for static items\n+  --> $DIR/issue-88643.rs:16:36\n+   |\n+LL | static CALLBACKS3: Option<dyn Fn(& _)> = None;\n+   |                                    ^ not allowed in type signatures\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0121`."}, {"sha": "c459d8c3cdc17663f567cc8dcfd9016394864558", "filename": "src/test/ui/typeck/typeck_type_placeholder_item_help.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.rs?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -12,6 +12,7 @@ const TEST3: _ = Some(42);\n \n const TEST4: fn() -> _ = 42;\n //~^ ERROR the placeholder `_` is not allowed within types on item signatures for functions\n+//~| ERROR the placeholder `_` is not allowed within types on item signatures for constant items\n \n trait Test5 {\n     const TEST5: _ = 42;"}, {"sha": "07a5dbd93c7432019860cc177d5b5a6bb481da0b", "filename": "src/test/ui/typeck/typeck_type_placeholder_item_help.stderr", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa71be1b39d7b672414c622093e906e81aa06351/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item_help.stderr?ref=aa71be1b39d7b672414c622093e906e81aa06351", "patch": "@@ -31,8 +31,14 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL | const TEST4: fn() -> _ = 42;\n    |                      ^ not allowed in type signatures\n \n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constant items\n+  --> $DIR/typeck_type_placeholder_item_help.rs:13:22\n+   |\n+LL | const TEST4: fn() -> _ = 42;\n+   |                      ^ not allowed in type signatures\n+\n error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n-  --> $DIR/typeck_type_placeholder_item_help.rs:17:18\n+  --> $DIR/typeck_type_placeholder_item_help.rs:18:18\n    |\n LL |     const TEST5: _ = 42;\n    |                  ^\n@@ -41,14 +47,14 @@ LL |     const TEST5: _ = 42;\n    |                  help: replace with the correct type: `i32`\n \n error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n-  --> $DIR/typeck_type_placeholder_item_help.rs:24:18\n+  --> $DIR/typeck_type_placeholder_item_help.rs:25:18\n    |\n LL |     const TEST6: _ = 13;\n    |                  ^\n    |                  |\n    |                  not allowed in type signatures\n    |                  help: replace with the correct type: `i32`\n \n-error: aborting due to 6 previous errors\n+error: aborting due to 7 previous errors\n \n For more information about this error, try `rustc --explain E0121`."}]}