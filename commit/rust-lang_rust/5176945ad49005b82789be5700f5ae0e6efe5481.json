{"sha": "5176945ad49005b82789be5700f5ae0e6efe5481", "node_id": "C_kwDOAAsO6NoAKDUxNzY5NDVhZDQ5MDA1YjgyNzg5YmU1NzAwZjVhZTBlNmVmZTU0ODE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-21T05:24:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-21T05:24:48Z"}, "message": "Auto merge of #95612 - davidtwco:split-debuginfo-in-bootstrap, r=Mark-Simulacrum\n\nbootstrap: add split-debuginfo config\n\nReplace `run-dysutil` option with more general `split-debuginfo` option that works on all platforms.\n\nr? `@Mark-Simulacrum`", "tree": {"sha": "d793a27cc9b8207a44369d4ee567c8ed4066b64d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d793a27cc9b8207a44369d4ee567c8ed4066b64d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5176945ad49005b82789be5700f5ae0e6efe5481", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5176945ad49005b82789be5700f5ae0e6efe5481", "html_url": "https://github.com/rust-lang/rust/commit/5176945ad49005b82789be5700f5ae0e6efe5481", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5176945ad49005b82789be5700f5ae0e6efe5481/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7be1da0319eb5f381bc0aa8559367bb33dfe90a5", "url": "https://api.github.com/repos/rust-lang/rust/commits/7be1da0319eb5f381bc0aa8559367bb33dfe90a5", "html_url": "https://github.com/rust-lang/rust/commit/7be1da0319eb5f381bc0aa8559367bb33dfe90a5"}, {"sha": "65cc0ad455634ad75be88781fa373400cfd337a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/65cc0ad455634ad75be88781fa373400cfd337a0", "html_url": "https://github.com/rust-lang/rust/commit/65cc0ad455634ad75be88781fa373400cfd337a0"}], "stats": {"total": 98, "additions": 77, "deletions": 21}, "files": [{"sha": "4d20ed841d47c502bd0b17d39c9f557ac91904b2", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5176945ad49005b82789be5700f5ae0e6efe5481/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5176945ad49005b82789be5700f5ae0e6efe5481/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=5176945ad49005b82789be5700f5ae0e6efe5481", "patch": "@@ -987,7 +987,7 @@ fn link_natively<'a, B: ArchiveBuilder<'a>>(\n \n         // On MSVC packed debug information is produced by the linker itself so\n         // there's no need to do anything else here.\n-        SplitDebuginfo::Packed if sess.target.is_like_msvc => {}\n+        SplitDebuginfo::Packed if sess.target.is_like_windows => {}\n \n         // ... and otherwise we're processing a `*.dwp` packed dwarf file.\n         //"}, {"sha": "dd886879b145d897f50d9ddae5307caacc3293ac", "filename": "config.toml.example", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5176945ad49005b82789be5700f5ae0e6efe5481/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/5176945ad49005b82789be5700f5ae0e6efe5481/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=5176945ad49005b82789be5700f5ae0e6efe5481", "patch": "@@ -473,13 +473,23 @@ changelog-seen = 2\n # FIXME(#61117): Some tests fail when this option is enabled.\n #debuginfo-level-tests = 0\n \n-# Whether to run `dsymutil` on Apple platforms to gather debug info into .dSYM\n-# bundles. `dsymutil` adds time to builds for no clear benefit, and also makes\n-# it more difficult for debuggers to find debug info. The compiler currently\n-# defaults to running `dsymutil` to preserve its historical default, but when\n-# compiling the compiler itself, we skip it by default since we know it's safe\n-# to do so in that case.\n-#run-dsymutil = false\n+# Should rustc be build with split debuginfo? Default is platform dependent.\n+# Valid values are the same as those accepted by `-C split-debuginfo`\n+# (`off`/`unpacked`/`packed`).\n+#\n+# On Linux, split debuginfo is disabled by default.\n+#\n+# On Apple platforms, unpacked split debuginfo is used by default. Unpacked\n+# debuginfo does not run `dsymutil`, which packages debuginfo from disparate\n+# object files into a single `.dSYM` file. `dsymutil` adds time to builds for\n+# no clear benefit, and also makes it more difficult for debuggers to find\n+# debug info. The compiler currently defaults to running `dsymutil` to preserve\n+# its historical default, but when compiling the compiler itself, we skip it by\n+# default since we know it's safe to do so in that case.\n+#\n+# On Windows platforms, packed debuginfo is the only supported option,\n+# producing a `.pdb` file.\n+#split-debuginfo = if linux { off } else if windows { packed } else if apple { unpacked }\n \n # Whether or not `panic!`s generate backtraces (RUST_BACKTRACE)\n #backtrace = true"}, {"sha": "310da7c646aa058b4c8bbc629ec22eda25907c80", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5176945ad49005b82789be5700f5ae0e6efe5481/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5176945ad49005b82789be5700f5ae0e6efe5481/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=5176945ad49005b82789be5700f5ae0e6efe5481", "patch": "@@ -14,7 +14,7 @@ use std::time::{Duration, Instant};\n use crate::cache::{Cache, Interned, INTERNER};\n use crate::check;\n use crate::compile;\n-use crate::config::TargetSelection;\n+use crate::config::{SplitDebuginfo, TargetSelection};\n use crate::dist;\n use crate::doc;\n use crate::flags::{Color, Subcommand};\n@@ -1390,17 +1390,17 @@ impl<'a> Builder<'a> {\n             },\n         );\n \n-        // `dsymutil` adds time to builds on Apple platforms for no clear benefit, and also makes\n-        // it more difficult for debuggers to find debug info. The compiler currently defaults to\n-        // running `dsymutil` to preserve its historical default, but when compiling the compiler\n-        // itself, we skip it by default since we know it's safe to do so in that case.\n-        // See https://github.com/rust-lang/rust/issues/79361 for more info on this flag.\n-        if target.contains(\"apple\") {\n-            if self.config.rust_run_dsymutil {\n-                rustflags.arg(\"-Csplit-debuginfo=packed\");\n-            } else {\n-                rustflags.arg(\"-Csplit-debuginfo=unpacked\");\n+        // FIXME(davidtwco): #[cfg(not(bootstrap))] - #95612 needs to be in the bootstrap compiler\n+        // for this conditional to be removed.\n+        if !target.contains(\"windows\") || compiler.stage >= 1 {\n+            if target.contains(\"linux\") || target.contains(\"windows\") {\n+                rustflags.arg(\"-Zunstable-options\");\n             }\n+            match self.config.rust_split_debuginfo {\n+                SplitDebuginfo::Packed => rustflags.arg(\"-Csplit-debuginfo=packed\"),\n+                SplitDebuginfo::Unpacked => rustflags.arg(\"-Csplit-debuginfo=unpacked\"),\n+                SplitDebuginfo::Off => rustflags.arg(\"-Csplit-debuginfo=off\"),\n+            };\n         }\n \n         if self.config.cmd.bless() {"}, {"sha": "f273fb42215e95873c8e48d9b86a0e8d4fb14a87", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 48, "deletions": 2, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/5176945ad49005b82789be5700f5ae0e6efe5481/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5176945ad49005b82789be5700f5ae0e6efe5481/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=5176945ad49005b82789be5700f5ae0e6efe5481", "patch": "@@ -130,7 +130,7 @@ pub struct Config {\n     pub rust_debuginfo_level_std: u32,\n     pub rust_debuginfo_level_tools: u32,\n     pub rust_debuginfo_level_tests: u32,\n-    pub rust_run_dsymutil: bool,\n+    pub rust_split_debuginfo: SplitDebuginfo,\n     pub rust_rpath: bool,\n     pub rustc_parallel: bool,\n     pub rustc_default_linker: Option<String>,\n@@ -221,6 +221,46 @@ impl FromStr for LlvmLibunwind {\n     }\n }\n \n+#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, Hash)]\n+pub enum SplitDebuginfo {\n+    Packed,\n+    Unpacked,\n+    Off,\n+}\n+\n+impl Default for SplitDebuginfo {\n+    fn default() -> Self {\n+        SplitDebuginfo::Off\n+    }\n+}\n+\n+impl std::str::FromStr for SplitDebuginfo {\n+    type Err = ();\n+\n+    fn from_str(s: &str) -> Result<Self, Self::Err> {\n+        match s {\n+            \"packed\" => Ok(SplitDebuginfo::Packed),\n+            \"unpacked\" => Ok(SplitDebuginfo::Unpacked),\n+            \"off\" => Ok(SplitDebuginfo::Off),\n+            _ => Err(()),\n+        }\n+    }\n+}\n+\n+impl SplitDebuginfo {\n+    /// Returns the default `-Csplit-debuginfo` value for the current target. See the comment for\n+    /// `rust.split-debuginfo` in `config.toml.example`.\n+    fn default_for_platform(target: &str) -> Self {\n+        if target.contains(\"apple\") {\n+            SplitDebuginfo::Unpacked\n+        } else if target.contains(\"windows\") {\n+            SplitDebuginfo::Packed\n+        } else {\n+            SplitDebuginfo::Off\n+        }\n+    }\n+}\n+\n #[derive(Copy, Clone, Default, PartialEq, Eq, PartialOrd, Ord, Hash)]\n pub struct TargetSelection {\n     pub triple: Interned<String>,\n@@ -586,6 +626,7 @@ define_config! {\n         debuginfo_level_std: Option<u32> = \"debuginfo-level-std\",\n         debuginfo_level_tools: Option<u32> = \"debuginfo-level-tools\",\n         debuginfo_level_tests: Option<u32> = \"debuginfo-level-tests\",\n+        split_debuginfo: Option<String> = \"split-debuginfo\",\n         run_dsymutil: Option<bool> = \"run-dsymutil\",\n         backtrace: Option<bool> = \"backtrace\",\n         incremental: Option<bool> = \"incremental\",\n@@ -992,7 +1033,12 @@ impl Config {\n             debuginfo_level_std = rust.debuginfo_level_std;\n             debuginfo_level_tools = rust.debuginfo_level_tools;\n             debuginfo_level_tests = rust.debuginfo_level_tests;\n-            config.rust_run_dsymutil = rust.run_dsymutil.unwrap_or(false);\n+            config.rust_split_debuginfo = rust\n+                .split_debuginfo\n+                .as_deref()\n+                .map(SplitDebuginfo::from_str)\n+                .map(|v| v.expect(\"invalid value for rust.split_debuginfo\"))\n+                .unwrap_or(SplitDebuginfo::default_for_platform(&config.build.triple));\n             optimize = rust.optimize;\n             ignore_git = rust.ignore_git;\n             config.rust_new_symbol_mangling = rust.new_symbol_mangling;"}]}