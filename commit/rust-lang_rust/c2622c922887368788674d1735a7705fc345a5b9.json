{"sha": "c2622c922887368788674d1735a7705fc345a5b9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMyNjIyYzkyMjg4NzM2ODc4ODY3NGQxNzM1YTc3MDVmYzM0NWE1Yjk=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-10T15:33:18Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-10T15:33:18Z"}, "message": "Prefer names from outer DefMap over extern prelude", "tree": {"sha": "b0aab1d4c84036dfdc27da40e15c96828cd9e9fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0aab1d4c84036dfdc27da40e15c96828cd9e9fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2622c922887368788674d1735a7705fc345a5b9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2622c922887368788674d1735a7705fc345a5b9", "html_url": "https://github.com/rust-lang/rust/commit/c2622c922887368788674d1735a7705fc345a5b9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2622c922887368788674d1735a7705fc345a5b9/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "83280ea5746451f4580e6c32ba8a82be972cb786", "url": "https://api.github.com/repos/rust-lang/rust/commits/83280ea5746451f4580e6c32ba8a82be972cb786", "html_url": "https://github.com/rust-lang/rust/commit/83280ea5746451f4580e6c32ba8a82be972cb786"}], "stats": {"total": 45, "additions": 40, "deletions": 5}, "files": [{"sha": "db459b1ed8414d30c9ede5efc0dd1c4ce8639968", "filename": "crates/hir_def/src/nameres/path_resolution.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c2622c922887368788674d1735a7705fc345a5b9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2622c922887368788674d1735a7705fc345a5b9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs?ref=c2622c922887368788674d1735a7705fc345a5b9", "patch": "@@ -156,7 +156,7 @@ impl DefMap {\n         }\n     }\n \n-    pub(super) fn resolve_path_fp_with_macro_single(\n+    fn resolve_path_fp_with_macro_single(\n         &self,\n         db: &dyn DefDatabase,\n         mode: ResolveMode,\n@@ -384,10 +384,16 @@ impl DefMap {\n                 }\n             }\n         };\n-        let from_extern_prelude = self\n-            .extern_prelude\n-            .get(name)\n-            .map_or(PerNs::none(), |&it| PerNs::types(it, Visibility::Public));\n+        // Give precedence to names in outer `DefMap`s over the extern prelude; only check prelude\n+        // from the crate DefMap.\n+        let from_extern_prelude = match self.block {\n+            Some(_) => PerNs::none(),\n+            None => self\n+                .extern_prelude\n+                .get(name)\n+                .map_or(PerNs::none(), |&it| PerNs::types(it, Visibility::Public)),\n+        };\n+\n         let from_prelude = self.resolve_in_prelude(db, name);\n \n         from_legacy_macro.or(from_scope_or_builtin).or(from_extern_prelude).or(from_prelude)"}, {"sha": "86f937e1d3afd01d6909fead56883d561f9dbdc7", "filename": "crates/hir_ty/src/diagnostics.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c2622c922887368788674d1735a7705fc345a5b9/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2622c922887368788674d1735a7705fc345a5b9/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs?ref=c2622c922887368788674d1735a7705fc345a5b9", "patch": "@@ -705,6 +705,35 @@ fn x(a: S) {\n         )\n     }\n \n+    #[test]\n+    fn import_extern_crate_clash_with_inner_item() {\n+        // This is more of a resolver test, but doesn't really work with the hir_def testsuite.\n+\n+        check_diagnostics(\n+            r#\"\n+//- /lib.rs crate:lib deps:jwt\n+mod permissions;\n+\n+use permissions::jwt;\n+\n+fn f() {\n+    fn inner() {}\n+    jwt::Claims {}; // should resolve to the local one with 0 fields, and not get a diagnostic\n+}\n+\n+//- /permissions.rs\n+pub mod jwt  {\n+    pub struct Claims {}\n+}\n+\n+//- /jwt/lib.rs crate:jwt\n+pub struct Claims {\n+    field: u8,\n+}\n+        \"#,\n+        );\n+    }\n+\n     #[test]\n     fn break_outside_of_loop() {\n         check_diagnostics("}]}