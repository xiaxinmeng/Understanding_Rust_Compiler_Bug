{"sha": "f66769fe8d71d9d5d15f845e6ef918f2e417598f", "node_id": "C_kwDOAAsO6NoAKGY2Njc2OWZlOGQ3MWQ5ZDVkMTVmODQ1ZTZlZjkxOGYyZTQxNzU5OGY", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-09-21T22:43:38Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-09-21T23:12:15Z"}, "message": "rustdoc: dynamically show-hide line numbers on code examples", "tree": {"sha": "af67830725d1d5348c27a406043e16ac6846e4e9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af67830725d1d5348c27a406043e16ac6846e4e9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f66769fe8d71d9d5d15f845e6ef918f2e417598f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f66769fe8d71d9d5d15f845e6ef918f2e417598f", "html_url": "https://github.com/rust-lang/rust/commit/f66769fe8d71d9d5d15f845e6ef918f2e417598f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f66769fe8d71d9d5d15f845e6ef918f2e417598f/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7a718f3be217a17e00de317fba6d1d60facfd613", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a718f3be217a17e00de317fba6d1d60facfd613", "html_url": "https://github.com/rust-lang/rust/commit/7a718f3be217a17e00de317fba6d1d60facfd613"}], "stats": {"total": 65, "additions": 54, "deletions": 11}, "files": [{"sha": "5fbe540c320453d47601ba6de7aea86359671048", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 30, "deletions": 11, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/f66769fe8d71d9d5d15f845e6ef918f2e417598f/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/f66769fe8d71d9d5d15f845e6ef918f2e417598f/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=f66769fe8d71d9d5d15f845e6ef918f2e417598f", "patch": "@@ -697,20 +697,39 @@ function loadCss(cssFileName) {\n         }\n     }());\n \n+    window.rustdoc_add_line_numbers_to_examples = () => {\n+        onEachLazy(document.getElementsByClassName(\"rust-example-rendered\"), x => {\n+            const parent = x.parentNode;\n+            const line_numbers = parent.querySelectorAll(\".line-number\");\n+            if (line_numbers.length > 0) {\n+                return;\n+            }\n+            const count = x.textContent.split(\"\\n\").length;\n+            const elems = [];\n+            for (let i = 0; i < count; ++i) {\n+                elems.push(i + 1);\n+            }\n+            const node = document.createElement(\"pre\");\n+            addClass(node, \"line-number\");\n+            node.innerHTML = elems.join(\"\\n\");\n+            parent.insertBefore(node, x);\n+        });\n+    };\n+\n+    window.rustdoc_remove_line_numbers_from_examples = () => {\n+        onEachLazy(document.getElementsByClassName(\"rust-example-rendered\"), x => {\n+            const parent = x.parentNode;\n+            const line_numbers = parent.querySelectorAll(\".line-number\");\n+            for (const node of line_numbers) {\n+                parent.removeChild(node);\n+            }\n+        });\n+    };\n+\n     (function() {\n         // To avoid checking on \"rustdoc-line-numbers\" value on every loop...\n         if (getSettingValue(\"line-numbers\") === \"true\") {\n-            onEachLazy(document.getElementsByClassName(\"rust-example-rendered\"), x => {\n-                const count = x.textContent.split(\"\\n\").length;\n-                const elems = [];\n-                for (let i = 0; i < count; ++i) {\n-                    elems.push(i + 1);\n-                }\n-                const node = document.createElement(\"pre\");\n-                addClass(node, \"line-number\");\n-                node.innerHTML = elems.join(\"\\n\");\n-                x.parentNode.insertBefore(node, x);\n-            });\n+            window.rustdoc_add_line_numbers_to_examples();\n         }\n     }());\n "}, {"sha": "1c5d33e212754671efa1a0bc6afff4e226b90b9c", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f66769fe8d71d9d5d15f845e6ef918f2e417598f/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/f66769fe8d71d9d5d15f845e6ef918f2e417598f/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=f66769fe8d71d9d5d15f845e6ef918f2e417598f", "patch": "@@ -19,6 +19,13 @@\n                 updateSystemTheme();\n                 updateLightAndDark();\n                 break;\n+            case \"line-numbers\":\n+                if (value === true) {\n+                    window.rustdoc_add_line_numbers_to_examples();\n+                } else {\n+                    window.rustdoc_remove_line_numbers_from_examples();\n+                }\n+                break;\n         }\n     }\n "}, {"sha": "ebfffbce71561ffe3f739c60ec05dbc5f96ce7ff", "filename": "src/test/rustdoc-gui/docblock-code-block-line-number.goml", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/f66769fe8d71d9d5d15f845e6ef918f2e417598f/src%2Ftest%2Frustdoc-gui%2Fdocblock-code-block-line-number.goml", "raw_url": "https://github.com/rust-lang/rust/raw/f66769fe8d71d9d5d15f845e6ef918f2e417598f/src%2Ftest%2Frustdoc-gui%2Fdocblock-code-block-line-number.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fdocblock-code-block-line-number.goml?ref=f66769fe8d71d9d5d15f845e6ef918f2e417598f", "patch": "@@ -20,3 +20,20 @@ assert-css: (\"pre.line-number\", {\n })\n // The first code block has two lines so let's check its `<pre>` elements lists both of them.\n assert-text: (\"pre.line-number\", \"1\\n2\")\n+\n+// Now, try changing the setting dynamically. We'll turn it off, using the settings menu,\n+// and make sure it goes away.\n+\n+// First, open the settings menu.\n+click: \"#settings-menu\"\n+wait-for: \"#settings\"\n+assert-css: (\"#settings\", {\"display\": \"block\"})\n+\n+// Then, click the toggle button.\n+click: \"input#line-numbers + .slider\"\n+wait-for: 100 // wait-for-false does not exist\n+assert-false: \"pre.line-number\"\n+\n+// Finally, turn it on again.\n+click: \"input#line-numbers + .slider\"\n+wait-for: \"pre.line-number\""}]}