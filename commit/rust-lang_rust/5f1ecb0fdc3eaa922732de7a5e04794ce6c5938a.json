{"sha": "5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVmMWVjYjBmZGMzZWFhOTIyNzMyZGU3YTVlMDQ3OTRjZTZjNTkzOGE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-20T19:48:14Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-20T20:59:14Z"}, "message": "Merge branch 'fix_closure_debuginfo' of https://github.com/camlorn/rust into rollup\n\nConflicts:\n\tsrc/librustc_trans/mir/mod.rs", "tree": {"sha": "ebc2ca21942162cf3479e2c54b56821d6ee6aed7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebc2ca21942162cf3479e2c54b56821d6ee6aed7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a", "html_url": "https://github.com/rust-lang/rust/commit/5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b8dda5c7e7fc8fd67c05f67119af7ad2afc1f11", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b8dda5c7e7fc8fd67c05f67119af7ad2afc1f11", "html_url": "https://github.com/rust-lang/rust/commit/6b8dda5c7e7fc8fd67c05f67119af7ad2afc1f11"}, {"sha": "e1d8806efd702ee396992677cd04ab40c329d5d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1d8806efd702ee396992677cd04ab40c329d5d7", "html_url": "https://github.com/rust-lang/rust/commit/e1d8806efd702ee396992677cd04ab40c329d5d7"}], "stats": {"total": 14, "additions": 9, "deletions": 5}, "files": [{"sha": "94dc9a5fdb48946b308d3f29086044b1ec7bb0e1", "filename": "src/librustc_trans/mir/mod.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a/src%2Flibrustc_trans%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a/src%2Flibrustc_trans%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fmir%2Fmod.rs?ref=5f1ecb0fdc3eaa922732de7a5e04794ce6c5938a", "patch": "@@ -10,14 +10,13 @@\n \n use libc::c_uint;\n use llvm::{self, ValueRef};\n-use rustc::ty;\n+use rustc::ty::{self, layout};\n use rustc::mir;\n use rustc::mir::tcx::LvalueTy;\n use session::config::FullDebugInfo;\n use base;\n use common::{self, Block, BlockAndBuilder, CrateContext, FunctionContext, C_null};\n use debuginfo::{self, declare_local, DebugLoc, VariableAccess, VariableKind, FunctionDebugContext};\n-use machine;\n use type_of;\n \n use syntax_pos::{DUMMY_SP, NO_EXPANSION, COMMAND_LINE_EXPN, BytePos};\n@@ -494,10 +493,15 @@ fn arg_local_refs<'bcx, 'tcx>(bcx: &BlockAndBuilder<'bcx, 'tcx>,\n                 llval\n             };\n \n-            let llclosurety = type_of::type_of(bcx.ccx(), closure_ty);\n+            let layout = bcx.ccx().layout_of(closure_ty);\n+            let offsets = match *layout {\n+                layout::Univariant { ref variant, .. } => &variant.offsets[..],\n+                _ => bug!(\"Closures are only supposed to be Univariant\")\n+            };\n+\n             for (i, (decl, ty)) in mir.upvar_decls.iter().zip(upvar_tys).enumerate() {\n-                let byte_offset_of_var_in_env =\n-                    machine::llelement_offset(bcx.ccx(), llclosurety, i);\n+                let byte_offset_of_var_in_env = offsets[i].bytes();\n+\n \n                 let ops = unsafe {\n                     [llvm::LLVMRustDIBuilderCreateOpDeref(),"}]}