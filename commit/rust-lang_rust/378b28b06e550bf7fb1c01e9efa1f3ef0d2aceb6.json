{"sha": "378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3OGIyOGIwNmU1NTBiZjdmYjFjMDFlOWVmYTFmM2VmMGQyYWNlYjY=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2019-04-09T21:00:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-04-09T21:00:51Z"}, "message": "Merge pull request #3495 from scampi/issue-1096\n\nkeep missed comments appearing after the struct/enum ident", "tree": {"sha": "249b24ea7357426e559ebe5467405ea9bbe1bc93", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/249b24ea7357426e559ebe5467405ea9bbe1bc93"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcrQgDCRBK7hj4Ov3rIwAAdHIIAD1EEyXPlgFR27l13Z1CD1x0\nxqPloP6e7n1PdAEmqcob2efT4o51GxELYHLoohrL66EDeY1u+4P+e/psc27p7juC\nHn1sSPUUvzhu9C8mRJUolDbbmtmd0ELLx+aHN3fXGqBwFvmcueDyMFhjKBfTZMqi\nnlOv8XZYwi4sZ+5TWz5Ww7tjULvzQQjbzWYzuPBG04dgMnzlLaKc48+nIJ27nqBz\nlIMbh9yPqXAhhY3gWsXQoFzup57owSDS8qYbV4mZMYT3A7YISvIJmY72sPIDKRih\ngIIcNXhAoT83+mQoHiKJ7qIY9ohByf5cOT558bBbUq15kRp2krDLKDJDkriiVhQ=\n=usJ+\n-----END PGP SIGNATURE-----\n", "payload": "tree 249b24ea7357426e559ebe5467405ea9bbe1bc93\nparent 77924a9e442bfa4d3151a6b67206f31487782458\nparent bf383c4610adbe2da38190185bcb7544410f2fce\nauthor Seiichi Uchida <seuchida@gmail.com> 1554843651 +0900\ncommitter GitHub <noreply@github.com> 1554843651 +0900\n\nMerge pull request #3495 from scampi/issue-1096\n\nkeep missed comments appearing after the struct/enum ident"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "html_url": "https://github.com/rust-lang/rust/commit/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77924a9e442bfa4d3151a6b67206f31487782458", "url": "https://api.github.com/repos/rust-lang/rust/commits/77924a9e442bfa4d3151a6b67206f31487782458", "html_url": "https://github.com/rust-lang/rust/commit/77924a9e442bfa4d3151a6b67206f31487782458"}, {"sha": "bf383c4610adbe2da38190185bcb7544410f2fce", "url": "https://api.github.com/repos/rust-lang/rust/commits/bf383c4610adbe2da38190185bcb7544410f2fce", "html_url": "https://github.com/rust-lang/rust/commit/bf383c4610adbe2da38190185bcb7544410f2fce"}], "stats": {"total": 149, "additions": 124, "deletions": 25}, "files": [{"sha": "a811d4a26ed7d6af697d87daccbb2f7bf7481f83", "filename": "src/comment.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/src%2Fcomment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/src%2Fcomment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomment.rs?ref=378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "patch": "@@ -142,6 +142,11 @@ fn comment_style(orig: &str, normalize_comments: bool) -> CommentStyle<'_> {\n     }\n }\n \n+/// Returns true if the last line of the passed string finishes with a block-comment.\n+pub fn is_last_comment_block(s: &str) -> bool {\n+    s.trim_end().ends_with(\"*/\")\n+}\n+\n /// Combine `prev_str` and `next_str` into a single `String`. `span` may contain\n /// comments between two strings. If there are such comments, then that will be\n /// recovered. If `allow_extend` is true and there is no comment between the two"}, {"sha": "57bded726047e3273131f10a3af5ee232754445b", "filename": "src/items.rs", "status": "modified", "additions": 46, "deletions": 23, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "patch": "@@ -10,8 +10,9 @@ use syntax::visit;\n use syntax::{ast, ptr, symbol};\n \n use crate::comment::{\n-    combine_strs_with_missing_comments, contains_comment, recover_comment_removed,\n-    recover_missing_comment_in_span, rewrite_missing_comment, FindUncommented,\n+    combine_strs_with_missing_comments, contains_comment, is_last_comment_block,\n+    recover_comment_removed, recover_missing_comment_in_span, rewrite_missing_comment,\n+    FindUncommented,\n };\n use crate::config::lists::*;\n use crate::config::{BraceStyle, Config, Density, IndentStyle, Version};\n@@ -1173,11 +1174,7 @@ fn format_unit_struct(\n ) -> Option<String> {\n     let header_str = format_header(context, p.prefix, p.ident, p.vis);\n     let generics_str = if let Some(generics) = p.generics {\n-        let hi = if generics.where_clause.predicates.is_empty() {\n-            generics.span.hi()\n-        } else {\n-            generics.where_clause.span.hi()\n-        };\n+        let hi = context.snippet_provider.span_before(p.span, \";\");\n         format_generics(\n             context,\n             generics,\n@@ -2711,19 +2708,19 @@ fn format_generics(\n     let shape = Shape::legacy(context.budget(used_width + offset.width()), offset);\n     let mut result = rewrite_generics(context, \"\", generics, shape)?;\n \n-    let same_line_brace = if !generics.where_clause.predicates.is_empty() || result.contains('\\n') {\n+    // If the generics are not parameterized then generics.span.hi() == 0,\n+    // so we use span.lo(), which is the position after `struct Foo`.\n+    let span_end_before_where = if !generics.params.is_empty() {\n+        generics.span.hi()\n+    } else {\n+        span.lo()\n+    };\n+    let (same_line_brace, missed_comments) = if !generics.where_clause.predicates.is_empty() {\n         let budget = context.budget(last_line_used_width(&result, offset.width()));\n         let mut option = WhereClauseOption::snuggled(&result);\n         if brace_pos == BracePos::None {\n             option.suppress_comma = true;\n         }\n-        // If the generics are not parameterized then generics.span.hi() == 0,\n-        // so we use span.lo(), which is the position after `struct Foo`.\n-        let span_end_before_where = if !generics.params.is_empty() {\n-            generics.span.hi()\n-        } else {\n-            span.lo()\n-        };\n         let where_clause_str = rewrite_where_clause(\n             context,\n             &generics.where_clause,\n@@ -2737,15 +2734,41 @@ fn format_generics(\n             false,\n         )?;\n         result.push_str(&where_clause_str);\n-        brace_pos == BracePos::ForceSameLine\n-            || brace_style == BraceStyle::PreferSameLine\n-            || (generics.where_clause.predicates.is_empty()\n-                && trimmed_last_line_width(&result) == 1)\n+        (\n+            brace_pos == BracePos::ForceSameLine || brace_style == BraceStyle::PreferSameLine,\n+            // missed comments are taken care of in #rewrite_where_clause\n+            None,\n+        )\n     } else {\n-        brace_pos == BracePos::ForceSameLine\n-            || trimmed_last_line_width(&result) == 1\n-            || brace_style != BraceStyle::AlwaysNextLine\n+        (\n+            brace_pos == BracePos::ForceSameLine\n+                || (result.contains('\\n') && brace_style == BraceStyle::PreferSameLine\n+                    || brace_style != BraceStyle::AlwaysNextLine)\n+                || trimmed_last_line_width(&result) == 1,\n+            rewrite_missing_comment(\n+                mk_sp(\n+                    span_end_before_where,\n+                    if brace_pos == BracePos::None {\n+                        span.hi()\n+                    } else {\n+                        context.snippet_provider.span_before(span, \"{\")\n+                    },\n+                ),\n+                shape,\n+                context,\n+            ),\n+        )\n     };\n+    // add missing comments\n+    let missed_line_comments = missed_comments\n+        .filter(|missed_comments| !missed_comments.is_empty())\n+        .map_or(false, |missed_comments| {\n+            let is_block = is_last_comment_block(&missed_comments);\n+            let sep = if is_block { \" \" } else { \"\\n\" };\n+            result.push_str(sep);\n+            result.push_str(&missed_comments);\n+            !is_block\n+        });\n     if brace_pos == BracePos::None {\n         return Some(result);\n     }\n@@ -2761,7 +2784,7 @@ fn format_generics(\n         // 2 = ` {`\n         2\n     };\n-    let forbid_same_line_brace = overhead > remaining_budget;\n+    let forbid_same_line_brace = missed_line_comments || overhead > remaining_budget;\n     if !forbid_same_line_brace && same_line_brace {\n         result.push(' ');\n     } else {"}, {"sha": "0f459571d422e3d4ebc6a0b30e9f4b45d54dda8e", "filename": "src/missed_spans.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/src%2Fmissed_spans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/src%2Fmissed_spans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmissed_spans.rs?ref=378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "patch": "@@ -2,7 +2,7 @@ use std::borrow::Cow;\n \n use syntax::source_map::{BytePos, Pos, Span};\n \n-use crate::comment::{rewrite_comment, CodeCharKind, CommentCodeSlices};\n+use crate::comment::{is_last_comment_block, rewrite_comment, CodeCharKind, CommentCodeSlices};\n use crate::config::file_lines::FileLines;\n use crate::config::{EmitMode, FileName};\n use crate::shape::{Indent, Shape};\n@@ -288,7 +288,7 @@ impl<'a> FmtVisitor<'a> {\n                 .next()\n             {\n                 Some('\\n') | Some('\\r') => {\n-                    if !subslice.trim_end().ends_with(\"*/\") {\n+                    if !is_last_comment_block(subslice) {\n                         self.push_str(\"\\n\");\n                     }\n                 }"}, {"sha": "de78e736483f5a4574f891b0498d28bce3711f14", "filename": "tests/target/issue-1096.rs", "status": "added", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/tests%2Ftarget%2Fissue-1096.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6/tests%2Ftarget%2Fissue-1096.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-1096.rs?ref=378b28b06e550bf7fb1c01e9efa1f3ef0d2aceb6", "patch": "@@ -0,0 +1,71 @@\n+struct StructA<T> /* comment 1 */ {\n+    t: T,\n+}\n+\n+struct StructB<T> /* comment 2 */;\n+\n+struct StructC /* comment 3 */;\n+\n+struct StructD /* comment 4 */ {\n+    t: usize,\n+}\n+\n+struct StructE<T>\n+/* comment 5 */\n+where\n+    T: Clone,\n+{\n+    t: usize,\n+}\n+\n+struct StructF\n+/* comment 6 */\n+where\n+    T: Clone,\n+{\n+    t: usize,\n+}\n+\n+struct StructG<T>\n+/* comment 7 */\n+// why a line comment??\n+{\n+    t: T,\n+}\n+\n+struct StructH<T>\n+/* comment 8 */\n+// why a line comment??\n+where\n+    T: Clone,\n+{\n+    t: T,\n+}\n+\n+enum EnumA<T> /* comment 8 */ {\n+    Field(T),\n+}\n+\n+enum EnumB /* comment 9 */ {\n+    Field,\n+}\n+\n+// Issue 2781\n+struct StructX1<T>\n+// where\n+//     T: Clone\n+{\n+    inner: String,\n+}\n+\n+struct StructX2<\n+    T,\n+    U: Iterator<Item = String>,\n+    V: Iterator<Item = String>,\n+    W: Iterator<Item = String>,\n+>\n+// where\n+//     T: Clone\n+{\n+    inner: String,\n+}"}]}