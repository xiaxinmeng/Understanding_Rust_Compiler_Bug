{"sha": "3b4234a175347a6d9d555ac0ee56212b1296c8b7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiNDIzNGExNzUzNDdhNmQ5ZDU1NWFjMGVlNTYyMTJiMTI5NmM4Yjc=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-05-14T20:00:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-05-14T20:00:16Z"}, "message": "Rollup merge of #60719 - varkor:xpy-test-folder, r=Mark-Simulacrum\n\nAllow subdirectories to be tested by x.py test\n\nFixes https://github.com/rust-lang/rust/issues/60718.\n\nAs far as I can tell, multiple `--test-args` flags are ignored (only the first is respected), so if you specify a subdirectory, you won't also be able to filter using `--test-args`. If you don't specify a subdirectory, `--test-args` will continue working as usual, so this is strictly an improvement on the current state of affairs.", "tree": {"sha": "b5a167d4c590c8d989da3a8b77af256b0ab81264", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b5a167d4c590c8d989da3a8b77af256b0ab81264"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3b4234a175347a6d9d555ac0ee56212b1296c8b7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJc2x5QCRBK7hj4Ov3rIwAAdHIIAKFzhjwp26cYH7XrAmwVlo0D\nNEIvHWKrAt9qfVzP1LzgP10ThQSAngenYyPclSWQ+yw2dLgVsb0rXvf8TpqTBy5r\nIM5HwYa5oHMKo64CrWZseD4TP+o/epudzIkMW2vW0c001a7rh8pZGhykNrwJkxLQ\nV0OOkPw1AiE13pIwC/2aibFuEffycesDNzg7J5jPBKcUVE2y+IRIZryDLgJ4go6i\njcEzhJBjhLjBgx1PTO5qo9ZZNk7SgSiMbnFG3BJTOEWfm8NbqAP/1TSawbM07e5s\njSmjI9l6/UAKspjA3mcAxyU/NjQWL9DmqoRIckFEj87PDt7IPAwrgM+vFaYGcHY=\n=ehnn\n-----END PGP SIGNATURE-----\n", "payload": "tree b5a167d4c590c8d989da3a8b77af256b0ab81264\nparent b4c340e4bb246572029d235e46850faa9823d312\nparent b470d48c8a58a6cd91a14e5ba6387f424da6c5db\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1557864016 +0200\ncommitter GitHub <noreply@github.com> 1557864016 +0200\n\nRollup merge of #60719 - varkor:xpy-test-folder, r=Mark-Simulacrum\n\nAllow subdirectories to be tested by x.py test\n\nFixes https://github.com/rust-lang/rust/issues/60718.\n\nAs far as I can tell, multiple `--test-args` flags are ignored (only the first is respected), so if you specify a subdirectory, you won't also be able to filter using `--test-args`. If you don't specify a subdirectory, `--test-args` will continue working as usual, so this is strictly an improvement on the current state of affairs.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3b4234a175347a6d9d555ac0ee56212b1296c8b7", "html_url": "https://github.com/rust-lang/rust/commit/3b4234a175347a6d9d555ac0ee56212b1296c8b7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3b4234a175347a6d9d555ac0ee56212b1296c8b7/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b4c340e4bb246572029d235e46850faa9823d312", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4c340e4bb246572029d235e46850faa9823d312", "html_url": "https://github.com/rust-lang/rust/commit/b4c340e4bb246572029d235e46850faa9823d312"}, {"sha": "b470d48c8a58a6cd91a14e5ba6387f424da6c5db", "url": "https://api.github.com/repos/rust-lang/rust/commits/b470d48c8a58a6cd91a14e5ba6387f424da6c5db", "html_url": "https://github.com/rust-lang/rust/commit/b470d48c8a58a6cd91a14e5ba6387f424da6c5db"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "7826ac9471806043c1b00505e13cbe9ffab424c6", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3b4234a175347a6d9d555ac0ee56212b1296c8b7/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b4234a175347a6d9d555ac0ee56212b1296c8b7/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=3b4234a175347a6d9d555ac0ee56212b1296c8b7", "patch": "@@ -1184,8 +1184,19 @@ impl Step for Compiletest {\n                     Err(_) => p,\n                 }\n             })\n-            .filter(|p| p.starts_with(suite_path) && p.is_file())\n-            .map(|p| p.strip_prefix(suite_path).unwrap().to_str().unwrap())\n+            .filter(|p| p.starts_with(suite_path) && (p.is_dir() || p.is_file()))\n+            .filter_map(|p| {\n+                // Since test suite paths are themselves directories, if we don't\n+                // specify a directory or file, we'll get an empty string here\n+                // (the result of the test suite directory without its suite prefix).\n+                // Therefore, we need to filter these out, as only the first --test-args\n+                // flag is respected, so providing an empty --test-args conflicts with\n+                // any following it.\n+                match p.strip_prefix(suite_path).ok().and_then(|p| p.to_str()) {\n+                    Some(s) if s != \"\" => Some(s),\n+                    _ => None,\n+                }\n+            })\n             .collect();\n \n         test_args.append(&mut builder.config.cmd.test_args());"}]}