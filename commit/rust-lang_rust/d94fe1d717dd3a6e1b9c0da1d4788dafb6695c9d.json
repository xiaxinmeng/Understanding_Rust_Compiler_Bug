{"sha": "d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5NGZlMWQ3MTdkZDNhNmUxYjljMGRhMWQ0Nzg4ZGFmYjY2OTVjOWQ=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2018-12-20T13:57:21Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2018-12-20T13:57:34Z"}, "message": "Fix calling drop_in_place_real with empty drop glue\n\nfixes #209", "tree": {"sha": "b1bae770d803f68b0a3459726e8125f9d9cfc1b0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1bae770d803f68b0a3459726e8125f9d9cfc1b0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d", "html_url": "https://github.com/rust-lang/rust/commit/d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "43a68c33fecc4a1248c84d2f8d21a1735ce7a47f", "url": "https://api.github.com/repos/rust-lang/rust/commits/43a68c33fecc4a1248c84d2f8d21a1735ce7a47f", "html_url": "https://github.com/rust-lang/rust/commit/43a68c33fecc4a1248c84d2f8d21a1735ce7a47f"}], "stats": {"total": 25, "additions": 20, "deletions": 5}, "files": [{"sha": "d07067930812d5739bccf1e8315e263f8b2ae84a", "filename": "src/abi.rs", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d/src%2Fabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d/src%2Fabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fabi.rs?ref=d94fe1d717dd3a6e1b9c0da1d4788dafb6695c9d", "patch": "@@ -484,11 +484,26 @@ pub fn codegen_terminator_call<'a, 'tcx: 'a>(\n         .map(|&(ref place, bb)| (trans_place(fx, place), bb));\n \n     if let ty::FnDef(def_id, substs) = fn_ty.sty {\n-        let sig = ty_fn_sig(fx.tcx, fn_ty);\n-\n-        if sig.abi == Abi::RustIntrinsic {\n-            crate::intrinsics::codegen_intrinsic_call(fx, def_id, substs, args, destination);\n-            return;\n+        let instance = ty::Instance::resolve(\n+            fx.tcx,\n+            ty::ParamEnv::reveal_all(),\n+            def_id,\n+            substs,\n+        ).unwrap();\n+\n+        match instance.def {\n+            InstanceDef::Intrinsic(_) => {\n+                crate::intrinsics::codegen_intrinsic_call(fx, def_id, substs, args, destination);\n+                return;\n+            }\n+            InstanceDef::DropGlue(_, None) => {\n+                // empty drop glue - a nop.\n+                let (_, dest) = destination.expect(\"Non terminating drop_in_place_real???\");\n+                let ret_ebb = fx.get_ebb(dest);\n+                fx.bcx.ins().jump(ret_ebb, &[]);\n+                return;\n+            }\n+            _ => {}\n         }\n     }\n "}]}