{"sha": "cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "node_id": "C_kwDOAAsO6NoAKGNkNDJiMjBjZTM2YWRjOGMyYmVkYThkOGU4NmE5MWI0NzljZDE4MmY", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-07-02T14:15:13Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-07-02T14:20:26Z"}, "message": "fix: Trigger flyimport completions in item lists again", "tree": {"sha": "f31243850369ebb913ce5d82addbeda4ca5a2209", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f31243850369ebb913ce5d82addbeda4ca5a2209"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "html_url": "https://github.com/rust-lang/rust/commit/cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd42b20ce36adc8c2beda8d8e86a91b479cd182f/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed44fe52e4a730e4f892cde094fbba8ae8621589", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed44fe52e4a730e4f892cde094fbba8ae8621589", "html_url": "https://github.com/rust-lang/rust/commit/ed44fe52e4a730e4f892cde094fbba8ae8621589"}], "stats": {"total": 32, "additions": 28, "deletions": 4}, "files": [{"sha": "1c62347fb5b5dfb28f9b811c0df78a6440ce5d41", "filename": "crates/ide-completion/src/completions/flyimport.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cd42b20ce36adc8c2beda8d8e86a91b479cd182f/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd42b20ce36adc8c2beda8d8e86a91b479cd182f/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fflyimport.rs?ref=cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "patch": "@@ -5,7 +5,10 @@ use ide_db::imports::{\n     insert_use::ImportScope,\n };\n use itertools::Itertools;\n-use syntax::{ast, AstNode, SyntaxNode, T};\n+use syntax::{\n+    ast::{self},\n+    AstNode, SyntaxNode, T,\n+};\n \n use crate::{\n     context::{\n@@ -123,6 +126,7 @@ pub(crate) fn import_on_the_fly_path(\n                 | PathKind::Type { .. }\n                 | PathKind::Attr { .. }\n                 | PathKind::Derive { .. }\n+                | PathKind::Item { .. }\n                 | PathKind::Pat { .. },\n             qualified,\n             ..\n@@ -161,7 +165,7 @@ pub(crate) fn import_on_the_fly_pat(\n     let potential_import_name = import_name(ctx);\n     let import_assets = import_assets_for_path(ctx, &potential_import_name, None)?;\n \n-    import_on_the_fly_pat2(\n+    import_on_the_fly_pat_(\n         acc,\n         ctx,\n         pattern_ctx,\n@@ -227,7 +231,7 @@ fn import_on_the_fly(\n                 | PathKind::Pat { .. },\n                 ItemInNs::Macros(mac),\n             ) => mac.is_fn_like(ctx.db),\n-            (PathKind::Item { .. }, _) => true,\n+            (PathKind::Item { .. }, ..) => false,\n \n             (PathKind::Expr { .. }, ItemInNs::Types(_) | ItemInNs::Values(_)) => true,\n \n@@ -279,7 +283,7 @@ fn import_on_the_fly(\n     Some(())\n }\n \n-fn import_on_the_fly_pat2(\n+fn import_on_the_fly_pat_(\n     acc: &mut Completions,\n     ctx: &CompletionContext,\n     pattern_ctx: &PatternContext,"}, {"sha": "0bba7f2459cafae4a0e246586c0af6c278e09e9b", "filename": "crates/ide-completion/src/tests/flyimport.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/cd42b20ce36adc8c2beda8d8e86a91b479cd182f/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd42b20ce36adc8c2beda8d8e86a91b479cd182f/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "patch": "@@ -1210,3 +1210,23 @@ fn f<T>() where T: Comp$0\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn flyimport_source_file() {\n+    check(\n+        r#\"\n+//- /main.rs crate:main deps:dep\n+def$0\n+//- /lib.rs crate:dep\n+#[macro_export]\n+macro_rules! define_struct {\n+    () => {\n+        pub struct Foo;\n+    };\n+}\n+\"#,\n+        expect![[r#\"\n+            ma define_struct!(\u2026) (use dep::define_struct) macro_rules! define_struct\n+        \"#]],\n+    );\n+}"}]}