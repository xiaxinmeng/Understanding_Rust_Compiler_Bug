{"sha": "075996efd788613af0e19c0a241a81b1584b4cd1", "node_id": "C_kwDOAAsO6NoAKDA3NTk5NmVmZDc4ODYxM2FmMGUxOWMwYTI0MWE4MWIxNTg0YjRjZDE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-26T08:11:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-26T08:11:49Z"}, "message": "Auto merge of #7878 - rust-lang:string-slice, r=giraffate\n\nnew lint: string-slice\n\nThis is a restriction lint to highlight code that should have tests containing non-ascii characters. See #6623.\n\nchangelog: new lint: [`string-slice`]", "tree": {"sha": "a867ad36cdfee53ce0fc550f2c346cfb210fac42", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a867ad36cdfee53ce0fc550f2c346cfb210fac42"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/075996efd788613af0e19c0a241a81b1584b4cd1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/075996efd788613af0e19c0a241a81b1584b4cd1", "html_url": "https://github.com/rust-lang/rust/commit/075996efd788613af0e19c0a241a81b1584b4cd1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/075996efd788613af0e19c0a241a81b1584b4cd1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb0132d2090ec77f5a29c0551b07ac698a0a9eac", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb0132d2090ec77f5a29c0551b07ac698a0a9eac", "html_url": "https://github.com/rust-lang/rust/commit/cb0132d2090ec77f5a29c0551b07ac698a0a9eac"}, {"sha": "999b3004c499e96e62d677d79fab47c5c514636a", "url": "https://api.github.com/repos/rust-lang/rust/commits/999b3004c499e96e62d677d79fab47c5c514636a", "html_url": "https://github.com/rust-lang/rust/commit/999b3004c499e96e62d677d79fab47c5c514636a"}], "stats": {"total": 141, "additions": 106, "deletions": 35}, "files": [{"sha": "e2b0069279bc6b1f209be0fdad767b0575485577", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/075996efd788613af0e19c0a241a81b1584b4cd1/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/075996efd788613af0e19c0a241a81b1584b4cd1/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=075996efd788613af0e19c0a241a81b1584b4cd1", "patch": "@@ -3147,6 +3147,7 @@ Released 2018-09-13\n [`string_extend_chars`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_extend_chars\n [`string_from_utf8_as_bytes`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_from_utf8_as_bytes\n [`string_lit_as_bytes`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_lit_as_bytes\n+[`string_slice`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_slice\n [`string_to_string`]: https://rust-lang.github.io/rust-clippy/master/index.html#string_to_string\n [`strlen_on_c_strings`]: https://rust-lang.github.io/rust-clippy/master/index.html#strlen_on_c_strings\n [`struct_excessive_bools`]: https://rust-lang.github.io/rust-clippy/master/index.html#struct_excessive_bools"}, {"sha": "ff0a0f973976a9b7327d6331d29d04a227160bfb", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/075996efd788613af0e19c0a241a81b1584b4cd1/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/075996efd788613af0e19c0a241a81b1584b4cd1/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=075996efd788613af0e19c0a241a81b1584b4cd1", "patch": "@@ -431,6 +431,7 @@ store.register_lints(&[\n     strings::STRING_ADD_ASSIGN,\n     strings::STRING_FROM_UTF8_AS_BYTES,\n     strings::STRING_LIT_AS_BYTES,\n+    strings::STRING_SLICE,\n     strings::STRING_TO_STRING,\n     strings::STR_TO_STRING,\n     strlen_on_c_strings::STRLEN_ON_C_STRINGS,"}, {"sha": "4929bbecde090c72ac28c288d8d77bbb92e69213", "filename": "clippy_lints/src/lib.register_restriction.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/075996efd788613af0e19c0a241a81b1584b4cd1/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/075996efd788613af0e19c0a241a81b1584b4cd1/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_restriction.rs?ref=075996efd788613af0e19c0a241a81b1584b4cd1", "patch": "@@ -53,6 +53,7 @@ store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), ve\n     LintId::of(shadow::SHADOW_SAME),\n     LintId::of(shadow::SHADOW_UNRELATED),\n     LintId::of(strings::STRING_ADD),\n+    LintId::of(strings::STRING_SLICE),\n     LintId::of(strings::STRING_TO_STRING),\n     LintId::of(strings::STR_TO_STRING),\n     LintId::of(types::RC_BUFFER),"}, {"sha": "6435107b8b4643f02f94078b7fe0c70802458d56", "filename": "clippy_lints/src/strings.rs", "status": "modified", "additions": 71, "deletions": 35, "changes": 106, "blob_url": "https://github.com/rust-lang/rust/blob/075996efd788613af0e19c0a241a81b1584b4cd1/clippy_lints%2Fsrc%2Fstrings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/075996efd788613af0e19c0a241a81b1584b4cd1/clippy_lints%2Fsrc%2Fstrings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fstrings.rs?ref=075996efd788613af0e19c0a241a81b1584b4cd1", "patch": "@@ -107,51 +107,87 @@ declare_clippy_lint! {\n     \"calling `as_bytes` on a string literal instead of using a byte string literal\"\n }\n \n-declare_lint_pass!(StringAdd => [STRING_ADD, STRING_ADD_ASSIGN]);\n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for slice operations on strings\n+    ///\n+    /// ### Why is this bad?\n+    /// UTF-8 characters span multiple bytes, and it is easy to inadvertently confuse character\n+    /// counts and string indices. This may lead to panics, and should warrant some test cases\n+    /// containing wide UTF-8 characters. This lint is most useful in code that should avoid\n+    /// panics at all costs.\n+    ///\n+    /// ### Known problems\n+    /// Probably lots of false positives. If an index comes from a known valid position (e.g.\n+    /// obtained via `char_indices` over the same string), it is totally OK.\n+    ///\n+    /// # Example\n+    /// ```rust,should_panic\n+    /// &\"\u00d6lkanne\"[1..];\n+    /// ```\n+    pub STRING_SLICE,\n+    restriction,\n+    \"slicing a string\"\n+}\n+\n+declare_lint_pass!(StringAdd => [STRING_ADD, STRING_ADD_ASSIGN, STRING_SLICE]);\n \n impl<'tcx> LateLintPass<'tcx> for StringAdd {\n     fn check_expr(&mut self, cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) {\n         if in_external_macro(cx.sess(), e.span) {\n             return;\n         }\n-\n-        if let ExprKind::Binary(\n-            Spanned {\n-                node: BinOpKind::Add, ..\n-            },\n-            left,\n-            _,\n-        ) = e.kind\n-        {\n-            if is_string(cx, left) {\n-                if !is_lint_allowed(cx, STRING_ADD_ASSIGN, e.hir_id) {\n-                    let parent = get_parent_expr(cx, e);\n-                    if let Some(p) = parent {\n-                        if let ExprKind::Assign(target, _, _) = p.kind {\n-                            // avoid duplicate matches\n-                            if SpanlessEq::new(cx).eq_expr(target, left) {\n-                                return;\n+        match e.kind {\n+            ExprKind::Binary(\n+                Spanned {\n+                    node: BinOpKind::Add, ..\n+                },\n+                left,\n+                _,\n+            ) => {\n+                if is_string(cx, left) {\n+                    if !is_lint_allowed(cx, STRING_ADD_ASSIGN, e.hir_id) {\n+                        let parent = get_parent_expr(cx, e);\n+                        if let Some(p) = parent {\n+                            if let ExprKind::Assign(target, _, _) = p.kind {\n+                                // avoid duplicate matches\n+                                if SpanlessEq::new(cx).eq_expr(target, left) {\n+                                    return;\n+                                }\n                             }\n                         }\n                     }\n+                    span_lint(\n+                        cx,\n+                        STRING_ADD,\n+                        e.span,\n+                        \"you added something to a string. Consider using `String::push_str()` instead\",\n+                    );\n                 }\n-                span_lint(\n-                    cx,\n-                    STRING_ADD,\n-                    e.span,\n-                    \"you added something to a string. Consider using `String::push_str()` instead\",\n-                );\n-            }\n-        } else if let ExprKind::Assign(target, src, _) = e.kind {\n-            if is_string(cx, target) && is_add(cx, src, target) {\n-                span_lint(\n-                    cx,\n-                    STRING_ADD_ASSIGN,\n-                    e.span,\n-                    \"you assigned the result of adding something to this string. Consider using \\\n-                     `String::push_str()` instead\",\n-                );\n-            }\n+            },\n+            ExprKind::Assign(target, src, _) => {\n+                if is_string(cx, target) && is_add(cx, src, target) {\n+                    span_lint(\n+                        cx,\n+                        STRING_ADD_ASSIGN,\n+                        e.span,\n+                        \"you assigned the result of adding something to this string. Consider using \\\n+                         `String::push_str()` instead\",\n+                    );\n+                }\n+            },\n+            ExprKind::Index(target, _idx) => {\n+                let e_ty = cx.typeck_results().expr_ty(target).peel_refs();\n+                if matches!(e_ty.kind(), ty::Str) || is_type_diagnostic_item(cx, e_ty, sym::String) {\n+                    span_lint(\n+                        cx,\n+                        STRING_SLICE,\n+                        e.span,\n+                        \"indexing into a string may panic if the index is within a UTF-8 character\",\n+                    );\n+                }\n+            },\n+            _ => {},\n         }\n     }\n }"}, {"sha": "be4dfc8816c7f178091a88305c3fa162ee261a78", "filename": "tests/ui/string_slice.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/075996efd788613af0e19c0a241a81b1584b4cd1/tests%2Fui%2Fstring_slice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/075996efd788613af0e19c0a241a81b1584b4cd1/tests%2Fui%2Fstring_slice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_slice.rs?ref=075996efd788613af0e19c0a241a81b1584b4cd1", "patch": "@@ -0,0 +1,10 @@\n+#[warn(clippy::string_slice)]\n+#[allow(clippy::no_effect)]\n+\n+fn main() {\n+    &\"\u00d6lkanne\"[1..];\n+    let m = \"M\u00f6t\u00f6rhead\";\n+    &m[2..5];\n+    let s = String::from(m);\n+    &s[0..2];\n+}"}, {"sha": "55040bf5df2de6d3689f825132ee06e3798dcf3f", "filename": "tests/ui/string_slice.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/075996efd788613af0e19c0a241a81b1584b4cd1/tests%2Fui%2Fstring_slice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/075996efd788613af0e19c0a241a81b1584b4cd1/tests%2Fui%2Fstring_slice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_slice.stderr?ref=075996efd788613af0e19c0a241a81b1584b4cd1", "patch": "@@ -0,0 +1,22 @@\n+error: indexing into a string may panic if the index is within a UTF-8 character\n+  --> $DIR/string_slice.rs:5:6\n+   |\n+LL |     &\"\u00d6lkanne\"[1..];\n+   |      ^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::string-slice` implied by `-D warnings`\n+\n+error: indexing into a string may panic if the index is within a UTF-8 character\n+  --> $DIR/string_slice.rs:7:6\n+   |\n+LL |     &m[2..5];\n+   |      ^^^^^^^\n+\n+error: indexing into a string may panic if the index is within a UTF-8 character\n+  --> $DIR/string_slice.rs:9:6\n+   |\n+LL |     &s[0..2];\n+   |      ^^^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}]}