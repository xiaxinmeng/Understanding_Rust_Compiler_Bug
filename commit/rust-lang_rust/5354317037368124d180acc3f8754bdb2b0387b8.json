{"sha": "5354317037368124d180acc3f8754bdb2b0387b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzNTQzMTcwMzczNjgxMjRkMTgwYWNjM2Y4NzU0YmRiMmIwMzg3Yjg=", "commit": {"author": {"name": "Keegan McAllister", "email": "kmcallister@mozilla.com", "date": "2015-02-09T17:29:21Z"}, "committer": {"name": "Keegan McAllister", "email": "kmcallister@mozilla.com", "date": "2015-02-09T18:12:14Z"}, "message": "Process cfg_attr right before stripping cfg\n\nFixes #22070.\nFixes #19372.", "tree": {"sha": "e6513baa81e9707e06814054a44f919de5ec64d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e6513baa81e9707e06814054a44f919de5ec64d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5354317037368124d180acc3f8754bdb2b0387b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5354317037368124d180acc3f8754bdb2b0387b8", "html_url": "https://github.com/rust-lang/rust/commit/5354317037368124d180acc3f8754bdb2b0387b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5354317037368124d180acc3f8754bdb2b0387b8/comments", "author": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0110f5e03c67d7a3590c7c86f50f5546d75f27b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/0110f5e03c67d7a3590c7c86f50f5546d75f27b1", "html_url": "https://github.com/rust-lang/rust/commit/0110f5e03c67d7a3590c7c86f50f5546d75f27b1"}], "stats": {"total": 151, "additions": 113, "deletions": 38}, "files": [{"sha": "7ca0591be5064e9e78745463dcdc29f4b1ac5aa7", "filename": "src/libsyntax/config.rs", "status": "modified", "additions": 48, "deletions": 1, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Flibsyntax%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Flibsyntax%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fconfig.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -12,7 +12,7 @@ use attr::AttrMetaMethods;\n use diagnostic::SpanHandler;\n use fold::Folder;\n use {ast, fold, attr};\n-use codemap::Spanned;\n+use codemap::{Spanned, respan};\n use ptr::P;\n \n use util::small_vector::SmallVector;\n@@ -26,6 +26,7 @@ struct Context<F> where F: FnMut(&[ast::Attribute]) -> bool {\n // Support conditional compilation by transforming the AST, stripping out\n // any items that do not belong in the current configuration\n pub fn strip_unconfigured_items(diagnostic: &SpanHandler, krate: ast::Crate) -> ast::Crate {\n+    let krate = process_cfg_attr(diagnostic, krate);\n     let config = krate.config.clone();\n     strip_items(krate, |attrs| in_cfg(diagnostic, &config, attrs))\n }\n@@ -281,3 +282,49 @@ fn in_cfg(diagnostic: &SpanHandler, cfg: &[P<ast::MetaItem>], attrs: &[ast::Attr\n         attr::cfg_matches(diagnostic, cfg, &*mis[0])\n     })\n }\n+\n+struct CfgAttrFolder<'a> {\n+    diag: &'a SpanHandler,\n+    config: ast::CrateConfig,\n+}\n+\n+// Process `#[cfg_attr]`.\n+fn process_cfg_attr(diagnostic: &SpanHandler, krate: ast::Crate) -> ast::Crate {\n+    let mut fld = CfgAttrFolder {\n+        diag: diagnostic,\n+        config: krate.config.clone(),\n+    };\n+    fld.fold_crate(krate)\n+}\n+\n+impl<'a> fold::Folder for CfgAttrFolder<'a> {\n+    fn fold_attribute(&mut self, attr: ast::Attribute) -> Option<ast::Attribute> {\n+        if !attr.check_name(\"cfg_attr\") {\n+            return fold::noop_fold_attribute(attr, self);\n+        }\n+\n+        let (cfg, mi) = match attr.meta_item_list() {\n+            Some([ref cfg, ref mi]) => (cfg, mi),\n+            _ => {\n+                self.diag.span_err(attr.span, \"expected `#[cfg_attr(<cfg pattern>, <attr>)]`\");\n+                return None;\n+            }\n+        };\n+\n+        if attr::cfg_matches(self.diag, &self.config[], &cfg) {\n+            Some(respan(mi.span, ast::Attribute_ {\n+                id: attr::mk_attr_id(),\n+                style: attr.node.style,\n+                value: mi.clone(),\n+                is_sugared_doc: false,\n+            }))\n+        } else {\n+            None\n+        }\n+    }\n+\n+    // Need the ability to run pre-expansion.\n+    fn fold_mac(&mut self, mac: ast::Mac) -> ast::Mac {\n+        fold::noop_fold_mac(mac, self)\n+    }\n+}"}, {"sha": "64ae6162ef4e56060ffd95e56c3a30fec5b607c7", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -528,8 +528,6 @@ fn initial_syntax_expander_table(ecfg: &expand::ExpansionConfig) -> SyntaxEnv {\n     syntax_expanders.insert(intern(\"cfg\"),\n                             builtin_normal_expander(\n                                     ext::cfg::expand_cfg));\n-    syntax_expanders.insert(intern(\"cfg_attr\"),\n-                            Modifier(box ext::cfg_attr::expand));\n     syntax_expanders.insert(intern(\"trace_macros\"),\n                             builtin_normal_expander(\n                                     ext::trace_macros::expand_trace_macros));"}, {"sha": "72eaa3e47bec6cda739043cacdd1c9b6e2a8c709", "filename": "src/libsyntax/ext/cfg_attr.rs", "status": "removed", "additions": 0, "deletions": 34, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/0110f5e03c67d7a3590c7c86f50f5546d75f27b1/src%2Flibsyntax%2Fext%2Fcfg_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0110f5e03c67d7a3590c7c86f50f5546d75f27b1/src%2Flibsyntax%2Fext%2Fcfg_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fcfg_attr.rs?ref=0110f5e03c67d7a3590c7c86f50f5546d75f27b1", "patch": "@@ -1,34 +0,0 @@\n-// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-use ast;\n-use attr;\n-use codemap::Span;\n-use ext::base::ExtCtxt;\n-use ext::build::AstBuilder;\n-use ptr::P;\n-\n-pub fn expand(cx: &mut ExtCtxt, sp: Span, mi: &ast::MetaItem, it: P<ast::Item>) -> P<ast::Item> {\n-    let (cfg, attr) = match mi.node {\n-        ast::MetaList(_, ref mis) if mis.len() == 2 => (&mis[0], &mis[1]),\n-        _ => {\n-            cx.span_err(sp, \"expected `#[cfg_attr(<cfg pattern>, <attr>)]`\");\n-            return it;\n-        }\n-    };\n-\n-    let mut out = (*it).clone();\n-    if attr::cfg_matches(&cx.parse_sess.span_diagnostic, &cx.cfg, &**cfg) {\n-        out.attrs.push(cx.attribute(attr.span, attr.clone()));\n-    }\n-\n-    P(out)\n-}\n-"}, {"sha": "41850ada3e62b3aaec5961b5fdfd77a0fa789648", "filename": "src/libsyntax/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Flibsyntax%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Flibsyntax%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Flib.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -96,7 +96,6 @@ pub mod ext {\n     pub mod base;\n     pub mod build;\n     pub mod cfg;\n-    pub mod cfg_attr;\n     pub mod concat;\n     pub mod concat_idents;\n     pub mod deriving;"}, {"sha": "b71a3be5dcea4ec5630f4877b5e9a8765dfca03c", "filename": "src/test/compile-fail/cfg-attr-cfg-2.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Fcompile-fail%2Fcfg-attr-cfg-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Fcompile-fail%2Fcfg-attr-cfg-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcfg-attr-cfg-2.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+//\n+// error-pattern: main function not found\n+// compile-flags: --cfg foo\n+\n+// main is conditionally compiled, but the conditional compilation\n+// is conditional too!\n+\n+#[cfg_attr(foo, cfg(bar))]\n+fn main() { }"}, {"sha": "4867dd8d0b4abac1e8238265c98e8f3cbb9ceae5", "filename": "src/test/compile-fail/cfg-attr-crate-2.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Fcompile-fail%2Fcfg-attr-crate-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Fcompile-fail%2Fcfg-attr-crate-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcfg-attr-crate-2.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+//\n+// compile-flags: --cfg broken\n+\n+// https://github.com/rust-lang/rust/issues/21833#issuecomment-72353044\n+\n+#![cfg_attr(broken, no_std)] //~ ERROR no_std is experimental\n+\n+fn main() { }"}, {"sha": "09ab70194864f1b6905858c6f2a866620128f451", "filename": "src/test/run-pass/cfg-attr-cfg.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Frun-pass%2Fcfg-attr-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Frun-pass%2Fcfg-attr-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcfg-attr-cfg.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// main is conditionally compiled, but the conditional compilation\n+// is conditional too!\n+\n+#[cfg_attr(foo, cfg(bar))]\n+fn main() { }"}, {"sha": "e6bd8afad280b98e928883216ea6c851512280df", "filename": "src/test/run-pass/cfg-attr-crate.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Frun-pass%2Fcfg-attr-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5354317037368124d180acc3f8754bdb2b0387b8/src%2Ftest%2Frun-pass%2Fcfg-attr-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcfg-attr-crate.rs?ref=5354317037368124d180acc3f8754bdb2b0387b8", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// https://github.com/rust-lang/rust/issues/21833#issuecomment-72353044\n+\n+#![cfg_attr(not_used, no_std)]\n+\n+fn main() { }"}]}