{"sha": "22973a884455fa2885699c1479603c8abe44232b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIyOTczYTg4NDQ1NWZhMjg4NTY5OWMxNDc5NjAzYzhhYmU0NDIzMmI=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-08-29T14:25:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-29T14:25:26Z"}, "message": "Rollup merge of #83251 - estebank:issue-83241, r=oli-obk\n\nSuggestion for call on immutable binding of mutable type\n\nWhen calling a method requiring a mutable self borrow on an inmutable\nto a mutable borrow of the type, suggest making the binding mutable.\n\nFix #83241.", "tree": {"sha": "a9d43b210557c77034e140684d515349164ac727", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9d43b210557c77034e140684d515349164ac727"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/22973a884455fa2885699c1479603c8abe44232b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhK5jXCRBK7hj4Ov3rIwAAFXcIAD4mPnasslEmdIfKuFUoo5fy\nU7nZyt7jmteykrx7C5DAcK7aQN19PFKtJGmhsRhJ6DDzR0ruFEwxfERKgLb5jBeB\nnz+oUCjPaK1ur5VZnHXD+thda728Rv3zLQ0+gsZm80toZaNVIxy4M70JogdLf2Eg\nf+qjO+uBA4vpgrXIFYV18qw+GktKsJnDC0w+fR5LPAiox2pBMmyrpblkZgl/8BNZ\n3WmcLzQNKK14ozU+3mA5Q0odSznGEfBH34OWgE9EHn9u6wzuX8rD877LLKRSU4IC\npKDkXJLD/Kpe4tlXpOJJudp7q6R8oONtY/Xd4iiKR5qOKdnzzmZz9w92Pu0+krQ=\n=KHPP\n-----END PGP SIGNATURE-----\n", "payload": "tree a9d43b210557c77034e140684d515349164ac727\nparent 8eb50ce1f44d254399a2ff7d3b444a267838cd41\nparent 5b6f4b94c5679c9cce70d42cb4cbdbd55da2e0f7\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1630247126 +0200\ncommitter GitHub <noreply@github.com> 1630247126 +0200\n\nRollup merge of #83251 - estebank:issue-83241, r=oli-obk\n\nSuggestion for call on immutable binding of mutable type\n\nWhen calling a method requiring a mutable self borrow on an inmutable\nto a mutable borrow of the type, suggest making the binding mutable.\n\nFix #83241.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/22973a884455fa2885699c1479603c8abe44232b", "html_url": "https://github.com/rust-lang/rust/commit/22973a884455fa2885699c1479603c8abe44232b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/22973a884455fa2885699c1479603c8abe44232b/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8eb50ce1f44d254399a2ff7d3b444a267838cd41", "url": "https://api.github.com/repos/rust-lang/rust/commits/8eb50ce1f44d254399a2ff7d3b444a267838cd41", "html_url": "https://github.com/rust-lang/rust/commit/8eb50ce1f44d254399a2ff7d3b444a267838cd41"}, {"sha": "5b6f4b94c5679c9cce70d42cb4cbdbd55da2e0f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/5b6f4b94c5679c9cce70d42cb4cbdbd55da2e0f7", "html_url": "https://github.com/rust-lang/rust/commit/5b6f4b94c5679c9cce70d42cb4cbdbd55da2e0f7"}], "stats": {"total": 248, "additions": 210, "deletions": 38}, "files": [{"sha": "4e079ed865ac31d4f29ecaea2285fd8d86407811", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/mutability_errors.rs", "status": "modified", "additions": 72, "deletions": 8, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/22973a884455fa2885699c1479603c8abe44232b/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22973a884455fa2885699c1479603c8abe44232b/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs?ref=22973a884455fa2885699c1479603c8abe44232b", "patch": "@@ -5,11 +5,14 @@ use rustc_middle::mir::{Mutability, Place, PlaceRef, ProjectionElem};\n use rustc_middle::ty::{self, Ty, TyCtxt};\n use rustc_middle::{\n     hir::place::PlaceBase,\n-    mir::{self, ClearCrossCrate, Local, LocalDecl, LocalInfo, LocalKind, Location},\n+    mir::{\n+        self, BindingForm, ClearCrossCrate, ImplicitSelfKind, Local, LocalDecl, LocalInfo,\n+        LocalKind, Location,\n+    },\n };\n use rustc_span::source_map::DesugaringKind;\n use rustc_span::symbol::{kw, Symbol};\n-use rustc_span::Span;\n+use rustc_span::{BytePos, Span};\n \n use crate::borrow_check::diagnostics::BorrowedContentSource;\n use crate::borrow_check::MirBorrowckCtxt;\n@@ -241,13 +244,74 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                     .map(|l| mut_borrow_of_mutable_ref(l, self.local_names[local]))\n                     .unwrap_or(false) =>\n             {\n+                let decl = &self.body.local_decls[local];\n                 err.span_label(span, format!(\"cannot {ACT}\", ACT = act));\n-                err.span_suggestion(\n-                    span,\n-                    \"try removing `&mut` here\",\n-                    String::new(),\n-                    Applicability::MaybeIncorrect,\n-                );\n+                if let Some(mir::Statement {\n+                    source_info,\n+                    kind:\n+                        mir::StatementKind::Assign(box (\n+                            _,\n+                            mir::Rvalue::Ref(\n+                                _,\n+                                mir::BorrowKind::Mut { allow_two_phase_borrow: false },\n+                                _,\n+                            ),\n+                        )),\n+                    ..\n+                }) = &self.body[location.block].statements.get(location.statement_index)\n+                {\n+                    match decl.local_info {\n+                        Some(box LocalInfo::User(ClearCrossCrate::Set(BindingForm::Var(\n+                            mir::VarBindingForm {\n+                                binding_mode: ty::BindingMode::BindByValue(Mutability::Not),\n+                                opt_ty_info: Some(sp),\n+                                opt_match_place: _,\n+                                pat_span: _,\n+                            },\n+                        )))) => {\n+                            err.span_note(sp, \"the binding is already a mutable borrow\");\n+                        }\n+                        _ => {\n+                            err.span_note(\n+                                decl.source_info.span,\n+                                \"the binding is already a mutable borrow\",\n+                            );\n+                        }\n+                    }\n+                    if let Ok(snippet) =\n+                        self.infcx.tcx.sess.source_map().span_to_snippet(source_info.span)\n+                    {\n+                        if snippet.starts_with(\"&mut \") {\n+                            // We don't have access to the HIR to get accurate spans, but we can\n+                            // give a best effort structured suggestion.\n+                            err.span_suggestion_verbose(\n+                                source_info.span.with_hi(source_info.span.lo() + BytePos(5)),\n+                                \"try removing `&mut` here\",\n+                                String::new(),\n+                                Applicability::MachineApplicable,\n+                            );\n+                        } else {\n+                            // This can occur with things like `(&mut self).foo()`.\n+                            err.span_help(source_info.span, \"try removing `&mut` here\");\n+                        }\n+                    } else {\n+                        err.span_help(source_info.span, \"try removing `&mut` here\");\n+                    }\n+                } else if decl.mutability == Mutability::Not\n+                    && !matches!(\n+                        decl.local_info,\n+                        Some(box LocalInfo::User(ClearCrossCrate::Set(BindingForm::ImplicitSelf(\n+                            ImplicitSelfKind::MutRef\n+                        ))))\n+                    )\n+                {\n+                    err.span_suggestion_verbose(\n+                        decl.source_info.span.shrink_to_lo(),\n+                        \"consider making the binding mutable\",\n+                        \"mut \".to_string(),\n+                        Applicability::MachineApplicable,\n+                    );\n+                }\n             }\n \n             // We want to suggest users use `let mut` for local (user"}, {"sha": "7cdb16b282d540253dd756071d02611639dc3ef5", "filename": "src/test/ui/borrowck/mut-borrow-of-mut-ref.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.rs?ref=22973a884455fa2885699c1479603c8abe44232b", "patch": "@@ -2,12 +2,36 @@\n #![crate_type = \"rlib\"]\n \n pub fn f(b: &mut i32) {\n-    g(&mut b);\n+    //~^ NOTE the binding is already a mutable borrow\n+    //~| NOTE the binding is already a mutable borrow\n+    h(&mut b);\n     //~^ ERROR cannot borrow\n+    //~| NOTE cannot borrow as mutable\n     //~| HELP try removing `&mut` here\n     g(&mut &mut b);\n     //~^ ERROR cannot borrow\n+    //~| NOTE cannot borrow as mutable\n     //~| HELP try removing `&mut` here\n }\n \n-pub fn g(_: &mut i32) {}\n+pub fn g(b: &mut i32) { //~ NOTE the binding is already a mutable borrow\n+    h(&mut &mut b);\n+    //~^ ERROR cannot borrow\n+    //~| NOTE cannot borrow as mutable\n+    //~| HELP try removing `&mut` here\n+}\n+\n+pub fn h(_: &mut i32) {}\n+\n+trait Foo {\n+    fn bar(&mut self);\n+}\n+\n+impl Foo for &mut String {\n+    fn bar(&mut self) {}\n+}\n+\n+pub fn baz(f: &mut String) { //~ HELP consider making the binding mutable\n+    f.bar(); //~ ERROR cannot borrow `f` as mutable, as it is not declared as mutable\n+    //~^ NOTE cannot borrow as mutable\n+}"}, {"sha": "e4c51bb77c9edca9b779010c70a92fda2aa7b675", "filename": "src/test/ui/borrowck/mut-borrow-of-mut-ref.stderr", "status": "modified", "additions": 56, "deletions": 12, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.stderr?ref=22973a884455fa2885699c1479603c8abe44232b", "patch": "@@ -1,21 +1,65 @@\n error[E0596]: cannot borrow `b` as mutable, as it is not declared as mutable\n-  --> $DIR/mut-borrow-of-mut-ref.rs:5:7\n+  --> $DIR/mut-borrow-of-mut-ref.rs:7:7\n    |\n-LL |     g(&mut b);\n-   |       ^^^^^^\n-   |       |\n-   |       cannot borrow as mutable\n-   |       help: try removing `&mut` here\n+LL |     h(&mut b);\n+   |       ^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/mut-borrow-of-mut-ref.rs:4:13\n+   |\n+LL | pub fn f(b: &mut i32) {\n+   |             ^^^^^^^^\n+help: try removing `&mut` here\n+   |\n+LL -     h(&mut b);\n+LL +     h(b);\n+   | \n \n error[E0596]: cannot borrow `b` as mutable, as it is not declared as mutable\n-  --> $DIR/mut-borrow-of-mut-ref.rs:8:12\n+  --> $DIR/mut-borrow-of-mut-ref.rs:11:12\n    |\n LL |     g(&mut &mut b);\n-   |            ^^^^^^\n-   |            |\n-   |            cannot borrow as mutable\n-   |            help: try removing `&mut` here\n+   |            ^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/mut-borrow-of-mut-ref.rs:4:13\n+   |\n+LL | pub fn f(b: &mut i32) {\n+   |             ^^^^^^^^\n+help: try removing `&mut` here\n+   |\n+LL -     g(&mut &mut b);\n+LL +     g(&mut b);\n+   | \n+\n+error[E0596]: cannot borrow `b` as mutable, as it is not declared as mutable\n+  --> $DIR/mut-borrow-of-mut-ref.rs:18:12\n+   |\n+LL |     h(&mut &mut b);\n+   |            ^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/mut-borrow-of-mut-ref.rs:17:13\n+   |\n+LL | pub fn g(b: &mut i32) {\n+   |             ^^^^^^^^\n+help: try removing `&mut` here\n+   |\n+LL -     h(&mut &mut b);\n+LL +     h(&mut b);\n+   | \n+\n+error[E0596]: cannot borrow `f` as mutable, as it is not declared as mutable\n+  --> $DIR/mut-borrow-of-mut-ref.rs:35:5\n+   |\n+LL |     f.bar();\n+   |     ^ cannot borrow as mutable\n+   |\n+help: consider making the binding mutable\n+   |\n+LL | pub fn baz(mut f: &mut String) {\n+   |            +++\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0596`."}, {"sha": "88617381236d7377fe5717f613c14c52193f9a27", "filename": "src/test/ui/did_you_mean/issue-31424.stderr", "status": "modified", "additions": 22, "deletions": 6, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-31424.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-31424.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-31424.stderr?ref=22973a884455fa2885699c1479603c8abe44232b", "patch": "@@ -1,11 +1,19 @@\n error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n   --> $DIR/issue-31424.rs:7:9\n    |\n+LL |         (&mut self).bar();\n+   |         ^^^^^^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/issue-31424.rs:6:12\n+   |\n+LL |     fn foo(&mut self) {\n+   |            ^^^^^^^^^\n+help: try removing `&mut` here\n+  --> $DIR/issue-31424.rs:7:9\n+   |\n LL |         (&mut self).bar();\n    |         ^^^^^^^^^^^\n-   |         |\n-   |         cannot borrow as mutable\n-   |         help: try removing `&mut` here\n \n warning: function cannot return without recursing\n   --> $DIR/issue-31424.rs:13:5\n@@ -22,11 +30,19 @@ LL |         (&mut self).bar();\n error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n   --> $DIR/issue-31424.rs:16:9\n    |\n+LL |         (&mut self).bar();\n+   |         ^^^^^^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/issue-31424.rs:13:18\n+   |\n+LL |     fn bar(self: &mut Self) {\n+   |                  ^^^^^^^^^\n+help: try removing `&mut` here\n+  --> $DIR/issue-31424.rs:16:9\n+   |\n LL |         (&mut self).bar();\n    |         ^^^^^^^^^^^\n-   |         |\n-   |         cannot borrow as mutable\n-   |         help: try removing `&mut` here\n \n error: aborting due to 2 previous errors; 1 warning emitted\n "}, {"sha": "666172197ce9b01be64be88936a201bec1997282", "filename": "src/test/ui/did_you_mean/issue-34126.stderr", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-34126.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-34126.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-34126.stderr?ref=22973a884455fa2885699c1479603c8abe44232b", "patch": "@@ -2,10 +2,18 @@ error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n   --> $DIR/issue-34126.rs:6:18\n    |\n LL |         self.run(&mut self);\n-   |                  ^^^^^^^^^\n-   |                  |\n-   |                  cannot borrow as mutable\n-   |                  help: try removing `&mut` here\n+   |                  ^^^^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/issue-34126.rs:5:14\n+   |\n+LL |     fn start(&mut self) {\n+   |              ^^^^^^^^^\n+help: try removing `&mut` here\n+   |\n+LL -         self.run(&mut self);\n+LL +         self.run(self);\n+   | \n \n error[E0502]: cannot borrow `self` as mutable because it is also borrowed as immutable\n   --> $DIR/issue-34126.rs:6:18"}, {"sha": "18696f57c44aef80ac01115c80833feece008a1c", "filename": "src/test/ui/nll/issue-51191.stderr", "status": "modified", "additions": 22, "deletions": 6, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fnll%2Fissue-51191.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/22973a884455fa2885699c1479603c8abe44232b/src%2Ftest%2Fui%2Fnll%2Fissue-51191.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-51191.stderr?ref=22973a884455fa2885699c1479603c8abe44232b", "patch": "@@ -13,11 +13,19 @@ LL |         (&mut self).bar();\n error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n   --> $DIR/issue-51191.rs:7:9\n    |\n+LL |         (&mut self).bar();\n+   |         ^^^^^^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/issue-51191.rs:4:18\n+   |\n+LL |     fn bar(self: &mut Self) {\n+   |                  ^^^^^^^^^\n+help: try removing `&mut` here\n+  --> $DIR/issue-51191.rs:7:9\n+   |\n LL |         (&mut self).bar();\n    |         ^^^^^^^^^^^\n-   |         |\n-   |         cannot borrow as mutable\n-   |         help: try removing `&mut` here\n \n error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n   --> $DIR/issue-51191.rs:13:9\n@@ -42,11 +50,19 @@ LL |         (&mut self).bar();\n error[E0596]: cannot borrow `self` as mutable, as it is not declared as mutable\n   --> $DIR/issue-51191.rs:28:9\n    |\n+LL |         (&mut self).bar();\n+   |         ^^^^^^^^^^^ cannot borrow as mutable\n+   |\n+note: the binding is already a mutable borrow\n+  --> $DIR/issue-51191.rs:27:16\n+   |\n+LL |     fn mtblref(&mut self) {\n+   |                ^^^^^^^^^\n+help: try removing `&mut` here\n+  --> $DIR/issue-51191.rs:28:9\n+   |\n LL |         (&mut self).bar();\n    |         ^^^^^^^^^^^\n-   |         |\n-   |         cannot borrow as mutable\n-   |         help: try removing `&mut` here\n \n error: aborting due to 5 previous errors; 1 warning emitted\n "}]}