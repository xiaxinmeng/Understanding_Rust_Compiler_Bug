{"sha": "a361cdb72f0ecb155f7da7a025d5af4f49f1e735", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzNjFjZGI3MmYwZWNiMTU1ZjdkYTdhMDI1ZDVhZjRmNDlmMWU3MzU=", "commit": {"author": {"name": "Jonathan Turner", "email": "jonathandturner@users.noreply.github.com", "date": "2016-08-20T14:09:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-08-20T14:09:36Z"}, "message": "Rollup merge of #35811 - jonathandturner:fix_rustbuild_version_test, r=alexcrichton\n\nAdd workaround to detect correct compiler version\n\nThis adds a workaround which fixes a rustbuild issue where the wrong compiler is checked for the version number.  The bug would arise if you build the system correctly then changed to any other version (eg doing a `git pull`).  After changing to the new version, building would fail and complain that crates were built with the wrong compiler.\n\nThere are actually two compilers at play, the bootstrapping compiler (called the \"snapshot\" compiler) and the actual compiler being built (the \"real\" compiler).  In the case of this issue, the wrong compiler was being checked for version mismatch.\n\nr? @alexcrichton", "tree": {"sha": "2b2560f53811ae444201fb2bb91f1a3c033e5afe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b2560f53811ae444201fb2bb91f1a3c033e5afe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a361cdb72f0ecb155f7da7a025d5af4f49f1e735", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a361cdb72f0ecb155f7da7a025d5af4f49f1e735", "html_url": "https://github.com/rust-lang/rust/commit/a361cdb72f0ecb155f7da7a025d5af4f49f1e735", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a361cdb72f0ecb155f7da7a025d5af4f49f1e735/comments", "author": {"login": "jonathandturner", "id": 111457284, "node_id": "O_kgDOBqS0BA", "avatar_url": "https://avatars.githubusercontent.com/u/111457284?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonathandturner", "html_url": "https://github.com/jonathandturner", "followers_url": "https://api.github.com/users/jonathandturner/followers", "following_url": "https://api.github.com/users/jonathandturner/following{/other_user}", "gists_url": "https://api.github.com/users/jonathandturner/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonathandturner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonathandturner/subscriptions", "organizations_url": "https://api.github.com/users/jonathandturner/orgs", "repos_url": "https://api.github.com/users/jonathandturner/repos", "events_url": "https://api.github.com/users/jonathandturner/events{/privacy}", "received_events_url": "https://api.github.com/users/jonathandturner/received_events", "type": "Organization", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0155eb16dd06dbe0761b7486fba96f674cea4d65", "url": "https://api.github.com/repos/rust-lang/rust/commits/0155eb16dd06dbe0761b7486fba96f674cea4d65", "html_url": "https://github.com/rust-lang/rust/commit/0155eb16dd06dbe0761b7486fba96f674cea4d65"}, {"sha": "ffbb8600fbba009598cbebf7149d0bd7a736b928", "url": "https://api.github.com/repos/rust-lang/rust/commits/ffbb8600fbba009598cbebf7149d0bd7a736b928", "html_url": "https://github.com/rust-lang/rust/commit/ffbb8600fbba009598cbebf7149d0bd7a736b928"}], "stats": {"total": 8, "additions": 7, "deletions": 1}, "files": [{"sha": "175e32125f27204bdc0db3b79628b08b1a9de19b", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a361cdb72f0ecb155f7da7a025d5af4f49f1e735/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a361cdb72f0ecb155f7da7a025d5af4f49f1e735/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=a361cdb72f0ecb155f7da7a025d5af4f49f1e735", "patch": "@@ -38,13 +38,19 @@ fn main() {\n     // is passed (a bit janky...)\n     let target = args.windows(2).find(|w| &*w[0] == \"--target\")\n                                 .and_then(|w| w[1].to_str());\n+    let version = args.iter().find(|w| &**w == \"-vV\");\n \n     // Build scripts always use the snapshot compiler which is guaranteed to be\n     // able to produce an executable, whereas intermediate compilers may not\n     // have the standard library built yet and may not be able to produce an\n     // executable. Otherwise we just use the standard compiler we're\n     // bootstrapping with.\n-    let (rustc, libdir) = if target.is_none() {\n+    //\n+    // Also note that cargo will detect the version of the compiler to trigger\n+    // a rebuild when the compiler changes. If this happens, we want to make\n+    // sure to use the actual compiler instead of the snapshot compiler becase\n+    // that's the one that's actually changing.\n+    let (rustc, libdir) = if target.is_none() && version.is_none() {\n         (\"RUSTC_SNAPSHOT\", \"RUSTC_SNAPSHOT_LIBDIR\")\n     } else {\n         (\"RUSTC_REAL\", \"RUSTC_LIBDIR\")"}]}