{"sha": "84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0NjQ2ZTlkNjdhNTk0MWQ1MmJmYTVhMmFlNGU0ZTI5ZTMwODA4ZmU=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2021-09-15T21:56:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-15T21:56:56Z"}, "message": "Rollup merge of #87320 - danakj:debug-compilation-dir, r=michaelwoerister\n\nIntroduce -Z remap-cwd-prefix switch\n\nThis switch remaps any absolute paths rooted under the current\nworking directory to a new value. This includes remapping the\ndebug info in `DW_AT_comp_dir` and `DW_AT_decl_file`.\n\nImportantly, this flag does not require passing the current working\ndirectory to the compiler, such that the command line can be\nrun on any machine (with the same input files) and produce the\nsame results. This is critical property for debugging compiler\nissues that crop up on remote machines.\n\nThis is based on adetaylor's https://github.com/rust-lang/rust/commit/dbc4ae7cba0ba8d650b91ddd459b86a02a2d05c5\n\nMajor Change Proposal: https://github.com/rust-lang/compiler-team/issues/450\nDiscussed on #38322. Would resolve issue #87325.", "tree": {"sha": "be6d6c700cdf9366c960a57da1432f75a1852e12", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be6d6c700cdf9366c960a57da1432f75a1852e12"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhQmwoCRBK7hj4Ov3rIwAAbMYIAE/JVkz3P3pouD/0GfDb5dKY\nShyV16xh5V4xkmZVRNxB4Bp2tpzG0eU0wbgqDPI315QTc6TiATOkSSP5RgEdxCMg\nIQDgGaQTOTd2xyze8NkyS9IEOcJGKwci/kSJ4+lkAwZo8SmNIKryWmHDgjHeB2SW\ne68fPcCmktRnUzlaoG4bH+aKpbxcV42RcuY9rxH9l3VBwC8ifZ+MzLYUP83Cvivd\nV05pCZT+Lh3E2cPNlpZk9CgdOhRkwOOpgm5FEMoa5LJYxQhrJAo/ndEojs4z1OyK\nashojh/E44ZmhtNdEPSuWS6O1u+qx31CDdSiyqRt3XsF4qF8nCPjWKJg7p2SjDU=\n=Y3ek\n-----END PGP SIGNATURE-----\n", "payload": "tree be6d6c700cdf9366c960a57da1432f75a1852e12\nparent 2c7bc5e33c25e29058cbafefe680da8d5e9220e9\nparent c0118289efbd3d0c61ae8912426a211e53abe208\nauthor Manish Goregaokar <manishsmail@gmail.com> 1631743016 -0700\ncommitter GitHub <noreply@github.com> 1631743016 -0700\n\nRollup merge of #87320 - danakj:debug-compilation-dir, r=michaelwoerister\n\nIntroduce -Z remap-cwd-prefix switch\n\nThis switch remaps any absolute paths rooted under the current\nworking directory to a new value. This includes remapping the\ndebug info in `DW_AT_comp_dir` and `DW_AT_decl_file`.\n\nImportantly, this flag does not require passing the current working\ndirectory to the compiler, such that the command line can be\nrun on any machine (with the same input files) and produce the\nsame results. This is critical property for debugging compiler\nissues that crop up on remote machines.\n\nThis is based on adetaylor's https://github.com/rust-lang/rust/commit/dbc4ae7cba0ba8d650b91ddd459b86a02a2d05c5\n\nMajor Change Proposal: https://github.com/rust-lang/compiler-team/issues/450\nDiscussed on #38322. Would resolve issue #87325.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "html_url": "https://github.com/rust-lang/rust/commit/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c7bc5e33c25e29058cbafefe680da8d5e9220e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c7bc5e33c25e29058cbafefe680da8d5e9220e9", "html_url": "https://github.com/rust-lang/rust/commit/2c7bc5e33c25e29058cbafefe680da8d5e9220e9"}, {"sha": "c0118289efbd3d0c61ae8912426a211e53abe208", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0118289efbd3d0c61ae8912426a211e53abe208", "html_url": "https://github.com/rust-lang/rust/commit/c0118289efbd3d0c61ae8912426a211e53abe208"}], "stats": {"total": 107, "additions": 102, "deletions": 5}, "files": [{"sha": "cfe13b1fd4e1fbd060e37dbefb7229f00098435d", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "patch": "@@ -754,6 +754,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(profiler_runtime, \"abc\".to_string());\n     tracked!(relax_elf_relocations, Some(true));\n     tracked!(relro_level, Some(RelroLevel::Full));\n+    tracked!(remap_cwd_prefix, Some(PathBuf::from(\"abc\")));\n     tracked!(simulate_remapped_rust_src_base, Some(PathBuf::from(\"/rustc/abc\")));\n     tracked!(report_delayed_bugs, true);\n     tracked!(sanitizer, SanitizerSet::ADDRESS);"}, {"sha": "32aa035e1cdecb458faea87ceba51e2f3938c84a", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "patch": "@@ -1920,9 +1920,10 @@ fn parse_extern_dep_specs(\n \n fn parse_remap_path_prefix(\n     matches: &getopts::Matches,\n+    debugging_opts: &DebuggingOptions,\n     error_format: ErrorOutputType,\n ) -> Vec<(PathBuf, PathBuf)> {\n-    matches\n+    let mut mapping: Vec<(PathBuf, PathBuf)> = matches\n         .opt_strs(\"remap-path-prefix\")\n         .into_iter()\n         .map(|remap| match remap.rsplit_once('=') {\n@@ -1932,7 +1933,15 @@ fn parse_remap_path_prefix(\n             ),\n             Some((from, to)) => (PathBuf::from(from), PathBuf::from(to)),\n         })\n-        .collect()\n+        .collect();\n+    match &debugging_opts.remap_cwd_prefix {\n+        Some(to) => match std::env::current_dir() {\n+            Ok(cwd) => mapping.push((cwd, to.clone())),\n+            Err(_) => (),\n+        },\n+        None => (),\n+    };\n+    mapping\n }\n \n pub fn build_session_options(matches: &getopts::Matches) -> Options {\n@@ -2077,7 +2086,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n \n     let crate_name = matches.opt_str(\"crate-name\");\n \n-    let remap_path_prefix = parse_remap_path_prefix(matches, error_format);\n+    let remap_path_prefix = parse_remap_path_prefix(matches, &debugging_opts, error_format);\n \n     let pretty = parse_pretty(&debugging_opts, error_format);\n "}, {"sha": "8110afe75fa92969fb1364a06f748643d2c656ee", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "patch": "@@ -1250,6 +1250,8 @@ options! {\n         \"whether ELF relocations can be relaxed\"),\n     relro_level: Option<RelroLevel> = (None, parse_relro_level, [TRACKED],\n         \"choose which RELRO level to use\"),\n+    remap_cwd_prefix: Option<PathBuf> = (None, parse_opt_pathbuf, [TRACKED],\n+        \"remap paths under the current working directory to this path prefix\"),\n     simulate_remapped_rust_src_base: Option<PathBuf> = (None, parse_opt_pathbuf, [TRACKED],\n         \"simulate the effect of remap-debuginfo = true at bootstrapping by remapping path \\\n         to rust's source base directory. only meant for testing purposes\"),"}, {"sha": "977d258529f8c41a5b1f48895f955dfbe35efb3a", "filename": "src/doc/unstable-book/src/compiler-flags/remap-cwd-prefix.md", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fremap-cwd-prefix.md", "raw_url": "https://github.com/rust-lang/rust/raw/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fremap-cwd-prefix.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fremap-cwd-prefix.md?ref=84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "patch": "@@ -0,0 +1,24 @@\n+# `remap-cwd-prefix`\n+\n+The tracking issue for this feature is: [#87325](https://github.com/rust-lang/rust/issues/87325).\n+\n+------------------------\n+\n+This flag will rewrite absolute paths under the current working directory,\n+replacing the current working directory prefix with a specified value.\n+\n+The given value may be absolute or relative, or empty. This switch takes\n+precidence over `--remap-path-prefix` in case they would both match a given\n+path.\n+\n+This flag helps to produce deterministic output, by removing the current working\n+directory from build output, while allowing the command line to be universally\n+reproducible, such that the same execution will work on all machines, regardless\n+of build environment.\n+\n+## Example\n+```sh\n+# This would produce an absolute path to main.rs in build outputs of\n+# \"./main.rs\".\n+rustc -Z remap-cwd-prefix=. main.rs\n+```"}, {"sha": "adccc153568485f0fc62124c2f60e107d87ae3ea", "filename": "src/test/run-make-fulldeps/reproducible-build/Makefile", "status": "modified", "additions": 63, "deletions": 2, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/84646e9d67a5941d52bfa5a2ae4e4e29e30808fe/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build%2FMakefile?ref=84646e9d67a5941d52bfa5a2ae4e4e29e30808fe", "patch": "@@ -9,9 +9,19 @@ all:  \\\n \topt \\\n \tlink_paths \\\n \tremap_paths \\\n-\tdifferent_source_dirs \\\n+\tdifferent_source_dirs_rlib \\\n+\tremap_cwd_rlib \\\n+\tremap_cwd_to_empty \\\n \textern_flags\n \n+# TODO: Builds of `bin` crate types are not deterministic with debuginfo=2 on\n+# Windows.\n+# See: https://github.com/rust-lang/rust/pull/87320#issuecomment-920105533\n+# Issue: https://github.com/rust-lang/rust/issues/88982\n+#\n+#\tdifferent_source_dirs_bin \\\n+#\tremap_cwd_bin \\\n+\n smoke:\n \trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n \t$(RUSTC) linker.rs -O\n@@ -52,7 +62,19 @@ remap_paths:\n \t$(RUSTC) reproducible-build.rs --crate-type rlib --remap-path-prefix=/b=/c\n \tcmp \"$(TMPDIR)/libreproducible_build.rlib\" \"$(TMPDIR)/libfoo.rlib\" || exit 1\n \n-different_source_dirs:\n+different_source_dirs_bin:\n+\trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n+\t$(RUSTC) reproducible-build-aux.rs\n+\tmkdir $(TMPDIR)/test\n+\tcp reproducible-build.rs $(TMPDIR)/test\n+\t$(RUSTC) reproducible-build.rs --crate-type bin --remap-path-prefix=$$PWD=/b\n+\tcp $(TMPDIR)/reproducible-build $(TMPDIR)/foo\n+\t(cd $(TMPDIR)/test && $(RUSTC) reproducible-build.rs \\\n+\t\t--remap-path-prefix=$(TMPDIR)/test=/b \\\n+\t\t--crate-type bin)\n+\tcmp \"$(TMPDIR)/reproducible-build\" \"$(TMPDIR)/foo\" || exit 1\n+\n+different_source_dirs_rlib:\n \trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n \t$(RUSTC) reproducible-build-aux.rs\n \tmkdir $(TMPDIR)/test\n@@ -64,6 +86,45 @@ different_source_dirs:\n \t\t--crate-type rlib)\n \tcmp \"$(TMPDIR)/libreproducible_build.rlib\" \"$(TMPDIR)/libfoo.rlib\" || exit 1\n \n+remap_cwd_bin:\n+\trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n+\t$(RUSTC) reproducible-build-aux.rs\n+\tmkdir $(TMPDIR)/test\n+\tcp reproducible-build.rs $(TMPDIR)/test\n+\t$(RUSTC) reproducible-build.rs --crate-type bin -C debuginfo=2 \\\n+\t  -Z remap-cwd-prefix=.\n+\tcp $(TMPDIR)/reproducible-build $(TMPDIR)/first\n+\t(cd $(TMPDIR)/test && \\\n+\t $(RUSTC) reproducible-build.rs --crate-type bin -C debuginfo=2 \\\n+\t   -Z remap-cwd-prefix=.)\n+\tcmp \"$(TMPDIR)/first\" \"$(TMPDIR)/reproducible-build\" || exit 1\n+\n+remap_cwd_rlib:\n+\trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n+\t$(RUSTC) reproducible-build-aux.rs\n+\tmkdir $(TMPDIR)/test\n+\tcp reproducible-build.rs $(TMPDIR)/test\n+\t$(RUSTC) reproducible-build.rs --crate-type rlib -C debuginfo=2 \\\n+\t  -Z remap-cwd-prefix=.\n+\tcp $(TMPDIR)/libreproducible_build.rlib $(TMPDIR)/libfirst.rlib\n+\t(cd $(TMPDIR)/test && \\\n+\t $(RUSTC) reproducible-build.rs --crate-type rlib -C debuginfo=2 \\\n+\t   -Z remap-cwd-prefix=.)\n+\tcmp \"$(TMPDIR)/libfirst.rlib\" \"$(TMPDIR)/libreproducible_build.rlib\" || exit 1\n+\n+remap_cwd_to_empty:\n+\trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n+\t$(RUSTC) reproducible-build-aux.rs\n+\tmkdir $(TMPDIR)/test\n+\tcp reproducible-build.rs $(TMPDIR)/test\n+\t$(RUSTC) reproducible-build.rs --crate-type rlib -C debuginfo=2 \\\n+\t  -Z remap-cwd-prefix=\n+\tcp $(TMPDIR)/libreproducible_build.rlib $(TMPDIR)/libfirst.rlib\n+\t(cd $(TMPDIR)/test && \\\n+\t $(RUSTC) reproducible-build.rs --crate-type rlib -C debuginfo=2 \\\n+\t   -Z remap-cwd-prefix=)\n+\tcmp \"$(TMPDIR)/libfirst.rlib\" \"$(TMPDIR)/libreproducible_build.rlib\" || exit 1\n+\n extern_flags:\n \trm -rf $(TMPDIR) && mkdir $(TMPDIR)\n \t$(RUSTC) reproducible-build-aux.rs"}]}