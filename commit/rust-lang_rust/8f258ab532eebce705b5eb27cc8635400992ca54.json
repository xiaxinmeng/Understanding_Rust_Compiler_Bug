{"sha": "8f258ab532eebce705b5eb27cc8635400992ca54", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmMjU4YWI1MzJlZWJjZTcwNWI1ZWIyN2NjODYzNTQwMDk5MmNhNTQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-11-01T05:09:48Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-11-01T05:09:48Z"}, "message": "Provide a sound method of flushing stdout\n\nThe previous method was unsound because you could very easily create two mutable\npointers which alias the same location (not sound behavior). This hides the\nfunction which does so and then exports an explicit flush() function (with\ndocumentation about how it works).", "tree": {"sha": "d7f5f7ff4dae3c01f40fb337f103946cc7cc28af", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d7f5f7ff4dae3c01f40fb337f103946cc7cc28af"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f258ab532eebce705b5eb27cc8635400992ca54", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f258ab532eebce705b5eb27cc8635400992ca54", "html_url": "https://github.com/rust-lang/rust/commit/8f258ab532eebce705b5eb27cc8635400992ca54", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f258ab532eebce705b5eb27cc8635400992ca54/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d04a58cf2d224f6e0ae69334f90a9013ae2ba35a", "url": "https://api.github.com/repos/rust-lang/rust/commits/d04a58cf2d224f6e0ae69334f90a9013ae2ba35a", "html_url": "https://github.com/rust-lang/rust/commit/d04a58cf2d224f6e0ae69334f90a9013ae2ba35a"}], "stats": {"total": 41, "additions": 27, "deletions": 14}, "files": [{"sha": "1284ab736560fb9b6269b72b1ff3fcda8c5b8161", "filename": "src/libstd/rt/io/stdio.rs", "status": "modified", "additions": 27, "deletions": 14, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/8f258ab532eebce705b5eb27cc8635400992ca54/src%2Flibstd%2Frt%2Fio%2Fstdio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f258ab532eebce705b5eb27cc8635400992ca54/src%2Flibstd%2Frt%2Fio%2Fstdio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fio%2Fstdio.rs?ref=8f258ab532eebce705b5eb27cc8635400992ca54", "patch": "@@ -112,20 +112,17 @@ pub fn stderr() -> StdWriter {\n     do src(libc::STDERR_FILENO, false) |src| { StdWriter { inner: src } }\n }\n \n-/// Executes a closure with the local task's handle on stdout. By default, this\n-/// stream is a buffering stream, so the handled yielded to the given closure\n-/// can be used to flush the stdout stream (if necessary). The buffering used is\n-/// line-buffering when stdout is attached to a terminal, and a fixed sized\n-/// buffer if it is not attached to a terminal.\n-///\n-/// Note that handles generated via the `stdout()` function all output to the\n-/// same stream, and output among all task may be interleaved as a result of\n-/// this. This is provided to have access to the default stream for `print` and\n-/// `println` (and the related macros) for this task.\n-///\n-/// Also note that logging macros do not use this stream. Using the logging\n-/// macros will emit output to stderr.\n-pub fn with_task_stdout(f: &fn(&mut Writer)) {\n+// Helper to access the local task's stdout handle\n+//\n+// Note that this is not a safe function to expose because you can create an\n+// aliased pointer very easily:\n+//\n+//  do with_task_stdout |io1| {\n+//      do with_task_stdout |io2| {\n+//          // io1 aliases io2\n+//      }\n+//  }\n+fn with_task_stdout(f: &fn(&mut Writer)) {\n     use rt::local::Local;\n     use rt::task::Task;\n \n@@ -153,6 +150,22 @@ pub fn with_task_stdout(f: &fn(&mut Writer)) {\n     }\n }\n \n+/// Flushes the local task's stdout handle.\n+///\n+/// By default, this stream is a buffering stream, flushing may be necessary to\n+/// ensure output is on the terminal screen. The buffering used is\n+/// line-buffering when stdout is attached to a terminal, and a fixed sized\n+/// buffer if it is not attached to a terminal.\n+///\n+/// Note that logging macros do not use this stream. Using the logging macros\n+/// will emit output to stderr, and while they are line buffered the log\n+/// messages are always terminated in a newline (no need to flush).\n+pub fn flush() {\n+    do with_task_stdout |io| {\n+        io.flush();\n+    }\n+}\n+\n /// Prints a string to the stdout of the current process. No newline is emitted\n /// after the string is printed.\n pub fn print(s: &str) {"}]}