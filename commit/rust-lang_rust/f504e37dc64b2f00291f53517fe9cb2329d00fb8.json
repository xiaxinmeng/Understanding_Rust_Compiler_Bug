{"sha": "f504e37dc64b2f00291f53517fe9cb2329d00fb8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1MDRlMzdkYzY0YjJmMDAyOTFmNTM1MTdmZTljYjIzMjlkMDBmYjg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-09-17T10:37:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-09-17T10:37:01Z"}, "message": "Auto merge of #64543 - pietroalbini:revert-miri-manifest, r=pietroalbini\n\nRevert #64451\n\n#64451 is making the release process panic, causing today's missing nightly (see https://github.com/rust-lang/rust/issues/64540). This reverts that PR, but I'm happy to review a fixed version of it.\n\ncc @RalfJung\nr? @ghost\n\nFixes https://github.com/rust-lang/rust/issues/64540", "tree": {"sha": "55f0179ad6ec3cb32a95d8aa803e042f1f227b69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55f0179ad6ec3cb32a95d8aa803e042f1f227b69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f504e37dc64b2f00291f53517fe9cb2329d00fb8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f504e37dc64b2f00291f53517fe9cb2329d00fb8", "html_url": "https://github.com/rust-lang/rust/commit/f504e37dc64b2f00291f53517fe9cb2329d00fb8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f504e37dc64b2f00291f53517fe9cb2329d00fb8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5670d048c0f88af9976b5505c7853b23dd06770d", "url": "https://api.github.com/repos/rust-lang/rust/commits/5670d048c0f88af9976b5505c7853b23dd06770d", "html_url": "https://github.com/rust-lang/rust/commit/5670d048c0f88af9976b5505c7853b23dd06770d"}, {"sha": "a7a6dedfe661a6d9d181afeb0fbaa894fcb7362b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7a6dedfe661a6d9d181afeb0fbaa894fcb7362b", "html_url": "https://github.com/rust-lang/rust/commit/a7a6dedfe661a6d9d181afeb0fbaa894fcb7362b"}], "stats": {"total": 72, "additions": 9, "deletions": 63}, "files": [{"sha": "326f3b10b41967b9cc4774060c01c325e0f9cb25", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f504e37dc64b2f00291f53517fe9cb2329d00fb8/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f504e37dc64b2f00291f53517fe9cb2329d00fb8/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f504e37dc64b2f00291f53517fe9cb2329d00fb8", "patch": "@@ -201,9 +201,7 @@ dependencies = [\n name = \"build-manifest\"\n version = \"0.1.0\"\n dependencies = [\n- \"reqwest\",\n  \"serde\",\n- \"serde_json\",\n  \"toml\",\n ]\n "}, {"sha": "500d5766a899e4945874793483f1630daf55a8b1", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f504e37dc64b2f00291f53517fe9cb2329d00fb8/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f504e37dc64b2f00291f53517fe9cb2329d00fb8/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=f504e37dc64b2f00291f53517fe9cb2329d00fb8", "patch": "@@ -2000,8 +2000,6 @@ impl Step for HashSign {\n     }\n \n     fn run(self, builder: &Builder<'_>) {\n-        // This gets called by `promote-release`\n-        // (https://github.com/rust-lang/rust-central-station/tree/master/promote-release).\n         let mut cmd = builder.tool_cmd(Tool::BuildManifest);\n         if builder.config.dry_run {\n             return;\n@@ -2012,14 +2010,10 @@ impl Step for HashSign {\n         let addr = builder.config.dist_upload_addr.as_ref().unwrap_or_else(|| {\n             panic!(\"\\n\\nfailed to specify `dist.upload-addr` in `config.toml`\\n\\n\")\n         });\n-        let pass = if env::var(\"BUILD_MANIFEST_DISABLE_SIGNING\").is_err() {\n-            let file = builder.config.dist_gpg_password_file.as_ref().unwrap_or_else(|| {\n-                panic!(\"\\n\\nfailed to specify `dist.gpg-password-file` in `config.toml`\\n\\n\")\n-            });\n-            t!(fs::read_to_string(&file))\n-        } else {\n-            String::new()\n-        };\n+        let file = builder.config.dist_gpg_password_file.as_ref().unwrap_or_else(|| {\n+            panic!(\"\\n\\nfailed to specify `dist.gpg-password-file` in `config.toml`\\n\\n\")\n+        });\n+        let pass = t!(fs::read_to_string(&file));\n \n         let today = output(Command::new(\"date\").arg(\"+%Y-%m-%d\"));\n "}, {"sha": "c364479d8db13251be3caf4bc2a249b8c84df98d", "filename": "src/tools/build-manifest/Cargo.toml", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f504e37dc64b2f00291f53517fe9cb2329d00fb8/src%2Ftools%2Fbuild-manifest%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f504e37dc64b2f00291f53517fe9cb2329d00fb8/src%2Ftools%2Fbuild-manifest%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2FCargo.toml?ref=f504e37dc64b2f00291f53517fe9cb2329d00fb8", "patch": "@@ -7,5 +7,3 @@ edition = \"2018\"\n [dependencies]\n toml = \"0.5\"\n serde = { version = \"1.0\", features = [\"derive\"] }\n-serde_json = \"1.0\"\n-reqwest = \"0.9\""}, {"sha": "9ffa9391c820bd6fcfacda2178c78016278cc779", "filename": "src/tools/build-manifest/src/main.rs", "status": "modified", "additions": 5, "deletions": 49, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/f504e37dc64b2f00291f53517fe9cb2329d00fb8/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f504e37dc64b2f00291f53517fe9cb2329d00fb8/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs?ref=f504e37dc64b2f00291f53517fe9cb2329d00fb8", "patch": "@@ -1,19 +1,12 @@\n-//! Build a dist manifest, hash and sign everything.\n-//! This gets called by `promote-release`\n-//! (https://github.com/rust-lang/rust-central-station/tree/master/promote-release)\n-//! via `x.py dist hash-and-sign`; the cmdline arguments are set up\n-//! by rustbuild (in `src/bootstrap/dist.rs`).\n-\n use toml;\n use serde::Serialize;\n \n use std::collections::BTreeMap;\n use std::env;\n use std::fs;\n-use std::io::{self, Read, Write, BufRead, BufReader};\n+use std::io::{self, Read, Write};\n use std::path::{PathBuf, Path};\n use std::process::{Command, Stdio};\n-use std::collections::HashMap;\n \n static HOSTS: &[&str] = &[\n     \"aarch64-unknown-linux-gnu\",\n@@ -153,9 +146,6 @@ static MINGW: &[&str] = &[\n     \"x86_64-pc-windows-gnu\",\n ];\n \n-static TOOLSTATE: &str =\n-    \"https://raw.githubusercontent.com/rust-lang-nursery/rust-toolstate/master/history/linux.tsv\";\n-\n #[derive(Serialize)]\n #[serde(rename_all = \"kebab-case\")]\n struct Manifest {\n@@ -280,7 +270,6 @@ fn main() {\n     // Do not ask for a passphrase while manually testing\n     let mut passphrase = String::new();\n     if should_sign {\n-        // `x.py` passes the passphrase via stdin.\n         t!(io::stdin().read_to_string(&mut passphrase));\n     }\n \n@@ -364,7 +353,6 @@ impl Builder {\n         self.lldb_git_commit_hash = self.git_commit_hash(\"lldb\", \"x86_64-unknown-linux-gnu\");\n         self.miri_git_commit_hash = self.git_commit_hash(\"miri\", \"x86_64-unknown-linux-gnu\");\n \n-        self.check_toolstate();\n         self.digest_and_sign();\n         let manifest = self.build_manifest();\n         self.write_channel_files(&self.rust_release, &manifest);\n@@ -374,37 +362,6 @@ impl Builder {\n         }\n     }\n \n-    /// If a tool does not pass its tests, don't ship it.\n-    /// Right now, we do this only for Miri.\n-    fn check_toolstate(&mut self) {\n-        // Get the toolstate for this rust revision.\n-        let rev = self.rust_git_commit_hash.as_ref().expect(\"failed to determine rust git hash\");\n-        let toolstates = reqwest::get(TOOLSTATE).expect(\"failed to get toolstates\");\n-        let toolstates = BufReader::new(toolstates);\n-        let toolstate = toolstates.lines()\n-            .find_map(|line| {\n-                let line = line.expect(\"failed to read toolstate lines\");\n-                let mut pieces = line.splitn(2, '\\t');\n-                let commit = pieces.next().expect(\"malformed toolstate line\");\n-                if commit != rev {\n-                    // Not the right commit.\n-                    return None;\n-                }\n-                // Return the 2nd piece, the JSON.\n-                Some(pieces.next().expect(\"malformed toolstate line\").to_owned())\n-            })\n-            .expect(\"failed to find toolstate for rust commit\");\n-        let toolstate: HashMap<String, String> =\n-            serde_json::from_str(&toolstate).expect(\"toolstate is malformed JSON\");\n-        // Mark some tools as missing based on toolstate.\n-        if toolstate.get(\"miri\").map(|s| &*s as &str) != Some(\"test-pass\") {\n-            println!(\"Miri tests are not passing, removing component\");\n-            self.miri_version = None;\n-            self.miri_git_commit_hash = None;\n-        }\n-    }\n-\n-    /// Hash all files, compute their signatures, and collect the hashes in `self.digests`.\n     fn digest_and_sign(&mut self) {\n         for file in t!(self.input.read_dir()).map(|e| t!(e).path()) {\n             let filename = file.file_name().unwrap().to_str().unwrap();\n@@ -575,20 +532,19 @@ impl Builder {\n             .as_ref()\n             .cloned()\n             .map(|version| (version, true))\n-            .unwrap_or_default(); // `is_present` defaults to `false` here.\n+            .unwrap_or_default();\n \n-        // Miri is nightly-only; never ship it for other trains.\n+        // miri needs to build std with xargo, which doesn't allow stable/beta:\n+        // <https://github.com/japaric/xargo/pull/204#issuecomment-374888868>\n         if pkgname == \"miri-preview\" && self.rust_release != \"nightly\" {\n-            is_present = false; // Pretend the component is entirely missing.\n+            is_present = false; // ignore it\n         }\n \n         let targets = targets.iter().map(|name| {\n             if is_present {\n-                // The component generally exists, but it might still be missing for this target.\n                 let filename = self.filename(pkgname, name);\n                 let digest = match self.digests.remove(&filename) {\n                     Some(digest) => digest,\n-                    // This component does not exist for this target -- skip it.\n                     None => return (name.to_string(), Target::unavailable()),\n                 };\n                 let xz_filename = filename.replace(\".tar.gz\", \".tar.xz\");"}]}