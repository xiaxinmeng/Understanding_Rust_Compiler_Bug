{"sha": "5dafcc24e46a05713c47235d51ac2d50c7899feb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVkYWZjYzI0ZTQ2YTA1NzEzYzQ3MjM1ZDUxYWMyZDUwYzc4OTlmZWI=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-08-23T14:20:32Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-08-24T13:29:56Z"}, "message": "Add merge_derives config option", "tree": {"sha": "45d9ef1a166facb7778758650c43935a81c1e5cb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45d9ef1a166facb7778758650c43935a81c1e5cb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5dafcc24e46a05713c47235d51ac2d50c7899feb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5dafcc24e46a05713c47235d51ac2d50c7899feb", "html_url": "https://github.com/rust-lang/rust/commit/5dafcc24e46a05713c47235d51ac2d50c7899feb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5dafcc24e46a05713c47235d51ac2d50c7899feb/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba6121c4e251d927f52b498f0d50ab5c0748051d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba6121c4e251d927f52b498f0d50ab5c0748051d", "html_url": "https://github.com/rust-lang/rust/commit/ba6121c4e251d927f52b498f0d50ab5c0748051d"}], "stats": {"total": 113, "additions": 99, "deletions": 14}, "files": [{"sha": "373447bf24f605fbd3f63dcc655af8d3dcab4176", "filename": "Configurations.md", "status": "modified", "additions": 36, "deletions": 10, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/5dafcc24e46a05713c47235d51ac2d50c7899feb/Configurations.md", "raw_url": "https://github.com/rust-lang/rust/raw/5dafcc24e46a05713c47235d51ac2d50c7899feb/Configurations.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Configurations.md?ref=5dafcc24e46a05713c47235d51ac2d50c7899feb", "patch": "@@ -1230,7 +1230,7 @@ Put a match sub-patterns' separator (`|`) in front or back.\n - **Default value**: `\"Back\"`\n - **Possible values**: `\"Back\"`, `\"Front\"`\n \n-#### `\"Back\"`\n+#### `\"Back\"`:\n \n ```rust\n match m {\n@@ -1243,7 +1243,7 @@ match m {\n }\n ```\n \n-#### `Front`\n+#### `Front`:\n \n ```rust\n match m {\n@@ -1265,25 +1265,42 @@ Maximum width of each line\n \n See also [`error_on_line_overflow`](#error_on_line_overflow).\n \n-## `multiline_closure_forces_block`\n+## `merge_derives`\n \n-Force multiline closure bodies to be wrapped in a block\n+Merge multiple derives into a single one.\n \n-- **Default value**: `false`\n-- **Possible values**: `false`, `true`\n+- **Default value**: `true`\n+- **Possible values**: `true`, `false`\n+\n+*Note*: The merged derives will be put after all other attributes or doc comments.\n+\n+#### `true`:\n+\n+```rust\n+#[derive(Eq, PartialEq, Debug, Copy, Clone)]\n+pub enum Foo {}\n+```\n \n #### `false`:\n \n ```rust\n-result.and_then(|maybe_value| match maybe_value {\n-    None => ...,\n-    Some(value) => ...,\n-})\n+#[derive(Eq, PartialEq)]\n+#[derive(Debug)]\n+#[derive(Copy, Clone)]\n+pub enum Foo {}\n ```\n \n+## `multiline_closure_forces_block`\n+\n+Force multiline closure bodies to be wrapped in a block\n+\n+- **Default value**: `false`\n+- **Possible values**: `false`, `true`\n+\n #### `true`:\n \n ```rust\n+\n result.and_then(|maybe_value| {\n     match maybe_value {\n         None => ...,\n@@ -1292,6 +1309,15 @@ result.and_then(|maybe_value| {\n })\n ```\n \n+#### `false`:\n+\n+```rust\n+result.and_then(|maybe_value| match maybe_value {\n+    None => ...,\n+    Some(value) => ...,\n+})\n+```\n+\n ## `multiline_match_arm_forces_block`\n \n Force multiline match arm bodies to be wrapped in a block"}, {"sha": "31eccf2494195367658a608959ea7513ac9cf462", "filename": "src/config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5dafcc24e46a05713c47235d51ac2d50c7899feb/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dafcc24e46a05713c47235d51ac2d50c7899feb/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=5dafcc24e46a05713c47235d51ac2d50c7899feb", "patch": "@@ -619,6 +619,7 @@ create_config! {\n         \"Force multiline closure bodies to be wrapped in a block\";\n     multiline_match_arm_forces_block: bool, false,\n         \"Force multiline match arm bodies to be wrapped in a block\";\n+    merge_derives: bool, true, \"Merge multiple `#[derive(...)]` into a single one\";\n }\n \n #[cfg(test)]"}, {"sha": "8787850634e48af4e557fc3899395873930e3bb2", "filename": "src/lists.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5dafcc24e46a05713c47235d51ac2d50c7899feb/src%2Flists.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dafcc24e46a05713c47235d51ac2d50c7899feb/src%2Flists.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flists.rs?ref=5dafcc24e46a05713c47235d51ac2d50c7899feb", "patch": "@@ -19,10 +19,10 @@ use config::{Config, IndentStyle};\n use rewrite::RewriteContext;\n use utils::{first_line_width, last_line_width, mk_sp};\n \n-#[derive(Eq, PartialEq, Debug, Copy, Clone)]\n /// Formatting tactic for lists. This will be cast down to a\n /// DefinitiveListTactic depending on the number and length of the items and\n /// their comments.\n+#[derive(Eq, PartialEq, Debug, Copy, Clone)]\n pub enum ListTactic {\n     // One item per row.\n     Vertical,\n@@ -144,8 +144,8 @@ impl ListItem {\n     }\n }\n \n-#[derive(Eq, PartialEq, Debug, Copy, Clone)]\n /// The definitive formatting tactic for lists.\n+#[derive(Eq, PartialEq, Debug, Copy, Clone)]\n pub enum DefinitiveListTactic {\n     Vertical,\n     Horizontal,"}, {"sha": "b0df0bcaf9bfcf195e31747e42c0134a01a78d68", "filename": "src/visitor.rs", "status": "modified", "additions": 42, "deletions": 2, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/5dafcc24e46a05713c47235d51ac2d50c7899feb/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dafcc24e46a05713c47235d51ac2d50c7899feb/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=5dafcc24e46a05713c47235d51ac2d50c7899feb", "patch": "@@ -925,6 +925,8 @@ impl<'a> Rewrite for [ast::Attribute] {\n         }\n         let indent = shape.indent.to_string(context.config);\n \n+        let mut derive_args = Vec::new();\n+\n         for (i, a) in self.iter().enumerate() {\n             let a_str = try_opt!(a.rewrite(context, shape));\n \n@@ -956,13 +958,51 @@ impl<'a> Rewrite for [ast::Attribute] {\n             }\n \n             // Write the attribute itself.\n-            result.push_str(&a_str);\n+            if context.config.merge_derives() {\n+                if let Some(mut args) = get_derive_args(context, a) {\n+                    // If the attribute is `#[derive(...)]`, take the arguments and skip rewriting.\n+                    // We will merge the all arguments into a single `#[derive(...)]` at last.\n+                    derive_args.append(&mut args);\n+                } else {\n+                    result.push_str(&a_str);\n+\n+                    if i < self.len() - 1 {\n+                        result.push('\\n');\n+                    }\n+                }\n+            } else {\n+                result.push_str(&a_str);\n \n-            if i < self.len() - 1 {\n+                if i < self.len() - 1 {\n+                    result.push('\\n');\n+                }\n+            }\n+        }\n+\n+        // Add merged `#[derive(...)]` at last.\n+        if context.config.merge_derives() && !derive_args.is_empty() {\n+            if !result.is_empty() && !result.ends_with('\\n') {\n+                result.push_str(&indent);\n                 result.push('\\n');\n             }\n+            result.push_str(&format!(\"#[derive({})]\", derive_args.join(\", \")));\n         }\n \n         Some(result)\n     }\n }\n+\n+/// Returns the arguments of `#[derive(...)]`.\n+fn get_derive_args(context: &RewriteContext, attr: &ast::Attribute) -> Option<Vec<String>> {\n+    attr.meta().and_then(|meta_item| match meta_item.node {\n+        ast::MetaItemKind::List(ref args) if meta_item.name.as_str() == \"derive\" => {\n+            // Every argument of `derive` should be `NestedMetaItemKind::Literal`.\n+            Some(\n+                args.iter()\n+                    .map(|a| context.snippet(a.span))\n+                    .collect::<Vec<_>>(),\n+            )\n+        }\n+        _ => None,\n+    })\n+}"}, {"sha": "804a48c43c056802b4039e91b2705a861caf2128", "filename": "tests/source/configs-merge_derives-true.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5dafcc24e46a05713c47235d51ac2d50c7899feb/tests%2Fsource%2Fconfigs-merge_derives-true.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dafcc24e46a05713c47235d51ac2d50c7899feb/tests%2Fsource%2Fconfigs-merge_derives-true.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fconfigs-merge_derives-true.rs?ref=5dafcc24e46a05713c47235d51ac2d50c7899feb", "patch": "@@ -0,0 +1,10 @@\n+// rustfmt-merge_derives: true\n+// Merge multiple derives to a single one.\n+\n+#[bar]\n+#[derive(Eq, PartialEq)]\n+#[foo]\n+#[derive(Debug)]\n+#[foobar]\n+#[derive(Copy, Clone)]\n+pub enum Foo {}"}, {"sha": "8cf7b9a346d2766460a2806e5701f5e1cd5ad508", "filename": "tests/target/configs-merge_derives-true.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5dafcc24e46a05713c47235d51ac2d50c7899feb/tests%2Ftarget%2Fconfigs-merge_derives-true.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5dafcc24e46a05713c47235d51ac2d50c7899feb/tests%2Ftarget%2Fconfigs-merge_derives-true.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fconfigs-merge_derives-true.rs?ref=5dafcc24e46a05713c47235d51ac2d50c7899feb", "patch": "@@ -0,0 +1,8 @@\n+// rustfmt-merge_derives: true\n+// Merge multiple derives to a single one.\n+\n+#[bar]\n+#[foo]\n+#[foobar]\n+#[derive(Eq, PartialEq, Debug, Copy, Clone)]\n+pub enum Foo {}"}]}