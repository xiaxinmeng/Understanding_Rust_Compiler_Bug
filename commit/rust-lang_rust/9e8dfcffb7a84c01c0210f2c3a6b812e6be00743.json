{"sha": "9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "node_id": "C_kwDOAAsO6NoAKDllOGRmY2ZmYjdhODRjMDFjMDIxMGYyYzNhNmI4MTJlNmJlMDA3NDM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-11-28T09:42:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-28T09:42:39Z"}, "message": "Rollup merge of #91254 - Aaron1011:impl-candidate-err-ty, r=lcnr\n\nOnly check for errors in predicate when skipping impl assembly\n\nPrior to PR #91205, checking for errors in the overall obligation\nwould check checking the `ParamEnv`, due to an incorrect\n`super_visit_with` impl. With this bug fixed, we will now\nbail out of impl candidate assembly if the `ParamEnv` contains\nany error types.\n\nIn practice, this appears to be overly conservative - when an error\noccurs early in compilation, we end up giving up early for some\npredicates that we could have successfully evaluated without overflow.\nBy only checking for errors in the predicate itself, we avoid causing\nadditional spurious 'type annotations needed' errors after a 'real'\nerror has already occurred.\n\nWith this PR, the diagnostic changes caused by PR #91205 are reverted.", "tree": {"sha": "a38dfe053795d01e0ecd6df10fa611ad149b6f56", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a38dfe053795d01e0ecd6df10fa611ad149b6f56"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJho08PCRBK7hj4Ov3rIwAADYsIAJnnwl7T/s75WFyhjhIRtAHU\nLGrKHYdN7Erc3/zMKpnjJdGDnOVeOsRXarVCVkpV79mEQWR0zfWXBe1t5oP5cjKc\nVcVNNFV6ufs4C0GQOLn6Vwc4FzZ4rxTfb8Ej1gjiotcrjDq6BuyeHIFJEr7r439K\nX/nLYWFQ+MyLopHfRP4UTg3060tsUojmTyEW4u4lnc/OMjeGjuiIjmrMs3ZxECeW\n0gt30072NP7icb0YB8GN30uK43dAwSXdmlr35h0pwyLe0FEZ8oVcWVJ4x4ziDF22\nQPuNgNYI+sS6tsx7ajLVcCbkKOutrlSwHXQQJYxdBL2BnHnhAFxOS0fklwhdOD8=\n=C1CQ\n-----END PGP SIGNATURE-----\n", "payload": "tree a38dfe053795d01e0ecd6df10fa611ad149b6f56\nparent af0cf347875b696a1f01634e9a761bbccccd1de6\nparent d18065d9978fd8c961d3cb58a6b22b9c33ba6dc8\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1638092559 +0100\ncommitter GitHub <noreply@github.com> 1638092559 +0100\n\nRollup merge of #91254 - Aaron1011:impl-candidate-err-ty, r=lcnr\n\nOnly check for errors in predicate when skipping impl assembly\n\nPrior to PR #91205, checking for errors in the overall obligation\nwould check checking the `ParamEnv`, due to an incorrect\n`super_visit_with` impl. With this bug fixed, we will now\nbail out of impl candidate assembly if the `ParamEnv` contains\nany error types.\n\nIn practice, this appears to be overly conservative - when an error\noccurs early in compilation, we end up giving up early for some\npredicates that we could have successfully evaluated without overflow.\nBy only checking for errors in the predicate itself, we avoid causing\nadditional spurious 'type annotations needed' errors after a 'real'\nerror has already occurred.\n\nWith this PR, the diagnostic changes caused by PR #91205 are reverted.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "html_url": "https://github.com/rust-lang/rust/commit/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "af0cf347875b696a1f01634e9a761bbccccd1de6", "url": "https://api.github.com/repos/rust-lang/rust/commits/af0cf347875b696a1f01634e9a761bbccccd1de6", "html_url": "https://github.com/rust-lang/rust/commit/af0cf347875b696a1f01634e9a761bbccccd1de6"}, {"sha": "d18065d9978fd8c961d3cb58a6b22b9c33ba6dc8", "url": "https://api.github.com/repos/rust-lang/rust/commits/d18065d9978fd8c961d3cb58a6b22b9c33ba6dc8", "html_url": "https://github.com/rust-lang/rust/commit/d18065d9978fd8c961d3cb58a6b22b9c33ba6dc8"}], "stats": {"total": 60, "additions": 28, "deletions": 32}, "files": [{"sha": "6e3e3b9b14480d383fdad71dd9a6829647b5b61f", "filename": "compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs?ref=9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "patch": "@@ -536,7 +536,10 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         // This helps us avoid overflow: see issue #72839\n         // Since compilation is already guaranteed to fail, this is just\n         // to try to show the 'nicest' possible errors to the user.\n-        if obligation.references_error() {\n+        // We don't check for errors in the `ParamEnv` - in practice,\n+        // it seems to cause us to be overly aggressive in deciding\n+        // to give up searching for candidates, leading to spurious errors.\n+        if obligation.predicate.references_error() {\n             return;\n         }\n "}, {"sha": "02dce4f7a97e829d1f886d0a8025a41a77d81e64", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-72787.min.stderr", "status": "modified", "additions": 7, "deletions": 15, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-72787.min.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-72787.min.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-72787.min.stderr?ref=9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "patch": "@@ -1,5 +1,5 @@\n error: generic parameters may not be used in const operations\n-  --> $DIR/issue-72787.rs:12:17\n+  --> $DIR/issue-72787.rs:11:17\n    |\n LL |     Condition<{ LHS <= RHS }>: True\n    |                 ^^^ cannot perform const operation using `LHS`\n@@ -8,7 +8,7 @@ LL |     Condition<{ LHS <= RHS }>: True\n    = help: use `#![feature(generic_const_exprs)]` to allow generic const expressions\n \n error: generic parameters may not be used in const operations\n-  --> $DIR/issue-72787.rs:12:24\n+  --> $DIR/issue-72787.rs:11:24\n    |\n LL |     Condition<{ LHS <= RHS }>: True\n    |                        ^^^ cannot perform const operation using `RHS`\n@@ -17,7 +17,7 @@ LL |     Condition<{ LHS <= RHS }>: True\n    = help: use `#![feature(generic_const_exprs)]` to allow generic const expressions\n \n error: generic parameters may not be used in const operations\n-  --> $DIR/issue-72787.rs:26:25\n+  --> $DIR/issue-72787.rs:25:25\n    |\n LL |     IsLessOrEqual<{ 8 - I }, { 8 - J }>: True,\n    |                         ^ cannot perform const operation using `I`\n@@ -26,7 +26,7 @@ LL |     IsLessOrEqual<{ 8 - I }, { 8 - J }>: True,\n    = help: use `#![feature(generic_const_exprs)]` to allow generic const expressions\n \n error: generic parameters may not be used in const operations\n-  --> $DIR/issue-72787.rs:26:36\n+  --> $DIR/issue-72787.rs:25:36\n    |\n LL |     IsLessOrEqual<{ 8 - I }, { 8 - J }>: True,\n    |                                    ^ cannot perform const operation using `J`\n@@ -35,29 +35,21 @@ LL |     IsLessOrEqual<{ 8 - I }, { 8 - J }>: True,\n    = help: use `#![feature(generic_const_exprs)]` to allow generic const expressions\n \n error[E0283]: type annotations needed\n-  --> $DIR/issue-72787.rs:10:38\n-   |\n-LL | impl<const LHS: u32, const RHS: u32> True for IsLessOrEqual<LHS, RHS> where\n-   |                                      ^^^^ cannot infer type for struct `IsLessOrEqual<LHS, RHS>`\n-   |\n-   = note: cannot satisfy `IsLessOrEqual<LHS, RHS>: True`\n-\n-error[E0283]: type annotations needed\n-  --> $DIR/issue-72787.rs:22:26\n+  --> $DIR/issue-72787.rs:21:26\n    |\n LL |     IsLessOrEqual<I, 8>: True,\n    |                          ^^^^ cannot infer type for struct `IsLessOrEqual<I, 8_u32>`\n    |\n    = note: cannot satisfy `IsLessOrEqual<I, 8_u32>: True`\n \n error[E0283]: type annotations needed\n-  --> $DIR/issue-72787.rs:22:26\n+  --> $DIR/issue-72787.rs:21:26\n    |\n LL |     IsLessOrEqual<I, 8>: True,\n    |                          ^^^^ cannot infer type for struct `IsLessOrEqual<I, 8_u32>`\n    |\n    = note: cannot satisfy `IsLessOrEqual<I, 8_u32>: True`\n \n-error: aborting due to 7 previous errors\n+error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0283`."}, {"sha": "77ad57f0640fa03260dec80aa3e95bc2f706493c", "filename": "src/test/ui/const-generics/generic_const_exprs/issue-72787.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-72787.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-72787.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fgeneric_const_exprs%2Fissue-72787.rs?ref=9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "patch": "@@ -8,7 +8,6 @@ pub struct Condition<const CONDITION: bool>;\n pub trait True {}\n \n impl<const LHS: u32, const RHS: u32> True for IsLessOrEqual<LHS, RHS> where\n-//[min]~^ ERROR type annotations needed\n     Condition<{ LHS <= RHS }>: True\n //[min]~^ Error generic parameters may not be used in const operations\n //[min]~| Error generic parameters may not be used in const operations"}, {"sha": "966d76d148af3f69d901198d4955d3b4654d769a", "filename": "src/test/ui/issues/issue-77919.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fissues%2Fissue-77919.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fissues%2Fissue-77919.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-77919.rs?ref=9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "patch": "@@ -10,4 +10,4 @@ struct Multiply<N, M> {\n }\n impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n //~^ ERROR cannot find type `VAL` in this scope\n-//~| ERROR type annotations needed\n+//~| ERROR not all trait items implemented, missing: `VAL`"}, {"sha": "97bd5ab36b65d176d2e4ab0fb8580f0d2342dde0", "filename": "src/test/ui/issues/issue-77919.stderr", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fissues%2Fissue-77919.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftest%2Fui%2Fissues%2Fissue-77919.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-77919.stderr?ref=9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "patch": "@@ -17,15 +17,16 @@ LL | impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n    |          |\n    |          help: you might be missing a type parameter: `, VAL`\n \n-error[E0283]: type annotations needed\n-  --> $DIR/issue-77919.rs:11:12\n+error[E0046]: not all trait items implemented, missing: `VAL`\n+  --> $DIR/issue-77919.rs:11:1\n    |\n+LL |     const VAL: T;\n+   |     ------------- `VAL` from trait\n+...\n LL | impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n-   |            ^^^^^^^^^^^^^^ cannot infer type for struct `Multiply<N, M>`\n-   |\n-   = note: cannot satisfy `Multiply<N, M>: TypeVal<usize>`\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ missing `VAL` in implementation\n \n error: aborting due to 3 previous errors\n \n-Some errors have detailed explanations: E0283, E0412.\n-For more information about an error, try `rustc --explain E0283`.\n+Some errors have detailed explanations: E0046, E0412.\n+For more information about an error, try `rustc --explain E0046`."}, {"sha": "c8239897f3abb5b7032d8f574aeae103599b1e71", "filename": "src/tools/clippy/tests/ui/crashes/ice-6252.stderr", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fcrashes%2Fice-6252.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9e8dfcffb7a84c01c0210f2c3a6b812e6be00743/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fcrashes%2Fice-6252.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fcrashes%2Fice-6252.stderr?ref=9e8dfcffb7a84c01c0210f2c3a6b812e6be00743", "patch": "@@ -21,15 +21,16 @@ LL | impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n    |          |\n    |          help: you might be missing a type parameter: `, VAL`\n \n-error[E0283]: type annotations needed\n-  --> $DIR/ice-6252.rs:10:12\n+error[E0046]: not all trait items implemented, missing: `VAL`\n+  --> $DIR/ice-6252.rs:10:1\n    |\n+LL |     const VAL: T;\n+   |     ------------- `VAL` from trait\n+...\n LL | impl<N, M> TypeVal<usize> for Multiply<N, M> where N: TypeVal<VAL> {}\n-   |            ^^^^^^^^^^^^^^ cannot infer type for struct `Multiply<N, M>`\n-   |\n-   = note: cannot satisfy `Multiply<N, M>: TypeVal<usize>`\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ missing `VAL` in implementation\n \n error: aborting due to 3 previous errors\n \n-Some errors have detailed explanations: E0283, E0412.\n-For more information about an error, try `rustc --explain E0283`.\n+Some errors have detailed explanations: E0046, E0412.\n+For more information about an error, try `rustc --explain E0046`."}]}