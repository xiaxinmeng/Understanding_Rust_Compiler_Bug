{"sha": "814d617d348c23507fd444e58515c9bff6b73105", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxNGQ2MTdkMzQ4YzIzNTA3ZmQ0NDRlNTg1MTVjOWJmZjZiNzMxMDU=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-03-09T15:33:41Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-03-09T16:18:50Z"}, "message": "Show whether a binding is mutable or not on hover", "tree": {"sha": "5c722ffc17e90f76b2ea479ac2d67429380d7d04", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5c722ffc17e90f76b2ea479ac2d67429380d7d04"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/814d617d348c23507fd444e58515c9bff6b73105", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/814d617d348c23507fd444e58515c9bff6b73105", "html_url": "https://github.com/rust-lang/rust/commit/814d617d348c23507fd444e58515c9bff6b73105", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/814d617d348c23507fd444e58515c9bff6b73105/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "983726a45cf3daafbf4b245e220773bd12897bb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/983726a45cf3daafbf4b245e220773bd12897bb7", "html_url": "https://github.com/rust-lang/rust/commit/983726a45cf3daafbf4b245e220773bd12897bb7"}], "stats": {"total": 75, "additions": 47, "deletions": 28}, "files": [{"sha": "caf4c3395c5cba2101036d86c40c8d51324625e2", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/814d617d348c23507fd444e58515c9bff6b73105/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/814d617d348c23507fd444e58515c9bff6b73105/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=814d617d348c23507fd444e58515c9bff6b73105", "patch": "@@ -1296,13 +1296,7 @@ impl Local {\n \n     pub fn is_mut(self, db: &dyn HirDatabase) -> bool {\n         let body = db.body(self.parent.into());\n-        match &body[self.pat_id] {\n-            Pat::Bind { mode, .. } => match mode {\n-                BindingAnnotation::Mutable | BindingAnnotation::RefMut => true,\n-                _ => false,\n-            },\n-            _ => false,\n-        }\n+        matches!(&body[self.pat_id], Pat::Bind { mode: BindingAnnotation::Mutable, .. })\n     }\n \n     pub fn parent(self, _db: &dyn HirDatabase) -> DefWithBody {"}, {"sha": "ea45086ce8fc9408bcfe61c98c9ee4755916781d", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 43, "deletions": 19, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/814d617d348c23507fd444e58515c9bff6b73105/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/814d617d348c23507fd444e58515c9bff6b73105/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=814d617d348c23507fd444e58515c9bff6b73105", "patch": "@@ -1,3 +1,4 @@\n+use either::Either;\n use hir::{\n     Adt, AsAssocItem, AssocItemContainer, FieldSource, GenericParam, HasAttrs, HasSource,\n     HirDisplay, Module, ModuleDef, ModuleSource, Semantics,\n@@ -366,7 +367,7 @@ fn hover_for_definition(\n                 .and_then(|fd| hover_for_builtin(fd, it))\n                 .or_else(|| Some(Markup::fenced_block(&it.name()))),\n         },\n-        Definition::Local(it) => Some(Markup::fenced_block(&it.ty(db).display(db))),\n+        Definition::Local(it) => hover_for_local(it, db),\n         Definition::SelfType(impl_def) => {\n             impl_def.target_ty(db).as_adt().and_then(|adt| match adt {\n                 Adt::Struct(it) => from_def_source(db, it, mod_path),\n@@ -405,6 +406,29 @@ fn hover_for_definition(\n     }\n }\n \n+fn hover_for_local(it: hir::Local, db: &RootDatabase) -> Option<Markup> {\n+    let ty = it.ty(db);\n+    let ty = ty.display(db);\n+    let is_mut = if it.is_mut(db) { \"mut \" } else { \"\" };\n+    let desc = match it.source(db).value {\n+        Either::Left(ident) => {\n+            let name = it.name(db).unwrap();\n+            let let_kw = if ident\n+                .syntax()\n+                .parent()\n+                .map_or(false, |p| p.kind() == LET_STMT || p.kind() == CONDITION)\n+            {\n+                \"let \"\n+            } else {\n+                \"\"\n+            };\n+            format!(\"{}{}{}: {}\", let_kw, is_mut, name, ty)\n+        }\n+        Either::Right(_) => format!(\"{}self: {}\", is_mut, ty),\n+    };\n+    hover_markup(None, Some(desc), None)\n+}\n+\n fn hover_for_keyword(\n     sema: &Semantics<RootDatabase>,\n     links_in_hover: bool,\n@@ -574,7 +598,7 @@ fn main() {\n                 *iter*\n \n                 ```rust\n-                Iter<Scan<OtherStruct<OtherStruct<i32>>, |&mut u32, &u32, &mut u32| -> Option<u32>, u32>>\n+                let mut iter: Iter<Scan<OtherStruct<OtherStruct<i32>>, |&mut u32, &u32, &mut u32| -> Option<u32>, u32>>\n                 ```\n             \"#]],\n         );\n@@ -798,7 +822,7 @@ fn main() {\n                 ```\n \n                 ```rust\n-                const foo: u32 = 123\n+                const foo: u32\n                 ```\n             \"#]],\n         );\n@@ -831,7 +855,7 @@ fn main() {\n                 *zz*\n \n                 ```rust\n-                Test<i32, u8>\n+                let zz: Test<i32, u8>\n                 ```\n             \"#]],\n         );\n@@ -870,7 +894,7 @@ fn main() { let b$0ar = Some(12); }\n                 *bar*\n \n                 ```rust\n-                Option<i32>\n+                let bar: Option<i32>\n                 ```\n             \"#]],\n         );\n@@ -938,7 +962,7 @@ fn main() {\n                 *foo*\n \n                 ```rust\n-                i32\n+                foo: i32\n                 ```\n             \"#]],\n         )\n@@ -952,7 +976,7 @@ fn main() {\n                 *foo*\n \n                 ```rust\n-                i32\n+                foo: i32\n                 ```\n             \"#]],\n         )\n@@ -966,7 +990,7 @@ fn main() {\n                 *foo*\n \n                 ```rust\n-                i32\n+                foo: i32\n                 ```\n             \"#]],\n         )\n@@ -980,7 +1004,7 @@ fn main() {\n                 *foo*\n \n                 ```rust\n-                i32\n+                foo: i32\n                 ```\n             \"#]],\n         )\n@@ -1000,7 +1024,7 @@ fn main() {\n                 *_x*\n \n                 ```rust\n-                impl Deref<Target = u8> + DerefMut<Target = u8>\n+                _x: impl Deref<Target = u8> + DerefMut<Target = u8>\n                 ```\n             \"#]],\n         )\n@@ -1022,7 +1046,7 @@ fn main() { let foo_$0test = Thing::new(); }\n                 *foo_test*\n \n                 ```rust\n-                Thing\n+                let foo_test: Thing\n                 ```\n             \"#]],\n         )\n@@ -1081,7 +1105,7 @@ fn main() {\n                 ```\n \n                 ```rust\n-                const C: u32 = 1\n+                const C: u32\n                 ```\n             \"#]],\n         )\n@@ -1182,7 +1206,7 @@ fn y() {\n                 *x*\n \n                 ```rust\n-                i32\n+                let x: i32\n                 ```\n             \"#]],\n         )\n@@ -1259,7 +1283,7 @@ fn foo(bar:u32) { let a = id!(ba$0r); }\n                 *bar*\n \n                 ```rust\n-                u32\n+                bar: u32\n                 ```\n             \"#]],\n         );\n@@ -1277,7 +1301,7 @@ fn foo(bar:u32) { let a = id!(ba$0r); }\n                 *bar*\n \n                 ```rust\n-                u32\n+                bar: u32\n                 ```\n             \"#]],\n         );\n@@ -3302,7 +3326,7 @@ fn main() {\n                 *f*\n \n                 ```rust\n-                &i32\n+                f: &i32\n                 ```\n             \"#]],\n         );\n@@ -3321,7 +3345,7 @@ impl Foo {\n                 *self*\n \n                 ```rust\n-                &Foo\n+                self: &Foo\n                 ```\n             \"#]],\n         );\n@@ -3341,7 +3365,7 @@ impl Foo {\n                 *self*\n \n                 ```rust\n-                Arc<Foo>\n+                self: Arc<Foo>\n                 ```\n             \"#]],\n         );\n@@ -3537,7 +3561,7 @@ fn foo() {\n                 ```\n \n                 ```rust\n-                const FOO: usize = 3\n+                const FOO: usize\n                 ```\n \n                 ---"}, {"sha": "b0cfdd8b7dc5721e773dbbf4957dab707a203f37", "filename": "crates/ide/src/syntax_highlighting/highlight.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/814d617d348c23507fd444e58515c9bff6b73105/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/814d617d348c23507fd444e58515c9bff6b73105/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Fhighlight.rs?ref=814d617d348c23507fd444e58515c9bff6b73105", "patch": "@@ -330,10 +330,11 @@ fn highlight_def(db: &RootDatabase, def: Definition) -> Highlight {\n                 HlTag::Symbol(SymbolKind::Local)\n             };\n             let mut h = Highlight::new(tag);\n-            if local.is_mut(db) || local.ty(db).is_mutable_reference() {\n+            let ty = local.ty(db);\n+            if local.is_mut(db) || ty.is_mutable_reference() {\n                 h |= HlMod::Mutable;\n             }\n-            if local.ty(db).as_callable(db).is_some() || local.ty(db).impls_fnonce(db) {\n+            if ty.as_callable(db).is_some() || ty.impls_fnonce(db) {\n                 h |= HlMod::Callable;\n             }\n             return h;"}]}