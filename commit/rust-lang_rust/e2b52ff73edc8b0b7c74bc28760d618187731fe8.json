{"sha": "e2b52ff73edc8b0b7c74bc28760d618187731fe8", "node_id": "C_kwDOAAsO6NoAKGUyYjUyZmY3M2VkYzhiMGI3Yzc0YmMyODc2MGQ2MTgxODc3MzFmZTg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-12T02:58:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-12T02:58:51Z"}, "message": "Auto merge of #99464 - nikic:llvm-15, r=cuviper\n\nUpdate to LLVM 15\n\nFor preliminary testing. Some LLVM 15 compatibility fixes were applied separately in #99512.\n\nRelease timeline:\n * LLVM 15 branched on Jul 26.\n * The final LLVM 15.0.0 release is scheduled for Sep 6.\n * Current nightly (1.65.0) is scheduled for Nov 3.\n\nChanges in this PR (apart from the LLVM update):\n * Pass `--set llvm.allow-old-toolchain` for many Docker images. LLVM 16 will require GCC >= 7.1, while LLVM 15 still allows older compilers with an option. Specify the option for builders still using GCC 5.4. #95026 updated some of the used toolchains, but not all.\n * Use the `+atomics-32` target feature for thumbv6m.\n * Explicitly link libatomic when cross-compiling LLVM to 32-bit target.\n * Explicitly disable zstd support, to avoid libzstd.so dependency.\n\nNew LLVM patches ([commits](https://github.com/rust-lang/llvm-project/commits/rustc/15.0-2022-08-09)):\n * [rust-only] Fix ICE with GCC 5.4 (https://github.com/nikic/llvm-project/commit/15be58d7f0342b1da5af219bac8bd71d01da6dff)\n * [rust-only] Fix build with GCC 5.4 (https://github.com/nikic/llvm-project/commit/774edc10fa45229c2aa678f1bef8b4812dc0f76a)\n * ~~[rust-only] Fix build with GCC 5.2 (https://github.com/nikic/llvm-project/commit/1a6069a7bb35ace1e40d566035cbf7ed2fa3b1f7)~~\n * ~~[rust-only] Fix ICE with GCC 5.2 (https://github.com/nikic/llvm-project/commit/493081f2909206e0ed55af68a4058a76c0ad7a64)~~\n * ~~[rust-only] Fix build with GCC 5.2 (https://github.com/nikic/llvm-project/commit/0fc5979d738c3a1f9510fe2d62417f7d2af37817)~~\n * [backported] Addition of `+atomics` target feature (https://github.com/llvm/llvm-project/commit/57bdd9892d0eba5bdd25fc44799235be7b9f5153).\n * [backported] Revert compiler-rt change that broke powerpc (https://github.com/llvm/llvm-project/commit/9c68b43915fc1c9c0a07e935163ae8d638d7241b)\n * [awaiting backport] Fix RelLookupTableConverter on gnux32 (https://github.com/nikic/llvm-project/commit/639388a05f25772fb23eea5b1045e7df83bcfaa7 / https://github.com/llvm/llvm-project/issues/57021)\n\nTested images: dist-x86_64-linux, armhf-gnu, arm-android, dist-s390x-linux, dist-x86_64-illumos, dist-x86_64-freebsd, wasm32, dist-x86_64-musl, dist-various-1, dist-riscv64-linux, dist-mips-linux, dist-mipsel-linux, dist-powerpc-linux, dist-aarch64-linux, dist-x86_64-apple, x86_64-msvc-1, x86_64-msvc-2, dist-various-2, dist-arm-linux\nTested up to the usual ipv6 error: test-various, i686-gnu, x86_64-gnu-nopt\n\nr? `@ghost`", "tree": {"sha": "1c205fc0e8ea9c4d60e1a860c7e6c566fd33a42a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1c205fc0e8ea9c4d60e1a860c7e6c566fd33a42a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2b52ff73edc8b0b7c74bc28760d618187731fe8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2b52ff73edc8b0b7c74bc28760d618187731fe8", "html_url": "https://github.com/rust-lang/rust/commit/e2b52ff73edc8b0b7c74bc28760d618187731fe8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2b52ff73edc8b0b7c74bc28760d618187731fe8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b998821e4c51c44a9ebee395c91323c374236bbb", "url": "https://api.github.com/repos/rust-lang/rust/commits/b998821e4c51c44a9ebee395c91323c374236bbb", "html_url": "https://github.com/rust-lang/rust/commit/b998821e4c51c44a9ebee395c91323c374236bbb"}, {"sha": "115dfe267efc0f3c6875906947c55a14f9c7a4a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/115dfe267efc0f3c6875906947c55a14f9c7a4a8", "html_url": "https://github.com/rust-lang/rust/commit/115dfe267efc0f3c6875906947c55a14f9c7a4a8"}], "stats": {"total": 101, "additions": 73, "deletions": 28}, "files": [{"sha": "ceda348025e364bff23cfdb24679939f8f7b8646", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -389,26 +389,26 @@ jobs:\n             os: windows-latest-xl\n           - name: i686-mingw-1\n             env:\n-              RUST_CONFIGURE_ARGS: \"--build=i686-pc-windows-gnu\"\n+              RUST_CONFIGURE_ARGS: \"--build=i686-pc-windows-gnu --set llvm.allow-old-toolchain\"\n               SCRIPT: make ci-mingw-subset-1\n               CUSTOM_MINGW: 1\n             os: windows-latest-xl\n           - name: i686-mingw-2\n             env:\n-              RUST_CONFIGURE_ARGS: \"--build=i686-pc-windows-gnu\"\n+              RUST_CONFIGURE_ARGS: \"--build=i686-pc-windows-gnu --set llvm.allow-old-toolchain\"\n               SCRIPT: make ci-mingw-subset-2\n               CUSTOM_MINGW: 1\n             os: windows-latest-xl\n           - name: x86_64-mingw-1\n             env:\n               SCRIPT: make ci-mingw-subset-1\n-              RUST_CONFIGURE_ARGS: \"--build=x86_64-pc-windows-gnu --enable-profiler\"\n+              RUST_CONFIGURE_ARGS: \"--build=x86_64-pc-windows-gnu --enable-profiler --set llvm.allow-old-toolchain\"\n               CUSTOM_MINGW: 1\n             os: windows-latest-xl\n           - name: x86_64-mingw-2\n             env:\n               SCRIPT: make ci-mingw-subset-2\n-              RUST_CONFIGURE_ARGS: \"--build=x86_64-pc-windows-gnu --enable-profiler\"\n+              RUST_CONFIGURE_ARGS: \"--build=x86_64-pc-windows-gnu --enable-profiler --set llvm.allow-old-toolchain\"\n               CUSTOM_MINGW: 1\n             os: windows-latest-xl\n           - name: dist-x86_64-msvc\n@@ -432,15 +432,15 @@ jobs:\n             os: windows-latest-xl\n           - name: dist-i686-mingw\n             env:\n-              RUST_CONFIGURE_ARGS: \"--build=i686-pc-windows-gnu --enable-full-tools --enable-profiler\"\n+              RUST_CONFIGURE_ARGS: \"--build=i686-pc-windows-gnu --enable-full-tools --enable-profiler --set llvm.allow-old-toolchain\"\n               SCRIPT: python x.py dist\n               CUSTOM_MINGW: 1\n               DIST_REQUIRE_ALL_TOOLS: 1\n             os: windows-latest-xl\n           - name: dist-x86_64-mingw\n             env:\n               SCRIPT: python x.py dist\n-              RUST_CONFIGURE_ARGS: \"--build=x86_64-pc-windows-gnu --enable-full-tools --enable-profiler\"\n+              RUST_CONFIGURE_ARGS: \"--build=x86_64-pc-windows-gnu --enable-full-tools --enable-profiler --set llvm.allow-old-toolchain\"\n               CUSTOM_MINGW: 1\n               DIST_REQUIRE_ALL_TOOLS: 1\n             os: windows-latest-xl"}, {"sha": "9a664b6509801d57df60313e0a43d01c839c97df", "filename": ".gitmodules", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/.gitmodules", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/.gitmodules", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitmodules?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -34,7 +34,7 @@\n [submodule \"src/llvm-project\"]\n \tpath = src/llvm-project\n \turl = https://github.com/rust-lang/llvm-project.git\n-\tbranch = rustc/14.0-2022-06-20\n+\tbranch = rustc/15.0-2022-08-09\n [submodule \"src/doc/embedded-book\"]\n \tpath = src/doc/embedded-book\n \turl = https://github.com/rust-embedded/book.git"}, {"sha": "96d238eda59d08d417a5910a505d8c5ea0f5bcde", "filename": "compiler/rustc_codegen_llvm/src/llvm_util.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -440,6 +440,8 @@ pub(crate) fn global_llvm_features(sess: &Session, diagnostics: bool) -> Vec<Str\n             .features\n             .split(',')\n             .filter(|v| !v.is_empty() && backend_feature_name(v).is_some())\n+            // Drop +atomics-32 feature introduced in LLVM 15.\n+            .filter(|v| *v != \"+atomics-32\" || get_version() >= (15, 0, 0))\n             .map(String::from),\n     );\n "}, {"sha": "abb68f3afe5274ec06f362c2e25e506326542b78", "filename": "compiler/rustc_llvm/build.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/compiler%2Frustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/compiler%2Frustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fbuild.rs?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -242,6 +242,13 @@ fn main() {\n         println!(\"cargo:rustc-link-lib=uuid\");\n     } else if target.contains(\"netbsd\") || target.contains(\"haiku\") || target.contains(\"darwin\") {\n         println!(\"cargo:rustc-link-lib=z\");\n+    } else if target.starts_with(\"arm\")\n+        || target.starts_with(\"mips-\")\n+        || target.starts_with(\"mipsel-\")\n+        || target.starts_with(\"powerpc-\")\n+    {\n+        // 32-bit targets need to link libatomic.\n+        println!(\"cargo:rustc-link-lib=atomic\");\n     }\n     cmd.args(&components);\n "}, {"sha": "c9bb0112f0e3d154498c817678207010722e9bb5", "filename": "compiler/rustc_target/src/spec/thumbv6m_none_eabi.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/compiler%2Frustc_target%2Fsrc%2Fspec%2Fthumbv6m_none_eabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/compiler%2Frustc_target%2Fsrc%2Fspec%2Fthumbv6m_none_eabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fthumbv6m_none_eabi.rs?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -13,7 +13,9 @@ pub fn target() -> Target {\n             abi: \"eabi\".into(),\n             // The ARMv6-M architecture doesn't support unaligned loads/stores so we disable them\n             // with +strict-align.\n-            features: \"+strict-align\".into(),\n+            // Also force-enable 32-bit atomics, which allows the use of atomic load/store only.\n+            // The resulting atomics are ABI incompatible with atomics backed by libatomic.\n+            features: \"+strict-align,+atomics-32\".into(),\n             // There are no atomic CAS instructions available in the instruction set of the ARMv6-M\n             // architecture\n             atomic_cas: false,"}, {"sha": "8b50d5dc52bc179ee08c33ef91dd76e37f556c0e", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -325,6 +325,9 @@ impl Step for Llvm {\n             cfg.define(\"LLVM_PROFDATA_FILE\", &path);\n         }\n \n+        // Disable zstd to avoid a dependency on libzstd.so.\n+        cfg.define(\"LLVM_ENABLE_ZSTD\", \"OFF\");\n+\n         if target != \"aarch64-apple-darwin\" && !target.contains(\"windows\") {\n             cfg.define(\"LLVM_ENABLE_ZLIB\", \"ON\");\n         } else {"}, {"sha": "a2335687ab33568266850d9437942656b0ae0f3d", "filename": "src/ci/docker/host-x86_64/arm-android/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -29,7 +29,8 @@ ENV PATH=$PATH:/android/sdk/platform-tools\n \n ENV TARGETS=arm-linux-androideabi\n \n-ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/arm-14\n+ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+    --set llvm.allow-old-toolchain\n \n ENV SCRIPT python3 ../x.py --stage 2 test --host='' --target $TARGETS\n "}, {"sha": "c98fa496d4861d22c274e17d3f38c2ca12fc7ccf", "filename": "src/ci/docker/host-x86_64/dist-android/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -32,7 +32,8 @@ ENV RUST_CONFIGURE_ARGS \\\n       --i686-linux-android-ndk=/android/ndk/x86-14 \\\n       --aarch64-linux-android-ndk=/android/ndk/arm64-21 \\\n       --x86_64-linux-android-ndk=/android/ndk/x86_64-21 \\\n-      --disable-docs\n+      --disable-docs \\\n+      --set llvm.allow-old-toolchain\n \n ENV SCRIPT python3 ../x.py dist --host='' --target $TARGETS\n "}, {"sha": "b0d65428ec6c488a7166e9f05108439cd95e2478", "filename": "src/ci/docker/host-x86_64/dist-i586-gnu-i586-i686-musl/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-i586-gnu-i586-i686-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-i586-gnu-i586-i686-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-i586-gnu-i586-i686-musl%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -36,7 +36,8 @@ RUN /scripts/cmake.sh\n ENV RUST_CONFIGURE_ARGS \\\n       --musl-root-i586=/musl-i586 \\\n       --musl-root-i686=/musl-i686 \\\n-      --disable-docs\n+      --disable-docs \\\n+      --set llvm.allow-old-toolchain\n \n # Newer binutils broke things on some vms/distros (i.e., linking against\n # unknown relocs disabled by the following flag), so we need to go out of our"}, {"sha": "948fa40dd4b13c0161c41637570f8a31c19d182b", "filename": "src/ci/docker/host-x86_64/dist-mips-linux/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips-linux%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -26,5 +26,6 @@ RUN /scripts/cmake.sh\n \n ENV HOSTS=mips-unknown-linux-gnu\n \n-ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py dist --host $HOSTS --target $HOSTS"}, {"sha": "fd15dbd22c6c279b807556067174458961a387fc", "filename": "src/ci/docker/host-x86_64/dist-mips64-linux/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips64-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips64-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips64-linux%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -25,5 +25,6 @@ RUN /scripts/cmake.sh\n \n ENV HOSTS=mips64-unknown-linux-gnuabi64\n \n-ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py dist --host $HOSTS --target $HOSTS"}, {"sha": "376bdfb4a2f4b6e1d80375e806a7cc510a418c5d", "filename": "src/ci/docker/host-x86_64/dist-mips64el-linux/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips64el-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips64el-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mips64el-linux%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -26,5 +26,6 @@ RUN /scripts/cmake.sh\n \n ENV HOSTS=mips64el-unknown-linux-gnuabi64\n \n-ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py dist --host $HOSTS --target $HOSTS"}, {"sha": "70c8b2a96c8c1e458582e32ce01bbf3c1d1596aa", "filename": "src/ci/docker/host-x86_64/dist-mipsel-linux/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mipsel-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mipsel-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-mipsel-linux%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -25,5 +25,6 @@ RUN /scripts/cmake.sh\n \n ENV HOSTS=mipsel-unknown-linux-gnu\n \n-ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py dist --host $HOSTS --target $HOSTS"}, {"sha": "fed4be4c30a74163893253a0f5f72d3e19d801b4", "filename": "src/ci/docker/host-x86_64/dist-x86_64-netbsd/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-netbsd%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-netbsd%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-netbsd%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -21,5 +21,6 @@ ENV \\\n \n ENV HOSTS=x86_64-unknown-netbsd\n \n-ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py dist --host $HOSTS --target $HOSTS"}, {"sha": "1f8d0a64ea48e0ecc380ea6411c21eea80ed36b2", "filename": "src/ci/docker/host-x86_64/i686-gnu-nopt/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu-nopt%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu-nopt%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu-nopt%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -27,6 +27,7 @@ RUN mkdir -p /config\n RUN echo \"[rust]\" > /config/nopt-std-config.toml\n RUN echo \"optimize = false\" >> /config/nopt-std-config.toml\n \n-ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu --disable-optimize-tests\n+ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu --disable-optimize-tests \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py test --stage 0 --config /config/nopt-std-config.toml library/std \\\n   && python3 ../x.py --stage 2 test"}, {"sha": "7bca0398dea7c6679bcf8e6286b2b5c116392340", "filename": "src/ci/docker/host-x86_64/i686-gnu/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -23,7 +23,8 @@ RUN sh /scripts/sccache.sh\n COPY scripts/cmake.sh /scripts/\n RUN /scripts/cmake.sh\n \n-ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu\n+ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu \\\n+    --set llvm.allow-old-toolchain\n # Exclude some tests that are unlikely to be platform specific, to speed up\n # this slow job.\n ENV SCRIPT python3 ../x.py --stage 2 test \\"}, {"sha": "bfc6975c19dc9b174e0b6deaf3ecb4beeb4ec474", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-aux/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-aux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-aux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-aux%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -26,5 +26,6 @@ RUN sh /scripts/sccache.sh\n COPY scripts/cmake.sh /scripts/\n RUN /scripts/cmake.sh\n \n-ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu\n+ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu \\\n+    --set llvm.allow-old-toolchain\n ENV RUST_CHECK_TARGET check-aux"}, {"sha": "4bb4042cd7e2ffa75a0986c2a7dd3a12dc560c35", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-distcheck/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-distcheck%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-distcheck%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-distcheck%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -22,6 +22,7 @@ RUN sh /scripts/sccache.sh\n COPY scripts/cmake.sh /scripts/\n RUN /scripts/cmake.sh\n \n-ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu --set rust.ignore-git=false\n+ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu --set rust.ignore-git=false \\\n+    --set llvm.allow-old-toolchain\n ENV SCRIPT python3 ../x.py --stage 2 test distcheck\n ENV DIST_SRC 1"}, {"sha": "f442a477a7b1e121a00f8da94ae63b40677cd90d", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-tools/Dockerfile", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -81,6 +81,7 @@ COPY host-x86_64/x86_64-gnu-tools/browser-ui-test.version /tmp/\n RUN npm install -g browser-ui-test@$(head -n 1 /tmp/browser-ui-test.version) --unsafe-perm=true\n \n ENV RUST_CONFIGURE_ARGS \\\n+  --set llvm.allow-old-toolchain \\\n   --build=x86_64-unknown-linux-gnu \\\n   --save-toolstates=/tmp/toolstate/toolstates.json\n "}, {"sha": "a21400cc4726d04e5161bb76a4bea7e6bb288843", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 24, "deletions": 6, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -596,29 +596,39 @@ jobs:\n \n           - name: i686-mingw-1\n             env:\n-              RUST_CONFIGURE_ARGS: --build=i686-pc-windows-gnu\n+              RUST_CONFIGURE_ARGS: >-\n+                --build=i686-pc-windows-gnu\n+                --set llvm.allow-old-toolchain\n               SCRIPT: make ci-mingw-subset-1\n               CUSTOM_MINGW: 1\n             <<: *job-windows-xl\n \n           - name: i686-mingw-2\n             env:\n-              RUST_CONFIGURE_ARGS: --build=i686-pc-windows-gnu\n+              RUST_CONFIGURE_ARGS: >-\n+                --build=i686-pc-windows-gnu\n+                --set llvm.allow-old-toolchain\n               SCRIPT: make ci-mingw-subset-2\n               CUSTOM_MINGW: 1\n             <<: *job-windows-xl\n \n           - name: x86_64-mingw-1\n             env:\n               SCRIPT: make ci-mingw-subset-1\n-              RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-gnu --enable-profiler\n+              RUST_CONFIGURE_ARGS: >-\n+                --build=x86_64-pc-windows-gnu\n+                --enable-profiler\n+                --set llvm.allow-old-toolchain\n               CUSTOM_MINGW: 1\n             <<: *job-windows-xl\n \n           - name: x86_64-mingw-2\n             env:\n               SCRIPT: make ci-mingw-subset-2\n-              RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-gnu --enable-profiler\n+              RUST_CONFIGURE_ARGS: >-\n+                --build=x86_64-pc-windows-gnu\n+                --enable-profiler\n+                --set llvm.allow-old-toolchain\n               CUSTOM_MINGW: 1\n             <<: *job-windows-xl\n \n@@ -663,7 +673,11 @@ jobs:\n \n           - name: dist-i686-mingw\n             env:\n-              RUST_CONFIGURE_ARGS: --build=i686-pc-windows-gnu --enable-full-tools --enable-profiler\n+              RUST_CONFIGURE_ARGS: >-\n+                --build=i686-pc-windows-gnu\n+                --enable-full-tools\n+                --enable-profiler\n+                --set llvm.allow-old-toolchain\n               SCRIPT: python x.py dist\n               CUSTOM_MINGW: 1\n               DIST_REQUIRE_ALL_TOOLS: 1\n@@ -672,7 +686,11 @@ jobs:\n           - name: dist-x86_64-mingw\n             env:\n               SCRIPT: python x.py dist\n-              RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-gnu --enable-full-tools --enable-profiler\n+              RUST_CONFIGURE_ARGS: >-\n+                --build=x86_64-pc-windows-gnu\n+                --enable-full-tools\n+                --enable-profiler\n+                --set llvm.allow-old-toolchain\n               CUSTOM_MINGW: 1\n               DIST_REQUIRE_ALL_TOOLS: 1\n             <<: *job-windows-xl"}, {"sha": "e3be3f64ecac101d14ceda759ba078ad0aaf3747", "filename": "src/llvm-project", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fllvm-project?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -1 +1 @@\n-Subproject commit 8b6b5014fdad3a750f7242a6bfdcad83619498d4\n+Subproject commit e3be3f64ecac101d14ceda759ba078ad0aaf3747"}, {"sha": "c943261d799c4b608d659a5cece75f60b62cfbeb", "filename": "src/test/run-make/coverage-llvmir/filecheck.testprog.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Ftest%2Frun-make%2Fcoverage-llvmir%2Ffilecheck.testprog.txt", "raw_url": "https://github.com/rust-lang/rust/raw/e2b52ff73edc8b0b7c74bc28760d618187731fe8/src%2Ftest%2Frun-make%2Fcoverage-llvmir%2Ffilecheck.testprog.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fcoverage-llvmir%2Ffilecheck.testprog.txt?ref=e2b52ff73edc8b0b7c74bc28760d618187731fe8", "patch": "@@ -9,7 +9,7 @@ CHECK-SAME:   section \"[[INSTR_PROF_COVFUN]]\"[[COMDAT_IF_SUPPORTED]], align 8\n CHECK:        @__llvm_coverage_mapping = private constant\n CHECK-SAME:   section \"[[INSTR_PROF_COVMAP]]\", align 8\n \n-WINDOWS:      @__llvm_profile_runtime = external global i32\n+WINDOWS:      @__llvm_profile_runtime = external{{.*}}global i32\n \n CHECK:        @__profc__R{{[a-zA-Z0-9_]+}}testprog14will_be_called = {{private|internal}} global\n CHECK-SAME:   section \"[[INSTR_PROF_CNTS]]\"{{.*}}, align 8"}]}