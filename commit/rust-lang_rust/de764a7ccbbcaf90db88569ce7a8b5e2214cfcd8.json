{"sha": "de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8", "node_id": "C_kwDOAAsO6NoAKGRlNzY0YTdjY2JiY2FmOTBkYjg4NTY5Y2U3YThiNWUyMjE0Y2ZjZDg", "commit": {"author": {"name": "Chris Denton", "email": "christophersdenton@gmail.com", "date": "2021-12-16T17:21:34Z"}, "committer": {"name": "Chris Denton", "email": "christophersdenton@gmail.com", "date": "2021-12-16T17:22:32Z"}, "message": "Quote bat script command line", "tree": {"sha": "301ce4897b76506f200d3f2520747ac9f6238cd2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/301ce4897b76506f200d3f2520747ac9f6238cd2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE+p/jD6jrzmnSIWJLcTRy8vRWJ94FAmG7ddgACgkQcTRy8vRW\nJ95Deg/8DQtxrQ3gk8Q1yhBdlVpzVfVF0Tz1JeSC9uTKsUsC6fu92nkD/SDwWl5G\nUlHxinzFTU8yRf/OK0v+ZhsBaz/W8CoLbrK7Oor48BbMTtmMaIVwBN/cKN3eddsv\n65cwPx0LWgQP6qaNw2sxg0IClh/1aTkg8R6iXSrugEzwW+NzzGDMqZAszNdvdnfF\nOzRWMf5onhrVAvTevKb9w8C7Y1SDNgDvbLRqijBRzDHPPImnE0VPHDPO5S2v9cft\nA2AS4jGmL9WNVLs5iC1rkNKErbABJe08lFjFdogJPhH69EIqctiAgr/1fsCpvj98\nFnSDQ2NEDGKCBSKr//OMrdoTzI9DQiL2pMzNBtC+qqzoU5R5EH7h29AvuUigGq8+\n7hXUup5XqE84ure3jc93qr4PHNlZ1rmPHvJgTtuayfVbuVDANdnYYCpJs3gkiUkE\n5iKVzpgPdBUPT87zCu3wBBFaB1bGS98Cwc/DxXohFiIg5RnZT59UeaOy6Jf/h2Fr\nZdtRf7qVqwqTEpx/BSAUOAtep8tJ4AGXbaM1eK0C2SEFYsUwyNAMHg36gc+imG4x\nw6RRcJTm/c97ArYcCKpsdxXXh8fsVim2YXxNzFeShrggmFRGIzqKjlhrekB2vw3y\nkkTNPimmK3Izj35ci1Qbbytq1WSkqXWXFiotffhmsoLmKRKy7zQ=\n=WTTD\n-----END PGP SIGNATURE-----", "payload": "tree 301ce4897b76506f200d3f2520747ac9f6238cd2\nparent f8402169aaa12e7bbb9630796a8caec90a3055ca\nauthor Chris Denton <christophersdenton@gmail.com> 1639675294 +0000\ncommitter Chris Denton <christophersdenton@gmail.com> 1639675352 +0000\n\nQuote bat script command line\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8", "html_url": "https://github.com/rust-lang/rust/commit/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8/comments", "author": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f8402169aaa12e7bbb9630796a8caec90a3055ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/f8402169aaa12e7bbb9630796a8caec90a3055ca", "html_url": "https://github.com/rust-lang/rust/commit/f8402169aaa12e7bbb9630796a8caec90a3055ca"}], "stats": {"total": 35, "additions": 35, "deletions": 0}, "files": [{"sha": "630a8a4c47ad05e8835811ac1cbf3bb0d86fb189", "filename": "library/std/src/process/tests.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8/library%2Fstd%2Fsrc%2Fprocess%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8/library%2Fstd%2Fsrc%2Fprocess%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fprocess%2Ftests.rs?ref=de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8", "patch": "@@ -416,3 +416,22 @@ fn env_empty() {\n     let p = Command::new(\"cmd\").args(&[\"/C\", \"exit 0\"]).env_clear().spawn();\n     assert!(p.is_ok());\n }\n+\n+// See issue #91991\n+#[test]\n+#[cfg(windows)]\n+fn run_bat_script() {\n+    let tempdir = crate::sys_common::io::test::tmpdir();\n+    let script_path = tempdir.join(\"hello.cmd\");\n+\n+    crate::fs::write(&script_path, \"@echo Hello, %~1!\").unwrap();\n+    let output = Command::new(&script_path)\n+        .arg(\"fellow Rustaceans\")\n+        .stdout(crate::process::Stdio::piped())\n+        .spawn()\n+        .unwrap()\n+        .wait_with_output()\n+        .unwrap();\n+    assert!(output.status.success());\n+    assert_eq!(String::from_utf8_lossy(&output.stdout).trim(), \"Hello, fellow Rustaceans!\");\n+}"}, {"sha": "e84dfbce4a7540b97fc8e6b3d52fe0cc184bbe57", "filename": "library/std/src/sys/windows/process.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs?ref=de764a7ccbbcaf90db88569ce7a8b5e2214cfcd8", "patch": "@@ -704,6 +704,19 @@ fn make_command_line(prog: &OsStr, args: &[Arg], force_quotes: bool) -> io::Resu\n     // Encode the command and arguments in a command line string such\n     // that the spawned process may recover them using CommandLineToArgvW.\n     let mut cmd: Vec<u16> = Vec::new();\n+\n+    // CreateFileW has special handling for .bat and .cmd files, which means we\n+    // need to add an extra pair of quotes surrounding the whole command line\n+    // so they are properly passed on to the script.\n+    // See issue #91991.\n+    let is_batch_file = Path::new(prog)\n+        .extension()\n+        .map(|ext| ext.eq_ignore_ascii_case(\"cmd\") || ext.eq_ignore_ascii_case(\"bat\"))\n+        .unwrap_or(false);\n+    if is_batch_file {\n+        cmd.push(b'\"' as u16);\n+    }\n+\n     // Always quote the program name so CreateProcess doesn't interpret args as\n     // part of the name if the binary wasn't found first time.\n     append_arg(&mut cmd, prog, Quote::Always)?;\n@@ -715,6 +728,9 @@ fn make_command_line(prog: &OsStr, args: &[Arg], force_quotes: bool) -> io::Resu\n         };\n         append_arg(&mut cmd, arg, quote)?;\n     }\n+    if is_batch_file {\n+        cmd.push(b'\"' as u16);\n+    }\n     return Ok(cmd);\n \n     fn append_arg(cmd: &mut Vec<u16>, arg: &OsStr, quote: Quote) -> io::Result<()> {"}]}