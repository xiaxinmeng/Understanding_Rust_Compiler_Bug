{"sha": "dd0507c054ea27ae836025761908d339a478e0ab", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRkMDUwN2MwNTRlYTI3YWU4MzYwMjU3NjE5MDhkMzM5YTQ3OGUwYWI=", "commit": {"author": {"name": "varkor", "email": "github@varkor.com", "date": "2020-01-20T15:22:12Z"}, "committer": {"name": "varkor", "email": "github@varkor.com", "date": "2020-01-21T01:03:15Z"}, "message": "Make `TooGeneric` error in WF checking a proper error\n\n`TooGeneric` is encountered during WF checking when we cannot determine that a constant involving a generic parameter will always be evaluated successfully (rather than resulting in an error). In these cases, the burden of proof should be with the caller, so that we can avoid post-monomorphisation tim errors (which was the previous previous behaviour). This commit ensures that this situation produces a proper compiler error, rather than silently ignoring it or ICEing.", "tree": {"sha": "46d1061dacc21dd0d2a235604364ec3db08077d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/46d1061dacc21dd0d2a235604364ec3db08077d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd0507c054ea27ae836025761908d339a478e0ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd0507c054ea27ae836025761908d339a478e0ab", "html_url": "https://github.com/rust-lang/rust/commit/dd0507c054ea27ae836025761908d339a478e0ab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd0507c054ea27ae836025761908d339a478e0ab/comments", "author": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "900811e43047fc5593f39b0363373530b02c87e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/900811e43047fc5593f39b0363373530b02c87e0", "html_url": "https://github.com/rust-lang/rust/commit/900811e43047fc5593f39b0363373530b02c87e0"}], "stats": {"total": 61, "additions": 45, "deletions": 16}, "files": [{"sha": "f3dc79f0ff6b222acc40000cd97484057c1ea701", "filename": "src/librustc/traits/error_reporting/mod.rs", "status": "modified", "additions": 23, "deletions": 11, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/dd0507c054ea27ae836025761908d339a478e0ab/src%2Flibrustc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd0507c054ea27ae836025761908d339a478e0ab/src%2Flibrustc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=dd0507c054ea27ae836025761908d339a478e0ab", "patch": "@@ -914,17 +914,29 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n                 report_object_safety_error(self.tcx, span, did, violations)\n             }\n \n-            // already reported in the query\n-            ConstEvalFailure(err) => {\n-                if let ErrorHandled::TooGeneric = err {\n-                    // Silence this error, as it can be produced during intermediate steps\n-                    // when a constant is not yet able to be evaluated (but will be later).\n-                    return;\n-                }\n-                self.tcx.sess.delay_span_bug(\n-                    span,\n-                    &format!(\"constant in type had an ignored error: {:?}\", err),\n-                );\n+            ConstEvalFailure(ErrorHandled::TooGeneric) => {\n+                // In this instance, we have a const expression containing an unevaluated\n+                // generic parameter. We have no idea whether this expression is valid or\n+                // not (e.g. it might result in an error), but we don't want to just assume\n+                // that it's okay, because that might result in post-monomorphisation time\n+                // errors. The onus is really on the caller to provide values that it can\n+                // prove are well-formed.\n+                let mut err = self\n+                    .tcx\n+                    .sess\n+                    .struct_span_err(span, \"constant expression depends on a generic parameter\");\n+                // FIXME(const_generics): we should suggest to the user how they can resolve this\n+                // issue. However, this is currently not actually possible\n+                // (see https://github.com/rust-lang/rust/issues/66962#issuecomment-575907083).\n+                err.note(\"this may fail depending on what value the parameter takes\");\n+                err\n+            }\n+\n+            // Already reported in the query.\n+            ConstEvalFailure(ErrorHandled::Reported) => {\n+                self.tcx\n+                    .sess\n+                    .delay_span_bug(span, &format!(\"constant in type had an ignored error\"));\n                 return;\n             }\n "}, {"sha": "d996bf56fcc10c443cc524cbe24d8598b672cec8", "filename": "src/test/ui/const-generics/array-size-in-generic-struct-param.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/dd0507c054ea27ae836025761908d339a478e0ab/src%2Ftest%2Fui%2Fconst-generics%2Farray-size-in-generic-struct-param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd0507c054ea27ae836025761908d339a478e0ab/src%2Ftest%2Fui%2Fconst-generics%2Farray-size-in-generic-struct-param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Farray-size-in-generic-struct-param.rs?ref=dd0507c054ea27ae836025761908d339a478e0ab", "patch": "@@ -1,18 +1,17 @@\n-// run-pass\n-\n #![feature(const_generics)]\n //~^ WARN the feature `const_generics` is incomplete and may cause the compiler to crash\n \n #[allow(dead_code)]\n-struct ArithArrayLen<const N: usize>([u32; 0 + N]); // ok\n+struct ArithArrayLen<const N: usize>([u32; 0 + N]);\n+//~^ ERROR constant expression depends on a generic parameter\n \n #[derive(PartialEq, Eq)]\n struct Config {\n     arr_size: usize,\n }\n \n struct B<const CFG: Config> {\n-    arr: [u8; CFG.arr_size], // ok\n+    arr: [u8; CFG.arr_size], //~ ERROR constant expression depends on a generic parameter\n }\n \n const C: Config = Config { arr_size: 5 };"}, {"sha": "6ae70c493b1dd3afc4c76c09d783170e234d867f", "filename": "src/test/ui/const-generics/array-size-in-generic-struct-param.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/dd0507c054ea27ae836025761908d339a478e0ab/src%2Ftest%2Fui%2Fconst-generics%2Farray-size-in-generic-struct-param.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd0507c054ea27ae836025761908d339a478e0ab/src%2Ftest%2Fui%2Fconst-generics%2Farray-size-in-generic-struct-param.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Farray-size-in-generic-struct-param.stderr?ref=dd0507c054ea27ae836025761908d339a478e0ab", "patch": "@@ -1,8 +1,26 @@\n warning: the feature `const_generics` is incomplete and may cause the compiler to crash\n-  --> $DIR/array-size-in-generic-struct-param.rs:3:12\n+  --> $DIR/array-size-in-generic-struct-param.rs:1:12\n    |\n LL | #![feature(const_generics)]\n    |            ^^^^^^^^^^^^^^\n    |\n    = note: `#[warn(incomplete_features)]` on by default\n \n+error: constant expression depends on a generic parameter\n+  --> $DIR/array-size-in-generic-struct-param.rs:5:38\n+   |\n+LL | struct ArithArrayLen<const N: usize>([u32; 0 + N]);\n+   |                                      ^^^^^^^^^^^^\n+   |\n+   = note: this may fail depending on what value the parameter takes\n+\n+error: constant expression depends on a generic parameter\n+  --> $DIR/array-size-in-generic-struct-param.rs:14:5\n+   |\n+LL |     arr: [u8; CFG.arr_size],\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: this may fail depending on what value the parameter takes\n+\n+error: aborting due to 2 previous errors\n+"}]}