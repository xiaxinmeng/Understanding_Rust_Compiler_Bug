{"sha": "a70d03b62454f57672e14b48715ae10c01e5fd34", "node_id": "C_kwDOAAsO6NoAKGE3MGQwM2I2MjQ1NGY1NzY3MmUxNGI0ODcxNWFlMTBjMDFlNWZkMzQ", "commit": {"author": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2023-02-06T01:58:39Z"}, "committer": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2023-02-09T00:47:12Z"}, "message": "Extend `BYTE_SLICE_IN_PACKED_STRUCT_WITH_DERIVE`.\n\nTo temporarily allow a `str` field in a packed struct using `derive`,\nalong with `[u8]`.", "tree": {"sha": "1937ed3dbd3fbd4e7e411991fd40b3fadbe1944e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1937ed3dbd3fbd4e7e411991fd40b3fadbe1944e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a70d03b62454f57672e14b48715ae10c01e5fd34", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a70d03b62454f57672e14b48715ae10c01e5fd34", "html_url": "https://github.com/rust-lang/rust/commit/a70d03b62454f57672e14b48715ae10c01e5fd34", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a70d03b62454f57672e14b48715ae10c01e5fd34/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef934d9b632b8ac00276558824664c104b92b5f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef934d9b632b8ac00276558824664c104b92b5f0", "html_url": "https://github.com/rust-lang/rust/commit/ef934d9b632b8ac00276558824664c104b92b5f0"}], "stats": {"total": 106, "additions": 81, "deletions": 25}, "files": [{"sha": "970b9115d8d79639aa232db382c0936dbad366e9", "filename": "compiler/rustc_builtin_macros/src/deriving/generic/mod.rs", "status": "modified", "additions": 35, "deletions": 20, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/a70d03b62454f57672e14b48715ae10c01e5fd34/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d03b62454f57672e14b48715ae10c01e5fd34/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fgeneric%2Fmod.rs?ref=a70d03b62454f57672e14b48715ae10c01e5fd34", "patch": "@@ -1557,31 +1557,46 @@ impl<'a> TraitDef<'a> {\n                             }),\n                         ),\n                     );\n-                    // In general, fields in packed structs are copied via a\n-                    // block, e.g. `&{self.0}`. The one exception is `[u8]`\n-                    // fields, which cannot be copied and also never cause\n-                    // unaligned references. This exception is allowed to\n-                    // handle the `FlexZeroSlice` type in the `zerovec` crate\n-                    // within `icu4x-0.9.0`.\n-                    //\n-                    // Once use of `icu4x-0.9.0` has dropped sufficiently, this\n-                    // exception should be removed.\n-                    let is_u8_slice = if let TyKind::Slice(ty) = &struct_field.ty.kind &&\n-                        let TyKind::Path(None, rustc_ast::Path { segments, .. }) = &ty.kind &&\n-                        let [seg] = segments.as_slice() &&\n-                        seg.ident.name == sym::u8 && seg.args.is_none()\n-                    {\n-                        true\n-                    } else {\n-                        false\n-                    };\n                     if is_packed {\n-                        if is_u8_slice {\n+                        // In general, fields in packed structs are copied via a\n+                        // block, e.g. `&{self.0}`. The two exceptions are `[u8]`\n+                        // and `str` fields, which cannot be copied and also never\n+                        // cause unaligned references. These exceptions are allowed\n+                        // to handle the `FlexZeroSlice` type in the `zerovec`\n+                        // crate within `icu4x-0.9.0`.\n+                        //\n+                        // Once use of `icu4x-0.9.0` has dropped sufficiently, this\n+                        // exception should be removed.\n+                        let is_simple_path = |ty: &P<ast::Ty>, sym| {\n+                            if let TyKind::Path(None, ast::Path { segments, .. }) = &ty.kind &&\n+                                let [seg] = segments.as_slice() &&\n+                                seg.ident.name == sym && seg.args.is_none()\n+                            {\n+                                true\n+                            } else {\n+                                false\n+                            }\n+                        };\n+\n+                        let exception = if let TyKind::Slice(ty) = &struct_field.ty.kind &&\n+                            is_simple_path(ty, sym::u8)\n+                        {\n+                            Some(\"byte\")\n+                        } else if is_simple_path(&struct_field.ty, sym::str) {\n+                            Some(\"string\")\n+                        } else {\n+                            None\n+                        };\n+\n+                        if let Some(ty) = exception {\n                             cx.sess.parse_sess.buffer_lint_with_diagnostic(\n                                 BYTE_SLICE_IN_PACKED_STRUCT_WITH_DERIVE,\n                                 sp,\n                                 ast::CRATE_NODE_ID,\n-                                \"byte slice in a packed struct that derives a built-in trait\",\n+                                &format!(\n+                                    \"{} slice in a packed struct that derives a built-in trait\",\n+                                    ty\n+                                ),\n                                 rustc_lint_defs::BuiltinLintDiagnostics::ByteSliceInPackedStructWithDerive\n                             );\n                         } else {"}, {"sha": "9d8ad9d9ed9f6f5c7d2fa66b7e0d656ba2393581", "filename": "compiler/rustc_lint_defs/src/builtin.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a70d03b62454f57672e14b48715ae10c01e5fd34/compiler%2Frustc_lint_defs%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d03b62454f57672e14b48715ae10c01e5fd34/compiler%2Frustc_lint_defs%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint_defs%2Fsrc%2Fbuiltin.rs?ref=a70d03b62454f57672e14b48715ae10c01e5fd34", "patch": "@@ -4073,7 +4073,8 @@ declare_lint! {\n \n declare_lint! {\n     /// The `byte_slice_in_packed_struct_with_derive` lint detects cases where a byte slice field\n-    /// (`[u8]`) is used in a `packed` struct that derives one or more built-in traits.\n+    /// (`[u8]`) or string slice field (`str`) is used in a `packed` struct that derives one or\n+    /// more built-in traits.\n     ///\n     /// ### Example\n     ///\n@@ -4091,11 +4092,11 @@ declare_lint! {\n     /// ### Explanation\n     ///\n     /// This was previously accepted but is being phased out, because fields in packed structs are\n-    /// now required to implement `Copy` for `derive` to work. Byte slices are a temporary\n-    /// exception because certain crates depended on them.\n+    /// now required to implement `Copy` for `derive` to work. Byte slices and string slices are a\n+    /// temporary exception because certain crates depended on them.\n     pub BYTE_SLICE_IN_PACKED_STRUCT_WITH_DERIVE,\n     Warn,\n-    \"`[u8]` slice used in a packed struct with `derive`\",\n+    \"`[u8]` or `str` used in a packed struct with `derive`\",\n     @future_incompatible = FutureIncompatibleInfo {\n         reference: \"issue #107457 <https://github.com/rust-lang/rust/issues/107457>\",\n         reason: FutureIncompatibilityReason::FutureReleaseErrorReportNow,"}, {"sha": "58be4519720178b8fab1f5504fc43607bc8e05a9", "filename": "tests/ui/derives/deriving-with-repr-packed.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/a70d03b62454f57672e14b48715ae10c01e5fd34/tests%2Fui%2Fderives%2Fderiving-with-repr-packed.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d03b62454f57672e14b48715ae10c01e5fd34/tests%2Fui%2Fderives%2Fderiving-with-repr-packed.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fderives%2Fderiving-with-repr-packed.rs?ref=a70d03b62454f57672e14b48715ae10c01e5fd34", "patch": "@@ -33,4 +33,14 @@ struct FlexZeroSlice {\n     //~^^ this was previously accepted\n }\n \n+// Again, currently allowed, but will be phased out.\n+#[derive(Debug)]\n+#[repr(packed)]\n+struct WithStr {\n+    width: u8,\n+    data: str,\n+    //~^ WARNING string slice in a packed struct that derives a built-in trait\n+    //~^^ this was previously accepted\n+}\n+\n fn main() {}"}, {"sha": "0cfe03869af1bd6846e3e836dca9d12ee5f37fd0", "filename": "tests/ui/derives/deriving-with-repr-packed.stderr", "status": "modified", "additions": 31, "deletions": 1, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/a70d03b62454f57672e14b48715ae10c01e5fd34/tests%2Fui%2Fderives%2Fderiving-with-repr-packed.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a70d03b62454f57672e14b48715ae10c01e5fd34/tests%2Fui%2Fderives%2Fderiving-with-repr-packed.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fderives%2Fderiving-with-repr-packed.stderr?ref=a70d03b62454f57672e14b48715ae10c01e5fd34", "patch": "@@ -13,6 +13,20 @@ LL |     data: [u8],\n    = note: `#[warn(byte_slice_in_packed_struct_with_derive)]` on by default\n    = note: this warning originates in the derive macro `Debug` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n+warning: string slice in a packed struct that derives a built-in trait\n+  --> $DIR/deriving-with-repr-packed.rs:41:5\n+   |\n+LL | #[derive(Debug)]\n+   |          ----- in this derive macro expansion\n+...\n+LL |     data: str,\n+   |     ^^^^^^^^^\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #107457 <https://github.com/rust-lang/rust/issues/107457>\n+   = help: consider implementing the trait by hand, or remove the `packed` attribute\n+   = note: this warning originates in the derive macro `Debug` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n error[E0507]: cannot move out of `self` which is behind a shared reference\n   --> $DIR/deriving-with-repr-packed.rs:22:10\n    |\n@@ -24,7 +38,7 @@ LL | struct X(Y);\n    |\n    = note: this error originates in the derive macro `Debug` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n-error: aborting due to previous error; 1 warning emitted\n+error: aborting due to previous error; 2 warnings emitted\n \n For more information about this error, try `rustc --explain E0507`.\n Future incompatibility report: Future breakage diagnostic:\n@@ -43,3 +57,19 @@ LL |     data: [u8],\n    = note: `#[warn(byte_slice_in_packed_struct_with_derive)]` on by default\n    = note: this warning originates in the derive macro `Debug` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n+Future breakage diagnostic:\n+warning: string slice in a packed struct that derives a built-in trait\n+  --> $DIR/deriving-with-repr-packed.rs:41:5\n+   |\n+LL | #[derive(Debug)]\n+   |          ----- in this derive macro expansion\n+...\n+LL |     data: str,\n+   |     ^^^^^^^^^\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #107457 <https://github.com/rust-lang/rust/issues/107457>\n+   = help: consider implementing the trait by hand, or remove the `packed` attribute\n+   = note: `#[warn(byte_slice_in_packed_struct_with_derive)]` on by default\n+   = note: this warning originates in the derive macro `Debug` (in Nightly builds, run with -Z macro-backtrace for more info)\n+"}]}