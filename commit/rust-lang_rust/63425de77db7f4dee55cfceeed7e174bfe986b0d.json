{"sha": "63425de77db7f4dee55cfceeed7e174bfe986b0d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzNDI1ZGU3N2RiN2Y0ZGVlNTVjZmNlZWVkN2UxNzRiZmU5ODZiMGQ=", "commit": {"author": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2021-04-29T08:10:58Z"}, "committer": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2021-04-29T08:10:58Z"}, "message": "while_immutable_cond: check condition for mutation", "tree": {"sha": "a739c8b3259c8d5d98f83336d89d997e7c9f22cc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a739c8b3259c8d5d98f83336d89d997e7c9f22cc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63425de77db7f4dee55cfceeed7e174bfe986b0d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63425de77db7f4dee55cfceeed7e174bfe986b0d", "html_url": "https://github.com/rust-lang/rust/commit/63425de77db7f4dee55cfceeed7e174bfe986b0d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63425de77db7f4dee55cfceeed7e174bfe986b0d/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce37099bd3cc05568c09fa7c1f06c80efd64c905", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce37099bd3cc05568c09fa7c1f06c80efd64c905", "html_url": "https://github.com/rust-lang/rust/commit/ce37099bd3cc05568c09fa7c1f06c80efd64c905"}], "stats": {"total": 25, "additions": 20, "deletions": 5}, "files": [{"sha": "55404b87ec9ce60400bf8137ac93a8dbe8a09e23", "filename": "clippy_lints/src/loops/while_immutable_condition.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/63425de77db7f4dee55cfceeed7e174bfe986b0d/clippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63425de77db7f4dee55cfceeed7e174bfe986b0d/clippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs?ref=63425de77db7f4dee55cfceeed7e174bfe986b0d", "patch": "@@ -28,11 +28,14 @@ pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, cond: &'tcx Expr<'_>, expr: &'\n         return;\n     }\n     let used_in_condition = &var_visitor.ids;\n-    let no_cond_variable_mutated = if let Some(used_mutably) = mutated_variables(expr, cx) {\n-        used_in_condition.is_disjoint(&used_mutably)\n-    } else {\n-        return;\n-    };\n+    let mutated_in_body = mutated_variables(expr, cx);\n+    let mutated_in_condition = mutated_variables(cond, cx);\n+    let no_cond_variable_mutated =\n+        if let (Some(used_mutably_body), Some(used_mutably_cond)) = (mutated_in_body, mutated_in_condition) {\n+            used_in_condition.is_disjoint(&used_mutably_body) && used_in_condition.is_disjoint(&used_mutably_cond)\n+        } else {\n+            return;\n+        };\n     let mutable_static_in_cond = var_visitor.def_ids.iter().any(|(_, v)| *v);\n \n     let mut has_break_or_return_visitor = HasBreakOrReturnVisitor {"}, {"sha": "3d8fb8507e515c470a8ff1d2a59d5002b7ef3fd1", "filename": "tests/ui/infinite_loop.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/63425de77db7f4dee55cfceeed7e174bfe986b0d/tests%2Fui%2Finfinite_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63425de77db7f4dee55cfceeed7e174bfe986b0d/tests%2Fui%2Finfinite_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finfinite_loop.rs?ref=63425de77db7f4dee55cfceeed7e174bfe986b0d", "patch": "@@ -192,11 +192,23 @@ fn while_loop_with_break_and_return() {\n     }\n }\n \n+fn immutable_condition_false_positive(mut n: u64) -> u32 {\n+    let mut count = 0;\n+    while {\n+        n >>= 1;\n+        n != 0\n+    } {\n+        count += 1;\n+    }\n+    count\n+}\n+\n fn main() {\n     immutable_condition();\n     unused_var();\n     used_immutable();\n     internally_mutable();\n+    immutable_condition_false_positive(5);\n \n     let mut c = Counter { count: 0 };\n     c.inc_n(5);"}]}