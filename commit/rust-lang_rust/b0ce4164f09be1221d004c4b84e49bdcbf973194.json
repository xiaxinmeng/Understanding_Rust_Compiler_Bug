{"sha": "b0ce4164f09be1221d004c4b84e49bdcbf973194", "node_id": "C_kwDOAAsO6NoAKGIwY2U0MTY0ZjA5YmUxMjIxZDAwNGM0Yjg0ZTQ5YmRjYmY5NzMxOTQ", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2023-04-25T12:48:53Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2023-05-29T16:58:11Z"}, "message": "linker: Report linker flavors incompatible with the current target\n\nPreviously they would be reported as link time errors about unknown linker options", "tree": {"sha": "b796caaaca796de99a220ccecbfcd2e7d92749a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b796caaaca796de99a220ccecbfcd2e7d92749a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b0ce4164f09be1221d004c4b84e49bdcbf973194", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b0ce4164f09be1221d004c4b84e49bdcbf973194", "html_url": "https://github.com/rust-lang/rust/commit/b0ce4164f09be1221d004c4b84e49bdcbf973194", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b0ce4164f09be1221d004c4b84e49bdcbf973194/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2013ccc218a488768ad6b647dd8ecc293e7847b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2013ccc218a488768ad6b647dd8ecc293e7847b4", "html_url": "https://github.com/rust-lang/rust/commit/2013ccc218a488768ad6b647dd8ecc293e7847b4"}], "stats": {"total": 53, "additions": 51, "deletions": 2}, "files": [{"sha": "4897bd8d5daec84045d0a3084deaa920291b29ad", "filename": "compiler/rustc_session/messages.ftl", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_session%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_session%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fmessages.ftl?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -27,6 +27,10 @@ session_feature_gate_error = {$explain}\n session_file_is_not_writeable = output file {$file} is not writeable -- check its permissions\n \n session_hexadecimal_float_literal_not_supported = hexadecimal float literal is not supported\n+\n+session_incompatible_linker_flavor = linker flavor `{$flavor}` is incompatible with the current target\n+    .note = compatible flavors are: {$compatible_list}\n+\n session_incorrect_cgu_reuse_type =\n     CGU-reuse for `{$cgu_user_name}` is `{$actual_reuse}` but should be {$at_least ->\n     [one] {\"at least \"}"}, {"sha": "4a3e668da111a91089c9b797beaa6ed5f10b9242", "filename": "compiler/rustc_session/src/errors.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Ferrors.rs?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -422,3 +422,11 @@ pub fn report_lit_error(sess: &ParseSess, err: LitError, lit: token::Lit, span:\n pub struct OptimisationFuelExhausted {\n     pub msg: String,\n }\n+\n+#[derive(Diagnostic)]\n+#[diag(session_incompatible_linker_flavor)]\n+#[note]\n+pub struct IncompatibleLinkerFlavor {\n+    pub flavor: &'static str,\n+    pub compatible_list: String,\n+}"}, {"sha": "1eb54cee5a14c35907c5c6b295e07cb5fbeb308b", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -1675,6 +1675,13 @@ fn validate_commandline_args_with_session_available(sess: &Session) {\n     if sess.opts.unstable_opts.instrument_xray.is_some() && !sess.target.options.supports_xray {\n         sess.emit_err(errors::InstrumentationNotSupported { us: \"XRay\".to_string() });\n     }\n+\n+    if let Some(flavor) = sess.opts.cg.linker_flavor {\n+        if let Some(compatible_list) = sess.target.linker_flavor.check_compatibility(flavor) {\n+            let flavor = flavor.desc();\n+            sess.emit_err(errors::IncompatibleLinkerFlavor { flavor, compatible_list });\n+        }\n+    }\n }\n \n /// Holds data on the current incremental compilation session, if there is one."}, {"sha": "a7b54766bc6234a4d625279222193c817e9301cf", "filename": "compiler/rustc_target/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_target%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_target%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Flib.rs?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -11,6 +11,7 @@\n #![feature(assert_matches)]\n #![feature(associated_type_bounds)]\n #![feature(exhaustive_patterns)]\n+#![feature(iter_intersperse)]\n #![feature(min_specialization)]\n #![feature(never_type)]\n #![feature(rustc_attrs)]"}, {"sha": "05cb7e87a9365458e808a55e63dd31d29a552e76", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -319,6 +319,19 @@ impl LinkerFlavor {\n         self.with_hints(LinkerFlavor::infer_linker_hints(linker_stem))\n     }\n \n+    pub fn check_compatibility(self, cli: LinkerFlavorCli) -> Option<String> {\n+        // The CLI flavor should be compatible with the target if it survives this roundtrip.\n+        let compatible = |cli| cli == self.with_cli_hints(cli).to_cli();\n+        (!compatible(cli)).then(|| {\n+            LinkerFlavorCli::all()\n+                .iter()\n+                .filter(|cli| compatible(**cli))\n+                .map(|cli| cli.desc())\n+                .intersperse(\", \")\n+                .collect()\n+        })\n+    }\n+\n     pub fn lld_flavor(self) -> LldFlavor {\n         match self {\n             LinkerFlavor::Gnu(..)\n@@ -340,6 +353,10 @@ impl LinkerFlavor {\n macro_rules! linker_flavor_cli_impls {\n     ($(($($flavor:tt)*) $string:literal)*) => (\n         impl LinkerFlavorCli {\n+            const fn all() -> &'static [LinkerFlavorCli] {\n+                &[$($($flavor)*,)*]\n+            }\n+\n             pub const fn one_of() -> &'static str {\n                 concat!(\"one of: \", $($string, \" \",)*)\n             }\n@@ -351,8 +368,8 @@ macro_rules! linker_flavor_cli_impls {\n                 })\n             }\n \n-            pub fn desc(&self) -> &str {\n-                match *self {\n+            pub fn desc(self) -> &'static str {\n+                match self {\n                     $($($flavor)* => $string,)*\n                 }\n             }"}, {"sha": "90c2b612f22da1d9def44190086316a4737f5fc0", "filename": "tests/ui/linkage-attr/incompatible-flavor.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/tests%2Fui%2Flinkage-attr%2Fincompatible-flavor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/tests%2Fui%2Flinkage-attr%2Fincompatible-flavor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flinkage-attr%2Fincompatible-flavor.rs?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -0,0 +1,6 @@\n+// compile-flags: --target=x86_64-unknown-linux-gnu -C linker-flavor=msvc --crate-type=rlib\n+// error-pattern: linker flavor `msvc` is incompatible with the current target\n+// needs-llvm-components:\n+\n+#![feature(no_core)]\n+#![no_core]"}, {"sha": "e07e778521c0b65349e3a466daa41a1fb6e2ad3d", "filename": "tests/ui/linkage-attr/incompatible-flavor.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b0ce4164f09be1221d004c4b84e49bdcbf973194/tests%2Fui%2Flinkage-attr%2Fincompatible-flavor.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b0ce4164f09be1221d004c4b84e49bdcbf973194/tests%2Fui%2Flinkage-attr%2Fincompatible-flavor.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flinkage-attr%2Fincompatible-flavor.stderr?ref=b0ce4164f09be1221d004c4b84e49bdcbf973194", "patch": "@@ -0,0 +1,6 @@\n+error: linker flavor `msvc` is incompatible with the current target\n+   |\n+   = note: compatible flavors are: gcc, ld, ld.lld\n+\n+error: aborting due to previous error\n+"}]}