{"sha": "bc5a8e9537d30858fede92347e3842d4d4f8a803", "node_id": "C_kwDOAAsO6NoAKGJjNWE4ZTk1MzdkMzA4NThmZWRlOTIzNDdlMzg0MmQ0ZDRmOGE4MDM", "commit": {"author": {"name": "Preston From", "email": "prestonfrom@gmail.com", "date": "2022-06-02T08:23:42Z"}, "committer": {"name": "Preston From", "email": "prestonfrom@gmail.com", "date": "2022-06-02T08:38:57Z"}, "message": "Lint message correctly identifies match vs for loop", "tree": {"sha": "29202e1d17e10cb8b198f83a24a266eb3d97d67e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29202e1d17e10cb8b198f83a24a266eb3d97d67e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc5a8e9537d30858fede92347e3842d4d4f8a803", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc5a8e9537d30858fede92347e3842d4d4f8a803", "html_url": "https://github.com/rust-lang/rust/commit/bc5a8e9537d30858fede92347e3842d4d4f8a803", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc5a8e9537d30858fede92347e3842d4d4f8a803/comments", "author": {"login": "PrestonFrom", "id": 12164367, "node_id": "MDQ6VXNlcjEyMTY0MzY3", "avatar_url": "https://avatars.githubusercontent.com/u/12164367?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PrestonFrom", "html_url": "https://github.com/PrestonFrom", "followers_url": "https://api.github.com/users/PrestonFrom/followers", "following_url": "https://api.github.com/users/PrestonFrom/following{/other_user}", "gists_url": "https://api.github.com/users/PrestonFrom/gists{/gist_id}", "starred_url": "https://api.github.com/users/PrestonFrom/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PrestonFrom/subscriptions", "organizations_url": "https://api.github.com/users/PrestonFrom/orgs", "repos_url": "https://api.github.com/users/PrestonFrom/repos", "events_url": "https://api.github.com/users/PrestonFrom/events{/privacy}", "received_events_url": "https://api.github.com/users/PrestonFrom/received_events", "type": "User", "site_admin": false}, "committer": {"login": "PrestonFrom", "id": 12164367, "node_id": "MDQ6VXNlcjEyMTY0MzY3", "avatar_url": "https://avatars.githubusercontent.com/u/12164367?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PrestonFrom", "html_url": "https://github.com/PrestonFrom", "followers_url": "https://api.github.com/users/PrestonFrom/followers", "following_url": "https://api.github.com/users/PrestonFrom/following{/other_user}", "gists_url": "https://api.github.com/users/PrestonFrom/gists{/gist_id}", "starred_url": "https://api.github.com/users/PrestonFrom/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PrestonFrom/subscriptions", "organizations_url": "https://api.github.com/users/PrestonFrom/orgs", "repos_url": "https://api.github.com/users/PrestonFrom/repos", "events_url": "https://api.github.com/users/PrestonFrom/events{/privacy}", "received_events_url": "https://api.github.com/users/PrestonFrom/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e33d87d4a0a188aa03d7d07700dbf296cf76581a", "url": "https://api.github.com/repos/rust-lang/rust/commits/e33d87d4a0a188aa03d7d07700dbf296cf76581a", "html_url": "https://github.com/rust-lang/rust/commit/e33d87d4a0a188aa03d7d07700dbf296cf76581a"}], "stats": {"total": 25, "additions": 14, "deletions": 11}, "files": [{"sha": "2f7819cb47048cb5d51c99150937d87f5cadcd64", "filename": "clippy_lints/src/significant_drop_in_scrutinee.rs", "status": "modified", "additions": 13, "deletions": 10, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/bc5a8e9537d30858fede92347e3842d4d4f8a803/clippy_lints%2Fsrc%2Fsignificant_drop_in_scrutinee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc5a8e9537d30858fede92347e3842d4d4f8a803/clippy_lints%2Fsrc%2Fsignificant_drop_in_scrutinee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fsignificant_drop_in_scrutinee.rs?ref=bc5a8e9537d30858fede92347e3842d4d4f8a803", "patch": "@@ -91,15 +91,11 @@ declare_lint_pass!(SignificantDropInScrutinee => [SIGNIFICANT_DROP_IN_SCRUTINEE]\n \n impl<'tcx> LateLintPass<'tcx> for SignificantDropInScrutinee {\n     fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'tcx>) {\n-        if let Some(suggestions) = has_significant_drop_in_scrutinee(cx, expr) {\n+        if let Some((suggestions, message)) = has_significant_drop_in_scrutinee(cx, expr) {\n             for found in suggestions {\n-                span_lint_and_then(\n-                    cx,\n-                    SIGNIFICANT_DROP_IN_SCRUTINEE,\n-                    found.found_span,\n-                    \"temporary with significant drop in match scrutinee\",\n-                    |diag| set_diagnostic(diag, cx, expr, found),\n-                );\n+                span_lint_and_then(cx, SIGNIFICANT_DROP_IN_SCRUTINEE, found.found_span, message, |diag| {\n+                    set_diagnostic(diag, cx, expr, found);\n+                });\n             }\n         }\n     }\n@@ -153,13 +149,20 @@ fn set_diagnostic<'tcx>(diag: &mut Diagnostic, cx: &LateContext<'tcx>, expr: &'t\n fn has_significant_drop_in_scrutinee<'tcx, 'a>(\n     cx: &'a LateContext<'tcx>,\n     expr: &'tcx Expr<'tcx>,\n-) -> Option<Vec<FoundSigDrop>> {\n+) -> Option<(Vec<FoundSigDrop>, &'static str)> {\n     match expr.kind {\n         ExprKind::Match(match_expr, _, source) => {\n             match source {\n                 MatchSource::Normal | MatchSource::ForLoopDesugar => {\n                     let mut helper = SigDropHelper::new(cx);\n-                    helper.find_sig_drop(match_expr)\n+                    helper.find_sig_drop(match_expr).map(|drops| {\n+                        let message = if source == MatchSource::Normal {\n+                            \"temporary with significant drop in match scrutinee\"\n+                        } else {\n+                            \"temporary with significant drop in for loop\"\n+                        };\n+                        (drops, message)\n+                    })\n                 },\n                 // MatchSource of TryDesugar or AwaitDesugar is out of scope for this lint\n                 MatchSource::TryDesugar | MatchSource::AwaitDesugar => None,"}, {"sha": "303f3c1df033cfcd1100747da442bccd82ef5ab3", "filename": "tests/ui/significant_drop_in_scrutinee.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bc5a8e9537d30858fede92347e3842d4d4f8a803/tests%2Fui%2Fsignificant_drop_in_scrutinee.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bc5a8e9537d30858fede92347e3842d4d4f8a803/tests%2Fui%2Fsignificant_drop_in_scrutinee.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsignificant_drop_in_scrutinee.stderr?ref=bc5a8e9537d30858fede92347e3842d4d4f8a803", "patch": "@@ -285,7 +285,7 @@ error: temporary with significant drop in match scrutinee\n LL |     match rwlock.read().unwrap().to_number() {\n    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: temporary with significant drop in match scrutinee\n+error: temporary with significant drop in for loop\n   --> $DIR/significant_drop_in_scrutinee.rs:589:14\n    |\n LL |     for s in rwlock.read().unwrap().iter() {"}]}