{"sha": "9f69d024edb3b8acaa3edeb6730d1800c1185da8", "node_id": "C_kwDOAAsO6NoAKDlmNjlkMDI0ZWRiM2I4YWNhYTNlZGViNjczMGQxODAwYzExODVkYTg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-27T12:41:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-27T12:41:29Z"}, "message": "Auto merge of #12098 - jonas-schievink:macro-rules-snippet, r=jonas-schievink\n\nfix: show `macro_rules` snippet in blocks\n\nfixes https://github.com/rust-lang/rust-analyzer/issues/12092", "tree": {"sha": "f88e33cb757695d79e08b0172b0ae24242d69ccd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f88e33cb757695d79e08b0172b0ae24242d69ccd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9f69d024edb3b8acaa3edeb6730d1800c1185da8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9f69d024edb3b8acaa3edeb6730d1800c1185da8", "html_url": "https://github.com/rust-lang/rust/commit/9f69d024edb3b8acaa3edeb6730d1800c1185da8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9f69d024edb3b8acaa3edeb6730d1800c1185da8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e6ca0dacfabbe5e55a3014f79c982def0af399f", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e6ca0dacfabbe5e55a3014f79c982def0af399f", "html_url": "https://github.com/rust-lang/rust/commit/9e6ca0dacfabbe5e55a3014f79c982def0af399f"}, {"sha": "0060d5977d08c6d7867374598581fd847a66e078", "url": "https://api.github.com/repos/rust-lang/rust/commits/0060d5977d08c6d7867374598581fd847a66e078", "html_url": "https://github.com/rust-lang/rust/commit/0060d5977d08c6d7867374598581fd847a66e078"}], "stats": {"total": 49, "additions": 28, "deletions": 21}, "files": [{"sha": "c00de6ff50f3eef087a772edbd13ba0c7daacdab", "filename": "crates/ide_completion/src/completions/snippet.rs", "status": "modified", "additions": 21, "deletions": 18, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/9f69d024edb3b8acaa3edeb6730d1800c1185da8/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fsnippet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f69d024edb3b8acaa3edeb6730d1800c1185da8/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fsnippet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fsnippet.rs?ref=9f69d024edb3b8acaa3edeb6730d1800c1185da8", "patch": "@@ -43,7 +43,7 @@ pub(crate) fn complete_expr_snippet(acc: &mut Completions, ctx: &CompletionConte\n }\n \n pub(crate) fn complete_item_snippet(acc: &mut Completions, ctx: &CompletionContext) {\n-    if !ctx.expects_item()\n+    if !(ctx.expects_item() || ctx.has_block_expr_parent())\n         || ctx.previous_token_is(T![unsafe])\n         || ctx.path_qual().is_some()\n         || ctx.has_impl_or_trait_prev_sibling()\n@@ -63,11 +63,13 @@ pub(crate) fn complete_item_snippet(acc: &mut Completions, ctx: &CompletionConte\n         add_custom_completions(acc, ctx, cap, SnippetScope::Item);\n     }\n \n-    let mut item = snippet(\n-        ctx,\n-        cap,\n-        \"tmod (Test module)\",\n-        \"\\\n+    // Test-related snippets shouldn't be shown in blocks.\n+    if !ctx.has_block_expr_parent() {\n+        let mut item = snippet(\n+            ctx,\n+            cap,\n+            \"tmod (Test module)\",\n+            \"\\\n #[cfg(test)]\n mod tests {\n     use super::*;\n@@ -77,22 +79,23 @@ mod tests {\n         $0\n     }\n }\",\n-    );\n-    item.lookup_by(\"tmod\");\n-    item.add_to(acc);\n-\n-    let mut item = snippet(\n-        ctx,\n-        cap,\n-        \"tfn (Test function)\",\n-        \"\\\n+        );\n+        item.lookup_by(\"tmod\");\n+        item.add_to(acc);\n+\n+        let mut item = snippet(\n+            ctx,\n+            cap,\n+            \"tfn (Test function)\",\n+            \"\\\n #[test]\n fn ${1:feature}() {\n     $0\n }\",\n-    );\n-    item.lookup_by(\"tfn\");\n-    item.add_to(acc);\n+        );\n+        item.lookup_by(\"tfn\");\n+        item.add_to(acc);\n+    }\n \n     let item = snippet(\n         ctx,"}, {"sha": "5984149046a65f0a9ed0ae3b3f56f4fcf7328236", "filename": "crates/ide_completion/src/tests/expression.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9f69d024edb3b8acaa3edeb6730d1800c1185da8/crates%2Fide_completion%2Fsrc%2Ftests%2Fexpression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f69d024edb3b8acaa3edeb6730d1800c1185da8/crates%2Fide_completion%2Fsrc%2Ftests%2Fexpression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Fexpression.rs?ref=9f69d024edb3b8acaa3edeb6730d1800c1185da8", "patch": "@@ -153,6 +153,7 @@ impl Unit {\n             kw return\n             sn pd\n             sn ppd\n+            sn macro_rules\n             kw self\n             kw super\n             kw crate\n@@ -246,10 +247,11 @@ fn complete_in_block() {\n             kw return\n             sn pd\n             sn ppd\n+            sn macro_rules\n             kw self\n             kw super\n             kw crate\n-            fn foo()     fn()\n+            fn foo()       fn()\n             bt u32\n         \"#]],\n     )\n@@ -293,10 +295,11 @@ fn complete_after_if_expr() {\n             kw return\n             sn pd\n             sn ppd\n+            sn macro_rules\n             kw self\n             kw super\n             kw crate\n-            fn foo()     fn()\n+            fn foo()       fn()\n             bt u32\n         \"#]],\n     )\n@@ -366,10 +369,11 @@ fn completes_in_loop_ctx() {\n             kw return\n             sn pd\n             sn ppd\n+            sn macro_rules\n             kw self\n             kw super\n             kw crate\n-            fn my()      fn()\n+            fn my()        fn()\n             bt u32\n         \"#]],\n     );"}]}