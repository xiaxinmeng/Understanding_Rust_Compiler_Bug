{"sha": "d2470e74e133de90c227e6d22dfd3391277333b3", "node_id": "C_kwDOAAsO6NoAKGQyNDcwZTc0ZTEzM2RlOTBjMjI3ZTZkMjJkZmQzMzkxMjc3MzMzYjM", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-10-17T21:06:40Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-10-17T21:23:24Z"}, "message": "rustc_ast: Turn `MutVisitor::token_visiting_enabled` into a constant\n\nIt's a visitor property rather than something that needs to be determined at runtime", "tree": {"sha": "9cc9bb0fd5da7ef741bc727afb67b184ae730d03", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9cc9bb0fd5da7ef741bc727afb67b184ae730d03"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2470e74e133de90c227e6d22dfd3391277333b3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2470e74e133de90c227e6d22dfd3391277333b3", "html_url": "https://github.com/rust-lang/rust/commit/d2470e74e133de90c227e6d22dfd3391277333b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2470e74e133de90c227e6d22dfd3391277333b3/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8db8f48ea8c2443e969050fe4b6c829585048d5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/8db8f48ea8c2443e969050fe4b6c829585048d5c", "html_url": "https://github.com/rust-lang/rust/commit/8db8f48ea8c2443e969050fe4b6c829585048d5c"}], "stats": {"total": 21, "additions": 8, "deletions": 13}, "files": [{"sha": "df88cf35db242548b06305440ed48ddd44079e93", "filename": "compiler/rustc_ast/src/mut_visit.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d2470e74e133de90c227e6d22dfd3391277333b3/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2470e74e133de90c227e6d22dfd3391277333b3/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs?ref=d2470e74e133de90c227e6d22dfd3391277333b3", "patch": "@@ -37,9 +37,7 @@ pub trait MutVisitor: Sized {\n     /// Mutable token visiting only exists for the `macro_rules` token marker and should not be\n     /// used otherwise. Token visitor would be entirely separate from the regular visitor if\n     /// the marker didn't have to visit AST fragments in nonterminal tokens.\n-    fn token_visiting_enabled(&self) -> bool {\n-        false\n-    }\n+    const VISIT_TOKENS: bool = false;\n \n     // Methods in this trait have one of three forms:\n     //\n@@ -363,7 +361,7 @@ pub fn visit_mac_args<T: MutVisitor>(args: &mut MacArgs, vis: &mut T) {\n         }\n         MacArgs::Eq(eq_span, token) => {\n             vis.visit_span(eq_span);\n-            if vis.token_visiting_enabled() {\n+            if T::VISIT_TOKENS {\n                 visit_token(token, vis);\n             } else {\n                 // The value in `#[key = VALUE]` must be visited as an expression for backward\n@@ -682,7 +680,7 @@ pub fn visit_tt<T: MutVisitor>(tt: &mut TokenTree, vis: &mut T) {\n \n // No `noop_` prefix because there isn't a corresponding method in `MutVisitor`.\n pub fn visit_tts<T: MutVisitor>(TokenStream(tts): &mut TokenStream, vis: &mut T) {\n-    if vis.token_visiting_enabled() && !tts.is_empty() {\n+    if T::VISIT_TOKENS && !tts.is_empty() {\n         let tts = Lrc::make_mut(tts);\n         visit_vec(tts, |(tree, _is_joint)| visit_tt(tree, vis));\n     }\n@@ -692,14 +690,14 @@ pub fn visit_attr_annotated_tts<T: MutVisitor>(\n     AttrAnnotatedTokenStream(tts): &mut AttrAnnotatedTokenStream,\n     vis: &mut T,\n ) {\n-    if vis.token_visiting_enabled() && !tts.is_empty() {\n+    if T::VISIT_TOKENS && !tts.is_empty() {\n         let tts = Lrc::make_mut(tts);\n         visit_vec(tts, |(tree, _is_joint)| visit_attr_annotated_tt(tree, vis));\n     }\n }\n \n pub fn visit_lazy_tts_opt_mut<T: MutVisitor>(lazy_tts: Option<&mut LazyTokenStream>, vis: &mut T) {\n-    if vis.token_visiting_enabled() {\n+    if T::VISIT_TOKENS {\n         if let Some(lazy_tts) = lazy_tts {\n             let mut tts = lazy_tts.create_token_stream();\n             visit_attr_annotated_tts(&mut tts, vis);"}, {"sha": "6bf7a2a1b798b8c1273cebb26ed476e72743f550", "filename": "compiler/rustc_expand/src/mbe/transcribe.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d2470e74e133de90c227e6d22dfd3391277333b3/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2470e74e133de90c227e6d22dfd3391277333b3/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs?ref=d2470e74e133de90c227e6d22dfd3391277333b3", "patch": "@@ -19,9 +19,7 @@ use std::mem;\n struct Marker(LocalExpnId, Transparency);\n \n impl MutVisitor for Marker {\n-    fn token_visiting_enabled(&self) -> bool {\n-        true\n-    }\n+    const VISIT_TOKENS: bool = true;\n \n     fn visit_span(&mut self, span: &mut Span) {\n         *span = span.apply_mark(self.0.to_expn_id(), self.1)"}, {"sha": "8974d45b4d8cfeaddced965b4cc7eab4db5ed3ec", "filename": "compiler/rustc_expand/src/mut_visit/tests.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d2470e74e133de90c227e6d22dfd3391277333b3/compiler%2Frustc_expand%2Fsrc%2Fmut_visit%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2470e74e133de90c227e6d22dfd3391277333b3/compiler%2Frustc_expand%2Fsrc%2Fmut_visit%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmut_visit%2Ftests.rs?ref=d2470e74e133de90c227e6d22dfd3391277333b3", "patch": "@@ -15,9 +15,8 @@ fn print_crate_items(krate: &ast::Crate) -> String {\n struct ToZzIdentMutVisitor;\n \n impl MutVisitor for ToZzIdentMutVisitor {\n-    fn token_visiting_enabled(&self) -> bool {\n-        true\n-    }\n+    const VISIT_TOKENS: bool = true;\n+\n     fn visit_ident(&mut self, ident: &mut Ident) {\n         *ident = Ident::from_str(\"zz\");\n     }"}]}