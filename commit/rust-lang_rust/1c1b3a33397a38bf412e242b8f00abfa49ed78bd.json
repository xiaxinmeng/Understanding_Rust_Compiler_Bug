{"sha": "1c1b3a33397a38bf412e242b8f00abfa49ed78bd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFjMWIzYTMzMzk3YTM4YmY0MTJlMjQyYjhmMDBhYmZhNDllZDc4YmQ=", "commit": {"author": {"name": "Eric Holk", "email": "eric.holk@gmail.com", "date": "2012-07-09T22:29:23Z"}, "committer": {"name": "Eric Holk", "email": "eric.holk@gmail.com", "date": "2012-07-11T05:00:46Z"}, "message": "Added peek for pipes.", "tree": {"sha": "b9d074eb4bcf481ccc9f138c7fe3af92504962be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b9d074eb4bcf481ccc9f138c7fe3af92504962be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c1b3a33397a38bf412e242b8f00abfa49ed78bd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c1b3a33397a38bf412e242b8f00abfa49ed78bd", "html_url": "https://github.com/rust-lang/rust/commit/1c1b3a33397a38bf412e242b8f00abfa49ed78bd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c1b3a33397a38bf412e242b8f00abfa49ed78bd/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "69cd8b5fcb559ff3342258273f2cc81023f699ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/69cd8b5fcb559ff3342258273f2cc81023f699ba", "html_url": "https://github.com/rust-lang/rust/commit/69cd8b5fcb559ff3342258273f2cc81023f699ba"}], "stats": {"total": 46, "additions": 46, "deletions": 0}, "files": [{"sha": "6f61b12ab4091261eb203c6785e5df8e9a7ecec5", "filename": "src/libcore/pipes.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1c1b3a33397a38bf412e242b8f00abfa49ed78bd/src%2Flibcore%2Fpipes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c1b3a33397a38bf412e242b8f00abfa49ed78bd/src%2Flibcore%2Fpipes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fpipes.rs?ref=1c1b3a33397a38bf412e242b8f00abfa49ed78bd", "patch": "@@ -144,6 +144,15 @@ fn recv<T: send>(-p: recv_packet<T>) -> option<T> {\n     }\n }\n \n+/// Returns true if messages are available.\n+fn peek<T: send>(p: recv_packet<T>) -> bool {\n+    alt p.header().state {\n+      empty { false }\n+      blocked { fail \"peeking on blocked packet\" }\n+      full | terminated { true }\n+    }\n+}\n+\n fn sender_terminate<T: send>(p: *packet<T>) {\n     let p = unsafe { uniquify(p) };\n     alt swap_state_rel(p.header.state, terminated) {\n@@ -337,6 +346,20 @@ class recv_packet<T: send> {\n         p <-> self.p;\n         option::unwrap(p)\n     }\n+\n+    fn header() -> &self.packet_header {\n+        alt self.p {\n+          some(packet) {\n+            unsafe {\n+                let packet = uniquify(packet);\n+                let header = reinterpret_cast(&packet.header);\n+                forget(packet);\n+                header\n+            }\n+          }\n+          none { fail \"packet already consumed\" }\n+        }\n+    }\n }\n \n fn entangle<T: send>() -> (send_packet<T>, recv_packet<T>) {"}, {"sha": "9a2451cd47a0c1c2fc4653ac33280097f270d471", "filename": "src/test/run-pass/pipe-peek.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1c1b3a33397a38bf412e242b8f00abfa49ed78bd/src%2Ftest%2Frun-pass%2Fpipe-peek.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c1b3a33397a38bf412e242b8f00abfa49ed78bd/src%2Ftest%2Frun-pass%2Fpipe-peek.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fpipe-peek.rs?ref=1c1b3a33397a38bf412e242b8f00abfa49ed78bd", "patch": "@@ -0,0 +1,23 @@\n+// xfail-pretty\n+\n+use std;\n+import std::timer::sleep;\n+import std::uv;\n+\n+proto! oneshot {\n+    waiting:send {\n+        signal -> signaled\n+    }\n+\n+    signaled:send { }\n+}\n+\n+fn main() {\n+    let (c, p) = oneshot::init();\n+\n+    assert !pipes::peek(p);\n+\n+    oneshot::client::signal(c);\n+\n+    assert pipes::peek(p);\n+}"}]}