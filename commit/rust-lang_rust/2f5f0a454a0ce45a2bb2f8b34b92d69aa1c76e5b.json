{"sha": "2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmNWYwYTQ1NGEwY2U0NWEyYmIyZjhiMzRiOTJkNjlhYTFjNzZlNWI=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2016-04-11T22:47:08Z"}, "committer": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2016-04-11T22:47:08Z"}, "message": "Merge pull request #912 from rust-lang-nursery/pat-simple-mixed\n\nChange the logic around breaking multiple patterns in match arms", "tree": {"sha": "5b7e34d62c21ab4c3db37ebdb9597232862a0792", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5b7e34d62c21ab4c3db37ebdb9597232862a0792"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "html_url": "https://github.com/rust-lang/rust/commit/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce97bc08be91d931b5c8ec62bc35c4915b63c8d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce97bc08be91d931b5c8ec62bc35c4915b63c8d5", "html_url": "https://github.com/rust-lang/rust/commit/ce97bc08be91d931b5c8ec62bc35c4915b63c8d5"}, {"sha": "5dc3283e49cc739425a314c1b0837c72f0d6909d", "url": "https://api.github.com/repos/rust-lang/rust/commits/5dc3283e49cc739425a314c1b0837c72f0d6909d", "html_url": "https://github.com/rust-lang/rust/commit/5dc3283e49cc739425a314c1b0837c72f0d6909d"}], "stats": {"total": 144, "additions": 101, "deletions": 43}, "files": [{"sha": "0fecdd49a087eac438d3a326cc57144bbdaa91e6", "filename": "src/config.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -98,7 +98,8 @@ impl Density {\n     pub fn to_list_tactic(self) -> ListTactic {\n         match self {\n             Density::Compressed => ListTactic::Mixed,\n-            Density::Tall | Density::CompressedIfEmpty => ListTactic::HorizontalVertical,\n+            Density::Tall |\n+            Density::CompressedIfEmpty => ListTactic::HorizontalVertical,\n             Density::Vertical => ListTactic::Vertical,\n         }\n     }"}, {"sha": "7ee69885a429da8f58ab2b037e10b7e13821871b", "filename": "src/expr.rs", "status": "modified", "additions": 38, "deletions": 34, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -21,7 +21,7 @@ use lists::{write_list, itemize_list, ListFormatting, SeparatorTactic, ListTacti\n             DefinitiveListTactic, definitive_tactic, ListItem, format_item_list};\n use string::{StringFormat, rewrite_string};\n use utils::{CodeMapSpanUtils, extra_offset, last_line_width, wrap_str, binary_search,\n-            first_line_width, semicolon_for_stmt};\n+            first_line_width, semicolon_for_stmt, trimmed_last_line_width};\n use visitor::FmtVisitor;\n use config::{Config, StructLitStyle, MultilineStyle};\n use comment::{FindUncommented, rewrite_comment, contains_comment, recover_comment_removed};\n@@ -497,7 +497,8 @@ impl Rewrite for ast::Stmt {\n                     None\n                 }\n             }\n-            ast::StmtKind::Expr(ref ex, _) | ast::StmtKind::Semi(ref ex, _) => {\n+            ast::StmtKind::Expr(ref ex, _) |\n+            ast::StmtKind::Semi(ref ex, _) => {\n                 let suffix = if semicolon_for_stmt(self) {\n                     \";\"\n                 } else {\n@@ -953,7 +954,6 @@ fn arm_comma(config: &Config, arm: &ast::Arm, body: &ast::Expr) -> &'static str\n impl Rewrite for ast::Arm {\n     fn rewrite(&self, context: &RewriteContext, width: usize, offset: Indent) -> Option<String> {\n         let &ast::Arm { ref attrs, ref pats, ref guard, ref body } = self;\n-        let indent_str = offset.to_string(context.config);\n \n         // FIXME this is all a bit grotty, would be nice to abstract out the\n         // treatment of attributes.\n@@ -980,38 +980,34 @@ impl Rewrite for ast::Arm {\n                                     .map(|p| p.rewrite(context, pat_budget, offset))\n                                     .collect::<Option<Vec<_>>>());\n \n-        let mut total_width = pat_strs.iter().fold(0, |a, p| a + p.len());\n-        // Add ` | `.len().\n-        total_width += (pat_strs.len() - 1) * 3;\n-\n-        let mut vertical = total_width > pat_budget || pat_strs.iter().any(|p| p.contains('\\n'));\n-        if !vertical && context.config.take_source_hints {\n-            // If the patterns were previously stacked, keep them stacked.\n-            let pat_span = mk_sp(pats[0].span.lo, pats[pats.len() - 1].span.hi);\n-            let pat_str = context.snippet(pat_span);\n-            vertical = pat_str.contains('\\n');\n-        }\n+        let all_simple = pat_strs.iter().all(|p| pat_is_simple(&p));\n+        let items: Vec<_> = pat_strs.into_iter().map(|s| ListItem::from_str(s)).collect();\n+        let fmt = ListFormatting {\n+            tactic: if all_simple {\n+                DefinitiveListTactic::Mixed\n+            } else {\n+                DefinitiveListTactic::Vertical\n+            },\n+            separator: \" |\",\n+            trailing_separator: SeparatorTactic::Never,\n+            indent: offset,\n+            width: pat_budget,\n+            ends_with_newline: false,\n+            config: context.config,\n+        };\n+        let pats_str = try_opt!(write_list(items, &fmt));\n \n-        let pats_width = if vertical {\n-            pat_strs.last().unwrap().len()\n+        let budget = if pats_str.contains('\\n') {\n+            context.config.max_width - offset.width()\n         } else {\n-            total_width\n+            width\n         };\n \n-        let mut pats_str = String::new();\n-        for p in pat_strs {\n-            if !pats_str.is_empty() {\n-                if vertical {\n-                    pats_str.push_str(\" |\\n\");\n-                    pats_str.push_str(&indent_str);\n-                } else {\n-                    pats_str.push_str(\" | \");\n-                }\n-            }\n-            pats_str.push_str(&p);\n-        }\n-\n-        let guard_str = try_opt!(rewrite_guard(context, guard, width, offset, pats_width));\n+        let guard_str = try_opt!(rewrite_guard(context,\n+                                               guard,\n+                                               budget,\n+                                               offset,\n+                                               trimmed_last_line_width(&pats_str)));\n \n         let pats_str = format!(\"{}{}\", pats_str, guard_str);\n         // Where the next text can start.\n@@ -1023,7 +1019,7 @@ impl Rewrite for ast::Arm {\n         let body = match **body {\n             ast::Expr { node: ast::ExprKind::Block(ref block), .. }\n                 if !is_unsafe_block(block) && is_simple_block(block, context.codemap) &&\n-                context.config.wrap_match_arms => block.expr.as_ref().map(|e| &**e).unwrap(),\n+                   context.config.wrap_match_arms => block.expr.as_ref().map(|e| &**e).unwrap(),\n             ref x => x,\n         };\n \n@@ -1085,6 +1081,13 @@ impl Rewrite for ast::Arm {\n     }\n }\n \n+// A pattern is simple if it is very short or it is short-ish and just a path.\n+// E.g. `Foo::Bar` is simple, but `Foo(..)` is not.\n+fn pat_is_simple(pat_str: &str) -> bool {\n+    pat_str.len() <= 16 ||\n+    (pat_str.len() <= 24 && pat_str.chars().all(|c| c.is_alphabetic() || c == ':'))\n+}\n+\n // The `if ...` guard on a match arm.\n fn rewrite_guard(context: &RewriteContext,\n                  guard: &Option<ptr::P<ast::Expr>>,\n@@ -1106,11 +1109,12 @@ fn rewrite_guard(context: &RewriteContext,\n         }\n \n         // Not enough space to put the guard after the pattern, try a newline.\n-        let overhead = context.config.tab_spaces + 4 + 5;\n+        let overhead = offset.block_indent(context.config).width() + 4 + 5;\n         if overhead < width {\n             let cond_str = guard.rewrite(context,\n                                          width - overhead,\n-                                         offset.block_indent(context.config));\n+                                         // 3 == `if `\n+                                         offset.block_indent(context.config) + 3);\n             if let Some(cond_str) = cond_str {\n                 return Some(format!(\"\\n{}if {}\",\n                                     offset.block_indent(context.config).to_string(context.config),"}, {"sha": "2be271e140b8ca836a0effe3f784d26dd77f6be0", "filename": "src/macros.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -58,7 +58,8 @@ pub fn rewrite_macro(mac: &ast::Mac,\n                      -> Option<String> {\n     let original_style = macro_style(mac, context);\n     let macro_name = match extra_ident {\n-        None | Some(ast::Ident { name: ast::Name(0), .. }) => format!(\"{}!\", mac.node.path),\n+        None |\n+        Some(ast::Ident { name: ast::Name(0), .. }) => format!(\"{}!\", mac.node.path),\n         Some(ident) => format!(\"{}! {}\", mac.node.path, ident),\n     };\n     let style = if FORCED_BRACKET_MACROS.contains(&&macro_name[..]) {"}, {"sha": "51bebc409e09ed3c8f85ec15c7ed5bcc4a532973", "filename": "src/types.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftypes.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -552,7 +552,8 @@ impl Rewrite for ast::Ty {\n             ast::TyKind::BareFn(ref bare_fn) => {\n                 rewrite_bare_fn(bare_fn, self.span, context, width, offset)\n             }\n-            ast::TyKind::Mac(..) | ast::TyKind::Typeof(..) => unreachable!(),\n+            ast::TyKind::Mac(..) |\n+            ast::TyKind::Typeof(..) => unreachable!(),\n         }\n     }\n }"}, {"sha": "862ceb1e13eb0974c4497e3a576f7f24060b08d3", "filename": "src/utils.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -113,6 +113,13 @@ pub fn last_line_width(s: &str) -> usize {\n         None => s.len(),\n     }\n }\n+#[inline]\n+pub fn trimmed_last_line_width(s: &str) -> usize {\n+    match s.rfind('\\n') {\n+        Some(n) => s[(n + 1)..].trim().len(),\n+        None => s.trim().len(),\n+    }\n+}\n \n #[inline]\n fn is_skip(meta_item: &MetaItem) -> bool {"}, {"sha": "cc97c2289f015c98bb123c73e8b3e7f2787bc482", "filename": "src/visitor.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -46,7 +46,8 @@ impl<'a> FmtVisitor<'a> {\n                     self.push_rewrite(stmt.span, rewrite);\n                 }\n             }\n-            ast::StmtKind::Expr(..) | ast::StmtKind::Semi(..) => {\n+            ast::StmtKind::Expr(..) |\n+            ast::StmtKind::Semi(..) => {\n                 let rewrite = stmt.rewrite(&self.get_context(),\n                                            self.config.max_width - self.block_indent.width(),\n                                            self.block_indent);"}, {"sha": "a9fb540404729e6b001f7f6722a7514400a971ef", "filename": "tests/source/match.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/tests%2Fsource%2Fmatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/tests%2Fsource%2Fmatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmatch.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -274,3 +274,23 @@ fn issue494() {\n         }\n     }\n }\n+\n+fn issue386() {\n+    match foo {\n+        BiEq | BiLt | BiLe | BiNe | BiGt | BiGe =>\n+                    true,\n+        BiAnd | BiOr | BiAdd | BiSub | BiMul | BiDiv | BiRem |\n+        BiBitXor | BiBitAnd | BiBitOr | BiShl | BiShr =>\n+            false,\n+    }\n+}\n+\n+fn guards() {\n+    match foo {\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa if foooooooooooooo && barrrrrrrrrrrr => {}\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa | aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa if foooooooooooooo && barrrrrrrrrrrr => {}\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n+            if fooooooooooooooooooooo &&\n+               (bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb || cccccccccccccccccccccccccccccccccccccccc) => {}\n+    }\n+}"}, {"sha": "bc5556283c37f778f68fd9bbfccc4d3899305786", "filename": "tests/target/match.rs", "status": "modified", "additions": 28, "deletions": 5, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/tests%2Ftarget%2Fmatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b/tests%2Ftarget%2Fmatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmatch.rs?ref=2f5f0a454a0ce45a2bb2f8b34b92d69aa1c76e5b", "patch": "@@ -221,9 +221,8 @@ fn issue355() {\n fn issue280() {\n     {\n         match x {\n-            CompressionMode::DiscardNewline | CompressionMode::CompressWhitespaceNewline => {\n-                ch == '\\n'\n-            }\n+            CompressionMode::DiscardNewline |\n+            CompressionMode::CompressWhitespaceNewline => ch == '\\n',\n             ast::ItemConst(ref typ, ref expr) => {\n                 self.process_static_or_const_item(item, &typ, &expr)\n             }\n@@ -260,7 +259,8 @@ fn issue496() {\n         {\n             {\n                 match def {\n-                    def::DefConst(def_id) | def::DefAssociatedConst(def_id) => {\n+                    def::DefConst(def_id) |\n+                    def::DefAssociatedConst(def_id) => {\n                         match const_eval::lookup_const_by_id(cx.tcx, def_id, Some(self.pat.id)) {\n                             Some(const_expr) => x,\n                         }\n@@ -274,7 +274,8 @@ fn issue496() {\n fn issue494() {\n     {\n         match stmt.node {\n-            hir::StmtExpr(ref expr, id) | hir::StmtSemi(ref expr, id) => {\n+            hir::StmtExpr(ref expr, id) |\n+            hir::StmtSemi(ref expr, id) => {\n                 result.push(StmtRef::Mirror(Box::new(Stmt {\n                     span: stmt.span,\n                     kind: StmtKind::Expr {\n@@ -286,3 +287,25 @@ fn issue494() {\n         }\n     }\n }\n+\n+fn issue386() {\n+    match foo {\n+        BiEq | BiLt | BiLe | BiNe | BiGt | BiGe => true,\n+        BiAnd | BiOr | BiAdd | BiSub | BiMul | BiDiv | BiRem | BiBitXor | BiBitAnd | BiBitOr |\n+        BiShl | BiShr => false,\n+    }\n+}\n+\n+fn guards() {\n+    match foo {\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa if foooooooooooooo &&\n+                                                                      barrrrrrrrrrrr => {}\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa |\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa if foooooooooooooo &&\n+                                                                      barrrrrrrrrrrr => {}\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n+            if fooooooooooooooooooooo &&\n+               (bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb ||\n+                cccccccccccccccccccccccccccccccccccccccc) => {}\n+    }\n+}"}]}