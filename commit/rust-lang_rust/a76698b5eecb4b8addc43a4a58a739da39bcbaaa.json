{"sha": "a76698b5eecb4b8addc43a4a58a739da39bcbaaa", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3NjY5OGI1ZWVjYjRiOGFkZGM0M2E0YTU4YTczOWRhMzliY2JhYWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-06-12T13:05:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-06-12T13:05:55Z"}, "message": "Auto merge of #34045 - ollie27:rustdoc_stripped, r=brson\n\nrustdoc: Don't generate empty files for stripped items\n\nWe need to traverse stripped modules to generate redirect pages, but we shouldn't generate\nanything else for them.\n\nThis now renders the file contents to a Vec before writing it to a file in one go. I think\nthat's probably a better strategy anyway.\n\nFixes: #34025", "tree": {"sha": "94c15b76f7e08abc7a3a753c2a269b1cdbceab30", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/94c15b76f7e08abc7a3a753c2a269b1cdbceab30"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a76698b5eecb4b8addc43a4a58a739da39bcbaaa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a76698b5eecb4b8addc43a4a58a739da39bcbaaa", "html_url": "https://github.com/rust-lang/rust/commit/a76698b5eecb4b8addc43a4a58a739da39bcbaaa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a76698b5eecb4b8addc43a4a58a739da39bcbaaa/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b1b752655d374819064bf01ba760305ad3a1f623", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1b752655d374819064bf01ba760305ad3a1f623", "html_url": "https://github.com/rust-lang/rust/commit/b1b752655d374819064bf01ba760305ad3a1f623"}, {"sha": "cfb4ad2f2383d20f6446d8c63a3e992edbb8b8b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/cfb4ad2f2383d20f6446d8c63a3e992edbb8b8b8", "html_url": "https://github.com/rust-lang/rust/commit/cfb4ad2f2383d20f6446d8c63a3e992edbb8b8b8"}], "stats": {"total": 63, "additions": 46, "deletions": 17}, "files": [{"sha": "617d2a9b58d09b4a4f8fcdfd4d0b056697745e7c", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 24, "deletions": 17, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/a76698b5eecb4b8addc43a4a58a739da39bcbaaa/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a76698b5eecb4b8addc43a4a58a739da39bcbaaa/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=a76698b5eecb4b8addc43a4a58a739da39bcbaaa", "patch": "@@ -1257,7 +1257,6 @@ impl Context {\n \n         info!(\"Recursing into {}\", self.dst.display());\n \n-        mkdir(&self.dst).unwrap();\n         let ret = f(self);\n \n         info!(\"Recursed; leaving {}\", self.dst.display());\n@@ -1301,7 +1300,7 @@ impl Context {\n     fn item<F>(&mut self, item: clean::Item, mut f: F) -> Result<(), Error> where\n         F: FnMut(&mut Context, clean::Item),\n     {\n-        fn render(w: File, cx: &Context, it: &clean::Item,\n+        fn render(writer: &mut io::Write, cx: &Context, it: &clean::Item,\n                   pushname: bool) -> io::Result<()> {\n             // A little unfortunate that this is done like this, but it sure\n             // does make formatting *a lot* nicer.\n@@ -1336,12 +1335,8 @@ impl Context {\n \n             reset_ids(true);\n \n-            // We have a huge number of calls to write, so try to alleviate some\n-            // of the pain by using a buffered writer instead of invoking the\n-            // write syscall all the time.\n-            let mut writer = BufWriter::new(w);\n             if !cx.render_redirect_pages {\n-                layout::render(&mut writer, &cx.shared.layout, &page,\n+                layout::render(writer, &cx.shared.layout, &page,\n                                &Sidebar{ cx: cx, item: it },\n                                &Item{ cx: cx, item: it },\n                                cx.shared.css_file_extension.is_some())?;\n@@ -1354,10 +1349,10 @@ impl Context {\n                         url.push_str(\"/\");\n                     }\n                     url.push_str(&item_path(it));\n-                    layout::redirect(&mut writer, &url)?;\n+                    layout::redirect(writer, &url)?;\n                 }\n             }\n-            writer.flush()\n+            Ok(())\n         }\n \n         // Stripped modules survive the rustdoc passes (i.e. `strip-private`)\n@@ -1378,9 +1373,16 @@ impl Context {\n             let mut item = Some(item);\n             self.recurse(name, |this| {\n                 let item = item.take().unwrap();\n-                let joint_dst = this.dst.join(\"index.html\");\n-                let dst = try_err!(File::create(&joint_dst), &joint_dst);\n-                try_err!(render(dst, this, &item, false), &joint_dst);\n+\n+                let mut buf = Vec::new();\n+                render(&mut buf, this, &item, false).unwrap();\n+                // buf will be empty if the module is stripped and there is no redirect for it\n+                if !buf.is_empty() {\n+                    let joint_dst = this.dst.join(\"index.html\");\n+                    try_err!(fs::create_dir_all(&this.dst), &this.dst);\n+                    let mut dst = try_err!(File::create(&joint_dst), &joint_dst);\n+                    try_err!(dst.write_all(&buf), &joint_dst);\n+                }\n \n                 let m = match item.inner {\n                     clean::StrippedItem(box clean::ModuleItem(m)) |\n@@ -1389,7 +1391,7 @@ impl Context {\n                 };\n \n                 // render sidebar-items.js used throughout this module\n-                {\n+                if !this.render_redirect_pages {\n                     let items = this.build_sidebar_items(&m);\n                     let js_dst = this.dst.join(\"sidebar-items.js\");\n                     let mut js_out = BufWriter::new(try_err!(File::create(&js_dst), &js_dst));\n@@ -1403,10 +1405,15 @@ impl Context {\n                 Ok(())\n             })\n         } else if item.name.is_some() {\n-            let joint_dst = self.dst.join(&item_path(&item));\n-\n-            let dst = try_err!(File::create(&joint_dst), &joint_dst);\n-            try_err!(render(dst, self, &item, true), &joint_dst);\n+            let mut buf = Vec::new();\n+            render(&mut buf, self, &item, true).unwrap();\n+            // buf will be empty if the item is stripped and there is no redirect for it\n+            if !buf.is_empty() {\n+                let joint_dst = self.dst.join(&item_path(&item));\n+                try_err!(fs::create_dir_all(&self.dst), &self.dst);\n+                let mut dst = try_err!(File::create(&joint_dst), &joint_dst);\n+                try_err!(dst.write_all(&buf), &joint_dst);\n+            }\n             Ok(())\n         } else {\n             Ok(())"}, {"sha": "8c0a7703c91da216c3e24106b2019d7e1d51b552", "filename": "src/test/rustdoc/issue-34025.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a76698b5eecb4b8addc43a4a58a739da39bcbaaa/src%2Ftest%2Frustdoc%2Fissue-34025.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a76698b5eecb4b8addc43a4a58a739da39bcbaaa/src%2Ftest%2Frustdoc%2Fissue-34025.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-34025.rs?ref=a76698b5eecb4b8addc43a4a58a739da39bcbaaa", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_name = \"foo\"]\n+\n+// @!has 'foo/sys/index.html'\n+// @!has 'foo/sys/sidebar-items.js'\n+#[doc(hidden)]\n+pub mod sys {\n+    extern \"C\" {\n+        // @!has 'foo/sys/fn.foo.html'\n+        #[doc(hidden)]\n+        pub fn foo();\n+    }\n+}"}]}