{"sha": "9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmYTlkMTY2ZDgxNDFiYjljYTRmY2YwNTQ0YzQ5YjkwM2ZiODVlMDk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-05-11T13:14:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-11T13:14:55Z"}, "message": "Merge #8800\n\n8800: feat: Make \"pull assignments up\" assist work in more cases r=Jesse-Bakker a=Jesse-Bakker\n\nFixes #8771\n\nCo-authored-by: Jesse Bakker <github@jessebakker.com>", "tree": {"sha": "6dbb562ae3d94aad193402e2677341758d3a08b7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6dbb562ae3d94aad193402e2677341758d3a08b7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgmoNPCRBK7hj4Ov3rIwAAUJAIAHViYEOoRjHsqKvZYn/BiL5f\nThaqdXu95uylt9xIyoWIaI5nEZso73+QW8q7SF/iUej+ClsmG91rXZiAKOpWE5Kh\nQ50a0LM9hGAOsioHZ8ZxxQixn2H5pwPN6tBK/vAHSvB9kG+QneeA4D76WmMm97hp\nJ7/R6KkGvFkkKc2cVXU3t5sFrYkVDVuDViPB7uHyfA/BpmzdZolj1GGLG41TB+8W\nVcloOifnp4gzFDSsToGpG3wrQOSiY5CkP+1ZXriIYltIqW+Qttb31ZZtkOQekji4\nJdpPvRXsZYjox5wVrSr3NrKNsPqJxtEdJqiCKF3re+/0e8lAOMzyfjTTo2Sedv4=\n=MVQf\n-----END PGP SIGNATURE-----\n", "payload": "tree 6dbb562ae3d94aad193402e2677341758d3a08b7\nparent 77518991b83dc8673f5c25cf252af7956469e554\nparent 5f37e344061cb0655fc8d8ee10e937ddc308ffad\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1620738895 +0000\ncommitter GitHub <noreply@github.com> 1620738895 +0000\n\nMerge #8800\n\n8800: feat: Make \"pull assignments up\" assist work in more cases r=Jesse-Bakker a=Jesse-Bakker\n\nFixes #8771\n\nCo-authored-by: Jesse Bakker <github@jessebakker.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "html_url": "https://github.com/rust-lang/rust/commit/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77518991b83dc8673f5c25cf252af7956469e554", "url": "https://api.github.com/repos/rust-lang/rust/commits/77518991b83dc8673f5c25cf252af7956469e554", "html_url": "https://github.com/rust-lang/rust/commit/77518991b83dc8673f5c25cf252af7956469e554"}, {"sha": "5f37e344061cb0655fc8d8ee10e937ddc308ffad", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f37e344061cb0655fc8d8ee10e937ddc308ffad", "html_url": "https://github.com/rust-lang/rust/commit/5f37e344061cb0655fc8d8ee10e937ddc308ffad"}], "stats": {"total": 50, "additions": 34, "deletions": 16}, "files": [{"sha": "3128faa68bc190f576af4bb5b737c807600452a7", "filename": "crates/ide_assists/src/handlers/pull_assignment_up.rs", "status": "modified", "additions": 34, "deletions": 16, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fpull_assignment_up.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fa9d166d8141bb9ca4fcf0544c49b903fb85e09/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fpull_assignment_up.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fpull_assignment_up.rs?ref=9fa9d166d8141bb9ca4fcf0544c49b903fb85e09", "patch": "@@ -60,6 +60,12 @@ pub(crate) fn pull_assignment_up(acc: &mut Assists, ctx: &AssistContext) -> Opti\n         return None;\n     };\n \n+    if let Some(parent) = tgt.syntax().parent() {\n+        if matches!(parent.kind(), syntax::SyntaxKind::BIN_EXPR | syntax::SyntaxKind::LET_STMT) {\n+            return None;\n+        }\n+    }\n+\n     acc.add(\n         AssistId(\"pull_assignment_up\", AssistKind::RefactorExtract),\n         \"Pull assignment up\",\n@@ -74,7 +80,13 @@ pub(crate) fn pull_assignment_up(acc: &mut Assists, ctx: &AssistContext) -> Opti\n             let tgt = edit.make_ast_mut(tgt);\n \n             for (stmt, rhs) in assignments {\n-                ted::replace(stmt.syntax(), rhs.syntax());\n+                let mut stmt = stmt.syntax().clone();\n+                if let Some(parent) = stmt.parent() {\n+                    if ast::ExprStmt::cast(parent.clone()).is_some() {\n+                        stmt = parent.clone();\n+                    }\n+                }\n+                ted::replace(stmt, rhs.syntax());\n             }\n             let assign_expr = make::expr_assignment(collector.common_lhs, tgt.clone());\n             let assign_stmt = make::expr_stmt(assign_expr);\n@@ -87,14 +99,15 @@ pub(crate) fn pull_assignment_up(acc: &mut Assists, ctx: &AssistContext) -> Opti\n struct AssignmentsCollector<'a> {\n     sema: &'a hir::Semantics<'a, ide_db::RootDatabase>,\n     common_lhs: ast::Expr,\n-    assignments: Vec<(ast::ExprStmt, ast::Expr)>,\n+    assignments: Vec<(ast::BinExpr, ast::Expr)>,\n }\n \n impl<'a> AssignmentsCollector<'a> {\n     fn collect_match(&mut self, match_expr: &ast::MatchExpr) -> Option<()> {\n         for arm in match_expr.match_arm_list()?.arms() {\n             match arm.expr()? {\n                 ast::Expr::BlockExpr(block) => self.collect_block(&block)?,\n+                ast::Expr::BinExpr(expr) => self.collect_expr(&expr)?,\n                 _ => return None,\n             }\n         }\n@@ -114,24 +127,30 @@ impl<'a> AssignmentsCollector<'a> {\n         }\n     }\n     fn collect_block(&mut self, block: &ast::BlockExpr) -> Option<()> {\n-        if block.tail_expr().is_some() {\n-            return None;\n-        }\n-\n-        let last_stmt = block.statements().last()?;\n-        if let ast::Stmt::ExprStmt(stmt) = last_stmt {\n-            if let ast::Expr::BinExpr(expr) = stmt.expr()? {\n-                if expr.op_kind()? == ast::BinOp::Assignment\n-                    && is_equivalent(self.sema, &expr.lhs()?, &self.common_lhs)\n-                {\n-                    self.assignments.push((stmt, expr.rhs()?));\n-                    return Some(());\n-                }\n+        let last_expr = block.tail_expr().or_else(|| {\n+            if let ast::Stmt::ExprStmt(stmt) = block.statements().last()? {\n+                stmt.expr()\n+            } else {\n+                None\n             }\n+        })?;\n+\n+        if let ast::Expr::BinExpr(expr) = last_expr {\n+            return self.collect_expr(&expr);\n         }\n \n         None\n     }\n+\n+    fn collect_expr(&mut self, expr: &ast::BinExpr) -> Option<()> {\n+        if expr.op_kind()? == ast::BinOp::Assignment\n+            && is_equivalent(self.sema, &expr.lhs()?, &self.common_lhs)\n+        {\n+            self.assignments.push((expr.clone(), expr.rhs()?));\n+            return Some(());\n+        }\n+        None\n+    }\n }\n \n fn is_equivalent(\n@@ -241,7 +260,6 @@ fn foo() {\n     }\n \n     #[test]\n-    #[ignore]\n     fn test_pull_assignment_up_assignment_expressions() {\n         check_assist(\n             pull_assignment_up,"}]}