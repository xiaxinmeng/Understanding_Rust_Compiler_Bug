{"sha": "1d8290568506e5d85422f23ab73ce79519201995", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkODI5MDU2ODUwNmU1ZDg1NDIyZjIzYWI3M2NlNzk1MTkyMDE5OTU=", "commit": {"author": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-09-12T20:36:58Z"}, "committer": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-09-16T12:12:28Z"}, "message": "Fix rebase", "tree": {"sha": "b28bb322353aba77a4a1179005a247fedf64e767", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b28bb322353aba77a4a1179005a247fedf64e767"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d8290568506e5d85422f23ab73ce79519201995", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d8290568506e5d85422f23ab73ce79519201995", "html_url": "https://github.com/rust-lang/rust/commit/1d8290568506e5d85422f23ab73ce79519201995", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d8290568506e5d85422f23ab73ce79519201995/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88a532106034a271bcbb9c48339a306499b86eb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/88a532106034a271bcbb9c48339a306499b86eb9", "html_url": "https://github.com/rust-lang/rust/commit/88a532106034a271bcbb9c48339a306499b86eb9"}], "stats": {"total": 39, "additions": 24, "deletions": 15}, "files": [{"sha": "f006bede409907b7cc356177fb00385b5b93f97e", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1d8290568506e5d85422f23ab73ce79519201995/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d8290568506e5d85422f23ab73ce79519201995/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=1d8290568506e5d85422f23ab73ce79519201995", "patch": "@@ -9,6 +9,7 @@ use crate::traits::normalize_projection_type;\n \n use rustc_data_structures::fx::FxHashSet;\n use rustc_data_structures::stack::ensure_sufficient_stack;\n+use rustc_data_structures::sync::Lrc;\n use rustc_errors::{error_code, struct_span_err, Applicability, DiagnosticBuilder, Style};\n use rustc_hir as hir;\n use rustc_hir::def::DefKind;\n@@ -678,19 +679,18 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n         has_custom_message: bool,\n     ) -> bool {\n         let span = obligation.cause.span;\n-        let points_at_for_iter = matches!(\n-            span.ctxt().outer_expn_data().kind,\n-            ExpnKind::Desugaring(DesugaringKind::ForLoop(ForLoopLoc::IntoIter))\n-        );\n \n-        let code =\n-            if let (ObligationCauseCode::FunctionArgumentObligation { parent_code, .. }, false) =\n-                (&obligation.cause.code, points_at_for_iter)\n-            {\n-                parent_code.clone()\n-            } else {\n-                return false;\n-            };\n+        let code = if let ObligationCauseCode::FunctionArgumentObligation { parent_code, .. } =\n+            &obligation.cause.code\n+        {\n+            parent_code.clone()\n+        } else if let ExpnKind::Desugaring(DesugaringKind::ForLoop(ForLoopLoc::IntoIter)) =\n+            span.ctxt().outer_expn_data().kind\n+        {\n+            Lrc::new(obligation.cause.code.clone())\n+        } else {\n+            return false;\n+        };\n \n         // List of traits for which it would be nonsensical to suggest borrowing.\n         // For instance, immutable references are always Copy, so suggesting to"}, {"sha": "14d28b59648c1abfe943890319391d7f82ce3091", "filename": "src/test/ui/expr/malformed_closure/ruby_style_closure.stderr", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/1d8290568506e5d85422f23ab73ce79519201995/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1d8290568506e5d85422f23ab73ce79519201995/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr?ref=1d8290568506e5d85422f23ab73ce79519201995", "patch": "@@ -5,10 +5,19 @@ LL |         Some(x * 2)\n    |              ^ not found in this scope\n \n error[E0277]: expected a `FnOnce<({integer},)>` closure, found `Option<_>`\n-  --> $DIR/ruby_style_closure.rs:10:22\n+  --> $DIR/ruby_style_closure.rs:10:31\n    |\n-LL |     let p = Some(45).and_then({\n-   |                      ^^^^^^^^ expected an `FnOnce<({integer},)>` closure, found `Option<_>`\n+LL |       let p = Some(45).and_then({\n+   |  ______________________--------_^\n+   | |                      |\n+   | |                      required by a bound introduced by this call\n+LL | |\n+LL | |         |x| println!(\"doubling {}\", x);\n+LL | |         Some(x * 2)\n+   | |         -----------\n+LL | |\n+LL | |     });\n+   | |_____^ expected an `FnOnce<({integer},)>` closure, found `Option<_>`\n    |\n    = help: the trait `FnOnce<({integer},)>` is not implemented for `Option<_>`\n "}]}