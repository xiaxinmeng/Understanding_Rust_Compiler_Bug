{"sha": "5afc63a2aef113d49944b6ee5f7a743198a6aff1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVhZmM2M2EyYWVmMTEzZDQ5OTQ0YjZlZTVmN2E3NDMxOThhNmFmZjE=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-02-01T13:56:51Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-02-01T14:17:22Z"}, "message": "Optimize u64_to_{le,be}_bytes\n\nLLVM fails to properly optimize the shifts used to convert the source\nvalue to the right endianess. The resulting assembly copies the value\nto the stack one byte at a time even when there's no conversion required\n(e.g. u64_to_le_bytes on a little endian machine).\n\nInstead of doing the conversion ourselves using shifts, we can use the\nexisting intrinsics to perform the endianess conversion and then\ntransmute the value to get a fixed vector of its bytes.\n\nBefore:\n\ntest be_i8  ... bench:     21442 ns/iter (+/- 70)\ntest be_i16 ... bench:     21447 ns/iter (+/- 45)\ntest be_i32 ... bench:     23832 ns/iter (+/- 63)\ntest be_i64 ... bench:     26887 ns/iter (+/- 267)\n\ntest le_i8  ... bench:     21442 ns/iter (+/- 56)\ntest le_i16 ... bench:     21448 ns/iter (+/- 36)\ntest le_i32 ... bench:     23825 ns/iter (+/- 153)\ntest le_i64 ... bench:     26271 ns/iter (+/- 138)\n\nAfter:\n\ntest be_i8  ... bench:     21438 ns/iter (+/- 10)\ntest be_i16 ... bench:     21441 ns/iter (+/- 15)\ntest be_i32 ... bench:     19057 ns/iter (+/- 6)\ntest be_i64 ... bench:     21439 ns/iter (+/- 34)\n\ntest le_i8  ... bench:     21438 ns/iter (+/- 19)\ntest le_i16 ... bench:     21439 ns/iter (+/- 8)\ntest le_i32 ... bench:     21439 ns/iter (+/- 19)\ntest le_i64 ... bench:     21438 ns/iter (+/- 22)", "tree": {"sha": "c775ff34c6d90ff12b98db9f63cd68063cabb4b6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c775ff34c6d90ff12b98db9f63cd68063cabb4b6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5afc63a2aef113d49944b6ee5f7a743198a6aff1", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5afc63a2aef113d49944b6ee5f7a743198a6aff1", "html_url": "https://github.com/rust-lang/rust/commit/5afc63a2aef113d49944b6ee5f7a743198a6aff1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5afc63a2aef113d49944b6ee5f7a743198a6aff1/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c80d28c8e322b6da49b7725d2b5e5b5cc86da822", "url": "https://api.github.com/repos/rust-lang/rust/commits/c80d28c8e322b6da49b7725d2b5e5b5cc86da822", "html_url": "https://github.com/rust-lang/rust/commit/c80d28c8e322b6da49b7725d2b5e5b5cc86da822"}], "stats": {"total": 42, "additions": 14, "deletions": 28}, "files": [{"sha": "548dc3efe92f0e80d788d608e8722c28642f7c16", "filename": "src/libstd/io/extensions.rs", "status": "modified", "additions": 14, "deletions": 28, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/5afc63a2aef113d49944b6ee5f7a743198a6aff1/src%2Flibstd%2Fio%2Fextensions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5afc63a2aef113d49944b6ee5f7a743198a6aff1/src%2Flibstd%2Fio%2Fextensions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fextensions.rs?ref=5afc63a2aef113d49944b6ee5f7a743198a6aff1", "patch": "@@ -51,23 +51,16 @@ impl<'r, R: Reader> Iterator<u8> for Bytes<'r, R> {\n }\n \n pub fn u64_to_le_bytes<T>(n: u64, size: uint, f: |v: &[u8]| -> T) -> T {\n+    use unstable::intrinsics::{to_le16, to_le32, to_le64};\n+    use cast::transmute;\n+\n+    // LLVM fails to properly optimize this when using shifts instead of the to_le* intrinsics\n     assert!(size <= 8u);\n     match size {\n       1u => f(&[n as u8]),\n-      2u => f(&[n as u8,\n-              (n >> 8) as u8]),\n-      4u => f(&[n as u8,\n-              (n >> 8) as u8,\n-              (n >> 16) as u8,\n-              (n >> 24) as u8]),\n-      8u => f(&[n as u8,\n-              (n >> 8) as u8,\n-              (n >> 16) as u8,\n-              (n >> 24) as u8,\n-              (n >> 32) as u8,\n-              (n >> 40) as u8,\n-              (n >> 48) as u8,\n-              (n >> 56) as u8]),\n+      2u => f(unsafe { transmute::<i16, [u8, ..2]>(to_le16(n as i16)) }),\n+      4u => f(unsafe { transmute::<i32, [u8, ..4]>(to_le32(n as i32)) }),\n+      8u => f(unsafe { transmute::<i64, [u8, ..8]>(to_le64(n as i64)) }),\n       _ => {\n \n         let mut bytes: ~[u8] = ~[];\n@@ -84,23 +77,16 @@ pub fn u64_to_le_bytes<T>(n: u64, size: uint, f: |v: &[u8]| -> T) -> T {\n }\n \n pub fn u64_to_be_bytes<T>(n: u64, size: uint, f: |v: &[u8]| -> T) -> T {\n+    use unstable::intrinsics::{to_be16, to_be32, to_be64};\n+    use cast::transmute;\n+\n+    // LLVM fails to properly optimize this when using shifts instead of the to_be* intrinsics\n     assert!(size <= 8u);\n     match size {\n       1u => f(&[n as u8]),\n-      2u => f(&[(n >> 8) as u8,\n-              n as u8]),\n-      4u => f(&[(n >> 24) as u8,\n-              (n >> 16) as u8,\n-              (n >> 8) as u8,\n-              n as u8]),\n-      8u => f(&[(n >> 56) as u8,\n-              (n >> 48) as u8,\n-              (n >> 40) as u8,\n-              (n >> 32) as u8,\n-              (n >> 24) as u8,\n-              (n >> 16) as u8,\n-              (n >> 8) as u8,\n-              n as u8]),\n+      2u => f(unsafe { transmute::<i16, [u8, ..2]>(to_be16(n as i16)) }),\n+      4u => f(unsafe { transmute::<i32, [u8, ..4]>(to_be32(n as i32)) }),\n+      8u => f(unsafe { transmute::<i64, [u8, ..8]>(to_be64(n as i64)) }),\n       _ => {\n         let mut bytes: ~[u8] = ~[];\n         let mut i = size;"}]}