{"sha": "27ebe5d33e08d92c1a032dc27f19094571bd19cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3ZWJlNWQzM2UwOGQ5MmMxYTAzMmRjMjdmMTkwOTQ1NzFiZDE5Y2Q=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-06-10T10:08:35Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-06-10T10:08:35Z"}, "message": "Reduce OUT_DIR special casing", "tree": {"sha": "9b967facb387f495acab99fc8d9850db5073cdab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b967facb387f495acab99fc8d9850db5073cdab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/27ebe5d33e08d92c1a032dc27f19094571bd19cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/27ebe5d33e08d92c1a032dc27f19094571bd19cd", "html_url": "https://github.com/rust-lang/rust/commit/27ebe5d33e08d92c1a032dc27f19094571bd19cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/27ebe5d33e08d92c1a032dc27f19094571bd19cd/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "560b98bc505be6ff70876df661e4055e1b38a78c", "url": "https://api.github.com/repos/rust-lang/rust/commits/560b98bc505be6ff70876df661e4055e1b38a78c", "html_url": "https://github.com/rust-lang/rust/commit/560b98bc505be6ff70876df661e4055e1b38a78c"}], "stats": {"total": 93, "additions": 43, "deletions": 50}, "files": [{"sha": "cb0e27dce21763ad0e0b7e493be3e677df625e73", "filename": "crates/ra_project_model/src/lib.rs", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/27ebe5d33e08d92c1a032dc27f19094571bd19cd/crates%2Fra_project_model%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27ebe5d33e08d92c1a032dc27f19094571bd19cd/crates%2Fra_project_model%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Flib.rs?ref=27ebe5d33e08d92c1a032dc27f19094571bd19cd", "patch": "@@ -47,17 +47,21 @@ pub struct PackageRoot {\n     path: PathBuf,\n     /// Is a member of the current workspace\n     is_member: bool,\n+    out_dir: Option<PathBuf>,\n }\n impl PackageRoot {\n     pub fn new_member(path: PathBuf) -> PackageRoot {\n-        Self { path, is_member: true }\n+        Self { path, is_member: true, out_dir: None }\n     }\n     pub fn new_non_member(path: PathBuf) -> PackageRoot {\n-        Self { path, is_member: false }\n+        Self { path, is_member: false, out_dir: None }\n     }\n     pub fn path(&self) -> &Path {\n         &self.path\n     }\n+    pub fn out_dir(&self) -> Option<&Path> {\n+        self.out_dir.as_deref()\n+    }\n     pub fn is_member(&self) -> bool {\n         self.is_member\n     }\n@@ -204,6 +208,7 @@ impl ProjectWorkspace {\n                 .map(|pkg| PackageRoot {\n                     path: cargo[pkg].root().to_path_buf(),\n                     is_member: cargo[pkg].is_member,\n+                    out_dir: cargo[pkg].out_dir.clone(),\n                 })\n                 .chain(sysroot.crates().map(|krate| {\n                     PackageRoot::new_non_member(sysroot[krate].root_dir().to_path_buf())\n@@ -212,17 +217,6 @@ impl ProjectWorkspace {\n         }\n     }\n \n-    pub fn out_dirs(&self) -> Vec<PathBuf> {\n-        match self {\n-            ProjectWorkspace::Json { project } => {\n-                project.crates.iter().filter_map(|krate| krate.out_dir.as_ref()).cloned().collect()\n-            }\n-            ProjectWorkspace::Cargo { cargo, sysroot: _ } => {\n-                cargo.packages().filter_map(|pkg| cargo[pkg].out_dir.as_ref()).cloned().collect()\n-            }\n-        }\n-    }\n-\n     pub fn proc_macro_dylib_paths(&self) -> Vec<PathBuf> {\n         match self {\n             ProjectWorkspace::Json { project } => project"}, {"sha": "45af963179b31b2f20194343e3f155f8c3f989f1", "filename": "crates/rust-analyzer/src/cli/load_cargo.rs", "status": "modified", "additions": 19, "deletions": 19, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/27ebe5d33e08d92c1a032dc27f19094571bd19cd/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27ebe5d33e08d92c1a032dc27f19094571bd19cd/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs?ref=27ebe5d33e08d92c1a032dc27f19094571bd19cd", "patch": "@@ -36,28 +36,28 @@ pub fn load_cargo(\n     )?;\n \n     let mut extern_dirs = FxHashSet::default();\n-    extern_dirs.extend(ws.out_dirs());\n-\n-    let mut project_roots = ws.to_roots();\n-    project_roots.extend(extern_dirs.iter().cloned().map(PackageRoot::new_non_member));\n \n     let (sender, receiver) = unbounded();\n     let sender = Box::new(move |t| sender.send(t).unwrap());\n-    let (mut vfs, roots) = Vfs::new(\n-        project_roots\n-            .iter()\n-            .map(|pkg_root| {\n-                RootEntry::new(\n-                    pkg_root.path().to_owned(),\n-                    RustPackageFilterBuilder::default()\n-                        .set_member(pkg_root.is_member())\n-                        .into_vfs_filter(),\n-                )\n-            })\n-            .collect(),\n-        sender,\n-        Watch(false),\n-    );\n+\n+    let mut roots = Vec::new();\n+    let project_roots = ws.to_roots();\n+    for root in &project_roots {\n+        roots.push(RootEntry::new(\n+            root.path().to_owned(),\n+            RustPackageFilterBuilder::default().set_member(root.is_member()).into_vfs_filter(),\n+        ));\n+\n+        if let Some(out_dir) = root.out_dir() {\n+            extern_dirs.insert(out_dir.to_path_buf());\n+            roots.push(RootEntry::new(\n+                out_dir.to_owned(),\n+                RustPackageFilterBuilder::default().set_member(root.is_member()).into_vfs_filter(),\n+            ))\n+        }\n+    }\n+\n+    let (mut vfs, roots) = Vfs::new(roots, sender, Watch(false));\n \n     let source_roots = roots\n         .into_iter()"}, {"sha": "96d91b12d9242fe1fabfb5bbaea83845cf302714", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 17, "deletions": 18, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/27ebe5d33e08d92c1a032dc27f19094571bd19cd/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27ebe5d33e08d92c1a032dc27f19094571bd19cd/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=27ebe5d33e08d92c1a032dc27f19094571bd19cd", "patch": "@@ -89,8 +89,7 @@ impl GlobalState {\n     ) -> GlobalState {\n         let mut change = AnalysisChange::new();\n \n-        let extern_dirs: FxHashSet<_> =\n-            workspaces.iter().flat_map(ProjectWorkspace::out_dirs).collect();\n+        let mut extern_dirs: FxHashSet<PathBuf> = FxHashSet::default();\n \n         let mut local_roots = Vec::new();\n         let roots: Vec<_> = {\n@@ -100,22 +99,22 @@ impl GlobalState {\n                     .exclude(exclude_globs.iter().cloned())\n                     .into_vfs_filter()\n             };\n-            workspaces\n-                .iter()\n-                .flat_map(ProjectWorkspace::to_roots)\n-                .map(|pkg_root| {\n-                    let path = pkg_root.path().to_owned();\n-                    if pkg_root.is_member() {\n-                        local_roots.push(path.clone());\n-                    }\n-                    RootEntry::new(path, create_filter(pkg_root.is_member()))\n-                })\n-                .chain(\n-                    extern_dirs\n-                        .iter()\n-                        .map(|path| RootEntry::new(path.to_owned(), create_filter(false))),\n-                )\n-                .collect()\n+            let mut roots = Vec::new();\n+            for root in workspaces.iter().flat_map(ProjectWorkspace::to_roots) {\n+                let path = root.path().to_owned();\n+                if root.is_member() {\n+                    local_roots.push(path.clone());\n+                }\n+                roots.push(RootEntry::new(path, create_filter(root.is_member())));\n+                if let Some(out_dir) = root.out_dir() {\n+                    extern_dirs.insert(out_dir.to_path_buf());\n+                    roots.push(RootEntry::new(\n+                        out_dir.to_path_buf(),\n+                        create_filter(root.is_member()),\n+                    ))\n+                }\n+            }\n+            roots\n         };\n \n         let (task_sender, task_receiver) = unbounded();"}]}