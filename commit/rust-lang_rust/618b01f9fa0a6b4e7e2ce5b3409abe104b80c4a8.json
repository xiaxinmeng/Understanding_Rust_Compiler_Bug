{"sha": "618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYxOGIwMWY5ZmEwYTZiNGU3ZTJjZTViMzQwOWFiZTEwNGI4MGM0YTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-11-19T15:24:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-11-19T15:24:09Z"}, "message": "Auto merge of #66454 - cjgillot:lift, r=Zoxc\n\nDerive Lift using a proc-macro\n\nBased on #66384\n\nr? @Zoxc", "tree": {"sha": "516b235844b5de2038e60be8a29d835dbbdfca9b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/516b235844b5de2038e60be8a29d835dbbdfca9b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "html_url": "https://github.com/rust-lang/rust/commit/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9d6ff1553b7debbe5c99c102ce0978b6130592f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d6ff1553b7debbe5c99c102ce0978b6130592f8", "html_url": "https://github.com/rust-lang/rust/commit/9d6ff1553b7debbe5c99c102ce0978b6130592f8"}, {"sha": "a65091ffff8953cdea1208ee2d10c7858f3c1fe6", "url": "https://api.github.com/repos/rust-lang/rust/commits/a65091ffff8953cdea1208ee2d10c7858f3c1fe6", "html_url": "https://github.com/rust-lang/rust/commit/a65091ffff8953cdea1208ee2d10c7858f3c1fe6"}], "stats": {"total": 409, "additions": 87, "deletions": 322}, "files": [{"sha": "b0f65ac6e1b3437440221c98ada4d8adc9fde09e", "filename": "src/librustc/infer/canonical/mod.rs", "status": "modified", "additions": 5, "deletions": 33, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Finfer%2Fcanonical%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Finfer%2Fcanonical%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fcanonical%2Fmod.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -32,7 +32,7 @@ use std::ops::Index;\n use syntax::source_map::Span;\n use crate::ty::fold::TypeFoldable;\n use crate::ty::subst::GenericArg;\n-use crate::ty::{self, BoundVar, Lift, List, Region, TyCtxt};\n+use crate::ty::{self, BoundVar, List, Region, TyCtxt};\n \n mod canonicalizer;\n \n@@ -44,7 +44,7 @@ mod substitute;\n /// variables have been rewritten to \"canonical vars\". These are\n /// numbered starting from 0 in order of first appearance.\n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, RustcDecodable, RustcEncodable)]\n-#[derive(HashStable, TypeFoldable)]\n+#[derive(HashStable, TypeFoldable, Lift)]\n pub struct Canonical<'tcx, V> {\n     pub max_universe: ty::UniverseIndex,\n     pub variables: CanonicalVarInfos<'tcx>,\n@@ -65,7 +65,7 @@ impl<'tcx> UseSpecializedDecodable for CanonicalVarInfos<'tcx> {}\n /// variables. You will need to supply it later to instantiate the\n /// canonicalized query response.\n #[derive(Clone, Debug, PartialEq, Eq, Hash, RustcDecodable, RustcEncodable)]\n-#[derive(HashStable, TypeFoldable)]\n+#[derive(HashStable, TypeFoldable, Lift)]\n pub struct CanonicalVarValues<'tcx> {\n     pub var_values: IndexVec<BoundVar, GenericArg<'tcx>>,\n }\n@@ -188,15 +188,15 @@ pub enum CanonicalTyVarKind {\n /// After we execute a query with a canonicalized key, we get back a\n /// `Canonical<QueryResponse<..>>`. You can use\n /// `instantiate_query_result` to access the data in this result.\n-#[derive(Clone, Debug, HashStable, TypeFoldable)]\n+#[derive(Clone, Debug, HashStable, TypeFoldable, Lift)]\n pub struct QueryResponse<'tcx, R> {\n     pub var_values: CanonicalVarValues<'tcx>,\n     pub region_constraints: QueryRegionConstraints<'tcx>,\n     pub certainty: Certainty,\n     pub value: R,\n }\n \n-#[derive(Clone, Debug, Default, HashStable, TypeFoldable)]\n+#[derive(Clone, Debug, Default, HashStable, TypeFoldable, Lift)]\n pub struct QueryRegionConstraints<'tcx> {\n     pub outlives: Vec<QueryOutlivesConstraint<'tcx>>,\n     pub member_constraints: Vec<MemberConstraint<'tcx>>,\n@@ -469,13 +469,6 @@ CloneTypeFoldableImpls! {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx, T> Lift<'tcx> for Canonical<'a, T> {\n-        type Lifted = Canonical<'tcx, T::Lifted>;\n-        max_universe, variables, value\n-    } where T: Lift<'tcx>\n-}\n-\n impl<'tcx> CanonicalVarValues<'tcx> {\n     pub fn len(&self) -> usize {\n         self.var_values.len()\n@@ -521,27 +514,6 @@ impl<'a, 'tcx> IntoIterator for &'a CanonicalVarValues<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for CanonicalVarValues<'a> {\n-        type Lifted = CanonicalVarValues<'tcx>;\n-        var_values,\n-    }\n-}\n-\n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx, R> Lift<'tcx> for QueryResponse<'a, R> {\n-        type Lifted = QueryResponse<'tcx, R::Lifted>;\n-        var_values, region_constraints, certainty, value\n-    } where R: Lift<'tcx>\n-}\n-\n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for QueryRegionConstraints<'a> {\n-        type Lifted = QueryRegionConstraints<'tcx>;\n-        outlives, member_constraints\n-    }\n-}\n-\n impl<'tcx> Index<BoundVar> for CanonicalVarValues<'tcx> {\n     type Output = GenericArg<'tcx>;\n "}, {"sha": "402449ce6cc2032cb0465f1e61ba56f4cf506194", "filename": "src/librustc/infer/region_constraints/mod.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Finfer%2Fregion_constraints%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Finfer%2Fregion_constraints%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fregion_constraints%2Fmod.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -151,7 +151,7 @@ impl Constraint<'_> {\n /// ```\n /// R0 member of [O1..On]\n /// ```\n-#[derive(Debug, Clone, HashStable, TypeFoldable)]\n+#[derive(Debug, Clone, HashStable, TypeFoldable, Lift)]\n pub struct MemberConstraint<'tcx> {\n     /// The `DefId` of the opaque type causing this constraint: used for error reporting.\n     pub opaque_type_def_id: DefId,\n@@ -169,13 +169,6 @@ pub struct MemberConstraint<'tcx> {\n     pub choice_regions: Lrc<Vec<Region<'tcx>>>,\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for MemberConstraint<'a> {\n-        type Lifted = MemberConstraint<'tcx>;\n-        opaque_type_def_id, definition_span, hidden_ty, member_region, choice_regions\n-    }\n-}\n-\n /// `VerifyGenericBound(T, _, R, RS)`: the parameter type `T` (or\n /// associated type) must outlive the region `R`. `T` is known to\n /// outlive `RS`. Therefore, verify that `R <= RS[i]` for some"}, {"sha": "aae1c7a299272d675ac4ffbc4546a1e474749186", "filename": "src/librustc/macros.rs", "status": "modified", "additions": 0, "deletions": 71, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmacros.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -253,77 +253,6 @@ macro_rules! CloneTypeFoldableAndLiftImpls {\n     }\n }\n \n-#[macro_export]\n-macro_rules! BraceStructLiftImpl {\n-    (impl<$($p:tt),*> Lift<$tcx:tt> for $s:path {\n-        type Lifted = $lifted:ty;\n-        $($field:ident),* $(,)?\n-    } $(where $($wc:tt)*)*) => {\n-        impl<$($p),*> $crate::ty::Lift<$tcx> for $s\n-            $(where $($wc)*)*\n-        {\n-            type Lifted = $lifted;\n-\n-            fn lift_to_tcx(&self, tcx: TyCtxt<$tcx>) -> Option<$lifted> {\n-                $(let $field = tcx.lift(&self.$field)?;)*\n-                Some(Self::Lifted { $($field),* })\n-            }\n-        }\n-    };\n-}\n-\n-#[macro_export]\n-macro_rules! EnumLiftImpl {\n-    (impl<$($p:tt),*> Lift<$tcx:tt> for $s:path {\n-        type Lifted = $lifted:ty;\n-        $($variants:tt)*\n-    } $(where $($wc:tt)*)*) => {\n-        impl<$($p),*> $crate::ty::Lift<$tcx> for $s\n-            $(where $($wc)*)*\n-        {\n-            type Lifted = $lifted;\n-\n-            fn lift_to_tcx(&self, tcx: TyCtxt<$tcx>) -> Option<$lifted> {\n-                EnumLiftImpl!(@Variants(self, tcx) input($($variants)*) output())\n-            }\n-        }\n-    };\n-\n-    (@Variants($this:expr, $tcx:expr) input() output($($output:tt)*)) => {\n-        match $this {\n-            $($output)*\n-        }\n-    };\n-\n-    (@Variants($this:expr, $tcx:expr)\n-     input( ($variant:path) ( $($variant_arg:ident),* ) , $($input:tt)*)\n-     output( $($output:tt)*) ) => {\n-        EnumLiftImpl!(\n-            @Variants($this, $tcx)\n-                input($($input)*)\n-                output(\n-                    $variant ( $($variant_arg),* ) => {\n-                        Some($variant ( $($tcx.lift($variant_arg)?),* ))\n-                    }\n-                    $($output)*\n-                )\n-        )\n-    };\n-\n-    (@Variants($this:expr, $tcx:expr)\n-     input( ($variant:path), $($input:tt)*)\n-     output( $($output:tt)*) ) => {\n-        EnumLiftImpl!(\n-            @Variants($this, $tcx)\n-                input($($input)*)\n-                output(\n-                    $variant => { Some($variant) }\n-                    $($output)*\n-                )\n-        )\n-    };\n-}\n-\n #[macro_export]\n macro_rules! EnumTypeFoldableImpl {\n     (impl<$($p:tt),*> TypeFoldable<$tcx:tt> for $s:path {"}, {"sha": "31c50610ac4e245b307085f206b81bab1b722ae6", "filename": "src/librustc/mir/interpret/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fmir%2Finterpret%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fmir%2Finterpret%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Fmod.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -124,7 +124,8 @@ use rustc_macros::HashStable;\n use byteorder::{WriteBytesExt, ReadBytesExt, LittleEndian, BigEndian};\n \n /// Uniquely identifies a specific constant or static.\n-#[derive(Copy, Clone, Debug, Eq, PartialEq, Hash, RustcEncodable, RustcDecodable, HashStable)]\n+#[derive(Copy, Clone, Debug, Eq, PartialEq, Hash, RustcEncodable, RustcDecodable)]\n+#[derive(HashStable, Lift)]\n pub struct GlobalId<'tcx> {\n     /// For a constant or static, the `Instance` of the item itself.\n     /// For a promoted global, the `Instance` of the function they belong to."}, {"sha": "3aa355ce11a8a2ccbc4ada0a4c1c28b705111084", "filename": "src/librustc/traits/mod.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fmod.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -334,27 +334,27 @@ pub type TraitObligations<'tcx> = Vec<TraitObligation<'tcx>>;\n /// are used for representing the trait system in the form of\n /// logic programming clauses. They are part of the interface\n /// for the chalk SLG solver.\n-#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable)]\n+#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable, Lift)]\n pub enum WhereClause<'tcx> {\n     Implemented(ty::TraitPredicate<'tcx>),\n     ProjectionEq(ty::ProjectionPredicate<'tcx>),\n     RegionOutlives(ty::RegionOutlivesPredicate<'tcx>),\n     TypeOutlives(ty::TypeOutlivesPredicate<'tcx>),\n }\n \n-#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable)]\n+#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable, Lift)]\n pub enum WellFormed<'tcx> {\n     Trait(ty::TraitPredicate<'tcx>),\n     Ty(Ty<'tcx>),\n }\n \n-#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable)]\n+#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable, Lift)]\n pub enum FromEnv<'tcx> {\n     Trait(ty::TraitPredicate<'tcx>),\n     Ty(Ty<'tcx>),\n }\n \n-#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable)]\n+#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable, Lift)]\n pub enum DomainGoal<'tcx> {\n     Holds(WhereClause<'tcx>),\n     WellFormed(WellFormed<'tcx>),\n@@ -370,7 +370,7 @@ pub enum QuantifierKind {\n     Existential,\n }\n \n-#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable)]\n+#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug, HashStable, TypeFoldable, Lift)]\n pub enum GoalKind<'tcx> {\n     Implies(Clauses<'tcx>, Goal<'tcx>),\n     And(Goal<'tcx>, Goal<'tcx>),"}, {"sha": "93f56804a9f4f6524764a0f991bebce16f00d240", "filename": "src/librustc/traits/query/dropck_outlives.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Fdropck_outlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Fdropck_outlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Fdropck_outlives.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -79,7 +79,7 @@ impl<'cx, 'tcx> At<'cx, 'tcx> {\n     }\n }\n \n-#[derive(Clone, Debug, Default, TypeFoldable)]\n+#[derive(Clone, Debug, Default, TypeFoldable, Lift)]\n pub struct DropckOutlivesResult<'tcx> {\n     pub kinds: Vec<GenericArg<'tcx>>,\n     pub overflows: Vec<Ty<'tcx>>,\n@@ -152,13 +152,6 @@ impl<'tcx> FromIterator<DtorckConstraint<'tcx>> for DtorckConstraint<'tcx> {\n         result\n     }\n }\n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for DropckOutlivesResult<'a> {\n-        type Lifted = DropckOutlivesResult<'tcx>;\n-        kinds, overflows\n-    }\n-}\n-\n impl_stable_hash_for!(struct DropckOutlivesResult<'tcx> {\n     kinds, overflows\n });"}, {"sha": "30528dcebdae9c3ae695055a8cb3fe15f7d7fc92", "filename": "src/librustc/traits/query/normalize.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Fnormalize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Fnormalize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Fnormalize.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -66,7 +66,7 @@ impl<'cx, 'tcx> At<'cx, 'tcx> {\n }\n \n /// Result from the `normalize_projection_ty` query.\n-#[derive(Clone, Debug, TypeFoldable)]\n+#[derive(Clone, Debug, TypeFoldable, Lift)]\n pub struct NormalizationResult<'tcx> {\n     /// Result of normalization.\n     pub normalized_ty: Ty<'tcx>,\n@@ -194,13 +194,6 @@ impl<'cx, 'tcx> TypeFolder<'tcx> for QueryNormalizer<'cx, 'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for NormalizationResult<'a> {\n-        type Lifted = NormalizationResult<'tcx>;\n-        normalized_ty\n-    }\n-}\n-\n impl_stable_hash_for!(struct NormalizationResult<'tcx> {\n     normalized_ty\n });"}, {"sha": "d6cd2cce425cb6f29d4953d5d9bd82f6032f04da", "filename": "src/librustc/traits/query/outlives_bounds.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Foutlives_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Foutlives_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Foutlives_bounds.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -4,7 +4,7 @@ use crate::hir;\n use syntax::source_map::Span;\n use crate::traits::{FulfillmentContext, ObligationCause, TraitEngine, TraitEngineExt};\n use crate::traits::query::NoSolution;\n-use crate::ty::{self, Ty, TyCtxt};\n+use crate::ty::{self, Ty};\n \n use crate::ich::StableHashingContext;\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n@@ -17,22 +17,13 @@ use std::mem;\n /// case they are called implied bounds). They are fed to the\n /// `OutlivesEnv` which in turn is supplied to the region checker and\n /// other parts of the inference system.\n-#[derive(Clone, Debug, TypeFoldable)]\n+#[derive(Clone, Debug, TypeFoldable, Lift)]\n pub enum OutlivesBound<'tcx> {\n     RegionSubRegion(ty::Region<'tcx>, ty::Region<'tcx>),\n     RegionSubParam(ty::Region<'tcx>, ty::ParamTy),\n     RegionSubProjection(ty::Region<'tcx>, ty::ProjectionTy<'tcx>),\n }\n \n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for self::OutlivesBound<'a> {\n-        type Lifted = self::OutlivesBound<'tcx>;\n-        (self::OutlivesBound::RegionSubRegion)(a, b),\n-        (self::OutlivesBound::RegionSubParam)(a, b),\n-        (self::OutlivesBound::RegionSubProjection)(a, b),\n-    }\n-}\n-\n impl<'a, 'tcx> HashStable<StableHashingContext<'a>> for OutlivesBound<'tcx> {\n     fn hash_stable(&self, hcx: &mut StableHashingContext<'a>, hasher: &mut StableHasher) {\n         mem::discriminant(self).hash_stable(hcx, hasher);"}, {"sha": "8b0ee5feed7bc0d376829f0625ee288ee2f6960f", "filename": "src/librustc/traits/query/type_op/ascribe_user_type.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fascribe_user_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fascribe_user_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fascribe_user_type.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -4,7 +4,7 @@ use crate::hir::def_id::DefId;\n use crate::ty::{ParamEnvAnd, Ty, TyCtxt};\n use crate::ty::subst::UserSubsts;\n \n-#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable, Lift)]\n pub struct AscribeUserType<'tcx> {\n     pub mir_ty: Ty<'tcx>,\n     pub def_id: DefId,\n@@ -39,13 +39,6 @@ impl<'tcx> super::QueryTypeOp<'tcx> for AscribeUserType<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for AscribeUserType<'a> {\n-        type Lifted = AscribeUserType<'tcx>;\n-        mir_ty, def_id, user_substs\n-    }\n-}\n-\n impl_stable_hash_for! {\n     struct AscribeUserType<'tcx> {\n         mir_ty, def_id, user_substs"}, {"sha": "5086994fbb6edaca7b1b17223b0e6dc2c700864a", "filename": "src/librustc/traits/query/type_op/eq.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Feq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Feq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Feq.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -2,7 +2,7 @@ use crate::infer::canonical::{Canonicalized, CanonicalizedQueryResponse};\n use crate::traits::query::Fallible;\n use crate::ty::{ParamEnvAnd, Ty, TyCtxt};\n \n-#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable, Lift)]\n pub struct Eq<'tcx> {\n     pub a: Ty<'tcx>,\n     pub b: Ty<'tcx>,\n@@ -36,14 +36,6 @@ impl<'tcx> super::QueryTypeOp<'tcx> for Eq<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for Eq<'a> {\n-        type Lifted = Eq<'tcx>;\n-        a,\n-        b,\n-    }\n-}\n-\n impl_stable_hash_for! {\n     struct Eq<'tcx> { a, b }\n }"}, {"sha": "f97b34f9e9a5aa9751c6eb84c042edb7f0c75832", "filename": "src/librustc/traits/query/type_op/implied_outlives_bounds.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fimplied_outlives_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fimplied_outlives_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fimplied_outlives_bounds.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -3,7 +3,7 @@ use crate::traits::query::outlives_bounds::OutlivesBound;\n use crate::traits::query::Fallible;\n use crate::ty::{ParamEnvAnd, Ty, TyCtxt};\n \n-#[derive(Clone, Debug, TypeFoldable)]\n+#[derive(Clone, Debug, TypeFoldable, Lift)]\n pub struct ImpliedOutlivesBounds<'tcx> {\n     pub ty: Ty<'tcx>,\n }\n@@ -40,13 +40,6 @@ impl<'tcx> super::QueryTypeOp<'tcx> for ImpliedOutlivesBounds<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for ImpliedOutlivesBounds<'a> {\n-        type Lifted = ImpliedOutlivesBounds<'tcx>;\n-        ty,\n-    }\n-}\n-\n impl_stable_hash_for! {\n     struct ImpliedOutlivesBounds<'tcx> { ty }\n }"}, {"sha": "798fc5224ccc6a0a0fedfaeaedf06e9e78fca2e1", "filename": "src/librustc/traits/query/type_op/normalize.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fnormalize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fnormalize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fnormalize.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -4,7 +4,7 @@ use crate::traits::query::Fallible;\n use crate::ty::fold::TypeFoldable;\n use crate::ty::{self, Lift, ParamEnvAnd, Ty, TyCtxt};\n \n-#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable, Lift)]\n pub struct Normalize<T> {\n     pub value: T,\n }\n@@ -83,13 +83,6 @@ impl Normalizable<'tcx> for ty::FnSig<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'tcx, T> Lift<'tcx> for Normalize<T> {\n-        type Lifted = Normalize<T::Lifted>;\n-        value,\n-    } where T: Lift<'tcx>,\n-}\n-\n impl_stable_hash_for! {\n     impl<T> for struct Normalize<T> {\n         value"}, {"sha": "d2a7fdc8946df0632506654cd448a853956a1922", "filename": "src/librustc/traits/query/type_op/outlives.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Foutlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Foutlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Foutlives.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -3,7 +3,7 @@ use crate::traits::query::dropck_outlives::{DropckOutlivesResult, trivial_dropck\n use crate::traits::query::Fallible;\n use crate::ty::{ParamEnvAnd, Ty, TyCtxt};\n \n-#[derive(Copy, Clone, Debug, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, TypeFoldable, Lift)]\n pub struct DropckOutlives<'tcx> {\n     dropped_ty: Ty<'tcx>,\n }\n@@ -54,13 +54,6 @@ impl super::QueryTypeOp<'tcx> for DropckOutlives<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for DropckOutlives<'a> {\n-        type Lifted = DropckOutlives<'tcx>;\n-        dropped_ty\n-    }\n-}\n-\n impl_stable_hash_for! {\n     struct DropckOutlives<'tcx> { dropped_ty }\n }"}, {"sha": "cbf485fcfe02fbef331f2d7d898c0ecdd63cf222", "filename": "src/librustc/traits/query/type_op/prove_predicate.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -2,7 +2,7 @@ use crate::infer::canonical::{Canonicalized, CanonicalizedQueryResponse};\n use crate::traits::query::Fallible;\n use crate::ty::{ParamEnvAnd, Predicate, TyCtxt};\n \n-#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable, Lift)]\n pub struct ProvePredicate<'tcx> {\n     pub predicate: Predicate<'tcx>,\n }\n@@ -45,13 +45,6 @@ impl<'tcx> super::QueryTypeOp<'tcx> for ProvePredicate<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for ProvePredicate<'a> {\n-        type Lifted = ProvePredicate<'tcx>;\n-        predicate,\n-    }\n-}\n-\n impl_stable_hash_for! {\n     struct ProvePredicate<'tcx> { predicate }\n }"}, {"sha": "bd53e234a6a4906d83c7ab3bc0e667432d674894", "filename": "src/librustc/traits/query/type_op/subtype.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fsubtype.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fsubtype.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fquery%2Ftype_op%2Fsubtype.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -2,7 +2,7 @@ use crate::infer::canonical::{Canonicalized, CanonicalizedQueryResponse};\n use crate::traits::query::Fallible;\n use crate::ty::{ParamEnvAnd, Ty, TyCtxt};\n \n-#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, Hash, PartialEq, Eq, TypeFoldable, Lift)]\n pub struct Subtype<'tcx> {\n     pub sub: Ty<'tcx>,\n     pub sup: Ty<'tcx>,\n@@ -36,14 +36,6 @@ impl<'tcx> super::QueryTypeOp<'tcx> for Subtype<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for Subtype<'a> {\n-        type Lifted = Subtype<'tcx>;\n-        sub,\n-        sup,\n-    }\n-}\n-\n impl_stable_hash_for! {\n     struct Subtype<'tcx> { sub, sup }\n }"}, {"sha": "8c300da11fcbf67e5b0e77fa64183dd46b26467a", "filename": "src/librustc/traits/structural_impls.rs", "status": "modified", "additions": 0, "deletions": 49, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -650,55 +650,6 @@ impl<'a, 'tcx> Lift<'tcx> for traits::Vtable<'a, ()> {\n     }\n }\n \n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for traits::WhereClause<'a> {\n-        type Lifted = traits::WhereClause<'tcx>;\n-        (traits::WhereClause::Implemented)(trait_ref),\n-        (traits::WhereClause::ProjectionEq)(projection),\n-        (traits::WhereClause::TypeOutlives)(ty_outlives),\n-        (traits::WhereClause::RegionOutlives)(region_outlives),\n-    }\n-}\n-\n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for traits::WellFormed<'a> {\n-        type Lifted = traits::WellFormed<'tcx>;\n-        (traits::WellFormed::Trait)(trait_ref),\n-        (traits::WellFormed::Ty)(ty),\n-    }\n-}\n-\n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for traits::FromEnv<'a> {\n-        type Lifted = traits::FromEnv<'tcx>;\n-        (traits::FromEnv::Trait)(trait_ref),\n-        (traits::FromEnv::Ty)(ty),\n-    }\n-}\n-\n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for traits::DomainGoal<'a> {\n-        type Lifted = traits::DomainGoal<'tcx>;\n-        (traits::DomainGoal::Holds)(wc),\n-        (traits::DomainGoal::WellFormed)(wf),\n-        (traits::DomainGoal::FromEnv)(from_env),\n-        (traits::DomainGoal::Normalize)(projection),\n-    }\n-}\n-\n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for traits::GoalKind<'a> {\n-        type Lifted = traits::GoalKind<'tcx>;\n-        (traits::GoalKind::Implies)(hypotheses, goal),\n-        (traits::GoalKind::And)(goal1, goal2),\n-        (traits::GoalKind::Not)(goal),\n-        (traits::GoalKind::DomainGoal)(domain_goal),\n-        (traits::GoalKind::Quantified)(kind, goal),\n-        (traits::GoalKind::Subtype)(a, b),\n-        (traits::GoalKind::CannotProve),\n-    }\n-}\n-\n impl<'a, 'tcx> Lift<'tcx> for traits::Environment<'a> {\n     type Lifted = traits::Environment<'tcx>;\n     fn lift_to_tcx(&self, tcx: TyCtxt<'tcx>) -> Option<Self::Lifted> {"}, {"sha": "41d069bf6ae33c28d7d1be549c7681a00d076d1a", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 3, "deletions": 17, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -826,20 +826,13 @@ rustc_index::newtype_index! {\n pub type CanonicalUserTypeAnnotations<'tcx> =\n     IndexVec<UserTypeAnnotationIndex, CanonicalUserTypeAnnotation<'tcx>>;\n \n-#[derive(Clone, Debug, RustcEncodable, RustcDecodable, HashStable, TypeFoldable)]\n+#[derive(Clone, Debug, RustcEncodable, RustcDecodable, HashStable, TypeFoldable, Lift)]\n pub struct CanonicalUserTypeAnnotation<'tcx> {\n     pub user_ty: CanonicalUserType<'tcx>,\n     pub span: Span,\n     pub inferred_ty: Ty<'tcx>,\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for CanonicalUserTypeAnnotation<'a> {\n-        type Lifted = CanonicalUserTypeAnnotation<'tcx>;\n-        user_ty, span, inferred_ty\n-    }\n-}\n-\n /// Canonicalized user type annotation.\n pub type CanonicalUserType<'tcx> = Canonical<'tcx, UserType<'tcx>>;\n \n@@ -892,7 +885,8 @@ impl CanonicalUserType<'tcx> {\n /// A user-given type annotation attached to a constant. These arise\n /// from constants that are named via paths, like `Foo::<A>::new` and\n /// so forth.\n-#[derive(Copy, Clone, Debug, PartialEq, RustcEncodable, RustcDecodable, HashStable, TypeFoldable)]\n+#[derive(Copy, Clone, Debug, PartialEq, RustcEncodable, RustcDecodable)]\n+#[derive(HashStable, TypeFoldable, Lift)]\n pub enum UserType<'tcx> {\n     Ty(Ty<'tcx>),\n \n@@ -901,14 +895,6 @@ pub enum UserType<'tcx> {\n     TypeOf(DefId, UserSubsts<'tcx>),\n }\n \n-EnumLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for UserType<'a> {\n-        type Lifted = UserType<'tcx>;\n-        (UserType::Ty)(ty),\n-        (UserType::TypeOf)(def, substs),\n-    }\n-}\n-\n impl<'tcx> CommonTypes<'tcx> {\n     fn new(interners: &CtxtInterners<'tcx>) -> CommonTypes<'tcx> {\n         let mk = |ty| interners.intern_ty(ty);"}, {"sha": "7eee0a5e2b52cc5ddbe9ab9f1e8d3aa30045a216", "filename": "src/librustc/ty/instance.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Finstance.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -12,7 +12,8 @@ use rustc_macros::HashStable;\n use std::fmt;\n use std::iter;\n \n-#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug, RustcEncodable, RustcDecodable, HashStable)]\n+#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug, RustcEncodable, RustcDecodable)]\n+#[derive(HashStable, Lift)]\n pub struct Instance<'tcx> {\n     pub def: InstanceDef<'tcx>,\n     pub substs: SubstsRef<'tcx>,"}, {"sha": "ccac7720914fcce7e5294d71781e0e228e67a161", "filename": "src/librustc/ty/structural_impls.rs", "status": "modified", "additions": 1, "deletions": 23, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fstructural_impls.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -1,7 +1,6 @@\n //! This module contains implements of the `Lift` and `TypeFoldable`\n //! traits for various types in the Rust compiler. Most are written by\n-//! hand, though we've recently added some macros (e.g.,\n-//! `BraceStructLiftImpl!`) to help with the tedium.\n+//! hand, though we've recently added some macros and proc-macros to help with the tedium.\n \n use crate::hir::def::Namespace;\n use crate::mir::ProjectionKind;\n@@ -779,27 +778,6 @@ impl<'a, 'tcx> Lift<'tcx> for ty::InstanceDef<'a> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for ty::TypeAndMut<'a> {\n-        type Lifted = ty::TypeAndMut<'tcx>;\n-        ty, mutbl\n-    }\n-}\n-\n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for ty::Instance<'a> {\n-        type Lifted = ty::Instance<'tcx>;\n-        def, substs\n-    }\n-}\n-\n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for interpret::GlobalId<'a> {\n-        type Lifted = interpret::GlobalId<'tcx>;\n-        instance, promoted\n-    }\n-}\n-\n ///////////////////////////////////////////////////////////////////////////\n // TypeFoldable implementations.\n //"}, {"sha": "fa22709d66fc4dffd63a2a3ed3902a5262b047eb", "filename": "src/librustc/ty/sty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fsty.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -30,7 +30,7 @@ use self::InferTy::*;\n use self::TyKind::*;\n \n #[derive(Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash, Debug, RustcEncodable, RustcDecodable)]\n-#[derive(HashStable, TypeFoldable)]\n+#[derive(HashStable, TypeFoldable, Lift)]\n pub struct TypeAndMut<'tcx> {\n     pub ty: Ty<'tcx>,\n     pub mutbl: hir::Mutability,"}, {"sha": "a8a17fe9d7d8808bfd69fc6fabe2209fbeb285ab", "filename": "src/librustc/ty/subst.rs", "status": "modified", "additions": 2, "deletions": 18, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fsubst.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc%2Fty%2Fsubst.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fsubst.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -731,7 +731,7 @@ pub type CanonicalUserSubsts<'tcx> = Canonical<'tcx, UserSubsts<'tcx>>;\n /// Stores the user-given substs to reach some fully qualified path\n /// (e.g., `<T>::Item` or `<T as Trait>::Item`).\n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, RustcEncodable, RustcDecodable)]\n-#[derive(HashStable, TypeFoldable)]\n+#[derive(HashStable, TypeFoldable, Lift)]\n pub struct UserSubsts<'tcx> {\n     /// The substitutions for the item as given by the user.\n     pub substs: SubstsRef<'tcx>,\n@@ -741,14 +741,6 @@ pub struct UserSubsts<'tcx> {\n     pub user_self_ty: Option<UserSelfTy<'tcx>>,\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for UserSubsts<'a> {\n-        type Lifted = UserSubsts<'tcx>;\n-        substs,\n-        user_self_ty,\n-    }\n-}\n-\n /// Specifies the user-given self type. In the case of a path that\n /// refers to a member in an inherent impl, this self type is\n /// sometimes needed to constrain the type parameters on the impl. For\n@@ -766,16 +758,8 @@ BraceStructLiftImpl! {\n /// the self type, giving `Foo<?A>`. Finally, we unify that with\n /// the self type here, which contains `?A` to be `&'static u32`\n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, RustcEncodable, RustcDecodable)]\n-#[derive(HashStable, TypeFoldable)]\n+#[derive(HashStable, TypeFoldable, Lift)]\n pub struct UserSelfTy<'tcx> {\n     pub impl_def_id: DefId,\n     pub self_ty: Ty<'tcx>,\n }\n-\n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for UserSelfTy<'a> {\n-        type Lifted = UserSelfTy<'tcx>;\n-        impl_def_id,\n-        self_ty,\n-    }\n-}"}, {"sha": "dce3820d2842ca53f6dd501845ce86819350e97e", "filename": "src/librustc_macros/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_macros%2Fsrc%2Flib.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -10,6 +10,7 @@ use proc_macro::TokenStream;\n \n mod hash_stable;\n mod type_foldable;\n+mod lift;\n mod query;\n mod symbols;\n \n@@ -25,3 +26,4 @@ pub fn symbols(input: TokenStream) -> TokenStream {\n \n decl_derive!([HashStable, attributes(stable_hasher)] => hash_stable::hash_stable_derive);\n decl_derive!([TypeFoldable, attributes(type_foldable)] => type_foldable::type_foldable_derive);\n+decl_derive!([Lift, attributes(lift)] => lift::lift_derive);"}, {"sha": "23f30bcad2b632411c108128b70da979a3a17a58", "filename": "src/librustc_macros/src/lift.rs", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc_macros%2Fsrc%2Flift.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc_macros%2Fsrc%2Flift.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_macros%2Fsrc%2Flift.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -0,0 +1,50 @@\n+use synstructure;\n+use syn::{self, parse_quote};\n+use proc_macro2;\n+use quote::quote;\n+\n+pub fn lift_derive(mut s: synstructure::Structure<'_>) -> proc_macro2::TokenStream {\n+    s.add_bounds(synstructure::AddBounds::Generics);\n+\n+    let tcx: syn::Lifetime = parse_quote!('tcx);\n+    let newtcx: syn::GenericParam = parse_quote!('__lifted);\n+\n+    let lifted = {\n+        let ast = s.ast();\n+        let ident = &ast.ident;\n+\n+        // Replace `'tcx` lifetime by the `'__lifted` lifetime\n+        let (_, generics, _) = ast.generics.split_for_impl();\n+        let mut generics : syn::AngleBracketedGenericArguments = syn::parse_quote!{ #generics };\n+        for arg in generics.args.iter_mut() {\n+            match arg {\n+                syn::GenericArgument::Lifetime(l) if *l == tcx => {\n+                    *arg = parse_quote!('__lifted);\n+                },\n+                syn::GenericArgument::Type(t) => {\n+                    *arg = syn::parse_quote!{ #t::Lifted };\n+                },\n+                _ => {},\n+            }\n+        }\n+\n+        quote!{ #ident #generics }\n+    };\n+\n+    let body = s.each_variant(|vi| {\n+        let bindings = &vi.bindings();\n+        vi.construct(|_, index| {\n+            let bi = &bindings[index];\n+            quote!{ __tcx.lift(#bi)?  }\n+        })\n+    });\n+\n+    s.add_impl_generic(newtcx);\n+    s.bound_impl(quote!(::rustc::ty::Lift<'__lifted>), quote!{\n+        type Lifted = #lifted;\n+\n+        fn lift_to_tcx(&self, __tcx: ::rustc::ty::TyCtxt<'__lifted>) -> Option<#lifted> {\n+            Some(match *self { #body })\n+        }\n+    })\n+}"}, {"sha": "b0dcdc7486e0795238d38c943f28792236583217", "filename": "src/librustc_traits/chalk_context/mod.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc_traits%2Fchalk_context%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src%2Flibrustc_traits%2Fchalk_context%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_traits%2Fchalk_context%2Fmod.rs?ref=618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8", "patch": "@@ -38,7 +38,7 @@ use rustc::ty::fold::{TypeFoldable, TypeFolder, TypeVisitor};\n use rustc::ty::query::Providers;\n use rustc::ty::subst::{GenericArg, GenericArgKind};\n use syntax_pos::DUMMY_SP;\n-use rustc_macros::TypeFoldable;\n+use rustc_macros::{TypeFoldable, Lift};\n \n use std::fmt::{self, Debug};\n use std::marker::PhantomData;\n@@ -66,7 +66,7 @@ crate struct UniverseMap;\n \n crate type RegionConstraint<'tcx> = ty::OutlivesPredicate<GenericArg<'tcx>, ty::Region<'tcx>>;\n \n-#[derive(Clone, Debug, PartialEq, Eq, Hash, TypeFoldable)]\n+#[derive(Clone, Debug, PartialEq, Eq, Hash, TypeFoldable, Lift)]\n crate struct ConstrainedSubst<'tcx> {\n     subst: CanonicalVarValues<'tcx>,\n     constraints: Vec<RegionConstraint<'tcx>>,\n@@ -581,14 +581,6 @@ impl ExClauseFold<'tcx> for ChalkArenas<'tcx> {\n     }\n }\n \n-BraceStructLiftImpl! {\n-    impl<'a, 'tcx> Lift<'tcx> for ConstrainedSubst<'a> {\n-        type Lifted = ConstrainedSubst<'tcx>;\n-\n-        subst, constraints\n-    }\n-}\n-\n trait Upcast<'tcx>: 'tcx {\n     type Upcasted: 'tcx;\n "}]}