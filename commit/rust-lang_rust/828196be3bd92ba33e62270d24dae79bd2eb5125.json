{"sha": "828196be3bd92ba33e62270d24dae79bd2eb5125", "node_id": "C_kwDOAAsO6NoAKDgyODE5NmJlM2JkOTJiYTMzZTYyMjcwZDI0ZGFlNzliZDJlYjUxMjU", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-03-18T10:55:53Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-03-18T11:01:59Z"}, "message": "fix: Fix runnables trying to add doc tests in the crate root from #[macro_export] macros", "tree": {"sha": "2ada73ff6d50de07d05e8c9f4faa9916ac14cb8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2ada73ff6d50de07d05e8c9f4faa9916ac14cb8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/828196be3bd92ba33e62270d24dae79bd2eb5125", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/828196be3bd92ba33e62270d24dae79bd2eb5125", "html_url": "https://github.com/rust-lang/rust/commit/828196be3bd92ba33e62270d24dae79bd2eb5125", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/828196be3bd92ba33e62270d24dae79bd2eb5125/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd17933c31b7e4e8b1750c59a8de2e4ab0268c33", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd17933c31b7e4e8b1750c59a8de2e4ab0268c33", "html_url": "https://github.com/rust-lang/rust/commit/bd17933c31b7e4e8b1750c59a8de2e4ab0268c33"}], "stats": {"total": 101, "additions": 98, "deletions": 3}, "files": [{"sha": "9207614c68d7b7f0743fc3038fdd8130a4d47ab8", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=828196be3bd92ba33e62270d24dae79bd2eb5125", "patch": "@@ -570,6 +570,12 @@ impl Module {\n             .collect()\n     }\n \n+    pub fn legacy_macros(self, db: &dyn HirDatabase) -> Vec<Macro> {\n+        let def_map = self.id.def_map(db.upcast());\n+        let scope = &def_map[self.id.local_id].scope;\n+        scope.legacy_macros().map(|(_, it)| MacroId::from(it).into()).collect()\n+    }\n+\n     pub fn impl_defs(self, db: &dyn HirDatabase) -> Vec<Impl> {\n         let def_map = self.id.def_map(db.upcast());\n         def_map[self.id.local_id].scope.impls().map(Impl::from).collect()\n@@ -1789,6 +1795,10 @@ impl Macro {\n         }\n     }\n \n+    pub fn is_macro_export(self, db: &dyn HirDatabase) -> bool {\n+        matches!(self.id, MacroId::MacroRulesId(id) if db.macro_rules_data(id).macro_export)\n+    }\n+\n     pub fn kind(&self, db: &dyn HirDatabase) -> MacroKind {\n         match self.id {\n             MacroId::Macro2Id(it) => match it.lookup(db.upcast()).expander {"}, {"sha": "ffb733c2b9722064b9356742d3504b6d5c1937a2", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=828196be3bd92ba33e62270d24dae79bd2eb5125", "patch": "@@ -315,6 +315,7 @@ impl Macro2Data {\n #[derive(Debug, Clone, PartialEq, Eq)]\n pub struct MacroRulesData {\n     pub name: Name,\n+    pub macro_export: bool,\n }\n \n impl MacroRulesData {\n@@ -326,7 +327,12 @@ impl MacroRulesData {\n         let item_tree = loc.id.item_tree(db);\n         let makro = &item_tree[loc.id.value];\n \n-        Arc::new(MacroRulesData { name: makro.name.clone() })\n+        let macro_export = item_tree\n+            .attrs(db, loc.container.krate(), ModItem::from(loc.id.value).into())\n+            .by_key(\"macro_export\")\n+            .exists();\n+\n+        Arc::new(MacroRulesData { name: makro.name.clone(), macro_export })\n     }\n }\n #[derive(Debug, Clone, PartialEq, Eq)]"}, {"sha": "f1330b34d1fe6f7af286e89a1154135e2b34fe4c", "filename": "crates/hir_def/src/item_scope.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fhir_def%2Fsrc%2Fitem_scope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fhir_def%2Fsrc%2Fitem_scope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_scope.rs?ref=828196be3bd92ba33e62270d24dae79bd2eb5125", "patch": "@@ -63,6 +63,7 @@ pub struct ItemScope {\n     // FIXME: Macro shadowing in one module is not properly handled. Non-item place macros will\n     // be all resolved to the last one defined if shadowing happens.\n     legacy_macros: FxHashMap<Name, MacroRulesId>,\n+    /// The derive macro invocations in this scope.\n     attr_macros: FxHashMap<AstId<ast::Item>, MacroCallId>,\n     /// The derive macro invocations in this scope, keyed by the owner item over the actual derive attributes\n     /// paired with the derive macro invocations for the specific attribute."}, {"sha": "2c8e898d72307e120f786328e0bbeb35e4477c60", "filename": "crates/ide/src/runnables.rs", "status": "modified", "additions": 71, "deletions": 1, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fide%2Fsrc%2Frunnables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fide%2Fsrc%2Frunnables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Frunnables.rs?ref=828196be3bd92ba33e62270d24dae79bd2eb5125", "patch": "@@ -157,7 +157,13 @@ pub(crate) fn runnables(db: &RootDatabase, file_id: FileId) -> Vec<Runnable> {\n             Definition::SelfType(impl_) => runnable_impl(&sema, &impl_),\n             _ => None,\n         };\n-        add_opt(runnable.or_else(|| module_def_doctest(sema.db, def)), Some(def));\n+        add_opt(\n+            runnable\n+                .or_else(|| module_def_doctest(sema.db, def))\n+                // #[macro_export] mbe macros are declared in the root, while their definition may reside in a different module\n+                .filter(|it| it.nav.file_id == file_id),\n+            Some(def),\n+        );\n         if let Definition::SelfType(impl_) = def {\n             impl_.items(db).into_iter().for_each(|assoc| {\n                 let runnable = match assoc {\n@@ -2074,4 +2080,68 @@ impl<T, U> Foo<T, U> {\n             \"#]],\n         );\n     }\n+\n+    #[test]\n+    fn doc_test_macro_export_mbe() {\n+        check(\n+            r#\"\n+//- /lib.rs\n+$0\n+mod foo;\n+\n+//- /foo.rs\n+/// ```\n+/// fn foo() {\n+/// }\n+/// ```\n+#[macro_export]\n+macro_rules! foo {\n+    () => {\n+\n+    };\n+}\n+\"#,\n+            &[],\n+            expect![[r#\"\n+                []\n+            \"#]],\n+        );\n+        check(\n+            r#\"\n+//- /lib.rs\n+$0\n+/// ```\n+/// fn foo() {\n+/// }\n+/// ```\n+#[macro_export]\n+macro_rules! foo {\n+    () => {\n+\n+    };\n+}\n+\"#,\n+            &[DocTest],\n+            expect![[r#\"\n+                [\n+                    Runnable {\n+                        use_name_in_title: false,\n+                        nav: NavigationTarget {\n+                            file_id: FileId(\n+                                0,\n+                            ),\n+                            full_range: 1..94,\n+                            name: \"foo\",\n+                        },\n+                        kind: DocTest {\n+                            test_id: Path(\n+                                \"foo\",\n+                            ),\n+                        },\n+                        cfg: None,\n+                    },\n+                ]\n+            \"#]],\n+        );\n+    }\n }"}, {"sha": "36457a5364f5fa421d26218fbd567748acee5b4c", "filename": "crates/ide_db/src/defs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fide_db%2Fsrc%2Fdefs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fide_db%2Fsrc%2Fdefs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fdefs.rs?ref=828196be3bd92ba33e62270d24dae79bd2eb5125", "patch": "@@ -447,7 +447,7 @@ impl NameRefClass {\n \n impl_from!(\n     Field, Module, Function, Adt, Variant, Const, Static, Trait, TypeAlias, BuiltinType, Local,\n-    GenericParam, Label\n+    GenericParam, Label, Macro\n     for Definition\n );\n "}, {"sha": "d4fda397d6827a32993af177815e3bc2aa2fd505", "filename": "crates/ide_db/src/helpers.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/828196be3bd92ba33e62270d24dae79bd2eb5125/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers.rs?ref=828196be3bd92ba33e62270d24dae79bd2eb5125", "patch": "@@ -76,6 +76,14 @@ pub fn visit_file_defs(\n         cb(def.into());\n     }\n     module.impl_defs(db).into_iter().for_each(|impl_| cb(impl_.into()));\n+\n+    let is_root = module.is_crate_root(db);\n+    module\n+        .legacy_macros(db)\n+        .into_iter()\n+        // don't show legacy macros declared in the crate-root that were already covered in declarations earlier\n+        .filter(|it| !(is_root && it.is_macro_export(db)))\n+        .for_each(|mac| cb(mac.into()));\n }\n \n /// Checks if the given lint is equal or is contained by the other lint which may or may not be a group."}]}