{"sha": "3890992d0a9509bfab77659bc23f065ebcd3c2ba", "node_id": "C_kwDOAAsO6NoAKDM4OTA5OTJkMGE5NTA5YmZhYjc3NjU5YmMyM2YwNjVlYmNkM2MyYmE", "commit": {"author": {"name": "Joshua Nelson", "email": "github@jyn.dev", "date": "2022-12-26T23:53:39Z"}, "committer": {"name": "Joshua Nelson", "email": "github@jyn.dev", "date": "2022-12-26T23:53:57Z"}, "message": "Fix panic on `x build --help --verbose`\n\nThis also makes the panic message a little more informative in case it\nhappens again.", "tree": {"sha": "e3357d069a22f7972e5d6cfb5a50935835c746f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e3357d069a22f7972e5d6cfb5a50935835c746f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3890992d0a9509bfab77659bc23f065ebcd3c2ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3890992d0a9509bfab77659bc23f065ebcd3c2ba", "html_url": "https://github.com/rust-lang/rust/commit/3890992d0a9509bfab77659bc23f065ebcd3c2ba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3890992d0a9509bfab77659bc23f065ebcd3c2ba/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88c58e3c2c097ebffac425d9e080dcb1aadf790e", "url": "https://api.github.com/repos/rust-lang/rust/commits/88c58e3c2c097ebffac425d9e080dcb1aadf790e", "html_url": "https://github.com/rust-lang/rust/commit/88c58e3c2c097ebffac425d9e080dcb1aadf790e"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "de39868d692d47a3498f5dc28190fdf961f3a6b0", "filename": "src/bootstrap/flags.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3890992d0a9509bfab77659bc23f065ebcd3c2ba/src%2Fbootstrap%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3890992d0a9509bfab77659bc23f065ebcd3c2ba/src%2Fbootstrap%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fflags.rs?ref=3890992d0a9509bfab77659bc23f065ebcd3c2ba", "patch": "@@ -351,7 +351,17 @@ To learn more about a subcommand, run `./x.py <subcommand> -h`\",\n \n         // fn usage()\n         let usage = |exit_code: i32, opts: &Options, verbose: bool, subcommand_help: &str| -> ! {\n-            let config = Config::parse(&[\"setup\".to_string()]);\n+            // We have an unfortunate situation here: some Steps use `builder.in_tree_crates` to determine their paths.\n+            // To determine those crates, we need to run `cargo metadata`, which means we need all submodules to be checked out.\n+            // That takes a while to run, so only do it when paths were explicitly requested, not on all CLI errors.\n+            // `Build::new` won't load submodules for the `setup` command.\n+            let cmd = if verbose {\n+                println!(\"note: updating submodules before printing available paths\");\n+                \"build\"\n+            } else {\n+                \"setup\"\n+            };\n+            let config = Config::parse(&[cmd.to_string()]);\n             let build = Build::new(config);\n             let paths = Builder::get_help(&build, subcommand);\n "}, {"sha": "ced1e397807e42f77e2b24d18195e046c3375b16", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3890992d0a9509bfab77659bc23f065ebcd3c2ba/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3890992d0a9509bfab77659bc23f065ebcd3c2ba/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=3890992d0a9509bfab77659bc23f065ebcd3c2ba", "patch": "@@ -1400,7 +1400,10 @@ impl Build {\n         let mut list = vec![INTERNER.intern_str(root)];\n         let mut visited = HashSet::new();\n         while let Some(krate) = list.pop() {\n-            let krate = &self.crates[&krate];\n+            let krate = self\n+                .crates\n+                .get(&krate)\n+                .unwrap_or_else(|| panic!(\"metadata missing for {krate}: {:?}\", self.crates));\n             ret.push(krate);\n             for dep in &krate.deps {\n                 if !self.crates.contains_key(dep) {"}]}