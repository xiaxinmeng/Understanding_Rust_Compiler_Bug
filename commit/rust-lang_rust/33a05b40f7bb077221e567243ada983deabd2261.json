{"sha": "33a05b40f7bb077221e567243ada983deabd2261", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMzYTA1YjQwZjdiYjA3NzIyMWU1NjcyNDNhZGE5ODNkZWFiZDIyNjE=", "commit": {"author": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-07-18T21:42:10Z"}, "committer": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-07-27T14:33:23Z"}, "message": "forbid generic params inside of anon consts in ty defaults", "tree": {"sha": "f59214f3e0c33782a5958d6375a51b4b3f196890", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f59214f3e0c33782a5958d6375a51b4b3f196890"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/33a05b40f7bb077221e567243ada983deabd2261", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/33a05b40f7bb077221e567243ada983deabd2261", "html_url": "https://github.com/rust-lang/rust/commit/33a05b40f7bb077221e567243ada983deabd2261", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/33a05b40f7bb077221e567243ada983deabd2261/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb19cdb711120123a2f5803b6c0a57012206765d", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb19cdb711120123a2f5803b6c0a57012206765d", "html_url": "https://github.com/rust-lang/rust/commit/cb19cdb711120123a2f5803b6c0a57012206765d"}], "stats": {"total": 129, "additions": 121, "deletions": 8}, "files": [{"sha": "81e29047dc5e24e14c9269a6b48154ef5e1cabca", "filename": "src/librustc_resolve/diagnostics.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Flibrustc_resolve%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Flibrustc_resolve%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fdiagnostics.rs?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -455,6 +455,17 @@ impl<'a> Resolver<'a> {\n                 );\n                 err\n             }\n+            ResolutionError::ParamInAnonConstInTyDefault(name) => {\n+                let mut err = self.session.struct_span_err(\n+                    span,\n+                    \"constant values inside of type parameter defaults must not depend on generic parameters\",\n+                );\n+                err.span_label(\n+                    span,\n+                    format!(\"the anonymous constant must not depend on the parameter `{}`\", name),\n+                );\n+                err\n+            }\n             ResolutionError::SelfInTyParamDefault => {\n                 let mut err = struct_span_err!(\n                     self.session,"}, {"sha": "bcd2c6c1f1c27cc3e29cede1605e9e44b9cb5eb0", "filename": "src/librustc_resolve/late.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Flibrustc_resolve%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Flibrustc_resolve%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flate.rs?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -570,7 +570,15 @@ impl<'a, 'ast> Visitor<'ast> for LateResolutionVisitor<'a, '_, 'ast> {\n \n                     if let Some(ref ty) = default {\n                         self.ribs[TypeNS].push(default_ban_rib);\n-                        self.visit_ty(ty);\n+                        self.with_rib(ValueNS, ForwardTyParamBanRibKind, |this| {\n+                            // HACK: We use an empty `ForwardTyParamBanRibKind` here which\n+                            // is only used to forbid the use of const parameters inside of\n+                            // type defaults.\n+                            //\n+                            // While the rib name doesn't really fit here, it does allow us to use the same\n+                            // code for both const and type parameters.\n+                            this.visit_ty(ty);\n+                        });\n                         default_ban_rib = self.ribs[TypeNS].pop().unwrap();\n                     }\n \n@@ -1081,7 +1089,9 @@ impl<'a, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n     fn with_constant_rib(&mut self, f: impl FnOnce(&mut Self)) {\n         debug!(\"with_constant_rib\");\n         self.with_rib(ValueNS, ConstantItemRibKind, |this| {\n-            this.with_label_rib(ConstantItemRibKind, f);\n+            this.with_rib(TypeNS, ConstantItemRibKind, |this| {\n+                this.with_label_rib(ConstantItemRibKind, f);\n+            })\n         });\n     }\n "}, {"sha": "234fcd789eee4932242b5e389356ce43f5a827b0", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 53, "deletions": 6, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -216,6 +216,8 @@ enum ResolutionError<'a> {\n     ForwardDeclaredTyParam, // FIXME(const_generics:defaults)\n     /// ERROR E0770: the type of const parameters must not depend on other generic parameters.\n     ParamInTyOfConstParam(Symbol),\n+    /// constant values inside of type parameter defaults must not depend on generic parameters.\n+    ParamInAnonConstInTyDefault(Symbol),\n     /// Error E0735: type parameters with a default cannot use `Self`\n     SelfInTyParamDefault,\n     /// Error E0767: use of unreachable label\n@@ -2526,18 +2528,40 @@ impl<'a> Resolver<'a> {\n                 }\n             }\n             Res::Def(DefKind::TyParam, _) | Res::SelfTy(..) => {\n+                let mut in_ty_param_default = false;\n                 for rib in ribs {\n                     let has_generic_params = match rib.kind {\n                         NormalRibKind\n                         | ClosureOrAsyncRibKind\n                         | AssocItemRibKind\n                         | ModuleRibKind(..)\n-                        | MacroDefinition(..)\n-                        | ForwardTyParamBanRibKind\n-                        | ConstantItemRibKind => {\n+                        | MacroDefinition(..) => {\n                             // Nothing to do. Continue.\n                             continue;\n                         }\n+\n+                        // We only forbid constant items if we are inside of type defaults,\n+                        // for example `struct Foo<T, U = [u8; std::mem::size_of::<T>()]>`\n+                        ForwardTyParamBanRibKind => {\n+                            in_ty_param_default = true;\n+                            continue;\n+                        }\n+                        ConstantItemRibKind => {\n+                            if in_ty_param_default {\n+                                if record_used {\n+                                    self.report_error(\n+                                        span,\n+                                        ResolutionError::ParamInAnonConstInTyDefault(\n+                                            rib_ident.name,\n+                                        ),\n+                                    );\n+                                }\n+                                return Res::Err;\n+                            } else {\n+                                continue;\n+                            }\n+                        }\n+\n                         // This was an attempt to use a type parameter outside its scope.\n                         ItemRibKind(has_generic_params) => has_generic_params,\n                         FnItemRibKind => HasGenericParams::Yes,\n@@ -2572,15 +2596,38 @@ impl<'a> Resolver<'a> {\n                     // (spuriously) conflicting with the const param.\n                     ribs.next();\n                 }\n+\n+                let mut in_ty_param_default = false;\n                 for rib in ribs {\n                     let has_generic_params = match rib.kind {\n                         NormalRibKind\n                         | ClosureOrAsyncRibKind\n                         | AssocItemRibKind\n                         | ModuleRibKind(..)\n-                        | MacroDefinition(..)\n-                        | ForwardTyParamBanRibKind\n-                        | ConstantItemRibKind => continue,\n+                        | MacroDefinition(..) => continue,\n+\n+                        // We only forbid constant items if we are inside of type defaults,\n+                        // for example `struct Foo<T, U = [u8; std::mem::size_of::<T>()]>`\n+                        ForwardTyParamBanRibKind => {\n+                            in_ty_param_default = true;\n+                            continue;\n+                        }\n+                        ConstantItemRibKind => {\n+                            if in_ty_param_default {\n+                                if record_used {\n+                                    self.report_error(\n+                                        span,\n+                                        ResolutionError::ParamInAnonConstInTyDefault(\n+                                            rib_ident.name,\n+                                        ),\n+                                    );\n+                                }\n+                                return Res::Err;\n+                            } else {\n+                                continue;\n+                            }\n+                        }\n+\n                         ItemRibKind(has_generic_params) => has_generic_params,\n                         FnItemRibKind => HasGenericParams::Yes,\n                         ConstParamTyRibKind => {"}, {"sha": "c118fa7acc4ecc9c4a27019bc64c75b93f53a63b", "filename": "src/test/ui/const-generics/params-in-ct-in-ty-param-lazy-norm.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fconst-generics%2Fparams-in-ct-in-ty-param-lazy-norm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fconst-generics%2Fparams-in-ct-in-ty-param-lazy-norm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fparams-in-ct-in-ty-param-lazy-norm.rs?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -0,0 +1,10 @@\n+#![feature(const_generics)] //~ WARN the feature `const_generics` is incomplete\n+\n+struct Foo<T, U = [u8; std::mem::size_of::<T>()]>(T, U);\n+//~^ ERROR constant values inside of type parameter defaults\n+\n+// FIXME(const_generics:defaults): We still don't know how to we deal with type defaults.\n+struct Bar<T = [u8; N], const N: usize>(T);\n+//~^ ERROR constant values inside of type parameter defaults\n+\n+fn main() {}"}, {"sha": "8e6676b01f11f7bc161584d87088b0e225e16037", "filename": "src/test/ui/const-generics/params-in-ct-in-ty-param-lazy-norm.stderr", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fconst-generics%2Fparams-in-ct-in-ty-param-lazy-norm.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fconst-generics%2Fparams-in-ct-in-ty-param-lazy-norm.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fparams-in-ct-in-ty-param-lazy-norm.stderr?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -0,0 +1,23 @@\n+error: constant values inside of type parameter defaults must not depend on generic parameters\n+  --> $DIR/params-in-ct-in-ty-param-lazy-norm.rs:3:44\n+   |\n+LL | struct Foo<T, U = [u8; std::mem::size_of::<T>()]>(T, U);\n+   |                                            ^ the anonymous constant must not depend on the parameter `T`\n+\n+error: constant values inside of type parameter defaults must not depend on generic parameters\n+  --> $DIR/params-in-ct-in-ty-param-lazy-norm.rs:7:21\n+   |\n+LL | struct Bar<T = [u8; N], const N: usize>(T);\n+   |                     ^ the anonymous constant must not depend on the parameter `N`\n+\n+warning: the feature `const_generics` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/params-in-ct-in-ty-param-lazy-norm.rs:1:12\n+   |\n+LL | #![feature(const_generics)]\n+   |            ^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+\n+error: aborting due to 2 previous errors; 1 warning emitted\n+"}, {"sha": "dd89bc0f7a0ff856feba1e555509b6fe48b84127", "filename": "src/test/ui/generic/param-in-ct-in-ty-param-default.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fgeneric%2Fparam-in-ct-in-ty-param-default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fgeneric%2Fparam-in-ct-in-ty-param-default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric%2Fparam-in-ct-in-ty-param-default.rs?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -0,0 +1,4 @@\n+struct Foo<T, U = [u8; std::mem::size_of::<T>()]>(T, U);\n+//~^ ERROR constant values inside of type parameter defaults\n+\n+fn main() {}"}, {"sha": "ea867240269efdd3bf0de265687cc543d4eaf5d3", "filename": "src/test/ui/generic/param-in-ct-in-ty-param-default.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fgeneric%2Fparam-in-ct-in-ty-param-default.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/33a05b40f7bb077221e567243ada983deabd2261/src%2Ftest%2Fui%2Fgeneric%2Fparam-in-ct-in-ty-param-default.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric%2Fparam-in-ct-in-ty-param-default.stderr?ref=33a05b40f7bb077221e567243ada983deabd2261", "patch": "@@ -0,0 +1,8 @@\n+error: constant values inside of type parameter defaults must not depend on generic parameters\n+  --> $DIR/param-in-ct-in-ty-param-default.rs:1:44\n+   |\n+LL | struct Foo<T, U = [u8; std::mem::size_of::<T>()]>(T, U);\n+   |                                            ^ the anonymous constant must not depend on the parameter `T`\n+\n+error: aborting due to previous error\n+"}]}