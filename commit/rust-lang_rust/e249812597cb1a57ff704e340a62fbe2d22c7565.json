{"sha": "e249812597cb1a57ff704e340a62fbe2d22c7565", "node_id": "C_kwDOAAsO6NoAKGUyNDk4MTI1OTdjYjFhNTdmZjcwNGUzNDBhNjJmYmUyZDIyYzc1NjU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-26T22:45:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-26T22:45:21Z"}, "message": "Rollup merge of #92134 - nico-abram:patch-1, r=michaelwoerister\n\nAdd x86_64-pc-windows-msvc linker-plugin-lto instructions\n\nI had some trouble getting cross language LTO working for this target, in part because the very few links of documentation I could find were linux-centric and because of a few very specific errors I ran into. I'm not sure if this is the correct place to document this, but this is one of the first links I found when looking for documentation so it might be the best place for it.", "tree": {"sha": "4c4ffd5e6db5b9a751057398c75a2c370dea68c1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c4ffd5e6db5b9a751057398c75a2c370dea68c1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e249812597cb1a57ff704e340a62fbe2d22c7565", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh8c8BCRBK7hj4Ov3rIwAARLYIADEZP2dBj3hqGIJnp+IMWV3x\n7gKgC7s+1zIsobDOiOjG8PPExIqx7xSD9n4zGLDw3VYn2yvNfyLaiaititb3Rf1D\nJkjCqxERO3Y7lESB8d7YxfbaUoGmSGiQ6XCsyBmvzAAmnGwZlKFB0prUpBGqJDAU\nK4qN4mmt7mGZo7qq+cZNjFN17Mq7T+uDg2q8dHeDD+iCU4b5Ge2gncy9Ka6QocRn\nqR5oGk1ihSiKFcj4T0Ni9JYnQqeTjCVZfpJsbwGFC1Om27uJ2kqYRk+pbAdy81Mx\nVBvqiZkXYXJeff0ViPbXW4puOgqyuWnriC58MDA8hwDFyQfh3MyfXbLLGFswPYU=\n=KdIg\n-----END PGP SIGNATURE-----\n", "payload": "tree 4c4ffd5e6db5b9a751057398c75a2c370dea68c1\nparent 75eb96301d85852b24397ac3d747c7091cd28b11\nparent b75cb95c269231e4e065dccc27bcf63543550325\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1643237121 +0100\ncommitter GitHub <noreply@github.com> 1643237121 +0100\n\nRollup merge of #92134 - nico-abram:patch-1, r=michaelwoerister\n\nAdd x86_64-pc-windows-msvc linker-plugin-lto instructions\n\nI had some trouble getting cross language LTO working for this target, in part because the very few links of documentation I could find were linux-centric and because of a few very specific errors I ran into. I'm not sure if this is the correct place to document this, but this is one of the first links I found when looking for documentation so it might be the best place for it.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e249812597cb1a57ff704e340a62fbe2d22c7565", "html_url": "https://github.com/rust-lang/rust/commit/e249812597cb1a57ff704e340a62fbe2d22c7565", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e249812597cb1a57ff704e340a62fbe2d22c7565/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75eb96301d85852b24397ac3d747c7091cd28b11", "url": "https://api.github.com/repos/rust-lang/rust/commits/75eb96301d85852b24397ac3d747c7091cd28b11", "html_url": "https://github.com/rust-lang/rust/commit/75eb96301d85852b24397ac3d747c7091cd28b11"}, {"sha": "b75cb95c269231e4e065dccc27bcf63543550325", "url": "https://api.github.com/repos/rust-lang/rust/commits/b75cb95c269231e4e065dccc27bcf63543550325", "html_url": "https://github.com/rust-lang/rust/commit/b75cb95c269231e4e065dccc27bcf63543550325"}], "stats": {"total": 42, "additions": 42, "deletions": 0}, "files": [{"sha": "941c65922d8f09d3d1db1a6b818a1d5420eee222", "filename": "src/doc/rustc/src/linker-plugin-lto.md", "status": "modified", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/e249812597cb1a57ff704e340a62fbe2d22c7565/src%2Fdoc%2Frustc%2Fsrc%2Flinker-plugin-lto.md", "raw_url": "https://github.com/rust-lang/rust/raw/e249812597cb1a57ff704e340a62fbe2d22c7565/src%2Fdoc%2Frustc%2Fsrc%2Flinker-plugin-lto.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Flinker-plugin-lto.md?ref=e249812597cb1a57ff704e340a62fbe2d22c7565", "patch": "@@ -86,6 +86,48 @@ option:\n rustc -Clinker-plugin-lto=\"/path/to/LLVMgold.so\" -L. -Copt-level=2 ./main.rs\n ```\n \n+### Usage with clang-cl and x86_64-pc-windows-msvc\n+\n+Cross language LTO can be used with the x86_64-pc-windows-msvc target, but this requires using the\n+clang-cl compiler instead of the MSVC cl.exe included with Visual Studio Build Tools, and linking\n+with lld-link. Both clang-cl and lld-link can be downloaded from [LLVM's download page](https://releases.llvm.org/download.html).\n+Note that most crates in the ecosystem are likely to assume you are using cl.exe if using this target\n+and that some things, like for example vcpkg, [don't work very well with clang-cl](https://github.com/microsoft/vcpkg/issues/2087).\n+\n+You will want to make sure your rust major LLVM version matches your installed LLVM tooling version,\n+otherwise it is likely you will get linker errors:\n+\n+```bat\n+rustc -V --verbose\n+clang-cl --version\n+```\n+\n+If you are compiling any proc-macros, you will get this error:\n+\n+```bash\n+error: Linker plugin based LTO is not supported together with `-C prefer-dynamic` when\n+targeting Windows-like targets\n+```\n+\n+This is fixed if you explicitly set the target, for example\n+`cargo build --target x86_64-pc-windows-msvc`\n+Without an explicit --target the flags will be passed to all compiler invocations (including build\n+scripts and proc macros), see [cargo docs on rustflags](https://doc.rust-lang.org/cargo/reference/config.html#buildrustflags)\n+\n+If you have dependencies using the `cc` crate, you will need to set these\n+environment variables:\n+```bat\n+set CC=clang-cl\n+set CXX=clang-cl\n+set CFLAGS=/clang:-flto=thin /clang:-fuse-ld=lld-link\n+set CXXFLAGS=/clang:-flto=thin /clang:-fuse-ld=lld-link\n+REM Needed because msvc's lib.exe crashes on LLVM LTO .obj files\n+set AR=llvm-lib\n+```\n+\n+If you are specifying lld-link as your linker by setting `linker = \"lld-link.exe\"` in your cargo config,\n+you may run into issues with some crates that compile code with separate cargo invocations. You should be\n+able to get around this problem by setting `-Clinker=lld-link` in RUSTFLAGS\n \n ## Toolchain Compatibility\n "}]}