{"sha": "2a466466c768dc56382550a3130674b2eebe227c", "node_id": "C_kwDOAAsO6NoAKDJhNDY2NDY2Yzc2OGRjNTYzODI1NTBhMzEzMDY3NGIyZWViZTIyN2M", "commit": {"author": {"name": "marc0246", "email": "40955683+marc0246@users.noreply.github.com", "date": "2023-05-16T06:53:05Z"}, "committer": {"name": "marc0246", "email": "40955683+marc0246@users.noreply.github.com", "date": "2023-05-16T06:53:05Z"}, "message": "Fix duplicate `arcinner_layout_for_value_layout` calls", "tree": {"sha": "23dd55e2989c91026281f89a61e19cc9156cc7c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23dd55e2989c91026281f89a61e19cc9156cc7c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a466466c768dc56382550a3130674b2eebe227c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJfBAABCABJFiEEW438jQio9CWtboLOaJy4jBCQxoQFAmRjKFErHDQwOTU1Njgz\nK21hcmMwMjQ2QHVzZXJzLm5vcmVwbHkuZ2l0aHViLmNvbQAKCRBonLiMEJDGhEwV\nEACHarTHDsT+8PjX8cDEpeJl5RVwfBeU9d4jQCzrKHTI4UvxuK1gD37EOuq6RAyo\nSFvM1TwQVsFKzgvONYkJUtSVUog2qZrftoJd04PxmqK3pirCGw8tAtLjf/rHYWGT\nTHcCFEuoQUOU6l7eG0jsuhIvU6GsHWv04vhotzKG2dEiY47In8Jjw/H21RhqFwOz\naqz1Y6Jgb2vODI1nxVTvGTjRlP4ECBH+EmkmlEEjyw78DTV9bqNwNycIdMREnj5y\nOovGVqoHkonMiiIaT7l/xPzfj390W1iAr0qu5Pbb5Ti1TkfSEFIhw5/Kgxu/6PQD\ne6+VabYgchNabs+sPMIUzyWKBNWKpyCIEUbL0cbckoUL5pCoP5Mq4Yhxr7Hd38v4\npxciSjQBfgWENn/OehxfsmJRFImyIATZ0AR6mzfPm+V9QWus3gQLnCNcTDUBTv7k\n5VgHdXxHR3GMhA8o84+PC0E+82Di4nfjHiPjHNdx3GRZbd/uwi/c5xKsq9Lm3aya\n1+gUKYoh77OJbIHYzac+3TaRalVR/LVrbgif1wycuHk9lmw1aHVW+4LlfDyB7uVT\noXl2N1JYEn+nmSNDzMcwC/aWmgrBuhYJa+NywkO9DgvwQu3XU2tFAFdAlQfZ6goN\nG6kt/NxWCF4Z/1VpiHSdNcaDtYuxHP0Lv3zUBloCKZlupA==\n=iSJK\n-----END PGP SIGNATURE-----", "payload": "tree 23dd55e2989c91026281f89a61e19cc9156cc7c8\nparent 8006510ab0f69ee75e9c3f7e8bff3776886dae51\nauthor marc0246 <40955683+marc0246@users.noreply.github.com> 1684219985 +0200\ncommitter marc0246 <40955683+marc0246@users.noreply.github.com> 1684219985 +0200\n\nFix duplicate `arcinner_layout_for_value_layout` calls\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a466466c768dc56382550a3130674b2eebe227c", "html_url": "https://github.com/rust-lang/rust/commit/2a466466c768dc56382550a3130674b2eebe227c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a466466c768dc56382550a3130674b2eebe227c/comments", "author": {"login": "marc0246", "id": 40955683, "node_id": "MDQ6VXNlcjQwOTU1Njgz", "avatar_url": "https://avatars.githubusercontent.com/u/40955683?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marc0246", "html_url": "https://github.com/marc0246", "followers_url": "https://api.github.com/users/marc0246/followers", "following_url": "https://api.github.com/users/marc0246/following{/other_user}", "gists_url": "https://api.github.com/users/marc0246/gists{/gist_id}", "starred_url": "https://api.github.com/users/marc0246/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marc0246/subscriptions", "organizations_url": "https://api.github.com/users/marc0246/orgs", "repos_url": "https://api.github.com/users/marc0246/repos", "events_url": "https://api.github.com/users/marc0246/events{/privacy}", "received_events_url": "https://api.github.com/users/marc0246/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marc0246", "id": 40955683, "node_id": "MDQ6VXNlcjQwOTU1Njgz", "avatar_url": "https://avatars.githubusercontent.com/u/40955683?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marc0246", "html_url": "https://github.com/marc0246", "followers_url": "https://api.github.com/users/marc0246/followers", "following_url": "https://api.github.com/users/marc0246/following{/other_user}", "gists_url": "https://api.github.com/users/marc0246/gists{/gist_id}", "starred_url": "https://api.github.com/users/marc0246/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marc0246/subscriptions", "organizations_url": "https://api.github.com/users/marc0246/orgs", "repos_url": "https://api.github.com/users/marc0246/repos", "events_url": "https://api.github.com/users/marc0246/events{/privacy}", "received_events_url": "https://api.github.com/users/marc0246/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8006510ab0f69ee75e9c3f7e8bff3776886dae51", "url": "https://api.github.com/repos/rust-lang/rust/commits/8006510ab0f69ee75e9c3f7e8bff3776886dae51", "html_url": "https://github.com/rust-lang/rust/commit/8006510ab0f69ee75e9c3f7e8bff3776886dae51"}], "stats": {"total": 53, "additions": 47, "deletions": 6}, "files": [{"sha": "bfdb7a92beff68015ee090e3eb7056ef283994b7", "filename": "library/alloc/src/sync.rs", "status": "modified", "additions": 19, "deletions": 6, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/2a466466c768dc56382550a3130674b2eebe227c/library%2Falloc%2Fsrc%2Fsync.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a466466c768dc56382550a3130674b2eebe227c/library%2Falloc%2Fsrc%2Fsync.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fsync.rs?ref=2a466466c768dc56382550a3130674b2eebe227c", "patch": "@@ -502,6 +502,7 @@ impl<T> Arc<T> {\n     /// assert_eq!(*five, 5)\n     /// ```\n     #[cfg(not(no_global_oom_handling))]\n+    #[inline]\n     #[unstable(feature = \"new_uninit\", issue = \"63291\")]\n     #[must_use]\n     pub fn new_uninit() -> Arc<mem::MaybeUninit<T>> {\n@@ -535,6 +536,7 @@ impl<T> Arc<T> {\n     ///\n     /// [zeroed]: mem::MaybeUninit::zeroed\n     #[cfg(not(no_global_oom_handling))]\n+    #[inline]\n     #[unstable(feature = \"new_uninit\", issue = \"63291\")]\n     #[must_use]\n     pub fn new_zeroed() -> Arc<mem::MaybeUninit<T>> {\n@@ -844,6 +846,7 @@ impl<T> Arc<[T]> {\n     /// assert_eq!(*values, [1, 2, 3])\n     /// ```\n     #[cfg(not(no_global_oom_handling))]\n+    #[inline]\n     #[unstable(feature = \"new_uninit\", issue = \"63291\")]\n     #[must_use]\n     pub fn new_uninit_slice(len: usize) -> Arc<[mem::MaybeUninit<T>]> {\n@@ -871,6 +874,7 @@ impl<T> Arc<[T]> {\n     ///\n     /// [zeroed]: mem::MaybeUninit::zeroed\n     #[cfg(not(no_global_oom_handling))]\n+    #[inline]\n     #[unstable(feature = \"new_uninit\", issue = \"63291\")]\n     #[must_use]\n     pub fn new_zeroed_slice(len: usize) -> Arc<[mem::MaybeUninit<T>]> {\n@@ -1300,10 +1304,10 @@ impl<T: ?Sized> Arc<T> {\n         mem_to_arcinner: impl FnOnce(*mut u8) -> *mut ArcInner<T>,\n     ) -> *mut ArcInner<T> {\n         let layout = arcinner_layout_for_value_layout(value_layout);\n-        unsafe {\n-            Arc::try_allocate_for_layout(value_layout, allocate, mem_to_arcinner)\n-                .unwrap_or_else(|_| handle_alloc_error(layout))\n-        }\n+\n+        let ptr = allocate(layout).unwrap_or_else(|_| handle_alloc_error(layout));\n+\n+        unsafe { Self::initialize_arcinner(ptr, layout, mem_to_arcinner) }\n     }\n \n     /// Allocates an `ArcInner<T>` with sufficient space for\n@@ -1321,7 +1325,16 @@ impl<T: ?Sized> Arc<T> {\n \n         let ptr = allocate(layout)?;\n \n-        // Initialize the ArcInner\n+        let inner = unsafe { Self::initialize_arcinner(ptr, layout, mem_to_arcinner) };\n+\n+        Ok(inner)\n+    }\n+\n+    unsafe fn initialize_arcinner(\n+        ptr: NonNull<[u8]>,\n+        layout: Layout,\n+        mem_to_arcinner: impl FnOnce(*mut u8) -> *mut ArcInner<T>,\n+    ) -> *mut ArcInner<T> {\n         let inner = mem_to_arcinner(ptr.as_non_null_ptr().as_ptr());\n         debug_assert_eq!(unsafe { Layout::for_value(&*inner) }, layout);\n \n@@ -1330,7 +1343,7 @@ impl<T: ?Sized> Arc<T> {\n             ptr::write(&mut (*inner).weak, atomic::AtomicUsize::new(1));\n         }\n \n-        Ok(inner)\n+        inner\n     }\n \n     /// Allocates an `ArcInner<T>` with sufficient space for an unsized inner value."}, {"sha": "90b3c314d2f4bfec8444f76dc05e0ab4967b8843", "filename": "tests/codegen/issues/issue-111603.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/2a466466c768dc56382550a3130674b2eebe227c/tests%2Fcodegen%2Fissues%2Fissue-111603.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a466466c768dc56382550a3130674b2eebe227c/tests%2Fcodegen%2Fissues%2Fissue-111603.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcodegen%2Fissues%2Fissue-111603.rs?ref=2a466466c768dc56382550a3130674b2eebe227c", "patch": "@@ -0,0 +1,28 @@\n+// compile-flags: -O\n+\n+#![crate_type = \"lib\"]\n+#![feature(get_mut_unchecked, new_uninit)]\n+\n+use std::sync::Arc;\n+\n+// CHECK-LABEL: @new_uninit\n+#[no_mangle]\n+pub fn new_uninit(x: u64) -> Arc<[u64; 1000]> {\n+    // CHECK: call alloc::sync::arcinner_layout_for_value_layout\n+    // CHECK-NOT: call alloc::sync::arcinner_layout_for_value_layout\n+    let mut arc = Arc::new_uninit();\n+    unsafe { Arc::get_mut_unchecked(&mut arc) }.write([x; 1000]);\n+    unsafe { arc.assume_init() }\n+}\n+\n+// CHECK-LABEL: @new_uninit_slice\n+#[no_mangle]\n+pub fn new_uninit_slice(x: u64) -> Arc<[u64]> {\n+    // CHECK: call alloc::sync::arcinner_layout_for_value_layout\n+    // CHECK-NOT: call alloc::sync::arcinner_layout_for_value_layout\n+    let mut arc = Arc::new_uninit_slice(1000);\n+    for elem in unsafe { Arc::get_mut_unchecked(&mut arc) } {\n+        elem.write(x);\n+    }\n+    unsafe { arc.assume_init() }\n+}"}]}