{"sha": "af4acd05338dcb0d47e235862b303c37d655951f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmNGFjZDA1MzM4ZGNiMGQ0N2UyMzU4NjJiMzAzYzM3ZDY1NTk1MWY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-04-12T18:36:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-04-12T18:36:16Z"}, "message": "Rollup merge of #59866 - estebank:recover-missing-semi, r=petrochenkov\n\nRecover from missing semicolon based on the found token\n\nWhen encountering one of a few keywords when a semicolon was\nexpected, suggest the semicolon and recover:\n\n```\nerror: expected one of `.`, `;`, `?`, or an operator, found `let`\n  --> $DIR/recover-missing-semi.rs:4:5\n   |\nLL |     let _: usize = ()\n   |                      - help: missing semicolon here\nLL |\nLL |     let _ = 3;\n   |     ^^^\n\nerror[E0308]: mismatched types\n  --> $DIR/recover-missing-semi.rs:2:20\n   |\nLL |     let _: usize = ()\n   |                    ^^ expected usize, found ()\n   |\n   = note: expected type `usize`\n              found type `()`\n```", "tree": {"sha": "dffad55345acacf47eb4c37efabe13d151c0fcd7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dffad55345acacf47eb4c37efabe13d151c0fcd7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af4acd05338dcb0d47e235862b303c37d655951f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcsNqhCRBK7hj4Ov3rIwAAdHIIACXP7bpdrP/RzVqAwpU7ns5d\nJ0IwxASL2PWnu7WkBz0g7fTEi6EwioSlxC1JAhQtZJ3ax0ZBrx6u7hs2GIHw38z/\nJIZkyFTgtz1q0Kv11qvDiDhiQqEZNXu9NNcckltdo9W3uk3fTYd8wj7Sn57FPFGu\nst++eVo7/x0ovr1QitJiA0lNdeZyFX9PYcLDyF35Y6jKcElpfUI7df1jVH5TBcz1\nRNWIK53TUu15e6RhaQi8EDs7H8Snd7/4NjF0jnTqPDyp78Ys22eAk6onWU+88Bvm\nhIZA3XPTPxHD29kATb7KGSyGtsBE62I0xG9uSQl27nZ3z07a4vycpWVmOYoOQfQ=\n=PgLg\n-----END PGP SIGNATURE-----\n", "payload": "tree dffad55345acacf47eb4c37efabe13d151c0fcd7\nparent ca9f04e41e2bb124e3ae74f6c179eeeac96e9c67\nparent 9b6b3d618c16976a273cfd4f95408eef37e6c82e\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1555094176 +0200\ncommitter GitHub <noreply@github.com> 1555094176 +0200\n\nRollup merge of #59866 - estebank:recover-missing-semi, r=petrochenkov\n\nRecover from missing semicolon based on the found token\n\nWhen encountering one of a few keywords when a semicolon was\nexpected, suggest the semicolon and recover:\n\n```\nerror: expected one of `.`, `;`, `?`, or an operator, found `let`\n  --> $DIR/recover-missing-semi.rs:4:5\n   |\nLL |     let _: usize = ()\n   |                      - help: missing semicolon here\nLL |\nLL |     let _ = 3;\n   |     ^^^\n\nerror[E0308]: mismatched types\n  --> $DIR/recover-missing-semi.rs:2:20\n   |\nLL |     let _: usize = ()\n   |                    ^^ expected usize, found ()\n   |\n   = note: expected type `usize`\n              found type `()`\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af4acd05338dcb0d47e235862b303c37d655951f", "html_url": "https://github.com/rust-lang/rust/commit/af4acd05338dcb0d47e235862b303c37d655951f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af4acd05338dcb0d47e235862b303c37d655951f/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ca9f04e41e2bb124e3ae74f6c179eeeac96e9c67", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca9f04e41e2bb124e3ae74f6c179eeeac96e9c67", "html_url": "https://github.com/rust-lang/rust/commit/ca9f04e41e2bb124e3ae74f6c179eeeac96e9c67"}, {"sha": "9b6b3d618c16976a273cfd4f95408eef37e6c82e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b6b3d618c16976a273cfd4f95408eef37e6c82e", "html_url": "https://github.com/rust-lang/rust/commit/9b6b3d618c16976a273cfd4f95408eef37e6c82e"}], "stats": {"total": 78, "additions": 78, "deletions": 0}, "files": [{"sha": "a5adb37f7455c279b4973d97784c46a1196bb72c", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/af4acd05338dcb0d47e235862b303c37d655951f/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af4acd05338dcb0d47e235862b303c37d655951f/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=af4acd05338dcb0d47e235862b303c37d655951f", "patch": "@@ -851,8 +851,34 @@ impl<'a> Parser<'a> {\n                 }\n             }\n \n+            let is_semi_suggestable = expected.iter().any(|t| match t {\n+                TokenType::Token(token::Semi) => true, // we expect a `;` here\n+                _ => false,\n+            }) && ( // a `;` would be expected before the current keyword\n+                self.token.is_keyword(keywords::Break) ||\n+                self.token.is_keyword(keywords::Continue) ||\n+                self.token.is_keyword(keywords::For) ||\n+                self.token.is_keyword(keywords::If) ||\n+                self.token.is_keyword(keywords::Let) ||\n+                self.token.is_keyword(keywords::Loop) ||\n+                self.token.is_keyword(keywords::Match) ||\n+                self.token.is_keyword(keywords::Return) ||\n+                self.token.is_keyword(keywords::While)\n+            );\n             let cm = self.sess.source_map();\n             match (cm.lookup_line(self.span.lo()), cm.lookup_line(sp.lo())) {\n+                (Ok(ref a), Ok(ref b)) if a.line != b.line && is_semi_suggestable => {\n+                    // The spans are in different lines, expected `;` and found `let` or `return`.\n+                    // High likelihood that it is only a missing `;`.\n+                    err.span_suggestion_short(\n+                        label_sp,\n+                        \"a semicolon may be missing here\",\n+                        \";\".to_string(),\n+                        Applicability::MaybeIncorrect,\n+                    );\n+                    err.emit();\n+                    return Ok(true);\n+                }\n                 (Ok(ref a), Ok(ref b)) if a.line == b.line => {\n                     // When the spans are in the same line, it means that the only content between\n                     // them is whitespace, point at the found token in that case:"}, {"sha": "1893dc716bedc97116b15142663b65177193a5bb", "filename": "src/test/ui/parser/recover-missing-semi.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/af4acd05338dcb0d47e235862b303c37d655951f/src%2Ftest%2Fui%2Fparser%2Frecover-missing-semi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af4acd05338dcb0d47e235862b303c37d655951f/src%2Ftest%2Fui%2Fparser%2Frecover-missing-semi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Frecover-missing-semi.rs?ref=af4acd05338dcb0d47e235862b303c37d655951f", "patch": "@@ -0,0 +1,13 @@\n+fn main() {\n+    let _: usize = ()\n+    //~^ ERROR mismatched types\n+    let _ = 3;\n+    //~^ ERROR expected one of\n+}\n+\n+fn foo() -> usize {\n+    let _: usize = ()\n+    //~^ ERROR mismatched types\n+    return 3;\n+    //~^ ERROR expected one of\n+}"}, {"sha": "99339e4dd5025c8d9845e738633374b59f9b48d2", "filename": "src/test/ui/parser/recover-missing-semi.stderr", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/af4acd05338dcb0d47e235862b303c37d655951f/src%2Ftest%2Fui%2Fparser%2Frecover-missing-semi.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/af4acd05338dcb0d47e235862b303c37d655951f/src%2Ftest%2Fui%2Fparser%2Frecover-missing-semi.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Frecover-missing-semi.stderr?ref=af4acd05338dcb0d47e235862b303c37d655951f", "patch": "@@ -0,0 +1,39 @@\n+error: expected one of `.`, `;`, `?`, or an operator, found `let`\n+  --> $DIR/recover-missing-semi.rs:4:5\n+   |\n+LL |     let _: usize = ()\n+   |                      - help: a semicolon may be missing here\n+LL |\n+LL |     let _ = 3;\n+   |     ^^^\n+\n+error: expected one of `.`, `;`, `?`, or an operator, found `return`\n+  --> $DIR/recover-missing-semi.rs:11:5\n+   |\n+LL |     let _: usize = ()\n+   |                      - help: a semicolon may be missing here\n+LL |\n+LL |     return 3;\n+   |     ^^^^^^\n+\n+error[E0308]: mismatched types\n+  --> $DIR/recover-missing-semi.rs:2:20\n+   |\n+LL |     let _: usize = ()\n+   |                    ^^ expected usize, found ()\n+   |\n+   = note: expected type `usize`\n+              found type `()`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/recover-missing-semi.rs:9:20\n+   |\n+LL |     let _: usize = ()\n+   |                    ^^ expected usize, found ()\n+   |\n+   = note: expected type `usize`\n+              found type `()`\n+\n+error: aborting due to 4 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}