{"sha": "ae15d1094a1185e965a3de1672c5159546af9863", "node_id": "C_kwDOAAsO6NoAKGFlMTVkMTA5NGExMTg1ZTk2NWEzZGUxNjcyYzUxNTk1NDZhZjk4NjM", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-01-23T10:29:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-23T10:29:59Z"}, "message": "Rollup merge of #106886 - dtolnay:fastinstall, r=Mark-Simulacrum\n\nMake stage2 rustdoc and proc-macro-srv disableable in x.py install\n\nRustdoc will build if `[build] tools = [\"rustdoc\"]` is set, and rust-analyzer-proc-macro-srv will build if `[build] tools = [\"rust-analyzer\"]` is set.\n\nOn my machine skipping these tools speeds up `x.py install` from 7m15s to 6m08s (0m43s for rustdoc and 0m24s for rust-analyzer-proc-macro-srv). This is a significant speedup, since I never use rust-analyzer-proc-macro-srv, and I practically never need to use a custom build of rustdoc.", "tree": {"sha": "90fe42dbf5335361238377a148c9b10285e91e79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/90fe42dbf5335361238377a148c9b10285e91e79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ae15d1094a1185e965a3de1672c5159546af9863", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjzmGnCRBK7hj4Ov3rIwAAuF4IAETa3O4jFlNuVQlcBA4pJtlX\ndLUqfStSg5lr5EJ0LefdmeDEZXVxHsPMEB62EYyr+spG3Gp/EHJ3jboTEb3vw5Gz\njnWUbBjA/IzpyoPtR2nWwZAYFBOXwAZKW2I1ApQspMwuNVBA1f84DmbqxuGcyduG\n6WJpetTwINwoEbJpadcx2LaNc7PcH8V1vHRCv+layEjafN7KWY8ruoFCCdOEtimh\nnh1QDc69xV/tLeUBd31RePXZLdsJy54a/153ybpO4AM3r58PL/ap/AL80aeffACA\nuLV7qPY+fpC/pN8spWvxCpJmwFzhX1Pi5sRJQ0AA2dh2mE+ZaZiab/0L/JW3u0Q=\n=r7zA\n-----END PGP SIGNATURE-----\n", "payload": "tree 90fe42dbf5335361238377a148c9b10285e91e79\nparent 9e79642a7b0578f69585fc59476b5269f6040c5a\nparent 11e002a001348e7ea035c0cb2665be806e2a832e\nauthor Yuki Okushi <jtitor@2k36.org> 1674469799 +0900\ncommitter GitHub <noreply@github.com> 1674469799 +0900\n\nRollup merge of #106886 - dtolnay:fastinstall, r=Mark-Simulacrum\n\nMake stage2 rustdoc and proc-macro-srv disableable in x.py install\n\nRustdoc will build if `[build] tools = [\"rustdoc\"]` is set, and rust-analyzer-proc-macro-srv will build if `[build] tools = [\"rust-analyzer\"]` is set.\n\nOn my machine skipping these tools speeds up `x.py install` from 7m15s to 6m08s (0m43s for rustdoc and 0m24s for rust-analyzer-proc-macro-srv). This is a significant speedup, since I never use rust-analyzer-proc-macro-srv, and I practically never need to use a custom build of rustdoc.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ae15d1094a1185e965a3de1672c5159546af9863", "html_url": "https://github.com/rust-lang/rust/commit/ae15d1094a1185e965a3de1672c5159546af9863", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ae15d1094a1185e965a3de1672c5159546af9863/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e79642a7b0578f69585fc59476b5269f6040c5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e79642a7b0578f69585fc59476b5269f6040c5a", "html_url": "https://github.com/rust-lang/rust/commit/9e79642a7b0578f69585fc59476b5269f6040c5a"}, {"sha": "11e002a001348e7ea035c0cb2665be806e2a832e", "url": "https://api.github.com/repos/rust-lang/rust/commits/11e002a001348e7ea035c0cb2665be806e2a832e", "html_url": "https://github.com/rust-lang/rust/commit/11e002a001348e7ea035c0cb2665be806e2a832e"}], "stats": {"total": 51, "additions": 40, "deletions": 11}, "files": [{"sha": "299bfd779e57a83461efc1167ae9de9e3d603ab8", "filename": "config.toml.example", "status": "modified", "additions": 18, "deletions": 5, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/ae15d1094a1185e965a3de1672c5159546af9863/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/ae15d1094a1185e965a3de1672c5159546af9863/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=ae15d1094a1185e965a3de1672c5159546af9863", "patch": "@@ -285,11 +285,24 @@ changelog-seen = 2\n # be built if `extended = true`.\n #extended = false\n \n-# Installs chosen set of extended tools if `extended = true`. By default builds\n-# all extended tools except `rust-demangler`, unless the target is also being\n-# built with `profiler = true`. If chosen tool failed to build the installation\n-# fails. If `extended = false`, this option is ignored.\n-#tools = [\"cargo\", \"rls\", \"clippy\", \"rustfmt\", \"analysis\", \"src\"] # + \"rust-demangler\" if `profiler`\n+# Set of tools to be included in the installation.\n+#\n+# If `extended = false`, the only one of these built by default is rustdoc.\n+#\n+# If `extended = true`, they're all included, with the exception of\n+# rust-demangler which additionally requires `profiler = true` to be set.\n+#\n+# If any enabled tool fails to build, the installation fails.\n+#tools = [\n+#    \"cargo\",\n+#    \"clippy\",\n+#    \"rustdoc\",\n+#    \"rustfmt\",\n+#    \"rust-analyzer\",\n+#    \"analysis\",\n+#    \"src\",\n+#    \"rust-demangler\",  # if profiler = true\n+#]\n \n # Verbosity level: 0 == not verbose, 1 == verbose, 2 == very verbose\n #verbose = 0"}, {"sha": "2d86ff1d2baeafff219b642ca5e5338bfd84cf01", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/ae15d1094a1185e965a3de1672c5159546af9863/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae15d1094a1185e965a3de1672c5159546af9863/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=ae15d1094a1185e965a3de1672c5159546af9863", "patch": "@@ -392,19 +392,29 @@ impl Step for Rustc {\n             t!(fs::create_dir_all(image.join(\"bin\")));\n             builder.cp_r(&src.join(\"bin\"), &image.join(\"bin\"));\n \n-            builder.install(&builder.rustdoc(compiler), &image.join(\"bin\"), 0o755);\n+            if builder\n+                .config\n+                .tools\n+                .as_ref()\n+                .map_or(true, |tools| tools.iter().any(|tool| tool == \"rustdoc\"))\n+            {\n+                let rustdoc = builder.rustdoc(compiler);\n+                builder.install(&rustdoc, &image.join(\"bin\"), 0o755);\n+            }\n \n-            let ra_proc_macro_srv = builder\n-                .ensure(tool::RustAnalyzerProcMacroSrv {\n+            if let Some(ra_proc_macro_srv) = builder.ensure_if_default(\n+                tool::RustAnalyzerProcMacroSrv {\n                     compiler: builder.compiler_for(\n                         compiler.stage,\n                         builder.config.build,\n                         compiler.host,\n                     ),\n                     target: compiler.host,\n-                })\n-                .expect(\"rust-analyzer-proc-macro-server always builds\");\n-            builder.install(&ra_proc_macro_srv, &image.join(\"libexec\"), 0o755);\n+                },\n+                builder.kind,\n+            ) {\n+                builder.install(&ra_proc_macro_srv, &image.join(\"libexec\"), 0o755);\n+            }\n \n             let libdir_relative = builder.libdir_relative(compiler);\n "}, {"sha": "ca5f500f93bc41deea9db9be5a6698f1154ab021", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ae15d1094a1185e965a3de1672c5159546af9863/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae15d1094a1185e965a3de1672c5159546af9863/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=ae15d1094a1185e965a3de1672c5159546af9863", "patch": "@@ -765,9 +765,15 @@ impl Step for RustAnalyzerProcMacroSrv {\n     const ONLY_HOSTS: bool = true;\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        let builder = run.builder;\n         // Allow building `rust-analyzer-proc-macro-srv` both as part of the `rust-analyzer` and as a stand-alone tool.\n         run.path(\"src/tools/rust-analyzer\")\n             .path(\"src/tools/rust-analyzer/crates/proc-macro-srv-cli\")\n+            .default_condition(builder.config.tools.as_ref().map_or(true, |tools| {\n+                tools\n+                    .iter()\n+                    .any(|tool| tool == \"rust-analyzer\" || tool == \"rust-analyzer-proc-macro-srv\")\n+            }))\n     }\n \n     fn make_run(run: RunConfig<'_>) {"}]}