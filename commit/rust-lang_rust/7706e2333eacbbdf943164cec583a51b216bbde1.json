{"sha": "7706e2333eacbbdf943164cec583a51b216bbde1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc3MDZlMjMzM2VhY2JiZGY5NDMxNjRjZWM1ODNhNTFiMjE2YmJkZTE=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2016-01-12T16:21:11Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2016-01-13T13:29:50Z"}, "message": "revise lifetime handling for alloca's that are initialized as \"dropped.\"\n\n(This can/should be revisited when drop flags are stored out of band.)", "tree": {"sha": "835aa0404306810a3a2996e834f1791a1682358b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/835aa0404306810a3a2996e834f1791a1682358b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7706e2333eacbbdf943164cec583a51b216bbde1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7706e2333eacbbdf943164cec583a51b216bbde1", "html_url": "https://github.com/rust-lang/rust/commit/7706e2333eacbbdf943164cec583a51b216bbde1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7706e2333eacbbdf943164cec583a51b216bbde1/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8168765d43937d1def40f13bcfe9be5748a180b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/8168765d43937d1def40f13bcfe9be5748a180b3", "html_url": "https://github.com/rust-lang/rust/commit/8168765d43937d1def40f13bcfe9be5748a180b3"}], "stats": {"total": 11, "additions": 10, "deletions": 1}, "files": [{"sha": "375b3e3f0d2d5bc3ac54c6a4e357ffcb58c69a39", "filename": "src/librustc_trans/trans/base.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7706e2333eacbbdf943164cec583a51b216bbde1/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7706e2333eacbbdf943164cec583a51b216bbde1/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fbase.rs?ref=7706e2333eacbbdf943164cec583a51b216bbde1", "patch": "@@ -1354,6 +1354,13 @@ pub fn alloca_dropped<'blk, 'tcx>(cx: Block<'blk, 'tcx>, ty: Ty<'tcx>, name: &st\n     let p = alloca(cx, llty, name);\n     let b = cx.fcx.ccx.builder();\n     b.position_before(cx.fcx.alloca_insert_pt.get().unwrap());\n+\n+    // This is just like `call_lifetime_start` (but latter expects a\n+    // Block, which we do not have for `alloca_insert_pt`).\n+    core_lifetime_emit(cx.ccx(), p, Lifetime::Start, |ccx, size, lifetime_start| {\n+        let ptr = b.pointercast(p, Type::i8p(ccx));\n+        b.call(lifetime_start, &[C_u64(ccx, size), ptr], None);\n+    });\n     memfill(&b, p, ty, adt::DTOR_DONE);\n     p\n }"}, {"sha": "32f263746d31e04158742f0abcf12395ad1d44c4", "filename": "src/librustc_trans/trans/datum.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7706e2333eacbbdf943164cec583a51b216bbde1/src%2Flibrustc_trans%2Ftrans%2Fdatum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7706e2333eacbbdf943164cec583a51b216bbde1/src%2Flibrustc_trans%2Ftrans%2Fdatum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fdatum.rs?ref=7706e2333eacbbdf943164cec583a51b216bbde1", "patch": "@@ -513,7 +513,9 @@ impl<'tcx> Datum<'tcx, Rvalue> {\n                     |this, bcx, llval| {\n                         debug!(\"populate call for Datum::to_lvalue_datum_in_scope \\\n                                 self.ty={:?}\", this.ty);\n-                        call_lifetime_start(bcx, llval);\n+                        // do not call_lifetime_start here; the\n+                        // `InitAlloc::Dropped` will start scratch\n+                        // value's lifetime at open of function body.\n                         let bcx = this.store_to(bcx, llval);\n                         bcx.fcx.schedule_lifetime_end(scope, llval);\n                         bcx"}]}