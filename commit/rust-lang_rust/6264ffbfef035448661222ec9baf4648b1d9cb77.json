{"sha": "6264ffbfef035448661222ec9baf4648b1d9cb77", "node_id": "C_kwDOAAsO6NoAKDYyNjRmZmJmZWYwMzU0NDg2NjEyMjJlYzliYWY0NjQ4YjFkOWNiNzc", "commit": {"author": {"name": "beetrees", "email": "b@beetr.ee", "date": "2022-06-21T19:10:31Z"}, "committer": {"name": "beetrees", "email": "b@beetr.ee", "date": "2022-06-21T19:10:31Z"}, "message": "Migrate `builtin-macros-requires-cfg-pattern` to `SessionDiagnostic`", "tree": {"sha": "ce06efb3afc659c4c2cb027a16c42e6bd13b39f1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ce06efb3afc659c4c2cb027a16c42e6bd13b39f1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6264ffbfef035448661222ec9baf4648b1d9cb77", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYKAB0WIQT9oej+Slbzs/bk2IuHkb11QZHr1gUCYrIXqAAKCRCHkb11QZHr\n1tsCAP92zpOa9Q6JbL4JpHAhh8pddxAeoWFgM403ZafExnbiGAEAqfSy4Em44LN7\nquP6GP61hjkvbFasv9MlNQieNq7iNw0=\n=vxl0\n-----END PGP SIGNATURE-----", "payload": "tree ce06efb3afc659c4c2cb027a16c42e6bd13b39f1\nparent d6072e53cd975839ad5e4c2d3ae101ce7ea0c3c0\nauthor beetrees <b@beetr.ee> 1655838631 +0100\ncommitter beetrees <b@beetr.ee> 1655838631 +0100\n\nMigrate `builtin-macros-requires-cfg-pattern` to `SessionDiagnostic`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6264ffbfef035448661222ec9baf4648b1d9cb77", "html_url": "https://github.com/rust-lang/rust/commit/6264ffbfef035448661222ec9baf4648b1d9cb77", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6264ffbfef035448661222ec9baf4648b1d9cb77/comments", "author": {"login": "beetrees", "id": 107947675, "node_id": "U_kgDOBm8mmw", "avatar_url": "https://avatars.githubusercontent.com/u/107947675?v=4", "gravatar_id": "", "url": "https://api.github.com/users/beetrees", "html_url": "https://github.com/beetrees", "followers_url": "https://api.github.com/users/beetrees/followers", "following_url": "https://api.github.com/users/beetrees/following{/other_user}", "gists_url": "https://api.github.com/users/beetrees/gists{/gist_id}", "starred_url": "https://api.github.com/users/beetrees/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/beetrees/subscriptions", "organizations_url": "https://api.github.com/users/beetrees/orgs", "repos_url": "https://api.github.com/users/beetrees/repos", "events_url": "https://api.github.com/users/beetrees/events{/privacy}", "received_events_url": "https://api.github.com/users/beetrees/received_events", "type": "User", "site_admin": false}, "committer": {"login": "beetrees", "id": 107947675, "node_id": "U_kgDOBm8mmw", "avatar_url": "https://avatars.githubusercontent.com/u/107947675?v=4", "gravatar_id": "", "url": "https://api.github.com/users/beetrees", "html_url": "https://github.com/beetrees", "followers_url": "https://api.github.com/users/beetrees/followers", "following_url": "https://api.github.com/users/beetrees/following{/other_user}", "gists_url": "https://api.github.com/users/beetrees/gists{/gist_id}", "starred_url": "https://api.github.com/users/beetrees/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/beetrees/subscriptions", "organizations_url": "https://api.github.com/users/beetrees/orgs", "repos_url": "https://api.github.com/users/beetrees/repos", "events_url": "https://api.github.com/users/beetrees/events{/privacy}", "received_events_url": "https://api.github.com/users/beetrees/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6072e53cd975839ad5e4c2d3ae101ce7ea0c3c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6072e53cd975839ad5e4c2d3ae101ce7ea0c3c0", "html_url": "https://github.com/rust-lang/rust/commit/d6072e53cd975839ad5e4c2d3ae101ce7ea0c3c0"}], "stats": {"total": 23, "additions": 18, "deletions": 5}, "files": [{"sha": "692474f2657b1a1be638b21415d18876268a5bd9", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6264ffbfef035448661222ec9baf4648b1d9cb77/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/6264ffbfef035448661222ec9baf4648b1d9cb77/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=6264ffbfef035448661222ec9baf4648b1d9cb77", "patch": "@@ -3669,6 +3669,7 @@ dependencies = [\n  \"rustc_feature\",\n  \"rustc_lexer\",\n  \"rustc_lint_defs\",\n+ \"rustc_macros\",\n  \"rustc_parse\",\n  \"rustc_parse_format\",\n  \"rustc_session\","}, {"sha": "7dc947f7d9a143fb1e72d6cdf9ae97814c7908ca", "filename": "compiler/rustc_builtin_macros/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_builtin_macros%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_builtin_macros%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2FCargo.toml?ref=6264ffbfef035448661222ec9baf4648b1d9cb77", "patch": "@@ -16,6 +16,7 @@ rustc_errors = { path = \"../rustc_errors\" }\n rustc_feature = { path = \"../rustc_feature\" }\n rustc_lexer = { path = \"../rustc_lexer\" }\n rustc_lint_defs = { path = \"../rustc_lint_defs\" }\n+rustc_macros = { path = \"../rustc_macros\" }\n rustc_parse = { path = \"../rustc_parse\" }\n rustc_target = { path = \"../rustc_target\" }\n rustc_session = { path = \"../rustc_session\" }"}, {"sha": "2a6adc216643f87b524dc47160074cc945bbf4d0", "filename": "compiler/rustc_builtin_macros/src/cfg.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_builtin_macros%2Fsrc%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_builtin_macros%2Fsrc%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fcfg.rs?ref=6264ffbfef035448661222ec9baf4648b1d9cb77", "patch": "@@ -8,6 +8,7 @@ use rustc_ast::tokenstream::TokenStream;\n use rustc_attr as attr;\n use rustc_errors::PResult;\n use rustc_expand::base::{self, *};\n+use rustc_macros::SessionDiagnostic;\n use rustc_span::Span;\n \n pub fn expand_cfg(\n@@ -34,21 +35,27 @@ pub fn expand_cfg(\n     }\n }\n \n-fn parse_cfg<'a>(cx: &mut ExtCtxt<'a>, sp: Span, tts: TokenStream) -> PResult<'a, ast::MetaItem> {\n+#[derive(SessionDiagnostic)]\n+#[error(slug = \"builtin-macros-requires-cfg-pattern\")]\n+struct RequiresCfgPattern {\n+    #[primary_span]\n+    #[label]\n+    span: Span,\n+}\n+\n+fn parse_cfg<'a>(cx: &mut ExtCtxt<'a>, span: Span, tts: TokenStream) -> PResult<'a, ast::MetaItem> {\n     let mut p = cx.new_parser_from_tts(tts);\n \n     if p.token == token::Eof {\n-        let mut err = cx.struct_span_err(sp, \"macro requires a cfg-pattern as an argument\");\n-        err.span_label(sp, \"cfg-pattern required\");\n-        return Err(err);\n+        return Err(cx.create_err(RequiresCfgPattern { span }));\n     }\n \n     let cfg = p.parse_meta_item()?;\n \n     let _ = p.eat(&token::Comma);\n \n     if !p.eat(&token::Eof) {\n-        return Err(cx.struct_span_err(sp, \"expected 1 cfg-pattern\"));\n+        return Err(cx.struct_span_err(span, \"expected 1 cfg-pattern\"));\n     }\n \n     Ok(cfg)"}, {"sha": "89cd9fe579d6b5a486e0b83e21e55f97c88900da", "filename": "compiler/rustc_error_messages/locales/en-US/builtin_macros.ftl", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fbuiltin_macros.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fbuiltin_macros.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fbuiltin_macros.ftl?ref=6264ffbfef035448661222ec9baf4648b1d9cb77", "patch": "@@ -0,0 +1,3 @@\n+builtin-macros-requires-cfg-pattern =\n+    macro requires a cfg-pattern as an argument\n+    .label = cfg-pattern required"}, {"sha": "7211c05432698207809919d940e152cddc9c6dac", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6264ffbfef035448661222ec9baf4648b1d9cb77/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=6264ffbfef035448661222ec9baf4648b1d9cb77", "patch": "@@ -33,6 +33,7 @@ pub use unic_langid::{langid, LanguageIdentifier};\n fluent_messages! {\n     parser => \"../locales/en-US/parser.ftl\",\n     typeck => \"../locales/en-US/typeck.ftl\",\n+    builtin_macros => \"../locales/en-US/builtin_macros.ftl\",\n }\n \n pub use fluent_generated::{self as fluent, DEFAULT_LOCALE_RESOURCES};"}]}