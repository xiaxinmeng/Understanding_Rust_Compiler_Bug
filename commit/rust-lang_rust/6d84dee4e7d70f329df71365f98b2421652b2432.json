{"sha": "6d84dee4e7d70f329df71365f98b2421652b2432", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkODRkZWU0ZTdkNzBmMzI5ZGY3MTM2NWY5OGIyNDIxNjUyYjI0MzI=", "commit": {"author": {"name": "Vincent Rouill\u00e9", "email": "vincent@speedy37.fr", "date": "2019-12-28T21:26:24Z"}, "committer": {"name": "Vincent Rouill\u00e9", "email": "vincent@speedy37.fr", "date": "2019-12-28T21:48:49Z"}, "message": "fix #2520: change expand_repeat loop stop condition", "tree": {"sha": "e3c58befd8d46c5f994126313ca7daf41b82dd69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e3c58befd8d46c5f994126313ca7daf41b82dd69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d84dee4e7d70f329df71365f98b2421652b2432", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZNskgiIpwnvIy0J//KUTNzQDuFEFAl4HzcYACgkQ/KUTNzQD\nuFHhSBAApsqAjholtta+Wb/nSqcCCUcYsVVklV3dE5aG2qBKNVmKyzP/erultllN\n3Mka62BMBbg+hNj9bGRdwY6CgrtlLpgPUlQBlVnxCdcaWmPDMale+UUzDuu85q1U\nxa1MXmjpLDsGcEDIWwHKvQWcxvz5b+nDzsPvGcgJqzTzJMY1U/hzWsK5JbrZpT+C\nflu4Nz/mZ4vZ/rvGcmI4pEDkO45oemBrJqiYA6phv3A1OnS7RonzEMB0Zec7jqx7\nLWkeu/s32eH7yJ3yle4gPLZMoWXa1HOZBaM3cvUPtRBprhz+XW00pyQhLMk7rgSd\ndZ5nVU7+xWW7Jset3+igF183g+4RFkzXcCXx+/NPD8l5jWu/yVpJhWtL2EADODNd\nSPTC3N9/zapfKMiWFzHMkgsyfRWi3XC5XA7i0oAcnnNPVGLE4h94Hg9AUV+fHol3\n2f8LTwvQiL6s0iuvVwfyM7ndfMCb3Tp2L3i/IfxN+5MNYuz46dzQb5rV9QkMKYLM\n5Qo8YTsZhGWxUla9kZEvud0nMBnZISIR/R4eKLZSBQP8Dj3GVov+hWr5Pdk079r/\n7djpoIth4PalU5SIi6vgqWn8dkzgf26Rc1NK3MiOGwSnul+gCEoT1G2MhQXKuxzC\n91rO/8kYxa3EGyrEqwEw3wueBg6Zh1gQQuWcq4g1ZCdD7GQq1os=\n=qP7z\n-----END PGP SIGNATURE-----", "payload": "tree e3c58befd8d46c5f994126313ca7daf41b82dd69\nparent c5a48bea1218afb63d7932a6816f34c810bbab6b\nauthor Vincent Rouill\u00e9 <vincent@speedy37.fr> 1577568384 +0100\ncommitter Vincent Rouill\u00e9 <vincent@speedy37.fr> 1577569729 +0100\n\nfix #2520: change expand_repeat loop stop condition\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d84dee4e7d70f329df71365f98b2421652b2432", "html_url": "https://github.com/rust-lang/rust/commit/6d84dee4e7d70f329df71365f98b2421652b2432", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d84dee4e7d70f329df71365f98b2421652b2432/comments", "author": {"login": "Speedy37", "id": 5376197, "node_id": "MDQ6VXNlcjUzNzYxOTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5376197?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Speedy37", "html_url": "https://github.com/Speedy37", "followers_url": "https://api.github.com/users/Speedy37/followers", "following_url": "https://api.github.com/users/Speedy37/following{/other_user}", "gists_url": "https://api.github.com/users/Speedy37/gists{/gist_id}", "starred_url": "https://api.github.com/users/Speedy37/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Speedy37/subscriptions", "organizations_url": "https://api.github.com/users/Speedy37/orgs", "repos_url": "https://api.github.com/users/Speedy37/repos", "events_url": "https://api.github.com/users/Speedy37/events{/privacy}", "received_events_url": "https://api.github.com/users/Speedy37/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Speedy37", "id": 5376197, "node_id": "MDQ6VXNlcjUzNzYxOTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5376197?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Speedy37", "html_url": "https://github.com/Speedy37", "followers_url": "https://api.github.com/users/Speedy37/followers", "following_url": "https://api.github.com/users/Speedy37/following{/other_user}", "gists_url": "https://api.github.com/users/Speedy37/gists{/gist_id}", "starred_url": "https://api.github.com/users/Speedy37/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Speedy37/subscriptions", "organizations_url": "https://api.github.com/users/Speedy37/orgs", "repos_url": "https://api.github.com/users/Speedy37/repos", "events_url": "https://api.github.com/users/Speedy37/events{/privacy}", "received_events_url": "https://api.github.com/users/Speedy37/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5a48bea1218afb63d7932a6816f34c810bbab6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5a48bea1218afb63d7932a6816f34c810bbab6b", "html_url": "https://github.com/rust-lang/rust/commit/c5a48bea1218afb63d7932a6816f34c810bbab6b"}], "stats": {"total": 113, "additions": 77, "deletions": 36}, "files": [{"sha": "8bb1a25a317444c832029a4d4ba13d22f239e092", "filename": "crates/ra_mbe/src/mbe_expander/transcriber.rs", "status": "modified", "additions": 31, "deletions": 36, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/6d84dee4e7d70f329df71365f98b2421652b2432/crates%2Fra_mbe%2Fsrc%2Fmbe_expander%2Ftranscriber.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d84dee4e7d70f329df71365f98b2421652b2432/crates%2Fra_mbe%2Fsrc%2Fmbe_expander%2Ftranscriber.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_mbe%2Fsrc%2Fmbe_expander%2Ftranscriber.rs?ref=6d84dee4e7d70f329df71365f98b2421652b2432", "patch": "@@ -14,21 +14,24 @@ impl Bindings {\n         self.inner.contains_key(name)\n     }\n \n-    fn get(&self, name: &str, nesting: &[usize]) -> Result<&Fragment, ExpandError> {\n+    fn get(&self, name: &str, nesting: &mut [NestingState]) -> Result<&Fragment, ExpandError> {\n         let mut b = self.inner.get(name).ok_or_else(|| {\n             ExpandError::BindingError(format!(\"could not find binding `{}`\", name))\n         })?;\n-        for &idx in nesting.iter() {\n+        for s in nesting.iter_mut() {\n+            s.hit = true;\n             b = match b {\n                 Binding::Fragment(_) => break,\n-                Binding::Nested(bs) => bs.get(idx).ok_or_else(|| {\n+                Binding::Nested(bs) => bs.get(s.idx).ok_or_else(|| {\n+                    s.at_end = true;\n                     ExpandError::BindingError(format!(\"could not find nested binding `{}`\", name))\n                 })?,\n                 Binding::Empty => {\n+                    s.at_end = true;\n                     return Err(ExpandError::BindingError(format!(\n                         \"could not find empty binding `{}`\",\n                         name\n-                    )))\n+                    )));\n                 }\n             };\n         }\n@@ -51,15 +54,21 @@ pub(super) fn transcribe(\n     bindings: &Bindings,\n ) -> Result<tt::Subtree, ExpandError> {\n     assert!(template.delimiter == None);\n-    let mut ctx = ExpandCtx { bindings: &bindings, nesting: Vec::new(), var_expanded: false };\n+    let mut ctx = ExpandCtx { bindings: &bindings, nesting: Vec::new() };\n     expand_subtree(&mut ctx, template)\n }\n \n+#[derive(Debug)]\n+struct NestingState {\n+    idx: usize,\n+    hit: bool,\n+    at_end: bool,\n+}\n+\n #[derive(Debug)]\n struct ExpandCtx<'a> {\n     bindings: &'a Bindings,\n-    nesting: Vec<usize>,\n-    var_expanded: bool,\n+    nesting: Vec<NestingState>,\n }\n \n fn expand_subtree(ctx: &mut ExpandCtx, template: &tt::Subtree) -> Result<tt::Subtree, ExpandError> {\n@@ -121,8 +130,7 @@ fn expand_var(ctx: &mut ExpandCtx, v: &SmolStr) -> Result<Fragment, ExpandError>\n         .into();\n         Fragment::Tokens(tt)\n     } else {\n-        let fragment = ctx.bindings.get(&v, &ctx.nesting)?.clone();\n-        ctx.var_expanded = true;\n+        let fragment = ctx.bindings.get(&v, &mut ctx.nesting)?.clone();\n         fragment\n     };\n     Ok(res)\n@@ -135,37 +143,24 @@ fn expand_repeat(\n     separator: Option<Separator>,\n ) -> Result<Fragment, ExpandError> {\n     let mut buf: Vec<tt::TokenTree> = Vec::new();\n-    ctx.nesting.push(0);\n+    ctx.nesting.push(NestingState { idx: 0, at_end: false, hit: false });\n     // Dirty hack to make macro-expansion terminate.\n     // This should be replaced by a propper macro-by-example implementation\n-    let mut limit = 65536;\n+    let limit = 65536;\n     let mut has_seps = 0;\n     let mut counter = 0;\n \n-    // We store the old var expanded value, and restore it later\n-    // It is because before this `$repeat`,\n-    // it is possible some variables already expanad in the same subtree\n-    //\n-    // `some_var_expanded` keep check if the deeper subtree has expanded variables\n-    let mut some_var_expanded = false;\n-    let old_var_expanded = ctx.var_expanded;\n-    ctx.var_expanded = false;\n-\n-    while let Ok(mut t) = expand_subtree(ctx, template) {\n-        t.delimiter = None;\n-        // if no var expanded in the child, we count it as a fail\n-        if !ctx.var_expanded {\n+    loop {\n+        let res = expand_subtree(ctx, template);\n+        let nesting_state = ctx.nesting.last_mut().unwrap();\n+        if nesting_state.at_end || !nesting_state.hit {\n             break;\n         }\n-\n-        // Reset `ctx.var_expandeded` to see if there is other expanded variable\n-        // in the next matching\n-        some_var_expanded = true;\n-        ctx.var_expanded = false;\n+        nesting_state.idx += 1;\n+        nesting_state.hit = false;\n \n         counter += 1;\n-        limit -= 1;\n-        if limit == 0 {\n+        if counter == limit {\n             log::warn!(\n                 \"expand_tt excced in repeat pattern exceed limit => {:#?}\\n{:#?}\",\n                 template,\n@@ -174,8 +169,11 @@ fn expand_repeat(\n             break;\n         }\n \n-        let idx = ctx.nesting.pop().unwrap();\n-        ctx.nesting.push(idx + 1);\n+        let mut t = match res {\n+            Ok(t) => t,\n+            Err(_) => continue,\n+        };\n+        t.delimiter = None;\n         push_subtree(&mut buf, t);\n \n         if let Some(ref sep) = separator {\n@@ -203,9 +201,6 @@ fn expand_repeat(\n         }\n     }\n \n-    // Restore the `var_expanded` by combining old one and the new one\n-    ctx.var_expanded = some_var_expanded || old_var_expanded;\n-\n     ctx.nesting.pop().unwrap();\n     for _ in 0..has_seps {\n         buf.pop();"}, {"sha": "288366ccacb73b87f21534a7f67557774cf00a75", "filename": "crates/ra_mbe/src/tests.rs", "status": "modified", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/6d84dee4e7d70f329df71365f98b2421652b2432/crates%2Fra_mbe%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d84dee4e7d70f329df71365f98b2421652b2432/crates%2Fra_mbe%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_mbe%2Fsrc%2Ftests.rs?ref=6d84dee4e7d70f329df71365f98b2421652b2432", "patch": "@@ -1491,3 +1491,49 @@ fn debug_dump_ignore_spaces(node: &ra_syntax::SyntaxNode) -> String {\n \n     buf\n }\n+\n+#[test]\n+fn test_issue_2520() {\n+    let macro_fixture = parse_macro(\n+        r#\"\n+        macro_rules! my_macro {\n+            {\n+                ( $(\n+                    $( [] $sname:ident : $stype:ty  )?\n+                    $( [$expr:expr] $nname:ident : $ntype:ty  )?\n+                ),* )\n+            } => {\n+                Test {\n+                    $(\n+                        $( $sname, )?\n+                    )*\n+                }\n+            };\n+        }\n+    \"#,\n+    );\n+\n+    macro_fixture.assert_expand_items(\n+        r#\"my_macro ! {\n+            ([] p1 : u32 , [|_| S0K0] s : S0K0 , [] k0 : i32)\n+        }\"#,\n+        \"Test {p1 , k0 ,}\",\n+    );\n+}\n+\n+#[test]\n+fn test_repeat_bad_var() {\n+    parse_macro(\n+        r#\"\n+        macro_rules! foo {\n+            ($( $b:ident )+) => {\n+                $( $c )+\n+            };\n+            ($( $b:ident )+) => {\n+                $( $b )+\n+            }\n+        }\n+    \"#,\n+    )\n+    .assert_expand_items(\"foo!(b0 b1);\", \"b0 b1\");\n+}"}]}