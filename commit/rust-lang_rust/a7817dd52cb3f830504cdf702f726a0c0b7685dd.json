{"sha": "a7817dd52cb3f830504cdf702f726a0c0b7685dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3ODE3ZGQ1MmNiM2Y4MzA1MDRjZGY3MDJmNzI2YTBjMGI3Njg1ZGQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-09-15T04:28:55Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-09-15T04:28:55Z"}, "message": "rustc: Preallocate when building the dep graph\n\nThis commit alters the `query` function in the dep graph module to preallocate\nmemory using `with_capacity` instead of relying on automatic growth. Discovered\nin #44576 it was found that for the syntex_syntax clean incremental benchmark\nthe peak memory usage was found when the dep graph was being saved, particularly\nthe `DepGraphQuery` data structure itself. PRs like #44142 which add more\nqueries end up just making this much larger!\n\nI didn't see an immediately obvious way to reduce the size of the\n`DepGraphQuery` object, but it turns out that `with_capacity` helps quite a bit!\nLocally 831 MB was used [before] this commit, and 770 MB is in use at the peak\nof the compiler [after] this commit. That's a nice 7.5% improvement! This won't\nquite make up for the losses in #44142 but I figured it's a good start.\n\n[before]: https://gist.github.com/alexcrichton/2d2b9c7a65503761925c5a0bcfeb0d1e\n[before]: https://gist.github.com/alexcrichton/6da51f2a6184bfb81694cc44f06deb5b", "tree": {"sha": "55abbdf81dbcf984b493e747e6393027c0fd59ff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55abbdf81dbcf984b493e747e6393027c0fd59ff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7817dd52cb3f830504cdf702f726a0c0b7685dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7817dd52cb3f830504cdf702f726a0c0b7685dd", "html_url": "https://github.com/rust-lang/rust/commit/a7817dd52cb3f830504cdf702f726a0c0b7685dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7817dd52cb3f830504cdf702f726a0c0b7685dd/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d288a5ae5e2e72b1c40611db80f94bbec75639b", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d288a5ae5e2e72b1c40611db80f94bbec75639b", "html_url": "https://github.com/rust-lang/rust/commit/2d288a5ae5e2e72b1c40611db80f94bbec75639b"}], "stats": {"total": 19, "additions": 16, "deletions": 3}, "files": [{"sha": "ea83a4f8b3104dd2de1113fa6eba381d1d043444", "filename": "src/librustc/dep_graph/query.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a7817dd52cb3f830504cdf702f726a0c0b7685dd/src%2Flibrustc%2Fdep_graph%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7817dd52cb3f830504cdf702f726a0c0b7685dd/src%2Flibrustc%2Fdep_graph%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fquery.rs?ref=a7817dd52cb3f830504cdf702f726a0c0b7685dd", "patch": "@@ -22,11 +22,10 @@ impl DepGraphQuery {\n     pub fn new(nodes: &[DepNode],\n                edges: &[(DepNode, DepNode)])\n                -> DepGraphQuery {\n-        let mut graph = Graph::new();\n+        let mut graph = Graph::with_capacity(nodes.len(), edges.len());\n         let mut indices = FxHashMap();\n         for node in nodes {\n-            indices.insert(node.clone(), graph.next_node_index());\n-            graph.add_node(node.clone());\n+            indices.insert(node.clone(), graph.add_node(node.clone()));\n         }\n \n         for &(ref source, ref target) in edges {"}, {"sha": "474622f3669131a0c54623a53376a8e942f3d864", "filename": "src/librustc_data_structures/graph/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a7817dd52cb3f830504cdf702f726a0c0b7685dd/src%2Flibrustc_data_structures%2Fgraph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7817dd52cb3f830504cdf702f726a0c0b7685dd/src%2Flibrustc_data_structures%2Fgraph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fgraph%2Fmod.rs?ref=a7817dd52cb3f830504cdf702f726a0c0b7685dd", "patch": "@@ -114,6 +114,13 @@ impl<N: Debug, E: Debug> Graph<N, E> {\n         }\n     }\n \n+    pub fn with_capacity(nodes: usize, edges: usize) -> Graph<N, E> {\n+        Graph {\n+            nodes: SnapshotVec::with_capacity(nodes),\n+            edges: SnapshotVec::with_capacity(edges),\n+        }\n+    }\n+\n     // # Simple accessors\n \n     #[inline]"}, {"sha": "2da91918288bab77ff8266086a662ea150fc4aad", "filename": "src/librustc_data_structures/snapshot_vec.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a7817dd52cb3f830504cdf702f726a0c0b7685dd/src%2Flibrustc_data_structures%2Fsnapshot_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7817dd52cb3f830504cdf702f726a0c0b7685dd/src%2Flibrustc_data_structures%2Fsnapshot_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fsnapshot_vec.rs?ref=a7817dd52cb3f830504cdf702f726a0c0b7685dd", "patch": "@@ -66,6 +66,13 @@ impl<D: SnapshotVecDelegate> SnapshotVec<D> {\n         }\n     }\n \n+    pub fn with_capacity(n: usize) -> SnapshotVec<D> {\n+        SnapshotVec {\n+            values: Vec::with_capacity(n),\n+            undo_log: Vec::new(),\n+        }\n+    }\n+\n     fn in_snapshot(&self) -> bool {\n         !self.undo_log.is_empty()\n     }"}]}