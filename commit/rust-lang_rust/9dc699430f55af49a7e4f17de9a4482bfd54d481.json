{"sha": "9dc699430f55af49a7e4f17de9a4482bfd54d481", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlkYzY5OTQzMGY1NWFmNDlhN2U0ZjE3ZGU5YTQ0ODJiZmQ1NGQ0ODE=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-03-20T08:02:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-20T08:02:05Z"}, "message": "Rollup merge of #69935 - davidtwco:issue-69925, r=eddyb\n\ncodegen/mir: support polymorphic `InstanceDef`s\n\ncc #69925\n\nThis PR modifies the use of `subst_and_normalize_erasing_regions` on parts of the MIR bodies returned from `instance_mir`, so that `InstanceDef::CloneShim` and `InstanceDef::DropGlue` (where there is a type) do not perform substitutions. This avoids double substitutions and enables polymorphic `InstanceDef`s.\n\nr? @eddyb\ncc @nikomatsakis", "tree": {"sha": "e38d50b0c02be2668d6cbfe23a212f375564d01d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e38d50b0c02be2668d6cbfe23a212f375564d01d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9dc699430f55af49a7e4f17de9a4482bfd54d481", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJedHh9CRBK7hj4Ov3rIwAAdHIIAJ3j+Gt5nETWp9M0nO3v0LXf\nuoDgQPLZ1cru6lhxg9aJgCyFFX5fcoRoEhkFh1lBiw0D62ss1+75sQ5g879/ZlaW\nSmugajTVVzQmq+ZW2XZV7jpjarA55NS2okftCtVBDlXVzydFi5X5Fi4DTI9ug+oR\nHZjf+ogQu+OIyGW9A/D9VipVWVU6qJ5PKBChePXqtUmvNGFQb9NRGyAzeBJSDq88\nAMBvo3Thf5Ijroakgaosq00dBHuLl7vkFoGBbxM3ezwIg7rAvI7ZKdTrqOqdt1pM\nHxGW058xLz1vX6Vdt4zLFidnz9t4RegMCK1Dpa/OpSdT7AKaIxE/ceOKJhD6DP8=\n=55TF\n-----END PGP SIGNATURE-----\n", "payload": "tree e38d50b0c02be2668d6cbfe23a212f375564d01d\nparent 3554f2d9411b0924fea8c78dfa82060b9500f261\nparent bee151308d5c5090627772c04e17f783aa53451a\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1584691325 +0900\ncommitter GitHub <noreply@github.com> 1584691325 +0900\n\nRollup merge of #69935 - davidtwco:issue-69925, r=eddyb\n\ncodegen/mir: support polymorphic `InstanceDef`s\n\ncc #69925\n\nThis PR modifies the use of `subst_and_normalize_erasing_regions` on parts of the MIR bodies returned from `instance_mir`, so that `InstanceDef::CloneShim` and `InstanceDef::DropGlue` (where there is a type) do not perform substitutions. This avoids double substitutions and enables polymorphic `InstanceDef`s.\n\nr? @eddyb\ncc @nikomatsakis\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9dc699430f55af49a7e4f17de9a4482bfd54d481", "html_url": "https://github.com/rust-lang/rust/commit/9dc699430f55af49a7e4f17de9a4482bfd54d481", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9dc699430f55af49a7e4f17de9a4482bfd54d481/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3554f2d9411b0924fea8c78dfa82060b9500f261", "url": "https://api.github.com/repos/rust-lang/rust/commits/3554f2d9411b0924fea8c78dfa82060b9500f261", "html_url": "https://github.com/rust-lang/rust/commit/3554f2d9411b0924fea8c78dfa82060b9500f261"}, {"sha": "bee151308d5c5090627772c04e17f783aa53451a", "url": "https://api.github.com/repos/rust-lang/rust/commits/bee151308d5c5090627772c04e17f783aa53451a", "html_url": "https://github.com/rust-lang/rust/commit/bee151308d5c5090627772c04e17f783aa53451a"}], "stats": {"total": 185, "additions": 102, "deletions": 83}, "files": [{"sha": "13d58ea73ac6b9074b8d93b09301d67479997e36", "filename": "src/librustc/ty/instance.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Finstance.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -381,6 +381,32 @@ impl<'tcx> Instance<'tcx> {\n         Instance { def, substs }\n     }\n \n+    /// FIXME(#69925) Depending on the kind of `InstanceDef`, the MIR body associated with an\n+    /// instance is expressed in terms of the generic parameters of `self.def_id()`, and in other\n+    /// cases the MIR body is expressed in terms of the types found in the substitution array.\n+    /// In the former case, we want to substitute those generic types and replace them with the\n+    /// values from the substs when monomorphizing the function body. But in the latter case, we\n+    /// don't want to do that substitution, since it has already been done effectively.\n+    ///\n+    /// This function returns `Some(substs)` in the former case and None otherwise -- i.e., if\n+    /// this function returns `None`, then the MIR body does not require substitution during\n+    /// monomorphization.\n+    pub fn substs_for_mir_body(&self) -> Option<SubstsRef<'tcx>> {\n+        match self.def {\n+            InstanceDef::CloneShim(..)\n+            | InstanceDef::DropGlue(_, Some(_)) => None,\n+            InstanceDef::ClosureOnceShim { .. }\n+            | InstanceDef::DropGlue(..)\n+            // FIXME(#69925): `FnPtrShim` should be in the other branch.\n+            | InstanceDef::FnPtrShim(..)\n+            | InstanceDef::Item(_)\n+            | InstanceDef::Intrinsic(..)\n+            | InstanceDef::ReifyShim(..)\n+            | InstanceDef::Virtual(..)\n+            | InstanceDef::VtableShim(..) => Some(self.substs),\n+        }\n+    }\n+\n     pub fn is_vtable_shim(&self) -> bool {\n         if let InstanceDef::VtableShim(..) = self.def { true } else { false }\n     }"}, {"sha": "000db0155ada38b05667e5a396abf7b1995ebd4d", "filename": "src/librustc_codegen_ssa/mir/mod.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -86,13 +86,18 @@ pub struct FunctionCx<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> {\n impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n     pub fn monomorphize<T>(&self, value: &T) -> T\n     where\n-        T: TypeFoldable<'tcx>,\n+        T: Copy + TypeFoldable<'tcx>,\n     {\n-        self.cx.tcx().subst_and_normalize_erasing_regions(\n-            self.instance.substs,\n-            ty::ParamEnv::reveal_all(),\n-            value,\n-        )\n+        debug!(\"monomorphize: self.instance={:?}\", self.instance);\n+        if let Some(substs) = self.instance.substs_for_mir_body() {\n+            self.cx.tcx().subst_and_normalize_erasing_regions(\n+                substs,\n+                ty::ParamEnv::reveal_all(),\n+                &value,\n+            )\n+        } else {\n+            self.cx.tcx().normalize_erasing_regions(ty::ParamEnv::reveal_all(), *value)\n+        }\n     }\n }\n "}, {"sha": "68a893dc4be5d7f8748ff8e7b5e5dc05eee66903", "filename": "src/librustc_mir/interpret/eval_context.rs", "status": "modified", "additions": 17, "deletions": 10, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -335,15 +335,25 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n \n     /// Call this on things you got out of the MIR (so it is as generic as the current\n     /// stack frame), to bring it into the proper environment for this interpreter.\n+    pub(super) fn subst_from_current_frame_and_normalize_erasing_regions<T: TypeFoldable<'tcx>>(\n+        &self,\n+        value: T,\n+    ) -> T {\n+        self.subst_from_frame_and_normalize_erasing_regions(self.frame(), value)\n+    }\n+\n+    /// Call this on things you got out of the MIR (so it is as generic as the provided\n+    /// stack frame), to bring it into the proper environment for this interpreter.\n     pub(super) fn subst_from_frame_and_normalize_erasing_regions<T: TypeFoldable<'tcx>>(\n         &self,\n+        frame: &Frame<'mir, 'tcx, M::PointerTag, M::FrameExtra>,\n         value: T,\n     ) -> T {\n-        self.tcx.subst_and_normalize_erasing_regions(\n-            self.frame().instance.substs,\n-            self.param_env,\n-            &value,\n-        )\n+        if let Some(substs) = frame.instance.substs_for_mir_body() {\n+            self.tcx.subst_and_normalize_erasing_regions(substs, self.param_env, &value)\n+        } else {\n+            self.tcx.normalize_erasing_regions(self.param_env, value)\n+        }\n     }\n \n     /// The `substs` are assumed to already be in our interpreter \"universe\" (param_env).\n@@ -371,11 +381,8 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n             None => {\n                 let layout = crate::interpret::operand::from_known_layout(layout, || {\n                     let local_ty = frame.body.local_decls[local].ty;\n-                    let local_ty = self.tcx.subst_and_normalize_erasing_regions(\n-                        frame.instance.substs,\n-                        self.param_env,\n-                        &local_ty,\n-                    );\n+                    let local_ty =\n+                        self.subst_from_frame_and_normalize_erasing_regions(frame, local_ty);\n                     self.layout_of(local_ty)\n                 })?;\n                 if let Some(state) = frame.locals.get(local) {"}, {"sha": "b39058405f5cbf2094b483324afd4e4938291afc", "filename": "src/librustc_mir/interpret/operand.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Foperand.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -490,7 +490,8 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n             Copy(ref place) | Move(ref place) => self.eval_place_to_op(place, layout)?,\n \n             Constant(ref constant) => {\n-                let val = self.subst_from_frame_and_normalize_erasing_regions(constant.literal);\n+                let val =\n+                    self.subst_from_current_frame_and_normalize_erasing_regions(constant.literal);\n                 self.eval_const_to_op(val, layout)?\n             }\n         };"}, {"sha": "5313446c253c848e2864011b352cbfa180c238e4", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -640,9 +640,11 @@ where\n                         // bail out.\n                         None => Place::null(&*self),\n                     },\n-                    layout: self.layout_of(self.subst_from_frame_and_normalize_erasing_regions(\n-                        self.frame().body.return_ty(),\n-                    ))?,\n+                    layout: self.layout_of(\n+                        self.subst_from_current_frame_and_normalize_erasing_regions(\n+                            self.frame().body.return_ty(),\n+                        ),\n+                    )?,\n                 }\n             }\n             local => PlaceTy {"}, {"sha": "cb11df18378d991fc4bb99157e94d9b21298f542", "filename": "src/librustc_mir/interpret/step.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Finterpret%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fstep.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -248,7 +248,7 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n             }\n \n             NullaryOp(mir::NullOp::SizeOf, ty) => {\n-                let ty = self.subst_from_frame_and_normalize_erasing_regions(ty);\n+                let ty = self.subst_from_current_frame_and_normalize_erasing_regions(ty);\n                 let layout = self.layout_of(ty)?;\n                 assert!(\n                     !layout.is_unsized(),"}, {"sha": "4dd037d93ce9b9c727013d84a35a25690c165668", "filename": "src/librustc_mir/monomorphize/collector.rs", "status": "modified", "additions": 40, "deletions": 62, "changes": 102, "blob_url": "https://github.com/rust-lang/rust/blob/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc699430f55af49a7e4f17de9a4482bfd54d481/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs?ref=9dc699430f55af49a7e4f17de9a4482bfd54d481", "patch": "@@ -185,7 +185,7 @@ use rustc::mir::visit::Visitor as MirVisitor;\n use rustc::mir::{self, Local, Location};\n use rustc::ty::adjustment::{CustomCoerceUnsized, PointerCast};\n use rustc::ty::print::obsolete::DefPathBasedNames;\n-use rustc::ty::subst::{InternalSubsts, SubstsRef};\n+use rustc::ty::subst::InternalSubsts;\n use rustc::ty::{self, GenericParamDefKind, Instance, Ty, TyCtxt, TypeFoldable};\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_data_structures::sync::{par_iter, MTLock, MTRef, ParallelIterator};\n@@ -493,7 +493,21 @@ struct MirNeighborCollector<'a, 'tcx> {\n     tcx: TyCtxt<'tcx>,\n     body: &'a mir::Body<'tcx>,\n     output: &'a mut Vec<MonoItem<'tcx>>,\n-    param_substs: SubstsRef<'tcx>,\n+    instance: Instance<'tcx>,\n+}\n+\n+impl<'a, 'tcx> MirNeighborCollector<'a, 'tcx> {\n+    pub fn monomorphize<T>(&self, value: T) -> T\n+    where\n+        T: TypeFoldable<'tcx>,\n+    {\n+        debug!(\"monomorphize: self.instance={:?}\", self.instance);\n+        if let Some(substs) = self.instance.substs_for_mir_body() {\n+            self.tcx.subst_and_normalize_erasing_regions(substs, ty::ParamEnv::reveal_all(), &value)\n+        } else {\n+            self.tcx.normalize_erasing_regions(ty::ParamEnv::reveal_all(), value)\n+        }\n+    }\n }\n \n impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n@@ -509,17 +523,9 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                 ref operand,\n                 target_ty,\n             ) => {\n-                let target_ty = self.tcx.subst_and_normalize_erasing_regions(\n-                    self.param_substs,\n-                    ty::ParamEnv::reveal_all(),\n-                    &target_ty,\n-                );\n+                let target_ty = self.monomorphize(target_ty);\n                 let source_ty = operand.ty(self.body, self.tcx);\n-                let source_ty = self.tcx.subst_and_normalize_erasing_regions(\n-                    self.param_substs,\n-                    ty::ParamEnv::reveal_all(),\n-                    &source_ty,\n-                );\n+                let source_ty = self.monomorphize(source_ty);\n                 let (source_ty, target_ty) =\n                     find_vtable_types_for_unsizing(self.tcx, source_ty, target_ty);\n                 // This could also be a different Unsize instruction, like\n@@ -540,11 +546,7 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                 _,\n             ) => {\n                 let fn_ty = operand.ty(self.body, self.tcx);\n-                let fn_ty = self.tcx.subst_and_normalize_erasing_regions(\n-                    self.param_substs,\n-                    ty::ParamEnv::reveal_all(),\n-                    &fn_ty,\n-                );\n+                let fn_ty = self.monomorphize(fn_ty);\n                 visit_fn_use(self.tcx, fn_ty, false, &mut self.output);\n             }\n             mir::Rvalue::Cast(\n@@ -553,11 +555,7 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                 _,\n             ) => {\n                 let source_ty = operand.ty(self.body, self.tcx);\n-                let source_ty = self.tcx.subst_and_normalize_erasing_regions(\n-                    self.param_substs,\n-                    ty::ParamEnv::reveal_all(),\n-                    &source_ty,\n-                );\n+                let source_ty = self.monomorphize(source_ty);\n                 match source_ty.kind {\n                     ty::Closure(def_id, substs) => {\n                         let instance = Instance::resolve_closure(\n@@ -593,7 +591,23 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n     fn visit_const(&mut self, constant: &&'tcx ty::Const<'tcx>, location: Location) {\n         debug!(\"visiting const {:?} @ {:?}\", *constant, location);\n \n-        collect_const(self.tcx, *constant, self.param_substs, self.output);\n+        let substituted_constant = self.monomorphize(*constant);\n+        let param_env = ty::ParamEnv::reveal_all();\n+\n+        match substituted_constant.val {\n+            ty::ConstKind::Value(val) => collect_const_value(self.tcx, val, self.output),\n+            ty::ConstKind::Unevaluated(def_id, substs, promoted) => {\n+                match self.tcx.const_eval_resolve(param_env, def_id, substs, promoted, None) {\n+                    Ok(val) => collect_const_value(self.tcx, val, self.output),\n+                    Err(ErrorHandled::Reported) => {}\n+                    Err(ErrorHandled::TooGeneric) => span_bug!(\n+                        self.tcx.def_span(def_id),\n+                        \"collection encountered polymorphic constant\",\n+                    ),\n+                }\n+            }\n+            _ => {}\n+        }\n \n         self.super_const(constant);\n     }\n@@ -605,21 +619,13 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n         match *kind {\n             mir::TerminatorKind::Call { ref func, .. } => {\n                 let callee_ty = func.ty(self.body, tcx);\n-                let callee_ty = tcx.subst_and_normalize_erasing_regions(\n-                    self.param_substs,\n-                    ty::ParamEnv::reveal_all(),\n-                    &callee_ty,\n-                );\n+                let callee_ty = self.monomorphize(callee_ty);\n                 visit_fn_use(self.tcx, callee_ty, true, &mut self.output);\n             }\n             mir::TerminatorKind::Drop { ref location, .. }\n             | mir::TerminatorKind::DropAndReplace { ref location, .. } => {\n                 let ty = location.ty(self.body, self.tcx).ty;\n-                let ty = tcx.subst_and_normalize_erasing_regions(\n-                    self.param_substs,\n-                    ty::ParamEnv::reveal_all(),\n-                    &ty,\n-                );\n+                let ty = self.monomorphize(ty);\n                 visit_drop_use(self.tcx, ty, true, self.output);\n             }\n             mir::TerminatorKind::Goto { .. }\n@@ -1156,8 +1162,7 @@ fn collect_neighbours<'tcx>(\n     debug!(\"collect_neighbours: {:?}\", instance.def_id());\n     let body = tcx.instance_mir(instance.def);\n \n-    MirNeighborCollector { tcx, body: &body, output, param_substs: instance.substs }\n-        .visit_body(body);\n+    MirNeighborCollector { tcx, body: &body, output, instance }.visit_body(body);\n }\n \n fn def_id_to_string(tcx: TyCtxt<'_>, def_id: DefId) -> String {\n@@ -1167,33 +1172,6 @@ fn def_id_to_string(tcx: TyCtxt<'_>, def_id: DefId) -> String {\n     output\n }\n \n-fn collect_const<'tcx>(\n-    tcx: TyCtxt<'tcx>,\n-    constant: &'tcx ty::Const<'tcx>,\n-    param_substs: SubstsRef<'tcx>,\n-    output: &mut Vec<MonoItem<'tcx>>,\n-) {\n-    debug!(\"visiting const {:?}\", constant);\n-\n-    let param_env = ty::ParamEnv::reveal_all();\n-    let substituted_constant =\n-        tcx.subst_and_normalize_erasing_regions(param_substs, param_env, &constant);\n-\n-    match substituted_constant.val {\n-        ty::ConstKind::Value(val) => collect_const_value(tcx, val, output),\n-        ty::ConstKind::Unevaluated(def_id, substs, promoted) => {\n-            match tcx.const_eval_resolve(param_env, def_id, substs, promoted, None) {\n-                Ok(val) => collect_const_value(tcx, val, output),\n-                Err(ErrorHandled::Reported) => {}\n-                Err(ErrorHandled::TooGeneric) => {\n-                    span_bug!(tcx.def_span(def_id), \"collection encountered polymorphic constant\",)\n-                }\n-            }\n-        }\n-        _ => {}\n-    }\n-}\n-\n fn collect_const_value<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     value: ConstValue<'tcx>,"}]}