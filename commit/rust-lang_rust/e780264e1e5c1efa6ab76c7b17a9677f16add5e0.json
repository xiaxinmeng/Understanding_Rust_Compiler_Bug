{"sha": "e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "node_id": "C_kwDOAAsO6NoAKGU3ODAyNjRlMWU1YzFlZmE2YWI3NmM3YjE3YTk2NzdmMTZhZGQ1ZTA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-24T04:07:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-24T04:07:48Z"}, "message": "Auto merge of #94107 - tmiasko:fewer-types, r=davidtwco\n\nReapply cg_llvm: `fewer_names` in `uncached_llvm_type`\n\nr? `@davidtwco` `@erikdesjardins`", "tree": {"sha": "c0ad8347fc2a4e2fd54ed6510123a64d568f1cca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c0ad8347fc2a4e2fd54ed6510123a64d568f1cca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "html_url": "https://github.com/rust-lang/rust/commit/e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e780264e1e5c1efa6ab76c7b17a9677f16add5e0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ebec97e09a89760e5791bbb2ab96e2ebec19931", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ebec97e09a89760e5791bbb2ab96e2ebec19931", "html_url": "https://github.com/rust-lang/rust/commit/8ebec97e09a89760e5791bbb2ab96e2ebec19931"}, {"sha": "4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "html_url": "https://github.com/rust-lang/rust/commit/4e41a46f6a6894ecb4b9d968a33f73a8e321587a"}], "stats": {"total": 11, "additions": 10, "deletions": 1}, "files": [{"sha": "da378dc649352603f54d38a390d44ee1c076f9d6", "filename": "compiler/rustc_codegen_llvm/src/type_of.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e780264e1e5c1efa6ab76c7b17a9677f16add5e0/compiler%2Frustc_codegen_llvm%2Fsrc%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e780264e1e5c1efa6ab76c7b17a9677f16add5e0/compiler%2Frustc_codegen_llvm%2Fsrc%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Ftype_of.rs?ref=e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "patch": "@@ -1,5 +1,6 @@\n use crate::common::*;\n use crate::context::TypeLowering;\n+use crate::llvm_util::get_version;\n use crate::type_::Type;\n use rustc_codegen_ssa::traits::*;\n use rustc_middle::bug;\n@@ -42,7 +43,12 @@ fn uncached_llvm_type<'a, 'tcx>(\n         // FIXME(eddyb) producing readable type names for trait objects can result\n         // in problematically distinct types due to HRTB and subtyping (see #47638).\n         // ty::Dynamic(..) |\n-        ty::Adt(..) | ty::Closure(..) | ty::Foreign(..) | ty::Generator(..) | ty::Str => {\n+        ty::Adt(..) | ty::Closure(..) | ty::Foreign(..) | ty::Generator(..) | ty::Str\n+            // For performance reasons we use names only when emitting LLVM IR. Unless we are on\n+            // LLVM < 14, where the use of unnamed types resulted in various issues, e.g., #76213,\n+            // #79564, and #79246.\n+            if get_version() < (14, 0, 0) || !cx.sess().fewer_names() =>\n+        {\n             let mut name = with_no_visible_paths!(with_no_trimmed_paths!(layout.ty.to_string()));\n             if let (&ty::Adt(def, _), &Variants::Single { index }) =\n                 (layout.ty.kind(), &layout.variants)\n@@ -58,6 +64,9 @@ fn uncached_llvm_type<'a, 'tcx>(\n             }\n             Some(name)\n         }\n+        // Use identified structure types for ADT. Due to pointee types in LLVM IR their definition\n+        // might be recursive. Other cases are non-recursive and we can use literal structure types.\n+        ty::Adt(..) => Some(String::new()),\n         _ => None,\n     };\n "}]}