{"sha": "fe999e88edd2254124be6419607bd29156841f59", "node_id": "C_kwDOAAsO6NoAKGZlOTk5ZTg4ZWRkMjI1NDEyNGJlNjQxOTYwN2JkMjkxNTY4NDFmNTk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-01T10:04:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-01T10:04:19Z"}, "message": "Auto merge of #7741 - surechen:fix_if_then_panic, r=flip1995\n\nMake if_then_panic handle situation of BinOpKind::And || BinOpKind::Or\n\nfixes #7731\n\nMake if_then_panic handle situation of cond.kind = ExprKind::DropTemps(ExprKind::Binary(BinOpKind::And || BinOpKind::Or, left, right), ..) =\n\nchangelog: [`if_then_panic`] Fix suggestion for more complex conditions", "tree": {"sha": "7cd32c89cfc861602d3e6c07b562b1c87a557893", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7cd32c89cfc861602d3e6c07b562b1c87a557893"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe999e88edd2254124be6419607bd29156841f59", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe999e88edd2254124be6419607bd29156841f59", "html_url": "https://github.com/rust-lang/rust/commit/fe999e88edd2254124be6419607bd29156841f59", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe999e88edd2254124be6419607bd29156841f59/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f8303ada90e1a314cf37875f8285d3d174553c33", "url": "https://api.github.com/repos/rust-lang/rust/commits/f8303ada90e1a314cf37875f8285d3d174553c33", "html_url": "https://github.com/rust-lang/rust/commit/f8303ada90e1a314cf37875f8285d3d174553c33"}, {"sha": "41e2c68a6e3e6d06c6e3549ae4e79f145fb4ba1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/41e2c68a6e3e6d06c6e3549ae4e79f145fb4ba1b", "html_url": "https://github.com/rust-lang/rust/commit/41e2c68a6e3e6d06c6e3549ae4e79f145fb4ba1b"}], "stats": {"total": 78, "additions": 71, "deletions": 7}, "files": [{"sha": "10bca59e6d06ab5da76ebe19bbba10020f50f9a8", "filename": "clippy_lints/src/if_then_panic.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fe999e88edd2254124be6419607bd29156841f59/clippy_lints%2Fsrc%2Fif_then_panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe999e88edd2254124be6419607bd29156841f59/clippy_lints%2Fsrc%2Fif_then_panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fif_then_panic.rs?ref=fe999e88edd2254124be6419607bd29156841f59", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::higher::PanicExpn;\n-use clippy_utils::is_expn_of;\n use clippy_utils::source::snippet_with_applicability;\n+use clippy_utils::{is_expn_of, sugg};\n use rustc_errors::Applicability;\n use rustc_hir::{Block, Expr, ExprKind, StmtKind, UnOp};\n use rustc_lint::{LateContext, LateLintPass};\n@@ -74,12 +74,14 @@ impl LateLintPass<'_> for IfThenPanic {\n                 };\n                 let mut applicability = Applicability::MachineApplicable;\n                 let sugg = snippet_with_applicability(cx, span, \"..\", &mut applicability);\n-\n-                let cond_sugg =\n-                if let ExprKind::DropTemps(Expr{kind: ExprKind::Unary(UnOp::Not, not_expr), ..}) = cond.kind {\n-                    snippet_with_applicability(cx, not_expr.span, \"..\", &mut applicability).to_string()\n+                let cond_sugg = if let ExprKind::DropTemps(e, ..) = cond.kind {\n+                    if let Expr{kind: ExprKind::Unary(UnOp::Not, not_expr), ..} = e {\n+                         sugg::Sugg::hir_with_applicability(cx, not_expr, \"..\", &mut applicability).maybe_par().to_string()\n+                    } else {\n+                       format!(\"!{}\", sugg::Sugg::hir_with_applicability(cx, e, \"..\", &mut applicability).maybe_par().to_string())\n+                    }\n                 } else {\n-                    format!(\"!{}\", snippet_with_applicability(cx, cond.span, \"..\", &mut applicability))\n+                   format!(\"!{}\", sugg::Sugg::hir_with_applicability(cx, cond, \"..\", &mut applicability).maybe_par().to_string())\n                 };\n \n                 span_lint_and_sugg("}, {"sha": "0998f8ffa9de4ecf8fe15e4c8e74ed6bdbb3176c", "filename": "tests/ui/if_then_panic.fixed", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fe999e88edd2254124be6419607bd29156841f59/tests%2Fui%2Fif_then_panic.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/fe999e88edd2254124be6419607bd29156841f59/tests%2Fui%2Fif_then_panic.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fif_then_panic.fixed?ref=fe999e88edd2254124be6419607bd29156841f59", "patch": "@@ -31,4 +31,10 @@ fn main() {\n     } else {\n         println!(\"qwq\");\n     }\n+    let b = vec![1, 2, 3];\n+    assert!(!b.is_empty(), \"panic1\");\n+    assert!(!(b.is_empty() && a.is_empty()), \"panic2\");\n+    assert!(!(a.is_empty() && !b.is_empty()), \"panic3\");\n+    assert!(!(b.is_empty() || a.is_empty()), \"panic4\");\n+    assert!(!(a.is_empty() || !b.is_empty()), \"panic5\");\n }"}, {"sha": "10433c8d54f2dd1a4fe3211f8e7a60c7c5d33625", "filename": "tests/ui/if_then_panic.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/fe999e88edd2254124be6419607bd29156841f59/tests%2Fui%2Fif_then_panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe999e88edd2254124be6419607bd29156841f59/tests%2Fui%2Fif_then_panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fif_then_panic.rs?ref=fe999e88edd2254124be6419607bd29156841f59", "patch": "@@ -35,4 +35,20 @@ fn main() {\n     } else {\n         println!(\"qwq\");\n     }\n+    let b = vec![1, 2, 3];\n+    if b.is_empty() {\n+        panic!(\"panic1\");\n+    }\n+    if b.is_empty() && a.is_empty() {\n+        panic!(\"panic2\");\n+    }\n+    if a.is_empty() && !b.is_empty() {\n+        panic!(\"panic3\");\n+    }\n+    if b.is_empty() || a.is_empty() {\n+        panic!(\"panic4\");\n+    }\n+    if a.is_empty() || !b.is_empty() {\n+        panic!(\"panic5\");\n+    }\n }"}, {"sha": "5bb62f8756606ec42f899d2fec87c4a966d9b48f", "filename": "tests/ui/if_then_panic.stderr", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/fe999e88edd2254124be6419607bd29156841f59/tests%2Fui%2Fif_then_panic.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fe999e88edd2254124be6419607bd29156841f59/tests%2Fui%2Fif_then_panic.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fif_then_panic.stderr?ref=fe999e88edd2254124be6419607bd29156841f59", "patch": "@@ -16,5 +16,45 @@ LL | |         panic!(\"qwqwq\");\n LL | |     }\n    | |_____^ help: try: `assert!(a.is_empty(), \"qwqwq\");`\n \n-error: aborting due to 2 previous errors\n+error: only a `panic!` in `if`-then statement\n+  --> $DIR/if_then_panic.rs:39:5\n+   |\n+LL | /     if b.is_empty() {\n+LL | |         panic!(\"panic1\");\n+LL | |     }\n+   | |_____^ help: try: `assert!(!b.is_empty(), \"panic1\");`\n+\n+error: only a `panic!` in `if`-then statement\n+  --> $DIR/if_then_panic.rs:42:5\n+   |\n+LL | /     if b.is_empty() && a.is_empty() {\n+LL | |         panic!(\"panic2\");\n+LL | |     }\n+   | |_____^ help: try: `assert!(!(b.is_empty() && a.is_empty()), \"panic2\");`\n+\n+error: only a `panic!` in `if`-then statement\n+  --> $DIR/if_then_panic.rs:45:5\n+   |\n+LL | /     if a.is_empty() && !b.is_empty() {\n+LL | |         panic!(\"panic3\");\n+LL | |     }\n+   | |_____^ help: try: `assert!(!(a.is_empty() && !b.is_empty()), \"panic3\");`\n+\n+error: only a `panic!` in `if`-then statement\n+  --> $DIR/if_then_panic.rs:48:5\n+   |\n+LL | /     if b.is_empty() || a.is_empty() {\n+LL | |         panic!(\"panic4\");\n+LL | |     }\n+   | |_____^ help: try: `assert!(!(b.is_empty() || a.is_empty()), \"panic4\");`\n+\n+error: only a `panic!` in `if`-then statement\n+  --> $DIR/if_then_panic.rs:51:5\n+   |\n+LL | /     if a.is_empty() || !b.is_empty() {\n+LL | |         panic!(\"panic5\");\n+LL | |     }\n+   | |_____^ help: try: `assert!(!(a.is_empty() || !b.is_empty()), \"panic5\");`\n+\n+error: aborting due to 7 previous errors\n "}]}