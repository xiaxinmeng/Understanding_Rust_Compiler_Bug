{"sha": "4b859c3f2f023c95b5aff6d330e2eabe71253b39", "node_id": "C_kwDOAAsO6NoAKDRiODU5YzNmMmYwMjNjOTViNWFmZjZkMzMwZTJlYWJlNzEyNTNiMzk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-07T16:57:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-07T16:57:15Z"}, "message": "Rollup merge of #107695 - Swatinem:futcallx3, r=compiler-errors\n\nAdd test for Future inflating arg size to 3x\n\nThis adds one more test that should track improvements to generator\nlayout, like https://github.com/rust-lang/rust/issues/62958 and https://github.com/rust-lang/rust/issues/62575.\n\nIn particular, this test highlights suboptimal layout, as the storage\nfor the argument future is not being reused across its usage as `upvar`,\n`local` and `awaitee` (being polled to completion).\n\nThis is on top of https://github.com/rust-lang/rust/pull/107692 (as those would conflict with each other)\n\nIt is a minimal repro for code mentioned in https://github.com/moka-rs/moka/issues/212#issuecomment-1416914616 (CC `@tatsuya6502)`", "tree": {"sha": "94822e46a22fb8687c72acf8c4d865e8b06bc7fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/94822e46a22fb8687c72acf8c4d865e8b06bc7fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4b859c3f2f023c95b5aff6d330e2eabe71253b39", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj4oLrCRBK7hj4Ov3rIwAAeg0IAJdQapNiRmE1t3SRyq87femr\nxHY7RBlyneQf5qkXkXoZZZ7c56wese3ZHX1iJcHCGRT4Cm09qfZyJub/ZgEoK+zZ\nkg/68SYqpgKDXMPpzZ/Ymdq/p8M74TjuwiJrjR1ZKdw6KukFwA1SfFDNqW4D9q4m\nHyy5QIMYZO7wnQl6yyFCXNDwOww6MOJgqUYysOrELu4TC8eS5lrbSnRTIl7MBLfH\nC0ayULVO4QhQWo4ueAc600JTH7KIJdvhy/m8Uwrv4yhEfNa95aH6/oPjFl49/X2U\nJKTvfzsQkBmRBgcjr9h1JegHGoPaPxCgDiRUDxtJwDIaGjsJJTlZLz0/yrbAzk8=\n=zoYU\n-----END PGP SIGNATURE-----\n", "payload": "tree 94822e46a22fb8687c72acf8c4d865e8b06bc7fc\nparent 306dbaf5741a4d76cb2ba0c5feca24414cd1c51a\nparent 7a7b2e352108e17dc4ac834b02ff59e7f81a2c5d\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1675789035 +0100\ncommitter GitHub <noreply@github.com> 1675789035 +0100\n\nRollup merge of #107695 - Swatinem:futcallx3, r=compiler-errors\n\nAdd test for Future inflating arg size to 3x\n\nThis adds one more test that should track improvements to generator\nlayout, like https://github.com/rust-lang/rust/issues/62958 and https://github.com/rust-lang/rust/issues/62575.\n\nIn particular, this test highlights suboptimal layout, as the storage\nfor the argument future is not being reused across its usage as `upvar`,\n`local` and `awaitee` (being polled to completion).\n\nThis is on top of https://github.com/rust-lang/rust/pull/107692 (as those would conflict with each other)\n\nIt is a minimal repro for code mentioned in https://github.com/moka-rs/moka/issues/212#issuecomment-1416914616 (CC `@tatsuya6502)`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4b859c3f2f023c95b5aff6d330e2eabe71253b39", "html_url": "https://github.com/rust-lang/rust/commit/4b859c3f2f023c95b5aff6d330e2eabe71253b39", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4b859c3f2f023c95b5aff6d330e2eabe71253b39/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "306dbaf5741a4d76cb2ba0c5feca24414cd1c51a", "url": "https://api.github.com/repos/rust-lang/rust/commits/306dbaf5741a4d76cb2ba0c5feca24414cd1c51a", "html_url": "https://github.com/rust-lang/rust/commit/306dbaf5741a4d76cb2ba0c5feca24414cd1c51a"}, {"sha": "7a7b2e352108e17dc4ac834b02ff59e7f81a2c5d", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a7b2e352108e17dc4ac834b02ff59e7f81a2c5d", "html_url": "https://github.com/rust-lang/rust/commit/7a7b2e352108e17dc4ac834b02ff59e7f81a2c5d"}], "stats": {"total": 96, "additions": 96, "deletions": 0}, "files": [{"sha": "1816d842d6c4179c0d57bb4513db215ea498b080", "filename": "tests/ui/async-await/future-sizes/async-awaiting-fut.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/4b859c3f2f023c95b5aff6d330e2eabe71253b39/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Fasync-awaiting-fut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b859c3f2f023c95b5aff6d330e2eabe71253b39/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Fasync-awaiting-fut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Fasync-awaiting-fut.rs?ref=4b859c3f2f023c95b5aff6d330e2eabe71253b39", "patch": "@@ -0,0 +1,24 @@\n+// compile-flags: -Z print-type-sizes --crate-type lib\n+// edition:2021\n+// build-pass\n+// ignore-pass\n+\n+async fn wait() {}\n+\n+async fn big_fut(arg: [u8; 1024]) {}\n+\n+async fn calls_fut(fut: impl std::future::Future<Output = ()>) {\n+    loop {\n+        wait().await;\n+        if true {\n+            return fut.await;\n+        } else {\n+            wait().await;\n+        }\n+    }\n+}\n+\n+pub async fn test() {\n+    let fut = big_fut([0u8; 1024]);\n+    calls_fut(fut).await;\n+}"}, {"sha": "eaf3e4b61e304a9241c510b538dd9a5dc794642a", "filename": "tests/ui/async-await/future-sizes/async-awaiting-fut.stdout", "status": "added", "additions": 72, "deletions": 0, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/4b859c3f2f023c95b5aff6d330e2eabe71253b39/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Fasync-awaiting-fut.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/4b859c3f2f023c95b5aff6d330e2eabe71253b39/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Fasync-awaiting-fut.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Ffuture-sizes%2Fasync-awaiting-fut.stdout?ref=4b859c3f2f023c95b5aff6d330e2eabe71253b39", "patch": "@@ -0,0 +1,72 @@\n+print-type-size type: `[async fn body@$DIR/async-awaiting-fut.rs:21:21: 24:2]`: 3078 bytes, alignment: 1 bytes\n+print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n+print-type-size     variant `Suspend0`: 3077 bytes\n+print-type-size         local `.__awaitee`: 3077 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size     variant `Returned`: 0 bytes\n+print-type-size     variant `Panicked`: 0 bytes\n+print-type-size type: `[async fn body@$DIR/async-awaiting-fut.rs:10:64: 19:2]`: 3077 bytes, alignment: 1 bytes\n+print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 2051 bytes\n+print-type-size         padding: 1026 bytes\n+print-type-size         upvar `.fut`: 1025 bytes, alignment: 1 bytes\n+print-type-size     variant `Suspend0`: 2052 bytes\n+print-type-size         local `.fut`: 1025 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size         local `..generator_field4`: 1 bytes\n+print-type-size         padding: 1 bytes\n+print-type-size         upvar `.fut`: 1025 bytes, alignment: 1 bytes\n+print-type-size         local `.__awaitee`: 1 bytes\n+print-type-size     variant `Suspend1`: 3076 bytes\n+print-type-size         padding: 1024 bytes\n+print-type-size         local `..generator_field4`: 1 bytes, alignment: 1 bytes\n+print-type-size         padding: 1 bytes\n+print-type-size         upvar `.fut`: 1025 bytes, alignment: 1 bytes\n+print-type-size         local `.__awaitee`: 1025 bytes\n+print-type-size     variant `Suspend2`: 2052 bytes\n+print-type-size         local `.fut`: 1025 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size         local `..generator_field4`: 1 bytes\n+print-type-size         padding: 1 bytes\n+print-type-size         upvar `.fut`: 1025 bytes, alignment: 1 bytes\n+print-type-size         local `.__awaitee`: 1 bytes\n+print-type-size     variant `Returned`: 2051 bytes\n+print-type-size         padding: 1026 bytes\n+print-type-size         upvar `.fut`: 1025 bytes, alignment: 1 bytes\n+print-type-size     variant `Panicked`: 2051 bytes\n+print-type-size         padding: 1026 bytes\n+print-type-size         upvar `.fut`: 1025 bytes, alignment: 1 bytes\n+print-type-size type: `std::mem::ManuallyDrop<[async fn body@$DIR/async-awaiting-fut.rs:10:64: 19:2]>`: 3077 bytes, alignment: 1 bytes\n+print-type-size     field `.value`: 3077 bytes\n+print-type-size type: `std::mem::MaybeUninit<[async fn body@$DIR/async-awaiting-fut.rs:10:64: 19:2]>`: 3077 bytes, alignment: 1 bytes\n+print-type-size     variant `MaybeUninit`: 3077 bytes\n+print-type-size         field `.uninit`: 0 bytes\n+print-type-size         field `.value`: 3077 bytes\n+print-type-size type: `[async fn body@$DIR/async-awaiting-fut.rs:8:35: 8:37]`: 1025 bytes, alignment: 1 bytes\n+print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 1024 bytes\n+print-type-size         upvar `.arg`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size     variant `Returned`: 1024 bytes\n+print-type-size         upvar `.arg`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size     variant `Panicked`: 1024 bytes\n+print-type-size         upvar `.arg`: 1024 bytes, offset: 0 bytes, alignment: 1 bytes\n+print-type-size type: `std::mem::ManuallyDrop<[async fn body@$DIR/async-awaiting-fut.rs:8:35: 8:37]>`: 1025 bytes, alignment: 1 bytes\n+print-type-size     field `.value`: 1025 bytes\n+print-type-size type: `std::mem::MaybeUninit<[async fn body@$DIR/async-awaiting-fut.rs:8:35: 8:37]>`: 1025 bytes, alignment: 1 bytes\n+print-type-size     variant `MaybeUninit`: 1025 bytes\n+print-type-size         field `.uninit`: 0 bytes\n+print-type-size         field `.value`: 1025 bytes\n+print-type-size type: `[async fn body@$DIR/async-awaiting-fut.rs:6:17: 6:19]`: 1 bytes, alignment: 1 bytes\n+print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n+print-type-size     variant `Returned`: 0 bytes\n+print-type-size     variant `Panicked`: 0 bytes\n+print-type-size type: `std::mem::ManuallyDrop<bool>`: 1 bytes, alignment: 1 bytes\n+print-type-size     field `.value`: 1 bytes\n+print-type-size type: `std::mem::MaybeUninit<bool>`: 1 bytes, alignment: 1 bytes\n+print-type-size     variant `MaybeUninit`: 1 bytes\n+print-type-size         field `.uninit`: 0 bytes\n+print-type-size         field `.value`: 1 bytes\n+print-type-size type: `std::task::Poll<()>`: 1 bytes, alignment: 1 bytes\n+print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Ready`: 0 bytes\n+print-type-size         field `.0`: 0 bytes\n+print-type-size     variant `Pending`: 0 bytes"}]}