{"sha": "70b49c7bddec33e6972610e024fcbb3576aa9be3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwYjQ5YzdiZGRlYzMzZTY5NzI2MTBlMDI0ZmNiYjM1NzZhYTliZTM=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-04T17:16:39Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-04T19:09:29Z"}, "message": "metadata: skip empty polymorphization bitset\n\nThis commit skips encoding empty polymorphization results - while\npolymorphization is disabled, this should be every polymorphization\nresult; but when polymorphization is re-enabled, this would help with\nnon-generic functions and those which do use all their parameters (most\nfunctions).\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "06e73a7c4272fbbb4761889263099b558038c327", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/06e73a7c4272fbbb4761889263099b558038c327"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70b49c7bddec33e6972610e024fcbb3576aa9be3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl8psmkACgkQJZLnbIc4\nH9nF7Q//RvJnPT1YaQOi25GWWZaOXiF7AHYvYmedgkV0C2VcweNvW6KgDEdXKJHx\nQcGx2u/PQucriL3uLsTbAtmNZ3WfpkKhELuj2ZH9CrrFbuKR6csxPaiawthBSUPT\ntpCHLJPfw+a3PAPFMm/Yq/4tQPmiG/IQNGuvoUuERvL4wwivTccv8VoqgkMmd6H0\nhsObsi/Jj9f+ZwlRAMzPXlcB3dUjfKJZL79Fl8+iH6Sbv8ZAeZhpRzix0/+Zho9L\n3z7EYMkBomk2Ifp5j1iOGBgD2QmAVZtuGxpQQRb3iOZt8qVofkWZ9AyJQ9EOY0hU\njXBOBi+CHXkfA56gZKpVsic/uYUZUEbx54HmL4W3ly/bHTUC/BDJrtuWHjjS37Ud\n/2YtcOk41j8l4pW01tvL5wAO5vMqPdiBv0Sf9kuvZ6fv3IbhoREyQiyybMzNMotM\nLwFa/tyrtu9oFdr+QX/KDpdSgKUOck8krwWXh/dxWgVcKyv2xSzJknn0aAhRemDx\nvARdqQARaAeilgmVs5zDJI5i2baMU1mgdhtjPHMEVYTsEI8o3DDR0Ohlqy66kULC\nL0R6UHa/kUyGh0qDnZWuV2ngDSaRX7uzeE/w8D/JjM2VRG2vS9rZ/Nves92Unga2\nk1bvYO30X41ipHgWuCXngBYw3TrD9jaVkQON+fqXbi7PLE78AKc=\n=4c1O\n-----END PGP SIGNATURE-----", "payload": "tree 06e73a7c4272fbbb4761889263099b558038c327\nparent 5f89f02c4e7d06dcb94434b8b30ce457b06eda5c\nauthor David Wood <david@davidtw.co> 1596561399 +0100\ncommitter David Wood <david@davidtw.co> 1596568169 +0100\n\nmetadata: skip empty polymorphization bitset\n\nThis commit skips encoding empty polymorphization results - while\npolymorphization is disabled, this should be every polymorphization\nresult; but when polymorphization is re-enabled, this would help with\nnon-generic functions and those which do use all their parameters (most\nfunctions).\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70b49c7bddec33e6972610e024fcbb3576aa9be3", "html_url": "https://github.com/rust-lang/rust/commit/70b49c7bddec33e6972610e024fcbb3576aa9be3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70b49c7bddec33e6972610e024fcbb3576aa9be3/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5f89f02c4e7d06dcb94434b8b30ce457b06eda5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f89f02c4e7d06dcb94434b8b30ce457b06eda5c", "html_url": "https://github.com/rust-lang/rust/commit/5f89f02c4e7d06dcb94434b8b30ce457b06eda5c"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "aec9e8daa0f82d9779a193cbcadc8741ebada114", "filename": "src/librustc_metadata/rmeta/encoder.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/70b49c7bddec33e6972610e024fcbb3576aa9be3/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70b49c7bddec33e6972610e024fcbb3576aa9be3/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs?ref=70b49c7bddec33e6972610e024fcbb3576aa9be3", "patch": "@@ -1134,8 +1134,11 @@ impl EncodeContext<'a, 'tcx> {\n         debug!(\"EntryBuilder::encode_mir({:?})\", def_id);\n         if self.tcx.mir_keys(LOCAL_CRATE).contains(&def_id) {\n             record!(self.tables.mir[def_id.to_def_id()] <- self.tcx.optimized_mir(def_id));\n-            record!(self.tables.unused_generic_params[def_id.to_def_id()] <-\n-                    self.tcx.unused_generic_params(def_id));\n+\n+            let unused = self.tcx.unused_generic_params(def_id);\n+            if !unused.is_empty() {\n+                record!(self.tables.unused_generic_params[def_id.to_def_id()] <- unused);\n+            }\n         }\n     }\n "}, {"sha": "8fc1458f592054ee47064dbc4bc3fb63e8b74163", "filename": "src/librustc_mir/monomorphize/polymorphize.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/70b49c7bddec33e6972610e024fcbb3576aa9be3/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70b49c7bddec33e6972610e024fcbb3576aa9be3/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs?ref=70b49c7bddec33e6972610e024fcbb3576aa9be3", "patch": "@@ -36,6 +36,13 @@ fn unused_generic_params(tcx: TyCtxt<'_>, def_id: DefId) -> FiniteBitSet<u32> {\n         return FiniteBitSet::new_empty();\n     }\n \n+    // Polymorphization results are stored in cross-crate metadata only when there are unused\n+    // parameters, so assume that non-local items must have only used parameters (else this query\n+    // would not be invoked, and the cross-crate metadata used instead).\n+    if !def_id.is_local() {\n+        return FiniteBitSet::new_empty();\n+    }\n+\n     let generics = tcx.generics_of(def_id);\n     debug!(\"unused_generic_params: generics={:?}\", generics);\n "}]}