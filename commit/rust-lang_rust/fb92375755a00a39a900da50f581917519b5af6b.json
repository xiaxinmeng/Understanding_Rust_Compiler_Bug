{"sha": "fb92375755a00a39a900da50f581917519b5af6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZiOTIzNzU3NTVhMDBhMzlhOTAwZGE1MGY1ODE5MTc1MTliNWFmNmI=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-07-07T09:14:20Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-07-07T09:14:20Z"}, "message": "Merge commit '3a31c6d8272c14388a34622193baf553636fe470' into sync_cg_clif-2021-07-07", "tree": {"sha": "479b4faf1a6fd9d4ddce341c8dd7eac792797b6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/479b4faf1a6fd9d4ddce341c8dd7eac792797b6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fb92375755a00a39a900da50f581917519b5af6b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fb92375755a00a39a900da50f581917519b5af6b", "html_url": "https://github.com/rust-lang/rust/commit/fb92375755a00a39a900da50f581917519b5af6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fb92375755a00a39a900da50f581917519b5af6b/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "html_url": "https://github.com/rust-lang/rust/commit/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b"}], "stats": {"total": 1729, "additions": 1283, "deletions": 446}, "files": [{"sha": "61da6a2491c52fcd3270195db5fb441e89c0a496", "filename": ".cirrus.yml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/.cirrus.yml", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/.cirrus.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.cirrus.yml?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -14,7 +14,7 @@ task:\n     - . $HOME/.cargo/env\n     - git config --global user.email \"user@example.com\"\n     - git config --global user.name \"User\"\n-    - ./prepare.sh\n+    - ./y.rs prepare\n   test_script:\n     - . $HOME/.cargo/env\n     - # Enable backtraces for easier debugging"}, {"sha": "f81ac87726052c7c16e78869bd4baf2866be1fa1", "filename": ".github/workflows/main.yml", "status": "modified", "additions": 72, "deletions": 1, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/.github%2Fworkflows%2Fmain.yml", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/.github%2Fworkflows%2Fmain.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fmain.yml?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -19,6 +19,9 @@ jobs:\n           - os: ubuntu-latest\n             env:\n               TARGET_TRIPLE: x86_64-pc-windows-gnu\n+          - os: ubuntu-latest\n+            env:\n+              TARGET_TRIPLE: aarch64-unknown-linux-gnu\n \n     steps:\n     - uses: actions/checkout@v2\n@@ -49,11 +52,19 @@ jobs:\n         sudo apt-get install -y gcc-mingw-w64-x86-64 wine-stable\n         rustup target add x86_64-pc-windows-gnu\n \n+    - name: Install AArch64 toolchain and qemu\n+      if: matrix.os == 'ubuntu-latest' && matrix.env.TARGET_TRIPLE == 'aarch64-unknown-linux-gnu'\n+      run: |\n+        sudo apt-get install -y gcc-aarch64-linux-gnu qemu-user\n+\n     - name: Prepare dependencies\n       run: |\n         git config --global user.email \"user@example.com\"\n         git config --global user.name \"User\"\n-        ./prepare.sh\n+        ./y.rs prepare\n+\n+    - name: Build\n+      run: ./y.rs build --sysroot none\n \n     - name: Test\n       env:\n@@ -87,3 +98,63 @@ jobs:\n       with:\n         name: cg_clif-${{ runner.os }}-cross-x86_64-mingw\n         path: cg_clif.tar.xz\n+\n+  build_windows:\n+    runs-on: windows-latest\n+    timeout-minutes: 60\n+\n+    steps:\n+    - uses: actions/checkout@v2\n+\n+    #- name: Cache cargo installed crates\n+    #  uses: actions/cache@v2\n+    #  with:\n+    #    path: ~/.cargo/bin\n+    #    key: ${{ runner.os }}-cargo-installed-crates\n+\n+    #- name: Cache cargo registry and index\n+    #  uses: actions/cache@v2\n+    #  with:\n+    #    path: |\n+    #        ~/.cargo/registry\n+    #        ~/.cargo/git\n+    #    key: ${{ runner.os }}-cargo-registry-and-index-${{ hashFiles('**/Cargo.lock') }}\n+\n+    #- name: Cache cargo target dir\n+    #  uses: actions/cache@v2\n+    #  with:\n+    #    path: target\n+    #    key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('rust-toolchain', '**/Cargo.lock') }}\n+\n+    - name: Prepare dependencies\n+      run: |\n+        git config --global user.email \"user@example.com\"\n+        git config --global user.name \"User\"\n+        git config --global core.autocrlf false\n+        rustup set default-host x86_64-pc-windows-gnu\n+        rustc y.rs -o y.exe -g\n+        ./y.exe prepare\n+\n+    - name: Build\n+      #name: Test\n+      run: |\n+        # Enable backtraces for easier debugging\n+        #export RUST_BACKTRACE=1\n+\n+        # Reduce amount of benchmark runs as they are slow\n+        #export COMPILE_RUNS=2\n+        #export RUN_RUNS=2\n+\n+        # Enable extra checks\n+        #export CG_CLIF_ENABLE_VERIFIER=1\n+\n+        ./y.exe build\n+\n+    #- name: Package prebuilt cg_clif\n+    #  run: tar cvfJ cg_clif.tar.xz build\n+\n+    #- name: Upload prebuilt cg_clif\n+    #  uses: actions/upload-artifact@v2\n+    #  with:\n+    #    name: cg_clif-${{ runner.os }}\n+    #    path: cg_clif.tar.xz"}, {"sha": "1c08e5ece33d27e67fc01b5012f1ac237f2fc51c", "filename": ".github/workflows/rustc.yml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/.github%2Fworkflows%2Frustc.yml", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/.github%2Fworkflows%2Frustc.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Frustc.yml?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -34,7 +34,7 @@ jobs:\n       run: |\n         git config --global user.email \"user@example.com\"\n         git config --global user.name \"User\"\n-        ./prepare.sh\n+        ./y.rs prepare\n \n     - name: Test\n       run: |\n@@ -72,7 +72,7 @@ jobs:\n       run: |\n         git config --global user.email \"user@example.com\"\n         git config --global user.name \"User\"\n-        ./prepare.sh\n+        ./y.rs prepare\n \n     - name: Test\n       run: |"}, {"sha": "12e779fe7c7d7b8bb050611e643a6355776ed518", "filename": ".gitignore", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitignore?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -6,9 +6,11 @@ perf.data\n perf.data.old\n *.events\n *.string*\n+/y.bin\n /build\n /build_sysroot/sysroot_src\n /build_sysroot/compiler-builtins\n+/build_sysroot/rustc_version\n /rust\n /rand\n /regex"}, {"sha": "f62e59cefc2414c23ecb8a3ca3418d87d4e7f7c5", "filename": ".vscode/settings.json", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/.vscode%2Fsettings.json", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/.vscode%2Fsettings.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.vscode%2Fsettings.json?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,7 +1,9 @@\n {\n     // source for rustc_* is not included in the rust-src component; disable the errors about this\n     \"rust-analyzer.diagnostics.disabled\": [\"unresolved-extern-crate\", \"unresolved-macro-call\"],\n-    \"rust-analyzer.assist.importMergeBehavior\": \"last\",\n+    \"rust-analyzer.assist.importGranularity\": \"module\",\n+    \"rust-analyzer.assist.importEnforceGranularity\": true,\n+    \"rust-analyzer.assist.importPrefix\": \"crate\",\n     \"rust-analyzer.cargo.runBuildScripts\": true,\n     \"rust-analyzer.linkedProjects\": [\n         \"./Cargo.toml\",\n@@ -49,6 +51,23 @@\n                     \"cfg\": [],\n                 },\n             ]\n+        },\n+        {\n+            \"roots\": [\"./y.rs\"],\n+            \"crates\": [\n+                {\n+                    \"root_module\": \"./y.rs\",\n+                    \"edition\": \"2018\",\n+                    \"deps\": [{ \"crate\": 1, \"name\": \"std\" }],\n+                    \"cfg\": [],\n+                },\n+                {\n+                    \"root_module\": \"./build_sysroot/sysroot_src/library/std/src/lib.rs\",\n+                    \"edition\": \"2018\",\n+                    \"deps\": [],\n+                    \"cfg\": [],\n+                },\n+            ]\n         }\n     ]\n }"}, {"sha": "56d0974b25371b6e2abef4451c5eefef3879668c", "filename": "Cargo.lock", "status": "modified", "additions": 32, "deletions": 24, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -33,16 +33,16 @@ checksum = \"baf1de4339761588bc0619e3cbc0120ee582ebb74b53b4efbf79117bd2da40fd\"\n \n [[package]]\n name = \"cranelift-bforest\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"cranelift-entity\",\n ]\n \n [[package]]\n name = \"cranelift-codegen\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"cranelift-bforest\",\n  \"cranelift-codegen-meta\",\n@@ -57,27 +57,27 @@ dependencies = [\n \n [[package]]\n name = \"cranelift-codegen-meta\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"cranelift-codegen-shared\",\n  \"cranelift-entity\",\n ]\n \n [[package]]\n name = \"cranelift-codegen-shared\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n \n [[package]]\n name = \"cranelift-entity\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n \n [[package]]\n name = \"cranelift-frontend\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"cranelift-codegen\",\n  \"log\",\n@@ -87,8 +87,8 @@ dependencies = [\n \n [[package]]\n name = \"cranelift-jit\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"anyhow\",\n  \"cranelift-codegen\",\n@@ -104,8 +104,8 @@ dependencies = [\n \n [[package]]\n name = \"cranelift-module\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"anyhow\",\n  \"cranelift-codegen\",\n@@ -115,17 +115,18 @@ dependencies = [\n \n [[package]]\n name = \"cranelift-native\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"cranelift-codegen\",\n+ \"libc\",\n  \"target-lexicon\",\n ]\n \n [[package]]\n name = \"cranelift-object\"\n-version = \"0.74.0\"\n-source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#76c6b83f6a21a12a11d4f890490f8acb6329a600\"\n+version = \"0.75.0\"\n+source = \"git+https://github.com/bytecodealliance/wasmtime.git?branch=main#c71ad9490e7f3e19bbcae7e28bbe50f8a0b4a5d8\"\n dependencies = [\n  \"anyhow\",\n  \"cranelift-codegen\",\n@@ -171,9 +172,9 @@ dependencies = [\n \n [[package]]\n name = \"libc\"\n-version = \"0.2.86\"\n+version = \"0.2.97\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"b7282d924be3275cec7f6756ff4121987bc6481325397dde6ba3e7802b1a8b1c\"\n+checksum = \"12b8adadd720df158f4d70dfe7ccc6adb0472d7c55ca83445f6a5ab3e36f8fb6\"\n \n [[package]]\n name = \"libloading\"\n@@ -203,14 +204,21 @@ dependencies = [\n  \"libc\",\n ]\n \n+[[package]]\n+name = \"memchr\"\n+version = \"2.4.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b16bd47d9e329435e309c58469fe0791c2d0d1ba96ec0954152a5ae2b04387dc\"\n+\n [[package]]\n name = \"object\"\n-version = \"0.24.0\"\n+version = \"0.25.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"1a5b3dd1c072ee7963717671d1ca129f1048fda25edea6b752bfc71ac8854170\"\n+checksum = \"a38f2be3697a57b4060074ff41b44c16870d916ad7877c17696e063257482bc7\"\n dependencies = [\n  \"crc32fast\",\n  \"indexmap\",\n+ \"memchr\",\n ]\n \n [[package]]"}, {"sha": "ef68d7ee532dd3a7561ef0539f326959e3e0857c", "filename": "Cargo.toml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -9,15 +9,15 @@ crate-type = [\"dylib\"]\n \n [dependencies]\n # These have to be in sync with each other\n-cranelift-codegen = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\", features = [\"unwind\"] }\n+cranelift-codegen = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\", features = [\"unwind\", \"all-arch\"] }\n cranelift-frontend = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\" }\n cranelift-module = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\" }\n cranelift-native = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\" }\n cranelift-jit = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\", optional = true }\n cranelift-object = { git = \"https://github.com/bytecodealliance/wasmtime.git\", branch = \"main\" }\n target-lexicon = \"0.12.0\"\n gimli = { version = \"0.24.0\", default-features = false, features = [\"write\"]}\n-object = { version = \"0.24.0\", default-features = false, features = [\"std\", \"read_core\", \"write\", \"archive\", \"coff\", \"elf\", \"macho\", \"pe\"] }\n+object = { version = \"0.25.0\", default-features = false, features = [\"std\", \"read_core\", \"write\", \"archive\", \"coff\", \"elf\", \"macho\", \"pe\"] }\n \n ar = { git = \"https://github.com/bjorn3/rust-ar.git\", branch = \"do_not_remove_cg_clif_ranlib\" }\n indexmap = \"1.0.2\""}, {"sha": "dad8ed90b53b8307fb1c4b72d40b15a59c2878bd", "filename": "Readme.md", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/Readme.md", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/Readme.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Readme.md?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -10,8 +10,8 @@ If not please open an issue.\n ```bash\n $ git clone https://github.com/bjorn3/rustc_codegen_cranelift.git\n $ cd rustc_codegen_cranelift\n-$ ./prepare.sh # download and patch sysroot src and install hyperfine for benchmarking\n-$ ./build.sh\n+$ ./y.rs prepare # download and patch sysroot src and install hyperfine for benchmarking\n+$ ./y.rs build\n ```\n \n To run the test suite replace the last command with:\n@@ -20,7 +20,7 @@ To run the test suite replace the last command with:\n $ ./test.sh\n ```\n \n-This will implicitly build cg_clif too. Both `build.sh` and `test.sh` accept a `--debug` argument to\n+This will implicitly build cg_clif too. Both `y.rs build` and `test.sh` accept a `--debug` argument to\n build in debug mode.\n \n Alternatively you can download a pre built version from [GHA]. It is listed in the artifacts section\n@@ -32,12 +32,12 @@ of workflow runs. Unfortunately due to GHA restrictions you need to be logged in\n \n rustc_codegen_cranelift can be used as a near-drop-in replacement for `cargo build` or `cargo run` for existing projects.\n \n-Assuming `$cg_clif_dir` is the directory you cloned this repo into and you followed the instructions (`prepare.sh` and `build.sh` or `test.sh`).\n+Assuming `$cg_clif_dir` is the directory you cloned this repo into and you followed the instructions (`y.rs prepare` and `y.rs build` or `test.sh`).\n \n In the directory with your project (where you can do the usual `cargo build`), run:\n \n ```bash\n-$ $cg_clif_dir/build/cargo.sh build\n+$ $cg_clif_dir/build/cargo build\n ```\n \n This will build your project with rustc_codegen_cranelift instead of the usual LLVM backend."}, {"sha": "76bc1884334afe4ea539ca65be6b5f8c32f5203d", "filename": "build.sh", "status": "removed", "additions": 0, "deletions": 89, "changes": 89, "blob_url": "https://github.com/rust-lang/rust/blob/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/build.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/build.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build.sh?ref=4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "patch": "@@ -1,89 +0,0 @@\n-#!/usr/bin/env bash\n-set -e\n-\n-# Settings\n-export CHANNEL=\"release\"\n-build_sysroot=\"clif\"\n-target_dir='build'\n-while [[ $# != 0 ]]; do\n-    case $1 in\n-        \"--debug\")\n-            export CHANNEL=\"debug\"\n-            ;;\n-        \"--sysroot\")\n-            build_sysroot=$2\n-            shift\n-            ;;\n-        \"--target-dir\")\n-            target_dir=$2\n-            shift\n-            ;;\n-        *)\n-            echo \"Unknown flag '$1'\"\n-            echo \"Usage: ./build.sh [--debug] [--sysroot none|clif|llvm] [--target-dir DIR]\"\n-            exit 1\n-            ;;\n-    esac\n-    shift\n-done\n-\n-# Build cg_clif\n-unset CARGO_TARGET_DIR\n-unamestr=$(uname)\n-if [[ \"$unamestr\" == 'Linux' || \"$unamestr\" == \"FreeBSD\" ]]; then\n-   export RUSTFLAGS='-Clink-arg=-Wl,-rpath=$ORIGIN/../lib '$RUSTFLAGS\n-elif [[ \"$unamestr\" == 'Darwin' ]]; then\n-   export RUSTFLAGS='-Csplit-debuginfo=unpacked -Clink-arg=-Wl,-rpath,@loader_path/../lib -Zosx-rpath-install-name '$RUSTFLAGS\n-   dylib_ext='dylib'\n-else\n-   echo \"Unsupported os $unamestr\"\n-   exit 1\n-fi\n-if [[ \"$CHANNEL\" == \"release\" ]]; then\n-    cargo build --release\n-else\n-    cargo build\n-fi\n-\n-source scripts/ext_config.sh\n-\n-rm -rf \"$target_dir\"\n-mkdir \"$target_dir\"\n-mkdir \"$target_dir\"/bin \"$target_dir\"/lib\n-ln target/$CHANNEL/cg_clif{,_build_sysroot} \"$target_dir\"/bin\n-ln target/$CHANNEL/*rustc_codegen_cranelift* \"$target_dir\"/lib\n-ln rust-toolchain scripts/config.sh scripts/cargo.sh \"$target_dir\"\n-\n-mkdir -p \"$target_dir/lib/rustlib/$TARGET_TRIPLE/lib/\"\n-mkdir -p \"$target_dir/lib/rustlib/$HOST_TRIPLE/lib/\"\n-if [[ \"$TARGET_TRIPLE\" == \"x86_64-pc-windows-gnu\" ]]; then\n-    cp $(rustc --print sysroot)/lib/rustlib/$TARGET_TRIPLE/lib/*.o \"$target_dir/lib/rustlib/$TARGET_TRIPLE/lib/\"\n-fi\n-\n-case \"$build_sysroot\" in\n-    \"none\")\n-        ;;\n-    \"llvm\")\n-        cp -r $(rustc --print sysroot)/lib/rustlib/$TARGET_TRIPLE/lib \"$target_dir/lib/rustlib/$TARGET_TRIPLE/\"\n-        if [[ \"$HOST_TRIPLE\" != \"$TARGET_TRIPLE\" ]]; then\n-            cp -r $(rustc --print sysroot)/lib/rustlib/$HOST_TRIPLE/lib \"$target_dir/lib/rustlib/$HOST_TRIPLE/\"\n-        fi\n-        ;;\n-    \"clif\")\n-        echo \"[BUILD] sysroot\"\n-        dir=$(pwd)\n-        cd \"$target_dir\"\n-        time \"$dir/build_sysroot/build_sysroot.sh\"\n-        if [[ \"$HOST_TRIPLE\" != \"$TARGET_TRIPLE\" ]]; then\n-            time TARGET_TRIPLE=\"$HOST_TRIPLE\" \"$dir/build_sysroot/build_sysroot.sh\"\n-        fi\n-        cp lib/rustlib/*/lib/libstd-* lib/\n-        ;;\n-    *)\n-        echo \"Unknown sysroot kind \\`$build_sysroot\\`.\"\n-        echo \"The allowed values are:\"\n-        echo \"    none A sysroot that doesn't contain the standard library\"\n-        echo \"    llvm Copy the sysroot from rustc compiled by cg_llvm\"\n-        echo \"    clif Build a new sysroot using cg_clif\"\n-        exit 1\n-esac"}, {"sha": "46f661107e73b43ab0b9a2713e51661a60a64708", "filename": "build_sysroot/Cargo.lock", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_sysroot%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_sysroot%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2FCargo.lock?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -56,7 +56,7 @@ dependencies = [\n \n [[package]]\n name = \"compiler_builtins\"\n-version = \"0.1.43\"\n+version = \"0.1.46\"\n dependencies = [\n  \"rustc-std-workspace-core\",\n ]\n@@ -121,9 +121,9 @@ dependencies = [\n \n [[package]]\n name = \"hermit-abi\"\n-version = \"0.1.18\"\n+version = \"0.1.19\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"322f4de77956e22ed0e5032c359a0f1273f1f7f0d79bfa3b8ffbc730d7fbcc5c\"\n+checksum = \"62b467343b94ba476dcb2500d242dadbb39557df889310ac77c5d99100aaac33\"\n dependencies = [\n  \"compiler_builtins\",\n  \"libc\",\n@@ -132,9 +132,9 @@ dependencies = [\n \n [[package]]\n name = \"libc\"\n-version = \"0.2.95\"\n+version = \"0.2.97\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"789da6d93f1b866ffe175afc5322a4d76c038605a1c3319bb57b06967ca98a36\"\n+checksum = \"12b8adadd720df158f4d70dfe7ccc6adb0472d7c55ca83445f6a5ab3e36f8fb6\"\n dependencies = [\n  \"rustc-std-workspace-core\",\n ]\n@@ -195,9 +195,9 @@ dependencies = [\n \n [[package]]\n name = \"rustc-demangle\"\n-version = \"0.1.19\"\n+version = \"0.1.20\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"410f7acf3cb3a44527c5d9546bad4bf4e6c460915d5f9f2fc524498bfe8f70ce\"\n+checksum = \"dead70b0b5e03e9c814bcb6b01e03e68f7c57a80aa48c72ec92152ab3e818d49\"\n dependencies = [\n  \"compiler_builtins\",\n  \"rustc-std-workspace-core\","}, {"sha": "0354304e55bf77477039d6737749d845128ac80c", "filename": "build_sysroot/build_sysroot.sh", "status": "removed", "additions": 0, "deletions": 39, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/build_sysroot%2Fbuild_sysroot.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/build_sysroot%2Fbuild_sysroot.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2Fbuild_sysroot.sh?ref=4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "patch": "@@ -1,39 +0,0 @@\n-#!/usr/bin/env bash\n-\n-# Requires the CHANNEL env var to be set to `debug` or `release.`\n-\n-set -e\n-\n-source ./config.sh\n-\n-dir=$(pwd)\n-\n-# Use rustc with cg_clif as hotpluggable backend instead of the custom cg_clif driver so that\n-# build scripts are still compiled using cg_llvm.\n-export RUSTC=$dir\"/bin/cg_clif_build_sysroot\"\n-export RUSTFLAGS=$RUSTFLAGS\" --clif\"\n-\n-cd \"$(dirname \"$0\")\"\n-\n-# Cleanup for previous run\n-#     v Clean target dir except for build scripts and incremental cache\n-rm -r target/*/{debug,release}/{build,deps,examples,libsysroot*,native} 2>/dev/null || true\n-\n-# We expect the target dir in the default location. Guard against the user changing it.\n-export CARGO_TARGET_DIR=target\n-\n-# Build libs\n-export RUSTFLAGS=\"$RUSTFLAGS -Zforce-unstable-if-unmarked -Cpanic=abort\"\n-export __CARGO_DEFAULT_LIB_METADATA=\"cg_clif\"\n-if [[ \"$1\" != \"--debug\" ]]; then\n-    sysroot_channel='release'\n-    # FIXME Enable incremental again once rust-lang/rust#74946 is fixed\n-    CARGO_INCREMENTAL=0 RUSTFLAGS=\"$RUSTFLAGS -Zmir-opt-level=3\" cargo build --target \"$TARGET_TRIPLE\" --release\n-else\n-    sysroot_channel='debug'\n-    cargo build --target \"$TARGET_TRIPLE\"\n-fi\n-\n-# Copy files to sysroot\n-ln \"target/$TARGET_TRIPLE/$sysroot_channel/deps/\"* \"$dir/lib/rustlib/$TARGET_TRIPLE/lib/\"\n-rm \"$dir/lib/rustlib/$TARGET_TRIPLE/lib/\"*.{rmeta,d}"}, {"sha": "54b7a94750c5249ee465380802c313d72e68272c", "filename": "build_sysroot/prepare_sysroot_src.sh", "status": "removed", "additions": 0, "deletions": 39, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/build_sysroot%2Fprepare_sysroot_src.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/build_sysroot%2Fprepare_sysroot_src.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2Fprepare_sysroot_src.sh?ref=4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "patch": "@@ -1,39 +0,0 @@\n-#!/usr/bin/env bash\n-set -e\n-cd \"$(dirname \"$0\")\"\n-\n-SRC_DIR=\"$(dirname \"$(rustup which rustc)\")/../lib/rustlib/src/rust/\"\n-DST_DIR=\"sysroot_src\"\n-\n-if [ ! -e \"$SRC_DIR\" ]; then\n-    echo \"Please install rust-src component\"\n-    exit 1\n-fi\n-\n-rm -rf $DST_DIR\n-mkdir -p $DST_DIR/library\n-cp -a \"$SRC_DIR/library\" $DST_DIR/\n-\n-pushd $DST_DIR\n-echo \"[GIT] init\"\n-git init\n-echo \"[GIT] add\"\n-git add .\n-echo \"[GIT] commit\"\n-git commit -m \"Initial commit\" -q\n-for file in $(ls ../../patches/ | grep -v patcha); do\n-echo \"[GIT] apply\" \"$file\"\n-git apply ../../patches/\"$file\"\n-git add -A\n-git commit --no-gpg-sign -m \"Patch $file\"\n-done\n-popd\n-\n-git clone https://github.com/rust-lang/compiler-builtins.git || echo \"rust-lang/compiler-builtins has already been cloned\"\n-pushd compiler-builtins\n-git checkout -- .\n-git checkout 0.1.43\n-git apply ../../crate_patches/000*-compiler-builtins-*.patch\n-popd\n-\n-echo \"Successfully prepared sysroot source for building\""}, {"sha": "1df2bcc4541ca1b9fdbad003df57ea3f6c67d265", "filename": "build_system/build_backend.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fbuild_backend.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fbuild_backend.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fbuild_backend.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,40 @@\n+use std::env;\n+use std::path::{Path, PathBuf};\n+use std::process::Command;\n+\n+pub(crate) fn build_backend(channel: &str, host_triple: &str) -> PathBuf {\n+    let mut cmd = Command::new(\"cargo\");\n+    cmd.arg(\"build\").arg(\"--target\").arg(host_triple);\n+\n+    match channel {\n+        \"debug\" => {}\n+        \"release\" => {\n+            cmd.arg(\"--release\");\n+        }\n+        _ => unreachable!(),\n+    }\n+\n+    if cfg!(unix) {\n+        if cfg!(target_os = \"macos\") {\n+            cmd.env(\n+                \"RUSTFLAGS\",\n+                \"-Csplit-debuginfo=unpacked \\\n+                -Clink-arg=-Wl,-rpath,@loader_path/../lib \\\n+                -Zosx-rpath-install-name\"\n+                    .to_string()\n+                    + env::var(\"RUSTFLAGS\").as_deref().unwrap_or(\"\"),\n+            );\n+        } else {\n+            cmd.env(\n+                \"RUSTFLAGS\",\n+                \"-Clink-arg=-Wl,-rpath=$ORIGIN/../lib \".to_string()\n+                    + env::var(\"RUSTFLAGS\").as_deref().unwrap_or(\"\"),\n+            );\n+        }\n+    }\n+\n+    eprintln!(\"[BUILD] rustc_codegen_cranelift\");\n+    crate::utils::spawn_and_wait(cmd);\n+\n+    Path::new(\"target\").join(host_triple).join(channel)\n+}"}, {"sha": "9fb88c279613fb85627f262183fe23fe079553de", "filename": "build_system/build_sysroot.rs", "status": "added", "additions": 216, "deletions": 0, "changes": 216, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fbuild_sysroot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fbuild_sysroot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fbuild_sysroot.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,216 @@\n+use std::env;\n+use std::fs;\n+use std::path::{Path, PathBuf};\n+use std::process::{self, Command};\n+\n+use crate::rustc_info::{get_file_name, get_rustc_version};\n+use crate::utils::{spawn_and_wait, try_hard_link};\n+use crate::SysrootKind;\n+\n+pub(crate) fn build_sysroot(\n+    channel: &str,\n+    sysroot_kind: SysrootKind,\n+    target_dir: &Path,\n+    cg_clif_build_dir: PathBuf,\n+    host_triple: &str,\n+    target_triple: &str,\n+) {\n+    if target_dir.exists() {\n+        fs::remove_dir_all(target_dir).unwrap();\n+    }\n+    fs::create_dir_all(target_dir.join(\"bin\")).unwrap();\n+    fs::create_dir_all(target_dir.join(\"lib\")).unwrap();\n+\n+    // Copy the backend\n+    for file in [\"cg_clif\", \"cg_clif_build_sysroot\"] {\n+        try_hard_link(\n+            cg_clif_build_dir.join(get_file_name(file, \"bin\")),\n+            target_dir.join(\"bin\").join(get_file_name(file, \"bin\")),\n+        );\n+    }\n+\n+    let cg_clif_dylib = get_file_name(\"rustc_codegen_cranelift\", \"dylib\");\n+    try_hard_link(\n+        cg_clif_build_dir.join(&cg_clif_dylib),\n+        target_dir\n+            .join(if cfg!(windows) {\n+                // Windows doesn't have rpath support, so the cg_clif dylib needs to be next to the\n+                // binaries.\n+                \"bin\"\n+            } else {\n+                \"lib\"\n+            })\n+            .join(cg_clif_dylib),\n+    );\n+\n+    // Build and copy cargo wrapper\n+    let mut build_cargo_wrapper_cmd = Command::new(\"rustc\");\n+    build_cargo_wrapper_cmd\n+        .arg(\"scripts/cargo.rs\")\n+        .arg(\"-o\")\n+        .arg(target_dir.join(\"cargo\"))\n+        .arg(\"-g\");\n+    spawn_and_wait(build_cargo_wrapper_cmd);\n+\n+    let default_sysroot = crate::rustc_info::get_default_sysroot();\n+\n+    let rustlib = target_dir.join(\"lib\").join(\"rustlib\");\n+    let host_rustlib_lib = rustlib.join(host_triple).join(\"lib\");\n+    let target_rustlib_lib = rustlib.join(target_triple).join(\"lib\");\n+    fs::create_dir_all(&host_rustlib_lib).unwrap();\n+    fs::create_dir_all(&target_rustlib_lib).unwrap();\n+\n+    if target_triple == \"x86_64-pc-windows-gnu\" {\n+        if !default_sysroot.join(\"lib\").join(\"rustlib\").join(target_triple).join(\"lib\").exists() {\n+            eprintln!(\n+                \"The x86_64-pc-windows-gnu target needs to be installed first before it is possible \\\n+                to compile a sysroot for it.\",\n+            );\n+            process::exit(1);\n+        }\n+        for file in fs::read_dir(\n+            default_sysroot.join(\"lib\").join(\"rustlib\").join(target_triple).join(\"lib\"),\n+        )\n+        .unwrap()\n+        {\n+            let file = file.unwrap().path();\n+            if file.extension().map_or(true, |ext| ext.to_str().unwrap() != \"o\") {\n+                continue; // only copy object files\n+            }\n+            try_hard_link(&file, target_rustlib_lib.join(file.file_name().unwrap()));\n+        }\n+    }\n+\n+    match sysroot_kind {\n+        SysrootKind::None => {} // Nothing to do\n+        SysrootKind::Llvm => {\n+            for file in fs::read_dir(\n+                default_sysroot.join(\"lib\").join(\"rustlib\").join(host_triple).join(\"lib\"),\n+            )\n+            .unwrap()\n+            {\n+                let file = file.unwrap().path();\n+                let file_name_str = file.file_name().unwrap().to_str().unwrap();\n+                if file_name_str.contains(\"rustc_\")\n+                    || file_name_str.contains(\"chalk\")\n+                    || file_name_str.contains(\"tracing\")\n+                    || file_name_str.contains(\"regex\")\n+                {\n+                    // These are large crates that are part of the rustc-dev component and are not\n+                    // necessary to run regular programs.\n+                    continue;\n+                }\n+                try_hard_link(&file, host_rustlib_lib.join(file.file_name().unwrap()));\n+            }\n+\n+            if target_triple != host_triple {\n+                for file in fs::read_dir(\n+                    default_sysroot.join(\"lib\").join(\"rustlib\").join(target_triple).join(\"lib\"),\n+                )\n+                .unwrap()\n+                {\n+                    let file = file.unwrap().path();\n+                    try_hard_link(&file, target_rustlib_lib.join(file.file_name().unwrap()));\n+                }\n+            }\n+        }\n+        SysrootKind::Clif => {\n+            build_clif_sysroot_for_triple(channel, target_dir, host_triple, None);\n+\n+            if host_triple != target_triple {\n+                // When cross-compiling it is often necessary to manually pick the right linker\n+                let linker = if target_triple == \"aarch64-unknown-linux-gnu\" {\n+                    Some(\"aarch64-linux-gnu-gcc\")\n+                } else {\n+                    None\n+                };\n+                build_clif_sysroot_for_triple(channel, target_dir, target_triple, linker);\n+            }\n+\n+            // Copy std for the host to the lib dir. This is necessary for the jit mode to find\n+            // libstd.\n+            for file in fs::read_dir(host_rustlib_lib).unwrap() {\n+                let file = file.unwrap().path();\n+                if file.file_name().unwrap().to_str().unwrap().contains(\"std-\") {\n+                    try_hard_link(&file, target_dir.join(\"lib\").join(file.file_name().unwrap()));\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+fn build_clif_sysroot_for_triple(\n+    channel: &str,\n+    target_dir: &Path,\n+    triple: &str,\n+    linker: Option<&str>,\n+) {\n+    match fs::read_to_string(Path::new(\"build_sysroot\").join(\"rustc_version\")) {\n+        Err(e) => {\n+            eprintln!(\"Failed to get rustc version for patched sysroot source: {}\", e);\n+            eprintln!(\"Hint: Try `./y.rs prepare` to patch the sysroot source\");\n+            process::exit(1);\n+        }\n+        Ok(source_version) => {\n+            let rustc_version = get_rustc_version();\n+            if source_version != rustc_version {\n+                eprintln!(\"The patched sysroot source is outdated\");\n+                eprintln!(\"Source version: {}\", source_version.trim());\n+                eprintln!(\"Rustc version:  {}\", rustc_version.trim());\n+                eprintln!(\"Hint: Try `./y.rs prepare` to update the patched sysroot source\");\n+                process::exit(1);\n+            }\n+        }\n+    }\n+\n+    let build_dir = Path::new(\"build_sysroot\").join(\"target\").join(triple).join(channel);\n+\n+    if !crate::config::get_bool(\"keep_sysroot\") {\n+        // Cleanup the target dir with the exception of build scripts and the incremental cache\n+        for dir in [\"build\", \"deps\", \"examples\", \"native\"] {\n+            if build_dir.join(dir).exists() {\n+                fs::remove_dir_all(build_dir.join(dir)).unwrap();\n+            }\n+        }\n+    }\n+\n+    // Build sysroot\n+    let mut build_cmd = Command::new(\"cargo\");\n+    build_cmd.arg(\"build\").arg(\"--target\").arg(triple).current_dir(\"build_sysroot\");\n+    let mut rustflags = \"--clif -Zforce-unstable-if-unmarked\".to_string();\n+    if channel == \"release\" {\n+        build_cmd.arg(\"--release\");\n+        rustflags.push_str(\" -Zmir-opt-level=3\");\n+    }\n+    if let Some(linker) = linker {\n+        use std::fmt::Write;\n+        write!(rustflags, \" -Clinker={}\", linker).unwrap();\n+    }\n+    build_cmd.env(\"RUSTFLAGS\", rustflags);\n+    build_cmd.env(\n+        \"RUSTC\",\n+        env::current_dir().unwrap().join(target_dir).join(\"bin\").join(\"cg_clif_build_sysroot\"),\n+    );\n+    // FIXME Enable incremental again once rust-lang/rust#74946 is fixed\n+    build_cmd.env(\"CARGO_INCREMENTAL\", \"0\").env(\"__CARGO_DEFAULT_LIB_METADATA\", \"cg_clif\");\n+    spawn_and_wait(build_cmd);\n+\n+    // Copy all relevant files to the sysroot\n+    for entry in\n+        fs::read_dir(Path::new(\"build_sysroot/target\").join(triple).join(channel).join(\"deps\"))\n+            .unwrap()\n+    {\n+        let entry = entry.unwrap();\n+        if let Some(ext) = entry.path().extension() {\n+            if ext == \"rmeta\" || ext == \"d\" || ext == \"dSYM\" {\n+                continue;\n+            }\n+        } else {\n+            continue;\n+        };\n+        try_hard_link(\n+            entry.path(),\n+            target_dir.join(\"lib\").join(\"rustlib\").join(triple).join(\"lib\").join(entry.file_name()),\n+        );\n+    }\n+}"}, {"sha": "ef540cf1f822b467b80adbc23f2c490e96c647ac", "filename": "build_system/config.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fconfig.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,55 @@\n+use std::{fs, process};\n+\n+fn load_config_file() -> Vec<(String, Option<String>)> {\n+    fs::read_to_string(\"config.txt\")\n+        .unwrap()\n+        .lines()\n+        .map(|line| if let Some((line, _comment)) = line.split_once('#') { line } else { line })\n+        .map(|line| line.trim())\n+        .filter(|line| !line.is_empty())\n+        .map(|line| {\n+            if let Some((key, val)) = line.split_once('=') {\n+                (key.trim().to_owned(), Some(val.trim().to_owned()))\n+            } else {\n+                (line.to_owned(), None)\n+            }\n+        })\n+        .collect()\n+}\n+\n+pub(crate) fn get_bool(name: &str) -> bool {\n+    let values = load_config_file()\n+        .into_iter()\n+        .filter(|(key, _)| key == name)\n+        .map(|(_, val)| val)\n+        .collect::<Vec<_>>();\n+    if values.is_empty() {\n+        false\n+    } else {\n+        if values.iter().any(|val| val.is_some()) {\n+            eprintln!(\"Boolean config `{}` has a value\", name);\n+            process::exit(1);\n+        }\n+        true\n+    }\n+}\n+\n+pub(crate) fn get_value(name: &str) -> Option<String> {\n+    let values = load_config_file()\n+        .into_iter()\n+        .filter(|(key, _)| key == name)\n+        .map(|(_, val)| val)\n+        .collect::<Vec<_>>();\n+    if values.is_empty() {\n+        None\n+    } else if values.len() == 1 {\n+        if values[0].is_none() {\n+            eprintln!(\"Config `{}` missing value\", name);\n+            process::exit(1);\n+        }\n+        values.into_iter().next().unwrap()\n+    } else {\n+        eprintln!(\"Config `{}` given multiple values: {:?}\", name, values);\n+        process::exit(1);\n+    }\n+}"}, {"sha": "401b8271abcc52e63f4b4c493a5ac2ec24a59066", "filename": "build_system/prepare.rs", "status": "added", "additions": 133, "deletions": 0, "changes": 133, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fprepare.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Fprepare.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fprepare.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,133 @@\n+use std::env;\n+use std::ffi::OsStr;\n+use std::ffi::OsString;\n+use std::fs;\n+use std::path::Path;\n+use std::process::Command;\n+\n+use crate::rustc_info::{get_file_name, get_rustc_path, get_rustc_version};\n+use crate::utils::{copy_dir_recursively, spawn_and_wait};\n+\n+pub(crate) fn prepare() {\n+    prepare_sysroot();\n+\n+    eprintln!(\"[INSTALL] hyperfine\");\n+    Command::new(\"cargo\").arg(\"install\").arg(\"hyperfine\").spawn().unwrap().wait().unwrap();\n+\n+    clone_repo(\n+        \"rand\",\n+        \"https://github.com/rust-random/rand.git\",\n+        \"0f933f9c7176e53b2a3c7952ded484e1783f0bf1\",\n+    );\n+    apply_patches(\"rand\", Path::new(\"rand\"));\n+\n+    clone_repo(\n+        \"regex\",\n+        \"https://github.com/rust-lang/regex.git\",\n+        \"341f207c1071f7290e3f228c710817c280c8dca1\",\n+    );\n+\n+    clone_repo(\n+        \"simple-raytracer\",\n+        \"https://github.com/ebobby/simple-raytracer\",\n+        \"804a7a21b9e673a482797aa289a18ed480e4d813\",\n+    );\n+\n+    eprintln!(\"[LLVM BUILD] simple-raytracer\");\n+    let mut build_cmd = Command::new(\"cargo\");\n+    build_cmd.arg(\"build\").env_remove(\"CARGO_TARGET_DIR\").current_dir(\"simple-raytracer\");\n+    spawn_and_wait(build_cmd);\n+    fs::copy(\n+        Path::new(\"simple-raytracer/target/debug\").join(get_file_name(\"main\", \"bin\")),\n+        // FIXME use get_file_name here too once testing is migrated to rust\n+        \"simple-raytracer/raytracer_cg_llvm\",\n+    )\n+    .unwrap();\n+}\n+\n+fn prepare_sysroot() {\n+    let rustc_path = get_rustc_path();\n+    let sysroot_src_orig = rustc_path.parent().unwrap().join(\"../lib/rustlib/src/rust\");\n+    let sysroot_src = env::current_dir().unwrap().join(\"build_sysroot\").join(\"sysroot_src\");\n+\n+    assert!(sysroot_src_orig.exists());\n+\n+    if sysroot_src.exists() {\n+        fs::remove_dir_all(&sysroot_src).unwrap();\n+    }\n+    fs::create_dir_all(sysroot_src.join(\"library\")).unwrap();\n+    eprintln!(\"[COPY] sysroot src\");\n+    copy_dir_recursively(&sysroot_src_orig.join(\"library\"), &sysroot_src.join(\"library\"));\n+\n+    let rustc_version = get_rustc_version();\n+    fs::write(\n+        Path::new(\"build_sysroot\").join(\"rustc_version\"),\n+        &rustc_version,\n+    )\n+    .unwrap();\n+\n+    eprintln!(\"[GIT] init\");\n+    let mut git_init_cmd = Command::new(\"git\");\n+    git_init_cmd.arg(\"init\").arg(\"-q\").current_dir(&sysroot_src);\n+    spawn_and_wait(git_init_cmd);\n+\n+    let mut git_add_cmd = Command::new(\"git\");\n+    git_add_cmd.arg(\"add\").arg(\".\").current_dir(&sysroot_src);\n+    spawn_and_wait(git_add_cmd);\n+\n+    let mut git_commit_cmd = Command::new(\"git\");\n+    git_commit_cmd\n+        .arg(\"commit\")\n+        .arg(\"-m\")\n+        .arg(\"Initial commit\")\n+        .arg(\"-q\")\n+        .current_dir(&sysroot_src);\n+    spawn_and_wait(git_commit_cmd);\n+\n+    apply_patches(\"sysroot\", &sysroot_src);\n+\n+    clone_repo(\n+        \"build_sysroot/compiler-builtins\",\n+        \"https://github.com/rust-lang/compiler-builtins.git\",\n+        \"0.1.46\",\n+    );\n+    apply_patches(\"compiler-builtins\", Path::new(\"build_sysroot/compiler-builtins\"));\n+}\n+\n+fn clone_repo(target_dir: &str, repo: &str, rev: &str) {\n+    eprintln!(\"[CLONE] {}\", repo);\n+    // Ignore exit code as the repo may already have been checked out\n+    Command::new(\"git\").arg(\"clone\").arg(repo).arg(target_dir).spawn().unwrap().wait().unwrap();\n+\n+    let mut clean_cmd = Command::new(\"git\");\n+    clean_cmd.arg(\"checkout\").arg(\"--\").arg(\".\").current_dir(target_dir);\n+    spawn_and_wait(clean_cmd);\n+\n+    let mut checkout_cmd = Command::new(\"git\");\n+    checkout_cmd.arg(\"checkout\").arg(\"-q\").arg(rev).current_dir(target_dir);\n+    spawn_and_wait(checkout_cmd);\n+}\n+\n+fn get_patches(crate_name: &str) -> Vec<OsString> {\n+    let mut patches: Vec<_> = fs::read_dir(\"patches\")\n+        .unwrap()\n+        .map(|entry| entry.unwrap().path())\n+        .filter(|path| path.extension() == Some(OsStr::new(\"patch\")))\n+        .map(|path| path.file_name().unwrap().to_owned())\n+        .filter(|file_name| {\n+            file_name.to_str().unwrap().split_once(\"-\").unwrap().1.starts_with(crate_name)\n+        })\n+        .collect();\n+    patches.sort();\n+    patches\n+}\n+\n+fn apply_patches(crate_name: &str, target_dir: &Path) {\n+    for patch in get_patches(crate_name) {\n+        eprintln!(\"[PATCH] {:?} <- {:?}\", target_dir.file_name().unwrap(), patch);\n+        let patch_arg = env::current_dir().unwrap().join(\"patches\").join(patch);\n+        let mut apply_patch_cmd = Command::new(\"git\");\n+        apply_patch_cmd.arg(\"am\").arg(patch_arg).arg(\"-q\").current_dir(target_dir);\n+        spawn_and_wait(apply_patch_cmd);\n+    }\n+}"}, {"sha": "9206bb02bd3da56da6959cdbbf34cf2e55a93f1c", "filename": "build_system/rustc_info.rs", "status": "added", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Frustc_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Frustc_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Frustc_info.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,65 @@\n+use std::path::{Path, PathBuf};\n+use std::process::{Command, Stdio};\n+\n+pub(crate) fn get_rustc_version() -> String {\n+    let version_info =\n+        Command::new(\"rustc\").stderr(Stdio::inherit()).args(&[\"-V\"]).output().unwrap().stdout;\n+    String::from_utf8(version_info).unwrap()\n+}\n+\n+pub(crate) fn get_host_triple() -> String {\n+    let version_info =\n+        Command::new(\"rustc\").stderr(Stdio::inherit()).args(&[\"-vV\"]).output().unwrap().stdout;\n+    String::from_utf8(version_info)\n+        .unwrap()\n+        .lines()\n+        .to_owned()\n+        .find(|line| line.starts_with(\"host\"))\n+        .unwrap()\n+        .split(\":\")\n+        .nth(1)\n+        .unwrap()\n+        .trim()\n+        .to_owned()\n+}\n+\n+pub(crate) fn get_rustc_path() -> PathBuf {\n+    let rustc_path = Command::new(\"rustup\")\n+        .stderr(Stdio::inherit())\n+        .args(&[\"which\", \"rustc\"])\n+        .output()\n+        .unwrap()\n+        .stdout;\n+    Path::new(String::from_utf8(rustc_path).unwrap().trim()).to_owned()\n+}\n+\n+pub(crate) fn get_default_sysroot() -> PathBuf {\n+    let default_sysroot = Command::new(\"rustc\")\n+        .stderr(Stdio::inherit())\n+        .args(&[\"--print\", \"sysroot\"])\n+        .output()\n+        .unwrap()\n+        .stdout;\n+    Path::new(String::from_utf8(default_sysroot).unwrap().trim()).to_owned()\n+}\n+\n+pub(crate) fn get_file_name(crate_name: &str, crate_type: &str) -> String {\n+    let file_name = Command::new(\"rustc\")\n+        .stderr(Stdio::inherit())\n+        .args(&[\n+            \"--crate-name\",\n+            crate_name,\n+            \"--crate-type\",\n+            crate_type,\n+            \"--print\",\n+            \"file-names\",\n+            \"-\",\n+        ])\n+        .output()\n+        .unwrap()\n+        .stdout;\n+    let file_name = String::from_utf8(file_name).unwrap().trim().to_owned();\n+    assert!(!file_name.contains('\\n'));\n+    assert!(file_name.contains(crate_name));\n+    file_name\n+}"}, {"sha": "12b5d70fad853133384fb064e19fd9a2cb9d189a", "filename": "build_system/utils.rs", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/build_system%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Futils.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,35 @@\n+use std::fs;\n+use std::path::Path;\n+use std::process::{self, Command};\n+\n+#[track_caller]\n+pub(crate) fn try_hard_link(src: impl AsRef<Path>, dst: impl AsRef<Path>) {\n+    let src = src.as_ref();\n+    let dst = dst.as_ref();\n+    if let Err(_) = fs::hard_link(src, dst) {\n+        fs::copy(src, dst).unwrap(); // Fallback to copying if hardlinking failed\n+    }\n+}\n+\n+#[track_caller]\n+pub(crate) fn spawn_and_wait(mut cmd: Command) {\n+    if !cmd.spawn().unwrap().wait().unwrap().success() {\n+        process::exit(1);\n+    }\n+}\n+\n+pub(crate) fn copy_dir_recursively(from: &Path, to: &Path) {\n+    for entry in fs::read_dir(from).unwrap() {\n+        let entry = entry.unwrap();\n+        let filename = entry.file_name();\n+        if filename == \".\" || filename == \"..\" {\n+            continue;\n+        }\n+        if entry.metadata().unwrap().is_dir() {\n+            fs::create_dir(to.join(&filename)).unwrap();\n+            copy_dir_recursively(&from.join(&filename), &to.join(&filename));\n+        } else {\n+            fs::copy(from.join(&filename), to.join(&filename)).unwrap();\n+        }\n+    }\n+}"}, {"sha": "f4f8c82d69f10814a052af9e45b7e79bfc61d301", "filename": "clean_all.sh", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/clean_all.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/clean_all.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clean_all.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,5 +1,6 @@\n #!/usr/bin/env bash\n set -e\n \n-rm -rf target/ build/ build_sysroot/{sysroot_src/,target/,compiler-builtins/} perf.data{,.old}\n+rm -rf build_sysroot/{sysroot_src/,target/,compiler-builtins/,rustc_version}\n+rm -rf target/ build/ perf.data{,.old}\n rm -rf rand/ regex/ simple-raytracer/"}, {"sha": "b14db27d6206fc79ffa1faf4805fea0ab126e92b", "filename": "config.txt", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/config.txt", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/config.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.txt?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,17 @@\n+# This file allows configuring the build system.\n+\n+# Which triple to produce a compiler toolchain for.\n+#\n+# Defaults to the default triple of rustc on the host system.\n+#host = x86_64-unknown-linux-gnu\n+\n+# Which triple to build libraries (core/alloc/std/test/proc_macro) for.\n+#\n+# Defaults to `host`.\n+#target = x86_64-unknown-linux-gnu\n+\n+# Disables cleaning of the sysroot dir. This will cause old compiled artifacts to be re-used when\n+# the sysroot source hasn't changed. This is useful when the codegen backend hasn't been modified.\n+# This option can be changed while the build system is already running for as long as sysroot\n+# building hasn't started yet.\n+#keep_sysroot"}, {"sha": "956d5905a97adfbf460676559a73b32728b06b00", "filename": "docs/usage.md", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/docs%2Fusage.md", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/docs%2Fusage.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fusage.md?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -2,14 +2,14 @@\n \n rustc_codegen_cranelift can be used as a near-drop-in replacement for `cargo build` or `cargo run` for existing projects.\n \n-Assuming `$cg_clif_dir` is the directory you cloned this repo into and you followed the instructions (`prepare.sh` and `build.sh` or `test.sh`).\n+Assuming `$cg_clif_dir` is the directory you cloned this repo into and you followed the instructions (`y.rs prepare` and `y.rs build` or `test.sh`).\n \n ## Cargo\n \n In the directory with your project (where you can do the usual `cargo build`), run:\n \n ```bash\n-$ $cg_clif_dir/build/cargo.sh build\n+$ $cg_clif_dir/build/cargo build\n ```\n \n This will build your project with rustc_codegen_cranelift instead of the usual LLVM backend.\n@@ -30,7 +30,7 @@ In jit mode cg_clif will immediately execute your code without creating an execu\n > The jit mode will probably need cargo integration to make this possible.\n \n ```bash\n-$ $cg_clif_dir/build/cargo.sh jit\n+$ $cg_clif_dir/build/cargo jit\n ```\n \n or\n@@ -40,11 +40,10 @@ $ $cg_clif_dir/build/bin/cg_clif -Cllvm-args=mode=jit -Cprefer-dynamic my_crate.\n ```\n \n There is also an experimental lazy jit mode. In this mode functions are only compiled once they are\n-first called. It currently does not work with multi-threaded programs. When a not yet compiled\n-function is called from another thread than the main thread, you will get an ICE.\n+first called.\n \n ```bash\n-$ $cg_clif_dir/build/cargo.sh lazy-jit\n+$ $cg_clif_dir/build/cargo lazy-jit\n ```\n \n ## Shell"}, {"sha": "d997ce6d1b379044fd3675420e9837739ef0aa10", "filename": "example/mini_core_hello_world.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/example%2Fmini_core_hello_world.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/example%2Fmini_core_hello_world.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/example%2Fmini_core_hello_world.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -292,7 +292,7 @@ fn main() {\n     #[cfg(not(any(jit, windows)))]\n     test_tls();\n \n-    #[cfg(all(not(jit), target_os = \"linux\"))]\n+    #[cfg(all(not(jit), target_arch = \"x86_64\", target_os = \"linux\"))]\n     unsafe {\n         global_asm_test();\n     }\n@@ -303,12 +303,12 @@ fn main() {\n     assert_eq!(*REF1, *REF2);\n }\n \n-#[cfg(all(not(jit), target_os = \"linux\"))]\n+#[cfg(all(not(jit), target_arch = \"x86_64\", target_os = \"linux\"))]\n extern \"C\" {\n     fn global_asm_test();\n }\n \n-#[cfg(all(not(jit), target_os = \"linux\"))]\n+#[cfg(all(not(jit), target_arch = \"x86_64\", target_os = \"linux\"))]\n global_asm! {\n     \"\n     .global global_asm_test"}, {"sha": "5bc51a541b58c7d63b0939976ab2d8869983d24b", "filename": "example/std_example.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/example%2Fstd_example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/example%2Fstd_example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/example%2Fstd_example.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -15,8 +15,6 @@ fn main() {\n     let stderr = ::std::io::stderr();\n     let mut stderr = stderr.lock();\n \n-    // FIXME support lazy jit when multi threading\n-    #[cfg(not(lazy_jit))]\n     std::thread::spawn(move || {\n         println!(\"Hello from another thread!\");\n     });"}, {"sha": "7daea99f5794d2103588c152a0ac02ca1b5b14b1", "filename": "patches/0001-compiler-builtins-Disable-128bit-atomic-operations.patch", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0001-compiler-builtins-Disable-128bit-atomic-operations.patch", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0001-compiler-builtins-Disable-128bit-atomic-operations.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0001-compiler-builtins-Disable-128bit-atomic-operations.patch?ref=fb92375755a00a39a900da50f581917519b5af6b", "previous_filename": "crate_patches/0001-compiler-builtins-Disable-128bit-atomic-operations.patch"}, {"sha": "01dc0fcc5376138bccca396b78e729a5942bf94c", "filename": "patches/0001-rand-Enable-c2-chacha-simd-feature.patch", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0001-rand-Enable-c2-chacha-simd-feature.patch", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0001-rand-Enable-c2-chacha-simd-feature.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0001-rand-Enable-c2-chacha-simd-feature.patch?ref=fb92375755a00a39a900da50f581917519b5af6b", "previous_filename": "crate_patches/0001-rand-Enable-c2-chacha-simd-feature.patch"}, {"sha": "19fd20d7269017cfa1dd21a9db67999d61d4b619", "filename": "patches/0002-rand-Disable-failing-test.patch", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0002-rand-Disable-failing-test.patch", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0002-rand-Disable-failing-test.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0002-rand-Disable-failing-test.patch?ref=fb92375755a00a39a900da50f581917519b5af6b", "previous_filename": "crate_patches/0002-rand-Disable-failing-test.patch"}, {"sha": "ba0eaacd82870fd0a12952989c55b70317ef3b3a", "filename": "patches/0022-sysroot-Disable-not-compiling-tests.patch", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0022-sysroot-Disable-not-compiling-tests.patch", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0022-sysroot-Disable-not-compiling-tests.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0022-sysroot-Disable-not-compiling-tests.patch?ref=fb92375755a00a39a900da50f581917519b5af6b", "previous_filename": "patches/0022-core-Disable-not-compiling-tests.patch"}, {"sha": "5d2c3049f60ebfb03d44e5885d14390d1e0371d2", "filename": "patches/0023-sysroot-Ignore-failing-tests.patch", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0023-sysroot-Ignore-failing-tests.patch", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0023-sysroot-Ignore-failing-tests.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0023-sysroot-Ignore-failing-tests.patch?ref=fb92375755a00a39a900da50f581917519b5af6b", "previous_filename": "patches/0023-core-Ignore-failing-tests.patch"}, {"sha": "32e5930969061f0231ecc6e89c72eb77be7002cb", "filename": "patches/0027-sysroot-128bit-atomic-operations.patch", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0027-sysroot-128bit-atomic-operations.patch", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/patches%2F0027-sysroot-128bit-atomic-operations.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0027-sysroot-128bit-atomic-operations.patch?ref=fb92375755a00a39a900da50f581917519b5af6b", "previous_filename": "patches/0027-Disable-128bit-atomic-operations.patch"}, {"sha": "64c097261c908bf6909aec2789646e998552f4ee", "filename": "prepare.sh", "status": "removed", "additions": 0, "deletions": 29, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/prepare.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/prepare.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/prepare.sh?ref=4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "patch": "@@ -1,29 +0,0 @@\n-#!/usr/bin/env bash\n-set -e\n-\n-./build_sysroot/prepare_sysroot_src.sh\n-cargo install hyperfine || echo \"Skipping hyperfine install\"\n-\n-git clone https://github.com/rust-random/rand.git || echo \"rust-random/rand has already been cloned\"\n-pushd rand\n-git checkout -- .\n-git checkout 0f933f9c7176e53b2a3c7952ded484e1783f0bf1\n-git am ../crate_patches/*-rand-*.patch\n-popd\n-\n-git clone https://github.com/rust-lang/regex.git || echo \"rust-lang/regex has already been cloned\"\n-pushd regex\n-git checkout -- .\n-git checkout 341f207c1071f7290e3f228c710817c280c8dca1\n-popd\n-\n-git clone https://github.com/ebobby/simple-raytracer || echo \"ebobby/simple-raytracer has already been cloned\"\n-pushd simple-raytracer\n-git checkout -- .\n-git checkout 804a7a21b9e673a482797aa289a18ed480e4d813\n-\n-# build with cg_llvm for perf comparison\n-unset CARGO_TARGET_DIR\n-cargo build\n-mv target/debug/main raytracer_cg_llvm\n-popd"}, {"sha": "f806f7bdcd98a72e2c858d5b4f915be04e396bd1", "filename": "rust-toolchain", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/rust-toolchain", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/rust-toolchain", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rust-toolchain?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,3 +1,3 @@\n [toolchain]\n-channel = \"nightly-2021-05-26\"\n+channel = \"nightly-2021-07-07\"\n components = [\"rust-src\", \"rustc-dev\", \"llvm-tools-preview\"]"}, {"sha": "b7e8dd44974794294ac0621138ac6bdf95c1ee56", "filename": "scripts/cargo.rs", "status": "added", "additions": 70, "deletions": 0, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fcargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fcargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fcargo.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,70 @@\n+use std::env;\n+#[cfg(unix)]\n+use std::os::unix::process::CommandExt;\n+use std::path::PathBuf;\n+use std::process::Command;\n+\n+fn main() {\n+    if env::var(\"RUSTC_WRAPPER\").map_or(false, |wrapper| wrapper.contains(\"sccache\")) {\n+        eprintln!(\n+            \"\\x1b[1;93m=== Warning: Unsetting RUSTC_WRAPPER to prevent interference with sccache ===\\x1b[0m\"\n+        );\n+        env::remove_var(\"RUSTC_WRAPPER\");\n+    }\n+\n+    let sysroot = PathBuf::from(env::current_exe().unwrap().parent().unwrap());\n+\n+    env::set_var(\"RUSTC\", sysroot.join(\"bin/cg_clif\".to_string() + env::consts::EXE_SUFFIX));\n+\n+    let mut rustdoc_flags = env::var(\"RUSTDOCFLAGS\").unwrap_or(String::new());\n+    rustdoc_flags.push_str(\" -Cpanic=abort -Zpanic-abort-tests -Zcodegen-backend=\");\n+    rustdoc_flags.push_str(\n+        sysroot\n+            .join(if cfg!(windows) { \"bin\" } else { \"lib\" })\n+            .join(\n+                env::consts::DLL_PREFIX.to_string()\n+                    + \"rustc_codegen_cranelift\"\n+                    + env::consts::DLL_SUFFIX,\n+            )\n+            .to_str()\n+            .unwrap(),\n+    );\n+    rustdoc_flags.push_str(\" --sysroot \");\n+    rustdoc_flags.push_str(sysroot.to_str().unwrap());\n+    env::set_var(\"RUSTDOCFLAGS\", rustdoc_flags);\n+\n+    // Ensure that the right toolchain is used\n+    env::set_var(\"RUSTUP_TOOLCHAIN\", env!(\"RUSTUP_TOOLCHAIN\"));\n+\n+    let args: Vec<_> = match env::args().nth(1).as_deref() {\n+        Some(\"jit\") => {\n+            env::set_var(\n+                \"RUSTFLAGS\",\n+                env::var(\"RUSTFLAGS\").unwrap_or(String::new()) + \" -Cprefer-dynamic\",\n+            );\n+            std::array::IntoIter::new([\"rustc\".to_string()])\n+                .chain(env::args().skip(2))\n+                .chain([\"--\".to_string(), \"-Cllvm-args=mode=jit\".to_string()])\n+                .collect()\n+        }\n+        Some(\"lazy-jit\") => {\n+            env::set_var(\n+                \"RUSTFLAGS\",\n+                env::var(\"RUSTFLAGS\").unwrap_or(String::new()) + \" -Cprefer-dynamic\",\n+            );\n+            std::array::IntoIter::new([\"rustc\".to_string()])\n+                .chain(env::args().skip(2))\n+                .chain([\"--\".to_string(), \"-Cllvm-args=mode=jit-lazy\".to_string()])\n+                .collect()\n+        }\n+        _ => env::args().skip(1).collect(),\n+    };\n+\n+    #[cfg(unix)]\n+    Command::new(\"cargo\").args(args).exec();\n+\n+    #[cfg(not(unix))]\n+    std::process::exit(\n+        Command::new(\"cargo\").args(args).spawn().unwrap().wait().unwrap().code().unwrap_or(1),\n+    );\n+}"}, {"sha": "1daa5a78f7bd25e6396d21b3e92d7fe336171f83", "filename": "scripts/cargo.sh", "status": "removed", "additions": 0, "deletions": 18, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/scripts%2Fcargo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b/scripts%2Fcargo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fcargo.sh?ref=4cfa1fcb5b566e9bbe24fafb77027a39685dfe6b", "patch": "@@ -1,18 +0,0 @@\n-#!/usr/bin/env bash\n-\n-dir=$(dirname \"$0\")\n-source \"$dir/config.sh\"\n-\n-# read nightly compiler from rust-toolchain file\n-TOOLCHAIN=$(cat \"$dir/rust-toolchain\" | grep channel | sed \"s/channel = \\\"\\(.*\\)\\\"/\\1/\")\n-\n-cmd=$1\n-shift || true\n-\n-if [[ \"$cmd\" = \"jit\" ]]; then\n-cargo \"+${TOOLCHAIN}\" rustc \"$@\" -- -Cllvm-args=mode=jit -Cprefer-dynamic\n-elif [[ \"$cmd\" = \"lazy-jit\" ]]; then\n-cargo \"+${TOOLCHAIN}\" rustc \"$@\" -- -Cllvm-args=mode=jit-lazy -Cprefer-dynamic\n-else\n-cargo \"+${TOOLCHAIN}\" \"$cmd\" \"$@\"\n-fi"}, {"sha": "53ada369b089a28ee63b3c183603a36153239821", "filename": "scripts/config.sh", "status": "modified", "additions": 2, "deletions": 23, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fconfig.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fconfig.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fconfig.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -2,26 +2,5 @@\n \n set -e\n \n-dylib=$(echo \"\" | rustc --print file-names --crate-type dylib --crate-name rustc_codegen_cranelift -)\n-\n-if echo \"$RUSTC_WRAPPER\" | grep sccache; then\n-echo\n-echo -e \"\\x1b[1;93m=== Warning: Unset RUSTC_WRAPPER to prevent interference with sccache ===\\x1b[0m\"\n-echo\n-export RUSTC_WRAPPER=\n-fi\n-\n-dir=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\"; pwd)\n-\n-export RUSTC=$dir\"/bin/cg_clif\"\n-\n-export RUSTDOCFLAGS=$linker' -Cpanic=abort -Zpanic-abort-tests '\\\n-'-Zcodegen-backend='$dir'/lib/'$dylib' --sysroot '$dir\n-\n-# FIXME fix `#[linkage = \"extern_weak\"]` without this\n-if [[ \"$(uname)\" == 'Darwin' ]]; then\n-   export RUSTFLAGS=\"$RUSTFLAGS -Clink-arg=-undefined -Clink-arg=dynamic_lookup\"\n-fi\n-\n-export LD_LIBRARY_PATH=\"$(rustc --print sysroot)/lib:\"$dir\"/lib\"\n-export DYLD_LIBRARY_PATH=$LD_LIBRARY_PATH\n+export LD_LIBRARY_PATH=\"$(rustc --print sysroot)/lib:$LD_LIBRARY_PATH\"\n+export DYLD_LIBRARY_PATH=\"$(rustc --print sysroot)/lib:$DYLD_LIBRARY_PATH\""}, {"sha": "11d6c4c83186743f2751a2403c2996eab66746be", "filename": "scripts/ext_config.sh", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fext_config.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fext_config.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fext_config.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,6 +1,6 @@\n # Note to people running shellcheck: this file should only be sourced, not executed directly.\n \n-# Various env vars that should only be set for the build system but not for cargo.sh\n+# Various env vars that should only be set for the build system\n \n set -e\n \n@@ -25,3 +25,8 @@ if [[ \"$HOST_TRIPLE\" != \"$TARGET_TRIPLE\" ]]; then\n       echo \"Unknown non-native platform\"\n    fi\n fi\n+\n+# FIXME fix `#[linkage = \"extern_weak\"]` without this\n+if [[ \"$(uname)\" == 'Darwin' ]]; then\n+   export RUSTFLAGS=\"$RUSTFLAGS -Clink-arg=-undefined -Clink-arg=dynamic_lookup\"\n+fi"}, {"sha": "9e196afbe4f57c38b36576fb9621f4cee56373b5", "filename": "scripts/filter_profile.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Ffilter_profile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Ffilter_profile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ffilter_profile.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -2,9 +2,10 @@\n #![forbid(unsafe_code)]/* This line is ignored by bash\n # This block is ignored by rustc\n pushd $(dirname \"$0\")/../\n-source build/config.sh\n+source scripts/config.sh\n+RUSTC=\"$(pwd)/build/bin/cg_clif\"\n popd\n-PROFILE=$1 OUTPUT=$2 exec $RUSTC $RUSTFLAGS -Cllvm-args=mode=jit -Cprefer-dynamic $0\n+PROFILE=$1 OUTPUT=$2 exec $RUSTC -Cllvm-args=mode=jit -Cprefer-dynamic $0\n #*/\n \n //! This program filters away uninteresting samples and trims uninteresting frames for stackcollapse"}, {"sha": "cc34c08088665bc19cdea842e961593052c28e50", "filename": "scripts/rustup.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Frustup.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Frustup.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Frustup.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -17,7 +17,7 @@ case $1 in\n         done\n \n         ./clean_all.sh\n-        ./prepare.sh\n+        ./y.rs prepare\n \n         (cd build_sysroot && cargo update)\n "}, {"sha": "52adaaa8de673d3661903b9353ed96ec1bbbb5dc", "filename": "scripts/setup_rust_fork.sh", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fsetup_rust_fork.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Fsetup_rust_fork.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fsetup_rust_fork.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,8 +1,8 @@\n #!/bin/bash\n set -e\n \n-./build.sh\n-source build/config.sh\n+./y.rs build\n+source scripts/config.sh\n \n echo \"[SETUP] Rust fork\"\n git clone https://github.com/rust-lang/rust.git || true\n@@ -33,7 +33,7 @@ index d95b5b7f17f..00b6f0e3635 100644\n  [dependencies]\n  core = { path = \"../core\" }\n -compiler_builtins = { version = \"0.1.40\", features = ['rustc-dep-of-std'] }\n-+compiler_builtins = { version = \"0.1.43\", features = ['rustc-dep-of-std', 'no-asm'] }\n++compiler_builtins = { version = \"0.1.45\", features = ['rustc-dep-of-std', 'no-asm'] }\n \n  [dev-dependencies]\n  rand = \"0.7\""}, {"sha": "2f5c2cf737b056be7560f2caa6d6c7d0d6160a8c", "filename": "scripts/test_rustc_tests.sh", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Ftest_rustc_tests.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Ftest_rustc_tests.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ftest_rustc_tests.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -38,7 +38,8 @@ rm src/test/ui/threads-sendsync/task-stderr.rs\n rm src/test/ui/numbers-arithmetic/int-abs-overflow.rs\n rm src/test/ui/drop/drop-trait-enum.rs\n rm src/test/ui/numbers-arithmetic/issue-8460.rs\n-rm src/test/incremental/change_crate_dep_kind.rs # requires -Cpanic=unwind\n+rm src/test/ui/rt-explody-panic-payloads.rs\n+rm src/test/incremental/change_crate_dep_kind.rs\n \n rm src/test/ui/issues/issue-28950.rs # depends on stack size optimizations\n rm src/test/ui/init-large-type.rs # same\n@@ -64,6 +65,7 @@ rm src/test/incremental/lto.rs # requires lto\n \n rm -r src/test/run-make/emit-shared-files # requires the rustdoc executable in build/bin/\n rm -r src/test/run-make/unstable-flag-required # same\n+rm -r src/test/run-make/emit-named-files # requires full --emit support\n \n rm src/test/pretty/asm.rs # inline asm\n rm src/test/pretty/raw-str-nonexpr.rs # same"}, {"sha": "5df04c533a70e38fb009dec4ec62f337e0a87a38", "filename": "scripts/tests.sh", "status": "modified", "additions": 19, "deletions": 17, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Ftests.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/scripts%2Ftests.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ftests.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -2,9 +2,10 @@\n \n set -e\n \n-source build/config.sh\n+source scripts/config.sh\n source scripts/ext_config.sh\n-MY_RUSTC=\"$RUSTC $RUSTFLAGS -L crate=target/out --out-dir target/out -Cdebuginfo=2\"\n+export RUSTC=false # ensure that cg_llvm isn't accidentally used\n+MY_RUSTC=\"$(pwd)/build/bin/cg_clif $RUSTFLAGS -L crate=target/out --out-dir target/out -Cdebuginfo=2\"\n \n function no_sysroot_tests() {\n     echo \"[BUILD] mini_core\"\n@@ -46,7 +47,7 @@ function base_sysroot_tests() {\n         $MY_RUSTC -Cllvm-args=mode=jit -Cprefer-dynamic example/std_example.rs --target \"$HOST_TRIPLE\"\n \n         echo \"[JIT-lazy] std_example\"\n-        $MY_RUSTC -Cllvm-args=mode=jit-lazy -Cprefer-dynamic example/std_example.rs --cfg lazy_jit --target \"$HOST_TRIPLE\"\n+        $MY_RUSTC -Cllvm-args=mode=jit-lazy -Cprefer-dynamic example/std_example.rs --target \"$HOST_TRIPLE\"\n     else\n         echo \"[JIT] std_example (skipped)\"\n     fi\n@@ -75,63 +76,64 @@ function base_sysroot_tests() {\n \n function extended_sysroot_tests() {\n     pushd rand\n-    cargo clean\n+    ../build/cargo clean\n     if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n         echo \"[TEST] rust-random/rand\"\n-        ../build/cargo.sh test --workspace\n+        ../build/cargo test --workspace\n     else\n         echo \"[AOT] rust-random/rand\"\n-        ../build/cargo.sh build --workspace --target $TARGET_TRIPLE --tests\n+        ../build/cargo build --workspace --target $TARGET_TRIPLE --tests\n     fi\n     popd\n \n     pushd simple-raytracer\n     if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n         echo \"[BENCH COMPILE] ebobby/simple-raytracer\"\n-        hyperfine --runs \"${RUN_RUNS:-10}\" --warmup 1 --prepare \"cargo clean\" \\\n+        hyperfine --runs \"${RUN_RUNS:-10}\" --warmup 1 --prepare \"../build/cargo clean\" \\\n         \"RUSTC=rustc RUSTFLAGS='' cargo build\" \\\n-        \"../build/cargo.sh build\"\n+        \"../build/cargo build\"\n \n         echo \"[BENCH RUN] ebobby/simple-raytracer\"\n         cp ./target/debug/main ./raytracer_cg_clif\n         hyperfine --runs \"${RUN_RUNS:-10}\" ./raytracer_cg_llvm ./raytracer_cg_clif\n     else\n+        ../build/cargo clean\n         echo \"[BENCH COMPILE] ebobby/simple-raytracer (skipped)\"\n         echo \"[COMPILE] ebobby/simple-raytracer\"\n-        ../build/cargo.sh build --target $TARGET_TRIPLE\n+        ../build/cargo build --target $TARGET_TRIPLE\n         echo \"[BENCH RUN] ebobby/simple-raytracer (skipped)\"\n     fi\n     popd\n \n     pushd build_sysroot/sysroot_src/library/core/tests\n     echo \"[TEST] libcore\"\n-    cargo clean\n+    ../../../../../build/cargo clean\n     if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n-        ../../../../../build/cargo.sh test\n+        ../../../../../build/cargo test\n     else\n-        ../../../../../build/cargo.sh build --target $TARGET_TRIPLE --tests\n+        ../../../../../build/cargo build --target $TARGET_TRIPLE --tests\n     fi\n     popd\n \n     pushd regex\n     echo \"[TEST] rust-lang/regex example shootout-regex-dna\"\n-    cargo clean\n+    ../build/cargo clean\n     export RUSTFLAGS=\"$RUSTFLAGS --cap-lints warn\" # newer aho_corasick versions throw a deprecation warning\n     # Make sure `[codegen mono items] start` doesn't poison the diff\n-    ../build/cargo.sh build --example shootout-regex-dna --target $TARGET_TRIPLE\n+    ../build/cargo build --example shootout-regex-dna --target $TARGET_TRIPLE\n     if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n         cat examples/regexdna-input.txt \\\n-            | ../build/cargo.sh run --example shootout-regex-dna --target $TARGET_TRIPLE \\\n+            | ../build/cargo run --example shootout-regex-dna --target $TARGET_TRIPLE \\\n             | grep -v \"Spawned thread\" > res.txt\n         diff -u res.txt examples/regexdna-output.txt\n     fi\n \n     if [[ \"$HOST_TRIPLE\" = \"$TARGET_TRIPLE\" ]]; then\n         echo \"[TEST] rust-lang/regex tests\"\n-        ../build/cargo.sh test --tests -- --exclude-should-panic --test-threads 1 -Zunstable-options -q\n+        ../build/cargo test --tests -- --exclude-should-panic --test-threads 1 -Zunstable-options -q\n     else\n         echo \"[AOT] rust-lang/regex tests\"\n-        ../build/cargo.sh build --tests --target $TARGET_TRIPLE\n+        ../build/cargo build --tests --target $TARGET_TRIPLE\n     fi\n     popd\n }"}, {"sha": "3d78eed77b94c373cfe533920501dbabb6f99470", "filename": "src/base.rs", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbase.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -21,6 +21,11 @@ pub(crate) fn codegen_fn<'tcx>(\n     debug_assert!(!instance.substs.needs_infer());\n \n     let mir = tcx.instance_mir(instance.def);\n+    let _mir_guard = crate::PrintOnPanic(|| {\n+        let mut buf = Vec::new();\n+        rustc_mir::util::write_mir_pretty(tcx, Some(instance.def_id()), &mut buf).unwrap();\n+        String::from_utf8_lossy(&buf).into_owned()\n+    });\n \n     // Declare function\n     let symbol_name = tcx.symbol_name(instance);\n@@ -52,7 +57,6 @@ pub(crate) fn codegen_fn<'tcx>(\n         module,\n         tcx,\n         pointer_type,\n-        vtables: FxHashMap::default(),\n         constants_cx: ConstantCx::new(),\n \n         instance,\n@@ -105,7 +109,14 @@ pub(crate) fn codegen_fn<'tcx>(\n     let context = &mut cx.cached_context;\n     context.func = func;\n \n-    crate::pretty_clif::write_clif_file(tcx, \"unopt\", None, instance, &context, &clif_comments);\n+    crate::pretty_clif::write_clif_file(\n+        tcx,\n+        \"unopt\",\n+        module.isa(),\n+        instance,\n+        &context,\n+        &clif_comments,\n+    );\n \n     // Verify function\n     verify_func(tcx, &clif_comments, &context.func);\n@@ -122,7 +133,13 @@ pub(crate) fn codegen_fn<'tcx>(\n \n     // Perform rust specific optimizations\n     tcx.sess.time(\"optimize clif ir\", || {\n-        crate::optimize::optimize_function(tcx, instance, context, &mut clif_comments);\n+        crate::optimize::optimize_function(\n+            tcx,\n+            module.isa(),\n+            instance,\n+            context,\n+            &mut clif_comments,\n+        );\n     });\n \n     // Define function\n@@ -137,7 +154,7 @@ pub(crate) fn codegen_fn<'tcx>(\n     crate::pretty_clif::write_clif_file(\n         tcx,\n         \"opt\",\n-        Some(module.isa()),\n+        module.isa(),\n         instance,\n         &context,\n         &clif_comments,"}, {"sha": "a044b43b86470a3c3e83f99ea5eb0cec9d4ea92e", "filename": "src/bin/cg_clif.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fbin%2Fcg_clif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fbin%2Fcg_clif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fcg_clif.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -6,8 +6,8 @@ extern crate rustc_interface;\n extern crate rustc_session;\n extern crate rustc_target;\n \n-use std::panic;\n use std::lazy::SyncLazy;\n+use std::panic;\n \n use rustc_data_structures::profiling::{get_resident_set_size, print_time_passes_entry};\n use rustc_interface::interface;"}, {"sha": "892ccf27f6df893f713a62e9cf387f951848da98", "filename": "src/common.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcommon.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -233,7 +233,6 @@ pub(crate) struct FunctionCx<'m, 'clif, 'tcx: 'm> {\n     pub(crate) module: &'m mut dyn Module,\n     pub(crate) tcx: TyCtxt<'tcx>,\n     pub(crate) pointer_type: Type, // Cached from module\n-    pub(crate) vtables: FxHashMap<(Ty<'tcx>, Option<ty::PolyExistentialTraitRef<'tcx>>), Pointer>,\n     pub(crate) constants_cx: ConstantCx,\n \n     pub(crate) instance: Instance<'tcx>,"}, {"sha": "2a2573aad295025f14f1d743c63b64845d9412db", "filename": "src/constant.rs", "status": "modified", "additions": 76, "deletions": 65, "changes": 141, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconstant.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,16 +1,13 @@\n //! Handling of `static`s, `const`s and promoted allocations\n \n-use rustc_span::DUMMY_SP;\n-\n-use rustc_ast::Mutability;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_errors::ErrorReported;\n use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use rustc_middle::mir::interpret::{\n-    alloc_range, read_target_uint, AllocId, Allocation, ConstValue, ErrorHandled, GlobalAlloc,\n-    Scalar,\n+    read_target_uint, AllocId, Allocation, ConstValue, ErrorHandled, GlobalAlloc, Scalar,\n };\n use rustc_middle::ty::ConstKind;\n+use rustc_span::DUMMY_SP;\n \n use cranelift_codegen::ir::GlobalValueData;\n use cranelift_module::*;\n@@ -171,66 +168,74 @@ pub(crate) fn codegen_const_value<'tcx>(\n     }\n \n     match const_val {\n-        ConstValue::Scalar(x) => {\n-            if fx.clif_type(layout.ty).is_none() {\n-                let (size, align) = (layout.size, layout.align.pref);\n-                let mut alloc = Allocation::from_bytes(\n-                    std::iter::repeat(0).take(size.bytes_usize()).collect::<Vec<u8>>(),\n-                    align,\n-                    Mutability::Not,\n-                );\n-                alloc.write_scalar(fx, alloc_range(Size::ZERO, size), x.into()).unwrap();\n-                let alloc = fx.tcx.intern_const_alloc(alloc);\n-                return CValue::by_ref(pointer_for_allocation(fx, alloc), layout);\n-            }\n-\n-            match x {\n-                Scalar::Int(int) => CValue::const_val(fx, layout, int),\n-                Scalar::Ptr(ptr) => {\n-                    let alloc_kind = fx.tcx.get_global_alloc(ptr.alloc_id);\n-                    let base_addr = match alloc_kind {\n-                        Some(GlobalAlloc::Memory(alloc)) => {\n-                            fx.constants_cx.todo.push(TodoItem::Alloc(ptr.alloc_id));\n-                            let data_id = data_id_for_alloc_id(\n-                                &mut fx.constants_cx,\n-                                fx.module,\n-                                ptr.alloc_id,\n-                                alloc.mutability,\n-                            );\n-                            let local_data_id =\n-                                fx.module.declare_data_in_func(data_id, &mut fx.bcx.func);\n-                            if fx.clif_comments.enabled() {\n-                                fx.add_comment(local_data_id, format!(\"{:?}\", ptr.alloc_id));\n-                            }\n-                            fx.bcx.ins().global_value(fx.pointer_type, local_data_id)\n-                        }\n-                        Some(GlobalAlloc::Function(instance)) => {\n-                            let func_id = crate::abi::import_function(fx.tcx, fx.module, instance);\n-                            let local_func_id =\n-                                fx.module.declare_func_in_func(func_id, &mut fx.bcx.func);\n-                            fx.bcx.ins().func_addr(fx.pointer_type, local_func_id)\n-                        }\n-                        Some(GlobalAlloc::Static(def_id)) => {\n-                            assert!(fx.tcx.is_static(def_id));\n-                            let data_id = data_id_for_static(fx.tcx, fx.module, def_id, false);\n-                            let local_data_id =\n-                                fx.module.declare_data_in_func(data_id, &mut fx.bcx.func);\n-                            if fx.clif_comments.enabled() {\n-                                fx.add_comment(local_data_id, format!(\"{:?}\", def_id));\n-                            }\n-                            fx.bcx.ins().global_value(fx.pointer_type, local_data_id)\n+        ConstValue::Scalar(x) => match x {\n+            Scalar::Int(int) => {\n+                if fx.clif_type(layout.ty).is_some() {\n+                    return CValue::const_val(fx, layout, int);\n+                } else {\n+                    let raw_val = int.to_bits(int.size()).unwrap();\n+                    let val = match int.size().bytes() {\n+                        1 => fx.bcx.ins().iconst(types::I8, raw_val as i64),\n+                        2 => fx.bcx.ins().iconst(types::I16, raw_val as i64),\n+                        4 => fx.bcx.ins().iconst(types::I32, raw_val as i64),\n+                        8 => fx.bcx.ins().iconst(types::I64, raw_val as i64),\n+                        16 => {\n+                            let lsb = fx.bcx.ins().iconst(types::I64, raw_val as u64 as i64);\n+                            let msb =\n+                                fx.bcx.ins().iconst(types::I64, (raw_val >> 64) as u64 as i64);\n+                            fx.bcx.ins().iconcat(lsb, msb)\n                         }\n-                        None => bug!(\"missing allocation {:?}\", ptr.alloc_id),\n-                    };\n-                    let val = if ptr.offset.bytes() != 0 {\n-                        fx.bcx.ins().iadd_imm(base_addr, i64::try_from(ptr.offset.bytes()).unwrap())\n-                    } else {\n-                        base_addr\n+                        _ => unreachable!(),\n                     };\n-                    CValue::by_val(val, layout)\n+\n+                    let place = CPlace::new_stack_slot(fx, layout);\n+                    place.to_ptr().store(fx, val, MemFlags::trusted());\n+                    place.to_cvalue(fx)\n                 }\n             }\n-        }\n+            Scalar::Ptr(ptr) => {\n+                let alloc_kind = fx.tcx.get_global_alloc(ptr.alloc_id);\n+                let base_addr = match alloc_kind {\n+                    Some(GlobalAlloc::Memory(alloc)) => {\n+                        let data_id = data_id_for_alloc_id(\n+                            &mut fx.constants_cx,\n+                            fx.module,\n+                            ptr.alloc_id,\n+                            alloc.mutability,\n+                        );\n+                        let local_data_id =\n+                            fx.module.declare_data_in_func(data_id, &mut fx.bcx.func);\n+                        if fx.clif_comments.enabled() {\n+                            fx.add_comment(local_data_id, format!(\"{:?}\", ptr.alloc_id));\n+                        }\n+                        fx.bcx.ins().global_value(fx.pointer_type, local_data_id)\n+                    }\n+                    Some(GlobalAlloc::Function(instance)) => {\n+                        let func_id = crate::abi::import_function(fx.tcx, fx.module, instance);\n+                        let local_func_id =\n+                            fx.module.declare_func_in_func(func_id, &mut fx.bcx.func);\n+                        fx.bcx.ins().func_addr(fx.pointer_type, local_func_id)\n+                    }\n+                    Some(GlobalAlloc::Static(def_id)) => {\n+                        assert!(fx.tcx.is_static(def_id));\n+                        let data_id = data_id_for_static(fx.tcx, fx.module, def_id, false);\n+                        let local_data_id =\n+                            fx.module.declare_data_in_func(data_id, &mut fx.bcx.func);\n+                        if fx.clif_comments.enabled() {\n+                            fx.add_comment(local_data_id, format!(\"{:?}\", def_id));\n+                        }\n+                        fx.bcx.ins().global_value(fx.pointer_type, local_data_id)\n+                    }\n+                    None => bug!(\"missing allocation {:?}\", ptr.alloc_id),\n+                };\n+                let val = if ptr.offset.bytes() != 0 {\n+                    fx.bcx.ins().iadd_imm(base_addr, i64::try_from(ptr.offset.bytes()).unwrap())\n+                } else {\n+                    base_addr\n+                };\n+                CValue::by_val(val, layout)\n+            }\n+        },\n         ConstValue::ByRef { alloc, offset } => CValue::by_ref(\n             pointer_for_allocation(fx, alloc)\n                 .offset_i64(fx, i64::try_from(offset.bytes()).unwrap()),\n@@ -254,7 +259,6 @@ pub(crate) fn pointer_for_allocation<'tcx>(\n     alloc: &'tcx Allocation,\n ) -> crate::pointer::Pointer {\n     let alloc_id = fx.tcx.create_memory_alloc(alloc);\n-    fx.constants_cx.todo.push(TodoItem::Alloc(alloc_id));\n     let data_id =\n         data_id_for_alloc_id(&mut fx.constants_cx, &mut *fx.module, alloc_id, alloc.mutability);\n \n@@ -266,12 +270,13 @@ pub(crate) fn pointer_for_allocation<'tcx>(\n     crate::pointer::Pointer::new(global_ptr)\n }\n \n-fn data_id_for_alloc_id(\n+pub(crate) fn data_id_for_alloc_id(\n     cx: &mut ConstantCx,\n     module: &mut dyn Module,\n     alloc_id: AllocId,\n     mutability: rustc_hir::Mutability,\n ) -> DataId {\n+    cx.todo.push(TodoItem::Alloc(alloc_id));\n     *cx.anon_allocs.entry(alloc_id).or_insert_with(|| {\n         module.declare_anonymous_data(mutability == rustc_hir::Mutability::Mut, false).unwrap()\n     })\n@@ -352,7 +357,14 @@ fn define_all_allocs(tcx: TyCtxt<'_>, module: &mut dyn Module, cx: &mut Constant\n                     GlobalAlloc::Memory(alloc) => alloc,\n                     GlobalAlloc::Function(_) | GlobalAlloc::Static(_) => unreachable!(),\n                 };\n-                let data_id = data_id_for_alloc_id(cx, module, alloc_id, alloc.mutability);\n+                let data_id = *cx.anon_allocs.entry(alloc_id).or_insert_with(|| {\n+                    module\n+                        .declare_anonymous_data(\n+                            alloc.mutability == rustc_hir::Mutability::Mut,\n+                            false,\n+                        )\n+                        .unwrap()\n+                });\n                 (data_id, alloc, None)\n             }\n             TodoItem::Static(def_id) => {\n@@ -415,7 +427,6 @@ fn define_all_allocs(tcx: TyCtxt<'_>, module: &mut dyn Module, cx: &mut Constant\n                     continue;\n                 }\n                 GlobalAlloc::Memory(target_alloc) => {\n-                    cx.todo.push(TodoItem::Alloc(reloc));\n                     data_id_for_alloc_id(cx, module, reloc, target_alloc.mutability)\n                 }\n                 GlobalAlloc::Static(def_id) => {"}, {"sha": "c7e15f81e030104c33ff6663ca8806307dcbf7ed", "filename": "src/debuginfo/line_info.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdebuginfo%2Fline_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdebuginfo%2Fline_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdebuginfo%2Fline_info.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -10,7 +10,7 @@ use rustc_span::{\n };\n \n use cranelift_codegen::binemit::CodeOffset;\n-use cranelift_codegen::machinst::MachSrcLoc;\n+use cranelift_codegen::MachSrcLoc;\n \n use gimli::write::{\n     Address, AttributeValue, FileId, FileInfo, LineProgram, LineString, LineStringTable,"}, {"sha": "c67336eb3f2c3125ee0427511991fbd3d01d2e09", "filename": "src/debuginfo/mod.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdebuginfo%2Fmod.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -61,9 +61,11 @@ impl<'tcx> DebugContext<'tcx> {\n \n         let mut dwarf = DwarfUnit::new(encoding);\n \n-        // FIXME: how to get version when building out of tree?\n-        // Normally this would use option_env!(\"CFG_VERSION\").\n-        let producer = format!(\"cg_clif (rustc {})\", \"unknown version\");\n+        let producer = format!(\n+            \"cg_clif (rustc {}, cranelift {})\",\n+            rustc_interface::util::version_str().unwrap_or(\"unknown version\"),\n+            cranelift_codegen::VERSION,\n+        );\n         let comp_dir = tcx.sess.working_dir.to_string_lossy(false).into_owned();\n         let (name, file_info) = match tcx.sess.local_crate_source_file.clone() {\n             Some(path) => {"}, {"sha": "a8b802f449437622770ff9426fd524ac4273c1f2", "filename": "src/driver/aot.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdriver%2Faot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdriver%2Faot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver%2Faot.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -289,13 +289,16 @@ pub(crate) fn run_aot(\n         None\n     };\n \n+    // FIXME handle `-Ctarget-cpu=native`\n+    let target_cpu =\n+        tcx.sess.opts.cg.target_cpu.as_ref().unwrap_or(&tcx.sess.target.cpu).to_owned();\n     Box::new((\n         CodegenResults {\n             modules,\n             allocator_module,\n             metadata_module,\n             metadata,\n-            crate_info: CrateInfo::new(tcx, crate::target_triple(tcx.sess).to_string()),\n+            crate_info: CrateInfo::new(tcx, target_cpu),\n         },\n         work_products,\n     ))"}, {"sha": "76fbc9ad51e8ec8af1b9665ed2194a4b18f145a4", "filename": "src/driver/jit.rs", "status": "modified", "additions": 107, "deletions": 20, "changes": 127, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdriver%2Fjit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fdriver%2Fjit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver%2Fjit.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -3,11 +3,14 @@\n \n use std::cell::RefCell;\n use std::ffi::CString;\n+use std::lazy::{Lazy, SyncOnceCell};\n use std::os::raw::{c_char, c_int};\n+use std::sync::{mpsc, Mutex};\n \n use cranelift_codegen::binemit::{NullStackMapSink, NullTrapSink};\n use rustc_codegen_ssa::CrateInfo;\n use rustc_middle::mir::mono::MonoItem;\n+use rustc_session::Session;\n \n use cranelift_jit::{JITBuilder, JITModule};\n \n@@ -23,12 +26,48 @@ thread_local! {\n     static LAZY_JIT_STATE: RefCell<Option<JitState>> = RefCell::new(None);\n }\n \n+/// The Sender owned by the rustc thread\n+static GLOBAL_MESSAGE_SENDER: SyncOnceCell<Mutex<mpsc::Sender<UnsafeMessage>>> =\n+    SyncOnceCell::new();\n+\n+/// A message that is sent from the jitted runtime to the rustc thread.\n+/// Senders are responsible for upholding `Send` semantics.\n+enum UnsafeMessage {\n+    /// Request that the specified `Instance` be lazily jitted.\n+    ///\n+    /// Nothing accessible through `instance_ptr` may be moved or mutated by the sender after\n+    /// this message is sent.\n+    JitFn {\n+        instance_ptr: *const Instance<'static>,\n+        trampoline_ptr: *const u8,\n+        tx: mpsc::Sender<*const u8>,\n+    },\n+}\n+unsafe impl Send for UnsafeMessage {}\n+\n+impl UnsafeMessage {\n+    /// Send the message.\n+    fn send(self) -> Result<(), mpsc::SendError<UnsafeMessage>> {\n+        thread_local! {\n+            /// The Sender owned by the local thread\n+            static LOCAL_MESSAGE_SENDER: Lazy<mpsc::Sender<UnsafeMessage>> = Lazy::new(||\n+                GLOBAL_MESSAGE_SENDER\n+                    .get().unwrap()\n+                    .lock().unwrap()\n+                    .clone()\n+            );\n+        }\n+        LOCAL_MESSAGE_SENDER.with(|sender| sender.send(self))\n+    }\n+}\n+\n fn create_jit_module<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     backend_config: &BackendConfig,\n     hotswap: bool,\n ) -> (JITModule, CodegenCx<'tcx>) {\n-    let imported_symbols = load_imported_symbols_for_jit(tcx);\n+    let crate_info = CrateInfo::new(tcx, \"dummy_target_cpu\".to_string());\n+    let imported_symbols = load_imported_symbols_for_jit(tcx.sess, crate_info);\n \n     let isa = crate::build_isa(tcx.sess, backend_config);\n     let mut jit_builder = JITBuilder::with_isa(isa, cranelift_module::default_libcall_names());\n@@ -116,19 +155,14 @@ pub(crate) fn run_jit(tcx: TyCtxt<'_>, backend_config: BackendConfig) -> ! {\n         .chain(backend_config.jit_args.iter().map(|arg| &**arg))\n         .map(|arg| CString::new(arg).unwrap())\n         .collect::<Vec<_>>();\n-    let mut argv = args.iter().map(|arg| arg.as_ptr()).collect::<Vec<_>>();\n-\n-    // Push a null pointer as a terminating argument. This is required by POSIX and\n-    // useful as some dynamic linkers use it as a marker to jump over.\n-    argv.push(std::ptr::null());\n \n     let start_sig = Signature {\n         params: vec![\n             AbiParam::new(jit_module.target_config().pointer_type()),\n             AbiParam::new(jit_module.target_config().pointer_type()),\n         ],\n         returns: vec![AbiParam::new(jit_module.target_config().pointer_type() /*isize*/)],\n-        call_conv: CallConv::triple_default(&crate::target_triple(tcx.sess)),\n+        call_conv: jit_module.target_config().default_call_conv,\n     };\n     let start_func_id = jit_module.declare_function(\"main\", Linkage::Import, &start_sig).unwrap();\n     let finalized_start: *const u8 = jit_module.get_finalized_function(start_func_id);\n@@ -141,12 +175,51 @@ pub(crate) fn run_jit(tcx: TyCtxt<'_>, backend_config: BackendConfig) -> ! {\n \n     let f: extern \"C\" fn(c_int, *const *const c_char) -> c_int =\n         unsafe { ::std::mem::transmute(finalized_start) };\n-    let ret = f(args.len() as c_int, argv.as_ptr());\n-    std::process::exit(ret);\n+\n+    let (tx, rx) = mpsc::channel();\n+    GLOBAL_MESSAGE_SENDER.set(Mutex::new(tx)).unwrap();\n+\n+    // Spawn the jitted runtime in a new thread so that this rustc thread can handle messages\n+    // (eg to lazily JIT further functions as required)\n+    std::thread::spawn(move || {\n+        let mut argv = args.iter().map(|arg| arg.as_ptr()).collect::<Vec<_>>();\n+\n+        // Push a null pointer as a terminating argument. This is required by POSIX and\n+        // useful as some dynamic linkers use it as a marker to jump over.\n+        argv.push(std::ptr::null());\n+\n+        let ret = f(args.len() as c_int, argv.as_ptr());\n+        std::process::exit(ret);\n+    });\n+\n+    // Handle messages\n+    loop {\n+        match rx.recv().unwrap() {\n+            // lazy JIT compilation request - compile requested instance and return pointer to result\n+            UnsafeMessage::JitFn { instance_ptr, trampoline_ptr, tx } => {\n+                tx.send(jit_fn(instance_ptr, trampoline_ptr))\n+                    .expect(\"jitted runtime hung up before response to lazy JIT request was sent\");\n+            }\n+        }\n+    }\n }\n \n #[no_mangle]\n-extern \"C\" fn __clif_jit_fn(instance_ptr: *const Instance<'static>) -> *const u8 {\n+extern \"C\" fn __clif_jit_fn(\n+    instance_ptr: *const Instance<'static>,\n+    trampoline_ptr: *const u8,\n+) -> *const u8 {\n+    // send the JIT request to the rustc thread, with a channel for the response\n+    let (tx, rx) = mpsc::channel();\n+    UnsafeMessage::JitFn { instance_ptr, trampoline_ptr, tx }\n+        .send()\n+        .expect(\"rustc thread hung up before lazy JIT request was sent\");\n+\n+    // block on JIT compilation result\n+    rx.recv().expect(\"rustc thread hung up before responding to sent lazy JIT request\")\n+}\n+\n+fn jit_fn(instance_ptr: *const Instance<'static>, trampoline_ptr: *const u8) -> *const u8 {\n     rustc_middle::ty::tls::with(|tcx| {\n         // lift is used to ensure the correct lifetime for instance.\n         let instance = tcx.lift(unsafe { *instance_ptr }).unwrap();\n@@ -160,6 +233,17 @@ extern \"C\" fn __clif_jit_fn(instance_ptr: *const Instance<'static>) -> *const u8\n             let name = tcx.symbol_name(instance).name;\n             let sig = crate::abi::get_function_sig(tcx, jit_module.isa().triple(), instance);\n             let func_id = jit_module.declare_function(name, Linkage::Export, &sig).unwrap();\n+\n+            let current_ptr = jit_module.read_got_entry(func_id);\n+\n+            // If the function's GOT entry has already been updated to point at something other\n+            // than the shim trampoline, don't re-jit but just return the new pointer instead.\n+            // This does not need synchronization as this code is executed only by a sole rustc\n+            // thread.\n+            if current_ptr != trampoline_ptr {\n+                return current_ptr;\n+            }\n+\n             jit_module.prepare_for_function_redefine(func_id).unwrap();\n \n             let mut cx = crate::CodegenCx::new(tcx, backend_config, jit_module.isa(), false);\n@@ -173,14 +257,16 @@ extern \"C\" fn __clif_jit_fn(instance_ptr: *const Instance<'static>) -> *const u8\n     })\n }\n \n-fn load_imported_symbols_for_jit(tcx: TyCtxt<'_>) -> Vec<(String, *const u8)> {\n+fn load_imported_symbols_for_jit(\n+    sess: &Session,\n+    crate_info: CrateInfo,\n+) -> Vec<(String, *const u8)> {\n     use rustc_middle::middle::dependency_format::Linkage;\n \n     let mut dylib_paths = Vec::new();\n \n-    let crate_info = CrateInfo::new(tcx, \"dummy_target_cpu\".to_string());\n-    let formats = tcx.dependency_formats(());\n-    let data = &formats\n+    let data = &crate_info\n+        .dependency_formats\n         .iter()\n         .find(|(crate_type, _data)| *crate_type == rustc_session::config::CrateType::Executable)\n         .unwrap()\n@@ -190,9 +276,8 @@ fn load_imported_symbols_for_jit(tcx: TyCtxt<'_>) -> Vec<(String, *const u8)> {\n         match data[cnum.as_usize() - 1] {\n             Linkage::NotLinked | Linkage::IncludedFromDylib => {}\n             Linkage::Static => {\n-                let name = tcx.crate_name(cnum);\n-                let mut err =\n-                    tcx.sess.struct_err(&format!(\"Can't load static lib {}\", name.as_str()));\n+                let name = &crate_info.crate_name[&cnum];\n+                let mut err = sess.struct_err(&format!(\"Can't load static lib {}\", name.as_str()));\n                 err.note(\"rustc_codegen_cranelift can only load dylibs in JIT mode.\");\n                 err.emit();\n             }\n@@ -232,7 +317,7 @@ fn load_imported_symbols_for_jit(tcx: TyCtxt<'_>) -> Vec<(String, *const u8)> {\n         std::mem::forget(lib)\n     }\n \n-    tcx.sess.abort_if_errors();\n+    sess.abort_if_errors();\n \n     imported_symbols\n }\n@@ -254,7 +339,7 @@ fn codegen_shim<'tcx>(cx: &mut CodegenCx<'tcx>, module: &mut JITModule, inst: In\n             Linkage::Import,\n             &Signature {\n                 call_conv: module.target_config().default_call_conv,\n-                params: vec![AbiParam::new(pointer_type)],\n+                params: vec![AbiParam::new(pointer_type), AbiParam::new(pointer_type)],\n                 returns: vec![AbiParam::new(pointer_type)],\n             },\n         )\n@@ -267,6 +352,7 @@ fn codegen_shim<'tcx>(cx: &mut CodegenCx<'tcx>, module: &mut JITModule, inst: In\n     let mut builder_ctx = FunctionBuilderContext::new();\n     let mut trampoline_builder = FunctionBuilder::new(trampoline, &mut builder_ctx);\n \n+    let trampoline_fn = module.declare_func_in_func(func_id, trampoline_builder.func);\n     let jit_fn = module.declare_func_in_func(jit_fn, trampoline_builder.func);\n     let sig_ref = trampoline_builder.func.import_signature(sig);\n \n@@ -276,7 +362,8 @@ fn codegen_shim<'tcx>(cx: &mut CodegenCx<'tcx>, module: &mut JITModule, inst: In\n \n     trampoline_builder.switch_to_block(entry_block);\n     let instance_ptr = trampoline_builder.ins().iconst(pointer_type, instance_ptr as u64 as i64);\n-    let jitted_fn = trampoline_builder.ins().call(jit_fn, &[instance_ptr]);\n+    let trampoline_ptr = trampoline_builder.ins().func_addr(pointer_type, trampoline_fn);\n+    let jitted_fn = trampoline_builder.ins().call(jit_fn, &[instance_ptr, trampoline_ptr]);\n     let jitted_fn = trampoline_builder.func.dfg.inst_results(jitted_fn)[0];\n     let call_inst = trampoline_builder.ins().call_indirect(sig_ref, jitted_fn, &fn_args);\n     let ret_vals = trampoline_builder.func.dfg.inst_results(call_inst).to_vec();"}, {"sha": "be3704ca2768e0377a579c8206adf25c8d499fa6", "filename": "src/intrinsics/llvm.rs", "status": "modified", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fintrinsics%2Fllvm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fintrinsics%2Fllvm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fintrinsics%2Fllvm.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -106,6 +106,26 @@ pub(crate) fn codegen_llvm_intrinsic_call<'tcx>(\n             let dest = CPlace::for_ptr(Pointer::new(mem_addr), a.layout());\n             dest.write_cvalue(fx, a);\n         };\n+        \"llvm.x86.addcarry.64\", (v c_in, c a, c b) {\n+            llvm_add_sub(\n+                fx,\n+                BinOp::Add,\n+                ret,\n+                c_in,\n+                a,\n+                b\n+            );\n+        };\n+        \"llvm.x86.subborrow.64\", (v b_in, c a, c b) {\n+            llvm_add_sub(\n+                fx,\n+                BinOp::Sub,\n+                ret,\n+                b_in,\n+                a,\n+                b\n+            );\n+        };\n     }\n \n     if let Some((_, dest)) = destination {\n@@ -121,3 +141,41 @@ pub(crate) fn codegen_llvm_intrinsic_call<'tcx>(\n // llvm.x86.avx2.pshuf.b\n // llvm.x86.avx2.psrli.w\n // llvm.x86.sse2.psrli.w\n+\n+fn llvm_add_sub<'tcx>(\n+    fx: &mut FunctionCx<'_, '_, 'tcx>,\n+    bin_op: BinOp,\n+    ret: CPlace<'tcx>,\n+    cb_in: Value,\n+    a: CValue<'tcx>,\n+    b: CValue<'tcx>,\n+) {\n+    assert_eq!(\n+        a.layout().ty,\n+        fx.tcx.types.u64,\n+        \"llvm.x86.addcarry.64/llvm.x86.subborrow.64 second operand must be u64\"\n+    );\n+    assert_eq!(\n+        b.layout().ty,\n+        fx.tcx.types.u64,\n+        \"llvm.x86.addcarry.64/llvm.x86.subborrow.64 third operand must be u64\"\n+    );\n+\n+    // c + carry -> c + first intermediate carry or borrow respectively\n+    let int0 = crate::num::codegen_checked_int_binop(fx, bin_op, a, b);\n+    let c = int0.value_field(fx, mir::Field::new(0));\n+    let cb0 = int0.value_field(fx, mir::Field::new(1)).load_scalar(fx);\n+\n+    // c + carry -> c + second intermediate carry or borrow respectively\n+    let cb_in_as_u64 = fx.bcx.ins().uextend(types::I64, cb_in);\n+    let cb_in_as_u64 = CValue::by_val(cb_in_as_u64, fx.layout_of(fx.tcx.types.u64));\n+    let int1 = crate::num::codegen_checked_int_binop(fx, bin_op, c, cb_in_as_u64);\n+    let (c, cb1) = int1.load_scalar_pair(fx);\n+\n+    // carry0 | carry1 -> carry or borrow respectively\n+    let cb_out = fx.bcx.ins().bor(cb0, cb1);\n+\n+    let layout = fx.layout_of(fx.tcx.mk_tup([fx.tcx.types.u8, fx.tcx.types.u64].iter()));\n+    let val = CValue::by_val_pair(cb_out, c, layout);\n+    ret.write_cvalue(fx, val);\n+}"}, {"sha": "cb1cb3c74dbb5981317ceb4b7e677516d98ceb43", "filename": "src/lib.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,4 +1,4 @@\n-#![feature(rustc_private, decl_macro, never_type, hash_drain_filter, vec_into_raw_parts)]\n+#![feature(rustc_private, decl_macro, never_type, hash_drain_filter, vec_into_raw_parts, once_cell)]\n #![warn(rust_2018_idioms)]\n #![warn(unused_lifetimes)]\n #![warn(unreachable_pub)]\n@@ -14,7 +14,9 @@ extern crate rustc_fs_util;\n extern crate rustc_hir;\n extern crate rustc_incremental;\n extern crate rustc_index;\n+extern crate rustc_interface;\n extern crate rustc_metadata;\n+extern crate rustc_mir;\n extern crate rustc_session;\n extern crate rustc_span;\n extern crate rustc_target;\n@@ -284,10 +286,12 @@ fn build_isa(sess: &Session, backend_config: &BackendConfig) -> Box<dyn isa::Tar\n         }\n         None => {\n             let mut builder =\n-                cranelift_codegen::isa::lookup_variant(target_triple, variant).unwrap();\n-            // Don't use \"haswell\" as the default, as it implies `has_lzcnt`.\n-            // macOS CI is still at Ivy Bridge EP, so `lzcnt` is interpreted as `bsr`.\n-            builder.enable(\"nehalem\").unwrap();\n+                cranelift_codegen::isa::lookup_variant(target_triple.clone(), variant).unwrap();\n+            if target_triple.architecture == target_lexicon::Architecture::X86_64 {\n+                // Don't use \"haswell\" as the default, as it implies `has_lzcnt`.\n+                // macOS CI is still at Ivy Bridge EP, so `lzcnt` is interpreted as `bsr`.\n+                builder.enable(\"nehalem\").unwrap();\n+            }\n             builder\n         }\n     };"}, {"sha": "61033d85a12740a827d1f443c7e76e567dfd54e9", "filename": "src/optimize/mod.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Foptimize%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Foptimize%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Foptimize%2Fmod.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,17 +1,20 @@\n //! Various optimizations specific to cg_clif\n \n+use cranelift_codegen::isa::TargetIsa;\n+\n use crate::prelude::*;\n \n pub(crate) mod peephole;\n \n pub(crate) fn optimize_function<'tcx>(\n     tcx: TyCtxt<'tcx>,\n+    isa: &dyn TargetIsa,\n     instance: Instance<'tcx>,\n     ctx: &mut Context,\n     clif_comments: &mut crate::pretty_clif::CommentWriter,\n ) {\n     // FIXME classify optimizations over opt levels once we have more\n \n-    crate::pretty_clif::write_clif_file(tcx, \"preopt\", None, instance, &ctx, &*clif_comments);\n+    crate::pretty_clif::write_clif_file(tcx, \"preopt\", isa, instance, &ctx, &*clif_comments);\n     crate::base::verify_func(tcx, &*clif_comments, &ctx.func);\n }"}, {"sha": "05db74745a1c0583bb5598e885ac04e8eda37c64", "filename": "src/pretty_clif.rs", "status": "modified", "additions": 10, "deletions": 9, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fpretty_clif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fpretty_clif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fpretty_clif.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -233,7 +233,7 @@ pub(crate) fn write_ir_file(\n pub(crate) fn write_clif_file<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     postfix: &str,\n-    isa: Option<&dyn cranelift_codegen::isa::TargetIsa>,\n+    isa: &dyn cranelift_codegen::isa::TargetIsa,\n     instance: Instance<'tcx>,\n     context: &cranelift_codegen::Context,\n     mut clif_comments: &CommentWriter,\n@@ -242,22 +242,23 @@ pub(crate) fn write_clif_file<'tcx>(\n         tcx,\n         || format!(\"{}.{}.clif\", tcx.symbol_name(instance).name, postfix),\n         |file| {\n-            let value_ranges = isa\n-                .map(|isa| context.build_value_labels_ranges(isa).expect(\"value location ranges\"));\n-\n             let mut clif = String::new();\n             cranelift_codegen::write::decorate_function(\n                 &mut clif_comments,\n                 &mut clif,\n                 &context.func,\n-                &DisplayFunctionAnnotations { isa, value_ranges: value_ranges.as_ref() },\n+                &DisplayFunctionAnnotations { isa: Some(isa), value_ranges: None },\n             )\n             .unwrap();\n \n-            writeln!(file, \"test compile\")?;\n-            writeln!(file, \"set is_pic\")?;\n-            writeln!(file, \"set enable_simd\")?;\n-            writeln!(file, \"target {} haswell\", crate::target_triple(tcx.sess))?;\n+            for flag in isa.flags().iter() {\n+                writeln!(file, \"set {}\", flag)?;\n+            }\n+            write!(file, \"target {}\", isa.triple().architecture.to_string())?;\n+            for isa_flag in isa.isa_flags().iter() {\n+                write!(file, \" {}\", isa_flag)?;\n+            }\n+            writeln!(file, \"\\n\")?;\n             writeln!(file)?;\n             file.write_all(clif.as_bytes())?;\n             Ok(())"}, {"sha": "4a5f9f133a2bbc8e2168fd4668036fb46f3d091f", "filename": "src/vtable.rs", "status": "modified", "additions": 10, "deletions": 15, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/src%2Fvtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/src%2Fvtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvtable.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,10 +1,9 @@\n //! Codegen vtables and vtable accesses.\n //!\n //! See `rustc_codegen_ssa/src/meth.rs` for reference.\n-// FIXME dedup this logic between miri, cg_llvm and cg_clif\n \n+use crate::constant::data_id_for_alloc_id;\n use crate::prelude::*;\n-use super::constant::pointer_for_allocation;\n \n fn vtable_memflags() -> MemFlags {\n     let mut flags = MemFlags::trusted(); // A vtable access is always aligned and will never trap.\n@@ -38,7 +37,7 @@ pub(crate) fn min_align_of_obj(fx: &mut FunctionCx<'_, '_, '_>, vtable: Value) -\n         pointer_ty(fx.tcx),\n         vtable_memflags(),\n         vtable,\n-        (ty::COMMON_VTABLE_ENTRIES_SIZE * usize_size) as i32,\n+        (ty::COMMON_VTABLE_ENTRIES_ALIGN * usize_size) as i32,\n     )\n }\n \n@@ -69,16 +68,12 @@ pub(crate) fn get_vtable<'tcx>(\n     ty: Ty<'tcx>,\n     trait_ref: Option<ty::PolyExistentialTraitRef<'tcx>>,\n ) -> Value {\n-    let vtable_ptr = if let Some(vtable_ptr) = fx.vtables.get(&(ty, trait_ref)) {\n-        *vtable_ptr\n-    } else {\n-        let vtable_alloc_id = fx.tcx.vtable_allocation(ty, trait_ref);\n-        let vtable_allocation = fx.tcx.global_alloc(vtable_alloc_id).unwrap_memory();\n-        let vtable_ptr = pointer_for_allocation(fx, vtable_allocation);\n-\n-        fx.vtables.insert((ty, trait_ref), vtable_ptr);\n-        vtable_ptr\n-    };\n-\n-    vtable_ptr.get_addr(fx)\n+    let alloc_id = fx.tcx.vtable_allocation(ty, trait_ref);\n+    let data_id =\n+        data_id_for_alloc_id(&mut fx.constants_cx, &mut *fx.module, alloc_id, Mutability::Not);\n+    let local_data_id = fx.module.declare_data_in_func(data_id, &mut fx.bcx.func);\n+    if fx.clif_comments.enabled() {\n+        fx.add_comment(local_data_id, format!(\"vtable: {:?}\", alloc_id));\n+    }\n+    fx.bcx.ins().global_value(fx.pointer_type, local_data_id)\n }"}, {"sha": "a10924628bb0eba9350b56f5603ead5b068b75f4", "filename": "test.sh", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/test.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/test.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test.sh?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -1,13 +1,13 @@\n #!/usr/bin/env bash\n set -e\n \n-./build.sh --sysroot none \"$@\"\n+./y.rs build --sysroot none \"$@\"\n \n rm -r target/out || true\n \n scripts/tests.sh no_sysroot\n \n-./build.sh \"$@\"\n+./y.rs build \"$@\"\n \n scripts/tests.sh base_sysroot\n scripts/tests.sh extended_sysroot"}, {"sha": "43937588b481da1005f68642316a3b2e3fa62c4c", "filename": "y.rs", "status": "added", "additions": 153, "deletions": 0, "changes": 153, "blob_url": "https://github.com/rust-lang/rust/blob/fb92375755a00a39a900da50f581917519b5af6b/y.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb92375755a00a39a900da50f581917519b5af6b/y.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/y.rs?ref=fb92375755a00a39a900da50f581917519b5af6b", "patch": "@@ -0,0 +1,153 @@\n+#!/usr/bin/env bash\n+#![allow()] /*This line is ignored by bash\n+# This block is ignored by rustc\n+set -e\n+echo \"[BUILD] y.rs\" 1>&2\n+rustc $0 -o ${0/.rs/.bin} -g\n+exec ${0/.rs/.bin} $@\n+*/\n+\n+//! The build system for cg_clif\n+//!\n+//! # Manual compilation\n+//!\n+//! If your system doesn't support shell scripts you can manually compile and run this file using\n+//! for example:\n+//!\n+//! ```shell\n+//! $ rustc y.rs -o build/y.bin\n+//! $ build/y.bin\n+//! ```\n+//!\n+//! # Naming\n+//!\n+//! The name `y.rs` was chosen to not conflict with rustc's `x.py`.\n+\n+use std::env;\n+use std::path::PathBuf;\n+use std::process;\n+\n+#[path = \"build_system/build_backend.rs\"]\n+mod build_backend;\n+#[path = \"build_system/build_sysroot.rs\"]\n+mod build_sysroot;\n+#[path = \"build_system/config.rs\"]\n+mod config;\n+#[path = \"build_system/prepare.rs\"]\n+mod prepare;\n+#[path = \"build_system/rustc_info.rs\"]\n+mod rustc_info;\n+#[path = \"build_system/utils.rs\"]\n+mod utils;\n+\n+fn usage() {\n+    eprintln!(\"Usage:\");\n+    eprintln!(\"  ./y.rs prepare\");\n+    eprintln!(\"  ./y.rs build [--debug] [--sysroot none|clif|llvm] [--target-dir DIR]\");\n+}\n+\n+macro_rules! arg_error {\n+    ($($err:tt)*) => {{\n+        eprintln!($($err)*);\n+        usage();\n+        std::process::exit(1);\n+    }};\n+}\n+\n+enum Command {\n+    Build,\n+}\n+\n+#[derive(Copy, Clone)]\n+enum SysrootKind {\n+    None,\n+    Clif,\n+    Llvm,\n+}\n+\n+fn main() {\n+    env::set_var(\"CG_CLIF_DISPLAY_CG_TIME\", \"1\");\n+    env::set_var(\"CG_CLIF_DISABLE_INCR_CACHE\", \"1\");\n+    // The target dir is expected in the default location. Guard against the user changing it.\n+    env::set_var(\"CARGO_TARGET_DIR\", \"target\");\n+\n+    let mut args = env::args().skip(1);\n+    let command = match args.next().as_deref() {\n+        Some(\"prepare\") => {\n+            if args.next().is_some() {\n+                arg_error!(\"./x.rs prepare doesn't expect arguments\");\n+            }\n+            prepare::prepare();\n+            process::exit(0);\n+        }\n+        Some(\"build\") => Command::Build,\n+        Some(flag) if flag.starts_with('-') => arg_error!(\"Expected command found flag {}\", flag),\n+        Some(command) => arg_error!(\"Unknown command {}\", command),\n+        None => {\n+            usage();\n+            process::exit(0);\n+        }\n+    };\n+\n+    let mut target_dir = PathBuf::from(\"build\");\n+    let mut channel = \"release\";\n+    let mut sysroot_kind = SysrootKind::Clif;\n+    while let Some(arg) = args.next().as_deref() {\n+        match arg {\n+            \"--target-dir\" => {\n+                target_dir = PathBuf::from(args.next().unwrap_or_else(|| {\n+                    arg_error!(\"--target-dir requires argument\");\n+                }))\n+            }\n+            \"--debug\" => channel = \"debug\",\n+            \"--sysroot\" => {\n+                sysroot_kind = match args.next().as_deref() {\n+                    Some(\"none\") => SysrootKind::None,\n+                    Some(\"clif\") => SysrootKind::Clif,\n+                    Some(\"llvm\") => SysrootKind::Llvm,\n+                    Some(arg) => arg_error!(\"Unknown sysroot kind {}\", arg),\n+                    None => arg_error!(\"--sysroot requires argument\"),\n+                }\n+            }\n+            flag if flag.starts_with(\"-\") => arg_error!(\"Unknown flag {}\", flag),\n+            arg => arg_error!(\"Unexpected argument {}\", arg),\n+        }\n+    }\n+\n+    let host_triple = if let Ok(host_triple) = std::env::var(\"HOST_TRIPLE\") {\n+        host_triple\n+    } else if let Some(host_triple) = crate::config::get_value(\"host\") {\n+        host_triple\n+    } else {\n+        rustc_info::get_host_triple()\n+    };\n+    let target_triple = if let Ok(target_triple) = std::env::var(\"TARGET_TRIPLE\") {\n+        if target_triple != \"\" {\n+            target_triple\n+        } else {\n+            host_triple.clone() // Empty target triple can happen on GHA\n+        }\n+    } else if let Some(target_triple) = crate::config::get_value(\"target\") {\n+        target_triple\n+    } else {\n+        host_triple.clone()\n+    };\n+\n+    if target_triple.ends_with(\"-msvc\") {\n+        eprintln!(\"The MSVC toolchain is not yet supported by rustc_codegen_cranelift.\");\n+        eprintln!(\"Switch to the MinGW toolchain for Windows support.\");\n+        eprintln!(\"Hint: You can use `rustup set default-host x86_64-pc-windows-gnu` to\");\n+        eprintln!(\"set the global default target to MinGW\");\n+        process::exit(1);\n+    }\n+\n+    let cg_clif_build_dir = build_backend::build_backend(channel, &host_triple);\n+    build_sysroot::build_sysroot(\n+        channel,\n+        sysroot_kind,\n+        &target_dir,\n+        cg_clif_build_dir,\n+        &host_triple,\n+        &target_triple,\n+    );\n+}"}]}