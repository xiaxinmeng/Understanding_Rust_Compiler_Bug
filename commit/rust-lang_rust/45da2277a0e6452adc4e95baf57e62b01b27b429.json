{"sha": "45da2277a0e6452adc4e95baf57e62b01b27b429", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ1ZGEyMjc3YTBlNjQ1MmFkYzRlOTViYWY1N2U2MmIwMWIyN2I0Mjk=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2021-02-20T18:23:46Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2021-02-20T23:48:22Z"}, "message": "Fix some Python2->3 error in publish_toolstate.py by type-checking it", "tree": {"sha": "8e81ec909746c131fd811c19662d727f7a2fd671", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8e81ec909746c131fd811c19662d727f7a2fd671"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/45da2277a0e6452adc4e95baf57e62b01b27b429", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/45da2277a0e6452adc4e95baf57e62b01b27b429", "html_url": "https://github.com/rust-lang/rust/commit/45da2277a0e6452adc4e95baf57e62b01b27b429", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/45da2277a0e6452adc4e95baf57e62b01b27b429/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7c23ab933ebc1f205c3b59f4ebc85d40f67d404", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7c23ab933ebc1f205c3b59f4ebc85d40f67d404", "html_url": "https://github.com/rust-lang/rust/commit/e7c23ab933ebc1f205c3b59f4ebc85d40f67d404"}], "stats": {"total": 50, "additions": 34, "deletions": 16}, "files": [{"sha": "f97914b1e97561f40e4a70dc18be66b29da1dff9", "filename": "src/tools/publish_toolstate.py", "status": "modified", "additions": 34, "deletions": 16, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/45da2277a0e6452adc4e95baf57e62b01b27b429/src%2Ftools%2Fpublish_toolstate.py", "raw_url": "https://github.com/rust-lang/rust/raw/45da2277a0e6452adc4e95baf57e62b01b27b429/src%2Ftools%2Fpublish_toolstate.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fpublish_toolstate.py?ref=45da2277a0e6452adc4e95baf57e62b01b27b429", "patch": "@@ -17,8 +17,14 @@\n import textwrap\n try:\n     import urllib2\n+    from urllib2 import HTTPError\n except ImportError:\n     import urllib.request as urllib2\n+    from urllib.error import HTTPError\n+try:\n+    import typing\n+except ImportError:\n+    pass\n \n # List of people to ping when the status of a tool or a book changed.\n # These should be collaborators of the rust-lang/rust repository (with at least\n@@ -63,20 +69,23 @@\n }\n \n def load_json_from_response(resp):\n+    # type: (typing.Any) -> typing.Any\n     content = resp.read()\n     if isinstance(content, bytes):\n-        content = content.decode('utf-8')\n+        content_str = content.decode('utf-8')\n     else:\n         print(\"Refusing to decode \" + str(type(content)) + \" to str\")\n-    return json.loads(content)\n+    return json.loads(content_str)\n \n def validate_maintainers(repo, github_token):\n+    # type: (str, str) -> None\n     '''Ensure all maintainers are assignable on a GitHub repo'''\n     next_link_re = re.compile(r'<([^>]+)>; rel=\"next\"')\n \n     # Load the list of assignable people in the GitHub repo\n-    assignable = []\n-    url = 'https://api.github.com/repos/%s/collaborators?per_page=100' % repo\n+    assignable = [] # type: typing.List[str]\n+    url = 'https://api.github.com/repos/' \\\n+        + '%s/collaborators?per_page=100' % repo # type: typing.Optional[str]\n     while url is not None:\n         response = urllib2.urlopen(urllib2.Request(url, headers={\n             'Authorization': 'token ' + github_token,\n@@ -116,9 +125,10 @@ def validate_maintainers(repo, github_token):\n \n \n def read_current_status(current_commit, path):\n+    # type: (str, str) -> typing.Mapping[str, typing.Any]\n     '''Reads build status of `current_commit` from content of `history/*.tsv`\n     '''\n-    with open(path, 'rU') as f:\n+    with open(path, 'r') as f:\n         for line in f:\n             (commit, status) = line.split('\\t', 1)\n             if commit == current_commit:\n@@ -127,10 +137,12 @@ def read_current_status(current_commit, path):\n \n \n def gh_url():\n+    # type: () -> str\n     return os.environ['TOOLSTATE_ISSUES_API_URL']\n \n \n def maybe_delink(message):\n+    # type: (str) -> str\n     if os.environ.get('TOOLSTATE_SKIP_MENTIONS') is not None:\n         return message.replace(\"@\", \"\")\n     return message\n@@ -143,8 +155,10 @@ def issue(\n     relevant_pr_number,\n     relevant_pr_user,\n     labels,\n+    github_token,\n ):\n-    # Open an issue about the toolstate failure.\n+    # type: (str, str, typing.Iterable[str], str, str, typing.List[str], str) -> None\n+    '''Open an issue about the toolstate failure.'''\n     if status == 'test-fail':\n         status_description = 'has failing tests'\n     else:\n@@ -168,7 +182,7 @@ def issue(\n     print(\"Creating issue:\\n{}\".format(request))\n     response = urllib2.urlopen(urllib2.Request(\n         gh_url(),\n-        request,\n+        request.encode(),\n         {\n             'Authorization': 'token ' + github_token,\n             'Content-Type': 'application/json',\n@@ -183,8 +197,10 @@ def update_latest(\n     relevant_pr_url,\n     relevant_pr_user,\n     pr_reviewer,\n-    current_datetime\n+    current_datetime,\n+    github_token,\n ):\n+    # type: (str, str, str, str, str, str, str) -> str\n     '''Updates `_data/latest.json` to match build result of the given commit.\n     '''\n     with open('_data/latest.json', 'r+') as f:\n@@ -243,13 +259,14 @@ def update_latest(\n             if create_issue_for_status is not None:\n                 try:\n                     issue(\n-                        tool, create_issue_for_status, MAINTAINERS.get(tool, ''),\n-                        relevant_pr_number, relevant_pr_user, LABELS.get(tool, ''),\n+                        tool, create_issue_for_status, MAINTAINERS.get(tool, ()),\n+                        relevant_pr_number, relevant_pr_user, LABELS.get(tool, []),\n+                        github_token,\n                     )\n-                except urllib2.HTTPError as e:\n+                except HTTPError as e:\n                     # network errors will simply end up not creating an issue, but that's better\n                     # than failing the entire build job\n-                    print(\"HTTPError when creating issue for status regression: {0}\\n{1}\"\n+                    print(\"HTTPError when creating issue for status regression: {0}\\n{1!r}\"\n                           .format(e, e.read()))\n                 except IOError as e:\n                     print(\"I/O error when creating issue for status regression: {0}\".format(e))\n@@ -318,7 +335,8 @@ def update_latest(\n         relevant_pr_url,\n         relevant_pr_user,\n         pr_reviewer,\n-        cur_datetime\n+        cur_datetime,\n+        github_token,\n     )\n     if not message:\n         print('<Nothing changed>')\n@@ -337,13 +355,13 @@ def update_latest(\n     issue_url = gh_url() + '/{}/comments'.format(number)\n     response = urllib2.urlopen(urllib2.Request(\n         issue_url,\n-        json.dumps({'body': maybe_delink(message)}),\n+        json.dumps({'body': maybe_delink(message)}).encode(),\n         {\n             'Authorization': 'token ' + github_token,\n             'Content-Type': 'application/json',\n         }\n     ))\n     response.read()\n-except urllib2.HTTPError as e:\n-    print(\"HTTPError: %s\\n%s\" % (e, e.read()))\n+except HTTPError as e:\n+    print(\"HTTPError: %s\\n%r\" % (e, e.read()))\n     raise"}]}