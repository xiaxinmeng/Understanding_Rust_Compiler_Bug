{"sha": "328e89c022b9d24ad435038e0b51bf85f47234bd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyOGU4OWMwMjJiOWQyNGFkNDM1MDM4ZTBiNTFiZjg1ZjQ3MjM0YmQ=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-12-21T01:47:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-21T01:47:45Z"}, "message": "Rollup merge of #80236 - tmiasko:atomic-swap, r=oli-obk\n\nUse pointer type in AtomicPtr::swap implementation\n\nCloses #80234.", "tree": {"sha": "abb75e7ab8f50b1d69ea7e141755549baa196c2e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/abb75e7ab8f50b1d69ea7e141755549baa196c2e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/328e89c022b9d24ad435038e0b51bf85f47234bd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf3/7CCRBK7hj4Ov3rIwAAdHIIAKG9sG4ed4N3QEEVWdd/KDCJ\nFVcLl5g2aJhSFfRrKAYkVTYTYoaEyaekRSxYSLKc+JVGjsDu6M3eiSM05Opxm/3C\nbTuiHg9sI+TszFM+W/N8gyZCaw3B029WPYziHJsqdxIYqnlXBDG2XJRnkNcdAgl0\njQtYlomQzIb6oN6Cz3VxIvnKb7HV71w0fp9e3hut7m70ozVatoFBEzxc5PR9Pp1a\nQMKWdzXPIpqc86kr/jym2MaLYgD2LJzkufUYEPoS97a/YvvjA64NHduo7hD6CWSL\n070vCcRnjJxYT0s7x6z9Ft+e9BscFzcCI0p9w5MBIsqsKuhmh9vh8PJqqJQxzSg=\n=1mAq\n-----END PGP SIGNATURE-----\n", "payload": "tree abb75e7ab8f50b1d69ea7e141755549baa196c2e\nparent 2528acb5f7fabd68fc951fda1f724640c38c1042\nparent 4ad53dc9f5b43e0fa27622e3e40faeac15f00f31\nauthor Dylan DPC <dylan.dpc@gmail.com> 1608515265 +0100\ncommitter GitHub <noreply@github.com> 1608515265 +0100\n\nRollup merge of #80236 - tmiasko:atomic-swap, r=oli-obk\n\nUse pointer type in AtomicPtr::swap implementation\n\nCloses #80234.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/328e89c022b9d24ad435038e0b51bf85f47234bd", "html_url": "https://github.com/rust-lang/rust/commit/328e89c022b9d24ad435038e0b51bf85f47234bd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/328e89c022b9d24ad435038e0b51bf85f47234bd/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2528acb5f7fabd68fc951fda1f724640c38c1042", "url": "https://api.github.com/repos/rust-lang/rust/commits/2528acb5f7fabd68fc951fda1f724640c38c1042", "html_url": "https://github.com/rust-lang/rust/commit/2528acb5f7fabd68fc951fda1f724640c38c1042"}, {"sha": "4ad53dc9f5b43e0fa27622e3e40faeac15f00f31", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ad53dc9f5b43e0fa27622e3e40faeac15f00f31", "html_url": "https://github.com/rust-lang/rust/commit/4ad53dc9f5b43e0fa27622e3e40faeac15f00f31"}], "stats": {"total": 25, "additions": 22, "deletions": 3}, "files": [{"sha": "80e3ed75b8585de8c7f5e2341ccceca7c9f39eee", "filename": "compiler/rustc_codegen_ssa/src/mir/intrinsic.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/328e89c022b9d24ad435038e0b51bf85f47234bd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/328e89c022b9d24ad435038e0b51bf85f47234bd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fintrinsic.rs?ref=328e89c022b9d24ad435038e0b51bf85f47234bd", "patch": "@@ -524,8 +524,19 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                         };\n \n                         let ty = substs.type_at(0);\n-                        if int_type_width_signed(ty, bx.tcx()).is_some() {\n-                            bx.atomic_rmw(atom_op, args[0].immediate(), args[1].immediate(), order)\n+                        if int_type_width_signed(ty, bx.tcx()).is_some()\n+                            || (ty.is_unsafe_ptr() && op == \"xchg\")\n+                        {\n+                            let mut ptr = args[0].immediate();\n+                            let mut val = args[1].immediate();\n+                            if ty.is_unsafe_ptr() {\n+                                // Some platforms do not support atomic operations on pointers,\n+                                // so we cast to integer first.\n+                                let ptr_llty = bx.type_ptr_to(bx.type_isize());\n+                                ptr = bx.pointercast(ptr, ptr_llty);\n+                                val = bx.ptrtoint(val, bx.type_isize());\n+                            }\n+                            bx.atomic_rmw(atom_op, ptr, val, order)\n                         } else {\n                             return invalid_monomorphization(ty);\n                         }"}, {"sha": "a96da9aa6dc73c3879acbffcab9a0fc082c3ed3d", "filename": "library/core/src/sync/atomic.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/328e89c022b9d24ad435038e0b51bf85f47234bd/library%2Fcore%2Fsrc%2Fsync%2Fatomic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/328e89c022b9d24ad435038e0b51bf85f47234bd/library%2Fcore%2Fsrc%2Fsync%2Fatomic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fsync%2Fatomic.rs?ref=328e89c022b9d24ad435038e0b51bf85f47234bd", "patch": "@@ -1040,8 +1040,16 @@ impl<T> AtomicPtr<T> {\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[cfg(target_has_atomic = \"ptr\")]\n     pub fn swap(&self, ptr: *mut T, order: Ordering) -> *mut T {\n+        #[cfg(bootstrap)]\n         // SAFETY: data races are prevented by atomic intrinsics.\n-        unsafe { atomic_swap(self.p.get() as *mut usize, ptr as usize, order) as *mut T }\n+        unsafe {\n+            atomic_swap(self.p.get() as *mut usize, ptr as usize, order) as *mut T\n+        }\n+        #[cfg(not(bootstrap))]\n+        // SAFETY: data races are prevented by atomic intrinsics.\n+        unsafe {\n+            atomic_swap(self.p.get(), ptr, order)\n+        }\n     }\n \n     /// Stores a value into the pointer if the current value is the same as the `current` value."}]}