{"sha": "735ace977c75405084cb41b3b0613d14b55c811d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczNWFjZTk3N2M3NTQwNTA4NGNiNDFiM2IwNjEzZDE0YjU1YzgxMWQ=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2017-07-11T21:10:38Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2017-07-30T08:11:59Z"}, "message": "add a pass for validation commands; for now just emit the initial AcquireValid", "tree": {"sha": "f008b246288990e2b823891aadb50241988e67d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f008b246288990e2b823891aadb50241988e67d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/735ace977c75405084cb41b3b0613d14b55c811d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/735ace977c75405084cb41b3b0613d14b55c811d", "html_url": "https://github.com/rust-lang/rust/commit/735ace977c75405084cb41b3b0613d14b55c811d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/735ace977c75405084cb41b3b0613d14b55c811d/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5264103de4085d61a9e47c97de3a31b1f36b2dd3", "url": "https://api.github.com/repos/rust-lang/rust/commits/5264103de4085d61a9e47c97de3a31b1f36b2dd3", "html_url": "https://github.com/rust-lang/rust/commit/5264103de4085d61a9e47c97de3a31b1f36b2dd3"}], "stats": {"total": 48, "additions": 48, "deletions": 0}, "files": [{"sha": "68e6b0f50d1d6902cfca857b7729ee2036080b20", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/735ace977c75405084cb41b3b0613d14b55c811d/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/735ace977c75405084cb41b3b0613d14b55c811d/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=735ace977c75405084cb41b3b0613d14b55c811d", "patch": "@@ -925,6 +925,10 @@ pub fn phase_3_run_analysis_passes<'tcx, F, R>(sess: &'tcx Session,\n     let mut passes = Passes::new();\n     passes.push_hook(mir::transform::dump_mir::DumpMir);\n \n+    // Insert AcquireValid and ReleaseValid calls.  Conceptually, this\n+    // pass is actually part of MIR building.\n+    passes.push_pass(MIR_CONST, mir::transform::add_validation::AddValidation);\n+\n     // Remove all `EndRegion` statements that are not involved in borrows.\n     passes.push_pass(MIR_CONST, mir::transform::clean_end_regions::CleanEndRegions);\n "}, {"sha": "6934ec7a74f26dda91d20118688bcff3e36da8c8", "filename": "src/librustc_mir/transform/add_validation.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/735ace977c75405084cb41b3b0613d14b55c811d/src%2Flibrustc_mir%2Ftransform%2Fadd_validation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/735ace977c75405084cb41b3b0613d14b55c811d/src%2Flibrustc_mir%2Ftransform%2Fadd_validation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fadd_validation.rs?ref=735ace977c75405084cb41b3b0613d14b55c811d", "patch": "@@ -0,0 +1,43 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! This pass adds validation calls (AcquireValid, ReleaseValid) where appropriate.\n+//! It has to be run really early, before transformations like inlining, because\n+//! introducing these calls *adds* UB -- so, conceptually, this pass is actually part\n+//! of MIR building, and only after this pass we think of the program has having the\n+//! normal MIR semantics.\n+\n+use rustc::ty::TyCtxt;\n+use rustc::mir::*;\n+use rustc::mir::transform::{MirPass, MirSource};\n+\n+pub struct AddValidation;\n+\n+impl MirPass for AddValidation {\n+    fn run_pass<'a, 'tcx>(&self,\n+                          _tcx: TyCtxt<'a, 'tcx, 'tcx>,\n+                          _: MirSource,\n+                          mir: &mut Mir<'tcx>) {\n+        // Add an AcquireValid at the beginning of the start block\n+        if mir.arg_count > 0 {\n+            let acquire_stmt = Statement {\n+                source_info: SourceInfo {\n+                    scope: ARGUMENT_VISIBILITY_SCOPE,\n+                    span: mir.span,\n+                },\n+                kind: StatementKind::Validate(ValidationOp::Acquire,\n+                    // Skip return value, go over all the arguments\n+                    mir.local_decls.iter_enumerated().skip(1).take(mir.arg_count)\n+                    .map(|(local, local_decl)| (local_decl.ty, Lvalue::Local(local))).collect())\n+            };\n+            mir.basic_blocks_mut()[START_BLOCK].statements.insert(0, acquire_stmt);\n+        }\n+    }\n+}"}, {"sha": "a247ce2231e769195ec4b13a10b1a60a8086d4f0", "filename": "src/librustc_mir/transform/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/735ace977c75405084cb41b3b0613d14b55c811d/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/735ace977c75405084cb41b3b0613d14b55c811d/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fmod.rs?ref=735ace977c75405084cb41b3b0613d14b55c811d", "patch": "@@ -24,6 +24,7 @@ use syntax::ast;\n use syntax_pos::{DUMMY_SP, Span};\n use transform;\n \n+pub mod add_validation;\n pub mod clean_end_regions;\n pub mod simplify_branches;\n pub mod simplify;"}]}