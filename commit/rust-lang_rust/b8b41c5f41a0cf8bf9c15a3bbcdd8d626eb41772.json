{"sha": "b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI4YjQxYzVmNDFhMGNmOGJmOWMxNWEzYmJjZGQ4ZDYyNmViNDE3NzI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-15T09:43:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-15T09:43:08Z"}, "message": "Merge #5354\n\n5354: Add opt-in mimalloc feature r=matklad a=ivan\n\nThis adds a `mimalloc` feature to use [mimalloc](https://github.com/microsoft/mimalloc) via [mimalloc_rust](https://github.com/purpleprotocol/mimalloc_rust), and a corresponding `cargo xtask install --server --mimalloc`.\r\n\r\nIn my tests on Linux, mimalloc seems to run consistently faster than jemalloc and uses only slightly more memory in `analysis-stats` on chalk. Also, builds with mimalloc produce a binary 3MB smaller than builds with jemalloc.\r\n\r\nA summary of `env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/` runs on NixOS master on an Intel 4790K in VMware Workstation:\r\n\r\n<table>\r\n<tr>\r\n<td></td><td>self-reported time</td><td>elapsed time</td><td>max RSS</td>\r\n</tr>\r\n<tr><td>glibc 2.30 run 1</td><td>225.1 sec</td><td>3:46.91</td><td>1075208</td></tr>\r\n<tr><td>glibc 2.30 run 2</td><td>228.4 sec</td><td>3:50.13</td><td>1074996</td></tr>\r\n<tr><td>jemalloc run 1</td><td>201.8 sec</td><td>3:23.03</td><td>1055960</td></tr>\r\n<tr><td>jemalloc run 2</td><td>199.2 sec</td><td>3:20.41</td><td>1065040</td></tr>\r\n<tr><td>mimalloc run 1</td><td>188.6 sec</td><td>3:09.77</td><td>1105584</td></tr>\r\n<tr><td>mimalloc run 2</td><td>185.0 sec</td><td>3:06.23</td><td>1108132</td></tr>\r\n<tr><td>mimalloc + lto run 1</td><td>160.7 sec</td><td>2:41.80</td><td>1106076</td></tr>\r\n<tr><td>mimalloc + lto run 2</td><td>162.2 sec</td><td>2:43.31</td><td>1104268</td></tr>\r\n</tr>\r\n</table>\r\n\r\nI included an `lto = true; codegen-units = 1` run out of curiosity, this PR doesn't enable it.\r\n\r\n<details>\r\n<summary>analysis-stats benchmark runs</summary>\r\n\r\n## default\r\n\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 333.880345ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 10.176299461s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 214.968806927s, 0b allocated 0b resident\r\nTotal: 225.145114417s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 225.34\r\n        System time (seconds): 1.49\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:46.91\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1075208\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 6\r\n        Minor (reclaiming a frame) page faults: 294711\r\n        Voluntary context switches: 365\r\n        Involuntary context switches: 3273\r\n        Swaps: 0\r\n        File system inputs: 2904\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 332.711598ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.895020518s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 218.5001697s, 0b allocated 0b resident\r\nTotal: 228.39519833s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 228.26\r\n        System time (seconds): 1.75\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:50.13\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1074996\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 9\r\n        Minor (reclaiming a frame) page faults: 294748\r\n        Voluntary context switches: 330\r\n        Involuntary context switches: 1561\r\n        Swaps: 0\r\n        File system inputs: 12608\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n\r\n## jemalloc\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.11s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 356.090374ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 10.176550183s, 439mb allocated 465mb resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 191.607201827s, 993mb allocated 1036mb resident\r\nTotal: 201.783937913s, 993mb allocated 1036mb resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 201.07\r\n        System time (seconds): 1.89\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:23.03\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1055960\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 357755\r\n        Voluntary context switches: 240\r\n        Involuntary context switches: 1889\r\n        Swaps: 0\r\n        File system inputs: 256\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 317.917622ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.902142185s, 439mb allocated 463mb resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 189.295317017s, 993mb allocated 1046mb resident\r\nTotal: 199.197555943s, 993mb allocated 1046mb resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 198.64\r\n        System time (seconds): 1.67\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:20.41\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1065040\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 369013\r\n        Voluntary context switches: 243\r\n        Involuntary context switches: 2835\r\n        Swaps: 0\r\n        File system inputs: 0\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n\r\n## mimalloc\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.12s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 332.116806ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.796643695s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 178.82132362s, 0b allocated 0b resident\r\nTotal: 188.617975605s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 187.70\r\n        System time (seconds): 1.97\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:09.77\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1105584\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 296481\r\n        Voluntary context switches: 222\r\n        Involuntary context switches: 1868\r\n        Swaps: 0\r\n        File system inputs: 256\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.13s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 320.046776ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.287690124s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 175.710939697s, 0b allocated 0b resident\r\nTotal: 184.998640033s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 184.38\r\n        System time (seconds): 1.81\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:06.23\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1108132\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 297055\r\n        Voluntary context switches: 374\r\n        Involuntary context switches: 2374\r\n        Swaps: 0\r\n        File system inputs: 0\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n\r\n## mimalloc + lto\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.11s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 369.600196ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 7.572726834s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 153.090899101s, 0b allocated 0b resident\r\nTotal: 160.663635235s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 160.01\r\n        System time (seconds): 1.70\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 2:41.80\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1106076\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 1\r\n        Minor (reclaiming a frame) page faults: 296610\r\n        Voluntary context switches: 209\r\n        Involuntary context switches: 2798\r\n        Swaps: 0\r\n        File system inputs: 8\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 334.630658ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 7.71699197s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 154.50351318s, 0b allocated 0b resident\r\nTotal: 162.220513775s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 161.52\r\n        System time (seconds): 1.74\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 2:43.31\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1104268\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 296183\r\n        Voluntary context switches: 200\r\n        Involuntary context switches: 1666\r\n        Swaps: 0\r\n        File system inputs: 0\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n</details>\n\nCo-authored-by: Ivan Kozik <ivan@ludios.org>", "tree": {"sha": "5f68995303745ccfe6a9fb9a95255c09fdc5d9b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f68995303745ccfe6a9fb9a95255c09fdc5d9b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfDs+sCRBK7hj4Ov3rIwAAdHIIAIyRvtQCTChb8HqdCSSL5fsm\n6iHwrJwK4ZZJiABBhA+R17o2qa7WJBwhmD+FWDtsTkfiwScaCNcBJ9A4+plyv1kZ\n/kc3JgjfDy4YtekD8ohs/9oLdpH/2ovOW6PZI6K1LFVnhqaVMhFZTXiOBEeKSULA\nyEK2jNUQccFHRqlGz0Qlgm3cDe8AoALkq/+yEEujo4tnl9+gwvr15acS8hIN0JQQ\nr/K12EoiqfqcBjIoiNuFypcq25+V8ialwaQFGZVnM7+xI4t+9vCyZSGRwIGctYZ6\nd+mIg8fCdTS4fBhcRbkAYRQi7CFuHDap+Ee48Qx1WRKfVWTtAfev8ygGvEGf/Sk=\n=wiDY\n-----END PGP SIGNATURE-----\n", "payload": "tree 5f68995303745ccfe6a9fb9a95255c09fdc5d9b5\nparent 77425c21c797bab5ae66c418751d689691229651\nparent 6710856c1098f71168c47451af53bac9a33b49dd\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1594806188 +0000\ncommitter GitHub <noreply@github.com> 1594806188 +0000\n\nMerge #5354\n\n5354: Add opt-in mimalloc feature r=matklad a=ivan\n\nThis adds a `mimalloc` feature to use [mimalloc](https://github.com/microsoft/mimalloc) via [mimalloc_rust](https://github.com/purpleprotocol/mimalloc_rust), and a corresponding `cargo xtask install --server --mimalloc`.\r\n\r\nIn my tests on Linux, mimalloc seems to run consistently faster than jemalloc and uses only slightly more memory in `analysis-stats` on chalk. Also, builds with mimalloc produce a binary 3MB smaller than builds with jemalloc.\r\n\r\nA summary of `env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/` runs on NixOS master on an Intel 4790K in VMware Workstation:\r\n\r\n<table>\r\n<tr>\r\n<td></td><td>self-reported time</td><td>elapsed time</td><td>max RSS</td>\r\n</tr>\r\n<tr><td>glibc 2.30 run 1</td><td>225.1 sec</td><td>3:46.91</td><td>1075208</td></tr>\r\n<tr><td>glibc 2.30 run 2</td><td>228.4 sec</td><td>3:50.13</td><td>1074996</td></tr>\r\n<tr><td>jemalloc run 1</td><td>201.8 sec</td><td>3:23.03</td><td>1055960</td></tr>\r\n<tr><td>jemalloc run 2</td><td>199.2 sec</td><td>3:20.41</td><td>1065040</td></tr>\r\n<tr><td>mimalloc run 1</td><td>188.6 sec</td><td>3:09.77</td><td>1105584</td></tr>\r\n<tr><td>mimalloc run 2</td><td>185.0 sec</td><td>3:06.23</td><td>1108132</td></tr>\r\n<tr><td>mimalloc + lto run 1</td><td>160.7 sec</td><td>2:41.80</td><td>1106076</td></tr>\r\n<tr><td>mimalloc + lto run 2</td><td>162.2 sec</td><td>2:43.31</td><td>1104268</td></tr>\r\n</tr>\r\n</table>\r\n\r\nI included an `lto = true; codegen-units = 1` run out of curiosity, this PR doesn't enable it.\r\n\r\n<details>\r\n<summary>analysis-stats benchmark runs</summary>\r\n\r\n## default\r\n\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 333.880345ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 10.176299461s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 214.968806927s, 0b allocated 0b resident\r\nTotal: 225.145114417s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 225.34\r\n        System time (seconds): 1.49\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:46.91\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1075208\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 6\r\n        Minor (reclaiming a frame) page faults: 294711\r\n        Voluntary context switches: 365\r\n        Involuntary context switches: 3273\r\n        Swaps: 0\r\n        File system inputs: 2904\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 332.711598ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.895020518s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 218.5001697s, 0b allocated 0b resident\r\nTotal: 228.39519833s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 228.26\r\n        System time (seconds): 1.75\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:50.13\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1074996\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 9\r\n        Minor (reclaiming a frame) page faults: 294748\r\n        Voluntary context switches: 330\r\n        Involuntary context switches: 1561\r\n        Swaps: 0\r\n        File system inputs: 12608\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n\r\n## jemalloc\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.11s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 356.090374ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 10.176550183s, 439mb allocated 465mb resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 191.607201827s, 993mb allocated 1036mb resident\r\nTotal: 201.783937913s, 993mb allocated 1036mb resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 201.07\r\n        System time (seconds): 1.89\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:23.03\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1055960\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 357755\r\n        Voluntary context switches: 240\r\n        Involuntary context switches: 1889\r\n        Swaps: 0\r\n        File system inputs: 256\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 317.917622ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.902142185s, 439mb allocated 463mb resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 189.295317017s, 993mb allocated 1046mb resident\r\nTotal: 199.197555943s, 993mb allocated 1046mb resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 198.64\r\n        System time (seconds): 1.67\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:20.41\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1065040\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 369013\r\n        Voluntary context switches: 243\r\n        Involuntary context switches: 2835\r\n        Swaps: 0\r\n        File system inputs: 0\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n\r\n## mimalloc\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.12s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 332.116806ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.796643695s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 178.82132362s, 0b allocated 0b resident\r\nTotal: 188.617975605s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 187.70\r\n        System time (seconds): 1.97\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:09.77\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1105584\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 296481\r\n        Voluntary context switches: 222\r\n        Involuntary context switches: 1868\r\n        Swaps: 0\r\n        File system inputs: 256\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.13s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 320.046776ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 9.287690124s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 175.710939697s, 0b allocated 0b resident\r\nTotal: 184.998640033s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 184.38\r\n        System time (seconds): 1.81\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 3:06.23\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1108132\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 297055\r\n        Voluntary context switches: 374\r\n        Involuntary context switches: 2374\r\n        Swaps: 0\r\n        File system inputs: 0\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n\r\n## mimalloc + lto\r\n```\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.11s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 369.600196ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 7.572726834s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 153.090899101s, 0b allocated 0b resident\r\nTotal: 160.663635235s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 160.01\r\n        System time (seconds): 1.70\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 2:41.80\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1106076\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 1\r\n        Minor (reclaiming a frame) page faults: 296610\r\n        Voluntary context switches: 209\r\n        Involuntary context switches: 2798\r\n        Swaps: 0\r\n        File system inputs: 8\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n# env time -v cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\r\n    Finished release [optimized] target(s) in 0.10s\r\n     Running `target/release/rust-analyzer analysis-stats ../chalk/`\r\n[ERROR ra_project_model] cyclic dependency chalk-integration -> chalk-engine\r\n[ERROR ra_project_model] cyclic dependency chalk-recursive -> chalk-integration\r\n[ERROR ra_project_model] cyclic dependency chalk-solve -> chalk-integration\r\nDatabase loaded 334.630658ms\r\nCrates in this dir: 11\r\nTotal modules found: 159\r\nTotal declarations: 2631\r\nTotal functions: 1947\r\nItem Collection: 7.71699197s, 0b allocated 0b resident\r\nTotal expressions: 57094\r\nExpressions of unknown type: 2938 (5%)\r\nExpressions of partially unknown type: 2427 (4%)\r\nType mismatches: 232\r\nInference: 154.50351318s, 0b allocated 0b resident\r\nTotal: 162.220513775s, 0b allocated 0b resident\r\n        Command being timed: \"cargo run --release -p rust-analyzer -- analysis-stats ../chalk/\"\r\n        User time (seconds): 161.52\r\n        System time (seconds): 1.74\r\n        Percent of CPU this job got: 99%\r\n        Elapsed (wall clock) time (h:mm:ss or m:ss): 2:43.31\r\n        Average shared text size (kbytes): 0\r\n        Average unshared data size (kbytes): 0\r\n        Average stack size (kbytes): 0\r\n        Average total size (kbytes): 0\r\n        Maximum resident set size (kbytes): 1104268\r\n        Average resident set size (kbytes): 0\r\n        Major (requiring I/O) page faults: 0\r\n        Minor (reclaiming a frame) page faults: 296183\r\n        Voluntary context switches: 200\r\n        Involuntary context switches: 1666\r\n        Swaps: 0\r\n        File system inputs: 0\r\n        File system outputs: 0\r\n        Socket messages sent: 0\r\n        Socket messages received: 0\r\n        Signals delivered: 0\r\n        Page size (bytes): 4096\r\n        Exit status: 0\r\n```\r\n</details>\n\nCo-authored-by: Ivan Kozik <ivan@ludios.org>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "html_url": "https://github.com/rust-lang/rust/commit/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77425c21c797bab5ae66c418751d689691229651", "url": "https://api.github.com/repos/rust-lang/rust/commits/77425c21c797bab5ae66c418751d689691229651", "html_url": "https://github.com/rust-lang/rust/commit/77425c21c797bab5ae66c418751d689691229651"}, {"sha": "6710856c1098f71168c47451af53bac9a33b49dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/6710856c1098f71168c47451af53bac9a33b49dd", "html_url": "https://github.com/rust-lang/rust/commit/6710856c1098f71168c47451af53bac9a33b49dd"}], "stats": {"total": 66, "additions": 60, "deletions": 6}, "files": [{"sha": "6cc44e0da048e5b53c9820ffcaf55769690369cd", "filename": "Cargo.lock", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "patch": "@@ -214,6 +214,15 @@ dependencies = [\n  \"bitflags\",\n ]\n \n+[[package]]\n+name = \"cmake\"\n+version = \"0.1.44\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"0e56268c17a6248366d66d4a47a3381369d068cce8409bb1716ed77ea32163bb\"\n+dependencies = [\n+ \"cc\",\n+]\n+\n [[package]]\n name = \"console\"\n version = \"0.11.3\"\n@@ -674,6 +683,15 @@ dependencies = [\n  \"winapi 0.3.9\",\n ]\n \n+[[package]]\n+name = \"libmimalloc-sys\"\n+version = \"0.1.15\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"a27252ec1d0c4e0dd6142cbc572da50b363ab56fc334f7aa8fadf295b2e24e74\"\n+dependencies = [\n+ \"cmake\",\n+]\n+\n [[package]]\n name = \"linked-hash-map\"\n version = \"0.5.3\"\n@@ -770,6 +788,15 @@ dependencies = [\n  \"autocfg\",\n ]\n \n+[[package]]\n+name = \"mimalloc\"\n+version = \"0.1.19\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"6c52de2069999f01bd26436564dbe7de3a87898feeb7a0d0ff9eb20a05bb7ca0\"\n+dependencies = [\n+ \"libmimalloc-sys\",\n+]\n+\n [[package]]\n name = \"miniz_oxide\"\n version = \"0.4.0\"\n@@ -1248,6 +1275,7 @@ dependencies = [\n  \"backtrace\",\n  \"jemalloc-ctl\",\n  \"jemallocator\",\n+ \"mimalloc\",\n  \"once_cell\",\n  \"ra_arena\",\n ]"}, {"sha": "b3d52985af04bcc4ca1bfc9b0987eeb3ea3024a4", "filename": "crates/ra_prof/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/crates%2Fra_prof%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/crates%2Fra_prof%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2FCargo.toml?ref=b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "patch": "@@ -13,6 +13,7 @@ doctest = false\n ra_arena = { path = \"../ra_arena\" }\n once_cell = \"1.3.1\"\n backtrace = { version = \"0.3.44\", optional = true }\n+mimalloc = { version = \"0.1.19\", default-features = false, optional = true }\n \n [target.'cfg(not(target_env = \"msvc\"))'.dependencies]\n jemallocator = { version = \"0.3.2\", optional = true }\n@@ -25,4 +26,5 @@ cpu_profiler = []\n # Uncomment to enable for the whole crate graph\n # default = [ \"backtrace\" ]\n # default = [ \"jemalloc\" ]\n+# default = [ \"mimalloc\" ]\n # default = [ \"cpu_profiler\" ]"}, {"sha": "b54531b4e13150d1804189b80f2d8e305cc08d3d", "filename": "crates/ra_prof/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/crates%2Fra_prof%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/crates%2Fra_prof%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2Fsrc%2Flib.rs?ref=b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "patch": "@@ -19,6 +19,10 @@ pub use crate::{\n #[global_allocator]\n static ALLOC: jemallocator::Jemalloc = jemallocator::Jemalloc;\n \n+#[cfg(all(feature = \"mimalloc\"))]\n+#[global_allocator]\n+static ALLOC: mimalloc::MiMalloc = mimalloc::MiMalloc;\n+\n /// Prints backtrace to stderr, useful for debugging.\n #[cfg(feature = \"backtrace\")]\n pub fn print_backtrace() {"}, {"sha": "57724bcbc59f8ef273ee03951972d163760faa0b", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "patch": "@@ -66,3 +66,4 @@ tt = { path = \"../ra_tt\", package = \"ra_tt\" }\n \n [features]\n jemalloc = [ \"ra_prof/jemalloc\" ]\n+mimalloc = [ \"ra_prof/mimalloc\" ]"}, {"sha": "a0dc0c9c2105469c88cfcc1e19e545fc320a77bf", "filename": "xtask/src/install.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/xtask%2Fsrc%2Finstall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/xtask%2Fsrc%2Finstall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Finstall.rs?ref=b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "patch": "@@ -19,7 +19,13 @@ pub enum ClientOpt {\n }\n \n pub struct ServerOpt {\n-    pub jemalloc: bool,\n+    pub malloc: Malloc,\n+}\n+\n+pub enum Malloc {\n+    System,\n+    Jemalloc,\n+    Mimalloc,\n }\n \n impl InstallCmd {\n@@ -130,8 +136,12 @@ fn install_server(opts: ServerOpt) -> Result<()> {\n         )\n     }\n \n-    let jemalloc = if opts.jemalloc { \"--features jemalloc\" } else { \"\" };\n-    let res = run!(\"cargo install --path crates/rust-analyzer --locked --force {}\", jemalloc);\n+    let malloc_feature = match opts.malloc {\n+        Malloc::System => \"\",\n+        Malloc::Jemalloc => \"--features jemalloc\",\n+        Malloc::Mimalloc => \"--features mimalloc\",\n+    };\n+    let res = run!(\"cargo install --path crates/rust-analyzer --locked --force {}\", malloc_feature);\n \n     if res.is_err() && old_rust {\n         eprintln!("}, {"sha": "399ff72049b77b80add6e47d501e1507ae146e34", "filename": "xtask/src/main.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/xtask%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772/xtask%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fmain.rs?ref=b8b41c5f41a0cf8bf9c15a3bbcdd8d626eb41772", "patch": "@@ -14,7 +14,7 @@ use pico_args::Arguments;\n use xtask::{\n     codegen::{self, Mode},\n     dist::run_dist,\n-    install::{ClientOpt, InstallCmd, ServerOpt},\n+    install::{ClientOpt, InstallCmd, Malloc, ServerOpt},\n     not_bash::pushd,\n     pre_commit, project_root,\n     release::{PromoteCmd, ReleaseCmd},\n@@ -46,6 +46,7 @@ FLAGS:\n         --client-code    Install only VS Code plugin\n         --server         Install only the language server\n         --jemalloc       Use jemalloc for server\n+        --mimalloc       Use mimalloc for server\n     -h, --help           Prints help information\n         \"\n                 );\n@@ -61,13 +62,21 @@ FLAGS:\n                 return Ok(());\n             }\n \n-            let jemalloc = args.contains(\"--jemalloc\");\n+            let malloc = match (args.contains(\"--jemalloc\"), args.contains(\"--mimalloc\")) {\n+                (false, false) => Malloc::System,\n+                (true, false) => Malloc::Jemalloc,\n+                (false, true) => Malloc::Mimalloc,\n+                (true, true) => {\n+                    eprintln!(\"error: Cannot use both `--jemalloc` and `--mimalloc`\");\n+                    return Ok(());\n+                }\n+            };\n \n             args.finish()?;\n \n             InstallCmd {\n                 client: if server { None } else { Some(ClientOpt::VsCode) },\n-                server: if client_code { None } else { Some(ServerOpt { jemalloc }) },\n+                server: if client_code { None } else { Some(ServerOpt { malloc }) },\n             }\n             .run()\n         }"}]}