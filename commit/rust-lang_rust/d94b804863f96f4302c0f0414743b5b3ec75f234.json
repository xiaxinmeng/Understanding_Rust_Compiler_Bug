{"sha": "d94b804863f96f4302c0f0414743b5b3ec75f234", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5NGI4MDQ4NjNmOTZmNDMwMmMwZjA0MTQ3NDNiNWIzZWM3NWYyMzQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-01T08:41:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-01T08:41:50Z"}, "message": "Auto merge of #51882 - varkor:check-type_dependent_defs, r=estebank\n\nAlways check type_dependent_defs\n\nDirectly indexing into `type_dependent_defs` has caused multiple ICEs in the past (https://github.com/rust-lang/rust/issues/46771, https://github.com/rust-lang/rust/issues/49241, etc.) and is almost certainly responsible for #51798 too. This PR ensures we always check `type_dependent_defs` first, which should prevent any more of these (or at least make them easier to track down).", "tree": {"sha": "bfa8924528c7adf0b5ce73fc97185d42dc560e23", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfa8924528c7adf0b5ce73fc97185d42dc560e23"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d94b804863f96f4302c0f0414743b5b3ec75f234", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d94b804863f96f4302c0f0414743b5b3ec75f234", "html_url": "https://github.com/rust-lang/rust/commit/d94b804863f96f4302c0f0414743b5b3ec75f234", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d94b804863f96f4302c0f0414743b5b3ec75f234/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1703baf520b8c14f50719c9ffa8036f3b782134", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1703baf520b8c14f50719c9ffa8036f3b782134", "html_url": "https://github.com/rust-lang/rust/commit/a1703baf520b8c14f50719c9ffa8036f3b782134"}, {"sha": "4071adfcb5c9fa0d28f4ea096c19a3e8d4c802ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/4071adfcb5c9fa0d28f4ea096c19a3e8d4c802ff", "html_url": "https://github.com/rust-lang/rust/commit/4071adfcb5c9fa0d28f4ea096c19a3e8d4c802ff"}], "stats": {"total": 39, "additions": 28, "deletions": 11}, "files": [{"sha": "c846b627d8926ab77c3050e14746bfb66fa4ea1b", "filename": "src/librustc/middle/dead.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc%2Fmiddle%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc%2Fmiddle%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fdead.rs?ref=d94b804863f96f4302c0f0414743b5b3ec75f234", "patch": "@@ -96,7 +96,11 @@ impl<'a, 'tcx> MarkSymbolVisitor<'a, 'tcx> {\n     }\n \n     fn lookup_and_handle_method(&mut self, id: hir::HirId) {\n-        self.check_def_id(self.tables.type_dependent_defs()[id].def_id());\n+        if let Some(def) = self.tables.type_dependent_defs().get(id) {\n+            self.check_def_id(def.def_id());\n+        } else {\n+            bug!(\"no type-dependent def for method\");\n+        }\n     }\n \n     fn handle_field_access(&mut self, lhs: &hir::Expr, node_id: ast::NodeId) {"}, {"sha": "476f3f5799daf6d322cf9908de8f42a7c9400c9e", "filename": "src/librustc/middle/reachable.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc%2Fmiddle%2Freachable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc%2Fmiddle%2Freachable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Freachable.rs?ref=d94b804863f96f4302c0f0414743b5b3ec75f234", "patch": "@@ -120,7 +120,7 @@ impl<'a, 'tcx> Visitor<'tcx> for ReachableContext<'a, 'tcx> {\n                 Some(self.tables.qpath_def(qpath, expr.hir_id))\n             }\n             hir::ExprMethodCall(..) => {\n-                Some(self.tables.type_dependent_defs()[expr.hir_id])\n+                self.tables.type_dependent_defs().get(expr.hir_id).cloned()\n             }\n             _ => None\n         };"}, {"sha": "05aa57d8cc5d78cd687414465591aa261a089866", "filename": "src/librustc_lint/builtin.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc_lint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc_lint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fbuiltin.rs?ref=d94b804863f96f4302c0f0414743b5b3ec75f234", "patch": "@@ -1004,10 +1004,15 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnconditionalRecursion {\n             // Check for method calls and overloaded operators.\n             if cx.tables.is_method_call(expr) {\n                 let hir_id = cx.tcx.hir.definitions().node_to_hir_id(id);\n-                let def_id = cx.tables.type_dependent_defs()[hir_id].def_id();\n-                let substs = cx.tables.node_substs(hir_id);\n-                if method_call_refers_to_method(cx, method, def_id, substs, id) {\n-                    return true;\n+                if let Some(def) = cx.tables.type_dependent_defs().get(hir_id) {\n+                    let def_id = def.def_id();\n+                    let substs = cx.tables.node_substs(hir_id);\n+                    if method_call_refers_to_method(cx, method, def_id, substs, id) {\n+                        return true;\n+                    }\n+                } else {\n+                    cx.tcx.sess.delay_span_bug(expr.span,\n+                                               \"no type-dependent def for method call\");\n                 }\n             }\n "}, {"sha": "8c73771e57b22544be20dc014a3b64603f432ec4", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=d94b804863f96f4302c0f0414743b5b3ec75f234", "patch": "@@ -692,8 +692,11 @@ fn method_callee<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n                                  -> Expr<'tcx> {\n     let temp_lifetime = cx.region_scope_tree.temporary_scope(expr.hir_id.local_id);\n     let (def_id, substs) = custom_callee.unwrap_or_else(|| {\n-        (cx.tables().type_dependent_defs()[expr.hir_id].def_id(),\n-         cx.tables().node_substs(expr.hir_id))\n+        if let Some(def) = cx.tables().type_dependent_defs().get(expr.hir_id) {\n+            (def.def_id(), cx.tables().node_substs(expr.hir_id))\n+        } else {\n+            span_bug!(expr.span, \"no type-dependent def for method callee\")\n+        }\n     });\n     let ty = cx.tcx().mk_fn_def(def_id, substs);\n     Expr {"}, {"sha": "157da5ee6d5eeaff8467d30f5c8e76cecc06a94b", "filename": "src/librustc_privacy/lib.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc_privacy%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d94b804863f96f4302c0f0414743b5b3ec75f234/src%2Flibrustc_privacy%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_privacy%2Flib.rs?ref=d94b804863f96f4302c0f0414743b5b3ec75f234", "patch": "@@ -795,10 +795,15 @@ impl<'a, 'tcx> Visitor<'tcx> for TypePrivacyVisitor<'a, 'tcx> {\n             }\n             hir::ExprMethodCall(_, span, _) => {\n                 // Method calls have to be checked specially.\n-                let def_id = self.tables.type_dependent_defs()[expr.hir_id].def_id();\n                 self.span = span;\n-                if self.tcx.type_of(def_id).visit_with(self) {\n-                    return;\n+                if let Some(def) = self.tables.type_dependent_defs().get(expr.hir_id) {\n+                    let def_id = def.def_id();\n+                    if self.tcx.type_of(def_id).visit_with(self) {\n+                        return;\n+                    }\n+                } else {\n+                    self.tcx.sess.delay_span_bug(expr.span,\n+                                                 \"no type-dependent def for method call\");\n                 }\n             }\n             _ => {}"}]}