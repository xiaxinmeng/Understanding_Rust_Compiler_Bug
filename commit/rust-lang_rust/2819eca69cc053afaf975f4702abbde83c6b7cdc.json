{"sha": "2819eca69cc053afaf975f4702abbde83c6b7cdc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4MTllY2E2OWNjMDUzYWZhZjk3NWY0NzAyYWJiZGU4M2M2YjdjZGM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-09-07T09:47:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-07T09:47:35Z"}, "message": "Auto merge of #36296 - nagisa:pass-timing, r=eddyb\n\nCount and report time taken by MIR passes\n\nThere\u2019s some desire for deeper introspectability into what MIR passes cost us.\n\n-Z time-passes after this PR:\n\n```\n   Compiling test_shim v0.1.0 (file:///home/nagisa/Documents/rust/rust/src/rustc/test_shim)\ntime: 0.000; rss: 29MB\tparsing\ntime: 0.000; rss: 29MB\tconfiguration\ntime: 0.000; rss: 29MB\trecursion limit\ntime: 0.000; rss: 29MB\tcrate injection\ntime: 0.000; rss: 29MB\tplugin loading\ntime: 0.000; rss: 29MB\tplugin registration\ntime: 0.032; rss: 54MB\texpansion\ntime: 0.000; rss: 54MB\tmaybe building test harness\ntime: 0.000; rss: 54MB\tassigning node ids\ntime: 0.000; rss: 54MB\tchecking for inline asm in case the target doesn't support it\ntime: 0.000; rss: 54MB\tcomplete gated feature checking\ntime: 0.000; rss: 54MB\tcollecting defs\ntime: 0.004; rss: 54MB\texternal crate/lib resolution\ntime: 0.000; rss: 54MB\tearly lint checks\ntime: 0.000; rss: 54MB\tAST validation\ntime: 0.001; rss: 54MB\tname resolution\ntime: 0.000; rss: 54MB\tlowering ast -> hir\ntime: 0.000; rss: 56MB\tindexing hir\ntime: 0.000; rss: 56MB\tattribute checking\ntime: 0.000; rss: 56MB\tlanguage item collection\ntime: 0.000; rss: 56MB\tlifetime resolution\ntime: 0.000; rss: 56MB\tlooking for entry point\ntime: 0.000; rss: 56MB\tlooking for plugin registrar\ntime: 0.000; rss: 56MB\tregion resolution\ntime: 0.000; rss: 56MB\tloop checking\ntime: 0.000; rss: 56MB\tstatic item recursion checking\ntime: 0.000; rss: 56MB\tcompute_incremental_hashes_map\ntime: 0.000; rss: 56MB\tload_dep_graph\ntime: 0.000; rss: 56MB\ttype collecting\ntime: 0.000; rss: 56MB\tvariance inference\ntime: 0.011; rss: 59MB\tcoherence checking\ntime: 0.000; rss: 59MB\twf checking\ntime: 0.000; rss: 59MB\titem-types checking\ntime: 0.000; rss: 59MB\titem-bodies checking\ntime: 0.000; rss: 59MB\tdrop-impl checking\ntime: 0.000; rss: 59MB\tconst checking\ntime: 0.000; rss: 59MB\tprivacy checking\ntime: 0.000; rss: 59MB\tstability index\ntime: 0.000; rss: 59MB\tintrinsic checking\ntime: 0.000; rss: 59MB\teffect checking\ntime: 0.000; rss: 59MB\tmatch checking\ntime: 0.000; rss: 59MB\tliveness checking\ntime: 0.000; rss: 59MB\trvalue checking\ntime: 0.000; rss: 59MB\tMIR dump\n  time: 0.000; rss: 59MB\tSimplifyCfg\n  time: 0.000; rss: 59MB\tQualifyAndPromoteConstants\n  time: 0.000; rss: 59MB\tTypeckMir\n  time: 0.000; rss: 59MB\tSimplifyBranches\n  time: 0.000; rss: 59MB\tSimplifyCfg\ntime: 0.000; rss: 59MB\tMIR passes\ntime: 0.000; rss: 59MB\tborrow checking\ntime: 0.000; rss: 59MB\treachability checking\ntime: 0.000; rss: 59MB\tdeath checking\ntime: 0.000; rss: 59MB\tstability checking\ntime: 0.000; rss: 59MB\tunused lib feature checking\ntime: 0.000; rss: 59MB\tlint checking\ntime: 0.000; rss: 59MB\tresolving dependency formats\n  time: 0.000; rss: 59MB\tNoLandingPads\n  time: 0.000; rss: 59MB\tSimplifyCfg\n  time: 0.000; rss: 59MB\tEraseRegions\n  time: 0.000; rss: 59MB\tAddCallGuards\n  time: 0.000; rss: 59MB\tElaborateDrops\n  time: 0.000; rss: 59MB\tNoLandingPads\n  time: 0.000; rss: 59MB\tSimplifyCfg\n  time: 0.000; rss: 59MB\tDeaggregator\n  time: 0.000; rss: 59MB\tAddCallGuards\n  time: 0.000; rss: 59MB\tPreTrans\ntime: 0.000; rss: 59MB\tPrepare MIR codegen passes\n  time: 0.000; rss: 59MB\twrite metadata\n  time: 0.000; rss: 61MB\ttranslation item collection\n  time: 0.000; rss: 61MB\tcodegen unit partitioning\n  time: 0.000; rss: 61MB\tinternalize symbols\ntime: 0.007; rss: 61MB\ttranslation\ntime: 0.000; rss: 61MB\tassert dep graph\ntime: 0.000; rss: 61MB\tserialize dep graph\ntime: 0.000; rss: 61MB\tllvm function passes [2]\ntime: 0.000; rss: 61MB\tllvm function passes [3]\ntime: 0.000; rss: 61MB\tllvm function passes [1]\ntime: 0.000; rss: 61MB\tllvm function passes [0]\ntime: 0.000; rss: 61MB\tllvm module passes [2]\ntime: 0.000; rss: 61MB\tllvm module passes [1]\ntime: 0.000; rss: 61MB\tllvm module passes [0]\ntime: 0.000; rss: 61MB\tllvm module passes [3]\ntime: 0.001; rss: 62MB\tcodegen passes [1]\ntime: 0.001; rss: 62MB\tcodegen passes [2]\ntime: 0.001; rss: 62MB\tcodegen passes [0]\ntime: 0.001; rss: 62MB\tcodegen passes [3]\ntime: 0.001; rss: 63MB\tcodegen passes [1]\ntime: 0.005; rss: 63MB\tLLVM passes\ntime: 0.000; rss: 63MB\tserialize work products\ntime: 0.001; rss: 63MB\tlinking\n```\n\nr? @eddyb or @nikomatsakis\n\ncc @nrc, @Mark-Simulacrum", "tree": {"sha": "cd0a6501ea525c1ddb475830bfbf31d5e2445b6d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cd0a6501ea525c1ddb475830bfbf31d5e2445b6d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2819eca69cc053afaf975f4702abbde83c6b7cdc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2819eca69cc053afaf975f4702abbde83c6b7cdc", "html_url": "https://github.com/rust-lang/rust/commit/2819eca69cc053afaf975f4702abbde83c6b7cdc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2819eca69cc053afaf975f4702abbde83c6b7cdc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fe278a8a3218fd83d8bf21e82e2c0cc975d2fb64", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe278a8a3218fd83d8bf21e82e2c0cc975d2fb64", "html_url": "https://github.com/rust-lang/rust/commit/fe278a8a3218fd83d8bf21e82e2c0cc975d2fb64"}, {"sha": "0520698be30eeabd72e66d4b8fa540f727820c33", "url": "https://api.github.com/repos/rust-lang/rust/commits/0520698be30eeabd72e66d4b8fa540f727820c33", "html_url": "https://github.com/rust-lang/rust/commit/0520698be30eeabd72e66d4b8fa540f727820c33"}], "stats": {"total": 25, "additions": 13, "deletions": 12}, "files": [{"sha": "8cd5f5844d21c02e8f2b8a1fdd29165e46d6a8c9", "filename": "src/librustc/mir/transform.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc%2Fmir%2Ftransform.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc%2Fmir%2Ftransform.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Ftransform.rs?ref=2819eca69cc053afaf975f4702abbde83c6b7cdc", "patch": "@@ -15,7 +15,9 @@ use mir::mir_map::MirMap;\n use mir::repr::{Mir, Promoted};\n use ty::TyCtxt;\n use syntax::ast::NodeId;\n+use util::common::time;\n \n+use std::borrow::Cow;\n use std::fmt;\n \n /// Where a specific Mir comes from.\n@@ -72,12 +74,12 @@ impl<'a, 'tcx> MirSource {\n /// Various information about pass.\n pub trait Pass {\n     // fn should_run(Session) to check if pass should run?\n-    fn name(&self) -> &str {\n+    fn name<'a>(&self) -> Cow<'static, str> {\n         let name = unsafe { ::std::intrinsics::type_name::<Self>() };\n         if let Some(tail) = name.rfind(\":\") {\n-            &name[tail+1..]\n+            Cow::from(&name[tail+1..])\n         } else {\n-            name\n+            Cow::from(name)\n         }\n     }\n     fn disambiguator<'a>(&'a self) -> Option<Box<fmt::Display+'a>> { None }\n@@ -162,11 +164,10 @@ impl<'a, 'tcx> Passes {\n     }\n \n     pub fn run_passes(&mut self, tcx: TyCtxt<'a, 'tcx, 'tcx>, map: &mut MirMap<'tcx>) {\n-        for pass in &mut self.plugin_passes {\n-            pass.run_pass(tcx, map, &mut self.pass_hooks);\n-        }\n-        for pass in &mut self.passes {\n-            pass.run_pass(tcx, map, &mut self.pass_hooks);\n+        let Passes { ref mut passes, ref mut plugin_passes, ref mut pass_hooks } = *self;\n+        for pass in plugin_passes.iter_mut().chain(passes.iter_mut()) {\n+            time(tcx.sess.time_passes(), &*pass.name(),\n+                 || pass.run_pass(tcx, map, pass_hooks));\n         }\n     }\n "}, {"sha": "694b017bbd70687a9f9c0334d731200baa989f18", "filename": "src/librustc_mir/transform/dump_mir.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc_mir%2Ftransform%2Fdump_mir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc_mir%2Ftransform%2Fdump_mir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fdump_mir.rs?ref=2819eca69cc053afaf975f4702abbde83c6b7cdc", "patch": "@@ -26,7 +26,7 @@ impl<'b, 'tcx> MirPass<'tcx> for Marker<'b> {\n }\n \n impl<'b> Pass for Marker<'b> {\n-    fn name(&self) -> &str { self.0 }\n+    fn name(&self) -> ::std::borrow::Cow<'static, str> { String::from(self.0).into() }\n }\n \n pub struct Disambiguator<'a> {\n@@ -58,7 +58,7 @@ impl<'tcx> MirPassHook<'tcx> for DumpMir {\n     {\n         pretty::dump_mir(\n             tcx,\n-            pass.name(),\n+            &*pass.name(),\n             &Disambiguator {\n                 pass: pass,\n                 is_after: is_after"}, {"sha": "407e21616102cafc7d9ea67f9571c217329e974c", "filename": "src/librustc_mir/transform/simplify_branches.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc_mir%2Ftransform%2Fsimplify_branches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc_mir%2Ftransform%2Fsimplify_branches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify_branches.rs?ref=2819eca69cc053afaf975f4702abbde83c6b7cdc", "patch": "@@ -62,5 +62,5 @@ impl<'l> Pass for SimplifyBranches<'l> {\n     }\n \n     // avoid calling `type_name` - it contains `<'static>`\n-    fn name(&self) -> &str { \"SimplifyBranches\" }\n+    fn name(&self) -> ::std::borrow::Cow<'static, str> { \"SimplifyBranches\".into() }\n }"}, {"sha": "8e1b7b44976f33c0c2baf8875d646afff8e0ae6d", "filename": "src/librustc_mir/transform/simplify_cfg.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc_mir%2Ftransform%2Fsimplify_cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2819eca69cc053afaf975f4702abbde83c6b7cdc/src%2Flibrustc_mir%2Ftransform%2Fsimplify_cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify_cfg.rs?ref=2819eca69cc053afaf975f4702abbde83c6b7cdc", "patch": "@@ -64,7 +64,7 @@ impl<'l> Pass for SimplifyCfg<'l> {\n     }\n \n     // avoid calling `type_name` - it contains `<'static>`\n-    fn name(&self) -> &str { \"SimplifyCfg\" }\n+    fn name(&self) -> ::std::borrow::Cow<'static, str> { \"SimplifyCfg\".into() }\n }\n \n pub struct CfgSimplifier<'a, 'tcx: 'a> {"}]}