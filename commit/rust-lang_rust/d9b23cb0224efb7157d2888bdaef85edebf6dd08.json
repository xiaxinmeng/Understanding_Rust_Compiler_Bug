{"sha": "d9b23cb0224efb7157d2888bdaef85edebf6dd08", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5YjIzY2IwMjI0ZWZiNzE1N2QyODg4YmRhZWY4NWVkZWJmNmRkMDg=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-10-19T21:47:50Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-10-24T23:06:16Z"}, "message": "move comm functions out of rust abi", "tree": {"sha": "9b90f44fc8441a7dff8d2499dcda9f726f08b898", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b90f44fc8441a7dff8d2499dcda9f726f08b898"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9b23cb0224efb7157d2888bdaef85edebf6dd08", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9b23cb0224efb7157d2888bdaef85edebf6dd08", "html_url": "https://github.com/rust-lang/rust/commit/d9b23cb0224efb7157d2888bdaef85edebf6dd08", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9b23cb0224efb7157d2888bdaef85edebf6dd08/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "44697a4293ae083e57b49cc2afe6cf7fca71b10a", "url": "https://api.github.com/repos/rust-lang/rust/commits/44697a4293ae083e57b49cc2afe6cf7fca71b10a", "html_url": "https://github.com/rust-lang/rust/commit/44697a4293ae083e57b49cc2afe6cf7fca71b10a"}], "stats": {"total": 48, "additions": 34, "deletions": 14}, "files": [{"sha": "07097079c0e35bc58516c340c3dd6ce35b4c2d35", "filename": "src/lib/comm.rs", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/d9b23cb0224efb7157d2888bdaef85edebf6dd08/src%2Flib%2Fcomm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9b23cb0224efb7157d2888bdaef85edebf6dd08/src%2Flib%2Fcomm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib%2Fcomm.rs?ref=d9b23cb0224efb7157d2888bdaef85edebf6dd08", "patch": "@@ -8,17 +8,18 @@ export recv;\n export chan;\n export port;\n \n-native \"rust\" mod rustrt {\n+native \"c-stack-cdecl\" mod rustrt {\n     type void;\n     type rust_port;\n \n-    fn chan_id_send<~T>(target_task: task::task, target_port: port_id,\n+    fn chan_id_send<~T>(unused_task: *void, t: *sys::type_desc,\n+                        target_task: task::task, target_port: port_id,\n                         -data: T);\n \n-    fn new_port(unit_sz: uint) -> *rust_port;\n-    fn del_port(po: *rust_port);\n-    fn drop_port(po: *rust_port);\n-    fn get_port_id(po: *rust_port) -> port_id;\n+    fn new_port(unused_task: *void, unit_sz: uint) -> *rust_port;\n+    fn del_port(unused_task: *void, po: *rust_port);\n+    fn drop_port(unused_task: *void, po: *rust_port);\n+    fn get_port_id(unused_task: *void, po: *rust_port) -> port_id;\n }\n \n native \"rust-intrinsic\" mod rusti {\n@@ -32,23 +33,28 @@ type port_id = int;\n tag chan<~T> { chan_t(task::task, port_id); }\n \n resource port_ptr(po: *rustrt::rust_port) {\n-    rustrt::drop_port(po);\n-    rustrt::del_port(po);\n+    rustrt::drop_port(ptr::null(), po);\n+    rustrt::del_port(ptr::null(), po);\n }\n \n tag port<~T> { port_t(@port_ptr); }\n \n fn send<~T>(ch: chan<T>, -data: T) {\n     let chan_t(t, p) = ch;\n-    rustrt::chan_id_send(t, p, data);\n+    rustrt::chan_id_send(ptr::null(), sys::get_type_desc::<T>(), t, p, data);\n+    task::yield();\n }\n \n fn port<~T>() -> port<T> {\n-    port_t(@port_ptr(rustrt::new_port(sys::size_of::<T>())))\n+    let p = rustrt::new_port(ptr::null(), sys::size_of::<T>());\n+    ret port_t(@port_ptr(p));\n }\n \n-fn recv<~T>(p: port<T>) -> T { ret rusti::recv(***p) }\n+fn recv<~T>(p: port<T>) -> T {\n+    ret rusti::recv(***p);\n+}\n \n fn chan<~T>(p: port<T>) -> chan<T> {\n-    chan_t(task::get_task_id(), rustrt::get_port_id(***p))\n+    let id = rustrt::get_port_id(ptr::null(), ***p);\n+    ret chan_t(task::get_task_id(), id);\n }"}, {"sha": "310d61b182e9a652f38ad3d28c60d2bfd277cbf2", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d9b23cb0224efb7157d2888bdaef85edebf6dd08/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/d9b23cb0224efb7157d2888bdaef85edebf6dd08/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=d9b23cb0224efb7157d2888bdaef85edebf6dd08", "patch": "@@ -576,7 +576,6 @@ chan_id_send(type_desc *t, rust_task_id target_task_id,\n             port->remote_chan->send(sptr);\n         }\n         target_task->deref();\n-        task->yield();\n     }\n }\n "}, {"sha": "bef5a3c4e5b47b9d331218c1742a3c054cfc86b5", "filename": "src/test/stdtest/comm.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d9b23cb0224efb7157d2888bdaef85edebf6dd08/src%2Ftest%2Fstdtest%2Fcomm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9b23cb0224efb7157d2888bdaef85edebf6dd08/src%2Ftest%2Fstdtest%2Fcomm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fstdtest%2Fcomm.rs?ref=d9b23cb0224efb7157d2888bdaef85edebf6dd08", "patch": "@@ -4,6 +4,13 @@ import std::comm;\n #[test]\n fn create_port_and_chan() { let p = comm::port::<int>(); comm::chan(p); }\n \n+#[test]\n+fn send_int() {\n+    let p = comm::port::<int>();\n+    let c = comm::chan(p);\n+    comm::send(c, 22);\n+}\n+\n #[test]\n fn send_recv_fn() {\n     let p = comm::port::<int>();\n@@ -21,9 +28,17 @@ fn send_recv_fn_infer() {\n }\n \n #[test]\n-fn chan_chan() {\n+fn chan_chan_infer() {\n     let p = comm::port(), p2 = comm::port::<int>();\n     let c = comm::chan(p);\n     comm::send(c, comm::chan(p2));\n     comm::recv(p);\n }\n+\n+#[test]\n+fn chan_chan() {\n+    let p = comm::port::<comm::chan<int>>(), p2 = comm::port::<int>();\n+    let c = comm::chan(p);\n+    comm::send(c, comm::chan(p2));\n+    comm::recv(p);\n+}"}]}