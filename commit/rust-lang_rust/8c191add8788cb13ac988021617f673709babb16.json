{"sha": "8c191add8788cb13ac988021617f673709babb16", "node_id": "C_kwDOAAsO6NoAKDhjMTkxYWRkODc4OGNiMTNhYzk4ODAyMTYxN2Y2NzM3MDliYWJiMTY", "commit": {"author": {"name": "Centri3", "email": "114838443+Centri3@users.noreply.github.com", "date": "2023-05-15T00:25:23Z"}, "committer": {"name": "Centri3", "email": "114838443+Centri3@users.noreply.github.com", "date": "2023-05-15T00:25:23Z"}, "message": "the implementation!!", "tree": {"sha": "7872e34d5f2f2a052faa8f0cb8391550c0a910b6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7872e34d5f2f2a052faa8f0cb8391550c0a910b6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8c191add8788cb13ac988021617f673709babb16", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8c191add8788cb13ac988021617f673709babb16", "html_url": "https://github.com/rust-lang/rust/commit/8c191add8788cb13ac988021617f673709babb16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8c191add8788cb13ac988021617f673709babb16/comments", "author": {"login": "Centri3", "id": 114838443, "node_id": "U_kgDOBthLqw", "avatar_url": "https://avatars.githubusercontent.com/u/114838443?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centri3", "html_url": "https://github.com/Centri3", "followers_url": "https://api.github.com/users/Centri3/followers", "following_url": "https://api.github.com/users/Centri3/following{/other_user}", "gists_url": "https://api.github.com/users/Centri3/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centri3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centri3/subscriptions", "organizations_url": "https://api.github.com/users/Centri3/orgs", "repos_url": "https://api.github.com/users/Centri3/repos", "events_url": "https://api.github.com/users/Centri3/events{/privacy}", "received_events_url": "https://api.github.com/users/Centri3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centri3", "id": 114838443, "node_id": "U_kgDOBthLqw", "avatar_url": "https://avatars.githubusercontent.com/u/114838443?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centri3", "html_url": "https://github.com/Centri3", "followers_url": "https://api.github.com/users/Centri3/followers", "following_url": "https://api.github.com/users/Centri3/following{/other_user}", "gists_url": "https://api.github.com/users/Centri3/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centri3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centri3/subscriptions", "organizations_url": "https://api.github.com/users/Centri3/orgs", "repos_url": "https://api.github.com/users/Centri3/repos", "events_url": "https://api.github.com/users/Centri3/events{/privacy}", "received_events_url": "https://api.github.com/users/Centri3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "590c9fc108371fb414d6d3987b018c4da81fac5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/590c9fc108371fb414d6d3987b018c4da81fac5c", "html_url": "https://github.com/rust-lang/rust/commit/590c9fc108371fb414d6d3987b018c4da81fac5c"}], "stats": {"total": 226, "additions": 225, "deletions": 1}, "files": [{"sha": "223dd6989781720cde4b033c413395926c3d5359", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -4948,6 +4948,7 @@ Released 2018-09-13\n [`println_empty_string`]: https://rust-lang.github.io/rust-clippy/master/index.html#println_empty_string\n [`ptr_arg`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_arg\n [`ptr_as_ptr`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_as_ptr\n+[`ptr_cast_constness`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_cast_constness\n [`ptr_eq`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_eq\n [`ptr_offset_with_cast`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_offset_with_cast\n [`pub_enum_variant_names`]: https://rust-lang.github.io/rust-clippy/master/index.html#pub_enum_variant_names"}, {"sha": "ee2f0f8855e63660cc2f17851a9ecc5604f6974c", "filename": "clippy_lints/src/casts/mod.rs", "status": "modified", "additions": 32, "deletions": 1, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -18,6 +18,7 @@ mod fn_to_numeric_cast;\n mod fn_to_numeric_cast_any;\n mod fn_to_numeric_cast_with_truncation;\n mod ptr_as_ptr;\n+mod ptr_cast_constness;\n mod unnecessary_cast;\n mod utils;\n \n@@ -399,7 +400,7 @@ declare_clippy_lint! {\n     /// namely `*const T` to `*const U` and `*mut T` to `*mut U`.\n     ///\n     /// ### Why is this bad?\n-    /// Though `as` casts between raw pointers is not terrible, `pointer::cast` is safer because\n+    /// Though `as` casts between raw pointers are not terrible, `pointer::cast` is safer because\n     /// it cannot accidentally change the pointer's mutability nor cast the pointer to other types like `usize`.\n     ///\n     /// ### Example\n@@ -422,6 +423,34 @@ declare_clippy_lint! {\n     \"casting using `as` from and to raw pointers that doesn't change its mutability, where `pointer::cast` could take the place of `as`\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for `as` casts between raw pointers which change its constness, namely `*const T` to\n+    /// `*mut T` and `*mut T` to `*const T`.\n+    ///\n+    /// ### Why is this bad?\n+    /// Though `as` casts between raw pointers are not terrible, `pointer::cast_mut` and\n+    /// `pointer::cast_const` are safer because they cannot accidentally cast the pointer to another\n+    /// type.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// let ptr: *const u32 = &42_u32;\n+    /// let mut_ptr = ptr as *mut u32;\n+    /// let ptr = mut_ptr as *const u32;\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// let ptr: *const u32 = &42_u32;\n+    /// let mut_ptr = ptr.cast_mut();\n+    /// let ptr = mut_ptr.cast_const();\n+    /// ```\n+    #[clippy::version = \"1.65.0\"]\n+    pub PTR_CAST_CONSTNESS,\n+    pedantic,\n+    \"TODO\"\n+}\n+\n declare_clippy_lint! {\n     /// ### What it does\n     /// Checks for casts from an enum type to an integral type which will definitely truncate the\n@@ -689,6 +718,7 @@ impl_lint_pass!(Casts => [\n     FN_TO_NUMERIC_CAST_WITH_TRUNCATION,\n     CHAR_LIT_AS_U8,\n     PTR_AS_PTR,\n+    PTR_CAST_CONSTNESS,\n     CAST_ENUM_TRUNCATION,\n     CAST_ENUM_CONSTRUCTOR,\n     CAST_ABS_TO_UNSIGNED,\n@@ -722,6 +752,7 @@ impl<'tcx> LateLintPass<'tcx> for Casts {\n                 return;\n             }\n             cast_slice_from_raw_parts::check(cx, expr, cast_expr, cast_to, &self.msrv);\n+            ptr_cast_constness::check(cx, expr, cast_expr, cast_from, cast_to);\n             as_ptr_cast_mut::check(cx, expr, cast_expr, cast_to);\n             fn_to_numeric_cast_any::check(cx, expr, cast_expr, cast_from, cast_to);\n             fn_to_numeric_cast::check(cx, expr, cast_expr, cast_from, cast_to);"}, {"sha": "0a95b36a59933abc83cdd10f94f6c3a12e5e27b7", "filename": "clippy_lints/src/casts/ptr_cast_constness.rs", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/clippy_lints%2Fsrc%2Fcasts%2Fptr_cast_constness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/clippy_lints%2Fsrc%2Fcasts%2Fptr_cast_constness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Fptr_cast_constness.rs?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -0,0 +1,35 @@\n+use clippy_utils::diagnostics::span_lint_and_sugg;\n+use clippy_utils::sugg::Sugg;\n+use if_chain::if_chain;\n+use rustc_errors::Applicability;\n+use rustc_hir::{Expr, Mutability};\n+use rustc_lint::LateContext;\n+use rustc_middle::ty::{self, Ty, TypeAndMut};\n+\n+use super::PTR_CAST_CONSTNESS;\n+\n+pub(super) fn check(cx: &LateContext<'_>, expr: &Expr<'_>, cast_expr: &Expr<'_>, cast_from: Ty<'_>, cast_to: Ty<'_>) {\n+    if_chain! {\n+        if let ty::RawPtr(TypeAndMut { mutbl: from_mutbl, .. }) = cast_from.kind();\n+        if let ty::RawPtr(TypeAndMut { mutbl: to_mutbl, .. }) = cast_to.kind();\n+        if !matches!((from_mutbl, to_mutbl),\n+            (Mutability::Not, Mutability::Not) | (Mutability::Mut, Mutability::Mut));\n+        then {\n+            let sugg = Sugg::hir(cx, cast_expr, \"_\");\n+            let constness = match *to_mutbl {\n+                Mutability::Not => \"const\",\n+                Mutability::Mut => \"mut\",\n+            };\n+\n+            span_lint_and_sugg(\n+                cx,\n+                PTR_CAST_CONSTNESS,\n+                expr.span,\n+                \"`as` casting between raw pointers while changing its constness\",\n+                &format!(\"try `pointer::cast_{constness}`, a safer alternative\"),\n+                format!(\"{}.cast_{constness}()\", sugg.maybe_par()),\n+                Applicability::MachineApplicable,\n+            );\n+        }\n+    }\n+}"}, {"sha": "beeeb322b4d1987e27ba5a069b4de0e1b5e98d14", "filename": "clippy_lints/src/declared_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/clippy_lints%2Fsrc%2Fdeclared_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/clippy_lints%2Fsrc%2Fdeclared_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdeclared_lints.rs?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -89,6 +89,7 @@ pub(crate) static LINTS: &[&crate::LintInfo] = &[\n     crate::casts::FN_TO_NUMERIC_CAST_ANY_INFO,\n     crate::casts::FN_TO_NUMERIC_CAST_WITH_TRUNCATION_INFO,\n     crate::casts::PTR_AS_PTR_INFO,\n+    crate::casts::PTR_CAST_CONSTNESS_INFO,\n     crate::casts::UNNECESSARY_CAST_INFO,\n     crate::checked_conversions::CHECKED_CONVERSIONS_INFO,\n     crate::cognitive_complexity::COGNITIVE_COMPLEXITY_INFO,"}, {"sha": "bb7b00b50ab361e00d77a48bd2704c5f52720f23", "filename": "tests/ui/ptr_cast_constness.fixed", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/tests%2Fui%2Fptr_cast_constness.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/tests%2Fui%2Fptr_cast_constness.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_cast_constness.fixed?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -0,0 +1,55 @@\n+//@run-rustfix\n+//@aux-build:proc_macros.rs\n+\n+#![warn(clippy::ptr_cast_constness)]\n+\n+extern crate proc_macros;\n+use proc_macros::{external, inline_macros};\n+\n+#[inline_macros]\n+fn main() {\n+    let ptr: *const u32 = &42_u32;\n+    let mut_ptr: *mut u32 = &mut 42_u32;\n+\n+    let _ = ptr as *const i32;\n+    let _ = mut_ptr as *mut i32;\n+\n+    // Make sure the lint can handle the difference in their operator precedences.\n+    unsafe {\n+        let ptr_ptr: *const *const u32 = &ptr;\n+        let _ = (*ptr_ptr).cast_mut();\n+    }\n+\n+    let _ = ptr.cast_mut();\n+    let _ = mut_ptr.cast_const();\n+\n+    // Lint this, since pointer::cast_mut and pointer::cast_const have ?Sized\n+    let ptr_of_array: *const [u32; 4] = &[1, 2, 3, 4];\n+    let _ = ptr_of_array as *const [u32];\n+    let _ = ptr_of_array as *const dyn std::fmt::Debug;\n+\n+    // Make sure the lint is triggered inside a macro\n+    let _ = inline!($ptr as *const i32);\n+\n+    // Do not lint inside macros from external crates\n+    let _ = external!($ptr as *const i32);\n+}\n+\n+#[clippy::msrv = \"1.64\"]\n+fn _msrv_1_37() {\n+    let ptr: *const u32 = &42_u32;\n+    let mut_ptr: *mut u32 = &mut 42_u32;\n+\n+    // `pointer::cast_const` and `pointer::cast_mut` were stabilized in 1.65. Do not lint this\n+    let _ = ptr.cast_mut();\n+    let _ = mut_ptr.cast_const();\n+}\n+\n+#[clippy::msrv = \"1.65\"]\n+fn _msrv_1_38() {\n+    let ptr: *const u32 = &42_u32;\n+    let mut_ptr: *mut u32 = &mut 42_u32;\n+\n+    let _ = ptr.cast_mut();\n+    let _ = mut_ptr.cast_const();\n+}"}, {"sha": "a560d36d1171e19dfd2fdc9dd3de8892e40bf12f", "filename": "tests/ui/ptr_cast_constness.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/tests%2Fui%2Fptr_cast_constness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/tests%2Fui%2Fptr_cast_constness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_cast_constness.rs?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -0,0 +1,55 @@\n+//@run-rustfix\n+//@aux-build:proc_macros.rs\n+\n+#![warn(clippy::ptr_cast_constness)]\n+\n+extern crate proc_macros;\n+use proc_macros::{external, inline_macros};\n+\n+#[inline_macros]\n+fn main() {\n+    let ptr: *const u32 = &42_u32;\n+    let mut_ptr: *mut u32 = &mut 42_u32;\n+\n+    let _ = ptr as *const i32;\n+    let _ = mut_ptr as *mut i32;\n+\n+    // Make sure the lint can handle the difference in their operator precedences.\n+    unsafe {\n+        let ptr_ptr: *const *const u32 = &ptr;\n+        let _ = *ptr_ptr as *mut i32;\n+    }\n+\n+    let _ = ptr as *mut i32;\n+    let _ = mut_ptr as *const i32;\n+\n+    // Lint this, since pointer::cast_mut and pointer::cast_const have ?Sized\n+    let ptr_of_array: *const [u32; 4] = &[1, 2, 3, 4];\n+    let _ = ptr_of_array as *const [u32];\n+    let _ = ptr_of_array as *const dyn std::fmt::Debug;\n+\n+    // Make sure the lint is triggered inside a macro\n+    let _ = inline!($ptr as *const i32);\n+\n+    // Do not lint inside macros from external crates\n+    let _ = external!($ptr as *const i32);\n+}\n+\n+#[clippy::msrv = \"1.64\"]\n+fn _msrv_1_37() {\n+    let ptr: *const u32 = &42_u32;\n+    let mut_ptr: *mut u32 = &mut 42_u32;\n+\n+    // `pointer::cast_const` and `pointer::cast_mut` were stabilized in 1.65. Do not lint this\n+    let _ = ptr as *mut i32;\n+    let _ = mut_ptr as *const i32;\n+}\n+\n+#[clippy::msrv = \"1.65\"]\n+fn _msrv_1_38() {\n+    let ptr: *const u32 = &42_u32;\n+    let mut_ptr: *mut u32 = &mut 42_u32;\n+\n+    let _ = ptr as *mut i32;\n+    let _ = mut_ptr as *const i32;\n+}"}, {"sha": "e665e2971c49573c427a4ea7378e65dbfc9b1870", "filename": "tests/ui/ptr_cast_constness.stderr", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/8c191add8788cb13ac988021617f673709babb16/tests%2Fui%2Fptr_cast_constness.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8c191add8788cb13ac988021617f673709babb16/tests%2Fui%2Fptr_cast_constness.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_cast_constness.stderr?ref=8c191add8788cb13ac988021617f673709babb16", "patch": "@@ -0,0 +1,46 @@\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:20:17\n+   |\n+LL |         let _ = *ptr_ptr as *mut i32;\n+   |                 ^^^^^^^^^^^^^^^^^^^^ help: try `pointer::cast_mut`, a safer alternative: `(*ptr_ptr).cast_mut()`\n+   |\n+   = note: `-D clippy::ptr-cast-constness` implied by `-D warnings`\n+\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:23:13\n+   |\n+LL |     let _ = ptr as *mut i32;\n+   |             ^^^^^^^^^^^^^^^ help: try `pointer::cast_mut`, a safer alternative: `ptr.cast_mut()`\n+\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:24:13\n+   |\n+LL |     let _ = mut_ptr as *const i32;\n+   |             ^^^^^^^^^^^^^^^^^^^^^ help: try `pointer::cast_const`, a safer alternative: `mut_ptr.cast_const()`\n+\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:44:13\n+   |\n+LL |     let _ = ptr as *mut i32;\n+   |             ^^^^^^^^^^^^^^^ help: try `pointer::cast_mut`, a safer alternative: `ptr.cast_mut()`\n+\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:45:13\n+   |\n+LL |     let _ = mut_ptr as *const i32;\n+   |             ^^^^^^^^^^^^^^^^^^^^^ help: try `pointer::cast_const`, a safer alternative: `mut_ptr.cast_const()`\n+\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:53:13\n+   |\n+LL |     let _ = ptr as *mut i32;\n+   |             ^^^^^^^^^^^^^^^ help: try `pointer::cast_mut`, a safer alternative: `ptr.cast_mut()`\n+\n+error: `as` casting between raw pointers while changing its constness\n+  --> $DIR/ptr_cast_constness.rs:54:13\n+   |\n+LL |     let _ = mut_ptr as *const i32;\n+   |             ^^^^^^^^^^^^^^^^^^^^^ help: try `pointer::cast_const`, a safer alternative: `mut_ptr.cast_const()`\n+\n+error: aborting due to 7 previous errors\n+"}]}