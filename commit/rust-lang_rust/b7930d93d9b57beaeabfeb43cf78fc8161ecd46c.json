{"sha": "b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3OTMwZDkzZDliNTdiZWFlYWJmZWI0M2NmNzhmYzgxNjFlY2Q0NmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-01-22T12:09:02Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-01-22T12:09:02Z"}, "message": "Auto merge of #21187 - oli-obk:feature/hint_struct_field_access, r=alexcrichton\n\nrebase and fix of #19267", "tree": {"sha": "0c38770d7ced3d284b8c4d13909c4dd0526ca85b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0c38770d7ced3d284b8c4d13909c4dd0526ca85b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "html_url": "https://github.com/rust-lang/rust/commit/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5d2056a7e3e52b2aec41662cfd960e0eafe8494c", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d2056a7e3e52b2aec41662cfd960e0eafe8494c", "html_url": "https://github.com/rust-lang/rust/commit/5d2056a7e3e52b2aec41662cfd960e0eafe8494c"}, {"sha": "09d9924713a119692b8b195b81bd57ee7821cb71", "url": "https://api.github.com/repos/rust-lang/rust/commits/09d9924713a119692b8b195b81bd57ee7821cb71", "html_url": "https://github.com/rust-lang/rust/commit/09d9924713a119692b8b195b81bd57ee7821cb71"}], "stats": {"total": 113, "additions": 112, "deletions": 1}, "files": [{"sha": "5f8ae09b5bd6fa6ce8a599bba3ea0c13485d5a67", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2015 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -108,6 +108,7 @@ use lint;\n use util::common::{block_query, indenter, loop_query};\n use util::ppaux::{self, Repr};\n use util::nodemap::{DefIdMap, FnvHashMap, NodeMap};\n+use util::lev_distance::lev_distance;\n \n use std::cell::{Cell, Ref, RefCell};\n use std::mem::replace;\n@@ -3071,11 +3072,43 @@ fn check_expr_with_unifier<'a, 'tcx, F>(fcx: &FnCtxt<'a, 'tcx>,\n                             actual)\n                 },\n                 expr_t, None);\n+            if let Some(t) = ty::ty_to_def_id(expr_t) {\n+                suggest_field_names(t, field, tcx, vec![]);\n+            }\n         }\n \n         fcx.write_error(expr.id);\n     }\n \n+    // displays hints about the closest matches in field names\n+    fn suggest_field_names<'tcx>(id : DefId,\n+                                 field : &ast::SpannedIdent,\n+                                 tcx : &ty::ctxt<'tcx>,\n+                                 skip : Vec<&str>) {\n+        let ident = token::get_ident(field.node);\n+        let name = ident.get();\n+        // only find fits with at least one matching letter\n+        let mut best_dist = name.len();\n+        let mut best = None;\n+        let fields = ty::lookup_struct_fields(tcx, id);\n+        for elem in fields.iter() {\n+            let n = elem.name.as_str();\n+            // ignore already set fields\n+            if skip.iter().any(|&x| x == n) {\n+                continue;\n+            }\n+            let dist = lev_distance(n, name);\n+            if dist < best_dist {\n+                best = Some(n);\n+                best_dist = dist;\n+            }\n+        }\n+        if let Some(n) = best {\n+            tcx.sess.span_help(field.span,\n+                format!(\"did you mean `{}`?\", n).as_slice());\n+        }\n+    }\n+\n     // Check tuple index expressions\n     fn check_tup_field(fcx: &FnCtxt,\n                        expr: &ast::Expr,\n@@ -3183,6 +3216,13 @@ fn check_expr_with_unifier<'a, 'tcx, F>(fcx: &FnCtxt<'a, 'tcx>,\n                         },\n                         struct_ty,\n                         None);\n+                    // prevent all specified fields from being suggested\n+                    let skip_fields = ast_fields.iter().map(|ref x| x.ident.node.name.as_str());\n+                    let actual_id = match enum_id_opt {\n+                        Some(_) => class_id,\n+                        None => ty::ty_to_def_id(struct_ty).unwrap()\n+                    };\n+                    suggest_field_names(actual_id, &field.ident, tcx, skip_fields.collect());\n                     error_happened = true;\n                 }\n                 Some((_, true)) => {"}, {"sha": "8df9ffd6cc73f2526424359bc5a88935adb3b0f3", "filename": "src/test/compile-fail/struct-fields-hints-no-dupe.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Ftest%2Fcompile-fail%2Fstruct-fields-hints-no-dupe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Ftest%2Fcompile-fail%2Fstruct-fields-hints-no-dupe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fstruct-fields-hints-no-dupe.rs?ref=b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct A {\n+    foo : i32,\n+    car : i32,\n+    barr : i32\n+}\n+\n+fn main() {\n+    let a = A {\n+        foo : 5,\n+        bar : 42,//~ ERROR structure `A` has no field named `bar`\n+        //~^ HELP did you mean `barr`?\n+        car : 9,\n+    };\n+}"}, {"sha": "37001f1e60a0fb2e0dc586ed780913a957d8b9bb", "filename": "src/test/compile-fail/struct-fields-hints.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Ftest%2Fcompile-fail%2Fstruct-fields-hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Ftest%2Fcompile-fail%2Fstruct-fields-hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fstruct-fields-hints.rs?ref=b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "patch": "@@ -0,0 +1,23 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct A {\n+    foo : i32,\n+    car : i32,\n+    barr : i32\n+}\n+\n+fn main() {\n+    let a = A {\n+        foo : 5,\n+        bar : 42,//~ ERROR structure `A` has no field named `bar`\n+        //~^ HELP did you mean `car`?\n+    };\n+}"}, {"sha": "c897dc55204b1235f98e7b7f760ecc9b1c86015a", "filename": "src/test/compile-fail/struct-fields-typo.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Ftest%2Fcompile-fail%2Fstruct-fields-typo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7930d93d9b57beaeabfeb43cf78fc8161ecd46c/src%2Ftest%2Fcompile-fail%2Fstruct-fields-typo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fstruct-fields-typo.rs?ref=b7930d93d9b57beaeabfeb43cf78fc8161ecd46c", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct BuildData {\n+    foo: isize,\n+    bar: f32\n+}\n+\n+fn main() {\n+    let foo = BuildData {\n+        foo: 0,\n+        bar: 0.5,\n+    };\n+    let x = foo.baa;//~ ERROR attempted access of field `baa` on type `BuildData`\n+    //~^ HELP did you mean `bar`?\n+    println!(\"{}\", x);\n+}"}]}