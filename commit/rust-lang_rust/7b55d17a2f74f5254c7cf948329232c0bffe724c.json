{"sha": "7b55d17a2f74f5254c7cf948329232c0bffe724c", "node_id": "C_kwDOAAsO6NoAKDdiNTVkMTdhMmY3NGY1MjU0YzdjZjk0ODMyOTIzMmMwYmZmZTcyNGM", "commit": {"author": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-10-30T03:02:10Z"}, "committer": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-10-30T04:05:21Z"}, "message": "Reduce span of let else irrefutable_let_patterns warning\n\nHuge spans aren't good for IDE users as they underline constructs that\nare possibly multiline.", "tree": {"sha": "24bc917b9d210923570a3b91a6b56e7f8535c908", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24bc917b9d210923570a3b91a6b56e7f8535c908"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b55d17a2f74f5254c7cf948329232c0bffe724c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b55d17a2f74f5254c7cf948329232c0bffe724c", "html_url": "https://github.com/rust-lang/rust/commit/7b55d17a2f74f5254c7cf948329232c0bffe724c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b55d17a2f74f5254c7cf948329232c0bffe724c/comments", "author": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "committer": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5e9772042948002f9c6f60c4c81603170035fffa", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e9772042948002f9c6f60c4c81603170035fffa", "html_url": "https://github.com/rust-lang/rust/commit/5e9772042948002f9c6f60c4c81603170035fffa"}], "stats": {"total": 41, "additions": 26, "deletions": 15}, "files": [{"sha": "589990c3f163a54b32d0aba1982b0b99d26d8c4c", "filename": "compiler/rustc_mir_build/src/thir/pattern/check_match.rs", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/7b55d17a2f74f5254c7cf948329232c0bffe724c/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b55d17a2f74f5254c7cf948329232c0bffe724c/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs?ref=7b55d17a2f74f5254c7cf948329232c0bffe724c", "patch": "@@ -79,7 +79,10 @@ impl<'tcx> Visitor<'tcx> for MatchVisitor<'_, '_, 'tcx> {\n         intravisit::walk_local(self, loc);\n         let els = loc.els;\n         if let Some(init) = loc.init && els.is_some() {\n-            self.check_let(&loc.pat, init, loc.span);\n+            // Build a span without the else { ... } as we don't want to underline\n+            // the entire else block in the IDE setting.\n+            let span = loc.span.with_hi(init.span.hi());\n+            self.check_let(&loc.pat, init, span);\n         }\n \n         let (msg, sp) = match loc.source {\n@@ -630,11 +633,6 @@ fn irrefutable_let_patterns(\n     count: usize,\n     span: Span,\n ) {\n-    let span = match source {\n-        LetSource::LetElse(span) => span,\n-        _ => span,\n-    };\n-\n     macro_rules! emit_diag {\n         (\n             $lint:expr,\n@@ -680,7 +678,7 @@ fn irrefutable_let_patterns(\n                 \"removing the guard and adding a `let` inside the match arm\"\n             );\n         }\n-        LetSource::LetElse(..) => {\n+        LetSource::LetElse => {\n             emit_diag!(\n                 lint,\n                 \"`let...else`\",\n@@ -1127,7 +1125,7 @@ pub enum LetSource {\n     GenericLet,\n     IfLet,\n     IfLetGuard,\n-    LetElse(Span),\n+    LetElse,\n     WhileLet,\n }\n \n@@ -1156,8 +1154,8 @@ fn let_source_parent(tcx: TyCtxt<'_>, parent: HirId, pat_id: Option<HirId>) -> L\n     let parent_parent = hir.get_parent_node(parent);\n     let parent_parent_node = hir.get(parent_parent);\n     match parent_parent_node {\n-        hir::Node::Stmt(hir::Stmt { kind: hir::StmtKind::Local(_), span, .. }) => {\n-            return LetSource::LetElse(*span);\n+        hir::Node::Stmt(hir::Stmt { kind: hir::StmtKind::Local(_), .. }) => {\n+            return LetSource::LetElse;\n         }\n         hir::Node::Arm(hir::Arm { guard: Some(hir::Guard::If(_)), .. }) => {\n             return LetSource::IfLetGuard;"}, {"sha": "f4b338eb0af95313b64b760ecf35175cfe9bc807", "filename": "src/test/ui/let-else/let-else-irrefutable.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7b55d17a2f74f5254c7cf948329232c0bffe724c/src%2Ftest%2Fui%2Flet-else%2Flet-else-irrefutable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b55d17a2f74f5254c7cf948329232c0bffe724c/src%2Ftest%2Fui%2Flet-else%2Flet-else-irrefutable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flet-else%2Flet-else-irrefutable.rs?ref=7b55d17a2f74f5254c7cf948329232c0bffe724c", "patch": "@@ -1,7 +1,11 @@\n // check-pass\n \n-\n-\n fn main() {\n     let x = 1 else { return }; //~ WARN irrefutable `let...else` pattern\n+\n+    // Multiline else blocks should not get printed\n+    let x = 1 else { //~ WARN irrefutable `let...else` pattern\n+        eprintln!(\"problem case encountered\");\n+        return\n+    };\n }"}, {"sha": "73d4e5f34831d6444aa3571c11f52d7f2e5a08e0", "filename": "src/test/ui/let-else/let-else-irrefutable.stderr", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7b55d17a2f74f5254c7cf948329232c0bffe724c/src%2Ftest%2Fui%2Flet-else%2Flet-else-irrefutable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7b55d17a2f74f5254c7cf948329232c0bffe724c/src%2Ftest%2Fui%2Flet-else%2Flet-else-irrefutable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flet-else%2Flet-else-irrefutable.stderr?ref=7b55d17a2f74f5254c7cf948329232c0bffe724c", "patch": "@@ -1,12 +1,21 @@\n warning: irrefutable `let...else` pattern\n-  --> $DIR/let-else-irrefutable.rs:6:5\n+  --> $DIR/let-else-irrefutable.rs:4:5\n    |\n LL |     let x = 1 else { return };\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |     ^^^^^^^^^\n    |\n    = note: this pattern will always match, so the `else` clause is useless\n    = help: consider removing the `else` clause\n    = note: `#[warn(irrefutable_let_patterns)]` on by default\n \n-warning: 1 warning emitted\n+warning: irrefutable `let...else` pattern\n+  --> $DIR/let-else-irrefutable.rs:7:5\n+   |\n+LL |     let x = 1 else {\n+   |     ^^^^^^^^^\n+   |\n+   = note: this pattern will always match, so the `else` clause is useless\n+   = help: consider removing the `else` clause\n+\n+warning: 2 warnings emitted\n "}]}