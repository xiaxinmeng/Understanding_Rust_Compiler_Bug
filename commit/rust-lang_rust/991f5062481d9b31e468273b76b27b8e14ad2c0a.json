{"sha": "991f5062481d9b31e468273b76b27b8e14ad2c0a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk5MWY1MDYyNDgxZDliMzFlNDY4MjczYjc2YjI3YjhlMTRhZDJjMGE=", "commit": {"author": {"name": "Ricardo M. Correia", "email": "rcorreia@wizy.org", "date": "2014-09-27T03:08:41Z"}, "committer": {"name": "Ricardo M. Correia", "email": "rcorreia@wizy.org", "date": "2014-09-29T13:07:14Z"}, "message": "rustc: Fix permission denied error in 'ar' when lto is enabled\n\nThe reason that 'ar' can fail with permission denied is that when\nlink-time optimizations are enabled, rustc copies libraries into a\ntemporary directory, preserving file permissions, and subsequently\nmodifies them using 'ar'.\n\nThe modification can fail because some package managers may install\nlibraries in system directories as read-only files, which means the\ntemporary file also becomes read-only when it is copied.\n\nI have fixed this by giving the temporary file's owner read+write\npermissions after the copy.\n\nI have also added a regression test for this issue.", "tree": {"sha": "4b1efe8f1f7fcd0a44f016c3d9ab0ec8cb606e4e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b1efe8f1f7fcd0a44f016c3d9ab0ec8cb606e4e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/991f5062481d9b31e468273b76b27b8e14ad2c0a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/991f5062481d9b31e468273b76b27b8e14ad2c0a", "html_url": "https://github.com/rust-lang/rust/commit/991f5062481d9b31e468273b76b27b8e14ad2c0a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/991f5062481d9b31e468273b76b27b8e14ad2c0a/comments", "author": {"login": "wizeman", "id": 168610, "node_id": "MDQ6VXNlcjE2ODYxMA==", "avatar_url": "https://avatars.githubusercontent.com/u/168610?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wizeman", "html_url": "https://github.com/wizeman", "followers_url": "https://api.github.com/users/wizeman/followers", "following_url": "https://api.github.com/users/wizeman/following{/other_user}", "gists_url": "https://api.github.com/users/wizeman/gists{/gist_id}", "starred_url": "https://api.github.com/users/wizeman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wizeman/subscriptions", "organizations_url": "https://api.github.com/users/wizeman/orgs", "repos_url": "https://api.github.com/users/wizeman/repos", "events_url": "https://api.github.com/users/wizeman/events{/privacy}", "received_events_url": "https://api.github.com/users/wizeman/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wizeman", "id": 168610, "node_id": "MDQ6VXNlcjE2ODYxMA==", "avatar_url": "https://avatars.githubusercontent.com/u/168610?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wizeman", "html_url": "https://github.com/wizeman", "followers_url": "https://api.github.com/users/wizeman/followers", "following_url": "https://api.github.com/users/wizeman/following{/other_user}", "gists_url": "https://api.github.com/users/wizeman/gists{/gist_id}", "starred_url": "https://api.github.com/users/wizeman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wizeman/subscriptions", "organizations_url": "https://api.github.com/users/wizeman/orgs", "repos_url": "https://api.github.com/users/wizeman/repos", "events_url": "https://api.github.com/users/wizeman/events{/privacy}", "received_events_url": "https://api.github.com/users/wizeman/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "40b86baca0e7e84ece58c2b5f6161371bf672a93", "url": "https://api.github.com/repos/rust-lang/rust/commits/40b86baca0e7e84ece58c2b5f6161371bf672a93", "html_url": "https://github.com/rust-lang/rust/commit/40b86baca0e7e84ece58c2b5f6161371bf672a93"}], "stats": {"total": 48, "additions": 48, "deletions": 0}, "files": [{"sha": "b793096b30a4f3ec5f41018ef59c242d6bc31f15", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=991f5062481d9b31e468273b76b27b8e14ad2c0a", "patch": "@@ -1319,6 +1319,18 @@ fn add_upstream_rust_crates(cmd: &mut Command, sess: &Session,\n                         sess.abort_if_errors();\n                     }\n                 }\n+                // Fix up permissions of the copy, as fs::copy() preserves\n+                // permissions, but the original file may have been installed\n+                // by a package manager and may be read-only.\n+                match fs::chmod(&dst, io::UserRead | io::UserWrite) {\n+                    Ok(..) => {}\n+                    Err(e) => {\n+                        sess.err(format!(\"failed to chmod {} when preparing \\\n+                                          for LTO: {}\", dst.display(),\n+                                         e).as_slice());\n+                        sess.abort_if_errors();\n+                    }\n+                }\n                 let handler = &sess.diagnostic().handler;\n                 let config = ArchiveConfig {\n                     handler: handler,"}, {"sha": "0afbbc3450ac7fdd674a0344ee4c90915a736a46", "filename": "src/test/run-make/lto-readonly-lib/Makefile", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Ftest%2Frun-make%2Flto-readonly-lib%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Ftest%2Frun-make%2Flto-readonly-lib%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-readonly-lib%2FMakefile?ref=991f5062481d9b31e468273b76b27b8e14ad2c0a", "patch": "@@ -0,0 +1,12 @@\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) lib.rs\n+\n+\t# the compiler needs to copy and modify the rlib file when performing\n+\t# LTO, so we should ensure that it can cope with the original rlib\n+\t# being read-only.\n+\tchmod 444 $(TMPDIR)/*.rlib\n+\n+\t$(RUSTC) main.rs -C lto\n+\t$(call RUN,main)"}, {"sha": "04d3ae67207228d9bfe4d16f9873b5cd8bbe3f92", "filename": "src/test/run-make/lto-readonly-lib/lib.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Ftest%2Frun-make%2Flto-readonly-lib%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Ftest%2Frun-make%2Flto-readonly-lib%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-readonly-lib%2Flib.rs?ref=991f5062481d9b31e468273b76b27b8e14ad2c0a", "patch": "@@ -0,0 +1,11 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type = \"rlib\"]"}, {"sha": "e12ac9e01dc17ecaa8b256aaab05723524f09176", "filename": "src/test/run-make/lto-readonly-lib/main.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Ftest%2Frun-make%2Flto-readonly-lib%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/991f5062481d9b31e468273b76b27b8e14ad2c0a/src%2Ftest%2Frun-make%2Flto-readonly-lib%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-readonly-lib%2Fmain.rs?ref=991f5062481d9b31e468273b76b27b8e14ad2c0a", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+extern crate lib;\n+\n+fn main() {}"}]}