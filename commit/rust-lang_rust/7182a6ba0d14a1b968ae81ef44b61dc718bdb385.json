{"sha": "7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "node_id": "C_kwDOAAsO6NoAKDcxODJhNmJhMGQxNGExYjk2OGFlODFlZjQ0YjYxZGM3MThiZGIzODU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-26T00:07:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-26T00:07:16Z"}, "message": "Auto merge of #9681 - koka831:feat/add-seek-from-current-lint, r=giraffate\n\nfeat: add new lint `seek_from_current`\n\nchangelog: `seek_from_current`: new lint to suggest using `stream_position` instead of seek from current position with `SeekFrom::Current(0)`\n\naddresses https://github.com/rust-lang/rust-clippy/issues/7886.\n\nThis PR is related to https://github.com/rust-lang/rust-clippy/pull/9667, so I will update `methods/mod.rs` if it get conflicted.", "tree": {"sha": "6349fe84051f8f2457bfbe43200ef8b38bd9f5fb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6349fe84051f8f2457bfbe43200ef8b38bd9f5fb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "html_url": "https://github.com/rust-lang/rust/commit/7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "634987b49e5401c93421d1c37e75757396b2e5a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/634987b49e5401c93421d1c37e75757396b2e5a6", "html_url": "https://github.com/rust-lang/rust/commit/634987b49e5401c93421d1c37e75757396b2e5a6"}, {"sha": "6efb3a2b9ac9e0477b6b222c051c15c98233b424", "url": "https://api.github.com/repos/rust-lang/rust/commits/6efb3a2b9ac9e0477b6b222c051c15c98233b424", "html_url": "https://github.com/rust-lang/rust/commit/6efb3a2b9ac9e0477b6b222c051c15c98233b424"}], "stats": {"total": 163, "additions": 162, "deletions": 1}, "files": [{"sha": "b47e80f6979c96b55c5e138998fcdfd09e034a9c", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -4200,6 +4200,7 @@ Released 2018-09-13\n [`same_item_push`]: https://rust-lang.github.io/rust-clippy/master/index.html#same_item_push\n [`same_name_method`]: https://rust-lang.github.io/rust-clippy/master/index.html#same_name_method\n [`search_is_some`]: https://rust-lang.github.io/rust-clippy/master/index.html#search_is_some\n+[`seek_from_current`]: https://rust-lang.github.io/rust-clippy/master/index.html#seek_from_current\n [`seek_to_start_instead_of_rewind`]: https://rust-lang.github.io/rust-clippy/master/index.html#seek_to_start_instead_of_rewind\n [`self_assignment`]: https://rust-lang.github.io/rust-clippy/master/index.html#self_assignment\n [`self_named_constructors`]: https://rust-lang.github.io/rust-clippy/master/index.html#self_named_constructors"}, {"sha": "fff26307e3491e1724cd34d9770a8876f19dc1cf", "filename": "clippy_lints/src/declared_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_lints%2Fsrc%2Fdeclared_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_lints%2Fsrc%2Fdeclared_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdeclared_lints.rs?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -363,6 +363,7 @@ pub(crate) static LINTS: &[&crate::LintInfo] = &[\n     crate::methods::REPEAT_ONCE_INFO,\n     crate::methods::RESULT_MAP_OR_INTO_OPTION_INFO,\n     crate::methods::SEARCH_IS_SOME_INFO,\n+    crate::methods::SEEK_FROM_CURRENT_INFO,\n     crate::methods::SEEK_TO_START_INSTEAD_OF_REWIND_INFO,\n     crate::methods::SHOULD_IMPLEMENT_TRAIT_INFO,\n     crate::methods::SINGLE_CHAR_ADD_STR_INFO,"}, {"sha": "b29c7d9f253a5190b255f91bee88eef48b234f37", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -69,6 +69,7 @@ mod path_buf_push_overwrite;\n mod range_zip_with_len;\n mod repeat_once;\n mod search_is_some;\n+mod seek_from_current;\n mod seek_to_start_instead_of_rewind;\n mod single_char_add_str;\n mod single_char_insert_string;\n@@ -3067,6 +3068,49 @@ declare_clippy_lint! {\n     \"iterating on map using `iter` when `keys` or `values` would do\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    ///\n+    /// Checks an argument of `seek` method of `Seek` trait\n+    /// and if it start seek from `SeekFrom::Current(0)`, suggests `stream_position` instead.\n+    ///\n+    /// ### Why is this bad?\n+    ///\n+    /// Readability. Use dedicated method.\n+    ///\n+    /// ### Example\n+    ///\n+    /// ```rust\n+    /// use std::fs::File;\n+    /// use std::io::{self, Write, Seek, SeekFrom};\n+    ///\n+    /// fn main() -> io::Result<()> {\n+    ///     let mut f = File::create(\"foo.txt\")?;\n+    ///     f.write_all(b\"Hello\")?;\n+    ///     eprintln!(\"Written {} bytes\", f.seek(SeekFrom::Current(0))?);\n+    ///\n+    ///     Ok(())\n+    /// }\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// use std::fs::File;\n+    /// use std::io::{self, Write, Seek, SeekFrom};\n+    ///\n+    /// fn main() -> io::Result<()> {\n+    ///     let mut f = File::create(\"foo.txt\")?;\n+    ///     f.write_all(b\"Hello\")?;\n+    ///     eprintln!(\"Written {} bytes\", f.stream_position()?);\n+    ///\n+    ///     Ok(())\n+    /// }\n+    /// ```\n+    #[clippy::version = \"1.66.0\"]\n+    pub SEEK_FROM_CURRENT,\n+    complexity,\n+    \"use dedicated method for seek from current position\"\n+}\n+\n declare_clippy_lint! {\n     /// ### What it does\n     ///\n@@ -3222,6 +3266,7 @@ impl_lint_pass!(Methods => [\n     VEC_RESIZE_TO_ZERO,\n     VERBOSE_FILE_READS,\n     ITER_KV_MAP,\n+    SEEK_FROM_CURRENT,\n     SEEK_TO_START_INSTEAD_OF_REWIND,\n ]);\n \n@@ -3638,6 +3683,9 @@ impl Methods {\n                     vec_resize_to_zero::check(cx, expr, count_arg, default_arg, span);\n                 },\n                 (\"seek\", [arg]) => {\n+                    if meets_msrv(self.msrv, msrvs::SEEK_FROM_CURRENT) {\n+                        seek_from_current::check(cx, expr, recv, arg);\n+                    }\n                     if meets_msrv(self.msrv, msrvs::SEEK_REWIND) {\n                         seek_to_start_instead_of_rewind::check(cx, expr, recv, arg, span);\n                     }"}, {"sha": "361a3082f949a12baec89f13955c8701ebb8aaad", "filename": "clippy_lints/src/methods/seek_from_current.rs", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_lints%2Fsrc%2Fmethods%2Fseek_from_current.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_lints%2Fsrc%2Fmethods%2Fseek_from_current.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fseek_from_current.rs?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -0,0 +1,48 @@\n+use rustc_ast::ast::{LitIntType, LitKind};\n+use rustc_errors::Applicability;\n+use rustc_hir::{Expr, ExprKind};\n+use rustc_lint::LateContext;\n+\n+use clippy_utils::{\n+    diagnostics::span_lint_and_sugg, get_trait_def_id, match_def_path, paths, source::snippet_with_applicability,\n+    ty::implements_trait,\n+};\n+\n+use super::SEEK_FROM_CURRENT;\n+\n+pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>, recv: &'tcx Expr<'_>, arg: &'tcx Expr<'_>) {\n+    let ty = cx.typeck_results().expr_ty(recv);\n+\n+    if let Some(def_id) = get_trait_def_id(cx, &paths::STD_IO_SEEK) {\n+        if implements_trait(cx, ty, def_id, &[]) && arg_is_seek_from_current(cx, arg) {\n+            let mut applicability = Applicability::MachineApplicable;\n+            let snip = snippet_with_applicability(cx, recv.span, \"..\", &mut applicability);\n+\n+            span_lint_and_sugg(\n+                cx,\n+                SEEK_FROM_CURRENT,\n+                expr.span,\n+                \"using `SeekFrom::Current` to start from current position\",\n+                \"replace with\",\n+                format!(\"{snip}.stream_position()\"),\n+                applicability,\n+            );\n+        }\n+    }\n+}\n+\n+fn arg_is_seek_from_current<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) -> bool {\n+    if let ExprKind::Call(f, args) = expr.kind &&\n+        let ExprKind::Path(ref path) = f.kind &&\n+        let Some(def_id) = cx.qpath_res(path, f.hir_id).opt_def_id() &&\n+        match_def_path(cx, def_id, &paths::STD_IO_SEEK_FROM_CURRENT) {\n+        // check if argument of `SeekFrom::Current` is `0`\n+        if args.len() == 1 &&\n+            let ExprKind::Lit(ref lit) = args[0].kind &&\n+            let LitKind::Int(0, LitIntType::Unsuffixed) = lit.node {\n+            return true\n+        }\n+    }\n+\n+    false\n+}"}, {"sha": "9a672e2ddfd7df05bf6797e8f442e854d1615646", "filename": "clippy_utils/src/msrvs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_utils%2Fsrc%2Fmsrvs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_utils%2Fsrc%2Fmsrvs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fmsrvs.rs?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -17,7 +17,7 @@ msrv_aliases! {\n     1,58,0 { FORMAT_ARGS_CAPTURE }\n     1,53,0 { OR_PATTERNS, MANUAL_BITS, BTREE_MAP_RETAIN, BTREE_SET_RETAIN, ARRAY_INTO_ITERATOR }\n     1,52,0 { STR_SPLIT_ONCE, REM_EUCLID_CONST }\n-    1,51,0 { BORROW_AS_PTR, UNSIGNED_ABS }\n+    1,51,0 { BORROW_AS_PTR, SEEK_FROM_CURRENT, UNSIGNED_ABS }\n     1,50,0 { BOOL_THEN, CLAMP }\n     1,47,0 { TAU }\n     1,46,0 { CONST_IF_MATCH }"}, {"sha": "6c09c146082ab41e673ea06b142afb334fea833c", "filename": "clippy_utils/src/paths.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_utils%2Fsrc%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/clippy_utils%2Fsrc%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fpaths.rs?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -116,6 +116,7 @@ pub const STDOUT: [&str; 4] = [\"std\", \"io\", \"stdio\", \"stdout\"];\n pub const CONVERT_IDENTITY: [&str; 3] = [\"core\", \"convert\", \"identity\"];\n pub const STD_FS_CREATE_DIR: [&str; 3] = [\"std\", \"fs\", \"create_dir\"];\n pub const STD_IO_SEEK: [&str; 3] = [\"std\", \"io\", \"Seek\"];\n+pub const STD_IO_SEEK_FROM_CURRENT: [&str; 4] = [\"std\", \"io\", \"SeekFrom\", \"Current\"];\n pub const STD_IO_SEEKFROM_START: [&str; 4] = [\"std\", \"io\", \"SeekFrom\", \"Start\"];\n pub const STRING_AS_MUT_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_mut_str\"];\n pub const STRING_AS_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_str\"];"}, {"sha": "4b5303324bc6f17e7dde1e1dc477c1eac2b3c357", "filename": "tests/ui/seek_from_current.fixed", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/tests%2Fui%2Fseek_from_current.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/tests%2Fui%2Fseek_from_current.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fseek_from_current.fixed?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -0,0 +1,26 @@\n+// run-rustfix\n+#![warn(clippy::seek_from_current)]\n+#![feature(custom_inner_attributes)]\n+\n+use std::fs::File;\n+use std::io::{self, Seek, SeekFrom, Write};\n+\n+fn _msrv_1_50() -> io::Result<()> {\n+    #![clippy::msrv = \"1.50\"]\n+    let mut f = File::create(\"foo.txt\")?;\n+    f.write_all(b\"Hi!\")?;\n+    f.seek(SeekFrom::Current(0))?;\n+    f.seek(SeekFrom::Current(1))?;\n+    Ok(())\n+}\n+\n+fn _msrv_1_51() -> io::Result<()> {\n+    #![clippy::msrv = \"1.51\"]\n+    let mut f = File::create(\"foo.txt\")?;\n+    f.write_all(b\"Hi!\")?;\n+    f.stream_position()?;\n+    f.seek(SeekFrom::Current(1))?;\n+    Ok(())\n+}\n+\n+fn main() {}"}, {"sha": "f93639261a1808241f7e24dfc1957c4c71c1907e", "filename": "tests/ui/seek_from_current.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/tests%2Fui%2Fseek_from_current.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/tests%2Fui%2Fseek_from_current.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fseek_from_current.rs?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -0,0 +1,26 @@\n+// run-rustfix\n+#![warn(clippy::seek_from_current)]\n+#![feature(custom_inner_attributes)]\n+\n+use std::fs::File;\n+use std::io::{self, Seek, SeekFrom, Write};\n+\n+fn _msrv_1_50() -> io::Result<()> {\n+    #![clippy::msrv = \"1.50\"]\n+    let mut f = File::create(\"foo.txt\")?;\n+    f.write_all(b\"Hi!\")?;\n+    f.seek(SeekFrom::Current(0))?;\n+    f.seek(SeekFrom::Current(1))?;\n+    Ok(())\n+}\n+\n+fn _msrv_1_51() -> io::Result<()> {\n+    #![clippy::msrv = \"1.51\"]\n+    let mut f = File::create(\"foo.txt\")?;\n+    f.write_all(b\"Hi!\")?;\n+    f.seek(SeekFrom::Current(0))?;\n+    f.seek(SeekFrom::Current(1))?;\n+    Ok(())\n+}\n+\n+fn main() {}"}, {"sha": "db1125b53cdf5c2182970a9c748633f0d9c5840d", "filename": "tests/ui/seek_from_current.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/tests%2Fui%2Fseek_from_current.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7182a6ba0d14a1b968ae81ef44b61dc718bdb385/tests%2Fui%2Fseek_from_current.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fseek_from_current.stderr?ref=7182a6ba0d14a1b968ae81ef44b61dc718bdb385", "patch": "@@ -0,0 +1,10 @@\n+error: using `SeekFrom::Current` to start from current position\n+  --> $DIR/seek_from_current.rs:21:5\n+   |\n+LL |     f.seek(SeekFrom::Current(0))?;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: replace with: `f.stream_position()`\n+   |\n+   = note: `-D clippy::seek-from-current` implied by `-D warnings`\n+\n+error: aborting due to previous error\n+"}]}