{"sha": "cd6b723bb66c7cc32a1436db43079dc4236eaa90", "node_id": "C_kwDOAAsO6NoAKGNkNmI3MjNiYjY2YzdjYzMyYTE0MzZkYjQzMDc5ZGM0MjM2ZWFhOTA", "commit": {"author": {"name": "Oli Scherer", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2022-07-25T17:55:45Z"}, "committer": {"name": "Oli Scherer", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2022-07-25T17:57:56Z"}, "message": "Add default impls for `FileDescriptor` methods", "tree": {"sha": "530534c9a8afb98c83a1df4cfa241f357fca5e43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/530534c9a8afb98c83a1df4cfa241f357fca5e43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd6b723bb66c7cc32a1436db43079dc4236eaa90", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd6b723bb66c7cc32a1436db43079dc4236eaa90", "html_url": "https://github.com/rust-lang/rust/commit/cd6b723bb66c7cc32a1436db43079dc4236eaa90", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd6b723bb66c7cc32a1436db43079dc4236eaa90/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b938529fb8ed8f7b5b374282ffc3ffa74c313111", "url": "https://api.github.com/repos/rust-lang/rust/commits/b938529fb8ed8f7b5b374282ffc3ffa74c313111", "html_url": "https://github.com/rust-lang/rust/commit/b938529fb8ed8f7b5b374282ffc3ffa74c313111"}], "stats": {"total": 161, "additions": 41, "deletions": 120}, "files": [{"sha": "c9f35c04891710f10cfc4a403ede579831e47bdd", "filename": "src/shims/unix/fs.rs", "status": "modified", "additions": 38, "deletions": 117, "changes": 155, "blob_url": "https://github.com/rust-lang/rust/blob/cd6b723bb66c7cc32a1436db43079dc4236eaa90/src%2Fshims%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6b723bb66c7cc32a1436db43079dc4236eaa90/src%2Fshims%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Funix%2Ffs.rs?ref=cd6b723bb66c7cc32a1436db43079dc4236eaa90", "patch": "@@ -24,38 +24,56 @@ struct FileHandle {\n }\n \n trait FileDescriptor: std::fmt::Debug {\n-    fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle>;\n+    fn name(&self) -> &'static str;\n+\n+    fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle> {\n+        throw_unsup_format!(\"{} cannot be used as FileHandle\", self.name());\n+    }\n \n     fn read<'tcx>(\n         &mut self,\n-        communicate_allowed: bool,\n-        bytes: &mut [u8],\n-    ) -> InterpResult<'tcx, io::Result<usize>>;\n+        _communicate_allowed: bool,\n+        _bytes: &mut [u8],\n+    ) -> InterpResult<'tcx, io::Result<usize>> {\n+        throw_unsup_format!(\"cannot read from {}\", self.name());\n+    }\n \n     fn write<'tcx>(\n         &self,\n-        communicate_allowed: bool,\n-        bytes: &[u8],\n-    ) -> InterpResult<'tcx, io::Result<usize>>;\n+        _communicate_allowed: bool,\n+        _bytes: &[u8],\n+    ) -> InterpResult<'tcx, io::Result<usize>> {\n+        throw_unsup_format!(\"cannot write to {}\", self.name());\n+    }\n \n     fn seek<'tcx>(\n         &mut self,\n-        communicate_allowed: bool,\n-        offset: SeekFrom,\n-    ) -> InterpResult<'tcx, io::Result<u64>>;\n+        _communicate_allowed: bool,\n+        _offset: SeekFrom,\n+    ) -> InterpResult<'tcx, io::Result<u64>> {\n+        throw_unsup_format!(\"cannot seek on {}\", self.name());\n+    }\n \n     fn close<'tcx>(\n         self: Box<Self>,\n         _communicate_allowed: bool,\n-    ) -> InterpResult<'tcx, io::Result<i32>>;\n+    ) -> InterpResult<'tcx, io::Result<i32>> {\n+        throw_unsup_format!(\"cannot close {}\", self.name());\n+    }\n \n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>>;\n \n     #[cfg(unix)]\n-    fn as_unix_host_fd(&self) -> Option<i32>;\n+    fn as_unix_host_fd(&self) -> Option<i32> {\n+        None\n+    }\n }\n \n impl FileDescriptor for FileHandle {\n+    fn name(&self) -> &'static str {\n+        \"FILE\"\n+    }\n+\n     fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle> {\n         Ok(self)\n     }\n@@ -126,8 +144,8 @@ impl FileDescriptor for FileHandle {\n }\n \n impl FileDescriptor for io::Stdin {\n-    fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle> {\n-        throw_unsup_format!(\"stdin cannot be used as FileHandle\");\n+    fn name(&self) -> &'static str {\n+        \"stdin\"\n     }\n \n     fn read<'tcx>(\n@@ -142,29 +160,6 @@ impl FileDescriptor for io::Stdin {\n         Ok(Read::read(self, bytes))\n     }\n \n-    fn write<'tcx>(\n-        &self,\n-        _communicate_allowed: bool,\n-        _bytes: &[u8],\n-    ) -> InterpResult<'tcx, io::Result<usize>> {\n-        throw_unsup_format!(\"cannot write to stdin\");\n-    }\n-\n-    fn seek<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _offset: SeekFrom,\n-    ) -> InterpResult<'tcx, io::Result<u64>> {\n-        throw_unsup_format!(\"cannot seek on stdin\");\n-    }\n-\n-    fn close<'tcx>(\n-        self: Box<Self>,\n-        _communicate_allowed: bool,\n-    ) -> InterpResult<'tcx, io::Result<i32>> {\n-        throw_unsup_format!(\"stdin cannot be closed\");\n-    }\n-\n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(io::stdin()))\n     }\n@@ -176,16 +171,8 @@ impl FileDescriptor for io::Stdin {\n }\n \n impl FileDescriptor for io::Stdout {\n-    fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle> {\n-        throw_unsup_format!(\"stdout cannot be used as FileHandle\");\n-    }\n-\n-    fn read<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _bytes: &mut [u8],\n-    ) -> InterpResult<'tcx, io::Result<usize>> {\n-        throw_unsup_format!(\"cannot read from stdout\");\n+    fn name(&self) -> &'static str {\n+        \"stdout\"\n     }\n \n     fn write<'tcx>(\n@@ -205,21 +192,6 @@ impl FileDescriptor for io::Stdout {\n         Ok(result)\n     }\n \n-    fn seek<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _offset: SeekFrom,\n-    ) -> InterpResult<'tcx, io::Result<u64>> {\n-        throw_unsup_format!(\"cannot seek on stdout\");\n-    }\n-\n-    fn close<'tcx>(\n-        self: Box<Self>,\n-        _communicate_allowed: bool,\n-    ) -> InterpResult<'tcx, io::Result<i32>> {\n-        throw_unsup_format!(\"stdout cannot be closed\");\n-    }\n-\n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(io::stdout()))\n     }\n@@ -231,16 +203,8 @@ impl FileDescriptor for io::Stdout {\n }\n \n impl FileDescriptor for io::Stderr {\n-    fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle> {\n-        throw_unsup_format!(\"stderr cannot be used as FileHandle\");\n-    }\n-\n-    fn read<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _bytes: &mut [u8],\n-    ) -> InterpResult<'tcx, io::Result<usize>> {\n-        throw_unsup_format!(\"cannot read from stderr\");\n+    fn name(&self) -> &'static str {\n+        \"stderr\"\n     }\n \n     fn write<'tcx>(\n@@ -253,21 +217,6 @@ impl FileDescriptor for io::Stderr {\n         Ok(Write::write(&mut { self }, bytes))\n     }\n \n-    fn seek<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _offset: SeekFrom,\n-    ) -> InterpResult<'tcx, io::Result<u64>> {\n-        throw_unsup_format!(\"cannot seek on stderr\");\n-    }\n-\n-    fn close<'tcx>(\n-        self: Box<Self>,\n-        _communicate_allowed: bool,\n-    ) -> InterpResult<'tcx, io::Result<i32>> {\n-        throw_unsup_format!(\"stderr cannot be closed\");\n-    }\n-\n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(io::stderr()))\n     }\n@@ -282,16 +231,8 @@ impl FileDescriptor for io::Stderr {\n struct DummyOutput;\n \n impl FileDescriptor for DummyOutput {\n-    fn as_file_handle<'tcx>(&self) -> InterpResult<'tcx, &FileHandle> {\n-        throw_unsup_format!(\"stderr and stdout cannot be used as FileHandle\");\n-    }\n-\n-    fn read<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _bytes: &mut [u8],\n-    ) -> InterpResult<'tcx, io::Result<usize>> {\n-        throw_unsup_format!(\"cannot read from stderr or stdout\");\n+    fn name(&self) -> &'static str {\n+        \"stderr and stdout\"\n     }\n \n     fn write<'tcx>(\n@@ -303,29 +244,9 @@ impl FileDescriptor for DummyOutput {\n         Ok(Ok(bytes.len()))\n     }\n \n-    fn seek<'tcx>(\n-        &mut self,\n-        _communicate_allowed: bool,\n-        _offset: SeekFrom,\n-    ) -> InterpResult<'tcx, io::Result<u64>> {\n-        throw_unsup_format!(\"cannot seek on stderr or stdout\");\n-    }\n-\n-    fn close<'tcx>(\n-        self: Box<Self>,\n-        _communicate_allowed: bool,\n-    ) -> InterpResult<'tcx, io::Result<i32>> {\n-        throw_unsup_format!(\"stderr and stdout cannot be closed\");\n-    }\n-\n     fn dup<'tcx>(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(DummyOutput))\n     }\n-\n-    #[cfg(unix)]\n-    fn as_unix_host_fd(&self) -> Option<i32> {\n-        None\n-    }\n }\n \n #[derive(Debug)]"}, {"sha": "e4eab5fd69640602c6d793e1ab000800a9a50d8d", "filename": "tests/fail/fs/close_stdout.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cd6b723bb66c7cc32a1436db43079dc4236eaa90/tests%2Ffail%2Ffs%2Fclose_stdout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6b723bb66c7cc32a1436db43079dc4236eaa90/tests%2Ffail%2Ffs%2Fclose_stdout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Ffs%2Fclose_stdout.rs?ref=cd6b723bb66c7cc32a1436db43079dc4236eaa90", "patch": "@@ -7,6 +7,6 @@\n \n fn main() {\n     unsafe {\n-        libc::close(1); //~ ERROR: stdout cannot be closed\n+        libc::close(1); //~ ERROR: cannot close stdout\n     }\n }"}, {"sha": "eb2c54e05f1fa7ca102b489d64a7229ef89ab137", "filename": "tests/fail/fs/close_stdout.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cd6b723bb66c7cc32a1436db43079dc4236eaa90/tests%2Ffail%2Ffs%2Fclose_stdout.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cd6b723bb66c7cc32a1436db43079dc4236eaa90/tests%2Ffail%2Ffs%2Fclose_stdout.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Ffs%2Fclose_stdout.stderr?ref=cd6b723bb66c7cc32a1436db43079dc4236eaa90", "patch": "@@ -1,8 +1,8 @@\n-error: unsupported operation: stdout cannot be closed\n+error: unsupported operation: cannot close stdout\n   --> $DIR/close_stdout.rs:LL:CC\n    |\n LL |         libc::close(1);\n-   |         ^^^^^^^^^^^^^^ stdout cannot be closed\n+   |         ^^^^^^^^^^^^^^ cannot close stdout\n    |\n    = help: this is likely not a bug in the program; it indicates that the program performed an operation that the interpreter does not support\n    = note: backtrace:"}]}