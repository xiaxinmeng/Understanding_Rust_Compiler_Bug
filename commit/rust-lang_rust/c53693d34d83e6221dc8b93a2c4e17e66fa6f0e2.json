{"sha": "c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM1MzY5M2QzNGQ4M2U2MjIxZGM4YjkzYTJjNGUxN2U2NmZhNmYwZTI=", "commit": {"author": {"name": "Fisher Darling", "email": "fdarling@mines.edu", "date": "2019-12-13T04:18:21Z"}, "committer": {"name": "Fisher Darling", "email": "fdarlingco@gmail.com", "date": "2020-02-17T02:08:25Z"}, "message": "Handle recursion_limit parsing errors", "tree": {"sha": "dfdd15a42fa21e8ecd3cf1f8313a96688b12cd3b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dfdd15a42fa21e8ecd3cf1f8313a96688b12cd3b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "html_url": "https://github.com/rust-lang/rust/commit/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/comments", "author": null, "committer": {"login": "fisherdarling", "id": 14206675, "node_id": "MDQ6VXNlcjE0MjA2Njc1", "avatar_url": "https://avatars.githubusercontent.com/u/14206675?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fisherdarling", "html_url": "https://github.com/fisherdarling", "followers_url": "https://api.github.com/users/fisherdarling/followers", "following_url": "https://api.github.com/users/fisherdarling/following{/other_user}", "gists_url": "https://api.github.com/users/fisherdarling/gists{/gist_id}", "starred_url": "https://api.github.com/users/fisherdarling/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fisherdarling/subscriptions", "organizations_url": "https://api.github.com/users/fisherdarling/orgs", "repos_url": "https://api.github.com/users/fisherdarling/repos", "events_url": "https://api.github.com/users/fisherdarling/events{/privacy}", "received_events_url": "https://api.github.com/users/fisherdarling/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "116dff95a37214e86f067715374a18a4de1621f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/116dff95a37214e86f067715374a18a4de1621f0", "html_url": "https://github.com/rust-lang/rust/commit/116dff95a37214e86f067715374a18a4de1621f0"}], "stats": {"total": 118, "additions": 112, "deletions": 6}, "files": [{"sha": "b5c88b33b4a9598f4787ecc335e364322e2d5d95", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -50,6 +50,7 @@\n #![feature(associated_type_bounds)]\n #![feature(rustc_attrs)]\n #![feature(hash_raw_entry)]\n+#![feature(int_error_matching)]\n #![recursion_limit = \"512\"]\n \n #[macro_use]"}, {"sha": "be530da5910df588d180edc9e28f2f630e40aa6d", "filename": "src/librustc/middle/recursion_limit.rs", "status": "modified", "additions": 40, "deletions": 6, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Flibrustc%2Fmiddle%2Frecursion_limit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Flibrustc%2Fmiddle%2Frecursion_limit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Frecursion_limit.rs?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -6,26 +6,60 @@\n // just peeks and looks for that attribute.\n \n use crate::session::Session;\n+use core::num::IntErrorKind;\n+use rustc::bug;\n use rustc_span::symbol::{sym, Symbol};\n use syntax::ast;\n \n use rustc_data_structures::sync::Once;\n \n pub fn update_limits(sess: &Session, krate: &ast::Crate) {\n-    update_limit(krate, &sess.recursion_limit, sym::recursion_limit, 128);\n-    update_limit(krate, &sess.type_length_limit, sym::type_length_limit, 1048576);\n+    update_limit(sess, krate, &sess.recursion_limit, sym::recursion_limit, 128);\n+    update_limit(sess, krate, &sess.type_length_limit, sym::type_length_limit, 1048576);\n }\n \n-fn update_limit(krate: &ast::Crate, limit: &Once<usize>, name: Symbol, default: usize) {\n+fn update_limit(\n+    sess: &Session,\n+    krate: &ast::Crate,\n+    limit: &Once<usize>,\n+    name: Symbol,\n+    default: usize,\n+) {\n     for attr in &krate.attrs {\n         if !attr.check_name(name) {\n             continue;\n         }\n \n         if let Some(s) = attr.value_str() {\n-            if let Some(n) = s.as_str().parse().ok() {\n-                limit.set(n);\n-                return;\n+            match s.as_str().parse() {\n+                Ok(n) => {\n+                    limit.set(n);\n+                    return;\n+                }\n+                Err(e) => {\n+                    let mut err = sess.struct_span_err(\n+                        attr.span,\n+                        \"`recursion_limit` must be a non-negative integer\",\n+                    );\n+\n+                    let value_span = attr\n+                        .meta()\n+                        .and_then(|meta| meta.name_value_literal().cloned())\n+                        .map(|lit| lit.span)\n+                        .unwrap_or(attr.span);\n+\n+                    let error_str = match e.kind() {\n+                        IntErrorKind::Overflow => \"`recursion_limit` is too large\",\n+                        IntErrorKind::Empty => \"`recursion_limit` must be a non-negative integer\",\n+                        IntErrorKind::InvalidDigit => \"not a valid integer\",\n+                        IntErrorKind::Underflow => bug!(\"`recursion_limit` should never underflow\"),\n+                        IntErrorKind::Zero => bug!(\"zero is a valid `recursion_limit`\"),\n+                        kind => bug!(\"unimplemented IntErrorKind variant: {:?}\", kind),\n+                    };\n+\n+                    err.span_label(value_span, error_str);\n+                    err.emit();\n+                }\n             }\n         }\n     }"}, {"sha": "2a064f3e1159946cb1c15683422f392b518d5a69", "filename": "src/test/ui/recursion_limit/empty.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fempty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fempty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Fempty.rs?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,6 @@\n+// Test the parse error for an empty recursion_limit\n+\n+#![recursion_limit = \"\"] //~ ERROR `recursion_limit` must be a non-negative integer\n+                         //~| `recursion_limit` must be a non-negative integer\n+\n+fn main() {}"}, {"sha": "690c33a746307aaf2640b121191d9bb2ff857ce6", "filename": "src/test/ui/recursion_limit/empty.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fempty.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fempty.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Fempty.stderr?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,10 @@\n+error: `recursion_limit` must be a non-negative integer\n+  --> $DIR/empty.rs:3:1\n+   |\n+LL | #![recursion_limit = \"\"]\n+   | ^^^^^^^^^^^^^^^^^^^^^--^\n+   |                      |\n+   |                      `recursion_limit` must be a non-negative integer\n+\n+error: aborting due to previous error\n+"}, {"sha": "903d8040476961837d4791f9772910ffd71ebe80", "filename": "src/test/ui/recursion_limit/invalid_digit.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Finvalid_digit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Finvalid_digit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Finvalid_digit.rs?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,6 @@\n+// Test the parse error for an invalid digit in recursion_limit\n+\n+#![recursion_limit = \"-100\"] //~ ERROR `recursion_limit` must be a non-negative integer\n+                             //~| not a valid integer\n+\n+fn main() {}"}, {"sha": "1dcfea547c0bd5a3381ce50bec84934cac36af01", "filename": "src/test/ui/recursion_limit/invalid_digit.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Finvalid_digit.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Finvalid_digit.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Finvalid_digit.stderr?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,10 @@\n+error: `recursion_limit` must be a non-negative integer\n+  --> $DIR/invalid_digit.rs:3:1\n+   |\n+LL | #![recursion_limit = \"-100\"]\n+   | ^^^^^^^^^^^^^^^^^^^^^------^\n+   |                      |\n+   |                      not a valid integer\n+\n+error: aborting due to previous error\n+"}, {"sha": "6487b1350aa98cd93f393fad50eb295e12f4ea39", "filename": "src/test/ui/recursion_limit/overflow.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Foverflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Foverflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Foverflow.rs?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,7 @@\n+// Test the parse error for an overflowing recursion_limit\n+\n+#![recursion_limit = \"999999999999999999999999\"]\n+//~^ ERROR `recursion_limit` must be a non-negative integer\n+//~| `recursion_limit` is too large\n+\n+fn main() {}"}, {"sha": "c3fc11989dcec7845cbd5c669fb689ddb144059a", "filename": "src/test/ui/recursion_limit/overflow.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Foverflow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Foverflow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Foverflow.stderr?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,10 @@\n+error: `recursion_limit` must be a non-negative integer\n+  --> $DIR/overflow.rs:3:1\n+   |\n+LL | #![recursion_limit = \"999999999999999999999999\"]\n+   | ^^^^^^^^^^^^^^^^^^^^^--------------------------^\n+   |                      |\n+   |                      `recursion_limit` is too large\n+\n+error: aborting due to previous error\n+"}, {"sha": "f7199944e0063de178d0eaae838dc702670050c6", "filename": "src/test/ui/recursion_limit/zero.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Fzero.rs?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,12 @@\n+// Test that a `recursion_limit` of 0 is valid\n+\n+#![recursion_limit = \"0\"]\n+\n+macro_rules! test {\n+    () => {};\n+    ($tt:tt) => { test!(); };\n+}\n+\n+test!(test); //~ ERROR 10:1: 10:13: recursion limit reached while expanding `test!`\n+\n+fn main() {}"}, {"sha": "6358805d89dee2c095f1cdccd16c83898598f45e", "filename": "src/test/ui/recursion_limit/zero.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fzero.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2/src%2Ftest%2Fui%2Frecursion_limit%2Fzero.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frecursion_limit%2Fzero.stderr?ref=c53693d34d83e6221dc8b93a2c4e17e66fa6f0e2", "patch": "@@ -0,0 +1,10 @@\n+error: recursion limit reached while expanding `test!`\n+  --> $DIR/zero.rs:10:1\n+   |\n+LL | test!(test);\n+   | ^^^^^^^^^^^^\n+   |\n+   = help: consider adding a `#![recursion_limit=\"0\"]` attribute to your crate (`zero`)\n+\n+error: aborting due to previous error\n+"}]}