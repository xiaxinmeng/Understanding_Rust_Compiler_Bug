{"sha": "fc901244890cf2c0218027189d9d2311026dabbd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjOTAxMjQ0ODkwY2YyYzAyMTgwMjcxODlkOWQyMzExMDI2ZGFiYmQ=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-06-16T08:51:08Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-06-16T09:10:33Z"}, "message": "test exact_div UB detection", "tree": {"sha": "9e181f192152d3958da0983ba51a2c8d7659cfd2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9e181f192152d3958da0983ba51a2c8d7659cfd2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc901244890cf2c0218027189d9d2311026dabbd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc901244890cf2c0218027189d9d2311026dabbd", "html_url": "https://github.com/rust-lang/rust/commit/fc901244890cf2c0218027189d9d2311026dabbd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc901244890cf2c0218027189d9d2311026dabbd/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "14c41925c643a10f53169f5faa61fc7a6cc74ae5", "url": "https://api.github.com/repos/rust-lang/rust/commits/14c41925c643a10f53169f5faa61fc7a6cc74ae5", "html_url": "https://github.com/rust-lang/rust/commit/14c41925c643a10f53169f5faa61fc7a6cc74ae5"}], "stats": {"total": 28, "additions": 27, "deletions": 1}, "files": [{"sha": "cf2afe0a811a11716ebe89bd17e8ea6de700ff84", "filename": "src/intrinsic.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fc901244890cf2c0218027189d9d2311026dabbd/src%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc901244890cf2c0218027189d9d2311026dabbd/src%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fintrinsic.rs?ref=fc901244890cf2c0218027189d9d2311026dabbd", "patch": "@@ -272,7 +272,13 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 let b = this.read_immediate(args[1])?;\n                 // check x % y != 0\n                 if this.binary_op(mir::BinOp::Rem, a, b)?.0.to_bits(dest.layout.size)? != 0 {\n-                    return err!(ValidationFailure(format!(\"exact_div: {:?} cannot be divided by {:?}\", a, b)));\n+                    // Check if `b` is -1, which is the \"min_value / -1\" case.\n+                    let minus1 = Scalar::from_int(-1, dest.layout.size);\n+                    return if b.to_scalar().unwrap() == minus1 {\n+                        err!(Intrinsic(format!(\"exact_div: result of dividing MIN by -1 cannot be represented\")))\n+                    } else {\n+                        err!(Intrinsic(format!(\"exact_div: {:?} cannot be divided by {:?} without remainder\", *a, *b)))\n+                    };\n                 }\n                 this.binop_ignore_overflow(mir::BinOp::Div, a, b, dest)?;\n             },"}, {"sha": "171bedeadc672bb03e1e8f981f7e62b8082d6a5e", "filename": "tests/compile-fail/exact_div1.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fexact_div1.rs?ref=fc901244890cf2c0218027189d9d2311026dabbd", "patch": "@@ -0,0 +1,5 @@\n+#![feature(core_intrinsics)]\n+fn main() {\n+    // divison by 0\n+    unsafe { std::intrinsics::exact_div(2, 0); } //~ ERROR divisor of zero\n+}"}, {"sha": "22bcf027dd05f854aa1556825e3e2ae4091c30e7", "filename": "tests/compile-fail/exact_div2.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fexact_div2.rs?ref=fc901244890cf2c0218027189d9d2311026dabbd", "patch": "@@ -0,0 +1,5 @@\n+#![feature(core_intrinsics)]\n+fn main() {\n+    // divison with a remainder\n+    unsafe { std::intrinsics::exact_div(2u16, 3); } //~ ERROR Scalar(0x0002) cannot be divided by Scalar(0x0003) without remainder\n+}"}, {"sha": "2db62e0092d51ebaf08160cc14756450899d7dd6", "filename": "tests/compile-fail/exact_div3.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fexact_div3.rs?ref=fc901244890cf2c0218027189d9d2311026dabbd", "patch": "@@ -0,0 +1,5 @@\n+#![feature(core_intrinsics)]\n+fn main() {\n+    // signed divison with a remainder\n+    unsafe { std::intrinsics::exact_div(-19i8, 2); } //~ ERROR Scalar(0xed) cannot be divided by Scalar(0x02) without remainder\n+}"}, {"sha": "736d4f2516d2ddb6a958870354084091c75a52a9", "filename": "tests/compile-fail/exact_div4.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc901244890cf2c0218027189d9d2311026dabbd/tests%2Fcompile-fail%2Fexact_div4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fexact_div4.rs?ref=fc901244890cf2c0218027189d9d2311026dabbd", "patch": "@@ -0,0 +1,5 @@\n+#![feature(core_intrinsics)]\n+fn main() {\n+    // divison of min_value by -1\n+    unsafe { std::intrinsics::exact_div(i64::min_value(), -1); } //~ ERROR result of dividing MIN by -1 cannot be represented\n+}"}]}