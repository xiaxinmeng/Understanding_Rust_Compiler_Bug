{"sha": "e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a", "node_id": "C_kwDOAAsO6NoAKGUyOTVmMGMyOWNjNDFiZTM0ZmVlMzY0ZmUxZmNmMWExYjBiYmQzMWE", "commit": {"author": {"name": "Chayim Refael Friedman", "email": "chayimfr@gmail.com", "date": "2022-09-04T13:26:00Z"}, "committer": {"name": "Chayim Refael Friedman", "email": "chayimfr@gmail.com", "date": "2022-09-04T14:33:15Z"}, "message": "Insert whitespaces into static & const bodies if they are expanded from macro on hover\n\nMacro expansion erases whitespace information, and so we end with invalid Rust code.", "tree": {"sha": "f13bd960e64d1e5018b71dbc1ae75f584ecb524b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f13bd960e64d1e5018b71dbc1ae75f584ecb524b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a", "html_url": "https://github.com/rust-lang/rust/commit/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a/comments", "author": {"login": "ChayimFriedman2", "id": 24700207, "node_id": "MDQ6VXNlcjI0NzAwMjA3", "avatar_url": "https://avatars.githubusercontent.com/u/24700207?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChayimFriedman2", "html_url": "https://github.com/ChayimFriedman2", "followers_url": "https://api.github.com/users/ChayimFriedman2/followers", "following_url": "https://api.github.com/users/ChayimFriedman2/following{/other_user}", "gists_url": "https://api.github.com/users/ChayimFriedman2/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChayimFriedman2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChayimFriedman2/subscriptions", "organizations_url": "https://api.github.com/users/ChayimFriedman2/orgs", "repos_url": "https://api.github.com/users/ChayimFriedman2/repos", "events_url": "https://api.github.com/users/ChayimFriedman2/events{/privacy}", "received_events_url": "https://api.github.com/users/ChayimFriedman2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChayimFriedman2", "id": 24700207, "node_id": "MDQ6VXNlcjI0NzAwMjA3", "avatar_url": "https://avatars.githubusercontent.com/u/24700207?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChayimFriedman2", "html_url": "https://github.com/ChayimFriedman2", "followers_url": "https://api.github.com/users/ChayimFriedman2/followers", "following_url": "https://api.github.com/users/ChayimFriedman2/following{/other_user}", "gists_url": "https://api.github.com/users/ChayimFriedman2/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChayimFriedman2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChayimFriedman2/subscriptions", "organizations_url": "https://api.github.com/users/ChayimFriedman2/orgs", "repos_url": "https://api.github.com/users/ChayimFriedman2/repos", "events_url": "https://api.github.com/users/ChayimFriedman2/events{/privacy}", "received_events_url": "https://api.github.com/users/ChayimFriedman2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "989b09d20cafc2b1eb9198e25701b9e2234d8ba0", "url": "https://api.github.com/repos/rust-lang/rust/commits/989b09d20cafc2b1eb9198e25701b9e2234d8ba0", "html_url": "https://github.com/rust-lang/rust/commit/989b09d20cafc2b1eb9198e25701b9e2234d8ba0"}], "stats": {"total": 80, "additions": 77, "deletions": 3}, "files": [{"sha": "c5c50d88dd28a5f7db15bd1931daf5d0d1185b83", "filename": "crates/ide/src/hover/render.rs", "status": "modified", "additions": 18, "deletions": 3, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a/crates%2Fide%2Fsrc%2Fhover%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a/crates%2Fide%2Fsrc%2Fhover%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Frender.rs?ref=e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a", "patch": "@@ -2,12 +2,13 @@\n use std::fmt::Display;\n \n use either::Either;\n-use hir::{AsAssocItem, AttributeTemplate, HasAttrs, HirDisplay, Semantics, TypeInfo};\n+use hir::{AsAssocItem, AttributeTemplate, HasAttrs, HasSource, HirDisplay, Semantics, TypeInfo};\n use ide_db::{\n     base_db::SourceDatabase,\n     defs::Definition,\n     famous_defs::FamousDefs,\n     generated::lints::{CLIPPY_LINTS, DEFAULT_LINTS, FEATURES},\n+    syntax_helpers::insert_whitespace_into_node,\n     RootDatabase,\n };\n use itertools::Itertools;\n@@ -350,10 +351,24 @@ pub(super) fn definition(\n             let body = it.eval(db);\n             match body {\n                 Ok(x) => Some(format!(\"{}\", x)),\n-                Err(_) => it.value(db).map(|x| format!(\"{}\", x)),\n+                Err(_) => {\n+                    let source = it.source(db)?;\n+                    let mut body = source.value.body()?.syntax().clone();\n+                    if source.file_id.is_macro() {\n+                        body = insert_whitespace_into_node::insert_ws_into(body);\n+                    }\n+                    Some(body.to_string())\n+                }\n+            }\n+        }),\n+        Definition::Static(it) => label_value_and_docs(db, it, |it| {\n+            let source = it.source(db)?;\n+            let mut body = source.value.body()?.syntax().clone();\n+            if source.file_id.is_macro() {\n+                body = insert_whitespace_into_node::insert_ws_into(body);\n             }\n+            Some(body.to_string())\n         }),\n-        Definition::Static(it) => label_value_and_docs(db, it, |it| it.value(db)),\n         Definition::Trait(it) => label_and_docs(db, it),\n         Definition::TypeAlias(it) => label_and_docs(db, it),\n         Definition::BuiltinType(it) => {"}, {"sha": "d49bc4f99cfde70b43ce2ebeec2e155970215c62", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 59, "deletions": 0, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=e295f0c29cc41be34fee364fe1fcf1a1b0bbd31a", "patch": "@@ -5113,3 +5113,62 @@ fn f() {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn static_const_macro_expanded_body() {\n+    check(\n+        r#\"\n+macro_rules! m {\n+    () => {\n+        pub const V: i8 = {\n+            let e = 123;\n+            f(e) // Prevent const eval from evaluating this constant, we want to print the body's code.\n+        };\n+    };\n+}\n+m!();\n+fn main() { $0V; }\n+\"#,\n+        expect![[r#\"\n+            *V*\n+\n+            ```rust\n+            test\n+            ```\n+            \n+            ```rust\n+            pub const V: i8 = {\n+              let e = 123;\n+              f(e)\n+            }\n+            ```\n+        \"#]],\n+    );\n+    check(\n+        r#\"\n+macro_rules! m {\n+    () => {\n+        pub static V: i8 = {\n+            let e = 123;\n+        };\n+    };\n+}\n+m!();\n+fn main() { $0V; }\n+\"#,\n+        expect![[r#\"\n+            *V*\n+\n+            ```rust\n+            test\n+            ```\n+            \n+            ```rust\n+            pub static V: i8 = {\n+              let e = 123;\n+              \n+            }\n+            ```\n+        \"#]],\n+    );\n+}"}]}