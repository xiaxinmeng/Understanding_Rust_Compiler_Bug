{"sha": "5e65467eff3d1da4712586d8402d1d2e1d6654bc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlNjU0NjdlZmYzZDFkYTQ3MTI1ODZkODQwMmQxZDJlMWQ2NjU0YmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-26T17:26:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-26T17:26:18Z"}, "message": "Auto merge of #83488 - Aaron1011:ban-expr-inner-attrs, r=petrochenkov\n\nBan custom inner attributes in expressions and statements\n\nSplit out from https://github.com/rust-lang/rust/pull/82608\n\nCustom inner attributes are unstable, so this won't break any stable users.\nThis allows us to speed up token collection, and avoid a redundant call to `collect_tokens_no_attrs` when parsing an `Expr` that has outer attributes.\n\nr? `@petrochenkov`", "tree": {"sha": "27aab873452a5138f35e69ec1f4f709471fe094c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/27aab873452a5138f35e69ec1f4f709471fe094c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e65467eff3d1da4712586d8402d1d2e1d6654bc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e65467eff3d1da4712586d8402d1d2e1d6654bc", "html_url": "https://github.com/rust-lang/rust/commit/5e65467eff3d1da4712586d8402d1d2e1d6654bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e65467eff3d1da4712586d8402d1d2e1d6654bc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8719c51e0e44483cff9b6975a830f6e51812a48", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8719c51e0e44483cff9b6975a830f6e51812a48", "html_url": "https://github.com/rust-lang/rust/commit/b8719c51e0e44483cff9b6975a830f6e51812a48"}, {"sha": "7504b9bb96236a340c41c95f95cf3c4a09341afc", "url": "https://api.github.com/repos/rust-lang/rust/commits/7504b9bb96236a340c41c95f95cf3c4a09341afc", "html_url": "https://github.com/rust-lang/rust/commit/7504b9bb96236a340c41c95f95cf3c4a09341afc"}], "stats": {"total": 430, "additions": 257, "deletions": 173}, "files": [{"sha": "470788a972aa35b27d810de807b612da584b476d", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -206,30 +206,36 @@ ast_fragments! {\n     }\n }\n \n+pub enum SupportsMacroExpansion {\n+    No,\n+    Yes { supports_inner_attrs: bool },\n+}\n+\n impl AstFragmentKind {\n     crate fn dummy(self, span: Span) -> AstFragment {\n         self.make_from(DummyResult::any(span)).expect(\"couldn't create a dummy AST fragment\")\n     }\n \n-    /// Fragment supports macro expansion and not just inert attributes, `cfg` and `cfg_attr`.\n-    pub fn supports_macro_expansion(self) -> bool {\n+    pub fn supports_macro_expansion(self) -> SupportsMacroExpansion {\n         match self {\n             AstFragmentKind::OptExpr\n             | AstFragmentKind::Expr\n-            | AstFragmentKind::Pat\n-            | AstFragmentKind::Ty\n             | AstFragmentKind::Stmts\n-            | AstFragmentKind::Items\n+            | AstFragmentKind::Ty\n+            | AstFragmentKind::Pat => SupportsMacroExpansion::Yes { supports_inner_attrs: false },\n+            AstFragmentKind::Items\n             | AstFragmentKind::TraitItems\n             | AstFragmentKind::ImplItems\n-            | AstFragmentKind::ForeignItems => true,\n+            | AstFragmentKind::ForeignItems => {\n+                SupportsMacroExpansion::Yes { supports_inner_attrs: true }\n+            }\n             AstFragmentKind::Arms\n             | AstFragmentKind::Fields\n             | AstFragmentKind::FieldPats\n             | AstFragmentKind::GenericParams\n             | AstFragmentKind::Params\n             | AstFragmentKind::StructFields\n-            | AstFragmentKind::Variants => false,\n+            | AstFragmentKind::Variants => SupportsMacroExpansion::No,\n         }\n     }\n "}, {"sha": "fe190bfe9d981905df8a756f8555b9f497881a0c", "filename": "compiler/rustc_parse/src/parser/expr.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -92,6 +92,21 @@ impl<'a> Parser<'a> {\n         self.parse_expr_res(Restrictions::empty(), None)\n     }\n \n+    /// Parses an expression, forcing tokens to be collected\n+    pub fn parse_expr_force_collect(&mut self) -> PResult<'a, P<Expr>> {\n+        // If we have outer attributes, then the call to `collect_tokens_trailing_token`\n+        // will be made for us.\n+        if matches!(self.token.kind, TokenKind::Pound | TokenKind::DocComment(..)) {\n+            self.parse_expr()\n+        } else {\n+            // If we don't have outer attributes, then we need to ensure\n+            // that collection happens by using `collect_tokens_no_attrs`.\n+            // Expression don't support custom inner attributes, so `parse_expr`\n+            // will never try to collect tokens if we don't have outer attributes.\n+            self.collect_tokens_no_attrs(|this| this.parse_expr())\n+        }\n+    }\n+\n     pub(super) fn parse_anon_const_expr(&mut self) -> PResult<'a, AnonConst> {\n         self.parse_expr().map(|value| AnonConst { id: DUMMY_NODE_ID, value })\n     }"}, {"sha": "f0ee76d328c40813c7b82c4e493d852db4385d5a", "filename": "compiler/rustc_parse/src/parser/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fmod.rs?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -987,7 +987,7 @@ impl<'a> Parser<'a> {\n                     }\n \n                     // Collect tokens because they are used during lowering to HIR.\n-                    let expr = self.collect_tokens_no_attrs(|this| this.parse_expr())?;\n+                    let expr = self.parse_expr_force_collect()?;\n                     let span = expr.span;\n \n                     match &expr.kind {"}, {"sha": "0c49d10358356148945116e9bd56720bbf23ff92", "filename": "compiler/rustc_parse/src/parser/nonterminal.rs", "status": "modified", "additions": 1, "deletions": 16, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fnonterminal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fnonterminal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fnonterminal.rs?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -128,22 +128,7 @@ impl<'a> Parser<'a> {\n                 })?)\n             }\n \n-            // If there are attributes present, then `parse_expr` will end up collecting tokens,\n-            // turning the outer `collect_tokens_no_attrs` into a no-op due to the already present\n-            // tokens. If there are *not* attributes present, then the outer\n-            // `collect_tokens_no_attrs` will ensure that we will end up collecting tokens for the\n-            // expressions.\n-            //\n-            // This is less efficient than it could be, since the outer `collect_tokens_no_attrs`\n-            // still needs to snapshot the `TokenCursor` before calling `parse_expr`, even when\n-            // `parse_expr` will end up collecting tokens. Ideally, this would work more like\n-            // `parse_item`, and take in a `ForceCollect` parameter. However, this would require\n-            // adding a `ForceCollect` parameter in a bunch of places in expression parsing\n-            // for little gain. If the perf impact from this turns out to be noticeable, we should\n-            // revisit this apporach.\n-            NonterminalKind::Expr => {\n-                token::NtExpr(self.collect_tokens_no_attrs(|this| this.parse_expr())?)\n-            }\n+            NonterminalKind::Expr => token::NtExpr(self.parse_expr_force_collect()?),\n             NonterminalKind::Literal => {\n                 // The `:literal` matcher does not support attributes\n                 token::NtLiteral("}, {"sha": "2efce1e1984f3df2cfb49c7958ca1d06436f1cef", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -17,7 +17,7 @@ use rustc_errors::struct_span_err;\n use rustc_expand::base::Annotatable;\n use rustc_expand::base::{Indeterminate, ResolverExpand, SyntaxExtension, SyntaxExtensionKind};\n use rustc_expand::compile_declarative_macro;\n-use rustc_expand::expand::{AstFragment, Invocation, InvocationKind};\n+use rustc_expand::expand::{AstFragment, Invocation, InvocationKind, SupportsMacroExpansion};\n use rustc_feature::is_builtin_attr_name;\n use rustc_hir::def::{self, DefKind, NonMacroAttrKind};\n use rustc_hir::def_id;\n@@ -278,12 +278,12 @@ impl<'a> ResolverExpand for Resolver<'a> {\n \n         // Derives are not included when `invocations` are collected, so we have to add them here.\n         let parent_scope = &ParentScope { derives, ..parent_scope };\n-        let require_inert = !invoc.fragment_kind.supports_macro_expansion();\n+        let supports_macro_expansion = invoc.fragment_kind.supports_macro_expansion();\n         let node_id = self.lint_node_id(eager_expansion_root);\n         let (ext, res) = self.smart_resolve_macro_path(\n             path,\n             kind,\n-            require_inert,\n+            supports_macro_expansion,\n             inner_attr,\n             parent_scope,\n             node_id,\n@@ -457,7 +457,7 @@ impl<'a> Resolver<'a> {\n         &mut self,\n         path: &ast::Path,\n         kind: MacroKind,\n-        require_inert: bool,\n+        supports_macro_expansion: SupportsMacroExpansion,\n         inner_attr: bool,\n         parent_scope: &ParentScope<'a>,\n         node_id: NodeId,\n@@ -505,8 +505,17 @@ impl<'a> Resolver<'a> {\n \n         let unexpected_res = if ext.macro_kind() != kind {\n             Some((kind.article(), kind.descr_expected()))\n-        } else if require_inert && matches!(res, Res::Def(..)) {\n-            Some((\"a\", \"non-macro attribute\"))\n+        } else if matches!(res, Res::Def(..)) {\n+            match supports_macro_expansion {\n+                SupportsMacroExpansion::No => Some((\"a\", \"non-macro attribute\")),\n+                SupportsMacroExpansion::Yes { supports_inner_attrs } => {\n+                    if inner_attr && !supports_inner_attrs {\n+                        Some((\"a\", \"non-macro inner attribute\"))\n+                    } else {\n+                        None\n+                    }\n+                }\n+            }\n         } else {\n             None\n         };"}, {"sha": "5707621f80e675dea8384773ed003586d80f7e0c", "filename": "src/test/ui/proc-macro/inner-attrs.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.rs?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -1,10 +1,10 @@\n-// check-pass\n // compile-flags: -Z span-debug --error-format human\n // aux-build:test-macros.rs\n \n #![feature(custom_inner_attributes)]\n #![feature(proc_macro_hygiene)]\n #![feature(stmt_expr_attributes)]\n+#![feature(rustc_attrs)]\n \n #![no_std] // Don't load unnecessary hygiene information from std\n extern crate std;\n@@ -25,17 +25,34 @@ struct MyStruct {\n \n fn bar() {\n     (#![print_target_and_args(fifth)] 1, 2);\n+    //~^ ERROR expected non-macro inner attribute, found attribute macro\n+\n+    #[print_target_and_args(tuple_attrs)] (\n+        #![cfg_attr(FALSE, rustc_dummy)]\n+        3, 4, {\n+            #![cfg_attr(not(FALSE), rustc_dummy(innermost))]\n+            5\n+        }\n+    );\n+\n+    #[print_target_and_args(array_attrs)] [\n+        #![rustc_dummy(inner)]\n+        true; 0\n+    ];\n \n     [#![print_target_and_args(sixth)] 1 , 2];\n+    //~^ ERROR expected non-macro inner attribute, found attribute macro\n     [#![print_target_and_args(seventh)] true ; 5];\n-\n+    //~^ ERROR expected non-macro inner attribute, found attribute macro\n \n     match 0 {\n         #![print_target_and_args(eighth)]\n+        //~^ ERROR expected non-macro inner attribute, found attribute macro\n         _ => {}\n     }\n \n     MyStruct { #![print_target_and_args(ninth)] field: true };\n+    //~^ ERROR expected non-macro inner attribute, found attribute macro\n }\n \n extern {"}, {"sha": "db774cbfb8fc34e2b289f9b8df47bf541566032b", "filename": "src/test/ui/proc-macro/inner-attrs.stderr", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.stderr?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -0,0 +1,32 @@\n+error: expected non-macro inner attribute, found attribute macro `print_target_and_args`\n+  --> $DIR/inner-attrs.rs:27:9\n+   |\n+LL |     (#![print_target_and_args(fifth)] 1, 2);\n+   |         ^^^^^^^^^^^^^^^^^^^^^ not a non-macro inner attribute\n+\n+error: expected non-macro inner attribute, found attribute macro `print_target_and_args`\n+  --> $DIR/inner-attrs.rs:43:9\n+   |\n+LL |     [#![print_target_and_args(sixth)] 1 , 2];\n+   |         ^^^^^^^^^^^^^^^^^^^^^ not a non-macro inner attribute\n+\n+error: expected non-macro inner attribute, found attribute macro `print_target_and_args`\n+  --> $DIR/inner-attrs.rs:45:9\n+   |\n+LL |     [#![print_target_and_args(seventh)] true ; 5];\n+   |         ^^^^^^^^^^^^^^^^^^^^^ not a non-macro inner attribute\n+\n+error: expected non-macro inner attribute, found attribute macro `print_target_and_args`\n+  --> $DIR/inner-attrs.rs:49:12\n+   |\n+LL |         #![print_target_and_args(eighth)]\n+   |            ^^^^^^^^^^^^^^^^^^^^^ not a non-macro inner attribute\n+\n+error: expected non-macro inner attribute, found attribute macro `print_target_and_args`\n+  --> $DIR/inner-attrs.rs:54:19\n+   |\n+LL |     MyStruct { #![print_target_and_args(ninth)] field: true };\n+   |                   ^^^^^^^^^^^^^^^^^^^^^ not a non-macro inner attribute\n+\n+error: aborting due to 5 previous errors\n+"}, {"sha": "ae04544e53356e390f220b80bb6b5c2354f7b175", "filename": "src/test/ui/proc-macro/inner-attrs.stdout", "status": "modified", "additions": 161, "deletions": 141, "changes": 302, "blob_url": "https://github.com/rust-lang/rust/blob/5e65467eff3d1da4712586d8402d1d2e1d6654bc/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/5e65467eff3d1da4712586d8402d1d2e1d6654bc/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Finner-attrs.stdout?ref=5e65467eff3d1da4712586d8402d1d2e1d6654bc", "patch": "@@ -290,231 +290,251 @@ PRINT-ATTR INPUT (DEBUG): TokenStream [\n         span: $DIR/inner-attrs.rs:17:1: 20:2 (#0),\n     },\n ]\n-PRINT-ATTR_ARGS INPUT (DISPLAY): fifth\n+PRINT-ATTR_ARGS INPUT (DISPLAY): tuple_attrs\n PRINT-ATTR_ARGS INPUT (DEBUG): TokenStream [\n     Ident {\n-        ident: \"fifth\",\n-        span: $DIR/inner-attrs.rs:27:31: 27:36 (#0),\n+        ident: \"tuple_attrs\",\n+        span: $DIR/inner-attrs.rs:30:29: 30:40 (#0),\n     },\n ]\n-PRINT-ATTR INPUT (DISPLAY): (1, 2) ;\n+PRINT-ATTR INPUT (DISPLAY): (# ! [cfg_attr(FALSE, rustc_dummy)] 3, 4,\n+ { # ! [cfg_attr(not(FALSE), rustc_dummy(innermost))] 5 }) ;\n PRINT-ATTR INPUT (DEBUG): TokenStream [\n     Group {\n         delimiter: Parenthesis,\n         stream: TokenStream [\n-            Literal {\n-                kind: Integer,\n-                symbol: \"1\",\n-                suffix: None,\n-                span: $DIR/inner-attrs.rs:27:5: 27:45 (#0),\n+            Punct {\n+                ch: '#',\n+                spacing: Joint,\n+                span: $DIR/inner-attrs.rs:31:9: 31:10 (#0),\n             },\n             Punct {\n-                ch: ',',\n+                ch: '!',\n                 spacing: Alone,\n-                span: $DIR/inner-attrs.rs:27:5: 27:45 (#0),\n+                span: $DIR/inner-attrs.rs:31:10: 31:11 (#0),\n             },\n-            Literal {\n-                kind: Integer,\n-                symbol: \"2\",\n-                suffix: None,\n-                span: $DIR/inner-attrs.rs:27:5: 27:45 (#0),\n+            Group {\n+                delimiter: Bracket,\n+                stream: TokenStream [\n+                    Ident {\n+                        ident: \"cfg_attr\",\n+                        span: $DIR/inner-attrs.rs:31:12: 31:20 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Parenthesis,\n+                        stream: TokenStream [\n+                            Ident {\n+                                ident: \"FALSE\",\n+                                span: $DIR/inner-attrs.rs:31:21: 31:26 (#0),\n+                            },\n+                            Punct {\n+                                ch: ',',\n+                                spacing: Alone,\n+                                span: $DIR/inner-attrs.rs:31:26: 31:27 (#0),\n+                            },\n+                            Ident {\n+                                ident: \"rustc_dummy\",\n+                                span: $DIR/inner-attrs.rs:31:28: 31:39 (#0),\n+                            },\n+                        ],\n+                        span: $DIR/inner-attrs.rs:31:20: 31:40 (#0),\n+                    },\n+                ],\n+                span: $DIR/inner-attrs.rs:31:11: 31:41 (#0),\n             },\n-        ],\n-        span: $DIR/inner-attrs.rs:27:5: 27:45 (#0),\n-    },\n-    Punct {\n-        ch: ';',\n-        spacing: Alone,\n-        span: $DIR/inner-attrs.rs:27:5: 27:45 (#0),\n-    },\n-]\n-PRINT-ATTR_ARGS INPUT (DISPLAY): sixth\n-PRINT-ATTR_ARGS INPUT (DEBUG): TokenStream [\n-    Ident {\n-        ident: \"sixth\",\n-        span: $DIR/inner-attrs.rs:29:31: 29:36 (#0),\n-    },\n-]\n-PRINT-ATTR INPUT (DISPLAY): [1, 2] ;\n-PRINT-ATTR INPUT (DEBUG): TokenStream [\n-    Group {\n-        delimiter: Bracket,\n-        stream: TokenStream [\n             Literal {\n                 kind: Integer,\n-                symbol: \"1\",\n+                symbol: \"3\",\n                 suffix: None,\n-                span: $DIR/inner-attrs.rs:29:5: 29:46 (#0),\n+                span: $DIR/inner-attrs.rs:32:9: 32:10 (#0),\n             },\n             Punct {\n                 ch: ',',\n                 spacing: Alone,\n-                span: $DIR/inner-attrs.rs:29:5: 29:46 (#0),\n+                span: $DIR/inner-attrs.rs:32:10: 32:11 (#0),\n             },\n             Literal {\n                 kind: Integer,\n-                symbol: \"2\",\n+                symbol: \"4\",\n                 suffix: None,\n-                span: $DIR/inner-attrs.rs:29:5: 29:46 (#0),\n-            },\n-        ],\n-        span: $DIR/inner-attrs.rs:29:5: 29:46 (#0),\n-    },\n-    Punct {\n-        ch: ';',\n-        spacing: Alone,\n-        span: $DIR/inner-attrs.rs:29:5: 29:46 (#0),\n-    },\n-]\n-PRINT-ATTR_ARGS INPUT (DISPLAY): seventh\n-PRINT-ATTR_ARGS INPUT (DEBUG): TokenStream [\n-    Ident {\n-        ident: \"seventh\",\n-        span: $DIR/inner-attrs.rs:30:31: 30:38 (#0),\n-    },\n-]\n-PRINT-ATTR INPUT (DISPLAY): [true ; 5] ;\n-PRINT-ATTR INPUT (DEBUG): TokenStream [\n-    Group {\n-        delimiter: Bracket,\n-        stream: TokenStream [\n-            Ident {\n-                ident: \"true\",\n-                span: $DIR/inner-attrs.rs:30:5: 30:51 (#0),\n+                span: $DIR/inner-attrs.rs:32:12: 32:13 (#0),\n             },\n             Punct {\n-                ch: ';',\n+                ch: ',',\n                 spacing: Alone,\n-                span: $DIR/inner-attrs.rs:30:5: 30:51 (#0),\n+                span: $DIR/inner-attrs.rs:32:13: 32:14 (#0),\n             },\n-            Literal {\n-                kind: Integer,\n-                symbol: \"5\",\n-                suffix: None,\n-                span: $DIR/inner-attrs.rs:30:5: 30:51 (#0),\n+            Group {\n+                delimiter: Brace,\n+                stream: TokenStream [\n+                    Punct {\n+                        ch: '#',\n+                        spacing: Joint,\n+                        span: $DIR/inner-attrs.rs:33:13: 33:14 (#0),\n+                    },\n+                    Punct {\n+                        ch: '!',\n+                        spacing: Alone,\n+                        span: $DIR/inner-attrs.rs:33:14: 33:15 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Bracket,\n+                        stream: TokenStream [\n+                            Ident {\n+                                ident: \"cfg_attr\",\n+                                span: $DIR/inner-attrs.rs:33:16: 33:24 (#0),\n+                            },\n+                            Group {\n+                                delimiter: Parenthesis,\n+                                stream: TokenStream [\n+                                    Ident {\n+                                        ident: \"not\",\n+                                        span: $DIR/inner-attrs.rs:33:25: 33:28 (#0),\n+                                    },\n+                                    Group {\n+                                        delimiter: Parenthesis,\n+                                        stream: TokenStream [\n+                                            Ident {\n+                                                ident: \"FALSE\",\n+                                                span: $DIR/inner-attrs.rs:33:29: 33:34 (#0),\n+                                            },\n+                                        ],\n+                                        span: $DIR/inner-attrs.rs:33:28: 33:35 (#0),\n+                                    },\n+                                    Punct {\n+                                        ch: ',',\n+                                        spacing: Alone,\n+                                        span: $DIR/inner-attrs.rs:33:35: 33:36 (#0),\n+                                    },\n+                                    Ident {\n+                                        ident: \"rustc_dummy\",\n+                                        span: $DIR/inner-attrs.rs:33:37: 33:48 (#0),\n+                                    },\n+                                    Group {\n+                                        delimiter: Parenthesis,\n+                                        stream: TokenStream [\n+                                            Ident {\n+                                                ident: \"innermost\",\n+                                                span: $DIR/inner-attrs.rs:33:49: 33:58 (#0),\n+                                            },\n+                                        ],\n+                                        span: $DIR/inner-attrs.rs:33:48: 33:59 (#0),\n+                                    },\n+                                ],\n+                                span: $DIR/inner-attrs.rs:33:24: 33:60 (#0),\n+                            },\n+                        ],\n+                        span: $DIR/inner-attrs.rs:33:15: 33:61 (#0),\n+                    },\n+                    Literal {\n+                        kind: Integer,\n+                        symbol: \"5\",\n+                        suffix: None,\n+                        span: $DIR/inner-attrs.rs:34:13: 34:14 (#0),\n+                    },\n+                ],\n+                span: $DIR/inner-attrs.rs:32:15: 35:10 (#0),\n             },\n         ],\n-        span: $DIR/inner-attrs.rs:30:5: 30:51 (#0),\n+        span: $DIR/inner-attrs.rs:30:43: 36:6 (#0),\n     },\n     Punct {\n         ch: ';',\n         spacing: Alone,\n-        span: $DIR/inner-attrs.rs:30:5: 30:51 (#0),\n+        span: $DIR/inner-attrs.rs:36:6: 36:7 (#0),\n     },\n ]\n-PRINT-ATTR_ARGS INPUT (DISPLAY): eighth\n+PRINT-ATTR_ARGS INPUT (DISPLAY): array_attrs\n PRINT-ATTR_ARGS INPUT (DEBUG): TokenStream [\n     Ident {\n-        ident: \"eighth\",\n-        span: $DIR/inner-attrs.rs:34:34: 34:40 (#0),\n+        ident: \"array_attrs\",\n+        span: $DIR/inner-attrs.rs:38:29: 38:40 (#0),\n     },\n ]\n-PRINT-ATTR INPUT (DISPLAY): match 0 { _ => { } }\n+PRINT-ATTR INPUT (DISPLAY): [# ! [rustc_dummy(inner)] true ; 0] ;\n PRINT-ATTR INPUT (DEBUG): TokenStream [\n-    Ident {\n-        ident: \"match\",\n-        span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n-    },\n-    Literal {\n-        kind: Integer,\n-        symbol: \"0\",\n-        suffix: None,\n-        span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n-    },\n     Group {\n-        delimiter: Brace,\n+        delimiter: Bracket,\n         stream: TokenStream [\n-            Ident {\n-                ident: \"_\",\n-                span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n-            },\n             Punct {\n-                ch: '=',\n+                ch: '#',\n                 spacing: Joint,\n-                span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n+                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n             },\n             Punct {\n-                ch: '>',\n+                ch: '!',\n                 spacing: Alone,\n-                span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n+                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n             },\n             Group {\n-                delimiter: Brace,\n-                stream: TokenStream [],\n-                span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n-            },\n-        ],\n-        span: $DIR/inner-attrs.rs:33:5: 36:6 (#0),\n-    },\n-]\n-PRINT-ATTR_ARGS INPUT (DISPLAY): ninth\n-PRINT-ATTR_ARGS INPUT (DEBUG): TokenStream [\n-    Ident {\n-        ident: \"ninth\",\n-        span: $DIR/inner-attrs.rs:38:41: 38:46 (#0),\n-    },\n-]\n-PRINT-ATTR INPUT (DISPLAY): MyStruct { field : true, } ;\n-PRINT-ATTR INPUT (DEBUG): TokenStream [\n-    Ident {\n-        ident: \"MyStruct\",\n-        span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n-    },\n-    Group {\n-        delimiter: Brace,\n-        stream: TokenStream [\n-            Ident {\n-                ident: \"field\",\n-                span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n-            },\n-            Punct {\n-                ch: ':',\n-                spacing: Alone,\n-                span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n+                delimiter: Bracket,\n+                stream: TokenStream [\n+                    Ident {\n+                        ident: \"rustc_dummy\",\n+                        span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Parenthesis,\n+                        stream: TokenStream [\n+                            Ident {\n+                                ident: \"inner\",\n+                                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n+                            },\n+                        ],\n+                        span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n+                    },\n+                ],\n+                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n             },\n             Ident {\n                 ident: \"true\",\n-                span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n+                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n             },\n             Punct {\n-                ch: ',',\n+                ch: ';',\n                 spacing: Alone,\n-                span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n+                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n+            },\n+            Literal {\n+                kind: Integer,\n+                symbol: \"0\",\n+                suffix: None,\n+                span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n             },\n         ],\n-        span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n+        span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n     },\n     Punct {\n         ch: ';',\n         spacing: Alone,\n-        span: $DIR/inner-attrs.rs:38:5: 38:63 (#0),\n+        span: $DIR/inner-attrs.rs:38:43: 41:7 (#0),\n     },\n ]\n PRINT-ATTR_ARGS INPUT (DISPLAY): tenth\n PRINT-ATTR_ARGS INPUT (DEBUG): TokenStream [\n     Ident {\n         ident: \"tenth\",\n-        span: $DIR/inner-attrs.rs:43:42: 43:47 (#0),\n+        span: $DIR/inner-attrs.rs:60:42: 60:47 (#0),\n     },\n ]\n PRINT-ATTR INPUT (DISPLAY): fn weird_extern() { }\n PRINT-ATTR INPUT (DEBUG): TokenStream [\n     Ident {\n         ident: \"fn\",\n-        span: $DIR/inner-attrs.rs:42:5: 44:6 (#0),\n+        span: $DIR/inner-attrs.rs:59:5: 61:6 (#0),\n     },\n     Ident {\n         ident: \"weird_extern\",\n-        span: $DIR/inner-attrs.rs:42:5: 44:6 (#0),\n+        span: $DIR/inner-attrs.rs:59:5: 61:6 (#0),\n     },\n     Group {\n         delimiter: Parenthesis,\n         stream: TokenStream [],\n-        span: $DIR/inner-attrs.rs:42:5: 44:6 (#0),\n+        span: $DIR/inner-attrs.rs:59:5: 61:6 (#0),\n     },\n     Group {\n         delimiter: Brace,\n         stream: TokenStream [],\n-        span: $DIR/inner-attrs.rs:42:5: 44:6 (#0),\n+        span: $DIR/inner-attrs.rs:59:5: 61:6 (#0),\n     },\n ]"}]}