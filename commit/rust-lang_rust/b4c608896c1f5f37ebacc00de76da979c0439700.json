{"sha": "b4c608896c1f5f37ebacc00de76da979c0439700", "node_id": "C_kwDOAAsO6NoAKGI0YzYwODg5NmMxZjVmMzdlYmFjYzAwZGU3NmRhOTc5YzA0Mzk3MDA", "commit": {"author": {"name": "iDawer", "email": "ilnur.iskhakov.oss@outlook.com", "date": "2022-04-01T14:12:50Z"}, "committer": {"name": "iDawer", "email": "ilnur.iskhakov.oss@outlook.com", "date": "2022-04-01T14:12:50Z"}, "message": "fix: splitting path of a glob import wrongly adds `self`\n\n`ast::UseTree::split_prefix` handles globs now.\nRemoved an extra branch for globs in `ide_db::imports::merge_imports::recursive_merge` (superseeded by split_prefix).", "tree": {"sha": "313ef3e4b4f65ad7715683964bda47c7cf13f123", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/313ef3e4b4f65ad7715683964bda47c7cf13f123"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b4c608896c1f5f37ebacc00de76da979c0439700", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b4c608896c1f5f37ebacc00de76da979c0439700", "html_url": "https://github.com/rust-lang/rust/commit/b4c608896c1f5f37ebacc00de76da979c0439700", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b4c608896c1f5f37ebacc00de76da979c0439700/comments", "author": {"login": "iDawer", "id": 7803845, "node_id": "MDQ6VXNlcjc4MDM4NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7803845?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iDawer", "html_url": "https://github.com/iDawer", "followers_url": "https://api.github.com/users/iDawer/followers", "following_url": "https://api.github.com/users/iDawer/following{/other_user}", "gists_url": "https://api.github.com/users/iDawer/gists{/gist_id}", "starred_url": "https://api.github.com/users/iDawer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iDawer/subscriptions", "organizations_url": "https://api.github.com/users/iDawer/orgs", "repos_url": "https://api.github.com/users/iDawer/repos", "events_url": "https://api.github.com/users/iDawer/events{/privacy}", "received_events_url": "https://api.github.com/users/iDawer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "iDawer", "id": 7803845, "node_id": "MDQ6VXNlcjc4MDM4NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7803845?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iDawer", "html_url": "https://github.com/iDawer", "followers_url": "https://api.github.com/users/iDawer/followers", "following_url": "https://api.github.com/users/iDawer/following{/other_user}", "gists_url": "https://api.github.com/users/iDawer/gists{/gist_id}", "starred_url": "https://api.github.com/users/iDawer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iDawer/subscriptions", "organizations_url": "https://api.github.com/users/iDawer/orgs", "repos_url": "https://api.github.com/users/iDawer/repos", "events_url": "https://api.github.com/users/iDawer/events{/privacy}", "received_events_url": "https://api.github.com/users/iDawer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bc08b8eff3f8e4da7c448d7b7f6461938c817a60", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc08b8eff3f8e4da7c448d7b7f6461938c817a60", "html_url": "https://github.com/rust-lang/rust/commit/bc08b8eff3f8e4da7c448d7b7f6461938c817a60"}], "stats": {"total": 74, "additions": 41, "deletions": 33}, "files": [{"sha": "705ae666176abbf9f9ed34b222303d17a2d920d0", "filename": "crates/ide_assists/src/handlers/merge_imports.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs?ref=b4c608896c1f5f37ebacc00de76da979c0439700", "patch": "@@ -330,7 +330,7 @@ use std$0::{fmt::*};\n use std::{fmt::{self, Display}};\n \",\n             r\"\n-use std::{fmt::{self, *, Display}};\n+use std::{fmt::{*, self, Display}};\n \",\n         )\n     }\n@@ -440,4 +440,18 @@ use std::$0\n fn main() {}\",\n         );\n     }\n+\n+    #[test]\n+    fn split_glob() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+use foo::$0*;\n+use foo::bar::Baz;\n+\",\n+            r\"\n+use foo::{*, bar::Baz};\n+\",\n+        );\n+    }\n }"}, {"sha": "e4b9651e5e807bed7f1f769456eebf1e226711ad", "filename": "crates/ide_db/src/imports/insert_use/tests.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fide_db%2Fsrc%2Fimports%2Finsert_use%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fide_db%2Fsrc%2Fimports%2Finsert_use%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fimports%2Finsert_use%2Ftests.rs?ref=b4c608896c1f5f37ebacc00de76da979c0439700", "patch": "@@ -656,7 +656,7 @@ fn merge_mod_into_glob() {\n     check_with_config(\n         \"token::TokenKind\",\n         r\"use token::TokenKind::*;\",\n-        r\"use token::TokenKind::{self, *};\",\n+        r\"use token::TokenKind::{*, self};\",\n         &InsertUseConfig {\n             granularity: ImportGranularity::Crate,\n             enforce_granularity: true,\n@@ -670,11 +670,10 @@ fn merge_mod_into_glob() {\n \n #[test]\n fn merge_self_glob() {\n-    cov_mark::check!(merge_self_glob);\n     check_with_config(\n         \"self\",\n         r\"use self::*;\",\n-        r\"use self::{self, *};\",\n+        r\"use self::{*, self};\",\n         &InsertUseConfig {\n             granularity: ImportGranularity::Crate,\n             enforce_granularity: true,\n@@ -693,7 +692,7 @@ fn merge_glob() {\n         r\"\n use syntax::{SyntaxKind::*};\",\n         r\"\n-use syntax::{SyntaxKind::{self, *}};\",\n+use syntax::{SyntaxKind::{*, self}};\",\n     )\n }\n \n@@ -702,7 +701,7 @@ fn merge_glob_nested() {\n     check_crate(\n         \"foo::bar::quux::Fez\",\n         r\"use foo::bar::{Baz, quux::*};\",\n-        r\"use foo::bar::{Baz, quux::{self::*, Fez}};\",\n+        r\"use foo::bar::{Baz, quux::{*, Fez}};\",\n     )\n }\n "}, {"sha": "d4e85db16e36f796f25023ba041d981bfb1853bd", "filename": "crates/ide_db/src/imports/merge_imports.rs", "status": "modified", "additions": 2, "deletions": 24, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fide_db%2Fsrc%2Fimports%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fide_db%2Fsrc%2Fimports%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fimports%2Fmerge_imports.rs?ref=b4c608896c1f5f37ebacc00de76da979c0439700", "patch": "@@ -3,7 +3,7 @@ use std::cmp::Ordering;\n \n use itertools::{EitherOrBoth, Itertools};\n use syntax::{\n-    ast::{self, make, AstNode, HasAttrs, HasVisibility, PathSegmentKind},\n+    ast::{self, AstNode, HasAttrs, HasVisibility, PathSegmentKind},\n     ted,\n };\n \n@@ -129,29 +129,7 @@ fn recursive_merge(lhs: &ast::UseTree, rhs: &ast::UseTree, merge: MergeBehavior)\n                         _ => (),\n                     }\n \n-                    // Glob imports aren't part of the use-tree lists so we need\n-                    // to special handle them here as well this special handling\n-                    // is only required for when we merge a module import into a\n-                    // glob import of said module see the `merge_self_glob` or\n-                    // `merge_mod_into_glob` tests.\n-                    if lhs_t.star_token().is_some() || rhs_t.star_token().is_some() {\n-                        if tree_is_self(lhs_t) || tree_is_self(&rhs_t) {\n-                            cov_mark::hit!(merge_self_glob);\n-                            let self_tree = make::use_tree(\n-                                make::path_unqualified(make::path_segment_self()),\n-                                None,\n-                                None,\n-                                false,\n-                            )\n-                            .clone_for_update();\n-                            ted::replace(lhs_t.syntax(), self_tree.syntax());\n-                            *lhs_t = self_tree;\n-                            let glob = make::use_tree_glob().clone_for_update();\n-                            use_trees.insert(idx, glob.clone());\n-                            lhs.get_or_create_use_tree_list().add_use_tree(glob);\n-                            continue;\n-                        }\n-                    } else if lhs_t.use_tree_list().is_none() && rhs_t.use_tree_list().is_none() {\n+                    if lhs_t.use_tree_list().is_none() && rhs_t.use_tree_list().is_none() {\n                         continue;\n                     }\n                 }"}, {"sha": "296c6bfec011762b498d45f8dc5a7b281971dedb", "filename": "crates/syntax/src/ast/edit_in_place.rs", "status": "modified", "additions": 20, "deletions": 3, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fsyntax%2Fsrc%2Fast%2Fedit_in_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4c608896c1f5f37ebacc00de76da979c0439700/crates%2Fsyntax%2Fsrc%2Fast%2Fedit_in_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fedit_in_place.rs?ref=b4c608896c1f5f37ebacc00de76da979c0439700", "patch": "@@ -302,16 +302,33 @@ impl ast::UseTree {\n \n     /// Splits off the given prefix, making it the path component of the use tree,\n     /// appending the rest of the path to all UseTreeList items.\n+    ///\n+    /// # Examples\n+    ///\n+    /// `prefix$0::suffix` -> `prefix::{suffix}`\n+    ///\n+    /// `prefix$0` -> `prefix::{self}`\n+    ///\n+    /// `prefix$0::*` -> `prefix::{*}`\n     pub fn split_prefix(&self, prefix: &ast::Path) {\n         debug_assert_eq!(self.path(), Some(prefix.top_path()));\n         let path = self.path().unwrap();\n         if &path == prefix && self.use_tree_list().is_none() {\n-            let self_suffix = make::path_unqualified(make::path_segment_self()).clone_for_update();\n-            ted::replace(path.syntax(), self_suffix.syntax());\n+            if self.star_token().is_some() {\n+                // path$0::* -> *\n+                self.coloncolon_token().map(ted::remove);\n+                ted::remove(prefix.syntax());\n+            } else {\n+                // path$0 -> self\n+                let self_suffix =\n+                    make::path_unqualified(make::path_segment_self()).clone_for_update();\n+                ted::replace(path.syntax(), self_suffix.syntax());\n+            }\n         } else if split_path_prefix(prefix).is_none() {\n             return;\n         }\n-\n+        // At this point, prefix path is detached; _self_ use tree has suffix path.\n+        // Next, transoform 'suffix' use tree into 'prefix::{suffix}'\n         let subtree = self.clone_subtree().clone_for_update();\n         ted::remove_all_iter(self.syntax().children_with_tokens());\n         ted::insert(Position::first_child_of(self.syntax()), prefix.syntax());"}]}