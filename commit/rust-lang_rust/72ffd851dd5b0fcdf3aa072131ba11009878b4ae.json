{"sha": "72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcyZmZkODUxZGQ1YjBmY2RmM2FhMDcyMTMxYmExMTAwOTg3OGI0YWU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-30T08:44:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-30T08:44:31Z"}, "message": "Merge #5581\n\n5581: Measure instructions in addition to time r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "4b35f683a6bfb70fa9e1db3b22371ebcde0e7d99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b35f683a6bfb70fa9e1db3b22371ebcde0e7d99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfIohvCRBK7hj4Ov3rIwAAdHIIAEh++106/6NFmG8bIiHvC0hN\n9ulFtNFKm0rwQ1U6hkL8RIi5amOrwHCumVT0RpmVhUxokuHcFFABktHld8g6uVX4\nik6C4LD7v8isPIR9k7HfFmBsHb6+4lc/xBpkiMlP69C/wKTb0EUy13ZeM3B5WBT8\nOWPYhP84D+bvgnHZAfgWtPZh+nqzr68uY8EU9k1DCLuXcwnNw7V+4deHiCGsBQvu\n8ZhztVopPLCGCXwIIyp9/bBepZzOd6PGDKU9VzPYlzjlrYGVU5M87zVF3k289HSf\nmDBHw1mUNdLYrQg1h4vHqmIKVVRKwdXuI1ZYlhQlWC7CXwhGetnC+7NvLiROy4o=\n=ykox\n-----END PGP SIGNATURE-----\n", "payload": "tree 4b35f683a6bfb70fa9e1db3b22371ebcde0e7d99\nparent c8573c418cb5240e0b60e93b15978b00e3ff0683\nparent f22af66c3763c4b2a9d16621473cb6979fb2f36d\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1596098671 +0000\ncommitter GitHub <noreply@github.com> 1596098671 +0000\n\nMerge #5581\n\n5581: Measure instructions in addition to time r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "html_url": "https://github.com/rust-lang/rust/commit/72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8573c418cb5240e0b60e93b15978b00e3ff0683", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8573c418cb5240e0b60e93b15978b00e3ff0683", "html_url": "https://github.com/rust-lang/rust/commit/c8573c418cb5240e0b60e93b15978b00e3ff0683"}, {"sha": "f22af66c3763c4b2a9d16621473cb6979fb2f36d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f22af66c3763c4b2a9d16621473cb6979fb2f36d", "html_url": "https://github.com/rust-lang/rust/commit/f22af66c3763c4b2a9d16621473cb6979fb2f36d"}], "stats": {"total": 145, "additions": 125, "deletions": 20}, "files": [{"sha": "e63dcc530fad8007bba7f003d8f2e9c66ee2f477", "filename": "Cargo.lock", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "patch": "@@ -840,6 +840,25 @@ version = \"2.1.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"d4fd5641d01c8f18a23da7b6fe29298ff4b55afcccdf78973b24cf3175fee32e\"\n \n+[[package]]\n+name = \"perf-event\"\n+version = \"0.4.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"0cb38a2f363560fb3cfcb47f28848b245a41c7e0d63e0b190918b712b6bf6803\"\n+dependencies = [\n+ \"libc\",\n+ \"perf-event-open-sys\",\n+]\n+\n+[[package]]\n+name = \"perf-event-open-sys\"\n+version = \"0.3.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"95db63e37862bc1b842135d2234ef9418f222cc660c6752f45e7cf9ddfb97f96\"\n+dependencies = [\n+ \"libc\",\n+]\n+\n [[package]]\n name = \"petgraph\"\n version = \"0.5.1\"\n@@ -1126,6 +1145,7 @@ dependencies = [\n  \"cfg-if\",\n  \"libc\",\n  \"once_cell\",\n+ \"perf-event\",\n  \"ra_arena\",\n ]\n "}, {"sha": "c82b9f76d4817873319ec5098738802e405d2c69", "filename": "crates/ra_prof/Cargo.toml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Fra_prof%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Fra_prof%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2FCargo.toml?ref=72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "patch": "@@ -16,6 +16,9 @@ backtrace = { version = \"0.3.44\", optional = true }\n cfg-if = \"0.1.10\"\n libc = \"0.2.73\"\n \n+[target.'cfg(target_os = \"linux\")'.dependencies]\n+perf-event = \"0.4\"\n+\n [features]\n cpu_profiler = []\n "}, {"sha": "eb50965ae6f07e7ad032ed4696699f8f02697d6a", "filename": "crates/ra_prof/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Fra_prof%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Fra_prof%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2Fsrc%2Flib.rs?ref=72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "patch": "@@ -1,5 +1,6 @@\n //! A collection of tools for profiling rust-analyzer.\n \n+mod stop_watch;\n mod memory_usage;\n #[cfg(feature = \"cpu_profiler\")]\n mod google_cpu_profiler;\n@@ -11,6 +12,7 @@ use std::cell::RefCell;\n pub use crate::{\n     hprof::{init, init_from, profile},\n     memory_usage::{Bytes, MemoryUsage},\n+    stop_watch::{StopWatch, StopWatchSpan},\n };\n \n /// Prints backtrace to stderr, useful for debugging."}, {"sha": "8b8ec25a5fe0f4f15a1c8d5d38cb76fc721b2ab4", "filename": "crates/ra_prof/src/stop_watch.rs", "status": "added", "additions": 79, "deletions": 0, "changes": 79, "blob_url": "https://github.com/rust-lang/rust/blob/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Fra_prof%2Fsrc%2Fstop_watch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Fra_prof%2Fsrc%2Fstop_watch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2Fsrc%2Fstop_watch.rs?ref=72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "patch": "@@ -0,0 +1,79 @@\n+//! Like `std::time::Instant`, but also measures memory & CPU cycles.\n+use std::{\n+    fmt,\n+    time::{Duration, Instant},\n+};\n+\n+use crate::MemoryUsage;\n+\n+pub struct StopWatch {\n+    time: Instant,\n+    #[cfg(target_os = \"linux\")]\n+    counter: Option<perf_event::Counter>,\n+    memory: Option<MemoryUsage>,\n+}\n+\n+pub struct StopWatchSpan {\n+    pub time: Duration,\n+    pub instructions: Option<u64>,\n+    pub memory: Option<MemoryUsage>,\n+}\n+\n+impl StopWatch {\n+    pub fn start() -> StopWatch {\n+        #[cfg(target_os = \"linux\")]\n+        let counter = {\n+            let mut counter = perf_event::Builder::new().build().ok();\n+            if let Some(counter) = &mut counter {\n+                let _ = counter.enable();\n+            }\n+            counter\n+        };\n+        let time = Instant::now();\n+        StopWatch {\n+            time,\n+            #[cfg(target_os = \"linux\")]\n+            counter,\n+            memory: None,\n+        }\n+    }\n+    pub fn memory(mut self, yes: bool) -> StopWatch {\n+        if yes {\n+            self.memory = Some(MemoryUsage::current());\n+        }\n+        self\n+    }\n+    pub fn elapsed(&mut self) -> StopWatchSpan {\n+        let time = self.time.elapsed();\n+\n+        #[cfg(target_os = \"linux\")]\n+        let instructions = self.counter.as_mut().and_then(|it| it.read().ok());\n+        #[cfg(not(target_os = \"linux\"))]\n+        let instructions = None;\n+\n+        let memory = self.memory.map(|it| MemoryUsage::current() - it);\n+        StopWatchSpan { time, instructions, memory }\n+    }\n+}\n+\n+impl fmt::Display for StopWatchSpan {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        write!(f, \"{:.2?}\", self.time)?;\n+        if let Some(mut instructions) = self.instructions {\n+            let mut prefix = \"\";\n+            if instructions > 10000 {\n+                instructions /= 1000;\n+                prefix = \"k\"\n+            }\n+            if instructions > 10000 {\n+                instructions /= 1000;\n+                prefix = \"m\"\n+            }\n+            write!(f, \", {}{}i\", instructions, prefix)?;\n+        }\n+        if let Some(memory) = self.memory {\n+            write!(f, \", {}\", memory)?;\n+        }\n+        Ok(())\n+    }\n+}"}, {"sha": "73ec3204b79ca5ab57df8b471d7750847647c77a", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 21, "deletions": 20, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72ffd851dd5b0fcdf3aa072131ba11009878b4ae/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=72ffd851dd5b0fcdf3aa072131ba11009878b4ae", "patch": "@@ -3,7 +3,7 @@\n \n use std::{\n     path::Path,\n-    time::{Instant, SystemTime, UNIX_EPOCH},\n+    time::{SystemTime, UNIX_EPOCH},\n };\n \n use hir::{\n@@ -29,6 +29,7 @@ use crate::{\n     },\n     print_memory_usage,\n };\n+use ra_prof::StopWatch;\n \n /// Need to wrap Snapshot to provide `Clone` impl for `map_with`\n struct Snap<DB>(DB);\n@@ -54,11 +55,12 @@ pub fn analysis_stats(\n         Rand32::new(seed)\n     };\n \n-    let db_load_time = Instant::now();\n+    let mut db_load_sw = StopWatch::start().memory(memory_usage);\n     let (host, vfs) = load_cargo(path, load_output_dirs, with_proc_macro)?;\n     let db = host.raw_database();\n-    eprintln!(\"Database loaded {:?}\", db_load_time.elapsed());\n-    let analysis_time = Instant::now();\n+    eprintln!(\"Database loaded {}\", db_load_sw.elapsed());\n+\n+    let mut analysis_sw = StopWatch::start().memory(memory_usage);\n     let mut num_crates = 0;\n     let mut visited_modules = FxHashSet::default();\n     let mut visit_queue = Vec::new();\n@@ -110,20 +112,20 @@ pub fn analysis_stats(\n     eprintln!(\"Total modules found: {}\", visited_modules.len());\n     eprintln!(\"Total declarations: {}\", num_decls);\n     eprintln!(\"Total functions: {}\", funcs.len());\n-    let item_collection_memory = ra_prof::memory_usage();\n-    eprintln!(\"Item Collection: {:?}, {}\", analysis_time.elapsed(), item_collection_memory);\n+    eprintln!(\"Item Collection: {}\", analysis_sw.elapsed());\n \n     if randomize {\n         shuffle(&mut rng, &mut funcs);\n     }\n \n     let mut bar = match verbosity {\n         Verbosity::Quiet | Verbosity::Spammy => ProgressReport::hidden(),\n+        _ if parallel => ProgressReport::hidden(),\n         _ => ProgressReport::new(funcs.len() as u64),\n     };\n \n     if parallel {\n-        let inference_time = Instant::now();\n+        let mut inference_sw = StopWatch::start().memory(memory_usage);\n         let snap = Snap(db.snapshot());\n         funcs\n             .par_iter()\n@@ -133,14 +135,10 @@ pub fn analysis_stats(\n                 snap.0.infer(f_id.into());\n             })\n             .count();\n-        eprintln!(\n-            \"Parallel Inference: {:?}, {}\",\n-            inference_time.elapsed(),\n-            ra_prof::memory_usage()\n-        );\n+        eprintln!(\"Parallel Inference: {}\", inference_sw.elapsed());\n     }\n \n-    let inference_time = Instant::now();\n+    let mut inference_sw = StopWatch::start().memory(memory_usage);\n     bar.tick();\n     let mut num_exprs = 0;\n     let mut num_exprs_unknown = 0;\n@@ -291,14 +289,17 @@ pub fn analysis_stats(\n     eprintln!(\"Type mismatches: {}\", num_type_mismatches);\n     report_metric(\"type mismatches\", num_type_mismatches, \"#\");\n \n-    let inference_time = inference_time.elapsed();\n-    let total_memory = ra_prof::memory_usage();\n-    eprintln!(\"Inference: {:?}, {}\", inference_time, total_memory - item_collection_memory);\n+    eprintln!(\"Inference: {}\", inference_sw.elapsed());\n \n-    let analysis_time = analysis_time.elapsed();\n-    eprintln!(\"Total: {:?}, {}\", analysis_time, total_memory);\n-    report_metric(\"total time\", analysis_time.as_millis() as u64, \"ms\");\n-    report_metric(\"total memory\", total_memory.allocated.megabytes() as u64, \"MB\");\n+    let total_span = analysis_sw.elapsed();\n+    eprintln!(\"Total: {}\", total_span);\n+    report_metric(\"total time\", total_span.time.as_millis() as u64, \"ms\");\n+    if let Some(instructions) = total_span.instructions {\n+        report_metric(\"total time\", instructions, \"#instr\");\n+    }\n+    if let Some(memory) = total_span.memory {\n+        report_metric(\"total memory\", memory.allocated.megabytes() as u64, \"MB\");\n+    }\n \n     if memory_usage {\n         print_memory_usage(host, vfs);"}]}