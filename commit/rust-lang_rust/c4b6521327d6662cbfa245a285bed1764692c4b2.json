{"sha": "c4b6521327d6662cbfa245a285bed1764692c4b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0YjY1MjEzMjdkNjY2MmNiZmEyNDVhMjg1YmVkMTc2NDY5MmM0YjI=", "commit": {"author": {"name": "Scott McMurray", "email": "scottmcm@users.noreply.github.com", "date": "2018-03-25T07:16:16Z"}, "committer": {"name": "Scott McMurray", "email": "scottmcm@users.noreply.github.com", "date": "2018-04-11T03:03:40Z"}, "message": "Add ok-wrapping to catch blocks, per RFC", "tree": {"sha": "511df2397217eec12823f333d1ca704736694219", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/511df2397217eec12823f333d1ca704736694219"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4b6521327d6662cbfa245a285bed1764692c4b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4b6521327d6662cbfa245a285bed1764692c4b2", "html_url": "https://github.com/rust-lang/rust/commit/c4b6521327d6662cbfa245a285bed1764692c4b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4b6521327d6662cbfa245a285bed1764692c4b2/comments", "author": {"login": "scottmcm", "id": 18526288, "node_id": "MDQ6VXNlcjE4NTI2Mjg4", "avatar_url": "https://avatars.githubusercontent.com/u/18526288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scottmcm", "html_url": "https://github.com/scottmcm", "followers_url": "https://api.github.com/users/scottmcm/followers", "following_url": "https://api.github.com/users/scottmcm/following{/other_user}", "gists_url": "https://api.github.com/users/scottmcm/gists{/gist_id}", "starred_url": "https://api.github.com/users/scottmcm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scottmcm/subscriptions", "organizations_url": "https://api.github.com/users/scottmcm/orgs", "repos_url": "https://api.github.com/users/scottmcm/repos", "events_url": "https://api.github.com/users/scottmcm/events{/privacy}", "received_events_url": "https://api.github.com/users/scottmcm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "scottmcm", "id": 18526288, "node_id": "MDQ6VXNlcjE4NTI2Mjg4", "avatar_url": "https://avatars.githubusercontent.com/u/18526288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scottmcm", "html_url": "https://github.com/scottmcm", "followers_url": "https://api.github.com/users/scottmcm/followers", "following_url": "https://api.github.com/users/scottmcm/following{/other_user}", "gists_url": "https://api.github.com/users/scottmcm/gists{/gist_id}", "starred_url": "https://api.github.com/users/scottmcm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scottmcm/subscriptions", "organizations_url": "https://api.github.com/users/scottmcm/orgs", "repos_url": "https://api.github.com/users/scottmcm/repos", "events_url": "https://api.github.com/users/scottmcm/events{/privacy}", "received_events_url": "https://api.github.com/users/scottmcm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b72d48f8e5f3c7cabcf6fcd31474209bff0ab59", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b72d48f8e5f3c7cabcf6fcd31474209bff0ab59", "html_url": "https://github.com/rust-lang/rust/commit/0b72d48f8e5f3c7cabcf6fcd31474209bff0ab59"}], "stats": {"total": 119, "additions": 80, "deletions": 39}, "files": [{"sha": "5bc1bf4431c5bc6f3b23fad380352594776265d1", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 35, "deletions": 7, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -3010,7 +3010,27 @@ impl<'a> LoweringContext<'a> {\n                 )\n             }),\n             ExprKind::Catch(ref body) => {\n-                self.with_catch_scope(body.id, |this| hir::ExprBlock(this.lower_block(body, true)))\n+                self.with_catch_scope(body.id, |this| {\n+                    let unstable_span =\n+                        this.allow_internal_unstable(CompilerDesugaringKind::Catch, body.span);\n+                    let mut block = this.lower_block(body, true).into_inner();\n+                    let tail = block.expr.take().map_or_else(\n+                        || {\n+                            let LoweredNodeId { node_id, hir_id } = this.next_id();\n+                            hir::Expr {\n+                                id: node_id,\n+                                span: unstable_span,\n+                                node: hir::ExprTup(hir_vec![]),\n+                                attrs: ThinVec::new(),\n+                                hir_id,\n+                            }\n+                        },\n+                        |x: P<hir::Expr>| x.into_inner(),\n+                    );\n+                    block.expr = Some(this.wrap_in_try_constructor(\n+                        \"from_ok\", tail, unstable_span));\n+                    hir::ExprBlock(P(block))\n+                })\n             }\n             ExprKind::Match(ref expr, ref arms) => hir::ExprMatch(\n                 P(self.lower_expr(expr)),\n@@ -3539,12 +3559,8 @@ impl<'a> LoweringContext<'a> {\n \n                         self.expr_call(e.span, from, hir_vec![err_expr])\n                     };\n-                    let from_err_expr = {\n-                        let path = &[\"ops\", \"Try\", \"from_error\"];\n-                        let from_err = P(self.expr_std_path(unstable_span, path, ThinVec::new()));\n-                        P(self.expr_call(e.span, from_err, hir_vec![from_expr]))\n-                    };\n-\n+                    let from_err_expr =\n+                        self.wrap_in_try_constructor(\"from_error\", from_expr, unstable_span);\n                     let thin_attrs = ThinVec::from(attrs);\n                     let catch_scope = self.catch_scopes.last().map(|x| *x);\n                     let ret_expr = if let Some(catch_node) = catch_scope {\n@@ -4079,6 +4095,18 @@ impl<'a> LoweringContext<'a> {\n             )\n         }\n     }\n+\n+    fn wrap_in_try_constructor(\n+        &mut self,\n+        method: &'static str,\n+        e: hir::Expr,\n+        unstable_span: Span,\n+    ) -> P<hir::Expr> {\n+        let path = &[\"ops\", \"Try\", method];\n+        let from_err = P(self.expr_std_path(unstable_span, path,\n+                                            ThinVec::new()));\n+        P(self.expr_call(e.span, from_err, hir_vec![e]))\n+    }\n }\n \n fn body_ids(bodies: &BTreeMap<hir::BodyId, hir::Body>) -> Vec<hir::BodyId> {"}, {"sha": "4ac678aaa052de443bb5a58d3d91d88de170c80a", "filename": "src/librustc/ich/impls_syntax.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc%2Fich%2Fimpls_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc%2Fich%2Fimpls_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_syntax.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -372,7 +372,8 @@ impl_stable_hash_for!(enum ::syntax_pos::hygiene::ExpnFormat {\n \n impl_stable_hash_for!(enum ::syntax_pos::hygiene::CompilerDesugaringKind {\n     DotFill,\n-    QuestionMark\n+    QuestionMark,\n+    Catch\n });\n \n impl_stable_hash_for!(enum ::syntax_pos::FileName {"}, {"sha": "942e4fb56cabc0471c3e960e939d6d9f505d0f07", "filename": "src/librustc_mir/borrow_check/nll/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fmod.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -202,11 +202,11 @@ fn dump_mir_results<'a, 'gcx, 'tcx>(\n     });\n \n     // Also dump the inference graph constraints as a graphviz file.\n-    let _: io::Result<()> = do catch {\n+    let _: io::Result<()> = do_catch! {{\n         let mut file =\n             pretty::create_dump_file(infcx.tcx, \"regioncx.dot\", None, \"nll\", &0, source)?;\n-        regioncx.dump_graphviz(&mut file)\n-    };\n+        regioncx.dump_graphviz(&mut file)?;\n+    }};\n }\n \n fn dump_annotation<'a, 'gcx, 'tcx>("}, {"sha": "3741b8feccc0911aef4b1bf4ba63a28306cff9bb", "filename": "src/librustc_mir/lib.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc_mir%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc_mir%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Flib.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -33,6 +33,7 @@ Rust MIR: a lowered representation of Rust. Also: an experiment!\n #![feature(nonzero)]\n #![feature(inclusive_range_fields)]\n #![feature(crate_visibility_modifier)]\n+#![cfg_attr(stage0, feature(try_trait))]\n \n extern crate arena;\n #[macro_use]\n@@ -54,6 +55,16 @@ extern crate log_settings;\n extern crate rustc_apfloat;\n extern crate byteorder;\n \n+#[cfg(stage0)]\n+macro_rules! do_catch {\n+  ($t:expr) => { (|| ::std::ops::Try::from_ok($t) )() }\n+}\n+\n+#[cfg(not(stage0))]\n+macro_rules! do_catch {\n+  ($t:expr) => { do catch { $t } }\n+}\n+\n mod diagnostics;\n \n mod borrow_check;"}, {"sha": "a891e372ad8b5989745b442b0f6d64f90f774684", "filename": "src/librustc_mir/util/pretty.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpretty.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -137,7 +137,7 @@ fn dump_matched_mir_node<'a, 'gcx, 'tcx, F>(\n ) where\n     F: FnMut(PassWhere, &mut dyn Write) -> io::Result<()>,\n {\n-    let _: io::Result<()> = do catch {\n+    let _: io::Result<()> = do_catch! {{\n         let mut file = create_dump_file(tcx, \"mir\", pass_num, pass_name, disambiguator, source)?;\n         writeln!(file, \"// MIR for `{}`\", node_path)?;\n         writeln!(file, \"// source = {:?}\", source)?;\n@@ -150,16 +150,14 @@ fn dump_matched_mir_node<'a, 'gcx, 'tcx, F>(\n         extra_data(PassWhere::BeforeCFG, &mut file)?;\n         write_mir_fn(tcx, source, mir, &mut extra_data, &mut file)?;\n         extra_data(PassWhere::AfterCFG, &mut file)?;\n-        Ok(())\n-    };\n+    }};\n \n     if tcx.sess.opts.debugging_opts.dump_mir_graphviz {\n-        let _: io::Result<()> = do catch {\n+        let _: io::Result<()> = do_catch! {{\n             let mut file =\n                 create_dump_file(tcx, \"dot\", pass_num, pass_name, disambiguator, source)?;\n             write_mir_fn_graphviz(tcx, source.def_id, mir, &mut file)?;\n-            Ok(())\n-        };\n+        }};\n     }\n }\n "}, {"sha": "8cb5776fdeb0167ccc3ea403fa8e8cf7d728db8c", "filename": "src/libsyntax_pos/hygiene.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibsyntax_pos%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Flibsyntax_pos%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fhygiene.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -432,6 +432,7 @@ pub enum ExpnFormat {\n pub enum CompilerDesugaringKind {\n     DotFill,\n     QuestionMark,\n+    Catch,\n }\n \n impl CompilerDesugaringKind {\n@@ -440,6 +441,7 @@ impl CompilerDesugaringKind {\n         let s = match *self {\n             DotFill => \"...\",\n             QuestionMark => \"?\",\n+            Catch => \"do catch\",\n         };\n         Symbol::intern(s)\n     }"}, {"sha": "f332ffd449423b34087fb335697fe36df202340e", "filename": "src/test/compile-fail/catch-bad-lifetime.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-bad-lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-bad-lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcatch-bad-lifetime.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -21,7 +21,6 @@ pub fn main() {\n             //~^ ERROR `my_string` does not live long enough\n             Err(my_str) ?;\n             Err(\"\") ?;\n-            Ok(())\n         };\n     }\n \n@@ -32,7 +31,6 @@ pub fn main() {\n         let mut j: Result<(), &mut i32> = do catch {\n             Err(k) ?;\n             i = 10; //~ ERROR cannot assign to `i` because it is borrowed\n-            Ok(())\n         };\n         ::std::mem::drop(k); //~ ERROR use of moved value: `k`\n         i = 40; //~ ERROR cannot assign to `i` because it is borrowed"}, {"sha": "b369847699bdbb1ffa99d138b553c5087b50f65e", "filename": "src/test/compile-fail/catch-bad-type.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-bad-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-bad-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcatch-bad-type.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -11,11 +11,18 @@\n #![feature(catch_expr)]\n \n pub fn main() {\n-    let res: Result<i32, i32> = do catch {\n+    let res: Result<u32, i32> = do catch {\n         Err(\"\")?; //~ ERROR the trait bound `i32: std::convert::From<&str>` is not satisfied\n-        Ok(5)\n+        5\n     };\n+\n     let res: Result<i32, i32> = do catch {\n-        Ok(\"\") //~ mismatched types\n+        \"\" //~ ERROR type mismatch\n     };\n+\n+    let res: Result<i32, i32> = do catch { }; //~ ERROR type mismatch\n+\n+    let res: () = do catch { }; //~ the trait bound `(): std::ops::Try` is not satisfied\n+\n+    let res: i32 = do catch { 5 }; //~ ERROR the trait bound `i32: std::ops::Try` is not satisfied\n }"}, {"sha": "faefb5ef18a351efeb8f9b7e08a9d0000a8d4d6d", "filename": "src/test/compile-fail/catch-maybe-bad-lifetime.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-maybe-bad-lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-maybe-bad-lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcatch-maybe-bad-lifetime.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -17,7 +17,7 @@ pub fn main() {\n         let mut i = 222;\n         let x: Result<&i32, ()> = do catch {\n             Err(())?;\n-            Ok(&i)\n+            &i\n         };\n         x.ok().cloned();\n         i = 0; //~ ERROR cannot assign to `i` because it is borrowed\n@@ -29,7 +29,6 @@ pub fn main() {\n         let _y: Result<(), ()> = do catch {\n             Err(())?;\n             ::std::mem::drop(x);\n-            Ok(())\n         };\n         println!(\"{}\", x); //~ ERROR use of moved value: `x`\n     }\n@@ -42,7 +41,6 @@ pub fn main() {\n         let x: Result<(), ()> = do catch {\n             Err(())?;\n             j = &i;\n-            Ok(())\n         };\n         i = 0; //~ ERROR cannot assign to `i` because it is borrowed\n         let _ = i;"}, {"sha": "0c41102e3bea41e398f9226220f356b30510fd6b", "filename": "src/test/compile-fail/catch-opt-init.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-opt-init.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Fcompile-fail%2Fcatch-opt-init.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcatch-opt-init.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -19,7 +19,6 @@ pub fn main() {\n         cfg_res = 5;\n         Ok::<(), ()>(())?;\n         use_val(cfg_res);\n-        Ok(())\n     };\n     assert_eq!(cfg_res, 5); //~ ERROR use of possibly uninitialized variable\n }"}, {"sha": "c23bca7f49e54f2479c615183a6e94678efbd11f", "filename": "src/test/run-pass/catch-expr.rs", "status": "modified", "additions": 12, "deletions": 13, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Frun-pass%2Fcatch-expr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b6521327d6662cbfa245a285bed1764692c4b2/src%2Ftest%2Frun-pass%2Fcatch-expr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcatch-expr.rs?ref=c4b6521327d6662cbfa245a285bed1764692c4b2", "patch": "@@ -13,11 +13,11 @@\n struct catch {}\n \n pub fn main() {\n-    let catch_result = do catch {\n+    let catch_result: Option<_> = do catch {\n         let x = 5;\n         x\n     };\n-    assert_eq!(catch_result, 5);\n+    assert_eq!(catch_result, Some(5));\n \n     let mut catch = true;\n     while catch { catch = false; }\n@@ -30,51 +30,50 @@ pub fn main() {\n         _ => {}\n     };\n \n-    let catch_err = do catch {\n+    let catch_err: Result<_, i32> = do catch {\n         Err(22)?;\n-        Ok(1)\n+        1\n     };\n     assert_eq!(catch_err, Err(22));\n \n     let catch_okay: Result<i32, i32> = do catch {\n         if false { Err(25)?; }\n         Ok::<(), i32>(())?;\n-        Ok(28)\n+        28\n     };\n     assert_eq!(catch_okay, Ok(28));\n \n     let catch_from_loop: Result<i32, i32> = do catch {\n         for i in 0..10 {\n             if i < 5 { Ok::<i32, i32>(i)?; } else { Err(i)?; }\n         }\n-        Ok(22)\n+        22\n     };\n     assert_eq!(catch_from_loop, Err(5));\n \n     let cfg_init;\n     let _res: Result<(), ()> = do catch {\n         cfg_init = 5;\n-        Ok(())\n     };\n     assert_eq!(cfg_init, 5);\n \n     let cfg_init_2;\n     let _res: Result<(), ()> = do catch {\n         cfg_init_2 = 6;\n         Err(())?;\n-        Ok(())\n     };\n     assert_eq!(cfg_init_2, 6);\n \n     let my_string = \"test\".to_string();\n     let res: Result<&str, ()> = do catch {\n-        Ok(&my_string)\n+        // Unfortunately, deref doesn't fire here (#49356)\n+        &my_string[..]\n     };\n     assert_eq!(res, Ok(\"test\"));\n \n-    do catch {\n-        ()\n-    }\n+    let my_opt: Option<_> = do catch { () };\n+    assert_eq!(my_opt, Some(()));\n \n-    ();\n+    let my_opt: Option<_> = do catch { };\n+    assert_eq!(my_opt, Some(()));\n }"}]}