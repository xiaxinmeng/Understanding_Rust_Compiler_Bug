{"sha": "33939a3db1da5a9e9c0009e50d3b70318a0b84a4", "node_id": "C_kwDOAAsO6NoAKDMzOTM5YTNkYjFkYTVhOWU5YzAwMDllNTBkM2I3MDMxOGEwYjg0YTQ", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-05-20T15:28:39Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-05-20T15:28:39Z"}, "message": "Don't swallow build script errors", "tree": {"sha": "b7698bd4fc047dee90920b2cfca1adf7379b3886", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b7698bd4fc047dee90920b2cfca1adf7379b3886"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/33939a3db1da5a9e9c0009e50d3b70318a0b84a4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/33939a3db1da5a9e9c0009e50d3b70318a0b84a4", "html_url": "https://github.com/rust-lang/rust/commit/33939a3db1da5a9e9c0009e50d3b70318a0b84a4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/33939a3db1da5a9e9c0009e50d3b70318a0b84a4/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a978e1404cdfa6f83818717b2dcdc989e8bc09f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a978e1404cdfa6f83818717b2dcdc989e8bc09f", "html_url": "https://github.com/rust-lang/rust/commit/2a978e1404cdfa6f83818717b2dcdc989e8bc09f"}], "stats": {"total": 34, "additions": 17, "deletions": 17}, "files": [{"sha": "d4792633efbd4895a989fc3227d4591821cac394", "filename": "crates/project-model/src/build_scripts.rs", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/33939a3db1da5a9e9c0009e50d3b70318a0b84a4/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/33939a3db1da5a9e9c0009e50d3b70318a0b84a4/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs?ref=33939a3db1da5a9e9c0009e50d3b70318a0b84a4", "patch": "@@ -7,6 +7,7 @@\n //! here, but it covers procedural macros as well.\n \n use std::{\n+    cell::RefCell,\n     io,\n     path::PathBuf,\n     process::{Command, Stdio},\n@@ -107,15 +108,15 @@ impl WorkspaceBuildScripts {\n             by_id.insert(workspace[package].id.clone(), package);\n         }\n \n-        let mut cfg_err = None;\n-        let mut stderr = String::new();\n+        let errors = RefCell::new(String::new());\n+        let push_err = |err: &str| {\n+            let mut e = errors.borrow_mut();\n+            e.push_str(err);\n+            e.push('\\n');\n+        };\n         let output = stdx::process::streaming_output(\n             cmd,\n             &mut |line| {\n-                if cfg_err.is_some() {\n-                    return;\n-                }\n-\n                 // Copy-pasted from existing cargo_metadata. It seems like we\n                 // should be using serde_stacker here?\n                 let mut deserializer = serde_json::Deserializer::from_str(line);\n@@ -135,7 +136,7 @@ impl WorkspaceBuildScripts {\n                                 match cfg.parse::<CfgFlag>() {\n                                     Ok(it) => acc.push(it),\n                                     Err(err) => {\n-                                        cfg_err = Some(format!(\n+                                        push_err(&format!(\n                                             \"invalid cfg from cargo-metadata: {}\",\n                                             err\n                                         ));\n@@ -177,15 +178,18 @@ impl WorkspaceBuildScripts {\n                     }\n                     Message::CompilerMessage(message) => {\n                         progress(message.target.name);\n+\n+                        if let Some(diag) = message.message.rendered.as_deref() {\n+                            push_err(diag);\n+                        }\n                     }\n                     Message::BuildFinished(_) => {}\n                     Message::TextLine(_) => {}\n                     _ => {}\n                 }\n             },\n             &mut |line| {\n-                stderr.push_str(line);\n-                stderr.push('\\n');\n+                push_err(line);\n             },\n         )?;\n \n@@ -205,16 +209,12 @@ impl WorkspaceBuildScripts {\n             }\n         }\n \n-        if let Some(cfg_err) = cfg_err {\n-            stderr.push_str(&cfg_err);\n-            stderr.push('\\n');\n-        }\n-\n+        let mut errors = errors.into_inner();\n         if !output.status.success() {\n-            if stderr.is_empty() {\n-                stderr = \"cargo check failed\".to_string();\n+            if errors.is_empty() {\n+                errors = \"cargo check failed\".to_string();\n             }\n-            res.error = Some(stderr)\n+            res.error = Some(errors);\n         }\n \n         Ok(res)"}]}