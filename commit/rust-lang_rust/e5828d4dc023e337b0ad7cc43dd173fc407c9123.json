{"sha": "e5828d4dc023e337b0ad7cc43dd173fc407c9123", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1ODI4ZDRkYzAyM2UzMzdiMGFkN2NjNDNkZDE3M2ZjNDA3YzkxMjM=", "commit": {"author": {"name": "varkor", "email": "github@varkor.com", "date": "2019-04-30T19:37:05Z"}, "committer": {"name": "varkor", "email": "github@varkor.com", "date": "2019-05-02T20:47:14Z"}, "message": "Prevent dependencies between std/test/rustc unifying with each other", "tree": {"sha": "ac91ca57fa5b6b504bf8a5761bbb059b13d94f77", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ac91ca57fa5b6b504bf8a5761bbb059b13d94f77"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e5828d4dc023e337b0ad7cc43dd173fc407c9123", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e5828d4dc023e337b0ad7cc43dd173fc407c9123", "html_url": "https://github.com/rust-lang/rust/commit/e5828d4dc023e337b0ad7cc43dd173fc407c9123", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e5828d4dc023e337b0ad7cc43dd173fc407c9123/comments", "author": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08bfe16129b0621bc90184f8704523d4929695ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/08bfe16129b0621bc90184f8704523d4929695ef", "html_url": "https://github.com/rust-lang/rust/commit/08bfe16129b0621bc90184f8704523d4929695ef"}], "stats": {"total": 24, "additions": 20, "deletions": 4}, "files": [{"sha": "c84eb6476e087aea79ce0ac579faab177c7b0f88", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e5828d4dc023e337b0ad7cc43dd173fc407c9123/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5828d4dc023e337b0ad7cc43dd173fc407c9123/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=e5828d4dc023e337b0ad7cc43dd173fc407c9123", "patch": "@@ -853,14 +853,30 @@ impl<'a> Builder<'a> {\n \n         // FIXME: Temporary fix for https://github.com/rust-lang/cargo/issues/3005\n         // Force cargo to output binaries with disambiguating hashes in the name\n-        let metadata = if compiler.stage == 0 {\n-            // Treat stage0 like special channel, whether it's a normal prior-\n+        let mut metadata = if compiler.stage == 0 {\n+            // Treat stage0 like a special channel, whether it's a normal prior-\n             // release rustc or a local rebuild with the same version, so we\n             // never mix these libraries by accident.\n-            \"bootstrap\"\n+            \"bootstrap\".to_string()\n         } else {\n-            &self.config.channel\n+            self.config.channel.to_string()\n         };\n+        // We want to make sure that none of the dependencies between\n+        // std/test/rustc unify with one another. This is done for weird linkage\n+        // reasons but the gist of the problem is that if librustc, libtest, and\n+        // libstd all depend on libc from crates.io (which they actually do) we\n+        // want to make sure they all get distinct versions. Things get really\n+        // weird if we try to unify all these dependencies right now, namely\n+        // around how many times the library is linked in dynamic libraries and\n+        // such. If rustc were a static executable or if we didn't ship dylibs\n+        // this wouldn't be a problem, but we do, so it is. This is in general\n+        // just here to make sure things build right. If you can remove this and\n+        // things still build right, please do!\n+        match mode {\n+            Mode::Std => metadata.push_str(\"std\"),\n+            Mode::Test => metadata.push_str(\"test\"),\n+            _ => {},\n+        }\n         cargo.env(\"__CARGO_DEFAULT_LIB_METADATA\", &metadata);\n \n         let stage;"}]}