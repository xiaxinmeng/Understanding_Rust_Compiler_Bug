{"sha": "6a3aae8aea2448432d4fd0f7c3a22778beaab831", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhM2FhZThhZWEyNDQ4NDMyZDRmZDBmN2MzYTIyNzc4YmVhYWI4MzE=", "commit": {"author": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2020-05-22T02:48:44Z"}, "committer": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2020-05-22T04:42:38Z"}, "message": "Add flag to open docs:  x.py doc --open\n\nTested with:\n\n       # opens doc/index.html\n    x.py doc --stage 0 --open\n    x.py doc --stage 0 --open src/doc\n\n       # opens doc/book/index.html\n    x.py doc --stage 0 --open src/doc/book\n\n       # opens doc/std/index.html\n    x.py doc --stage 0 --open src/libstd\n\n       # opens doc/proc_macro/index.html\n    x.py doc --stage 0 --open src/libproc_macro\n\n       # opens both\n    x.py doc --stage 0 --open src/libstd src/libproc_macro", "tree": {"sha": "c0024264e444ba7a883eb66b4a5c9d51cfb300fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c0024264e444ba7a883eb66b4a5c9d51cfb300fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a3aae8aea2448432d4fd0f7c3a22778beaab831", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERijF2Cz/ZdaBZKeK+boUO5X/bYIFAl7HWD4ACgkQ+boUO5X/\nbYICNw//RExVMhVbNwWOxokON5WmqS+wKCSh7kw0Fp1jo4EtQjhaUlC+1n6sFmSf\n/XqevJWk9xEa6l2PysbC0AR0UDZprj0mbQKEpYJvhVD5AeQ8wKNGChisjnQid7Ow\nzLIBikRLPpWVMrzEBcaHvLYek4fQuKYezqBmMD6wCF2mIi31UJBD7peHZ0dMni7E\nPiHZ1iq5gmEt1RIf6kpyBLlDCssmw7F5O95/X6kxy0JayrKaYzddYu6HTLmHVXmF\nudc7gxG0ksOT6es04w0+YpnnT4POkulVBYpKM6RICbETkZS3zkoM7H5J7kRLkFIF\nE2QdWeQrQ/Yw962Ss/PR1ruH9MFhLWDMA69bq3PgHoebzil1tiF7zYckgzxQ5Dqc\nZpZAzFbiJmfN4penKiN28QZ9TkxnOb9/KTVe2mUotkJ0jH4y+HutApW95sgY942R\n2f4+NrpCEbIqSSLySfRU12L/FJixJrdM6q9ZPEvOtl8wW4Y1LIcgZ/S3xAjGOKSy\nxoC+X3CoZEKqQFuKB6dyNXEew6qyRp5+FaW5aHKAww52SohLUCzbzkPOcqb5WUqa\nmk17gcHbaBd7Ow2q/ujmRXREgU70QEcA9quk9Slo32/xXKufV5r56uIgj/DLB2G2\nLc6knJ/HVCCfGa4gyNs4Zx8UgWbhHzp/27a+UKcVoVNvQBbCupw=\n=WPYo\n-----END PGP SIGNATURE-----", "payload": "tree c0024264e444ba7a883eb66b4a5c9d51cfb300fa\nparent 9310e3bd4f425f84fc27878ebf2bda1f30935a63\nauthor David Tolnay <dtolnay@gmail.com> 1590115724 -0700\ncommitter David Tolnay <dtolnay@gmail.com> 1590122558 -0700\n\nAdd flag to open docs:  x.py doc --open\n\nTested with:\n\n       # opens doc/index.html\n    x.py doc --stage 0 --open\n    x.py doc --stage 0 --open src/doc\n\n       # opens doc/book/index.html\n    x.py doc --stage 0 --open src/doc/book\n\n       # opens doc/std/index.html\n    x.py doc --stage 0 --open src/libstd\n\n       # opens doc/proc_macro/index.html\n    x.py doc --stage 0 --open src/libproc_macro\n\n       # opens both\n    x.py doc --stage 0 --open src/libstd src/libproc_macro\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a3aae8aea2448432d4fd0f7c3a22778beaab831", "html_url": "https://github.com/rust-lang/rust/commit/6a3aae8aea2448432d4fd0f7c3a22778beaab831", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a3aae8aea2448432d4fd0f7c3a22778beaab831/comments", "author": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9310e3bd4f425f84fc27878ebf2bda1f30935a63", "url": "https://api.github.com/repos/rust-lang/rust/commits/9310e3bd4f425f84fc27878ebf2bda1f30935a63", "html_url": "https://github.com/rust-lang/rust/commit/9310e3bd4f425f84fc27878ebf2bda1f30935a63"}], "stats": {"total": 77, "additions": 74, "deletions": 3}, "files": [{"sha": "b0b9e2c27df9c68981ea7732374a86bde77e6630", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6a3aae8aea2448432d4fd0f7c3a22778beaab831/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/6a3aae8aea2448432d4fd0f7c3a22778beaab831/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=6a3aae8aea2448432d4fd0f7c3a22778beaab831", "patch": "@@ -213,6 +213,7 @@ dependencies = [\n  \"lazy_static 1.4.0\",\n  \"libc\",\n  \"num_cpus\",\n+ \"opener\",\n  \"pretty_assertions\",\n  \"serde\",\n  \"serde_json\","}, {"sha": "c4918d7f2e7146795f0d5fdf5ea485dc2d6386bc", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=6a3aae8aea2448432d4fd0f7c3a22778beaab831", "patch": "@@ -48,6 +48,7 @@ toml = \"0.5\"\n lazy_static = \"1.3.0\"\n time = \"0.1\"\n ignore = \"0.4.10\"\n+opener = \"0.4\"\n \n [target.'cfg(windows)'.dependencies.winapi]\n version = \"0.3\""}, {"sha": "5489b1bc66b64f6984fcfddecb845c73ab3c7e71", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=6a3aae8aea2448432d4fd0f7c3a22778beaab831", "patch": "@@ -503,7 +503,7 @@ impl<'a> Builder<'a> {\n             Subcommand::Check { ref paths } => (Kind::Check, &paths[..]),\n             Subcommand::Clippy { ref paths } => (Kind::Clippy, &paths[..]),\n             Subcommand::Fix { ref paths } => (Kind::Fix, &paths[..]),\n-            Subcommand::Doc { ref paths } => (Kind::Doc, &paths[..]),\n+            Subcommand::Doc { ref paths, .. } => (Kind::Doc, &paths[..]),\n             Subcommand::Test { ref paths, .. } => (Kind::Test, &paths[..]),\n             Subcommand::Bench { ref paths, .. } => (Kind::Bench, &paths[..]),\n             Subcommand::Dist { ref paths } => (Kind::Dist, &paths[..]),"}, {"sha": "be5e3bfee303f520701ed6c3f06bbb4dd3e82854", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 58, "deletions": 1, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=6a3aae8aea2448432d4fd0f7c3a22778beaab831", "patch": "@@ -70,6 +70,35 @@ book!(\n     RustdocBook, \"src/doc/rustdoc\", \"rustdoc\";\n );\n \n+fn open(builder: &Builder<'_>, path: impl AsRef<Path>) {\n+    if builder.config.dry_run || !builder.config.cmd.open() {\n+        return;\n+    }\n+\n+    let path = path.as_ref();\n+    builder.info(&format!(\"Opening doc {}\", path.to_string_lossy()));\n+\n+    // ignore error\n+    let _ = opener::open(path);\n+}\n+\n+// \"src/libstd\" -> [\"src\", \"libstd\"]\n+//\n+// Used for deciding whether a particular step is one requested by the user on\n+// the `x.py doc` command line, which determines whether `--open` will open that\n+// page.\n+fn components_simplified(path: &PathBuf) -> Vec<&str> {\n+    path.iter().map(|component| component.to_str().unwrap_or(\"???\")).collect()\n+}\n+\n+fn is_explicit_request(builder: &Builder<'_>, path: &str) -> bool {\n+    builder\n+        .paths\n+        .iter()\n+        .map(components_simplified)\n+        .any(|requested| requested.iter().copied().eq(path.split(\"/\")))\n+}\n+\n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n pub struct UnstableBook {\n     target: Interned<String>,\n@@ -200,6 +229,12 @@ impl Step for TheBook {\n \n             invoke_rustdoc(builder, compiler, target, path);\n         }\n+\n+        if is_explicit_request(builder, \"src/doc/book\") {\n+            let out = builder.doc_out(target);\n+            let index = out.join(\"book\").join(\"index.html\");\n+            open(builder, &index);\n+        }\n     }\n }\n \n@@ -338,6 +373,13 @@ impl Step for Standalone {\n             }\n             builder.run(&mut cmd);\n         }\n+\n+        // We open doc/index.html as the default if invoked as `x.py doc --open`\n+        // with no particular explicit doc requested (e.g. src/libcore).\n+        if builder.paths.is_empty() || is_explicit_request(builder, \"src/doc\") {\n+            let index = out.join(\"index.html\");\n+            open(builder, &index);\n+        }\n     }\n }\n \n@@ -418,10 +460,25 @@ impl Step for Std {\n \n             builder.run(&mut cargo.into());\n         };\n-        for krate in &[\"alloc\", \"core\", \"std\", \"proc_macro\", \"test\"] {\n+        let krates = [\"alloc\", \"core\", \"std\", \"proc_macro\", \"test\"];\n+        for krate in &krates {\n             run_cargo_rustdoc_for(krate);\n         }\n         builder.cp_r(&my_out, &out);\n+\n+        // Look for src/libstd, src/libcore etc in the `x.py doc` arguments and\n+        // open the corresponding rendered docs.\n+        for path in builder.paths.iter().map(components_simplified) {\n+            if path.get(0) == Some(&\"src\")\n+                && path.get(1).map_or(false, |dir| dir.starts_with(\"lib\"))\n+            {\n+                let requested_crate = &path[1][3..];\n+                if krates.contains(&requested_crate) {\n+                    let index = out.join(requested_crate).join(\"index.html\");\n+                    open(builder, &index);\n+                }\n+            }\n+        }\n     }\n }\n "}, {"sha": "cfaa43f397095c30a4cf4046f28ca2ac8f2d62d7", "filename": "src/bootstrap/flags.rs", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a3aae8aea2448432d4fd0f7c3a22778beaab831/src%2Fbootstrap%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fflags.rs?ref=6a3aae8aea2448432d4fd0f7c3a22778beaab831", "patch": "@@ -61,6 +61,7 @@ pub enum Subcommand {\n     },\n     Doc {\n         paths: Vec<PathBuf>,\n+        open: bool,\n     },\n     Test {\n         paths: Vec<PathBuf>,\n@@ -248,6 +249,9 @@ To learn more about a subcommand, run `./x.py <subcommand> -h`\",\n             \"bench\" => {\n                 opts.optmulti(\"\", \"test-args\", \"extra arguments\", \"ARGS\");\n             }\n+            \"doc\" => {\n+                opts.optflag(\"\", \"open\", \"open the docs in a browser\");\n+            }\n             \"clean\" => {\n                 opts.optflag(\"\", \"all\", \"clean all build artifacts\");\n             }\n@@ -404,6 +408,7 @@ Arguments:\n         ./x.py doc src/doc/book\n         ./x.py doc src/doc/nomicon\n         ./x.py doc src/doc/book src/libstd\n+        ./x.py doc src/libstd --open\n \n     If no arguments are passed then everything is documented:\n \n@@ -479,7 +484,7 @@ Arguments:\n                 },\n             },\n             \"bench\" => Subcommand::Bench { paths, test_args: matches.opt_strs(\"test-args\") },\n-            \"doc\" => Subcommand::Doc { paths },\n+            \"doc\" => Subcommand::Doc { paths, open: matches.opt_present(\"open\") },\n             \"clean\" => {\n                 if !paths.is_empty() {\n                     println!(\"\\nclean does not take a path argument\\n\");\n@@ -613,6 +618,13 @@ impl Subcommand {\n             _ => None,\n         }\n     }\n+\n+    pub fn open(&self) -> bool {\n+        match *self {\n+            Subcommand::Doc { open, .. } => open,\n+            _ => false,\n+        }\n+    }\n }\n \n fn split(s: &[String]) -> Vec<String> {"}]}