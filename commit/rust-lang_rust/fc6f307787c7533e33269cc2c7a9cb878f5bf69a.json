{"sha": "fc6f307787c7533e33269cc2c7a9cb878f5bf69a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjNmYzMDc3ODdjNzUzM2UzMzI2OWNjMmM3YTljYjg3OGY1YmY2OWE=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-09-22T21:48:13Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-09-22T22:27:35Z"}, "message": "Fix linear for loops on strings to not hit trailing null.", "tree": {"sha": "f209c44e5878d46ad1d8e60edd51eb9d517c8fd5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f209c44e5878d46ad1d8e60edd51eb9d517c8fd5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc6f307787c7533e33269cc2c7a9cb878f5bf69a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc6f307787c7533e33269cc2c7a9cb878f5bf69a", "html_url": "https://github.com/rust-lang/rust/commit/fc6f307787c7533e33269cc2c7a9cb878f5bf69a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc6f307787c7533e33269cc2c7a9cb878f5bf69a/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "913882de7f36e12e5b09b52b5c6b225defaf6ef0", "url": "https://api.github.com/repos/rust-lang/rust/commits/913882de7f36e12e5b09b52b5c6b225defaf6ef0", "html_url": "https://github.com/rust-lang/rust/commit/913882de7f36e12e5b09b52b5c6b225defaf6ef0"}], "stats": {"total": 20, "additions": 13, "deletions": 7}, "files": [{"sha": "eb02d8e0b2206987f5387f806dd28d3ac26b9819", "filename": "src/boot/me/trans.ml", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fc6f307787c7533e33269cc2c7a9cb878f5bf69a/src%2Fboot%2Fme%2Ftrans.ml", "raw_url": "https://github.com/rust-lang/rust/raw/fc6f307787c7533e33269cc2c7a9cb878f5bf69a/src%2Fboot%2Fme%2Ftrans.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Ftrans.ml?ref=fc6f307787c7533e33269cc2c7a9cb878f5bf69a", "patch": "@@ -2861,6 +2861,7 @@ let trans_visitor\n       (dst_cell:Il.cell)\n       (src_cell:Il.cell)\n       (unit_ty:Ast.ty)\n+      (trailing_null:bool)\n       (f:Il.cell -> Il.cell -> Ast.ty -> unit)\n       : unit =\n \n@@ -2886,6 +2887,10 @@ let trans_visitor\n             lea lim (fst (need_mem_cell data));\n             mov ptr (Il.Cell lim);\n             add_to lim (Il.Cell len);\n+\n+            if trailing_null\n+            then sub_from lim (imm 1L);\n+\n             let back_jmp_target = mark () in\n             let fwd_jmps =\n               trans_compare_simple Il.JAE (Il.Cell ptr) (Il.Cell lim)\n@@ -2935,10 +2940,13 @@ let trans_visitor\n       | Ast.TY_fn _\n       | Ast.TY_obj _ -> bug () \"Attempting to iterate over fn/pred/obj slots\"\n \n-      | Ast.TY_vec _\n+      | Ast.TY_vec _ ->\n+          let unit_ty = seq_unit_ty ty in\n+            iter_seq_parts ty_params dst_cell src_cell unit_ty false f\n+\n       | Ast.TY_str ->\n           let unit_ty = seq_unit_ty ty in\n-            iter_seq_parts ty_params dst_cell src_cell unit_ty f\n+            iter_seq_parts ty_params dst_cell src_cell unit_ty true f\n \n       | _ -> ()\n \n@@ -3171,7 +3179,7 @@ let trans_visitor\n       | Ast.TY_task -> trans_kill_task cell\n       | Ast.TY_str -> trans_free cell false\n       | Ast.TY_vec s ->\n-          iter_seq_parts ty_params cell cell s\n+          iter_seq_parts ty_params cell cell s false\n              (fun _ src ty -> drop_ty ty_params src ty);\n              trans_free cell is_gc\n \n@@ -4655,6 +4663,7 @@ let trans_visitor\n     let (seq_cell, seq_ty) = trans_lval seq in\n     let unit_ty = seq_unit_ty seq_ty in\n       iter_seq_parts ty_params seq_cell seq_cell unit_ty\n+        (simplified_ty seq_ty = Ast.TY_str)\n         begin\n           fun _ src_cell unit_ty ->\n             trans_init_slot_from_cell"}, {"sha": "2b517f78fe3de79a16ab62875ef29fbdc7e26a6a", "filename": "src/test/run-pass/linear-for-loop.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fc6f307787c7533e33269cc2c7a9cb878f5bf69a/src%2Ftest%2Frun-pass%2Flinear-for-loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc6f307787c7533e33269cc2c7a9cb878f5bf69a/src%2Ftest%2Frun-pass%2Flinear-for-loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flinear-for-loop.rs?ref=fc6f307787c7533e33269cc2c7a9cb878f5bf69a", "patch": "@@ -27,12 +27,9 @@ fn main() {\n       check (c == ('o' as u8));\n     }\n     // ...\n-    if (i == 12) {\n-      check (c == (0 as u8));\n-    }\n     i += 1;\n     log i;\n     log c;\n   }\n-  check(i == 12);\n+  check(i == 11);\n }"}]}