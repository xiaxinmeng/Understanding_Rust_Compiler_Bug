{"sha": "0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhZDViOWI5ZTA4ZTg0ZjgwYTRiYWNjZDExMjA5NTUzZjFlNjRiMmE=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-11-02T06:29:40Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-11-02T06:29:40Z"}, "message": "Merge #3388\n\n3388: RIIR update lints: Generate deprecated lints r=phansch a=phansch\n\nThe update script now also generates the 'register_removed' section in\n`clippy_lints/src/lib.rs`.\n\nAlso, instead of using `let mut store ...`, I added a new identifier\nline so that the replacement will continue to work in case `let mut\nstore ...` ever changes.\n\ncc #2882\n\nCo-authored-by: Philipp Hansch <dev@phansch.net>", "tree": {"sha": "1823351293db1e96b4b4be3fc53995c14c344ee2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1823351293db1e96b4b4be3fc53995c14c344ee2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "html_url": "https://github.com/rust-lang/rust/commit/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "5172271e70173122bde3018ba455dfa97850c7f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5172271e70173122bde3018ba455dfa97850c7f6", "html_url": "https://github.com/rust-lang/rust/commit/5172271e70173122bde3018ba455dfa97850c7f6"}, {"sha": "7e027217f113b2feafd39b0d19500aa030f320d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e027217f113b2feafd39b0d19500aa030f320d7", "html_url": "https://github.com/rust-lang/rust/commit/7e027217f113b2feafd39b0d19500aa030f320d7"}], "stats": {"total": 52, "additions": 48, "deletions": 4}, "files": [{"sha": "656a271aec991689180e62ba67f04f6321acdf7c", "filename": "clippy_dev/src/lib.rs", "status": "modified", "additions": 38, "deletions": 3, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/clippy_dev%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/clippy_dev%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Flib.rs?ref=0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "patch": "@@ -72,14 +72,34 @@ impl Lint {\n     }\n }\n \n+/// Generates the list of lint links at the bottom of the README\n pub fn gen_changelog_lint_list(lints: Vec<Lint>) -> Vec<String> {\n     let mut lint_list_sorted: Vec<Lint> = lints;\n     lint_list_sorted.sort_by_key(|l| l.name.clone());\n     lint_list_sorted\n         .iter()\n-        .filter(|l| !l.is_internal())\n-        .map(|l| {\n-            format!(\"[`{}`]: {}#{}\", l.name, DOCS_LINK.clone(), l.name)\n+        .filter_map(|l| {\n+            if l.is_internal() {\n+                None\n+            } else {\n+                Some(format!(\"[`{}`]: {}#{}\", l.name, DOCS_LINK.clone(), l.name))\n+            }\n+        }).collect()\n+}\n+\n+/// Generates the `register_removed` code in `./clippy_lints/src/lib.rs`.\n+pub fn gen_deprecated(lints: &[Lint]) -> Vec<String> {\n+    lints.iter()\n+        .filter_map(|l| {\n+            l.clone().deprecation.and_then(|depr_text| {\n+                Some(\n+                    format!(\n+                        \"    store.register_removed(\\n        \\\"{}\\\",\\n        \\\"{}\\\",\\n    );\",\n+                        l.name,\n+                        depr_text\n+                    )\n+                )\n+            })\n         })\n         .collect()\n }\n@@ -321,3 +341,18 @@ fn test_gen_changelog_lint_list() {\n     ];\n     assert_eq!(expected, gen_changelog_lint_list(lints));\n }\n+\n+#[test]\n+fn test_gen_deprecated() {\n+    let lints = vec![\n+        Lint::new(\"should_assert_eq\", \"group1\", \"abc\", Some(\"has been superseeded by should_assert_eq2\"), \"module_name\"),\n+        Lint::new(\"should_assert_eq2\", \"group2\", \"abc\", None, \"module_name\")\n+    ];\n+    let expected: Vec<String> = vec![\n+        r#\"    store.register_removed(\n+        \"should_assert_eq\",\n+        \"has been superseeded by should_assert_eq2\",\n+    );\"#.to_string()\n+    ];\n+    assert_eq!(expected, gen_deprecated(&lints));\n+}"}, {"sha": "887a4ab9328929322667145856dd88fedfdfea8b", "filename": "clippy_dev/src/main.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/clippy_dev%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/clippy_dev%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fmain.rs?ref=0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "patch": "@@ -82,4 +82,12 @@ fn update_lints() {\n         false,\n         || { gen_changelog_lint_list(lint_list.clone()) }\n     );\n+\n+    replace_region_in_file(\n+        \"../clippy_lints/src/lib.rs\",\n+        \"begin deprecated lints\",\n+        \"end deprecated lints\",\n+        false,\n+        || { gen_deprecated(&lint_list) }\n+    );\n }"}, {"sha": "86ecba38d590cd6d4ed6a487105b19e378422631", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "patch": "@@ -271,6 +271,7 @@ pub fn read_conf(reg: &rustc_plugin::Registry<'_>) -> Conf {\n #[rustfmt::skip]\n pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n     let mut store = reg.sess.lint_store.borrow_mut();\n+    // begin deprecated lints, do not remove this comment, it\u2019s used in `update_lints`\n     store.register_removed(\n         \"should_assert_eq\",\n         \"`assert!()` will be more flexible with RFC 2011\","}, {"sha": "221069d353cb3093063b1b0eefc60b46435475e4", "filename": "util/update_lints.py", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/util%2Fupdate_lints.py", "raw_url": "https://github.com/rust-lang/rust/raw/0ad5b9b9e08e84f80a4baccd11209553f1e64b2a/util%2Fupdate_lints.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/util%2Fupdate_lints.py?ref=0ad5b9b9e08e84f80a4baccd11209553f1e64b2a", "patch": "@@ -240,7 +240,7 @@ def main(print_only=False, check=False):\n \n     # same for \"deprecated\" lint collection\n     changed |= replace_region(\n-        'clippy_lints/src/lib.rs', r'let mut store', r'end deprecated lints',\n+        'clippy_lints/src/lib.rs', r'begin deprecated lints', r'end deprecated lints',\n         lambda: gen_deprecated(deprecated_lints),\n         replace_start=False,\n         write_back=not check)"}]}