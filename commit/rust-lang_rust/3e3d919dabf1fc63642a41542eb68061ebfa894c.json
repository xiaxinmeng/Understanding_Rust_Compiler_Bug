{"sha": "3e3d919dabf1fc63642a41542eb68061ebfa894c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNlM2Q5MTlkYWJmMWZjNjM2NDJhNDE1NDJlYjY4MDYxZWJmYTg5NGM=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2019-10-01T12:50:05Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2019-10-29T12:42:55Z"}, "message": "improve documentation of rustdoc doctest feature", "tree": {"sha": "5432e55278b8fb38004094d30a1abee65fe8afbb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5432e55278b8fb38004094d30a1abee65fe8afbb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3e3d919dabf1fc63642a41542eb68061ebfa894c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3e3d919dabf1fc63642a41542eb68061ebfa894c", "html_url": "https://github.com/rust-lang/rust/commit/3e3d919dabf1fc63642a41542eb68061ebfa894c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3e3d919dabf1fc63642a41542eb68061ebfa894c/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a212960a4b47bb0879c75bc32de984d7626d5921", "url": "https://api.github.com/repos/rust-lang/rust/commits/a212960a4b47bb0879c75bc32de984d7626d5921", "html_url": "https://github.com/rust-lang/rust/commit/a212960a4b47bb0879c75bc32de984d7626d5921"}], "stats": {"total": 29, "additions": 22, "deletions": 7}, "files": [{"sha": "45fbb4fbfc66b5c85e0ab12486cc96d29984be19", "filename": "src/doc/rustdoc/src/documentation-tests.md", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/3e3d919dabf1fc63642a41542eb68061ebfa894c/src%2Fdoc%2Frustdoc%2Fsrc%2Fdocumentation-tests.md", "raw_url": "https://github.com/rust-lang/rust/raw/3e3d919dabf1fc63642a41542eb68061ebfa894c/src%2Fdoc%2Frustdoc%2Fsrc%2Fdocumentation-tests.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fdocumentation-tests.md?ref=3e3d919dabf1fc63642a41542eb68061ebfa894c", "patch": "@@ -382,22 +382,22 @@ indented code blocks.\n \n ### Include items only when collecting doctests\n \n-Rustdoc's [documentation tests] can do some things that regular unit tests can't, so it can\n+Rustdoc's documentation tests can do some things that regular unit tests can't, so it can\n sometimes be useful to extend your doctests with samples that wouldn't otherwise need to be in\n documentation. To this end, Rustdoc allows you to have certain items only appear when it's\n collecting doctests, so you can utilize doctest functionality without forcing the test to appear in\n docs, or to find an arbitrary private item to include it on.\n \n When compiling a crate for use in doctests (with `--test` option), rustdoc will set `cfg(doctest)`.\n-Note that they will still link against only the public items of your crate; if you need to\n-test private items, either make items conditionally public via `cfg(doctest)` or write a unit test.\n+Note that they will still link against only the public items of your crate; if you need to test\n+private items, you need to write a unit test.\n \n In this example, we're adding doctests that we know won't compile, to verify that our struct can\n only take in valid data:\n \n ```rust\n /// We have a struct here. Remember it doesn't accept negative numbers!\n-pub struct MyStruct(usize);\n+pub struct MyStruct(pub usize);\n \n /// ```compile_fail\n /// let x = my_crate::MyStruct(-5);\n@@ -406,7 +406,22 @@ pub struct MyStruct(usize);\n pub struct MyStructOnlyTakesUsize;\n ```\n \n-Please note that the struct `MyStructOnlyTakesUsize` will not appear in documentation or in the\n-public API considering it only exists when running rustdoc with the `--test` option.\n+Note that the struct `MyStructOnlyTakesUsize` here isn't actually part of your public crate\n+API. The use of `#[cfg(doctest)]` makes sure that this struct only exists while rustdoc is\n+collecting doctests. This means that its doctest is executed when `--test` is passed to rustdoc,\n+but is hidden from the public documentation.\n \n-[documentation tests]: documentation-tests.html\n+Another possible use of `cfg(doctest)` is to test doctests that are included in your README file\n+without including it in your main documentation. For example, you could write this into your\n+`lib.rs` to test your README as part of your doctests:\n+\n+```rust,no_run (includes-extra-file)\n+#![feature(extern_doc)]\n+\n+#[doc(include=\"../README.md\")]\n+#[cfg(doctest)]\n+pub struct ReadmeDoctests;\n+```\n+\n+This will include your README as documentation on the hidden struct `ReadmeDoctests`, which will\n+then be tested alongside the rest of your doctests."}]}