{"sha": "177997e3833d48973e7856e14f2935340b1862f1", "node_id": "C_kwDOAAsO6NoAKDE3Nzk5N2UzODMzZDQ4OTczZTc4NTZlMTRmMjkzNTM0MGIxODYyZjE", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-03-29T23:36:27Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-03-30T15:11:42Z"}, "message": "Closures always implement FnOnce in new solver", "tree": {"sha": "bbe49586e7b7faa5f91a1fabafc62f525702c064", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbe49586e7b7faa5f91a1fabafc62f525702c064"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/177997e3833d48973e7856e14f2935340b1862f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/177997e3833d48973e7856e14f2935340b1862f1", "html_url": "https://github.com/rust-lang/rust/commit/177997e3833d48973e7856e14f2935340b1862f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/177997e3833d48973e7856e14f2935340b1862f1/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a7ca936e61d04399198911ee2b07ac110bf17b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a7ca936e61d04399198911ee2b07ac110bf17b0", "html_url": "https://github.com/rust-lang/rust/commit/8a7ca936e61d04399198911ee2b07ac110bf17b0"}], "stats": {"total": 28, "additions": 25, "deletions": 3}, "files": [{"sha": "fcb965dd725af297d4e5565d7017d733214f666f", "filename": "compiler/rustc_trait_selection/src/solve/trait_goals/structural_traits.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/177997e3833d48973e7856e14f2935340b1862f1/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals%2Fstructural_traits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/177997e3833d48973e7856e14f2935340b1862f1/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals%2Fstructural_traits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals%2Fstructural_traits.rs?ref=177997e3833d48973e7856e14f2935340b1862f1", "patch": "@@ -214,9 +214,20 @@ pub(crate) fn extract_tupled_inputs_and_output_from_callable<'tcx>(\n         ty::Closure(_, substs) => {\n             let closure_substs = substs.as_closure();\n             match closure_substs.kind_ty().to_opt_closure_kind() {\n-                Some(closure_kind) if closure_kind.extends(goal_kind) => {}\n-                None => return Ok(None),\n-                _ => return Err(NoSolution),\n+                // If the closure's kind doesn't extend the goal kind,\n+                // then the closure doesn't implement the trait.\n+                Some(closure_kind) => {\n+                    if !closure_kind.extends(goal_kind) {\n+                        return Err(NoSolution);\n+                    }\n+                }\n+                // Closure kind is not yet determined, so we return ambiguity unless\n+                // the expected kind is `FnOnce` as that is always implemented.\n+                None => {\n+                    if goal_kind != ty::ClosureKind::FnOnce {\n+                        return Ok(None);\n+                    }\n+                }\n             }\n             Ok(Some(closure_substs.sig().map_bound(|sig| (sig.inputs()[0], sig.output()))))\n         }"}, {"sha": "d2ad0cc0316e3d4925f6f03eca422bd043567de1", "filename": "tests/ui/traits/new-solver/closure-inference-guidance.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/177997e3833d48973e7856e14f2935340b1862f1/tests%2Fui%2Ftraits%2Fnew-solver%2Fclosure-inference-guidance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/177997e3833d48973e7856e14f2935340b1862f1/tests%2Fui%2Ftraits%2Fnew-solver%2Fclosure-inference-guidance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnew-solver%2Fclosure-inference-guidance.rs?ref=177997e3833d48973e7856e14f2935340b1862f1", "patch": "@@ -0,0 +1,11 @@\n+// compile-flags: -Ztrait-solver=next\n+// check-pass\n+\n+fn foo(i: isize) -> isize { i + 1 }\n+\n+fn apply<A, F>(f: F, v: A) -> A where F: FnOnce(A) -> A { f(v) }\n+\n+pub fn main() {\n+    let f = |i| foo(i);\n+    assert_eq!(apply(f, 2), 3);\n+}"}]}