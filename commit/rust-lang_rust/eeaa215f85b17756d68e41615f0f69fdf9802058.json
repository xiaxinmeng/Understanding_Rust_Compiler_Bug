{"sha": "eeaa215f85b17756d68e41615f0f69fdf9802058", "node_id": "C_kwDOAAsO6NoAKGVlYWEyMTVmODViMTc3NTZkNjhlNDE2MTVmMGY2OWZkZjk4MDIwNTg", "commit": {"author": {"name": "jackh726", "email": "jack.huey@umassmed.edu", "date": "2021-11-26T02:16:27Z"}, "committer": {"name": "jackh726", "email": "jack.huey@umassmed.edu", "date": "2021-11-26T02:16:27Z"}, "message": "Don't treat unnormalized function arguments as well-formed", "tree": {"sha": "7376d2ac0f1dc4b8d6be4255dc107d357511ac2f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7376d2ac0f1dc4b8d6be4255dc107d357511ac2f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eeaa215f85b17756d68e41615f0f69fdf9802058", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eeaa215f85b17756d68e41615f0f69fdf9802058", "html_url": "https://github.com/rust-lang/rust/commit/eeaa215f85b17756d68e41615f0f69fdf9802058", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eeaa215f85b17756d68e41615f0f69fdf9802058/comments", "author": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eee8b9c7bafade55981d155dae71657f1cc55a22", "url": "https://api.github.com/repos/rust-lang/rust/commits/eee8b9c7bafade55981d155dae71657f1cc55a22", "html_url": "https://github.com/rust-lang/rust/commit/eee8b9c7bafade55981d155dae71657f1cc55a22"}], "stats": {"total": 84, "additions": 38, "deletions": 46}, "files": [{"sha": "8d97c3cbb0b0ebd406fa9301d91827a36c08617d", "filename": "compiler/rustc_borrowck/src/type_check/free_region_relations.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Ffree_region_relations.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Ffree_region_relations.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Ffree_region_relations.rs?ref=eeaa215f85b17756d68e41615f0f69fdf9802058", "patch": "@@ -256,7 +256,6 @@ impl UniversalRegionRelationsBuilder<'cx, 'tcx> {\n                 debug!(\"build: input_or_output={:?}\", ty);\n                 // We add implied bounds from both the unnormalized and normalized ty\n                 // See issue #87748\n-                let constraints_implied_1 = self.add_implied_bounds(ty);\n                 let TypeOpOutput { output: norm_ty, constraints: constraints1, .. } = self\n                     .param_env\n                     .and(type_op::normalize::Normalize::new(ty))\n@@ -284,10 +283,9 @@ impl UniversalRegionRelationsBuilder<'cx, 'tcx> {\n                 // }\n                 // ```\n                 // Both &Self::Bar and &() are WF\n-                let constraints_implied_2 =\n-                    if ty != norm_ty { self.add_implied_bounds(norm_ty) } else { None };\n+                let constraints_implied = self.add_implied_bounds(norm_ty);\n                 normalized_inputs_and_output.push(norm_ty);\n-                constraints1.into_iter().chain(constraints_implied_1).chain(constraints_implied_2)\n+                constraints1.into_iter().chain(constraints_implied)\n             })\n             .collect();\n "}, {"sha": "e7e36f11e750de7bdeef33ca0ae117b500f4b01d", "filename": "compiler/rustc_typeck/src/check/compare_method.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs?ref=eeaa215f85b17756d68e41615f0f69fdf9802058", "patch": "@@ -266,14 +266,9 @@ fn compare_predicate_entailment<'tcx>(\n         // First liberate late bound regions and subst placeholders\n         let trait_sig = tcx.liberate_late_bound_regions(impl_m.def_id, tcx.fn_sig(trait_m.def_id));\n         let trait_sig = trait_sig.subst(tcx, trait_to_placeholder_substs);\n-        // Next, add all inputs and output as well-formed tys. Importantly,\n-        // we have to do this before normalization, since the normalized ty may\n-        // not contain the input parameters. See issue #87748.\n-        wf_tys.extend(trait_sig.inputs_and_output.iter());\n         let trait_sig =\n             inh.normalize_associated_types_in(impl_m_span, impl_m_hir_id, param_env, trait_sig);\n-        // Also add the resulting inputs and output as well-formed.\n-        // This probably isn't strictly necessary.\n+        // Add the resulting inputs and output as well-formed.\n         wf_tys.extend(trait_sig.inputs_and_output.iter());\n         let trait_fty = tcx.mk_fn_ptr(ty::Binder::dummy(trait_sig));\n "}, {"sha": "a037bb66478251582c1d09ce14f6390d8f219337", "filename": "compiler/rustc_typeck/src/check/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmod.rs?ref=eeaa215f85b17756d68e41615f0f69fdf9802058", "patch": "@@ -391,7 +391,6 @@ fn typeck_with_fallback<'tcx>(\n             let mut wf_tys = FxHashSet::default();\n             // Compute the fty from point of view of inside the fn.\n             let fn_sig = tcx.liberate_late_bound_regions(def_id.to_def_id(), fn_sig);\n-            wf_tys.extend(fn_sig.inputs_and_output.iter());\n             let fn_sig = inh.normalize_associated_types_in(\n                 body.value.span,\n                 body_id.hir_id,"}, {"sha": "1c48d91f91a9fc93a29178f69d88e65857ccc2de", "filename": "compiler/rustc_typeck/src/check/wfcheck.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eeaa215f85b17756d68e41615f0f69fdf9802058/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs?ref=eeaa215f85b17756d68e41615f0f69fdf9802058", "patch": "@@ -1322,11 +1322,6 @@ fn check_fn_or_method<'fcx, 'tcx>(\n ) {\n     let sig = fcx.tcx.liberate_late_bound_regions(def_id, sig);\n \n-    // Unnormalized types in signature are WF too\n-    implied_bounds.extend(sig.inputs());\n-    // FIXME(#27579) return types should not be implied bounds\n-    implied_bounds.insert(sig.output());\n-\n     // Normalize the input and output types one at a time, using a different\n     // `WellFormedLoc` for each. We cannot call `normalize_associated_types`\n     // on the entire `FnSig`, since this would use the same `WellFormedLoc`"}, {"sha": "2e5ac7d7398eb41e7b36194919ab1c151818ae1d", "filename": "src/test/ui/fn/implied-bounds-unnorm-associated-type.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/eeaa215f85b17756d68e41615f0f69fdf9802058/src%2Ftest%2Fui%2Ffn%2Fimplied-bounds-unnorm-associated-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eeaa215f85b17756d68e41615f0f69fdf9802058/src%2Ftest%2Fui%2Ffn%2Fimplied-bounds-unnorm-associated-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffn%2Fimplied-bounds-unnorm-associated-type.rs?ref=eeaa215f85b17756d68e41615f0f69fdf9802058", "patch": "@@ -0,0 +1,22 @@\n+// check-fail\n+// See issue #91068. Types in the substs of an associated type can't be implied\n+// to be WF, since they don't actually have to be constructed.\n+\n+trait Trait {\n+    type Type;\n+}\n+\n+impl<T> Trait for T {\n+    type Type = ();\n+}\n+\n+fn f<'a, 'b>(s: &'b str, _: <&'a &'b () as Trait>::Type) -> &'a str {\n+    s //~ ERROR lifetime mismatch [E0623]\n+}\n+\n+fn main() {\n+    let x = String::from(\"Hello World!\");\n+    let y = f(&x, ());\n+    drop(x);\n+    println!(\"{}\", y);\n+}"}, {"sha": "93ab5dceee9477fd5671029b68ea3e58ccde423c", "filename": "src/test/ui/fn/implied-bounds-unnorm-associated-type.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/eeaa215f85b17756d68e41615f0f69fdf9802058/src%2Ftest%2Fui%2Ffn%2Fimplied-bounds-unnorm-associated-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/eeaa215f85b17756d68e41615f0f69fdf9802058/src%2Ftest%2Fui%2Ffn%2Fimplied-bounds-unnorm-associated-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffn%2Fimplied-bounds-unnorm-associated-type.stderr?ref=eeaa215f85b17756d68e41615f0f69fdf9802058", "patch": "@@ -0,0 +1,13 @@\n+error[E0623]: lifetime mismatch\n+  --> $DIR/implied-bounds-unnorm-associated-type.rs:14:5\n+   |\n+LL | fn f<'a, 'b>(s: &'b str, _: <&'a &'b () as Trait>::Type) -> &'a str {\n+   |                 -------      ----------\n+   |                 |\n+   |                 these two types are declared with different lifetimes...\n+LL |     s\n+   |     ^ ...but data from `s` flows here\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0623`."}, {"sha": "93c3b3937cb814f060d4cc0a4dc0698f47b8cf1e", "filename": "src/test/ui/generic-associated-types/issue-87748.rs", "status": "removed", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/eee8b9c7bafade55981d155dae71657f1cc55a22/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-87748.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eee8b9c7bafade55981d155dae71657f1cc55a22/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-87748.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-87748.rs?ref=eee8b9c7bafade55981d155dae71657f1cc55a22", "patch": "@@ -1,30 +0,0 @@\n-// Checks that we properly add implied bounds from unnormalized projections in\n-// inputs when typechecking functions.\n-\n-// check-pass\n-\n-#![feature(generic_associated_types)]\n-\n-trait MyTrait {\n-    type Assoc<'a, 'b> where 'b: 'a;\n-    fn do_sth(arg: Self::Assoc<'_, '_>);\n-}\n-\n-struct A;\n-struct B;\n-struct C;\n-\n-impl MyTrait for A {\n-    type Assoc<'a, 'b> where 'b: 'a = u32;\n-    fn do_sth(_: u32) {}\n-}\n-impl MyTrait for B {\n-    type Assoc<'a, 'b> where 'b: 'a = u32;\n-    fn do_sth(_: Self::Assoc<'_, '_>) {}\n-}\n-impl MyTrait for C {\n-    type Assoc<'a, 'b> where 'b: 'a = u32;\n-    fn do_sth(_: Self::Assoc<'static, 'static>) {}\n-}\n-\n-fn main () {}"}]}