{"sha": "55769a5ca98452967deb66dc1043a45fe0b2ddba", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1NzY5YTVjYTk4NDUyOTY3ZGViNjZkYzEwNDNhNDVmZTBiMmRkYmE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2021-06-03T15:58:12Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2021-06-03T16:55:45Z"}, "message": "wasm: Make simd types passed via indirection again\n\nThis commit updates wasm target specs to use `simd_types_indirect: true`\nagain. Long ago this was added since wasm simd types were always\ntranslated to `v128` under-the-hood in LLVM, meaning that it didn't\nmatter whether that target feature was enabled or not. Now, however,\n`v128` is conditionally used in codegen depending on target features\nenabled, meaning that it's possible to get linker errors about different\nsignatures in code that correctly uses simd types. The fix is the same\nas for all other platforms, which is to pass the type indirectly.", "tree": {"sha": "5c1174ab1bc802242b5fdb1b63af18d7531c70c1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5c1174ab1bc802242b5fdb1b63af18d7531c70c1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55769a5ca98452967deb66dc1043a45fe0b2ddba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55769a5ca98452967deb66dc1043a45fe0b2ddba", "html_url": "https://github.com/rust-lang/rust/commit/55769a5ca98452967deb66dc1043a45fe0b2ddba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55769a5ca98452967deb66dc1043a45fe0b2ddba/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "835150e70288535bc57bb624792229b9dc94991d", "url": "https://api.github.com/repos/rust-lang/rust/commits/835150e70288535bc57bb624792229b9dc94991d", "html_url": "https://github.com/rust-lang/rust/commit/835150e70288535bc57bb624792229b9dc94991d"}], "stats": {"total": 39, "additions": 33, "deletions": 6}, "files": [{"sha": "6c8977351949de691b2cdc16e7c51ce3355c41a0", "filename": "compiler/rustc_target/src/spec/wasm_base.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/55769a5ca98452967deb66dc1043a45fe0b2ddba/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55769a5ca98452967deb66dc1043a45fe0b2ddba/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs?ref=55769a5ca98452967deb66dc1043a45fe0b2ddba", "patch": "@@ -103,12 +103,6 @@ pub fn options() -> TargetOptions {\n         linker: Some(\"rust-lld\".to_owned()),\n         lld_flavor: LldFlavor::Wasm,\n \n-        // No need for indirection here, simd types can always be passed by\n-        // value as the whole module either has simd or not, which is different\n-        // from x86 (for example) where programs can have functions that don't\n-        // enable simd features.\n-        simd_types_indirect: false,\n-\n         pre_link_args,\n \n         crt_objects_fallback: Some(CrtObjectsFallback::Wasm),"}, {"sha": "deac593df43f1e1d3ff84056e1ac644feb82a5e8", "filename": "src/test/ui/simd/wasm-simd-indirect.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/55769a5ca98452967deb66dc1043a45fe0b2ddba/src%2Ftest%2Fui%2Fsimd%2Fwasm-simd-indirect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55769a5ca98452967deb66dc1043a45fe0b2ddba/src%2Ftest%2Fui%2Fsimd%2Fwasm-simd-indirect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fwasm-simd-indirect.rs?ref=55769a5ca98452967deb66dc1043a45fe0b2ddba", "patch": "@@ -0,0 +1,33 @@\n+// build-pass\n+\n+#![cfg_attr(target_arch = \"wasm32\", feature(wasm_simd, wasm_target_feature))]\n+\n+#[cfg(target_arch = \"wasm32\")]\n+fn main() {\n+    unsafe {\n+        a::api_with_simd_feature();\n+    }\n+}\n+\n+#[cfg(target_arch = \"wasm32\")]\n+mod a {\n+    use std::arch::wasm32::*;\n+\n+    #[target_feature(enable = \"simd128\")]\n+    pub unsafe fn api_with_simd_feature() {\n+        crate::b::api_takes_v128(u64x2(0, 1));\n+    }\n+}\n+\n+#[cfg(target_arch = \"wasm32\")]\n+mod b {\n+    use std::arch::wasm32::*;\n+\n+    #[inline(never)]\n+    pub fn api_takes_v128(a: v128) -> v128 {\n+        a\n+    }\n+}\n+\n+#[cfg(not(target_arch = \"wasm32\"))]\n+fn main() {}"}]}