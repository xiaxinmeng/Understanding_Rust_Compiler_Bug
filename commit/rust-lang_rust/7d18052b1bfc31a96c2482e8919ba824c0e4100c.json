{"sha": "7d18052b1bfc31a96c2482e8919ba824c0e4100c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdkMTgwNTJiMWJmYzMxYTk2YzI0ODJlODkxOWJhODI0YzBlNDEwMGM=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-08-31T20:18:10Z"}, "committer": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-08-31T20:18:10Z"}, "message": "Add test for closure migration where body is a block fragment.", "tree": {"sha": "91477405abf0c86aa006e35b63f23a042c118ff9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/91477405abf0c86aa006e35b63f23a042c118ff9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7d18052b1bfc31a96c2482e8919ba824c0e4100c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7d18052b1bfc31a96c2482e8919ba824c0e4100c", "html_url": "https://github.com/rust-lang/rust/commit/7d18052b1bfc31a96c2482e8919ba824c0e4100c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7d18052b1bfc31a96c2482e8919ba824c0e4100c/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7189c854139b84d4356285c13d19b04b64e32272", "url": "https://api.github.com/repos/rust-lang/rust/commits/7189c854139b84d4356285c13d19b04b64e32272", "html_url": "https://github.com/rust-lang/rust/commit/7189c854139b84d4356285c13d19b04b64e32272"}], "stats": {"total": 86, "additions": 86, "deletions": 0}, "files": [{"sha": "f91454aa2111e044ee11a99f84582a8b02e267de", "filename": "src/test/ui/closures/2229_closure_analysis/migrations/closure-body-macro-fragment.fixed", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/7d18052b1bfc31a96c2482e8919ba824c0e4100c/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/7d18052b1bfc31a96c2482e8919ba824c0e4100c/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.fixed?ref=7d18052b1bfc31a96c2482e8919ba824c0e4100c", "patch": "@@ -0,0 +1,25 @@\n+// run-rustfix\n+// edition:2018\n+// check-pass\n+#![warn(rust_2021_compatibility)]\n+\n+macro_rules! m {\n+    (@ $body:expr) => {{\n+        let f = || $body;\n+        //~^ WARNING: drop order\n+        f();\n+    }};\n+    ($body:block) => {{\n+        m!(@ $body);\n+    }};\n+}\n+\n+fn main() {\n+    let a = (1.to_string(), 2.to_string());\n+    m!({\n+        let _ = &a;\n+        //~^ HELP: add a dummy\n+        let x = a.0;\n+        println!(\"{}\", x);\n+    });\n+}"}, {"sha": "5a1026d04331912d4d998eea56b7bacfd7da06a9", "filename": "src/test/ui/closures/2229_closure_analysis/migrations/closure-body-macro-fragment.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/7d18052b1bfc31a96c2482e8919ba824c0e4100c/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d18052b1bfc31a96c2482e8919ba824c0e4100c/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.rs?ref=7d18052b1bfc31a96c2482e8919ba824c0e4100c", "patch": "@@ -0,0 +1,24 @@\n+// run-rustfix\n+// edition:2018\n+// check-pass\n+#![warn(rust_2021_compatibility)]\n+\n+macro_rules! m {\n+    (@ $body:expr) => {{\n+        let f = || $body;\n+        //~^ WARNING: drop order\n+        f();\n+    }};\n+    ($body:block) => {{\n+        m!(@ $body);\n+    }};\n+}\n+\n+fn main() {\n+    let a = (1.to_string(), 2.to_string());\n+    m!({\n+        //~^ HELP: add a dummy\n+        let x = a.0;\n+        println!(\"{}\", x);\n+    });\n+}"}, {"sha": "e6e5598f6d2a1beee09d78c72271ab1c511f074b", "filename": "src/test/ui/closures/2229_closure_analysis/migrations/closure-body-macro-fragment.stderr", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/7d18052b1bfc31a96c2482e8919ba824c0e4100c/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7d18052b1bfc31a96c2482e8919ba824c0e4100c/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmigrations%2Fclosure-body-macro-fragment.stderr?ref=7d18052b1bfc31a96c2482e8919ba824c0e4100c", "patch": "@@ -0,0 +1,37 @@\n+warning: changes to closure capture in Rust 2021 will affect drop order\n+  --> $DIR/closure-body-macro-fragment.rs:8:17\n+   |\n+LL |           let f = || $body;\n+   |  _________________^\n+LL | |\n+LL | |         f();\n+LL | |     }};\n+   | |     - in Rust 2018, `a` is dropped here, but in Rust 2021, only `a.0` will be dropped here as part of the closure\n+LL | |     ($body:block) => {{\n+LL | |         m!(@ $body);\n+   | |__________________^\n+...\n+LL | /     m!({\n+LL | |\n+LL | |         let x = a.0;\n+   | |                 --- in Rust 2018, this closure captures all of `a`, but in Rust 2021, it will only capture `a.0`\n+LL | |         println!(\"{}\", x);\n+LL | |     });\n+   | |_______- in this macro invocation\n+   |\n+note: the lint level is defined here\n+  --> $DIR/closure-body-macro-fragment.rs:4:9\n+   |\n+LL | #![warn(rust_2021_compatibility)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^\n+   = note: `#[warn(rust_2021_incompatible_closure_captures)]` implied by `#[warn(rust_2021_compatibility)]`\n+   = note: for more information, see <https://doc.rust-lang.org/nightly/edition-guide/rust-2021/disjoint-capture-in-closures.html>\n+   = note: this warning originates in the macro `m` (in Nightly builds, run with -Z macro-backtrace for more info)\n+help: add a dummy let to cause `a` to be fully captured\n+   |\n+LL ~     m!({\n+LL +         let _ = &a;\n+   |\n+\n+warning: 1 warning emitted\n+"}]}