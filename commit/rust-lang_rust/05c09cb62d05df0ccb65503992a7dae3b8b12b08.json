{"sha": "05c09cb62d05df0ccb65503992a7dae3b8b12b08", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1YzA5Y2I2MmQwNWRmMGNjYjY1NTAzOTkyYTdkYWUzYjhiMTJiMDg=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-09-15T16:33:41Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-09-15T16:46:45Z"}, "message": "Move the Lock into symbol::Interner\n\nThis makes it easier to make the symbol interner (near) lock free in\ncase of concurrent accesses in the future.", "tree": {"sha": "ebc564808049cde7631a9a7b8c335075a5a6c3cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebc564808049cde7631a9a7b8c335075a5a6c3cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/05c09cb62d05df0ccb65503992a7dae3b8b12b08", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/05c09cb62d05df0ccb65503992a7dae3b8b12b08", "html_url": "https://github.com/rust-lang/rust/commit/05c09cb62d05df0ccb65503992a7dae3b8b12b08", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/05c09cb62d05df0ccb65503992a7dae3b8b12b08/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c7bc5e33c25e29058cbafefe680da8d5e9220e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c7bc5e33c25e29058cbafefe680da8d5e9220e9", "html_url": "https://github.com/rust-lang/rust/commit/2c7bc5e33c25e29058cbafefe680da8d5e9220e9"}], "stats": {"total": 37, "additions": 21, "deletions": 16}, "files": [{"sha": "9c5469f635f71ee8c3f6d136d9b60f19242ea749", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/05c09cb62d05df0ccb65503992a7dae3b8b12b08/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05c09cb62d05df0ccb65503992a7dae3b8b12b08/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=05c09cb62d05df0ccb65503992a7dae3b8b12b08", "patch": "@@ -78,7 +78,7 @@ mod tests;\n // threads within the compilation session, but is not accessible outside the\n // session.\n pub struct SessionGlobals {\n-    symbol_interner: Lock<symbol::Interner>,\n+    symbol_interner: symbol::Interner,\n     span_interner: Lock<span_encoding::SpanInterner>,\n     hygiene_data: Lock<hygiene::HygieneData>,\n     source_map: Lock<Option<Lrc<SourceMap>>>,\n@@ -87,7 +87,7 @@ pub struct SessionGlobals {\n impl SessionGlobals {\n     pub fn new(edition: Edition) -> SessionGlobals {\n         SessionGlobals {\n-            symbol_interner: Lock::new(symbol::Interner::fresh()),\n+            symbol_interner: symbol::Interner::fresh(),\n             span_interner: Lock::new(span_encoding::SpanInterner::default()),\n             hygiene_data: Lock::new(hygiene::HygieneData::new(edition)),\n             source_map: Lock::new(None),"}, {"sha": "d0163c36aa22593a51982329c51f723f374f20f9", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 18, "deletions": 13, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/05c09cb62d05df0ccb65503992a7dae3b8b12b08/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05c09cb62d05df0ccb65503992a7dae3b8b12b08/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=05c09cb62d05df0ccb65503992a7dae3b8b12b08", "patch": "@@ -5,6 +5,7 @@\n use rustc_arena::DroplessArena;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher, ToStableHashKey};\n+use rustc_data_structures::sync::Lock;\n use rustc_macros::HashStable_Generic;\n use rustc_serialize::{Decodable, Decoder, Encodable, Encoder};\n \n@@ -1696,6 +1697,9 @@ impl<CTX> ToStableHashKey<CTX> for Symbol {\n     }\n }\n \n+#[derive(Default)]\n+pub(crate) struct Interner(Lock<InternerInner>);\n+\n // The `&'static str`s in this type actually point into the arena.\n //\n // The `FxHashMap`+`Vec` pair could be replaced by `FxIndexSet`, but #75278\n@@ -1705,45 +1709,46 @@ impl<CTX> ToStableHashKey<CTX> for Symbol {\n // This type is private to prevent accidentally constructing more than one `Interner` on the same\n // thread, which makes it easy to mixup `Symbol`s between `Interner`s.\n #[derive(Default)]\n-pub(crate) struct Interner {\n+struct InternerInner {\n     arena: DroplessArena,\n     names: FxHashMap<&'static str, Symbol>,\n     strings: Vec<&'static str>,\n }\n \n impl Interner {\n     fn prefill(init: &[&'static str]) -> Self {\n-        Interner {\n+        Interner(Lock::new(InternerInner {\n             strings: init.into(),\n             names: init.iter().copied().zip((0..).map(Symbol::new)).collect(),\n             ..Default::default()\n-        }\n+        }))\n     }\n \n     #[inline]\n-    pub fn intern(&mut self, string: &str) -> Symbol {\n-        if let Some(&name) = self.names.get(string) {\n+    pub(crate) fn intern(&self, string: &str) -> Symbol {\n+        let mut inner = self.0.lock();\n+        if let Some(&name) = inner.names.get(string) {\n             return name;\n         }\n \n-        let name = Symbol::new(self.strings.len() as u32);\n+        let name = Symbol::new(inner.strings.len() as u32);\n \n         // `from_utf8_unchecked` is safe since we just allocated a `&str` which is known to be\n         // UTF-8.\n         let string: &str =\n-            unsafe { str::from_utf8_unchecked(self.arena.alloc_slice(string.as_bytes())) };\n+            unsafe { str::from_utf8_unchecked(inner.arena.alloc_slice(string.as_bytes())) };\n         // It is safe to extend the arena allocation to `'static` because we only access\n         // these while the arena is still alive.\n         let string: &'static str = unsafe { &*(string as *const str) };\n-        self.strings.push(string);\n-        self.names.insert(string, name);\n+        inner.strings.push(string);\n+        inner.names.insert(string, name);\n         name\n     }\n \n     // Get the symbol as a string. `Symbol::as_str()` should be used in\n     // preference to this function.\n-    pub fn get(&self, symbol: Symbol) -> &str {\n-        self.strings[symbol.0.as_usize()]\n+    pub(crate) fn get(&self, symbol: Symbol) -> &str {\n+        self.0.lock().strings[symbol.0.as_usize()]\n     }\n }\n \n@@ -1875,8 +1880,8 @@ impl Ident {\n }\n \n #[inline]\n-fn with_interner<T, F: FnOnce(&mut Interner) -> T>(f: F) -> T {\n-    with_session_globals(|session_globals| f(&mut *session_globals.symbol_interner.lock()))\n+fn with_interner<T, F: FnOnce(&Interner) -> T>(f: F) -> T {\n+    with_session_globals(|session_globals| f(&session_globals.symbol_interner))\n }\n \n /// An alternative to [`Symbol`], useful when the chars within the symbol need to"}, {"sha": "0958fce5fee304fbd6f918a16efcf40e65e47cef", "filename": "compiler/rustc_span/src/symbol/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/05c09cb62d05df0ccb65503992a7dae3b8b12b08/compiler%2Frustc_span%2Fsrc%2Fsymbol%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05c09cb62d05df0ccb65503992a7dae3b8b12b08/compiler%2Frustc_span%2Fsrc%2Fsymbol%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol%2Ftests.rs?ref=05c09cb62d05df0ccb65503992a7dae3b8b12b08", "patch": "@@ -4,7 +4,7 @@ use crate::create_default_session_globals_then;\n \n #[test]\n fn interner_tests() {\n-    let mut i: Interner = Interner::default();\n+    let i = Interner::default();\n     // first one is zero:\n     assert_eq!(i.intern(\"dog\"), Symbol::new(0));\n     // re-use gets the same entry:"}]}