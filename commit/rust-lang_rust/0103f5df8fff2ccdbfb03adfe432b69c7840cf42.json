{"sha": "0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAxMDNmNWRmOGZmZjJjY2RiZmIwM2FkZmU0MzJiNjljNzg0MGNmNDI=", "commit": {"author": {"name": "Brandon", "email": "brandondong604@hotmail.com", "date": "2021-03-16T07:46:57Z"}, "committer": {"name": "Brandon", "email": "brandondong604@hotmail.com", "date": "2021-03-16T07:52:58Z"}, "message": "Fix missing unresolved macro diagnostic in function body", "tree": {"sha": "0ec3903c77b7311ccf52306d94cc052225b43c7d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ec3903c77b7311ccf52306d94cc052225b43c7d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "html_url": "https://github.com/rust-lang/rust/commit/0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/comments", "author": {"login": "brandondong", "id": 13722457, "node_id": "MDQ6VXNlcjEzNzIyNDU3", "avatar_url": "https://avatars.githubusercontent.com/u/13722457?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brandondong", "html_url": "https://github.com/brandondong", "followers_url": "https://api.github.com/users/brandondong/followers", "following_url": "https://api.github.com/users/brandondong/following{/other_user}", "gists_url": "https://api.github.com/users/brandondong/gists{/gist_id}", "starred_url": "https://api.github.com/users/brandondong/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brandondong/subscriptions", "organizations_url": "https://api.github.com/users/brandondong/orgs", "repos_url": "https://api.github.com/users/brandondong/repos", "events_url": "https://api.github.com/users/brandondong/events{/privacy}", "received_events_url": "https://api.github.com/users/brandondong/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brandondong", "id": 13722457, "node_id": "MDQ6VXNlcjEzNzIyNDU3", "avatar_url": "https://avatars.githubusercontent.com/u/13722457?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brandondong", "html_url": "https://github.com/brandondong", "followers_url": "https://api.github.com/users/brandondong/followers", "following_url": "https://api.github.com/users/brandondong/following{/other_user}", "gists_url": "https://api.github.com/users/brandondong/gists{/gist_id}", "starred_url": "https://api.github.com/users/brandondong/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brandondong/subscriptions", "organizations_url": "https://api.github.com/users/brandondong/orgs", "repos_url": "https://api.github.com/users/brandondong/repos", "events_url": "https://api.github.com/users/brandondong/events{/privacy}", "received_events_url": "https://api.github.com/users/brandondong/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0a2b4e826e1da20d3cfa8c279fcdffa24f32a7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0a2b4e826e1da20d3cfa8c279fcdffa24f32a7d", "html_url": "https://github.com/rust-lang/rust/commit/c0a2b4e826e1da20d3cfa8c279fcdffa24f32a7d"}], "stats": {"total": 114, "additions": 75, "deletions": 39}, "files": [{"sha": "d2dcd6727495467fb5e520e2a6c6d59e28578ba3", "filename": "crates/hir_def/src/body.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -32,6 +32,7 @@ use crate::{\n     path::{ModPath, Path},\n     src::HasSource,\n     AsMacroCall, BlockId, DefWithBodyId, HasModule, LocalModuleId, Lookup, ModuleId,\n+    UnresolvedMacro,\n };\n \n /// A subset of Expander that only deals with cfg attributes. We only need it to\n@@ -101,10 +102,12 @@ impl Expander {\n         &mut self,\n         db: &dyn DefDatabase,\n         macro_call: ast::MacroCall,\n-    ) -> ExpandResult<Option<(Mark, T)>> {\n+    ) -> Result<ExpandResult<Option<(Mark, T)>>, UnresolvedMacro> {\n         if self.recursion_limit + 1 > EXPANSION_RECURSION_LIMIT {\n             cov_mark::hit!(your_stack_belongs_to_me);\n-            return ExpandResult::str_err(\"reached recursion limit during macro expansion\".into());\n+            return Ok(ExpandResult::str_err(\n+                \"reached recursion limit during macro expansion\".into(),\n+            ));\n         }\n \n         let macro_call = InFile::new(self.current_file_id, &macro_call);\n@@ -116,14 +119,14 @@ impl Expander {\n         let call_id =\n             macro_call.as_call_id_with_errors(db, self.def_map.krate(), resolver, &mut |e| {\n                 err.get_or_insert(e);\n-            });\n+            })?;\n         let call_id = match call_id {\n             Some(it) => it,\n             None => {\n                 if err.is_none() {\n                     log::warn!(\"no error despite `as_call_id_with_errors` returning `None`\");\n                 }\n-                return ExpandResult { value: None, err };\n+                return Ok(ExpandResult { value: None, err });\n             }\n         };\n \n@@ -141,17 +144,17 @@ impl Expander {\n                     log::warn!(\"no error despite `parse_or_expand` failing\");\n                 }\n \n-                return ExpandResult::only_err(err.unwrap_or_else(|| {\n+                return Ok(ExpandResult::only_err(err.unwrap_or_else(|| {\n                     mbe::ExpandError::Other(\"failed to parse macro invocation\".into())\n-                }));\n+                })));\n             }\n         };\n \n         let node = match T::cast(raw_node) {\n             Some(it) => it,\n             None => {\n                 // This can happen without being an error, so only forward previous errors.\n-                return ExpandResult { value: None, err };\n+                return Ok(ExpandResult { value: None, err });\n             }\n         };\n \n@@ -167,7 +170,7 @@ impl Expander {\n         self.current_file_id = file_id;\n         self.ast_id_map = db.ast_id_map(file_id);\n \n-        ExpandResult { value: Some((mark, node)), err }\n+        Ok(ExpandResult { value: Some((mark, node)), err })\n     }\n \n     pub(crate) fn exit(&mut self, db: &dyn DefDatabase, mut mark: Mark) {"}, {"sha": "f6992c9a8a946c9a03e3c551aa4de492020f8b8d", "filename": "crates/hir_def/src/body/diagnostics.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Fdiagnostics.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -2,13 +2,14 @@\n \n use hir_expand::diagnostics::DiagnosticSink;\n \n-use crate::diagnostics::{InactiveCode, MacroError, UnresolvedProcMacro};\n+use crate::diagnostics::{InactiveCode, MacroError, UnresolvedMacroCall, UnresolvedProcMacro};\n \n #[derive(Debug, Eq, PartialEq)]\n pub(crate) enum BodyDiagnostic {\n     InactiveCode(InactiveCode),\n     MacroError(MacroError),\n     UnresolvedProcMacro(UnresolvedProcMacro),\n+    UnresolvedMacroCall(UnresolvedMacroCall),\n }\n \n impl BodyDiagnostic {\n@@ -23,6 +24,9 @@ impl BodyDiagnostic {\n             BodyDiagnostic::UnresolvedProcMacro(diag) => {\n                 sink.push(diag.clone());\n             }\n+            BodyDiagnostic::UnresolvedMacroCall(diag) => {\n+                sink.push(diag.clone());\n+            }\n         }\n     }\n }"}, {"sha": "08f0c32f419bc2e8356979f7c045324f47c213da", "filename": "crates/hir_def/src/body/lower.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -24,7 +24,7 @@ use crate::{\n     body::{Body, BodySourceMap, Expander, LabelSource, PatPtr, SyntheticSyntax},\n     builtin_type::{BuiltinFloat, BuiltinInt, BuiltinUint},\n     db::DefDatabase,\n-    diagnostics::{InactiveCode, MacroError, UnresolvedProcMacro},\n+    diagnostics::{InactiveCode, MacroError, UnresolvedMacroCall, UnresolvedProcMacro},\n     expr::{\n         dummy_expr_id, ArithOp, Array, BinaryOp, BindingAnnotation, CmpOp, Expr, ExprId, Label,\n         LabelId, Literal, LogicOp, MatchArm, Ordering, Pat, PatId, RecordFieldPat, RecordLitField,\n@@ -33,7 +33,7 @@ use crate::{\n     item_scope::BuiltinShadowMode,\n     path::{GenericArgs, Path},\n     type_ref::{Mutability, Rawness, TypeRef},\n-    AdtId, BlockLoc, ModuleDefId,\n+    AdtId, BlockLoc, ModuleDefId, UnresolvedMacro,\n };\n \n use super::{diagnostics::BodyDiagnostic, ExprSource, PatSource};\n@@ -542,6 +542,17 @@ impl ExprCollector<'_> {\n         let macro_call = self.expander.to_source(AstPtr::new(&e));\n         let res = self.expander.enter_expand(self.db, e);\n \n+        let res = match res {\n+            Ok(res) => res,\n+            Err(UnresolvedMacro) => {\n+                self.source_map.diagnostics.push(BodyDiagnostic::UnresolvedMacroCall(\n+                    UnresolvedMacroCall { file: outer_file, node: syntax_ptr.cast().unwrap() },\n+                ));\n+                collector(self, None);\n+                return;\n+            }\n+        };\n+\n         match &res.err {\n             Some(ExpandError::UnresolvedProcMacro) => {\n                 self.source_map.diagnostics.push(BodyDiagnostic::UnresolvedProcMacro("}, {"sha": "f8e6f70e87b24894817cb6df84e849c6ceb7d7d6", "filename": "crates/hir_def/src/body/tests.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -174,6 +174,18 @@ fn f() {\n     );\n }\n \n+#[test]\n+fn unresolved_macro_diag() {\n+    check_diagnostics(\n+        r#\"\n+fn f() {\n+    m!();\n+  //^^^^ unresolved macro call\n+}\n+      \"#,\n+    );\n+}\n+\n #[test]\n fn dollar_crate_in_builtin_macro() {\n     check_diagnostics("}, {"sha": "e3bb9de08bcce9c190a16d589d620ff0cdc902af", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 20, "deletions": 17, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -261,23 +261,26 @@ fn collect_items(\n                 let ast_id_map = db.ast_id_map(file_id);\n                 let root = db.parse_or_expand(file_id).unwrap();\n                 let call = ast_id_map.get(call.ast_id).to_node(&root);\n-\n-                if let Some((mark, mac)) = expander.enter_expand(db, call).value {\n-                    let src: InFile<ast::MacroItems> = expander.to_source(mac);\n-                    let item_tree = db.item_tree(src.file_id);\n-                    let iter =\n-                        item_tree.top_level_items().iter().filter_map(ModItem::as_assoc_item);\n-                    items.extend(collect_items(\n-                        db,\n-                        module,\n-                        expander,\n-                        iter,\n-                        src.file_id,\n-                        container,\n-                        limit - 1,\n-                    ));\n-\n-                    expander.exit(db, mark);\n+                let res = expander.enter_expand(db, call);\n+\n+                if let Ok(res) = res {\n+                    if let Some((mark, mac)) = res.value {\n+                        let src: InFile<ast::MacroItems> = expander.to_source(mac);\n+                        let item_tree = db.item_tree(src.file_id);\n+                        let iter =\n+                            item_tree.top_level_items().iter().filter_map(ModItem::as_assoc_item);\n+                        items.extend(collect_items(\n+                            db,\n+                            module,\n+                            expander,\n+                            iter,\n+                            src.file_id,\n+                            container,\n+                            limit - 1,\n+                        ));\n+\n+                        expander.exit(db, mark);\n+                    }\n                 }\n             }\n         }"}, {"sha": "97abf865345ffe4b601919dcb8561784dc5f77c8", "filename": "crates/hir_def/src/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdiagnostics.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -99,7 +99,7 @@ impl Diagnostic for UnresolvedImport {\n //\n // This diagnostic is triggered if rust-analyzer is unable to resolve the path to a\n // macro in a macro invocation.\n-#[derive(Debug)]\n+#[derive(Debug, Clone, Eq, PartialEq)]\n pub struct UnresolvedMacroCall {\n     pub file: HirFileId,\n     pub node: AstPtr<ast::MacroCall>,"}, {"sha": "4b5cdd7a14e1d28e323fd099f06f1435f59a91bb", "filename": "crates/hir_def/src/lib.rs", "status": "modified", "additions": 13, "deletions": 10, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0103f5df8fff2ccdbfb03adfe432b69c7840cf42/crates%2Fhir_def%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Flib.rs?ref=0103f5df8fff2ccdbfb03adfe432b69c7840cf42", "patch": "@@ -583,7 +583,7 @@ pub trait AsMacroCall {\n         krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n     ) -> Option<MacroCallId> {\n-        self.as_call_id_with_errors(db, krate, resolver, &mut |_| ())\n+        self.as_call_id_with_errors(db, krate, resolver, &mut |_| ()).ok()?\n     }\n \n     fn as_call_id_with_errors(\n@@ -592,7 +592,7 @@ pub trait AsMacroCall {\n         krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n         error_sink: &mut dyn FnMut(mbe::ExpandError),\n-    ) -> Option<MacroCallId>;\n+    ) -> Result<Option<MacroCallId>, UnresolvedMacro>;\n }\n \n impl AsMacroCall for InFile<&ast::MacroCall> {\n@@ -602,24 +602,27 @@ impl AsMacroCall for InFile<&ast::MacroCall> {\n         krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n         error_sink: &mut dyn FnMut(mbe::ExpandError),\n-    ) -> Option<MacroCallId> {\n+    ) -> Result<Option<MacroCallId>, UnresolvedMacro> {\n         let ast_id = AstId::new(self.file_id, db.ast_id_map(self.file_id).ast_id(self.value));\n         let h = Hygiene::new(db.upcast(), self.file_id);\n         let path = self.value.path().and_then(|path| path::ModPath::from_src(path, &h));\n \n-        if path.is_none() {\n-            error_sink(mbe::ExpandError::Other(\"malformed macro invocation\".into()));\n-        }\n+        let path = match path {\n+            None => {\n+                error_sink(mbe::ExpandError::Other(\"malformed macro invocation\".into()));\n+                return Ok(None);\n+            }\n+            Some(path) => path,\n+        };\n \n         macro_call_as_call_id(\n-            &AstIdWithPath::new(ast_id.file_id, ast_id.value, path?),\n+            &AstIdWithPath::new(ast_id.file_id, ast_id.value, path),\n             db,\n             krate,\n             resolver,\n             error_sink,\n         )\n-        .ok()?\n-        .ok()\n+        .map(Result::ok)\n     }\n }\n \n@@ -636,7 +639,7 @@ impl<T: ast::AstNode> AstIdWithPath<T> {\n     }\n }\n \n-struct UnresolvedMacro;\n+pub struct UnresolvedMacro;\n \n fn macro_call_as_call_id(\n     call: &AstIdWithPath<ast::MacroCall>,"}]}