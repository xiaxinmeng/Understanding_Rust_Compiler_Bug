{"sha": "40f4993c67ff54e413da17496769407ab85f3924", "node_id": "C_kwDOAAsO6NoAKDQwZjQ5OTNjNjdmZjU0ZTQxM2RhMTc0OTY3Njk0MDdhYjg1ZjM5MjQ", "commit": {"author": {"name": "Yacin Tmimi", "email": "ytmimi@horizonmedia.com", "date": "2021-09-24T02:43:03Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2021-10-06T03:29:23Z"}, "message": "Update derive attibute span to start after opening '('\n\nFixes 4984\n\nWhen parsing derive attributes we're only concerned about the traits\nand comments listed between the opening and closing parentheses.\n\nDerive attribute spans currently start at the '#'.\n\n    Span starts here\n    |\n    v\n    #[derive(...)]\n\nAfter this update the derive spans start after the opening '('.\n\n    Span starts here\n             |\n             V\n    #[derive(...)]", "tree": {"sha": "6912c4e75df9368305be71bb063b67d4d1a4bf16", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6912c4e75df9368305be71bb063b67d4d1a4bf16"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40f4993c67ff54e413da17496769407ab85f3924", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40f4993c67ff54e413da17496769407ab85f3924", "html_url": "https://github.com/rust-lang/rust/commit/40f4993c67ff54e413da17496769407ab85f3924", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40f4993c67ff54e413da17496769407ab85f3924/comments", "author": {"login": "ytmimi", "id": 29028348, "node_id": "MDQ6VXNlcjI5MDI4MzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/29028348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ytmimi", "html_url": "https://github.com/ytmimi", "followers_url": "https://api.github.com/users/ytmimi/followers", "following_url": "https://api.github.com/users/ytmimi/following{/other_user}", "gists_url": "https://api.github.com/users/ytmimi/gists{/gist_id}", "starred_url": "https://api.github.com/users/ytmimi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ytmimi/subscriptions", "organizations_url": "https://api.github.com/users/ytmimi/orgs", "repos_url": "https://api.github.com/users/ytmimi/repos", "events_url": "https://api.github.com/users/ytmimi/events{/privacy}", "received_events_url": "https://api.github.com/users/ytmimi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0f449d6edda5a40057fc82ea02cc9abeae4d012", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0f449d6edda5a40057fc82ea02cc9abeae4d012", "html_url": "https://github.com/rust-lang/rust/commit/f0f449d6edda5a40057fc82ea02cc9abeae4d012"}], "stats": {"total": 55, "additions": 54, "deletions": 1}, "files": [{"sha": "a5982820e3ded6f2de868975ac9003ee441623f4", "filename": "src/attr.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/40f4993c67ff54e413da17496769407ab85f3924/src%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40f4993c67ff54e413da17496769407ab85f3924/src%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fattr.rs?ref=40f4993c67ff54e413da17496769407ab85f3924", "patch": "@@ -13,6 +13,7 @@ use crate::lists::{definitive_tactic, itemize_list, write_list, ListFormatting,\n use crate::overflow;\n use crate::rewrite::{Rewrite, RewriteContext};\n use crate::shape::Shape;\n+use crate::source_map::SpanUtils;\n use crate::types::{rewrite_path, PathContext};\n use crate::utils::{count_newlines, mk_sp};\n \n@@ -116,7 +117,9 @@ fn format_derive(\n                 |span| span.lo(),\n                 |span| span.hi(),\n                 |span| Some(context.snippet(*span).to_owned()),\n-                attr.span.lo(),\n+                // We update derive attribute spans to start after the opening '('\n+                // This helps us focus parsing to just what's inside #[derive(...)]\n+                context.snippet_provider.span_after(attr.span, \"(\"),\n                 attr.span.hi(),\n                 false,\n             );"}, {"sha": "677f873771691771851b48efa740cc090e791867", "filename": "tests/source/issue-4984/minimum_example.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/40f4993c67ff54e413da17496769407ab85f3924/tests%2Fsource%2Fissue-4984%2Fminimum_example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40f4993c67ff54e413da17496769407ab85f3924/tests%2Fsource%2Fissue-4984%2Fminimum_example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-4984%2Fminimum_example.rs?ref=40f4993c67ff54e413da17496769407ab85f3924", "patch": "@@ -0,0 +1,2 @@\n+#[derive(/*Debug, */Clone)]\n+struct Foo;"}, {"sha": "73921dd173547711d0966743203ae07b7203c87e", "filename": "tests/source/issue-4984/multi_line_derive.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/40f4993c67ff54e413da17496769407ab85f3924/tests%2Fsource%2Fissue-4984%2Fmulti_line_derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40f4993c67ff54e413da17496769407ab85f3924/tests%2Fsource%2Fissue-4984%2Fmulti_line_derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-4984%2Fmulti_line_derive.rs?ref=40f4993c67ff54e413da17496769407ab85f3924", "patch": "@@ -0,0 +1,20 @@\n+#[derive(\n+/* ---------- Some really important comment that just had to go inside the derive --------- */\n+Debug, Clone, Eq, PartialEq,\n+)]\n+struct Foo {\n+    a: i32,\n+    b: T,\n+}\n+\n+#[derive(\n+/*\n+    Some really important comment that just had to go inside the derive.\n+    Also had to be put over multiple lines\n+*/\n+Debug, Clone, Eq, PartialEq,\n+)]\n+struct Bar {\n+    a: i32,\n+    b: T,\n+}"}, {"sha": "f0599c5d694b29df53672314d64dff63c9f225df", "filename": "tests/target/issue-4984/minimum_example.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/40f4993c67ff54e413da17496769407ab85f3924/tests%2Ftarget%2Fissue-4984%2Fminimum_example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40f4993c67ff54e413da17496769407ab85f3924/tests%2Ftarget%2Fissue-4984%2Fminimum_example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-4984%2Fminimum_example.rs?ref=40f4993c67ff54e413da17496769407ab85f3924", "patch": "@@ -0,0 +1,2 @@\n+#[derive(/*Debug, */ Clone)]\n+struct Foo;"}, {"sha": "5fbd9784adc97c5f0841c556f5fa695c218afebb", "filename": "tests/target/issue-4984/multi_line_derive.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/40f4993c67ff54e413da17496769407ab85f3924/tests%2Ftarget%2Fissue-4984%2Fmulti_line_derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40f4993c67ff54e413da17496769407ab85f3924/tests%2Ftarget%2Fissue-4984%2Fmulti_line_derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-4984%2Fmulti_line_derive.rs?ref=40f4993c67ff54e413da17496769407ab85f3924", "patch": "@@ -0,0 +1,26 @@\n+#[derive(\n+    /* ---------- Some really important comment that just had to go inside the derive --------- */\n+    Debug,\n+    Clone,\n+    Eq,\n+    PartialEq,\n+)]\n+struct Foo {\n+    a: i32,\n+    b: T,\n+}\n+\n+#[derive(\n+    /*\n+        Some really important comment that just had to go inside the derive.\n+        Also had to be put over multiple lines\n+    */\n+    Debug,\n+    Clone,\n+    Eq,\n+    PartialEq,\n+)]\n+struct Bar {\n+    a: i32,\n+    b: T,\n+}"}]}