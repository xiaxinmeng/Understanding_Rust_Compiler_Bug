{"sha": "98a58114a4f2d83e4ddd4da85493b83b42f6a6b9", "node_id": "C_kwDOAAsO6NoAKDk4YTU4MTE0YTRmMmQ4M2U0ZGRkNGRhODU0OTNiODNiNDJmNmE2Yjk", "commit": {"author": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2022-06-20T18:10:25Z"}, "committer": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2022-06-20T18:10:25Z"}, "message": "Only apply `cfg(test)` for local crates\n\nDon't analyze dependencies with `test`; this should fix various cases\nwhere crates use `cfg(not(test))` and so we didn't find things.\n\n\"Local\" here currently means anything that's not from the registry, so\nanything inside the workspace, but also path dependencies. So this isn't\nperfect, and users might still need to use\n`rust-analyzer.cargo.unsetTest` for these in some cases.", "tree": {"sha": "7a1805703aa40eef82a00015193a22498026fe9f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a1805703aa40eef82a00015193a22498026fe9f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/98a58114a4f2d83e4ddd4da85493b83b42f6a6b9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/98a58114a4f2d83e4ddd4da85493b83b42f6a6b9", "html_url": "https://github.com/rust-lang/rust/commit/98a58114a4f2d83e4ddd4da85493b83b42f6a6b9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/98a58114a4f2d83e4ddd4da85493b83b42f6a6b9/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "427061da19723f2206fe4dcb175c9c43b9a6193d", "url": "https://api.github.com/repos/rust-lang/rust/commits/427061da19723f2206fe4dcb175c9c43b9a6193d", "html_url": "https://github.com/rust-lang/rust/commit/427061da19723f2206fe4dcb175c9c43b9a6193d"}], "stats": {"total": 9, "additions": 7, "deletions": 2}, "files": [{"sha": "052d8fee255306b88a72fe0a7a5804954054fbdb", "filename": "crates/project-model/src/workspace.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/98a58114a4f2d83e4ddd4da85493b83b42f6a6b9/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98a58114a4f2d83e4ddd4da85493b83b42f6a6b9/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fworkspace.rs?ref=98a58114a4f2d83e4ddd4da85493b83b42f6a6b9", "patch": "@@ -541,8 +541,6 @@ fn cargo_to_crate_graph(\n \n     let mut pkg_to_lib_crate = FxHashMap::default();\n \n-    // Add test cfg for non-sysroot crates\n-    cfg_options.insert_atom(\"test\".into());\n     cfg_options.insert_atom(\"debug_assertions\".into());\n \n     let mut pkg_crates = FxHashMap::default();\n@@ -558,6 +556,13 @@ fn cargo_to_crate_graph(\n             CfgOverrides::Selective(cfg_overrides) => cfg_overrides.get(&cargo[pkg].name),\n         };\n \n+        // Add test cfg for local crates\n+        if cargo[pkg].is_local {\n+            replaced_cfg_options = cfg_options.clone();\n+            replaced_cfg_options.insert_atom(\"test\".into());\n+            cfg_options = &replaced_cfg_options;\n+        }\n+\n         if let Some(overrides) = overrides {\n             // FIXME: this is sort of a hack to deal with #![cfg(not(test))] vanishing such as seen\n             // in ed25519_dalek (#7243), and libcore (#9203) (although you only hit that one while"}]}