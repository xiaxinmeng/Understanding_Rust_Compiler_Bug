{"sha": "d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5ZGYwZjQzYWM2NjlhNjhkYzc2NDY2YTJmMmMyMTg4NWI1YWYyZGQ=", "commit": {"author": {"name": "Unreal Hoang", "email": "unrealhoang@gmail.com", "date": "2020-03-26T09:16:10Z"}, "committer": {"name": "Unreal Hoang", "email": "unrealhoang@gmail.com", "date": "2020-03-26T15:08:12Z"}, "message": "Assist: replace unwrap with match", "tree": {"sha": "c20d4c2a698b33c83014664754379b182b659dc9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c20d4c2a698b33c83014664754379b182b659dc9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE5FNMeJ7UuhhqQiT99mIXvcbzfPoFAl58xV0ACgkQ9mIXvcbz\nfPrbKg//YzVGa4kivYw0gt743Vng7hulW3fJ0YDA6YkwIsKXHQcPytnNs6juNuUM\n5g6/PuKGdMEv5FgUXpbAOvHb46RhhKbETrcpmpHiBnDgaq/eGgFoLeEJW7vA4AnC\nG4IgvNHoLzM5k5ucDv3DGl87V0P3gFS6g8J1rGBSR+oWJWuC4PQ2TMGZtiEcVByF\nIaP1eZaaopKn4LIVtBXqICP3IFIhhTZ14qP3sNMkdtN83iM0hsSvP7BKLFTNip+v\nsXnY+HLTqekY1480w7twGnMubsWhy1ZRh5YO/0F2FgwExx0EyHSC8QK+BY5ZfmSc\n93irwU8ULUOBxdupR1LpXTKTlHacch5DtiK3kez9TMymrnn3In6oc/4SpCAhiikY\n9NdpQN4ZHvkqvIVZcZLdmbjmKY4vaTDKGwHWd4JAL08g4Xq3EmIAKg9nY6XxNhQn\nuyWP9J5By7y1q7jnCNzvXE74X6aFQZsyiH+R4V8cwuSARIi7x5Hgi0nk7lXNTFdz\nflWO5o4tgGl8Zob4U7cbS4yixEKlnOwJmx27/kSQi437jy/ICP5a9HyydQKBuqYZ\nFNaPKztpNtPSFwo9U4QVDb+M8QEKtUpdkwrHihtegb+LwRESzJoZvuMmnEpKF2aH\nx2Vj3gpfutZuDcL1gI+P3/iaS7ZNg+6bzxphdcz1WxbrQ/1aBuU=\n=Vqae\n-----END PGP SIGNATURE-----", "payload": "tree c20d4c2a698b33c83014664754379b182b659dc9\nparent 785eb32f49653fbc5789396af4fa6ad61f89fb38\nauthor Unreal Hoang <unrealhoang@gmail.com> 1585214170 +0900\ncommitter Unreal Hoang <unrealhoang@gmail.com> 1585235292 +0900\n\nAssist: replace unwrap with match\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "html_url": "https://github.com/rust-lang/rust/commit/d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/comments", "author": {"login": "unrealhoang", "id": 1218094, "node_id": "MDQ6VXNlcjEyMTgwOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1218094?v=4", "gravatar_id": "", "url": "https://api.github.com/users/unrealhoang", "html_url": "https://github.com/unrealhoang", "followers_url": "https://api.github.com/users/unrealhoang/followers", "following_url": "https://api.github.com/users/unrealhoang/following{/other_user}", "gists_url": "https://api.github.com/users/unrealhoang/gists{/gist_id}", "starred_url": "https://api.github.com/users/unrealhoang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/unrealhoang/subscriptions", "organizations_url": "https://api.github.com/users/unrealhoang/orgs", "repos_url": "https://api.github.com/users/unrealhoang/repos", "events_url": "https://api.github.com/users/unrealhoang/events{/privacy}", "received_events_url": "https://api.github.com/users/unrealhoang/received_events", "type": "User", "site_admin": false}, "committer": {"login": "unrealhoang", "id": 1218094, "node_id": "MDQ6VXNlcjEyMTgwOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1218094?v=4", "gravatar_id": "", "url": "https://api.github.com/users/unrealhoang", "html_url": "https://github.com/unrealhoang", "followers_url": "https://api.github.com/users/unrealhoang/followers", "following_url": "https://api.github.com/users/unrealhoang/following{/other_user}", "gists_url": "https://api.github.com/users/unrealhoang/gists{/gist_id}", "starred_url": "https://api.github.com/users/unrealhoang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/unrealhoang/subscriptions", "organizations_url": "https://api.github.com/users/unrealhoang/orgs", "repos_url": "https://api.github.com/users/unrealhoang/repos", "events_url": "https://api.github.com/users/unrealhoang/events{/privacy}", "received_events_url": "https://api.github.com/users/unrealhoang/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "785eb32f49653fbc5789396af4fa6ad61f89fb38", "url": "https://api.github.com/repos/rust-lang/rust/commits/785eb32f49653fbc5789396af4fa6ad61f89fb38", "html_url": "https://github.com/rust-lang/rust/commit/785eb32f49653fbc5789396af4fa6ad61f89fb38"}], "stats": {"total": 230, "additions": 230, "deletions": 0}, "files": [{"sha": "543224232f5a00e46c1b8bb0a2be3e45875c2ea5", "filename": "crates/ra_assists/src/doc_tests/generated.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_assists%2Fsrc%2Fdoc_tests%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_assists%2Fsrc%2Fdoc_tests%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fdoc_tests%2Fgenerated.rs?ref=d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "patch": "@@ -622,6 +622,30 @@ fn process(map: HashMap<String, String>) {}\n     )\n }\n \n+#[test]\n+fn doctest_replace_unwrap_with_match() {\n+    check(\n+        \"replace_unwrap_with_match\",\n+        r#####\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = x.<|>unwrap();\n+}\n+\"#####,\n+        r#####\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = match x {\n+        Ok(a) => a,\n+        _ => unreachable!(),\n+    };\n+}\n+\"#####,\n+    )\n+}\n+\n #[test]\n fn doctest_split_import() {\n     check("}, {"sha": "62cb7a7631ad1d217e887cb02071e1eabc468731", "filename": "crates/ra_assists/src/handlers/replace_unwrap_with_match.rs", "status": "added", "additions": 177, "deletions": 0, "changes": 177, "blob_url": "https://github.com/rust-lang/rust/blob/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_assists%2Fsrc%2Fhandlers%2Freplace_unwrap_with_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_assists%2Fsrc%2Fhandlers%2Freplace_unwrap_with_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Freplace_unwrap_with_match.rs?ref=d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "patch": "@@ -0,0 +1,177 @@\n+use std::iter;\n+\n+use ra_syntax::{\n+    ast::{self, make},\n+    AstNode,\n+};\n+\n+use crate::{Assist, AssistCtx, AssistId};\n+use ast::edit::IndentLevel;\n+\n+// Assist: replace_unwrap_with_match\n+//\n+// Replaces `unwrap` a `match` expression. Works for Result and Option.\n+//\n+// ```\n+// enum Result<T, E> { Ok(T), Err(E) }\n+// fn main() {\n+//     let x: Result<i32, i32> = Result::Ok(92);\n+//     let y = x.<|>unwrap();\n+// }\n+// ```\n+// ->\n+// ```\n+// enum Result<T, E> { Ok(T), Err(E) }\n+// fn main() {\n+//     let x: Result<i32, i32> = Result::Ok(92);\n+//     let y = match x {\n+//         Ok(a) => a,\n+//         _ => unreachable!(),\n+//     };\n+// }\n+// ```\n+pub(crate) fn replace_unwrap_with_match(ctx: AssistCtx) -> Option<Assist> {\n+    let method_call: ast::MethodCallExpr = ctx.find_node_at_offset()?;\n+    let name = method_call.name_ref()?;\n+    if name.text() != \"unwrap\" {\n+        return None;\n+    }\n+    let caller = method_call.expr()?;\n+    let ty = ctx.sema.type_of_expr(&caller)?;\n+\n+    let type_name = ty.as_adt()?.name(ctx.sema.db).to_string();\n+\n+    for (unwrap_type, variant_name) in [(\"Result\", \"Ok\"), (\"Option\", \"Some\")].iter() {\n+        if &type_name == unwrap_type {\n+            return ctx.add_assist(\n+                AssistId(\"replace_unwrap_with_match\"),\n+                \"Replace unwrap with match\",\n+                |edit| {\n+                    let ok_path =\n+                        make::path_unqualified(make::path_segment(make::name_ref(variant_name)));\n+                    let it = make::bind_pat(make::name(\"a\")).into();\n+                    let ok_tuple = make::tuple_struct_pat(ok_path, iter::once(it)).into();\n+\n+                    let bind_path = make::path_unqualified(make::path_segment(make::name_ref(\"a\")));\n+                    let ok_arm = make::match_arm(iter::once(ok_tuple), make::expr_path(bind_path));\n+\n+                    let unreachable_call = make::unreachable_macro_call().into();\n+                    let err_arm = make::match_arm(\n+                        iter::once(make::placeholder_pat().into()),\n+                        unreachable_call,\n+                    );\n+\n+                    let match_arm_list = make::match_arm_list(vec![ok_arm, err_arm]);\n+                    let match_expr = make::expr_match(caller.clone(), match_arm_list);\n+                    let match_expr =\n+                        IndentLevel::from_node(method_call.syntax()).increase_indent(match_expr);\n+\n+                    edit.target(method_call.syntax().text_range());\n+                    edit.set_cursor(caller.syntax().text_range().start());\n+                    edit.replace_ast::<ast::Expr>(method_call.into(), match_expr);\n+                },\n+            );\n+        }\n+    }\n+    None\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+    use crate::helpers::{check_assist, check_assist_target};\n+\n+    #[test]\n+    fn test_replace_result_unwrap_with_match() {\n+        check_assist(\n+            replace_unwrap_with_match,\n+            r\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = i(x).<|>unwrap();\n+}\n+            \",\n+            r\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = <|>match i(x) {\n+        Ok(a) => a,\n+        _ => unreachable!(),\n+    };\n+}\n+            \",\n+        )\n+    }\n+\n+    #[test]\n+    fn test_replace_option_unwrap_with_match() {\n+        check_assist(\n+            replace_unwrap_with_match,\n+            r\"\n+enum Option<T> { Some(T), None }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x = Option::Some(92);\n+    let y = i(x).<|>unwrap();\n+}\n+            \",\n+            r\"\n+enum Option<T> { Some(T), None }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x = Option::Some(92);\n+    let y = <|>match i(x) {\n+        Some(a) => a,\n+        _ => unreachable!(),\n+    };\n+}\n+            \",\n+        );\n+    }\n+\n+    #[test]\n+    fn test_replace_result_unwrap_with_match_chaining() {\n+        check_assist(\n+            replace_unwrap_with_match,\n+            r\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = i(x).<|>unwrap().count_zeroes();\n+}\n+            \",\n+            r\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = <|>match i(x) {\n+        Ok(a) => a,\n+        _ => unreachable!(),\n+    }.count_zeroes();\n+}\n+            \",\n+        )\n+    }\n+\n+    #[test]\n+    fn replace_unwrap_with_match_target() {\n+        check_assist_target(\n+            replace_unwrap_with_match,\n+            r\"\n+enum Option<T> { Some(T), None }\n+fn i<T>(a: T) -> T { a }\n+fn main() {\n+    let x = Option::Some(92);\n+    let y = i(x).<|>unwrap();\n+}\n+            \",\n+            r\"i(x).unwrap()\",\n+        );\n+    }\n+}"}, {"sha": "becd5e99da6da3494e5f29d1041550dc40be49b7", "filename": "crates/ra_assists/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_assists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_assists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Flib.rs?ref=d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "patch": "@@ -119,6 +119,7 @@ mod handlers {\n     mod remove_mut;\n     mod replace_if_let_with_match;\n     mod replace_qualified_name_with_use;\n+    mod replace_unwrap_with_match;\n     mod split_import;\n \n     pub(crate) fn all() -> &'static [AssistHandler] {\n@@ -154,6 +155,7 @@ mod handlers {\n             remove_mut::remove_mut,\n             replace_if_let_with_match::replace_if_let_with_match,\n             replace_qualified_name_with_use::replace_qualified_name_with_use,\n+            replace_unwrap_with_match::replace_unwrap_with_match,\n             split_import::split_import,\n         ]\n     }"}, {"sha": "e29600439593891394b0f0011e9cb5c2108b0de3", "filename": "crates/ra_syntax/src/ast/make.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_syntax%2Fsrc%2Fast%2Fmake.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/crates%2Fra_syntax%2Fsrc%2Fast%2Fmake.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fmake.rs?ref=d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "patch": "@@ -250,6 +250,10 @@ pub fn token(kind: SyntaxKind) -> SyntaxToken {\n         .unwrap_or_else(|| panic!(\"unhandled token: {:?}\", kind))\n }\n \n+pub fn unreachable_macro_call() -> ast::MacroCall {\n+    ast_from_text(&format!(\"unreachable!()\"))\n+}\n+\n fn ast_from_text<N: AstNode>(text: &str) -> N {\n     let parse = SourceFile::parse(text);\n     let node = parse.tree().syntax().descendants().find_map(N::cast).unwrap();"}, {"sha": "b2568a954f32b6814cf427c9d42b32757f10aa8e", "filename": "docs/user/assists.md", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/docs%2Fuser%2Fassists.md", "raw_url": "https://github.com/rust-lang/rust/raw/d9df0f43ac669a68dc76466a2f2c21885b5af2dd/docs%2Fuser%2Fassists.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fassists.md?ref=d9df0f43ac669a68dc76466a2f2c21885b5af2dd", "patch": "@@ -597,6 +597,29 @@ use std::collections::HashMap;\n fn process(map: HashMap<String, String>) {}\n ```\n \n+## `replace_unwrap_with_match`\n+\n+Replaces `unwrap` a `match` expression. Works for Result and Option.\n+\n+```rust\n+// BEFORE\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = x.\u2503unwrap();\n+}\n+\n+// AFTER\n+enum Result<T, E> { Ok(T), Err(E) }\n+fn main() {\n+    let x: Result<i32, i32> = Result::Ok(92);\n+    let y = match x {\n+        Ok(a) => a,\n+        _ => unreachable!(),\n+    };\n+}\n+```\n+\n ## `split_import`\n \n Wraps the tail of import into braces."}]}