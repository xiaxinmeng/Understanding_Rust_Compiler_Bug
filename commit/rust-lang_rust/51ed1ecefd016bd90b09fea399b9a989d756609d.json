{"sha": "51ed1ecefd016bd90b09fea399b9a989d756609d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxZWQxZWNlZmQwMTZiZDkwYjA5ZmVhMzk5YjlhOTg5ZDc1NjYwOWQ=", "commit": {"author": {"name": "Richo Healey", "email": "richo@psych0tik.net", "date": "2015-02-03T03:33:50Z"}, "committer": {"name": "Richo Healey", "email": "richo@psych0tik.net", "date": "2015-02-03T07:11:23Z"}, "message": "lint: Deny #[no_mangle] const items\n\nThis renames the PrivateNoMangleFns lint to allow both to happen in a\nsingle pass, since they do roughly the same work.", "tree": {"sha": "e16ad18d96715f04e4430acac9de73361eafa6e9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e16ad18d96715f04e4430acac9de73361eafa6e9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51ed1ecefd016bd90b09fea399b9a989d756609d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51ed1ecefd016bd90b09fea399b9a989d756609d", "html_url": "https://github.com/rust-lang/rust/commit/51ed1ecefd016bd90b09fea399b9a989d756609d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51ed1ecefd016bd90b09fea399b9a989d756609d/comments", "author": {"login": "richo", "id": 476418, "node_id": "MDQ6VXNlcjQ3NjQxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/476418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richo", "html_url": "https://github.com/richo", "followers_url": "https://api.github.com/users/richo/followers", "following_url": "https://api.github.com/users/richo/following{/other_user}", "gists_url": "https://api.github.com/users/richo/gists{/gist_id}", "starred_url": "https://api.github.com/users/richo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richo/subscriptions", "organizations_url": "https://api.github.com/users/richo/orgs", "repos_url": "https://api.github.com/users/richo/repos", "events_url": "https://api.github.com/users/richo/events{/privacy}", "received_events_url": "https://api.github.com/users/richo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "richo", "id": 476418, "node_id": "MDQ6VXNlcjQ3NjQxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/476418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richo", "html_url": "https://github.com/richo", "followers_url": "https://api.github.com/users/richo/followers", "following_url": "https://api.github.com/users/richo/following{/other_user}", "gists_url": "https://api.github.com/users/richo/gists{/gist_id}", "starred_url": "https://api.github.com/users/richo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richo/subscriptions", "organizations_url": "https://api.github.com/users/richo/orgs", "repos_url": "https://api.github.com/users/richo/repos", "events_url": "https://api.github.com/users/richo/events{/privacy}", "received_events_url": "https://api.github.com/users/richo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eaf4c5c784637f3df8bdebc6ec21dbd4bc69420a", "url": "https://api.github.com/repos/rust-lang/rust/commits/eaf4c5c784637f3df8bdebc6ec21dbd4bc69420a", "html_url": "https://github.com/rust-lang/rust/commit/eaf4c5c784637f3df8bdebc6ec21dbd4bc69420a"}], "stats": {"total": 30, "additions": 25, "deletions": 5}, "files": [{"sha": "fdc2bed781a135d4c9ca08e68233b683055a7bd5", "filename": "src/librustc/lint/builtin.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/51ed1ecefd016bd90b09fea399b9a989d756609d/src%2Flibrustc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51ed1ecefd016bd90b09fea399b9a989d756609d/src%2Flibrustc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fbuiltin.rs?ref=51ed1ecefd016bd90b09fea399b9a989d756609d", "patch": "@@ -2065,12 +2065,19 @@ declare_lint! {\n     \"functions marked #[no_mangle] should be exported\"\n }\n \n+declare_lint! {\n+    NO_MANGLE_CONST_ITEMS,\n+    Deny,\n+    \"const items will not have their symbols exported\"\n+}\n+\n #[derive(Copy)]\n-pub struct PrivateNoMangleFns;\n+pub struct InvalidNoMangleItems;\n \n-impl LintPass for PrivateNoMangleFns {\n+impl LintPass for InvalidNoMangleItems {\n     fn get_lints(&self) -> LintArray {\n-        lint_array!(PRIVATE_NO_MANGLE_FNS)\n+        lint_array!(PRIVATE_NO_MANGLE_FNS,\n+                    NO_MANGLE_CONST_ITEMS)\n     }\n \n     fn check_item(&mut self, cx: &Context, it: &ast::Item) {\n@@ -2083,6 +2090,12 @@ impl LintPass for PrivateNoMangleFns {\n                     cx.span_lint(PRIVATE_NO_MANGLE_FNS, it.span, msg.as_slice());\n                 }\n             },\n+            ast::ItemConst(..) => {\n+                if attr::contains_name(it.attrs.as_slice(), \"no_mangle\") {\n+                    let msg = \"const items should never be #[no_mangle]\";\n+                    cx.span_lint(NO_MANGLE_CONST_ITEMS, it.span, msg);\n+                }\n+            }\n             _ => {},\n         }\n     }"}, {"sha": "730a125fe972401d88789782a68d645c04655bb9", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51ed1ecefd016bd90b09fea399b9a989d756609d/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51ed1ecefd016bd90b09fea399b9a989d756609d/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=51ed1ecefd016bd90b09fea399b9a989d756609d", "patch": "@@ -213,7 +213,7 @@ impl LintStore {\n                      UnstableFeatures,\n                      Stability,\n                      UnconditionalRecursion,\n-                     PrivateNoMangleFns,\n+                     InvalidNoMangleItems,\n         );\n \n         add_builtin_with_new!(sess,"}, {"sha": "fed1157b1cf1c16f68ac1984b74f3a83bd378a3f", "filename": "src/test/compile-fail/lint-unexported-no-mangle.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/51ed1ecefd016bd90b09fea399b9a989d756609d/src%2Ftest%2Fcompile-fail%2Flint-unexported-no-mangle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51ed1ecefd016bd90b09fea399b9a989d756609d/src%2Ftest%2Fcompile-fail%2Flint-unexported-no-mangle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Flint-unexported-no-mangle.rs?ref=51ed1ecefd016bd90b09fea399b9a989d756609d", "patch": "@@ -8,13 +8,20 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// compile-flags:-F private_no_mangle_fns\n+// compile-flags:-F private_no_mangle_fns -F no_mangle_const_items\n \n // FIXME(#19495) no_mangle'ing main ICE's.\n #[no_mangle]\n fn foo() { //~ ERROR function foo is marked #[no_mangle], but not exported\n }\n \n+#[allow(dead_code)]\n+#[no_mangle]\n+const FOO: u64 = 1; //~ ERROR const items should never be #[no_mangle]\n+\n+#[no_mangle]\n+pub const PUB_FOO: u64 = 1; //~ ERROR const items should never be #[no_mangle]\n+\n #[no_mangle]\n pub fn bar()  {\n }"}]}