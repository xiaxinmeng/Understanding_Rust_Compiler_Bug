{"sha": "cf894535069f67a1192ae7999ae2a82ba31b4877", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmODk0NTM1MDY5ZjY3YTExOTJhZTc5OTlhZTJhODJiYTMxYjQ4Nzc=", "commit": {"author": {"name": "Wang Xuerui", "email": "git@xen0n.name", "date": "2016-12-27T17:49:25Z"}, "committer": {"name": "Wang Xuerui", "email": "git@xen0n.name", "date": "2016-12-28T02:54:13Z"}, "message": "rustbuild: fix host-only rules ignoring targets in dist steps\n\n`arr` is the actual list of targets participating in steps construction,\nbut due to #38468 the hosts array now consists of only the build triple\nfor the `dist` steps, hence all non-build-triple targets are lost for\nthe host-only rules.\n\nFix this by using the original non-shadowed hosts array in `arr`\ncalculation. This should unbreak the nightly packaging process.\n\nFixes #38637.", "tree": {"sha": "746f35e41bce04b31a7e4f8feab45f66b3891317", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/746f35e41bce04b31a7e4f8feab45f66b3891317"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf894535069f67a1192ae7999ae2a82ba31b4877", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJYYylmAAoJEDhUS04t5/q5AN8P+QEXh3zY84ZaSNhAG7Kz7POq\nhfQrGIoRdPlolXYIwaYrIuR2Jgt/oBPHWQTl0Z4xmzb0UuH8AzcCLDmr13XI0NZ7\nvpwdQBmSs4ATg4n6EnUV6UPw6aeHTvEwai3rtSqLPrMJxSd7VpKmqUbho/CDAo4L\ny/ifGCTXRaT23Sts+wqlxxheHzw0n19Hk+JTOHwolSu99SoOw5g0AXdNsWNDIlcD\nMwqILEy6dOLaarFd1zPu0LSIyYJvkrj6sCmxX9SJnfNx6oCdEWlH+oX3hlyFbJhL\nO3UEinGoMbFJRDNqOUUG9yamImheGGQWu0mAuDbsR+J4Ep+Vq+Dml/ZzxqEdnBs7\n9JlU7wkKUNJeC2GaIQZygUmMQGl6dfWMNuwlzKLR0UGkioGtKUEaB5xU2IFIMc0C\nK5fYZkhlbcZfgKE5q4GPeis5oJWkPr4AA0TMAKZrZF4kLvnBt/mvuJzVZd2faOZ0\nm+OPov+MZ9camEUvTdUK8fL2VepnlMxsPvh1OAW2Cww9OjzdpI80ZY3nTviFtV1a\nda0AqHMm97PrPILf0KdnYJJMbAORcD2IWn4/TQ7ej/C3sccTsnmLA1drYoZE3i5c\nE7dRXEwwREYbyO6ndm6ItZN5Hzdt/uXndIdwCYEJ637AThYlJVC55Lbf5Reczurk\njEq6v7QCsLQxq6EkqrN2\n=ZfMm\n-----END PGP SIGNATURE-----", "payload": "tree 746f35e41bce04b31a7e4f8feab45f66b3891317\nparent 3991046d52a0cdcc88174f5d421d4c7761f49244\nauthor Wang Xuerui <git@xen0n.name> 1482860965 +0800\ncommitter Wang Xuerui <git@xen0n.name> 1482893653 +0800\n\nrustbuild: fix host-only rules ignoring targets in dist steps\n\n`arr` is the actual list of targets participating in steps construction,\nbut due to #38468 the hosts array now consists of only the build triple\nfor the `dist` steps, hence all non-build-triple targets are lost for\nthe host-only rules.\n\nFix this by using the original non-shadowed hosts array in `arr`\ncalculation. This should unbreak the nightly packaging process.\n\nFixes #38637.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf894535069f67a1192ae7999ae2a82ba31b4877", "html_url": "https://github.com/rust-lang/rust/commit/cf894535069f67a1192ae7999ae2a82ba31b4877", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf894535069f67a1192ae7999ae2a82ba31b4877/comments", "author": {"login": "xen0n", "id": 1175567, "node_id": "MDQ6VXNlcjExNzU1Njc=", "avatar_url": "https://avatars.githubusercontent.com/u/1175567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xen0n", "html_url": "https://github.com/xen0n", "followers_url": "https://api.github.com/users/xen0n/followers", "following_url": "https://api.github.com/users/xen0n/following{/other_user}", "gists_url": "https://api.github.com/users/xen0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/xen0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xen0n/subscriptions", "organizations_url": "https://api.github.com/users/xen0n/orgs", "repos_url": "https://api.github.com/users/xen0n/repos", "events_url": "https://api.github.com/users/xen0n/events{/privacy}", "received_events_url": "https://api.github.com/users/xen0n/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xen0n", "id": 1175567, "node_id": "MDQ6VXNlcjExNzU1Njc=", "avatar_url": "https://avatars.githubusercontent.com/u/1175567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xen0n", "html_url": "https://github.com/xen0n", "followers_url": "https://api.github.com/users/xen0n/followers", "following_url": "https://api.github.com/users/xen0n/following{/other_user}", "gists_url": "https://api.github.com/users/xen0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/xen0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xen0n/subscriptions", "organizations_url": "https://api.github.com/users/xen0n/orgs", "repos_url": "https://api.github.com/users/xen0n/repos", "events_url": "https://api.github.com/users/xen0n/events{/privacy}", "received_events_url": "https://api.github.com/users/xen0n/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3991046d52a0cdcc88174f5d421d4c7761f49244", "url": "https://api.github.com/repos/rust-lang/rust/commits/3991046d52a0cdcc88174f5d421d4c7761f49244", "html_url": "https://github.com/rust-lang/rust/commit/3991046d52a0cdcc88174f5d421d4c7761f49244"}], "stats": {"total": 14, "additions": 10, "deletions": 4}, "files": [{"sha": "52caa3f0958a348a428d374d20d6a6a5e5b7254f", "filename": "src/bootstrap/step.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/cf894535069f67a1192ae7999ae2a82ba31b4877/src%2Fbootstrap%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf894535069f67a1192ae7999ae2a82ba31b4877/src%2Fbootstrap%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fstep.rs?ref=cf894535069f67a1192ae7999ae2a82ba31b4877", "patch": "@@ -839,14 +839,20 @@ invalid rule dependency graph detected, was a rule added and maybe typo'd?\n                 &self.build.config.target\n             };\n             // Determine the actual targets participating in this rule.\n+            // NOTE: We should keep the full projection from build triple to\n+            // the hosts for the dist steps, now that the hosts array above is\n+            // truncated to avoid duplication of work in that case. Therefore\n+            // the original non-shadowed hosts array is used below.\n             let arr = if rule.host {\n                 // If --target was specified but --host wasn't specified,\n-                // don't run any host-only tests\n-                if self.build.flags.target.len() > 0 &&\n-                   self.build.flags.host.len() == 0 {\n+                // don't run any host-only tests. Also, respect any `--host`\n+                // overrides as done for `hosts`.\n+                if self.build.flags.host.len() > 0 {\n+                    &self.build.flags.host[..]\n+                } else if self.build.flags.target.len() > 0 {\n                     &[]\n                 } else {\n-                    hosts\n+                    &self.build.config.host[..]\n                 }\n             } else {\n                 targets"}]}