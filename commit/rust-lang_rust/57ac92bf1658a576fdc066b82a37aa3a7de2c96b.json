{"sha": "57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "node_id": "C_kwDOAAsO6NoAKDU3YWM5MmJmMTY1OGE1NzZmZGMwNjZiODJhMzdhYTNhN2RlMmM5NmI", "commit": {"author": {"name": "Yacin Tmimi", "email": "yacintmimi@gmail.com", "date": "2021-11-18T01:46:48Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2021-12-14T19:28:25Z"}, "message": "Prevent duplicate comma when formatting struct pattern with \"..\"\n\nFixes 5066\n\nWhen a struct pattern that contained a \"..\" was formatted, it was\nassumed that a trailing comma should always be added if the struct\nfields weren't formatted vertically.\n\nNow, a trailing comma is only added if not already included in the\nreformatted struct fields.", "tree": {"sha": "9974ea36f5aebea2fb9f56c91397cc61e0e640c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9974ea36f5aebea2fb9f56c91397cc61e0e640c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "html_url": "https://github.com/rust-lang/rust/commit/57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/comments", "author": {"login": "ytmimi", "id": 29028348, "node_id": "MDQ6VXNlcjI5MDI4MzQ4", "avatar_url": "https://avatars.githubusercontent.com/u/29028348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ytmimi", "html_url": "https://github.com/ytmimi", "followers_url": "https://api.github.com/users/ytmimi/followers", "following_url": "https://api.github.com/users/ytmimi/following{/other_user}", "gists_url": "https://api.github.com/users/ytmimi/gists{/gist_id}", "starred_url": "https://api.github.com/users/ytmimi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ytmimi/subscriptions", "organizations_url": "https://api.github.com/users/ytmimi/orgs", "repos_url": "https://api.github.com/users/ytmimi/repos", "events_url": "https://api.github.com/users/ytmimi/events{/privacy}", "received_events_url": "https://api.github.com/users/ytmimi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "740fb57f5ddacddd9bcf074df701bcc50b46e69f", "url": "https://api.github.com/repos/rust-lang/rust/commits/740fb57f5ddacddd9bcf074df701bcc50b46e69f", "html_url": "https://github.com/rust-lang/rust/commit/740fb57f5ddacddd9bcf074df701bcc50b46e69f"}], "stats": {"total": 57, "additions": 54, "deletions": 3}, "files": [{"sha": "9b74b35f31413cc20c8b0cdd3863fad51b1ae5b0", "filename": "src/patterns.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/src%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/src%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fpatterns.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -318,19 +318,20 @@ fn rewrite_struct_pat(\n     let mut fields_str = write_list(&item_vec, &fmt)?;\n     let one_line_width = h_shape.map_or(0, |shape| shape.width);\n \n+    let has_trailing_comma = fmt.needs_trailing_separator();\n+\n     if ellipsis {\n         if fields_str.contains('\\n') || fields_str.len() > one_line_width {\n             // Add a missing trailing comma.\n-            if context.config.trailing_comma() == SeparatorTactic::Never {\n+            if !has_trailing_comma {\n                 fields_str.push(',');\n             }\n             fields_str.push('\\n');\n             fields_str.push_str(&nested_shape.indent.to_string(context.config));\n         } else {\n             if !fields_str.is_empty() {\n                 // there are preceding struct fields being matched on\n-                if tactic == DefinitiveListTactic::Vertical {\n-                    // if the tactic is Vertical, write_list already added a trailing ,\n+                if has_trailing_comma {\n                     fields_str.push(' ');\n                 } else {\n                     fields_str.push_str(\", \");"}, {"sha": "c7122c676237e4bffaa3de0d04c9770a82c31bea", "filename": "tests/target/issue-5066/multi_line_struct_trailing_comma_always_struct_lit_width_0.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_trailing_comma_always_struct_lit_width_0.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_trailing_comma_always_struct_lit_width_0.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_trailing_comma_always_struct_lit_width_0.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -0,0 +1,10 @@\n+// rustfmt-trailing_comma: Always\n+// rustfmt-struct_lit_single_line: false\n+// rustfmt-struct_lit_width: 0\n+\n+fn main() {\n+    let Foo {\n+        a,\n+        ..\n+    } = b;\n+}"}, {"sha": "68e89c4179f7d00053fcae307b6b9876e0f7cf48", "filename": "tests/target/issue-5066/multi_line_struct_trailing_comma_never_struct_lit_width_0.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_trailing_comma_never_struct_lit_width_0.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_trailing_comma_never_struct_lit_width_0.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_trailing_comma_never_struct_lit_width_0.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -0,0 +1,10 @@\n+// rustfmt-trailing_comma: Never\n+// rustfmt-struct_lit_single_line: false\n+// rustfmt-struct_lit_width: 0\n+\n+fn main() {\n+    let Foo {\n+        a,\n+        ..\n+    } = b;\n+}"}, {"sha": "3368f07038684b194ff61b1595d71e57785a1d38", "filename": "tests/target/issue-5066/multi_line_struct_with_trailing_comma_always.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_with_trailing_comma_always.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_with_trailing_comma_always.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_with_trailing_comma_always.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -0,0 +1,10 @@\n+// rustfmt-trailing_comma: Always\n+// rustfmt-struct_lit_single_line: false\n+\n+// There is an issue with how this is formatted.\n+// formatting should look like ./multi_line_struct_trailing_comma_always_struct_lit_width_0.rs\n+fn main() {\n+    let Foo {\n+        a, ..\n+    } = b;\n+}"}, {"sha": "cf63c4c983c46e32e395b32e86a395c666c95b16", "filename": "tests/target/issue-5066/multi_line_struct_with_trailing_comma_never.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_with_trailing_comma_never.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_with_trailing_comma_never.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-5066%2Fmulti_line_struct_with_trailing_comma_never.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -0,0 +1,10 @@\n+// rustfmt-trailing_comma: Never\n+// rustfmt-struct_lit_single_line: false\n+\n+// There is an issue with how this is formatted.\n+// formatting should look like ./multi_line_struct_trailing_comma_never_struct_lit_width_0.rs\n+fn main() {\n+    let Foo {\n+        a, ..\n+    } = b;\n+}"}, {"sha": "e20bcec93169683336e838757ab39153a1325106", "filename": "tests/target/issue-5066/with_trailing_comma_always.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fwith_trailing_comma_always.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fwith_trailing_comma_always.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-5066%2Fwith_trailing_comma_always.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -0,0 +1,5 @@\n+// rustfmt-trailing_comma: Always\n+\n+fn main() {\n+    let Foo { a, .. } = b;\n+}"}, {"sha": "8b95bb137bca30bba4fae1c65c0742f72a286d3c", "filename": "tests/target/issue-5066/with_trailing_comma_never.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fwith_trailing_comma_never.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57ac92bf1658a576fdc066b82a37aa3a7de2c96b/tests%2Ftarget%2Fissue-5066%2Fwith_trailing_comma_never.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-5066%2Fwith_trailing_comma_never.rs?ref=57ac92bf1658a576fdc066b82a37aa3a7de2c96b", "patch": "@@ -0,0 +1,5 @@\n+// rustfmt-trailing_comma: Never\n+\n+fn main() {\n+    let Foo { a, .. } = b;\n+}"}]}