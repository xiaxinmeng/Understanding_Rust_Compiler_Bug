{"sha": "fa3621b468263828b5e1a1b1563e0b9cb7209e96", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhMzYyMWI0NjgyNjM4MjhiNWUxYTFiMTU2M2UwYjljYjcyMDllOTY=", "commit": {"author": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-02-14T16:27:08Z"}, "committer": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-02-14T16:31:57Z"}, "message": "Don't fail to remove files if they are missing\n\nIn the backend we may want to remove certain temporary files, but in\ncertain other situations these files might not be produced in the first\nplace. We don't exactly care about that, and the intent is really that\nthese files are gone after a certain point in the backend.\n\nHere we unify the backend file removing calls to use `ensure_removed`\nwhich will attempt to delete a file, but will not fail if it does not\nexist (anymore).\n\nThe tradeoff to this approach is, of course, that we may miss instances\nwere we are attempting to remove files at wrong paths due to some bug \u2013\ncompilation would silently succeed but the temporary files would remain\nthere somewhere.", "tree": {"sha": "94006f8a285f48b431f1156e39430ab65c1c7216", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/94006f8a285f48b431f1156e39430ab65c1c7216"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa3621b468263828b5e1a1b1563e0b9cb7209e96", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa3621b468263828b5e1a1b1563e0b9cb7209e96", "html_url": "https://github.com/rust-lang/rust/commit/fa3621b468263828b5e1a1b1563e0b9cb7209e96", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa3621b468263828b5e1a1b1563e0b9cb7209e96/comments", "author": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b86674e7cc8ac9c846ed5aca84aaefc2d0d12e4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b86674e7cc8ac9c846ed5aca84aaefc2d0d12e4a", "html_url": "https://github.com/rust-lang/rust/commit/b86674e7cc8ac9c846ed5aca84aaefc2d0d12e4a"}], "stats": {"total": 37, "additions": 23, "deletions": 14}, "files": [{"sha": "5f8a11ab94e666798184c3b3f9c51f04649a3028", "filename": "compiler/rustc_codegen_llvm/src/back/write.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fa3621b468263828b5e1a1b1563e0b9cb7209e96/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa3621b468263828b5e1a1b1563e0b9cb7209e96/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs?ref=fa3621b468263828b5e1a1b1563e0b9cb7209e96", "patch": "@@ -11,6 +11,7 @@ use crate::llvm_util;\n use crate::type_::Type;\n use crate::LlvmCodegenBackend;\n use crate::ModuleLlvm;\n+use rustc_codegen_ssa::back::link::ensure_removed;\n use rustc_codegen_ssa::back::write::{\n     BitcodeSection, CodegenContext, EmitObj, ModuleConfig, TargetMachineFactoryConfig,\n     TargetMachineFactoryFn,\n@@ -879,9 +880,7 @@ pub(crate) unsafe fn codegen(\n \n                 if !config.emit_bc {\n                     debug!(\"removing_bitcode {:?}\", bc_out);\n-                    if let Err(e) = fs::remove_file(&bc_out) {\n-                        diag_handler.err(&format!(\"failed to remove bitcode: {}\", e));\n-                    }\n+                    ensure_removed(diag_handler, &bc_out);\n                 }\n             }\n "}, {"sha": "972b9bbfe1caff56a00a5c271ebaa9fb52827c9a", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fa3621b468263828b5e1a1b1563e0b9cb7209e96/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa3621b468263828b5e1a1b1563e0b9cb7209e96/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=fa3621b468263828b5e1a1b1563e0b9cb7209e96", "patch": "@@ -1,5 +1,6 @@\n use rustc_data_structures::fx::FxHashSet;\n use rustc_data_structures::temp_dir::MaybeTempDir;\n+use rustc_errors::Handler;\n use rustc_fs_util::fix_windows_verbatim_for_gcc;\n use rustc_hir::def_id::CrateNum;\n use rustc_middle::middle::cstore::{EncodedMetadata, LibSource};\n@@ -34,9 +35,11 @@ use std::path::{Path, PathBuf};\n use std::process::{ExitStatus, Output, Stdio};\n use std::{ascii, char, env, fmt, fs, io, mem, str};\n \n-pub fn remove(sess: &Session, path: &Path) {\n+pub fn ensure_removed(diag_handler: &Handler, path: &Path) {\n     if let Err(e) = fs::remove_file(path) {\n-        sess.err(&format!(\"failed to remove {}: {}\", path.display(), e));\n+        if e.kind() != io::ErrorKind::NotFound {\n+            diag_handler.err(&format!(\"failed to remove {}: {}\", path.display(), e));\n+        }\n     }\n }\n \n@@ -112,11 +115,11 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n         if !sess.opts.cg.save_temps {\n             let remove_temps_from_module = |module: &CompiledModule| {\n                 if let Some(ref obj) = module.object {\n-                    remove(sess, obj);\n+                    ensure_removed(sess.diagnostic(), obj);\n                 }\n \n                 if let Some(ref obj) = module.dwarf_object {\n-                    remove(sess, obj);\n+                    ensure_removed(sess.diagnostic(), obj);\n                 }\n             };\n "}, {"sha": "b0aed812460071fc4712268e0a527d6512e99d4d", "filename": "compiler/rustc_codegen_ssa/src/back/write.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fa3621b468263828b5e1a1b1563e0b9cb7209e96/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa3621b468263828b5e1a1b1563e0b9cb7209e96/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs?ref=fa3621b468263828b5e1a1b1563e0b9cb7209e96", "patch": "@@ -1,4 +1,4 @@\n-use super::link::{self, remove};\n+use super::link::{self, ensure_removed};\n use super::linker::LinkerInfo;\n use super::lto::{self, SerializedModule};\n use super::symbol_export::symbol_name_for_instance_in_crate;\n@@ -543,7 +543,7 @@ fn produce_final_output_artifacts(\n             copy_gracefully(&path, &crate_output.path(output_type));\n             if !sess.opts.cg.save_temps && !keep_numbered {\n                 // The user just wants `foo.x`, not `foo.#module-name#.x`.\n-                remove(sess, &path);\n+                ensure_removed(sess.diagnostic(), &path);\n             }\n         } else {\n             let ext = crate_output\n@@ -642,33 +642,33 @@ fn produce_final_output_artifacts(\n         for module in compiled_modules.modules.iter() {\n             if let Some(ref path) = module.object {\n                 if !keep_numbered_objects {\n-                    remove(sess, path);\n+                    ensure_removed(sess.diagnostic(), path);\n                 }\n             }\n \n             if let Some(ref path) = module.dwarf_object {\n                 if !keep_numbered_objects {\n-                    remove(sess, path);\n+                    ensure_removed(sess.diagnostic(), path);\n                 }\n             }\n \n             if let Some(ref path) = module.bytecode {\n                 if !keep_numbered_bitcode {\n-                    remove(sess, path);\n+                    ensure_removed(sess.diagnostic(), path);\n                 }\n             }\n         }\n \n         if !user_wants_bitcode {\n             if let Some(ref metadata_module) = compiled_modules.metadata_module {\n                 if let Some(ref path) = metadata_module.bytecode {\n-                    remove(sess, &path);\n+                    ensure_removed(sess.diagnostic(), &path);\n                 }\n             }\n \n             if let Some(ref allocator_module) = compiled_modules.allocator_module {\n                 if let Some(ref path) = allocator_module.bytecode {\n-                    remove(sess, path);\n+                    ensure_removed(sess.diagnostic(), path);\n                 }\n             }\n         }"}, {"sha": "043011b3316a7c195f3e8817df0de3fc73f8e45a", "filename": "src/test/ui/debuginfo-emit-llvm-ir-and-split-debuginfo.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fa3621b468263828b5e1a1b1563e0b9cb7209e96/src%2Ftest%2Fui%2Fdebuginfo-emit-llvm-ir-and-split-debuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa3621b468263828b5e1a1b1563e0b9cb7209e96/src%2Ftest%2Fui%2Fdebuginfo-emit-llvm-ir-and-split-debuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdebuginfo-emit-llvm-ir-and-split-debuginfo.rs?ref=fa3621b468263828b5e1a1b1563e0b9cb7209e96", "patch": "@@ -0,0 +1,7 @@\n+// build-pass\n+//\n+// compile-flags: -g --emit=llvm-ir -Zunstable-options -Csplit-debuginfo=unpacked\n+//\n+// Make sure that we don't explode with an error if we don't actually end up emitting any `dwo`s,\n+// as would be the case if we don't actually codegen anything.\n+#![crate_type=\"rlib\"]"}]}