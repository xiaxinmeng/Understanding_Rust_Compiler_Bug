{"sha": "90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkwYzYyYmNlZTlkMTk1MGQwZTRiNjQyZmMyYmQzYWU1Mzc0ZTQwY2I=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-05-14T13:15:52Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-05-14T13:15:52Z"}, "message": "Prioritize locals with correct types", "tree": {"sha": "feb465bcaa569115f3d7b5fab74ba395c8d9940d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/feb465bcaa569115f3d7b5fab74ba395c8d9940d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb", "html_url": "https://github.com/rust-lang/rust/commit/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1587ac26332c3378c41d3cc552b270ee6a45cc4", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1587ac26332c3378c41d3cc552b270ee6a45cc4", "html_url": "https://github.com/rust-lang/rust/commit/f1587ac26332c3378c41d3cc552b270ee6a45cc4"}], "stats": {"total": 60, "additions": 55, "deletions": 5}, "files": [{"sha": "da336973c1801a35cb08c02bce6a298496056d35", "filename": "crates/ra_ide/src/completion/completion_context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcompletion_context.rs?ref=90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb", "patch": "@@ -34,7 +34,7 @@ pub(crate) struct CompletionContext<'a> {\n     pub(super) record_pat_syntax: Option<ast::RecordPat>,\n     pub(super) record_field_syntax: Option<ast::RecordField>,\n     pub(super) impl_def: Option<ast::ImplDef>,\n-    /// FIXME: `ActiveParameter` is string-based, which is very wrong\n+    /// FIXME: `ActiveParameter` is string-based, which is very very wrong\n     pub(super) active_parameter: Option<ActiveParameter>,\n     pub(super) is_param: bool,\n     /// If a name-binding or reference to a const in a pattern."}, {"sha": "077cf9647735f6add4d73d77cfa73132707182f6", "filename": "crates/ra_ide/src/completion/presentation.rs", "status": "modified", "additions": 54, "deletions": 4, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs?ref=90c62bcee9d1950d0e4b642fc2bd3ae5374e40cb", "patch": "@@ -17,12 +17,11 @@ use crate::{\n impl Completions {\n     pub(crate) fn add_field(&mut self, ctx: &CompletionContext, field: hir::Field, ty: &Type) {\n         let is_deprecated = is_deprecated(field, ctx.db);\n-        let ty = ty.display(ctx.db).to_string();\n         let name = field.name(ctx.db);\n         let mut completion_item =\n             CompletionItem::new(CompletionKind::Reference, ctx.source_range(), name.to_string())\n                 .kind(CompletionItemKind::Field)\n-                .detail(ty.clone())\n+                .detail(ty.display(ctx.db).to_string())\n                 .set_documentation(field.docs(ctx.db))\n                 .set_deprecated(is_deprecated);\n \n@@ -107,6 +106,12 @@ impl Completions {\n             }\n         };\n \n+        if let ScopeDef::Local(local) = resolution {\n+            if let Some(score) = compute_score(ctx, &local.ty(ctx.db), &local_name) {\n+                completion_item = completion_item.set_score(score);\n+            }\n+        }\n+\n         // Add `<>` for generic types\n         if ctx.is_path_type && !ctx.has_type_args && ctx.config.add_call_parenthesis {\n             if let Some(cap) = ctx.config.snippet_cap {\n@@ -319,10 +324,11 @@ impl Completions {\n \n pub(crate) fn compute_score(\n     ctx: &CompletionContext,\n-    // FIXME: this definitely should be a `Type`\n-    ty: &str,\n+    ty: &Type,\n     name: &str,\n ) -> Option<CompletionScore> {\n+    // FIXME: this should not fall back to string equality.\n+    let ty = &ty.display(ctx.db).to_string();\n     let (active_name, active_type) = if let Some(record_field) = &ctx.record_field_syntax {\n         tested_by!(test_struct_field_completion_in_record_lit);\n         let (struct_field, _local) = ctx.sema.resolve_record_field(record_field)?;\n@@ -1405,4 +1411,48 @@ mod tests {\n         \"###\n         );\n     }\n+\n+    #[test]\n+    fn prioritize_exact_ref_match() {\n+        assert_debug_snapshot!(\n+        do_reference_completion(\n+                r\"\n+                    struct WorldSnapshot { _f: () };\n+                    fn go(world: &WorldSnapshot) {\n+                        go(w<|>)\n+                    }\n+                    \",\n+        ),\n+            @r###\"\n+        [\n+            CompletionItem {\n+                label: \"WorldSnapshot\",\n+                source_range: 132..133,\n+                delete: 132..133,\n+                insert: \"WorldSnapshot\",\n+                kind: Struct,\n+            },\n+            CompletionItem {\n+                label: \"go(\u2026)\",\n+                source_range: 132..133,\n+                delete: 132..133,\n+                insert: \"go(${1:world})$0\",\n+                kind: Function,\n+                lookup: \"go\",\n+                detail: \"fn go(world: &WorldSnapshot)\",\n+                trigger_call_info: true,\n+            },\n+            CompletionItem {\n+                label: \"world\",\n+                source_range: 132..133,\n+                delete: 132..133,\n+                insert: \"world\",\n+                kind: Binding,\n+                detail: \"&WorldSnapshot\",\n+                score: TypeAndNameMatch,\n+            },\n+        ]\n+        \"###\n+        );\n+    }\n }"}]}