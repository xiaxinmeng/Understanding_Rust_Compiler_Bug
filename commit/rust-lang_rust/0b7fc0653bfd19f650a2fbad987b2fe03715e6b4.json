{"sha": "0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiN2ZjMDY1M2JmZDE5ZjY1MGEyZmJhZDk4N2IyZmUwMzcxNWU2YjQ=", "commit": {"author": {"name": "Jorge Aparicio", "email": "japaricious@gmail.com", "date": "2016-03-06T13:19:51Z"}, "committer": {"name": "Jorge Aparicio", "email": "japaricious@gmail.com", "date": "2016-03-06T13:19:51Z"}, "message": "rustbuild: fix cross compilation of libstd to i686-unknown-linux-musl\n\n- make sure we copy the third party objects (crt*.o) to the target stage directory.\n- apply the x86_64-musl logic also to the i686-musl target.", "tree": {"sha": "5d778f54cf1fa06d0382944ed47a68a93c74367f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d778f54cf1fa06d0382944ed47a68a93c74367f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "html_url": "https://github.com/rust-lang/rust/commit/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/comments", "author": null, "committer": null, "parents": [{"sha": "c116ae35cf49b55bd8d82e31f1ba030cf7e63867", "url": "https://api.github.com/repos/rust-lang/rust/commits/c116ae35cf49b55bd8d82e31f1ba030cf7e63867", "html_url": "https://github.com/rust-lang/rust/commit/c116ae35cf49b55bd8d82e31f1ba030cf7e63867"}], "stats": {"total": 29, "additions": 24, "deletions": 5}, "files": [{"sha": "fb0a840bfa22b7169ca0085946b2354588e8cafc", "filename": "src/bootstrap/build/compile.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Fbootstrap%2Fbuild%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Fbootstrap%2Fbuild%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fcompile.rs?ref=0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "patch": "@@ -83,6 +83,19 @@ pub fn std_link(build: &Build,\n                          libdir.join(staticlib(\"compiler-rt\", target))));\n     }\n     add_to_sysroot(&out_dir, &libdir);\n+\n+    if target.contains(\"musl\") && (target.contains(\"x86_64\") || target.contains(\"i686\")) {\n+        copy_third_party_objects(build, target, &libdir);\n+    }\n+}\n+\n+/// Copies the crt(1,i,n).o startup objects\n+///\n+/// Only required for musl targets that statically link to libc\n+fn copy_third_party_objects(build: &Build, target: &str, into: &Path) {\n+    for &obj in &[\"crt1.o\", \"crti.o\", \"crtn.o\"] {\n+        t!(fs::copy(compiler_file(build.cc(target), obj), into.join(obj)));\n+    }\n }\n \n /// Build and prepare startup objects like rsbegin.o and rsend.o"}, {"sha": "be4416c697c561d0d796862e206bf43bf5b5307a", "filename": "src/bootstrap/build/sanity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Fbootstrap%2Fbuild%2Fsanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Fbootstrap%2Fbuild%2Fsanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fsanity.rs?ref=0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "patch": "@@ -79,7 +79,7 @@ pub fn check(build: &mut Build) {\n         }\n \n         // Make sure musl-root is valid if specified\n-        if target.contains(\"musl\") && target.contains(\"x86_64\") {\n+        if target.contains(\"musl\") && (target.contains(\"x86_64\") || target.contains(\"i686\")) {\n             match build.config.musl_root {\n                 Some(ref root) => {\n                     if fs::metadata(root.join(\"lib/libc.a\")).is_err() {"}, {"sha": "9e2090c3246c697d2f8a707e1fec8a4e60db896b", "filename": "src/liballoc_jemalloc/build.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Fliballoc_jemalloc%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Fliballoc_jemalloc%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc_jemalloc%2Fbuild.rs?ref=0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "patch": "@@ -111,7 +111,7 @@ fn main() {\n     println!(\"cargo:rustc-link-search=native={}/lib\", build_dir.display());\n     if target.contains(\"android\") {\n         println!(\"cargo:rustc-link-lib=gcc\");\n-    } else if !target.contains(\"windows\") {\n+    } else if !target.contains(\"windows\") && !target.contains(\"musl\") {\n         println!(\"cargo:rustc-link-lib=pthread\");\n     }\n }"}, {"sha": "1c8375479cab27041316984682e7714a2a31d5c7", "filename": "src/libstd/build.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Flibstd%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Flibstd%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fbuild.rs?ref=0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "patch": "@@ -28,7 +28,7 @@ fn main() {\n     }\n \n     if target.contains(\"unknown-linux\") {\n-        if target.contains(\"musl\") && target.contains(\"x86_64\") {\n+        if target.contains(\"musl\") && (target.contains(\"x86_64\") || target.contains(\"i686\")) {\n             println!(\"cargo:rustc-link-lib=static=unwind\");\n         } else {\n             println!(\"cargo:rustc-link-lib=dl\");"}, {"sha": "c1e9782852a7971ae4c714acf5b7ef52c78e25bf", "filename": "src/libstd/sys/common/libunwind.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Flibstd%2Fsys%2Fcommon%2Flibunwind.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b7fc0653bfd19f650a2fbad987b2fe03715e6b4/src%2Flibstd%2Fsys%2Fcommon%2Flibunwind.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fcommon%2Flibunwind.rs?ref=0b7fc0653bfd19f650a2fbad987b2fe03715e6b4", "patch": "@@ -106,9 +106,15 @@ pub type _Unwind_Exception_Cleanup_Fn =\n #[cfg_attr(any(all(target_os = \"linux\", not(target_env = \"musl\")),\n                target_os = \"freebsd\",\n                target_os = \"solaris\",\n-               all(target_os = \"linux\", target_env = \"musl\", not(target_arch = \"x86_64\"))),\n+               all(target_os = \"linux\",\n+                   target_env = \"musl\",\n+                   not(target_arch = \"x86\"),\n+                   not(target_arch = \"x86_64\"))),\n            link(name = \"gcc_s\"))]\n-#[cfg_attr(all(target_os = \"linux\", target_env = \"musl\", target_arch = \"x86_64\", not(test)),\n+#[cfg_attr(all(target_os = \"linux\",\n+               target_env = \"musl\",\n+               any(target_arch = \"x86\", target_arch = \"x86_64\"),\n+               not(test)),\n            link(name = \"unwind\", kind = \"static\"))]\n #[cfg_attr(any(target_os = \"android\", target_os = \"openbsd\"),\n            link(name = \"gcc\"))]"}]}