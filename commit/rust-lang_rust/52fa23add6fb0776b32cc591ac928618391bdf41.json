{"sha": "52fa23add6fb0776b32cc591ac928618391bdf41", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyZmEyM2FkZDZmYjA3NzZiMzJjYzU5MWFjOTI4NjE4MzkxYmRmNDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-04-18T14:15:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-04-18T14:15:31Z"}, "message": "Auto merge of #71218 - eddyb:a-lifetime-stranded-in-fn-def, r=nikomatsakis\n\noutlives: ignore lifetimes shallowly found in `ty::FnDef`s.\n\nFixes #70917 by restoring the pre-#70164 behavior for now.\n\nr? @nikomatsakis", "tree": {"sha": "e4747b1954af60d9eb6ebebfa52642f5feccf77b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4747b1954af60d9eb6ebebfa52642f5feccf77b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52fa23add6fb0776b32cc591ac928618391bdf41", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52fa23add6fb0776b32cc591ac928618391bdf41", "html_url": "https://github.com/rust-lang/rust/commit/52fa23add6fb0776b32cc591ac928618391bdf41", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52fa23add6fb0776b32cc591ac928618391bdf41/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "339a938fa6582d5c6f84d811680a1031c684c1c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/339a938fa6582d5c6f84d811680a1031c684c1c6", "html_url": "https://github.com/rust-lang/rust/commit/339a938fa6582d5c6f84d811680a1031c684c1c6"}, {"sha": "f86f03263cb2de5090ac71663327fba3bd452315", "url": "https://api.github.com/repos/rust-lang/rust/commits/f86f03263cb2de5090ac71663327fba3bd452315", "html_url": "https://github.com/rust-lang/rust/commit/f86f03263cb2de5090ac71663327fba3bd452315"}], "stats": {"total": 70, "additions": 64, "deletions": 6}, "files": [{"sha": "1a601d723cb7bfe74645b4e3fcb812161c1128de", "filename": "src/librustc_infer/infer/outlives/verify.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/52fa23add6fb0776b32cc591ac928618391bdf41/src%2Flibrustc_infer%2Finfer%2Foutlives%2Fverify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52fa23add6fb0776b32cc591ac928618391bdf41/src%2Flibrustc_infer%2Finfer%2Foutlives%2Fverify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_infer%2Finfer%2Foutlives%2Fverify.rs?ref=52fa23add6fb0776b32cc591ac928618391bdf41", "patch": "@@ -42,6 +42,31 @@ impl<'cx, 'tcx> VerifyBoundCx<'cx, 'tcx> {\n         match ty.kind {\n             ty::Param(p) => self.param_bound(p),\n             ty::Projection(data) => self.projection_bound(data),\n+            ty::FnDef(_, substs) => {\n+                // HACK(eddyb) ignore lifetimes found shallowly in `substs`.\n+                // This is inconsistent with `ty::Adt` (including all substs),\n+                // but consistent with previous (accidental) behavior.\n+                // See https://github.com/rust-lang/rust/issues/70917\n+                // for further background and discussion.\n+                let mut bounds = substs\n+                    .iter()\n+                    .filter_map(|&child| match child.unpack() {\n+                        GenericArgKind::Type(ty) => Some(self.type_bound(ty)),\n+                        GenericArgKind::Lifetime(_) => None,\n+                        GenericArgKind::Const(_) => Some(self.recursive_bound(child)),\n+                    })\n+                    .filter(|bound| {\n+                        // Remove bounds that must hold, since they are not interesting.\n+                        !bound.must_hold()\n+                    });\n+\n+                match (bounds.next(), bounds.next()) {\n+                    (Some(first), None) => first,\n+                    (first, second) => VerifyBound::AllBounds(\n+                        first.into_iter().chain(second).chain(bounds).collect(),\n+                    ),\n+                }\n+            }\n             _ => self.recursive_bound(ty.into()),\n         }\n     }"}, {"sha": "4fd4d0d1f062717cd6556854b8aa0803dd3039c9", "filename": "src/librustc_middle/ty/outlives.rs", "status": "modified", "additions": 26, "deletions": 6, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/52fa23add6fb0776b32cc591ac928618391bdf41/src%2Flibrustc_middle%2Fty%2Foutlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52fa23add6fb0776b32cc591ac928618391bdf41/src%2Flibrustc_middle%2Fty%2Foutlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Foutlives.rs?ref=52fa23add6fb0776b32cc591ac928618391bdf41", "patch": "@@ -62,6 +62,27 @@ fn compute_components(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>, out: &mut SmallVec<[Compo\n     // in the `subtys` iterator (e.g., when encountering a\n     // projection).\n     match ty.kind {\n+            ty::FnDef(_, substs) => {\n+                // HACK(eddyb) ignore lifetimes found shallowly in `substs`.\n+                // This is inconsistent with `ty::Adt` (including all substs)\n+                // and with `ty::Closure` (ignoring all substs other than\n+                // upvars, of which a `ty::FnDef` doesn't have any), but\n+                // consistent with previous (accidental) behavior.\n+                // See https://github.com/rust-lang/rust/issues/70917\n+                // for further background and discussion.\n+                for &child in substs {\n+                    match child.unpack() {\n+                        GenericArgKind::Type(ty) => {\n+                            compute_components(tcx, ty, out);\n+                        }\n+                        GenericArgKind::Lifetime(_) => {}\n+                        GenericArgKind::Const(_) => {\n+                            compute_components_recursive(tcx, child, out);\n+                        }\n+                    }\n+                }\n+            }\n+\n             ty::Closure(_, ref substs) => {\n                 for upvar_ty in substs.as_closure().upvar_tys() {\n                     compute_components(tcx, upvar_ty, out);\n@@ -136,23 +157,22 @@ fn compute_components(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>, out: &mut SmallVec<[Compo\n             ty::Float(..) |       // OutlivesScalar\n             ty::Never |           // ...\n             ty::Adt(..) |         // OutlivesNominalType\n-            ty::Opaque(..) |        // OutlivesNominalType (ish)\n+            ty::Opaque(..) |      // OutlivesNominalType (ish)\n             ty::Foreign(..) |     // OutlivesNominalType\n             ty::Str |             // OutlivesScalar (ish)\n             ty::Array(..) |       // ...\n             ty::Slice(..) |       // ...\n             ty::RawPtr(..) |      // ...\n             ty::Ref(..) |         // OutlivesReference\n             ty::Tuple(..) |       // ...\n-            ty::FnDef(..) |       // OutlivesFunction (*)\n             ty::FnPtr(_) |        // OutlivesFunction (*)\n-            ty::Dynamic(..) |       // OutlivesObject, OutlivesFragment (*)\n+            ty::Dynamic(..) |     // OutlivesObject, OutlivesFragment (*)\n             ty::Placeholder(..) |\n             ty::Bound(..) |\n             ty::Error => {\n-                // (*) Bare functions and traits are both binders. In the\n-                // RFC, this means we would add the bound regions to the\n-                // \"bound regions list\".  In our representation, no such\n+                // (*) Function pointers and trait objects are both binders.\n+                // In the RFC, this means we would add the bound regions to\n+                // the \"bound regions list\".  In our representation, no such\n                 // list is maintained explicitly, because bound regions\n                 // themselves can be readily identified.\n                 compute_components_recursive(tcx, ty.into(), out);"}, {"sha": "b9aab27142e312fa2aa55b0554a9d674d22e200d", "filename": "src/test/ui/lifetimes/issue-70917-lifetimes-in-fn-def.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/52fa23add6fb0776b32cc591ac928618391bdf41/src%2Ftest%2Fui%2Flifetimes%2Fissue-70917-lifetimes-in-fn-def.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52fa23add6fb0776b32cc591ac928618391bdf41/src%2Ftest%2Fui%2Flifetimes%2Fissue-70917-lifetimes-in-fn-def.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fissue-70917-lifetimes-in-fn-def.rs?ref=52fa23add6fb0776b32cc591ac928618391bdf41", "patch": "@@ -0,0 +1,13 @@\n+// check-pass\n+\n+fn assert_static<T: 'static>(_: T) {}\n+\n+// NOTE(eddyb) the `'a: 'a` may look a bit strange, but we *really* want\n+// `'a` to be an *early-bound* parameter, otherwise it doesn't matter anyway.\n+fn capture_lifetime<'a: 'a>() {}\n+\n+fn test_lifetime<'a>() {\n+    assert_static(capture_lifetime::<'a>);\n+}\n+\n+fn main() {}"}]}