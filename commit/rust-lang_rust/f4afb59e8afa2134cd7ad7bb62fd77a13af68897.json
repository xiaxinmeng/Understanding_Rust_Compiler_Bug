{"sha": "f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0YWZiNTllOGFmYTIxMzRjZDdhZDdiYjYyZmQ3N2ExM2FmNjg4OTc=", "commit": {"author": {"name": "Scott Olson", "email": "scott@solson.me", "date": "2016-07-07T08:27:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-07T08:27:03Z"}, "message": "Merge pull request #42 from oli-obk/floating_in_space\n\nimplement floats by running the ops on the host architecture", "tree": {"sha": "bce5f5720967c5ea1c86b91f8d0afd8bc5e48f35", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bce5f5720967c5ea1c86b91f8d0afd8bc5e48f35"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "html_url": "https://github.com/rust-lang/rust/commit/f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/comments", "author": {"login": "solson", "id": 26806, "node_id": "MDQ6VXNlcjI2ODA2", "avatar_url": "https://avatars.githubusercontent.com/u/26806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/solson", "html_url": "https://github.com/solson", "followers_url": "https://api.github.com/users/solson/followers", "following_url": "https://api.github.com/users/solson/following{/other_user}", "gists_url": "https://api.github.com/users/solson/gists{/gist_id}", "starred_url": "https://api.github.com/users/solson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/solson/subscriptions", "organizations_url": "https://api.github.com/users/solson/orgs", "repos_url": "https://api.github.com/users/solson/repos", "events_url": "https://api.github.com/users/solson/events{/privacy}", "received_events_url": "https://api.github.com/users/solson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7cc77a010cb842c258b36130df8b9f601970fde", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7cc77a010cb842c258b36130df8b9f601970fde", "html_url": "https://github.com/rust-lang/rust/commit/a7cc77a010cb842c258b36130df8b9f601970fde"}, {"sha": "7613ef0563843f26fb8abdc47dbd2f9e38eb4895", "url": "https://api.github.com/repos/rust-lang/rust/commits/7613ef0563843f26fb8abdc47dbd2f9e38eb4895", "html_url": "https://github.com/rust-lang/rust/commit/7613ef0563843f26fb8abdc47dbd2f9e38eb4895"}], "stats": {"total": 117, "additions": 114, "deletions": 3}, "files": [{"sha": "9ef51a04145261b8cbedfaa7aa4cc2659ffa32e9", "filename": "src/interpreter/mod.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/src%2Finterpreter%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/src%2Finterpreter%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Finterpreter%2Fmod.rs?ref=f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "patch": "@@ -169,7 +169,7 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n     // TODO(solson): Try making const_to_primval instead.\n     fn const_to_ptr(&mut self, const_val: &const_val::ConstVal) -> EvalResult<'tcx, Pointer> {\n         use rustc::middle::const_val::ConstVal::*;\n-        use rustc_const_math::{ConstInt, ConstIsize, ConstUsize};\n+        use rustc_const_math::{ConstInt, ConstIsize, ConstUsize, ConstFloat};\n         macro_rules! i2p {\n             ($i:ident, $n:expr) => {{\n                 let ptr = self.memory.allocate($n);\n@@ -178,7 +178,17 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n             }}\n         }\n         match *const_val {\n-            Float(_f) => unimplemented!(),\n+            Float(ConstFloat::F32(f)) => {\n+                let ptr = self.memory.allocate(4);\n+                self.memory.write_f32(ptr, f)?;\n+                Ok(ptr)\n+            },\n+            Float(ConstFloat::F64(f)) => {\n+                let ptr = self.memory.allocate(8);\n+                self.memory.write_f64(ptr, f)?;\n+                Ok(ptr)\n+            },\n+            Float(ConstFloat::FInfer{..}) => unreachable!(),\n             Integral(ConstInt::Infer(_)) => unreachable!(),\n             Integral(ConstInt::InferSigned(_)) => unreachable!(),\n             Integral(ConstInt::I8(i)) => i2p!(i, 1),\n@@ -824,7 +834,7 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n     }\n \n     pub fn read_primval(&mut self, ptr: Pointer, ty: Ty<'tcx>) -> EvalResult<'tcx, PrimVal> {\n-        use syntax::ast::{IntTy, UintTy};\n+        use syntax::ast::{IntTy, UintTy, FloatTy};\n         let val = match (self.memory.pointer_size(), &ty.sty) {\n             (_, &ty::TyBool)              => PrimVal::Bool(self.memory.read_bool(ptr)?),\n             (_, &ty::TyChar)              => {\n@@ -849,6 +859,9 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n             (8, &ty::TyUint(UintTy::Us)) |\n             (_, &ty::TyUint(UintTy::U64)) => PrimVal::U64(self.memory.read_uint(ptr, 8)? as u64),\n \n+            (_, &ty::TyFloat(FloatTy::F32)) => PrimVal::F32(self.memory.read_f32(ptr)?),\n+            (_, &ty::TyFloat(FloatTy::F64)) => PrimVal::F64(self.memory.read_f64(ptr)?),\n+\n             (_, &ty::TyFnDef(def_id, substs, fn_ty)) => {\n                 PrimVal::FnPtr(self.memory.create_fn_ptr(def_id, substs, fn_ty))\n             },"}, {"sha": "293887ba8625584bf2f6b788d81a6001e530e23f", "filename": "src/memory.rs", "status": "modified", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/src%2Fmemory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/src%2Fmemory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmemory.rs?ref=f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "patch": "@@ -407,6 +407,8 @@ impl<'a, 'tcx> Memory<'a, 'tcx> {\n             PrimVal::U64(n)  => self.write_uint(ptr, n as u64, 8),\n             PrimVal::Char(c) => self.write_uint(ptr, c as u64, 4),\n             PrimVal::IntegerPtr(n) => self.write_uint(ptr, n as u64, pointer_size),\n+            PrimVal::F32(f) => self.write_f32(ptr, f),\n+            PrimVal::F64(f) => self.write_f64(ptr, f),\n             PrimVal::FnPtr(_p) |\n             PrimVal::AbstractPtr(_p) => unimplemented!(),\n         }\n@@ -464,6 +466,28 @@ impl<'a, 'tcx> Memory<'a, 'tcx> {\n         let size = self.pointer_size();\n         self.write_uint(ptr, n, size)\n     }\n+\n+    pub fn write_f32(&mut self, ptr: Pointer, f: f32) -> EvalResult<'tcx, ()> {\n+        let endianess = self.endianess();\n+        let b = self.get_bytes_mut(ptr, 4)?;\n+        write_target_f32(endianess, b, f).unwrap();\n+        Ok(())\n+    }\n+\n+    pub fn write_f64(&mut self, ptr: Pointer, f: f64) -> EvalResult<'tcx, ()> {\n+        let endianess = self.endianess();\n+        let b = self.get_bytes_mut(ptr, 8)?;\n+        write_target_f64(endianess, b, f).unwrap();\n+        Ok(())\n+    }\n+\n+    pub fn read_f32(&self, ptr: Pointer) -> EvalResult<'tcx, f32> {\n+        self.get_bytes(ptr, 4).map(|b| read_target_f32(self.endianess(), b).unwrap())\n+    }\n+\n+    pub fn read_f64(&self, ptr: Pointer) -> EvalResult<'tcx, f64> {\n+        self.get_bytes(ptr, 8).map(|b| read_target_f64(self.endianess(), b).unwrap())\n+    }\n }\n \n /// Relocations\n@@ -586,6 +610,36 @@ fn read_target_int(endianess: layout::Endian, mut source: &[u8]) -> Result<i64,\n     }\n }\n \n+////////////////////////////////////////////////////////////////////////////////\n+// Methods to access floats in the target endianess\n+////////////////////////////////////////////////////////////////////////////////\n+\n+fn write_target_f32(endianess: layout::Endian, mut target: &mut [u8], data: f32) -> Result<(), byteorder::Error> {\n+    match endianess {\n+        layout::Endian::Little => target.write_f32::<LittleEndian>(data),\n+        layout::Endian::Big => target.write_f32::<BigEndian>(data),\n+    }\n+}\n+fn write_target_f64(endianess: layout::Endian, mut target: &mut [u8], data: f64) -> Result<(), byteorder::Error> {\n+    match endianess {\n+        layout::Endian::Little => target.write_f64::<LittleEndian>(data),\n+        layout::Endian::Big => target.write_f64::<BigEndian>(data),\n+    }\n+}\n+\n+fn read_target_f32(endianess: layout::Endian, mut source: &[u8]) -> Result<f32, byteorder::Error> {\n+    match endianess {\n+        layout::Endian::Little => source.read_f32::<LittleEndian>(),\n+        layout::Endian::Big => source.read_f32::<BigEndian>(),\n+    }\n+}\n+fn read_target_f64(endianess: layout::Endian, mut source: &[u8]) -> Result<f64, byteorder::Error> {\n+    match endianess {\n+        layout::Endian::Little => source.read_f64::<LittleEndian>(),\n+        layout::Endian::Big => source.read_f64::<BigEndian>(),\n+    }\n+}\n+\n ////////////////////////////////////////////////////////////////////////////////\n // Undefined byte tracking\n ////////////////////////////////////////////////////////////////////////////////"}, {"sha": "966196d8d1a5f65a3aa1e9d3a9fe6154bf57ef7a", "filename": "src/primval.rs", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/src%2Fprimval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/src%2Fprimval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fprimval.rs?ref=f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "patch": "@@ -13,6 +13,8 @@ pub enum PrimVal {\n     FnPtr(Pointer),\n     IntegerPtr(u64),\n     Char(char),\n+\n+    F32(f32), F64(f64),\n }\n \n /// returns the result of the operation and whether the operation overflowed\n@@ -57,6 +59,32 @@ pub fn binary_op<'tcx>(bin_op: mir::BinOp, left: PrimVal, right: PrimVal) -> Eva\n         })\n     }\n \n+    macro_rules! float_binops {\n+        ($v:ident, $l:ident, $r:ident) => ({\n+            match bin_op {\n+                Add    => $v($l + $r),\n+                Sub    => $v($l - $r),\n+                Mul    => $v($l * $r),\n+                Div    => $v($l / $r),\n+                Rem    => $v($l % $r),\n+\n+                // invalid float ops\n+                BitXor => unreachable!(),\n+                BitAnd => unreachable!(),\n+                BitOr  => unreachable!(),\n+                Shl => unreachable!(),\n+                Shr => unreachable!(),\n+\n+                Eq => Bool($l == $r),\n+                Ne => Bool($l != $r),\n+                Lt => Bool($l < $r),\n+                Le => Bool($l <= $r),\n+                Gt => Bool($l > $r),\n+                Ge => Bool($l >= $r),\n+            }\n+        })\n+    }\n+\n     fn unrelated_ptr_ops<'tcx>(bin_op: mir::BinOp) -> EvalResult<'tcx, PrimVal> {\n         use rustc::mir::repr::BinOp::*;\n         match bin_op {\n@@ -128,6 +156,8 @@ pub fn binary_op<'tcx>(bin_op: mir::BinOp, left: PrimVal, right: PrimVal) -> Eva\n         (U16(l), U16(r)) => int_binops!(U16, l, r),\n         (U32(l), U32(r)) => int_binops!(U32, l, r),\n         (U64(l), U64(r)) => int_binops!(U64, l, r),\n+        (F32(l), F32(r)) => float_binops!(F32, l, r),\n+        (F64(l), F64(r)) => float_binops!(F64, l, r),\n         (Char(l), Char(r)) => match bin_op {\n             Eq => Bool(l == r),\n             Ne => Bool(l != r),\n@@ -211,6 +241,9 @@ pub fn unary_op<'tcx>(un_op: mir::UnOp, val: PrimVal) -> EvalResult<'tcx, PrimVa\n         (Not, U16(n)) => Ok(U16(!n)),\n         (Not, U32(n)) => Ok(U32(!n)),\n         (Not, U64(n)) => Ok(U64(!n)),\n+\n+        (Neg, F64(n)) => Ok(F64(-n)),\n+        (Neg, F32(n)) => Ok(F32(-n)),\n         _ => Err(EvalError::Unimplemented(format!(\"unimplemented unary op: {:?}, {:?}\", un_op, val))),\n     }\n }"}, {"sha": "9c4d0594d1c9916dac909bcdd5087008a2b79e6c", "filename": "tests/run-pass/floats.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/tests%2Frun-pass%2Ffloats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4afb59e8afa2134cd7ad7bb62fd77a13af68897/tests%2Frun-pass%2Ffloats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Ffloats.rs?ref=f4afb59e8afa2134cd7ad7bb62fd77a13af68897", "patch": "@@ -0,0 +1,11 @@\n+\n+fn main() {\n+    assert_eq!(6.0_f32*6.0_f32, 36.0_f32);\n+    assert_eq!(6.0_f64*6.0_f64, 36.0_f64);\n+    assert_eq!(-{5.0_f32}, -5.0_f32);\n+    assert!((5.0_f32/0.0).is_infinite());\n+    assert!((-5.0_f32).sqrt().is_nan());\n+    let x: u64 = unsafe { std::mem::transmute(42.0_f64) };\n+    let y: f64 = unsafe { std::mem::transmute(x) };\n+    assert_eq!(y, 42.0_f64);\n+}"}]}