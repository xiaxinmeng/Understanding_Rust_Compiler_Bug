{"sha": "24e3b1d0d3cfb5fddc91105bb261413566e8b701", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0ZTNiMWQwZDNjZmI1ZmRkYzkxMTA1YmIyNjE0MTM1NjZlOGI3MDE=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-09-03T12:27:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-09-03T12:27:05Z"}, "message": "Rollup merge of #64104 - Mark-Simulacrum:intrinsic-fn-ptr-ice, r=estebank\n\nEmit error on intrinsic to fn ptr casts\n\nI'm not sure if a type error is the best way of doing this but it seemed like a relatively correct place to do it, and I expect this is a pretty rare case to hit anyway.\n\nFixes #15694", "tree": {"sha": "a5ebb43454b05a252c93cd59c2ceacc7fd4ec32e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5ebb43454b05a252c93cd59c2ceacc7fd4ec32e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24e3b1d0d3cfb5fddc91105bb261413566e8b701", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdblwZCRBK7hj4Ov3rIwAAdHIIAKNarxTuwyASMfp/BycDFXVg\n+1r4cfsqOpN6hjieYcg9K+vofnlWwlH2FFsR1IRH7XveI9zc5PFQj5JN0+OFSmOK\nlRlugCxYBH3P33BhHC5SDSu3mdaHbU5vDJq3K3mLu3ZUPe15Kbp/gxzKXqOfIgPk\nPfmq3JRHWE7988EP5nYMUYIKhu0ReZ72qdrdkfC/4YAydXQgm4VaYQ1UJjzvhdgO\noEBYwkJGN9fca5um7WFa1u8EZKQ1G77FT8+Jg63MlzSbkewAkz8AVoC0Gm3/4PLV\neA4seZc/NqPM9VtEYOuJdJmQRA6puSvXGnQnrQHzOHe50pQ5pM5B4aHY6UrQZO8=\n=gG6Y\n-----END PGP SIGNATURE-----\n", "payload": "tree a5ebb43454b05a252c93cd59c2ceacc7fd4ec32e\nparent a906a83d986f73ae92c63ecfe230b14a11eed82f\nparent dd323f8a72327aba0b4771ea08a8b007bba995ca\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1567513625 +0200\ncommitter GitHub <noreply@github.com> 1567513625 +0200\n\nRollup merge of #64104 - Mark-Simulacrum:intrinsic-fn-ptr-ice, r=estebank\n\nEmit error on intrinsic to fn ptr casts\n\nI'm not sure if a type error is the best way of doing this but it seemed like a relatively correct place to do it, and I expect this is a pretty rare case to hit anyway.\n\nFixes #15694\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24e3b1d0d3cfb5fddc91105bb261413566e8b701", "html_url": "https://github.com/rust-lang/rust/commit/24e3b1d0d3cfb5fddc91105bb261413566e8b701", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24e3b1d0d3cfb5fddc91105bb261413566e8b701/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a906a83d986f73ae92c63ecfe230b14a11eed82f", "url": "https://api.github.com/repos/rust-lang/rust/commits/a906a83d986f73ae92c63ecfe230b14a11eed82f", "html_url": "https://github.com/rust-lang/rust/commit/a906a83d986f73ae92c63ecfe230b14a11eed82f"}, {"sha": "dd323f8a72327aba0b4771ea08a8b007bba995ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/dd323f8a72327aba0b4771ea08a8b007bba995ca", "html_url": "https://github.com/rust-lang/rust/commit/dd323f8a72327aba0b4771ea08a8b007bba995ca"}], "stats": {"total": 57, "additions": 57, "deletions": 0}, "files": [{"sha": "e684ccfeeb7ed7babc8c4a602c333de5ccc87626", "filename": "src/librustc/infer/error_reporting/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -1636,6 +1636,9 @@ impl<'tcx> ObligationCause<'tcx> {\n                 TypeError::CyclicTy(ty) if ty.is_closure() || ty.is_generator() => {\n                     Error0644(\"closure/generator type that references itself\")\n                 }\n+                TypeError::IntrinsicCast => {\n+                    Error0308(\"cannot coerce intrinsics to function pointers\")\n+                }\n                 _ => Error0308(\"mismatched types\"),\n             },\n         }"}, {"sha": "fe8f94ab1d314bdcb1e3a2a2870a228b7b295c99", "filename": "src/librustc/ty/error.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc%2Fty%2Ferror.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc%2Fty%2Ferror.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Ferror.rs?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -46,6 +46,8 @@ pub enum TypeError<'tcx> {\n     ExistentialMismatch(ExpectedFound<&'tcx ty::List<ty::ExistentialPredicate<'tcx>>>),\n \n     ConstMismatch(ExpectedFound<&'tcx ty::Const<'tcx>>),\n+\n+    IntrinsicCast,\n }\n \n #[derive(Clone, RustcEncodable, RustcDecodable, PartialEq, Eq, Hash, Debug, Copy)]\n@@ -179,6 +181,9 @@ impl<'tcx> fmt::Display for TypeError<'tcx> {\n             ConstMismatch(ref values) => {\n                 write!(f, \"expected `{}`, found `{}`\", values.expected, values.found)\n             }\n+            IntrinsicCast => {\n+                write!(f, \"cannot coerce intrinsics to function pointers\")\n+            }\n         }\n     }\n }"}, {"sha": "ec7cf1a13c5964f81b47fa94aff9e807a12db82c", "filename": "src/librustc/ty/structural_impls.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fstructural_impls.rs?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -748,6 +748,7 @@ impl<'a, 'tcx> Lift<'tcx> for ty::error::TypeError<'a> {\n             Sorts(ref x) => return tcx.lift(x).map(Sorts),\n             ExistentialMismatch(ref x) => return tcx.lift(x).map(ExistentialMismatch),\n             ConstMismatch(ref x) => return tcx.lift(x).map(ConstMismatch),\n+            IntrinsicCast => IntrinsicCast,\n         })\n     }\n }\n@@ -1338,6 +1339,7 @@ EnumTypeFoldableImpl! {\n         (ty::error::TypeError::Sorts)(x),\n         (ty::error::TypeError::ExistentialMismatch)(x),\n         (ty::error::TypeError::ConstMismatch)(x),\n+        (ty::error::TypeError::IntrinsicCast),\n     }\n }\n "}, {"sha": "c216cc92b1e58867ad0c41913276eb3091975d06", "filename": "src/librustc_typeck/check/cast.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -40,6 +40,7 @@ use rustc::ty::{self, Ty, TypeFoldable, TypeAndMut};\n use rustc::ty::subst::SubstsRef;\n use rustc::ty::adjustment::AllowTwoPhase;\n use rustc::ty::cast::{CastKind, CastTy};\n+use rustc::ty::error::TypeError;\n use rustc::middle::lang_items;\n use syntax::ast;\n use syntax_pos::Span;\n@@ -461,6 +462,9 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                                              self.expr_ty,\n                                              fcx.tcx.mk_fn_ptr(f),\n                                              AllowTwoPhase::No);\n+                    if let Err(TypeError::IntrinsicCast) = res {\n+                        return Err(CastError::IllegalCast);\n+                    }\n                     if res.is_err() {\n                         return Err(CastError::NonScalar);\n                     }"}, {"sha": "f2e1a6e29d6fca09344839e42f75ea9c9581716f", "filename": "src/librustc_typeck/check/coercion.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -70,6 +70,7 @@ use std::ops::Deref;\n use syntax::feature_gate;\n use syntax::symbol::sym;\n use syntax_pos;\n+use rustc_target::spec::abi::Abi;\n \n struct Coerce<'a, 'tcx> {\n     fcx: &'a FnCtxt<'a, 'tcx>,\n@@ -689,6 +690,11 @@ impl<'f, 'tcx> Coerce<'f, 'tcx> {\n         match b.sty {\n             ty::FnPtr(_) => {\n                 let a_sig = a.fn_sig(self.tcx);\n+                // Intrinsics are not coercible to function pointers\n+                if a_sig.abi() == Abi::RustIntrinsic ||\n+                   a_sig.abi() == Abi::PlatformIntrinsic {\n+                   return Err(TypeError::IntrinsicCast);\n+                }\n                 let InferOk { value: a_sig, mut obligations } =\n                     self.normalize_associated_types_in_as_infer_ok(self.cause.span, &a_sig);\n "}, {"sha": "09baa059e55679f5bbaa9d3a76c9db8b8d6f1996", "filename": "src/test/ui/reify-intrinsic.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Ftest%2Fui%2Freify-intrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Ftest%2Fui%2Freify-intrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Freify-intrinsic.rs?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -0,0 +1,15 @@\n+// check-fail\n+\n+#![feature(intrinsics)]\n+\n+fn a() {\n+    let _: unsafe extern \"rust-intrinsic\" fn(isize) -> usize = std::mem::transmute;\n+    //~^ ERROR cannot coerce\n+}\n+\n+fn b() {\n+    let _ = std::mem::transmute as unsafe extern \"rust-intrinsic\" fn(isize) -> usize;\n+    //~^ ERROR casting\n+}\n+\n+fn main() {}"}, {"sha": "4a1bd77cf7ee9839082c83da371dd9b180666c32", "filename": "src/test/ui/reify-intrinsic.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Ftest%2Fui%2Freify-intrinsic.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/24e3b1d0d3cfb5fddc91105bb261413566e8b701/src%2Ftest%2Fui%2Freify-intrinsic.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Freify-intrinsic.stderr?ref=24e3b1d0d3cfb5fddc91105bb261413566e8b701", "patch": "@@ -0,0 +1,22 @@\n+error[E0308]: cannot coerce intrinsics to function pointers\n+  --> $DIR/reify-intrinsic.rs:6:64\n+   |\n+LL |     let _: unsafe extern \"rust-intrinsic\" fn(isize) -> usize = std::mem::transmute;\n+   |                                                                ^^^^^^^^^^^^^^^^^^^\n+   |                                                                |\n+   |                                                                cannot coerce intrinsics to function pointers\n+   |                                                                help: use parentheses to call this function: `std::mem::transmute(...)`\n+   |\n+   = note: expected type `unsafe extern \"rust-intrinsic\" fn(isize) -> usize`\n+              found type `unsafe extern \"rust-intrinsic\" fn(_) -> _ {std::intrinsics::transmute::<_, _>}`\n+\n+error[E0606]: casting `unsafe extern \"rust-intrinsic\" fn(_) -> _ {std::intrinsics::transmute::<_, _>}` as `unsafe extern \"rust-intrinsic\" fn(isize) -> usize` is invalid\n+  --> $DIR/reify-intrinsic.rs:11:13\n+   |\n+LL |     let _ = std::mem::transmute as unsafe extern \"rust-intrinsic\" fn(isize) -> usize;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+\n+Some errors have detailed explanations: E0308, E0606.\n+For more information about an error, try `rustc --explain E0308`."}]}