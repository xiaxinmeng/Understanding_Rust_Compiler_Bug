{"sha": "979d131c5d8354a80d21942bed7d78ab1e76d9f0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3OWQxMzFjNWQ4MzU0YTgwZDIxOTQyYmVkN2Q3OGFiMWU3NmQ5ZjA=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-08-30T10:27:36Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-08-30T10:27:36Z"}, "message": "Format and preserve attributes on ast::Stmt", "tree": {"sha": "47faaf86dfd4be154647959a3cc2191773a1703d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/47faaf86dfd4be154647959a3cc2191773a1703d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/979d131c5d8354a80d21942bed7d78ab1e76d9f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/979d131c5d8354a80d21942bed7d78ab1e76d9f0", "html_url": "https://github.com/rust-lang/rust/commit/979d131c5d8354a80d21942bed7d78ab1e76d9f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/979d131c5d8354a80d21942bed7d78ab1e76d9f0/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e31a48b4d9f431635c67bb608d9a68729c798a35", "url": "https://api.github.com/repos/rust-lang/rust/commits/e31a48b4d9f431635c67bb608d9a68729c798a35", "html_url": "https://github.com/rust-lang/rust/commit/e31a48b4d9f431635c67bb608d9a68729c798a35"}], "stats": {"total": 200, "additions": 117, "deletions": 83}, "files": [{"sha": "f00dc6457f97e540a5097f9a201f2981feb6816c", "filename": "src/expr.rs", "status": "modified", "additions": 20, "deletions": 24, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=979d131c5d8354a80d21942bed7d78ab1e76d9f0", "patch": "@@ -130,11 +130,10 @@ pub fn format_expr(\n                 ExprType::Statement => {\n                     if is_unsafe_block(block) {\n                         block.rewrite(context, shape)\n-                    } else {\n+                    } else if let rw @ Some(_) = rewrite_empty_block(context, block, shape) {\n                         // Rewrite block without trying to put it in a single line.\n-                        if let rw @ Some(_) = rewrite_empty_block(context, block, shape) {\n-                            return rw;\n-                        }\n+                        rw\n+                    } else {\n                         let prefix = try_opt!(block_prefix(context, block, shape));\n                         rewrite_block_with_visitor(context, &prefix, block, shape)\n                     }\n@@ -293,17 +292,17 @@ pub fn format_expr(\n             shape,\n         ),\n         ast::ExprKind::Catch(ref block) => {\n-            if let rewrite @ Some(_) = rewrite_single_line_block(context, \"do catch \", block, shape)\n-            {\n-                return rewrite;\n+            if let rw @ Some(_) = rewrite_single_line_block(context, \"do catch \", block, shape) {\n+                rw\n+            } else {\n+                // 9 = `do catch `\n+                let budget = shape.width.checked_sub(9).unwrap_or(0);\n+                Some(format!(\n+                    \"{}{}\",\n+                    \"do catch \",\n+                    try_opt!(block.rewrite(&context, Shape::legacy(budget, shape.indent)))\n+                ))\n             }\n-            // 9 = `do catch `\n-            let budget = shape.width.checked_sub(9).unwrap_or(0);\n-            Some(format!(\n-                \"{}{}\",\n-                \"do catch \",\n-                try_opt!(block.rewrite(&context, Shape::legacy(budget, shape.indent)))\n-            ))\n         }\n     };\n \n@@ -883,16 +882,13 @@ impl Rewrite for ast::Stmt {\n                     \"\"\n                 };\n \n-                format_expr(\n-                    ex,\n-                    match self.node {\n-                        ast::StmtKind::Expr(_) => ExprType::SubExpression,\n-                        ast::StmtKind::Semi(_) => ExprType::Statement,\n-                        _ => unreachable!(),\n-                    },\n-                    context,\n-                    try_opt!(shape.sub_width(suffix.len())),\n-                ).map(|s| s + suffix)\n+                let expr_type = match self.node {\n+                    ast::StmtKind::Expr(_) => ExprType::SubExpression,\n+                    ast::StmtKind::Semi(_) => ExprType::Statement,\n+                    _ => unreachable!(),\n+                };\n+                let shape = try_opt!(shape.sub_width(suffix.len()));\n+                format_expr(ex, expr_type, context, shape).map(|s| s + suffix)\n             }\n             ast::StmtKind::Mac(..) | ast::StmtKind::Item(..) => None,\n         };"}, {"sha": "50efea4044e05b873d4e50be866c3408a3edcdcd", "filename": "src/items.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=979d131c5d8354a80d21942bed7d78ab1e76d9f0", "patch": "@@ -55,7 +55,23 @@ impl Rewrite for ast::Local {\n \n         skip_out_of_file_lines_range!(context, self.span);\n \n-        let mut result = \"let \".to_owned();\n+        if contains_skip(&self.attrs) {\n+            return None;\n+        }\n+\n+        let attrs_str = try_opt!(self.attrs.rewrite(context, shape));\n+        let mut result = if attrs_str.is_empty() {\n+            \"let \".to_owned()\n+        } else {\n+            try_opt!(combine_strs_with_missing_comments(\n+                context,\n+                &attrs_str,\n+                \"let \",\n+                mk_sp(self.attrs.last().map(|a| a.span.hi).unwrap(), self.span.lo),\n+                shape,\n+                false,\n+            ))\n+        };\n \n         // 4 = \"let \".len()\n         let pat_shape = try_opt!(shape.offset_left(4));"}, {"sha": "c45110ea06b6156c6032e880faec00764f9c1cb8", "filename": "src/lib.rs", "status": "modified", "additions": 24, "deletions": 22, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=979d131c5d8354a80d21942bed7d78ab1e76d9f0", "patch": "@@ -91,32 +91,46 @@ macro_rules! span_with_attrs_lo_hi {\n         }\n     }\n }\n+\n macro_rules! span_with_attrs {\n     ($this:ident) => {\n         span_with_attrs_lo_hi!($this, $this.span.lo, $this.span.hi)\n     }\n }\n \n-impl Spanned for ast::Expr {\n-    fn span(&self) -> Span {\n-        span_with_attrs!(self)\n+macro_rules! implement_spanned {\n+    ($this:ty) => {\n+        impl Spanned for $this {\n+            fn span(&self) -> Span {\n+                span_with_attrs!(self)\n+            }\n+        }\n     }\n }\n \n-impl Spanned for ast::Item {\n-    fn span(&self) -> Span {\n-        span_with_attrs!(self)\n-    }\n-}\n+// Implement `Spanned` for structs with `attrs` field.\n+implement_spanned!(ast::Expr);\n+implement_spanned!(ast::Field);\n+implement_spanned!(ast::ForeignItem);\n+implement_spanned!(ast::Item);\n+implement_spanned!(ast::Local);\n \n impl Spanned for ast::Stmt {\n     fn span(&self) -> Span {\n         match self.node {\n-            // Cover attributes\n+            ast::StmtKind::Local(ref local) => mk_sp(local.span().lo, self.span.hi),\n+            ast::StmtKind::Item(ref item) => mk_sp(item.span().lo, self.span.hi),\n             ast::StmtKind::Expr(ref expr) | ast::StmtKind::Semi(ref expr) => {\n                 mk_sp(expr.span().lo, self.span.hi)\n             }\n-            _ => self.span,\n+            ast::StmtKind::Mac(ref mac) => {\n+                let (_, _, ref attrs) = **mac;\n+                if attrs.is_empty() {\n+                    self.span\n+                } else {\n+                    mk_sp(attrs[0].span.lo, self.span.hi)\n+                }\n+            }\n         }\n     }\n }\n@@ -155,12 +169,6 @@ impl Spanned for ast::StructField {\n     }\n }\n \n-impl Spanned for ast::Field {\n-    fn span(&self) -> Span {\n-        span_with_attrs!(self)\n-    }\n-}\n-\n impl Spanned for ast::WherePredicate {\n     fn span(&self) -> Span {\n         match *self {\n@@ -208,12 +216,6 @@ impl Spanned for ast::TyParamBound {\n     }\n }\n \n-impl Spanned for ast::ForeignItem {\n-    fn span(&self) -> Span {\n-        span_with_attrs!(self)\n-    }\n-}\n-\n #[derive(Copy, Clone, Debug)]\n pub struct Indent {\n     // Width of the block indent, in characters. Must be a multiple of"}, {"sha": "b4c4bf3553f6dde6c8b1344c35daa69302403c36", "filename": "src/visitor.rs", "status": "modified", "additions": 12, "deletions": 36, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/979d131c5d8354a80d21942bed7d78ab1e76d9f0/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=979d131c5d8354a80d21942bed7d78ab1e76d9f0", "patch": "@@ -30,7 +30,7 @@ use lists::{itemize_list, write_list, DefinitiveListTactic, ListFormatting, Sepa\n use macros::{rewrite_macro, MacroPosition};\n use regex::Regex;\n use rewrite::{Rewrite, RewriteContext};\n-use utils::{self, contains_skip, mk_sp};\n+use utils::{self, contains_skip, inner_attributes, mk_sp};\n \n fn is_use_item(item: &ast::Item) -> bool {\n     match item.node {\n@@ -73,47 +73,23 @@ impl<'a> FmtVisitor<'a> {\n             ast::StmtKind::Item(ref item) => {\n                 self.visit_item(item);\n             }\n-            ast::StmtKind::Local(ref local) => {\n-                let rewrite = if contains_skip(&local.attrs) {\n-                    None\n-                } else {\n-                    stmt.rewrite(\n-                        &self.get_context(),\n-                        Shape::indented(self.block_indent, self.config),\n-                    )\n-                };\n-                self.push_rewrite(stmt.span, rewrite);\n+            ast::StmtKind::Local(..) => {\n+                let rewrite = stmt.rewrite(&self.get_context(), self.shape());\n+                self.push_rewrite(stmt.span(), rewrite);\n             }\n             ast::StmtKind::Expr(ref expr) => {\n-                let rewrite = format_expr(\n-                    expr,\n-                    ExprType::Statement,\n-                    &self.get_context(),\n-                    Shape::indented(self.block_indent, self.config),\n-                );\n-                let span = if expr.attrs.is_empty() {\n-                    stmt.span\n-                } else {\n-                    mk_sp(expr.span().lo, stmt.span.hi)\n-                };\n-                self.push_rewrite(span, rewrite)\n+                let rewrite =\n+                    format_expr(expr, ExprType::Statement, &self.get_context(), self.shape());\n+                self.push_rewrite(stmt.span(), rewrite)\n             }\n-            ast::StmtKind::Semi(ref expr) => {\n-                let rewrite = stmt.rewrite(\n-                    &self.get_context(),\n-                    Shape::indented(self.block_indent, self.config),\n-                );\n-                let span = if expr.attrs.is_empty() {\n-                    stmt.span\n-                } else {\n-                    mk_sp(expr.span().lo, stmt.span.hi)\n-                };\n-                self.push_rewrite(span, rewrite)\n+            ast::StmtKind::Semi(..) => {\n+                let rewrite = stmt.rewrite(&self.get_context(), self.shape());\n+                self.push_rewrite(stmt.span(), rewrite)\n             }\n             ast::StmtKind::Mac(ref mac) => {\n                 let (ref mac, _macro_style, ref attrs) = **mac;\n-                if contains_skip(attrs) {\n-                    self.push_rewrite(mac.span, None);\n+                if self.visit_attrs(attrs, ast::AttrStyle::Outer) {\n+                    self.push_rewrite(stmt.span(), None);\n                 } else {\n                     self.visit_mac(mac, None, MacroPosition::Statement);\n                 }"}, {"sha": "4d23d8b79d11a898d8af470f97b4d4fb81e38053", "filename": "tests/source/attrib.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/979d131c5d8354a80d21942bed7d78ab1e76d9f0/tests%2Fsource%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/979d131c5d8354a80d21942bed7d78ab1e76d9f0/tests%2Fsource%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fattrib.rs?ref=979d131c5d8354a80d21942bed7d78ab1e76d9f0", "patch": "@@ -124,3 +124,25 @@ impl InnerAttributes() {\n mod InnerAttributes {\n     #![ this_is_an_inner_attribute ( foo ) ]\n }\n+\n+fn attributes_on_statements() {\n+    // Local\n+    # [ attr ( on ( local ) ) ]\n+    let x = 3;\n+\n+    // Item\n+    # [ attr ( on ( item ) ) ]\n+    use foo;\n+\n+    // Expr\n+    # [ attr ( on ( expr ) ) ]\n+    {}\n+\n+    // Semi\n+    # [ attr ( on ( semi ) ) ]\n+    foo();\n+\n+    // Mac\n+    # [ attr ( on ( mac ) ) ]\n+    foo!();\n+}"}, {"sha": "467d168ef4f24b5299bb16babdef7458afaf6370", "filename": "tests/target/attrib.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/979d131c5d8354a80d21942bed7d78ab1e76d9f0/tests%2Ftarget%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/979d131c5d8354a80d21942bed7d78ab1e76d9f0/tests%2Ftarget%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fattrib.rs?ref=979d131c5d8354a80d21942bed7d78ab1e76d9f0", "patch": "@@ -124,3 +124,25 @@ impl InnerAttributes() {\n mod InnerAttributes {\n     #![this_is_an_inner_attribute(foo)]\n }\n+\n+fn attributes_on_statements() {\n+    // Local\n+    #[attr(on(local))]\n+    let x = 3;\n+\n+    // Item\n+    #[attr(on(item))]\n+    use foo;\n+\n+    // Expr\n+    #[attr(on(expr))]\n+    {}\n+\n+    // Semi\n+    #[attr(on(semi))]\n+    foo();\n+\n+    // Mac\n+    #[attr(on(mac))]\n+    foo!();\n+}"}]}