{"sha": "914ae1e8490c4d6e34dc090cad30303b95d44bb7", "node_id": "C_kwDOAAsO6NoAKDkxNGFlMWU4NDkwYzRkNmUzNGRjMDkwY2FkMzAzMDNiOTVkNDRiYjc", "commit": {"author": {"name": "Elliot Bobrow", "email": "elliotgreybobrow@gmail.com", "date": "2022-02-21T22:38:22Z"}, "committer": {"name": "Elliot Bobrow", "email": "elliotgreybobrow@gmail.com", "date": "2022-02-26T17:23:29Z"}, "message": "check `use_self` in `pat`", "tree": {"sha": "7c5e9d8283af786b1e59c8d60902e38289dccc82", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7c5e9d8283af786b1e59c8d60902e38289dccc82"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/914ae1e8490c4d6e34dc090cad30303b95d44bb7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/914ae1e8490c4d6e34dc090cad30303b95d44bb7", "html_url": "https://github.com/rust-lang/rust/commit/914ae1e8490c4d6e34dc090cad30303b95d44bb7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/914ae1e8490c4d6e34dc090cad30303b95d44bb7/comments", "author": {"login": "ebobrow", "id": 77182873, "node_id": "MDQ6VXNlcjc3MTgyODcz", "avatar_url": "https://avatars.githubusercontent.com/u/77182873?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebobrow", "html_url": "https://github.com/ebobrow", "followers_url": "https://api.github.com/users/ebobrow/followers", "following_url": "https://api.github.com/users/ebobrow/following{/other_user}", "gists_url": "https://api.github.com/users/ebobrow/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebobrow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebobrow/subscriptions", "organizations_url": "https://api.github.com/users/ebobrow/orgs", "repos_url": "https://api.github.com/users/ebobrow/repos", "events_url": "https://api.github.com/users/ebobrow/events{/privacy}", "received_events_url": "https://api.github.com/users/ebobrow/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ebobrow", "id": 77182873, "node_id": "MDQ6VXNlcjc3MTgyODcz", "avatar_url": "https://avatars.githubusercontent.com/u/77182873?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebobrow", "html_url": "https://github.com/ebobrow", "followers_url": "https://api.github.com/users/ebobrow/followers", "following_url": "https://api.github.com/users/ebobrow/following{/other_user}", "gists_url": "https://api.github.com/users/ebobrow/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebobrow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebobrow/subscriptions", "organizations_url": "https://api.github.com/users/ebobrow/orgs", "repos_url": "https://api.github.com/users/ebobrow/repos", "events_url": "https://api.github.com/users/ebobrow/events{/privacy}", "received_events_url": "https://api.github.com/users/ebobrow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e605ef80f05fbaec22677e633971096675f2650", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e605ef80f05fbaec22677e633971096675f2650", "html_url": "https://github.com/rust-lang/rust/commit/9e605ef80f05fbaec22677e633971096675f2650"}], "stats": {"total": 89, "additions": 85, "deletions": 4}, "files": [{"sha": "4fa9a8ea2eca8108a8e08973fe08db5325aa7c45", "filename": "clippy_lints/src/use_self.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/914ae1e8490c4d6e34dc090cad30303b95d44bb7/clippy_lints%2Fsrc%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/914ae1e8490c4d6e34dc090cad30303b95d44bb7/clippy_lints%2Fsrc%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fuse_self.rs?ref=914ae1e8490c4d6e34dc090cad30303b95d44bb7", "patch": "@@ -9,7 +9,8 @@ use rustc_hir::{\n     def::{CtorOf, DefKind, Res},\n     def_id::LocalDefId,\n     intravisit::{walk_inf, walk_ty, Visitor},\n-    Expr, ExprKind, FnRetTy, FnSig, GenericArg, HirId, Impl, ImplItemKind, Item, ItemKind, Path, QPath, TyKind,\n+    Expr, ExprKind, FnRetTy, FnSig, GenericArg, HirId, Impl, ImplItemKind, Item, ItemKind, Pat, PatKind, Path, QPath,\n+    TyKind,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_semver::RustcVersion;\n@@ -252,6 +253,22 @@ impl<'tcx> LateLintPass<'tcx> for UseSelf {\n         }\n     }\n \n+    fn check_pat(&mut self, cx: &LateContext<'_>, pat: &Pat<'_>) {\n+        if_chain! {\n+            if !pat.span.from_expansion();\n+            if meets_msrv(self.msrv.as_ref(), &msrvs::TYPE_ALIAS_ENUM_VARIANTS);\n+            if let Some(&StackItem::Check { impl_id, .. }) = self.stack.last();\n+            if let PatKind::Path(QPath::Resolved(_, path)) = pat.kind;\n+            if !matches!(path.res, Res::SelfTy { .. } | Res::Def(DefKind::TyParam, _));\n+            if cx.typeck_results().pat_ty(pat) == cx.tcx.type_of(impl_id);\n+            if let [first, ..] = path.segments;\n+            if let Some(hir_id) = first.hir_id;\n+            then {\n+                span_lint(cx, cx.tcx.hir().span(hir_id));\n+            }\n+        }\n+    }\n+\n     extract_msrv_attr!(LateContext);\n }\n "}, {"sha": "9d216f56ae60c66b3a22df7158c40a893f424e08", "filename": "tests/ui/use_self.fixed", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/914ae1e8490c4d6e34dc090cad30303b95d44bb7/tests%2Fui%2Fuse_self.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/914ae1e8490c4d6e34dc090cad30303b95d44bb7/tests%2Fui%2Fuse_self.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.fixed?ref=914ae1e8490c4d6e34dc090cad30303b95d44bb7", "patch": "@@ -2,7 +2,7 @@\n // aux-build:proc_macro_derive.rs\n \n #![warn(clippy::use_self)]\n-#![allow(dead_code)]\n+#![allow(dead_code, unreachable_code)]\n #![allow(\n     clippy::should_implement_trait,\n     clippy::upper_case_acronyms,\n@@ -519,3 +519,26 @@ mod self_is_ty_param {\n         }\n     }\n }\n+\n+mod use_self_in_pat {\n+    enum Foo {\n+        Bar,\n+        Baz,\n+    }\n+\n+    impl Foo {\n+        fn do_stuff(self) {\n+            match self {\n+                Self::Bar => unimplemented!(),\n+                Self::Baz => unimplemented!(),\n+            }\n+            match Some(1) {\n+                Some(_) => unimplemented!(),\n+                None => unimplemented!(),\n+            }\n+            if let Self::Bar = self {\n+                unimplemented!()\n+            }\n+        }\n+    }\n+}"}, {"sha": "5f604fe25e416d93e2fafbf4883b92be539ca0ec", "filename": "tests/ui/use_self.rs", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/914ae1e8490c4d6e34dc090cad30303b95d44bb7/tests%2Fui%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/914ae1e8490c4d6e34dc090cad30303b95d44bb7/tests%2Fui%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.rs?ref=914ae1e8490c4d6e34dc090cad30303b95d44bb7", "patch": "@@ -2,7 +2,7 @@\n // aux-build:proc_macro_derive.rs\n \n #![warn(clippy::use_self)]\n-#![allow(dead_code)]\n+#![allow(dead_code, unreachable_code)]\n #![allow(\n     clippy::should_implement_trait,\n     clippy::upper_case_acronyms,\n@@ -519,3 +519,26 @@ mod self_is_ty_param {\n         }\n     }\n }\n+\n+mod use_self_in_pat {\n+    enum Foo {\n+        Bar,\n+        Baz,\n+    }\n+\n+    impl Foo {\n+        fn do_stuff(self) {\n+            match self {\n+                Foo::Bar => unimplemented!(),\n+                Foo::Baz => unimplemented!(),\n+            }\n+            match Some(1) {\n+                Some(_) => unimplemented!(),\n+                None => unimplemented!(),\n+            }\n+            if let Foo::Bar = self {\n+                unimplemented!()\n+            }\n+        }\n+    }\n+}"}, {"sha": "34d98618253a6ddcff0ab9e603896326f3a07d92", "filename": "tests/ui/use_self.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/914ae1e8490c4d6e34dc090cad30303b95d44bb7/tests%2Fui%2Fuse_self.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/914ae1e8490c4d6e34dc090cad30303b95d44bb7/tests%2Fui%2Fuse_self.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.stderr?ref=914ae1e8490c4d6e34dc090cad30303b95d44bb7", "patch": "@@ -168,5 +168,23 @@ error: unnecessary structure name repetition\n LL |             S2::new()\n    |             ^^ help: use the applicable keyword: `Self`\n \n-error: aborting due to 28 previous errors\n+error: unnecessary structure name repetition\n+  --> $DIR/use_self.rs:532:17\n+   |\n+LL |                 Foo::Bar => unimplemented!(),\n+   |                 ^^^ help: use the applicable keyword: `Self`\n+\n+error: unnecessary structure name repetition\n+  --> $DIR/use_self.rs:533:17\n+   |\n+LL |                 Foo::Baz => unimplemented!(),\n+   |                 ^^^ help: use the applicable keyword: `Self`\n+\n+error: unnecessary structure name repetition\n+  --> $DIR/use_self.rs:539:20\n+   |\n+LL |             if let Foo::Bar = self {\n+   |                    ^^^ help: use the applicable keyword: `Self`\n+\n+error: aborting due to 31 previous errors\n "}]}