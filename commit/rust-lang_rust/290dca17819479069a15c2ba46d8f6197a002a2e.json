{"sha": "290dca17819479069a15c2ba46d8f6197a002a2e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5MGRjYTE3ODE5NDc5MDY5YTE1YzJiYTQ2ZDhmNjE5N2EwMDJhMmU=", "commit": {"author": {"name": "Simon Vandel Sillesen", "email": "simon.vandel@gmail.com", "date": "2020-09-13T14:04:45Z"}, "committer": {"name": "Simon Vandel Sillesen", "email": "simon.vandel@gmail.com", "date": "2020-09-22T21:09:07Z"}, "message": "MIR pass to remove unneeded drops on types not needing drop\n\nThis is heavily dependent on MIR inlining running to actually see the drop statement", "tree": {"sha": "c84f7d9b5eebcb70d695fb6de21fc3094d7856fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c84f7d9b5eebcb70d695fb6de21fc3094d7856fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/290dca17819479069a15c2ba46d8f6197a002a2e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/290dca17819479069a15c2ba46d8f6197a002a2e", "html_url": "https://github.com/rust-lang/rust/commit/290dca17819479069a15c2ba46d8f6197a002a2e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/290dca17819479069a15c2ba46d8f6197a002a2e/comments", "author": {"login": "simonvandel", "id": 2770647, "node_id": "MDQ6VXNlcjI3NzA2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/2770647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/simonvandel", "html_url": "https://github.com/simonvandel", "followers_url": "https://api.github.com/users/simonvandel/followers", "following_url": "https://api.github.com/users/simonvandel/following{/other_user}", "gists_url": "https://api.github.com/users/simonvandel/gists{/gist_id}", "starred_url": "https://api.github.com/users/simonvandel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/simonvandel/subscriptions", "organizations_url": "https://api.github.com/users/simonvandel/orgs", "repos_url": "https://api.github.com/users/simonvandel/repos", "events_url": "https://api.github.com/users/simonvandel/events{/privacy}", "received_events_url": "https://api.github.com/users/simonvandel/received_events", "type": "User", "site_admin": false}, "committer": {"login": "simonvandel", "id": 2770647, "node_id": "MDQ6VXNlcjI3NzA2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/2770647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/simonvandel", "html_url": "https://github.com/simonvandel", "followers_url": "https://api.github.com/users/simonvandel/followers", "following_url": "https://api.github.com/users/simonvandel/following{/other_user}", "gists_url": "https://api.github.com/users/simonvandel/gists{/gist_id}", "starred_url": "https://api.github.com/users/simonvandel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/simonvandel/subscriptions", "organizations_url": "https://api.github.com/users/simonvandel/orgs", "repos_url": "https://api.github.com/users/simonvandel/repos", "events_url": "https://api.github.com/users/simonvandel/events{/privacy}", "received_events_url": "https://api.github.com/users/simonvandel/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0bc267512fc0cb49c86978192857e8187017f0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0bc267512fc0cb49c86978192857e8187017f0b", "html_url": "https://github.com/rust-lang/rust/commit/e0bc267512fc0cb49c86978192857e8187017f0b"}], "stats": {"total": 209, "additions": 209, "deletions": 0}, "files": [{"sha": "17ef98c176df2e84b788098537596c7b95a39145", "filename": "compiler/rustc_mir/src/transform/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fmod.rs?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -38,6 +38,7 @@ pub mod nrvo;\n pub mod promote_consts;\n pub mod qualify_min_const_fn;\n pub mod remove_noop_landing_pads;\n+pub mod remove_unneeded_drops;\n pub mod required_consts;\n pub mod rustc_peek;\n pub mod simplify;\n@@ -461,6 +462,7 @@ fn run_optimization_passes<'tcx>(\n \n     // The main optimizations that we do on MIR.\n     let optimizations: &[&dyn MirPass<'tcx>] = &[\n+        &remove_unneeded_drops::RemoveUnneededDrops::new(def_id),\n         &match_branches::MatchBranchSimplification,\n         // inst combine is after MatchBranchSimplification to clean up Ne(_1, false)\n         &instcombine::InstCombine,"}, {"sha": "0f023d71dd1da0802a648b0e23d6ebbf8a13e0a5", "filename": "compiler/rustc_mir/src/transform/remove_unneeded_drops.rs", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fremove_unneeded_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fremove_unneeded_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fremove_unneeded_drops.rs?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -0,0 +1,57 @@\n+//! This pass replaces a drop of a type that does not need dropping, with a goto\n+\n+use crate::transform::{MirPass, MirSource};\n+use rustc_hir::def_id::LocalDefId;\n+use rustc_middle::mir::visit::Visitor;\n+use rustc_middle::mir::*;\n+use rustc_middle::ty::TyCtxt;\n+\n+pub struct RemoveUnneededDrops {\n+    def_id: LocalDefId,\n+}\n+\n+impl RemoveUnneededDrops {\n+    pub fn new(def_id: LocalDefId) -> Self {\n+        Self { def_id }\n+    }\n+}\n+\n+impl<'tcx> MirPass<'tcx> for RemoveUnneededDrops {\n+    fn run_pass(&self, tcx: TyCtxt<'tcx>, source: MirSource<'tcx>, body: &mut Body<'tcx>) {\n+        trace!(\"Running SimplifyComparisonIntegral on {:?}\", source);\n+        let mut opt_finder = RemoveUnneededDropsOptimizationFinder {\n+            tcx,\n+            body,\n+            optimizations: vec![],\n+            def_id: self.def_id,\n+        };\n+        opt_finder.visit_body(body);\n+        for (loc, target) in opt_finder.optimizations {\n+            let terminator = body.basic_blocks_mut()[loc.block].terminator_mut();\n+            debug!(\"SUCCESS: replacing `drop` with goto({:?})\", target);\n+            terminator.kind = TerminatorKind::Goto { target };\n+        }\n+    }\n+}\n+\n+impl<'a, 'tcx> Visitor<'tcx> for RemoveUnneededDropsOptimizationFinder<'a, 'tcx> {\n+    fn visit_terminator(&mut self, terminator: &Terminator<'tcx>, location: Location) {\n+        match terminator.kind {\n+            TerminatorKind::Drop { place, target, .. } => {\n+                let ty = place.ty(self.body, self.tcx);\n+                let needs_drop = ty.ty.needs_drop(self.tcx, self.tcx.param_env(self.def_id));\n+                if !needs_drop {\n+                    self.optimizations.push((location, target));\n+                }\n+            }\n+            _ => {}\n+        }\n+        self.super_terminator(terminator, location);\n+    }\n+}\n+pub struct RemoveUnneededDropsOptimizationFinder<'a, 'tcx> {\n+    tcx: TyCtxt<'tcx>,\n+    body: &'a Body<'tcx>,\n+    optimizations: Vec<(Location, BasicBlock)>,\n+    def_id: LocalDefId,\n+}"}, {"sha": "545ad2794ee17887de7917595d7bc949503e690d", "filename": "src/test/mir-opt/remove_unneeded_drops.cannot_opt_generic.RemoveUnneededDrops.diff", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.cannot_opt_generic.RemoveUnneededDrops.diff", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.cannot_opt_generic.RemoveUnneededDrops.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.cannot_opt_generic.RemoveUnneededDrops.diff?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -0,0 +1,32 @@\n+- // MIR for `cannot_opt_generic` before RemoveUnneededDrops\n++ // MIR for `cannot_opt_generic` after RemoveUnneededDrops\n+  \n+  fn cannot_opt_generic(_1: T) -> () {\n+      debug x => _1;                       // in scope 0 at $DIR/remove_unneeded_drops.rs:19:26: 19:27\n+      let mut _0: ();                      // return place in scope 0 at $DIR/remove_unneeded_drops.rs:19:32: 19:32\n+      let _2: ();                          // in scope 0 at $DIR/remove_unneeded_drops.rs:20:5: 20:12\n+      let mut _3: T;                       // in scope 0 at $DIR/remove_unneeded_drops.rs:20:10: 20:11\n+      scope 1 {\n+          debug _x => _3;                  // in scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:20:5: 20:12\n+          StorageLive(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:20:10: 20:11\n+          _3 = move _1;                    // scope 0 at $DIR/remove_unneeded_drops.rs:20:10: 20:11\n+          _2 = const ();                   // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+          drop(_3) -> [return: bb2, unwind: bb1]; // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb1 (cleanup): {\n+          resume;                          // scope 0 at $DIR/remove_unneeded_drops.rs:19:1: 21:2\n+      }\n+  \n+      bb2: {\n+          StorageDead(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:20:11: 20:12\n+          StorageDead(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:20:12: 20:13\n+          _0 = const ();                   // scope 0 at $DIR/remove_unneeded_drops.rs:19:32: 21:2\n+          return;                          // scope 0 at $DIR/remove_unneeded_drops.rs:21:2: 21:2\n+      }\n+  }\n+  "}, {"sha": "78d65d13bd1bf5443ac24a19a3912419794bf56a", "filename": "src/test/mir-opt/remove_unneeded_drops.dont_opt.RemoveUnneededDrops.diff", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.dont_opt.RemoveUnneededDrops.diff", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.dont_opt.RemoveUnneededDrops.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.dont_opt.RemoveUnneededDrops.diff?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -0,0 +1,32 @@\n+- // MIR for `dont_opt` before RemoveUnneededDrops\n++ // MIR for `dont_opt` after RemoveUnneededDrops\n+  \n+  fn dont_opt(_1: Vec<bool>) -> () {\n+      debug x => _1;                       // in scope 0 at $DIR/remove_unneeded_drops.rs:7:13: 7:14\n+      let mut _0: ();                      // return place in scope 0 at $DIR/remove_unneeded_drops.rs:7:27: 7:27\n+      let _2: ();                          // in scope 0 at $DIR/remove_unneeded_drops.rs:8:5: 8:12\n+      let mut _3: std::vec::Vec<bool>;     // in scope 0 at $DIR/remove_unneeded_drops.rs:8:10: 8:11\n+      scope 1 {\n+          debug _x => _3;                  // in scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:8:5: 8:12\n+          StorageLive(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:8:10: 8:11\n+          _3 = move _1;                    // scope 0 at $DIR/remove_unneeded_drops.rs:8:10: 8:11\n+          _2 = const ();                   // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+          drop(_3) -> [return: bb2, unwind: bb1]; // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb1 (cleanup): {\n+          resume;                          // scope 0 at $DIR/remove_unneeded_drops.rs:7:1: 9:2\n+      }\n+  \n+      bb2: {\n+          StorageDead(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:8:11: 8:12\n+          StorageDead(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:8:12: 8:13\n+          _0 = const ();                   // scope 0 at $DIR/remove_unneeded_drops.rs:7:27: 9:2\n+          return;                          // scope 0 at $DIR/remove_unneeded_drops.rs:9:2: 9:2\n+      }\n+  }\n+  "}, {"sha": "34193ccc5c7e787c007bb5dac1fcaabff0d28dda", "filename": "src/test/mir-opt/remove_unneeded_drops.opt.RemoveUnneededDrops.diff", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.opt.RemoveUnneededDrops.diff", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.opt.RemoveUnneededDrops.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.opt.RemoveUnneededDrops.diff?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -0,0 +1,29 @@\n+- // MIR for `opt` before RemoveUnneededDrops\n++ // MIR for `opt` after RemoveUnneededDrops\n+  \n+  fn opt(_1: bool) -> () {\n+      debug x => _1;                       // in scope 0 at $DIR/remove_unneeded_drops.rs:2:8: 2:9\n+      let mut _0: ();                      // return place in scope 0 at $DIR/remove_unneeded_drops.rs:2:17: 2:17\n+      let _2: ();                          // in scope 0 at $DIR/remove_unneeded_drops.rs:3:5: 3:12\n+      let mut _3: bool;                    // in scope 0 at $DIR/remove_unneeded_drops.rs:3:10: 3:11\n+      scope 1 {\n+          debug _x => _3;                  // in scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:3:5: 3:12\n+          StorageLive(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:3:10: 3:11\n+          _3 = _1;                         // scope 0 at $DIR/remove_unneeded_drops.rs:3:10: 3:11\n+          _2 = const ();                   // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+-         drop(_3) -> bb1;                 // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n++         goto -> bb1;                     // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb1: {\n+          StorageDead(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:3:11: 3:12\n+          StorageDead(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:3:12: 3:13\n+          _0 = const ();                   // scope 0 at $DIR/remove_unneeded_drops.rs:2:17: 4:2\n+          return;                          // scope 0 at $DIR/remove_unneeded_drops.rs:4:2: 4:2\n+      }\n+  }\n+  "}, {"sha": "2e6c8c8a78a720fa7b3c036c74faf1d6ab4b3fe3", "filename": "src/test/mir-opt/remove_unneeded_drops.opt_generic_copy.RemoveUnneededDrops.diff", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.opt_generic_copy.RemoveUnneededDrops.diff", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.opt_generic_copy.RemoveUnneededDrops.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.opt_generic_copy.RemoveUnneededDrops.diff?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -0,0 +1,29 @@\n+- // MIR for `opt_generic_copy` before RemoveUnneededDrops\n++ // MIR for `opt_generic_copy` after RemoveUnneededDrops\n+  \n+  fn opt_generic_copy(_1: T) -> () {\n+      debug x => _1;                       // in scope 0 at $DIR/remove_unneeded_drops.rs:12:30: 12:31\n+      let mut _0: ();                      // return place in scope 0 at $DIR/remove_unneeded_drops.rs:12:36: 12:36\n+      let _2: ();                          // in scope 0 at $DIR/remove_unneeded_drops.rs:13:5: 13:12\n+      let mut _3: T;                       // in scope 0 at $DIR/remove_unneeded_drops.rs:13:10: 13:11\n+      scope 1 {\n+          debug _x => _3;                  // in scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:13:5: 13:12\n+          StorageLive(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:13:10: 13:11\n+          _3 = _1;                         // scope 0 at $DIR/remove_unneeded_drops.rs:13:10: 13:11\n+          _2 = const ();                   // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+-         drop(_3) -> bb1;                 // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n++         goto -> bb1;                     // scope 1 at $SRC_DIR/core/src/mem/mod.rs:LL:COL\n+      }\n+  \n+      bb1: {\n+          StorageDead(_3);                 // scope 0 at $DIR/remove_unneeded_drops.rs:13:11: 13:12\n+          StorageDead(_2);                 // scope 0 at $DIR/remove_unneeded_drops.rs:13:12: 13:13\n+          _0 = const ();                   // scope 0 at $DIR/remove_unneeded_drops.rs:12:36: 14:2\n+          return;                          // scope 0 at $DIR/remove_unneeded_drops.rs:14:2: 14:2\n+      }\n+  }\n+  "}, {"sha": "17d7e79a1eb0a4b9ee8aa4b0f05c572e443fbc4f", "filename": "src/test/mir-opt/remove_unneeded_drops.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/290dca17819479069a15c2ba46d8f6197a002a2e/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fremove_unneeded_drops.rs?ref=290dca17819479069a15c2ba46d8f6197a002a2e", "patch": "@@ -0,0 +1,28 @@\n+// EMIT_MIR remove_unneeded_drops.opt.RemoveUnneededDrops.diff\n+fn opt(x: bool) {\n+    drop(x);\n+}\n+\n+// EMIT_MIR remove_unneeded_drops.dont_opt.RemoveUnneededDrops.diff\n+fn dont_opt(x: Vec<bool>) {\n+    drop(x);\n+}\n+\n+// EMIT_MIR remove_unneeded_drops.opt_generic_copy.RemoveUnneededDrops.diff\n+fn opt_generic_copy<T: Copy>(x: T) {\n+    drop(x);\n+}\n+\n+// EMIT_MIR remove_unneeded_drops.cannot_opt_generic.RemoveUnneededDrops.diff\n+// since the pass is not running on monomorphisized code,\n+// we can't (but probably should) optimize this\n+fn cannot_opt_generic<T>(x: T) {\n+    drop(x);\n+}\n+\n+fn main() {\n+    opt(true);\n+    opt_generic_copy(42);\n+    cannot_opt_generic(42);\n+    dont_opt(vec![true]);\n+}"}]}