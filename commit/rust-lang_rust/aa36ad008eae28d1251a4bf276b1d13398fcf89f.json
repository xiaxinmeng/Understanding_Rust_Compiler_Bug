{"sha": "aa36ad008eae28d1251a4bf276b1d13398fcf89f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhMzZhZDAwOGVhZTI4ZDEyNTFhNGJmMjc2YjFkMTMzOThmY2Y4OWY=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-02-04T11:04:02Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-02-04T11:04:02Z"}, "message": "Merge #41\n\n41: G: unsafe impl & trait r=matklad a=matklad\n\nbors r+", "tree": {"sha": "838d2875f00d1d0c4b3d747dfd7c314abf9ac404", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/838d2875f00d1d0c4b3d747dfd7c314abf9ac404"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa36ad008eae28d1251a4bf276b1d13398fcf89f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa36ad008eae28d1251a4bf276b1d13398fcf89f", "html_url": "https://github.com/rust-lang/rust/commit/aa36ad008eae28d1251a4bf276b1d13398fcf89f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa36ad008eae28d1251a4bf276b1d13398fcf89f/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "5e5313a7c71d8aa873b418575f56d23b2eac6e7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e5313a7c71d8aa873b418575f56d23b2eac6e7f", "html_url": "https://github.com/rust-lang/rust/commit/5e5313a7c71d8aa873b418575f56d23b2eac6e7f"}, {"sha": "d4179550cd69a23a79ed27a96b93f9f760c02b69", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4179550cd69a23a79ed27a96b93f9f760c02b69", "html_url": "https://github.com/rust-lang/rust/commit/d4179550cd69a23a79ed27a96b93f9f760c02b69"}], "stats": {"total": 389, "additions": 228, "deletions": 161}, "files": [{"sha": "c2fcc44f5be3988da2900fe5ad899a92f7c62051", "filename": "grammar.ron", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/grammar.ron", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/grammar.ron", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/grammar.ron?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -91,6 +91,8 @@ Grammar(\n         \"USE_ITEM\",\n         \"STATIC_ITEM\",\n         \"CONST_ITEM\",\n+        \"TRAIT_ITEM\",\n+        \"IMPL_ITEM\",\n \n         \"EXTERN_BLOCK\",\n         \"ENUM_VARIANT\","}, {"sha": "fd6bdc0863c78c4940e788e4cfd91e8e7e5fdb17", "filename": "src/parser/event.rs", "status": "added", "additions": 140, "deletions": 0, "changes": 140, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fevent.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fevent.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fevent.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -0,0 +1,140 @@\n+use {File, FileBuilder, Sink, SyntaxKind, Token};\n+use syntax_kinds::TOMBSTONE;\n+use super::is_insignificant;\n+\n+/// `Parser` produces a flat list of `Event`s.\n+/// They are converted to a tree-structure in\n+/// a separate pass, via `TreeBuilder`.\n+#[derive(Debug)]\n+pub(crate) enum Event {\n+    /// This event signifies the start of the node.\n+    /// It should be either abandoned (in which case the\n+    /// `kind` is `TOMBSTONE`, and the event is ignored),\n+    /// or completed via a `Finish` event.\n+    ///\n+    /// All tokens between a `Start` and a `Finish` would\n+    /// become the children of the respective node.\n+    ///\n+    /// For left-recursive syntactic constructs, the parser produces\n+    /// a child node before it sees a parent. `forward_parent`\n+    /// exists to allow to tweak parent-child relationships.\n+    ///\n+    /// Consider this path\n+    ///\n+    /// foo::bar\n+    ///\n+    /// The events for it would look like this:\n+    ///\n+    ///\n+    /// START(PATH) IDENT('foo') FINISH START(PATH) COLONCOLON IDENT('bar') FINISH\n+    ///       |                          /\\\n+    ///       |                          |\n+    ///       +------forward-parent------+\n+    ///\n+    /// And the tree would look like this\n+    ///\n+    ///    +--PATH---------+\n+    ///    |   |           |\n+    ///    |   |           |\n+    ///    |  '::'       'bar'\n+    ///    |\n+    ///   PATH\n+    ///    |\n+    ///   'foo'\n+    ///\n+    /// See also `CompleteMarker::precede`.\n+    Start {\n+        kind: SyntaxKind,\n+        forward_parent: Option<u32>,\n+    },\n+\n+    /// Complete the previous `Start` event\n+    Finish,\n+\n+    /// Produce a single leaf-element.\n+    /// `n_raw_tokens` is used to glue complex contextual tokens.\n+    /// For example, lexer tokenizes `>>` as `>`, `>`, and\n+    /// `n_raw_tokens = 2` is used to produced a single `>>`.\n+    Token {\n+        kind: SyntaxKind,\n+        n_raw_tokens: u8,\n+    },\n+\n+    Error {\n+        message: String,\n+    },\n+}\n+\n+pub(super) fn to_file(text: String, tokens: &[Token], events: Vec<Event>) -> File {\n+    let mut builder = FileBuilder::new(text);\n+    let mut idx = 0;\n+\n+    let mut holes = Vec::new();\n+    let mut forward_parents = Vec::new();\n+\n+    for (i, event) in events.iter().enumerate() {\n+        if holes.last() == Some(&i) {\n+            holes.pop();\n+            continue;\n+        }\n+\n+        match event {\n+            &Event::Start {\n+                kind: TOMBSTONE, ..\n+            } => (),\n+\n+            &Event::Start { .. } => {\n+                forward_parents.clear();\n+                let mut idx = i;\n+                loop {\n+                    let (kind, fwd) = match events[idx] {\n+                        Event::Start {\n+                            kind,\n+                            forward_parent,\n+                        } => (kind, forward_parent),\n+                        _ => unreachable!(),\n+                    };\n+                    forward_parents.push((idx, kind));\n+                    if let Some(fwd) = fwd {\n+                        idx += fwd as usize;\n+                    } else {\n+                        break;\n+                    }\n+                }\n+                for &(idx, kind) in forward_parents.iter().into_iter().rev() {\n+                    builder.start_internal(kind);\n+                    holes.push(idx);\n+                }\n+                holes.pop();\n+            }\n+            &Event::Finish => {\n+                while idx < tokens.len() {\n+                    let token = tokens[idx];\n+                    if is_insignificant(token.kind) {\n+                        idx += 1;\n+                        builder.leaf(token.kind, token.len);\n+                    } else {\n+                        break;\n+                    }\n+                }\n+                builder.finish_internal()\n+            }\n+            &Event::Token {\n+                kind: _,\n+                mut n_raw_tokens,\n+            } => loop {\n+                let token = tokens[idx];\n+                if !is_insignificant(token.kind) {\n+                    n_raw_tokens -= 1;\n+                }\n+                idx += 1;\n+                builder.leaf(token.kind, token.len);\n+                if n_raw_tokens == 0 {\n+                    break;\n+                }\n+            },\n+            &Event::Error { ref message } => builder.error().message(message.clone()).emit(),\n+        }\n+    }\n+    builder.finish()\n+}"}, {"sha": "7823c476c200488cf38c1ff794b19a4edae7f8c2", "filename": "src/parser/event_parser/mod.rs", "status": "removed", "additions": 0, "deletions": 74, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/5e5313a7c71d8aa873b418575f56d23b2eac6e7f/src%2Fparser%2Fevent_parser%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e5313a7c71d8aa873b418575f56d23b2eac6e7f/src%2Fparser%2Fevent_parser%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fevent_parser%2Fmod.rs?ref=5e5313a7c71d8aa873b418575f56d23b2eac6e7f", "patch": "@@ -1,74 +0,0 @@\n-use {SyntaxKind, Token};\n-\n-#[macro_use]\n-mod parser;\n-mod grammar;\n-\n-/// `Parser` produces a flat list of `Event`s.\n-/// They are converted to a tree-structure in\n-/// a separate pass, via `TreeBuilder`.\n-#[derive(Debug)]\n-pub(crate) enum Event {\n-    /// This event signifies the start of the node.\n-    /// It should be either abandoned (in which case the\n-    /// `kind` is `TOMBSTONE`, and the event is ignored),\n-    /// or completed via a `Finish` event.\n-    ///\n-    /// All tokens between a `Start` and a `Finish` would\n-    /// become the children of the respective node.\n-    ///\n-    /// For left-recursive syntactic constructs, the parser produces\n-    /// a child node before it sees a parent. `forward_parent`\n-    /// exists to allow to tweak parent-child relationships.\n-    ///\n-    /// Consider this path\n-    ///\n-    /// foo::bar\n-    ///\n-    /// The events for it would look like this:\n-    ///\n-    ///\n-    /// START(PATH) IDENT('foo') FINISH START(PATH) COLONCOLON IDENT('bar') FINISH\n-    ///       |                          /\\\n-    ///       |                          |\n-    ///       +------forward-parent------+\n-    ///\n-    /// And the tree would look like this\n-    ///\n-    ///    +--PATH---------+\n-    ///    |   |           |\n-    ///    |   |           |\n-    ///    |  '::'       'bar'\n-    ///    |\n-    ///   PATH\n-    ///    |\n-    ///   'foo'\n-    ///\n-    /// See also `CompleteMarker::precede`.\n-    Start {\n-        kind: SyntaxKind,\n-        forward_parent: Option<u32>,\n-    },\n-\n-    /// Complete the previous `Start` event\n-    Finish,\n-\n-    /// Produce a single leaf-element.\n-    /// `n_raw_tokens` is used to glue complex contextual tokens.\n-    /// For example, lexer tokenizes `>>` as `>`, `>`, and\n-    /// `n_raw_tokens = 2` is used to produced a single `>>`.\n-    Token {\n-        kind: SyntaxKind,\n-        n_raw_tokens: u8,\n-    },\n-\n-    Error {\n-        message: String,\n-    },\n-}\n-\n-pub(crate) fn parse<'t>(text: &'t str, raw_tokens: &'t [Token]) -> Vec<Event> {\n-    let mut parser = parser::Parser::new(text, raw_tokens);\n-    grammar::file(&mut parser);\n-    parser.into_events()\n-}"}, {"sha": "8bf04afced1ce7df454bcf97dce6409c4d0a8559", "filename": "src/parser/grammar/attributes.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fattributes.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/attributes.rs"}, {"sha": "8caaf35538915da0a62536ac23658fa9638c7ca5", "filename": "src/parser/grammar/expressions.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fexpressions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fexpressions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fexpressions.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/expressions.rs"}, {"sha": "c9881d681aa34f70757fddfabc974b540d9d9be1", "filename": "src/parser/grammar/items/consts.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fitems%2Fconsts.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/items/consts.rs"}, {"sha": "3612802e17b9b4cc83e805b556b85a65f44673f6", "filename": "src/parser/grammar/items/mod.rs", "status": "renamed", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fitems%2Fmod.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -3,6 +3,7 @@ use super::*;\n mod structs;\n mod use_item;\n mod consts;\n+mod traits;\n \n pub(super) fn mod_contents(p: &mut Parser, stop_on_r_curly: bool) {\n     attributes::inner_attributes(p);\n@@ -80,6 +81,22 @@ fn item(p: &mut Parser) {\n                 CONST_ITEM\n             }\n         },\n+        // TODO: auto trait\n+        // test unsafe_trait\n+        // unsafe trait T {}\n+        UNSAFE_KW if la == TRAIT_KW => {\n+            p.bump();\n+            traits::trait_item(p);\n+            TRAIT_ITEM\n+        }\n+        // TODO: default impl\n+        // test unsafe_impl\n+        // unsafe impl Foo {}\n+        UNSAFE_KW if la == IMPL_KW => {\n+            p.bump();\n+            traits::impl_item(p);\n+            IMPL_ITEM\n+        }\n         MOD_KW => {\n             mod_item(p);\n             MOD_ITEM\n@@ -131,6 +148,7 @@ fn extern_block(p: &mut Parser) {\n     p.bump();\n     p.expect(R_CURLY);\n }\n+\n fn mod_item(p: &mut Parser) {\n     assert!(p.at(MOD_KW));\n     p.bump();", "previous_filename": "src/parser/event_parser/grammar/items/mod.rs"}, {"sha": "69d95c698f0ff0dbc5398b72959b31af11dd3750", "filename": "src/parser/grammar/items/structs.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fstructs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fstructs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fitems%2Fstructs.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/items/structs.rs"}, {"sha": "3bef9639f0297715d6f50501aec3e2433baefac3", "filename": "src/parser/grammar/items/traits.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fitems%2Ftraits.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -0,0 +1,17 @@\n+use super::*;\n+\n+pub(super) fn trait_item(p: &mut Parser) {\n+    assert!(p.at(TRAIT_KW));\n+    p.bump();\n+    p.expect(IDENT);\n+    p.expect(L_CURLY);\n+    p.expect(R_CURLY);\n+}\n+\n+pub(super) fn impl_item(p: &mut Parser) {\n+    assert!(p.at(IMPL_KW));\n+    p.bump();\n+    p.expect(IDENT);\n+    p.expect(L_CURLY);\n+    p.expect(R_CURLY);\n+}"}, {"sha": "38e7b3f8a521e23b90699f1d4f5718a66384cc65", "filename": "src/parser/grammar/items/use_item.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fuse_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fitems%2Fuse_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fitems%2Fuse_item.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/items/use_item.rs"}, {"sha": "afce308d0ce9e137ebc1a19184b4d68cc5e04c6e", "filename": "src/parser/grammar/mod.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fmod.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/mod.rs"}, {"sha": "6efac26103789507381095638c7f9e590446848b", "filename": "src/parser/grammar/paths.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Fpaths.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/paths.rs"}, {"sha": "12c9a53627e827f34bdd46eb80c5e09bbd383630", "filename": "src/parser/grammar/type_params.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Ftype_params.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Ftype_params.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Ftype_params.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/type_params.rs"}, {"sha": "1a3d44a0ab9ded0dd85a4639a8435360132196d2", "filename": "src/parser/grammar/types.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fgrammar%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fgrammar%2Ftypes.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "previous_filename": "src/parser/event_parser/grammar/types.rs"}, {"sha": "f17ffbf3aa394ee6071497d45df17300f487bb36", "filename": "src/parser/mod.rs", "status": "modified", "additions": 12, "deletions": 79, "changes": 91, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fmod.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -1,88 +1,21 @@\n-use {File, FileBuilder, Sink, SyntaxKind, Token};\n+use {File, SyntaxKind, Token};\n \n use syntax_kinds::*;\n \n-mod event_parser;\n-use self::event_parser::Event;\n+#[macro_use]\n+mod parser;\n+mod event;\n+mod grammar;\n+use self::event::Event;\n \n /// Parse a sequence of tokens into the representative node tree\n pub fn parse(text: String, tokens: &[Token]) -> File {\n-    let events = event_parser::parse(&text, tokens);\n-    from_events_to_file(text, tokens, events)\n-}\n-\n-fn from_events_to_file(text: String, tokens: &[Token], events: Vec<Event>) -> File {\n-    let mut builder = FileBuilder::new(text);\n-    let mut idx = 0;\n-\n-    let mut holes = Vec::new();\n-    let mut forward_parents = Vec::new();\n-\n-    for (i, event) in events.iter().enumerate() {\n-        if holes.last() == Some(&i) {\n-            holes.pop();\n-            continue;\n-        }\n-\n-        match event {\n-            &Event::Start {\n-                kind: TOMBSTONE, ..\n-            } => (),\n-\n-            &Event::Start { .. } => {\n-                forward_parents.clear();\n-                let mut idx = i;\n-                loop {\n-                    let (kind, fwd) = match events[idx] {\n-                        Event::Start {\n-                            kind,\n-                            forward_parent,\n-                        } => (kind, forward_parent),\n-                        _ => unreachable!(),\n-                    };\n-                    forward_parents.push((idx, kind));\n-                    if let Some(fwd) = fwd {\n-                        idx += fwd as usize;\n-                    } else {\n-                        break;\n-                    }\n-                }\n-                for &(idx, kind) in forward_parents.iter().into_iter().rev() {\n-                    builder.start_internal(kind);\n-                    holes.push(idx);\n-                }\n-                holes.pop();\n-            }\n-            &Event::Finish => {\n-                while idx < tokens.len() {\n-                    let token = tokens[idx];\n-                    if is_insignificant(token.kind) {\n-                        idx += 1;\n-                        builder.leaf(token.kind, token.len);\n-                    } else {\n-                        break;\n-                    }\n-                }\n-                builder.finish_internal()\n-            }\n-            &Event::Token {\n-                kind: _,\n-                mut n_raw_tokens,\n-            } => loop {\n-                let token = tokens[idx];\n-                if !is_insignificant(token.kind) {\n-                    n_raw_tokens -= 1;\n-                }\n-                idx += 1;\n-                builder.leaf(token.kind, token.len);\n-                if n_raw_tokens == 0 {\n-                    break;\n-                }\n-            },\n-            &Event::Error { ref message } => builder.error().message(message.clone()).emit(),\n-        }\n-    }\n-    builder.finish()\n+    let events = {\n+        let mut parser = parser::Parser::new(&text, tokens);\n+        grammar::file(&mut parser);\n+        parser.into_events()\n+    };\n+    event::to_file(text, tokens, events)\n }\n \n fn is_insignificant(kind: SyntaxKind) -> bool {"}, {"sha": "3f4c8a07d0c13435890c1bb8659edeb30bf2e812", "filename": "src/parser/parser.rs", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fparser%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fparser%2Fparser.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -1,6 +1,6 @@\n use {SyntaxKind, TextUnit, Token};\n use super::Event;\n-use super::super::is_insignificant;\n+use super::is_insignificant;\n use SyntaxKind::{EOF, TOMBSTONE};\n \n pub(crate) struct Marker {", "previous_filename": "src/parser/event_parser/parser.rs"}, {"sha": "22c615831556a76b79d409e7f636fd6324d0978d", "filename": "src/syntax_kinds.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fsyntax_kinds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/src%2Fsyntax_kinds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fsyntax_kinds.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -92,6 +92,8 @@ pub enum SyntaxKind {\n     USE_ITEM,\n     STATIC_ITEM,\n     CONST_ITEM,\n+    TRAIT_ITEM,\n+    IMPL_ITEM,\n     EXTERN_BLOCK,\n     ENUM_VARIANT,\n     NAMED_FIELD,\n@@ -207,6 +209,8 @@ impl SyntaxKind {\n             USE_ITEM => &SyntaxInfo { name: \"USE_ITEM\" },\n             STATIC_ITEM => &SyntaxInfo { name: \"STATIC_ITEM\" },\n             CONST_ITEM => &SyntaxInfo { name: \"CONST_ITEM\" },\n+            TRAIT_ITEM => &SyntaxInfo { name: \"TRAIT_ITEM\" },\n+            IMPL_ITEM => &SyntaxInfo { name: \"IMPL_ITEM\" },\n             EXTERN_BLOCK => &SyntaxInfo { name: \"EXTERN_BLOCK\" },\n             ENUM_VARIANT => &SyntaxInfo { name: \"ENUM_VARIANT\" },\n             NAMED_FIELD => &SyntaxInfo { name: \"NAMED_FIELD\" },"}, {"sha": "04e021550d88d4f6c75a1654127197b6fca1ed84", "filename": "tests/data/parser/inline/0007_unsafe_trait.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0007_unsafe_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0007_unsafe_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdata%2Fparser%2Finline%2F0007_unsafe_trait.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -0,0 +1 @@\n+unsafe trait T {}"}, {"sha": "d6f6a4cfa7ba5e42f790edbea80248dc1126c788", "filename": "tests/data/parser/inline/0007_unsafe_trait.txt", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0007_unsafe_trait.txt", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0007_unsafe_trait.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdata%2Fparser%2Finline%2F0007_unsafe_trait.txt?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -0,0 +1,11 @@\n+FILE@[0; 18)\n+  TRAIT_ITEM@[0; 18)\n+    UNSAFE_KW@[0; 6)\n+    WHITESPACE@[6; 7)\n+    TRAIT_KW@[7; 12)\n+    WHITESPACE@[12; 13)\n+    IDENT@[13; 14) \"T\"\n+    WHITESPACE@[14; 15)\n+    L_CURLY@[15; 16)\n+    R_CURLY@[16; 17)\n+    WHITESPACE@[17; 18)"}, {"sha": "41055f41d965443e7c5f28ea7535a4a6bb436a22", "filename": "tests/data/parser/inline/0008_unsafe_impl.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0008_unsafe_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0008_unsafe_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdata%2Fparser%2Finline%2F0008_unsafe_impl.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -0,0 +1 @@\n+unsafe impl Foo {}"}, {"sha": "a88a447cb308bcb0af1d633f6d1b017ffc34484b", "filename": "tests/data/parser/inline/0008_unsafe_impl.txt", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0008_unsafe_impl.txt", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tests%2Fdata%2Fparser%2Finline%2F0008_unsafe_impl.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdata%2Fparser%2Finline%2F0008_unsafe_impl.txt?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -0,0 +1,11 @@\n+FILE@[0; 19)\n+  IMPL_ITEM@[0; 19)\n+    UNSAFE_KW@[0; 6)\n+    WHITESPACE@[6; 7)\n+    IMPL_KW@[7; 11)\n+    WHITESPACE@[11; 12)\n+    IDENT@[12; 15) \"Foo\"\n+    WHITESPACE@[15; 16)\n+    L_CURLY@[16; 17)\n+    R_CURLY@[17; 18)\n+    WHITESPACE@[18; 19)"}, {"sha": "a52e7b1193ca30c80c30e1a1ccb80f9c9f1ad8ca", "filename": "tools/src/bin/collect-tests.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tools%2Fsrc%2Fbin%2Fcollect-tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa36ad008eae28d1251a4bf276b1d13398fcf89f/tools%2Fsrc%2Fbin%2Fcollect-tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tools%2Fsrc%2Fbin%2Fcollect-tests.rs?ref=aa36ad008eae28d1251a4bf276b1d13398fcf89f", "patch": "@@ -79,16 +79,19 @@ fn collect_tests(s: &str) -> Vec<Test> {\n         .map(str::trim_left)\n         .group_by(|line| line.starts_with(prefix));\n \n-    for (is_comment, block) in comment_blocks.into_iter() {\n+    'outer: for (is_comment, block) in comment_blocks.into_iter() {\n         if !is_comment {\n             continue;\n         }\n         let mut block = block.map(|line| &line[prefix.len()..]);\n-        let first = block.next().unwrap();\n-        if !first.starts_with(\"test \") {\n-            continue;\n-        }\n-        let name = first[\"test \".len()..].to_string();\n+\n+        let name = loop {\n+            match block.next() {\n+                Some(line) if line.starts_with(\"test \") => break line[\"test \".len()..].to_string(),\n+                Some(_) => (),\n+                None => continue 'outer,\n+            }\n+        };\n         let text: String = itertools::join(block.chain(::std::iter::once(\"\")), \"\\n\");\n         assert!(!text.trim().is_empty() && text.ends_with(\"\\n\"));\n         res.push(Test { name, text })\n@@ -121,7 +124,7 @@ fn inline_tests_dir() -> PathBuf {\n }\n \n fn grammar_dir() -> PathBuf {\n-    base_dir().join(\"src/parser/event_parser/grammar\")\n+    base_dir().join(\"src/parser/grammar\")\n }\n \n fn base_dir() -> PathBuf {"}]}