{"sha": "ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmMWE5ZTQwNmJmY2NlZmVkYjZjNGYyY2FiYzBjNGQ1OWFjOTQ3ZDQ=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-09-16T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-09-16T00:00:00Z"}, "message": "Fix underflow when calculating the number of no-op jumps folded\n\nWhen removing unwinds to no-op blocks and folding jumps to no-op blocks,\nremove the unwind target first. Otherwise we cannot determine if target\nhas been already folded or not.\n\nPrevious implementation incorrectly assumed that all resume targets had\nbeen folded already, occasionally resulting in an underflow:\n\nremove_noop_landing_pads: removed 18446744073709551613 jumps and 3 landing pads", "tree": {"sha": "064dd0eb23cbda5866929ed0b4f07e784220d4cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/064dd0eb23cbda5866929ed0b4f07e784220d4cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4", "html_url": "https://github.com/rust-lang/rust/commit/ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90b1f5ae59291dd69d72fad41a22277df19dc953", "url": "https://api.github.com/repos/rust-lang/rust/commits/90b1f5ae59291dd69d72fad41a22277df19dc953", "html_url": "https://github.com/rust-lang/rust/commit/90b1f5ae59291dd69d72fad41a22277df19dc953"}], "stats": {"total": 19, "additions": 10, "deletions": 9}, "files": [{"sha": "4079f0110e2c0c8f1c46be2b436b4f47f2695bcb", "filename": "compiler/rustc_mir/src/transform/remove_noop_landing_pads.rs", "status": "modified", "additions": 10, "deletions": 9, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fremove_noop_landing_pads.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fremove_noop_landing_pads.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fremove_noop_landing_pads.rs?ref=ff1a9e406bfccefedb6c4f2cabc0c4d59ac947d4", "patch": "@@ -102,6 +102,16 @@ impl RemoveNoopLandingPads {\n         let postorder: Vec<_> = traversal::postorder(body).map(|(bb, _)| bb).collect();\n         for bb in postorder {\n             debug!(\"  processing {:?}\", bb);\n+            if let Some(unwind) = body[bb].terminator_mut().unwind_mut() {\n+                if let Some(unwind_bb) = *unwind {\n+                    if nop_landing_pads.contains(unwind_bb) {\n+                        debug!(\"    removing noop landing pad\");\n+                        landing_pads_removed += 1;\n+                        *unwind = None;\n+                    }\n+                }\n+            }\n+\n             for target in body[bb].terminator_mut().successors_mut() {\n                 if *target != resume_block && nop_landing_pads.contains(*target) {\n                     debug!(\"    folding noop jump to {:?} to resume block\", target);\n@@ -110,15 +120,6 @@ impl RemoveNoopLandingPads {\n                 }\n             }\n \n-            if let Some(unwind) = body[bb].terminator_mut().unwind_mut() {\n-                if *unwind == Some(resume_block) {\n-                    debug!(\"    removing noop landing pad\");\n-                    jumps_folded -= 1;\n-                    landing_pads_removed += 1;\n-                    *unwind = None;\n-                }\n-            }\n-\n             let is_nop_landing_pad = self.is_nop_landing_pad(bb, body, &nop_landing_pads);\n             if is_nop_landing_pad {\n                 nop_landing_pads.insert(bb);"}]}