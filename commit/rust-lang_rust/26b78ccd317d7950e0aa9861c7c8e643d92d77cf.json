{"sha": "26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "node_id": "C_kwDOAAsO6NoAKDI2Yjc4Y2NkMzE3ZDc5NTBlMGFhOTg2MWM3YzhlNjQzZDkyZDc3Y2Y", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-10-14T06:53:20Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-10-14T07:07:34Z"}, "message": "Fix const stability", "tree": {"sha": "0aeb747d656dff753b5e3c7f43c1dd3d98693cc1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0aeb747d656dff753b5e3c7f43c1dd3d98693cc1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEQ7Fl7qPq2YcWF1dqAn35M4hird0FAmFn1zkACgkQAn35M4hi\nrd1cJw/+KHK9g+9sSdVWuVSNEoboFr+WnHR54kU4oegLZB3Fa3UvAoOAsESDIYih\nZBxg4tXqflEHO9BDeNm1GUKFy4IV9xcmgsszCEMjfPm6g5MW0vW1JNCG+xE0oalN\nN8wq/kL+c53yk3dNrcJkACw97XddjZCaULoc1vHWGbYig5vV+bcadiE8JFoQOVj0\n88RK7/kOAjJ0SQINpNsY4IlTU+4XdDKVAcP/gS2rPILFsi3BYzowS2SCfL1uCodI\nwjz4GjvYCKOmqP/TTfVqTW0qHFWrMfUJcNq4GNudkkDPVLJQwz74k/zVCWZvS5zZ\nI9EMp4IxtG7ybGFw9KrltpS44cpfyl1RMSr8AQx9T1Ls3dPtE3eqAbSK8rX+fFWg\n576RmzsVADhr4ryK205iM7rRw2yUbui+VwbfxHX1Ws7Q7kx902hLMa5tsI261Nh7\nnGLLczTF2WRSQX9R0Be2uDcG5H90HFy/+8qX5DJzRVHYsdc+D7TOayflWkcI/Ttq\nMTuidg5ESR86mhWnRHyiKHh+H+VXZaCODfjhLdJBBjWnOJq4qv9o0zujjnCF9MZx\n5Dlv/dShFXpcn9oDErDHAP5ZtusdgkZoOKTsLIsfCAKseN7EP6nYQ5+6qnICthtE\nWiwAAgW5+I0WBFnO/yvE4BYSr9LE0QLMGYKyQKGTWdxVcSfXy48=\n=k1sk\n-----END PGP SIGNATURE-----", "payload": "tree 0aeb747d656dff753b5e3c7f43c1dd3d98693cc1\nparent 6770dbd4b5729677bcca6a4c73d3335e523a7ac9\nauthor Deadbeef <ent3rm4n@gmail.com> 1634194400 +0000\ncommitter Deadbeef <ent3rm4n@gmail.com> 1634195254 +0000\n\nFix const stability\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "html_url": "https://github.com/rust-lang/rust/commit/26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6770dbd4b5729677bcca6a4c73d3335e523a7ac9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6770dbd4b5729677bcca6a4c73d3335e523a7ac9", "html_url": "https://github.com/rust-lang/rust/commit/6770dbd4b5729677bcca6a4c73d3335e523a7ac9"}], "stats": {"total": 39, "additions": 37, "deletions": 2}, "files": [{"sha": "d704c4335c7540503b371e146fb38f31aaf7465a", "filename": "compiler/rustc_const_eval/src/transform/check_consts/check.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs?ref=26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "patch": "@@ -24,7 +24,7 @@ use std::ops::Deref;\n use super::ops::{self, NonConstOp, Status};\n use super::qualifs::{self, CustomEq, HasMutInterior, NeedsNonConstDrop};\n use super::resolver::FlowSensitiveAnalysis;\n-use super::{is_lang_special_const_fn, ConstCx, Qualif};\n+use super::{is_lang_panic_fn, is_lang_special_const_fn, ConstCx, Qualif};\n use crate::const_eval::is_unstable_const_fn;\n \n // We are using `MaybeMutBorrowedLocals` as a proxy for whether an item may have been mutated\n@@ -910,7 +910,10 @@ impl Visitor<'tcx> for Checker<'mir, 'tcx> {\n                         }\n                     }\n \n-                    return;\n+                    if is_lang_panic_fn(tcx, callee) {\n+                        // run stability check on non-panic special const fns.\n+                        return;\n+                    }\n                 }\n \n                 if Some(callee) == tcx.lang_items().exchange_malloc_fn() {"}, {"sha": "886ace193c428dad394ac877eb45dbc3ddf77bf5", "filename": "library/core/src/intrinsics.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/library%2Fcore%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/library%2Fcore%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics.rs?ref=26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "patch": "@@ -2258,6 +2258,7 @@ pub unsafe fn write_bytes<T>(dst: *mut T, val: u8, count: usize) {\n     issue = \"none\",\n     reason = \"const_eval_select will never be stable\"\n )]\n+#[rustc_const_unstable(feature = \"const_eval_select\", issue = \"none\")]\n #[lang = \"const_eval_select\"]\n #[rustc_do_not_const_check]\n pub const unsafe fn const_eval_select<ARG, F, G, RET>(\n@@ -2278,6 +2279,7 @@ where\n     issue = \"none\",\n     reason = \"const_eval_select will never be stable\"\n )]\n+#[rustc_const_unstable(feature = \"const_eval_select\", issue = \"none\")]\n #[lang = \"const_eval_select_ct\"]\n pub const unsafe fn const_eval_select_ct<ARG, F, G, RET>(\n     arg: ARG,"}, {"sha": "db2462aee5922a39b8a8585d1bca85cecf384801", "filename": "src/test/ui/intrinsics/const-eval-select-stability.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/src%2Ftest%2Fui%2Fintrinsics%2Fconst-eval-select-stability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/src%2Ftest%2Fui%2Fintrinsics%2Fconst-eval-select-stability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fintrinsics%2Fconst-eval-select-stability.rs?ref=26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "patch": "@@ -0,0 +1,20 @@\n+#![feature(staged_api)]\n+#![feature(const_eval_select)]\n+#![stable(since = \"1.0\", feature = \"ui_test\")]\n+\n+use std::intrinsics::const_eval_select;\n+\n+fn log() {\n+    println!(\"HEY HEY HEY\")\n+}\n+\n+const fn nothing(){}\n+\n+#[stable(since = \"1.0\", feature = \"hey\")]\n+#[rustc_const_stable(since = \"1.0\", feature = \"const_hey\")]\n+pub const unsafe fn hey() {\n+    const_eval_select((), nothing, log);\n+    //~^ ERROR `const_eval_select` is not yet stable as a const fn\n+}\n+\n+fn main() {}"}, {"sha": "79641bbb46abe8652df00d2f1f16d21bc999d739", "filename": "src/test/ui/intrinsics/const-eval-select-stability.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/src%2Ftest%2Fui%2Fintrinsics%2Fconst-eval-select-stability.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/26b78ccd317d7950e0aa9861c7c8e643d92d77cf/src%2Ftest%2Fui%2Fintrinsics%2Fconst-eval-select-stability.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fintrinsics%2Fconst-eval-select-stability.stderr?ref=26b78ccd317d7950e0aa9861c7c8e643d92d77cf", "patch": "@@ -0,0 +1,10 @@\n+error: `const_eval_select` is not yet stable as a const fn\n+  --> $DIR/const-eval-select-stability.rs:16:5\n+   |\n+LL |     const_eval_select((), nothing, log);\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: const-stable functions can only call other const-stable functions\n+\n+error: aborting due to previous error\n+"}]}