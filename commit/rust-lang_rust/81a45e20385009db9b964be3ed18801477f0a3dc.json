{"sha": "81a45e20385009db9b964be3ed18801477f0a3dc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxYTQ1ZTIwMzg1MDA5ZGI5Yjk2NGJlM2VkMTg4MDE0NzdmMGEzZGM=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-12-19T13:11:01Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-12-19T13:11:01Z"}, "message": "miri: allocation is infallible", "tree": {"sha": "0c2da60ac4050aff9a4033af0ef38f48941eeffa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0c2da60ac4050aff9a4033af0ef38f48941eeffa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81a45e20385009db9b964be3ed18801477f0a3dc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81a45e20385009db9b964be3ed18801477f0a3dc", "html_url": "https://github.com/rust-lang/rust/commit/81a45e20385009db9b964be3ed18801477f0a3dc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81a45e20385009db9b964be3ed18801477f0a3dc/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb84844e83ee88684ef89cc02221a26abbf92530", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb84844e83ee88684ef89cc02221a26abbf92530", "html_url": "https://github.com/rust-lang/rust/commit/cb84844e83ee88684ef89cc02221a26abbf92530"}], "stats": {"total": 36, "additions": 18, "deletions": 18}, "files": [{"sha": "6e0f1c8b80c3284a3ad08141ec2b6dd5f74037be", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -187,7 +187,7 @@ fn eval_body_using_ecx<'mir, 'tcx>(\n     }\n     let layout = ecx.layout_of(mir.return_ty().subst(tcx, cid.instance.substs))?;\n     assert!(!layout.is_unsized());\n-    let ret = ecx.allocate(layout, MemoryKind::Stack)?;\n+    let ret = ecx.allocate(layout, MemoryKind::Stack);\n \n     let name = ty::tls::with(|tcx| tcx.item_path_str(cid.instance.def_id()));\n     let prom = cid.promoted.map_or(String::new(), |p| format!(\"::promoted[{:?}]\", p));\n@@ -490,8 +490,8 @@ impl<'a, 'mir, 'tcx> interpret::Machine<'a, 'mir, 'tcx>\n         _ecx: &mut EvalContext<'a, 'mir, 'tcx, Self>,\n         ptr: Pointer,\n         _kind: MemoryKind<Self::MemoryKinds>,\n-    ) -> EvalResult<'tcx, Pointer> {\n-        Ok(ptr)\n+    ) -> Pointer {\n+        ptr\n     }\n \n     #[inline(always)]"}, {"sha": "74b633d67956e0c57d15bbf04b18da46e80f14ab", "filename": "src/librustc_mir/interpret/machine.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fmachine.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -185,7 +185,7 @@ pub trait Machine<'a, 'mir, 'tcx>: Sized {\n         ecx: &mut EvalContext<'a, 'mir, 'tcx, Self>,\n         ptr: Pointer,\n         kind: MemoryKind<Self::MemoryKinds>,\n-    ) -> EvalResult<'tcx, Pointer<Self::PointerTag>>;\n+    ) -> Pointer<Self::PointerTag>;\n \n     /// Executed when evaluating the `*` operator: Following a reference.\n     /// This has the chance to adjust the tag.  It should not change anything else!"}, {"sha": "ddecdd44347f6b66e94d323395537b91c7dfbe06", "filename": "src/librustc_mir/interpret/memory.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Fmemory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Fmemory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fmemory.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -131,20 +131,20 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> Memory<'a, 'mir, 'tcx, M> {\n         &mut self,\n         alloc: Allocation<M::PointerTag, M::AllocExtra>,\n         kind: MemoryKind<M::MemoryKinds>,\n-    ) -> EvalResult<'tcx, AllocId> {\n+    ) -> AllocId {\n         let id = self.tcx.alloc_map.lock().reserve();\n         self.alloc_map.insert(id, (kind, alloc));\n-        Ok(id)\n+        id\n     }\n \n     pub fn allocate(\n         &mut self,\n         size: Size,\n         align: Align,\n         kind: MemoryKind<M::MemoryKinds>,\n-    ) -> EvalResult<'tcx, Pointer> {\n+    ) -> Pointer {\n         let extra = AllocationExtra::memory_allocated(size, &self.extra);\n-        Ok(Pointer::from(self.allocate_with(Allocation::undef(size, align, extra), kind)?))\n+        Pointer::from(self.allocate_with(Allocation::undef(size, align, extra), kind))\n     }\n \n     pub fn reallocate(\n@@ -162,7 +162,7 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> Memory<'a, 'mir, 'tcx, M> {\n \n         // For simplicities' sake, we implement reallocate as \"alloc, copy, dealloc\".\n         // This happens so rarely, the perf advantage is outweighed by the maintenance cost.\n-        let new_ptr = self.allocate(new_size, new_align, kind)?;\n+        let new_ptr = self.allocate(new_size, new_align, kind);\n         self.copy(\n             ptr.into(),\n             old_align,"}, {"sha": "7143d66ad9246ef190a233d6de9cd24815f620af", "filename": "src/librustc_mir/interpret/operand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Foperand.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -382,7 +382,7 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n             _ => {\n                 trace!(\"Forcing allocation for local of type {:?}\", layout.ty);\n                 Operand::Indirect(\n-                    *self.allocate(layout, MemoryKind::Stack)?\n+                    *self.allocate(layout, MemoryKind::Stack)\n                 )\n             }\n         })"}, {"sha": "e316b54f8ca7da77424243e9f7e51e20cf04b3ae", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -911,7 +911,7 @@ where\n                         // that might e.g., be an inner field of a struct with `Scalar` layout,\n                         // that has different alignment than the outer field.\n                         let local_layout = self.layout_of_local(&self.stack[frame], local)?;\n-                        let ptr = self.allocate(local_layout, MemoryKind::Stack)?;\n+                        let ptr = self.allocate(local_layout, MemoryKind::Stack);\n                         // We don't have to validate as we can assume the local\n                         // was already valid for its type.\n                         self.write_immediate_to_mplace_no_validate(value, ptr)?;\n@@ -933,15 +933,15 @@ where\n         &mut self,\n         layout: TyLayout<'tcx>,\n         kind: MemoryKind<M::MemoryKinds>,\n-    ) -> EvalResult<'tcx, MPlaceTy<'tcx, M::PointerTag>> {\n+    ) -> MPlaceTy<'tcx, M::PointerTag> {\n         if layout.is_unsized() {\n             assert!(self.tcx.features().unsized_locals, \"cannot alloc memory for unsized type\");\n             // FIXME: What should we do here? We should definitely also tag!\n-            Ok(MPlaceTy::dangling(layout, self))\n+            MPlaceTy::dangling(layout, self)\n         } else {\n-            let ptr = self.memory.allocate(layout.size, layout.align.abi, kind)?;\n-            let ptr = M::tag_new_allocation(self, ptr, kind)?;\n-            Ok(MPlaceTy::from_aligned_ptr(ptr, layout))\n+            let ptr = self.memory.allocate(layout.size, layout.align.abi, kind);\n+            let ptr = M::tag_new_allocation(self, ptr, kind);\n+            MPlaceTy::from_aligned_ptr(ptr, layout)\n         }\n     }\n "}, {"sha": "22936a9b0a0cf795769068998c09ecb6d7968c68", "filename": "src/librustc_mir/interpret/traits.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Finterpret%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Ftraits.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -54,7 +54,7 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n             ptr_size * (3 + methods.len() as u64),\n             ptr_align,\n             MemoryKind::Vtable,\n-        )?.with_default_tag();\n+        ).with_default_tag();\n         let tcx = &*self.tcx;\n \n         let drop = ::monomorphize::resolve_drop_in_place(*tcx, ty);"}, {"sha": "cfa899eb5a62a11410e9d34b831bcca263e7eaa2", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81a45e20385009db9b964be3ed18801477f0a3dc/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=81a45e20385009db9b964be3ed18801477f0a3dc", "patch": "@@ -346,7 +346,7 @@ impl<'a, 'mir, 'tcx> ConstPropagator<'a, 'mir, 'tcx> {\n             Rvalue::Cast(kind, ref operand, _) => {\n                 let (op, span) = self.eval_operand(operand, source_info)?;\n                 self.use_ecx(source_info, |this| {\n-                    let dest = this.ecx.allocate(place_layout, MemoryKind::Stack)?;\n+                    let dest = this.ecx.allocate(place_layout, MemoryKind::Stack);\n                     this.ecx.cast(op, kind, dest.into())?;\n                     Ok((dest.into(), span))\n                 })"}]}