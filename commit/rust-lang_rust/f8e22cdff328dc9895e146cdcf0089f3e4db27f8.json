{"sha": "f8e22cdff328dc9895e146cdcf0089f3e4db27f8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4ZTIyY2RmZjMyOGRjOTg5NWUxNDZjZGNmMDA4OWYzZTRkYjI3Zjg=", "commit": {"author": {"name": "Rafael \u00c1vila de Esp\u00edndola", "email": "respindola@mozilla.com", "date": "2011-04-08T17:54:48Z"}, "committer": {"name": "Rafael \u00c1vila de Esp\u00edndola", "email": "respindola@mozilla.com", "date": "2011-04-08T18:25:18Z"}, "message": "Gold is more strict about --whole-archive and will report duplicated\nsymbols because of an Object.o in a .a and one outside. A similar\nproblem happens for the non-shared part of libpthread.\n\nThis patch moves the -whole-archive/-no-whole-archive to include just the\nllvm libs.", "tree": {"sha": "efcc5554072e2974bcd00eda7f1d8cb929dba858", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/efcc5554072e2974bcd00eda7f1d8cb929dba858"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f8e22cdff328dc9895e146cdcf0089f3e4db27f8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f8e22cdff328dc9895e146cdcf0089f3e4db27f8", "html_url": "https://github.com/rust-lang/rust/commit/f8e22cdff328dc9895e146cdcf0089f3e4db27f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f8e22cdff328dc9895e146cdcf0089f3e4db27f8/comments", "author": null, "committer": null, "parents": [{"sha": "97d0f76c633b3e3f73bed79096e24b320ee6dbaf", "url": "https://api.github.com/repos/rust-lang/rust/commits/97d0f76c633b3e3f73bed79096e24b320ee6dbaf", "html_url": "https://github.com/rust-lang/rust/commit/97d0f76c633b3e3f73bed79096e24b320ee6dbaf"}], "stats": {"total": 17, "additions": 13, "deletions": 4}, "files": [{"sha": "a9d79182723533c22c693c82339dd71fabe86524", "filename": "Makefile.in", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/f8e22cdff328dc9895e146cdcf0089f3e4db27f8/Makefile.in", "raw_url": "https://github.com/rust-lang/rust/raw/f8e22cdff328dc9895e146cdcf0089f3e4db27f8/Makefile.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Makefile.in?ref=f8e22cdff328dc9895e146cdcf0089f3e4db27f8", "patch": "@@ -38,7 +38,8 @@ ifeq ($(CFG_OSTYPE), Linux)\n   CFG_LIB_NAME=lib$(1).so\n   CFG_GCC_CFLAGS += -fPIC -march=i686 -O2\n   CFG_GCC_LINK_FLAGS += -shared -fPIC -ldl -lpthread -lrt\n-  CFG_GCC_DEF_FLAG := -Wl,-whole-archive,--export-dynamic,--dynamic-list=\n+  CFG_GCC_DEF_FLAG := -Wl,--export-dynamic,--dynamic-list=\n+  CFG_GCC_PRE_LIB_FLAGS := -Wl,-whole-archive\n   CFG_GCC_POST_LIB_FLAGS := -Wl,-no-whole-archive\n   ifeq ($(CFG_CPUTYPE), x86_64)\n     CFG_GCC_CFLAGS += -m32\n@@ -417,11 +418,19 @@ rt/$(CFG_RUNTIME): $(RUNTIME_OBJS) $(MKFILES) $(RUNTIME_HDR) $(RUNTIME_DEF)\n \t@$(call E, link: $@)\n \t$(Q)$(call CFG_LINK_C,$@,$(RUNTIME_LIBS) $(RUNTIME_OBJS),$(RUNTIME_DEF))\n \n-rustllvm/$(CFG_RUSTLLVM): $(RUSTLLVM_OBJS) $(MKFILES) $(RUSTLLVM_HDR) \\\n+# FIXME: Building a .a is a hack so that we build with both older and newer\n+# versions of LLVM. In newer versions some of the bits of this library are\n+# already in LLVM itself, so they are skipped.\n+rustllvm/rustllvmbits.a: $(RUSTLLVM_OBJS)\n+\trm -f $@\n+\tar crs $@ $^\n+\n+rustllvm/$(CFG_RUSTLLVM): rustllvm/rustllvmbits.a $(MKFILES) $(RUSTLLVM_HDR) \\\n                           $(RUSTLLVM_DEF)\n \t@$(call E, link: $@)\n-\t$(Q)$(call CFG_LINK_C,$@,$(RUSTLLVM_LIBS) $(RUSTLLVM_OBJS) \\\n-          $(CFG_LLVM_LIBS) $(CFG_LLVM_LDFLAGS),$(RUSTLLVM_DEF))\n+\t$(Q)$(call CFG_LINK_C,$@,$(RUSTLLVM_LIBS) rustllvm/rustllvmbits.a \\\n+          $(CFG_GCC_PRE_LIB_FLAGS) $(CFG_LLVM_LIBS) \\\n+          $(CFG_GCC_POST_LIB_FLAGS) $(CFG_LLVM_LDFLAGS),$(RUSTLLVM_DEF))\n \n ifdef CFG_BOOT_NATIVE\n boot/rustboot$(X): $(BOOT_CMXS) $(MKFILES)"}]}