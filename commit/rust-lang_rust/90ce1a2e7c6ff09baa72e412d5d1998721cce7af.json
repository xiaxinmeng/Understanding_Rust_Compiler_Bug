{"sha": "90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "node_id": "C_kwDOAAsO6NoAKDkwY2UxYTJlN2M2ZmYwOWJhYTcyZTQxMmQ1ZDE5OTg3MjFjY2U3YWY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-08T16:29:02Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-08T16:29:02Z"}, "message": "Auto merge of #10761 - lochetti:fix_9871, r=Manishearth\n\nIgnore `borrow_deref_ref` warnings in code from procedural macros.\n\nDon't linting `borrow_deref_ref` if code was generated by procedural macro.\n\nThis PR fixes https://github.com/rust-lang/rust-clippy/issues/8971\n\nchangelog: [`borrow_deref_ref`] avoiding warnings in macro-generated code", "tree": {"sha": "5a93dd0b29e9205c0adffdacee29da1920b6638c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5a93dd0b29e9205c0adffdacee29da1920b6638c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "html_url": "https://github.com/rust-lang/rust/commit/90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e66488a66917d2741ff7a862fb2cdbb38ab4015e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e66488a66917d2741ff7a862fb2cdbb38ab4015e", "html_url": "https://github.com/rust-lang/rust/commit/e66488a66917d2741ff7a862fb2cdbb38ab4015e"}, {"sha": "394b4c1906ed8eb0484f70a7697b452dbb8fa483", "url": "https://api.github.com/repos/rust-lang/rust/commits/394b4c1906ed8eb0484f70a7697b452dbb8fa483", "html_url": "https://github.com/rust-lang/rust/commit/394b4c1906ed8eb0484f70a7697b452dbb8fa483"}], "stats": {"total": 42, "additions": 37, "deletions": 5}, "files": [{"sha": "814108ed8a7c2b1ef60c4e9888b7dc26ebae757d", "filename": "clippy_lints/src/borrow_deref_ref.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/clippy_lints%2Fsrc%2Fborrow_deref_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/clippy_lints%2Fsrc%2Fborrow_deref_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fborrow_deref_ref.rs?ref=90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "patch": "@@ -1,5 +1,6 @@\n use crate::reference::DEREF_ADDROF;\n use clippy_utils::diagnostics::span_lint_and_then;\n+use clippy_utils::is_from_proc_macro;\n use clippy_utils::source::snippet_opt;\n use clippy_utils::ty::implements_trait;\n use clippy_utils::{get_parent_expr, is_lint_allowed};\n@@ -47,8 +48,8 @@ declare_clippy_lint! {\n \n declare_lint_pass!(BorrowDerefRef => [BORROW_DEREF_REF]);\n \n-impl LateLintPass<'_> for BorrowDerefRef {\n-    fn check_expr(&mut self, cx: &LateContext<'_>, e: &rustc_hir::Expr<'_>) {\n+impl<'tcx> LateLintPass<'tcx> for BorrowDerefRef {\n+    fn check_expr(&mut self, cx: &LateContext<'tcx>, e: &rustc_hir::Expr<'tcx>) {\n         if_chain! {\n             if !e.span.from_expansion();\n             if let ExprKind::AddrOf(_, Mutability::Not, addrof_target) = e.kind;\n@@ -58,6 +59,7 @@ impl LateLintPass<'_> for BorrowDerefRef {\n             if !matches!(deref_target.kind, ExprKind::Unary(UnOp::Deref, ..) );\n             let ref_ty = cx.typeck_results().expr_ty(deref_target);\n             if let ty::Ref(_, inner_ty, Mutability::Not) = ref_ty.kind();\n+            if !is_from_proc_macro(cx, e);\n             then{\n \n                 if let Some(parent_expr) = get_parent_expr(cx, e){"}, {"sha": "755264617920eb5385523b0e93a5bb918f3a3e6c", "filename": "tests/ui/borrow_deref_ref.fixed", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/tests%2Fui%2Fborrow_deref_ref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/tests%2Fui%2Fborrow_deref_ref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrow_deref_ref.fixed?ref=90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "patch": "@@ -1,7 +1,11 @@\n //@run-rustfix\n+//@aux-build: proc_macros.rs\n \n #![allow(dead_code, unused_variables)]\n \n+extern crate proc_macros;\n+use proc_macros::with_span;\n+\n fn main() {}\n \n mod should_lint {\n@@ -47,6 +51,17 @@ mod should_not_lint2 {\n     }\n }\n \n+with_span!(\n+    span\n+\n+    fn just_returning(x: &u32) -> &u32 {\n+        x\n+    }\n+\n+    fn dont_lint_proc_macro() {\n+        let a = &mut &*just_returning(&12);\n+    }\n+);\n // this mod explains why we should not lint `& &* (&T)`\n mod false_negative {\n     fn foo() {"}, {"sha": "e319d365f7e77f283ca9e43f3f8989c75cd35138", "filename": "tests/ui/borrow_deref_ref.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/tests%2Fui%2Fborrow_deref_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/tests%2Fui%2Fborrow_deref_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrow_deref_ref.rs?ref=90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "patch": "@@ -1,7 +1,11 @@\n //@run-rustfix\n+//@aux-build: proc_macros.rs\n \n #![allow(dead_code, unused_variables)]\n \n+extern crate proc_macros;\n+use proc_macros::with_span;\n+\n fn main() {}\n \n mod should_lint {\n@@ -47,6 +51,17 @@ mod should_not_lint2 {\n     }\n }\n \n+with_span!(\n+    span\n+\n+    fn just_returning(x: &u32) -> &u32 {\n+        x\n+    }\n+\n+    fn dont_lint_proc_macro() {\n+        let a = &mut &*just_returning(&12);\n+    }\n+);\n // this mod explains why we should not lint `& &* (&T)`\n mod false_negative {\n     fn foo() {"}, {"sha": "1e47cda6796019d05627f364a9fc2a78f5b623d6", "filename": "tests/ui/borrow_deref_ref.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/tests%2Fui%2Fborrow_deref_ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/90ce1a2e7c6ff09baa72e412d5d1998721cce7af/tests%2Fui%2Fborrow_deref_ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrow_deref_ref.stderr?ref=90ce1a2e7c6ff09baa72e412d5d1998721cce7af", "patch": "@@ -1,19 +1,19 @@\n error: deref on an immutable reference\n-  --> $DIR/borrow_deref_ref.rs:10:17\n+  --> $DIR/borrow_deref_ref.rs:14:17\n    |\n LL |         let b = &*a;\n    |                 ^^^ help: if you would like to reborrow, try removing `&*`: `a`\n    |\n    = note: `-D clippy::borrow-deref-ref` implied by `-D warnings`\n \n error: deref on an immutable reference\n-  --> $DIR/borrow_deref_ref.rs:12:22\n+  --> $DIR/borrow_deref_ref.rs:16:22\n    |\n LL |         let b = &mut &*bar(&12);\n    |                      ^^^^^^^^^^ help: if you would like to reborrow, try removing `&*`: `bar(&12)`\n \n error: deref on an immutable reference\n-  --> $DIR/borrow_deref_ref.rs:55:23\n+  --> $DIR/borrow_deref_ref.rs:70:23\n    |\n LL |         let addr_y = &&*x as *const _ as usize; // assert ok\n    |                       ^^^ help: if you would like to reborrow, try removing `&*`: `x`"}]}