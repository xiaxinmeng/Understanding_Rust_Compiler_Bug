{"sha": "6adb9cb53f5d3ee899398603c6de628ec55f99fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhZGI5Y2I1M2Y1ZDNlZTg5OTM5ODYwM2M2ZGU2MjhlYzU1Zjk5ZmU=", "commit": {"author": {"name": "Taylor Cramer", "email": "cramertj@cs.washington.edu", "date": "2016-03-24T22:48:38Z"}, "committer": {"name": "Taylor Cramer", "email": "cramertj@cs.washington.edu", "date": "2016-03-24T22:48:38Z"}, "message": "Added crosspointer transmute error and tests", "tree": {"sha": "a146d30525d71f98f906d3ce3f0dbd80c5f2e241", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a146d30525d71f98f906d3ce3f0dbd80c5f2e241"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6adb9cb53f5d3ee899398603c6de628ec55f99fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6adb9cb53f5d3ee899398603c6de628ec55f99fe", "html_url": "https://github.com/rust-lang/rust/commit/6adb9cb53f5d3ee899398603c6de628ec55f99fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6adb9cb53f5d3ee899398603c6de628ec55f99fe/comments", "author": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e65493599d631f5be0fbc882974153bf85a5ad6", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e65493599d631f5be0fbc882974153bf85a5ad6", "html_url": "https://github.com/rust-lang/rust/commit/7e65493599d631f5be0fbc882974153bf85a5ad6"}], "stats": {"total": 91, "additions": 89, "deletions": 2}, "files": [{"sha": "8a4a84f5ddee84caa79ade439579f6e0a3dda1e9", "filename": "src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6adb9cb53f5d3ee899398603c6de628ec55f99fe/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6adb9cb53f5d3ee899398603c6de628ec55f99fe/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=6adb9cb53f5d3ee899398603c6de628ec55f99fe", "patch": "@@ -195,6 +195,7 @@ pub fn plugin_registrar(reg: &mut Registry) {\n     reg.register_late_lint_pass(box no_effect::NoEffectPass);\n     reg.register_late_lint_pass(box map_clone::MapClonePass);\n     reg.register_late_lint_pass(box temporary_assignment::TemporaryAssignmentPass);\n+    reg.register_late_lint_pass(box transmute::CrosspointerTransmute);\n     reg.register_late_lint_pass(box transmute::UselessTransmute);\n     reg.register_late_lint_pass(box cyclomatic_complexity::CyclomaticComplexity::new(conf.cyclomatic_complexity_threshold));\n     reg.register_late_lint_pass(box escape::EscapePass);\n@@ -350,6 +351,7 @@ pub fn plugin_registrar(reg: &mut Registry) {\n         swap::ALMOST_SWAPPED,\n         swap::MANUAL_SWAP,\n         temporary_assignment::TEMPORARY_ASSIGNMENT,\n+        transmute::CROSSPOINTER_TRANSMUTE,\n         transmute::USELESS_TRANSMUTE,\n         types::ABSURD_EXTREME_COMPARISONS,\n         types::BOX_VEC,"}, {"sha": "daefbaf07ad445e057590c508046e9d190970251", "filename": "src/transmute.rs", "status": "modified", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/6adb9cb53f5d3ee899398603c6de628ec55f99fe/src%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6adb9cb53f5d3ee899398603c6de628ec55f99fe/src%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftransmute.rs?ref=6adb9cb53f5d3ee899398603c6de628ec55f99fe", "patch": "@@ -1,5 +1,7 @@\n use rustc::lint::*;\n use rustc_front::hir::*;\n+use rustc::middle::ty::TyS;\n+use rustc::middle::ty::TypeVariants::TyRawPtr;\n use utils;\n \n /// **What it does:** This lint checks for transmutes to the original type of the object.\n@@ -15,6 +17,19 @@ declare_lint! {\n     \"transmutes that have the same to and from types\"\n }\n \n+/// **What it does:*** This lint checks for transmutes between a type T and *T.\n+///\n+/// **Why is this bad?** It's easy to mistakenly transmute between a type and a pointer to that type.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:** `core::intrinsics::transmute(t)` where the result type is the same as `*t` or `&t`'s.\n+declare_lint! {\n+    pub CROSSPOINTER_TRANSMUTE,\n+    Warn,\n+    \"transmutes that have to or from types that are a pointer to the other\"\n+}\n+\n pub struct UselessTransmute;\n \n impl LintPass for UselessTransmute {\n@@ -43,3 +58,46 @@ impl LateLintPass for UselessTransmute {\n         }\n     }\n }\n+\n+pub struct CrosspointerTransmute;\n+\n+impl LintPass for CrosspointerTransmute {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(CROSSPOINTER_TRANSMUTE)\n+    }\n+}\n+\n+fn is_ptr_to(from: &TyS, to: &TyS) -> bool {\n+    if let TyRawPtr(from_ptr) = from.sty {\n+        from_ptr.ty == to\n+    } else {\n+        false\n+    }\n+}\n+\n+impl LateLintPass for CrosspointerTransmute {\n+    fn check_expr(&mut self, cx: &LateContext, e: &Expr) {\n+        if let ExprCall(ref path_expr, ref args) = e.node {\n+            if let ExprPath(None, _) = path_expr.node {\n+                let def_id = cx.tcx.def_map.borrow()[&path_expr.id].def_id();\n+\n+                if utils::match_def_path(cx, def_id, &[\"core\", \"intrinsics\", \"transmute\"]) {\n+                    let from_ty = cx.tcx.expr_ty(&args[0]);\n+                    let to_ty = cx.tcx.expr_ty(e);\n+\n+                    if is_ptr_to(to_ty, from_ty) {\n+                        cx.span_lint(CROSSPOINTER_TRANSMUTE,\n+                                     e.span,\n+                                     &format!(\"transmute from a type (`{}`) to a pointer to that type (`{}`)\", from_ty, to_ty));\n+                    }\n+\n+                    if is_ptr_to(from_ty, to_ty) {\n+                        cx.span_lint(CROSSPOINTER_TRANSMUTE,\n+                                     e.span,\n+                                     &format!(\"transmute from a type (`{}`) to the type that it points to (`{}`)\", from_ty, to_ty));\n+                    }\n+                }\n+            }\n+        }\n+    }\n+}"}, {"sha": "b875500808666a14dfb36865dfa8a769df096595", "filename": "tests/compile-fail/transmute.rs", "status": "modified", "additions": 29, "deletions": 2, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/6adb9cb53f5d3ee899398603c6de628ec55f99fe/tests%2Fcompile-fail%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6adb9cb53f5d3ee899398603c6de628ec55f99fe/tests%2Fcompile-fail%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Ftransmute.rs?ref=6adb9cb53f5d3ee899398603c6de628ec55f99fe", "patch": "@@ -1,6 +1,5 @@\n #![feature(plugin)]\n #![plugin(clippy)]\n-#![deny(useless_transmute)]\n \n extern crate core;\n \n@@ -12,14 +11,16 @@ fn my_vec() -> MyVec<i32> {\n }\n \n #[allow(needless_lifetimes)]\n+#[deny(useless_transmute)]\n unsafe fn _generic<'a, T, U: 'a>(t: &'a T) {\n     let _: &'a T = core::intrinsics::transmute(t);\n     //~^ ERROR transmute from a type (`&'a T`) to itself\n \n     let _: &'a U = core::intrinsics::transmute(t);\n }\n \n-fn main() {\n+#[deny(useless_transmute)]\n+fn useless() {\n     unsafe {\n         let _: Vec<i32> = core::intrinsics::transmute(my_vec());\n         //~^ ERROR transmute from a type (`collections::vec::Vec<i32>`) to itself\n@@ -43,3 +44,29 @@ fn main() {\n         let _: Vec<u32> = my_transmute(my_vec());\n     }\n }\n+\n+#[deny(crosspointer_transmute)]\n+fn crosspointer() {\n+    let mut vec: Vec<i32> = vec![];\n+    let vec_const_ptr: *const Vec<i32> = &vec as *const Vec<i32>;\n+    let vec_mut_ptr: *mut Vec<i32> = &mut vec as *mut Vec<i32>;\n+\n+    unsafe {\n+        let _: Vec<i32> = core::intrinsics::transmute(vec_const_ptr);\n+        //~^ ERROR transmute from a type (`*const collections::vec::Vec<i32>`) to the type that it points to (`collections::vec::Vec<i32>`)\n+\n+        let _: Vec<i32> = core::intrinsics::transmute(vec_mut_ptr);\n+        //~^ ERROR transmute from a type (`*mut collections::vec::Vec<i32>`) to the type that it points to (`collections::vec::Vec<i32>`)\n+\n+        let _: *const Vec<i32> = core::intrinsics::transmute(my_vec());\n+        //~^ ERROR transmute from a type (`collections::vec::Vec<i32>`) to a pointer to that type (`*const collections::vec::Vec<i32>`)\n+\n+        let _: *mut Vec<i32> = core::intrinsics::transmute(my_vec());\n+        //~^ ERROR transmute from a type (`collections::vec::Vec<i32>`) to a pointer to that type (`*mut collections::vec::Vec<i32>`)\n+    }\n+}\n+\n+fn main() {\n+    useless();\n+    crosspointer();\n+}"}]}