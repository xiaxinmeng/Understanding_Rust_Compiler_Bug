{"sha": "6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "node_id": "C_kwDOAAsO6NoAKDZkODE5YTRiOGY0NWIxNzBlN2MyYzQxNWRmMjBjZmEyZTBjYmJmN2Y", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-18T05:58:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-18T05:58:41Z"}, "message": "Auto merge of #106476 - keith:ks/add-sanitizer-support-for-modern-ios-platforms, r=badboy\n\nAdd sanitizer support for modern iOS platforms\n\nasan and tsan generally support iOS, but that previously wasn't configured in rust. This only adds support for the simulator architectures, and arm64 device architecture, not the older 32 bit architectures.", "tree": {"sha": "51050f2b2613d6978ba0262da752418325f3615e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/51050f2b2613d6978ba0262da752418325f3615e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "html_url": "https://github.com/rust-lang/rust/commit/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fabfd1fd931a302c0fceb60213534252883a6743", "url": "https://api.github.com/repos/rust-lang/rust/commits/fabfd1fd931a302c0fceb60213534252883a6743", "html_url": "https://github.com/rust-lang/rust/commit/fabfd1fd931a302c0fceb60213534252883a6743"}, {"sha": "aacf3213b142f074999429eab767ef7b53c3a1a5", "url": "https://api.github.com/repos/rust-lang/rust/commits/aacf3213b142f074999429eab767ef7b53c3a1a5", "html_url": "https://github.com/rust-lang/rust/commit/aacf3213b142f074999429eab767ef7b53c3a1a5"}], "stats": {"total": 59, "additions": 49, "deletions": 10}, "files": [{"sha": "e9edfd2877b866a19bba2b32623643ce8dc446ec", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios.rs?ref=6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "patch": "@@ -1,8 +1,11 @@\n use super::apple_base::{ios_llvm_target, opts, Arch};\n-use crate::spec::{FramePointer, Target, TargetOptions};\n+use crate::spec::{FramePointer, SanitizerSet, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let arch = Arch::Arm64;\n+    let mut base = opts(\"ios\", arch);\n+    base.supported_sanitizers = SanitizerSet::ADDRESS | SanitizerSet::THREAD;\n+\n     Target {\n         // Clang automatically chooses a more specific target based on\n         // IPHONEOS_DEPLOYMENT_TARGET.\n@@ -28,7 +31,7 @@ pub fn target() -> Target {\n                 darwinpcs\\0\\\n                 -Os\\0\"\n                 .into(),\n-            ..opts(\"ios\", arch)\n+            ..base\n         },\n     }\n }"}, {"sha": "6e2d62b6e085570415b20c19c236484122f1735a", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios_sim.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs?ref=6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "patch": "@@ -1,8 +1,11 @@\n use super::apple_base::{ios_sim_llvm_target, opts, Arch};\n-use crate::spec::{FramePointer, Target, TargetOptions};\n+use crate::spec::{FramePointer, SanitizerSet, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let arch = Arch::Arm64_sim;\n+    let mut base = opts(\"ios\", arch);\n+    base.supported_sanitizers = SanitizerSet::ADDRESS | SanitizerSet::THREAD;\n+\n     Target {\n         // Clang automatically chooses a more specific target based on\n         // IPHONEOS_DEPLOYMENT_TARGET.\n@@ -28,7 +31,7 @@ pub fn target() -> Target {\n                 darwinpcs\\0\\\n                 -Os\\0\"\n                 .into(),\n-            ..opts(\"ios\", arch)\n+            ..base\n         },\n     }\n }"}, {"sha": "1dcb47056a463b335010c81b56116102ecb06e04", "filename": "compiler/rustc_target/src/spec/x86_64_apple_ios.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_ios.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_ios.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_ios.rs?ref=6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "patch": "@@ -1,8 +1,11 @@\n use super::apple_base::{ios_sim_llvm_target, opts, Arch};\n-use crate::spec::{StackProbeType, Target, TargetOptions};\n+use crate::spec::{SanitizerSet, StackProbeType, Target, TargetOptions};\n \n pub fn target() -> Target {\n     let arch = Arch::X86_64_sim;\n+    let mut base = opts(\"ios\", arch);\n+    base.supported_sanitizers = SanitizerSet::ADDRESS | SanitizerSet::THREAD;\n+\n     Target {\n         llvm_target: ios_sim_llvm_target(arch).into(),\n         pointer_width: 64,\n@@ -12,7 +15,7 @@ pub fn target() -> Target {\n         options: TargetOptions {\n             max_atomic_width: Some(64),\n             stack_probes: StackProbeType::X86,\n-            ..opts(\"ios\", arch)\n+            ..base\n         },\n     }\n }"}, {"sha": "e7d7215166b42384dcb78be8231cf87984c2d0b8", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "patch": "@@ -533,7 +533,12 @@ fn copy_sanitizers(\n         let dst = libdir.join(&runtime.name);\n         builder.copy(&runtime.path, &dst);\n \n-        if target == \"x86_64-apple-darwin\" || target == \"aarch64-apple-darwin\" {\n+        if target == \"x86_64-apple-darwin\"\n+            || target == \"aarch64-apple-darwin\"\n+            || target == \"aarch64-apple-ios\"\n+            || target == \"aarch64-apple-ios-sim\"\n+            || target == \"x86_64-apple-ios\"\n+        {\n             // Update the library\u2019s install name to reflect that it has been renamed.\n             apple_darwin_update_library_name(&dst, &format!(\"@rpath/{}\", &runtime.name));\n             // Upon renaming the install name, the code signature of the file will invalidate,"}, {"sha": "d6e63fb937ec37c80e9b02671ec2cba9bc01a691", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 22, "deletions": 3, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "patch": "@@ -483,7 +483,7 @@ impl Step for Llvm {\n             cfg.define(\"LLVM_VERSION_SUFFIX\", suffix);\n         }\n \n-        configure_cmake(builder, target, &mut cfg, true, ldflags);\n+        configure_cmake(builder, target, &mut cfg, true, ldflags, &[]);\n         configure_llvm(builder, target, &mut cfg);\n \n         for (key, val) in &builder.config.llvm_build_config {\n@@ -574,6 +574,7 @@ fn configure_cmake(\n     cfg: &mut cmake::Config,\n     use_compiler_launcher: bool,\n     mut ldflags: LdFlags,\n+    extra_compiler_flags: &[&str],\n ) {\n     // Do not print installation messages for up-to-date files.\n     // LLVM and LLD builds can produce a lot of those and hit CI limits on log size.\n@@ -714,6 +715,9 @@ fn configure_cmake(\n     if builder.config.llvm_clang_cl.is_some() {\n         cflags.push(&format!(\" --target={}\", target));\n     }\n+    for flag in extra_compiler_flags {\n+        cflags.push(&format!(\" {}\", flag));\n+    }\n     cfg.define(\"CMAKE_C_FLAGS\", cflags);\n     let mut cxxflags: OsString = builder.cflags(target, GitRepo::Llvm, CLang::Cxx).join(\" \").into();\n     if let Some(ref s) = builder.config.llvm_cxxflags {\n@@ -723,6 +727,9 @@ fn configure_cmake(\n     if builder.config.llvm_clang_cl.is_some() {\n         cxxflags.push(&format!(\" --target={}\", target));\n     }\n+    for flag in extra_compiler_flags {\n+        cxxflags.push(&format!(\" {}\", flag));\n+    }\n     cfg.define(\"CMAKE_CXX_FLAGS\", cxxflags);\n     if let Some(ar) = builder.ar(target) {\n         if ar.is_absolute() {\n@@ -864,7 +871,7 @@ impl Step for Lld {\n             }\n         }\n \n-        configure_cmake(builder, target, &mut cfg, true, ldflags);\n+        configure_cmake(builder, target, &mut cfg, true, ldflags, &[]);\n         configure_llvm(builder, target, &mut cfg);\n \n         // Re-use the same flags as llvm to control the level of debug information\n@@ -1028,7 +1035,16 @@ impl Step for Sanitizers {\n         // Unfortunately sccache currently lacks support to build them successfully.\n         // Disable compiler launcher on Darwin targets to avoid potential issues.\n         let use_compiler_launcher = !self.target.contains(\"apple-darwin\");\n-        configure_cmake(builder, self.target, &mut cfg, use_compiler_launcher, LdFlags::default());\n+        let extra_compiler_flags: &[&str] =\n+            if self.target.contains(\"apple\") { &[\"-fembed-bitcode=off\"] } else { &[] };\n+        configure_cmake(\n+            builder,\n+            self.target,\n+            &mut cfg,\n+            use_compiler_launcher,\n+            LdFlags::default(),\n+            extra_compiler_flags,\n+        );\n \n         t!(fs::create_dir_all(&out_dir));\n         cfg.out_dir(out_dir);\n@@ -1084,12 +1100,15 @@ fn supported_sanitizers(\n \n     match &*target.triple {\n         \"aarch64-apple-darwin\" => darwin_libs(\"osx\", &[\"asan\", \"lsan\", \"tsan\"]),\n+        \"aarch64-apple-ios\" => darwin_libs(\"ios\", &[\"asan\", \"tsan\"]),\n+        \"aarch64-apple-ios-sim\" => darwin_libs(\"iossim\", &[\"asan\", \"tsan\"]),\n         \"aarch64-unknown-fuchsia\" => common_libs(\"fuchsia\", \"aarch64\", &[\"asan\"]),\n         \"aarch64-unknown-linux-gnu\" => {\n             common_libs(\"linux\", \"aarch64\", &[\"asan\", \"lsan\", \"msan\", \"tsan\", \"hwasan\"])\n         }\n         \"x86_64-apple-darwin\" => darwin_libs(\"osx\", &[\"asan\", \"lsan\", \"tsan\"]),\n         \"x86_64-unknown-fuchsia\" => common_libs(\"fuchsia\", \"x86_64\", &[\"asan\"]),\n+        \"x86_64-apple-ios\" => darwin_libs(\"iossim\", &[\"asan\", \"tsan\"]),\n         \"x86_64-unknown-freebsd\" => common_libs(\"freebsd\", \"x86_64\", &[\"asan\", \"msan\", \"tsan\"]),\n         \"x86_64-unknown-netbsd\" => {\n             common_libs(\"netbsd\", \"x86_64\", &[\"asan\", \"lsan\", \"msan\", \"tsan\"])"}, {"sha": "5f6a27e536638530c2dd4f91b32809f004bba275", "filename": "src/tools/compiletest/src/util.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/src%2Ftools%2Fcompiletest%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f/src%2Ftools%2Fcompiletest%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Futil.rs?ref=6d819a4b8f45b170e7c2c415df20cfa2e0cbbf7f", "patch": "@@ -11,6 +11,8 @@ mod tests;\n \n pub const ASAN_SUPPORTED_TARGETS: &[&str] = &[\n     \"aarch64-apple-darwin\",\n+    \"aarch64-apple-ios\",\n+    \"aarch64-apple-ios-sim\",\n     \"aarch64-unknown-fuchsia\",\n     \"aarch64-linux-android\",\n     \"aarch64-unknown-linux-gnu\",\n@@ -19,6 +21,7 @@ pub const ASAN_SUPPORTED_TARGETS: &[&str] = &[\n     \"i686-linux-android\",\n     \"i686-unknown-linux-gnu\",\n     \"x86_64-apple-darwin\",\n+    \"x86_64-apple-ios\",\n     \"x86_64-unknown-fuchsia\",\n     \"x86_64-linux-android\",\n     \"x86_64-unknown-freebsd\",\n@@ -70,8 +73,11 @@ pub const MSAN_SUPPORTED_TARGETS: &[&str] = &[\n \n pub const TSAN_SUPPORTED_TARGETS: &[&str] = &[\n     \"aarch64-apple-darwin\",\n+    \"aarch64-apple-ios\",\n+    \"aarch64-apple-ios-sim\",\n     \"aarch64-unknown-linux-gnu\",\n     \"x86_64-apple-darwin\",\n+    \"x86_64-apple-ios\",\n     \"x86_64-unknown-freebsd\",\n     \"x86_64-unknown-linux-gnu\",\n     \"s390x-unknown-linux-gnu\","}]}