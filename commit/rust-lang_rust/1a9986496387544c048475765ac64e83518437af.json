{"sha": "1a9986496387544c048475765ac64e83518437af", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhOTk4NjQ5NjM4NzU0NGMwNDg0NzU3NjVhYzY0ZTgzNTE4NDM3YWY=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-23T09:01:56Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-23T09:01:56Z"}, "message": "Use attrs rather than syntax for lang items", "tree": {"sha": "e2316c48dff66016162a13b0b82a9b01655e485f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2316c48dff66016162a13b0b82a9b01655e485f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1a9986496387544c048475765ac64e83518437af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1a9986496387544c048475765ac64e83518437af", "html_url": "https://github.com/rust-lang/rust/commit/1a9986496387544c048475765ac64e83518437af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1a9986496387544c048475765ac64e83518437af/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "552ba868afc8f72202ac834d07bbeb330aca007d", "url": "https://api.github.com/repos/rust-lang/rust/commits/552ba868afc8f72202ac834d07bbeb330aca007d", "html_url": "https://github.com/rust-lang/rust/commit/552ba868afc8f72202ac834d07bbeb330aca007d"}], "stats": {"total": 84, "additions": 45, "deletions": 39}, "files": [{"sha": "55f0c3a1327caee89dcd9baf469510ab33371d71", "filename": "crates/ra_hir/src/lang_item.rs", "status": "modified", "additions": 25, "deletions": 31, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/1a9986496387544c048475765ac64e83518437af/crates%2Fra_hir%2Fsrc%2Flang_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9986496387544c048475765ac64e83518437af/crates%2Fra_hir%2Fsrc%2Flang_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Flang_item.rs?ref=1a9986496387544c048475765ac64e83518437af", "patch": "@@ -1,13 +1,14 @@\n //! FIXME: write short doc here\n \n-use rustc_hash::FxHashMap;\n use std::sync::Arc;\n \n-use ra_syntax::{ast::AttrsOwner, SmolStr};\n+use hir_def::{AdtId, AttrDefId, ModuleDefId};\n+use ra_syntax::SmolStr;\n+use rustc_hash::FxHashMap;\n \n use crate::{\n     db::{AstDatabase, DefDatabase, HirDatabase},\n-    Adt, Crate, Enum, Function, HasSource, ImplBlock, Module, ModuleDef, Static, Struct, Trait,\n+    Crate, Enum, Function, ImplBlock, Module, Static, Struct, Trait,\n };\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\n@@ -95,26 +96,27 @@ impl LangItems {\n \n     fn collect_lang_items(&mut self, db: &(impl DefDatabase + AstDatabase), module: Module) {\n         // Look for impl targets\n-        for impl_block in module.impl_blocks(db) {\n-            let src = impl_block.source(db);\n-            if let Some(lang_item_name) = lang_item_name(&src.value) {\n-                self.items\n-                    .entry(lang_item_name)\n-                    .or_insert_with(|| LangItemTarget::ImplBlock(impl_block));\n-            }\n+        let def_map = db.crate_def_map(module.id.krate);\n+        let module_data = &def_map[module.id.module_id];\n+        for &impl_block in module_data.impls.iter() {\n+            self.collect_lang_item(db, impl_block, LangItemTarget::ImplBlock)\n         }\n \n-        for def in module.declarations(db) {\n+        for def in module_data.scope.declarations() {\n             match def {\n-                ModuleDef::Trait(trait_) => {\n+                ModuleDefId::TraitId(trait_) => {\n                     self.collect_lang_item(db, trait_, LangItemTarget::Trait)\n                 }\n-                ModuleDef::Adt(Adt::Enum(e)) => self.collect_lang_item(db, e, LangItemTarget::Enum),\n-                ModuleDef::Adt(Adt::Struct(s)) => {\n+                ModuleDefId::AdtId(AdtId::EnumId(e)) => {\n+                    self.collect_lang_item(db, e, LangItemTarget::Enum)\n+                }\n+                ModuleDefId::AdtId(AdtId::StructId(s)) => {\n                     self.collect_lang_item(db, s, LangItemTarget::Struct)\n                 }\n-                ModuleDef::Function(f) => self.collect_lang_item(db, f, LangItemTarget::Function),\n-                ModuleDef::Static(s) => self.collect_lang_item(db, s, LangItemTarget::Static),\n+                ModuleDefId::FunctionId(f) => {\n+                    self.collect_lang_item(db, f, LangItemTarget::Function)\n+                }\n+                ModuleDefId::StaticId(s) => self.collect_lang_item(db, s, LangItemTarget::Static),\n                 _ => {}\n             }\n         }\n@@ -135,26 +137,18 @@ impl LangItems {\n         }\n     }\n \n-    fn collect_lang_item<T, N>(\n+    fn collect_lang_item<T, D>(\n         &mut self,\n         db: &(impl DefDatabase + AstDatabase),\n         item: T,\n-        constructor: fn(T) -> LangItemTarget,\n+        constructor: fn(D) -> LangItemTarget,\n     ) where\n-        T: Copy + HasSource<Ast = N>,\n-        N: AttrsOwner,\n+        T: Into<AttrDefId> + Copy,\n+        D: From<T>,\n     {\n-        let node = item.source(db).value;\n-        if let Some(lang_item_name) = lang_item_name(&node) {\n-            self.items.entry(lang_item_name).or_insert_with(|| constructor(item));\n+        let attrs = db.attrs(item.into());\n+        if let Some(lang_item_name) = attrs.find_string_value(\"lang\") {\n+            self.items.entry(lang_item_name).or_insert_with(|| constructor(D::from(item)));\n         }\n     }\n }\n-\n-fn lang_item_name<T: AttrsOwner>(node: &T) -> Option<SmolStr> {\n-    node.attrs()\n-        .filter_map(|a| a.as_simple_key_value())\n-        .filter(|(key, _)| key == \"lang\")\n-        .map(|(_, val)| val)\n-        .nth(0)\n-}"}, {"sha": "eee5e44bf905f06ba671f8952d198d39a0cc86fe", "filename": "crates/ra_hir_def/src/attr.rs", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1a9986496387544c048475765ac64e83518437af/crates%2Fra_hir_def%2Fsrc%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9986496387544c048475765ac64e83518437af/crates%2Fra_hir_def%2Fsrc%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fattr.rs?ref=1a9986496387544c048475765ac64e83518437af", "patch": "@@ -53,28 +53,38 @@ impl Attrs {\n                     }\n                 }\n             }\n-            AttrDefId::AdtId(it) => match it {\n-                AdtId::StructId(it) => attrs_from_ast(it.0.lookup_intern(db).ast_id, db),\n-                AdtId::EnumId(it) => attrs_from_ast(it.lookup_intern(db).ast_id, db),\n-                AdtId::UnionId(it) => attrs_from_ast(it.0.lookup_intern(db).ast_id, db),\n-            },\n             AttrDefId::EnumVariantId(it) => {\n                 let src = it.parent.child_source(db);\n                 let hygiene = Hygiene::new(db, src.file_id);\n                 Attr::from_attrs_owner(&src.value[it.local_id], &hygiene)\n             }\n+            AttrDefId::AdtId(it) => match it {\n+                AdtId::StructId(it) => attrs_from_ast(it.0.lookup_intern(db).ast_id, db),\n+                AdtId::EnumId(it) => attrs_from_ast(it.lookup_intern(db).ast_id, db),\n+                AdtId::UnionId(it) => attrs_from_ast(it.0.lookup_intern(db).ast_id, db),\n+            },\n             AttrDefId::StaticId(it) => attrs_from_ast(it.lookup_intern(db).ast_id, db),\n+            AttrDefId::TraitId(it) => attrs_from_ast(it.lookup_intern(db).ast_id, db),\n+            AttrDefId::MacroDefId(it) => attrs_from_ast(it.ast_id, db),\n+            AttrDefId::ImplId(it) => attrs_from_ast(it.lookup_intern(db).ast_id, db),\n             AttrDefId::ConstId(it) => attrs_from_loc(it.lookup(db), db),\n             AttrDefId::FunctionId(it) => attrs_from_loc(it.lookup(db), db),\n-            AttrDefId::TraitId(it) => attrs_from_ast(it.lookup_intern(db).ast_id, db),\n             AttrDefId::TypeAliasId(it) => attrs_from_loc(it.lookup(db), db),\n-            AttrDefId::MacroDefId(it) => attrs_from_ast(it.ast_id, db),\n         }\n     }\n \n     pub fn has_atom(&self, atom: &str) -> bool {\n         self.iter().any(|it| it.is_simple_atom(atom))\n     }\n+\n+    pub fn find_string_value(&self, key: &str) -> Option<SmolStr> {\n+        self.iter().filter(|attr| attr.is_simple_atom(key)).find_map(|attr| {\n+            match attr.input.as_ref()? {\n+                AttrInput::Literal(it) => Some(it.clone()),\n+                _ => None,\n+            }\n+        })\n+    }\n }\n \n #[derive(Debug, Clone, PartialEq, Eq)]"}, {"sha": "20d4deadb452a4543c4ae93ee48777cb590f498d", "filename": "crates/ra_hir_def/src/lib.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1a9986496387544c048475765ac64e83518437af/crates%2Fra_hir_def%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a9986496387544c048475765ac64e83518437af/crates%2Fra_hir_def%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Flib.rs?ref=1a9986496387544c048475765ac64e83518437af", "patch": "@@ -489,6 +489,7 @@ pub enum AttrDefId {\n     TraitId(TraitId),\n     TypeAliasId(TypeAliasId),\n     MacroDefId(MacroDefId),\n+    ImplId(ImplId),\n }\n \n impl_froms!(\n@@ -501,7 +502,8 @@ impl_froms!(\n     FunctionId,\n     TraitId,\n     TypeAliasId,\n-    MacroDefId\n+    MacroDefId,\n+    ImplId\n );\n \n trait Intern {"}]}