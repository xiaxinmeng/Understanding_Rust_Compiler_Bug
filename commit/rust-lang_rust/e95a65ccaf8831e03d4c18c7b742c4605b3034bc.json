{"sha": "e95a65ccaf8831e03d4c18c7b742c4605b3034bc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU5NWE2NWNjYWY4ODMxZTAzZDRjMThjN2I3NDJjNDYwNWIzMDM0YmM=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2020-11-06T12:19:08Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2020-11-06T19:40:03Z"}, "message": "Support closure in change_return_type_to_result assist", "tree": {"sha": "ed0a5387139f7c18a2f303a2145accc4c0cb7d5e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed0a5387139f7c18a2f303a2145accc4c0cb7d5e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e95a65ccaf8831e03d4c18c7b742c4605b3034bc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e95a65ccaf8831e03d4c18c7b742c4605b3034bc", "html_url": "https://github.com/rust-lang/rust/commit/e95a65ccaf8831e03d4c18c7b742c4605b3034bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e95a65ccaf8831e03d4c18c7b742c4605b3034bc/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7709b6a2d4b74b5838fbe5b30b6188d6a549b580", "url": "https://api.github.com/repos/rust-lang/rust/commits/7709b6a2d4b74b5838fbe5b30b6188d6a549b580", "html_url": "https://github.com/rust-lang/rust/commit/7709b6a2d4b74b5838fbe5b30b6188d6a549b580"}], "stats": {"total": 121, "additions": 107, "deletions": 14}, "files": [{"sha": "76f33a5b6d3822b0450675471b72fac5b615f531", "filename": "crates/assists/src/handlers/change_return_type_to_result.rs", "status": "modified", "additions": 107, "deletions": 14, "changes": 121, "blob_url": "https://github.com/rust-lang/rust/blob/e95a65ccaf8831e03d4c18c7b742c4605b3034bc/crates%2Fassists%2Fsrc%2Fhandlers%2Fchange_return_type_to_result.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e95a65ccaf8831e03d4c18c7b742c4605b3034bc/crates%2Fassists%2Fsrc%2Fhandlers%2Fchange_return_type_to_result.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fchange_return_type_to_result.rs?ref=e95a65ccaf8831e03d4c18c7b742c4605b3034bc", "patch": "@@ -2,7 +2,7 @@ use std::iter;\n \n use syntax::{\n     ast::{self, make, BlockExpr, Expr, LoopBodyOwner},\n-    AstNode, SyntaxNode,\n+    match_ast, AstNode, SyntaxNode,\n };\n use test_utils::mark;\n \n@@ -21,8 +21,18 @@ use crate::{AssistContext, AssistId, AssistKind, Assists};\n // ```\n pub(crate) fn change_return_type_to_result(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n     let ret_type = ctx.find_node_at_offset::<ast::RetType>()?;\n-    // FIXME: extend to lambdas as well\n-    let fn_def = ret_type.syntax().parent().and_then(ast::Fn::cast)?;\n+    let parent = ret_type.syntax().parent()?;\n+    let block_expr = match_ast! {\n+        match parent {\n+            ast::Fn(func) => func.body()?,\n+            ast::ClosureExpr(closure) => match closure.body()? {\n+                Expr::BlockExpr(block) => block,\n+                // closures require a block when a return type is specified\n+                _ => return None,\n+            },\n+            _ => return None,\n+        }\n+    };\n \n     let type_ref = &ret_type.ty()?;\n     let ret_type_str = type_ref.syntax().text().to_string();\n@@ -34,16 +44,14 @@ pub(crate) fn change_return_type_to_result(acc: &mut Assists, ctx: &AssistContex\n         }\n     }\n \n-    let block_expr = &fn_def.body()?;\n-\n     acc.add(\n         AssistId(\"change_return_type_to_result\", AssistKind::RefactorRewrite),\n         \"Wrap return type in Result\",\n         type_ref.syntax().text_range(),\n         |builder| {\n             let mut tail_return_expr_collector = TailReturnCollector::new();\n-            tail_return_expr_collector.collect_jump_exprs(block_expr, false);\n-            tail_return_expr_collector.collect_tail_exprs(block_expr);\n+            tail_return_expr_collector.collect_jump_exprs(&block_expr, false);\n+            tail_return_expr_collector.collect_tail_exprs(&block_expr);\n \n             for ret_expr_arg in tail_return_expr_collector.exprs_to_wrap {\n                 let ok_wrapped = make::expr_call(\n@@ -285,16 +293,20 @@ mod tests {\n     }\n \n     #[test]\n-    fn change_return_type_to_result_simple_return_type() {\n+    fn change_return_type_to_result_simple_closure() {\n         check_assist(\n             change_return_type_to_result,\n-            r#\"fn foo() -> i32<|> {\n-                let test = \"test\";\n-                return 42i32;\n+            r#\"fn foo() {\n+                || -> i32<|> {\n+                    let test = \"test\";\n+                    return 42i32;\n+                };\n             }\"#,\n-            r#\"fn foo() -> Result<i32, ${0:_}> {\n-                let test = \"test\";\n-                return Ok(42i32);\n+            r#\"fn foo() {\n+                || -> Result<i32, ${0:_}> {\n+                    let test = \"test\";\n+                    return Ok(42i32);\n+                };\n             }\"#,\n         );\n     }\n@@ -310,6 +322,29 @@ mod tests {\n         );\n     }\n \n+    #[test]\n+    fn change_return_type_to_result_simple_return_type_bad_cursor_closure() {\n+        check_assist_not_applicable(\n+            change_return_type_to_result,\n+            r#\"fn foo() {\n+                || -> i32 {\n+                    let test = \"test\";<|>\n+                    return 42i32;\n+                };\n+            }\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn change_return_type_to_result_closure_non_block() {\n+        check_assist_not_applicable(\n+            change_return_type_to_result,\n+            r#\"fn foo() {\n+                || -> i<|>32 3;\n+            }\"#,\n+        );\n+    }\n+\n     #[test]\n     fn change_return_type_to_result_simple_return_type_already_result_std() {\n         check_assist_not_applicable(\n@@ -333,6 +368,19 @@ mod tests {\n         );\n     }\n \n+    #[test]\n+    fn change_return_type_to_result_simple_return_type_already_result_closure() {\n+        check_assist_not_applicable(\n+            change_return_type_to_result,\n+            r#\"fn foo() {\n+                || -> Result<i32<|>, String> {\n+                    let test = \"test\";\n+                    return 42i32;\n+                };\n+            }\"#,\n+        );\n+    }\n+\n     #[test]\n     fn change_return_type_to_result_simple_with_cursor() {\n         check_assist(\n@@ -363,6 +411,25 @@ mod tests {\n         );\n     }\n \n+    #[test]\n+    fn change_return_type_to_result_simple_with_tail_closure() {\n+        check_assist(\n+            change_return_type_to_result,\n+            r#\"fn foo() {\n+                || -><|> i32 {\n+                    let test = \"test\";\n+                    42i32\n+                };\n+            }\"#,\n+            r#\"fn foo() {\n+                || -> Result<i32, ${0:_}> {\n+                    let test = \"test\";\n+                    Ok(42i32)\n+                };\n+            }\"#,\n+        );\n+    }\n+\n     #[test]\n     fn change_return_type_to_result_simple_with_tail_only() {\n         check_assist(\n@@ -375,6 +442,7 @@ mod tests {\n             }\"#,\n         );\n     }\n+\n     #[test]\n     fn change_return_type_to_result_simple_with_tail_block_like() {\n         check_assist(\n@@ -396,6 +464,31 @@ mod tests {\n         );\n     }\n \n+    #[test]\n+    fn change_return_type_to_result_simple_without_block_closure() {\n+        check_assist(\n+            change_return_type_to_result,\n+            r#\"fn foo() {\n+                || -> i32<|> {\n+                    if true {\n+                        42i32\n+                    } else {\n+                        24i32\n+                    }\n+                };\n+            }\"#,\n+            r#\"fn foo() {\n+                || -> Result<i32, ${0:_}> {\n+                    if true {\n+                        Ok(42i32)\n+                    } else {\n+                        Ok(24i32)\n+                    }\n+                };\n+            }\"#,\n+        );\n+    }\n+\n     #[test]\n     fn change_return_type_to_result_simple_with_nested_if() {\n         check_assist("}]}