{"sha": "d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "node_id": "C_kwDOAAsO6NoAKGQ4ZDAxZTMyMTY4YTI0ODYyYjllZDJiNmE2YjdlYjBlODJmYmNmY2U", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-10-10T18:47:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-10T18:47:31Z"}, "message": "Rollup merge of #101360 - compiler-errors:multiple-closure-bounds, r=petrochenkov\n\nPoint out incompatible closure bounds\n\nFixes #100295", "tree": {"sha": "c13af13e23d009c9c339e8cf46ddca07ac94e883", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c13af13e23d009c9c339e8cf46ddca07ac94e883"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjRGjDCRBK7hj4Ov3rIwAAebwIAKVZvYLJJpT7Sp6xYEFeXlM2\ntskgW4s7Ytr+wMQ/SM5PUz3Iz7/W/fALN5baDce2KG4kqiervluL9+Z2KCRk01o5\n8o6MnnaxfaYmSaQqwI5Tjqza71yFFghPuUD2/AVhX6BKdwAj5BCJtbj/9JoO7oDl\n/oymQmk3AGPwEOY8qCIeYacDwCcqcGWxDzcGmB5r8Iws6UOoAi4q1hymCGTUWYwa\nTWXSIgs2GCkKic5U5sGRlGH0UPHo9xS+e50xGdWkL6luRDl/gZphzPOLe5gA7GJ2\ncqb97ckEwRKFYbdlVhLKagBzHhOzVN1uAZ3g36P9PWbwzqHfV1gI7zg48R8SG7Y=\n=IHZK\n-----END PGP SIGNATURE-----\n", "payload": "tree c13af13e23d009c9c339e8cf46ddca07ac94e883\nparent 0265a3e93bf1b89d97cae113ed214954d5c35e22\nparent 693485373b971d1574388b9da785b66c19dc86d2\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1665427651 +0200\ncommitter GitHub <noreply@github.com> 1665427651 +0200\n\nRollup merge of #101360 - compiler-errors:multiple-closure-bounds, r=petrochenkov\n\nPoint out incompatible closure bounds\n\nFixes #100295\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "html_url": "https://github.com/rust-lang/rust/commit/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0265a3e93bf1b89d97cae113ed214954d5c35e22", "url": "https://api.github.com/repos/rust-lang/rust/commits/0265a3e93bf1b89d97cae113ed214954d5c35e22", "html_url": "https://github.com/rust-lang/rust/commit/0265a3e93bf1b89d97cae113ed214954d5c35e22"}, {"sha": "693485373b971d1574388b9da785b66c19dc86d2", "url": "https://api.github.com/repos/rust-lang/rust/commits/693485373b971d1574388b9da785b66c19dc86d2", "html_url": "https://github.com/rust-lang/rust/commit/693485373b971d1574388b9da785b66c19dc86d2"}], "stats": {"total": 107, "additions": 107, "deletions": 0}, "files": [{"sha": "4e8baa2dfab6c3d176d6f0ff25a362f234eaa208", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "patch": "@@ -1255,6 +1255,7 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                         found_span,\n                         found_trait_ref,\n                         expected_trait_ref,\n+                        obligation.cause.code(),\n                     )\n                 } else {\n                     let (closure_span, found) = found_did"}, {"sha": "fda6a2236b1957b1c81e9580a52b69da6200ab17", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "patch": "@@ -254,8 +254,15 @@ pub trait TypeErrCtxtExt<'tcx> {\n         found_span: Option<Span>,\n         found: ty::PolyTraitRef<'tcx>,\n         expected: ty::PolyTraitRef<'tcx>,\n+        cause: &ObligationCauseCode<'tcx>,\n     ) -> DiagnosticBuilder<'tcx, ErrorGuaranteed>;\n \n+    fn note_conflicting_closure_bounds(\n+        &self,\n+        cause: &ObligationCauseCode<'tcx>,\n+        err: &mut DiagnosticBuilder<'tcx, ErrorGuaranteed>,\n+    );\n+\n     fn suggest_fully_qualified_path(\n         &self,\n         err: &mut Diagnostic,\n@@ -1584,6 +1591,7 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n         found_span: Option<Span>,\n         found: ty::PolyTraitRef<'tcx>,\n         expected: ty::PolyTraitRef<'tcx>,\n+        cause: &ObligationCauseCode<'tcx>,\n     ) -> DiagnosticBuilder<'tcx, ErrorGuaranteed> {\n         pub(crate) fn build_fn_sig_ty<'tcx>(\n             infcx: &InferCtxt<'tcx>,\n@@ -1645,9 +1653,68 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n         let signature_kind = format!(\"{argument_kind} signature\");\n         err.note_expected_found(&signature_kind, expected_str, &signature_kind, found_str);\n \n+        self.note_conflicting_closure_bounds(cause, &mut err);\n+\n         err\n     }\n \n+    // Add a note if there are two `Fn`-family bounds that have conflicting argument\n+    // requirements, which will always cause a closure to have a type error.\n+    fn note_conflicting_closure_bounds(\n+        &self,\n+        cause: &ObligationCauseCode<'tcx>,\n+        err: &mut DiagnosticBuilder<'tcx, ErrorGuaranteed>,\n+    ) {\n+        // First, look for an `ExprBindingObligation`, which means we can get\n+        // the unsubstituted predicate list of the called function. And check\n+        // that the predicate that we failed to satisfy is a `Fn`-like trait.\n+        if let ObligationCauseCode::ExprBindingObligation(def_id, _, _, idx) = cause\n+            && let predicates = self.tcx.predicates_of(def_id).instantiate_identity(self.tcx)\n+            && let Some(pred) = predicates.predicates.get(*idx)\n+            && let ty::PredicateKind::Trait(trait_pred) = pred.kind().skip_binder()\n+            && ty::ClosureKind::from_def_id(self.tcx, trait_pred.def_id()).is_some()\n+        {\n+            let expected_self =\n+                self.tcx.anonymize_late_bound_regions(pred.kind().rebind(trait_pred.self_ty()));\n+            let expected_substs = self\n+                .tcx\n+                .anonymize_late_bound_regions(pred.kind().rebind(trait_pred.trait_ref.substs));\n+\n+            // Find another predicate whose self-type is equal to the expected self type,\n+            // but whose substs don't match.\n+            let other_pred = std::iter::zip(&predicates.predicates, &predicates.spans)\n+                .enumerate()\n+                .find(|(other_idx, (pred, _))| match pred.kind().skip_binder() {\n+                    ty::PredicateKind::Trait(trait_pred)\n+                        if ty::ClosureKind::from_def_id(self.tcx, trait_pred.def_id())\n+                            .is_some()\n+                            && other_idx != idx\n+                            // Make sure that the self type matches\n+                            // (i.e. constraining this closure)\n+                            && expected_self\n+                                == self.tcx.anonymize_late_bound_regions(\n+                                    pred.kind().rebind(trait_pred.self_ty()),\n+                                )\n+                            // But the substs don't match (i.e. incompatible args)\n+                            && expected_substs\n+                                != self.tcx.anonymize_late_bound_regions(\n+                                    pred.kind().rebind(trait_pred.trait_ref.substs),\n+                                ) =>\n+                    {\n+                        true\n+                    }\n+                    _ => false,\n+                });\n+            // If we found one, then it's very likely the cause of the error.\n+            if let Some((_, (_, other_pred_span))) = other_pred {\n+                err.span_note(\n+                    *other_pred_span,\n+                    \"closure inferred to have a different signature due to this bound\",\n+                );\n+            }\n+        }\n+    }\n+\n     fn suggest_fully_qualified_path(\n         &self,\n         err: &mut Diagnostic,"}, {"sha": "6bb4098e2bbe5125fc967f298399bb6055e95d31", "filename": "src/test/ui/closures/multiple-fn-bounds.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/src%2Ftest%2Fui%2Fclosures%2Fmultiple-fn-bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/src%2Ftest%2Fui%2Fclosures%2Fmultiple-fn-bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2Fmultiple-fn-bounds.rs?ref=d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "patch": "@@ -0,0 +1,15 @@\n+fn foo<F: Fn(&char) -> bool + Fn(char) -> bool>(f: F) {\n+    //~^ NOTE required by a bound in `foo`\n+    //~| NOTE required by this bound in `foo`\n+    //~| NOTE closure inferred to have a different signature due to this bound\n+    todo!();\n+}\n+\n+fn main() {\n+    let v = true;\n+    foo(move |x| v);\n+    //~^ ERROR type mismatch in closure arguments\n+    //~| NOTE expected closure signature\n+    //~| NOTE expected due to this\n+    //~| NOTE found signature defined here\n+}"}, {"sha": "eefc123fed7ac3ed07714d9666abfafc89141c6f", "filename": "src/test/ui/closures/multiple-fn-bounds.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/src%2Ftest%2Fui%2Fclosures%2Fmultiple-fn-bounds.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce/src%2Ftest%2Fui%2Fclosures%2Fmultiple-fn-bounds.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2Fmultiple-fn-bounds.stderr?ref=d8d01e32168a24862b9ed2b6a6b7eb0e82fbcfce", "patch": "@@ -0,0 +1,24 @@\n+error[E0631]: type mismatch in closure arguments\n+  --> $DIR/multiple-fn-bounds.rs:10:5\n+   |\n+LL |     foo(move |x| v);\n+   |     ^^^ -------- found signature defined here\n+   |     |\n+   |     expected due to this\n+   |\n+   = note: expected closure signature `fn(char) -> _`\n+              found closure signature `for<'a> fn(&'a char) -> _`\n+note: closure inferred to have a different signature due to this bound\n+  --> $DIR/multiple-fn-bounds.rs:1:11\n+   |\n+LL | fn foo<F: Fn(&char) -> bool + Fn(char) -> bool>(f: F) {\n+   |           ^^^^^^^^^^^^^^^^^\n+note: required by a bound in `foo`\n+  --> $DIR/multiple-fn-bounds.rs:1:31\n+   |\n+LL | fn foo<F: Fn(&char) -> bool + Fn(char) -> bool>(f: F) {\n+   |                               ^^^^^^^^^^^^^^^^ required by this bound in `foo`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0631`."}]}