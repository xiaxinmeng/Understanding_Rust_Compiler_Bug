{"sha": "6c64870fa67f0227f40f6adc25a6944e95c2959f", "node_id": "C_kwDOAAsO6NoAKDZjNjQ4NzBmYTY3ZjAyMjdmNDBmNmFkYzI1YTY5NDRlOTVjMjk1OWY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-17T03:37:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-17T03:37:54Z"}, "message": "Auto merge of #111630 - BoxyUwU:ty_const_debug_formatting, r=compiler-errors\n\ndebug format `Const`'s less verbosely\n\nNot user visible change only visible to people debugging const generics.\n\nCurrently debug output for `ty::Const` is super verbose (even for `-Zverbose` lol), things like printing infer vars as `Infer(Var(?0c))` instead of just `?0c`, bound vars and placeholders not using `^0_1` or `!0_1` syntax respectively. With these changes its imo better but not perfect:\n`Const { ty: usize, kind: ^0_1 }`\nis still a lot for not much information. not entirely sure what to do about that so not dealing with it yet.\n\nNeed to do formatting for `ConstKind::Expr` at some point too since rn it sucks (doesn't even print anything with `Display`) not gonna do that in this PR either.\n\nr? `@compiler-errors`", "tree": {"sha": "e6be882190a0f88a8e3d3ba28cc2badb1746d393", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e6be882190a0f88a8e3d3ba28cc2badb1746d393"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6c64870fa67f0227f40f6adc25a6944e95c2959f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6c64870fa67f0227f40f6adc25a6944e95c2959f", "html_url": "https://github.com/rust-lang/rust/commit/6c64870fa67f0227f40f6adc25a6944e95c2959f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6c64870fa67f0227f40f6adc25a6944e95c2959f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0784db3deddfb09f52c65373ef50b14d82494cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0784db3deddfb09f52c65373ef50b14d82494cc", "html_url": "https://github.com/rust-lang/rust/commit/c0784db3deddfb09f52c65373ef50b14d82494cc"}, {"sha": "2a554eb40677a659092c5b95a52821275924c4bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a554eb40677a659092c5b95a52821275924c4bf", "html_url": "https://github.com/rust-lang/rust/commit/2a554eb40677a659092c5b95a52821275924c4bf"}], "stats": {"total": 120, "additions": 75, "deletions": 45}, "files": [{"sha": "1a4bd14815f93460e1e6917573ae8b00df86a5d9", "filename": "compiler/rustc_middle/src/ty/consts.rs", "status": "modified", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fconsts.rs?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -6,7 +6,6 @@ use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::LocalDefId;\n use rustc_macros::HashStable;\n-use std::fmt;\n \n mod int;\n mod kind;\n@@ -21,15 +20,6 @@ pub use valtree::*;\n #[rustc_pass_by_value]\n pub struct Const<'tcx>(pub(super) Interned<'tcx, ConstData<'tcx>>);\n \n-impl<'tcx> fmt::Debug for Const<'tcx> {\n-    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n-        // This reflects what `Const` looked liked before `Interned` was\n-        // introduced. We print it like this to avoid having to update expected\n-        // output in a lot of tests.\n-        write!(f, \"Const {{ ty: {:?}, kind: {:?} }}\", self.ty(), self.kind())\n-    }\n-}\n-\n /// Typed constant value.\n #[derive(PartialEq, Eq, PartialOrd, Ord, Hash, HashStable, TyEncodable, TyDecodable)]\n pub struct ConstData<'tcx> {"}, {"sha": "1dd4f8a243741fb6e9a16ac8996aa57325bf32e1", "filename": "compiler/rustc_middle/src/ty/consts/kind.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fconsts%2Fkind.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fconsts%2Fkind.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fconsts%2Fkind.rs?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -42,7 +42,7 @@ impl<'tcx> UnevaluatedConst<'tcx> {\n }\n \n /// Represents a constant in Rust.\n-#[derive(Copy, Clone, Debug, Eq, PartialEq, PartialOrd, Ord, TyEncodable, TyDecodable)]\n+#[derive(Copy, Clone, Eq, PartialEq, PartialOrd, Ord, TyEncodable, TyDecodable)]\n #[derive(Hash, HashStable, TypeFoldable, TypeVisitable)]\n #[derive(derive_more::From)]\n pub enum ConstKind<'tcx> {\n@@ -128,7 +128,7 @@ impl<'tcx> ConstKind<'tcx> {\n }\n \n /// An inference variable for a const, for use in const generics.\n-#[derive(Copy, Clone, Debug, Eq, PartialEq, PartialOrd, Ord, TyEncodable, TyDecodable, Hash)]\n+#[derive(Copy, Clone, Eq, PartialEq, PartialOrd, Ord, TyEncodable, TyDecodable, Hash)]\n pub enum InferConst<'tcx> {\n     /// Infer the value of the const.\n     Var(ty::ConstVid<'tcx>),"}, {"sha": "a8193c3e5591f94acf3d491d5fb6fbef56f76caa", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 31, "deletions": 29, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -703,7 +703,7 @@ pub trait PrettyPrinter<'tcx>:\n             ty::Error(_) => p!(\"[type error]\"),\n             ty::Param(ref param_ty) => p!(print(param_ty)),\n             ty::Bound(debruijn, bound_ty) => match bound_ty.kind {\n-                ty::BoundTyKind::Anon => self.pretty_print_bound_var(debruijn, bound_ty.var)?,\n+                ty::BoundTyKind::Anon => debug_bound_var(&mut self, debruijn, bound_ty.var)?,\n                 ty::BoundTyKind::Param(_, s) => match self.should_print_verbose() {\n                     true if debruijn == ty::INNERMOST => p!(write(\"^{}\", s)),\n                     true => p!(write(\"^{}_{}\", debruijn.index(), s)),\n@@ -741,7 +741,7 @@ pub trait PrettyPrinter<'tcx>:\n             }\n             ty::Placeholder(placeholder) => match placeholder.bound.kind {\n                 ty::BoundTyKind::Anon => {\n-                    self.pretty_print_placeholder_var(placeholder.universe, placeholder.bound.var)?\n+                    debug_placeholder_var(&mut self, placeholder.universe, placeholder.bound.var)?;\n                 }\n                 ty::BoundTyKind::Param(_, name) => p!(write(\"{}\", name)),\n             },\n@@ -1164,30 +1164,6 @@ pub trait PrettyPrinter<'tcx>:\n         traits.entry(trait_ref).or_default().extend(proj_ty);\n     }\n \n-    fn pretty_print_bound_var(\n-        &mut self,\n-        debruijn: ty::DebruijnIndex,\n-        var: ty::BoundVar,\n-    ) -> Result<(), Self::Error> {\n-        if debruijn == ty::INNERMOST {\n-            write!(self, \"^{}\", var.index())\n-        } else {\n-            write!(self, \"^{}_{}\", debruijn.index(), var.index())\n-        }\n-    }\n-\n-    fn pretty_print_placeholder_var(\n-        &mut self,\n-        ui: ty::UniverseIndex,\n-        var: ty::BoundVar,\n-    ) -> Result<(), Self::Error> {\n-        if ui == ty::UniverseIndex::ROOT {\n-            write!(self, \"!{}\", var.index())\n-        } else {\n-            write!(self, \"!{}_{}\", ui.index(), var.index())\n-        }\n-    }\n-\n     fn ty_infer_name(&self, _: ty::TyVid) -> Option<Symbol> {\n         None\n     }\n@@ -1321,7 +1297,7 @@ pub trait PrettyPrinter<'tcx>:\n         define_scoped_cx!(self);\n \n         if self.should_print_verbose() {\n-            p!(write(\"Const({:?}: {:?})\", ct.kind(), ct.ty()));\n+            p!(write(\"{:?}\", ct));\n             return Ok(self);\n         }\n \n@@ -1380,9 +1356,11 @@ pub trait PrettyPrinter<'tcx>:\n             }\n \n             ty::ConstKind::Bound(debruijn, bound_var) => {\n-                self.pretty_print_bound_var(debruijn, bound_var)?\n+                debug_bound_var(&mut self, debruijn, bound_var)?\n             }\n-            ty::ConstKind::Placeholder(placeholder) => p!(write(\"Placeholder({:?})\", placeholder)),\n+            ty::ConstKind::Placeholder(placeholder) => {\n+                debug_placeholder_var(&mut self, placeholder.universe, placeholder.bound)?;\n+            },\n             // FIXME(generic_const_exprs):\n             // write out some legible representation of an abstract const?\n             ty::ConstKind::Expr(_) => p!(\"[const expr]\"),\n@@ -3067,3 +3045,27 @@ pub struct OpaqueFnEntry<'tcx> {\n     fn_trait_ref: Option<ty::PolyTraitRef<'tcx>>,\n     return_ty: Option<ty::Binder<'tcx, Term<'tcx>>>,\n }\n+\n+pub fn debug_bound_var<T: std::fmt::Write>(\n+    fmt: &mut T,\n+    debruijn: ty::DebruijnIndex,\n+    var: ty::BoundVar,\n+) -> Result<(), std::fmt::Error> {\n+    if debruijn == ty::INNERMOST {\n+        write!(fmt, \"^{}\", var.index())\n+    } else {\n+        write!(fmt, \"^{}_{}\", debruijn.index(), var.index())\n+    }\n+}\n+\n+pub fn debug_placeholder_var<T: std::fmt::Write>(\n+    fmt: &mut T,\n+    universe: ty::UniverseIndex,\n+    bound: ty::BoundVar,\n+) -> Result<(), std::fmt::Error> {\n+    if universe == ty::UniverseIndex::ROOT {\n+        write!(fmt, \"!{}\", bound.index())\n+    } else {\n+        write!(fmt, \"!{}_{}\", universe.index(), bound.index())\n+    }\n+}"}, {"sha": "16cb6c910463a81d42cbed1a8207faea8c1e5485", "filename": "compiler/rustc_middle/src/ty/structural_impls.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -192,6 +192,44 @@ impl<'tcx> fmt::Debug for AliasTy<'tcx> {\n     }\n }\n \n+impl<'tcx> fmt::Debug for ty::InferConst<'tcx> {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        match self {\n+            InferConst::Var(var) => write!(f, \"{var:?}\"),\n+            InferConst::Fresh(var) => write!(f, \"Fresh({var:?})\"),\n+        }\n+    }\n+}\n+\n+impl<'tcx> fmt::Debug for ty::Const<'tcx> {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        // This reflects what `Const` looked liked before `Interned` was\n+        // introduced. We print it like this to avoid having to update expected\n+        // output in a lot of tests.\n+        write!(f, \"Const {{ ty: {:?}, kind: {:?} }}\", self.ty(), self.kind())\n+    }\n+}\n+\n+impl<'tcx> fmt::Debug for ty::ConstKind<'tcx> {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        use ty::ConstKind::*;\n+        match self {\n+            Param(param) => write!(f, \"{param:?}\"),\n+            Infer(var) => write!(f, \"{var:?}\"),\n+            Bound(debruijn, var) => ty::print::debug_bound_var(f, *debruijn, *var),\n+            Placeholder(placeholder) => {\n+                ty::print::debug_placeholder_var(f, placeholder.universe, placeholder.bound)\n+            }\n+            Unevaluated(uv) => {\n+                f.debug_tuple(\"Unevaluated\").field(&uv.substs).field(&uv.def).finish()\n+            }\n+            Value(valtree) => write!(f, \"{valtree:?}\"),\n+            Error(_) => write!(f, \"[const error]\"),\n+            Expr(expr) => write!(f, \"{expr:?}\"),\n+        }\n+    }\n+}\n+\n ///////////////////////////////////////////////////////////////////////////\n // Atomic structs\n //"}, {"sha": "0424ce3abeb2edbf326715a4bd28b162d7b4ec53", "filename": "tests/mir-opt/issue_99325.main.built.after.mir", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/tests%2Fmir-opt%2Fissue_99325.main.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/tests%2Fmir-opt%2Fissue_99325.main.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fissue_99325.main.built.after.mir?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -1,8 +1,8 @@\n // MIR for `main` after built\n \n | User Type Annotations\n-| 0: user_ty: Canonical { value: TypeOf(DefId(0:3 ~ issue_99325[22bb]::function_with_bytes), UserSubsts { substs: [Const { ty: &'static [u8; 4], kind: Value(Branch([Leaf(0x41), Leaf(0x41), Leaf(0x41), Leaf(0x41)])) }], user_self_ty: None }), max_universe: U0, variables: [] }, span: $DIR/issue_99325.rs:10:16: 10:46, inferred_ty: fn() -> &'static [u8] {function_with_bytes::<&*b\"AAAA\">}\n-| 1: user_ty: Canonical { value: TypeOf(DefId(0:3 ~ issue_99325[22bb]::function_with_bytes), UserSubsts { substs: [Const { ty: &'static [u8; 4], kind: Unevaluated(UnevaluatedConst { def: DefId(0:8 ~ issue_99325[22bb]::main::{constant#1}), substs: [] }) }], user_self_ty: None }), max_universe: U0, variables: [] }, span: $DIR/issue_99325.rs:11:16: 11:68, inferred_ty: fn() -> &'static [u8] {function_with_bytes::<&*b\"AAAA\">}\n+| 0: user_ty: Canonical { value: TypeOf(DefId(0:3 ~ issue_99325[22bb]::function_with_bytes), UserSubsts { substs: [Const { ty: &'static [u8; 4], kind: Branch([Leaf(0x41), Leaf(0x41), Leaf(0x41), Leaf(0x41)]) }], user_self_ty: None }), max_universe: U0, variables: [] }, span: $DIR/issue_99325.rs:10:16: 10:46, inferred_ty: fn() -> &'static [u8] {function_with_bytes::<&*b\"AAAA\">}\n+| 1: user_ty: Canonical { value: TypeOf(DefId(0:3 ~ issue_99325[22bb]::function_with_bytes), UserSubsts { substs: [Const { ty: &'static [u8; 4], kind: Unevaluated([], DefId(0:8 ~ issue_99325[22bb]::main::{constant#1})) }], user_self_ty: None }), max_universe: U0, variables: [] }, span: $DIR/issue_99325.rs:11:16: 11:68, inferred_ty: fn() -> &'static [u8] {function_with_bytes::<&*b\"AAAA\">}\n |\n fn main() -> () {\n     let mut _0: ();                      // return place in scope 0 at $DIR/issue_99325.rs:+0:15: +0:15"}, {"sha": "c425f3cd5069b819e91fa0fcd13477f1b9e221f4", "filename": "tests/mir-opt/nll/region_subtyping_basic.main.nll.0.32bit.mir", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/tests%2Fmir-opt%2Fnll%2Fregion_subtyping_basic.main.nll.0.32bit.mir", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/tests%2Fmir-opt%2Fnll%2Fregion_subtyping_basic.main.nll.0.32bit.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fnll%2Fregion_subtyping_basic.main.nll.0.32bit.mir?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -22,7 +22,7 @@\n |\n fn main() -> () {\n     let mut _0: ();                      // return place in scope 0 at $DIR/region_subtyping_basic.rs:+0:11: +0:11\n-    let mut _1: [usize; Const(Value(Leaf(0x00000003)): usize)]; // in scope 0 at $DIR/region_subtyping_basic.rs:+1:9: +1:14\n+    let mut _1: [usize; Const { ty: usize, kind: Leaf(0x00000003) }]; // in scope 0 at $DIR/region_subtyping_basic.rs:+1:9: +1:14\n     let _3: usize;                       // in scope 0 at $DIR/region_subtyping_basic.rs:+2:16: +2:17\n     let mut _4: usize;                   // in scope 0 at $DIR/region_subtyping_basic.rs:+2:14: +2:18\n     let mut _5: bool;                    // in scope 0 at $DIR/region_subtyping_basic.rs:+2:14: +2:18"}, {"sha": "22ad24f8d772499e55bb6e3570b84e673e805c63", "filename": "tests/mir-opt/nll/region_subtyping_basic.main.nll.0.64bit.mir", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6c64870fa67f0227f40f6adc25a6944e95c2959f/tests%2Fmir-opt%2Fnll%2Fregion_subtyping_basic.main.nll.0.64bit.mir", "raw_url": "https://github.com/rust-lang/rust/raw/6c64870fa67f0227f40f6adc25a6944e95c2959f/tests%2Fmir-opt%2Fnll%2Fregion_subtyping_basic.main.nll.0.64bit.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fnll%2Fregion_subtyping_basic.main.nll.0.64bit.mir?ref=6c64870fa67f0227f40f6adc25a6944e95c2959f", "patch": "@@ -22,7 +22,7 @@\n |\n fn main() -> () {\n     let mut _0: ();                      // return place in scope 0 at $DIR/region_subtyping_basic.rs:+0:11: +0:11\n-    let mut _1: [usize; Const(Value(Leaf(0x0000000000000003)): usize)]; // in scope 0 at $DIR/region_subtyping_basic.rs:+1:9: +1:14\n+    let mut _1: [usize; Const { ty: usize, kind: Leaf(0x0000000000000003) }]; // in scope 0 at $DIR/region_subtyping_basic.rs:+1:9: +1:14\n     let _3: usize;                       // in scope 0 at $DIR/region_subtyping_basic.rs:+2:16: +2:17\n     let mut _4: usize;                   // in scope 0 at $DIR/region_subtyping_basic.rs:+2:14: +2:18\n     let mut _5: bool;                    // in scope 0 at $DIR/region_subtyping_basic.rs:+2:14: +2:18"}]}