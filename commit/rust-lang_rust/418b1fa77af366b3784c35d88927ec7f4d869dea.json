{"sha": "418b1fa77af366b3784c35d88927ec7f4d869dea", "node_id": "C_kwDOAAsO6NoAKDQxOGIxZmE3N2FmMzY2YjM3ODRjMzVkODg5MjdlYzdmNGQ4NjlkZWE", "commit": {"author": {"name": "Eric Huss", "email": "eric@huss.org", "date": "2022-06-25T23:49:00Z"}, "committer": {"name": "Eric Huss", "email": "eric@huss.org", "date": "2022-06-25T23:49:00Z"}, "message": "Fix LLVM rebuild with download-ci-llvm.", "tree": {"sha": "64e85728fef4070e15d05a07fa3d9955fe819555", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64e85728fef4070e15d05a07fa3d9955fe819555"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/418b1fa77af366b3784c35d88927ec7f4d869dea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/418b1fa77af366b3784c35d88927ec7f4d869dea", "html_url": "https://github.com/rust-lang/rust/commit/418b1fa77af366b3784c35d88927ec7f4d869dea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/418b1fa77af366b3784c35d88927ec7f4d869dea/comments", "author": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9cf699d2ff4ff23a6d6862a35727f4d5d3567dae", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cf699d2ff4ff23a6d6862a35727f4d5d3567dae", "html_url": "https://github.com/rust-lang/rust/commit/9cf699d2ff4ff23a6d6862a35727f4d5d3567dae"}], "stats": {"total": 13, "additions": 13, "deletions": 0}, "files": [{"sha": "ea410849694ca9ab7b83b5f700707c45c99f23bc", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/418b1fa77af366b3784c35d88927ec7f4d869dea/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/418b1fa77af366b3784c35d88927ec7f4d869dea/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=418b1fa77af366b3784c35d88927ec7f4d869dea", "patch": "@@ -150,6 +150,19 @@ pub(crate) fn maybe_download_ci_llvm(builder: &Builder<'_>) {\n         for binary in [\"llvm-config\", \"FileCheck\"] {\n             builder.fix_bin_or_dylib(&llvm_root.join(\"bin\").join(binary));\n         }\n+\n+        // Update the timestamp of llvm-config to force rustc_llvm to be\n+        // rebuilt. This is a hacky workaround for a deficiency in Cargo where\n+        // the rerun-if-changed directive doesn't handle changes very well.\n+        // https://github.com/rust-lang/cargo/issues/10791\n+        // Cargo only compares the timestamp of the file relative to the last\n+        // time `rustc_llvm` build script ran. However, the timestamps of the\n+        // files in the tarball are in the past, so it doesn't trigger a\n+        // rebuild.\n+        let now = filetime::FileTime::from_system_time(std::time::SystemTime::now());\n+        let llvm_config = llvm_root.join(\"bin/llvm-config\");\n+        t!(filetime::set_file_times(&llvm_config, now, now));\n+\n         let llvm_lib = llvm_root.join(\"lib\");\n         for entry in t!(fs::read_dir(&llvm_lib)) {\n             let lib = t!(entry).path();"}]}