{"sha": "d32ff14b86c72f55a113a3f477c42b2995e8c620", "node_id": "C_kwDOAAsO6NoAKGQzMmZmMTRiODZjNzJmNTVhMTEzYTNmNDc3YzQyYjI5OTVlOGM2MjA", "commit": {"author": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-08-23T20:14:12Z"}, "committer": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-08-27T15:39:11Z"}, "message": "Add replace-version-placeholder tool\n\nThis tool is to be ran at specific points in the release process to replace\nthe version place holder made by stabilizations with the version number.", "tree": {"sha": "d14a78a6b93f5daab2206353450547a28d11ead9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d14a78a6b93f5daab2206353450547a28d11ead9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d32ff14b86c72f55a113a3f477c42b2995e8c620", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d32ff14b86c72f55a113a3f477c42b2995e8c620", "html_url": "https://github.com/rust-lang/rust/commit/d32ff14b86c72f55a113a3f477c42b2995e8c620", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d32ff14b86c72f55a113a3f477c42b2995e8c620/comments", "author": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "committer": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a2e2d7676822600c81a519343c7eccab9204334b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2e2d7676822600c81a519343c7eccab9204334b", "html_url": "https://github.com/rust-lang/rust/commit/a2e2d7676822600c81a519343c7eccab9204334b"}], "stats": {"total": 117, "additions": 116, "deletions": 1}, "files": [{"sha": "dda8c03e256f1475677470e512a812ada8910311", "filename": "Cargo.lock", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -3293,6 +3293,14 @@ dependencies = [\n  \"winapi\",\n ]\n \n+[[package]]\n+name = \"replace-version-placeholder\"\n+version = \"0.1.0\"\n+dependencies = [\n+ \"tidy\",\n+ \"walkdir\",\n+]\n+\n [[package]]\n name = \"rls\"\n version = \"1.41.0\""}, {"sha": "1e83f05e0ca74ed2d0b849654df63464635bbec0", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -35,6 +35,7 @@ members = [\n   \"src/tools/jsondocck\",\n   \"src/tools/html-checker\",\n   \"src/tools/bump-stage0\",\n+  \"src/tools/replace-version-placeholder\",\n   \"src/tools/lld-wrapper\",\n ]\n "}, {"sha": "c4710e8faecbee40da707f1121f1d7425fbaabef", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -647,6 +647,7 @@ impl<'a> Builder<'a> {\n                 test::CrateRustdocJsonTypes,\n                 test::Linkcheck,\n                 test::TierCheck,\n+                test::ReplacePlaceholderTest,\n                 test::Cargotest,\n                 test::Cargo,\n                 test::Rls,\n@@ -746,7 +747,12 @@ impl<'a> Builder<'a> {\n                 install::Src,\n                 install::Rustc\n             ),\n-            Kind::Run => describe!(run::ExpandYamlAnchors, run::BuildManifest, run::BumpStage0),\n+            Kind::Run => describe!(\n+                run::ExpandYamlAnchors,\n+                run::BuildManifest,\n+                run::BumpStage0,\n+                run::ReplaceVersionPlaceholder,\n+            ),\n             // These commands either don't use paths, or they're special-cased in Build::build()\n             Kind::Clean | Kind::Format | Kind::Setup => vec![],\n         }"}, {"sha": "511872903d14e29d7e2c28ff6efa7b2584785a3d", "filename": "src/bootstrap/run.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Frun.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Frun.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Frun.rs?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -103,3 +103,25 @@ impl Step for BumpStage0 {\n         builder.run(&mut cmd);\n     }\n }\n+\n+#[derive(Debug, PartialOrd, Ord, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct ReplaceVersionPlaceholder;\n+\n+impl Step for ReplaceVersionPlaceholder {\n+    type Output = ();\n+    const ONLY_HOSTS: bool = true;\n+\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.path(\"src/tools/replace-version-placeholder\")\n+    }\n+\n+    fn make_run(run: RunConfig<'_>) {\n+        run.builder.ensure(ReplaceVersionPlaceholder);\n+    }\n+\n+    fn run(self, builder: &Builder<'_>) -> Self::Output {\n+        let mut cmd = builder.tool_cmd(Tool::ReplaceVersionPlaceholder);\n+        cmd.arg(&builder.src);\n+        builder.run(&mut cmd);\n+    }\n+}"}, {"sha": "9cbdb3aca3223b02b42b507aaa97a08b1c0367d6", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -2527,6 +2527,43 @@ impl Step for TierCheck {\n     }\n }\n \n+#[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]\n+pub struct ReplacePlaceholderTest;\n+\n+impl Step for ReplacePlaceholderTest {\n+    type Output = ();\n+    const ONLY_HOSTS: bool = true;\n+    const DEFAULT: bool = true;\n+\n+    /// Ensure the version placeholder replacement tool builds\n+    fn run(self, builder: &Builder<'_>) {\n+        builder.info(\"build check for version replacement placeholder\");\n+\n+        // Test the version placeholder replacement tool itself.\n+        let bootstrap_host = builder.config.build;\n+        let compiler = builder.compiler(0, bootstrap_host);\n+        let cargo = tool::prepare_tool_cargo(\n+            builder,\n+            compiler,\n+            Mode::ToolBootstrap,\n+            bootstrap_host,\n+            \"test\",\n+            \"src/tools/replace-version-placeholder\",\n+            SourceType::InTree,\n+            &[],\n+        );\n+        try_run(builder, &mut cargo.into());\n+    }\n+\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.path(\"src/tools/replace-version-placeholder\")\n+    }\n+\n+    fn make_run(run: RunConfig<'_>) {\n+        run.builder.ensure(Self);\n+    }\n+}\n+\n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]\n pub struct LintDocs {\n     pub compiler: Compiler,"}, {"sha": "5bb40014eb97f20f9977bcf469b106f6379736a2", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -378,6 +378,7 @@ bootstrap_tool!(\n     JsonDocCk, \"src/tools/jsondocck\", \"jsondocck\";\n     HtmlChecker, \"src/tools/html-checker\", \"html-checker\";\n     BumpStage0, \"src/tools/bump-stage0\", \"bump-stage0\";\n+    ReplaceVersionPlaceholder, \"src/tools/replace-version-placeholder\", \"replace-version-placeholder\";\n );\n \n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq, Ord, PartialOrd)]"}, {"sha": "346ce6bd1dbfd2ec71a436058306ad840eabdfe3", "filename": "src/tools/replace-version-placeholder/Cargo.toml", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Ftools%2Freplace-version-placeholder%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Ftools%2Freplace-version-placeholder%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Freplace-version-placeholder%2FCargo.toml?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -0,0 +1,10 @@\n+[package]\n+name = \"replace-version-placeholder\"\n+version = \"0.1.0\"\n+edition = \"2021\"\n+\n+# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n+\n+[dependencies]\n+tidy = { path = \"../tidy\" }\n+walkdir = \"2\""}, {"sha": "146e53f2e9a0f16a1bf1e07bfa3fd3e2fb6e23ce", "filename": "src/tools/replace-version-placeholder/src/main.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Ftools%2Freplace-version-placeholder%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32ff14b86c72f55a113a3f477c42b2995e8c620/src%2Ftools%2Freplace-version-placeholder%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Freplace-version-placeholder%2Fsrc%2Fmain.rs?ref=d32ff14b86c72f55a113a3f477c42b2995e8c620", "patch": "@@ -0,0 +1,30 @@\n+use std::path::PathBuf;\n+use tidy::{t, walk};\n+\n+pub const VERSION_PLACEHOLDER: &str = \"CURRENT_RUSTC_VERSION\";\n+\n+fn main() {\n+    let root_path: PathBuf = std::env::args_os().nth(1).expect(\"need path to root of repo\").into();\n+    let version_path = root_path.join(\"src\").join(\"version\");\n+    let version_str = t!(std::fs::read_to_string(&version_path), version_path);\n+    let version_str = version_str.trim();\n+    walk::walk(\n+        &root_path,\n+        &mut |path| {\n+            walk::filter_dirs(path)\n+                // We exempt these as they require the placeholder\n+                // for their operation\n+                || path.ends_with(\"compiler/rustc_passes/src/lib_features.rs\")\n+                || path.ends_with(\"src/tools/tidy/src/features/version.rs\")\n+                || path.ends_with(\"src/tools/replace-version-placeholder\")\n+        },\n+        &mut |entry, contents| {\n+            if !contents.contains(VERSION_PLACEHOLDER) {\n+                return;\n+            }\n+            let new_contents = contents.replace(VERSION_PLACEHOLDER, version_str);\n+            let path = entry.path();\n+            t!(std::fs::write(&path, new_contents), path);\n+        },\n+    );\n+}"}]}