{"sha": "e52b383a578e213d83a844523196d3c424f97cb6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1MmIzODNhNTc4ZTIxM2Q4M2E4NDQ1MjMxOTZkM2M0MjRmOTdjYjY=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-01-04T00:42:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-01-04T00:42:24Z"}, "message": "Merge pull request #2306 from dtwood/assert-eq-on-one-line\n\nAdd assert_eq! to special-cased macros", "tree": {"sha": "cdfeca7244c9546b63276796d1970df027127452", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cdfeca7244c9546b63276796d1970df027127452"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e52b383a578e213d83a844523196d3c424f97cb6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaTXhwCRBK7hj4Ov3rIwAAdHIIAJcdgnH1Vl7hAAKrkVFwl15u\ncOCKOhfwQV1y6hrflYlEwJatsaBlwLbLNwE9jYICAwJIvFClQyln89hlLD2iJhzD\nVPBYx/CyIVObYSfpvCgrfgGtcmGKnX/6BOcAlYLsrn0jHYSZeOU0K/qZC9A4c1a3\nQdhakJzpJacx+PF8Q3QFbNL9NI2WAUTkuHHcIYdBxqLwhhP2672/aYR9mAV6SLPR\nvHhMGyp1Rwg/J5RTobweOxVn0EFk1EzB53M+COzXDbUQbzaA3KgteIyHEwJT3aOY\nNaCw4wEOx0q3WT355n18rqqk/NJF+kVudc31pDxYo3BTRLYQVqkjrDeLkU/egb8=\n=c//z\n-----END PGP SIGNATURE-----\n", "payload": "tree cdfeca7244c9546b63276796d1970df027127452\nparent 9a7242c7d418eff6db3e11991114f7ee91f282e5\nparent 39e2f43f91e3c3677f39d89f420105648e0a268d\nauthor Nick Cameron <nrc@ncameron.org> 1515026544 +1300\ncommitter GitHub <noreply@github.com> 1515026544 +1300\n\nMerge pull request #2306 from dtwood/assert-eq-on-one-line\n\nAdd assert_eq! to special-cased macros"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e52b383a578e213d83a844523196d3c424f97cb6", "html_url": "https://github.com/rust-lang/rust/commit/e52b383a578e213d83a844523196d3c424f97cb6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e52b383a578e213d83a844523196d3c424f97cb6/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9a7242c7d418eff6db3e11991114f7ee91f282e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a7242c7d418eff6db3e11991114f7ee91f282e5", "html_url": "https://github.com/rust-lang/rust/commit/9a7242c7d418eff6db3e11991114f7ee91f282e5"}, {"sha": "39e2f43f91e3c3677f39d89f420105648e0a268d", "url": "https://api.github.com/repos/rust-lang/rust/commits/39e2f43f91e3c3677f39d89f420105648e0a268d", "html_url": "https://github.com/rust-lang/rust/commit/39e2f43f91e3c3677f39d89f420105648e0a268d"}], "stats": {"total": 209, "additions": 136, "deletions": 73}, "files": [{"sha": "5a8d43a072ff6b9c76f15785f7503812d6e33f1b", "filename": "src/codemap.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e52b383a578e213d83a844523196d3c424f97cb6/src%2Fcodemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e52b383a578e213d83a844523196d3c424f97cb6/src%2Fcodemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcodemap.rs?ref=e52b383a578e213d83a844523196d3c424f97cb6", "patch": "@@ -86,11 +86,9 @@ impl LineRangeUtils for CodeMap {\n         let hi = self.lookup_char_pos(span.hi());\n \n         assert_eq!(\n-            lo.file.name,\n-            hi.file.name,\n+            lo.file.name, hi.file.name,\n             \"span crossed file boundary: lo: {:?}, hi: {:?}\",\n-            lo,\n-            hi\n+            lo, hi\n         );\n \n         LineRange {"}, {"sha": "e64ea7436e332913b67b4fb6140611aaea498c28", "filename": "src/expr.rs", "status": "modified", "additions": 57, "deletions": 41, "changes": 98, "blob_url": "https://github.com/rust-lang/rust/blob/e52b383a578e213d83a844523196d3c424f97cb6/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e52b383a578e213d83a844523196d3c424f97cb6/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=e52b383a578e213d83a844523196d3c424f97cb6", "patch": "@@ -1811,25 +1811,40 @@ fn rewrite_string_lit(context: &RewriteContext, span: Span, shape: Shape) -> Opt\n     )\n }\n \n-const FORMAT_LIKE_WHITELIST: &[&str] = &[\n+/// A list of `format!`-like macros, that take a long format string and a list of arguments to\n+/// format.\n+///\n+/// Organized as a list of `(&str, usize)` tuples, giving the name of the macro and the number of\n+/// arguments before the format string (none for `format!(\"format\", ...)`, one for `assert!(result,\n+/// \"format\", ...)`, two for `assert_eq!(left, right, \"format\", ...)`).\n+const SPECIAL_MACRO_WHITELIST: &[(&str, usize)] = &[\n+    // format! like macros\n     // From the Rust Standard Library.\n-    \"eprint!\",\n-    \"eprintln!\",\n-    \"format!\",\n-    \"format_args!\",\n-    \"print!\",\n-    \"println!\",\n-    \"panic!\",\n-    \"unreachable!\",\n+    (\"eprint!\", 0),\n+    (\"eprintln!\", 0),\n+    (\"format!\", 0),\n+    (\"format_args!\", 0),\n+    (\"print!\", 0),\n+    (\"println!\", 0),\n+    (\"panic!\", 0),\n+    (\"unreachable!\", 0),\n     // From the `log` crate.\n-    \"debug!\",\n-    \"error!\",\n-    \"info!\",\n-    \"warn!\",\n+    (\"debug!\", 0),\n+    (\"error!\", 0),\n+    (\"info!\", 0),\n+    (\"warn!\", 0),\n+    // write! like macros\n+    (\"assert!\", 1),\n+    (\"debug_assert!\", 1),\n+    (\"write!\", 1),\n+    (\"writeln!\", 1),\n+    // assert_eq! like macros\n+    (\"assert_eq!\", 2),\n+    (\"assert_ne!\", 2),\n+    (\"debug_assert_eq!\", 2),\n+    (\"debug_assert_ne!\", 2),\n ];\n \n-const WRITE_LIKE_WHITELIST: &[&str] = &[\"assert!\", \"write!\", \"writeln!\"];\n-\n pub fn rewrite_call(\n     context: &RewriteContext,\n     callee: &str,\n@@ -2066,24 +2081,26 @@ where\n             } else {\n                 tactic = default_tactic();\n \n-                // For special-case macros, we may want to use different tactics.\n-                let maybe_args_offset = maybe_get_args_offset(callee_str, args);\n-\n-                if tactic == DefinitiveListTactic::Vertical && maybe_args_offset.is_some() {\n-                    let args_offset = maybe_args_offset.unwrap();\n-                    let args_tactic = definitive_tactic(\n-                        &item_vec[args_offset..],\n-                        ListTactic::HorizontalVertical,\n-                        Separator::Comma,\n-                        nested_shape.width,\n-                    );\n-\n-                    // Every argument is simple and fits on a single line.\n-                    if args_tactic == DefinitiveListTactic::Horizontal {\n-                        tactic = if args_offset == 1 {\n-                            DefinitiveListTactic::FormatCall\n-                        } else {\n-                            DefinitiveListTactic::WriteCall\n+                if tactic == DefinitiveListTactic::Vertical {\n+                    if let Some((all_simple, num_args_before)) =\n+                        maybe_get_args_offset(callee_str, args)\n+                    {\n+                        let one_line = all_simple\n+                            && definitive_tactic(\n+                                &item_vec[..num_args_before],\n+                                ListTactic::HorizontalVertical,\n+                                Separator::Comma,\n+                                nested_shape.width,\n+                            ) == DefinitiveListTactic::Horizontal\n+                            && definitive_tactic(\n+                                &item_vec[num_args_before + 1..],\n+                                ListTactic::HorizontalVertical,\n+                                Separator::Comma,\n+                                nested_shape.width,\n+                            ) == DefinitiveListTactic::Horizontal;\n+\n+                        if one_line {\n+                            tactic = DefinitiveListTactic::SpecialMacro(num_args_before);\n                         };\n                     }\n                 }\n@@ -2120,15 +2137,14 @@ fn is_every_args_simple<T: ToExpr>(lists: &[&T]) -> bool {\n }\n \n /// In case special-case style is required, returns an offset from which we start horizontal layout.\n-fn maybe_get_args_offset<T: ToExpr>(callee_str: &str, args: &[&T]) -> Option<usize> {\n-    if FORMAT_LIKE_WHITELIST.iter().any(|s| *s == callee_str) && args.len() >= 1\n-        && is_every_args_simple(args)\n-    {\n-        Some(1)\n-    } else if WRITE_LIKE_WHITELIST.iter().any(|s| *s == callee_str) && args.len() >= 2\n-        && is_every_args_simple(args)\n+fn maybe_get_args_offset<T: ToExpr>(callee_str: &str, args: &[&T]) -> Option<(bool, usize)> {\n+    if let Some(&(_, num_args_before)) = SPECIAL_MACRO_WHITELIST\n+        .iter()\n+        .find(|&&(s, _)| s == callee_str)\n     {\n-        Some(2)\n+        let all_simple = args.len() >= num_args_before && is_every_args_simple(args);\n+\n+        Some((all_simple, num_args_before))\n     } else {\n         None\n     }"}, {"sha": "193cd4f3c32e0bb33063a32bcff0522697a67ecf", "filename": "src/lists.rs", "status": "modified", "additions": 9, "deletions": 21, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e52b383a578e213d83a844523196d3c424f97cb6/src%2Flists.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e52b383a578e213d83a844523196d3c424f97cb6/src%2Flists.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flists.rs?ref=e52b383a578e213d83a844523196d3c424f97cb6", "patch": "@@ -160,10 +160,8 @@ pub enum DefinitiveListTactic {\n     Vertical,\n     Horizontal,\n     Mixed,\n-    // Special case tactic for `format!()` variants.\n-    FormatCall,\n-    // Special case tactic for `write!()` varianta.\n-    WriteCall,\n+    /// Special case tactic for `format!()`, `write!()` style macros.\n+    SpecialMacro(usize),\n }\n \n impl DefinitiveListTactic {\n@@ -271,7 +269,7 @@ where\n     I: IntoIterator<Item = T> + Clone,\n     T: AsRef<ListItem>,\n {\n-    let mut tactic = formatting.tactic;\n+    let tactic = formatting.tactic;\n     let sep_len = formatting.separator.len();\n \n     // Now that we know how we will layout, we can decide for sure if there\n@@ -313,26 +311,16 @@ where\n             DefinitiveListTactic::Horizontal if !first => {\n                 result.push(' ');\n             }\n-            DefinitiveListTactic::FormatCall if !first => {\n-                result.push('\\n');\n-                result.push_str(indent_str);\n-                tactic = DefinitiveListTactic::Horizontal;\n-            }\n-            DefinitiveListTactic::WriteCall => {\n-                let second = i == 1;\n-                let third = i == 2;\n-\n-                if first {\n+            DefinitiveListTactic::SpecialMacro(num_args_before) => {\n+                if i == 0 {\n                     // Nothing\n-                } else if second {\n-                    result.push('\\n');\n-                    result.push_str(indent_str);\n-                } else if third {\n+                } else if i < num_args_before {\n+                    result.push(' ');\n+                } else if i <= num_args_before + 1 {\n                     result.push('\\n');\n                     result.push_str(indent_str);\n-                    tactic = DefinitiveListTactic::Horizontal;\n                 } else {\n-                    unreachable!();\n+                    result.push(' ');\n                 }\n             }\n             DefinitiveListTactic::Vertical if !first => {"}, {"sha": "fc2ebcd7e4cfebeea0192ad7a521d5489292394e", "filename": "tests/source/macros.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e52b383a578e213d83a844523196d3c424f97cb6/tests%2Fsource%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e52b383a578e213d83a844523196d3c424f97cb6/tests%2Fsource%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmacros.rs?ref=e52b383a578e213d83a844523196d3c424f97cb6", "patch": "@@ -266,9 +266,15 @@ fn special_case_macros() {\n     warn!(\"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15);\n     warn!(\"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26);\n \n-    assert!(result, \"Ahoy there, {}!\", target);\n-    assert!(result, \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\", result, input, expected);\n-    assert!(result, \"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26);\n+    assert!(result == 42, \"Ahoy there, {}!\", target);\n+    assert!(result == 42, \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\", result, input, expected);\n+    assert!(result == 42, \"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26);\n+\n+    assert_eq!(left, right, \"Ahoy there, {}!\", target);\n+    assert_eq!(left, right, \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\", result, input, expected);\n+    assert_eq!(first_realllllllllllly_long_variable_that_doesnt_fit_one_one_line, second_reallllllllllly_long_variable_that_doesnt_fit_one_one_line, \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\", result, input, expected);\n+    assert_eq!(left + 42, right, \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\", result, input, expected);\n+    assert_eq!(left, right, \"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26);\n \n     write!(&mut s, \"Ahoy there, {}!\", target);\n     write!(&mut s, \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\", result, input, expected);"}, {"sha": "dceb560063476801e997e575641be8aeceecf59c", "filename": "tests/system.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e52b383a578e213d83a844523196d3c424f97cb6/tests%2Fsystem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e52b383a578e213d83a844523196d3c424f97cb6/tests%2Fsystem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsystem.rs?ref=e52b383a578e213d83a844523196d3c424f97cb6", "patch": "@@ -192,8 +192,7 @@ fn self_tests() {\n     }\n \n     assert_eq!(\n-        warnings,\n-        0,\n+        warnings, 0,\n         \"Rustfmt's code generated {} warnings\",\n         warnings\n     );"}, {"sha": "be9027dd108ee118db57a2b9eee7bbc9cdd455ba", "filename": "tests/target/macros.rs", "status": "modified", "additions": 58, "deletions": 2, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/e52b383a578e213d83a844523196d3c424f97cb6/tests%2Ftarget%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e52b383a578e213d83a844523196d3c424f97cb6/tests%2Ftarget%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacros.rs?ref=e52b383a578e213d83a844523196d3c424f97cb6", "patch": "@@ -691,14 +691,70 @@ fn special_case_macros() {\n         26\n     );\n \n-    assert!(result, \"Ahoy there, {}!\", target);\n+    assert!(result == 42, \"Ahoy there, {}!\", target);\n     assert!(\n+        result == 42,\n+        \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\",\n         result,\n+        input,\n+        expected\n+    );\n+    assert!(\n+        result == 42,\n+        \"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\",\n+        1,\n+        2,\n+        3,\n+        4,\n+        5,\n+        6,\n+        7,\n+        8,\n+        9,\n+        10,\n+        11,\n+        12,\n+        13,\n+        14,\n+        15,\n+        16,\n+        17,\n+        18,\n+        19,\n+        20,\n+        21,\n+        22,\n+        23,\n+        24,\n+        25,\n+        26\n+    );\n+\n+    assert_eq!(left, right, \"Ahoy there, {}!\", target);\n+    assert_eq!(\n+        left, right,\n         \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\",\n         result, input, expected\n     );\n-    assert!(\n+    assert_eq!(\n+        first_realllllllllllly_long_variable_that_doesnt_fit_one_one_line,\n+        second_reallllllllllly_long_variable_that_doesnt_fit_one_one_line,\n+        \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\",\n+        result,\n+        input,\n+        expected\n+    );\n+    assert_eq!(\n+        left + 42,\n+        right,\n+        \"Arr! While plunderin' the hold, we got '{}' when given '{}' (we expected '{}')\",\n         result,\n+        input,\n+        expected\n+    );\n+    assert_eq!(\n+        left,\n+        right,\n         \"{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}\",\n         1,\n         2,"}]}