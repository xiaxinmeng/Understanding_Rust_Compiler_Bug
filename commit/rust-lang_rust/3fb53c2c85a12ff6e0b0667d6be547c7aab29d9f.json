{"sha": "3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmYjUzYzJjODVhMTJmZjZlMGIwNjY3ZDZiZTU0N2M3YWFiMjlkOWY=", "commit": {"author": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-01-19T07:11:24Z"}, "committer": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-01-19T15:35:21Z"}, "message": "Fix ICE in mir when evaluating SizeOf on unsized type\n\nFixes #80742", "tree": {"sha": "26fab5678e9d8903f59d1f59f052617900bf9161", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/26fab5678e9d8903f59d1f59f052617900bf9161"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "html_url": "https://github.com/rust-lang/rust/commit/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/comments", "author": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f09fb488f70c5965ec4f64453a6e681fbfcff56c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f09fb488f70c5965ec4f64453a6e681fbfcff56c", "html_url": "https://github.com/rust-lang/rust/commit/f09fb488f70c5965ec4f64453a6e681fbfcff56c"}], "stats": {"total": 86, "additions": 82, "deletions": 4}, "files": [{"sha": "6d447acbecf34caf6679d9fe88eb12e36fdcae7c", "filename": "compiler/rustc_mir/src/interpret/step.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fstep.rs?ref=3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "patch": "@@ -264,10 +264,13 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n             NullaryOp(mir::NullOp::SizeOf, ty) => {\n                 let ty = self.subst_from_current_frame_and_normalize_erasing_regions(ty);\n                 let layout = self.layout_of(ty)?;\n-                assert!(\n-                    !layout.is_unsized(),\n-                    \"SizeOf nullary MIR operator called for unsized type\"\n-                );\n+                if layout.is_unsized() {\n+                    // FIXME: This should be a span_bug (#80742)\n+                    self.tcx.sess.delay_span_bug(\n+                        self.frame().current_span(),\n+                        &format!(\"SizeOf nullary MIR operator called for unsized type {}\", ty),\n+                    );\n+                }\n                 self.write_scalar(Scalar::from_machine_usize(layout.size.bytes(), self), dest)?;\n             }\n "}, {"sha": "c06d182fd567d2acc0cebf1d5a748d96cf6e15c4", "filename": "src/test/ui/mir/issue-80742.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/src%2Ftest%2Fui%2Fmir%2Fissue-80742.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/src%2Ftest%2Fui%2Fmir%2Fissue-80742.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fissue-80742.rs?ref=3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "patch": "@@ -0,0 +1,33 @@\n+// check-fail\n+\n+// This test used to cause an ICE in rustc_mir::interpret::step::eval_rvalue_into_place\n+\n+#![allow(incomplete_features)]\n+#![feature(const_evaluatable_checked)]\n+#![feature(const_generics)]\n+\n+use std::fmt::Debug;\n+use std::marker::PhantomData;\n+use std::mem::size_of;\n+\n+struct Inline<T>\n+where\n+    [u8; size_of::<T>() + 1]: ,\n+{\n+    _phantom: PhantomData<T>,\n+    buf: [u8; size_of::<T>() + 1],\n+}\n+\n+impl<T> Inline<T>\n+where\n+    [u8; size_of::<T>() + 1]: ,\n+{\n+    pub fn new(val: T) -> Inline<T> {\n+        todo!()\n+    }\n+}\n+\n+fn main() {\n+    let dst = Inline::<dyn Debug>::new(0); //~ ERROR\n+    //~^ ERROR\n+}"}, {"sha": "2ec0e9505288bfdc16aa0daf57b65d833cc57ccd", "filename": "src/test/ui/mir/issue-80742.stderr", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/src%2Ftest%2Fui%2Fmir%2Fissue-80742.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f/src%2Ftest%2Fui%2Fmir%2Fissue-80742.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fissue-80742.stderr?ref=3fb53c2c85a12ff6e0b0667d6be547c7aab29d9f", "patch": "@@ -0,0 +1,42 @@\n+error[E0599]: no function or associated item named `new` found for struct `Inline<dyn Debug>` in the current scope\n+  --> $DIR/issue-80742.rs:31:36\n+   |\n+LL | / struct Inline<T>\n+LL | | where\n+LL | |     [u8; size_of::<T>() + 1]: ,\n+LL | | {\n+LL | |     _phantom: PhantomData<T>,\n+LL | |     buf: [u8; size_of::<T>() + 1],\n+LL | | }\n+   | |_- function or associated item `new` not found for this\n+...\n+LL |       let dst = Inline::<dyn Debug>::new(0);\n+   |                                      ^^^ function or associated item not found in `Inline<dyn Debug>`\n+   | \n+  ::: $SRC_DIR/core/src/fmt/mod.rs:LL:COL\n+   |\n+LL |   pub trait Debug {\n+   |   --------------- doesn't satisfy `dyn Debug: Sized`\n+   |\n+   = note: the method `new` exists but the following trait bounds were not satisfied:\n+           `dyn Debug: Sized`\n+\n+error[E0277]: the size for values of type `dyn Debug` cannot be known at compilation time\n+  --> $DIR/issue-80742.rs:31:15\n+   |\n+LL | struct Inline<T>\n+   |               - required by this bound in `Inline`\n+...\n+LL |     let dst = Inline::<dyn Debug>::new(0);\n+   |               ^^^^^^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `dyn Debug`\n+help: consider relaxing the implicit `Sized` restriction\n+   |\n+LL | struct Inline<T: ?Sized>\n+   |                ^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+\n+Some errors have detailed explanations: E0277, E0599.\n+For more information about an error, try `rustc --explain E0277`."}]}