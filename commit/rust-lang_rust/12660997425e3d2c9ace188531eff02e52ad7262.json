{"sha": "12660997425e3d2c9ace188531eff02e52ad7262", "node_id": "C_kwDOAAsO6NoAKDEyNjYwOTk3NDI1ZTNkMmM5YWNlMTg4NTMxZWZmMDJlNTJhZDcyNjI", "commit": {"author": {"name": "Stovent", "email": "elian.hamon@viacesi.fr", "date": "2022-02-10T05:24:12Z"}, "committer": {"name": "Stovent", "email": "elian.hamon@viacesi.fr", "date": "2022-05-30T22:32:27Z"}, "message": "Implement carrying_add and borrowing_sub on signed numbers", "tree": {"sha": "c7156a864674ad6eaa87821e5be9c0b8d5ab2e5d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c7156a864674ad6eaa87821e5be9c0b8d5ab2e5d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12660997425e3d2c9ace188531eff02e52ad7262", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12660997425e3d2c9ace188531eff02e52ad7262", "html_url": "https://github.com/rust-lang/rust/commit/12660997425e3d2c9ace188531eff02e52ad7262", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12660997425e3d2c9ace188531eff02e52ad7262/comments", "author": {"login": "Stovent", "id": 23307724, "node_id": "MDQ6VXNlcjIzMzA3NzI0", "avatar_url": "https://avatars.githubusercontent.com/u/23307724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Stovent", "html_url": "https://github.com/Stovent", "followers_url": "https://api.github.com/users/Stovent/followers", "following_url": "https://api.github.com/users/Stovent/following{/other_user}", "gists_url": "https://api.github.com/users/Stovent/gists{/gist_id}", "starred_url": "https://api.github.com/users/Stovent/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Stovent/subscriptions", "organizations_url": "https://api.github.com/users/Stovent/orgs", "repos_url": "https://api.github.com/users/Stovent/repos", "events_url": "https://api.github.com/users/Stovent/events{/privacy}", "received_events_url": "https://api.github.com/users/Stovent/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Stovent", "id": 23307724, "node_id": "MDQ6VXNlcjIzMzA3NzI0", "avatar_url": "https://avatars.githubusercontent.com/u/23307724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Stovent", "html_url": "https://github.com/Stovent", "followers_url": "https://api.github.com/users/Stovent/followers", "following_url": "https://api.github.com/users/Stovent/following{/other_user}", "gists_url": "https://api.github.com/users/Stovent/gists{/gist_id}", "starred_url": "https://api.github.com/users/Stovent/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Stovent/subscriptions", "organizations_url": "https://api.github.com/users/Stovent/orgs", "repos_url": "https://api.github.com/users/Stovent/repos", "events_url": "https://api.github.com/users/Stovent/events{/privacy}", "received_events_url": "https://api.github.com/users/Stovent/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a8d2e3856c0c75c71998b6c85937203839b946d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a8d2e3856c0c75c71998b6c85937203839b946d", "html_url": "https://github.com/rust-lang/rust/commit/4a8d2e3856c0c75c71998b6c85937203839b946d"}], "stats": {"total": 129, "additions": 129, "deletions": 0}, "files": [{"sha": "4e51b90b835cf01d631bd4962ecd16cdcb023222", "filename": "library/core/src/num/int_macros.rs", "status": "modified", "additions": 80, "deletions": 0, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Fsrc%2Fnum%2Fint_macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Fsrc%2Fnum%2Fint_macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fint_macros.rs?ref=12660997425e3d2c9ace188531eff02e52ad7262", "patch": "@@ -1512,6 +1512,53 @@ macro_rules! int_impl {\n             (a as Self, b)\n         }\n \n+        /// Calculates `self + rhs + carry` without the ability to overflow.\n+        ///\n+        /// Performs \"ternary addition\" which takes in an extra bit to add, and may return an\n+        /// additional bit of overflow. This allows for chaining together multiple additions\n+        /// to create \"big integers\" which represent larger values.\n+        ///\n+        #[doc = concat!(\"This can be thought of as a \", stringify!($BITS), \"-bit \\\"full adder\\\", in the electronics sense.\")]\n+        ///\n+        /// # Examples\n+        ///\n+        /// Basic usage\n+        ///\n+        /// ```\n+        /// #![feature(bigint_helper_methods)]\n+        #[doc = concat!(\"assert_eq!(5\", stringify!($SelfT), \".carrying_add(2, false), (7, false));\")]\n+        #[doc = concat!(\"assert_eq!(5\", stringify!($SelfT), \".carrying_add(2, true), (8, false));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MAX.carrying_add(1, false), (\", stringify!($SelfT), \"::MIN, true));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MAX.carrying_add(0, true), (\", stringify!($SelfT), \"::MIN, true));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MAX.carrying_add(1, true), (\", stringify!($SelfT), \"::MIN + 1, true));\")]\n+        #[doc = concat!(\"assert_eq!(\",\n+            stringify!($SelfT), \"::MAX.carrying_add(\", stringify!($SelfT), \"::MAX, true), \",\n+            \"(-1, true));\"\n+        )]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MIN.carrying_add(-1, true), (\", stringify!($SelfT), \"::MIN, false));\")]\n+        #[doc = concat!(\"assert_eq!(0\", stringify!($SelfT), \".carrying_add(\", stringify!($SelfT), \"::MAX, true), (\", stringify!($SelfT), \"::MIN, true));\")]\n+        /// ```\n+        ///\n+        /// If `carry` is false, this method is equivalent to [`overflowing_add`](Self::overflowing_add):\n+        ///\n+        /// ```\n+        /// #![feature(bigint_helper_methods)]\n+        #[doc = concat!(\"assert_eq!(5_\", stringify!($SelfT), \".carrying_add(2, false), 5_\", stringify!($SelfT), \".overflowing_add(2));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MAX.carrying_add(1, false), \", stringify!($SelfT), \"::MAX.overflowing_add(1));\")]\n+        /// ```\n+        #[unstable(feature = \"bigint_helper_methods\", issue = \"85532\")]\n+        #[rustc_const_unstable(feature = \"const_bigint_helper_methods\", issue = \"85532\")]\n+        #[must_use = \"this returns the result of the operation, \\\n+                      without modifying the original\"]\n+        #[inline]\n+        pub const fn carrying_add(self, rhs: Self, carry: bool) -> (Self, bool) {\n+            // note: longer-term this should be done via an intrinsic.\n+            // note: no intermediate overflow is required (https://github.com/rust-lang/rust/issues/85532#issuecomment-1032214946).\n+            let (a, b) = self.overflowing_add(rhs);\n+            let (c, d) = a.overflowing_add(carry as $SelfT);\n+            (c, b != d)\n+        }\n+\n         /// Calculates `self` + `rhs` with an unsigned `rhs`\n         ///\n         /// Returns a tuple of the addition along with a boolean indicating\n@@ -1563,6 +1610,39 @@ macro_rules! int_impl {\n             (a as Self, b)\n         }\n \n+        /// Calculates `self - rhs - borrow` without the ability to overflow.\n+        ///\n+        /// Performs \"ternary subtraction\" which takes in an extra bit to subtract, and may return\n+        /// an additional bit of overflow. This allows for chaining together multiple subtractions\n+        /// to create \"big integers\" which represent larger values.\n+        ///\n+        /// # Examples\n+        ///\n+        /// Basic usage\n+        ///\n+        /// ```\n+        /// #![feature(bigint_helper_methods)]\n+        #[doc = concat!(\"assert_eq!(5\", stringify!($SelfT), \".borrowing_sub(2, false), (3, false));\")]\n+        #[doc = concat!(\"assert_eq!(5\", stringify!($SelfT), \".borrowing_sub(2, true), (2, false));\")]\n+        #[doc = concat!(\"assert_eq!(0\", stringify!($SelfT), \".borrowing_sub(1, false), (-1, false));\")]\n+        #[doc = concat!(\"assert_eq!(0\", stringify!($SelfT), \".borrowing_sub(1, true), (-2, false));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MIN.borrowing_sub(1, true), (\", stringify!($SelfT), \"::MAX - 1, true));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MAX.borrowing_sub(-1, false), (\", stringify!($SelfT), \"::MIN, true));\")]\n+        #[doc = concat!(\"assert_eq!(\", stringify!($SelfT), \"::MAX.borrowing_sub(-1, true), (\", stringify!($SelfT), \"::MAX, false));\")]\n+        /// ```\n+        #[unstable(feature = \"bigint_helper_methods\", issue = \"85532\")]\n+        #[rustc_const_unstable(feature = \"const_bigint_helper_methods\", issue = \"85532\")]\n+        #[must_use = \"this returns the result of the operation, \\\n+                      without modifying the original\"]\n+        #[inline]\n+        pub const fn borrowing_sub(self, rhs: Self, borrow: bool) -> (Self, bool) {\n+            // note: longer-term this should be done via an intrinsic.\n+            // note: no intermediate overflow is required (https://github.com/rust-lang/rust/issues/85532#issuecomment-1032214946).\n+            let (a, b) = self.overflowing_sub(rhs);\n+            let (c, d) = a.overflowing_sub(borrow as $SelfT);\n+            (c, b != d)\n+        }\n+\n         /// Calculates `self` - `rhs` with an unsigned `rhs`\n         ///\n         /// Returns a tuple of the subtraction along with a boolean indicating"}, {"sha": "3132d8adb3620c680607c0e68015453b1835bd92", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=12660997425e3d2c9ace188531eff02e52ad7262", "patch": "@@ -3,6 +3,7 @@\n #![feature(array_methods)]\n #![feature(array_windows)]\n #![feature(bench_black_box)]\n+#![feature(bigint_helper_methods)]\n #![feature(cell_update)]\n #![feature(const_assume)]\n #![feature(const_black_box)]"}, {"sha": "18c55e43aac81958d897a9e85141f7483eb24387", "filename": "library/core/tests/num/int_macros.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Ftests%2Fnum%2Fint_macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Ftests%2Fnum%2Fint_macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fnum%2Fint_macros.rs?ref=12660997425e3d2c9ace188531eff02e52ad7262", "patch": "@@ -338,6 +338,32 @@ macro_rules! int_module {\n                 assert_eq!(MIN.checked_next_multiple_of(-3), None);\n                 assert_eq!(MIN.checked_next_multiple_of(-1), Some(MIN));\n             }\n+\n+            #[test]\n+            fn test_carrying_add() {\n+                assert_eq!($T::MAX.carrying_add(1, false), ($T::MIN, true));\n+                assert_eq!($T::MAX.carrying_add(0, true), ($T::MIN, true));\n+                assert_eq!($T::MAX.carrying_add(1, true), ($T::MIN + 1, true));\n+                assert_eq!($T::MAX.carrying_add(-1, false), ($T::MAX - 1, false));\n+                assert_eq!($T::MAX.carrying_add(-1, true), ($T::MAX, false)); // no intermediate overflow\n+                assert_eq!($T::MIN.carrying_add(-1, false), ($T::MAX, true));\n+                assert_eq!($T::MIN.carrying_add(-1, true), ($T::MIN, false)); // no intermediate overflow\n+                assert_eq!((0 as $T).carrying_add($T::MAX, true), ($T::MIN, true));\n+                assert_eq!((0 as $T).carrying_add($T::MIN, true), ($T::MIN + 1, false));\n+            }\n+\n+            #[test]\n+            fn test_borrowing_sub() {\n+                assert_eq!($T::MIN.borrowing_sub(1, false), ($T::MAX, true));\n+                assert_eq!($T::MIN.borrowing_sub(0, true), ($T::MAX, true));\n+                assert_eq!($T::MIN.borrowing_sub(1, true), ($T::MAX - 1, true));\n+                assert_eq!($T::MIN.borrowing_sub(-1, false), ($T::MIN + 1, false));\n+                assert_eq!($T::MIN.borrowing_sub(-1, true), ($T::MIN, false)); // no intermediate overflow\n+                assert_eq!($T::MAX.borrowing_sub(-1, false), ($T::MIN, true));\n+                assert_eq!($T::MAX.borrowing_sub(-1, true), ($T::MAX, false)); // no intermediate overflow\n+                assert_eq!((0 as $T).borrowing_sub($T::MIN, false), ($T::MIN, true));\n+                assert_eq!((0 as $T).borrowing_sub($T::MIN, true), ($T::MAX, false));\n+            }\n         }\n     };\n }"}, {"sha": "15ae9f2324f6c8a29605576e793f9609571f42ab", "filename": "library/core/tests/num/uint_macros.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Ftests%2Fnum%2Fuint_macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12660997425e3d2c9ace188531eff02e52ad7262/library%2Fcore%2Ftests%2Fnum%2Fuint_macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fnum%2Fuint_macros.rs?ref=12660997425e3d2c9ace188531eff02e52ad7262", "patch": "@@ -230,6 +230,28 @@ macro_rules! uint_module {\n                 assert_eq!((1 as $T).checked_next_multiple_of(0), None);\n                 assert_eq!(MAX.checked_next_multiple_of(2), None);\n             }\n+\n+            #[test]\n+            fn test_carrying_add() {\n+                assert_eq!($T::MAX.carrying_add(1, false), (0, true));\n+                assert_eq!($T::MAX.carrying_add(0, true), (0, true));\n+                assert_eq!($T::MAX.carrying_add(1, true), (1, true));\n+\n+                assert_eq!($T::MIN.carrying_add($T::MAX, false), ($T::MAX, false));\n+                assert_eq!($T::MIN.carrying_add(0, true), (1, false));\n+                assert_eq!($T::MIN.carrying_add($T::MAX, true), (0, true));\n+            }\n+\n+            #[test]\n+            fn test_borrowing_sub() {\n+                assert_eq!($T::MIN.borrowing_sub(1, false), ($T::MAX, true));\n+                assert_eq!($T::MIN.borrowing_sub(0, true), ($T::MAX, true));\n+                assert_eq!($T::MIN.borrowing_sub(1, true), ($T::MAX - 1, true));\n+\n+                assert_eq!($T::MAX.borrowing_sub($T::MAX, false), (0, false));\n+                assert_eq!($T::MAX.borrowing_sub(0, true), ($T::MAX - 1, false));\n+                assert_eq!($T::MAX.borrowing_sub($T::MAX, true), ($T::MAX, true));\n+            }\n         }\n     };\n }"}]}