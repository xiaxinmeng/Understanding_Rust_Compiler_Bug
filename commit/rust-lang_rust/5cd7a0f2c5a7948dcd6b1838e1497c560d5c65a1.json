{"sha": "5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVjZDdhMGYyYzVhNzk0OGRjZDZiMTgzOGUxNDk3YzU2MGQ1YzY1YTE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-02-17T11:58:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-17T11:58:35Z"}, "message": "Merge #7704\n\n7704: Avoid transmitting unchanged diagnostics r=matklad a=michalmuskala\n\nReading through the code for diagnostics and observing debug logs, I noticed\r\nthat diagnostics are transmitted after every change for every opened file,\r\neven if they haven't changed (especially visible for files with no diagnostics).\r\n\r\nThis change avoids marking files as \"changed\" if diagnostics are the same to what\r\nwas already sent before. This will only work if diagnostics are always produced in\r\nthe same order, but from my limited testing it seems this is the case.\n\nCo-authored-by: Micha\u0142 Muska\u0142a <michal@muskala.eu>", "tree": {"sha": "d019f37897f2902244ff726dacbf19346e23d4d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d019f37897f2902244ff726dacbf19346e23d4d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgLQTrCRBK7hj4Ov3rIwAAdHIIACxNagqidS/cnqQug5MAl+Sa\nIekAVBgzcTT0hwoUVMu500CDBHRl5sFVR9Mth6Efly3d86CPTcY8H7IfI5j0XfSV\nRXvTzdjq0r7d1bEeXp/XthPXGqYl4uG6gZCn0mwCRF7saGM2hLnnh/vA3VFtHPoW\nbwFklRBGvGhcWWLUeEI3NwSD8JkWHAXYTW6uHQ1DQbdYOnwV+SPXzdg+cgeMFpkl\nkB3d9dcxIHDPk2eKILh0C0PNNf63wca9EwoUGypbaQGHtjedzTH7+TA5RI58cLcu\nOy2FnuhnEYFScPf3oQ1GKklDLq8uzCXWjomfahFbWkTNLSjYzaAJRqx4s0Hc3vs=\n=vuC+\n-----END PGP SIGNATURE-----\n", "payload": "tree d019f37897f2902244ff726dacbf19346e23d4d5\nparent 2920e7b28b58400a9026e92f28fc0304d71c7376\nparent 528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1613563115 +0000\ncommitter GitHub <noreply@github.com> 1613563115 +0000\n\nMerge #7704\n\n7704: Avoid transmitting unchanged diagnostics r=matklad a=michalmuskala\n\nReading through the code for diagnostics and observing debug logs, I noticed\r\nthat diagnostics are transmitted after every change for every opened file,\r\neven if they haven't changed (especially visible for files with no diagnostics).\r\n\r\nThis change avoids marking files as \"changed\" if diagnostics are the same to what\r\nwas already sent before. This will only work if diagnostics are always produced in\r\nthe same order, but from my limited testing it seems this is the case.\n\nCo-authored-by: Micha\u0142 Muska\u0142a <michal@muskala.eu>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1", "html_url": "https://github.com/rust-lang/rust/commit/5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2920e7b28b58400a9026e92f28fc0304d71c7376", "url": "https://api.github.com/repos/rust-lang/rust/commits/2920e7b28b58400a9026e92f28fc0304d71c7376", "html_url": "https://github.com/rust-lang/rust/commit/2920e7b28b58400a9026e92f28fc0304d71c7376"}, {"sha": "528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "url": "https://api.github.com/repos/rust-lang/rust/commits/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "html_url": "https://github.com/rust-lang/rust/commit/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00"}], "stats": {"total": 11, "additions": 11, "deletions": 0}, "files": [{"sha": "f01548c50a8af7cc90f90f1a555992a41ff67a81", "filename": "crates/rust-analyzer/src/diagnostics.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs?ref=5cd7a0f2c5a7948dcd6b1838e1497c560d5c65a1", "patch": "@@ -65,6 +65,17 @@ impl DiagnosticCollection {\n         file_id: FileId,\n         diagnostics: Vec<lsp_types::Diagnostic>,\n     ) {\n+        if let Some(existing_diagnostics) = self.native.get(&file_id) {\n+            if existing_diagnostics.len() == diagnostics.len()\n+                && diagnostics\n+                    .iter()\n+                    .zip(existing_diagnostics)\n+                    .all(|(new, existing)| are_diagnostics_equal(new, existing))\n+            {\n+                return;\n+            }\n+        }\n+\n         self.native.insert(file_id, diagnostics);\n         self.changes.insert(file_id);\n     }"}]}