{"sha": "f87bc6a5d186fa12234f283a90dfc310d133e567", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4N2JjNmE1ZDE4NmZhMTIyMzRmMjgzYTkwZGZjMzEwZDEzM2U1Njc=", "commit": {"author": {"name": "Edward Wang", "email": "edward.yu.wang@gmail.com", "date": "2014-06-21T20:03:15Z"}, "committer": {"name": "Edward Wang", "email": "edward.yu.wang@gmail.com", "date": "2014-06-21T20:03:15Z"}, "message": "Make destructuring trait reference work\n\nCloses #15031.", "tree": {"sha": "59ba6ee4846ffd0dfe99a6e3495bf367f67b3d14", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59ba6ee4846ffd0dfe99a6e3495bf367f67b3d14"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f87bc6a5d186fa12234f283a90dfc310d133e567", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f87bc6a5d186fa12234f283a90dfc310d133e567", "html_url": "https://github.com/rust-lang/rust/commit/f87bc6a5d186fa12234f283a90dfc310d133e567", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f87bc6a5d186fa12234f283a90dfc310d133e567/comments", "author": {"login": "edwardw", "id": 454049, "node_id": "MDQ6VXNlcjQ1NDA0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/454049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwardw", "html_url": "https://github.com/edwardw", "followers_url": "https://api.github.com/users/edwardw/followers", "following_url": "https://api.github.com/users/edwardw/following{/other_user}", "gists_url": "https://api.github.com/users/edwardw/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwardw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwardw/subscriptions", "organizations_url": "https://api.github.com/users/edwardw/orgs", "repos_url": "https://api.github.com/users/edwardw/repos", "events_url": "https://api.github.com/users/edwardw/events{/privacy}", "received_events_url": "https://api.github.com/users/edwardw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwardw", "id": 454049, "node_id": "MDQ6VXNlcjQ1NDA0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/454049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwardw", "html_url": "https://github.com/edwardw", "followers_url": "https://api.github.com/users/edwardw/followers", "following_url": "https://api.github.com/users/edwardw/following{/other_user}", "gists_url": "https://api.github.com/users/edwardw/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwardw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwardw/subscriptions", "organizations_url": "https://api.github.com/users/edwardw/orgs", "repos_url": "https://api.github.com/users/edwardw/repos", "events_url": "https://api.github.com/users/edwardw/events{/privacy}", "received_events_url": "https://api.github.com/users/edwardw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ae4b97c09a5b5c230f5dee9bdcef85951b6e00d", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ae4b97c09a5b5c230f5dee9bdcef85951b6e00d", "html_url": "https://github.com/rust-lang/rust/commit/0ae4b97c09a5b5c230f5dee9bdcef85951b6e00d"}], "stats": {"total": 79, "additions": 68, "deletions": 11}, "files": [{"sha": "fd89423f304cac70a167dfd8f31c49ae9c0658a0", "filename": "src/librustc/middle/typeck/check/_match.rs", "status": "modified", "additions": 26, "deletions": 10, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/f87bc6a5d186fa12234f283a90dfc310d133e567/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f87bc6a5d186fa12234f283a90dfc310d133e567/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2F_match.rs?ref=f87bc6a5d186fa12234f283a90dfc310d133e567", "patch": "@@ -726,22 +726,38 @@ pub fn check_pat(pcx: &pat_ctxt, pat: &ast::Pat, expected: ty::t) {\n }\n \n // Helper function to check gc, box and & patterns\n-pub fn check_pointer_pat(pcx: &pat_ctxt,\n-                         pointer_kind: PointerKind,\n-                         inner: &ast::Pat,\n-                         pat_id: ast::NodeId,\n-                         span: Span,\n-                         expected: ty::t) {\n+fn check_pointer_pat(pcx: &pat_ctxt,\n+                     pointer_kind: PointerKind,\n+                     inner: &ast::Pat,\n+                     pat_id: ast::NodeId,\n+                     span: Span,\n+                     expected: ty::t) {\n     let fcx = pcx.fcx;\n+    let tcx = fcx.ccx.tcx;\n     let check_inner: |ty::t| = |e_inner| {\n-        check_pat(pcx, inner, e_inner);\n-        fcx.write_ty(pat_id, expected);\n+        match ty::get(e_inner).sty {\n+            ty::ty_trait(_) if pat_is_binding(&tcx.def_map, inner) => {\n+                // This is \"x = SomeTrait\" being reduced from\n+                // \"let &x = &SomeTrait\" or \"let box x = Box<SomeTrait>\", an error.\n+                check_pat(pcx, inner, ty::mk_err());\n+                tcx.sess.span_err(\n+                    span,\n+                    format!(\"type `{}` cannot be dereferenced\",\n+                            fcx.infcx().ty_to_str(expected)).as_slice());\n+                fcx.write_error(pat_id);\n+            }\n+            _ => {\n+                check_pat(pcx, inner, e_inner);\n+                fcx.write_ty(pat_id, expected);\n+            }\n+        }\n     };\n+\n     match *structure_of(fcx, span, expected) {\n-        ty::ty_uniq(e_inner) if pointer_kind == Send && !ty::type_is_trait(e_inner) => {\n+        ty::ty_uniq(e_inner) if pointer_kind == Send => {\n             check_inner(e_inner);\n         }\n-        ty::ty_rptr(_, e_inner) if pointer_kind == Borrowed && !ty::type_is_trait(e_inner.ty) => {\n+        ty::ty_rptr(_, e_inner) if pointer_kind == Borrowed => {\n             check_inner(e_inner.ty);\n         }\n         _ => {"}, {"sha": "671bf45c9338fa68d9549546e57c6151ea30e29b", "filename": "src/test/compile-fail/destructure-trait-ref.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/f87bc6a5d186fa12234f283a90dfc310d133e567/src%2Ftest%2Fcompile-fail%2Fdestructure-trait-ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f87bc6a5d186fa12234f283a90dfc310d133e567/src%2Ftest%2Fcompile-fail%2Fdestructure-trait-ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fdestructure-trait-ref.rs?ref=f87bc6a5d186fa12234f283a90dfc310d133e567", "patch": "@@ -0,0 +1,41 @@\n+// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// The regression test for #15031 to make sure destructuring trait\n+// reference work properly.\n+\n+trait T {}\n+impl T for int {}\n+\n+fn main() {\n+    // For an expression of the form:\n+    //\n+    //      let &...&x = &..&SomeTrait;\n+    //\n+    // Say we have n `&` at the left hand and m `&` right hand, then:\n+    // if n < m, we are golden;\n+    // if n == m, it's a derefing non-derefable type error;\n+    // if n > m, it's a type mismatch error.\n+\n+    // n < m\n+    let &x = &(&1 as &T);\n+    let &x = &&(&1 as &T);\n+    let &&x = &&(&1 as &T);\n+\n+    // n == m\n+    let &x = &1 as &T;      //~ ERROR cannot be dereferenced\n+    let &&x = &(&1 as &T);  //~ ERROR cannot be dereferenced\n+    let box x = box 1 as Box<T>; //~ ERROR cannot be dereferenced\n+\n+    // n > m\n+    let &&x = &1 as &T;     //~ ERROR found an `&`-pointer pattern\n+    let &&&x = &(&1 as &T); //~ ERROR found an `&`-pointer pattern\n+    let box box x = box 1 as Box<T>;    //~ ERROR found a box pattern\n+}"}, {"sha": "edd6932aec6f0d3900614ad11699aced0a25fb3f", "filename": "src/test/compile-fail/issue-4972.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f87bc6a5d186fa12234f283a90dfc310d133e567/src%2Ftest%2Fcompile-fail%2Fissue-4972.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f87bc6a5d186fa12234f283a90dfc310d133e567/src%2Ftest%2Fcompile-fail%2Fissue-4972.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-4972.rs?ref=f87bc6a5d186fa12234f283a90dfc310d133e567", "patch": "@@ -17,7 +17,7 @@ pub enum TraitWrapper {\n \n fn get_tw_map<'lt>(tw: &'lt TraitWrapper) -> &'lt MyTrait {\n     match *tw {\n-        A(box ref map) => map, //~ ERROR found a box pattern\n+        A(box ref map) => map, //~ ERROR cannot be dereferenced\n     }\n }\n "}]}