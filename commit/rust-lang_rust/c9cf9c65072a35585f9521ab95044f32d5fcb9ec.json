{"sha": "c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "node_id": "C_kwDOAAsO6NoAKGM5Y2Y5YzY1MDcyYTM1NTg1Zjk1MjFhYjk1MDQ0ZjMyZDVmY2I5ZWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-01T02:03:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-01T02:03:23Z"}, "message": "Auto merge of #92294 - Kobzol:rustdoc-meta-kind, r=GuillaumeGomez\n\nAdd Attribute::meta_kind\n\nThe `AttrItem::meta` function is being called on a lot of places, however almost always the caller is only interested in the `kind` of the result `MetaItem`. Before, the `path`  had to be cloned in order to get the kind, now it does not have to be.\n\nThere is a larger related \"problem\". In a lot of places, something wants to know contents of attributes. This is accessed through `Attribute::meta_item_list`, which calls `AttrItem::meta` (now `AttrItem::meta_kind`), among other methods. When this function is called, the meta item list has to be recreated from scratch. Everytime something asks a simple question (like is this item/list of attributes `#[doc(hidden)]`?), the tokens of the attribute(s) are cloned, parsed and the results are allocated on the heap. That seems really unnecessary. What would be the best way to cache this? Turn `meta_item_list` into a query perhaps? Related PR: https://github.com/rust-lang/rust/pull/92227\n\nr? rust-lang/rustdoc", "tree": {"sha": "da4d7b058007b67b96335ce0a9720758f99b45a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da4d7b058007b67b96335ce0a9720758f99b45a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "html_url": "https://github.com/rust-lang/rust/commit/c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d2e0fd96ccbb9ade41f1a3f07b14b7437f8e4ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d2e0fd96ccbb9ade41f1a3f07b14b7437f8e4ef", "html_url": "https://github.com/rust-lang/rust/commit/4d2e0fd96ccbb9ade41f1a3f07b14b7437f8e4ef"}, {"sha": "047275a68266033b2d7646e5380d8491ec550677", "url": "https://api.github.com/repos/rust-lang/rust/commits/047275a68266033b2d7646e5380d8491ec550677", "html_url": "https://github.com/rust-lang/rust/commit/047275a68266033b2d7646e5380d8491ec550677"}], "stats": {"total": 43, "additions": 32, "deletions": 11}, "files": [{"sha": "d66774040f782955855f71cc98d5e33f3f12f453", "filename": "compiler/rustc_ast/src/attr/mod.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_ast%2Fsrc%2Fattr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_ast%2Fsrc%2Fattr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fattr%2Fmod.rs?ref=c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "patch": "@@ -136,15 +136,15 @@ impl Attribute {\n \n     pub fn value_str(&self) -> Option<Symbol> {\n         match self.kind {\n-            AttrKind::Normal(ref item, _) => item.meta(self.span).and_then(|meta| meta.value_str()),\n+            AttrKind::Normal(ref item, _) => item.meta_kind().and_then(|kind| kind.value_str()),\n             AttrKind::DocComment(..) => None,\n         }\n     }\n \n     pub fn meta_item_list(&self) -> Option<Vec<NestedMetaItem>> {\n         match self.kind {\n-            AttrKind::Normal(ref item, _) => match item.meta(self.span) {\n-                Some(MetaItem { kind: MetaItemKind::List(list), .. }) => Some(list),\n+            AttrKind::Normal(ref item, _) => match item.meta_kind() {\n+                Some(MetaItemKind::List(list)) => Some(list),\n                 _ => None,\n             },\n             AttrKind::DocComment(..) => None,\n@@ -228,6 +228,10 @@ impl AttrItem {\n             span,\n         })\n     }\n+\n+    pub fn meta_kind(&self) -> Option<MetaItemKind> {\n+        Some(MetaItemKind::from_mac_args(&self.args)?)\n+    }\n }\n \n impl Attribute {\n@@ -242,7 +246,7 @@ impl Attribute {\n         match self.kind {\n             AttrKind::DocComment(.., data) => Some(data),\n             AttrKind::Normal(ref item, _) if item.path == sym::doc => {\n-                item.meta(self.span).and_then(|meta| meta.value_str())\n+                item.meta_kind().and_then(|kind| kind.value_str())\n             }\n             _ => None,\n         }\n@@ -270,6 +274,13 @@ impl Attribute {\n         }\n     }\n \n+    pub fn meta_kind(&self) -> Option<MetaItemKind> {\n+        match self.kind {\n+            AttrKind::Normal(ref item, _) => item.meta_kind(),\n+            AttrKind::DocComment(..) => None,\n+        }\n+    }\n+\n     pub fn tokens(&self) -> AttrAnnotatedTokenStream {\n         match self.kind {\n             AttrKind::Normal(_, ref tokens) => tokens\n@@ -436,6 +447,16 @@ impl MetaItem {\n }\n \n impl MetaItemKind {\n+    pub fn value_str(&self) -> Option<Symbol> {\n+        match self {\n+            MetaItemKind::NameValue(ref v) => match v.kind {\n+                LitKind::Str(ref s, _) => Some(*s),\n+                _ => None,\n+            },\n+            _ => None,\n+        }\n+    }\n+\n     pub fn mac_args(&self, span: Span) -> MacArgs {\n         match self {\n             MetaItemKind::Word => MacArgs::Empty,"}, {"sha": "cb51555f5cadfabe109ddb2be9ae9a37a39aec75", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "patch": "@@ -484,7 +484,7 @@ pub(crate) fn check_attr_crate_type(\n                     return;\n                 }\n \n-                if let ast::MetaItemKind::NameValue(spanned) = a.meta().unwrap().kind {\n+                if let ast::MetaItemKind::NameValue(spanned) = a.meta_kind().unwrap() {\n                     let span = spanned.span;\n                     let lev_candidate = find_best_match_for_name(\n                         &CRATE_TYPES.iter().map(|(k, _)| *k).collect::<Vec<_>>(),"}, {"sha": "40d12c4a22dd37d1ed085ffd82e2ee9b0207b997", "filename": "compiler/rustc_passes/src/lib_features.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs?ref=c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "patch": "@@ -4,7 +4,7 @@\n // and `#[unstable (..)]`), but are not declared in one single location\n // (unlike lang features), which means we need to collect them instead.\n \n-use rustc_ast::{Attribute, MetaItem, MetaItemKind};\n+use rustc_ast::{Attribute, MetaItemKind};\n use rustc_errors::struct_span_err;\n use rustc_hir::intravisit::{NestedVisitorMap, Visitor};\n use rustc_middle::hir::map::Map;\n@@ -34,8 +34,8 @@ impl<'tcx> LibFeatureCollector<'tcx> {\n         // Find a stability attribute (i.e., `#[stable (..)]`, `#[unstable (..)]`,\n         // `#[rustc_const_unstable (..)]`).\n         if let Some(stab_attr) = stab_attrs.iter().find(|stab_attr| attr.has_name(**stab_attr)) {\n-            let meta_item = attr.meta();\n-            if let Some(MetaItem { kind: MetaItemKind::List(ref metas), .. }) = meta_item {\n+            let meta_kind = attr.meta_kind();\n+            if let Some(MetaItemKind::List(ref metas)) = meta_kind {\n                 let mut feature = None;\n                 let mut since = None;\n                 for meta in metas {"}, {"sha": "2fb5590016ef88514547d39fe3b27c9f473e7360", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9cf9c65072a35585f9521ab95044f32d5fcb9ec/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=c9cf9c65072a35585f9521ab95044f32d5fcb9ec", "patch": "@@ -2894,7 +2894,7 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n                 }\n             }\n         } else if attr.has_name(sym::instruction_set) {\n-            codegen_fn_attrs.instruction_set = match attr.meta().map(|i| i.kind) {\n+            codegen_fn_attrs.instruction_set = match attr.meta_kind() {\n                 Some(MetaItemKind::List(ref items)) => match items.as_slice() {\n                     [NestedMetaItem::MetaItem(set)] => {\n                         let segments =\n@@ -2999,7 +2999,7 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n         if !attr.has_name(sym::inline) {\n             return ia;\n         }\n-        match attr.meta().map(|i| i.kind) {\n+        match attr.meta_kind() {\n             Some(MetaItemKind::Word) => InlineAttr::Hint,\n             Some(MetaItemKind::List(ref items)) => {\n                 inline_span = Some(attr.span);\n@@ -3038,7 +3038,7 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n             return ia;\n         }\n         let err = |sp, s| struct_span_err!(tcx.sess.diagnostic(), sp, E0722, \"{}\", s).emit();\n-        match attr.meta().map(|i| i.kind) {\n+        match attr.meta_kind() {\n             Some(MetaItemKind::Word) => {\n                 err(attr.span, \"expected one argument\");\n                 ia"}]}