{"sha": "52a33655be8f2afc1ac666d24b5850badb23b3e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyYTMzNjU1YmU4ZjJhZmMxYWM2NjZkMjRiNTg1MGJhZGIyM2IzZTc=", "commit": {"author": {"name": "12101111", "email": "w12101111@gmail.com", "date": "2021-05-24T09:53:09Z"}, "committer": {"name": "12101111", "email": "w12101111@gmail.com", "date": "2021-05-26T11:22:58Z"}, "message": "cleanup and fix compiling of libunwind\n\nfix conditional compiling of llvm-libunwind feaure for musl target.\nupdate document of llvm-libunwind feature.", "tree": {"sha": "8ff4ed51f63cc3e79169a3ac291d3899873c699e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ff4ed51f63cc3e79169a3ac291d3899873c699e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52a33655be8f2afc1ac666d24b5850badb23b3e7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEERq7VLWSlisBf3CZ8l3hfrfOKl9wFAmCuL58ACgkQl3hfrfOK\nl9x8chAA4pTWDh5+Sh9wKkOgceX3pdxM6w87uOflK0BCuTBuyYSgoCbDVDsQxTmx\n5ptWtIQokW72aQN/5FVd4A+C5I4qAlBPnyCHcUWLC4P8I3I3pO9FuU50tjv9Fk4B\nALTwOfDm2aXTvH1YXCw8/UAhYOqJAvWM+duQs+iN1pRYY8EQglOEgnO6GabcvxcB\nGQyRwWfYL8P1t7fm2U28BYdLGNBJTgIrxvoweDpmSX40vobk/AENEm7+Q7xnelcN\nMqmMgcLeZ4UAH0gbHpElAMK4S+/avsjvC1yIrvfk417ixv0QFmjl2OUmGr9jmkHD\nfYwmSH4TWxYRMbNTh4/q+q4xFKfNEZifsfNVtBgTNvCnLnknRLrATGEWa3iiagAN\nc08PtaQM9hMGATgFXHAegMW8WxxUpYZ9f6inl25PcIrVN/3cN1BwFSVrxgssbeYC\n6wdn+nsauark40+wpcfFkU29xESPxyoJBS6SlDRYwO2saTFqsJCeTd6cP/DmFqWv\nI6OW6eUNa7ZpA7lOL39OsdWDCbwlHBZ6omYMFP2Jbk1mjWa3KWyf1/d6yO9AiXe5\n6f/XAaEbkre7AYajbUoMxOg0384dekrL194bmMPdi7W9TS/l/Sof9aXZ69AmuWy8\nmBa/9XW266aE+rhhXuBuQ+9b5B9bPEWn6pbAecnu+dM9qcfLev8=\n=V3eP\n-----END PGP SIGNATURE-----", "payload": "tree 8ff4ed51f63cc3e79169a3ac291d3899873c699e\nparent 126561cb31e8ebe1e2dd9dfd0d3ca621308dc56f\nauthor 12101111 <w12101111@gmail.com> 1621849989 +0800\ncommitter 12101111 <w12101111@gmail.com> 1622028178 +0800\n\ncleanup and fix compiling of libunwind\n\nfix conditional compiling of llvm-libunwind feaure for musl target.\nupdate document of llvm-libunwind feature.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52a33655be8f2afc1ac666d24b5850badb23b3e7", "html_url": "https://github.com/rust-lang/rust/commit/52a33655be8f2afc1ac666d24b5850badb23b3e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52a33655be8f2afc1ac666d24b5850badb23b3e7/comments", "author": {"login": "12101111", "id": 8438475, "node_id": "MDQ6VXNlcjg0Mzg0NzU=", "avatar_url": "https://avatars.githubusercontent.com/u/8438475?v=4", "gravatar_id": "", "url": "https://api.github.com/users/12101111", "html_url": "https://github.com/12101111", "followers_url": "https://api.github.com/users/12101111/followers", "following_url": "https://api.github.com/users/12101111/following{/other_user}", "gists_url": "https://api.github.com/users/12101111/gists{/gist_id}", "starred_url": "https://api.github.com/users/12101111/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/12101111/subscriptions", "organizations_url": "https://api.github.com/users/12101111/orgs", "repos_url": "https://api.github.com/users/12101111/repos", "events_url": "https://api.github.com/users/12101111/events{/privacy}", "received_events_url": "https://api.github.com/users/12101111/received_events", "type": "User", "site_admin": false}, "committer": {"login": "12101111", "id": 8438475, "node_id": "MDQ6VXNlcjg0Mzg0NzU=", "avatar_url": "https://avatars.githubusercontent.com/u/8438475?v=4", "gravatar_id": "", "url": "https://api.github.com/users/12101111", "html_url": "https://github.com/12101111", "followers_url": "https://api.github.com/users/12101111/followers", "following_url": "https://api.github.com/users/12101111/following{/other_user}", "gists_url": "https://api.github.com/users/12101111/gists{/gist_id}", "starred_url": "https://api.github.com/users/12101111/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/12101111/subscriptions", "organizations_url": "https://api.github.com/users/12101111/orgs", "repos_url": "https://api.github.com/users/12101111/repos", "events_url": "https://api.github.com/users/12101111/events{/privacy}", "received_events_url": "https://api.github.com/users/12101111/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "126561cb31e8ebe1e2dd9dfd0d3ca621308dc56f", "url": "https://api.github.com/repos/rust-lang/rust/commits/126561cb31e8ebe1e2dd9dfd0d3ca621308dc56f", "html_url": "https://github.com/rust-lang/rust/commit/126561cb31e8ebe1e2dd9dfd0d3ca621308dc56f"}], "stats": {"total": 182, "additions": 106, "deletions": 76}, "files": [{"sha": "df2fb448b7d4dc9b437636fe6ff40f69e3c8257d", "filename": "config.toml.example", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/52a33655be8f2afc1ac666d24b5850badb23b3e7/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/52a33655be8f2afc1ac666d24b5850badb23b3e7/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=52a33655be8f2afc1ac666d24b5850badb23b3e7", "patch": "@@ -563,6 +563,14 @@ changelog-seen = 2\n \n # Use LLVM libunwind as the implementation for Rust's unwinder.\n # Accepted values are 'in-tree' (formerly true), 'system' or 'no' (formerly false).\n+# This option only applies for Linux and Fuchsia targets.\n+# On Linux target, if crt-static is not enabled, 'no' means dynamic link to\n+# `libgcc_s.so`, 'in-tree' means static link to the in-tree build of llvm libunwind\n+# and 'system' means dynamic link to `libunwind.so`. If crt-static is enabled,\n+# the behavior is depend on the libc. On musl target, 'no' and 'in-tree' both \n+# means static link to the in-tree build of llvm libunwind, and 'system' means \n+# static link to `libunwind.a` provided by system. Due to the limitation of glibc,\n+# it must link to `libgcc_eh.a` to get a working output, and this option have no effect.\n #llvm-libunwind = 'no'\n \n # Enable Windows Control Flow Guard checks in the standard library."}, {"sha": "9273ad0c3a46f6640c017110aa65d41b4d287e35", "filename": "library/unwind/Cargo.toml", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/52a33655be8f2afc1ac666d24b5850badb23b3e7/library%2Funwind%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/52a33655be8f2afc1ac666d24b5850badb23b3e7/library%2Funwind%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Funwind%2FCargo.toml?ref=52a33655be8f2afc1ac666d24b5850badb23b3e7", "patch": "@@ -24,5 +24,12 @@ cfg-if = \"0.1.8\"\n cc = \"1.0.67\"\n \n [features]\n+\n+# Only applies for Linux and Fuchsia targets\n+# Static link to the in-tree build of llvm libunwind\n llvm-libunwind = []\n+\n+# Only applies for Linux and Fuchsia targets\n+# If crt-static is enabled, static link to `libunwind.a` provided by system\n+# If crt-static is disabled, dynamic link to `libunwind.so` provided by system\n system-llvm-libunwind = []"}, {"sha": "96df3fc5ac4c8351980da712da87705cfac19324", "filename": "library/unwind/build.rs", "status": "modified", "additions": 74, "deletions": 72, "changes": 146, "blob_url": "https://github.com/rust-lang/rust/blob/52a33655be8f2afc1ac666d24b5850badb23b3e7/library%2Funwind%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52a33655be8f2afc1ac666d24b5850badb23b3e7/library%2Funwind%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Funwind%2Fbuild.rs?ref=52a33655be8f2afc1ac666d24b5850badb23b3e7", "patch": "@@ -4,7 +4,8 @@ fn main() {\n     println!(\"cargo:rerun-if-changed=build.rs\");\n     let target = env::var(\"TARGET\").expect(\"TARGET was not set\");\n \n-    if cfg!(feature = \"system-llvm-libunwind\") {\n+    if cfg!(target_os = \"linux\") && cfg!(feature = \"system-llvm-libunwind\") {\n+        // linking for Linux is handled in lib.rs\n         return;\n     }\n \n@@ -57,101 +58,102 @@ mod llvm_libunwind {\n     pub fn compile() {\n         let target = env::var(\"TARGET\").expect(\"TARGET was not set\");\n         let target_env = env::var(\"CARGO_CFG_TARGET_ENV\").unwrap();\n-        let target_vendor = env::var(\"CARGO_CFG_TARGET_VENDOR\").unwrap();\n-        let target_endian_little = env::var(\"CARGO_CFG_TARGET_ENDIAN\").unwrap() != \"big\";\n-        let cfg = &mut cc::Build::new();\n-\n-        cfg.cpp(true);\n-        cfg.cpp_set_stdlib(None);\n-        cfg.warnings(false);\n+        let mut cc_cfg = cc::Build::new();\n+        let mut cpp_cfg = cc::Build::new();\n+        let root = Path::new(\"../../src/llvm-project/libunwind\");\n \n-        // libunwind expects a __LITTLE_ENDIAN__ macro to be set for LE archs, cf. #65765\n-        if target_endian_little {\n-            cfg.define(\"__LITTLE_ENDIAN__\", Some(\"1\"));\n+        cpp_cfg.cpp(true);\n+        cpp_cfg.cpp_set_stdlib(None);\n+        cpp_cfg.flag(\"-nostdinc++\");\n+        cpp_cfg.flag(\"-fno-exceptions\");\n+        cpp_cfg.flag(\"-fno-rtti\");\n+        cpp_cfg.flag_if_supported(\"-fvisibility-global-new-delete-hidden\");\n+\n+        // Don't set this for clang\n+        // By default, Clang builds C code in GNU C17 mode.\n+        // By default, Clang builds C++ code according to the C++98 standard,\n+        // with many C++11 features accepted as extensions.\n+        if cpp_cfg.get_compiler().is_like_gnu() {\n+            cpp_cfg.flag(\"-std=c++11\");\n+            cc_cfg.flag(\"-std=c99\");\n         }\n \n-        if target_env == \"msvc\" {\n-            // Don't pull in extra libraries on MSVC\n-            cfg.flag(\"/Zl\");\n-            cfg.flag(\"/EHsc\");\n-            cfg.define(\"_CRT_SECURE_NO_WARNINGS\", None);\n-            cfg.define(\"_LIBUNWIND_DISABLE_VISIBILITY_ANNOTATIONS\", None);\n-        } else if target.contains(\"x86_64-fortanix-unknown-sgx\") {\n-            cfg.cpp(false);\n-\n-            cfg.static_flag(true);\n-            cfg.opt_level(3);\n-\n-            cfg.flag(\"-nostdinc++\");\n-            cfg.flag(\"-fno-exceptions\");\n-            cfg.flag(\"-fno-rtti\");\n-            cfg.flag(\"-fstrict-aliasing\");\n-            cfg.flag(\"-funwind-tables\");\n-            cfg.flag(\"-fvisibility=hidden\");\n-            cfg.flag(\"-fno-stack-protector\");\n-            cfg.flag(\"-ffreestanding\");\n-            cfg.flag(\"-fexceptions\");\n-\n-            // easiest way to undefine since no API available in cc::Build to undefine\n-            cfg.flag(\"-U_FORTIFY_SOURCE\");\n-            cfg.define(\"_FORTIFY_SOURCE\", \"0\");\n-\n-            cfg.flag_if_supported(\"-fvisibility-global-new-delete-hidden\");\n+        if target.contains(\"x86_64-fortanix-unknown-sgx\") || target_env == \"musl\" {\n+            // use the same GCC C compiler command to compile C++ code so we do not need to setup the\n+            // C++ compiler env variables on the builders.\n+            // Don't set this for clang++, as clang++ is able to compile this without libc++.\n+            if cpp_cfg.get_compiler().is_like_gnu() {\n+                cpp_cfg.cpp(false);\n+            }\n+        }\n \n-            cfg.define(\"_LIBUNWIND_DISABLE_VISIBILITY_ANNOTATIONS\", None);\n-            cfg.define(\"RUST_SGX\", \"1\");\n-            cfg.define(\"__NO_STRING_INLINES\", None);\n-            cfg.define(\"__NO_MATH_INLINES\", None);\n-            cfg.define(\"_LIBUNWIND_IS_BAREMETAL\", None);\n-            cfg.define(\"__LIBUNWIND_IS_NATIVE_ONLY\", None);\n-            cfg.define(\"NDEBUG\", None);\n-        } else {\n-            cfg.flag(\"-std=c99\");\n-            cfg.flag(\"-std=c++11\");\n-            cfg.flag(\"-nostdinc++\");\n-            cfg.flag(\"-fno-exceptions\");\n-            cfg.flag(\"-fno-rtti\");\n+        for cfg in [&mut cc_cfg, &mut cpp_cfg].iter_mut() {\n+            cfg.warnings(false);\n             cfg.flag(\"-fstrict-aliasing\");\n             cfg.flag(\"-funwind-tables\");\n             cfg.flag(\"-fvisibility=hidden\");\n-            cfg.flag_if_supported(\"-fvisibility-global-new-delete-hidden\");\n             cfg.define(\"_LIBUNWIND_DISABLE_VISIBILITY_ANNOTATIONS\", None);\n+            cfg.include(root.join(\"include\"));\n+            cfg.cargo_metadata(false);\n+\n+            if target.contains(\"x86_64-fortanix-unknown-sgx\") {\n+                cfg.static_flag(true);\n+                cfg.opt_level(3);\n+                cfg.flag(\"-fno-stack-protector\");\n+                cfg.flag(\"-ffreestanding\");\n+                cfg.flag(\"-fexceptions\");\n+\n+                // easiest way to undefine since no API available in cc::Build to undefine\n+                cfg.flag(\"-U_FORTIFY_SOURCE\");\n+                cfg.define(\"_FORTIFY_SOURCE\", \"0\");\n+                cfg.define(\"RUST_SGX\", \"1\");\n+                cfg.define(\"__NO_STRING_INLINES\", None);\n+                cfg.define(\"__NO_MATH_INLINES\", None);\n+                cfg.define(\"_LIBUNWIND_IS_BAREMETAL\", None);\n+                cfg.define(\"__LIBUNWIND_IS_NATIVE_ONLY\", None);\n+                cfg.define(\"NDEBUG\", None);\n+            }\n         }\n \n-        let mut unwind_sources = vec![\n-            \"Unwind-EHABI.cpp\",\n-            \"Unwind-seh.cpp\",\n+        let mut c_sources = vec![\n             \"Unwind-sjlj.c\",\n             \"UnwindLevel1-gcc-ext.c\",\n             \"UnwindLevel1.c\",\n             \"UnwindRegistersRestore.S\",\n             \"UnwindRegistersSave.S\",\n-            \"libunwind.cpp\",\n         ];\n \n-        if target_vendor == \"apple\" {\n-            unwind_sources.push(\"Unwind_AppleExtras.cpp\");\n-        }\n+        let cpp_sources = vec![\"Unwind-EHABI.cpp\", \"Unwind-seh.cpp\", \"libunwind.cpp\"];\n+        let cpp_len = cpp_sources.len();\n \n         if target.contains(\"x86_64-fortanix-unknown-sgx\") {\n-            unwind_sources.push(\"UnwindRustSgx.c\");\n+            c_sources.push(\"UnwindRustSgx.c\");\n         }\n \n-        let root = Path::new(\"../../src/llvm-project/libunwind\");\n-        cfg.include(root.join(\"include\"));\n-        for src in unwind_sources {\n-            cfg.file(root.join(\"src\").join(src));\n+        for src in c_sources {\n+            cc_cfg.file(root.join(\"src\").join(src).canonicalize().unwrap());\n         }\n \n-        if target_env == \"musl\" {\n-            // use the same C compiler command to compile C++ code so we do not need to setup the\n-            // C++ compiler env variables on the builders\n-            cfg.cpp(false);\n-            // linking for musl is handled in lib.rs\n-            cfg.cargo_metadata(false);\n-            println!(\"cargo:rustc-link-search=native={}\", env::var(\"OUT_DIR\").unwrap());\n+        for src in cpp_sources {\n+            cpp_cfg.file(root.join(\"src\").join(src).canonicalize().unwrap());\n         }\n \n-        cfg.compile(\"unwind\");\n+        let out_dir = env::var(\"OUT_DIR\").unwrap();\n+        println!(\"cargo:rustc-link-search=native={}\", &out_dir);\n+\n+        cpp_cfg.compile(\"unwind-cpp\");\n+\n+        let mut count = 0;\n+        for entry in std::fs::read_dir(&out_dir).unwrap() {\n+            let obj = entry.unwrap().path().canonicalize().unwrap();\n+            if let Some(ext) = obj.extension() {\n+                if ext == \"o\" {\n+                    cc_cfg.object(&obj);\n+                    count += 1;\n+                }\n+            }\n+        }\n+        assert_eq!(cpp_len, count, \"Can't get object files from {:?}\", &out_dir);\n+        cc_cfg.compile(\"unwind\");\n     }\n }"}, {"sha": "eaeec72fbb55b473230e5100cff49ec2c33aa3b1", "filename": "library/unwind/src/lib.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/52a33655be8f2afc1ac666d24b5850badb23b3e7/library%2Funwind%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52a33655be8f2afc1ac666d24b5850badb23b3e7/library%2Funwind%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Funwind%2Fsrc%2Flib.rs?ref=52a33655be8f2afc1ac666d24b5850badb23b3e7", "patch": "@@ -37,9 +37,22 @@ cfg_if::cfg_if! {\n }\n \n #[cfg(target_env = \"musl\")]\n-#[link(name = \"unwind\", kind = \"static\", cfg(target_feature = \"crt-static\"))]\n-#[link(name = \"gcc_s\", cfg(not(target_feature = \"crt-static\")))]\n-extern \"C\" {}\n+cfg_if::cfg_if! {\n+    if #[cfg(all(feature = \"llvm-libunwind\", feature = \"system-llvm-libunwind\"))] {\n+        compile_error!(\"`llvm-libunwind` and `system-llvm-libunwind` cannot be enabled at the same time\");\n+    } else if #[cfg(feature = \"llvm-libunwind\")] {\n+        #[link(name = \"unwind\", kind = \"static\")]\n+        extern \"C\" {}\n+    } else if #[cfg(feature = \"system-llvm-libunwind\")] {\n+        #[link(name = \"unwind\", kind = \"static-nobundle\", cfg(target_feature = \"crt-static\"))]\n+        #[link(name = \"unwind\", cfg(not(target_feature = \"crt-static\")))]\n+        extern \"C\" {}\n+    } else {\n+        #[link(name = \"unwind\", kind = \"static\", cfg(target_feature = \"crt-static\"))]\n+        #[link(name = \"gcc_s\", cfg(not(target_feature = \"crt-static\")))]\n+        extern \"C\" {}\n+    }\n+}\n \n // When building with crt-static, we get `gcc_eh` from the `libc` crate, since\n // glibc needs it, and needs it listed later on the linker command line. We\n@@ -68,5 +81,5 @@ extern \"C\" {}\n extern \"C\" {}\n \n #[cfg(all(target_vendor = \"fortanix\", target_env = \"sgx\"))]\n-#[link(name = \"unwind\", kind = \"static-nobundle\")]\n+#[link(name = \"unwind\", kind = \"static\")]\n extern \"C\" {}"}]}