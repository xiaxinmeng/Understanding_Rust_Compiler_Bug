{"sha": "1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFiMmM1YzRjOWI4MjM1ODg1ZTcwYTNkZDk0ZGMzZTViZWU3YzdmZmQ=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2011-09-16T20:03:11Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2011-09-16T20:06:31Z"}, "message": "Make ty_fn_ret pure and get rid of a duplicate function", "tree": {"sha": "e109dfd7c5e9dbda2e712348b71c80ea5c7707e4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e109dfd7c5e9dbda2e712348b71c80ea5c7707e4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd", "html_url": "https://github.com/rust-lang/rust/commit/1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "43b219dbec5a3fa0ded5c02c95149d8517343087", "url": "https://api.github.com/repos/rust-lang/rust/commits/43b219dbec5a3fa0ded5c02c95149d8517343087", "html_url": "https://github.com/rust-lang/rust/commit/43b219dbec5a3fa0ded5c02c95149d8517343087"}], "stats": {"total": 30, "additions": 14, "deletions": 16}, "files": [{"sha": "f97bbd68f52ba73af90d35360cfa4cdd361ce0e0", "filename": "src/comp/middle/ty.rs", "status": "modified", "additions": 14, "deletions": 16, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd/src%2Fcomp%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd/src%2Fcomp%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Fty.rs?ref=1b2c5c4c9b8235885e70a3dd94dc3e5bee7c7ffd", "patch": "@@ -92,7 +92,6 @@ export pat_ty;\n export cname;\n export rename;\n export ret_ty_of_fn;\n-export ret_ty_of_fn_ty;\n export sequence_element_type;\n export struct;\n export sort_methods;\n@@ -1600,11 +1599,21 @@ fn ty_fn_abi(cx: ctxt, fty: t) -> ast::native_abi {\n     }\n }\n \n-fn ty_fn_ret(cx: ctxt, fty: t) -> t {\n-    alt struct(cx, fty) {\n+pure fn ty_fn_ret(cx: ctxt, fty: t) -> t {\n+    // Should be pure, as type interner contents\n+    // shouldn't change once set...\n+    let sty = unchecked { struct(cx, fty) };\n+    alt sty {\n       ty::ty_fn(_, _, r, _, _) { ret r; }\n       ty::ty_native_fn(_, _, r) { ret r; }\n-      _ { cx.sess.bug(\"ty_fn_ret() called on non-fn type\"); }\n+      _ {\n+        // Unchecked is ok since we diverge here\n+        // (might want to change the typechecker to allow\n+        // it without an unchecked)\n+        // Or, it wouldn't be necessary if we had the right\n+        // typestate constraint on cx and t (then we could\n+        // call unreachable() instead)\n+        unchecked { cx.sess.bug(\"ty_fn_ret() called on non-fn type\"); }}\n     }\n }\n \n@@ -2634,19 +2643,8 @@ fn lookup_item_type(cx: ctxt, did: ast::def_id) -> ty_param_kinds_and_ty {\n     }\n }\n \n-fn ret_ty_of_fn_ty(cx: ctxt, a_ty: t) -> t {\n-    alt ty::struct(cx, a_ty) {\n-      ty::ty_fn(_, _, ret_ty, _, _) { ret ret_ty; }\n-      ty::ty_native_fn(_, _, ret_ty) { ret ret_ty; }\n-      _ {\n-        cx.sess.bug(\"ret_ty_of_fn_ty() called on non-function type: \" +\n-                        ty_to_str(cx, a_ty));\n-      }\n-    }\n-}\n-\n fn ret_ty_of_fn(cx: ctxt, id: ast::node_id) -> t {\n-    ret ret_ty_of_fn_ty(cx, node_id_to_type(cx, id));\n+    ty_fn_ret(cx, node_id_to_type(cx, id))\n }\n \n fn is_binopable(cx: ctxt, ty: t, op: ast::binop) -> bool {"}]}