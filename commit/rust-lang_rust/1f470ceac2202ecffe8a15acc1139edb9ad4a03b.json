{"sha": "1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmNDcwY2VhYzIyMDJlY2ZmZThhMTVhY2MxMTM5ZWRiOWFkNGEwM2I=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-09-21T17:18:41Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-23T22:32:03Z"}, "message": "pre-expansion gate decl_macro", "tree": {"sha": "a10d1f399cfab5d1274f84e5a4585dba3955ade2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a10d1f399cfab5d1274f84e5a4585dba3955ade2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "html_url": "https://github.com/rust-lang/rust/commit/1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "49cbfa1a6f6469ddbc0e88161e52104cc87aea9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/49cbfa1a6f6469ddbc0e88161e52104cc87aea9b", "html_url": "https://github.com/rust-lang/rust/commit/49cbfa1a6f6469ddbc0e88161e52104cc87aea9b"}], "stats": {"total": 31, "additions": 24, "deletions": 7}, "files": [{"sha": "8fbb449d88c01a5fbbf504d4622d8ff229bbb607", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "patch": "@@ -220,7 +220,7 @@\n \n #![cfg_attr(test, feature(print_internals, set_stdio, update_panic_count))]\n #![cfg_attr(all(target_vendor = \"fortanix\", target_env = \"sgx\"),\n-            feature(slice_index_methods, decl_macro, coerce_unsized,\n+            feature(slice_index_methods, coerce_unsized,\n                     sgx_platform, ptr_wrapping_offset_from))]\n #![cfg_attr(all(test, target_vendor = \"fortanix\", target_env = \"sgx\"),\n             feature(fixed_size_array, maybe_uninit_extra))]\n@@ -251,6 +251,7 @@\n #![feature(container_error_extra)]\n #![feature(core_intrinsics)]\n #![feature(custom_test_frameworks)]\n+#![feature(decl_macro)]\n #![feature(doc_alias)]\n #![feature(doc_cfg)]\n #![feature(doc_keyword)]"}, {"sha": "9882db4e3f30880d192bf9f7333a5146edf5efc0", "filename": "src/libsyntax/feature_gate/check.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibsyntax%2Ffeature_gate%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibsyntax%2Ffeature_gate%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate%2Fcheck.rs?ref=1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "patch": "@@ -420,11 +420,6 @@ impl<'a> Visitor<'a> for PostExpansionVisitor<'a> {\n                                    \"auto traits are experimental and possibly buggy\");\n             }\n \n-            ast::ItemKind::MacroDef(ast::MacroDef { legacy: false, .. }) => {\n-                let msg = \"`macro` is experimental\";\n-                gate_feature_post!(&self, decl_macro, i.span, msg);\n-            }\n-\n             ast::ItemKind::OpaqueTy(..) => {\n                 gate_feature_post!(\n                     &self,\n@@ -831,6 +826,7 @@ pub fn check_crate(krate: &ast::Crate,\n     gate_all!(associated_type_bounds, \"associated type bounds are unstable\");\n     gate_all!(crate_visibility_modifier, \"`crate` visibility modifier is experimental\");\n     gate_all!(const_generics, \"const generics are unstable\");\n+    gate_all!(decl_macro, \"`macro` is experimental\");\n \n     visit::walk_crate(&mut visitor, krate);\n }"}, {"sha": "95bddb5afdd08dcd76ddbdf69b2dea16e17758cb", "filename": "src/libsyntax/parse/parser/item.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibsyntax%2Fparse%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibsyntax%2Fparse%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser%2Fitem.rs?ref=1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "patch": "@@ -1706,6 +1706,11 @@ impl<'a> Parser<'a> {\n         };\n \n         let span = lo.to(self.prev_span);\n+\n+        if !def.legacy {\n+            self.sess.gated_spans.decl_macro.borrow_mut().push(span);\n+        }\n+\n         Ok(Some(self.mk_item(span, ident, ItemKind::MacroDef(def), vis.clone(), attrs.to_vec())))\n     }\n "}, {"sha": "30aeff752ec40b82db6cf9abff70619a194a8d4f", "filename": "src/libsyntax/sess.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibsyntax%2Fsess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Flibsyntax%2Fsess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fsess.rs?ref=1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "patch": "@@ -38,6 +38,8 @@ crate struct GatedSpans {\n     pub crate_visibility_modifier: Lock<Vec<Span>>,\n     /// Spans collected for gating `const_generics`, e.g. `const N: usize`.\n     pub const_generics: Lock<Vec<Span>>,\n+    /// Spans collected for gating `decl_macro`, e.g. `macro m() {}`.\n+    pub decl_macro: Lock<Vec<Span>>,\n }\n \n /// Info about a parsing session."}, {"sha": "b208a047481a4b35183ab4921e49712127f2bfcf", "filename": "src/test/ui/feature-gates/feature-gate-decl_macro.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-decl_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-decl_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-decl_macro.rs?ref=1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "patch": "@@ -2,4 +2,8 @@\n \n macro m() {} //~ ERROR `macro` is experimental\n \n+macro_rules! accept_item { ($i:item) => {} }\n+accept_item! {\n+    macro m() {} //~ ERROR `macro` is experimental\n+}\n fn main() {}"}, {"sha": "c6690ebd4d91779186143f076e2bf106fe350905", "filename": "src/test/ui/feature-gates/feature-gate-decl_macro.stderr", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-decl_macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1f470ceac2202ecffe8a15acc1139edb9ad4a03b/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-decl_macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-decl_macro.stderr?ref=1f470ceac2202ecffe8a15acc1139edb9ad4a03b", "patch": "@@ -7,6 +7,15 @@ LL | macro m() {}\n    = note: for more information, see https://github.com/rust-lang/rust/issues/39412\n    = help: add `#![feature(decl_macro)]` to the crate attributes to enable\n \n-error: aborting due to previous error\n+error[E0658]: `macro` is experimental\n+  --> $DIR/feature-gate-decl_macro.rs:7:5\n+   |\n+LL |     macro m() {}\n+   |     ^^^^^^^^^^^^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/39412\n+   = help: add `#![feature(decl_macro)]` to the crate attributes to enable\n+\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0658`."}]}