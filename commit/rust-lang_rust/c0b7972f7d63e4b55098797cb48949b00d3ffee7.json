{"sha": "c0b7972f7d63e4b55098797cb48949b00d3ffee7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwYjc5NzJmN2Q2M2U0YjU1MDk4Nzk3Y2I0ODk0OWIwMGQzZmZlZTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-11-12T00:11:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-11-12T00:11:22Z"}, "message": "auto merge of #10422 : alexcrichton/rust/explicit-crate-map, r=pcwalton\n\nAs we start to move runtime components into the crate map, it's becoming harder\r\nand harder to start the runtime from a C function as rust is embedded in another\r\napplication. Right now if you compile a rust crate as a dynamic library which is\r\nthen linked to another application, when using std::rt::start there are no I/O\r\nlocal services, even though rustuv was linked against and requested. The reason\r\nfor this is that there is no top level crate map available specifying where to\r\nfind libuv I/O.\r\n\r\nThis option is not meant to be used regularly, but rather whenever compiling a\r\nfinal library crate and linking it into another application. This lifts the\r\nrequirement that to get a crate map you must have the final destination be an\r\nexecutable.", "tree": {"sha": "d73361e59d704339a9dd2f2e68d23da09b5a00de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d73361e59d704339a9dd2f2e68d23da09b5a00de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0b7972f7d63e4b55098797cb48949b00d3ffee7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0b7972f7d63e4b55098797cb48949b00d3ffee7", "html_url": "https://github.com/rust-lang/rust/commit/c0b7972f7d63e4b55098797cb48949b00d3ffee7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0b7972f7d63e4b55098797cb48949b00d3ffee7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88e383ef1e702666159bdc899d81e30927479501", "url": "https://api.github.com/repos/rust-lang/rust/commits/88e383ef1e702666159bdc899d81e30927479501", "html_url": "https://github.com/rust-lang/rust/commit/88e383ef1e702666159bdc899d81e30927479501"}, {"sha": "2eb92b77a97b5657919d636700d72f7578af2a4f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2eb92b77a97b5657919d636700d72f7578af2a4f", "html_url": "https://github.com/rust-lang/rust/commit/2eb92b77a97b5657919d636700d72f7578af2a4f"}], "stats": {"total": 7, "additions": 6, "deletions": 1}, "files": [{"sha": "d08127501b4d216d204bbe1b02709b9c99dbe25f", "filename": "src/librustc/driver/session.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c0b7972f7d63e4b55098797cb48949b00d3ffee7/src%2Flibrustc%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0b7972f7d63e4b55098797cb48949b00d3ffee7/src%2Flibrustc%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fsession.rs?ref=c0b7972f7d63e4b55098797cb48949b00d3ffee7", "patch": "@@ -76,6 +76,7 @@ pub static no_vectorize_loops:      uint = 1 << 26;\n pub static no_vectorize_slp:        uint = 1 << 27;\n pub static no_prepopulate_passes:   uint = 1 << 28;\n pub static use_softfp:              uint = 1 << 29;\n+pub static gen_crate_map:           uint = 1 << 30;\n \n pub fn debugging_opts_map() -> ~[(&'static str, &'static str, uint)] {\n     ~[(\"verbose\", \"in general, enable more debug printouts\", verbose),\n@@ -128,6 +129,7 @@ pub fn debugging_opts_map() -> ~[(&'static str, &'static str, uint)] {\n       \"Don't run LLVM's SLP vectorization passes\",\n       no_vectorize_slp),\n      (\"soft-float\", \"Generate software floating point library calls\", use_softfp),\n+     (\"gen-crate-map\", \"Force generation of a toplevel crate map\", gen_crate_map),\n     ]\n }\n \n@@ -331,6 +333,9 @@ impl Session_ {\n     pub fn no_vectorize_slp(&self) -> bool {\n         self.debugging_opt(no_vectorize_slp)\n     }\n+    pub fn gen_crate_map(&self) -> bool {\n+        self.debugging_opt(gen_crate_map)\n+    }\n \n     // pointless function, now...\n     pub fn str_of(&self, id: ast::Ident) -> @str {"}, {"sha": "a6e71b22bf582072157df81bd7dd1045bd01aa79", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c0b7972f7d63e4b55098797cb48949b00d3ffee7/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0b7972f7d63e4b55098797cb48949b00d3ffee7/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=c0b7972f7d63e4b55098797cb48949b00d3ffee7", "patch": "@@ -2949,7 +2949,7 @@ pub fn decl_crate_map(sess: session::Session, mapmeta: LinkMeta,\n     let mut n_subcrates = 1;\n     let cstore = sess.cstore;\n     while cstore::have_crate_data(cstore, n_subcrates) { n_subcrates += 1; }\n-    let mapname = if *sess.building_library {\n+    let mapname = if *sess.building_library && !sess.gen_crate_map() {\n         format!(\"{}_{}_{}\", mapmeta.name, mapmeta.vers, mapmeta.extras_hash)\n     } else {\n         ~\"toplevel\""}]}