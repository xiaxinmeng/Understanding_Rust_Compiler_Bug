{"sha": "0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlYjY4Yjc5N2IyZDJkMmFlMjAwOTNiODI0ZjY5ZmU4MTdjOTZlZDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-01T08:05:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-01T08:05:51Z"}, "message": "Auto merge of #48786 - nagisa:fp, r=nikomatsakis\n\nAdd force-frame-pointer flag to allow control of frame pointer ommision\n\nRebase of #47152 plus some changes suggested by https://github.com/rust-lang/rust/issues/48785.\n\nFixes #11906\n\nr? @nikomatsakis", "tree": {"sha": "6ecf044bbcbc9428764478a7936312c9ffc4d8b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ecf044bbcbc9428764478a7936312c9ffc4d8b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "html_url": "https://github.com/rust-lang/rust/commit/0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "491512ba1ed37a20b514c216c3eddaa732689de9", "url": "https://api.github.com/repos/rust-lang/rust/commits/491512ba1ed37a20b514c216c3eddaa732689de9", "html_url": "https://github.com/rust-lang/rust/commit/491512ba1ed37a20b514c216c3eddaa732689de9"}, {"sha": "7ec045219040876730693543e6cca53120a3236b", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ec045219040876730693543e6cca53120a3236b", "html_url": "https://github.com/rust-lang/rust/commit/7ec045219040876730693543e6cca53120a3236b"}], "stats": {"total": 36, "additions": 31, "deletions": 5}, "files": [{"sha": "59b40e9e2dc56b489ed986e1a0d54c45f4824394", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -1053,6 +1053,8 @@ options! {CodegenOptions, CodegenSetter, basic_codegen_options,\n          2 = full debug info with variable and type information\"),\n     opt_level: Option<String> = (None, parse_opt_string, [TRACKED],\n         \"optimize with possible levels 0-3, s, or z\"),\n+    force_frame_pointers: Option<bool> = (None, parse_opt_bool, [TRACKED],\n+        \"force use of the frame pointers\"),\n     debug_assertions: Option<bool> = (None, parse_opt_bool, [TRACKED],\n         \"explicitly enable the cfg(debug_assertions) directive\"),\n     inline_threshold: Option<usize> = (None, parse_opt_uint, [TRACKED],\n@@ -2965,6 +2967,10 @@ mod tests {\n         opts.cg.debuginfo = Some(0xba5eba11);\n         assert!(reference.dep_tracking_hash() != opts.dep_tracking_hash());\n \n+        opts = reference.clone();\n+        opts.cg.force_frame_pointers = Some(false);\n+        assert!(reference.dep_tracking_hash() != opts.dep_tracking_hash());\n+\n         opts = reference.clone();\n         opts.cg.debug_assertions = Some(true);\n         assert!(reference.dep_tracking_hash() != opts.dep_tracking_hash());"}, {"sha": "2ab72ba20bf4fc4b321ed9bd76b144e60efea2ea", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -20,7 +20,7 @@ use lint::builtin::BuiltinLintDiagnostics;\n use middle::allocator::AllocatorKind;\n use middle::dependency_format;\n use session::search_paths::PathKind;\n-use session::config::{DebugInfoLevel, OutputType};\n+use session::config::{OutputType};\n use ty::tls;\n use util::nodemap::{FxHashSet};\n use util::common::{duration_to_secs_str, ErrorReported};\n@@ -658,8 +658,11 @@ impl Session {\n     }\n \n     pub fn must_not_eliminate_frame_pointers(&self) -> bool {\n-        self.opts.debuginfo != DebugInfoLevel::NoDebugInfo\n-            || !self.target.target.options.eliminate_frame_pointer\n+        if let Some(x) = self.opts.cg.force_frame_pointers {\n+            x\n+        } else {\n+            !self.target.target.options.eliminate_frame_pointer\n+        }\n     }\n \n     /// Returns the symbol name for the registrar function,"}, {"sha": "46bb01e7c420dfe1f92a90dd8cdeb94022d45509", "filename": "src/librustc_target/spec/apple_ios_base.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc_target%2Fspec%2Fapple_ios_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc_target%2Fspec%2Fapple_ios_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fapple_ios_base.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -98,6 +98,7 @@ pub fn opts(arch: Arch) -> Result<TargetOptions, String> {\n         executables: true,\n         pre_link_args,\n         has_elf_tls: false,\n+        eliminate_frame_pointer: false,\n         // The following line is a workaround for jemalloc 4.5 being broken on\n         // ios. jemalloc 5.0 is supposed to fix this.\n         // see https://github.com/rust-lang/rust/issues/45262"}, {"sha": "d17789dfcc07feb929e520e26038d99774a56668", "filename": "src/librustc_target/spec/i686_apple_darwin.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc_target%2Fspec%2Fi686_apple_darwin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc_target%2Fspec%2Fi686_apple_darwin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fi686_apple_darwin.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -16,6 +16,7 @@ pub fn target() -> TargetResult {\n     base.max_atomic_width = Some(64);\n     base.pre_link_args.insert(LinkerFlavor::Gcc, vec![\"-m32\".to_string()]);\n     base.stack_probes = true;\n+    base.eliminate_frame_pointer = false;\n \n     Ok(Target {\n         llvm_target: \"i686-apple-darwin\".to_string(),"}, {"sha": "5baed57092d0f3c243605d666bce3a650281dbf6", "filename": "src/librustc_trans/attributes.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc_trans%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Flibrustc_trans%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fattributes.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -69,8 +69,6 @@ pub fn naked(val: ValueRef, is_naked: bool) {\n }\n \n pub fn set_frame_pointer_elimination(cx: &CodegenCx, llfn: ValueRef) {\n-    // FIXME: #11906: Omitting frame pointers breaks retrieving the value of a\n-    // parameter.\n     if cx.sess().must_not_eliminate_frame_pointers() {\n         llvm::AddFunctionAttrStringValue(\n             llfn, llvm::AttributePlace::Function,"}, {"sha": "f70e366719882a3112e2606f82c87c389d5c3ce2", "filename": "src/test/codegen/force-frame-pointers.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Ftest%2Fcodegen%2Fforce-frame-pointers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Ftest%2Fcodegen%2Fforce-frame-pointers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fforce-frame-pointers.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+//\n+// compile-flags: -C no-prepopulate-passes -C force-frame-pointers=y\n+\n+#![crate_type=\"lib\"]\n+\n+// CHECK: attributes #{{.*}} \"no-frame-pointer-elim\"=\"true\"\n+pub fn foo() {}"}, {"sha": "7bcb4e5ec2d2efee06d07c111e393bb31a978854", "filename": "src/test/run-pass/backtrace-debuginfo.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Ftest%2Frun-pass%2Fbacktrace-debuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0eb68b797b2d2d2ae20093b824f69fe817c96ed1/src%2Ftest%2Frun-pass%2Fbacktrace-debuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fbacktrace-debuginfo.rs?ref=0eb68b797b2d2d2ae20093b824f69fe817c96ed1", "patch": "@@ -16,6 +16,7 @@\n // \"enable\" to 0 instead.\n \n // compile-flags:-g -Cllvm-args=-enable-tail-merge=0 -Cllvm-args=-opt-bisect-limit=0\n+// compile-flags:-Cforce-frame-pointers=yes\n // ignore-pretty issue #37195\n // ignore-cloudabi spawning processes is not supported\n // ignore-emscripten spawning processes is not supported"}]}