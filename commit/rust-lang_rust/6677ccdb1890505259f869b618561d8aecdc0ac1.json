{"sha": "6677ccdb1890505259f869b618561d8aecdc0ac1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2NzdjY2RiMTg5MDUwNTI1OWY4NjliNjE4NTYxZDhhZWNkYzBhYzE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-30T08:41:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-30T08:41:02Z"}, "message": "Merge #3764\n\n3764: Move roots_to_scan to LoopState r=matklad a=edwin0cheng\n\ncloses #3760\r\n\r\ncc @lnicola \n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "d990255b6041036f7d3894a6311dc640268b128a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d990255b6041036f7d3894a6311dc640268b128a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6677ccdb1890505259f869b618561d8aecdc0ac1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJegbCeCRBK7hj4Ov3rIwAAdHIIAFqMaY0VAnVD1I6dMujKFU6Y\n0vZ8yZayZfzBUbIH4jCudFiczIR0MUUxfjQShxDWw73HOxs3j1m5Egl+RqqW6BF0\nWz8KUzCtOIamxVqrZgRun7VYAd+gY/oUlDsg+JNlU7HKDRiGyHeX6zvXCCtgi5b6\naDn6mSlGz/0FXYkyi6huDckg4aHVmehryK6SfeSBjtIjwpgK/xPvusj57nYAdU3B\nzX5w3I+ukHOpZ09V+jDCXce8LEyJ0LLX3SiqV35s5cLEf5N6VmzYevSQbXDP4tqr\nxIqNrC8GNX+YZFrL5AFXAuP3G32jEGJgTI2UOE7lgrMlSsf+4qP6iapFUB1Wqm4=\n=6GFX\n-----END PGP SIGNATURE-----\n", "payload": "tree d990255b6041036f7d3894a6311dc640268b128a\nparent 1c2d4135db867efe335a0654d86429bea7bb9caf\nparent 36812b9d7bd42c6469d857c434a63c921b70bdca\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1585557662 +0000\ncommitter GitHub <noreply@github.com> 1585557662 +0000\n\nMerge #3764\n\n3764: Move roots_to_scan to LoopState r=matklad a=edwin0cheng\n\ncloses #3760\r\n\r\ncc @lnicola \n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6677ccdb1890505259f869b618561d8aecdc0ac1", "html_url": "https://github.com/rust-lang/rust/commit/6677ccdb1890505259f869b618561d8aecdc0ac1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6677ccdb1890505259f869b618561d8aecdc0ac1/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1c2d4135db867efe335a0654d86429bea7bb9caf", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c2d4135db867efe335a0654d86429bea7bb9caf", "html_url": "https://github.com/rust-lang/rust/commit/1c2d4135db867efe335a0654d86429bea7bb9caf"}, {"sha": "36812b9d7bd42c6469d857c434a63c921b70bdca", "url": "https://api.github.com/repos/rust-lang/rust/commits/36812b9d7bd42c6469d857c434a63c921b70bdca", "html_url": "https://github.com/rust-lang/rust/commit/36812b9d7bd42c6469d857c434a63c921b70bdca"}], "stats": {"total": 52, "additions": 26, "deletions": 26}, "files": [{"sha": "d35963e9568bb68742c4592577803ad6d0ec0e8d", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 23, "deletions": 20, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/6677ccdb1890505259f869b618561d8aecdc0ac1/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6677ccdb1890505259f869b618561d8aecdc0ac1/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=6677ccdb1890505259f869b618561d8aecdc0ac1", "patch": "@@ -208,6 +208,9 @@ pub fn main_loop(\n         )\n     };\n \n+    loop_state.roots_total = world_state.vfs.read().n_roots();\n+    loop_state.roots_scanned = 0;\n+\n     let pool = ThreadPool::default();\n     let (task_sender, task_receiver) = unbounded::<Task>();\n     let (libdata_sender, libdata_receiver) = unbounded::<LibraryData>();\n@@ -333,7 +336,10 @@ struct LoopState {\n     in_flight_libraries: usize,\n     pending_libraries: Vec<(SourceRootId, Vec<(FileId, RelativePathBuf, Arc<String>)>)>,\n     workspace_loaded: bool,\n-    roots_scanned_progress: Option<usize>,\n+\n+    roots_progress_reported: Option<usize>,\n+    roots_scanned: usize,\n+    roots_total: usize,\n }\n \n impl LoopState {\n@@ -377,6 +383,7 @@ fn loop_turn(\n             world_state.add_lib(lib);\n             world_state.maybe_collect_garbage();\n             loop_state.in_flight_libraries -= 1;\n+            loop_state.roots_scanned += 1;\n         }\n         Event::CheckWatcher(task) => on_check_task(task, world_state, task_sender)?,\n         Event::Msg(msg) => match msg {\n@@ -408,7 +415,7 @@ fn loop_turn(\n     };\n \n     let mut state_changed = false;\n-    if let Some(changes) = world_state.process_changes() {\n+    if let Some(changes) = world_state.process_changes(&mut loop_state.roots_scanned) {\n         state_changed = true;\n         loop_state.pending_libraries.extend(changes);\n     }\n@@ -427,8 +434,11 @@ fn loop_turn(\n         });\n     }\n \n+    let show_progress = !loop_state.workspace_loaded\n+        && world_state.feature_flags.get(\"notifications.workspace-loaded\");\n+\n     if !loop_state.workspace_loaded\n-        && world_state.roots_to_scan == 0\n+        && loop_state.roots_scanned == loop_state.roots_total\n         && loop_state.pending_libraries.is_empty()\n         && loop_state.in_flight_libraries == 0\n     {\n@@ -439,9 +449,10 @@ fn loop_turn(\n             let snap = world_state.snapshot();\n             move || snap.analysis().prime_caches(subs).unwrap_or_else(|_: Canceled| ())\n         });\n-        send_startup_progress(&connection.sender, loop_state, world_state);\n-    } else if !loop_state.workspace_loaded {\n-        send_startup_progress(&connection.sender, loop_state, world_state);\n+    }\n+\n+    if show_progress {\n+        send_startup_progress(&connection.sender, loop_state);\n     }\n \n     if state_changed {\n@@ -706,21 +717,13 @@ fn on_diagnostic_task(task: DiagnosticTask, msg_sender: &Sender<Message>, state:\n     }\n }\n \n-fn send_startup_progress(\n-    sender: &Sender<Message>,\n-    loop_state: &mut LoopState,\n-    world_state: &WorldState,\n-) {\n-    if !world_state.feature_flags.get(\"notifications.workspace-loaded\") {\n-        return;\n-    }\n-\n-    let total: usize = world_state.workspaces.iter().map(|it| it.n_packages()).sum();\n-    let prev_progress = loop_state.roots_scanned_progress;\n-    let progress = total - world_state.roots_to_scan;\n-    loop_state.roots_scanned_progress = Some(progress);\n+fn send_startup_progress(sender: &Sender<Message>, loop_state: &mut LoopState) {\n+    let total: usize = loop_state.roots_total;\n+    let prev = loop_state.roots_progress_reported;\n+    let progress = loop_state.roots_scanned;\n+    loop_state.roots_progress_reported = Some(progress);\n \n-    match (prev_progress, loop_state.workspace_loaded) {\n+    match (prev, loop_state.workspace_loaded) {\n         (None, false) => {\n             let work_done_progress_create = request_new::<req::WorkDoneProgressCreate>(\n                 loop_state.next_request_id(),"}, {"sha": "5680397ed828f68af88c6856575646eaec458e65", "filename": "crates/rust-analyzer/src/world.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6677ccdb1890505259f869b618561d8aecdc0ac1/crates%2Frust-analyzer%2Fsrc%2Fworld.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6677ccdb1890505259f869b618561d8aecdc0ac1/crates%2Frust-analyzer%2Fsrc%2Fworld.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fworld.rs?ref=6677ccdb1890505259f869b618561d8aecdc0ac1", "patch": "@@ -51,8 +51,6 @@ pub struct Options {\n pub struct WorldState {\n     pub options: Options,\n     pub feature_flags: Arc<FeatureFlags>,\n-    //FIXME: this belongs to `LoopState` rather than to `WorldState`\n-    pub roots_to_scan: usize,\n     pub roots: Vec<PathBuf>,\n     pub workspaces: Arc<Vec<ProjectWorkspace>>,\n     pub analysis_host: AnalysisHost,\n@@ -123,7 +121,7 @@ impl WorldState {\n         let (task_sender, task_receiver) = unbounded();\n         let task_sender = Box::new(move |t| task_sender.send(t).unwrap());\n         let (mut vfs, vfs_roots) = Vfs::new(roots, task_sender, watch);\n-        let roots_to_scan = vfs_roots.len();\n+\n         for r in vfs_roots {\n             let vfs_root_path = vfs.root2path(r);\n             let is_local = folder_roots.iter().any(|it| vfs_root_path.starts_with(it));\n@@ -190,7 +188,6 @@ impl WorldState {\n         WorldState {\n             options,\n             feature_flags: Arc::new(feature_flags),\n-            roots_to_scan,\n             roots: folder_roots,\n             workspaces: Arc::new(workspaces),\n             analysis_host,\n@@ -206,6 +203,7 @@ impl WorldState {\n     /// FIXME: better API here\n     pub fn process_changes(\n         &mut self,\n+        roots_scanned: &mut usize,\n     ) -> Option<Vec<(SourceRootId, Vec<(FileId, RelativePathBuf, Arc<String>)>)>> {\n         let changes = self.vfs.write().commit_changes();\n         if changes.is_empty() {\n@@ -219,7 +217,7 @@ impl WorldState {\n                     let root_path = self.vfs.read().root2path(root);\n                     let is_local = self.roots.iter().any(|r| root_path.starts_with(r));\n                     if is_local {\n-                        self.roots_to_scan -= 1;\n+                        *roots_scanned += 1;\n                         for (file, path, text) in files {\n                             change.add_file(SourceRootId(root.0), FileId(file.0), path, text);\n                         }\n@@ -247,7 +245,6 @@ impl WorldState {\n     }\n \n     pub fn add_lib(&mut self, data: LibraryData) {\n-        self.roots_to_scan -= 1;\n         let mut change = AnalysisChange::new();\n         change.add_library(data);\n         self.analysis_host.apply_change(change);"}]}