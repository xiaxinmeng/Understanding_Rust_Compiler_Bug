{"sha": "88e40bc73db441b931372a11b99c308f4bf0427f", "node_id": "C_kwDOAAsO6NoAKDg4ZTQwYmM3M2RiNDQxYjkzMTM3MmExMWI5OWMzMDhmNGJmMDQyN2Y", "commit": {"author": {"name": "Oussama", "email": "abdelmoumenoussama@gmail.com", "date": "2021-12-21T21:00:14Z"}, "committer": {"name": "Oussama", "email": "abdelmoumenoussama@gmail.com", "date": "2021-12-21T21:00:14Z"}, "message": "Add support for suggestion when using an expression", "tree": {"sha": "0fcfbe2eb8975675c8b57f7c0a2c35b4651a587b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0fcfbe2eb8975675c8b57f7c0a2c35b4651a587b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/88e40bc73db441b931372a11b99c308f4bf0427f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/88e40bc73db441b931372a11b99c308f4bf0427f", "html_url": "https://github.com/rust-lang/rust/commit/88e40bc73db441b931372a11b99c308f4bf0427f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/88e40bc73db441b931372a11b99c308f4bf0427f/comments", "author": {"login": "Gh0stm4chine", "id": 14828055, "node_id": "MDQ6VXNlcjE0ODI4MDU1", "avatar_url": "https://avatars.githubusercontent.com/u/14828055?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Gh0stm4chine", "html_url": "https://github.com/Gh0stm4chine", "followers_url": "https://api.github.com/users/Gh0stm4chine/followers", "following_url": "https://api.github.com/users/Gh0stm4chine/following{/other_user}", "gists_url": "https://api.github.com/users/Gh0stm4chine/gists{/gist_id}", "starred_url": "https://api.github.com/users/Gh0stm4chine/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Gh0stm4chine/subscriptions", "organizations_url": "https://api.github.com/users/Gh0stm4chine/orgs", "repos_url": "https://api.github.com/users/Gh0stm4chine/repos", "events_url": "https://api.github.com/users/Gh0stm4chine/events{/privacy}", "received_events_url": "https://api.github.com/users/Gh0stm4chine/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Gh0stm4chine", "id": 14828055, "node_id": "MDQ6VXNlcjE0ODI4MDU1", "avatar_url": "https://avatars.githubusercontent.com/u/14828055?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Gh0stm4chine", "html_url": "https://github.com/Gh0stm4chine", "followers_url": "https://api.github.com/users/Gh0stm4chine/followers", "following_url": "https://api.github.com/users/Gh0stm4chine/following{/other_user}", "gists_url": "https://api.github.com/users/Gh0stm4chine/gists{/gist_id}", "starred_url": "https://api.github.com/users/Gh0stm4chine/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Gh0stm4chine/subscriptions", "organizations_url": "https://api.github.com/users/Gh0stm4chine/orgs", "repos_url": "https://api.github.com/users/Gh0stm4chine/repos", "events_url": "https://api.github.com/users/Gh0stm4chine/events{/privacy}", "received_events_url": "https://api.github.com/users/Gh0stm4chine/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ad37b1a4b34af381b93f603e4c948928a8a6124", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ad37b1a4b34af381b93f603e4c948928a8a6124", "html_url": "https://github.com/rust-lang/rust/commit/5ad37b1a4b34af381b93f603e4c948928a8a6124"}], "stats": {"total": 108, "additions": 96, "deletions": 12}, "files": [{"sha": "0d05c83ffe45ee05804556515df1ce330e118152", "filename": "clippy_lints/src/neg_multiply.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/88e40bc73db441b931372a11b99c308f4bf0427f/clippy_lints%2Fsrc%2Fneg_multiply.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88e40bc73db441b931372a11b99c308f4bf0427f/clippy_lints%2Fsrc%2Fneg_multiply.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneg_multiply.rs?ref=88e40bc73db441b931372a11b99c308f4bf0427f", "patch": "@@ -1,8 +1,9 @@\n use clippy_utils::consts::{self, Constant};\n use clippy_utils::diagnostics::span_lint_and_sugg;\n+use clippy_utils::source::snippet_with_applicability;\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n-use rustc_hir::{BinOpKind, Expr, ExprKind, QPath, UnOp};\n+use rustc_hir::{BinOpKind, Expr, ExprKind, UnOp};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n@@ -28,7 +29,7 @@ declare_clippy_lint! {\n     #[clippy::version = \"pre 1.29.0\"]\n     pub NEG_MULTIPLY,\n     style,\n-    \"multiplying integers with `-1`\"\n+    \"multiplying integers by `-1`\"\n }\n \n declare_lint_pass!(NegMultiply => [NEG_MULTIPLY]);\n@@ -54,17 +55,15 @@ fn check_mul(cx: &LateContext<'_>, span: Span, lit: &Expr<'_>, exp: &Expr<'_>) {\n         if let ExprKind::Lit(ref l) = lit.kind;\n         if consts::lit_to_constant(&l.node, cx.typeck_results().expr_ty_opt(lit)) == Constant::Int(1);\n         if cx.typeck_results().expr_ty(exp).is_integral();\n-        if let ExprKind::Path(QPath::Resolved(_, var_path)) = exp.kind;\n \n         then {\n-            let var_name = var_path.segments[0].ident.name.as_str();\n-            let suggestion = format!(\"-{var}\",var=var_name);\n-            let applicability = Applicability::MachineApplicable;\n+            let mut applicability = Applicability::MachineApplicable;\n+            let suggestion = format!(\"-{}\", snippet_with_applicability(cx, exp.span, \"..\", &mut applicability));\n             span_lint_and_sugg(\n                     cx,\n                     NEG_MULTIPLY,\n                     span,\n-                    \"this `multiplication with -1` can be written more succinctly\",\n+                    \"this multiplication by -1 can be written more succinctly\",\n                     \"consider using\",\n                     suggestion,\n                     applicability,"}, {"sha": "8546173cfd543dafdd9981a8809d2202bcb32100", "filename": "tests/ui/neg_multiply.fixed", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/88e40bc73db441b931372a11b99c308f4bf0427f/tests%2Fui%2Fneg_multiply.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/88e40bc73db441b931372a11b99c308f4bf0427f/tests%2Fui%2Fneg_multiply.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneg_multiply.fixed?ref=88e40bc73db441b931372a11b99c308f4bf0427f", "patch": "@@ -0,0 +1,44 @@\n+// run-rustfix\n+#![warn(clippy::neg_multiply)]\n+#![allow(clippy::no_effect, clippy::unnecessary_operation)]\n+\n+use std::ops::Mul;\n+\n+struct X;\n+\n+impl Mul<isize> for X {\n+    type Output = X;\n+\n+    fn mul(self, _r: isize) -> Self {\n+        self\n+    }\n+}\n+\n+impl Mul<X> for isize {\n+    type Output = X;\n+\n+    fn mul(self, _r: X) -> X {\n+        X\n+    }\n+}\n+\n+fn main() {\n+    let x = 0;\n+\n+    -x;\n+\n+    -x;\n+\n+    100 + -x;\n+\n+    -(100 + x);\n+\n+    -17;\n+\n+    0xcafe | -0xff00;\n+\n+    -1 * -1; // should be ok\n+\n+    X * -1; // should be ok\n+    -1 * X; // should also be ok\n+}"}, {"sha": "9f48e4d9c1279bc03aa1c38ad7ad2b0abf522213", "filename": "tests/ui/neg_multiply.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/88e40bc73db441b931372a11b99c308f4bf0427f/tests%2Fui%2Fneg_multiply.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88e40bc73db441b931372a11b99c308f4bf0427f/tests%2Fui%2Fneg_multiply.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneg_multiply.rs?ref=88e40bc73db441b931372a11b99c308f4bf0427f", "patch": "@@ -1,3 +1,4 @@\n+// run-rustfix\n #![warn(clippy::neg_multiply)]\n #![allow(clippy::no_effect, clippy::unnecessary_operation)]\n \n@@ -28,6 +29,14 @@ fn main() {\n \n     -1 * x;\n \n+    100 + x * -1;\n+\n+    (100 + x) * -1;\n+\n+    -1 * 17;\n+\n+    0xcafe | 0xff00 * -1;\n+\n     -1 * -1; // should be ok\n \n     X * -1; // should be ok"}, {"sha": "0a4bc0742958cac89a8e0e5ff522dfd4033417cf", "filename": "tests/ui/neg_multiply.stderr", "status": "modified", "additions": 37, "deletions": 5, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/88e40bc73db441b931372a11b99c308f4bf0427f/tests%2Fui%2Fneg_multiply.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/88e40bc73db441b931372a11b99c308f4bf0427f/tests%2Fui%2Fneg_multiply.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneg_multiply.stderr?ref=88e40bc73db441b931372a11b99c308f4bf0427f", "patch": "@@ -1,16 +1,48 @@\n-error: this `multiplication with -1` can be written more succinctly\n-  --> $DIR/neg_multiply.rs:27:5\n+error: operator precedence can trip the unwary\n+  --> $DIR/neg_multiply.rs:38:5\n+   |\n+LL |     0xcafe | 0xff00 * -1;\n+   |     ^^^^^^^^^^^^^^^^^^^^ help: consider parenthesizing your expression: `0xcafe | (0xff00 * -1)`\n+   |\n+   = note: `-D clippy::precedence` implied by `-D warnings`\n+\n+error: this multiplication by -1 can be written more succinctly\n+  --> $DIR/neg_multiply.rs:28:5\n    |\n LL |     x * -1;\n    |     ^^^^^^ help: consider using: `-x`\n    |\n    = note: `-D clippy::neg-multiply` implied by `-D warnings`\n \n-error: this `multiplication with -1` can be written more succinctly\n-  --> $DIR/neg_multiply.rs:29:5\n+error: this multiplication by -1 can be written more succinctly\n+  --> $DIR/neg_multiply.rs:30:5\n    |\n LL |     -1 * x;\n    |     ^^^^^^ help: consider using: `-x`\n \n-error: aborting due to 2 previous errors\n+error: this multiplication by -1 can be written more succinctly\n+  --> $DIR/neg_multiply.rs:32:11\n+   |\n+LL |     100 + x * -1;\n+   |           ^^^^^^ help: consider using: `-x`\n+\n+error: this multiplication by -1 can be written more succinctly\n+  --> $DIR/neg_multiply.rs:34:5\n+   |\n+LL |     (100 + x) * -1;\n+   |     ^^^^^^^^^^^^^^ help: consider using: `-(100 + x)`\n+\n+error: this multiplication by -1 can be written more succinctly\n+  --> $DIR/neg_multiply.rs:36:5\n+   |\n+LL |     -1 * 17;\n+   |     ^^^^^^^ help: consider using: `-17`\n+\n+error: this multiplication by -1 can be written more succinctly\n+  --> $DIR/neg_multiply.rs:38:14\n+   |\n+LL |     0xcafe | 0xff00 * -1;\n+   |              ^^^^^^^^^^^ help: consider using: `-0xff00`\n+\n+error: aborting due to 7 previous errors\n "}]}