{"sha": "f46f388cb20962cdf08747132c17448cf9602b5e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0NmYzODhjYjIwOTYyY2RmMDg3NDcxMzJjMTc0NDhjZjk2MDJiNWU=", "commit": {"author": {"name": "leonardo.yvens", "email": "leoyvens@gmail.com", "date": "2017-11-04T21:44:19Z"}, "committer": {"name": "leonardo.yvens", "email": "leoyvens@gmail.com", "date": "2017-11-05T00:00:25Z"}, "message": "Fix checking of auto trait bounds in trait objects.\n\nAny auto trait is allowed in trait object bounds.\nFix duplicate check of type and lifetime parameter count.", "tree": {"sha": "215cbd342f2587cbd198675a91305f61dc5a9cb0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/215cbd342f2587cbd198675a91305f61dc5a9cb0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f46f388cb20962cdf08747132c17448cf9602b5e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f46f388cb20962cdf08747132c17448cf9602b5e", "html_url": "https://github.com/rust-lang/rust/commit/f46f388cb20962cdf08747132c17448cf9602b5e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f46f388cb20962cdf08747132c17448cf9602b5e/comments", "author": {"login": "leoyvens", "id": 9885558, "node_id": "MDQ6VXNlcjk4ODU1NTg=", "avatar_url": "https://avatars.githubusercontent.com/u/9885558?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leoyvens", "html_url": "https://github.com/leoyvens", "followers_url": "https://api.github.com/users/leoyvens/followers", "following_url": "https://api.github.com/users/leoyvens/following{/other_user}", "gists_url": "https://api.github.com/users/leoyvens/gists{/gist_id}", "starred_url": "https://api.github.com/users/leoyvens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leoyvens/subscriptions", "organizations_url": "https://api.github.com/users/leoyvens/orgs", "repos_url": "https://api.github.com/users/leoyvens/repos", "events_url": "https://api.github.com/users/leoyvens/events{/privacy}", "received_events_url": "https://api.github.com/users/leoyvens/received_events", "type": "User", "site_admin": false}, "committer": {"login": "leoyvens", "id": 9885558, "node_id": "MDQ6VXNlcjk4ODU1NTg=", "avatar_url": "https://avatars.githubusercontent.com/u/9885558?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leoyvens", "html_url": "https://github.com/leoyvens", "followers_url": "https://api.github.com/users/leoyvens/followers", "following_url": "https://api.github.com/users/leoyvens/following{/other_user}", "gists_url": "https://api.github.com/users/leoyvens/gists{/gist_id}", "starred_url": "https://api.github.com/users/leoyvens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leoyvens/subscriptions", "organizations_url": "https://api.github.com/users/leoyvens/orgs", "repos_url": "https://api.github.com/users/leoyvens/repos", "events_url": "https://api.github.com/users/leoyvens/events{/privacy}", "received_events_url": "https://api.github.com/users/leoyvens/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d762b1d6c67db12e117186d94d70e46cddb22965", "url": "https://api.github.com/repos/rust-lang/rust/commits/d762b1d6c67db12e117186d94d70e46cddb22965", "html_url": "https://github.com/rust-lang/rust/commit/d762b1d6c67db12e117186d94d70e46cddb22965"}], "stats": {"total": 46, "additions": 16, "deletions": 30}, "files": [{"sha": "77ead1d503306bf0d35e201db28ca1dcd57bffd4", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 5, "deletions": 22, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -572,8 +572,8 @@ impl<'o, 'gcx: 'tcx, 'tcx> AstConv<'gcx, 'tcx>+'o {\n             let b = &trait_bounds[0];\n             let span = b.trait_ref.path.span;\n             struct_span_err!(self.tcx().sess, span, E0225,\n-                \"only Send/Sync traits can be used as additional traits in a trait object\")\n-                .span_label(span, \"non-Send/Sync additional trait\")\n+                \"only auto traits can be used as additional traits in a trait object\")\n+                .span_label(span, \"non-auto additional trait\")\n                 .emit();\n         }\n \n@@ -1311,27 +1311,10 @@ fn split_auto_traits<'a, 'b, 'gcx, 'tcx>(tcx: TyCtxt<'a, 'gcx, 'tcx>,\n     -> (Vec<DefId>, Vec<&'b hir::PolyTraitRef>)\n {\n     let (auto_traits, trait_bounds): (Vec<_>, _) = trait_bounds.iter().partition(|bound| {\n+        // Checks whether `trait_did` is an auto trait and adds it to `auto_traits` if so.\n         match bound.trait_ref.path.def {\n-            Def::Trait(trait_did) => {\n-                // Checks whether `trait_did` refers to one of the builtin\n-                // traits, like `Send`, and adds it to `auto_traits` if so.\n-                if Some(trait_did) == tcx.lang_items().send_trait() ||\n-                    Some(trait_did) == tcx.lang_items().sync_trait() {\n-                    let segments = &bound.trait_ref.path.segments;\n-                    segments[segments.len() - 1].with_parameters(|parameters| {\n-                        if !parameters.types.is_empty() {\n-                            check_type_argument_count(tcx, bound.trait_ref.path.span,\n-                                                      parameters.types.len(), &[]);\n-                        }\n-                        if !parameters.lifetimes.is_empty() {\n-                            report_lifetime_number_error(tcx, bound.trait_ref.path.span,\n-                                                         parameters.lifetimes.len(), 0);\n-                        }\n-                    });\n-                    true\n-                } else {\n-                    false\n-                }\n+            Def::Trait(trait_did) if tcx.trait_is_auto(trait_did) => {\n+                true\n             }\n             _ => false\n         }"}, {"sha": "76ac372b29f14a7ab49a00620a409bad787d4abd", "filename": "src/librustc_typeck/diagnostics.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Flibrustc_typeck%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Flibrustc_typeck%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fdiagnostics.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -2455,9 +2455,9 @@ fn main() {\n }\n ```\n \n-Send and Sync are an exception to this rule: it's possible to have bounds of\n-one non-builtin trait, plus either or both of Send and Sync. For example, the\n-following compiles correctly:\n+Auto traits such as Send and Sync are an exception to this rule:\n+It's possible to have bounds of one non-builtin trait, plus any number of\n+auto traits. For example, the following compiles correctly:\n \n ```\n fn main() {"}, {"sha": "c2f610ecd2816aed6fbe3b0d5a16fb639abe39da", "filename": "src/test/compile-fail/E0225.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2FE0225.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2FE0225.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2FE0225.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -10,6 +10,6 @@\n \n fn main() {\n     let _: Box<std::io::Read + std::io::Write>;\n-    //~^ ERROR only Send/Sync traits can be used as additional traits in a trait object [E0225]\n-    //~| NOTE non-Send/Sync additional trait\n+    //~^ ERROR only auto traits can be used as additional traits in a trait object [E0225]\n+    //~| NOTE non-auto additional trait\n }"}, {"sha": "df3da5096bf538d9d57639d729b92b178b0bbcb3", "filename": "src/test/compile-fail/bad-sized.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2Fbad-sized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2Fbad-sized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-sized.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -12,7 +12,7 @@ trait Trait {}\n \n pub fn main() {\n     let x: Vec<Trait + Sized> = Vec::new();\n-    //~^ ERROR only Send/Sync traits can be used as additional traits in a trait object\n+    //~^ ERROR only auto traits can be used as additional traits in a trait object\n     //~| ERROR the trait bound `Trait: std::marker::Sized` is not satisfied\n     //~| ERROR the trait bound `Trait: std::marker::Sized` is not satisfied\n }"}, {"sha": "914a3bd79d4602db7cf9c9aa93cd657103b9edb8", "filename": "src/test/compile-fail/issue-22560.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2Fissue-22560.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2Fissue-22560.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-22560.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -23,6 +23,6 @@ type Test = Add +\n             //~| NOTE missing reference to `RHS`\n             //~| NOTE because of the default `Self` reference, type parameters must be specified on object types\n             //~| ERROR E0225\n-            //~| NOTE non-Send/Sync additional trait\n+            //~| NOTE non-auto additional trait\n \n fn main() { }"}, {"sha": "e97e5a86a9d7d88567f4fd8249ddf996e9d83ddd", "filename": "src/test/compile-fail/issue-32963.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2Fissue-32963.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Fcompile-fail%2Fissue-32963.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-32963.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -16,6 +16,6 @@ fn size_of_copy<T: Copy+?Sized>() -> usize { mem::size_of::<T>() }\n \n fn main() {\n     size_of_copy::<Misc+Copy>();\n-    //~^ ERROR only Send/Sync traits can be used as additional traits in a trait object\n+    //~^ ERROR only auto traits can be used as additional traits in a trait object\n     //~| ERROR the trait bound `Misc: std::marker::Copy` is not satisfied\n }"}, {"sha": "e42aca9ccbd1378c29cff2e7c80765e2237b5e88", "filename": "src/test/run-pass/auto-traits.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Frun-pass%2Fauto-traits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f46f388cb20962cdf08747132c17448cf9602b5e/src%2Ftest%2Frun-pass%2Fauto-traits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fauto-traits.rs?ref=f46f388cb20962cdf08747132c17448cf9602b5e", "patch": "@@ -33,4 +33,7 @@ fn main() {\n     take_auto(AutoBool(true));\n     take_auto_unsafe(0);\n     take_auto_unsafe(AutoBool(true));\n+\n+    /// Auto traits are allowed in trait object bounds.\n+    let _: &(Send + Auto) = &0;\n }"}]}