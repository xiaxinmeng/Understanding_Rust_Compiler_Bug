{"sha": "cd7204ef394d1e53bb967086186e9b8664d7e268", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNkNzIwNGVmMzk0ZDFlNTNiYjk2NzA4NjE4NmU5Yjg2NjRkN2UyNjg=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-08-04T08:46:10Z"}, "committer": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-08-04T08:46:10Z"}, "message": "Forbid non-derefable types explicitly in unsizing casts", "tree": {"sha": "001388e814102929367d665d6784939d836d5729", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/001388e814102929367d665d6784939d836d5729"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd7204ef394d1e53bb967086186e9b8664d7e268", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEXmatGLoofN5+9u4rsJhshcDi2qEFAl8pIFIACgkQsJhshcDi\n2qF72Q//SjmIr37ihjsRi6wkhLcmu4F7vzj4yMqmyNEQtYr/aRnMn/0PtQdSoCBq\nzGbZkFEV2bOjDKiD2p5/5klPpJKHV87Jkml6/robiLiEiR3D5nux1qLEmIvfM7Mk\nmdwfsG0a8Eq5e1LJC76qVR69Ho5JtMN3TKdFHvfpKEw6EpIYg4RMq4Y9BBeqikP2\nBu56emSFTD+VFcpGnYCN/Rgk/YpaFJuPuxopJRDlvvq3cGS9aq5F214+H98mqgTY\nDoX8zebx34TFPeedwxxRxysD3G5bO6B1Hrd4nZ3C+12guxAepJGEuh7avCIDA1WP\ngFBVJ9u6afaZf5LhJsZnAfU258hPLxYxOoI1F6ACabI7kVabjo9iwZJSsz/dJeBR\nQ5DOaSXpm+uFMkDfr2PuNJ/I5B3fUro4beSf56Ulxj0KsoBFfY834KeuQMDbzXM7\nslPTJ267Q9S7o+49yRSzaBC/1uUDBUDATu6XmpWQpaTmLl+v/6kSoQA6VK9QGAG3\nrL3QCRlQMEfEncC5MyUSIkZb5y0wA0x804MzhZGN51iWoW0ZYoJn3GIUabbkG36D\neXfHwypAv44MX4mV++mRbxKawrJwB6WX/gGXzbVPBjhHsvH3psHRoIkXw6S96Uzv\n8S/zyCqhZLXFf3hP8uoPnUsvhY6aMdb6rn86SuBbqSO2Jr30B1Q=\n=NaLO\n-----END PGP SIGNATURE-----", "payload": "tree 001388e814102929367d665d6784939d836d5729\nparent 40857b9453a80801fc51b606b0d7532efedad42b\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1596530770 +0900\ncommitter Yuki Okushi <huyuumi.dev@gmail.com> 1596530770 +0900\n\nForbid non-derefable types explicitly in unsizing casts\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd7204ef394d1e53bb967086186e9b8664d7e268", "html_url": "https://github.com/rust-lang/rust/commit/cd7204ef394d1e53bb967086186e9b8664d7e268", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd7204ef394d1e53bb967086186e9b8664d7e268/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "40857b9453a80801fc51b606b0d7532efedad42b", "url": "https://api.github.com/repos/rust-lang/rust/commits/40857b9453a80801fc51b606b0d7532efedad42b", "html_url": "https://github.com/rust-lang/rust/commit/40857b9453a80801fc51b606b0d7532efedad42b"}], "stats": {"total": 32, "additions": 31, "deletions": 1}, "files": [{"sha": "34fa840408f79a7d213bf4e25c40fccc7b975d4b", "filename": "src/librustc_mir/transform/qualify_min_const_fn.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cd7204ef394d1e53bb967086186e9b8664d7e268/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd7204ef394d1e53bb967086186e9b8664d7e268/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs?ref=cd7204ef394d1e53bb967086186e9b8664d7e268", "patch": "@@ -193,7 +193,15 @@ fn check_rvalue(\n             _,\n         ) => Err((span, \"function pointer casts are not allowed in const fn\".into())),\n         Rvalue::Cast(CastKind::Pointer(PointerCast::Unsize), op, cast_ty) => {\n-            let pointee_ty = cast_ty.builtin_deref(true).unwrap().ty;\n+            let pointee_ty = if let Some(deref_ty) = cast_ty.builtin_deref(true) {\n+                deref_ty.ty\n+            } else {\n+                // We cannot allow this for now.\n+                return Err((\n+                    span,\n+                    \"unsizing casts are only allowed for references right now\".into(),\n+                ));\n+            };\n             let unsized_ty = tcx.struct_tail_erasing_lifetimes(pointee_ty, tcx.param_env(def_id));\n             if let ty::Slice(_) | ty::Str = unsized_ty.kind {\n                 check_operand(tcx, op, span, def_id, body)?;"}, {"sha": "67d9f6baca5b447a440c09036d63474d3c5beb5e", "filename": "src/test/ui/consts/unsizing-cast-non-null.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cd7204ef394d1e53bb967086186e9b8664d7e268/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd7204ef394d1e53bb967086186e9b8664d7e268/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.rs?ref=cd7204ef394d1e53bb967086186e9b8664d7e268", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for #75118.\n+\n+use std::ptr::NonNull;\n+\n+pub const fn dangling_slice<T>() -> NonNull<[T]> {\n+    NonNull::<[T; 0]>::dangling()\n+    //~^ ERROR: unsizing casts are only allowed for references right now\n+}\n+\n+fn main() {}"}, {"sha": "6575355daadd7fb34a83abb08529854ae9beeefd", "filename": "src/test/ui/consts/unsizing-cast-non-null.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cd7204ef394d1e53bb967086186e9b8664d7e268/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cd7204ef394d1e53bb967086186e9b8664d7e268/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.stderr?ref=cd7204ef394d1e53bb967086186e9b8664d7e268", "patch": "@@ -0,0 +1,12 @@\n+error[E0723]: unsizing casts are only allowed for references right now\n+  --> $DIR/unsizing-cast-non-null.rs:6:5\n+   |\n+LL |     NonNull::<[T; 0]>::dangling()\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n+   = help: add `#![feature(const_fn)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0723`."}]}