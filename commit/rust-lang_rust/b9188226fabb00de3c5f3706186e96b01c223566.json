{"sha": "b9188226fabb00de3c5f3706186e96b01c223566", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5MTg4MjI2ZmFiYjAwZGUzYzVmMzcwNjE4NmU5NmIwMWMyMjM1NjY=", "commit": {"author": {"name": "Veetaha", "email": "gerzoh1@gmail.com", "date": "2020-02-16T01:13:06Z"}, "committer": {"name": "Veetaha", "email": "gerzoh1@gmail.com", "date": "2020-02-16T01:41:40Z"}, "message": "vscode: extract downloadArtifact() function", "tree": {"sha": "5574eaa480aec30de650840e1d18702e3bf1327d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5574eaa480aec30de650840e1d18702e3bf1327d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9188226fabb00de3c5f3706186e96b01c223566", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9188226fabb00de3c5f3706186e96b01c223566", "html_url": "https://github.com/rust-lang/rust/commit/b9188226fabb00de3c5f3706186e96b01c223566", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9188226fabb00de3c5f3706186e96b01c223566/comments", "author": null, "committer": null, "parents": [{"sha": "0f7abeb03599964e58d979820134c9e7a61a690e", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f7abeb03599964e58d979820134c9e7a61a690e", "html_url": "https://github.com/rust-lang/rust/commit/0f7abeb03599964e58d979820134c9e7a61a690e"}], "stats": {"total": 58, "additions": 58, "deletions": 0}, "files": [{"sha": "de655f8f4b798fa0cb05a89ba4ea81352d3f4b9d", "filename": "editors/code/src/installation/download_artifact.ts", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/b9188226fabb00de3c5f3706186e96b01c223566/editors%2Fcode%2Fsrc%2Finstallation%2Fdownload_artifact.ts", "raw_url": "https://github.com/rust-lang/rust/raw/b9188226fabb00de3c5f3706186e96b01c223566/editors%2Fcode%2Fsrc%2Finstallation%2Fdownload_artifact.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Finstallation%2Fdownload_artifact.ts?ref=b9188226fabb00de3c5f3706186e96b01c223566", "patch": "@@ -0,0 +1,58 @@\n+import * as vscode from \"vscode\";\n+import * as path from \"path\";\n+import { promises as fs } from \"fs\";\n+import { strict as assert } from \"assert\";\n+\n+import { ArtifactReleaseInfo } from \"./interfaces\";\n+import { downloadFile } from \"./download_file\";\n+import { throttle } from \"throttle-debounce\";\n+\n+/**\n+ * Downloads artifact from given `downloadUrl`.\n+ * Creates `installationDir` if it is not yet created and put the artifact under\n+ * `artifactFileName`.\n+ * Displays info about the download progress in an info message printing the name\n+ * of the artifact as `displayName`.\n+ */\n+export async function downloadArtifact(\n+    {downloadUrl, releaseName}: ArtifactReleaseInfo,\n+    artifactFileName: string,\n+    installationDir: string,\n+    displayName: string,\n+) {\n+    await fs.mkdir(installationDir).catch(err => assert.strictEqual(\n+        err?.code,\n+        \"EEXIST\",\n+        `Couldn't create directory \"${installationDir}\" to download `+\n+        `${artifactFileName} artifact: ${err.message}`\n+    ));\n+\n+    const installationPath = path.join(installationDir, artifactFileName);\n+\n+    console.time(`Downloading ${artifactFileName}`);\n+    await vscode.window.withProgress(\n+        {\n+            location: vscode.ProgressLocation.Notification,\n+            cancellable: false, // FIXME: add support for canceling download?\n+            title: `Downloading ${displayName} (${releaseName})`\n+        },\n+        async (progress, _cancellationToken) => {\n+            let lastPrecentage = 0;\n+            const filePermissions = 0o755; // (rwx, r_x, r_x)\n+            await downloadFile(downloadUrl, installationPath, filePermissions, throttle(\n+                200,\n+                /* noTrailing: */ true,\n+                (readBytes, totalBytes) => {\n+                    const newPercentage = (readBytes / totalBytes) * 100;\n+                    progress.report({\n+                        message: newPercentage.toFixed(0) + \"%\",\n+                        increment: newPercentage - lastPrecentage\n+                    });\n+\n+                    lastPrecentage = newPercentage;\n+                })\n+            );\n+        }\n+    );\n+    console.timeEnd(`Downloading ${artifactFileName}`);\n+}"}]}