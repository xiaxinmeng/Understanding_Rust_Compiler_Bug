{"sha": "dd5b1de1812f308ad68472d2ab06c15d3c342d75", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRkNWIxZGUxODEyZjMwOGFkNjg0NzJkMmFiMDZjMTVkM2MzNDJkNzU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-04-28T00:24:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-04-28T00:24:33Z"}, "message": "auto merge of #6082 : catamorphism/rust/mkdir_recursive, r=brson\n\nr? @brson mkdir_recursive creates a directory as well as any of its\r\nparent directories that don't exist already. Seems like a useful\r\nthing to have in core.\r\n\r\n(Or r? anyone who gets to it first.)", "tree": {"sha": "6cca3a72f779c525e697e861b614159b37c486c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6cca3a72f779c525e697e861b614159b37c486c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd5b1de1812f308ad68472d2ab06c15d3c342d75", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd5b1de1812f308ad68472d2ab06c15d3c342d75", "html_url": "https://github.com/rust-lang/rust/commit/dd5b1de1812f308ad68472d2ab06c15d3c342d75", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd5b1de1812f308ad68472d2ab06c15d3c342d75/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88dd53a75441d25a060fb7dc7131ea3772383562", "url": "https://api.github.com/repos/rust-lang/rust/commits/88dd53a75441d25a060fb7dc7131ea3772383562", "html_url": "https://github.com/rust-lang/rust/commit/88dd53a75441d25a060fb7dc7131ea3772383562"}, {"sha": "848641fcb54c282f6bd616ef1d6ac06087d778f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/848641fcb54c282f6bd616ef1d6ac06087d778f6", "html_url": "https://github.com/rust-lang/rust/commit/848641fcb54c282f6bd616ef1d6ac06087d778f6"}], "stats": {"total": 79, "additions": 40, "deletions": 39}, "files": [{"sha": "b81209d35cf1d1509677048abcfc89d2520a714a", "filename": "src/libcore/os.rs", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/dd5b1de1812f308ad68472d2ab06c15d3c342d75/src%2Flibcore%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd5b1de1812f308ad68472d2ab06c15d3c342d75/src%2Flibcore%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fos.rs?ref=dd5b1de1812f308ad68472d2ab06c15d3c342d75", "patch": "@@ -639,6 +639,27 @@ pub fn make_dir(p: &Path, mode: c_int) -> bool {\n     }\n }\n \n+/// Creates a directory with a given mode.\n+/// Returns true iff creation\n+/// succeeded. Also creates all intermediate subdirectories\n+/// if they don't already exist, giving all of them the same mode.\n+pub fn mkdir_recursive(p: &Path, mode: c_int) -> bool {\n+    if path_is_dir(p) {\n+        return true;\n+    }\n+    let parent = p.dir_path();\n+    debug!(\"mkdir_recursive: parent = %s\",\n+           parent.to_str());\n+    if parent.to_str() == ~\".\"\n+        || parent.to_str() == ~\"/\" { // !!!\n+        // No parent directories to create\n+        path_is_dir(&parent) && make_dir(p, mode)\n+    }\n+    else {\n+        mkdir_recursive(&parent, mode) && make_dir(p, mode)\n+    }\n+}\n+\n /// Lists the contents of a directory\n #[allow(non_implicitly_copyable_typarams)]\n pub fn list_dir(p: &Path) -> ~[~str] {\n@@ -1467,4 +1488,18 @@ mod tests {\n           assert!((remove_file(&out)));\n         }\n     }\n+\n+    #[test]\n+    fn recursive_mkdir_ok() {\n+        use libc::consts::os::posix88::{S_IRUSR, S_IWUSR, S_IXUSR};\n+\n+        let root = os::tmpdir();\n+        let path = \"xy/z/zy\";\n+        let nested = root.push(path);\n+        assert!(os::mkdir_recursive(&nested,  (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n+        assert!(os::path_is_dir(&root.push(\"xy\")));\n+        assert!(os::path_is_dir(&root.push(\"xy/z\")));\n+        assert!(os::path_is_dir(&nested));\n+    }\n+\n }"}, {"sha": "0ebc33cf5bc3e8a979a44d5e3f903900539b322c", "filename": "src/librustpkg/path_util.rs", "status": "modified", "additions": 5, "deletions": 39, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/dd5b1de1812f308ad68472d2ab06c15d3c342d75/src%2Flibrustpkg%2Fpath_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd5b1de1812f308ad68472d2ab06c15d3c342d75/src%2Flibrustpkg%2Fpath_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Fpath_util.rs?ref=dd5b1de1812f308ad68472d2ab06c15d3c342d75", "patch": "@@ -14,6 +14,7 @@ use core::path::*;\n use core::{os, str};\n use core::option::*;\n use util::PkgId;\n+use core::libc::consts::os::posix88::{S_IRUSR, S_IWUSR, S_IXUSR};\n \n #[deriving(Eq)]\n pub enum OutputType { Main, Lib, Bench, Test }\n@@ -25,34 +26,15 @@ pub fn rust_path() -> ~[Path] {\n     ~[Path(\".\")]\n }\n \n+static u_rwx: i32 = (S_IRUSR | S_IWUSR | S_IXUSR) as i32;\n+\n /// Creates a directory that is readable, writeable,\n /// and executable by the user. Returns true iff creation\n /// succeeded.\n pub fn make_dir_rwx(p: &Path) -> bool {\n     use core::libc::consts::os::posix88::{S_IRUSR, S_IWUSR, S_IXUSR};\n \n-    os::make_dir(p, (S_IRUSR | S_IWUSR | S_IXUSR) as i32)\n-}\n-\n-/// Creates a directory that is readable, writeable,\n-/// and executable by the user. Returns true iff creation\n-/// succeeded. Also creates all intermediate subdirectories\n-/// if they don't already exist.\n-pub fn mkdir_recursive(p: &Path) -> bool {\n-    if os::path_is_dir(p) {\n-        return true;\n-    }\n-    let parent = p.dir_path();\n-    debug!(\"mkdir_recursive: parent = %s\",\n-           parent.to_str());\n-    if parent.to_str() == ~\".\"\n-        || parent.to_str() == ~\"/\" { // !!!\n-        // No parent directories to create\n-        os::path_is_dir(&parent) && make_dir_rwx(p)\n-    }\n-    else {\n-        mkdir_recursive(&parent) && make_dir_rwx(p)\n-    }\n+    os::make_dir(p, u_rwx)\n }\n \n /// Replace all occurrences of '-' in the stem part of path with '_'\n@@ -130,7 +112,7 @@ pub fn build_pkg_id_in_workspace(pkgid: PkgId, workspace: &Path) -> Path {\n     // n.b. Should actually use a target-specific\n     // subdirectory of build/\n     result = result.push(normalize(~pkgid.path).to_str());\n-    if os::path_exists(&result) || mkdir_recursive(&result) {\n+    if os::path_exists(&result) || os::mkdir_recursive(&result, u_rwx) {\n         result\n     }\n     else {\n@@ -148,19 +130,3 @@ pub fn mk_output_path(what: OutputType, short_name: ~str, dir: Path) -> Path {\n                            os::EXE_SUFFIX))\n     }\n }\n-\n-#[cfg(test)]\n-mod test {\n-    use core::os;\n-\n-    #[test]\n-    fn recursive_mkdir_ok() {\n-        let root = os::tmpdir();\n-        let path = \"xy/z/zy\";\n-        let nested = root.push(path);\n-        assert!(super::mkdir_recursive(&nested));\n-        assert!(os::path_is_dir(&root.push(\"xy\")));\n-        assert!(os::path_is_dir(&root.push(\"xy/z\")));\n-        assert!(os::path_is_dir(&nested));\n-    }\n-}"}]}