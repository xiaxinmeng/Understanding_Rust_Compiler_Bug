{"sha": "e7148592adde0b09d7bf34426e215c6c25fc7cd1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3MTQ4NTkyYWRkZTBiMDlkN2JmMzQ0MjZlMjE1YzZjMjVmYzdjZDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-05T11:41:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-05T11:41:33Z"}, "message": "auto merge of #13330 : huonw/rust/loop-error, r=alexcrichton\n\nrustc: move the check_loop pass earlier.\r\n\r\nThis pass is purely AST based, and by running it earlier we emit more\r\nuseful error messages, e.g. type inference fails in the case of \r\n`let r = break;` with few constraints on `r`, but it's more useful to be told that\r\nthe `break` is outside the loop (rather than a type error) when it is.\r\n\r\nCloses #13292.", "tree": {"sha": "2c1fc0d2a516a8a0e02cc2dad1728ad296231519", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2c1fc0d2a516a8a0e02cc2dad1728ad296231519"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e7148592adde0b09d7bf34426e215c6c25fc7cd1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e7148592adde0b09d7bf34426e215c6c25fc7cd1", "html_url": "https://github.com/rust-lang/rust/commit/e7148592adde0b09d7bf34426e215c6c25fc7cd1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e7148592adde0b09d7bf34426e215c6c25fc7cd1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3bfa05021db00aa04fe206292ed0e70342767aa4", "url": "https://api.github.com/repos/rust-lang/rust/commits/3bfa05021db00aa04fe206292ed0e70342767aa4", "html_url": "https://github.com/rust-lang/rust/commit/3bfa05021db00aa04fe206292ed0e70342767aa4"}, {"sha": "3766453a422198c77df4970159dd3a56f05e1861", "url": "https://api.github.com/repos/rust-lang/rust/commits/3766453a422198c77df4970159dd3a56f05e1861", "html_url": "https://github.com/rust-lang/rust/commit/3766453a422198c77df4970159dd3a56f05e1861"}], "stats": {"total": 22, "additions": 11, "deletions": 11}, "files": [{"sha": "7cb8a3c4efd221f5546758bc18b9b08b6f720da7", "filename": "src/librustc/driver/driver.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e7148592adde0b09d7bf34426e215c6c25fc7cd1/src%2Flibrustc%2Fdriver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7148592adde0b09d7bf34426e215c6c25fc7cd1/src%2Flibrustc%2Fdriver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fdriver.rs?ref=e7148592adde0b09d7bf34426e215c6c25fc7cd1", "patch": "@@ -323,6 +323,9 @@ pub fn phase_3_run_analysis_passes(sess: Session,\n     let region_map = time(time_passes, \"region resolution\", (), |_|\n                           middle::region::resolve_crate(&sess, krate));\n \n+    time(time_passes, \"loop checking\", (), |_|\n+         middle::check_loop::check_crate(&sess, krate));\n+\n     let ty_cx = ty::mk_ctxt(sess, def_map, named_region_map, ast_map,\n                             freevars, region_map, lang_items);\n \n@@ -348,9 +351,6 @@ pub fn phase_3_run_analysis_passes(sess: Session,\n     time(time_passes, \"effect checking\", (), |_|\n          middle::effect::check_crate(&ty_cx, method_map, krate));\n \n-    time(time_passes, \"loop checking\", (), |_|\n-         middle::check_loop::check_crate(&ty_cx, krate));\n-\n     let middle::moves::MoveMaps {moves_map, moved_variables_set,\n                                  capture_map} =\n         time(time_passes, \"compute moves\", (), |_|"}, {"sha": "4f08d818f4a13c33ad406f3012b67d905bbe163a", "filename": "src/librustc/middle/check_loop.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e7148592adde0b09d7bf34426e215c6c25fc7cd1/src%2Flibrustc%2Fmiddle%2Fcheck_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7148592adde0b09d7bf34426e215c6c25fc7cd1/src%2Flibrustc%2Fmiddle%2Fcheck_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcheck_loop.rs?ref=e7148592adde0b09d7bf34426e215c6c25fc7cd1", "patch": "@@ -8,7 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-use middle::ty;\n+use driver::session::Session;\n \n use syntax::ast;\n use syntax::codemap::Span;\n@@ -21,11 +21,11 @@ enum Context {\n }\n \n struct CheckLoopVisitor<'a> {\n-    tcx: &'a ty::ctxt,\n+    sess: &'a Session,\n }\n \n-pub fn check_crate(tcx: &ty::ctxt, krate: &ast::Crate) {\n-    visit::walk_crate(&mut CheckLoopVisitor { tcx: tcx }, krate, Normal)\n+pub fn check_crate(sess: &Session, krate: &ast::Crate) {\n+    visit::walk_crate(&mut CheckLoopVisitor { sess: sess }, krate, Normal)\n }\n \n impl<'a> Visitor<Context> for CheckLoopVisitor<'a> {\n@@ -57,12 +57,10 @@ impl<'a> CheckLoopVisitor<'a> {\n         match cx {\n             Loop => {}\n             Closure => {\n-                self.tcx.sess.span_err(span, format!(\"`{}` inside of a closure\",\n-                                                     name));\n+                self.sess.span_err(span, format!(\"`{}` inside of a closure\", name));\n             }\n             Normal => {\n-                self.tcx.sess.span_err(span, format!(\"`{}` outside of loop\",\n-                                                     name));\n+                self.sess.span_err(span, format!(\"`{}` outside of loop\", name));\n             }\n         }\n     }"}, {"sha": "210e3d3af800b1f99c29536e58c4b8ea89f99900", "filename": "src/test/compile-fail/break-outside-loop.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e7148592adde0b09d7bf34426e215c6c25fc7cd1/src%2Ftest%2Fcompile-fail%2Fbreak-outside-loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7148592adde0b09d7bf34426e215c6c25fc7cd1/src%2Ftest%2Fcompile-fail%2Fbreak-outside-loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbreak-outside-loop.rs?ref=e7148592adde0b09d7bf34426e215c6c25fc7cd1", "patch": "@@ -30,4 +30,6 @@ fn main() {\n     }\n \n     let rs: Foo = Foo{t: pth};\n+\n+    let unconstrained = break; //~ ERROR: `break` outside of loop\n }"}]}