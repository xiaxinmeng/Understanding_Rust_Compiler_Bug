{"sha": "cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiZjc0YmM0Y2EzZjlhM2IxN2FmNjcyOTMwYzU2ZmEyNTg2MWIyMWU=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-11-05T09:29:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-05T09:29:45Z"}, "message": "Rollup merge of #78584 - notriddle:master, r=GuillaumeGomez\n\nAdd keyboard handling to the theme picker menu\n\nThis PR is mostly designed to bring the theme picker closer to feature parity with the menu bar from docs.rs. Though the rustdoc theme picker is technically already usable from the keyboard, it's really weird that arrow keys work on some of the menus, but not all of them, in the exact same page.", "tree": {"sha": "bbbd85ea7b60b7559e4c17bbb92bd6a909c9eb18", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbbd85ea7b60b7559e4c17bbb92bd6a909c9eb18"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfo8YJCRBK7hj4Ov3rIwAAdHIIAKcyfuxvsrCNsWFIZyhHrH9Y\nfVtT2Br44jIhOn4KaQMYV/iBkFU1vYB53oE2+5h6WhY4PFPd0bm0AGceapZcmNbS\nKpDYBKFHHwW94lbE8bsV8T9EpOAXtlRdvFbde9xAuqOi6Dei0Ec3+BiXkFa4fw2/\n0I3yrJt6UN3bs5j4epCTSYScJteOrGDkIyDvf02ukI7CplxLWwNvTyUMXOtI12KJ\nd99ZUAFHulZTA3N5w9R6kvrXhRb1/q8sy9U0r5Fh/Oy35wwJ9XXWv7KC3m/zDi8P\nZnEEFz5m1Bu8wjdDAVGhO+17J/vtH+mAVUGUwaD8rkjWCwDron7m9iYuHq05cNo=\n=bbkr\n-----END PGP SIGNATURE-----\n", "payload": "tree bbbd85ea7b60b7559e4c17bbb92bd6a909c9eb18\nparent 6d7098f543f51611eab620b6d2e6f9d4167fc96e\nparent 17b8ca952baf5d32ef6e9653b0eda6516386400c\nauthor Mara Bos <m-ou.se@m-ou.se> 1604568585 +0100\ncommitter GitHub <noreply@github.com> 1604568585 +0100\n\nRollup merge of #78584 - notriddle:master, r=GuillaumeGomez\n\nAdd keyboard handling to the theme picker menu\n\nThis PR is mostly designed to bring the theme picker closer to feature parity with the menu bar from docs.rs. Though the rustdoc theme picker is technically already usable from the keyboard, it's really weird that arrow keys work on some of the menus, but not all of them, in the exact same page.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "html_url": "https://github.com/rust-lang/rust/commit/cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d7098f543f51611eab620b6d2e6f9d4167fc96e", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d7098f543f51611eab620b6d2e6f9d4167fc96e", "html_url": "https://github.com/rust-lang/rust/commit/6d7098f543f51611eab620b6d2e6f9d4167fc96e"}, {"sha": "17b8ca952baf5d32ef6e9653b0eda6516386400c", "url": "https://api.github.com/repos/rust-lang/rust/commits/17b8ca952baf5d32ef6e9653b0eda6516386400c", "html_url": "https://github.com/rust-lang/rust/commit/17b8ca952baf5d32ef6e9653b0eda6516386400c"}], "stats": {"total": 76, "additions": 64, "deletions": 12}, "files": [{"sha": "db73af7ec1689311525fabfe8ba9dc83df4d3031", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "patch": "@@ -79,12 +79,12 @@ pub fn render<T: Print, S: Print>(\n         {sidebar}\\\n     </nav>\\\n     <div class=\\\"theme-picker\\\">\\\n-        <button id=\\\"theme-picker\\\" aria-label=\\\"Pick another theme!\\\">\\\n+        <button id=\\\"theme-picker\\\" aria-label=\\\"Pick another theme!\\\" aria-haspopup=\\\"menu\\\">\\\n             <img src=\\\"{static_root_path}brush{suffix}.svg\\\" \\\n                  width=\\\"18\\\" \\\n                  alt=\\\"Pick another theme!\\\">\\\n         </button>\\\n-        <div id=\\\"theme-choices\\\"></div>\\\n+        <div id=\\\"theme-choices\\\" role=\\\"menu\\\"></div>\\\n     </div>\\\n     <script src=\\\"{static_root_path}theme{suffix}.js\\\"></script>\\\n     <nav class=\\\"sub\\\">\\"}, {"sha": "5ac0ffcfbf1c2d18b50928006dd82d54cd7b0acc", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "patch": "@@ -798,10 +798,10 @@ function handleThemeButtonsBlur(e) {{\n     var active = document.activeElement;\n     var related = e.relatedTarget;\n \n-    if (active.id !== \"themePicker\" &&\n+    if (active.id !== \"theme-picker\" &&\n         (!active.parentNode || active.parentNode.id !== \"theme-choices\") &&\n         (!related ||\n-         (related.id !== \"themePicker\" &&\n+         (related.id !== \"theme-picker\" &&\n           (!related.parentNode || related.parentNode.id !== \"theme-choices\")))) {{\n         hideThemeButtonState();\n     }}"}, {"sha": "de4792a5bd2f7fa12c890a5fe0cf86c7e28cf825", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 60, "deletions": 8, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/cbf74bc4ca3f9a3b17af672930c56fa25861b21e/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=cbf74bc4ca3f9a3b17af672930c56fa25861b21e", "patch": "@@ -4,6 +4,7 @@\n // Local js definitions:\n /* global addClass, getCurrentValue, hasClass */\n /* global onEachLazy, hasOwnProperty, removeClass, updateLocalStorage */\n+/* global hideThemeButtonState, showThemeButtonState */\n \n if (!String.prototype.startsWith) {\n     String.prototype.startsWith = function(searchString, position) {\n@@ -47,6 +48,14 @@ function getSearchElement() {\n     return document.getElementById(\"search\");\n }\n \n+function getThemesElement() {\n+    return document.getElementById(\"theme-choices\");\n+}\n+\n+function getThemePickerElement() {\n+    return document.getElementById(\"theme-picker\");\n+}\n+\n // Sets the focus on the search bar at the top of the page\n function focusSearchBar() {\n     getSearchInput().focus();\n@@ -137,10 +146,6 @@ function defocusSearchBar() {\n                 sidebar.appendChild(div);\n             }\n         }\n-        var themePickers = document.getElementsByClassName(\"theme-picker\");\n-        if (themePickers && themePickers.length > 0) {\n-            themePickers[0].style.display = \"none\";\n-        }\n     }\n \n     function hideSidebar() {\n@@ -155,10 +160,6 @@ function defocusSearchBar() {\n             filler.remove();\n         }\n         document.getElementsByTagName(\"body\")[0].style.marginTop = \"\";\n-        var themePickers = document.getElementsByClassName(\"theme-picker\");\n-        if (themePickers && themePickers.length > 0) {\n-            themePickers[0].style.display = null;\n-        }\n     }\n \n     function showSearchResults(search) {\n@@ -376,6 +377,7 @@ function defocusSearchBar() {\n             document.title = titleBeforeSearch;\n         }\n         defocusSearchBar();\n+        hideThemeButtonState();\n     }\n \n     function handleShortcut(ev) {\n@@ -412,7 +414,57 @@ function defocusSearchBar() {\n             case \"?\":\n                 displayHelp(true, ev);\n                 break;\n+\n+            default:\n+                var themePicker = getThemePickerElement();\n+                if (themePicker.parentNode.contains(ev.target)) {\n+                    handleThemeKeyDown(ev);\n+                }\n+            }\n+        }\n+    }\n+\n+    function handleThemeKeyDown(ev) {\n+        var active = document.activeElement;\n+        var themes = getThemesElement();\n+        switch (getVirtualKey(ev)) {\n+        case \"ArrowUp\":\n+            ev.preventDefault();\n+            if (active.previousElementSibling && ev.target.id !== \"theme-picker\") {\n+                active.previousElementSibling.focus();\n+            } else {\n+                showThemeButtonState();\n+                themes.lastElementChild.focus();\n+            }\n+            break;\n+        case \"ArrowDown\":\n+            ev.preventDefault();\n+            if (active.nextElementSibling && ev.target.id !== \"theme-picker\") {\n+                active.nextElementSibling.focus();\n+            } else {\n+                showThemeButtonState();\n+                themes.firstElementChild.focus();\n+            }\n+            break;\n+        case \"Enter\":\n+        case \"Return\":\n+        case \"Space\":\n+            if (ev.target.id === \"theme-picker\" && themes.style.display === \"none\") {\n+                ev.preventDefault();\n+                showThemeButtonState();\n+                themes.firstElementChild.focus();\n             }\n+            break;\n+        case \"Home\":\n+            ev.preventDefault();\n+            themes.firstElementChild.focus();\n+            break;\n+        case \"End\":\n+            ev.preventDefault();\n+            themes.lastElementChild.focus();\n+            break;\n+        // The escape key is handled in handleEscape, not here,\n+        // so that pressing escape will close the menu even if it isn't focused\n         }\n     }\n "}]}