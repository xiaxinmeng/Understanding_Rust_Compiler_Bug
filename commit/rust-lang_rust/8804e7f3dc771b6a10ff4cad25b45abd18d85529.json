{"sha": "8804e7f3dc771b6a10ff4cad25b45abd18d85529", "node_id": "C_kwDOAAsO6NoAKDg4MDRlN2YzZGM3NzFiNmExMGZmNGNhZDI1YjQ1YWJkMThkODU1Mjk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-14T17:02:53Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-14T17:02:53Z"}, "message": "Rollup merge of #108025 - notriddle:notriddle/intra-doc-link-tooltips, r=GuillaumeGomez\n\nrustdoc: add more tooltips to intra-doc links\n\nThis commit makes intra-doc link tooltips consistent with generated links in function signatures and item tables, with the format `itemtype foo::bar::baz`. This way, you can tell if a link points at a trait or a type (for example) by mousing over it.\n\nSee also https://github.com/rust-lang/rust/pull/39697\n\nPartially solves https://internals.rust-lang.org/t/rustdoc-suggestion-highlight-links-fn-s-mod-s-type-s-etc-appropriately-within-and-documentation/17931 (though the Internals thread asks for color-coding, while this PR adds a tooltip instead, it's accomplishing the same thing).\n\nBefore:\n\n<img width=\"950\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1593513/218653059-911cea01-7231-438a-ad98-be98ab73783f.png\">\n\nAfter:\n\n<img width=\"432\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1593513/218653201-34ca3aa7-18f1-4cb1-be68-a1411bbe797e.png\">", "tree": {"sha": "1b0e7f62b9668475455f4bb3b21b902e4d0daa9b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1b0e7f62b9668475455f4bb3b21b902e4d0daa9b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8804e7f3dc771b6a10ff4cad25b45abd18d85529", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj6769CRBK7hj4Ov3rIwAACkgIAGmUa1q+C7HBjVvrw4wHefFi\nMHtLsNJtVcKf+kjoNDPhPrE4iN4MQzroqZFRgQcTnNI6GoaFR0gt2BIIbaMuNwub\n97A/SuXdEYEI7SdLw+W79NzDuEThOMQUU20S7zGgnxf+glUWy2lYcgbb/R4Ncrwu\n2PqRsGNHddXFaZhTfBvxqwTTpPL/aj0jtvrAOs8QtajMuwKLsBFwruGkHnZVqNpI\nhPB6ZrZ5Yk5iu9USZf9RYNk6sCpxSEKaZFhNiAi1bQVGJMJ7mCmXqOW/lPQFBv6P\noRHuTC5GznJmKR3REE9Hyqv4VgcpvkxG9/letc4l9AGoyTuonGcliFmOEUDPiTY=\n=M9jC\n-----END PGP SIGNATURE-----\n", "payload": "tree 1b0e7f62b9668475455f4bb3b21b902e4d0daa9b\nparent 43b42c5e784905fb17cd17496317c6c1ca7269f6\nparent ba4b026e80c6278b6d0d8d4b4bf66daf4f49ed09\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1676394173 +0100\ncommitter GitHub <noreply@github.com> 1676394173 +0100\n\nRollup merge of #108025 - notriddle:notriddle/intra-doc-link-tooltips, r=GuillaumeGomez\n\nrustdoc: add more tooltips to intra-doc links\n\nThis commit makes intra-doc link tooltips consistent with generated links in function signatures and item tables, with the format `itemtype foo::bar::baz`. This way, you can tell if a link points at a trait or a type (for example) by mousing over it.\n\nSee also https://github.com/rust-lang/rust/pull/39697\n\nPartially solves https://internals.rust-lang.org/t/rustdoc-suggestion-highlight-links-fn-s-mod-s-type-s-etc-appropriately-within-and-documentation/17931 (though the Internals thread asks for color-coding, while this PR adds a tooltip instead, it's accomplishing the same thing).\n\nBefore:\n\n<img width=\"950\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1593513/218653059-911cea01-7231-438a-ad98-be98ab73783f.png\">\n\nAfter:\n\n<img width=\"432\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1593513/218653201-34ca3aa7-18f1-4cb1-be68-a1411bbe797e.png\">\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8804e7f3dc771b6a10ff4cad25b45abd18d85529", "html_url": "https://github.com/rust-lang/rust/commit/8804e7f3dc771b6a10ff4cad25b45abd18d85529", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8804e7f3dc771b6a10ff4cad25b45abd18d85529/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "43b42c5e784905fb17cd17496317c6c1ca7269f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/43b42c5e784905fb17cd17496317c6c1ca7269f6", "html_url": "https://github.com/rust-lang/rust/commit/43b42c5e784905fb17cd17496317c6c1ca7269f6"}, {"sha": "ba4b026e80c6278b6d0d8d4b4bf66daf4f49ed09", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba4b026e80c6278b6d0d8d4b4bf66daf4f49ed09", "html_url": "https://github.com/rust-lang/rust/commit/ba4b026e80c6278b6d0d8d4b4bf66daf4f49ed09"}], "stats": {"total": 61, "additions": 52, "deletions": 9}, "files": [{"sha": "b00cefdddb5242508072de5cf7facc4a5d597b90", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8804e7f3dc771b6a10ff4cad25b45abd18d85529/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8804e7f3dc771b6a10ff4cad25b45abd18d85529/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=8804e7f3dc771b6a10ff4cad25b45abd18d85529", "patch": "@@ -482,23 +482,24 @@ impl Item {\n     }\n \n     pub(crate) fn links(&self, cx: &Context<'_>) -> Vec<RenderedLink> {\n-        use crate::html::format::href;\n+        use crate::html::format::{href, link_tooltip};\n \n         cx.cache()\n             .intra_doc_links\n             .get(&self.item_id)\n             .map_or(&[][..], |v| v.as_slice())\n             .iter()\n-            .filter_map(|ItemLink { link: s, link_text, page_id: did, ref fragment }| {\n-                debug!(?did);\n-                if let Ok((mut href, ..)) = href(*did, cx) {\n+            .filter_map(|ItemLink { link: s, link_text, page_id: id, ref fragment }| {\n+                debug!(?id);\n+                if let Ok((mut href, ..)) = href(*id, cx) {\n                     debug!(?href);\n                     if let Some(ref fragment) = *fragment {\n                         fragment.render(&mut href, cx.tcx())\n                     }\n                     Some(RenderedLink {\n                         original_text: s.clone(),\n                         new_text: link_text.clone(),\n+                        tooltip: link_tooltip(*id, fragment, cx),\n                         href,\n                     })\n                 } else {\n@@ -523,6 +524,7 @@ impl Item {\n                 original_text: s.clone(),\n                 new_text: link_text.clone(),\n                 href: String::new(),\n+                tooltip: String::new(),\n             })\n             .collect()\n     }\n@@ -1040,6 +1042,8 @@ pub struct RenderedLink {\n     pub(crate) new_text: String,\n     /// The URL to put in the `href`\n     pub(crate) href: String,\n+    /// The tooltip.\n+    pub(crate) tooltip: String,\n }\n \n /// The attributes on an [`Item`], including attributes like `#[derive(...)]` and `#[inline]`,"}, {"sha": "314f061224940d6e6fe715cf1cd7431dc23eda4f", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8804e7f3dc771b6a10ff4cad25b45abd18d85529/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8804e7f3dc771b6a10ff4cad25b45abd18d85529/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=8804e7f3dc771b6a10ff4cad25b45abd18d85529", "patch": "@@ -34,6 +34,7 @@ use crate::clean::{\n use crate::formats::item_type::ItemType;\n use crate::html::escape::Escape;\n use crate::html::render::Context;\n+use crate::passes::collect_intra_doc_links::UrlFragment;\n \n use super::url_parts_builder::estimate_item_path_byte_length;\n use super::url_parts_builder::UrlPartsBuilder;\n@@ -768,6 +769,21 @@ pub(crate) fn href_relative_parts<'fqp>(\n     }\n }\n \n+pub(crate) fn link_tooltip(did: DefId, fragment: &Option<UrlFragment>, cx: &Context<'_>) -> String {\n+    let cache = cx.cache();\n+    let Some((fqp, shortty)) = cache.paths.get(&did)\n+        .or_else(|| cache.external_paths.get(&did))\n+        else { return String::new() };\n+    let fqp = fqp.iter().map(|sym| sym.as_str()).join(\"::\");\n+    if let &Some(UrlFragment::Item(id)) = fragment {\n+        let name = cx.tcx().item_name(id);\n+        let descr = cx.tcx().def_kind(id).descr(id);\n+        format!(\"{descr} {fqp}::{name}\")\n+    } else {\n+        format!(\"{shortty} {fqp}\")\n+    }\n+}\n+\n /// Used to render a [`clean::Path`].\n fn resolved_path<'cx>(\n     w: &mut fmt::Formatter<'_>,"}, {"sha": "e4adee6ae4dfb5f8fbd8e3f49e1b12bfaa07d6e0", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8804e7f3dc771b6a10ff4cad25b45abd18d85529/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8804e7f3dc771b6a10ff4cad25b45abd18d85529/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=8804e7f3dc771b6a10ff4cad25b45abd18d85529", "patch": "@@ -360,6 +360,9 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for LinkReplacer<'a, I> {\n                     trace!(\"it matched\");\n                     assert!(self.shortcut_link.is_none(), \"shortcut links cannot be nested\");\n                     self.shortcut_link = Some(link);\n+                    if title.is_empty() && !link.tooltip.is_empty() {\n+                        *title = CowStr::Borrowed(link.tooltip.as_ref());\n+                    }\n                 }\n             }\n             // Now that we're done with the shortcut link, don't replace any more text.\n@@ -410,9 +413,12 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for LinkReplacer<'a, I> {\n             }\n             // If this is a link, but not a shortcut link,\n             // replace the URL, since the broken_link_callback was not called.\n-            Some(Event::Start(Tag::Link(_, dest, _))) => {\n+            Some(Event::Start(Tag::Link(_, dest, title))) => {\n                 if let Some(link) = self.links.iter().find(|&link| *link.original_text == **dest) {\n                     *dest = CowStr::Borrowed(link.href.as_ref());\n+                    if title.is_empty() && !link.tooltip.is_empty() {\n+                        *title = CowStr::Borrowed(link.tooltip.as_ref());\n+                    }\n                 }\n             }\n             // Anything else couldn't have been a valid Rust path, so no need to replace the text.\n@@ -976,7 +982,7 @@ impl Markdown<'_> {\n             links\n                 .iter()\n                 .find(|link| link.original_text.as_str() == &*broken_link.reference)\n-                .map(|link| (link.href.as_str().into(), link.new_text.as_str().into()))\n+                .map(|link| (link.href.as_str().into(), link.tooltip.as_str().into()))\n         };\n \n         let p = Parser::new_with_broken_link_callback(md, main_body_opts(), Some(&mut replacer));\n@@ -1059,7 +1065,7 @@ impl MarkdownSummaryLine<'_> {\n             links\n                 .iter()\n                 .find(|link| link.original_text.as_str() == &*broken_link.reference)\n-                .map(|link| (link.href.as_str().into(), link.new_text.as_str().into()))\n+                .map(|link| (link.href.as_str().into(), link.tooltip.as_str().into()))\n         };\n \n         let p = Parser::new_with_broken_link_callback(md, summary_opts(), Some(&mut replacer))\n@@ -1106,7 +1112,7 @@ fn markdown_summary_with_limit(\n         link_names\n             .iter()\n             .find(|link| link.original_text.as_str() == &*broken_link.reference)\n-            .map(|link| (link.href.as_str().into(), link.new_text.as_str().into()))\n+            .map(|link| (link.href.as_str().into(), link.tooltip.as_str().into()))\n     };\n \n     let p = Parser::new_with_broken_link_callback(md, summary_opts(), Some(&mut replacer));\n@@ -1187,7 +1193,7 @@ pub(crate) fn plain_text_summary(md: &str, link_names: &[RenderedLink]) -> Strin\n         link_names\n             .iter()\n             .find(|link| link.original_text.as_str() == &*broken_link.reference)\n-            .map(|link| (link.href.as_str().into(), link.new_text.as_str().into()))\n+            .map(|link| (link.href.as_str().into(), link.tooltip.as_str().into()))\n     };\n \n     let p = Parser::new_with_broken_link_callback(md, summary_opts(), Some(&mut replacer));"}, {"sha": "e2d3ef425cb45f41d62a2db979ae67106f1879e5", "filename": "tests/rustdoc/intra-doc/basic.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/8804e7f3dc771b6a10ff4cad25b45abd18d85529/tests%2Frustdoc%2Fintra-doc%2Fbasic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8804e7f3dc771b6a10ff4cad25b45abd18d85529/tests%2Frustdoc%2Fintra-doc%2Fbasic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fintra-doc%2Fbasic.rs?ref=8804e7f3dc771b6a10ff4cad25b45abd18d85529", "patch": "@@ -1,21 +1,38 @@\n // @has basic/index.html\n // @has - '//a/@href' 'struct.ThisType.html'\n+// @has - '//a/@title' 'struct basic::ThisType'\n // @has - '//a/@href' 'struct.ThisType.html#method.this_method'\n+// @has - '//a/@title' 'associated function basic::ThisType::this_method'\n // @has - '//a/@href' 'enum.ThisEnum.html'\n+// @has - '//a/@title' 'enum basic::ThisEnum'\n // @has - '//a/@href' 'enum.ThisEnum.html#variant.ThisVariant'\n+// @has - '//a/@title' 'variant basic::ThisEnum::ThisVariant'\n // @has - '//a/@href' 'trait.ThisTrait.html'\n+// @has - '//a/@title' 'trait basic::ThisTrait'\n // @has - '//a/@href' 'trait.ThisTrait.html#tymethod.this_associated_method'\n+// @has - '//a/@title' 'associated function basic::ThisTrait::this_associated_method'\n // @has - '//a/@href' 'trait.ThisTrait.html#associatedtype.ThisAssociatedType'\n+// @has - '//a/@title' 'associated type basic::ThisTrait::ThisAssociatedType'\n // @has - '//a/@href' 'trait.ThisTrait.html#associatedconstant.THIS_ASSOCIATED_CONST'\n+// @has - '//a/@title' 'associated constant basic::ThisTrait::THIS_ASSOCIATED_CONST'\n // @has - '//a/@href' 'trait.ThisTrait.html'\n+// @has - '//a/@title' 'trait basic::ThisTrait'\n // @has - '//a/@href' 'type.ThisAlias.html'\n+// @has - '//a/@title' 'type basic::ThisAlias'\n // @has - '//a/@href' 'union.ThisUnion.html'\n+// @has - '//a/@title' 'union basic::ThisUnion'\n // @has - '//a/@href' 'fn.this_function.html'\n+// @has - '//a/@title' 'fn basic::this_function'\n // @has - '//a/@href' 'constant.THIS_CONST.html'\n+// @has - '//a/@title' 'constant basic::THIS_CONST'\n // @has - '//a/@href' 'static.THIS_STATIC.html'\n+// @has - '//a/@title' 'static basic::THIS_STATIC'\n // @has - '//a/@href' 'macro.this_macro.html'\n+// @has - '//a/@title' 'macro basic::this_macro'\n // @has - '//a/@href' 'trait.SoAmbiguous.html'\n+// @has - '//a/@title' 'trait basic::SoAmbiguous'\n // @has - '//a/@href' 'fn.SoAmbiguous.html'\n+// @has - '//a/@title' 'fn basic::SoAmbiguous'\n //! In this crate we would like to link to:\n //!\n //! * [`ThisType`](ThisType)"}]}