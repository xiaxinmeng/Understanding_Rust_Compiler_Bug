{"sha": "07638b95cec645bf8f587eb7851412aa3cdf4995", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA3NjM4Yjk1Y2VjNjQ1YmY4ZjU4N2ViNzg1MTQxMmFhM2NkZjQ5OTU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-02-12T04:46:47Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-02-12T18:40:32Z"}, "message": "bootstrap: Be resilient to job object failures\n\nThe build bots already use job objects, and they don't support nested job\nobjects, and we shouldn't entirely bail out in this case anyway!", "tree": {"sha": "610a6309ece26c7dbecfdcb9f75eb81dd6183d72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/610a6309ece26c7dbecfdcb9f75eb81dd6183d72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07638b95cec645bf8f587eb7851412aa3cdf4995", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07638b95cec645bf8f587eb7851412aa3cdf4995", "html_url": "https://github.com/rust-lang/rust/commit/07638b95cec645bf8f587eb7851412aa3cdf4995", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07638b95cec645bf8f587eb7851412aa3cdf4995/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1c13d03a5bbbc99d595906e566912e0bad337b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1c13d03a5bbbc99d595906e566912e0bad337b3", "html_url": "https://github.com/rust-lang/rust/commit/a1c13d03a5bbbc99d595906e566912e0bad337b3"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "a4e53bc45fcfbf979836b89b8ea1bba17b834122", "filename": "src/bootstrap/build/job.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/07638b95cec645bf8f587eb7851412aa3cdf4995/src%2Fbootstrap%2Fbuild%2Fjob.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07638b95cec645bf8f587eb7851412aa3cdf4995/src%2Fbootstrap%2Fbuild%2Fjob.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fjob.rs?ref=07638b95cec645bf8f587eb7851412aa3cdf4995", "patch": "@@ -64,9 +64,20 @@ pub unsafe fn setup() {\n                                     mem::size_of_val(&info) as DWORD);\n     assert!(r != 0, \"{}\", io::Error::last_os_error());\n \n-    // Assign our process to this job object\n+    // Assign our process to this job object. Note that if this fails, one very\n+    // likely reason is that we are ourselves already in a job object! This can\n+    // happen on the build bots that we've got for Windows, or if just anyone\n+    // else is instrumenting the build. In this case we just bail out\n+    // immediately and assume that they take care of it.\n+    //\n+    // Also note that nested jobs (why this might fail) are supported in recent\n+    // versions of Windows, but the version of Windows that our bots are running\n+    // at least don't support nested job objects.\n     let r = AssignProcessToJobObject(job, GetCurrentProcess());\n-    assert!(r != 0, \"{}\", io::Error::last_os_error());\n+    if r == 0 {\n+        CloseHandle(job);\n+        return\n+    }\n \n     // If we've got a parent process (e.g. the python script that called us)\n     // then move ownership of this job object up to them. That way if the python"}]}