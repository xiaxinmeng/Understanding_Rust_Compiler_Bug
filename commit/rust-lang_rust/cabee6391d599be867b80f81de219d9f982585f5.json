{"sha": "cabee6391d599be867b80f81de219d9f982585f5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNhYmVlNjM5MWQ1OTliZTg2N2I4MGY4MWRlMjE5ZDlmOTgyNTg1ZjU=", "commit": {"author": {"name": "Paul Stansifer", "email": "paul.stansifer@gmail.com", "date": "2012-07-06T21:29:50Z"}, "committer": {"name": "Paul Stansifer", "email": "paul.stansifer@gmail.com", "date": "2012-07-10T00:44:46Z"}, "message": "Enable item macros to define macros.", "tree": {"sha": "c877eeeac1aae5a971f6d7a996f422bb73767443", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c877eeeac1aae5a971f6d7a996f422bb73767443"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cabee6391d599be867b80f81de219d9f982585f5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cabee6391d599be867b80f81de219d9f982585f5", "html_url": "https://github.com/rust-lang/rust/commit/cabee6391d599be867b80f81de219d9f982585f5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cabee6391d599be867b80f81de219d9f982585f5/comments", "author": {"login": "paulstansifer", "id": 1431, "node_id": "MDQ6VXNlcjE0MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1431?v=4", "gravatar_id": "", "url": "https://api.github.com/users/paulstansifer", "html_url": "https://github.com/paulstansifer", "followers_url": "https://api.github.com/users/paulstansifer/followers", "following_url": "https://api.github.com/users/paulstansifer/following{/other_user}", "gists_url": "https://api.github.com/users/paulstansifer/gists{/gist_id}", "starred_url": "https://api.github.com/users/paulstansifer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/paulstansifer/subscriptions", "organizations_url": "https://api.github.com/users/paulstansifer/orgs", "repos_url": "https://api.github.com/users/paulstansifer/repos", "events_url": "https://api.github.com/users/paulstansifer/events{/privacy}", "received_events_url": "https://api.github.com/users/paulstansifer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "paulstansifer", "id": 1431, "node_id": "MDQ6VXNlcjE0MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1431?v=4", "gravatar_id": "", "url": "https://api.github.com/users/paulstansifer", "html_url": "https://github.com/paulstansifer", "followers_url": "https://api.github.com/users/paulstansifer/followers", "following_url": "https://api.github.com/users/paulstansifer/following{/other_user}", "gists_url": "https://api.github.com/users/paulstansifer/gists{/gist_id}", "starred_url": "https://api.github.com/users/paulstansifer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/paulstansifer/subscriptions", "organizations_url": "https://api.github.com/users/paulstansifer/orgs", "repos_url": "https://api.github.com/users/paulstansifer/repos", "events_url": "https://api.github.com/users/paulstansifer/events{/privacy}", "received_events_url": "https://api.github.com/users/paulstansifer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "579768baa56e1344ef541cca6fef673b5e9eb683", "url": "https://api.github.com/repos/rust-lang/rust/commits/579768baa56e1344ef541cca6fef673b5e9eb683", "html_url": "https://github.com/rust-lang/rust/commit/579768baa56e1344ef541cca6fef673b5e9eb683"}], "stats": {"total": 23, "additions": 17, "deletions": 6}, "files": [{"sha": "afc47d2ecfce9ba792a5afaadc5bd21b4a6f5624", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cabee6391d599be867b80f81de219d9f982585f5/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cabee6391d599be867b80f81de219d9f982585f5/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=cabee6391d599be867b80f81de219d9f982585f5", "patch": "@@ -20,7 +20,12 @@ type syntax_expander_tt_ = fn@(ext_ctxt, span, ast::token_tree) -> @ast::expr;\n type syntax_expander_tt_item\n     = {expander: syntax_expander_tt_item_, span: option<span>};\n type syntax_expander_tt_item_\n-    = fn@(ext_ctxt, span, ast::ident, ast::token_tree) -> @ast::item;\n+    = fn@(ext_ctxt, span, ast::ident, ast::token_tree) -> mac_result;\n+\n+enum mac_result {\n+    mr_item(@ast::item),\n+    mr_def(macro_def)\n+}\n \n enum syntax_extension {\n     normal(syntax_expander),"}, {"sha": "c6110fbe1a7cb7e7c6d73c1b58240e099b8d3fbb", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cabee6391d599be867b80f81de219d9f982585f5/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cabee6391d599be867b80f81de219d9f982585f5/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=cabee6391d599be867b80f81de219d9f982585f5", "patch": "@@ -170,10 +170,16 @@ fn expand_item_mac(exts: hashmap<str, syntax_extension>,\n             cx.bt_push(expanded_from({call_site: it.span,\n                                       callie: {name: *extname,\n                                                span: expand.span}}));\n-            let it = fld.fold_item(\n-                expand.expander(cx, it.span, it.ident, tt));\n+            let maybe_it =\n+                alt expand.expander(cx, it.span, it.ident, tt) {\n+                  mr_item(it) { fld.fold_item(it) }\n+                  mr_def(mdef) {\n+                    exts.insert(*mdef.ident, mdef.ext);\n+                    none\n+                  }\n+                };\n             cx.bt_pop();\n-            ret it\n+            ret maybe_it\n           }\n           _ { cx.span_fatal(it.span,\n                             #fmt(\"%s is not a legal here\", *extname)) }"}, {"sha": "61c154ab15eb95b0d020e608463a91fb13ecd312", "filename": "src/libsyntax/ext/pipes.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cabee6391d599be867b80f81de219d9f982585f5/src%2Flibsyntax%2Fext%2Fpipes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cabee6391d599be867b80f81de219d9f982585f5/src%2Flibsyntax%2Fext%2Fpipes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fpipes.rs?ref=cabee6391d599be867b80f81de219d9f982585f5", "patch": "@@ -11,7 +11,7 @@ import pipes::parse_proto::proto_parser;\n import pipes::pipec::methods;\n \n fn expand_proto(cx: ext_ctxt, _sp: span, id: ast::ident, tt: ast::token_tree)\n-    -> @ast::item\n+    -> base::mac_result\n {\n     let sess = cx.parse_sess();\n     let cfg = cx.cfg();\n@@ -25,5 +25,5 @@ fn expand_proto(cx: ext_ctxt, _sp: span, id: ast::ident, tt: ast::token_tree)\n \n     let proto = rust_parser.parse_proto(id);\n \n-    proto.compile(cx)\n+    base::mr_item(proto.compile(cx))\n }"}]}