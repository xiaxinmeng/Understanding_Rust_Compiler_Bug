{"sha": "ad3407f482d29f26c67700974d86f89b3f2ab993", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkMzQwN2Y0ODJkMjlmMjZjNjc3MDA5NzRkODZmODliM2YyYWI5OTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-01T14:33:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-01T14:33:37Z"}, "message": "Auto merge of #88269 - prconrad:doctest-persist-binaries, r=jyn514\n\nDoctest persist full binaries when persisting\n\nTested by adding an extra debug to echo the whole compiler line. Trimmed significantly:\n\nPersisted but not running -> full compile so we get binaries (new behavior).\n```\n$ rustdoc -Zunstable-options --test --persist-doctests doctests --no-run --extern t=libt.rlib t.rs\n\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"doctests/t_rs_8_0/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"-Z\" \"unstable-options\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"doctests/t_rs_2_0/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"-Z\" \"unstable-options\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\ntest t.rs - foople (line 2) - compile ... ok\ntest t.rs - florp (line 8) - compile ... ok\n```\n\nPersisted and running -> full compile.\n```\n$ rustdoc -Zunstable-options --test --persist-doctests doctests --extern t=libt.rlib t.rs\n\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"doctests/t_rs_8_0/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"-Z\" \"unstable-options\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"doctests/t_rs_2_0/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"-Z\" \"unstable-options\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\n\n```\n\nRunning but not persisted -> full compile only\n```\n$ rustdoc --test --extern t=libt.rlib t.rs\n\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"/tmp/rustdoctestixWAUI/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"/tmp/rustdoctestKEaJQu/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\n\n```\n\nNot running and not persisting -> save time and only run metadata.\n```\nRUSTDOC_LOG=rustdoc=debug,std::test=debug rustdoc -Zunstable-options --no-run --test --extern t=libt.rlib t.rs\n\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"/tmp/rustdoctest8twt2c/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"-Z\" \"unstable-options\" \"--emit=metadata\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\nDEBUG rustdoc::doctest run_test compiler \"rustc\" \"--crate-type\" \"bin\" \"--edition\" \"2015\" \"-o\" \"/tmp/rustdoctest3miSqv/rust_out\" \"--extern\" \"t=libt.rlib\" \"-Ccodegen-units=1\" \"-Z\" \"unstable-options\" \"--emit=metadata\" \"--target\" \"x86_64-unknown-linux-gnu\" \"--color\" \"always\"\n```\n\nI can't see any infrastructure for automating this sort of test. Am I missing it?", "tree": {"sha": "396cc0b07e80bed410ce7011dbc2dbca741841f2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/396cc0b07e80bed410ce7011dbc2dbca741841f2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad3407f482d29f26c67700974d86f89b3f2ab993", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad3407f482d29f26c67700974d86f89b3f2ab993", "html_url": "https://github.com/rust-lang/rust/commit/ad3407f482d29f26c67700974d86f89b3f2ab993", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad3407f482d29f26c67700974d86f89b3f2ab993/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "00ce1665c9f859813d4e9c5fdbf44d881e1fb64c", "url": "https://api.github.com/repos/rust-lang/rust/commits/00ce1665c9f859813d4e9c5fdbf44d881e1fb64c", "html_url": "https://github.com/rust-lang/rust/commit/00ce1665c9f859813d4e9c5fdbf44d881e1fb64c"}, {"sha": "cfe2d30bb46fc60af223448713c3d57ee027f34a", "url": "https://api.github.com/repos/rust-lang/rust/commits/cfe2d30bb46fc60af223448713c3d57ee027f34a", "html_url": "https://github.com/rust-lang/rust/commit/cfe2d30bb46fc60af223448713c3d57ee027f34a"}], "stats": {"total": 34, "additions": 33, "deletions": 1}, "files": [{"sha": "e61b7a0903810ba6a77b892d4c13c678cf9e6e8d", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad3407f482d29f26c67700974d86f89b3f2ab993/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad3407f482d29f26c67700974d86f89b3f2ab993/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=ad3407f482d29f26c67700974d86f89b3f2ab993", "patch": "@@ -361,7 +361,7 @@ fn run_test(\n     for debugging_option_str in &options.debugging_opts_strs {\n         compiler.arg(\"-Z\").arg(&debugging_option_str);\n     }\n-    if no_run && !compile_fail {\n+    if no_run && !compile_fail && options.persist_doctests.is_none() {\n         compiler.arg(\"--emit=metadata\");\n     }\n     compiler.arg(\"--target\").arg(match target {"}, {"sha": "273c8980b02242d80332e582bd6943beafef31fe", "filename": "src/test/run-make-fulldeps/doctests-keep-binaries/Makefile", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ad3407f482d29f26c67700974d86f89b3f2ab993/src%2Ftest%2Frun-make-fulldeps%2Fdoctests-keep-binaries%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/ad3407f482d29f26c67700974d86f89b3f2ab993/src%2Ftest%2Frun-make-fulldeps%2Fdoctests-keep-binaries%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fdoctests-keep-binaries%2FMakefile?ref=ad3407f482d29f26c67700974d86f89b3f2ab993", "patch": "@@ -0,0 +1,21 @@\n+include ../../run-make-fulldeps/tools.mk\n+\n+# Check that valid binaries are persisted by running them, regardless of whether the --run or --no-run option is used.\n+\n+all: run no_run\n+\n+run:\n+\tmkdir -p $(TMPDIR)/doctests\n+\t$(RUSTC) --crate-type rlib t.rs\n+\t$(RUSTDOC) -Zunstable-options --test --persist-doctests $(TMPDIR)/doctests --extern t=$(TMPDIR)/libt.rlib t.rs\n+\t$(TMPDIR)/doctests/t_rs_2_0/rust_out\n+\t$(TMPDIR)/doctests/t_rs_8_0/rust_out\n+\trm -rf $(TMPDIR)/doctests\n+\n+no_run:\n+\tmkdir -p $(TMPDIR)/doctests\n+\t$(RUSTC) --crate-type rlib t.rs\n+\t$(RUSTDOC) -Zunstable-options --test --persist-doctests $(TMPDIR)/doctests --extern t=$(TMPDIR)/libt.rlib t.rs --no-run\n+\t$(TMPDIR)/doctests/t_rs_2_0/rust_out\n+\t$(TMPDIR)/doctests/t_rs_8_0/rust_out\n+\trm -rf $(TMPDIR)/doctests"}, {"sha": "c38cf0a0b25d4020b3a61cb10e759846c2dc2d24", "filename": "src/test/run-make-fulldeps/doctests-keep-binaries/t.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ad3407f482d29f26c67700974d86f89b3f2ab993/src%2Ftest%2Frun-make-fulldeps%2Fdoctests-keep-binaries%2Ft.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad3407f482d29f26c67700974d86f89b3f2ab993/src%2Ftest%2Frun-make-fulldeps%2Fdoctests-keep-binaries%2Ft.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fdoctests-keep-binaries%2Ft.rs?ref=ad3407f482d29f26c67700974d86f89b3f2ab993", "patch": "@@ -0,0 +1,11 @@\n+/// Fungle the foople.\n+/// ```\n+/// t::foople();\n+/// ```\n+pub fn foople() {}\n+\n+/// Flomble the florp\n+/// ```\n+/// t::florp();\n+/// ```\n+pub fn florp() {}"}]}