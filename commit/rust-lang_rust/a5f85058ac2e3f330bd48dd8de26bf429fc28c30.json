{"sha": "a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "node_id": "C_kwDOAAsO6NoAKGE1Zjg1MDU4YWMyZTNmMzMwYmQ0OGRkOGRlMjZiZjQyOWZjMjhjMzA", "commit": {"author": {"name": "Caleb Cartwright", "email": "caleb.cartwright@outlook.com", "date": "2021-11-04T23:00:22Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2021-11-04T23:35:38Z"}, "message": "fix: handle external mods imported via external->inline load hierarchy", "tree": {"sha": "0c90167d99e72aeb2c8dc0dccdc450d1ac0abd68", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0c90167d99e72aeb2c8dc0dccdc450d1ac0abd68"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "html_url": "https://github.com/rust-lang/rust/commit/a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/comments", "author": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e75c4d7ee9a48b8599a3a61d3b79ccbe0a18d77e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e75c4d7ee9a48b8599a3a61d3b79ccbe0a18d77e", "html_url": "https://github.com/rust-lang/rust/commit/e75c4d7ee9a48b8599a3a61d3b79ccbe0a18d77e"}], "stats": {"total": 54, "additions": 41, "deletions": 13}, "files": [{"sha": "b1f229d9daaf5f411082f260aa68e358de077dc9", "filename": "src/modules.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/src%2Fmodules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/src%2Fmodules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmodules.rs?ref=a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "patch": "@@ -321,7 +321,9 @@ impl<'ast, 'sess, 'c> ModResolver<'ast, 'sess> {\n             (Some(Cow::Borrowed(ast::ModKind::Loaded(items, _, _))), _) => {\n                 self.visit_mod_from_ast(items)\n             }\n-            (Some(Cow::Owned(..)), Cow::Owned(items)) => self.visit_mod_outside_ast(items),\n+            (Some(Cow::Owned(ast::ModKind::Loaded(items, _, _))), _) | (_, Cow::Owned(items)) => {\n+                self.visit_mod_outside_ast(items)\n+            }\n             (_, _) => Ok(()),\n         }\n     }"}, {"sha": "ae4a0d0fccb191003dd5bdc04d2378c1b6707228", "filename": "src/test/mod_resolver.rs", "status": "modified", "additions": 30, "deletions": 12, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/src%2Ftest%2Fmod_resolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/src%2Ftest%2Fmod_resolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmod_resolver.rs?ref=a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "patch": "@@ -5,21 +5,39 @@ use super::read_config;\n \n use crate::{FileName, Input, Session};\n \n-#[test]\n-fn nested_out_of_line_mods_loaded() {\n-    // See also https://github.com/rust-lang/rustfmt/issues/4874\n-    let filename = \"tests/mod-resolver/issue-4874/main.rs\";\n-    let input_file = PathBuf::from(filename);\n+fn verify_mod_resolution(input_file_name: &str, exp_misformatted_files: &[&str]) {\n+    let input_file = PathBuf::from(input_file_name);\n     let config = read_config(&input_file);\n     let mut session = Session::<io::Stdout>::new(config, None);\n     let report = session\n-        .format(Input::File(filename.into()))\n+        .format(Input::File(input_file_name.into()))\n         .expect(\"Should not have had any execution errors\");\n     let errors_by_file = &report.internal.borrow().0;\n-    assert!(errors_by_file.contains_key(&FileName::Real(PathBuf::from(\n-        \"tests/mod-resolver/issue-4874/bar/baz.rs\",\n-    ))));\n-    assert!(errors_by_file.contains_key(&FileName::Real(PathBuf::from(\n-        \"tests/mod-resolver/issue-4874/foo/qux.rs\",\n-    ))));\n+    for exp_file in exp_misformatted_files {\n+        assert!(errors_by_file.contains_key(&FileName::Real(PathBuf::from(exp_file))));\n+    }\n+}\n+\n+#[test]\n+fn nested_out_of_line_mods_loaded() {\n+    // See also https://github.com/rust-lang/rustfmt/issues/4874\n+    verify_mod_resolution(\n+        \"tests/mod-resolver/issue-4874/main.rs\",\n+        &[\n+            \"tests/mod-resolver/issue-4874/bar/baz.rs\",\n+            \"tests/mod-resolver/issue-4874/foo/qux.rs\",\n+        ],\n+    );\n+}\n+\n+#[test]\n+fn out_of_line_nested_inline_within_out_of_line() {\n+    // See also https://github.com/rust-lang/rustfmt/issues/5063\n+    verify_mod_resolution(\n+        \"tests/mod-resolver/issue-5063/main.rs\",\n+        &[\n+            \"tests/mod-resolver/issue-5063/foo/bar/baz.rs\",\n+            \"tests/mod-resolver/issue-5063/foo.rs\",\n+        ],\n+    );\n }"}, {"sha": "d56974773fb9f6c2d0aecb95b24345d9b7544380", "filename": "tests/mod-resolver/issue-5063/foo.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/tests%2Fmod-resolver%2Fissue-5063%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/tests%2Fmod-resolver%2Fissue-5063%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Fissue-5063%2Ffoo.rs?ref=a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "patch": "@@ -0,0 +1,2 @@\n+mod bar {\n+        mod baz;}\n\\ No newline at end of file"}, {"sha": "3519b0ee59c88f71c373633ef2abd085d3e1ea16", "filename": "tests/mod-resolver/issue-5063/foo/bar/baz.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/tests%2Fmod-resolver%2Fissue-5063%2Ffoo%2Fbar%2Fbaz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/tests%2Fmod-resolver%2Fissue-5063%2Ffoo%2Fbar%2Fbaz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Fissue-5063%2Ffoo%2Fbar%2Fbaz.rs?ref=a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "patch": "@@ -0,0 +1 @@\n+fn    baz()    {       }\n\\ No newline at end of file"}, {"sha": "41c81c7bb433c69962cd1be3655de15d3e3325d5", "filename": "tests/mod-resolver/issue-5063/main.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/tests%2Fmod-resolver%2Fissue-5063%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f85058ac2e3f330bd48dd8de26bf429fc28c30/tests%2Fmod-resolver%2Fissue-5063%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmod-resolver%2Fissue-5063%2Fmain.rs?ref=a5f85058ac2e3f330bd48dd8de26bf429fc28c30", "patch": "@@ -0,0 +1,5 @@\n+fn main() {\n+    println!(\"Hello, world!\");\n+}\n+\n+mod foo;\n\\ No newline at end of file"}]}