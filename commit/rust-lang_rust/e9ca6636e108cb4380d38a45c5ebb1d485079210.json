{"sha": "e9ca6636e108cb4380d38a45c5ebb1d485079210", "node_id": "C_kwDOAAsO6NoAKGU5Y2E2NjM2ZTEwOGNiNDM4MGQzOGE0NWM1ZWJiMWQ0ODUwNzkyMTA", "commit": {"author": {"name": "DebugSteven", "email": "debugsteven@gmail.com", "date": "2023-01-02T23:36:29Z"}, "committer": {"name": "DebugSteven", "email": "debugsteven@gmail.com", "date": "2023-01-02T23:36:29Z"}, "message": "get latest x version from parsing cargo command", "tree": {"sha": "f250784ff5cc4acb55f469d9868e4191cb9a7de6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f250784ff5cc4acb55f469d9868e4191cb9a7de6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e9ca6636e108cb4380d38a45c5ebb1d485079210", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e9ca6636e108cb4380d38a45c5ebb1d485079210", "html_url": "https://github.com/rust-lang/rust/commit/e9ca6636e108cb4380d38a45c5ebb1d485079210", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e9ca6636e108cb4380d38a45c5ebb1d485079210/comments", "author": {"login": "DebugSteven", "id": 10746702, "node_id": "MDQ6VXNlcjEwNzQ2NzAy", "avatar_url": "https://avatars.githubusercontent.com/u/10746702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DebugSteven", "html_url": "https://github.com/DebugSteven", "followers_url": "https://api.github.com/users/DebugSteven/followers", "following_url": "https://api.github.com/users/DebugSteven/following{/other_user}", "gists_url": "https://api.github.com/users/DebugSteven/gists{/gist_id}", "starred_url": "https://api.github.com/users/DebugSteven/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DebugSteven/subscriptions", "organizations_url": "https://api.github.com/users/DebugSteven/orgs", "repos_url": "https://api.github.com/users/DebugSteven/repos", "events_url": "https://api.github.com/users/DebugSteven/events{/privacy}", "received_events_url": "https://api.github.com/users/DebugSteven/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DebugSteven", "id": 10746702, "node_id": "MDQ6VXNlcjEwNzQ2NzAy", "avatar_url": "https://avatars.githubusercontent.com/u/10746702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DebugSteven", "html_url": "https://github.com/DebugSteven", "followers_url": "https://api.github.com/users/DebugSteven/followers", "following_url": "https://api.github.com/users/DebugSteven/following{/other_user}", "gists_url": "https://api.github.com/users/DebugSteven/gists{/gist_id}", "starred_url": "https://api.github.com/users/DebugSteven/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DebugSteven/subscriptions", "organizations_url": "https://api.github.com/users/DebugSteven/orgs", "repos_url": "https://api.github.com/users/DebugSteven/repos", "events_url": "https://api.github.com/users/DebugSteven/events{/privacy}", "received_events_url": "https://api.github.com/users/DebugSteven/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9aebb1e09950591413103545d5bc1a40ec46bd9e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9aebb1e09950591413103545d5bc1a40ec46bd9e", "html_url": "https://github.com/rust-lang/rust/commit/9aebb1e09950591413103545d5bc1a40ec46bd9e"}], "stats": {"total": 66, "additions": 48, "deletions": 18}, "files": [{"sha": "784aca237f042f50a0f1063ea1d2e003ee4a40e5", "filename": "Cargo.lock", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e9ca6636e108cb4380d38a45c5ebb1d485079210/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/e9ca6636e108cb4380d38a45c5ebb1d485079210/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=e9ca6636e108cb4380d38a45c5ebb1d485079210", "patch": "@@ -4814,9 +4814,9 @@ dependencies = [\n \n [[package]]\n name = \"serde\"\n-version = \"1.0.147\"\n+version = \"1.0.152\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"d193d69bae983fc11a79df82342761dfbf28a99fc8d203dca4c3c1b590948965\"\n+checksum = \"bb7d1f0d3021d347a83e556fc4683dea2ea09d87bccdf88ff5c12545d89d5efb\"\n dependencies = [\n  \"serde_derive\",\n ]\n@@ -4833,9 +4833,9 @@ dependencies = [\n \n [[package]]\n name = \"serde_derive\"\n-version = \"1.0.147\"\n+version = \"1.0.152\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"4f1d362ca8fc9c3e3a7484440752472d68a6caa98f1ab81d99b5dfe517cec852\"\n+checksum = \"af487d118eecd09402d70a5d72551860e788df87b464af30e5ea6a38c75c541e\"\n dependencies = [\n  \"proc-macro2\",\n  \"quote\",\n@@ -4853,9 +4853,9 @@ dependencies = [\n \n [[package]]\n name = \"serde_json\"\n-version = \"1.0.85\"\n+version = \"1.0.91\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e55a28e3aaef9d5ce0506d0a14dbba8054ddc7e499ef522dd8b26859ec9d4a44\"\n+checksum = \"877c235533714907a8c2464236f5c4b2a17262ef1bd71f38f35ea592c8da6883\"\n dependencies = [\n  \"indexmap\",\n  \"itoa\",\n@@ -5133,9 +5133,9 @@ dependencies = [\n \n [[package]]\n name = \"syn\"\n-version = \"1.0.102\"\n+version = \"1.0.107\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"3fcd952facd492f9be3ef0d0b7032a6e442ee9b361d4acc2b1d0c4aaa5f613a1\"\n+checksum = \"1f4064b5b16e03ae50984a5a8ed5d4f8803e6bc1fd170a3cda91a1be4b18e3f5\"\n dependencies = [\n  \"proc-macro2\",\n  \"quote\",\n@@ -5310,6 +5310,7 @@ dependencies = [\n  \"miropt-test-tools\",\n  \"regex\",\n  \"semver\",\n+ \"serde_json\",\n  \"termcolor\",\n  \"walkdir\",\n ]"}, {"sha": "a13ecbe955ac14400880ef9c4e2aa96245879624", "filename": "src/tools/tidy/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e9ca6636e108cb4380d38a45c5ebb1d485079210/src%2Ftools%2Ftidy%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/e9ca6636e108cb4380d38a45c5ebb1d485079210/src%2Ftools%2Ftidy%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2FCargo.toml?ref=e9ca6636e108cb4380d38a45c5ebb1d485079210", "patch": "@@ -12,6 +12,7 @@ lazy_static = \"1\"\n walkdir = \"2\"\n ignore = \"0.4.18\"\n semver = \"1.0.14\"\n+serde_json = \"1.0.91\"\n termcolor = \"1.1.3\"\n \n [[bin]]"}, {"sha": "6cadc18fd3e9c9a093311c122fdcdcaad8e0e243", "filename": "src/tools/tidy/src/x_version.rs", "status": "modified", "additions": 38, "deletions": 10, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/e9ca6636e108cb4380d38a45c5ebb1d485079210/src%2Ftools%2Ftidy%2Fsrc%2Fx_version.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e9ca6636e108cb4380d38a45c5ebb1d485079210/src%2Ftools%2Ftidy%2Fsrc%2Fx_version.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fx_version.rs?ref=e9ca6636e108cb4380d38a45c5ebb1d485079210", "patch": "@@ -1,4 +1,5 @@\n-use semver::{BuildMetadata, Prerelease, Version};\n+use semver::Version;\n+use serde_json::Value;\n use std::io::ErrorKind;\n use std::process::{Command, Stdio};\n \n@@ -33,20 +34,47 @@ pub fn check(bad: &mut bool) {\n     if output.status.success() {\n         let version = String::from_utf8_lossy(&output.stdout);\n         let version = Version::parse(version.trim_end()).unwrap();\n-        let expected = Version {\n-            major: 0,\n-            minor: 1,\n-            patch: 0,\n-            pre: Prerelease::new(\"\").unwrap(),\n-            build: BuildMetadata::EMPTY,\n-        };\n-        if version < expected {\n+\n+        if let Some(expected) = get_x_wrapper_version() {\n+            if version < expected {\n+                return tidy_error!(\n+                    bad,\n+                    \"Current version of x is {version}, but the latest version is {expected}\\nConsider updating to the newer version of x by running `cargo install --path src/tools/x`\"\n+                );\n+            }\n+        } else {\n             return tidy_error!(\n                 bad,\n-                \"Current version of x is {version}, but the latest version is {expected}\\nConsider updating to the newer version of x by running `cargo install --path src/tools/x`\"\n+                \"Unable to parse the latest version of `x` at `src/tools/x/Cargo.toml`\"\n             );\n         }\n     } else {\n         return tidy_error!(bad, \"failed to check version of `x`: {}\", output.status);\n     }\n }\n+\n+// Parse latest version out of `x` Cargo.toml\n+fn get_x_wrapper_version() -> Option<Version> {\n+    let cmd = Command::new(\"cargo\")\n+        .arg(\"metadata\")\n+        .args([\"--no-deps\", \"--format-version\", \"1\", \"--manifest-path\", \"src/tools/x/Cargo.toml\"])\n+        .stdout(Stdio::piped())\n+        .spawn();\n+\n+    let child = match cmd {\n+        Ok(child) => child,\n+        Err(e) => {\n+            println!(\"failed to get version of `x`: {}\", e);\n+            return None;\n+        }\n+    };\n+\n+    let cargo_output = child.wait_with_output().unwrap();\n+    let cargo_output_str =\n+        String::from_utf8(cargo_output.stdout).expect(\"Unable to parse `src/tools/x/Cargo.toml`\");\n+\n+    let v: Value = serde_json::from_str(&cargo_output_str).unwrap();\n+    let vesrion_str = &v[\"packages\"][0][\"version\"].as_str()?;\n+\n+    Some(Version::parse(vesrion_str).unwrap())\n+}"}]}