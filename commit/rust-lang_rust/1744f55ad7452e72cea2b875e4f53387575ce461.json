{"sha": "1744f55ad7452e72cea2b875e4f53387575ce461", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3NDRmNTVhZDc0NTJlNzJjZWEyYjg3NWU0ZjUzMzg3NTc1Y2U0NjE=", "commit": {"author": {"name": "Jeffrey Seyfried", "email": "jeffrey.seyfried@gmail.com", "date": "2016-03-02T10:22:24Z"}, "committer": {"name": "Jeffrey Seyfried", "email": "jeffrey.seyfried@gmail.com", "date": "2016-03-26T18:22:40Z"}, "message": "Refactor away GraphBuilder", "tree": {"sha": "1edf6cb812b1e46f6009d8466004362e1e847781", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1edf6cb812b1e46f6009d8466004362e1e847781"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1744f55ad7452e72cea2b875e4f53387575ce461", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1744f55ad7452e72cea2b875e4f53387575ce461", "html_url": "https://github.com/rust-lang/rust/commit/1744f55ad7452e72cea2b875e4f53387575ce461", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1744f55ad7452e72cea2b875e4f53387575ce461/comments", "author": {"login": "jseyfried", "id": 8652869, "node_id": "MDQ6VXNlcjg2NTI4Njk=", "avatar_url": "https://avatars.githubusercontent.com/u/8652869?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jseyfried", "html_url": "https://github.com/jseyfried", "followers_url": "https://api.github.com/users/jseyfried/followers", "following_url": "https://api.github.com/users/jseyfried/following{/other_user}", "gists_url": "https://api.github.com/users/jseyfried/gists{/gist_id}", "starred_url": "https://api.github.com/users/jseyfried/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jseyfried/subscriptions", "organizations_url": "https://api.github.com/users/jseyfried/orgs", "repos_url": "https://api.github.com/users/jseyfried/repos", "events_url": "https://api.github.com/users/jseyfried/events{/privacy}", "received_events_url": "https://api.github.com/users/jseyfried/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jseyfried", "id": 8652869, "node_id": "MDQ6VXNlcjg2NTI4Njk=", "avatar_url": "https://avatars.githubusercontent.com/u/8652869?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jseyfried", "html_url": "https://github.com/jseyfried", "followers_url": "https://api.github.com/users/jseyfried/followers", "following_url": "https://api.github.com/users/jseyfried/following{/other_user}", "gists_url": "https://api.github.com/users/jseyfried/gists{/gist_id}", "starred_url": "https://api.github.com/users/jseyfried/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jseyfried/subscriptions", "organizations_url": "https://api.github.com/users/jseyfried/orgs", "repos_url": "https://api.github.com/users/jseyfried/repos", "events_url": "https://api.github.com/users/jseyfried/events{/privacy}", "received_events_url": "https://api.github.com/users/jseyfried/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0bed9aea2db3ab8338d8fe1ff7583395ceeb1c87", "url": "https://api.github.com/repos/rust-lang/rust/commits/0bed9aea2db3ab8338d8fe1ff7583395ceeb1c87", "html_url": "https://github.com/rust-lang/rust/commit/0bed9aea2db3ab8338d8fe1ff7583395ceeb1c87"}], "stats": {"total": 49, "additions": 11, "deletions": 38}, "files": [{"sha": "fac79eb8a28763003e83cbae99067491970b2322", "filename": "src/librustc_resolve/build_reduced_graph.rs", "status": "modified", "additions": 10, "deletions": 37, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/1744f55ad7452e72cea2b875e4f53387575ce461/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1744f55ad7452e72cea2b875e4f53387575ce461/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs?ref=1744f55ad7452e72cea2b875e4f53387575ce461", "patch": "@@ -43,26 +43,6 @@ use rustc_front::hir::{PathListIdent, PathListMod, StmtDecl};\n use rustc_front::hir::{Variant, ViewPathGlob, ViewPathList, ViewPathSimple};\n use rustc_front::intravisit::{self, Visitor};\n \n-use std::ops::{Deref, DerefMut};\n-\n-struct GraphBuilder<'a, 'b: 'a, 'tcx: 'b> {\n-    resolver: &'a mut Resolver<'b, 'tcx>,\n-}\n-\n-impl<'a, 'b:'a, 'tcx:'b> Deref for GraphBuilder<'a, 'b, 'tcx> {\n-    type Target = Resolver<'b, 'tcx>;\n-\n-    fn deref(&self) -> &Resolver<'b, 'tcx> {\n-        &*self.resolver\n-    }\n-}\n-\n-impl<'a, 'b:'a, 'tcx:'b> DerefMut for GraphBuilder<'a, 'b, 'tcx> {\n-    fn deref_mut(&mut self) -> &mut Resolver<'b, 'tcx> {\n-        &mut *self.resolver\n-    }\n-}\n-\n trait ToNameBinding<'a> {\n     fn to_name_binding(self) -> NameBinding<'a>;\n }\n@@ -80,12 +60,12 @@ impl<'a> ToNameBinding<'a> for (Def, Span, DefModifiers) {\n     }\n }\n \n-impl<'a, 'b:'a, 'tcx:'b> GraphBuilder<'a, 'b, 'tcx> {\n+impl<'b, 'tcx:'b> Resolver<'b, 'tcx> {\n     /// Constructs the reduced graph for the entire crate.\n-    fn build_reduced_graph(self, krate: &hir::Crate) {\n+    pub fn build_reduced_graph(&mut self, krate: &hir::Crate) {\n         let mut visitor = BuildReducedGraphVisitor {\n             parent: self.graph_root,\n-            builder: self,\n+            resolver: self,\n         };\n         intravisit::walk_crate(&mut visitor, krate);\n     }\n@@ -573,50 +553,43 @@ impl<'a, 'b:'a, 'tcx:'b> GraphBuilder<'a, 'b, 'tcx> {\n         module_.add_import_directive(directive);\n         self.unresolved_imports += 1;\n     }\n-}\n \n-impl<'a, 'tcx> Resolver<'a, 'tcx> {\n     /// Ensures that the reduced graph rooted at the given external module\n     /// is built, building it if it is not.\n-    pub fn populate_module_if_necessary(&mut self, module: Module<'a>) {\n+    pub fn populate_module_if_necessary(&mut self, module: Module<'b>) {\n         if module.populated.get() { return }\n-        let mut builder = GraphBuilder { resolver: self };\n         for child in self.session.cstore.item_children(module.def_id().unwrap()) {\n-            builder.build_reduced_graph_for_external_crate_def(module, child);\n+            self.build_reduced_graph_for_external_crate_def(module, child);\n         }\n         module.populated.set(true)\n     }\n }\n \n struct BuildReducedGraphVisitor<'a, 'b: 'a, 'tcx: 'b> {\n-    builder: GraphBuilder<'a, 'b, 'tcx>,\n+    resolver: &'a mut Resolver<'b, 'tcx>,\n     parent: Module<'b>,\n }\n \n impl<'a, 'b, 'v, 'tcx> Visitor<'v> for BuildReducedGraphVisitor<'a, 'b, 'tcx> {\n     fn visit_nested_item(&mut self, item: hir::ItemId) {\n-        self.visit_item(self.builder.resolver.ast_map.expect_item(item.id))\n+        self.visit_item(self.resolver.ast_map.expect_item(item.id))\n     }\n \n     fn visit_item(&mut self, item: &Item) {\n         let old_parent = self.parent;\n-        self.builder.build_reduced_graph_for_item(item, &mut self.parent);\n+        self.resolver.build_reduced_graph_for_item(item, &mut self.parent);\n         intravisit::walk_item(self, item);\n         self.parent = old_parent;\n     }\n \n     fn visit_foreign_item(&mut self, foreign_item: &ForeignItem) {\n-        self.builder.build_reduced_graph_for_foreign_item(foreign_item, &self.parent);\n+        self.resolver.build_reduced_graph_for_foreign_item(foreign_item, &self.parent);\n     }\n \n     fn visit_block(&mut self, block: &Block) {\n         let old_parent = self.parent;\n-        self.builder.build_reduced_graph_for_block(block, &mut self.parent);\n+        self.resolver.build_reduced_graph_for_block(block, &mut self.parent);\n         intravisit::walk_block(self, block);\n         self.parent = old_parent;\n     }\n }\n-\n-pub fn build_reduced_graph(resolver: &mut Resolver, krate: &hir::Crate) {\n-    GraphBuilder { resolver: resolver }.build_reduced_graph(krate);\n-}"}, {"sha": "e4a2c15d788e9c1589002d7561e64110a1322d56", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1744f55ad7452e72cea2b875e4f53387575ce461/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1744f55ad7452e72cea2b875e4f53387575ce461/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=1744f55ad7452e72cea2b875e4f53387575ce461", "patch": "@@ -3734,7 +3734,7 @@ pub fn create_resolver<'a, 'tcx>(session: &'a Session,\n \n     resolver.callback = callback;\n \n-    build_reduced_graph::build_reduced_graph(&mut resolver, krate);\n+    resolver.build_reduced_graph(krate);\n \n     resolve_imports::resolve_imports(&mut resolver);\n "}]}