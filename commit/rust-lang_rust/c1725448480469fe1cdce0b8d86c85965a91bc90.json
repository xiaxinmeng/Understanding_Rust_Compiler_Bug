{"sha": "c1725448480469fe1cdce0b8d86c85965a91bc90", "node_id": "C_kwDOAAsO6NoAKGMxNzI1NDQ4NDgwNDY5ZmUxY2RjZTBiOGQ4NmM4NTk2NWE5MWJjOTA", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-04-10T19:03:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-10T19:03:35Z"}, "message": "Rollup merge of #95807 - TaKO8Ki:suggest-local-var-for-vector, r=fee1-dead\n\nSuggest adding a local for vector to fix borrowck errors\n\ncloses #95574", "tree": {"sha": "bfe6421c21ea0d8fbab88c239275a7e64e30979e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfe6421c21ea0d8fbab88c239275a7e64e30979e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1725448480469fe1cdce0b8d86c85965a91bc90", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiUyoICRBK7hj4Ov3rIwAAIg0IADpFNCsYRiCMPq0FkqlFS6la\nzdOI6PLidcD+FUPsDbZUAy3kQFxMQmmAXkdQl8uYVGxaTitxXXDkMpneP9w8ovno\npts3PEYX+WOs2kIqVWWXewnNgPjTnejKgDf87nrECCm4w96v+y1ME9vpKCS7J/DJ\nunAhW8y8E51r3+rfrMyt+HgySFVjwZkpseUlb9Q2lxfT/28gEXVcnXPs9NJUMJ0x\niMh1C1WH07x5nxLz8RkN7C/RkXWN2keiAwfE8gvAITXeQ0H+BkSHIjj2wZjpYh35\nuk6f0C3wQiXKF7LjzTunNjmQvTisnRplqBWtY/pRXZGtl2G8LSbyXShFjKCiOdM=\n=5vn4\n-----END PGP SIGNATURE-----\n", "payload": "tree bfe6421c21ea0d8fbab88c239275a7e64e30979e\nparent 54597ba11f73e642797a51f7cdd264613759e693\nparent 71fea61bc9f387d99dd99b1f99d35e1a92f578a7\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1649617415 +0200\ncommitter GitHub <noreply@github.com> 1649617415 +0200\n\nRollup merge of #95807 - TaKO8Ki:suggest-local-var-for-vector, r=fee1-dead\n\nSuggest adding a local for vector to fix borrowck errors\n\ncloses #95574\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1725448480469fe1cdce0b8d86c85965a91bc90", "html_url": "https://github.com/rust-lang/rust/commit/c1725448480469fe1cdce0b8d86c85965a91bc90", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1725448480469fe1cdce0b8d86c85965a91bc90/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "54597ba11f73e642797a51f7cdd264613759e693", "url": "https://api.github.com/repos/rust-lang/rust/commits/54597ba11f73e642797a51f7cdd264613759e693", "html_url": "https://github.com/rust-lang/rust/commit/54597ba11f73e642797a51f7cdd264613759e693"}, {"sha": "71fea61bc9f387d99dd99b1f99d35e1a92f578a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/71fea61bc9f387d99dd99b1f99d35e1a92f578a7", "html_url": "https://github.com/rust-lang/rust/commit/71fea61bc9f387d99dd99b1f99d35e1a92f578a7"}], "stats": {"total": 118, "additions": 109, "deletions": 9}, "files": [{"sha": "9e5fb674772d5f0d7c9c525c40dbe886c13e784e", "filename": "compiler/rustc_borrowck/src/diagnostics/conflict_errors.rs", "status": "modified", "additions": 31, "deletions": 9, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c1725448480469fe1cdce0b8d86c85965a91bc90/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1725448480469fe1cdce0b8d86c85965a91bc90/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs?ref=c1725448480469fe1cdce0b8d86c85965a91bc90", "patch": "@@ -785,13 +785,22 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n         issued_borrow: &BorrowData<'tcx>,\n         explanation: BorrowExplanation,\n     ) {\n-        let used_in_call =\n-            matches!(explanation, BorrowExplanation::UsedLater(LaterUseKind::Call, _call_span, _));\n+        let used_in_call = matches!(\n+            explanation,\n+            BorrowExplanation::UsedLater(LaterUseKind::Call | LaterUseKind::Other, _call_span, _)\n+        );\n         if !used_in_call {\n             debug!(\"not later used in call\");\n             return;\n         }\n \n+        let use_span =\n+            if let BorrowExplanation::UsedLater(LaterUseKind::Other, use_span, _) = explanation {\n+                Some(use_span)\n+            } else {\n+                None\n+            };\n+\n         let outer_call_loc =\n             if let TwoPhaseActivation::ActivatedAt(loc) = issued_borrow.activation_location {\n                 loc\n@@ -835,7 +844,10 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n         debug!(\"===> outer_call_loc = {:?}, inner_call_loc = {:?}\", outer_call_loc, inner_call_loc);\n \n         let inner_call_span = inner_call_term.source_info.span;\n-        let outer_call_span = outer_call_stmt.either(|s| s.source_info, |t| t.source_info).span;\n+        let outer_call_span = match use_span {\n+            Some(span) => span,\n+            None => outer_call_stmt.either(|s| s.source_info, |t| t.source_info).span,\n+        };\n         if outer_call_span == inner_call_span || !outer_call_span.contains(inner_call_span) {\n             // FIXME: This stops the suggestion in some cases where it should be emitted.\n             //        Fix the spans for those cases so it's emitted correctly.\n@@ -845,8 +857,20 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n             );\n             return;\n         }\n-        err.span_help(inner_call_span, \"try adding a local storing this argument...\");\n-        err.span_help(outer_call_span, \"...and then using that local as the argument to this call\");\n+        err.span_help(\n+            inner_call_span,\n+            &format!(\n+                \"try adding a local storing this{}...\",\n+                if use_span.is_some() { \"\" } else { \" argument\" }\n+            ),\n+        );\n+        err.span_help(\n+            outer_call_span,\n+            &format!(\n+                \"...and then using that local {}\",\n+                if use_span.is_some() { \"here\" } else { \"as the argument to this call\" }\n+            ),\n+        );\n     }\n \n     fn suggest_split_at_mut_if_applicable(\n@@ -1912,10 +1936,8 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n         } else {\n             \"cannot assign twice to immutable variable\"\n         };\n-        if span != assigned_span {\n-            if !from_arg {\n-                err.span_label(assigned_span, format!(\"first assignment to {}\", place_description));\n-            }\n+        if span != assigned_span && !from_arg {\n+            err.span_label(assigned_span, format!(\"first assignment to {}\", place_description));\n         }\n         if let Some(decl) = local_decl\n             && let Some(name) = local_name"}, {"sha": "40f013f6a78a767c4b4e7df041a683907e484448", "filename": "src/test/ui/borrowck/suggest-local-var-for-vector.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-local-var-for-vector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-local-var-for-vector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-local-var-for-vector.rs?ref=c1725448480469fe1cdce0b8d86c85965a91bc90", "patch": "@@ -0,0 +1,4 @@\n+fn main() {\n+    let mut vec = vec![0u32; 420];\n+    vec[vec.len() - 1] = 123; //~ ERROR cannot borrow `vec` as immutable because it is also borrowed as mutable\n+}"}, {"sha": "615fffcd578adbc763965fb09b7eadeee0bbe393", "filename": "src/test/ui/borrowck/suggest-local-var-for-vector.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-local-var-for-vector.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-local-var-for-vector.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-local-var-for-vector.stderr?ref=c1725448480469fe1cdce0b8d86c85965a91bc90", "patch": "@@ -0,0 +1,24 @@\n+error[E0502]: cannot borrow `vec` as immutable because it is also borrowed as mutable\n+  --> $DIR/suggest-local-var-for-vector.rs:3:9\n+   |\n+LL |     vec[vec.len() - 1] = 123;\n+   |     ----^^^^^^^^^-----\n+   |     |   |\n+   |     |   immutable borrow occurs here\n+   |     mutable borrow occurs here\n+   |     mutable borrow later used here\n+   |\n+help: try adding a local storing this...\n+  --> $DIR/suggest-local-var-for-vector.rs:3:9\n+   |\n+LL |     vec[vec.len() - 1] = 123;\n+   |         ^^^^^^^^^\n+help: ...and then using that local here\n+  --> $DIR/suggest-local-var-for-vector.rs:3:5\n+   |\n+LL |     vec[vec.len() - 1] = 123;\n+   |     ^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0502`."}, {"sha": "40f013f6a78a767c4b4e7df041a683907e484448", "filename": "src/test/ui/borrowck/suggest-storing-local-var-for-vector.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-storing-local-var-for-vector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-storing-local-var-for-vector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-storing-local-var-for-vector.rs?ref=c1725448480469fe1cdce0b8d86c85965a91bc90", "patch": "@@ -0,0 +1,4 @@\n+fn main() {\n+    let mut vec = vec![0u32; 420];\n+    vec[vec.len() - 1] = 123; //~ ERROR cannot borrow `vec` as immutable because it is also borrowed as mutable\n+}"}, {"sha": "e3a16eddfd5eca533f9b4a1bf2cfba25660b873c", "filename": "src/test/ui/borrowck/suggest-storing-local-var-for-vector.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-storing-local-var-for-vector.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-storing-local-var-for-vector.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fsuggest-storing-local-var-for-vector.stderr?ref=c1725448480469fe1cdce0b8d86c85965a91bc90", "patch": "@@ -0,0 +1,24 @@\n+error[E0502]: cannot borrow `vec` as immutable because it is also borrowed as mutable\n+  --> $DIR/suggest-storing-local-var-for-vector.rs:3:9\n+   |\n+LL |     vec[vec.len() - 1] = 123;\n+   |     ----^^^^^^^^^-----\n+   |     |   |\n+   |     |   immutable borrow occurs here\n+   |     mutable borrow occurs here\n+   |     mutable borrow later used here\n+   |\n+help: try adding a local storing this...\n+  --> $DIR/suggest-storing-local-var-for-vector.rs:3:9\n+   |\n+LL |     vec[vec.len() - 1] = 123;\n+   |         ^^^^^^^^^\n+help: ...and then using that local here\n+  --> $DIR/suggest-storing-local-var-for-vector.rs:3:5\n+   |\n+LL |     vec[vec.len() - 1] = 123;\n+   |     ^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0502`."}, {"sha": "0f2daaf99d9145a4be74fa3297e84589fa8dcca4", "filename": "src/test/ui/borrowck/two-phase-nonrecv-autoref.nll.stderr", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Ftwo-phase-nonrecv-autoref.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1725448480469fe1cdce0b8d86c85965a91bc90/src%2Ftest%2Fui%2Fborrowck%2Ftwo-phase-nonrecv-autoref.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Ftwo-phase-nonrecv-autoref.nll.stderr?ref=c1725448480469fe1cdce0b8d86c85965a91bc90", "patch": "@@ -54,6 +54,17 @@ LL |     i[i[3]] = 4;\n    |     | immutable borrow occurs here\n    |     mutable borrow occurs here\n    |     mutable borrow later used here\n+   |\n+help: try adding a local storing this...\n+  --> $DIR/two-phase-nonrecv-autoref.rs:138:7\n+   |\n+LL |     i[i[3]] = 4;\n+   |       ^^^^\n+help: ...and then using that local here\n+  --> $DIR/two-phase-nonrecv-autoref.rs:138:5\n+   |\n+LL |     i[i[3]] = 4;\n+   |     ^^^^^^^\n \n error[E0502]: cannot borrow `i` as immutable because it is also borrowed as mutable\n   --> $DIR/two-phase-nonrecv-autoref.rs:143:7\n@@ -64,6 +75,17 @@ LL |     i[i[3]] = i[4];\n    |     | immutable borrow occurs here\n    |     mutable borrow occurs here\n    |     mutable borrow later used here\n+   |\n+help: try adding a local storing this...\n+  --> $DIR/two-phase-nonrecv-autoref.rs:143:7\n+   |\n+LL |     i[i[3]] = i[4];\n+   |       ^^^^\n+help: ...and then using that local here\n+  --> $DIR/two-phase-nonrecv-autoref.rs:143:5\n+   |\n+LL |     i[i[3]] = i[4];\n+   |     ^^^^^^^\n \n error: aborting due to 7 previous errors\n "}]}