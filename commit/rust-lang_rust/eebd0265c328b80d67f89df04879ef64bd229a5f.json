{"sha": "eebd0265c328b80d67f89df04879ef64bd229a5f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlYmQwMjY1YzMyOGI4MGQ2N2Y4OWRmMDQ4NzllZjY0YmQyMjlhNWY=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-08-30T14:24:42Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-09-07T23:31:58Z"}, "message": "Migrate top-level rendering to Buffer", "tree": {"sha": "b38cab3cc5cf96eafae339eb80ee9721b72c0e2a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b38cab3cc5cf96eafae339eb80ee9721b72c0e2a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eebd0265c328b80d67f89df04879ef64bd229a5f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eebd0265c328b80d67f89df04879ef64bd229a5f", "html_url": "https://github.com/rust-lang/rust/commit/eebd0265c328b80d67f89df04879ef64bd229a5f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eebd0265c328b80d67f89df04879ef64bd229a5f/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f35eae9934c227a094e23c378a330b03b9d2ec01", "url": "https://api.github.com/repos/rust-lang/rust/commits/f35eae9934c227a094e23c378a330b03b9d2ec01", "html_url": "https://github.com/rust-lang/rust/commit/f35eae9934c227a094e23c378a330b03b9d2ec01"}], "stats": {"total": 101, "additions": 49, "deletions": 52}, "files": [{"sha": "2856db7ef9843cad324e4627d001283ae381fcdb", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/eebd0265c328b80d67f89df04879ef64bd229a5f/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eebd0265c328b80d67f89df04879ef64bd229a5f/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=eebd0265c328b80d67f89df04879ef64bd229a5f", "patch": "@@ -1,9 +1,9 @@\n use std::fmt;\n-use std::io;\n use std::path::PathBuf;\n \n use crate::externalfiles::ExternalHtml;\n use crate::html::render::SlashChecker;\n+use crate::html::format::Buffer;\n \n #[derive(Clone)]\n pub struct Layout {\n@@ -26,15 +26,15 @@ pub struct Page<'a> {\n }\n \n pub fn render<T: fmt::Display, S: fmt::Display>(\n-    dst: &mut dyn io::Write,\n+    dst: &mut Buffer,\n     layout: &Layout,\n     page: &Page<'_>,\n     sidebar: &S,\n     t: &T,\n     css_file_extension: bool,\n     themes: &[PathBuf],\n     generate_search_filter: bool,\n-) -> io::Result<()> {\n+) {\n     let static_root_path = page.static_root_path.unwrap_or(page.root_path);\n     write!(dst,\n \"<!DOCTYPE html>\\\n@@ -238,7 +238,7 @@ pub fn render<T: fmt::Display, S: fmt::Display>(\n     )\n }\n \n-pub fn redirect(dst: &mut dyn io::Write, url: &str) -> io::Result<()> {\n+pub fn redirect(dst: &mut Buffer, url: &str) {\n     // <script> triggers a redirect before refresh, so this is fine.\n     write!(dst,\n r##\"<!DOCTYPE html>"}, {"sha": "d86071e68b29008c843eb11c7f6152c6829ad8cc", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 41, "deletions": 42, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/eebd0265c328b80d67f89df04879ef64bd229a5f/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eebd0265c328b80d67f89df04879ef64bd229a5f/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=eebd0265c328b80d67f89df04879ef64bd229a5f", "patch": "@@ -65,7 +65,7 @@ use crate::docfs::{DocFS, ErrorStorage, PathError};\n use crate::doctree;\n use crate::fold::DocFolder;\n use crate::html::escape::Escape;\n-use crate::html::format::{AsyncSpace, ConstnessSpace};\n+use crate::html::format::{Buffer, AsyncSpace, ConstnessSpace};\n use crate::html::format::{GenericBounds, WhereClause, href, AbiSpace, DefaultSpace};\n use crate::html::format::{VisSpace, Function, UnsafetySpace, MutableSpace};\n use crate::html::format::fmt_impl_for_trait_page;\n@@ -1185,13 +1185,13 @@ themePicker.onblur = handleThemeButtonsBlur;\n                                                 SlashChecker(s), s)\n                                     })\n                                     .collect::<String>());\n-            let mut v = Vec::new();\n-            try_err!(layout::render(&mut v, &cx.shared.layout,\n-                                    &page, &(\"\"), &content,\n-                                    cx.shared.css_file_extension.is_some(),\n-                                    &cx.shared.themes,\n-                                    cx.shared.generate_search_filter), &dst);\n-            cx.shared.fs.write(&dst, &v)?;\n+            let mut v = Buffer::html();\n+            layout::render(&mut v, &cx.shared.layout,\n+                           &page, &(\"\"), &content,\n+                           cx.shared.css_file_extension.is_some(),\n+                           &cx.shared.themes,\n+                           cx.shared.generate_search_filter);\n+            cx.shared.fs.write(&dst, v.into_inner().as_bytes())?;\n         }\n     }\n \n@@ -1939,14 +1939,13 @@ impl Context {\n         } else {\n             String::new()\n         };\n-        let mut v = Vec::new();\n-        try_err!(layout::render(&mut v, &self.shared.layout,\n-                                &page, &sidebar, &all,\n-                                self.shared.css_file_extension.is_some(),\n-                                &self.shared.themes,\n-                                self.shared.generate_search_filter),\n-                 &final_file);\n-        self.shared.fs.write(&final_file, &v)?;\n+        let mut v = Buffer::html();\n+        layout::render(&mut v, &self.shared.layout,\n+                       &page, &sidebar, &all,\n+                       self.shared.css_file_extension.is_some(),\n+                       &self.shared.themes,\n+                       self.shared.generate_search_filter);\n+        self.shared.fs.write(&final_file, v.into_inner().as_bytes())?;\n \n         // Generating settings page.\n         let settings = Settings::new(self.shared.static_root_path.as_deref().unwrap_or(\"./\"),\n@@ -1959,23 +1958,24 @@ impl Context {\n         let sidebar = \"<p class='location'>Settings</p><div class='sidebar-elems'></div>\";\n         themes.push(PathBuf::from(\"settings.css\"));\n         let layout = self.shared.layout.clone();\n-        let mut v = Vec::new();\n-        try_err!(layout::render(&mut v, &layout,\n-                                &page, &sidebar, &settings,\n-                                self.shared.css_file_extension.is_some(),\n-                                &themes,\n-                                self.shared.generate_search_filter),\n-                 &settings_file);\n-        self.shared.fs.write(&settings_file, &v)?;\n+        let mut v = Buffer::html();\n+        layout::render(\n+            &mut v,\n+            &layout,\n+            &page, &sidebar, &settings,\n+            self.shared.css_file_extension.is_some(),\n+            &themes,\n+            self.shared.generate_search_filter,\n+        );\n+        self.shared.fs.write(&settings_file, v.into_inner().as_bytes())?;\n \n         Ok(())\n     }\n \n     fn render_item(&self,\n-                   writer: &mut dyn io::Write,\n+                   writer: &mut Buffer,\n                    it: &clean::Item,\n-                   pushname: bool)\n-                   -> io::Result<()> {\n+                   pushname: bool) {\n         // A little unfortunate that this is done like this, but it sure\n         // does make formatting *a lot* nicer.\n         CURRENT_DEPTH.with(|slot| {\n@@ -2027,7 +2027,7 @@ impl Context {\n                            &Item{ cx: self, item: it },\n                            self.shared.css_file_extension.is_some(),\n                            &self.shared.themes,\n-                           self.shared.generate_search_filter)?;\n+                           self.shared.generate_search_filter);\n         } else {\n             let mut url = self.root_path();\n             if let Some(&(ref names, ty)) = cache().paths.get(&it.def_id) {\n@@ -2036,10 +2036,9 @@ impl Context {\n                     url.push_str(\"/\");\n                 }\n                 url.push_str(&item_path(ty, names.last().unwrap()));\n-                layout::redirect(writer, &url)?;\n+                layout::redirect(writer, &url);\n             }\n         }\n-        Ok(())\n     }\n \n     /// Non-parallelized version of rendering an item. This will take the input\n@@ -2075,13 +2074,13 @@ impl Context {\n \n             info!(\"Recursing into {}\", self.dst.display());\n \n-            let mut buf = Vec::new();\n-            self.render_item(&mut buf, &item, false).unwrap();\n+            let mut buf = Buffer::html();\n+            self.render_item(&mut buf, &item, false);\n             // buf will be empty if the module is stripped and there is no redirect for it\n             if !buf.is_empty() {\n                 self.shared.ensure_dir(&self.dst)?;\n                 let joint_dst = self.dst.join(\"index.html\");\n-                scx.fs.write(&joint_dst, buf)?;\n+                scx.fs.write(&joint_dst, buf.into_inner().as_bytes())?;\n             }\n \n             let m = match item.inner {\n@@ -2110,16 +2109,16 @@ impl Context {\n             self.dst = prev;\n             self.current.pop().unwrap();\n         } else if item.name.is_some() {\n-            let mut buf = Vec::new();\n-            self.render_item(&mut buf, &item, true).unwrap();\n+            let mut buf = Buffer::html();\n+            self.render_item(&mut buf, &item, true);\n             // buf will be empty if the item is stripped and there is no redirect for it\n             if !buf.is_empty() {\n                 let name = item.name.as_ref().unwrap();\n                 let item_type = item.type_();\n                 let file_name = &item_path(item_type, name);\n                 self.shared.ensure_dir(&self.dst)?;\n                 let joint_dst = self.dst.join(file_name);\n-                self.shared.fs.write(&joint_dst, buf)?;\n+                self.shared.fs.write(&joint_dst, buf.into_inner().as_bytes())?;\n \n                 if !self.render_redirect_pages {\n                     all.append(full_path(self, &item), &item_type);\n@@ -2129,18 +2128,18 @@ impl Context {\n                     // URL for the page.\n                     let redir_name = format!(\"{}.{}.html\", name, item_type.name_space());\n                     let redir_dst = self.dst.join(redir_name);\n-                    let mut v = Vec::new();\n-                    try_err!(layout::redirect(&mut v, file_name), &redir_dst);\n-                    self.shared.fs.write(&redir_dst, &v)?;\n+                    let mut v = Buffer::html();\n+                    layout::redirect(&mut v, file_name);\n+                    self.shared.fs.write(&redir_dst, v.into_inner().as_bytes())?;\n                 }\n                 // If the item is a macro, redirect from the old macro URL (with !)\n                 // to the new one (without).\n                 if item_type == ItemType::Macro {\n                     let redir_name = format!(\"{}.{}!.html\", item_type, name);\n                     let redir_dst = self.dst.join(redir_name);\n-                    let mut v = Vec::new();\n-                    try_err!(layout::redirect(&mut v, file_name), &redir_dst);\n-                    self.shared.fs.write(&redir_dst, &v)?;\n+                    let mut v = Buffer::html();\n+                    layout::redirect(&mut v, file_name);\n+                    self.shared.fs.write(&redir_dst, v.into_inner().as_bytes())?;\n                 }\n             }\n         }"}, {"sha": "a2a35b94c4fe7b12fc71c68b28dbb627b8cde576", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/eebd0265c328b80d67f89df04879ef64bd229a5f/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eebd0265c328b80d67f89df04879ef64bd229a5f/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=eebd0265c328b80d67f89df04879ef64bd229a5f", "patch": "@@ -4,6 +4,7 @@ use crate::fold::DocFolder;\n use crate::html::layout;\n use crate::html::render::{Error, SharedContext, BASIC_KEYWORDS};\n use crate::html::highlight;\n+use crate::html::format::Buffer;\n use std::ffi::OsStr;\n use std::fs;\n use std::path::{Component, Path, PathBuf};\n@@ -105,7 +106,7 @@ impl<'a> SourceCollector<'a> {\n         cur.push(&fname);\n         href.push_str(&fname.to_string_lossy());\n \n-        let mut v = Vec::new();\n+        let mut v = Buffer::html();\n         let title = format!(\"{} -- source\", cur.file_name().expect(\"failed to get file name\")\n                                                .to_string_lossy());\n         let desc = format!(\"Source to the Rust file `{}`.\", filename);\n@@ -120,15 +121,12 @@ impl<'a> SourceCollector<'a> {\n             extra_scripts: &[&format!(\"source-files{}\", self.scx.resource_suffix)],\n             static_extra_scripts: &[&format!(\"source-script{}\", self.scx.resource_suffix)],\n         };\n-        let result = layout::render(&mut v, &self.scx.layout,\n+        layout::render(&mut v, &self.scx.layout,\n                        &page, &(\"\"), &Source(contents),\n                        self.scx.css_file_extension.is_some(),\n                        &self.scx.themes,\n                        self.scx.generate_search_filter);\n-        if let Err(e) = result {\n-            return Err(Error::new(e, &cur));\n-        }\n-        self.scx.fs.write(&cur, &v)?;\n+        self.scx.fs.write(&cur, v.into_inner().as_bytes())?;\n         self.scx.local_sources.insert(p.clone(), href);\n         Ok(())\n     }"}]}