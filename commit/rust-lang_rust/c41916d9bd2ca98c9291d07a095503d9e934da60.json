{"sha": "c41916d9bd2ca98c9291d07a095503d9e934da60", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0MTkxNmQ5YmQyY2E5OGM5MjkxZDA3YTA5NTUwM2Q5ZTkzNGRhNjA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-25T17:19:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-25T17:19:00Z"}, "message": "Auto merge of #5616 - euclio:no-derive-suggestion, r=phansch,flip1995\n\nnew_without_default: do not suggest deriving\n\n---\n\nchangelog: do not suggest deriving `Default` in `new_without_default`\n\nThis commit changes the behavior of the `new_without_default` lint to not suggest deriving `Default`. This suggestion is misleading if the `new` implementation does something different than what a derived `Default` implementation would do, because then the two methods would not be equivalent.\n\nInstead, the `can_derive_default` check is removed, and we always suggest implementing `Default` in terms of `new()`.", "tree": {"sha": "8e277cb77410b0a1a754e2f1395ceb2e3125304d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8e277cb77410b0a1a754e2f1395ceb2e3125304d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c41916d9bd2ca98c9291d07a095503d9e934da60", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c41916d9bd2ca98c9291d07a095503d9e934da60", "html_url": "https://github.com/rust-lang/rust/commit/c41916d9bd2ca98c9291d07a095503d9e934da60", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c41916d9bd2ca98c9291d07a095503d9e934da60/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ca335a97dab0869ec6e407a15bea86a7c7c629e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ca335a97dab0869ec6e407a15bea86a7c7c629e", "html_url": "https://github.com/rust-lang/rust/commit/7ca335a97dab0869ec6e407a15bea86a7c7c629e"}, {"sha": "a578bed69ac2a9b33fcb871f9ad7dbf02355cb82", "url": "https://api.github.com/repos/rust-lang/rust/commits/a578bed69ac2a9b33fcb871f9ad7dbf02355cb82", "html_url": "https://github.com/rust-lang/rust/commit/a578bed69ac2a9b33fcb871f9ad7dbf02355cb82"}], "stats": {"total": 164, "additions": 64, "deletions": 100}, "files": [{"sha": "3b88e4c4cb194b95012aa335cfdd5c143f10287e", "filename": "clippy_lints/src/new_without_default.rs", "status": "modified", "additions": 23, "deletions": 95, "changes": 118, "blob_url": "https://github.com/rust-lang/rust/blob/c41916d9bd2ca98c9291d07a095503d9e934da60/clippy_lints%2Fsrc%2Fnew_without_default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c41916d9bd2ca98c9291d07a095503d9e934da60/clippy_lints%2Fsrc%2Fnew_without_default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fnew_without_default.rs?ref=c41916d9bd2ca98c9291d07a095503d9e934da60", "patch": "@@ -1,27 +1,20 @@\n use crate::utils::paths;\n use crate::utils::sugg::DiagnosticBuilderExt;\n-use crate::utils::{get_trait_def_id, implements_trait, return_ty, same_tys, span_lint_hir_and_then};\n+use crate::utils::{get_trait_def_id, return_ty, same_tys, span_lint_hir_and_then};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n-use rustc_hir::def_id::DefId;\n use rustc_hir::HirIdSet;\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::lint::in_external_macro;\n-use rustc_middle::ty::{self, Ty};\n+use rustc_middle::ty::Ty;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n-use rustc_span::source_map::Span;\n \n declare_clippy_lint! {\n     /// **What it does:** Checks for types with a `fn new() -> Self` method and no\n     /// implementation of\n     /// [`Default`](https://doc.rust-lang.org/std/default/trait.Default.html).\n     ///\n-    /// It detects both the case when a manual\n-    /// [`Default`](https://doc.rust-lang.org/std/default/trait.Default.html)\n-    /// implementation is required and also when it can be created with\n-    /// `#[derive(Default)]`\n-    ///\n     /// **Why is this bad?** The user might expect to be able to use\n     /// [`Default`](https://doc.rust-lang.org/std/default/trait.Default.html) as the\n     /// type can be constructed without arguments.\n@@ -40,46 +33,17 @@ declare_clippy_lint! {\n     /// }\n     /// ```\n     ///\n-    /// Instead, use:\n+    /// To fix the lint, and a `Default` implementation that delegates to `new`:\n     ///\n     /// ```ignore\n     /// struct Foo(Bar);\n     ///\n     /// impl Default for Foo {\n     ///     fn default() -> Self {\n-    ///         Foo(Bar::new())\n+    ///         Foo::new()\n     ///     }\n     /// }\n     /// ```\n-    ///\n-    /// Or, if\n-    /// [`Default`](https://doc.rust-lang.org/std/default/trait.Default.html)\n-    /// can be derived by `#[derive(Default)]`:\n-    ///\n-    /// ```rust\n-    /// struct Foo;\n-    ///\n-    /// impl Foo {\n-    ///     fn new() -> Self {\n-    ///         Foo\n-    ///     }\n-    /// }\n-    /// ```\n-    ///\n-    /// Instead, use:\n-    ///\n-    /// ```rust\n-    /// #[derive(Default)]\n-    /// struct Foo;\n-    ///\n-    /// impl Foo {\n-    ///     fn new() -> Self {\n-    ///         Foo\n-    ///     }\n-    /// }\n-    /// ```\n-    ///\n-    /// You can also have `new()` call `Default::default()`.\n     pub NEW_WITHOUT_DEFAULT,\n     style,\n     \"`fn new() -> Self` method without `Default` implementation\"\n@@ -158,46 +122,25 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for NewWithoutDefault {\n                                         }\n                                     }\n \n-                                    if let Some(sp) = can_derive_default(self_ty, cx, default_trait_id) {\n-                                        span_lint_hir_and_then(\n-                                            cx,\n-                                            NEW_WITHOUT_DEFAULT,\n-                                            id,\n-                                            impl_item.span,\n-                                            &format!(\n-                                                \"you should consider deriving a `Default` implementation for `{}`\",\n-                                                self_ty\n-                                            ),\n-                                            |diag| {\n-                                                diag.suggest_item_with_attr(\n-                                                    cx,\n-                                                    sp,\n-                                                    \"try this\",\n-                                                    \"#[derive(Default)]\",\n-                                                    Applicability::MaybeIncorrect,\n-                                                );\n-                                            });\n-                                    } else {\n-                                        span_lint_hir_and_then(\n-                                            cx,\n-                                            NEW_WITHOUT_DEFAULT,\n-                                            id,\n-                                            impl_item.span,\n-                                            &format!(\n-                                                \"you should consider adding a `Default` implementation for `{}`\",\n-                                                self_ty\n-                                            ),\n-                                            |diag| {\n-                                                diag.suggest_prepend_item(\n-                                                    cx,\n-                                                    item.span,\n-                                                    \"try this\",\n-                                                    &create_new_without_default_suggest_msg(self_ty),\n-                                                    Applicability::MaybeIncorrect,\n-                                                );\n-                                            },\n-                                        );\n-                                    }\n+                                    span_lint_hir_and_then(\n+                                        cx,\n+                                        NEW_WITHOUT_DEFAULT,\n+                                        id,\n+                                        impl_item.span,\n+                                        &format!(\n+                                            \"you should consider adding a `Default` implementation for `{}`\",\n+                                            self_ty\n+                                        ),\n+                                        |diag| {\n+                                            diag.suggest_prepend_item(\n+                                                cx,\n+                                                item.span,\n+                                                \"try this\",\n+                                                &create_new_without_default_suggest_msg(self_ty),\n+                                                Applicability::MaybeIncorrect,\n+                                            );\n+                                        },\n+                                    );\n                                 }\n                             }\n                         }\n@@ -217,18 +160,3 @@ fn create_new_without_default_suggest_msg(ty: Ty<'_>) -> String {\n     }}\n }}\", ty)\n }\n-\n-fn can_derive_default<'t, 'c>(ty: Ty<'t>, cx: &LateContext<'c, 't>, default_trait_id: DefId) -> Option<Span> {\n-    match ty.kind {\n-        ty::Adt(adt_def, substs) if adt_def.is_struct() => {\n-            for field in adt_def.all_fields() {\n-                let f_ty = field.ty(cx.tcx, substs);\n-                if !implements_trait(cx, f_ty, default_trait_id, &[]) {\n-                    return None;\n-                }\n-            }\n-            Some(cx.tcx.def_span(adt_def.did))\n-        },\n-        _ => None,\n-    }\n-}"}, {"sha": "3b6041823d8786672ec6bb3d7bdae19acaeaa428", "filename": "tests/ui/new_without_default.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c41916d9bd2ca98c9291d07a095503d9e934da60/tests%2Fui%2Fnew_without_default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c41916d9bd2ca98c9291d07a095503d9e934da60/tests%2Fui%2Fnew_without_default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnew_without_default.rs?ref=c41916d9bd2ca98c9291d07a095503d9e934da60", "patch": "@@ -148,4 +148,15 @@ impl AllowDerive {\n     }\n }\n \n+pub struct NewNotEqualToDerive {\n+    foo: i32,\n+}\n+\n+impl NewNotEqualToDerive {\n+    // This `new` implementation is not equal to a derived `Default`, so do not suggest deriving.\n+    pub fn new() -> Self {\n+        NewNotEqualToDerive { foo: 1 }\n+    }\n+}\n+\n fn main() {}"}, {"sha": "e529e441eb735c6b60cb59d5090fa5a22763bfdb", "filename": "tests/ui/new_without_default.stderr", "status": "modified", "additions": 30, "deletions": 5, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/c41916d9bd2ca98c9291d07a095503d9e934da60/tests%2Fui%2Fnew_without_default.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c41916d9bd2ca98c9291d07a095503d9e934da60/tests%2Fui%2Fnew_without_default.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnew_without_default.stderr?ref=c41916d9bd2ca98c9291d07a095503d9e934da60", "patch": "@@ -1,4 +1,4 @@\n-error: you should consider deriving a `Default` implementation for `Foo`\n+error: you should consider adding a `Default` implementation for `Foo`\n   --> $DIR/new_without_default.rs:8:5\n    |\n LL | /     pub fn new() -> Foo {\n@@ -9,10 +9,14 @@ LL | |     }\n    = note: `-D clippy::new-without-default` implied by `-D warnings`\n help: try this\n    |\n-LL | #[derive(Default)]\n+LL | impl Default for Foo {\n+LL |     fn default() -> Self {\n+LL |         Self::new()\n+LL |     }\n+LL | }\n    |\n \n-error: you should consider deriving a `Default` implementation for `Bar`\n+error: you should consider adding a `Default` implementation for `Bar`\n   --> $DIR/new_without_default.rs:16:5\n    |\n LL | /     pub fn new() -> Self {\n@@ -22,7 +26,11 @@ LL | |     }\n    |\n help: try this\n    |\n-LL | #[derive(Default)]\n+LL | impl Default for Bar {\n+LL |     fn default() -> Self {\n+LL |         Self::new()\n+LL |     }\n+LL | }\n    |\n \n error: you should consider adding a `Default` implementation for `LtKo<'c>`\n@@ -42,5 +50,22 @@ LL |     }\n LL | }\n    |\n \n-error: aborting due to 3 previous errors\n+error: you should consider adding a `Default` implementation for `NewNotEqualToDerive`\n+  --> $DIR/new_without_default.rs:157:5\n+   |\n+LL | /     pub fn new() -> Self {\n+LL | |         NewNotEqualToDerive { foo: 1 }\n+LL | |     }\n+   | |_____^\n+   |\n+help: try this\n+   |\n+LL | impl Default for NewNotEqualToDerive {\n+LL |     fn default() -> Self {\n+LL |         Self::new()\n+LL |     }\n+LL | }\n+   |\n+\n+error: aborting due to 4 previous errors\n "}]}