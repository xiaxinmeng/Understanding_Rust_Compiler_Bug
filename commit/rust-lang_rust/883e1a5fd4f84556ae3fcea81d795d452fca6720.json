{"sha": "883e1a5fd4f84556ae3fcea81d795d452fca6720", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4M2UxYTVmZDRmODQ1NTZhZTNmY2VhODFkNzk1ZDQ1MmZjYTY3MjA=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-11T16:15:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-11T16:15:57Z"}, "message": "Rollup merge of #85823 - fee1-dead:borrowck-0, r=jackh726\n\nDo not suggest ampmut if rhs is already mutable\n\nRemoves invalid suggestion in #85765, although it should highlight the user type instead of the local variable.\n\nLooking at the comments of this line:\nhttps://github.com/rust-lang/rust/blob/84b1005bfd22e2cb2a4c13b0b81958fe72628354/compiler/rustc_mir_build/src/build/matches/mod.rs#L2107\n\nIt was intentionally set to `None`, causing it to highlight the local variable instead. I am not sure if I will be able to fix it.\n\nFixes #85765", "tree": {"sha": "18530afceaa46679730088e448a2bc4dd422230f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/18530afceaa46679730088e448a2bc4dd422230f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/883e1a5fd4f84556ae3fcea81d795d452fca6720", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgw4w+CRBK7hj4Ov3rIwAAFRQIAJbtDvPVdQDS88QPTlwZ/eTF\nf/pBdsqMUy/tsm9gckCrZRHajTc26x9p6nrPnpYYhG/zo5qvaMr5cLOPZCqjWJ4N\nRO0rbvAx2wODx7evVEvJSCzvhiUeVwH9MUKaEfXn+PXBJb3oiSTvd1PFN7DelafN\nO9FnS/NVZTxP+Ma6J3j2G632wZubpiLv9J1Zul4U7S+m34++tT2EDiB4L7Df2CPp\nk8YX95J0uSIT+07iDQyVD6T9g17IZdbhwE6M0CiwzjTkQUQMjcAhR5sKgQTeUCe+\nWvhVjBz3o7XMEzG830v9vkUbMIVcdCOn2zHoWDcFRudCWrxQjBxgbDe5Fg2xjTY=\n=+otl\n-----END PGP SIGNATURE-----\n", "payload": "tree 18530afceaa46679730088e448a2bc4dd422230f\nparent 3b47d337e04a24d5e8cf2d25864d7e9fa949ca0a\nparent 0eda5098bd0931a22cb42930d0963306c92f15f2\nauthor Yuki Okushi <jtitor@2k36.org> 1623428157 +0900\ncommitter GitHub <noreply@github.com> 1623428157 +0900\n\nRollup merge of #85823 - fee1-dead:borrowck-0, r=jackh726\n\nDo not suggest ampmut if rhs is already mutable\n\nRemoves invalid suggestion in #85765, although it should highlight the user type instead of the local variable.\n\nLooking at the comments of this line:\nhttps://github.com/rust-lang/rust/blob/84b1005bfd22e2cb2a4c13b0b81958fe72628354/compiler/rustc_mir_build/src/build/matches/mod.rs#L2107\n\nIt was intentionally set to `None`, causing it to highlight the local variable instead. I am not sure if I will be able to fix it.\n\nFixes #85765\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/883e1a5fd4f84556ae3fcea81d795d452fca6720", "html_url": "https://github.com/rust-lang/rust/commit/883e1a5fd4f84556ae3fcea81d795d452fca6720", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/883e1a5fd4f84556ae3fcea81d795d452fca6720/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3b47d337e04a24d5e8cf2d25864d7e9fa949ca0a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b47d337e04a24d5e8cf2d25864d7e9fa949ca0a", "html_url": "https://github.com/rust-lang/rust/commit/3b47d337e04a24d5e8cf2d25864d7e9fa949ca0a"}, {"sha": "0eda5098bd0931a22cb42930d0963306c92f15f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/0eda5098bd0931a22cb42930d0963306c92f15f2", "html_url": "https://github.com/rust-lang/rust/commit/0eda5098bd0931a22cb42930d0963306c92f15f2"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "bf5f2c0eec23edc8382fc0819410dd4811600948", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/mutability_errors.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/883e1a5fd4f84556ae3fcea81d795d452fca6720/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/883e1a5fd4f84556ae3fcea81d795d452fca6720/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs?ref=883e1a5fd4f84556ae3fcea81d795d452fca6720", "patch": "@@ -902,9 +902,13 @@ fn suggest_ampmut<'tcx>(\n             {\n                 let lt_name = &src[1..ws_pos];\n                 let ty = &src[ws_pos..];\n-                return (assignment_rhs_span, format!(\"&{} mut {}\", lt_name, ty));\n+                if !ty.trim_start().starts_with(\"mut\") {\n+                    return (assignment_rhs_span, format!(\"&{} mut {}\", lt_name, ty));\n+                }\n             } else if let Some(stripped) = src.strip_prefix('&') {\n-                return (assignment_rhs_span, format!(\"&mut {}\", stripped));\n+                if !stripped.trim_start().starts_with(\"mut\") {\n+                    return (assignment_rhs_span, format!(\"&mut {}\", stripped));\n+                }\n             }\n         }\n     }"}, {"sha": "b82e0298158aa7c0a22af435a46a5efcd00d930c", "filename": "src/test/ui/borrowck/issue-85765.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/883e1a5fd4f84556ae3fcea81d795d452fca6720/src%2Ftest%2Fui%2Fborrowck%2Fissue-85765.rs", "raw_url": "https://github.com/rust-lang/rust/raw/883e1a5fd4f84556ae3fcea81d795d452fca6720/src%2Ftest%2Fui%2Fborrowck%2Fissue-85765.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-85765.rs?ref=883e1a5fd4f84556ae3fcea81d795d452fca6720", "patch": "@@ -0,0 +1,8 @@\n+fn main() {\n+    let mut test = Vec::new();\n+    let rofl: &Vec<Vec<i32>> = &mut test;\n+    //~^ HELP consider changing this to be a mutable reference\n+    rofl.push(Vec::new());\n+    //~^ ERROR cannot borrow `*rofl` as mutable, as it is behind a `&` reference\n+    //~| NOTE `rofl` is a `&` reference, so the data it refers to cannot be borrowed as mutable\n+}"}, {"sha": "863c2e8eccc8c65952cf31701ec247cb7c175e2f", "filename": "src/test/ui/borrowck/issue-85765.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/883e1a5fd4f84556ae3fcea81d795d452fca6720/src%2Ftest%2Fui%2Fborrowck%2Fissue-85765.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/883e1a5fd4f84556ae3fcea81d795d452fca6720/src%2Ftest%2Fui%2Fborrowck%2Fissue-85765.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-85765.stderr?ref=883e1a5fd4f84556ae3fcea81d795d452fca6720", "patch": "@@ -0,0 +1,12 @@\n+error[E0596]: cannot borrow `*rofl` as mutable, as it is behind a `&` reference\n+  --> $DIR/issue-85765.rs:5:5\n+   |\n+LL |     let rofl: &Vec<Vec<i32>> = &mut test;\n+   |         ---- help: consider changing this to be a mutable reference: `&mut Vec<Vec<i32>>`\n+LL |\n+LL |     rofl.push(Vec::new());\n+   |     ^^^^ `rofl` is a `&` reference, so the data it refers to cannot be borrowed as mutable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0596`."}]}