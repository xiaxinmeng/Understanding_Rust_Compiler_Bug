{"sha": "d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "node_id": "C_kwDOAAsO6NoAKGQ1ZjM4NjMyMDRiNjU1YWQ0NDk4ZjA4YzNhMDJkYzMyMGI3YjZlYTE", "commit": {"author": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-04-13T09:42:28Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-04-13T09:51:08Z"}, "message": "Consider lifetimes when comparing types for equality in MIR validator", "tree": {"sha": "b14e6f31c75ce2885be1b91cd437bbede9b3a012", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b14e6f31c75ce2885be1b91cd437bbede9b3a012"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "html_url": "https://github.com/rust-lang/rust/commit/d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b768f248e99688a2d7649731a99b2f2ad962abf5", "url": "https://api.github.com/repos/rust-lang/rust/commits/b768f248e99688a2d7649731a99b2f2ad962abf5", "html_url": "https://github.com/rust-lang/rust/commit/b768f248e99688a2d7649731a99b2f2ad962abf5"}], "stats": {"total": 20, "additions": 15, "deletions": 5}, "files": [{"sha": "79d427ccc4469c08ef9e82d908063f5c6efca281", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "patch": "@@ -315,9 +315,8 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                                     | ty::FnPtr(..)\n                             )\n                         }\n-                        // None of the possible types have lifetimes, so we can just compare\n-                        // directly\n-                        if a != b {\n+                        // The function pointer types can have lifetimes\n+                        if !self.mir_assign_valid_types(a, b) {\n                             self.fail(\n                                 location,\n                                 format!(\"Cannot compare unequal types {:?} and {:?}\", a, b),\n@@ -464,7 +463,7 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                 };\n                 // since CopyNonOverlapping is parametrized by 1 type,\n                 // we only need to check that they are equal and not keep an extra parameter.\n-                if op_src_ty != op_dst_ty {\n+                if !self.mir_assign_valid_types(op_src_ty, op_dst_ty) {\n                     self.fail(location, format!(\"bad arg ({:?} != {:?})\", op_src_ty, op_dst_ty));\n                 }\n "}, {"sha": "bceacc2e374f2edab635a6202cd750fc142b23d2", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "patch": "@@ -2518,7 +2518,8 @@ pub enum Rvalue<'tcx> {\n     /// * `Offset` has the same semantics as [`offset`](pointer::offset), except that the second\n     ///   parameter may be a `usize` as well.\n     /// * The comparison operations accept `bool`s, `char`s, signed or unsigned integers, floats,\n-    ///   raw pointers, or function pointers of matching types and return a `bool`.\n+    ///   raw pointers, or function pointers and return a `bool`. The types of the operands must be\n+    ///   matching, up to the usual caveat of the lifetimes in function pointers.\n     /// * Left and right shift operations accept signed or unsigned integers not necessarily of the\n     ///   same type and return a value of the same type as their LHS. Like in Rust, the RHS is\n     ///   truncated as needed."}, {"sha": "cd6c5bf271935a8b13b76fc8a992e44179f0da9e", "filename": "src/test/ui/mir/issue-95978-validator-lifetime-comparison.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/src%2Ftest%2Fui%2Fmir%2Fissue-95978-validator-lifetime-comparison.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f3863204b655ad4498f08c3a02dc320b7b6ea1/src%2Ftest%2Fui%2Fmir%2Fissue-95978-validator-lifetime-comparison.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fissue-95978-validator-lifetime-comparison.rs?ref=d5f3863204b655ad4498f08c3a02dc320b7b6ea1", "patch": "@@ -0,0 +1,10 @@\n+// check-pass\n+// compile-flags: -Zvalidate-mir\n+\n+fn foo(_a: &str) {}\n+\n+fn main() {\n+    let x = foo as fn(&'static str);\n+\n+    let _ = x == foo;\n+}"}]}