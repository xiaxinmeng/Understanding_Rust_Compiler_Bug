{"sha": "93f632ca4e7bb7fd54830e456d629a4948a92337", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkzZjYzMmNhNGU3YmI3ZmQ1NDgzMGU0NTZkNjI5YTQ5NDhhOTIzMzc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-02-28T15:07:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-02-28T15:07:33Z"}, "message": "Merge #3366\n\n3366: Simpilfy original_range logic r=matklad a=edwin0cheng\n\nThis PR fixed another [bug](https://github.com/rust-analyzer/rust-analyzer/issues/3000#issuecomment-592474844) which incorrectly map the wrong range of `punct` in macro_call and simplify the logic a little bit by introducing an `ascend_call_token` function.\r\n\r\n\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "5f363a6b5cfeb64a446902047ce1a4610e3dc6ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f363a6b5cfeb64a446902047ce1a4610e3dc6ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/93f632ca4e7bb7fd54830e456d629a4948a92337", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeWSy1CRBK7hj4Ov3rIwAAdHIIADv6ErFPkLm8fdmmxO5pSW2t\nIT2uhejC1Hj8OZTQWXz6UQfQ6D9SZXXQqd4eoDZ+DGYUGLdxHX/hFBDXcdUKsd4P\n2Jok7dDO09ohxar1VjEINi1AU9lbjcEsBw0M/vZ1l3UO0PStGUgXteWLHj70b8rn\n07314WNz+AaGldAekkj4XUULui6kSDkK7P26NA4mdjRxX6V5Ip0CJjXXv3HIqaF4\nJhcUnCjQAQKodxxB5TmQ47GSeKbZI4NTJvO+5qQXEOazbELqRdAceZNcSzGhO/FR\nFIg0PPsvX8IeKbOhwBc4tgbRBCi9ZI6y+QVt3R93J3kzQJ/dvlazOpz2QHiMZI8=\n=VpPV\n-----END PGP SIGNATURE-----\n", "payload": "tree 5f363a6b5cfeb64a446902047ce1a4610e3dc6ec\nparent 9ef6359950fa2f3ecb9a7d4120f01e4baeaad978\nparent 7a5ff0f37c5fb7d1d21ee56da0168f68e54fbca5\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1582902453 +0000\ncommitter GitHub <noreply@github.com> 1582902453 +0000\n\nMerge #3366\n\n3366: Simpilfy original_range logic r=matklad a=edwin0cheng\n\nThis PR fixed another [bug](https://github.com/rust-analyzer/rust-analyzer/issues/3000#issuecomment-592474844) which incorrectly map the wrong range of `punct` in macro_call and simplify the logic a little bit by introducing an `ascend_call_token` function.\r\n\r\n\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/93f632ca4e7bb7fd54830e456d629a4948a92337", "html_url": "https://github.com/rust-lang/rust/commit/93f632ca4e7bb7fd54830e456d629a4948a92337", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/93f632ca4e7bb7fd54830e456d629a4948a92337/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ef6359950fa2f3ecb9a7d4120f01e4baeaad978", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ef6359950fa2f3ecb9a7d4120f01e4baeaad978", "html_url": "https://github.com/rust-lang/rust/commit/9ef6359950fa2f3ecb9a7d4120f01e4baeaad978"}, {"sha": "7a5ff0f37c5fb7d1d21ee56da0168f68e54fbca5", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a5ff0f37c5fb7d1d21ee56da0168f68e54fbca5", "html_url": "https://github.com/rust-lang/rust/commit/7a5ff0f37c5fb7d1d21ee56da0168f68e54fbca5"}], "stats": {"total": 89, "additions": 51, "deletions": 38}, "files": [{"sha": "eecccdae22a3d64f7f2ceda3ee47020b8308971c", "filename": "crates/ra_hir/src/semantics.rs", "status": "modified", "additions": 27, "deletions": 38, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/93f632ca4e7bb7fd54830e456d629a4948a92337/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93f632ca4e7bb7fd54830e456d629a4948a92337/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsemantics.rs?ref=93f632ca4e7bb7fd54830e456d629a4948a92337", "patch": "@@ -8,8 +8,7 @@ use hir_def::{\n };\n use ra_db::{FileId, FileRange};\n use ra_syntax::{\n-    algo::{find_covering_element, skip_trivia_token},\n-    ast, match_ast, AstNode, Direction, NodeOrToken, SyntaxElement, SyntaxNode, SyntaxToken,\n+    algo::skip_trivia_token, ast, match_ast, AstNode, Direction, SyntaxNode, SyntaxToken,\n     TextRange, TextUnit,\n };\n use rustc_hash::{FxHashMap, FxHashSet};\n@@ -21,6 +20,7 @@ use crate::{\n     Function, HirFileId, InFile, Local, MacroDef, Module, Name, Origin, Path, PathResolution,\n     ScopeDef, StructField, Trait, Type, TypeParam, VariantDef,\n };\n+use hir_expand::ExpansionInfo;\n use ra_prof::profile;\n \n /// Primary API to get semantic information, like types, from syntax trees.\n@@ -337,22 +337,12 @@ impl<'a, DB: HirDatabase> SemanticsScope<'a, DB> {\n \n // FIXME: Change `HasSource` trait to work with `Semantics` and remove this?\n pub fn original_range(db: &impl HirDatabase, node: InFile<&SyntaxNode>) -> FileRange {\n-    let mut elem: InFile<SyntaxElement> = node.map(|n| n.clone().into());\n-\n-    while let Some((range, Origin::Call)) = original_range_and_origin(db, elem.as_ref()) {\n+    if let Some(range) = original_range_opt(db, node) {\n         let original_file = range.file_id.original_file(db);\n-\n         if range.file_id == original_file.into() {\n             return FileRange { file_id: original_file, range: range.value };\n         }\n \n-        if range.file_id != elem.file_id {\n-            if let Some(root) = db.parse_or_expand(range.file_id) {\n-                elem = range.with_value(find_covering_element(&root, range.value));\n-                continue;\n-            }\n-        }\n-\n         log::error!(\"Fail to mapping up more for {:?}\", range);\n         return FileRange { file_id: range.file_id.original_file(db), range: range.value };\n     }\n@@ -370,43 +360,42 @@ pub fn original_range(db: &impl HirDatabase, node: InFile<&SyntaxNode>) -> FileR\n     FileRange { file_id: node.file_id.original_file(db), range: node.value.text_range() }\n }\n \n-fn original_range_and_origin(\n+fn original_range_opt(\n     db: &impl HirDatabase,\n-    elem: InFile<&SyntaxElement>,\n-) -> Option<(InFile<TextRange>, Origin)> {\n-    let expansion = elem.file_id.expansion_info(db)?;\n-\n-    let node = match elem.as_ref().value {\n-        NodeOrToken::Node(it) => elem.with_value(it),\n-        NodeOrToken::Token(it) => {\n-            let (tt, origin) = expansion.map_token_up(elem.with_value(it))?;\n-            return Some((tt.map(|it| it.text_range()), origin));\n-        }\n-    };\n+    node: InFile<&SyntaxNode>,\n+) -> Option<InFile<TextRange>> {\n+    let expansion = node.file_id.expansion_info(db)?;\n \n     // the input node has only one token ?\n     let single = skip_trivia_token(node.value.first_token()?, Direction::Next)?\n         == skip_trivia_token(node.value.last_token()?, Direction::Prev)?;\n \n     Some(node.value.descendants().find_map(|it| {\n         let first = skip_trivia_token(it.first_token()?, Direction::Next)?;\n-        let last = skip_trivia_token(it.last_token()?, Direction::Prev)?;\n-\n-        if !single && first == last {\n-            return None;\n-        }\n+        let first = ascend_call_token(db, &expansion, node.with_value(first))?;\n \n-        // Try to map first and last tokens of node, and, if success, return the union range of mapped tokens\n-        let (first, first_origin) = expansion.map_token_up(node.with_value(&first))?;\n-        let (last, last_origin) = expansion.map_token_up(node.with_value(&last))?;\n+        let last = skip_trivia_token(it.last_token()?, Direction::Prev)?;\n+        let last = ascend_call_token(db, &expansion, node.with_value(last))?;\n \n-        if first.file_id != last.file_id || first_origin != last_origin {\n+        if (!single && first == last) || (first.file_id != last.file_id) {\n             return None;\n         }\n \n-        Some((\n-            first.with_value(first.value.text_range().extend_to(&last.value.text_range())),\n-            first_origin,\n-        ))\n+        Some(first.with_value(first.value.text_range().extend_to(&last.value.text_range())))\n     })?)\n }\n+\n+fn ascend_call_token(\n+    db: &impl HirDatabase,\n+    expansion: &ExpansionInfo,\n+    token: InFile<SyntaxToken>,\n+) -> Option<InFile<SyntaxToken>> {\n+    let (mapped, origin) = expansion.map_token_up(token.as_ref())?;\n+    if origin != Origin::Call {\n+        return None;\n+    }\n+    if let Some(info) = mapped.file_id.expansion_info(db) {\n+        return ascend_call_token(db, &info, mapped);\n+    }\n+    Some(mapped)\n+}"}, {"sha": "cc79f1fab1b5914177eda2bfdeeb3b9f2f0ce6fe", "filename": "crates/ra_ide/src/hover.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/93f632ca4e7bb7fd54830e456d629a4948a92337/crates%2Fra_ide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93f632ca4e7bb7fd54830e456d629a4948a92337/crates%2Fra_ide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fhover.rs?ref=93f632ca4e7bb7fd54830e456d629a4948a92337", "patch": "@@ -738,6 +738,30 @@ fn func(foo: i32) { if true { <|>foo; }; }\n         assert_eq!(hover_on, \"bar\")\n     }\n \n+    #[test]\n+    fn test_hover_through_func_in_macro_recursive() {\n+        let hover_on = check_hover_result(\n+            \"\n+            //- /lib.rs\n+            macro_rules! id_deep {\n+                ($($tt:tt)*) => { $($tt)* }\n+            }\n+            macro_rules! id {\n+                ($($tt:tt)*) => { id_deep!($($tt)*) }\n+            }\n+            fn bar() -> u32 {\n+                0\n+            }\n+            fn foo() {\n+                let a = id!([0u32, bar(<|>)] );\n+            }\n+            \",\n+            &[\"u32\"],\n+        );\n+\n+        assert_eq!(hover_on, \"bar()\")\n+    }\n+\n     #[test]\n     fn test_hover_through_literal_string_in_macro() {\n         let hover_on = check_hover_result("}]}