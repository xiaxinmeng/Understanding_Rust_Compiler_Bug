{"sha": "780349bdafb7983d59d07891abe4225e28d96541", "node_id": "C_kwDOAAsO6NoAKDc4MDM0OWJkYWZiNzk4M2Q1OWQwNzg5MWFiZTQyMjVlMjhkOTY1NDE", "commit": {"author": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2023-05-25T22:38:33Z"}, "committer": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2023-05-25T22:38:37Z"}, "message": "fix `need-mut` false positive in closure capture of match scrutinee", "tree": {"sha": "90bc52105ce4c699760560268072c1c6e3e395ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/90bc52105ce4c699760560268072c1c6e3e395ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/780349bdafb7983d59d07891abe4225e28d96541", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/780349bdafb7983d59d07891abe4225e28d96541", "html_url": "https://github.com/rust-lang/rust/commit/780349bdafb7983d59d07891abe4225e28d96541", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/780349bdafb7983d59d07891abe4225e28d96541/comments", "author": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "html_url": "https://github.com/rust-lang/rust/commit/7ef185d65ea8da681f0f89ab4785c45f25cfaf91"}], "stats": {"total": 86, "additions": 72, "deletions": 14}, "files": [{"sha": "36626ed1a9b1f6156d5f61365fcc725063931d6f", "filename": "crates/hir-def/src/body.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fhir-def%2Fsrc%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fhir-def%2Fsrc%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fbody.rs?ref=780349bdafb7983d59d07891abe4225e28d96541", "patch": "@@ -227,9 +227,8 @@ impl Body {\n         });\n     }\n \n-    pub fn walk_pats(&self, pat_id: PatId, f: &mut impl FnMut(PatId)) {\n+    pub fn walk_pats_shallow(&self, pat_id: PatId, mut f: impl FnMut(PatId)) {\n         let pat = &self[pat_id];\n-        f(pat_id);\n         match pat {\n             Pat::Range { .. }\n             | Pat::Lit(..)\n@@ -239,23 +238,28 @@ impl Body {\n             | Pat::Missing => {}\n             &Pat::Bind { subpat, .. } => {\n                 if let Some(subpat) = subpat {\n-                    self.walk_pats(subpat, f);\n+                    f(subpat);\n                 }\n             }\n             Pat::Or(args) | Pat::Tuple { args, .. } | Pat::TupleStruct { args, .. } => {\n-                args.iter().copied().for_each(|p| self.walk_pats(p, f));\n+                args.iter().copied().for_each(|p| f(p));\n             }\n-            Pat::Ref { pat, .. } => self.walk_pats(*pat, f),\n+            Pat::Ref { pat, .. } => f(*pat),\n             Pat::Slice { prefix, slice, suffix } => {\n                 let total_iter = prefix.iter().chain(slice.iter()).chain(suffix.iter());\n-                total_iter.copied().for_each(|p| self.walk_pats(p, f));\n+                total_iter.copied().for_each(|p| f(p));\n             }\n             Pat::Record { args, .. } => {\n-                args.iter().for_each(|RecordFieldPat { pat, .. }| self.walk_pats(*pat, f));\n+                args.iter().for_each(|RecordFieldPat { pat, .. }| f(*pat));\n             }\n-            Pat::Box { inner } => self.walk_pats(*inner, f),\n+            Pat::Box { inner } => f(*inner),\n         }\n     }\n+\n+    pub fn walk_pats(&self, pat_id: PatId, f: &mut impl FnMut(PatId)) {\n+        f(pat_id);\n+        self.walk_pats_shallow(pat_id, |p| self.walk_pats(p, f));\n+    }\n }\n \n impl Default for Body {"}, {"sha": "787c5c54a2916e4fffd3b9ec4b913aab6d7afe43", "filename": "crates/hir-ty/src/infer/closure.rs", "status": "modified", "additions": 21, "deletions": 5, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs?ref=780349bdafb7983d59d07891abe4225e28d96541", "patch": "@@ -643,7 +643,21 @@ impl InferenceContext<'_> {\n             }\n             None => *result = Some(ck),\n         };\n-        self.body.walk_pats(pat, &mut |p| match &self.body[p] {\n+\n+        self.walk_pat_inner(\n+            pat,\n+            &mut update_result,\n+            BorrowKind::Mut { allow_two_phase_borrow: false },\n+        );\n+    }\n+\n+    fn walk_pat_inner(\n+        &mut self,\n+        p: PatId,\n+        update_result: &mut impl FnMut(CaptureKind),\n+        mut for_mut: BorrowKind,\n+    ) {\n+        match &self.body[p] {\n             Pat::Ref { .. }\n             | Pat::Box { .. }\n             | Pat::Missing\n@@ -678,13 +692,15 @@ impl InferenceContext<'_> {\n                     }\n                 }\n                 crate::BindingMode::Ref(r) => match r {\n-                    Mutability::Mut => update_result(CaptureKind::ByRef(BorrowKind::Mut {\n-                        allow_two_phase_borrow: false,\n-                    })),\n+                    Mutability::Mut => update_result(CaptureKind::ByRef(for_mut)),\n                     Mutability::Not => update_result(CaptureKind::ByRef(BorrowKind::Shared)),\n                 },\n             },\n-        });\n+        }\n+        if self.result.pat_adjustments.get(&p).map_or(false, |x| !x.is_empty()) {\n+            for_mut = BorrowKind::Unique;\n+        }\n+        self.body.walk_pats_shallow(p, |p| self.walk_pat_inner(p, update_result, for_mut));\n     }\n \n     fn expr_ty(&self, expr: ExprId) -> Ty {"}, {"sha": "576e7f3fc619cf7b2518c08682275c5a2ab9916d", "filename": "crates/hir-ty/src/layout/tests/closure.rs", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fhir-ty%2Fsrc%2Flayout%2Ftests%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fhir-ty%2Fsrc%2Flayout%2Ftests%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Flayout%2Ftests%2Fclosure.rs?ref=780349bdafb7983d59d07891abe4225e28d96541", "patch": "@@ -201,7 +201,7 @@ fn match_pattern() {\n         ]\n         |x: i64| {\n             match y {\n-                X(_a, _b, _c) => x,\n+                X(_a, _, _c) => x,\n             }\n         }\n     }\n@@ -217,6 +217,18 @@ fn match_pattern() {\n             }\n         }\n     }\n+    size_and_align_expr! {\n+        minicore: copy;\n+        stmts: [\n+            struct X(i64, i32, (u8, i128));\n+            let y: X = X(2, 5, (7, 3));\n+        ]\n+        |x: i64| {\n+            match y {\n+                ref _y => x,\n+            }\n+        }\n+    }\n }\n \n #[test]"}, {"sha": "45b44c2c5ca912d3a95556d3ed027d38541cbd26", "filename": "crates/ide-diagnostics/src/handlers/mutability_errors.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/780349bdafb7983d59d07891abe4225e28d96541/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Fmutability_errors.rs?ref=780349bdafb7983d59d07891abe4225e28d96541", "patch": "@@ -352,6 +352,32 @@ fn main() {\n         );\n     }\n \n+    #[test]\n+    fn match_closure_capture() {\n+        check_diagnostics(\n+            r#\"\n+//- minicore: option\n+fn main() {\n+    let mut v = &mut Some(2);\n+      //^^^^^ \ud83d\udca1 weak: variable does not need to be mutable\n+    let _ = || match v {\n+        Some(k) => {\n+            *k = 5;\n+        }\n+        None => {}\n+    };\n+    let v = &mut Some(2);\n+    let _ = || match v {\n+                   //^ \ud83d\udca1 error: cannot mutate immutable variable `v`\n+        ref mut k => {\n+            *k = &mut Some(5);\n+        }\n+    };\n+}\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn match_bindings() {\n         check_diagnostics("}]}