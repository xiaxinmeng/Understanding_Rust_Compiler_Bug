{"sha": "43119deac14fe16e3a343c08755b1a049a5cc196", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQzMTE5ZGVhYzE0ZmUxNmUzYTM0M2MwODc1NWIxYTA0OWE1Y2MxOTY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-04-01T12:32:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-01T12:32:17Z"}, "message": "Rollup merge of #70591 - cuviper:fulldeps-library-path, r=Mark-Simulacrum\n\nEnsure LLVM is in the link path for \"fulldeps\" tests\n\nThis is a follow-up to #70123, which added `llvm-config --libdir` to the\n`LIBRARY_PATH` for rustc tools. We need the same for \"run-make-fulldeps\"\nand \"ui-fulldeps\" tests which depend on compiler libraries, implicitly\nneeding to link to `-lLLVM` as well.", "tree": {"sha": "85da671281f6783f024898cc8064cf6dee54b035", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85da671281f6783f024898cc8064cf6dee54b035"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/43119deac14fe16e3a343c08755b1a049a5cc196", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJehInRCRBK7hj4Ov3rIwAAdHIIAGQVGIRgWf1CS7OGAN5xZ9sU\nAP9N6GFDR3qClfUZsFu5yjpOytjuH6Eq6A0ZRFPpeGuIL/JueLXT9yC1xNBuCgpD\nwQam9oErePUPpWYGacjxBVdUn6YO9KfxGP0xMnnmBUBhK4+yGnIOJcb/ogFzsTQZ\nxEIq5c7tPmNs2FAIBCHZKd2bKzDrXSdsJ4mNoGspghmHQaptKA5WVv17iN46o0yX\nTimeiOs5jazI8nRDL93kIgE3JiYWUchnwY99ay41Z6jCdysBPNH+TJsTYuXT6Xv9\nA7LecKwckEA5vm+k5WZuj97Zwy9dZ487yAMt7knV2wh7z1ZDOfMaPCxSVtZph5A=\n=cHrf\n-----END PGP SIGNATURE-----\n", "payload": "tree 85da671281f6783f024898cc8064cf6dee54b035\nparent 90cecab42be9c28c09dd71b4b65d9f4de6976fae\nparent 6067315d58ff3d49b305ae3c99810656856c8e21\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1585744337 +0200\ncommitter GitHub <noreply@github.com> 1585744337 +0200\n\nRollup merge of #70591 - cuviper:fulldeps-library-path, r=Mark-Simulacrum\n\nEnsure LLVM is in the link path for \"fulldeps\" tests\n\nThis is a follow-up to #70123, which added `llvm-config --libdir` to the\n`LIBRARY_PATH` for rustc tools. We need the same for \"run-make-fulldeps\"\nand \"ui-fulldeps\" tests which depend on compiler libraries, implicitly\nneeding to link to `-lLLVM` as well.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/43119deac14fe16e3a343c08755b1a049a5cc196", "html_url": "https://github.com/rust-lang/rust/commit/43119deac14fe16e3a343c08755b1a049a5cc196", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/43119deac14fe16e3a343c08755b1a049a5cc196/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90cecab42be9c28c09dd71b4b65d9f4de6976fae", "url": "https://api.github.com/repos/rust-lang/rust/commits/90cecab42be9c28c09dd71b4b65d9f4de6976fae", "html_url": "https://github.com/rust-lang/rust/commit/90cecab42be9c28c09dd71b4b65d9f4de6976fae"}, {"sha": "6067315d58ff3d49b305ae3c99810656856c8e21", "url": "https://api.github.com/repos/rust-lang/rust/commits/6067315d58ff3d49b305ae3c99810656856c8e21", "html_url": "https://github.com/rust-lang/rust/commit/6067315d58ff3d49b305ae3c99810656856c8e21"}], "stats": {"total": 11, "additions": 10, "deletions": 1}, "files": [{"sha": "2499856235f100b6b03a9bed6fcf2f8624d87eac", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/43119deac14fe16e3a343c08755b1a049a5cc196/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43119deac14fe16e3a343c08755b1a049a5cc196/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=43119deac14fe16e3a343c08755b1a049a5cc196", "patch": "@@ -21,7 +21,7 @@ use crate::flags::Subcommand;\n use crate::native;\n use crate::tool::{self, SourceType, Tool};\n use crate::toolstate::ToolState;\n-use crate::util::{self, dylib_path, dylib_path_var};\n+use crate::util::{self, add_link_lib_path, dylib_path, dylib_path_var};\n use crate::Crate as CargoCrate;\n use crate::{envify, DocTests, GitRepo, Mode};\n \n@@ -1178,6 +1178,15 @@ impl Step for Compiletest {\n                 cmd.arg(\"--system-llvm\");\n             }\n \n+            // Tests that use compiler libraries may inherit the `-lLLVM` link\n+            // requirement, but the `-L` library path is not propagated across\n+            // separate compilations. We can add LLVM's library path to the\n+            // platform-specific environment variable as a workaround.\n+            if !builder.config.dry_run && suite.ends_with(\"fulldeps\") {\n+                let llvm_libdir = output(Command::new(&llvm_config).arg(\"--libdir\"));\n+                add_link_lib_path(vec![llvm_libdir.trim().into()], &mut cmd);\n+            }\n+\n             // Only pass correct values for these flags for the `run-make` suite as it\n             // requires that a C++ compiler was configured which isn't always the case.\n             if !builder.config.dry_run && suite == \"run-make-fulldeps\" {"}]}