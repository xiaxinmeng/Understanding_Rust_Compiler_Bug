{"sha": "b4e8596e3e78395543747ebaba26b49f6a478aa8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0ZTg1OTZlM2U3ODM5NTU0Mzc0N2ViYWJhMjZiNDlmNmE0NzhhYTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-04T01:40:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-04T01:40:36Z"}, "message": "Auto merge of #88598 - estebank:type-ascription-can-die-in-a-fire, r=wesleywiser\n\nDetect bare blocks with type ascription that were meant to be a `struct` literal\n\nAddress part of #34255.\n\nPotential improvement: silence the other knock down errors in `issue-34255-1.rs`.", "tree": {"sha": "c782e430605f5b820e4c4aaa448493bf706eccd2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c782e430605f5b820e4c4aaa448493bf706eccd2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b4e8596e3e78395543747ebaba26b49f6a478aa8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b4e8596e3e78395543747ebaba26b49f6a478aa8", "html_url": "https://github.com/rust-lang/rust/commit/b4e8596e3e78395543747ebaba26b49f6a478aa8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b4e8596e3e78395543747ebaba26b49f6a478aa8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "url": "https://api.github.com/repos/rust-lang/rust/commits/03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "html_url": "https://github.com/rust-lang/rust/commit/03c775c95596cbd92f2b1e8ca98e7addfa3eade2"}, {"sha": "12ce6e9c60c662dc7181b70021145f191c0f9f3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/12ce6e9c60c662dc7181b70021145f191c0f9f3e", "html_url": "https://github.com/rust-lang/rust/commit/12ce6e9c60c662dc7181b70021145f191c0f9f3e"}], "stats": {"total": 72, "additions": 67, "deletions": 5}, "files": [{"sha": "b92c5fa072786331b9c57d2eff79243c43fb67c2", "filename": "compiler/rustc_ast/src/ast.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_ast%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_ast%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fast.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -558,6 +558,14 @@ pub struct Block {\n     pub rules: BlockCheckMode,\n     pub span: Span,\n     pub tokens: Option<LazyTokenStream>,\n+    /// The following *isn't* a parse error, but will cause multiple errors in following stages.\n+    /// ```\n+    /// let x = {\n+    ///     foo: var\n+    /// };\n+    /// ```\n+    /// #34255\n+    pub could_be_bare_literal: bool,\n }\n \n /// A match pattern."}, {"sha": "2ec941cbb2466a95af61f5cb82254c7a1a0f4324", "filename": "compiler/rustc_ast/src/mut_visit.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -949,7 +949,7 @@ pub fn noop_visit_mt<T: MutVisitor>(MutTy { ty, mutbl: _ }: &mut MutTy, vis: &mu\n }\n \n pub fn noop_visit_block<T: MutVisitor>(block: &mut P<Block>, vis: &mut T) {\n-    let Block { id, stmts, rules: _, span, tokens } = block.deref_mut();\n+    let Block { id, stmts, rules: _, span, tokens, could_be_bare_literal: _ } = block.deref_mut();\n     vis.visit_id(id);\n     stmts.flat_map_in_place(|stmt| vis.flat_map_stmt(stmt));\n     vis.visit_span(span);"}, {"sha": "bcf95719db56b839331c689a787245e5c45409f2", "filename": "compiler/rustc_builtin_macros/src/deriving/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fmod.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -102,6 +102,7 @@ fn call_unreachable(cx: &ExtCtxt<'_>, span: Span) -> P<ast::Expr> {\n         rules: ast::BlockCheckMode::Unsafe(ast::CompilerGenerated),\n         span,\n         tokens: None,\n+        could_be_bare_literal: false,\n     }))\n }\n "}, {"sha": "8508b3b7ae6edb9a273d9f05e16950b75096e030", "filename": "compiler/rustc_builtin_macros/src/format.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -867,6 +867,7 @@ impl<'a, 'b> Context<'a, 'b> {\n             rules: BlockCheckMode::Unsafe(UnsafeSource::CompilerGenerated),\n             span: self.macsp,\n             tokens: None,\n+            could_be_bare_literal: false,\n         }));\n \n         let ident = Ident::from_str_and_span(\"args\", self.macsp);"}, {"sha": "2cc15b3e53f460b93ba8e686e6835fa20a8c0174", "filename": "compiler/rustc_expand/src/build.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_expand%2Fsrc%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_expand%2Fsrc%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fbuild.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -197,6 +197,7 @@ impl<'a> ExtCtxt<'a> {\n             rules: BlockCheckMode::Default,\n             span,\n             tokens: None,\n+            could_be_bare_literal: false,\n         })\n     }\n "}, {"sha": "a5f0c01477898dd6b2248a078026687c7b4338ad", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -810,6 +810,7 @@ impl<'a> MutVisitor for ReplaceBodyWithLoop<'a, '_> {\n                 id: resolver.next_node_id(),\n                 span: rustc_span::DUMMY_SP,\n                 tokens: None,\n+                could_be_bare_literal: false,\n             }\n         }\n "}, {"sha": "94ca70d3f9578efa2020fb58d222cd6f8981cf80", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -446,11 +446,13 @@ impl<'a> Parser<'a> {\n                         )\n                         .emit();\n                     *self = snapshot;\n-                    Ok(self.mk_block(\n+                    let mut tail = self.mk_block(\n                         vec![self.mk_stmt_err(expr.span)],\n                         s,\n                         lo.to(self.prev_token.span),\n-                    ))\n+                    );\n+                    tail.could_be_bare_literal = true;\n+                    Ok(tail)\n                 }\n                 (Err(mut err), Ok(tail)) => {\n                     // We have a block tail that contains a somehow valid type ascription expr.\n@@ -463,7 +465,10 @@ impl<'a> Parser<'a> {\n                     self.consume_block(token::Brace, ConsumeClosingDelim::Yes);\n                     Err(err)\n                 }\n-                (Ok(_), Ok(tail)) => Ok(tail),\n+                (Ok(_), Ok(mut tail)) => {\n+                    tail.could_be_bare_literal = true;\n+                    Ok(tail)\n+                }\n             });\n         }\n         None"}, {"sha": "25dcb4a112de1c7e030498a7167e97be22526055", "filename": "compiler/rustc_parse/src/parser/stmt.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fstmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fstmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fstmt.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -574,7 +574,14 @@ impl<'a> Parser<'a> {\n     }\n \n     pub(super) fn mk_block(&self, stmts: Vec<Stmt>, rules: BlockCheckMode, span: Span) -> P<Block> {\n-        P(Block { stmts, id: DUMMY_NODE_ID, rules, span, tokens: None })\n+        P(Block {\n+            stmts,\n+            id: DUMMY_NODE_ID,\n+            rules,\n+            span,\n+            tokens: None,\n+            could_be_bare_literal: false,\n+        })\n     }\n \n     pub(super) fn mk_stmt(&self, span: Span, kind: StmtKind) -> Stmt {"}, {"sha": "60573968361203330f30e8f77c33ec89f8d15c81", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -383,6 +383,11 @@ struct DiagnosticMetadata<'ast> {\n     /// Only used for better errors on `fn(): fn()`.\n     current_type_ascription: Vec<Span>,\n \n+    /// Only used for better errors on `let x = { foo: bar };`.\n+    /// In the case of a parse error with `let x = { foo: bar, };`, this isn't needed, it's only\n+    /// needed for cases where this parses as a correct type ascription.\n+    current_block_could_be_bare_struct_literal: Option<Span>,\n+\n     /// Only used for better errors on `let <pat>: <expr, not type>;`.\n     current_let_binding: Option<(Span, Option<Span>, Option<Span>)>,\n \n@@ -1871,6 +1876,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                 let instead = res.is_some();\n                 let suggestion =\n                     if res.is_none() { this.report_missing_type_error(path) } else { None };\n+                // get_from_node_id\n \n                 this.r.use_injections.push(UseError {\n                     err,\n@@ -2254,6 +2260,15 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             self.ribs[ValueNS].push(Rib::new(NormalRibKind));\n         }\n \n+        let prev = self.diagnostic_metadata.current_block_could_be_bare_struct_literal.take();\n+        if let (true, [Stmt { kind: StmtKind::Expr(expr), .. }]) =\n+            (block.could_be_bare_literal, &block.stmts[..])\n+        {\n+            if let ExprKind::Type(..) = expr.kind {\n+                self.diagnostic_metadata.current_block_could_be_bare_struct_literal =\n+                    Some(block.span);\n+            }\n+        }\n         // Descend into the block.\n         for stmt in &block.stmts {\n             if let StmtKind::Item(ref item) = stmt.kind {\n@@ -2267,6 +2282,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n \n             self.visit_stmt(stmt);\n         }\n+        self.diagnostic_metadata.current_block_could_be_bare_struct_literal = prev;\n \n         // Move back up.\n         self.parent_scope.module = orig_module;"}, {"sha": "b2c0c7874655e0d6fe9fd6bf7a412ab1b5a4fb3b", "filename": "compiler/rustc_resolve/src/late/diagnostics.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -207,6 +207,16 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n         let code = source.error_code(res.is_some());\n         let mut err = self.r.session.struct_span_err_with_code(base_span, &base_msg, code);\n \n+        if let Some(span) = self.diagnostic_metadata.current_block_could_be_bare_struct_literal {\n+            err.multipart_suggestion(\n+                \"you might have meant to write a `struct` literal\",\n+                vec![\n+                    (span.shrink_to_lo(), \"{ SomeStruct \".to_string()),\n+                    (span.shrink_to_hi(), \"}\".to_string()),\n+                ],\n+                Applicability::HasPlaceholders,\n+            );\n+        }\n         match (source, self.diagnostic_metadata.in_if_condition) {\n             (PathSource::Expr(_), Some(Expr { span, kind: ExprKind::Assign(..), .. })) => {\n                 err.span_suggestion_verbose("}, {"sha": "8b0cebfa60e2c09251e99abcc6f30550c29fc343", "filename": "src/test/ui-fulldeps/pprust-expr-roundtrip.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/src%2Ftest%2Fui-fulldeps%2Fpprust-expr-roundtrip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/src%2Ftest%2Fui-fulldeps%2Fpprust-expr-roundtrip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fpprust-expr-roundtrip.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -106,6 +106,7 @@ fn iter_exprs(depth: usize, f: &mut dyn FnMut(P<Expr>)) {\n                     rules: BlockCheckMode::Default,\n                     span: DUMMY_SP,\n                     tokens: None,\n+                    could_be_bare_literal: false,\n                 });\n                 iter_exprs(depth - 1, &mut |e| g(ExprKind::If(e, block.clone(), None)));\n             }"}, {"sha": "43f0fbbc4e387d266d8bddbc87fe7a6138de3c95", "filename": "src/test/ui/type/ascription/issue-34255-1.stderr", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/src%2Ftest%2Fui%2Ftype%2Fascription%2Fissue-34255-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/src%2Ftest%2Fui%2Ftype%2Fascription%2Fissue-34255-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype%2Fascription%2Fissue-34255-1.stderr?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -3,6 +3,16 @@ error[E0425]: cannot find value `input_cells` in this scope\n    |\n LL |         input_cells: Vec::new()\n    |         ^^^^^^^^^^^ a field by this name exists in `Self`\n+   |\n+help: you might have meant to write a `struct` literal\n+   |\n+LL ~     pub fn new() -> Self { SomeStruct {\n+LL |         input_cells: Vec::new()\n+LL |\n+LL |\n+LL |\n+LL ~     }}\n+   |\n \n error[E0214]: parenthesized type parameters may only be used with a `Fn` trait\n   --> $DIR/issue-34255-1.rs:7:27"}, {"sha": "34d73a77fd3d4fa6b41c5a7737b316865febcb13", "filename": "src/tools/rustfmt/src/closures.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4e8596e3e78395543747ebaba26b49f6a478aa8/src%2Ftools%2Frustfmt%2Fsrc%2Fclosures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4e8596e3e78395543747ebaba26b49f6a478aa8/src%2Ftools%2Frustfmt%2Fsrc%2Fclosures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt%2Fsrc%2Fclosures.rs?ref=b4e8596e3e78395543747ebaba26b49f6a478aa8", "patch": "@@ -160,6 +160,7 @@ fn rewrite_closure_with_block(\n             .first()\n             .map(|attr| attr.span.to(body.span))\n             .unwrap_or(body.span),\n+        could_be_bare_literal: false,\n     };\n     let block = crate::expr::rewrite_block_with_visitor(\n         context,"}]}