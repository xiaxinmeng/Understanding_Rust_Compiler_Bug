{"sha": "6639b60ec6f5479d2fac655e67d14d5a7a8adb27", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2MzliNjBlYzZmNTQ3OWQyZmFjNjU1ZTY3ZDE0ZDVhN2E4YWRiMjc=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-03-14T15:26:28Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-03-14T16:15:55Z"}, "message": "Rollup merge of #48966 - retep007:hir-fingerprint-optimization, r=michaelwoerister\n\nSpeed up SVH computation by using Fingerprint::combine()\n\nFix #47297", "tree": {"sha": "764a9e07e255468018ccdc5063181fa278ed0ece", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/764a9e07e255468018ccdc5063181fa278ed0ece"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6639b60ec6f5479d2fac655e67d14d5a7a8adb27", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlqpSrsACgkQ/vbIBR0O\nATxlsw//SZ2mEsS3pHArrMq7tmO/66SypGpZtKDVeHpPEpOs4Hozscj4T0yhR5QP\nPTdw7OJItcJ0/E4MdEm/Gi1HfrFdt1tndg1i7tUWKSv1arU0xKzVX1AmUhqpk5p4\niRs97nIEbY6wkv6Elz2+oL7UweUmd1XjufVCBn4joiiv91q4A2ZN2AjIF19+2e9I\nmfm/gCewB/U7hrk7cHc+dC6VjzEB98WUD3Bor366ilo1RuCu4rtvLdFTUsrXA2ng\n0esXmL1nPm9Rbn41i+vgMD5Fy3xB37QB1Kx6CihvF3SjLGv0yS4tDLne4Ka4TYef\nqFrrv5ZFRqCZswCCtIu28O3sjKqfqmyk/KpKH3ubgNbaFuXk79XsfntuBFOFLIFv\nXYr3ex4QKqXiXsD8SGVcvwhBfSD4I6PxFDPtZuY4sW+v/S6K2FAtybfrxzHMbGvn\n/BmUHS4df8S5CivK8xLn6O6iMcjeRDaCdlMVxh6WreYy+WS0hNJb1UU3lZVMpXZV\nMfSMZEKcRwRSZvMuAPXuIEhUyVpzqI5Hn/zvaTJu87SIy1LTLnFOhRId2eZJa2Bj\nRE1IActzUOIoSrYb+hDxMu78a652HElp9vTUJfA1eLCg16PcfGXKqDfZABc7qgaD\nGx2esPojSRcM0r0sEj9rrtR8hFMtuTLiSdLFajG6zIz9yWtcLIE=\n=tYDC\n-----END PGP SIGNATURE-----", "payload": "tree 764a9e07e255468018ccdc5063181fa278ed0ece\nparent 55e5ba3b81056bc88109aa9386503e21eae30808\nparent 2f2e17341c171c847c201516bec9bf2234704000\nauthor kennytm <kennytm@gmail.com> 1521041188 +0800\ncommitter kennytm <kennytm@gmail.com> 1521044155 +0800\n\nRollup merge of #48966 - retep007:hir-fingerprint-optimization, r=michaelwoerister\n\nSpeed up SVH computation by using Fingerprint::combine()\n\nFix #47297\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6639b60ec6f5479d2fac655e67d14d5a7a8adb27", "html_url": "https://github.com/rust-lang/rust/commit/6639b60ec6f5479d2fac655e67d14d5a7a8adb27", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6639b60ec6f5479d2fac655e67d14d5a7a8adb27/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "55e5ba3b81056bc88109aa9386503e21eae30808", "url": "https://api.github.com/repos/rust-lang/rust/commits/55e5ba3b81056bc88109aa9386503e21eae30808", "html_url": "https://github.com/rust-lang/rust/commit/55e5ba3b81056bc88109aa9386503e21eae30808"}, {"sha": "2f2e17341c171c847c201516bec9bf2234704000", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f2e17341c171c847c201516bec9bf2234704000", "html_url": "https://github.com/rust-lang/rust/commit/2f2e17341c171c847c201516bec9bf2234704000"}], "stats": {"total": 20, "additions": 12, "deletions": 8}, "files": [{"sha": "f77275926eba37477648a5dd8a7bca8d94868173", "filename": "src/librustc/hir/map/collector.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6639b60ec6f5479d2fac655e67d14d5a7a8adb27/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6639b60ec6f5479d2fac655e67d14d5a7a8adb27/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs?ref=6639b60ec6f5479d2fac655e67d14d5a7a8adb27", "patch": "@@ -13,6 +13,7 @@ use dep_graph::{DepGraph, DepKind, DepNodeIndex};\n use hir::def_id::{LOCAL_CRATE, CrateNum};\n use hir::intravisit::{Visitor, NestedVisitorMap};\n use hir::svh::Svh;\n+use ich::Fingerprint;\n use middle::cstore::CrateStore;\n use session::CrateDisambiguator;\n use std::iter::repeat;\n@@ -121,21 +122,24 @@ impl<'a, 'hir> NodeCollector<'a, 'hir> {\n         collector\n     }\n \n-    pub(super) fn finalize_and_compute_crate_hash(self,\n+    pub(super) fn finalize_and_compute_crate_hash(mut self,\n                                                   crate_disambiguator: CrateDisambiguator,\n                                                   cstore: &dyn CrateStore,\n                                                   codemap: &CodeMap,\n                                                   commandline_args_hash: u64)\n                                                   -> (Vec<MapEntry<'hir>>, Svh) {\n-        let mut node_hashes: Vec<_> = self\n+        self\n             .hir_body_nodes\n-            .iter()\n-            .map(|&(def_path_hash, dep_node_index)| {\n-                (def_path_hash, self.dep_graph.fingerprint_of(dep_node_index))\n-            })\n-            .collect();\n+            .sort_unstable_by(|&(ref d1, _), &(ref d2, _)| d1.cmp(d2));\n \n-        node_hashes.sort_unstable_by(|&(ref d1, _), &(ref d2, _)| d1.cmp(d2));\n+        let node_hashes = self\n+            .hir_body_nodes\n+            .iter()\n+            .fold(Fingerprint::ZERO, |fingerprint , &(def_path_hash, dep_node_index)| {\n+                fingerprint.combine(\n+                    def_path_hash.0.combine(self.dep_graph.fingerprint_of(dep_node_index))\n+                )\n+            });\n \n         let mut upstream_crates: Vec<_> = cstore.crates_untracked().iter().map(|&cnum| {\n             let name = cstore.crate_name_untracked(cnum).as_str();"}]}