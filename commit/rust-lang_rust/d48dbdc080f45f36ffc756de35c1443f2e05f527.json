{"sha": "d48dbdc080f45f36ffc756de35c1443f2e05f527", "node_id": "C_kwDOAAsO6NoAKGQ0OGRiZGMwODBmNDVmMzZmZmM3NTZkZTM1YzE0NDNmMmUwNWY1Mjc", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-12-13T18:25:36Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-12-15T18:45:40Z"}, "message": "Move generator check earlier in inlining.", "tree": {"sha": "5258ce40ce154feed6bf097ee2a370023cf915ef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5258ce40ce154feed6bf097ee2a370023cf915ef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d48dbdc080f45f36ffc756de35c1443f2e05f527", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d48dbdc080f45f36ffc756de35c1443f2e05f527", "html_url": "https://github.com/rust-lang/rust/commit/d48dbdc080f45f36ffc756de35c1443f2e05f527", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d48dbdc080f45f36ffc756de35c1443f2e05f527/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a66a704b2c3d30ff07d89380ebb9ba3de3b3182", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a66a704b2c3d30ff07d89380ebb9ba3de3b3182", "html_url": "https://github.com/rust-lang/rust/commit/4a66a704b2c3d30ff07d89380ebb9ba3de3b3182"}], "stats": {"total": 31, "additions": 12, "deletions": 19}, "files": [{"sha": "8be95b2d95a20c79897ffcde16bb4167ec5ca8cc", "filename": "compiler/rustc_mir_transform/src/inline.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d48dbdc080f45f36ffc756de35c1443f2e05f527/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d48dbdc080f45f36ffc756de35c1443f2e05f527/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs?ref=d48dbdc080f45f36ffc756de35c1443f2e05f527", "patch": "@@ -68,6 +68,12 @@ fn inline<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) -> bool {\n     if body.source.promoted.is_some() {\n         return false;\n     }\n+    // Avoid inlining into generators, since their `optimized_mir` is used for layout computation,\n+    // which can create a cycle, even when no attempt is made to inline the function in the other\n+    // direction.\n+    if body.generator.is_some() {\n+        return false;\n+    }\n \n     let mut this = Inliner {\n         tcx,\n@@ -202,14 +208,6 @@ impl<'tcx> Inliner<'tcx> {\n \n         if let Some(callee_def_id) = callee.def_id().as_local() {\n             let callee_hir_id = self.tcx.hir().local_def_id_to_hir_id(callee_def_id);\n-            // Avoid inlining into generators,\n-            // since their `optimized_mir` is used for layout computation, which can\n-            // create a cycle, even when no attempt is made to inline the function\n-            // in the other direction.\n-            if caller_body.generator.is_some() {\n-                return Err(\"local generator (query cycle avoidance)\");\n-            }\n-\n             // Avoid a cycle here by only using `instance_mir` only if we have\n             // a lower `HirId` than the callee. This ensures that the callee will\n             // not inline us. This trick only works without incremental compilation."}, {"sha": "84ccf25ef750e1e5adc0c95660156618578925e5", "filename": "src/test/mir-opt/generator_drop_cleanup.main-{closure#0}.generator_drop.0.mir", "status": "modified", "additions": 5, "deletions": 10, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d48dbdc080f45f36ffc756de35c1443f2e05f527/src%2Ftest%2Fmir-opt%2Fgenerator_drop_cleanup.main-%7Bclosure%230%7D.generator_drop.0.mir", "raw_url": "https://github.com/rust-lang/rust/raw/d48dbdc080f45f36ffc756de35c1443f2e05f527/src%2Ftest%2Fmir-opt%2Fgenerator_drop_cleanup.main-%7Bclosure%230%7D.generator_drop.0.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fgenerator_drop_cleanup.main-%7Bclosure%230%7D.generator_drop.0.mir?ref=d48dbdc080f45f36ffc756de35c1443f2e05f527", "patch": "@@ -20,21 +20,16 @@ fn main::{closure#0}(_1: *mut [generator@$DIR/generator-drop-cleanup.rs:10:15: 1\n     let _3: std::string::String;         // in scope 0 at $DIR/generator-drop-cleanup.rs:11:13: 11:15\n     let _4: ();                          // in scope 0 at $DIR/generator-drop-cleanup.rs:12:9: 12:14\n     let mut _5: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:12:9: 12:14\n-    let mut _7: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:18: 10:18\n-    let mut _8: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n-    let mut _9: u32;                     // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+    let mut _6: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:18: 10:18\n+    let mut _7: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+    let mut _8: u32;                     // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n     scope 1 {\n         debug _s => (((*_1) as variant#3).0: std::string::String); // in scope 1 at $DIR/generator-drop-cleanup.rs:11:13: 11:15\n     }\n-    scope 2 (inlined String::new) {      // at $DIR/generator-drop-cleanup.rs:11:18: 11:31\n-        let mut _6: std::vec::Vec<u8>;   // in scope 2 at $DIR/generator-drop-cleanup.rs:11:18: 11:31\n-        scope 3 (inlined Vec::<u8>::new) { // at $DIR/generator-drop-cleanup.rs:11:18: 11:31\n-        }\n-    }\n \n     bb0: {\n-        _9 = discriminant((*_1));        // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n-        switchInt(move _9) -> [0_u32: bb7, 3_u32: bb10, otherwise: bb11]; // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+        _8 = discriminant((*_1));        // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+        switchInt(move _8) -> [0_u32: bb7, 3_u32: bb10, otherwise: bb11]; // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n     }\n \n     bb1: {"}, {"sha": "be4d68f2de70714cce3a3fc8507a9223a9f4d4c6", "filename": "src/test/ui/mir/remove-zsts-query-cycle.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d48dbdc080f45f36ffc756de35c1443f2e05f527/src%2Ftest%2Fui%2Fmir%2Fremove-zsts-query-cycle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d48dbdc080f45f36ffc756de35c1443f2e05f527/src%2Ftest%2Fui%2Fmir%2Fremove-zsts-query-cycle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fremove-zsts-query-cycle.rs?ref=d48dbdc080f45f36ffc756de35c1443f2e05f527", "patch": "@@ -2,7 +2,7 @@\n //   optimized mir -> remove zsts -> layout of a generator -> optimized mir.\n //\n // edition:2018\n-// compile-flags: --crate-type=lib\n+// compile-flags: --crate-type=lib -Zinline-mir=yes\n // build-pass\n \n pub async fn listen() -> Result<(), std::io::Error> {"}]}