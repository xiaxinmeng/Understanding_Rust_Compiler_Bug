{"sha": "c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "node_id": "C_kwDOAAsO6NoAKGM4NjdjYmY5YjZhZWE4ZDczYzQzM2VkODVjNjYxOWU3NzE0ZjNmN2Y", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-27T15:01:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-27T15:01:50Z"}, "message": "Auto merge of #14216 - Veykril:simplify, r=Veykril\n\nminor: Simplify", "tree": {"sha": "027b77c16dd909fcba7afc28d03748c1307ad8a4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/027b77c16dd909fcba7afc28d03748c1307ad8a4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "html_url": "https://github.com/rust-lang/rust/commit/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b38fcde3ba6010d64d22138fa82dccb852fa8b23", "url": "https://api.github.com/repos/rust-lang/rust/commits/b38fcde3ba6010d64d22138fa82dccb852fa8b23", "html_url": "https://github.com/rust-lang/rust/commit/b38fcde3ba6010d64d22138fa82dccb852fa8b23"}, {"sha": "29a4453d5574577870e31fb6fee09fab2a0f6e67", "url": "https://api.github.com/repos/rust-lang/rust/commits/29a4453d5574577870e31fb6fee09fab2a0f6e67", "html_url": "https://github.com/rust-lang/rust/commit/29a4453d5574577870e31fb6fee09fab2a0f6e67"}], "stats": {"total": 133, "additions": 62, "deletions": 71}, "files": [{"sha": "1a5ee97fd047e2dd94714e783898950daae43856", "filename": "crates/hir-ty/src/method_resolution.rs", "status": "modified", "additions": 33, "deletions": 45, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fmethod_resolution.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -821,9 +821,9 @@ pub fn iterate_method_candidates_dyn(\n \n             let mut table = InferenceTable::new(db, env.clone());\n             let ty = table.instantiate_canonical(ty.clone());\n-            let (deref_chain, adj) = autoderef_method_receiver(&mut table, ty);\n+            let deref_chain = autoderef_method_receiver(&mut table, ty);\n \n-            let result = deref_chain.into_iter().zip(adj).try_for_each(|(receiver_ty, adj)| {\n+            let result = deref_chain.into_iter().try_for_each(|(receiver_ty, adj)| {\n                 iterate_method_candidates_with_autoref(\n                     &receiver_ty,\n                     adj,\n@@ -867,33 +867,28 @@ fn iterate_method_candidates_with_autoref(\n         return ControlFlow::Continue(());\n     }\n \n-    iterate_method_candidates_by_receiver(\n-        receiver_ty,\n-        first_adjustment.clone(),\n-        db,\n-        env.clone(),\n-        traits_in_scope,\n-        visible_from_module,\n-        name,\n-        &mut callback,\n-    )?;\n+    let mut iterate_method_candidates_by_receiver = move |receiver_ty, first_adjustment| {\n+        iterate_method_candidates_by_receiver(\n+            receiver_ty,\n+            first_adjustment,\n+            db,\n+            env.clone(),\n+            traits_in_scope,\n+            visible_from_module,\n+            name,\n+            &mut callback,\n+        )\n+    };\n+\n+    iterate_method_candidates_by_receiver(receiver_ty, first_adjustment.clone())?;\n \n     let refed = Canonical {\n         value: TyKind::Ref(Mutability::Not, static_lifetime(), receiver_ty.value.clone())\n             .intern(Interner),\n         binders: receiver_ty.binders.clone(),\n     };\n \n-    iterate_method_candidates_by_receiver(\n-        &refed,\n-        first_adjustment.with_autoref(Mutability::Not),\n-        db,\n-        env.clone(),\n-        traits_in_scope,\n-        visible_from_module,\n-        name,\n-        &mut callback,\n-    )?;\n+    iterate_method_candidates_by_receiver(&refed, first_adjustment.with_autoref(Mutability::Not))?;\n \n     let ref_muted = Canonical {\n         value: TyKind::Ref(Mutability::Mut, static_lifetime(), receiver_ty.value.clone())\n@@ -904,12 +899,6 @@ fn iterate_method_candidates_with_autoref(\n     iterate_method_candidates_by_receiver(\n         &ref_muted,\n         first_adjustment.with_autoref(Mutability::Mut),\n-        db,\n-        env,\n-        traits_in_scope,\n-        visible_from_module,\n-        name,\n-        &mut callback,\n     )\n }\n \n@@ -1210,8 +1199,8 @@ pub fn resolve_indexing_op(\n ) -> Option<ReceiverAdjustments> {\n     let mut table = InferenceTable::new(db, env.clone());\n     let ty = table.instantiate_canonical(ty);\n-    let (deref_chain, adj) = autoderef_method_receiver(&mut table, ty);\n-    for (ty, adj) in deref_chain.into_iter().zip(adj) {\n+    let deref_chain = autoderef_method_receiver(&mut table, ty);\n+    for (ty, adj) in deref_chain {\n         let goal = generic_implements_goal(db, env.clone(), index_trait, &ty);\n         if db.trait_solve(env.krate, goal.cast(Interner)).is_some() {\n             return Some(adj);\n@@ -1421,25 +1410,24 @@ fn generic_implements_goal(\n fn autoderef_method_receiver(\n     table: &mut InferenceTable<'_>,\n     ty: Ty,\n-) -> (Vec<Canonical<Ty>>, Vec<ReceiverAdjustments>) {\n-    let (mut deref_chain, mut adjustments): (Vec<_>, Vec<_>) = (Vec::new(), Vec::new());\n+) -> Vec<(Canonical<Ty>, ReceiverAdjustments)> {\n+    let mut deref_chain: Vec<_> = Vec::new();\n     let mut autoderef = autoderef::Autoderef::new(table, ty);\n     while let Some((ty, derefs)) = autoderef.next() {\n-        deref_chain.push(autoderef.table.canonicalize(ty).value);\n-        adjustments.push(ReceiverAdjustments {\n-            autoref: None,\n-            autoderefs: derefs,\n-            unsize_array: false,\n-        });\n+        deref_chain.push((\n+            autoderef.table.canonicalize(ty).value,\n+            ReceiverAdjustments { autoref: None, autoderefs: derefs, unsize_array: false },\n+        ));\n     }\n     // As a last step, we can do array unsizing (that's the only unsizing that rustc does for method receivers!)\n-    if let (Some((TyKind::Array(parameters, _), binders)), Some(adj)) = (\n-        deref_chain.last().map(|ty| (ty.value.kind(Interner), ty.binders.clone())),\n-        adjustments.last().cloned(),\n-    ) {\n+    if let Some((TyKind::Array(parameters, _), binders, adj)) =\n+        deref_chain.last().map(|(ty, adj)| (ty.value.kind(Interner), ty.binders.clone(), adj))\n+    {\n         let unsized_ty = TyKind::Slice(parameters.clone()).intern(Interner);\n-        deref_chain.push(Canonical { value: unsized_ty, binders });\n-        adjustments.push(ReceiverAdjustments { unsize_array: true, ..adj });\n+        deref_chain.push((\n+            Canonical { value: unsized_ty, binders },\n+            ReceiverAdjustments { unsize_array: true, ..adj.clone() },\n+        ));\n     }\n-    (deref_chain, adjustments)\n+    deref_chain\n }"}, {"sha": "6206a541c1e8975617124acfa509f49308a8517c", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -3339,12 +3339,10 @@ impl Type {\n             .map(move |ty| self.derived(ty))\n     }\n \n-    pub fn iterate_method_candidates<T>(\n+    pub fn iterate_method_candidates_with_traits<T>(\n         &self,\n         db: &dyn HirDatabase,\n         scope: &SemanticsScope<'_>,\n-        // FIXME this can be retrieved from `scope`, except autoimport uses this\n-        // to specify a different set, so the method needs to be split\n         traits_in_scope: &FxHashSet<TraitId>,\n         with_local_impls: Option<Module>,\n         name: Option<&Name>,\n@@ -3372,6 +3370,24 @@ impl Type {\n         slot\n     }\n \n+    pub fn iterate_method_candidates<T>(\n+        &self,\n+        db: &dyn HirDatabase,\n+        scope: &SemanticsScope<'_>,\n+        with_local_impls: Option<Module>,\n+        name: Option<&Name>,\n+        callback: impl FnMut(Function) -> Option<T>,\n+    ) -> Option<T> {\n+        self.iterate_method_candidates_with_traits(\n+            db,\n+            scope,\n+            &scope.visible_traits().0,\n+            with_local_impls,\n+            name,\n+            callback,\n+        )\n+    }\n+\n     fn iterate_method_candidates_dyn(\n         &self,\n         db: &dyn HirDatabase,"}, {"sha": "b3ba1c7d349fc635a4dc2c2ed78a0ea30c6a4ec1", "filename": "crates/hir/src/semantics.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fhir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fhir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -1673,6 +1673,7 @@ impl<'a> SemanticsScope<'a> {\n     }\n }\n \n+#[derive(Debug)]\n pub struct VisibleTraits(pub FxHashSet<TraitId>);\n \n impl ops::Deref for VisibleTraits {"}, {"sha": "9e1d9a702a15f3a7d8e4856453577bc1ee2a0814", "filename": "crates/ide-assists/src/handlers/convert_iter_for_each_to_for.rs", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_iter_for_each_to_for.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_iter_for_each_to_for.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_iter_for_each_to_for.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -157,19 +157,12 @@ fn is_ref_and_impls_iter_method(\n     let iter_trait = FamousDefs(sema, krate).core_iter_Iterator()?;\n \n     let has_wanted_method = ty\n-        .iterate_method_candidates(\n-            sema.db,\n-            &scope,\n-            &scope.visible_traits().0,\n-            None,\n-            Some(&wanted_method),\n-            |func| {\n-                if func.ret_type(sema.db).impls_trait(sema.db, iter_trait, &[]) {\n-                    return Some(());\n-                }\n-                None\n-            },\n-        )\n+        .iterate_method_candidates(sema.db, &scope, None, Some(&wanted_method), |func| {\n+            if func.ret_type(sema.db).impls_trait(sema.db, iter_trait, &[]) {\n+                return Some(());\n+            }\n+            None\n+        })\n         .is_some();\n     if !has_wanted_method {\n         return None;"}, {"sha": "442918619604448b7950f5796c0a27c160872162", "filename": "crates/ide-assists/src/handlers/generate_is_empty_from_len.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_is_empty_from_len.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_is_empty_from_len.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_is_empty_from_len.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -95,14 +95,7 @@ fn get_impl_method(\n \n     let scope = ctx.sema.scope(impl_.syntax())?;\n     let ty = impl_def.self_ty(db);\n-    ty.iterate_method_candidates(\n-        db,\n-        &scope,\n-        &scope.visible_traits().0,\n-        None,\n-        Some(fn_name),\n-        |func| Some(func),\n-    )\n+    ty.iterate_method_candidates(db, &scope, None, Some(fn_name), |func| Some(func))\n }\n \n #[cfg(test)]"}, {"sha": "09ac57153ae8b65df027bcda23b0ed7d98a84fdc", "filename": "crates/ide-completion/src/completions/dot.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fdot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fdot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fdot.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -122,7 +122,7 @@ fn complete_methods(\n     mut f: impl FnMut(hir::Function),\n ) {\n     let mut seen_methods = FxHashSet::default();\n-    receiver.iterate_method_candidates(\n+    receiver.iterate_method_candidates_with_traits(\n         ctx.db,\n         &ctx.scope,\n         &ctx.traits_in_scope(),"}, {"sha": "b26b0a9087ea2f3858efbe7a9d31bd2c3dabd49b", "filename": "crates/ide-db/src/imports/import_assets.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-db%2Fsrc%2Fimports%2Fimport_assets.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c867cbf9b6aea8d73c433ed85c6619e7714f3f7f/crates%2Fide-db%2Fsrc%2Fimports%2Fimport_assets.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Fimports%2Fimport_assets.rs?ref=c867cbf9b6aea8d73c433ed85c6619e7714f3f7f", "patch": "@@ -528,7 +528,7 @@ fn trait_applicable_items(\n             },\n         )\n     } else {\n-        trait_candidate.receiver_ty.iterate_method_candidates(\n+        trait_candidate.receiver_ty.iterate_method_candidates_with_traits(\n             db,\n             scope,\n             &trait_candidates,"}]}