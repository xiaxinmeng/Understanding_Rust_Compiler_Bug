{"sha": "74e08cb60d33e998d89a2a53fcceab48e574045e", "node_id": "C_kwDOAAsO6NoAKDc0ZTA4Y2I2MGQzM2U5OThkODlhMmE1M2ZjY2VhYjQ4ZTU3NDA0NWU", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-03-15T10:44:35Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-03-15T11:44:11Z"}, "message": "fix: Do not retry inlay hint requests", "tree": {"sha": "20f78b1b849dd40762943d706309d67a21a8d96d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20f78b1b849dd40762943d706309d67a21a8d96d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74e08cb60d33e998d89a2a53fcceab48e574045e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74e08cb60d33e998d89a2a53fcceab48e574045e", "html_url": "https://github.com/rust-lang/rust/commit/74e08cb60d33e998d89a2a53fcceab48e574045e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74e08cb60d33e998d89a2a53fcceab48e574045e/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad91622d115a9501277c6902ecbdfd70d882bfef", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad91622d115a9501277c6902ecbdfd70d882bfef", "html_url": "https://github.com/rust-lang/rust/commit/ad91622d115a9501277c6902ecbdfd70d882bfef"}], "stats": {"total": 38, "additions": 37, "deletions": 1}, "files": [{"sha": "313bb2ec8dffa8dfa3583331a2c76db8bfc60f3a", "filename": "crates/rust-analyzer/src/dispatch.rs", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/74e08cb60d33e998d89a2a53fcceab48e574045e/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74e08cb60d33e998d89a2a53fcceab48e574045e/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs?ref=74e08cb60d33e998d89a2a53fcceab48e574045e", "patch": "@@ -87,6 +87,42 @@ impl<'a> RequestDispatcher<'a> {\n         self\n     }\n \n+    /// Dispatches the request onto thread pool\n+    pub(crate) fn on_no_retry<R>(\n+        &mut self,\n+        f: fn(GlobalStateSnapshot, R::Params) -> Result<R::Result>,\n+    ) -> &mut Self\n+    where\n+        R: lsp_types::request::Request + 'static,\n+        R::Params: DeserializeOwned + panic::UnwindSafe + Send + fmt::Debug,\n+        R::Result: Serialize,\n+    {\n+        let (req, params, panic_context) = match self.parse::<R>() {\n+            Some(it) => it,\n+            None => return self,\n+        };\n+\n+        self.global_state.task_pool.handle.spawn({\n+            let world = self.global_state.snapshot();\n+            move || {\n+                let result = panic::catch_unwind(move || {\n+                    let _pctx = stdx::panic_context::enter(panic_context);\n+                    f(world, params)\n+                });\n+                match thread_result_to_response::<R>(req.id.clone(), result) {\n+                    Ok(response) => Task::Response(response),\n+                    Err(_) => Task::Response(lsp_server::Response::new_err(\n+                        req.id,\n+                        lsp_server::ErrorCode::ContentModified as i32,\n+                        \"content modified\".to_string(),\n+                    )),\n+                }\n+            }\n+        });\n+\n+        self\n+    }\n+\n     /// Dispatches the request onto thread pool\n     pub(crate) fn on<R>(\n         &mut self,"}, {"sha": "939d3ac3e74c4f3ed798d22e5b404ada4130ad5a", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/74e08cb60d33e998d89a2a53fcceab48e574045e/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74e08cb60d33e998d89a2a53fcceab48e574045e/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=74e08cb60d33e998d89a2a53fcceab48e574045e", "patch": "@@ -653,7 +653,7 @@ impl GlobalState {\n             .on::<lsp_types::request::GotoDeclaration>(handlers::handle_goto_declaration)\n             .on::<lsp_types::request::GotoImplementation>(handlers::handle_goto_implementation)\n             .on::<lsp_types::request::GotoTypeDefinition>(handlers::handle_goto_type_definition)\n-            .on::<lsp_types::request::InlayHintRequest>(handlers::handle_inlay_hints)\n+            .on_no_retry::<lsp_types::request::InlayHintRequest>(handlers::handle_inlay_hints)\n             .on::<lsp_types::request::InlayHintResolveRequest>(handlers::handle_inlay_hints_resolve)\n             .on::<lsp_types::request::Completion>(handlers::handle_completion)\n             .on::<lsp_types::request::ResolveCompletionItem>(handlers::handle_completion_resolve)"}]}