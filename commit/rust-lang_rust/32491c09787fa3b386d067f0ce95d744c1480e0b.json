{"sha": "32491c09787fa3b386d067f0ce95d744c1480e0b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyNDkxYzA5Nzg3ZmEzYjM4NmQwNjdmMGNlOTVkNzQ0YzE0ODBlMGI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-21T21:56:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-21T21:56:54Z"}, "message": "Merge #8570\n\n8570: Flycheck tries to parse both Cargo and Rustc messages. r=rickvanprim a=rickvanprim\n\nThis change allows non-Cargo build systems to be used for Flycheck provided they call `rustc` with `--error-format=json` and emit those JSON messages to `stdout`.\n\nCo-authored-by: James Leitch <rickvanprim@gmail.com>", "tree": {"sha": "b34adf250a8f7b43b7bfc2ecda2fb1f8f5614917", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b34adf250a8f7b43b7bfc2ecda2fb1f8f5614917"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/32491c09787fa3b386d067f0ce95d744c1480e0b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJggJ+mCRBK7hj4Ov3rIwAAQqoIAG+WKGlFpMaAy3mV4NJSFGaM\nuM2Z0MyeRoQQeUNwpcIdqEac+gLUu8+rTSNuXZQoruUsR2RbvIYvXPJUARYTOd9I\n91SZedft5y8/r+sMh+QwEXyT4ShCMsQvfXyx/EAWfSOEia5jmEWcn8TpmModhEdW\nCAcOol18yP0NqpvkIphSmsxUpAFLHnV1Lcvjs6gUCIIgnh3y3UKeTJQUxQkd9aJr\nQKCxxoyfNPAJC9NvbkCnA+MCiR1Nih9gH5sN5sKah93y0lKbSFzV5deoCYfvShnG\noH347ex/R00BT3lMfJdpbjfbR7VCzdYE4jcOSvsGudjnQ66G2f+OMg/DlbE6jhQ=\n=lOk3\n-----END PGP SIGNATURE-----\n", "payload": "tree b34adf250a8f7b43b7bfc2ecda2fb1f8f5614917\nparent b21701c5ee77f30d3d5f2e69980c6d03618390d6\nparent b3a7953cae4f14f74934cc64ba7ccf7b3eb6cd08\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1619042214 +0000\ncommitter GitHub <noreply@github.com> 1619042214 +0000\n\nMerge #8570\n\n8570: Flycheck tries to parse both Cargo and Rustc messages. r=rickvanprim a=rickvanprim\n\nThis change allows non-Cargo build systems to be used for Flycheck provided they call `rustc` with `--error-format=json` and emit those JSON messages to `stdout`.\n\nCo-authored-by: James Leitch <rickvanprim@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/32491c09787fa3b386d067f0ce95d744c1480e0b", "html_url": "https://github.com/rust-lang/rust/commit/32491c09787fa3b386d067f0ce95d744c1480e0b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/32491c09787fa3b386d067f0ce95d744c1480e0b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b21701c5ee77f30d3d5f2e69980c6d03618390d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/b21701c5ee77f30d3d5f2e69980c6d03618390d6", "html_url": "https://github.com/rust-lang/rust/commit/b21701c5ee77f30d3d5f2e69980c6d03618390d6"}, {"sha": "b3a7953cae4f14f74934cc64ba7ccf7b3eb6cd08", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3a7953cae4f14f74934cc64ba7ccf7b3eb6cd08", "html_url": "https://github.com/rust-lang/rust/commit/b3a7953cae4f14f74934cc64ba7ccf7b3eb6cd08"}], "stats": {"total": 70, "additions": 48, "deletions": 22}, "files": [{"sha": "98141f5cdaf8c064f14cb4a34c60bcafc0db7ecb", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/32491c09787fa3b386d067f0ce95d744c1480e0b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/32491c09787fa3b386d067f0ce95d744c1480e0b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=32491c09787fa3b386d067f0ce95d744c1480e0b", "patch": "@@ -396,6 +396,7 @@ dependencies = [\n  \"crossbeam-channel\",\n  \"jod-thread\",\n  \"log\",\n+ \"serde\",\n  \"serde_json\",\n  \"stdx\",\n  \"toolchain\","}, {"sha": "18b9ce7dfc150f3fce814a17e06ef0111ed887b5", "filename": "crates/flycheck/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/32491c09787fa3b386d067f0ce95d744c1480e0b/crates%2Fflycheck%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/32491c09787fa3b386d067f0ce95d744c1480e0b/crates%2Fflycheck%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fflycheck%2FCargo.toml?ref=32491c09787fa3b386d067f0ce95d744c1480e0b", "patch": "@@ -13,6 +13,7 @@ doctest = false\n crossbeam-channel = \"0.5.0\"\n log = \"0.4.8\"\n cargo_metadata = \"0.13\"\n+serde = { version = \"1.0.106\", features = [\"derive\"] }\n serde_json = \"1.0.48\"\n jod-thread = \"0.1.1\"\n "}, {"sha": "1682d8bde23548f38073682be12b6cd00dfdea5b", "filename": "crates/flycheck/src/lib.rs", "status": "modified", "additions": 46, "deletions": 22, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/32491c09787fa3b386d067f0ce95d744c1480e0b/crates%2Fflycheck%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32491c09787fa3b386d067f0ce95d744c1480e0b/crates%2Fflycheck%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fflycheck%2Fsrc%2Flib.rs?ref=32491c09787fa3b386d067f0ce95d744c1480e0b", "patch": "@@ -4,13 +4,14 @@\n \n use std::{\n     fmt,\n-    io::{self, BufReader},\n+    io::{self, BufRead, BufReader},\n     path::PathBuf,\n     process::{self, Command, Stdio},\n     time::Duration,\n };\n \n use crossbeam_channel::{never, select, unbounded, Receiver, Sender};\n+use serde::Deserialize;\n use stdx::JodChild;\n \n pub use cargo_metadata::diagnostic::{\n@@ -128,7 +129,7 @@ struct FlycheckActor {\n \n enum Event {\n     Restart(Restart),\n-    CheckEvent(Option<cargo_metadata::Message>),\n+    CheckEvent(Option<CargoMessage>),\n }\n \n impl FlycheckActor {\n@@ -180,21 +181,16 @@ impl FlycheckActor {\n                     self.progress(Progress::DidFinish(res));\n                 }\n                 Event::CheckEvent(Some(message)) => match message {\n-                    cargo_metadata::Message::CompilerArtifact(msg) => {\n+                    CargoMessage::CompilerArtifact(msg) => {\n                         self.progress(Progress::DidCheckCrate(msg.target.name));\n                     }\n \n-                    cargo_metadata::Message::CompilerMessage(msg) => {\n+                    CargoMessage::Diagnostic(msg) => {\n                         self.send(Message::AddDiagnostic {\n                             workspace_root: self.workspace_root.clone(),\n-                            diagnostic: msg.message,\n+                            diagnostic: msg,\n                         });\n                     }\n-\n-                    cargo_metadata::Message::BuildScriptExecuted(_)\n-                    | cargo_metadata::Message::BuildFinished(_)\n-                    | cargo_metadata::Message::TextLine(_)\n-                    | _ => {}\n                 },\n             }\n         }\n@@ -261,7 +257,7 @@ struct CargoHandle {\n     child: JodChild,\n     #[allow(unused)]\n     thread: jod_thread::JoinHandle<io::Result<bool>>,\n-    receiver: Receiver<cargo_metadata::Message>,\n+    receiver: Receiver<CargoMessage>,\n }\n \n impl CargoHandle {\n@@ -294,14 +290,11 @@ impl CargoHandle {\n \n struct CargoActor {\n     child_stdout: process::ChildStdout,\n-    sender: Sender<cargo_metadata::Message>,\n+    sender: Sender<CargoMessage>,\n }\n \n impl CargoActor {\n-    fn new(\n-        child_stdout: process::ChildStdout,\n-        sender: Sender<cargo_metadata::Message>,\n-    ) -> CargoActor {\n+    fn new(child_stdout: process::ChildStdout, sender: Sender<CargoMessage>) -> CargoActor {\n         CargoActor { child_stdout, sender }\n     }\n     fn run(self) -> io::Result<bool> {\n@@ -315,7 +308,7 @@ impl CargoActor {\n         // erroneus output.\n         let stdout = BufReader::new(self.child_stdout);\n         let mut read_at_least_one_message = false;\n-        for message in cargo_metadata::Message::parse_stream(stdout) {\n+        for message in stdout.lines() {\n             let message = match message {\n                 Ok(message) => message,\n                 Err(err) => {\n@@ -326,13 +319,44 @@ impl CargoActor {\n \n             read_at_least_one_message = true;\n \n-            // Skip certain kinds of messages to only spend time on what's useful\n-            match &message {\n-                cargo_metadata::Message::CompilerArtifact(artifact) if artifact.fresh => (),\n-                cargo_metadata::Message::BuildScriptExecuted(_) => (),\n-                _ => self.sender.send(message).unwrap(),\n+            // Try to deserialize a message from Cargo or Rustc.\n+            let mut deserializer = serde_json::Deserializer::from_str(&message);\n+            deserializer.disable_recursion_limit();\n+            if let Ok(message) = JsonMessage::deserialize(&mut deserializer) {\n+                match message {\n+                    // Skip certain kinds of messages to only spend time on what's useful\n+                    JsonMessage::Cargo(message) => match message {\n+                        cargo_metadata::Message::CompilerArtifact(artifact) if !artifact.fresh => {\n+                            self.sender.send(CargoMessage::CompilerArtifact(artifact)).unwrap()\n+                        }\n+                        cargo_metadata::Message::CompilerMessage(msg) => {\n+                            self.sender.send(CargoMessage::Diagnostic(msg.message)).unwrap()\n+                        }\n+\n+                        cargo_metadata::Message::CompilerArtifact(_)\n+                        | cargo_metadata::Message::BuildScriptExecuted(_)\n+                        | cargo_metadata::Message::BuildFinished(_)\n+                        | cargo_metadata::Message::TextLine(_)\n+                        | _ => (),\n+                    },\n+                    JsonMessage::Rustc(message) => {\n+                        self.sender.send(CargoMessage::Diagnostic(message)).unwrap()\n+                    }\n+                }\n             }\n         }\n         Ok(read_at_least_one_message)\n     }\n }\n+\n+enum CargoMessage {\n+    CompilerArtifact(cargo_metadata::Artifact),\n+    Diagnostic(Diagnostic),\n+}\n+\n+#[derive(Deserialize)]\n+#[serde(untagged)]\n+enum JsonMessage {\n+    Cargo(cargo_metadata::Message),\n+    Rustc(Diagnostic),\n+}"}]}