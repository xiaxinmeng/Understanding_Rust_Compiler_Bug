{"sha": "d0d37075a54b68df99c46d42655a06c575eecd3f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwZDM3MDc1YTU0YjY4ZGY5OWM0NmQ0MjY1NWEwNmM1NzVlZWNkM2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-07-10T11:07:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-07-10T11:07:25Z"}, "message": "Auto merge of #26751 - retep998:copy-that-floppy, r=alexcrichton\n\nUsing the OS mechanism for copying files allows the OS to optimize the transfer using stuff such as [Offloaded Data Transfers (ODX)](https://msdn.microsoft.com/en-us/library/windows/desktop/hh848056%28v=vs.85%29.aspx).\r\nAlso preserves a lot more information, including NTFS [File Streams](https://msdn.microsoft.com/en-us/library/windows/desktop/aa364404%28v=vs.85%29.aspx), which the manual implementation threw away.\r\nIn addition, it is an atomic operation, unlike the manual implementation which has extra calls for copying over permissions.\r\n\r\nr? @alexcrichton", "tree": {"sha": "03a0f0e30444469beca4f346f495b368ed37d2d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/03a0f0e30444469beca4f346f495b368ed37d2d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d0d37075a54b68df99c46d42655a06c575eecd3f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d0d37075a54b68df99c46d42655a06c575eecd3f", "html_url": "https://github.com/rust-lang/rust/commit/d0d37075a54b68df99c46d42655a06c575eecd3f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d0d37075a54b68df99c46d42655a06c575eecd3f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4695fbde2157d1a172cea5df99bd661c4aa1204a", "url": "https://api.github.com/repos/rust-lang/rust/commits/4695fbde2157d1a172cea5df99bd661c4aa1204a", "html_url": "https://github.com/rust-lang/rust/commit/4695fbde2157d1a172cea5df99bd661c4aa1204a"}, {"sha": "1d202692ecfddb4b731993a5db4271c8698cbade", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d202692ecfddb4b731993a5db4271c8698cbade", "html_url": "https://github.com/rust-lang/rust/commit/1d202692ecfddb4b731993a5db4271c8698cbade"}], "stats": {"total": 109, "additions": 93, "deletions": 16}, "files": [{"sha": "2458838bc9d362422eb0bfd43adab65ad541d0f3", "filename": "src/libstd/fs.rs", "status": "modified", "additions": 27, "deletions": 15, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ffs.rs?ref=d0d37075a54b68df99c46d42655a06c575eecd3f", "patch": "@@ -21,7 +21,7 @@ use core::prelude::*;\n \n use fmt;\n use ffi::OsString;\n-use io::{self, Error, ErrorKind, SeekFrom, Seek, Read, Write};\n+use io::{self, SeekFrom, Seek, Read, Write};\n use path::{Path, PathBuf};\n use sys::fs as fs_imp;\n use sys_common::{AsInnerMut, FromInner, AsInner};\n@@ -862,20 +862,7 @@ pub fn rename<P: AsRef<Path>, Q: AsRef<Path>>(from: P, to: Q) -> io::Result<()>\n /// ```\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub fn copy<P: AsRef<Path>, Q: AsRef<Path>>(from: P, to: Q) -> io::Result<u64> {\n-    let from = from.as_ref();\n-    let to = to.as_ref();\n-    if !from.is_file() {\n-        return Err(Error::new(ErrorKind::InvalidInput,\n-                              \"the source path is not an existing file\"))\n-    }\n-\n-    let mut reader = try!(File::open(from));\n-    let mut writer = try!(File::create(to));\n-    let perm = try!(reader.metadata()).permissions();\n-\n-    let ret = try!(io::copy(&mut reader, &mut writer));\n-    try!(set_permissions(to, perm));\n-    Ok(ret)\n+    fs_imp::copy(from.as_ref(), to.as_ref())\n }\n \n /// Creates a new hard link on the filesystem.\n@@ -1749,6 +1736,19 @@ mod tests {\n         }\n     }\n \n+    #[test]\n+    fn copy_src_does_not_exist() {\n+        let tmpdir = tmpdir();\n+        let from = Path2::new(\"test/nonexistent-bogus-path\");\n+        let to = tmpdir.join(\"out.txt\");\n+        check!(check!(File::create(&to)).write(b\"hello\"));\n+        assert!(fs::copy(&from, &to).is_err());\n+        assert!(!from.exists());\n+        let mut v = Vec::new();\n+        check!(check!(File::open(&to)).read_to_end(&mut v));\n+        assert_eq!(v, b\"hello\");\n+    }\n+\n     #[test]\n     fn copy_file_ok() {\n         let tmpdir = tmpdir();\n@@ -1818,6 +1818,18 @@ mod tests {\n         check!(fs::set_permissions(&out, attr.permissions()));\n     }\n \n+    #[cfg(windows)]\n+    #[test]\n+    fn copy_file_preserves_streams() {\n+        let tmp = tmpdir();\n+        check!(check!(File::create(tmp.join(\"in.txt:bunny\"))).write(\"carrot\".as_bytes()));\n+        assert_eq!(check!(fs::copy(tmp.join(\"in.txt\"), tmp.join(\"out.txt\"))), 6);\n+        assert_eq!(check!(tmp.join(\"out.txt\").metadata()).len(), 0);\n+        let mut v = Vec::new();\n+        check!(check!(File::open(tmp.join(\"out.txt:bunny\"))).read_to_end(&mut v));\n+        assert_eq!(v, b\"carrot\".to_vec());\n+    }\n+\n     #[cfg(not(windows))] // FIXME(#10264) operation not permitted?\n     #[test]\n     fn symlinks_work() {"}, {"sha": "8113d0ea8479cd98e7e41d301e8cea8719c8eb3d", "filename": "src/libstd/sys/unix/fs.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Ffs.rs?ref=d0d37075a54b68df99c46d42655a06c575eecd3f", "patch": "@@ -14,7 +14,7 @@ use os::unix::prelude::*;\n \n use ffi::{CString, CStr, OsString, OsStr};\n use fmt;\n-use io::{self, Error, SeekFrom};\n+use io::{self, Error, ErrorKind, SeekFrom};\n use libc::{self, c_int, size_t, off_t, c_char, mode_t};\n use mem;\n use path::{Path, PathBuf};\n@@ -516,3 +516,19 @@ pub fn canonicalize(p: &Path) -> io::Result<PathBuf> {\n     buf.truncate(p);\n     Ok(PathBuf::from(OsString::from_vec(buf)))\n }\n+\n+pub fn copy(from: &Path, to: &Path) -> io::Result<u64> {\n+    use fs::{File, PathExt, set_permissions};\n+    if !from.is_file() {\n+        return Err(Error::new(ErrorKind::InvalidInput,\n+                              \"the source path is not an existing file\"))\n+    }\n+\n+    let mut reader = try!(File::open(from));\n+    let mut writer = try!(File::create(to));\n+    let perm = try!(reader.metadata()).permissions();\n+\n+    let ret = try!(io::copy(&mut reader, &mut writer));\n+    try!(set_permissions(to, perm));\n+    Ok(ret)\n+}"}, {"sha": "16563be2cfb79ee1dbb9656bd5e34fe88eb2a121", "filename": "src/libstd/sys/windows/c.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs?ref=d0d37075a54b68df99c46d42655a06c575eecd3f", "patch": "@@ -66,6 +66,11 @@ pub const STD_ERROR_HANDLE: libc::DWORD = -12i32 as libc::DWORD;\n \n pub const HANDLE_FLAG_INHERIT: libc::DWORD = 0x00000001;\n \n+pub const PROGRESS_CONTINUE: libc::DWORD = 0;\n+pub const PROGRESS_CANCEL: libc::DWORD = 1;\n+pub const PROGRESS_STOP: libc::DWORD = 2;\n+pub const PROGRESS_QUIET: libc::DWORD = 3;\n+\n #[repr(C)]\n #[cfg(target_arch = \"x86\")]\n pub struct WSADATA {\n@@ -249,6 +254,19 @@ pub type PCONDITION_VARIABLE = *mut CONDITION_VARIABLE;\n pub type PSRWLOCK = *mut SRWLOCK;\n pub type ULONG = c_ulong;\n pub type ULONG_PTR = c_ulong;\n+pub type LPBOOL = *mut BOOL;\n+\n+pub type LPPROGRESS_ROUTINE = ::option::Option<unsafe extern \"system\" fn(\n+    TotalFileSize: libc::LARGE_INTEGER,\n+    TotalBytesTransferred: libc::LARGE_INTEGER,\n+    StreamSize: libc::LARGE_INTEGER,\n+    StreamBytesTransferred: libc::LARGE_INTEGER,\n+    dwStreamNumber: DWORD,\n+    dwCallbackReason: DWORD,\n+    hSourceFile: HANDLE,\n+    hDestinationFile: HANDLE,\n+    lpData: LPVOID,\n+) -> DWORD>;\n \n #[repr(C)]\n pub struct CONDITION_VARIABLE { pub ptr: LPVOID }\n@@ -413,6 +431,12 @@ extern \"system\" {\n     pub fn SetHandleInformation(hObject: libc::HANDLE,\n                                 dwMask: libc::DWORD,\n                                 dwFlags: libc::DWORD) -> libc::BOOL;\n+    pub fn CopyFileExW(lpExistingFileName: libc::LPCWSTR,\n+                       lpNewFileName: libc::LPCWSTR,\n+                       lpProgressRoutine: LPPROGRESS_ROUTINE,\n+                       lpData: libc::LPVOID,\n+                       pbCancel: LPBOOL,\n+                       dwCopyFlags: libc::DWORD) -> libc::BOOL;\n }\n \n // Functions that aren't available on Windows XP, but we still use them and just"}, {"sha": "ae6b20de63910079d53270f749ece6c32bfa446a", "filename": "src/libstd/sys/windows/fs.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0d37075a54b68df99c46d42655a06c575eecd3f/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs?ref=d0d37075a54b68df99c46d42655a06c575eecd3f", "patch": "@@ -575,3 +575,28 @@ pub fn canonicalize(p: &Path) -> io::Result<PathBuf> {\n         PathBuf::from(OsString::from_wide(buf))\n     })\n }\n+\n+pub fn copy(from: &Path, to: &Path) -> io::Result<u64> {\n+    unsafe extern \"system\" fn callback(\n+        _TotalFileSize: libc::LARGE_INTEGER,\n+        TotalBytesTransferred: libc::LARGE_INTEGER,\n+        _StreamSize: libc::LARGE_INTEGER,\n+        _StreamBytesTransferred: libc::LARGE_INTEGER,\n+        _dwStreamNumber: libc::DWORD,\n+        _dwCallbackReason: libc::DWORD,\n+        _hSourceFile: HANDLE,\n+        _hDestinationFile: HANDLE,\n+        lpData: libc::LPVOID,\n+    ) -> libc::DWORD {\n+        *(lpData as *mut i64) = TotalBytesTransferred;\n+        c::PROGRESS_CONTINUE\n+    }\n+    let pfrom = to_utf16(from);\n+    let pto = to_utf16(to);\n+    let mut size = 0i64;\n+    try!(cvt(unsafe {\n+        c::CopyFileExW(pfrom.as_ptr(), pto.as_ptr(), Some(callback),\n+                       &mut size as *mut _ as *mut _, ptr::null_mut(), 0)\n+    }));\n+    Ok(size as u64)\n+}"}]}