{"sha": "7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiMjQ1ZDQ2ZWQ1ZmM5M2QzMjUxZTllMDdmNTBlOWIwOWIxZjQyYzQ=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2013-01-05T07:06:25Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2013-01-05T07:07:58Z"}, "message": "librustc: Stop generating first-class aggregates in visit glue, since they kick us off fast isel. Closes #4352. rs=minor-perf-improvement", "tree": {"sha": "e39cce19243f576596c7f8673d804d11ed20ff38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e39cce19243f576596c7f8673d804d11ed20ff38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4", "html_url": "https://github.com/rust-lang/rust/commit/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9abcacc0f371206a66cd1b346f5e46ac6063d9bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/9abcacc0f371206a66cd1b346f5e46ac6063d9bd", "html_url": "https://github.com/rust-lang/rust/commit/9abcacc0f371206a66cd1b346f5e46ac6063d9bd"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "ed9d2a94f45adc5e4cb2f02db3ff41d28436be5c", "filename": "src/librustc/middle/trans/common.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs?ref=7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4", "patch": "@@ -1094,6 +1094,8 @@ fn C_cstr(cx: @crate_ctxt, s: ~str) -> ValueRef {\n     return g;\n }\n \n+// NB: Do not use `do_spill_noroot` to make this into a constant string, or\n+// you will be kicked off fast isel. See issue #4352 for an example of this.\n fn C_estr_slice(cx: @crate_ctxt, s: ~str) -> ValueRef {\n     let cs = llvm::LLVMConstPointerCast(C_cstr(cx, s), T_ptr(T_i8()));\n     C_struct(~[cs, C_uint(cx, str::len(s) + 1u /* +1 for null */)])"}, {"sha": "792d0ea9a7f7ef3616d71ad896b3a69add9eb128", "filename": "src/librustc/middle/trans/reflect.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4/src%2Flibrustc%2Fmiddle%2Ftrans%2Freflect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4/src%2Flibrustc%2Fmiddle%2Ftrans%2Freflect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Freflect.rs?ref=7b245d46ed5fc93d3251e9e07f50e9b09b1f42c4", "patch": "@@ -46,8 +46,17 @@ impl reflector {\n     }\n \n     fn c_slice(s: ~str) -> ValueRef {\n-        let ss = C_estr_slice(self.bcx.ccx(), s);\n-        do_spill_noroot(self.bcx, ss)\n+        // We're careful to not use first class aggregates here because that\n+        // will kick us off fast isel. (Issue #4352.)\n+        let bcx = self.bcx;\n+        let str_vstore = ty::vstore_slice(ty::re_static);\n+        let str_ty = ty::mk_estr(bcx.tcx(), str_vstore);\n+        let scratch = scratch_datum(bcx, str_ty, false);\n+        let c_str = PointerCast(bcx, C_cstr(bcx.ccx(), s), T_ptr(T_i8()));\n+        Store(bcx, c_str, GEPi(bcx, scratch.val, [ 0, 0 ]));\n+        let len = C_uint(bcx.ccx(), s.len() + 1);\n+        Store(bcx, len, GEPi(bcx, scratch.val, [ 0, 1 ]));\n+        scratch.val\n     }\n \n     fn c_size_and_align(t: ty::t) -> ~[ValueRef] {"}]}