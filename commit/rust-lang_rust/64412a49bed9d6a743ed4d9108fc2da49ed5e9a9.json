{"sha": "64412a49bed9d6a743ed4d9108fc2da49ed5e9a9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY0NDEyYTQ5YmVkOWQ2YTc0M2VkNGQ5MTA4ZmMyZGE0OWVkNWU5YTk=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-05-11T21:09:25Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-05-19T17:52:57Z"}, "message": "mk: Fix building compiler-rt on MSVC\n\nIt looks like compiler-rt has a cmake build sytem inside its source, but I have\nbeen unable to figure out how to use it and actually build the right library.\nFor now this commit hard-wires MSVC-targeting builds of libcompiler-rt to\ncontinue using `make` as the primary bulid system, but some frobbing of the\nflags are necessary to ensure that the right compiler is used.", "tree": {"sha": "20fcaa09dc9b1679e476180a43cb981fa575d676", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20fcaa09dc9b1679e476180a43cb981fa575d676"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/64412a49bed9d6a743ed4d9108fc2da49ed5e9a9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/64412a49bed9d6a743ed4d9108fc2da49ed5e9a9", "html_url": "https://github.com/rust-lang/rust/commit/64412a49bed9d6a743ed4d9108fc2da49ed5e9a9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/64412a49bed9d6a743ed4d9108fc2da49ed5e9a9/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee64bab76cdaa375cc015a5eb3e3fd7581d2a7b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee64bab76cdaa375cc015a5eb3e3fd7581d2a7b3", "html_url": "https://github.com/rust-lang/rust/commit/ee64bab76cdaa375cc015a5eb3e3fd7581d2a7b3"}], "stats": {"total": 24, "additions": 19, "deletions": 5}, "files": [{"sha": "777a2a0fd3b4bfceee113033a8d78a4ea468b336", "filename": "mk/rt.mk", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/64412a49bed9d6a743ed4d9108fc2da49ed5e9a9/mk%2Frt.mk", "raw_url": "https://github.com/rust-lang/rust/raw/64412a49bed9d6a743ed4d9108fc2da49ed5e9a9/mk%2Frt.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Frt.mk?ref=64412a49bed9d6a743ed4d9108fc2da49ed5e9a9", "patch": "@@ -226,18 +226,32 @@ COMPRT_NAME_$(1) := $$(call CFG_STATIC_LIB_NAME_$(1),compiler-rt)\n COMPRT_LIB_$(1) := $$(RT_OUTPUT_DIR_$(1))/$$(COMPRT_NAME_$(1))\n COMPRT_BUILD_DIR_$(1) := $$(RT_OUTPUT_DIR_$(1))/compiler-rt\n \n+# Note that on MSVC-targeting builds we hardwire CC/AR to gcc/ar even though\n+# we're targeting MSVC. This is because although compiler-rt has a CMake build\n+# config I can't actually figure out how to use it, so I'm not sure how to use\n+# cl.exe to build the objects. Additionally, the compiler-rt library when built\n+# with gcc has the same ABI as cl.exe, so they're largely compatible\n+COMPRT_CC_$(1) := $$(CC_$(1))\n+COMPRT_AR_$(1) := $$(AR_$(1))\n+COMPRT_CFLAGS_$(1) := $$(CFG_GCCISH_CFLAGS_$(1))\n+ifeq ($$(findstring msvc,$(1)),msvc)\n+COMPRT_CC_$(1) := gcc\n+COMPRT_AR_$(1) := ar\n+COMPRT_CFLAGS_$(1) := $$(CFG_GCCISH_CFLAGS_$(1)) -m64\n+endif\n+\n $$(COMPRT_LIB_$(1)): $$(COMPRT_DEPS) $$(MKFILE_DEPS)\n \t@$$(call E, make: compiler-rt)\n \t$$(Q)$$(MAKE) -C \"$(S)src/compiler-rt\" \\\n \t\tProjSrcRoot=\"$(S)src/compiler-rt\" \\\n \t\tProjObjRoot=\"$$(abspath $$(COMPRT_BUILD_DIR_$(1)))\" \\\n-\t\tCC=\"$$(CC_$(1))\" \\\n-\t\tAR=\"$$(AR_$(1))\" \\\n-\t\tRANLIB=\"$$(AR_$(1)) s\" \\\n-\t\tCFLAGS=\"$$(CFG_GCCISH_CFLAGS_$(1))\" \\\n+\t\tCC='$$(COMPRT_CC_$(1))' \\\n+\t\tAR='$$(COMPRT_AR_$(1))' \\\n+\t\tRANLIB='$$(COMPRT_AR_$(1)) s' \\\n+\t\tCFLAGS=\"$$(COMPRT_CFLAGS_$(1))\" \\\n \t\tTargetTriple=$(1) \\\n \t\ttriple-builtins\n-\t$$(Q)cp $$(COMPRT_BUILD_DIR_$(1))/triple/builtins/libcompiler_rt.a $$(COMPRT_LIB_$(1))\n+\t$$(Q)cp $$(COMPRT_BUILD_DIR_$(1))/triple/builtins/libcompiler_rt.a $$@\n \n ################################################################################\n # libbacktrace"}]}