{"sha": "eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlYTJmNTU5NmEwZWUzMmQxMjlkMGRjOWE2NDQzOWNiZTRiY2Y4MDI=", "commit": {"author": {"name": "Tim Neumann", "email": "mail@timnn.me", "date": "2017-09-17T11:19:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-09-17T11:19:04Z"}, "message": "Rollup merge of #44533 - nrc:rustfmt-submod, r=alexcrichton\n\nAdd Rustfmt\n\nr? @alexcrichton", "tree": {"sha": "031201e53414a5c5bc28842a11c236e66d046f11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/031201e53414a5c5bc28842a11c236e66d046f11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "html_url": "https://github.com/rust-lang/rust/commit/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/comments", "author": {"login": "TimNN", "id": 1178249, "node_id": "MDQ6VXNlcjExNzgyNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/1178249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TimNN", "html_url": "https://github.com/TimNN", "followers_url": "https://api.github.com/users/TimNN/followers", "following_url": "https://api.github.com/users/TimNN/following{/other_user}", "gists_url": "https://api.github.com/users/TimNN/gists{/gist_id}", "starred_url": "https://api.github.com/users/TimNN/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TimNN/subscriptions", "organizations_url": "https://api.github.com/users/TimNN/orgs", "repos_url": "https://api.github.com/users/TimNN/repos", "events_url": "https://api.github.com/users/TimNN/events{/privacy}", "received_events_url": "https://api.github.com/users/TimNN/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39710f8fccded5965f31add466e2fd20da4904ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/39710f8fccded5965f31add466e2fd20da4904ec", "html_url": "https://github.com/rust-lang/rust/commit/39710f8fccded5965f31add466e2fd20da4904ec"}, {"sha": "368cab3b0357194f407060cd1a1d3339cf854c25", "url": "https://api.github.com/repos/rust-lang/rust/commits/368cab3b0357194f407060cd1a1d3339cf854c25", "html_url": "https://github.com/rust-lang/rust/commit/368cab3b0357194f407060cd1a1d3339cf854c25"}], "stats": {"total": 98, "additions": 93, "deletions": 5}, "files": [{"sha": "d5ae25646547f8be4ec143c30e2ba3ba305c043d", "filename": ".gitmodules", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/.gitmodules", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/.gitmodules", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitmodules?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -36,3 +36,6 @@\n [submodule \"src/tools/clippy\"]\n \tpath = src/tools/clippy\n \turl = https://github.com/rust-lang-nursery/rust-clippy.git\n+[submodule \"src/tools/rustfmt\"]\n+\tpath = src/tools/rustfmt\n+\turl = https://github.com/rust-lang-nursery/rustfmt.git"}, {"sha": "44faf4b445de16ff71ee242b391172d454b0ee84", "filename": "src/Cargo.lock", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.lock?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -1351,7 +1351,7 @@ dependencies = [\n  \"rls-rustc 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rls-span 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rls-vfs 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rustfmt-nightly 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustfmt-nightly 0.2.5\",\n  \"serde 1.0.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_derive 1.0.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_json 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1822,7 +1822,6 @@ dependencies = [\n [[package]]\n name = \"rustfmt-nightly\"\n version = \"0.2.5\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"diff 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"env_logger 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -2562,7 +2561,6 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum rls-vfs 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ffd34691a510938bb67fe0444fb363103c73ffb31c121d1e16bc92d8945ea8ff\"\n \"checksum rustc-demangle 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"aee45432acc62f7b9a108cc054142dac51f979e69e71ddce7d6fc7adf29e817e\"\n \"checksum rustc-serialize 0.3.24 (registry+https://github.com/rust-lang/crates.io-index)\" = \"dcf128d1287d2ea9d80910b5f1120d0b8eede3fbf1abe91c40d39ea7d51e6fda\"\n-\"checksum rustfmt-nightly 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7d6dbb39239e54df780a850721fba87b3fdb2e645b39041742ec111369cec6af\"\n \"checksum same-file 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d931a44fdaa43b8637009e7632a02adc4f2b2e0733c08caa4cf00e8da4a117a7\"\n \"checksum scoped-tls 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"f417c22df063e9450888a7561788e9bd46d3bb3c1466435b4eccb903807f147d\"\n \"checksum scopeguard 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"59a076157c1e2dc561d8de585151ee6965d910dd4dcb5dabb7ae3e83981a6c57\""}, {"sha": "8142213b20421b7dfba670268ead87ea88638ef9", "filename": "src/Cargo.toml", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.toml?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -18,6 +18,7 @@ members = [\n   \"tools/cargo\",\n   \"tools/rustdoc\",\n   \"tools/rls\",\n+  \"tools/rustfmt\",\n   # FIXME(https://github.com/rust-lang/cargo/issues/4089): move these to exclude\n   \"tools/rls/test_data/borrow_error\",\n   \"tools/rls/test_data/completion\",\n@@ -58,3 +59,11 @@ debug-assertions = false\n \n [patch.\"https://github.com/rust-lang/cargo\"]\n cargo = { path = \"tools/cargo\" }\n+\n+# Override rustfmt dependencies both on the repo and the crate (the RLS\n+# sometimes uses either).\n+# FIXME should only need the crates.io patch, long term.\n+[patch.'https://github.com/rust-lang-nursery/rustfmt']\n+rustfmt-nightly = { path = \"tools/rustfmt\" }\n+[patch.crates-io]\n+rustfmt-nightly = { path = \"tools/rustfmt\" }"}, {"sha": "7ff0154bf8bb30532bfbedc8710421e4b87b1134", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -249,11 +249,11 @@ impl<'a> Builder<'a> {\n                 tool::UnstableBookGen, tool::Tidy, tool::Linkchecker, tool::CargoTest,\n                 tool::Compiletest, tool::RemoteTestServer, tool::RemoteTestClient,\n                 tool::RustInstaller, tool::Cargo, tool::Rls, tool::Rustdoc, tool::Clippy,\n-                native::Llvm),\n+                native::Llvm, tool::Rustfmt),\n             Kind::Test => describe!(check::Tidy, check::Bootstrap, check::DefaultCompiletest,\n                 check::HostCompiletest, check::Crate, check::CrateLibrustc, check::Rustdoc,\n                 check::Linkcheck, check::Cargotest, check::Cargo, check::Rls, check::Docs,\n-                check::ErrorIndex, check::Distcheck),\n+                check::ErrorIndex, check::Distcheck, check::Rustfmt),\n             Kind::Bench => describe!(check::Crate, check::CrateLibrustc),\n             Kind::Doc => describe!(doc::UnstableBook, doc::UnstableBookGen, doc::TheBook,\n                 doc::Standalone, doc::Std, doc::Test, doc::Rustc, doc::ErrorIndex, doc::Nomicon,"}, {"sha": "94bb89145fbf3d1068342316b85b583d26c3e957", "filename": "src/bootstrap/check.rs", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcheck.rs?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -253,6 +253,47 @@ impl Step for Rls {\n     }\n }\n \n+#[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]\n+pub struct Rustfmt {\n+    stage: u32,\n+    host: Interned<String>,\n+}\n+\n+impl Step for Rustfmt {\n+    type Output = ();\n+    const ONLY_HOSTS: bool = true;\n+\n+    fn should_run(run: ShouldRun) -> ShouldRun {\n+        run.path(\"src/tools/rustfmt\")\n+    }\n+\n+    fn make_run(run: RunConfig) {\n+        run.builder.ensure(Rustfmt {\n+            stage: run.builder.top_stage,\n+            host: run.target,\n+        });\n+    }\n+\n+    /// Runs `cargo test` for rustfmt.\n+    fn run(self, builder: &Builder) {\n+        let build = builder.build;\n+        let stage = self.stage;\n+        let host = self.host;\n+        let compiler = builder.compiler(stage, host);\n+\n+        builder.ensure(tool::Rustfmt { compiler, target: self.host });\n+        let mut cargo = builder.cargo(compiler, Mode::Tool, host, \"test\");\n+        cargo.arg(\"--manifest-path\").arg(build.src.join(\"src/tools/rustfmt/Cargo.toml\"));\n+\n+        // Don't build tests dynamically, just a pain to work with\n+        cargo.env(\"RUSTC_NO_PREFER_DYNAMIC\", \"1\");\n+\n+        builder.add_rustc_lib_path(compiler, &mut cargo);\n+\n+        try_run(build, &mut cargo);\n+    }\n+}\n+\n fn path_for_cargo(builder: &Builder, compiler: Compiler) -> OsString {\n     // Configure PATH to find the right rustc. NB. we have to use PATH\n     // and not RUSTC because the Cargo test suite has tests that will"}, {"sha": "72be9c12e84e6b0952db05e09b487c76427f405e", "filename": "src/bootstrap/mk/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Fmk%2FMakefile.in", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Fmk%2FMakefile.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fmk%2FMakefile.in?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -55,6 +55,7 @@ check-aux:\n \t\tsrc/tools/cargotest \\\n \t\tsrc/tools/cargo \\\n \t\tsrc/tools/rls \\\n+\t\tsrc/tools/rustfmt \\\n \t\tsrc/test/pretty \\\n \t\tsrc/test/run-pass/pretty \\\n \t\tsrc/test/run-fail/pretty \\"}, {"sha": "d082012acc191beef353cde52f16de6d0db2bb01", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -445,6 +445,40 @@ impl Step for Rls {\n     }\n }\n \n+#[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct Rustfmt {\n+    pub compiler: Compiler,\n+    pub target: Interned<String>,\n+}\n+\n+impl Step for Rustfmt {\n+    type Output = PathBuf;\n+    const DEFAULT: bool = true;\n+    const ONLY_HOSTS: bool = true;\n+\n+    fn should_run(run: ShouldRun) -> ShouldRun {\n+        let builder = run.builder;\n+        run.path(\"src/tools/rustfmt\").default_condition(builder.build.config.extended)\n+    }\n+\n+    fn make_run(run: RunConfig) {\n+        run.builder.ensure(Rustfmt {\n+            compiler: run.builder.compiler(run.builder.top_stage, run.builder.build.build),\n+            target: run.target,\n+        });\n+    }\n+\n+    fn run(self, builder: &Builder) -> PathBuf {\n+        builder.ensure(ToolBuild {\n+            compiler: self.compiler,\n+            target: self.target,\n+            tool: \"rustfmt\",\n+            mode: Mode::Librustc,\n+            path: \"src/tools/rustfmt\",\n+        })\n+    }\n+}\n+\n impl<'a> Builder<'a> {\n     /// Get a `Command` which is ready to run `tool` in `stage` built for\n     /// `host`."}, {"sha": "a1fd68da464fc51585f351c81fc2b867211c197e", "filename": "src/tools/rustfmt", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -0,0 +1 @@\n+Subproject commit a1fd68da464fc51585f351c81fc2b867211c197e"}, {"sha": "56c0b21cd53c7b7e1a1f25aa392033b29cf52573", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eea2f5596a0ee32d129d0dc9a64439cbe4bcf802/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=eea2f5596a0ee32d129d0dc9a64439cbe4bcf802", "patch": "@@ -64,6 +64,7 @@ fn filter_dirs(path: &Path) -> bool {\n         \"src/tools/rls\",\n         \"src/tools/clippy\",\n         \"src/tools/rust-installer\",\n+        \"src/tools/rustfmt\",\n     ];\n     skip.iter().any(|p| path.ends_with(p))\n }"}]}