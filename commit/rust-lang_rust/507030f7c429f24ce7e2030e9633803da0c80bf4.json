{"sha": "507030f7c429f24ce7e2030e9633803da0c80bf4", "node_id": "C_kwDOAAsO6NoAKDUwNzAzMGY3YzQyOWYyNGNlN2UyMDMwZTk2MzM4MDNkYTBjODBiZjQ", "commit": {"author": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2021-11-12T16:41:08Z"}, "committer": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2021-11-12T21:22:09Z"}, "message": "Run rustfmt on batches of multiple files", "tree": {"sha": "30ba2c9c0e74b52aeec4d694a3ea4dcdc7528c67", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/30ba2c9c0e74b52aeec4d694a3ea4dcdc7528c67"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/507030f7c429f24ce7e2030e9633803da0c80bf4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/507030f7c429f24ce7e2030e9633803da0c80bf4", "html_url": "https://github.com/rust-lang/rust/commit/507030f7c429f24ce7e2030e9633803da0c80bf4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/507030f7c429f24ce7e2030e9633803da0c80bf4/comments", "author": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "608c9e85840afd84fbcc5c10988cbb64fd10a612", "url": "https://api.github.com/repos/rust-lang/rust/commits/608c9e85840afd84fbcc5c10988cbb64fd10a612", "html_url": "https://github.com/rust-lang/rust/commit/608c9e85840afd84fbcc5c10988cbb64fd10a612"}], "stats": {"total": 40, "additions": 24, "deletions": 16}, "files": [{"sha": "9ceadee58ea5981777ff171d7a94ad7c9f09e41d", "filename": "clippy_dev/src/fmt.rs", "status": "modified", "additions": 24, "deletions": 16, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/507030f7c429f24ce7e2030e9633803da0c80bf4/clippy_dev%2Fsrc%2Ffmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/507030f7c429f24ce7e2030e9633803da0c80bf4/clippy_dev%2Fsrc%2Ffmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Ffmt.rs?ref=507030f7c429f24ce7e2030e9633803da0c80bf4", "patch": "@@ -1,6 +1,7 @@\n use crate::clippy_project_root;\n+use itertools::Itertools;\n use shell_escape::escape;\n-use std::ffi::OsStr;\n+use std::ffi::{OsStr, OsString};\n use std::path::Path;\n use std::process::{self, Command};\n use std::{fs, io};\n@@ -56,15 +57,22 @@ pub fn run(check: bool, verbose: bool) {\n         success &= cargo_fmt(context, &project_root.join(\"rustc_tools_util\"))?;\n         success &= cargo_fmt(context, &project_root.join(\"lintcheck\"))?;\n \n-        for entry in WalkDir::new(project_root.join(\"tests\")) {\n-            let entry = entry?;\n-            let path = entry.path();\n-\n-            if path.extension() != Some(\"rs\".as_ref()) || entry.file_name() == \"ice-3891.rs\" {\n-                continue;\n-            }\n-\n-            success &= rustfmt(context, path)?;\n+        let chunks = WalkDir::new(project_root.join(\"tests\"))\n+            .into_iter()\n+            .filter_map(|entry| {\n+                let entry = entry.expect(\"failed to find tests\");\n+                let path = entry.path();\n+\n+                if path.extension() != Some(\"rs\".as_ref()) || entry.file_name() == \"ice-3891.rs\" {\n+                    None\n+                } else {\n+                    Some(entry.into_path().into_os_string())\n+                }\n+            })\n+            .chunks(250);\n+\n+        for chunk in &chunks {\n+            success &= rustfmt(context, chunk)?;\n         }\n \n         Ok(success)\n@@ -185,14 +193,14 @@ fn rustfmt_test(context: &FmtContext) -> Result<(), CliError> {\n     }\n }\n \n-fn rustfmt(context: &FmtContext, path: &Path) -> Result<bool, CliError> {\n-    let mut args = vec![path.as_os_str()];\n+fn rustfmt(context: &FmtContext, paths: impl Iterator<Item = OsString>) -> Result<bool, CliError> {\n+    let mut args = Vec::new();\n     if context.check {\n-        args.push(\"--check\".as_ref());\n+        args.push(OsString::from(\"--check\"));\n     }\n+    args.extend(paths);\n+\n     let success = exec(context, \"rustfmt\", std::env::current_dir()?, &args)?;\n-    if !success {\n-        eprintln!(\"rustfmt failed on {}\", path.display());\n-    }\n+\n     Ok(success)\n }"}]}