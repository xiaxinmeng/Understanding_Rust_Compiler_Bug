{"sha": "d4593af78fb2929f0c46e5e4fc041092b7195f81", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0NTkzYWY3OGZiMjkyOWYwYzQ2ZTVlNGZjMDQxMDkyYjcxOTVmODE=", "commit": {"author": {"name": "Rich Kadel", "email": "richkadel@google.com", "date": "2020-08-12T22:30:41Z"}, "committer": {"name": "Rich Kadel", "email": "richkadel@google.com", "date": "2020-08-12T23:11:17Z"}, "message": "Change registered \"program name\" for -Cllvm-args usage messages\n\nWhile debugging a codegen issue, I tried adding LLVM options with\nthe rustc -Cllvm-args option, and was confused by the error and usage\nmessaging.\n\nThe LLVM \"program name\" argument is set to \"rustc\", and command line\nerror messages make it look like invalid arguments are \"rustc\"\narguments, not LLVM.\n\nI changed this argument so error messages and the \"-help\" usage feedback\nis easier to understand and react to. (Clang does something similar.)", "tree": {"sha": "961ea491259b6ae1a00ba981c5f48095275ec04d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/961ea491259b6ae1a00ba981c5f48095275ec04d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d4593af78fb2929f0c46e5e4fc041092b7195f81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d4593af78fb2929f0c46e5e4fc041092b7195f81", "html_url": "https://github.com/rust-lang/rust/commit/d4593af78fb2929f0c46e5e4fc041092b7195f81", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d4593af78fb2929f0c46e5e4fc041092b7195f81/comments", "author": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "committer": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3cfc7fe78eccc754b16981704a098d7bd520e2fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cfc7fe78eccc754b16981704a098d7bd520e2fd", "html_url": "https://github.com/rust-lang/rust/commit/3cfc7fe78eccc754b16981704a098d7bd520e2fd"}], "stats": {"total": 26, "additions": 25, "deletions": 1}, "files": [{"sha": "f0b50459837e93d3bb8793ad0800e64144e69f29", "filename": "src/librustc_codegen_llvm/llvm_util.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4593af78fb2929f0c46e5e4fc041092b7195f81/src%2Flibrustc_codegen_llvm%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4593af78fb2929f0c46e5e4fc041092b7195f81/src%2Flibrustc_codegen_llvm%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fllvm_util.rs?ref=d4593af78fb2929f0c46e5e4fc041092b7195f81", "patch": "@@ -73,7 +73,8 @@ unsafe fn configure_llvm(sess: &Session) {\n                 llvm_c_strs.push(s);\n             }\n         };\n-        add(\"rustc\", true); // fake program name\n+        // Set the llvm \"program name\" to make usage and invalid argument messages more clear.\n+        add(\"rustc -Cllvm-args=\\\"...\\\" with\", true);\n         if sess.time_llvm_passes() {\n             add(\"-time-passes\", false);\n         }"}, {"sha": "289bae24f810ecb73c41a9cb0bf88ccb4d463eb0", "filename": "src/test/ui/unknown-llvm-arg.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d4593af78fb2929f0c46e5e4fc041092b7195f81/src%2Ftest%2Fui%2Funknown-llvm-arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4593af78fb2929f0c46e5e4fc041092b7195f81/src%2Ftest%2Fui%2Funknown-llvm-arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funknown-llvm-arg.rs?ref=d4593af78fb2929f0c46e5e4fc041092b7195f81", "patch": "@@ -0,0 +1,22 @@\n+// compile-flags: -Cllvm-args=-not-a-real-llvm-arg\n+// normalize-stderr-test \"--help\" -> \"-help\"\n+// normalize-stderr-test \"\\n(\\n|.)*\" -> \"\"\n+\n+// I'm seeing \"--help\" locally, but \"-help\" in CI, so I'm normalizing it to just \"-help\".\n+\n+// Note that the rustc-supplied \"program name\", given when invoking LLVM, is used by LLVM to\n+// generate user-facing error messages and a usage (--help) messages. If the program name is\n+// `rustc`, the usage message in response to `--llvm-args=\"--help\"` starts with:\n+// ```\n+//   USAGE: rustc [options]\n+// ```\n+// followed by the list of options not to `rustc` but to `llvm`.\n+//\n+// On the other hand, if the program name is set to `rustc -Cllvm-args=\"...\" with`, the usage\n+// message is more clear:\n+// ```\n+//   USAGE: rustc -Cllvm-args=\"...\" with [options]\n+// ```\n+// This test captures the effect of the current program name setting on LLVM command line\n+// error messages.\n+fn main() {}"}, {"sha": "e1d3cfea28fdf41df3e7c11796eff408ee56f106", "filename": "src/test/ui/unknown-llvm-arg.stderr", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4593af78fb2929f0c46e5e4fc041092b7195f81/src%2Ftest%2Fui%2Funknown-llvm-arg.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4593af78fb2929f0c46e5e4fc041092b7195f81/src%2Ftest%2Fui%2Funknown-llvm-arg.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funknown-llvm-arg.stderr?ref=d4593af78fb2929f0c46e5e4fc041092b7195f81", "patch": "@@ -0,0 +1 @@\n+rustc -Cllvm-args=\"...\" with: Unknown command line argument '-not-a-real-llvm-arg'.  Try: 'rustc -Cllvm-args=\"...\" with -help'\n\\ No newline at end of file"}]}