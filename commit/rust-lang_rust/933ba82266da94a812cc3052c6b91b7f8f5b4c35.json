{"sha": "933ba82266da94a812cc3052c6b91b7f8f5b4c35", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkzM2JhODIyNjZkYTk0YTgxMmNjMzA1MmM2YjkxYjdmOGY1YjRjMzU=", "commit": {"author": {"name": "msizanoen1", "email": "qtmlabs@protonmail.com", "date": "2019-11-30T12:47:59Z"}, "committer": {"name": "msizanoen1", "email": "qtmlabs@protonmail.com", "date": "2020-07-11T10:30:02Z"}, "message": "RISC-V GNU/Linux as host platform", "tree": {"sha": "39e4c6134f1fbe04e6f9f24885b305c4f15cdfa7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39e4c6134f1fbe04e6f9f24885b305c4f15cdfa7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/933ba82266da94a812cc3052c6b91b7f8f5b4c35", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/933ba82266da94a812cc3052c6b91b7f8f5b4c35", "html_url": "https://github.com/rust-lang/rust/commit/933ba82266da94a812cc3052c6b91b7f8f5b4c35", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/933ba82266da94a812cc3052c6b91b7f8f5b4c35/comments", "author": {"login": "msizanoen1", "id": 55322658, "node_id": "MDQ6VXNlcjU1MzIyNjU4", "avatar_url": "https://avatars.githubusercontent.com/u/55322658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msizanoen1", "html_url": "https://github.com/msizanoen1", "followers_url": "https://api.github.com/users/msizanoen1/followers", "following_url": "https://api.github.com/users/msizanoen1/following{/other_user}", "gists_url": "https://api.github.com/users/msizanoen1/gists{/gist_id}", "starred_url": "https://api.github.com/users/msizanoen1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msizanoen1/subscriptions", "organizations_url": "https://api.github.com/users/msizanoen1/orgs", "repos_url": "https://api.github.com/users/msizanoen1/repos", "events_url": "https://api.github.com/users/msizanoen1/events{/privacy}", "received_events_url": "https://api.github.com/users/msizanoen1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "msizanoen1", "id": 55322658, "node_id": "MDQ6VXNlcjU1MzIyNjU4", "avatar_url": "https://avatars.githubusercontent.com/u/55322658?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msizanoen1", "html_url": "https://github.com/msizanoen1", "followers_url": "https://api.github.com/users/msizanoen1/followers", "following_url": "https://api.github.com/users/msizanoen1/following{/other_user}", "gists_url": "https://api.github.com/users/msizanoen1/gists{/gist_id}", "starred_url": "https://api.github.com/users/msizanoen1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msizanoen1/subscriptions", "organizations_url": "https://api.github.com/users/msizanoen1/orgs", "repos_url": "https://api.github.com/users/msizanoen1/repos", "events_url": "https://api.github.com/users/msizanoen1/events{/privacy}", "received_events_url": "https://api.github.com/users/msizanoen1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0c03aee8b81185d65b5821518661c30ecdb42de5", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c03aee8b81185d65b5821518661c30ecdb42de5", "html_url": "https://github.com/rust-lang/rust/commit/0c03aee8b81185d65b5821518661c30ecdb42de5"}], "stats": {"total": 94, "additions": 69, "deletions": 25}, "files": [{"sha": "68cd91fee17a4f16ae4b3989601a7a38455e2bfe", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -297,6 +297,9 @@ jobs:\n           - name: dist-powerpc64le-linux\n             os: ubuntu-latest-xl\n             env: {}\n+          - name: dist-riscv64-linux\n+            os: ubuntu-latest-xl\n+            env: {}\n           - name: dist-s390x-linux\n             os: ubuntu-latest-xl\n             env: {}"}, {"sha": "594bac873a19832f14e6f0df6131d698c45abc85", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 22, "deletions": 2, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -111,6 +111,15 @@ impl Step for Llvm {\n     /// Compile LLVM for `target`.\n     fn run(self, builder: &Builder<'_>) -> PathBuf {\n         let target = self.target;\n+        let target_native = if self.target.starts_with(\"riscv\") {\n+            // RISC-V target triples in Rust is not named the same as C compiler target triples.\n+            // This converts Rust RISC-V target triples to C compiler triples.\n+            let idx = target.find('-').unwrap();\n+\n+            format!(\"riscv{}{}\", &target[5..7], &target[idx..])\n+        } else {\n+            target.to_string()\n+        };\n \n         let Meta { stamp, build_llvm_config, out_dir, root } =\n             match prebuilt_llvm_config(builder, target) {\n@@ -164,8 +173,8 @@ impl Step for Llvm {\n             .define(\"LLVM_ENABLE_BINDINGS\", \"OFF\")\n             .define(\"LLVM_ENABLE_Z3_SOLVER\", \"OFF\")\n             .define(\"LLVM_PARALLEL_COMPILE_JOBS\", builder.jobs().to_string())\n-            .define(\"LLVM_TARGET_ARCH\", target.split('-').next().unwrap())\n-            .define(\"LLVM_DEFAULT_TARGET_TRIPLE\", target);\n+            .define(\"LLVM_TARGET_ARCH\", target_native.split('-').next().unwrap())\n+            .define(\"LLVM_DEFAULT_TARGET_TRIPLE\", target_native);\n \n         if !target.contains(\"netbsd\") {\n             cfg.define(\"LLVM_ENABLE_ZLIB\", \"ON\");\n@@ -212,6 +221,17 @@ impl Step for Llvm {\n             }\n         }\n \n+        if target.starts_with(\"riscv\") {\n+            // In RISC-V, using C++ atomics require linking to `libatomic` but the LLVM build\n+            // system check cannot detect this. Therefore it is set manually here.\n+            if !builder.config.llvm_tools_enabled {\n+                cfg.define(\"CMAKE_EXE_LINKER_FLAGS\", \"-latomic\");\n+            } else {\n+                cfg.define(\"CMAKE_EXE_LINKER_FLAGS\", \"-latomic -static-libstdc++\");\n+            }\n+            cfg.define(\"CMAKE_SHARED_LINKER_FLAGS\", \"-latomic\");\n+        }\n+\n         if target.contains(\"msvc\") {\n             cfg.define(\"LLVM_USE_CRT_DEBUG\", \"MT\");\n             cfg.define(\"LLVM_USE_CRT_RELEASE\", \"MT\");"}, {"sha": "13eba269392a75ddb16e75435a85527c14005de8", "filename": "src/ci/azure-pipelines/auto.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fazure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fazure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fauto.yml?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -53,6 +53,7 @@ jobs:\n       dist-powerpc-linux: {}\n       dist-powerpc64-linux: {}\n       dist-powerpc64le-linux: {}\n+      dist-riscv64-linux: {}\n       dist-s390x-linux: {}\n       dist-x86_64-freebsd: {}\n       dist-x86_64-musl: {}"}, {"sha": "dff7c475157a239b8928090f85e6b8b9023adacf", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/Dockerfile", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2FDockerfile?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -0,0 +1,31 @@\n+FROM ubuntu:18.04\n+\n+COPY scripts/cross-apt-packages.sh /scripts/\n+RUN sh /scripts/cross-apt-packages.sh\n+\n+COPY host-x86_64/dist-riscv64-linux/crosstool-ng.sh /scripts/\n+RUN sh /scripts/crosstool-ng.sh\n+\n+COPY scripts/rustbuild-setup.sh /scripts/\n+RUN sh /scripts/rustbuild-setup.sh\n+USER rustbuild\n+WORKDIR /tmp\n+\n+COPY host-x86_64/dist-riscv64-linux/build-toolchains.sh host-x86_64/dist-riscv64-linux/riscv64-unknown-linux-gnu.config /tmp/\n+RUN ./build-toolchains.sh\n+\n+USER root\n+\n+COPY scripts/sccache.sh /scripts/\n+RUN sh /scripts/sccache.sh\n+\n+ENV PATH=$PATH:/x-tools/riscv64-unknown-linux-gnu/bin\n+\n+ENV CC_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-gcc \\\n+    AR_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-ar \\\n+    CXX_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-g++\n+\n+ENV HOSTS=riscv64gc-unknown-linux-gnu\n+\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV SCRIPT python3 ../x.py dist --target $HOSTS --host $HOSTS"}, {"sha": "6a7c022d01a5d86b1ee93392284e36653c87fdbd", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/build-toolchains.sh", "status": "renamed", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fbuild-toolchains.sh", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fbuild-toolchains.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fbuild-toolchains.sh?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -19,9 +19,9 @@ exit 1\n   set -x\n }\n \n-mkdir -p /tmp/build-riscv\n-cp riscv64-unknown-linux-gnu.config /tmp/build-riscv/.config\n-cd /tmp/build-riscv\n+mkdir build\n+cd build\n+cp ../riscv64-unknown-linux-gnu.config .config\n hide_output ct-ng build\n cd ..\n-rm -rf build-riscv\n+rm -rf build", "previous_filename": "src/ci/docker/host-x86_64/dist-various-1/build-riscv-toolchain.sh"}, {"sha": "fb067a79a5c85c93691cdf5244394982d465289f", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/crosstool-ng.sh", "status": "renamed", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fcrosstool-ng.sh", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fcrosstool-ng.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fcrosstool-ng.sh?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -1,4 +1,3 @@\n-#!/bin/bash\n set -ex\n \n # Mirrored from https://github.com/crosstool-ng/crosstool-ng/archive/crosstool-ng-1.24.0.tar.gz", "previous_filename": "src/ci/docker/host-x86_64/dist-various-1/crosstool-ng.sh"}, {"sha": "dbb4be550dd70072efaaa4b525c901892ffc75e4", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/riscv64-unknown-linux-gnu.config", "status": "renamed", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Friscv64-unknown-linux-gnu.config", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Friscv64-unknown-linux-gnu.config", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Friscv64-unknown-linux-gnu.config?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -17,8 +17,6 @@ CT_CONFIGURE_has_gnu_m4_1_4_12_or_newer=y\n CT_CONFIGURE_has_python_3_4_or_newer=y\n CT_CONFIGURE_has_bison_2_7_or_newer=y\n CT_CONFIGURE_has_python=y\n-CT_CONFIGURE_has_dtc=y\n-CT_CONFIGURE_has_svn=y\n CT_CONFIGURE_has_git=y\n CT_CONFIGURE_has_md5sum=y\n CT_CONFIGURE_has_sha1sum=y", "previous_filename": "src/ci/docker/host-x86_64/dist-various-1/riscv64-unknown-linux-gnu.config"}, {"sha": "ac228cfe01d800cb777297c58631957487e42d3d", "filename": "src/ci/docker/host-x86_64/dist-various-1/Dockerfile", "status": "modified", "additions": 0, "deletions": 16, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -47,18 +47,6 @@ RUN add-apt-repository ppa:team-gcc-arm-embedded/ppa && \\\n     apt-get update && \\\n     apt-get install -y --no-install-recommends gcc-arm-embedded\n \n-COPY scripts/rustbuild-setup.sh host-x86_64/dist-various-1/build-riscv-toolchain.sh host-x86_64/dist-various-1/riscv64-unknown-linux-gnu.config host-x86_64/dist-various-1/crosstool-ng.sh /build/\n-RUN ./crosstool-ng.sh\n-\n-# Crosstool-ng will refuse to build as root\n-RUN sh ./rustbuild-setup.sh\n-USER rustbuild\n-\n-RUN ./build-riscv-toolchain.sh\n-\n-USER root\n-ENV PATH=/x-tools/riscv64-unknown-linux-gnu/bin:$PATH\n-\n COPY host-x86_64/dist-various-1/build-rumprun.sh /build\n RUN ./build-rumprun.sh\n \n@@ -158,7 +146,6 @@ ENV TARGETS=$TARGETS,riscv32imc-unknown-none-elf\n ENV TARGETS=$TARGETS,riscv32imac-unknown-none-elf\n ENV TARGETS=$TARGETS,riscv64imac-unknown-none-elf\n ENV TARGETS=$TARGETS,riscv64gc-unknown-none-elf\n-ENV TARGETS=$TARGETS,riscv64gc-unknown-linux-gnu\n ENV TARGETS=$TARGETS,armebv7r-none-eabi\n ENV TARGETS=$TARGETS,armebv7r-none-eabihf\n ENV TARGETS=$TARGETS,armv7r-none-eabi\n@@ -186,9 +173,6 @@ ENV CC_mipsel_unknown_linux_musl=mipsel-openwrt-linux-gcc \\\n     CFLAGS_aarch64_unknown_none_softfloat=-mstrict-align -march=armv8-a+nofp+nosimd \\\n     CC_aarch64_unknown_none=aarch64-none-elf-gcc \\\n     CFLAGS_aarch64_unknown_none=-mstrict-align -march=armv8-a+fp+simd \\\n-    CC_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-gcc \\\n-    AR_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-ar \\\n-    CXX_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-g++ \\\n     CC_riscv32i_unknown_none_elf=false \\\n     CC_riscv32imc_unknown_none_elf=false \\\n     CC_riscv32imac_unknown_none_elf=false \\"}, {"sha": "06cda99a3fe46a3d27909332af787cc8155cfc6e", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -341,6 +341,9 @@ jobs:\n           - name: dist-powerpc64le-linux\n             <<: *job-linux-xl\n \n+          - name: dist-riscv64-linux\n+            <<: *job-linux-xl\n+\n           - name: dist-s390x-linux\n             <<: *job-linux-xl\n "}, {"sha": "5145b3b5e6fcc9cf423c52a0d250a8183213f9c1", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/933ba82266da94a812cc3052c6b91b7f8f5b4c35/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=933ba82266da94a812cc3052c6b91b7f8f5b4c35", "patch": "@@ -275,6 +275,11 @@ fn main() {\n         \"stdc++\"\n     };\n \n+    // RISC-V requires libatomic for sub-word atomic operations\n+    if target.starts_with(\"riscv\") {\n+        println!(\"cargo:rustc-link-lib=atomic\");\n+    }\n+\n     // C++ runtime library\n     if !target.contains(\"msvc\") {\n         if let Some(s) = llvm_static_stdcpp {"}]}