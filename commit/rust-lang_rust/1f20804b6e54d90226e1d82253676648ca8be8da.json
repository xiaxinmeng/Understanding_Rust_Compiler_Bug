{"sha": "1f20804b6e54d90226e1d82253676648ca8be8da", "node_id": "C_kwDOAAsO6NoAKDFmMjA4MDRiNmU1NGQ5MDIyNmUxZDgyMjUzNjc2NjQ4Y2E4YmU4ZGE", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2023-01-30T16:50:02Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2023-01-30T16:50:02Z"}, "message": "Improve \"match to let-else\" assist", "tree": {"sha": "c512196aa2c8cff43cd064b6d41e8459d12442e4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c512196aa2c8cff43cd064b6d41e8459d12442e4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f20804b6e54d90226e1d82253676648ca8be8da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f20804b6e54d90226e1d82253676648ca8be8da", "html_url": "https://github.com/rust-lang/rust/commit/1f20804b6e54d90226e1d82253676648ca8be8da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f20804b6e54d90226e1d82253676648ca8be8da/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1b257f4eb4fef74b42fd7135d1cf3884e8b51c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1b257f4eb4fef74b42fd7135d1cf3884e8b51c9", "html_url": "https://github.com/rust-lang/rust/commit/f1b257f4eb4fef74b42fd7135d1cf3884e8b51c9"}], "stats": {"total": 75, "additions": 60, "deletions": 15}, "files": [{"sha": "7896d3a66d4b8ffcb042af0116b78fa17cfdc7e5", "filename": "crates/ide-assists/src/handlers/convert_match_to_let_else.rs", "status": "modified", "additions": 60, "deletions": 15, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/1f20804b6e54d90226e1d82253676648ca8be8da/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_match_to_let_else.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f20804b6e54d90226e1d82253676648ca8be8da/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_match_to_let_else.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_match_to_let_else.rs?ref=1f20804b6e54d90226e1d82253676648ca8be8da", "patch": "@@ -30,7 +30,7 @@ use crate::{\n // ```\n pub(crate) fn convert_match_to_let_else(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<()> {\n     let let_stmt: ast::LetStmt = ctx.find_node_at_offset()?;\n-    let binding = find_binding(let_stmt.pat()?)?;\n+    let binding = let_stmt.pat()?;\n \n     let initializer = match let_stmt.initializer() {\n         Some(ast::Expr::MatchExpr(it)) => it,\n@@ -47,7 +47,12 @@ pub(crate) fn convert_match_to_let_else(acc: &mut Assists, ctx: &AssistContext<'\n         return None;\n     }\n \n-    let diverging_arm_expr = diverging_arm.expr()?;\n+    let diverging_arm_expr = match diverging_arm.expr()? {\n+        ast::Expr::BlockExpr(block) if block.modifier().is_none() && block.label().is_none() => {\n+            block.to_string()\n+        }\n+        other => format!(\"{{ {other} }}\"),\n+    };\n     let extracting_arm_pat = extracting_arm.pat()?;\n     let extracted_variable = find_extracted_variable(ctx, &extracting_arm)?;\n \n@@ -56,24 +61,16 @@ pub(crate) fn convert_match_to_let_else(acc: &mut Assists, ctx: &AssistContext<'\n         \"Convert match to let-else\",\n         let_stmt.syntax().text_range(),\n         |builder| {\n-            let extracting_arm_pat = rename_variable(&extracting_arm_pat, extracted_variable, binding);\n+            let extracting_arm_pat =\n+                rename_variable(&extracting_arm_pat, extracted_variable, binding);\n             builder.replace(\n                 let_stmt.syntax().text_range(),\n-                format!(\"let {extracting_arm_pat} = {initializer_expr} else {{ {diverging_arm_expr} }};\")\n+                format!(\"let {extracting_arm_pat} = {initializer_expr} else {diverging_arm_expr};\"),\n             )\n         },\n     )\n }\n \n-// Given a pattern, find the name introduced to the surrounding scope.\n-fn find_binding(pat: ast::Pat) -> Option<ast::IdentPat> {\n-    if let ast::Pat::IdentPat(ident) = pat {\n-        Some(ident)\n-    } else {\n-        None\n-    }\n-}\n-\n // Given a match expression, find extracting and diverging arms.\n fn find_arms(\n     ctx: &AssistContext<'_>,\n@@ -124,7 +121,7 @@ fn find_extracted_variable(ctx: &AssistContext<'_>, arm: &ast::MatchArm) -> Opti\n }\n \n // Rename `extracted` with `binding` in `pat`.\n-fn rename_variable(pat: &ast::Pat, extracted: ast::Name, binding: ast::IdentPat) -> SyntaxNode {\n+fn rename_variable(pat: &ast::Pat, extracted: ast::Name, binding: ast::Pat) -> SyntaxNode {\n     let syntax = pat.syntax().clone_for_update();\n     let extracted_syntax = syntax.covering_element(extracted.syntax().text_range());\n \n@@ -136,7 +133,7 @@ fn rename_variable(pat: &ast::Pat, extracted: ast::Name, binding: ast::IdentPat)\n         if let Some(name_ref) = record_pat_field.field_name() {\n             ted::replace(\n                 record_pat_field.syntax(),\n-                ast::make::record_pat_field(ast::make::name_ref(&name_ref.text()), binding.into())\n+                ast::make::record_pat_field(ast::make::name_ref(&name_ref.text()), binding)\n                     .syntax()\n                     .clone_for_update(),\n             );\n@@ -410,4 +407,52 @@ fn foo(opt: Option<i32>) -> Option<i32> {\n     \"#,\n         );\n     }\n+\n+    #[test]\n+    fn complex_pattern() {\n+        check_assist(\n+            convert_match_to_let_else,\n+            r#\"\n+//- minicore: option\n+fn f() {\n+    let (x, y) = $0match Some((0, 1)) {\n+        Some(it) => it,\n+        None => return,\n+    };\n+}\n+\"#,\n+            r#\"\n+fn f() {\n+    let Some((x, y)) = Some((0, 1)) else { return };\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn diverging_block() {\n+        check_assist(\n+            convert_match_to_let_else,\n+            r#\"\n+//- minicore: option\n+fn f() {\n+    let x = $0match Some(()) {\n+        Some(it) => it,\n+        None => {//comment\n+            println!(\"nope\");\n+            return\n+        },\n+    };\n+}\n+\"#,\n+            r#\"\n+fn f() {\n+    let Some(x) = Some(()) else {//comment\n+            println!(\"nope\");\n+            return\n+        };\n+}\n+\"#,\n+        );\n+    }\n }"}]}