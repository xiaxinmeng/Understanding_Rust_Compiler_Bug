{"sha": "f870876d925b5dd115c9d792783dc6208e33d913", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4NzA4NzZkOTI1YjVkZDExNWM5ZDc5Mjc4M2RjNjIwOGUzM2Q5MTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-02T15:04:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-02T15:04:35Z"}, "message": "Auto merge of #6659 - phlip9:let_and_return_fix, r=phansch\n\nFix let_and_return false positive\n\nThe issue:\n\nSee this Rust playground link: https://play.rust-lang.org/?edition=2018&gist=12cb5d1e7527f8c37743b87fc4a53748\n\nRun the above with clippy to see the following warning:\n\n```\nwarning: returning the result of a `let` binding from a block\n  --> src/main.rs:24:5\n   |\n23 |     let value = Foo::new(&x).value();\n   |     --------------------------------- unnecessary `let` binding\n24 |     value\n   |     ^^^^^\n   |\n   = note: `#[warn(clippy::let_and_return)]` on by default\n   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#let_and_return\nhelp: return the expression directly\n   |\n23 |\n24 |     Foo::new(&x).value()\n   |\n```\n\nImplementing the suggested fix, removing the temporary let binding,\nyields a compiler error:\n\n```\nerror[E0597]: `x` does not live long enough\n  --> src/main.rs:23:14\n   |\n23 |     Foo::new(&x).value()\n   |     ---------^^-\n   |     |        |\n   |     |        borrowed value does not live long enough\n   |     a temporary with access to the borrow is created here ...\n24 | }\n   | -\n   | |\n   | `x` dropped here while still borrowed\n   | ... and the borrow might be used here, when that temporary is dropped and runs the `Drop` code for type `Foo`\n   |\n   = note: the temporary is part of an expression at the end of a block;\n           consider forcing this temporary to be dropped sooner, before the block's local variables are dropped\nhelp: for example, you could save the expression's value in a new local variable `x` and then make `x` be the expression at the end of the block\n   |\n23 |     let x = Foo::new(&x).value(); x\n   |     ^^^^^^^                     ^^^\n```\n\nThe fix:\n\nOf course, clippy looks like it should already handle this edge case;\nhowever, it appears `utils::fn_def_id` is not returning a `DefId` for\n`Foo::new`. Changing the `qpath_res` lookup to use the child Path\n`hir_id` instead of the parent Call `hir_id` fixes the issue.\n\nchangelog: none", "tree": {"sha": "208a723997117e6ff8fed3ce579b0b873fb312c3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/208a723997117e6ff8fed3ce579b0b873fb312c3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f870876d925b5dd115c9d792783dc6208e33d913", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f870876d925b5dd115c9d792783dc6208e33d913", "html_url": "https://github.com/rust-lang/rust/commit/f870876d925b5dd115c9d792783dc6208e33d913", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f870876d925b5dd115c9d792783dc6208e33d913/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d82ac5e732310518d0c420c637376cc3a8ded3d", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d82ac5e732310518d0c420c637376cc3a8ded3d", "html_url": "https://github.com/rust-lang/rust/commit/8d82ac5e732310518d0c420c637376cc3a8ded3d"}, {"sha": "7f1595e18f542f2caf209a05dd090b4a2ebd3b8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f1595e18f542f2caf209a05dd090b4a2ebd3b8a", "html_url": "https://github.com/rust-lang/rust/commit/7f1595e18f542f2caf209a05dd090b4a2ebd3b8a"}], "stats": {"total": 17, "additions": 14, "deletions": 3}, "files": [{"sha": "ae35c92cd40b4691ad9005c4350b1d9feef1a1ab", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f870876d925b5dd115c9d792783dc6208e33d913/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f870876d925b5dd115c9d792783dc6208e33d913/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=f870876d925b5dd115c9d792783dc6208e33d913", "patch": "@@ -1532,10 +1532,11 @@ pub fn fn_def_id(cx: &LateContext<'_>, expr: &Expr<'_>) -> Option<DefId> {\n         ExprKind::Call(\n             Expr {\n                 kind: ExprKind::Path(qpath),\n+                hir_id: path_hir_id,\n                 ..\n             },\n             ..,\n-        ) => cx.typeck_results().qpath_res(qpath, expr.hir_id).opt_def_id(),\n+        ) => cx.typeck_results().qpath_res(qpath, *path_hir_id).opt_def_id(),\n         _ => None,\n     }\n }"}, {"sha": "e3561863c1e1ff7f00f1e52703e808cdb1c64e63", "filename": "tests/ui/let_and_return.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f870876d925b5dd115c9d792783dc6208e33d913/tests%2Fui%2Flet_and_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f870876d925b5dd115c9d792783dc6208e33d913/tests%2Fui%2Flet_and_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flet_and_return.rs?ref=f870876d925b5dd115c9d792783dc6208e33d913", "patch": "@@ -117,7 +117,11 @@ mod no_lint_if_stmt_borrows {\n             fn drop(&mut self) {}\n         }\n \n-        impl Foo<'_> {\n+        impl<'a> Foo<'a> {\n+            fn new(inner: &'a Inner) -> Self {\n+                Self { inner }\n+            }\n+\n             fn value(&self) -> i32 {\n                 42\n             }\n@@ -132,6 +136,12 @@ mod no_lint_if_stmt_borrows {\n             let value = some_foo(&x).value();\n             value\n         }\n+\n+        fn test2() -> i32 {\n+            let x = Inner {};\n+            let value = Foo::new(&x).value();\n+            value\n+        }\n     }\n }\n "}, {"sha": "a6941dabeb88d56a722fa07b7efbcf620c395cea", "filename": "tests/ui/let_and_return.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f870876d925b5dd115c9d792783dc6208e33d913/tests%2Fui%2Flet_and_return.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f870876d925b5dd115c9d792783dc6208e33d913/tests%2Fui%2Flet_and_return.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flet_and_return.stderr?ref=f870876d925b5dd115c9d792783dc6208e33d913", "patch": "@@ -28,7 +28,7 @@ LL |         5\n    |\n \n error: returning the result of a `let` binding from a block\n-  --> $DIR/let_and_return.rs:154:13\n+  --> $DIR/let_and_return.rs:164:13\n    |\n LL |             let clone = Arc::clone(&self.foo);\n    |             ---------------------------------- unnecessary `let` binding"}]}