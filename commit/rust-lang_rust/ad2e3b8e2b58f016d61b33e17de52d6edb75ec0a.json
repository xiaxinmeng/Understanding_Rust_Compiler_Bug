{"sha": "ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkMmUzYjhlMmI1OGYwMTZkNjFiMzNlMTdkZTUyZDZlZGI3NWVjMGE=", "commit": {"author": {"name": "Marcus Klaas", "email": "mail@marcusklaas.nl", "date": "2015-10-02T09:47:03Z"}, "committer": {"name": "Marcus Klaas", "email": "mail@marcusklaas.nl", "date": "2015-10-02T09:47:03Z"}, "message": "Format indices", "tree": {"sha": "378aea0279b01dc329551c8a4fecbffe866b64cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/378aea0279b01dc329551c8a4fecbffe866b64cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "html_url": "https://github.com/rust-lang/rust/commit/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "603f2034a512317c530473c8c229f8685ed18bd9", "url": "https://api.github.com/repos/rust-lang/rust/commits/603f2034a512317c530473c8c229f8685ed18bd9", "html_url": "https://github.com/rust-lang/rust/commit/603f2034a512317c530473c8c229f8685ed18bd9"}], "stats": {"total": 53, "additions": 49, "deletions": 4}, "files": [{"sha": "75630eb8301468efe3332ce8d1e5c01f615c8144", "filename": "src/expr.rs", "status": "modified", "additions": 36, "deletions": 4, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "patch": "@@ -111,8 +111,6 @@ impl Rewrite for ast::Expr {\n                                 offset,\n                                 true)\n             }\n-            // We reformat it ourselves because rustc gives us a bad span\n-            // for ranges, see rust#27162\n             ast::Expr_::ExprRange(ref left, ref right) => {\n                 rewrite_range(context,\n                               left.as_ref().map(|e| &**e),\n@@ -182,10 +180,12 @@ impl Rewrite for ast::Expr {\n             ast::Expr_::ExprCast(ref expr, ref ty) => {\n                 rewrite_cast(expr, ty, context, width, offset)\n             }\n+            ast::Expr_::ExprIndex(ref expr, ref index) => {\n+                rewrite_index(expr, index, context, width, offset)\n+            }\n             // We do not format these expressions yet, but they should still\n             // satisfy our width restrictions.\n             ast::Expr_::ExprInPlace(..) |\n-            ast::Expr_::ExprIndex(..) |\n             ast::Expr_::ExprInlineAsm(..) |\n             ast::Expr_::ExprRepeat(..) => {\n                 wrap_str(context.snippet(self.span),\n@@ -197,6 +197,38 @@ impl Rewrite for ast::Expr {\n     }\n }\n \n+fn rewrite_index(expr: &ast::Expr,\n+                 index: &ast::Expr,\n+                 context: &RewriteContext,\n+                 width: usize,\n+                 offset: Indent)\n+                 -> Option<String> {\n+    let max_width = try_opt!(width.checked_sub(\"[]\".len()));\n+\n+    binary_search(1,\n+                  max_width,\n+                  |expr_budget| {\n+                      let expr_str = match expr.rewrite(context, expr_budget, offset) {\n+                          Some(result) => result,\n+                          None => return Err(Ordering::Greater),\n+                      };\n+\n+                      let last_line_width = last_line_width(&expr_str);\n+                      let index_budget = match max_width.checked_sub(last_line_width) {\n+                          Some(b) => b,\n+                          None => return Err(Ordering::Less),\n+                      };\n+                      let index_indent = offset + last_line_width + \"[\".len();\n+\n+                      let index_str = match index.rewrite(context, index_budget, index_indent) {\n+                          Some(result) => result,\n+                          None => return Err(Ordering::Less),\n+                      };\n+\n+                      Ok(format!(\"{}[{}]\", expr_str, index_str))\n+                  })\n+}\n+\n fn rewrite_cast(expr: &ast::Expr,\n                 ty: &ast::Ty,\n                 context: &RewriteContext,\n@@ -218,7 +250,7 @@ fn rewrite_cast(expr: &ast::Expr,\n                           Some(b) => b,\n                           None => return Err(Ordering::Less),\n                       };\n-                      let ty_indent = offset + last_line_width;\n+                      let ty_indent = offset + last_line_width + \" as \".len();\n \n                       let ty_str = match ty.rewrite(context, ty_budget, ty_indent) {\n                           Some(result) => result,"}, {"sha": "16b9047dcf1e717f391d7ea94e4be00a7e304bfb", "filename": "tests/source/expr.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/tests%2Fsource%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/tests%2Fsource%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fexpr.rs?ref=ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "patch": "@@ -197,3 +197,8 @@ fn casts() {\n         as SomeTraitXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX;\n     let slightly_longer_trait = yyyyyyyyy + yyyyyyyyyyy as SomeTraitYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY;\n }\n+\n+fn indices() {\n+    let x = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa+bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb+cccccccccccccccc) [ x + y + z ];\n+    let y = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb + cccccccccccccccc)[ xxxxx + yyyyy + zzzzz ];\n+}"}, {"sha": "ab25d489c1b3bf24df5ec4e59666abb7abacbbc7", "filename": "tests/target/expr.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/tests%2Ftarget%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a/tests%2Ftarget%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fexpr.rs?ref=ad2e3b8e2b58f016d61b33e17de52d6edb75ec0a", "patch": "@@ -208,3 +208,11 @@ fn casts() {\n     let slightly_longer_trait = yyyyyyyyy +\n                                 yyyyyyyyyyy as SomeTraitYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY;\n }\n+\n+fn indices() {\n+    let x = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb + cccccccccccccccc)[x +\n+                                                                                                y +\n+                                                                                                z];\n+    let y = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb +\n+             cccccccccccccccc)[xxxxx + yyyyy + zzzzz];\n+}"}]}