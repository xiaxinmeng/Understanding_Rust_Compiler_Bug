{"sha": "e591b83185ba60cec09225d5ed6b41325a7a331f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1OTFiODMxODViYTYwY2VjMDkyMjVkNWVkNmI0MTMyNWE3YTMzMWY=", "commit": {"author": {"name": "Smitty", "email": "me@smitop.com", "date": "2021-05-02T16:25:00Z"}, "committer": {"name": "Smitty", "email": "me@smitop.com", "date": "2021-05-02T16:25:00Z"}, "message": "UB if f*_fast intrinsic called with nonfinite value", "tree": {"sha": "770720f3ca0869f4ae80e526f68f4f27c433dd42", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/770720f3ca0869f4ae80e526f68f4f27c433dd42"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e591b83185ba60cec09225d5ed6b41325a7a331f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e591b83185ba60cec09225d5ed6b41325a7a331f", "html_url": "https://github.com/rust-lang/rust/commit/e591b83185ba60cec09225d5ed6b41325a7a331f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e591b83185ba60cec09225d5ed6b41325a7a331f/comments", "author": {"login": "syvb", "id": 10530973, "node_id": "MDQ6VXNlcjEwNTMwOTcz", "avatar_url": "https://avatars.githubusercontent.com/u/10530973?v=4", "gravatar_id": "", "url": "https://api.github.com/users/syvb", "html_url": "https://github.com/syvb", "followers_url": "https://api.github.com/users/syvb/followers", "following_url": "https://api.github.com/users/syvb/following{/other_user}", "gists_url": "https://api.github.com/users/syvb/gists{/gist_id}", "starred_url": "https://api.github.com/users/syvb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/syvb/subscriptions", "organizations_url": "https://api.github.com/users/syvb/orgs", "repos_url": "https://api.github.com/users/syvb/repos", "events_url": "https://api.github.com/users/syvb/events{/privacy}", "received_events_url": "https://api.github.com/users/syvb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "syvb", "id": 10530973, "node_id": "MDQ6VXNlcjEwNTMwOTcz", "avatar_url": "https://avatars.githubusercontent.com/u/10530973?v=4", "gravatar_id": "", "url": "https://api.github.com/users/syvb", "html_url": "https://github.com/syvb", "followers_url": "https://api.github.com/users/syvb/followers", "following_url": "https://api.github.com/users/syvb/following{/other_user}", "gists_url": "https://api.github.com/users/syvb/gists{/gist_id}", "starred_url": "https://api.github.com/users/syvb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/syvb/subscriptions", "organizations_url": "https://api.github.com/users/syvb/orgs", "repos_url": "https://api.github.com/users/syvb/repos", "events_url": "https://api.github.com/users/syvb/events{/privacy}", "received_events_url": "https://api.github.com/users/syvb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0e3038571cb1dd5c50aca28e4fe4c325ad5b2e98", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e3038571cb1dd5c50aca28e4fe4c325ad5b2e98", "html_url": "https://github.com/rust-lang/rust/commit/0e3038571cb1dd5c50aca28e4fe4c325ad5b2e98"}], "stats": {"total": 51, "additions": 51, "deletions": 0}, "files": [{"sha": "cae9c813c1797cc6e911d3abcf33e9166dc83246", "filename": "src/shims/intrinsics.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e591b83185ba60cec09225d5ed6b41325a7a331f/src%2Fshims%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e591b83185ba60cec09225d5ed6b41325a7a331f/src%2Fshims%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fintrinsics.rs?ref=e591b83185ba60cec09225d5ed6b41325a7a331f", "patch": "@@ -173,6 +173,36 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                     \"frem_fast\" => mir::BinOp::Rem,\n                     _ => bug!(),\n                 };\n+                let a_valid = match a.layout.ty.kind() {\n+                    ty::Float(FloatTy::F32) => a.to_scalar()?.to_f32()?.is_finite(),\n+                    ty::Float(FloatTy::F64) => a.to_scalar()?.to_f64()?.is_finite(),\n+                    _ => bug!(\n+                        \"`{}` called with non-float input type {:?}\",\n+                        intrinsic_name,\n+                        a.layout.ty\n+                    ),\n+                };\n+                if !a_valid {\n+                    throw_ub_format!(\n+                        \"`{}` intrinsic called with non-finite value as first parameter\",\n+                        intrinsic_name,\n+                    );\n+                }\n+                let b_valid = match b.layout.ty.kind() {\n+                    ty::Float(FloatTy::F32) => b.to_scalar()?.to_f32()?.is_finite(),\n+                    ty::Float(FloatTy::F64) => b.to_scalar()?.to_f64()?.is_finite(),\n+                    _ => bug!(\n+                        \"`{}` called with non-float input type {:?}\",\n+                        intrinsic_name,\n+                        b.layout.ty\n+                    ),\n+                };\n+                if !b_valid {\n+                    throw_ub_format!(\n+                        \"`{}` intrinsic called with non-finite value as second parameter\",\n+                        intrinsic_name,\n+                    );\n+                }\n                 this.binop_ignore_overflow(op, &a, &b, dest)?;\n             }\n "}, {"sha": "470ebe620050ffb95ee881916193d248cbc7a83c", "filename": "tests/compile-fail/fast_math_both.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e591b83185ba60cec09225d5ed6b41325a7a331f/tests%2Fcompile-fail%2Ffast_math_both.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e591b83185ba60cec09225d5ed6b41325a7a331f/tests%2Fcompile-fail%2Ffast_math_both.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Ffast_math_both.rs?ref=e591b83185ba60cec09225d5ed6b41325a7a331f", "patch": "@@ -0,0 +1,7 @@\n+#![feature(core_intrinsics)]\n+\n+fn main() {\n+    unsafe {\n+        let _x: f32 = core::intrinsics::frem_fast(f32::NAN, 3.2); //~ ERROR `frem_fast` intrinsic called with non-finite value as first parameter\n+    }\n+}"}, {"sha": "184476a4741717173121222ea97750ffca4d18e4", "filename": "tests/compile-fail/fast_math_first.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e591b83185ba60cec09225d5ed6b41325a7a331f/tests%2Fcompile-fail%2Ffast_math_first.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e591b83185ba60cec09225d5ed6b41325a7a331f/tests%2Fcompile-fail%2Ffast_math_first.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Ffast_math_first.rs?ref=e591b83185ba60cec09225d5ed6b41325a7a331f", "patch": "@@ -0,0 +1,7 @@\n+#![feature(core_intrinsics)]\n+\n+fn main() {\n+    unsafe {\n+        let _x: f32 = core::intrinsics::fsub_fast(f32::NAN, f32::NAN); //~ ERROR `fsub_fast` intrinsic called with non-finite value as first parameter\n+    }\n+}"}, {"sha": "114197d757932a76927824c4c8d9c6f12c1da6c5", "filename": "tests/compile-fail/fast_math_second.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e591b83185ba60cec09225d5ed6b41325a7a331f/tests%2Fcompile-fail%2Ffast_math_second.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e591b83185ba60cec09225d5ed6b41325a7a331f/tests%2Fcompile-fail%2Ffast_math_second.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Ffast_math_second.rs?ref=e591b83185ba60cec09225d5ed6b41325a7a331f", "patch": "@@ -0,0 +1,7 @@\n+#![feature(core_intrinsics)]\n+\n+fn main() {\n+    unsafe {\n+        let _x: f32 = core::intrinsics::fmul_fast(3.4f32, f32::NAN); //~ ERROR `fmul_fast` intrinsic called with non-finite value as second parameter\n+    }\n+}"}]}