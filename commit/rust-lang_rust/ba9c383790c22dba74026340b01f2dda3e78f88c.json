{"sha": "ba9c383790c22dba74026340b01f2dda3e78f88c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhOWMzODM3OTBjMjJkYmE3NDAyNjM0MGIwMWYyZGRhM2U3OGY4OGM=", "commit": {"author": {"name": "J. Ryan Stinnett", "email": "jryans@gmail.com", "date": "2015-10-04T09:57:32Z"}, "committer": {"name": "J. Ryan Stinnett", "email": "jryans@gmail.com", "date": "2015-10-04T09:57:32Z"}, "message": "Only report error for first issued loan with conflict\n\nChange error reporting of conflicting loans to stop earlier after printing\nan error for a given borrow, instead of proceeding to error on possibly every\nissued loan.  This keeps us down to O(n) errors (for n problem lines), instead\nof O(n^2) errors in some cases.\n\nFixes #27485.", "tree": {"sha": "fb9f27691f7ba19385ba990ddf8fc8cb928f933b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fb9f27691f7ba19385ba990ddf8fc8cb928f933b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ba9c383790c22dba74026340b01f2dda3e78f88c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ba9c383790c22dba74026340b01f2dda3e78f88c", "html_url": "https://github.com/rust-lang/rust/commit/ba9c383790c22dba74026340b01f2dda3e78f88c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ba9c383790c22dba74026340b01f2dda3e78f88c/comments", "author": {"login": "jryans", "id": 279572, "node_id": "MDQ6VXNlcjI3OTU3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/279572?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jryans", "html_url": "https://github.com/jryans", "followers_url": "https://api.github.com/users/jryans/followers", "following_url": "https://api.github.com/users/jryans/following{/other_user}", "gists_url": "https://api.github.com/users/jryans/gists{/gist_id}", "starred_url": "https://api.github.com/users/jryans/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jryans/subscriptions", "organizations_url": "https://api.github.com/users/jryans/orgs", "repos_url": "https://api.github.com/users/jryans/repos", "events_url": "https://api.github.com/users/jryans/events{/privacy}", "received_events_url": "https://api.github.com/users/jryans/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jryans", "id": 279572, "node_id": "MDQ6VXNlcjI3OTU3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/279572?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jryans", "html_url": "https://github.com/jryans", "followers_url": "https://api.github.com/users/jryans/followers", "following_url": "https://api.github.com/users/jryans/following{/other_user}", "gists_url": "https://api.github.com/users/jryans/gists{/gist_id}", "starred_url": "https://api.github.com/users/jryans/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jryans/subscriptions", "organizations_url": "https://api.github.com/users/jryans/orgs", "repos_url": "https://api.github.com/users/jryans/repos", "events_url": "https://api.github.com/users/jryans/events{/privacy}", "received_events_url": "https://api.github.com/users/jryans/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bfb26033af68949646081429040db606a044db22", "url": "https://api.github.com/repos/rust-lang/rust/commits/bfb26033af68949646081429040db606a044db22", "html_url": "https://github.com/rust-lang/rust/commit/bfb26033af68949646081429040db606a044db22"}], "stats": {"total": 46, "additions": 38, "deletions": 8}, "files": [{"sha": "ff5d364b968e578c92fa5f8ad1a8f13e5b7e1d0e", "filename": "src/librustc_borrowck/borrowck/check_loans.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ba9c383790c22dba74026340b01f2dda3e78f88c/src%2Flibrustc_borrowck%2Fborrowck%2Fcheck_loans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba9c383790c22dba74026340b01f2dda3e78f88c/src%2Flibrustc_borrowck%2Fborrowck%2Fcheck_loans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_borrowck%2Fborrowck%2Fcheck_loans.rs?ref=ba9c383790c22dba74026340b01f2dda3e78f88c", "patch": "@@ -363,13 +363,14 @@ impl<'a, 'tcx> CheckLoanCtxt<'a, 'tcx> {\n         let new_loan_indices = self.loans_generated_by(node);\n         debug!(\"new_loan_indices = {:?}\", new_loan_indices);\n \n-        self.each_issued_loan(node, |issued_loan| {\n-            for &new_loan_index in &new_loan_indices {\n+        for &new_loan_index in &new_loan_indices {\n+            self.each_issued_loan(node, |issued_loan| {\n                 let new_loan = &self.all_loans[new_loan_index];\n-                self.report_error_if_loans_conflict(issued_loan, new_loan);\n-            }\n-            true\n-        });\n+                // Only report an error for the first issued loan that conflicts\n+                // to avoid O(n^2) errors.\n+                self.report_error_if_loans_conflict(issued_loan, new_loan)\n+            });\n+        }\n \n         for (i, &x) in new_loan_indices.iter().enumerate() {\n             let old_loan = &self.all_loans[x];\n@@ -382,7 +383,8 @@ impl<'a, 'tcx> CheckLoanCtxt<'a, 'tcx> {\n \n     pub fn report_error_if_loans_conflict(&self,\n                                           old_loan: &Loan<'tcx>,\n-                                          new_loan: &Loan<'tcx>) {\n+                                          new_loan: &Loan<'tcx>)\n+                                          -> bool {\n         //! Checks whether `old_loan` and `new_loan` can safely be issued\n         //! simultaneously.\n \n@@ -397,7 +399,7 @@ impl<'a, 'tcx> CheckLoanCtxt<'a, 'tcx> {\n         self.report_error_if_loan_conflicts_with_restriction(\n             old_loan, new_loan, old_loan, new_loan) &&\n         self.report_error_if_loan_conflicts_with_restriction(\n-            new_loan, old_loan, old_loan, new_loan);\n+            new_loan, old_loan, old_loan, new_loan)\n     }\n \n     pub fn report_error_if_loan_conflicts_with_restriction(&self,"}, {"sha": "38e0e27a7b98e792e828f44bb7ad64ec83f426a0", "filename": "src/test/compile-fail/borrowck-mut-borrow-linear-errors.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ba9c383790c22dba74026340b01f2dda3e78f88c/src%2Ftest%2Fcompile-fail%2Fborrowck-mut-borrow-linear-errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba9c383790c22dba74026340b01f2dda3e78f88c/src%2Ftest%2Fcompile-fail%2Fborrowck-mut-borrow-linear-errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck-mut-borrow-linear-errors.rs?ref=ba9c383790c22dba74026340b01f2dda3e78f88c", "patch": "@@ -0,0 +1,28 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test to ensure we only report an error for the first issued loan that\n+// conflicts with a new loan, as opposed to every issued loan.  This keeps us\n+// down to O(n) errors (for n problem lines), instead of O(n^2) errors.\n+\n+fn main() {\n+    let mut x = 1;\n+    let mut addr;\n+    loop {\n+        match 1 {\n+            1 => { addr = &mut x; }\n+            //~^ ERROR cannot borrow `x` as mutable more than once at a time\n+            2 => { addr = &mut x; }\n+            //~^ ERROR cannot borrow `x` as mutable more than once at a time\n+            _ => { addr = &mut x; }\n+            //~^ ERROR cannot borrow `x` as mutable more than once at a time\n+        }\n+    }\n+}"}]}