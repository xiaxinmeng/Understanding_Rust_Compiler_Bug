{"sha": "cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNkNmU5ZjRmODM0Zjg0OWEzZGFmZDdjZjA3ODZmM2M5N2JjM2JiMzc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-28T20:51:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-28T20:51:39Z"}, "message": "auto merge of #10110 : catamorphism/rust/rustpkg-dependency-build-dir, r=metajack\n\nr? @metajack When invoked with the --rust-path-hack flag, rustpkg was correctly building\r\nthe package into the default workspace (and not into the build/ subdirectory of the\r\nparent directory of the source directory), but not correctly putting the output\r\nfor any dependencies into the default workspace as well.\r\n\r\nSpotted by Jack.", "tree": {"sha": "e9106875f04f7d83b76acf09e8ff385a196963a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e9106875f04f7d83b76acf09e8ff385a196963a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "html_url": "https://github.com/rust-lang/rust/commit/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ab4a6fab046769ddad48de557f64b0a97f86ce3", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ab4a6fab046769ddad48de557f64b0a97f86ce3", "html_url": "https://github.com/rust-lang/rust/commit/2ab4a6fab046769ddad48de557f64b0a97f86ce3"}, {"sha": "0e6a575635862deba5c280d38b32bb43093980c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e6a575635862deba5c280d38b32bb43093980c0", "html_url": "https://github.com/rust-lang/rust/commit/0e6a575635862deba5c280d38b32bb43093980c0"}], "stats": {"total": 57, "additions": 45, "deletions": 12}, "files": [{"sha": "797ea3372ccfdf45b97514b5f7da591af3899be8", "filename": "src/librustpkg/package_source.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Fpackage_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Fpackage_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Fpackage_source.rs?ref=cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "patch": "@@ -422,6 +422,8 @@ impl PkgSrc {\n                                 fail!(\"Bad kind in build_crates\")\n                             });\n                     }\n+                    debug!(\"Compiling crate {}; its output will be in {}\",\n+                           subpath.display(), sub_dir.display());\n                     let result = compile_crate(&subcx,\n                                                exec,\n                                                &id,\n@@ -473,8 +475,8 @@ impl PkgSrc {\n         let tests = self.tests.clone();\n         let benchs = self.benchs.clone();\n         debug!(\"Building libs in {}, destination = {}\",\n-               self.destination_workspace.display(),\n-               self.destination_workspace.display());\n+               self.source_workspace.display(),\n+               self.build_workspace().display());\n         self.build_crates(build_context,\n                           &mut deps,\n                           libs,"}, {"sha": "517d43432eccf6dc653bdbaf1b09bda03447e8b9", "filename": "src/librustpkg/rustpkg.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Frustpkg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Frustpkg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Frustpkg.rs?ref=cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "patch": "@@ -587,8 +587,6 @@ impl CtxMethods for BuildContext {\n                                            build_inputs,\n                                            &pkg_src.destination_workspace,\n                                            &id).map(|s| Path::new(s.as_slice()));\n-        debug!(\"install: id = {}, about to call discover_outputs, {:?}\",\n-               id.to_str(), result.map(|p| p.display().to_str()));\n         installed_files = installed_files + result;\n         note(format!(\"Installed package {} to {}\",\n                      id.to_str(),"}, {"sha": "8f1b269f1caac9177c531d230e08a359b6fa721a", "filename": "src/librustpkg/tests.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Ftests.rs?ref=cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "patch": "@@ -1511,6 +1511,30 @@ fn rust_path_hack_build_no_arg() {\n    assert!(!built_library_exists(&source_dir, \"foo\"));\n }\n \n+#[test]\n+fn rust_path_hack_build_with_dependency() {\n+    let foo_id = PkgId::new(\"foo\");\n+    let dep_id = PkgId::new(\"dep\");\n+    // Tests that when --rust-path-hack is in effect, dependencies get built\n+    // into the destination workspace and not the source directory\n+    let work_dir = create_local_package(&foo_id);\n+    let work_dir = work_dir.path();\n+    let dep_workspace = create_local_package(&dep_id);\n+    let dep_workspace = dep_workspace.path();\n+    let dest_workspace = mk_emptier_workspace(\"dep\");\n+    let dest_workspace = dest_workspace.path();\n+    let source_dir = work_dir.join_many([\"src\", \"foo-0.1\"]);\n+    writeFile(&source_dir.join(\"lib.rs\"), \"extern mod dep; pub fn f() { }\");\n+    let dep_dir = dep_workspace.join_many([\"src\", \"dep-0.1\"]);\n+    let rust_path = Some(~[(~\"RUST_PATH\",\n+                          format!(\"{}:{}\",\n+                                  dest_workspace.display(),\n+                                  dep_dir.display()))]);\n+    command_line_test_with_env([~\"build\", ~\"--rust-path-hack\", ~\"foo\"], work_dir, rust_path);\n+    assert_built_library_exists(dest_workspace, \"dep\");\n+    assert!(!built_library_exists(dep_workspace, \"dep\"));\n+}\n+\n #[test]\n fn rust_path_install_target() {\n     let dir_for_path = TempDir::new("}, {"sha": "9d835dcc20be7ba112c24263add0b9cf8086152e", "filename": "src/librustpkg/util.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37/src%2Flibrustpkg%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Futil.rs?ref=cd6e9f4f834f849a3dafd7cf0786f3c97bc3bb37", "patch": "@@ -465,22 +465,31 @@ impl<'self> Visitor<()> for ViewItemVisitor<'self> {\n                         // Find all the workspaces in the RUST_PATH that contain this package.\n                         let workspaces = pkg_parent_workspaces(&self.context.context,\n                                                                &pkg_id);\n-                        // Two cases:\n+                        // Three cases:\n                         // (a) `workspaces` is empty. That means there's no local source\n                         // for this package. In that case, we pass the default workspace\n                         // into `PkgSrc::new`, so that if it exists as a remote repository,\n-                        // its sources will be fetched into it.\n-                        // (b) `workspaces` is non-empty -- we found a local source for this\n-                        // package.\n-                        let dest_workspace = if workspaces.is_empty() {\n-                            default_workspace()\n-                        } else { workspaces[0] };\n+                        // its sources will be fetched into it. We also put the output in the\n+                        // same workspace.\n+                        // (b) We're using the Rust path hack. In that case, the output goes\n+                        // in the destination workspace.\n+                        // (c) `workspaces` is non-empty -- we found a local source for this\n+                        // package and will build in that workspace.\n+                        let (source_workspace, dest_workspace) = if workspaces.is_empty() {\n+                            (default_workspace(), default_workspace())\n+                        } else {\n+                            if self.context.context.use_rust_path_hack {\n+                                (workspaces[0], default_workspace())\n+                            } else {\n+                                 (workspaces[0].clone(), workspaces[0])\n+                            }\n+                        };\n                         // In this case, the source and destination workspaces are the same:\n                         // Either it's a remote package, so the local sources don't exist\n                         // and the `PkgSrc` constructor will detect that;\n                         // or else it's already in a workspace and we'll build into that\n                         // workspace\n-                        let pkg_src = PkgSrc::new(dest_workspace.clone(),\n+                        let pkg_src = PkgSrc::new(source_workspace,\n                                                   dest_workspace,\n                         // Use the rust_path_hack to search for dependencies iff\n                         // we were already using it"}]}