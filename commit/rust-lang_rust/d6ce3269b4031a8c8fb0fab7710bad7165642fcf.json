{"sha": "d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2Y2UzMjY5YjQwMzFhOGM4ZmIwZmFiNzcxMGJhZDcxNjU2NDJmY2Y=", "commit": {"author": {"name": "Andrew Hickman", "email": "andrew.hickman1@sky.com", "date": "2021-09-06T22:30:20Z"}, "committer": {"name": "Andrew Hickman", "email": "andrew.hickman1@sky.com", "date": "2021-09-06T22:34:47Z"}, "message": "Suggest wapping expr in parentheses on invalid unary negation\n\nFixes #88701", "tree": {"sha": "620ad7741892e4cc2ba6dbc953bf4ee1307834fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/620ad7741892e4cc2ba6dbc953bf4ee1307834fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "html_url": "https://github.com/rust-lang/rust/commit/d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/comments", "author": {"login": "andrewhickman", "id": 19718247, "node_id": "MDQ6VXNlcjE5NzE4MjQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19718247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrewhickman", "html_url": "https://github.com/andrewhickman", "followers_url": "https://api.github.com/users/andrewhickman/followers", "following_url": "https://api.github.com/users/andrewhickman/following{/other_user}", "gists_url": "https://api.github.com/users/andrewhickman/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrewhickman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrewhickman/subscriptions", "organizations_url": "https://api.github.com/users/andrewhickman/orgs", "repos_url": "https://api.github.com/users/andrewhickman/repos", "events_url": "https://api.github.com/users/andrewhickman/events{/privacy}", "received_events_url": "https://api.github.com/users/andrewhickman/received_events", "type": "User", "site_admin": false}, "committer": {"login": "andrewhickman", "id": 19718247, "node_id": "MDQ6VXNlcjE5NzE4MjQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19718247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrewhickman", "html_url": "https://github.com/andrewhickman", "followers_url": "https://api.github.com/users/andrewhickman/followers", "following_url": "https://api.github.com/users/andrewhickman/following{/other_user}", "gists_url": "https://api.github.com/users/andrewhickman/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrewhickman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrewhickman/subscriptions", "organizations_url": "https://api.github.com/users/andrewhickman/orgs", "repos_url": "https://api.github.com/users/andrewhickman/repos", "events_url": "https://api.github.com/users/andrewhickman/events{/privacy}", "received_events_url": "https://api.github.com/users/andrewhickman/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ceea01bb442b9746a51b062ce25abbf46d866b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ceea01bb442b9746a51b062ce25abbf46d866b2", "html_url": "https://github.com/rust-lang/rust/commit/8ceea01bb442b9746a51b062ce25abbf46d866b2"}], "stats": {"total": 114, "additions": 77, "deletions": 37}, "files": [{"sha": "bc5587af3efb6e38e5a3e8a958b38374a24a0161", "filename": "compiler/rustc_typeck/src/check/op.rs", "status": "modified", "additions": 43, "deletions": 35, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs?ref=d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "patch": "@@ -680,42 +680,50 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         ex.span,\n                         format!(\"cannot apply unary operator `{}`\", op.as_str()),\n                     );\n-                    match actual.kind() {\n-                        Uint(_) if op == hir::UnOp::Neg => {\n-                            err.note(\"unsigned values cannot be negated\");\n-\n-                            if let hir::ExprKind::Unary(\n-                                _,\n-                                hir::Expr {\n-                                    kind:\n-                                        hir::ExprKind::Lit(Spanned {\n-                                            node: ast::LitKind::Int(1, _),\n-                                            ..\n-                                        }),\n-                                    ..\n-                                },\n-                            ) = ex.kind\n-                            {\n-                                err.span_suggestion(\n-                                    ex.span,\n-                                    &format!(\n-                                        \"you may have meant the maximum value of `{}`\",\n-                                        actual\n-                                    ),\n-                                    format!(\"{}::MAX\", actual),\n-                                    Applicability::MaybeIncorrect,\n-                                );\n+\n+                    let sp = self.tcx.sess.source_map().start_point(ex.span);\n+                    if let Some(sp) =\n+                        self.tcx.sess.parse_sess.ambiguous_block_expr_parse.borrow().get(&sp)\n+                    {\n+                        self.tcx.sess.parse_sess.expr_parentheses_needed(&mut err, *sp);\n+                    } else {\n+                        match actual.kind() {\n+                            Uint(_) if op == hir::UnOp::Neg => {\n+                                err.note(\"unsigned values cannot be negated\");\n+\n+                                if let hir::ExprKind::Unary(\n+                                    _,\n+                                    hir::Expr {\n+                                        kind:\n+                                            hir::ExprKind::Lit(Spanned {\n+                                                node: ast::LitKind::Int(1, _),\n+                                                ..\n+                                            }),\n+                                        ..\n+                                    },\n+                                ) = ex.kind\n+                                {\n+                                    err.span_suggestion(\n+                                        ex.span,\n+                                        &format!(\n+                                            \"you may have meant the maximum value of `{}`\",\n+                                            actual\n+                                        ),\n+                                        format!(\"{}::MAX\", actual),\n+                                        Applicability::MaybeIncorrect,\n+                                    );\n+                                }\n+                            }\n+                            Str | Never | Char | Tuple(_) | Array(_, _) => {}\n+                            Ref(_, ref lty, _) if *lty.kind() == Str => {}\n+                            _ => {\n+                                let missing_trait = match op {\n+                                    hir::UnOp::Neg => \"std::ops::Neg\",\n+                                    hir::UnOp::Not => \"std::ops::Not\",\n+                                    hir::UnOp::Deref => \"std::ops::UnDerf\",\n+                                };\n+                                suggest_impl_missing(&mut err, operand_ty, &missing_trait);\n                             }\n-                        }\n-                        Str | Never | Char | Tuple(_) | Array(_, _) => {}\n-                        Ref(_, ref lty, _) if *lty.kind() == Str => {}\n-                        _ => {\n-                            let missing_trait = match op {\n-                                hir::UnOp::Neg => \"std::ops::Neg\",\n-                                hir::UnOp::Not => \"std::ops::Not\",\n-                                hir::UnOp::Deref => \"std::ops::UnDerf\",\n-                            };\n-                            suggest_impl_missing(&mut err, operand_ty, &missing_trait);\n                         }\n                     }\n                     err.emit();"}, {"sha": "941fd29d0a319ed88228bc43d9c7784e0c711a04", "filename": "src/test/ui/parser/expr-as-stmt.fixed", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed?ref=d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "patch": "@@ -32,4 +32,9 @@ fn moo(x: u32) -> bool {\n     }) > 0 //~ ERROR expected expression\n }\n \n+fn qux() -> u32 {\n+    ({2}) - 2 //~ ERROR cannot apply unary operator `-` to type `u32`\n+    //~^ ERROR mismatched types\n+}\n+\n fn main() {}"}, {"sha": "0a60ad601207a601b301febeddf43dce045f49e2", "filename": "src/test/ui/parser/expr-as-stmt.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs?ref=d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "patch": "@@ -32,4 +32,9 @@ fn moo(x: u32) -> bool {\n     } > 0 //~ ERROR expected expression\n }\n \n+fn qux() -> u32 {\n+    {2} - 2 //~ ERROR cannot apply unary operator `-` to type `u32`\n+    //~^ ERROR mismatched types\n+}\n+\n fn main() {}"}, {"sha": "0a04c2c8995f988df8dcaff20518b54f150a6127", "filename": "src/test/ui/parser/expr-as-stmt.stderr", "status": "modified", "additions": 24, "deletions": 2, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d6ce3269b4031a8c8fb0fab7710bad7165642fcf/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr?ref=d6ce3269b4031a8c8fb0fab7710bad7165642fcf", "patch": "@@ -99,7 +99,29 @@ help: parentheses are required to parse this as an expression\n LL |     ({ 3 }) * 3\n    |     +     +\n \n-error: aborting due to 9 previous errors\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:36:6\n+   |\n+LL |     {2} - 2\n+   |      ^ expected `()`, found integer\n+   |\n+help: you might have meant to return this value\n+   |\n+LL |     {return 2;} - 2\n+   |      ++++++  +\n+\n+error[E0600]: cannot apply unary operator `-` to type `u32`\n+  --> $DIR/expr-as-stmt.rs:36:9\n+   |\n+LL |     {2} - 2\n+   |         ^^^ cannot apply unary operator `-`\n+   |\n+help: parentheses are required to parse this as an expression\n+   |\n+LL |     ({2}) - 2\n+   |     +   +\n+\n+error: aborting due to 11 previous errors\n \n-Some errors have detailed explanations: E0308, E0614.\n+Some errors have detailed explanations: E0308, E0600, E0614.\n For more information about an error, try `rustc --explain E0308`."}]}