{"sha": "72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "node_id": "C_kwDOAAsO6NoAKDcyNDIxYmZiMGMyYTJhMDIwOWZiYzk2YmI5YTdkMzMyNTg5NjYxZDk", "commit": {"author": {"name": "\u8bb8\u6770\u53cb Jieyou Xu (Joe)", "email": "jieyouxu@outlook.com", "date": "2023-06-08T08:14:54Z"}, "committer": {"name": "\u8bb8\u6770\u53cb Jieyou Xu (Joe)", "email": "jieyouxu@outlook.com", "date": "2023-06-12T07:15:45Z"}, "message": "Fix debug ICE for extern type with where clauses", "tree": {"sha": "00c01db2169402a330a332ba04a719560be09810", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/00c01db2169402a330a332ba04a719560be09810"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEze4qXcfh0ileWqZTxf1dMgFP20cFAmSGxiEACgkQxf1dMgFP\n20cJ8Q/8CnPYV5vSlRrCkSYDySQrTTvw4nE2qq6GT3Dv2O4I2fX724/Y5HmPFugs\nbQZjiJrQlzyiqifzLmoAqt9A7dgjFdJNv9g00iJjq9EZpzAxSMdBaJtgJXc+6F/7\nuQQez87CO97gVktgxtSF6K6jEp9pQOYZ8RhUbJxlAM+ecG1QjXeVVdXXaQGZYCrr\nK9VRXQ8yQArs4jwyXvB5KbU95VkXfAXy7rHYZYS1DPeXy7SzVPaq6ul2kJkXScrL\n/JoOwOsiJ7M/irnJfbK/soffVnGLDbNG/XMhd7wkhGOi4h/q/VapHBLPN5Hj2YfV\n5BT34H8ovzAOXzE5/FSQnyexmfoEPAfZRFAU363tmoLZWEMu2Q/jxuNf6JVf0hlv\njQ0KYNxyS9YiQBqTZ3kdUdI9HBXRsxlXaxQu05pHcUar/0FfGtg8TUdyHQUHhw0u\n0n1BaImxak2Zo8UjYKKpxQaFFtZacvzVVTyb1uU4InD/GG3Z1V0APZvsqtInwzuX\nIMB+ONLh6q6tw1s1QHrNuApAmp/xmW0iuszhU7fegdtwdZ8EpkhETeFwQ0K8CHzX\nqSdz56nQ1VsTGcUm7tDdTYdjOB/x0hIusFyGfxo0dtix2dj52h0hYJqcKKB6X6fn\ndOxowvfqTjj0YKhyMA19Qj9wnC/UfpzRvB0q8zsiyX6dck+r2hM=\n=/Iu7\n-----END PGP SIGNATURE-----", "payload": "tree 00c01db2169402a330a332ba04a719560be09810\nparent 37998ab508d5d9fa0d465d7b535dc673087dda8f\nauthor \u8bb8\u6770\u53cb Jieyou Xu (Joe) <jieyouxu@outlook.com> 1686212094 +0800\ncommitter \u8bb8\u6770\u53cb Jieyou Xu (Joe) <jieyouxu@outlook.com> 1686554145 +0800\n\nFix debug ICE for extern type with where clauses\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "html_url": "https://github.com/rust-lang/rust/commit/72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/comments", "author": {"login": "jieyouxu", "id": 39484203, "node_id": "MDQ6VXNlcjM5NDg0MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/39484203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jieyouxu", "html_url": "https://github.com/jieyouxu", "followers_url": "https://api.github.com/users/jieyouxu/followers", "following_url": "https://api.github.com/users/jieyouxu/following{/other_user}", "gists_url": "https://api.github.com/users/jieyouxu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jieyouxu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jieyouxu/subscriptions", "organizations_url": "https://api.github.com/users/jieyouxu/orgs", "repos_url": "https://api.github.com/users/jieyouxu/repos", "events_url": "https://api.github.com/users/jieyouxu/events{/privacy}", "received_events_url": "https://api.github.com/users/jieyouxu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jieyouxu", "id": 39484203, "node_id": "MDQ6VXNlcjM5NDg0MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/39484203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jieyouxu", "html_url": "https://github.com/jieyouxu", "followers_url": "https://api.github.com/users/jieyouxu/followers", "following_url": "https://api.github.com/users/jieyouxu/following{/other_user}", "gists_url": "https://api.github.com/users/jieyouxu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jieyouxu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jieyouxu/subscriptions", "organizations_url": "https://api.github.com/users/jieyouxu/orgs", "repos_url": "https://api.github.com/users/jieyouxu/repos", "events_url": "https://api.github.com/users/jieyouxu/events{/privacy}", "received_events_url": "https://api.github.com/users/jieyouxu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37998ab508d5d9fa0d465d7b535dc673087dda8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/37998ab508d5d9fa0d465d7b535dc673087dda8f", "html_url": "https://github.com/rust-lang/rust/commit/37998ab508d5d9fa0d465d7b535dc673087dda8f"}], "stats": {"total": 91, "additions": 85, "deletions": 6}, "files": [{"sha": "a0979bbda54521a1c6c609539d6a21d412ff10a0", "filename": "compiler/rustc_ast_passes/src/ast_validation.rs", "status": "modified", "additions": 15, "deletions": 5, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Fast_validation.rs?ref=72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "patch": "@@ -364,7 +364,12 @@ impl<'a> AstValidator<'a> {\n         self.err_handler().emit_err(errors::BoundInContext { span, ctx });\n     }\n \n-    fn check_foreign_ty_genericless(&self, generics: &Generics, where_span: Span) {\n+    fn check_foreign_ty_genericless(\n+        &self,\n+        generics: &Generics,\n+        before_where_clause: &TyAliasWhereClause,\n+        after_where_clause: &TyAliasWhereClause,\n+    ) {\n         let cannot_have = |span, descr, remove_descr| {\n             self.err_handler().emit_err(errors::ExternTypesCannotHave {\n                 span,\n@@ -378,9 +383,14 @@ impl<'a> AstValidator<'a> {\n             cannot_have(generics.span, \"generic parameters\", \"generic parameters\");\n         }\n \n-        if !generics.where_clause.predicates.is_empty() {\n-            cannot_have(where_span, \"`where` clauses\", \"`where` clause\");\n-        }\n+        let check_where_clause = |where_clause: &TyAliasWhereClause| {\n+            if let TyAliasWhereClause(true, where_clause_span) = where_clause {\n+                cannot_have(*where_clause_span, \"`where` clauses\", \"`where` clause\");\n+            }\n+        };\n+\n+        check_where_clause(before_where_clause);\n+        check_where_clause(after_where_clause);\n     }\n \n     fn check_foreign_kind_bodyless(&self, ident: Ident, kind: &str, body: Option<Span>) {\n@@ -1039,7 +1049,7 @@ impl<'a> Visitor<'a> for AstValidator<'a> {\n                 self.check_defaultness(fi.span, *defaultness);\n                 self.check_foreign_kind_bodyless(fi.ident, \"type\", ty.as_ref().map(|b| b.span));\n                 self.check_type_no_bounds(bounds, \"`extern` blocks\");\n-                self.check_foreign_ty_genericless(generics, where_clauses.0.1);\n+                self.check_foreign_ty_genericless(generics, &where_clauses.0, &where_clauses.1);\n                 self.check_foreign_item_ascii_only(fi.ident);\n             }\n             ForeignItemKind::Static(_, _, body) => {"}, {"sha": "17e08f511d71fab9076950049dddc32b95acf1c0", "filename": "tests/ui/extern/issue-112363-extern-item-where-clauses-debug-ice.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fextern%2Fissue-112363-extern-item-where-clauses-debug-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fextern%2Fissue-112363-extern-item-where-clauses-debug-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fextern%2Fissue-112363-extern-item-where-clauses-debug-ice.rs?ref=72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "patch": "@@ -0,0 +1,10 @@\n+extern \"C\" {\n+    type Item = [T] where [T]: Sized;\n+    //~^ incorrect `type` inside `extern` block\n+    //~| `type`s inside `extern` blocks cannot have `where` clauses\n+    //~| cannot find type `T` in this scope\n+    //~| cannot find type `T` in this scope\n+    //~| extern types are experimental\n+}\n+\n+fn main() {}"}, {"sha": "bdc6755038aa487ccfa0adf08f919e5d5db09743", "filename": "tests/ui/extern/issue-112363-extern-item-where-clauses-debug-ice.stderr", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fextern%2Fissue-112363-extern-item-where-clauses-debug-ice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fextern%2Fissue-112363-extern-item-where-clauses-debug-ice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fextern%2Fissue-112363-extern-item-where-clauses-debug-ice.stderr?ref=72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "patch": "@@ -0,0 +1,47 @@\n+error: incorrect `type` inside `extern` block\n+  --> $DIR/issue-112363-extern-item-where-clauses-debug-ice.rs:2:10\n+   |\n+LL | extern \"C\" {\n+   | ---------- `extern` blocks define existing foreign types and types inside of them cannot have a body\n+LL |     type Item = [T] where [T]: Sized;\n+   |          ^^^^   --- the invalid body\n+   |          |\n+   |          cannot have a body\n+   |\n+   = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n+\n+error: `type`s inside `extern` blocks cannot have `where` clauses\n+  --> $DIR/issue-112363-extern-item-where-clauses-debug-ice.rs:2:21\n+   |\n+LL | extern \"C\" {\n+   | ---------- `extern` block begins here\n+LL |     type Item = [T] where [T]: Sized;\n+   |                     ^^^^^^^^^^^^^^^^ help: remove the `where` clause\n+   |\n+   = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n+\n+error[E0412]: cannot find type `T` in this scope\n+  --> $DIR/issue-112363-extern-item-where-clauses-debug-ice.rs:2:28\n+   |\n+LL |     type Item = [T] where [T]: Sized;\n+   |                            ^ not found in this scope\n+\n+error[E0412]: cannot find type `T` in this scope\n+  --> $DIR/issue-112363-extern-item-where-clauses-debug-ice.rs:2:18\n+   |\n+LL |     type Item = [T] where [T]: Sized;\n+   |                  ^ not found in this scope\n+\n+error[E0658]: extern types are experimental\n+  --> $DIR/issue-112363-extern-item-where-clauses-debug-ice.rs:2:5\n+   |\n+LL |     type Item = [T] where [T]: Sized;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #43467 <https://github.com/rust-lang/rust/issues/43467> for more information\n+   = help: add `#![feature(extern_types)]` to the crate attributes to enable\n+\n+error: aborting due to 5 previous errors\n+\n+Some errors have detailed explanations: E0412, E0658.\n+For more information about an error, try `rustc --explain E0412`."}, {"sha": "4d30086e7653627125c6c75f3f458c493f6d7f82", "filename": "tests/ui/parser/foreign-ty-semantic-fail.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fparser%2Fforeign-ty-semantic-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fparser%2Fforeign-ty-semantic-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fforeign-ty-semantic-fail.rs?ref=72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "patch": "@@ -15,4 +15,5 @@ extern \"C\" {\n     //~^ ERROR incorrect `type` inside `extern` block\n \n     type E: where;\n+    //~^ ERROR `type`s inside `extern` blocks cannot have `where` clauses\n }"}, {"sha": "2b400dfea3bfae5b99a80a7248247fdb02f06c26", "filename": "tests/ui/parser/foreign-ty-semantic-fail.stderr", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fparser%2Fforeign-ty-semantic-fail.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/72421bfb0c2a2a0209fbc96bb9a7d332589661d9/tests%2Fui%2Fparser%2Fforeign-ty-semantic-fail.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fforeign-ty-semantic-fail.stderr?ref=72421bfb0c2a2a0209fbc96bb9a7d332589661d9", "patch": "@@ -61,5 +61,16 @@ LL |     type D = u8;\n    |\n    = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n \n-error: aborting due to 6 previous errors\n+error: `type`s inside `extern` blocks cannot have `where` clauses\n+  --> $DIR/foreign-ty-semantic-fail.rs:17:13\n+   |\n+LL | extern \"C\" {\n+   | ---------- `extern` block begins here\n+...\n+LL |     type E: where;\n+   |             ^^^^^ help: remove the `where` clause\n+   |\n+   = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n+\n+error: aborting due to 7 previous errors\n "}]}