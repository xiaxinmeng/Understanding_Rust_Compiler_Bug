{"sha": "37a022ee43c95e815c458844b223ad73c11715d8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3YTAyMmVlNDNjOTVlODE1YzQ1ODg0NGIyMjNhZDczYzExNzE1ZDg=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-09-06T07:36:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-09-06T07:36:40Z"}, "message": "Rollup merge of #64156 - cuviper:gitless-llvm, r=alexcrichton\n\nAssume non-git LLVM is fresh if the stamp file exists\n\nRustbuild usually writes the LLVM submodule commit in a stamp file, so\nwe can avoid rebuilding it unnecessarily. However, for builds from a\nsource tarball (non-git), we were assuming a rebuild is always needed.\nThis can cause a lot of extra work if any environment like `CFLAGS`\nchanged between steps like build and install, which are often separate\nin distro builds.\n\nNow we also write an empty stamp file if the git commit is unknown, and\nits presence is trusted to indicate that no rebuild is needed. An info\nmessage reports that this is happening, along with the stamp file path\nthat can be deleted to force a rebuild anyway.\n\nFixes #61206.", "tree": {"sha": "0e888a915af5a187caeb7171204065531a0e54c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0e888a915af5a187caeb7171204065531a0e54c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37a022ee43c95e815c458844b223ad73c11715d8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdcgyJCRBK7hj4Ov3rIwAAdHIIAHQf9BaonH8OtqVl3DcPfq/B\nlwVeczbep4R/dkjVsdowRslPA9MLCl5vh3C21WaBR5nIdCw/xwI7grlM4xyeNo/R\np7pKEXglixxEuXlKrae5RasJ8cvBWkwqbBU7/RuXu3q5lKSHpC4dgMpQ/Rlr2OXQ\nz4PghcMf2Bdpn9+wPpmpv/MQlyNYZs2gX8tHLOFWApd7taWh3jc2h5q8F1p+NeN4\nihFjgTzBJAFF5aMK1PpiAte3NXL0nmXDwxm6qdoLfqIja68/fQfUqngC1n1S0mM3\nB2K6+ThXxO3WNN43SJ67tyiDuHv9UfOeL7PAa34ZW16c+TdvT9prysuj9wTwbZc=\n=+BDu\n-----END PGP SIGNATURE-----\n", "payload": "tree 0e888a915af5a187caeb7171204065531a0e54c8\nparent 3c1630aa386582644759514f74b2b0a7601fb379\nparent 53fe76479aab03b1fbe5b7184f45484886f769b1\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1567755400 +0200\ncommitter GitHub <noreply@github.com> 1567755400 +0200\n\nRollup merge of #64156 - cuviper:gitless-llvm, r=alexcrichton\n\nAssume non-git LLVM is fresh if the stamp file exists\n\nRustbuild usually writes the LLVM submodule commit in a stamp file, so\nwe can avoid rebuilding it unnecessarily. However, for builds from a\nsource tarball (non-git), we were assuming a rebuild is always needed.\nThis can cause a lot of extra work if any environment like `CFLAGS`\nchanged between steps like build and install, which are often separate\nin distro builds.\n\nNow we also write an empty stamp file if the git commit is unknown, and\nits presence is trusted to indicate that no rebuild is needed. An info\nmessage reports that this is happening, along with the stamp file path\nthat can be deleted to force a rebuild anyway.\n\nFixes #61206.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37a022ee43c95e815c458844b223ad73c11715d8", "html_url": "https://github.com/rust-lang/rust/commit/37a022ee43c95e815c458844b223ad73c11715d8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37a022ee43c95e815c458844b223ad73c11715d8/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c1630aa386582644759514f74b2b0a7601fb379", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c1630aa386582644759514f74b2b0a7601fb379", "html_url": "https://github.com/rust-lang/rust/commit/3c1630aa386582644759514f74b2b0a7601fb379"}, {"sha": "53fe76479aab03b1fbe5b7184f45484886f769b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/53fe76479aab03b1fbe5b7184f45484886f769b1", "html_url": "https://github.com/rust-lang/rust/commit/53fe76479aab03b1fbe5b7184f45484886f769b1"}], "stats": {"total": 27, "additions": 14, "deletions": 13}, "files": [{"sha": "7bf9ea2688f4c5a872d3f6f0b3f1ac645a9a7811", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/37a022ee43c95e815c458844b223ad73c11715d8/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37a022ee43c95e815c458844b223ad73c11715d8/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=37a022ee43c95e815c458844b223ad73c11715d8", "patch": "@@ -81,26 +81,29 @@ impl Step for Llvm {\n             (info, \"src/llvm-project/llvm\", builder.llvm_out(target), dir.join(\"bin\"))\n         };\n \n-        if !llvm_info.is_git() {\n-            println!(\n-                \"git could not determine the LLVM submodule commit hash. \\\n-                Assuming that an LLVM build is necessary.\",\n-            );\n-        }\n-\n         let build_llvm_config = llvm_config_ret_dir\n             .join(exe(\"llvm-config\", &*builder.config.build));\n         let done_stamp = out_dir.join(\"llvm-finished-building\");\n \n-        if let Some(llvm_commit) = llvm_info.sha() {\n-            if done_stamp.exists() {\n+        if done_stamp.exists() {\n+            if let Some(llvm_commit) = llvm_info.sha() {\n                 let done_contents = t!(fs::read(&done_stamp));\n \n                 // If LLVM was already built previously and the submodule's commit didn't change\n                 // from the previous build, then no action is required.\n                 if done_contents == llvm_commit.as_bytes() {\n-                    return build_llvm_config\n+                    return build_llvm_config;\n                 }\n+            } else {\n+                builder.info(\n+                    \"Could not determine the LLVM submodule commit hash. \\\n+                     Assuming that an LLVM rebuild is not necessary.\",\n+                );\n+                builder.info(&format!(\n+                    \"To force LLVM to rebuild, remove the file `{}`\",\n+                    done_stamp.display()\n+                ));\n+                return build_llvm_config;\n             }\n         }\n \n@@ -303,9 +306,7 @@ impl Step for Llvm {\n \n         cfg.build();\n \n-        if let Some(llvm_commit) = llvm_info.sha() {\n-            t!(fs::write(&done_stamp, llvm_commit));\n-        }\n+        t!(fs::write(&done_stamp, llvm_info.sha().unwrap_or(\"\")));\n \n         build_llvm_config\n     }"}]}