{"sha": "c993984e4d543e23474b50217f04df3fa7a38dcc", "node_id": "C_kwDOAAsO6NoAKGM5OTM5ODRlNGQ1NDNlMjM0NzRiNTAyMTdmMDRkZjNmYTdhMzhkY2M", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-07-17T14:10:03Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-09-24T18:45:51Z"}, "message": "builtin_macros: Make #[derive(A, B, ...)] cfg-eval its input only for `A, B, ...`", "tree": {"sha": "475b5463579f6091b68b9b04bb2a6754827c1af0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/475b5463579f6091b68b9b04bb2a6754827c1af0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c993984e4d543e23474b50217f04df3fa7a38dcc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c993984e4d543e23474b50217f04df3fa7a38dcc", "html_url": "https://github.com/rust-lang/rust/commit/c993984e4d543e23474b50217f04df3fa7a38dcc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c993984e4d543e23474b50217f04df3fa7a38dcc/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f06f9bbd3a2b0a2781decd6163b14f71dd59bf7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/f06f9bbd3a2b0a2781decd6163b14f71dd59bf7f", "html_url": "https://github.com/rust-lang/rust/commit/f06f9bbd3a2b0a2781decd6163b14f71dd59bf7f"}], "stats": {"total": 52, "additions": 48, "deletions": 4}, "files": [{"sha": "824776b45e21af2d284ef9751b0ec6b0c6fdf490", "filename": "compiler/rustc_builtin_macros/src/derive.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c993984e4d543e23474b50217f04df3fa7a38dcc/compiler%2Frustc_builtin_macros%2Fsrc%2Fderive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c993984e4d543e23474b50217f04df3fa7a38dcc/compiler%2Frustc_builtin_macros%2Fsrc%2Fderive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fderive.rs?ref=c993984e4d543e23474b50217f04df3fa7a38dcc", "patch": "@@ -26,7 +26,7 @@ impl MultiItemModifier for Expander {\n             return ExpandResult::Ready(vec![item]);\n         }\n \n-        let item = cfg_eval(ecx, item);\n+        let configured_item = cfg_eval(ecx, item.clone());\n \n         let result =\n             ecx.resolver.resolve_derives(ecx.current_expansion.id, ecx.force_mode, &|| {\n@@ -56,7 +56,7 @@ impl MultiItemModifier for Expander {\n                         report_path_args(sess, &meta);\n                         meta.path\n                     })\n-                    .map(|path| (path, item.clone(), None))\n+                    .map(|path| (path, configured_item.clone(), None))\n                     .collect()\n             });\n "}, {"sha": "bc8b001db8f349c6ff7ca2143bb49c3034681f0d", "filename": "src/test/ui/proc-macro/attribute-after-derive.stdout", "status": "modified", "additions": 46, "deletions": 2, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/c993984e4d543e23474b50217f04df3fa7a38dcc/src%2Ftest%2Fui%2Fproc-macro%2Fattribute-after-derive.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/c993984e4d543e23474b50217f04df3fa7a38dcc/src%2Ftest%2Fui%2Fproc-macro%2Fattribute-after-derive.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fattribute-after-derive.stdout?ref=c993984e4d543e23474b50217f04df3fa7a38dcc", "patch": "@@ -130,7 +130,7 @@ PRINT-DERIVE INPUT (DEBUG): TokenStream [\n         span: $DIR/attribute-after-derive.rs:25:24: 28:2 (#0),\n     },\n ]\n-PRINT-ATTR INPUT (DISPLAY): struct DeriveAttribute { }\n+PRINT-ATTR INPUT (DISPLAY): struct DeriveAttribute { #[cfg(FALSE)] field : u8, }\n PRINT-ATTR INPUT (DEBUG): TokenStream [\n     Ident {\n         ident: \"struct\",\n@@ -142,7 +142,51 @@ PRINT-ATTR INPUT (DEBUG): TokenStream [\n     },\n     Group {\n         delimiter: Brace,\n-        stream: TokenStream [],\n+        stream: TokenStream [\n+            Punct {\n+                ch: '#',\n+                spacing: Alone,\n+                span: $DIR/attribute-after-derive.rs:26:5: 26:6 (#0),\n+            },\n+            Group {\n+                delimiter: Bracket,\n+                stream: TokenStream [\n+                    Ident {\n+                        ident: \"cfg\",\n+                        span: $DIR/attribute-after-derive.rs:26:7: 26:10 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Parenthesis,\n+                        stream: TokenStream [\n+                            Ident {\n+                                ident: \"FALSE\",\n+                                span: $DIR/attribute-after-derive.rs:26:11: 26:16 (#0),\n+                            },\n+                        ],\n+                        span: $DIR/attribute-after-derive.rs:26:10: 26:17 (#0),\n+                    },\n+                ],\n+                span: $DIR/attribute-after-derive.rs:26:6: 26:18 (#0),\n+            },\n+            Ident {\n+                ident: \"field\",\n+                span: $DIR/attribute-after-derive.rs:27:5: 27:10 (#0),\n+            },\n+            Punct {\n+                ch: ':',\n+                spacing: Alone,\n+                span: $DIR/attribute-after-derive.rs:27:10: 27:11 (#0),\n+            },\n+            Ident {\n+                ident: \"u8\",\n+                span: $DIR/attribute-after-derive.rs:27:12: 27:14 (#0),\n+            },\n+            Punct {\n+                ch: ',',\n+                spacing: Alone,\n+                span: $DIR/attribute-after-derive.rs:27:14: 27:15 (#0),\n+            },\n+        ],\n         span: $DIR/attribute-after-derive.rs:25:24: 28:2 (#0),\n     },\n ]"}]}