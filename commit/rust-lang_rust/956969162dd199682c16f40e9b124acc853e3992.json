{"sha": "956969162dd199682c16f40e9b124acc853e3992", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1Njk2OTE2MmRkMTk5NjgyYzE2ZjQwZTliMTI0YWNjODUzZTM5OTI=", "commit": {"author": {"name": "Kevin Yap", "email": "me@kevinyap.ca", "date": "2015-02-07T09:11:33Z"}, "committer": {"name": "Kevin Yap", "email": "me@kevinyap.ca", "date": "2015-02-24T05:15:34Z"}, "message": "Refactor code in tidy.py\n\n- Replace wildcard import with explicit import of `check_license`\n- Move more logic outside of the `try` block.\n- Group all helper functions together.\n- Define `interesting_exts` and `uninteresting_files` at start of file\n  (with the rest of the constant declarations).", "tree": {"sha": "39c432bfa5e99cba2cb3eb8beee1fc47048c4faf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39c432bfa5e99cba2cb3eb8beee1fc47048c4faf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/956969162dd199682c16f40e9b124acc853e3992", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/956969162dd199682c16f40e9b124acc853e3992", "html_url": "https://github.com/rust-lang/rust/commit/956969162dd199682c16f40e9b124acc853e3992", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/956969162dd199682c16f40e9b124acc853e3992/comments", "author": {"login": "iKevinY", "id": 2434728, "node_id": "MDQ6VXNlcjI0MzQ3Mjg=", "avatar_url": "https://avatars.githubusercontent.com/u/2434728?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iKevinY", "html_url": "https://github.com/iKevinY", "followers_url": "https://api.github.com/users/iKevinY/followers", "following_url": "https://api.github.com/users/iKevinY/following{/other_user}", "gists_url": "https://api.github.com/users/iKevinY/gists{/gist_id}", "starred_url": "https://api.github.com/users/iKevinY/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iKevinY/subscriptions", "organizations_url": "https://api.github.com/users/iKevinY/orgs", "repos_url": "https://api.github.com/users/iKevinY/repos", "events_url": "https://api.github.com/users/iKevinY/events{/privacy}", "received_events_url": "https://api.github.com/users/iKevinY/received_events", "type": "User", "site_admin": false}, "committer": {"login": "iKevinY", "id": 2434728, "node_id": "MDQ6VXNlcjI0MzQ3Mjg=", "avatar_url": "https://avatars.githubusercontent.com/u/2434728?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iKevinY", "html_url": "https://github.com/iKevinY", "followers_url": "https://api.github.com/users/iKevinY/followers", "following_url": "https://api.github.com/users/iKevinY/following{/other_user}", "gists_url": "https://api.github.com/users/iKevinY/gists{/gist_id}", "starred_url": "https://api.github.com/users/iKevinY/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iKevinY/subscriptions", "organizations_url": "https://api.github.com/users/iKevinY/orgs", "repos_url": "https://api.github.com/users/iKevinY/repos", "events_url": "https://api.github.com/users/iKevinY/events{/privacy}", "received_events_url": "https://api.github.com/users/iKevinY/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1eebb8f371cf2703ca1d4096f974d037938ece8", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1eebb8f371cf2703ca1d4096f974d037938ece8", "html_url": "https://github.com/rust-lang/rust/commit/f1eebb8f371cf2703ca1d4096f974d037938ece8"}], "stats": {"total": 73, "additions": 37, "deletions": 36}, "files": [{"sha": "c524fae7f0a42e6272ce736cd5d54517702baa11", "filename": "src/etc/tidy.py", "status": "modified", "additions": 37, "deletions": 36, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/956969162dd199682c16f40e9b124acc853e3992/src%2Fetc%2Ftidy.py", "raw_url": "https://github.com/rust-lang/rust/raw/956969162dd199682c16f40e9b124acc853e3992/src%2Fetc%2Ftidy.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Ftidy.py?ref=956969162dd199682c16f40e9b124acc853e3992", "patch": "@@ -13,7 +13,7 @@\n import subprocess\n import re\n import os\n-from licenseck import *\n+from licenseck import check_license\n import snapshot\n \n err = 0\n@@ -22,13 +22,8 @@\n tab_flag = \"ignore-tidy-tab\"\n linelength_flag = \"ignore-tidy-linelength\"\n \n-# Be careful to support Python 2.4, 2.6, and 3.x here!\n-config_proc = subprocess.Popen([\"git\", \"config\", \"core.autocrlf\"],\n-                               stdout=subprocess.PIPE)\n-result = config_proc.communicate()[0]\n-\n-true = \"true\".encode('utf8')\n-autocrlf = result.strip() == true if result is not None else False\n+interesting_files = ['.rs', '.py', '.js', '.sh', '.c', '.h']\n+uninteresting_files = ['miniz.c', 'jquery', 'rust_android_dummy']\n \n \n def report_error_name_no(name, no, s):\n@@ -51,6 +46,34 @@ def do_license_check(name, contents):\n     if not check_license(name, contents):\n         report_error_name_no(name, 1, \"incorrect license\")\n \n+\n+def update_counts(current_name):\n+    global file_counts\n+    global count_other_linted_files\n+\n+    _, ext = os.path.splitext(current_name)\n+\n+    if ext in interesting_files:\n+        file_counts[ext] += 1\n+    else:\n+        count_other_linted_files += 1\n+\n+\n+def interesting_file(f):\n+    if any(x in f for x in uninteresting_files):\n+        return False\n+\n+    return any(os.path.splitext(f)[1] == ext for ext in interesting_files)\n+\n+\n+# Be careful to support Python 2.4, 2.6, and 3.x here!\n+config_proc = subprocess.Popen([\"git\", \"config\", \"core.autocrlf\"],\n+                               stdout=subprocess.PIPE)\n+result = config_proc.communicate()[0]\n+\n+true = \"true\".encode('utf8')\n+autocrlf = result.strip() == true if result is not None else False\n+\n current_name = \"\"\n current_contents = \"\"\n check_tab = True\n@@ -63,30 +86,16 @@ def do_license_check(name, contents):\n \n src_dir = sys.argv[1]\n \n-try:\n-    count_lines = 0\n-    count_non_blank_lines = 0\n-    count_other_linted_files = 0\n-\n-    interesting_files = ['.rs', '.py', '.js', '.sh', '.c', '.h']\n-\n-    file_counts = {ext: 0 for ext in interesting_files}\n-\n-    def update_counts(current_name):\n-        global file_counts\n-        global count_other_linted_files\n-\n-        _, ext = os.path.splitext(current_name)\n+count_lines = 0\n+count_non_blank_lines = 0\n+count_other_linted_files = 0\n \n-        if ext in interesting_files:\n-            file_counts[ext] += 1\n-        else:\n-            count_other_linted_files += 1\n+file_counts = {ext: 0 for ext in interesting_files}\n \n-    all_paths = set()\n+all_paths = set()\n \n+try:\n     for (dirpath, dirnames, filenames) in os.walk(src_dir):\n-\n         # Skip some third-party directories\n         skippable_dirs = {\n             'src/jemalloc',\n@@ -105,14 +114,6 @@ def update_counts(current_name):\n         if any(d in dirpath for d in skippable_dirs):\n             continue\n \n-        def interesting_file(f):\n-            if \"miniz.c\" in f \\\n-            or \"jquery\" in f \\\n-            or \"rust_android_dummy\" in f:\n-                return False\n-\n-            return any(os.path.splitext(f)[1] == ext for ext in interesting_files)\n-\n         file_names = [os.path.join(dirpath, f) for f in filenames\n                       if interesting_file(f)\n                       and not f.endswith(\"_gen.rs\")"}]}