{"sha": "271ec6b990523c79f93468a5b0ab5e1aceab50f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3MWVjNmI5OTA1MjNjNzlmOTM0NjhhNWIwYWI1ZTFhY2VhYjUwZjY=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-21T21:59:52Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-21T21:59:52Z"}, "message": "Add a \"Debug ItemTree\" LSP request", "tree": {"sha": "82e6df7e0d66797bae5ee26fa16af40f482ae365", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82e6df7e0d66797bae5ee26fa16af40f482ae365"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/271ec6b990523c79f93468a5b0ab5e1aceab50f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/271ec6b990523c79f93468a5b0ab5e1aceab50f6", "html_url": "https://github.com/rust-lang/rust/commit/271ec6b990523c79f93468a5b0ab5e1aceab50f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/271ec6b990523c79f93468a5b0ab5e1aceab50f6/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d13864440ba8b6ede1097c79b28e4981caf714a", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d13864440ba8b6ede1097c79b28e4981caf714a", "html_url": "https://github.com/rust-lang/rust/commit/8d13864440ba8b6ede1097c79b28e4981caf714a"}], "stats": {"total": 108, "additions": 108, "deletions": 0}, "files": [{"sha": "ff2a54117bb2f4f1eb7601500d2fde0e23ecf430", "filename": "crates/ide/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Fide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Fide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Flib.rs?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -50,6 +50,7 @@ mod typing;\n mod markdown_remove;\n mod doc_links;\n mod view_crate_graph;\n+mod view_item_tree;\n \n use std::sync::Arc;\n \n@@ -288,6 +289,10 @@ impl Analysis {\n         self.with_db(|db| view_hir::view_hir(&db, position))\n     }\n \n+    pub fn view_item_tree(&self, file_id: FileId) -> Cancelable<String> {\n+        self.with_db(|db| view_item_tree::view_item_tree(&db, file_id))\n+    }\n+\n     /// Renders the crate graph to GraphViz \"dot\" syntax.\n     pub fn view_crate_graph(&self) -> Cancelable<Result<String, String>> {\n         self.with_db(|db| view_crate_graph::view_crate_graph(&db))"}, {"sha": "3dc03085d651c9f0f2727341f29c8ade90274430", "filename": "crates/ide/src/view_item_tree.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Fide%2Fsrc%2Fview_item_tree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Fide%2Fsrc%2Fview_item_tree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fview_item_tree.rs?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -0,0 +1,16 @@\n+use hir::db::DefDatabase;\n+use ide_db::base_db::FileId;\n+use ide_db::RootDatabase;\n+\n+// Feature: Debug ItemTree\n+//\n+// Displays the ItemTree of the currently open file, for debugging.\n+//\n+// |===\n+// | Editor  | Action Name\n+//\n+// | VS Code | **Rust Analyzer: Debug ItemTree**\n+// |===\n+pub(crate) fn view_item_tree(db: &RootDatabase, file_id: FileId) -> String {\n+    db.file_item_tree(file_id.into()).pretty_print()\n+}"}, {"sha": "aa12fd94bd95d677faa3344ddd166bc737e6e79b", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -117,6 +117,16 @@ pub(crate) fn handle_view_hir(\n     Ok(res)\n }\n \n+pub(crate) fn handle_view_item_tree(\n+    snap: GlobalStateSnapshot,\n+    params: lsp_ext::ViewItemTreeParams,\n+) -> Result<String> {\n+    let _p = profile::span(\"handle_view_item_tree\");\n+    let file_id = from_proto::file_id(&snap, &params.text_document.uri)?;\n+    let res = snap.analysis.view_item_tree(file_id)?;\n+    Ok(res)\n+}\n+\n pub(crate) fn handle_view_crate_graph(snap: GlobalStateSnapshot, (): ()) -> Result<String> {\n     let _p = profile::span(\"handle_view_crate_graph\");\n     let dot = snap.analysis.view_crate_graph()??;"}, {"sha": "90504879304a07591a0998c4f6b16d617abf74e5", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -70,6 +70,20 @@ impl Request for ViewCrateGraph {\n     const METHOD: &'static str = \"rust-analyzer/viewCrateGraph\";\n }\n \n+#[derive(Deserialize, Serialize, Debug)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct ViewItemTreeParams {\n+    pub text_document: TextDocumentIdentifier,\n+}\n+\n+pub enum ViewItemTree {}\n+\n+impl Request for ViewItemTree {\n+    type Params = ViewItemTreeParams;\n+    type Result = String;\n+    const METHOD: &'static str = \"rust-analyzer/viewItemTree\";\n+}\n+\n pub enum ExpandMacro {}\n \n impl Request for ExpandMacro {"}, {"sha": "f837b89ddc91f88e9f0ef4343c5c136297467bae", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -514,6 +514,7 @@ impl GlobalState {\n             .on::<lsp_ext::SyntaxTree>(handlers::handle_syntax_tree)\n             .on::<lsp_ext::ViewHir>(handlers::handle_view_hir)\n             .on::<lsp_ext::ViewCrateGraph>(handlers::handle_view_crate_graph)\n+            .on::<lsp_ext::ViewItemTree>(handlers::handle_view_item_tree)\n             .on::<lsp_ext::ExpandMacro>(handlers::handle_expand_macro)\n             .on::<lsp_ext::ParentModule>(handlers::handle_parent_module)\n             .on::<lsp_ext::Runnables>(handlers::handle_runnables)"}, {"sha": "17d9281ff74955e1025d88398b35ebbf1284d11c", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -109,6 +109,11 @@\n                 \"title\": \"View Hir\",\n                 \"category\": \"Rust Analyzer\"\n             },\n+            {\n+                \"command\": \"rust-analyzer.viewItemTree\",\n+                \"title\": \"Debug ItemTree\",\n+                \"category\": \"Rust Analyzer\"\n+            },\n             {\n                 \"command\": \"rust-analyzer.viewCrateGraph\",\n                 \"title\": \"View Crate Graph\","}, {"sha": "8f672e68db5ccc8e0d643e6a98d9d97f448ae7df", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -429,6 +429,56 @@ export function viewHir(ctx: Ctx): Cmd {\n     };\n }\n \n+export function viewItemTree(ctx: Ctx): Cmd {\n+    const tdcp = new class implements vscode.TextDocumentContentProvider {\n+        readonly uri = vscode.Uri.parse('rust-analyzer://viewItemTree/itemtree.txt');\n+        readonly eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n+        constructor() {\n+            vscode.workspace.onDidChangeTextDocument(this.onDidChangeTextDocument, this, ctx.subscriptions);\n+            vscode.window.onDidChangeActiveTextEditor(this.onDidChangeActiveTextEditor, this, ctx.subscriptions);\n+        }\n+\n+        private onDidChangeTextDocument(event: vscode.TextDocumentChangeEvent) {\n+            if (isRustDocument(event.document)) {\n+                // We need to order this after language server updates, but there's no API for that.\n+                // Hence, good old sleep().\n+                void sleep(10).then(() => this.eventEmitter.fire(this.uri));\n+            }\n+        }\n+        private onDidChangeActiveTextEditor(editor: vscode.TextEditor | undefined) {\n+            if (editor && isRustEditor(editor)) {\n+                this.eventEmitter.fire(this.uri);\n+            }\n+        }\n+\n+        provideTextDocumentContent(_uri: vscode.Uri, ct: vscode.CancellationToken): vscode.ProviderResult<string> {\n+            const rustEditor = ctx.activeRustEditor;\n+            const client = ctx.client;\n+            if (!rustEditor || !client) return '';\n+\n+            const params = {\n+                textDocument: client.code2ProtocolConverter.asTextDocumentIdentifier(rustEditor.document),\n+            };\n+            return client.sendRequest(ra.viewItemTree, params, ct);\n+        }\n+\n+        get onDidChange(): vscode.Event<vscode.Uri> {\n+            return this.eventEmitter.event;\n+        }\n+    };\n+\n+    ctx.pushCleanup(vscode.workspace.registerTextDocumentContentProvider('rust-analyzer', tdcp));\n+\n+    return async () => {\n+        const document = await vscode.workspace.openTextDocument(tdcp.uri);\n+        tdcp.eventEmitter.fire(tdcp.uri);\n+        void await vscode.window.showTextDocument(document, {\n+            viewColumn: vscode.ViewColumn.Two,\n+            preserveFocus: true\n+        });\n+    };\n+}\n+\n export function viewCrateGraph(ctx: Ctx): Cmd {\n     return async () => {\n         const panel = vscode.window.createWebviewPanel(\"rust-analyzer.crate-graph\", \"rust-analyzer crate graph\", vscode.ViewColumn.Two);"}, {"sha": "6d5c2ea72dc224a68b5a9f151670c9d53d1354f4", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -27,6 +27,12 @@ export const syntaxTree = new lc.RequestType<SyntaxTreeParams, string, void>(\"ru\n \n export const viewHir = new lc.RequestType<lc.TextDocumentPositionParams, string, void>(\"rust-analyzer/viewHir\");\n \n+export interface ViewItemTreeParams {\n+    textDocument: lc.TextDocumentIdentifier;\n+}\n+\n+export const viewItemTree = new lc.RequestType<ViewItemTreeParams, string, void>(\"rust-analyzer/viewItemTree\");\n+\n export const viewCrateGraph = new lc.RequestType0<string, void>(\"rust-analyzer/viewCrateGraph\");\n \n export interface ExpandMacroParams {"}, {"sha": "92c797d47fae060232c0e37afb2d1879fb186de7", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/271ec6b990523c79f93468a5b0ab5e1aceab50f6/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=271ec6b990523c79f93468a5b0ab5e1aceab50f6", "patch": "@@ -106,6 +106,7 @@ async function tryActivate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('parentModule', commands.parentModule);\n     ctx.registerCommand('syntaxTree', commands.syntaxTree);\n     ctx.registerCommand('viewHir', commands.viewHir);\n+    ctx.registerCommand('viewItemTree', commands.viewItemTree);\n     ctx.registerCommand('viewCrateGraph', commands.viewCrateGraph);\n     ctx.registerCommand('expandMacro', commands.expandMacro);\n     ctx.registerCommand('run', commands.run);"}]}