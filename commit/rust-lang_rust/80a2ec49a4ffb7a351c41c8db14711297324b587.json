{"sha": "80a2ec49a4ffb7a351c41c8db14711297324b587", "node_id": "C_kwDOAAsO6NoAKDgwYTJlYzQ5YTRmZmI3YTM1MWM0MWM4ZGIxNDcxMTI5NzMyNGI1ODc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-22T00:10:44Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-22T00:10:44Z"}, "message": "Auto merge of #106934 - DrMeepster:offset_of, r=WaffleLapkin\n\nAdd offset_of! macro (RFC 3308)\n\nImplements https://github.com/rust-lang/rfcs/pull/3308 (tracking issue #106655) by adding the built in macro `core::mem::offset_of`. Two of the future possibilities are also implemented:\n\n* Nested field accesses (without array indexing)\n* DST support (for `Sized` fields)\n\nI wrote this a few months ago, before the RFC merged. Now that it's merged, I decided to rebase and finish it.\n\ncc `@thomcc` (RFC author)", "tree": {"sha": "32a089a87caf1bc9e30b08dcf2ce8d8e50bfc73a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/32a089a87caf1bc9e30b08dcf2ce8d8e50bfc73a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80a2ec49a4ffb7a351c41c8db14711297324b587", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80a2ec49a4ffb7a351c41c8db14711297324b587", "html_url": "https://github.com/rust-lang/rust/commit/80a2ec49a4ffb7a351c41c8db14711297324b587", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80a2ec49a4ffb7a351c41c8db14711297324b587/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0fd50f3e019dddc47d1d6dbe35c4c1542098d9c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fd50f3e019dddc47d1d6dbe35c4c1542098d9c5", "html_url": "https://github.com/rust-lang/rust/commit/0fd50f3e019dddc47d1d6dbe35c4c1542098d9c5"}, {"sha": "99abe44135e84de2029186384c3ffbd1ad860cca", "url": "https://api.github.com/repos/rust-lang/rust/commits/99abe44135e84de2029186384c3ffbd1ad860cca", "html_url": "https://github.com/rust-lang/rust/commit/99abe44135e84de2029186384c3ffbd1ad860cca"}], "stats": {"total": 1397, "additions": 1355, "deletions": 42}, "files": [{"sha": "1e4d3ba47f4722e227b6b0f4f203fbf30d947930", "filename": "compiler/rustc_ast/src/ast.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fast.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1271,6 +1271,7 @@ impl Expr {\n             ExprKind::Continue(..) => ExprPrecedence::Continue,\n             ExprKind::Ret(..) => ExprPrecedence::Ret,\n             ExprKind::InlineAsm(..) => ExprPrecedence::InlineAsm,\n+            ExprKind::OffsetOf(..) => ExprPrecedence::OffsetOf,\n             ExprKind::MacCall(..) => ExprPrecedence::Mac,\n             ExprKind::Struct(..) => ExprPrecedence::Struct,\n             ExprKind::Repeat(..) => ExprPrecedence::Repeat,\n@@ -1469,6 +1470,9 @@ pub enum ExprKind {\n     /// Output of the `asm!()` macro.\n     InlineAsm(P<InlineAsm>),\n \n+    /// Output of the `offset_of!()` macro.\n+    OffsetOf(P<Ty>, P<[Ident]>),\n+\n     /// A macro invocation; pre-expansion.\n     MacCall(P<MacCall>),\n "}, {"sha": "99f1f4bd9685f491606136039b1de37ae88438f0", "filename": "compiler/rustc_ast/src/mut_visit.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1456,6 +1456,12 @@ pub fn noop_visit_expr<T: MutVisitor>(\n         }\n         ExprKind::InlineAsm(asm) => vis.visit_inline_asm(asm),\n         ExprKind::FormatArgs(fmt) => vis.visit_format_args(fmt),\n+        ExprKind::OffsetOf(container, fields) => {\n+            vis.visit_ty(container);\n+            for field in fields.iter_mut() {\n+                vis.visit_ident(field);\n+            }\n+        }\n         ExprKind::MacCall(mac) => vis.visit_mac_call(mac),\n         ExprKind::Struct(se) => {\n             let StructExpr { qself, path, fields, rest } = se.deref_mut();"}, {"sha": "24b4bd8623f047952ba1c43577b67a51a91f8cee", "filename": "compiler/rustc_ast/src/util/parser.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Futil%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Futil%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Futil%2Fparser.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -269,6 +269,7 @@ pub enum ExprPrecedence {\n     Index,\n     Try,\n     InlineAsm,\n+    OffsetOf,\n     Mac,\n     FormatArgs,\n \n@@ -335,7 +336,8 @@ impl ExprPrecedence {\n             | ExprPrecedence::Try\n             | ExprPrecedence::InlineAsm\n             | ExprPrecedence::Mac\n-            | ExprPrecedence::FormatArgs => PREC_POSTFIX,\n+            | ExprPrecedence::FormatArgs\n+            | ExprPrecedence::OffsetOf => PREC_POSTFIX,\n \n             // Never need parens\n             ExprPrecedence::Array"}, {"sha": "8a6b5d5c9052deffc6fcee5e4dd0bccb8c2547d5", "filename": "compiler/rustc_ast/src/visit.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast%2Fsrc%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fvisit.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -909,6 +909,12 @@ pub fn walk_expr<'a, V: Visitor<'a>>(visitor: &mut V, expression: &'a Expr) {\n         ExprKind::Paren(subexpression) => visitor.visit_expr(subexpression),\n         ExprKind::InlineAsm(asm) => visitor.visit_inline_asm(asm),\n         ExprKind::FormatArgs(f) => visitor.visit_format_args(f),\n+        ExprKind::OffsetOf(container, fields) => {\n+            visitor.visit_ty(container);\n+            for &field in fields {\n+                visitor.visit_ident(field);\n+            }\n+        }\n         ExprKind::Yield(optional_expression) => {\n             walk_list!(visitor, visit_expr, optional_expression);\n         }"}, {"sha": "6863100d9bac099584d9af5f85ee7d4dee5ad78a", "filename": "compiler/rustc_ast_lowering/src/expr.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -289,6 +289,13 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                     hir::ExprKind::InlineAsm(self.lower_inline_asm(e.span, asm))\n                 }\n                 ExprKind::FormatArgs(fmt) => self.lower_format_args(e.span, fmt),\n+                ExprKind::OffsetOf(container, fields) => hir::ExprKind::OffsetOf(\n+                    self.lower_ty(\n+                        container,\n+                        &mut ImplTraitContext::Disallowed(ImplTraitPosition::OffsetOf),\n+                    ),\n+                    self.arena.alloc_from_iter(fields.iter().map(|&ident| self.lower_ident(ident))),\n+                ),\n                 ExprKind::Struct(se) => {\n                     let rest = match &se.rest {\n                         StructRest::Base(e) => Some(self.lower_expr(e)),"}, {"sha": "c969d709608102c240a51381cedea5a8f4eed597", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -283,6 +283,7 @@ enum ImplTraitPosition {\n     FieldTy,\n     Cast,\n     ImplSelf,\n+    OffsetOf,\n }\n \n impl std::fmt::Display for ImplTraitPosition {\n@@ -313,6 +314,7 @@ impl std::fmt::Display for ImplTraitPosition {\n             ImplTraitPosition::FieldTy => \"field types\",\n             ImplTraitPosition::Cast => \"cast types\",\n             ImplTraitPosition::ImplSelf => \"impl headers\",\n+            ImplTraitPosition::OffsetOf => \"`offset_of!` params\",\n         };\n \n         write!(f, \"{name}\")"}, {"sha": "aeb0c762020418617622331155469ee1c8dc9109", "filename": "compiler/rustc_ast_pretty/src/pprust/state/expr.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Fstate%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Fstate%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Fstate%2Fexpr.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -549,6 +549,26 @@ impl<'a> State<'a> {\n                 self.end();\n                 self.pclose();\n             }\n+            ast::ExprKind::OffsetOf(container, fields) => {\n+                // FIXME: This should have its own syntax, distinct from a macro invocation.\n+                self.word(\"offset_of!\");\n+                self.popen();\n+                self.rbox(0, Inconsistent);\n+                self.print_type(container);\n+                self.word(\",\");\n+                self.space();\n+\n+                if let Some((&first, rest)) = fields.split_first() {\n+                    self.print_ident(first);\n+\n+                    for &field in rest {\n+                        self.word(\".\");\n+                        self.print_ident(field);\n+                    }\n+                }\n+\n+                self.end();\n+            }\n             ast::ExprKind::MacCall(m) => self.print_mac(m),\n             ast::ExprKind::Paren(e) => {\n                 self.popen();"}, {"sha": "7cb0cec82c76a7ba8c90f7a1f23be660c6d737ba", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -2306,7 +2306,8 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n             Rvalue::AddressOf(..)\n             | Rvalue::ThreadLocalRef(..)\n             | Rvalue::Len(..)\n-            | Rvalue::Discriminant(..) => {}\n+            | Rvalue::Discriminant(..)\n+            | Rvalue::NullaryOp(NullOp::OffsetOf(..), _) => {}\n         }\n     }\n "}, {"sha": "fca6012a408c1d0223791027c28ed5348aae64aa", "filename": "compiler/rustc_builtin_macros/messages.ftl", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fmessages.ftl?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -149,3 +149,6 @@ builtin_macros_format_pos_mismatch = {$n} positional {$n ->\n     [one] argument\n     *[more] arguments\n     } in format string, but {$desc}\n+builtin_macros_offset_of_expected_field = expected field\n+\n+builtin_macros_offset_of_expected_two_args = expected 2 arguments"}, {"sha": "090e00616fb4806f7ad956413a13d2125ddb25b4", "filename": "compiler/rustc_builtin_macros/src/assert/context.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fsrc%2Fassert%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fsrc%2Fassert%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fassert%2Fcontext.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -301,6 +301,7 @@ impl<'cx, 'a> Context<'cx, 'a> {\n             | ExprKind::If(_, _, _)\n             | ExprKind::IncludedBytes(..)\n             | ExprKind::InlineAsm(_)\n+            | ExprKind::OffsetOf(_, _)\n             | ExprKind::Let(_, _, _)\n             | ExprKind::Lit(_)\n             | ExprKind::Loop(_, _, _)"}, {"sha": "8f86ef44aa3ab8f6d07d8a1f19680e27b9d17ebc", "filename": "compiler/rustc_builtin_macros/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Flib.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -45,6 +45,7 @@ mod format;\n mod format_foreign;\n mod global_allocator;\n mod log_syntax;\n+mod offset_of;\n mod source_util;\n mod test;\n mod trace_macros;\n@@ -92,6 +93,7 @@ pub fn register_builtin_macros(resolver: &mut dyn ResolverExpand) {\n         line: source_util::expand_line,\n         log_syntax: log_syntax::expand_log_syntax,\n         module_path: source_util::expand_mod,\n+        offset_of: offset_of::expand_offset_of,\n         option_env: env::expand_option_env,\n         core_panic: edition_panic::expand_panic,\n         std_panic: edition_panic::expand_panic,"}, {"sha": "0ef3e000e414c40c69fb87601320f8f07098957f", "filename": "compiler/rustc_builtin_macros/src/offset_of.rs", "status": "added", "additions": 99, "deletions": 0, "changes": 99, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fsrc%2Foffset_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_builtin_macros%2Fsrc%2Foffset_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Foffset_of.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,99 @@\n+use rustc_ast as ast;\n+use rustc_ast::ptr::P;\n+use rustc_ast::token;\n+use rustc_ast::tokenstream::TokenStream;\n+use rustc_errors::PResult;\n+use rustc_expand::base::{self, *};\n+use rustc_macros::Diagnostic;\n+use rustc_parse::parser::Parser;\n+use rustc_span::{symbol::Ident, Span};\n+\n+#[derive(Diagnostic)]\n+#[diag(builtin_macros_offset_of_expected_field)]\n+struct ExpectedField {\n+    #[primary_span]\n+    span: Span,\n+}\n+\n+#[derive(Diagnostic)]\n+#[diag(builtin_macros_offset_of_expected_two_args)]\n+struct ExpectedTwoArgs {\n+    #[primary_span]\n+    span: Span,\n+}\n+\n+fn parse_field<'a>(cx: &ExtCtxt<'a>, p: &mut Parser<'a>) -> PResult<'a, Ident> {\n+    let token = p.token.uninterpolate();\n+    let field = match token.kind {\n+        token::Ident(name, _) => Ident::new(name, token.span),\n+        token::Literal(token::Lit { kind: token::Integer, symbol, suffix: None }) => {\n+            Ident::new(symbol, token.span)\n+        }\n+        _ => return Err(cx.create_err(ExpectedField { span: p.token.span })),\n+    };\n+\n+    p.bump();\n+\n+    Ok(field)\n+}\n+\n+fn parse_args<'a>(\n+    cx: &mut ExtCtxt<'a>,\n+    sp: Span,\n+    tts: TokenStream,\n+) -> PResult<'a, (P<ast::Ty>, P<[Ident]>)> {\n+    let mut p = cx.new_parser_from_tts(tts);\n+\n+    let container = p.parse_ty()?;\n+\n+    p.expect(&token::Comma)?;\n+\n+    if p.eat(&token::Eof) {\n+        return Err(cx.create_err(ExpectedTwoArgs { span: sp }));\n+    }\n+\n+    let mut fields = Vec::new();\n+\n+    loop {\n+        let field = parse_field(cx, &mut p)?;\n+        fields.push(field);\n+\n+        if p.eat(&token::Dot) {\n+            continue;\n+        }\n+\n+        p.eat(&token::Comma);\n+\n+        if !p.eat(&token::Eof) {\n+            return Err(cx.create_err(ExpectedTwoArgs { span: sp }));\n+        }\n+\n+        break;\n+    }\n+\n+    Ok((container, fields.into()))\n+}\n+\n+pub fn expand_offset_of<'cx>(\n+    cx: &'cx mut ExtCtxt<'_>,\n+    sp: Span,\n+    tts: TokenStream,\n+) -> Box<dyn base::MacResult + 'cx> {\n+    match parse_args(cx, sp, tts) {\n+        Ok((container, fields)) => {\n+            let expr = P(ast::Expr {\n+                id: ast::DUMMY_NODE_ID,\n+                kind: ast::ExprKind::OffsetOf(container, fields),\n+                span: sp,\n+                attrs: ast::AttrVec::new(),\n+                tokens: None,\n+            });\n+\n+            MacEager::expr(expr)\n+        }\n+        Err(mut err) => {\n+            err.emit();\n+            DummyResult::any(sp)\n+        }\n+    }\n+}"}, {"sha": "f481290583e0678e10abe762f18b979c9fab258d", "filename": "compiler/rustc_codegen_cranelift/src/base.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fbase.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -781,12 +781,15 @@ fn codegen_stmt<'tcx>(\n                     let operand = operand.load_scalar(fx);\n                     lval.write_cvalue(fx, CValue::by_val(operand, box_layout));\n                 }\n-                Rvalue::NullaryOp(null_op, ty) => {\n+                Rvalue::NullaryOp(ref null_op, ty) => {\n                     assert!(lval.layout().ty.is_sized(fx.tcx, ParamEnv::reveal_all()));\n                     let layout = fx.layout_of(fx.monomorphize(ty));\n                     let val = match null_op {\n                         NullOp::SizeOf => layout.size.bytes(),\n                         NullOp::AlignOf => layout.align.abi.bytes(),\n+                        NullOp::OffsetOf(fields) => {\n+                            layout.offset_of_subfield(fx, fields.iter().map(|f| f.index())).bytes()\n+                        }\n                     };\n                     let val = CValue::const_val(fx, fx.layout_of(fx.tcx.types.usize), val.into());\n                     lval.write_cvalue(fx, val);"}, {"sha": "94de19a9c2935f5e54814033bb46d6cffd9f8cdb", "filename": "compiler/rustc_codegen_ssa/src/mir/rvalue.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -666,13 +666,16 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                 }\n             }\n \n-            mir::Rvalue::NullaryOp(null_op, ty) => {\n+            mir::Rvalue::NullaryOp(ref null_op, ty) => {\n                 let ty = self.monomorphize(ty);\n                 assert!(bx.cx().type_is_sized(ty));\n                 let layout = bx.cx().layout_of(ty);\n                 let val = match null_op {\n                     mir::NullOp::SizeOf => layout.size.bytes(),\n                     mir::NullOp::AlignOf => layout.align.abi.bytes(),\n+                    mir::NullOp::OffsetOf(fields) => {\n+                        layout.offset_of_subfield(bx.cx(), fields.iter().map(|f| f.index())).bytes()\n+                    }\n                 };\n                 let val = bx.cx().const_usize(val);\n                 let tcx = self.cx.tcx();"}, {"sha": "4d3a11935085d6ea73e6048d719a9efaeac3b439", "filename": "compiler/rustc_const_eval/src/interpret/step.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fstep.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -280,20 +280,23 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                 self.write_immediate(*val, &dest)?;\n             }\n \n-            NullaryOp(null_op, ty) => {\n+            NullaryOp(ref null_op, ty) => {\n                 let ty = self.subst_from_current_frame_and_normalize_erasing_regions(ty)?;\n                 let layout = self.layout_of(ty)?;\n-                if layout.is_unsized() {\n+                if let mir::NullOp::SizeOf | mir::NullOp::AlignOf = null_op && layout.is_unsized() {\n                     // FIXME: This should be a span_bug (#80742)\n                     self.tcx.sess.delay_span_bug(\n                         self.frame().current_span(),\n-                        &format!(\"Nullary MIR operator called for unsized type {}\", ty),\n+                        &format!(\"{null_op:?} MIR operator called for unsized type {ty}\"),\n                     );\n                     throw_inval!(SizeOfUnsizedType(ty));\n                 }\n                 let val = match null_op {\n                     mir::NullOp::SizeOf => layout.size.bytes(),\n                     mir::NullOp::AlignOf => layout.align.abi.bytes(),\n+                    mir::NullOp::OffsetOf(fields) => {\n+                        layout.offset_of_subfield(self, fields.iter().map(|f| f.index())).bytes()\n+                    }\n                 };\n                 self.write_scalar(Scalar::from_target_usize(val, self), &dest)?;\n             }"}, {"sha": "696c4517700902779a9193c35fd338dfd5d3a68a", "filename": "compiler/rustc_const_eval/src/transform/check_consts/check.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -558,7 +558,7 @@ impl<'tcx> Visitor<'tcx> for Checker<'_, 'tcx> {\n \n             Rvalue::Cast(_, _, _) => {}\n \n-            Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf, _) => {}\n+            Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf | NullOp::OffsetOf(_), _) => {}\n             Rvalue::ShallowInitBox(_, _) => {}\n \n             Rvalue::UnaryOp(_, operand) => {"}, {"sha": "e978e3442832ae17ddf998bb5bedc6e1361bfd64", "filename": "compiler/rustc_const_eval/src/transform/promote_consts.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fpromote_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fpromote_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fpromote_consts.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -514,6 +514,7 @@ impl<'tcx> Validator<'_, 'tcx> {\n             Rvalue::NullaryOp(op, _) => match op {\n                 NullOp::SizeOf => {}\n                 NullOp::AlignOf => {}\n+                NullOp::OffsetOf(_) => {}\n             },\n \n             Rvalue::ShallowInitBox(_, _) => return Err(Unpromotable),"}, {"sha": "9ab2b13d9d1612939df705b540ecebe40056cff4", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 49, "deletions": 4, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -8,9 +8,10 @@ use rustc_middle::mir::interpret::Scalar;\n use rustc_middle::mir::visit::{NonUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::{\n     traversal, BasicBlock, BinOp, Body, BorrowKind, CastKind, CopyNonOverlapping, Local, Location,\n-    MirPass, MirPhase, NonDivergingIntrinsic, Operand, Place, PlaceElem, PlaceRef, ProjectionElem,\n-    RetagKind, RuntimePhase, Rvalue, SourceScope, Statement, StatementKind, Terminator,\n-    TerminatorKind, UnOp, UnwindAction, VarDebugInfo, VarDebugInfoContents, START_BLOCK,\n+    MirPass, MirPhase, NonDivergingIntrinsic, NullOp, Operand, Place, PlaceElem, PlaceRef,\n+    ProjectionElem, RetagKind, RuntimePhase, Rvalue, SourceScope, Statement, StatementKind,\n+    Terminator, TerminatorKind, UnOp, UnwindAction, VarDebugInfo, VarDebugInfoContents,\n+    START_BLOCK,\n };\n use rustc_middle::ty::{self, InstanceDef, ParamEnv, Ty, TyCtxt, TypeVisitableExt};\n use rustc_mir_dataflow::impls::MaybeStorageLive;\n@@ -711,10 +712,54 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                     }\n                 }\n             }\n+            Rvalue::NullaryOp(NullOp::OffsetOf(fields), container) => {\n+                let fail_out_of_bounds = |this: &Self, location, field, ty| {\n+                    this.fail(location, format!(\"Out of bounds field {field:?} for {ty:?}\"));\n+                };\n+\n+                let mut current_ty = *container;\n+\n+                for field in fields.iter() {\n+                    match current_ty.kind() {\n+                        ty::Tuple(fields) => {\n+                            let Some(&f_ty) = fields.get(field.as_usize()) else {\n+                                fail_out_of_bounds(self, location, field, current_ty);\n+                                return;\n+                            };\n+\n+                            current_ty = self.tcx.normalize_erasing_regions(self.param_env, f_ty);\n+                        }\n+                        ty::Adt(adt_def, substs) => {\n+                            if adt_def.is_enum() {\n+                                self.fail(\n+                                    location,\n+                                    format!(\"Cannot get field offset from enum {current_ty:?}\"),\n+                                );\n+                                return;\n+                            }\n+\n+                            let Some(field) = adt_def.non_enum_variant().fields.get(field) else {\n+                                fail_out_of_bounds(self, location, field, current_ty);\n+                                return;\n+                            };\n+\n+                            let f_ty = field.ty(self.tcx, substs);\n+                            current_ty = self.tcx.normalize_erasing_regions(self.param_env, f_ty);\n+                        }\n+                        _ => {\n+                            self.fail(\n+                                location,\n+                                format!(\"Cannot get field offset from non-adt type {current_ty:?}\"),\n+                            );\n+                            return;\n+                        }\n+                    }\n+                }\n+            }\n             Rvalue::Repeat(_, _)\n             | Rvalue::ThreadLocalRef(_)\n             | Rvalue::AddressOf(_, _)\n-            | Rvalue::NullaryOp(_, _)\n+            | Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf, _)\n             | Rvalue::Discriminant(_) => {}\n         }\n         self.super_rvalue(rvalue, location);"}, {"sha": "52ed9660256cbf31e8e8482b7ae919aa97c70709", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1715,6 +1715,7 @@ impl Expr<'_> {\n             ExprKind::Continue(..) => ExprPrecedence::Continue,\n             ExprKind::Ret(..) => ExprPrecedence::Ret,\n             ExprKind::InlineAsm(..) => ExprPrecedence::InlineAsm,\n+            ExprKind::OffsetOf(..) => ExprPrecedence::OffsetOf,\n             ExprKind::Struct(..) => ExprPrecedence::Struct,\n             ExprKind::Repeat(..) => ExprPrecedence::Repeat,\n             ExprKind::Yield(..) => ExprPrecedence::Yield,\n@@ -1774,6 +1775,7 @@ impl Expr<'_> {\n             | ExprKind::Loop(..)\n             | ExprKind::Assign(..)\n             | ExprKind::InlineAsm(..)\n+            | ExprKind::OffsetOf(..)\n             | ExprKind::AssignOp(..)\n             | ExprKind::Lit(_)\n             | ExprKind::ConstBlock(..)\n@@ -1818,7 +1820,7 @@ impl Expr<'_> {\n \n     pub fn can_have_side_effects(&self) -> bool {\n         match self.peel_drop_temps().kind {\n-            ExprKind::Path(_) | ExprKind::Lit(_) => false,\n+            ExprKind::Path(_) | ExprKind::Lit(_) | ExprKind::OffsetOf(..) => false,\n             ExprKind::Type(base, _)\n             | ExprKind::Unary(_, base)\n             | ExprKind::Field(base, _)\n@@ -2022,6 +2024,9 @@ pub enum ExprKind<'hir> {\n     /// Inline assembly (from `asm!`), with its outputs and inputs.\n     InlineAsm(&'hir InlineAsm<'hir>),\n \n+    /// Field offset (`offset_of!`)\n+    OffsetOf(&'hir Ty<'hir>, &'hir [Ident]),\n+\n     /// A struct or struct-like variant literal expression.\n     ///\n     /// E.g., `Foo {x: 1, y: 2}`, or `Foo {x: 1, .. base}`,"}, {"sha": "df0047d82e12efe1660f6ddcb718ad7039d49f51", "filename": "compiler/rustc_hir/src/intravisit.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -786,6 +786,10 @@ pub fn walk_expr<'v, V: Visitor<'v>>(visitor: &mut V, expression: &'v Expr<'v>)\n         ExprKind::InlineAsm(ref asm) => {\n             visitor.visit_inline_asm(asm, expression.hir_id);\n         }\n+        ExprKind::OffsetOf(ref container, ref fields) => {\n+            visitor.visit_ty(container);\n+            walk_list!(visitor, visit_ident, fields.iter().copied());\n+        }\n         ExprKind::Yield(ref subexpression, _) => {\n             visitor.visit_expr(subexpression);\n         }"}, {"sha": "2db4f1e50d48e4c2fab57aa6cea8cabd69e699fc", "filename": "compiler/rustc_hir_pretty/src/lib.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_pretty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_pretty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_pretty%2Fsrc%2Flib.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1551,6 +1551,23 @@ impl<'a> State<'a> {\n                 self.word(\"asm!\");\n                 self.print_inline_asm(asm);\n             }\n+            hir::ExprKind::OffsetOf(container, ref fields) => {\n+                self.word(\"offset_of!(\");\n+                self.print_type(container);\n+                self.word(\",\");\n+                self.space();\n+\n+                if let Some((&first, rest)) = fields.split_first() {\n+                    self.print_ident(first);\n+\n+                    for &field in rest {\n+                        self.word(\".\");\n+                        self.print_ident(field);\n+                    }\n+                }\n+\n+                self.word(\")\");\n+            }\n             hir::ExprKind::Yield(expr, _) => {\n                 self.word_space(\"yield\");\n                 self.print_expr_maybe_paren(expr, parser::PREC_JUMP);"}, {"sha": "3ffc583d43f6125a4b652b99b5fb9d215faaa24d", "filename": "compiler/rustc_hir_typeck/src/expr.rs", "status": "modified", "additions": 97, "deletions": 9, "changes": 106, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -309,6 +309,9 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 self.deferred_asm_checks.borrow_mut().push((asm, expr.hir_id));\n                 self.check_expr_asm(asm)\n             }\n+            ExprKind::OffsetOf(container, ref fields) => {\n+                self.check_offset_of(container, fields, expr)\n+            }\n             ExprKind::Break(destination, ref expr_opt) => {\n                 self.check_expr_break(destination, expr_opt.as_deref(), expr)\n             }\n@@ -2450,15 +2453,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         base_did: DefId,\n         return_ty: Option<Ty<'tcx>>,\n     ) -> ErrorGuaranteed {\n-        let struct_path = self.tcx().def_path_str(base_did);\n-        let kind_name = self.tcx().def_descr(base_did);\n-        let mut err = struct_span_err!(\n-            self.tcx().sess,\n-            field.span,\n-            E0616,\n-            \"field `{field}` of {kind_name} `{struct_path}` is private\",\n-        );\n-        err.span_label(field.span, \"private field\");\n+        let mut err = self.private_field_err(field, base_did);\n+\n         // Also check if an accessible method exists, which is often what is meant.\n         if self.method_exists(field, expr_t, expr.hir_id, false, return_ty)\n             && !self.expr_in_place(expr.hir_id)\n@@ -2698,6 +2694,24 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         err\n     }\n \n+    fn private_field_err(\n+        &self,\n+        field: Ident,\n+        base_did: DefId,\n+    ) -> DiagnosticBuilder<'_, ErrorGuaranteed> {\n+        let struct_path = self.tcx().def_path_str(base_did);\n+        let kind_name = self.tcx().def_descr(base_did);\n+        let mut err = struct_span_err!(\n+            self.tcx().sess,\n+            field.span,\n+            E0616,\n+            \"field `{field}` of {kind_name} `{struct_path}` is private\",\n+        );\n+        err.span_label(field.span, \"private field\");\n+\n+        err\n+    }\n+\n     pub(crate) fn get_field_candidates_considering_privacy(\n         &self,\n         span: Span,\n@@ -3042,4 +3056,78 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             self.tcx.mk_unit()\n         }\n     }\n+\n+    fn check_offset_of(\n+        &self,\n+        container: &'tcx hir::Ty<'tcx>,\n+        fields: &[Ident],\n+        expr: &'tcx hir::Expr<'tcx>,\n+    ) -> Ty<'tcx> {\n+        let container = self.to_ty(container).normalized;\n+\n+        let mut field_indices = Vec::with_capacity(fields.len());\n+        let mut current_container = container;\n+\n+        for &field in fields {\n+            let container = self.structurally_resolved_type(expr.span, current_container);\n+\n+            match container.kind() {\n+                ty::Adt(container_def, substs) if !container_def.is_enum() => {\n+                    let block = self.tcx.hir().local_def_id_to_hir_id(self.body_id);\n+                    let (ident, def_scope) =\n+                        self.tcx.adjust_ident_and_get_scope(field, container_def.did(), block);\n+\n+                    let fields = &container_def.non_enum_variant().fields;\n+                    if let Some((index, field)) = fields\n+                        .iter_enumerated()\n+                        .find(|(_, f)| f.ident(self.tcx).normalize_to_macros_2_0() == ident)\n+                    {\n+                        let field_ty = self.field_ty(expr.span, field, substs);\n+\n+                        // FIXME: DSTs with static alignment should be allowed\n+                        self.require_type_is_sized(field_ty, expr.span, traits::MiscObligation);\n+\n+                        if field.vis.is_accessible_from(def_scope, self.tcx) {\n+                            self.tcx.check_stability(field.did, Some(expr.hir_id), expr.span, None);\n+                        } else {\n+                            self.private_field_err(ident, container_def.did()).emit();\n+                        }\n+\n+                        // Save the index of all fields regardless of their visibility in case\n+                        // of error recovery.\n+                        field_indices.push(index);\n+                        current_container = field_ty;\n+\n+                        continue;\n+                    }\n+                }\n+                ty::Tuple(tys) => {\n+                    let fstr = field.as_str();\n+\n+                    if let Ok(index) = fstr.parse::<usize>() {\n+                        if fstr == index.to_string() {\n+                            if let Some(&field_ty) = tys.get(index) {\n+                                field_indices.push(index.into());\n+                                current_container = field_ty;\n+\n+                                continue;\n+                            }\n+                        }\n+                    }\n+                }\n+                _ => (),\n+            };\n+\n+            self.no_such_field_err(field, container, expr.hir_id).emit();\n+\n+            break;\n+        }\n+\n+        self.typeck_results\n+            .borrow_mut()\n+            .offset_of_data_mut()\n+            .insert(expr.hir_id, (container, field_indices));\n+\n+        self.tcx.types.usize\n+    }\n }"}, {"sha": "94b6a0f8f47d74d24a041413375c68800ebb5b8e", "filename": "compiler/rustc_hir_typeck/src/expr_use_visitor.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr_use_visitor.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -300,6 +300,7 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n             hir::ExprKind::Continue(..)\n             | hir::ExprKind::Lit(..)\n             | hir::ExprKind::ConstBlock(..)\n+            | hir::ExprKind::OffsetOf(..)\n             | hir::ExprKind::Err(_) => {}\n \n             hir::ExprKind::Loop(blk, ..) => {"}, {"sha": "28c44aa5703e8e6e6fee04f1ce0de03a94a93a89", "filename": "compiler/rustc_hir_typeck/src/generator_interior/drop_ranges/cfg_build.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_build.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_build.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_build.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -215,6 +215,7 @@ impl<'a, 'tcx> DropRangeVisitor<'a, 'tcx> {\n             | ExprKind::Continue(..)\n             | ExprKind::Ret(..)\n             | ExprKind::InlineAsm(..)\n+            | ExprKind::OffsetOf(..)\n             | ExprKind::Struct(..)\n             | ExprKind::Repeat(..)\n             | ExprKind::Yield(..)\n@@ -485,6 +486,7 @@ impl<'a, 'tcx> Visitor<'tcx> for DropRangeVisitor<'a, 'tcx> {\n             | ExprKind::Field(..)\n             | ExprKind::Index(..)\n             | ExprKind::InlineAsm(..)\n+            | ExprKind::OffsetOf(..)\n             | ExprKind::Let(..)\n             | ExprKind::Lit(..)\n             | ExprKind::Path(..)"}, {"sha": "f5fca14eca88f819eb2e3b9b561ce619762cc839", "filename": "compiler/rustc_hir_typeck/src/mem_categorization.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fmem_categorization.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -381,6 +381,7 @@ impl<'a, 'tcx> MemCategorizationContext<'a, 'tcx> {\n             | hir::ExprKind::Struct(..)\n             | hir::ExprKind::Repeat(..)\n             | hir::ExprKind::InlineAsm(..)\n+            | hir::ExprKind::OffsetOf(..)\n             | hir::ExprKind::Err(_) => Ok(self.cat_rvalue(expr.hir_id, expr.span, expr_ty)),\n         }\n     }"}, {"sha": "9432a5840b2766b1651e176a69e81993527a9663", "filename": "compiler/rustc_hir_typeck/src/writeback.rs", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -70,6 +70,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         wbcx.visit_user_provided_tys();\n         wbcx.visit_user_provided_sigs();\n         wbcx.visit_generator_interior_types();\n+        wbcx.visit_offset_of_container_types();\n \n         wbcx.typeck_results.rvalue_scopes =\n             mem::take(&mut self.typeck_results.borrow_mut().rvalue_scopes);\n@@ -295,7 +296,7 @@ impl<'cx, 'tcx> Visitor<'tcx> for WritebackCx<'cx, 'tcx> {\n                     self.visit_field_id(field.hir_id);\n                 }\n             }\n-            hir::ExprKind::Field(..) => {\n+            hir::ExprKind::Field(..) | hir::ExprKind::OffsetOf(..) => {\n                 self.visit_field_id(e.hir_id);\n             }\n             hir::ExprKind::ConstBlock(anon_const) => {\n@@ -682,6 +683,28 @@ impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n         }\n     }\n \n+    fn visit_offset_of_container_types(&mut self) {\n+        let fcx_typeck_results = self.fcx.typeck_results.borrow();\n+        assert_eq!(fcx_typeck_results.hir_owner, self.typeck_results.hir_owner);\n+        let common_hir_owner = fcx_typeck_results.hir_owner;\n+\n+        for (local_id, &(container, ref indices)) in\n+            fcx_typeck_results.offset_of_data().items_in_stable_order()\n+        {\n+            let hir_id = hir::HirId { owner: common_hir_owner, local_id };\n+\n+            if cfg!(debug_assertions) && container.needs_infer() {\n+                span_bug!(\n+                    hir_id.to_span(self.fcx.tcx),\n+                    \"writeback: `{:?}` has inference variables\",\n+                    container\n+                );\n+            };\n+\n+            self.typeck_results.offset_of_data_mut().insert(hir_id, (container, indices.clone()));\n+        }\n+    }\n+\n     fn resolve<T>(&mut self, x: T, span: &dyn Locatable) -> T\n     where\n         T: TypeFoldable<TyCtxt<'tcx>>,"}, {"sha": "6b6a2e561f5aff6ea22a841fbfeaa423956aae5a", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -2041,7 +2041,11 @@ impl<'tcx> Debug for Rvalue<'tcx> {\n             }\n             UnaryOp(ref op, ref a) => write!(fmt, \"{:?}({:?})\", op, a),\n             Discriminant(ref place) => write!(fmt, \"discriminant({:?})\", place),\n-            NullaryOp(ref op, ref t) => write!(fmt, \"{:?}({:?})\", op, t),\n+            NullaryOp(ref op, ref t) => match op {\n+                NullOp::SizeOf => write!(fmt, \"SizeOf({:?})\", t),\n+                NullOp::AlignOf => write!(fmt, \"AlignOf({:?})\", t),\n+                NullOp::OffsetOf(fields) => write!(fmt, \"OffsetOf({:?}, {:?})\", t, fields),\n+            },\n             ThreadLocalRef(did) => ty::tls::with(|tcx| {\n                 let muta = tcx.static_mutability(did).unwrap().prefix_str();\n                 write!(fmt, \"&/*tls*/ {}{}\", muta, tcx.def_path_str(did))"}, {"sha": "d7d0366e101abc3ae6140b5d4c0f4fce1edfecfa", "filename": "compiler/rustc_middle/src/mir/syntax.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1115,7 +1115,7 @@ pub enum Rvalue<'tcx> {\n     CheckedBinaryOp(BinOp, Box<(Operand<'tcx>, Operand<'tcx>)>),\n \n     /// Computes a value as described by the operation.\n-    NullaryOp(NullOp, Ty<'tcx>),\n+    NullaryOp(NullOp<'tcx>, Ty<'tcx>),\n \n     /// Exactly like `BinaryOp`, but less operands.\n     ///\n@@ -1211,12 +1211,14 @@ pub enum AggregateKind<'tcx> {\n     Generator(DefId, SubstsRef<'tcx>, hir::Movability),\n }\n \n-#[derive(Copy, Clone, Debug, PartialEq, Eq, TyEncodable, TyDecodable, Hash, HashStable)]\n-pub enum NullOp {\n+#[derive(Clone, Debug, PartialEq, Eq, TyEncodable, TyDecodable, Hash, HashStable)]\n+pub enum NullOp<'tcx> {\n     /// Returns the size of a value of that type\n     SizeOf,\n     /// Returns the minimum alignment of a type\n     AlignOf,\n+    /// Returns the offset of a field\n+    OffsetOf(&'tcx List<FieldIdx>),\n }\n \n #[derive(Copy, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash)]"}, {"sha": "5ca8241344832f90bd9ce721671c0e06d4bb98aa", "filename": "compiler/rustc_middle/src/mir/tcx.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftcx.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftcx.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftcx.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -188,7 +188,9 @@ impl<'tcx> Rvalue<'tcx> {\n             }\n             Rvalue::UnaryOp(UnOp::Not | UnOp::Neg, ref operand) => operand.ty(local_decls, tcx),\n             Rvalue::Discriminant(ref place) => place.ty(local_decls, tcx).ty.discriminant_ty(tcx),\n-            Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf, _) => tcx.types.usize,\n+            Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf | NullOp::OffsetOf(..), _) => {\n+                tcx.types.usize\n+            }\n             Rvalue::Aggregate(ref ak, ref ops) => match **ak {\n                 AggregateKind::Array(ty) => tcx.mk_array(ty, ops.len() as u64),\n                 AggregateKind::Tuple => {"}, {"sha": "06874741bb065ebbd7b5bab57df23835e6b7837b", "filename": "compiler/rustc_middle/src/mir/type_foldable.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftype_foldable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftype_foldable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftype_foldable.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -16,7 +16,6 @@ TrivialTypeTraversalAndLiftImpls! {\n     UserTypeAnnotationIndex,\n     BorrowKind,\n     CastKind,\n-    NullOp,\n     hir::Movability,\n     BasicBlock,\n     SwitchTargets,\n@@ -26,6 +25,7 @@ TrivialTypeTraversalAndLiftImpls! {\n \n TrivialTypeTraversalImpls! {\n     ConstValue<'tcx>,\n+    NullOp<'tcx>,\n }\n \n impl<'tcx> TypeFoldable<TyCtxt<'tcx>> for &'tcx [InlineAsmTemplatePiece] {"}, {"sha": "8700a98b365e5dd53a7f25215e57739442fd11c8", "filename": "compiler/rustc_middle/src/thir.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fthir.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -20,7 +20,7 @@ use rustc_middle::mir::interpret::AllocId;\n use rustc_middle::mir::{self, BinOp, BorrowKind, FakeReadCause, Mutability, UnOp};\n use rustc_middle::ty::adjustment::PointerCast;\n use rustc_middle::ty::subst::SubstsRef;\n-use rustc_middle::ty::{self, AdtDef, FnSig, Ty, UpvarSubsts};\n+use rustc_middle::ty::{self, AdtDef, FnSig, List, Ty, UpvarSubsts};\n use rustc_middle::ty::{CanonicalUserType, CanonicalUserTypeAnnotation};\n use rustc_span::def_id::LocalDefId;\n use rustc_span::{sym, Span, Symbol, DUMMY_SP};\n@@ -481,6 +481,11 @@ pub enum ExprKind<'tcx> {\n     },\n     /// Inline assembly, i.e. `asm!()`.\n     InlineAsm(Box<InlineAsmExpr<'tcx>>),\n+    /// Field offset (`offset_of!`)\n+    OffsetOf {\n+        container: Ty<'tcx>,\n+        fields: &'tcx List<FieldIdx>,\n+    },\n     /// An expression taking a reference to a thread local.\n     ThreadLocalRef(DefId),\n     /// A `yield` expression."}, {"sha": "5c7ec31cf93d32cdcdc0e51c010889ddecc9731a", "filename": "compiler/rustc_middle/src/thir/visit.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fthir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fthir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fthir%2Fvisit.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -160,6 +160,7 @@ pub fn walk_expr<'a, 'tcx: 'a, V: Visitor<'a, 'tcx>>(visitor: &mut V, expr: &Exp\n                 }\n             }\n         }\n+        OffsetOf { container: _, fields: _ } => {}\n         ThreadLocalRef(_) => {}\n         Yield { value } => visitor.visit_expr(&visitor.thir()[value]),\n     }"}, {"sha": "5454d406dd1286a9f7ac11a195a29f51b47e47c7", "filename": "compiler/rustc_middle/src/ty/codec.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcodec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcodec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcodec.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -19,6 +19,7 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_middle::ty::TyCtxt;\n use rustc_serialize::{Decodable, Encodable};\n use rustc_span::Span;\n+use rustc_target::abi::FieldIdx;\n pub use rustc_type_ir::{TyDecoder, TyEncoder};\n use std::hash::Hash;\n use std::intrinsics;\n@@ -401,6 +402,15 @@ impl<'tcx, D: TyDecoder<I = TyCtxt<'tcx>>> RefDecodable<'tcx, D> for ty::List<ty\n     }\n }\n \n+impl<'tcx, D: TyDecoder<I = TyCtxt<'tcx>>> RefDecodable<'tcx, D> for ty::List<FieldIdx> {\n+    fn decode(decoder: &mut D) -> &'tcx Self {\n+        let len = decoder.read_usize();\n+        decoder\n+            .interner()\n+            .mk_fields_from_iter((0..len).map::<FieldIdx, _>(|_| Decodable::decode(decoder)))\n+    }\n+}\n+\n impl_decodable_via_ref! {\n     &'tcx ty::TypeckResults<'tcx>,\n     &'tcx ty::List<Ty<'tcx>>,\n@@ -412,6 +422,7 @@ impl_decodable_via_ref! {\n     &'tcx mir::coverage::CodeRegion,\n     &'tcx ty::List<ty::BoundVariableKind>,\n     &'tcx ty::List<ty::Predicate<'tcx>>,\n+    &'tcx ty::List<FieldIdx>,\n }\n \n #[macro_export]"}, {"sha": "6f122d97a39f075f3a8c0a4ae528a1d5f1bb4ef1", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -155,6 +155,7 @@ pub struct CtxtInterners<'tcx> {\n     layout: InternedSet<'tcx, LayoutS>,\n     adt_def: InternedSet<'tcx, AdtDefData>,\n     external_constraints: InternedSet<'tcx, ExternalConstraintsData<'tcx>>,\n+    fields: InternedSet<'tcx, List<FieldIdx>>,\n }\n \n impl<'tcx> CtxtInterners<'tcx> {\n@@ -178,6 +179,7 @@ impl<'tcx> CtxtInterners<'tcx> {\n             layout: Default::default(),\n             adt_def: Default::default(),\n             external_constraints: Default::default(),\n+            fields: Default::default(),\n         }\n     }\n \n@@ -1571,6 +1573,7 @@ slice_interners!(\n     projs: pub mk_projs(ProjectionKind),\n     place_elems: pub mk_place_elems(PlaceElem<'tcx>),\n     bound_variable_kinds: pub mk_bound_variable_kinds(ty::BoundVariableKind),\n+    fields: pub mk_fields(FieldIdx),\n );\n \n impl<'tcx> TyCtxt<'tcx> {\n@@ -2239,6 +2242,14 @@ impl<'tcx> TyCtxt<'tcx> {\n         T::collect_and_apply(iter, |xs| self.mk_place_elems(xs))\n     }\n \n+    pub fn mk_fields_from_iter<I, T>(self, iter: I) -> T::Output\n+    where\n+        I: Iterator<Item = T>,\n+        T: CollectAndApply<FieldIdx, &'tcx List<FieldIdx>>,\n+    {\n+        T::collect_and_apply(iter, |xs| self.mk_fields(xs))\n+    }\n+\n     pub fn mk_substs_trait(\n         self,\n         self_ty: Ty<'tcx>,"}, {"sha": "ef8955b1d3a317a82798e3a38bbc6de1d94539f5", "filename": "compiler/rustc_middle/src/ty/typeck_results.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fty%2Ftypeck_results.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_middle%2Fsrc%2Fty%2Ftypeck_results.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Ftypeck_results.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -208,6 +208,9 @@ pub struct TypeckResults<'tcx> {\n     /// Contains the data for evaluating the effect of feature `capture_disjoint_fields`\n     /// on closure size.\n     pub closure_size_eval: FxHashMap<LocalDefId, ClosureSizeProfileData<'tcx>>,\n+\n+    /// Container types and field indices of `offset_of!` expressions\n+    offset_of_data: ItemLocalMap<(Ty<'tcx>, Vec<FieldIdx>)>,\n }\n \n /// Whenever a value may be live across a generator yield, the type of that value winds up in the\n@@ -280,6 +283,7 @@ impl<'tcx> TypeckResults<'tcx> {\n             generator_interior_predicates: Default::default(),\n             treat_byte_string_as_slice: Default::default(),\n             closure_size_eval: Default::default(),\n+            offset_of_data: Default::default(),\n         }\n     }\n \n@@ -530,6 +534,14 @@ impl<'tcx> TypeckResults<'tcx> {\n     pub fn coercion_casts(&self) -> &ItemLocalSet {\n         &self.coercion_casts\n     }\n+\n+    pub fn offset_of_data(&self) -> LocalTableInContext<'_, (Ty<'tcx>, Vec<FieldIdx>)> {\n+        LocalTableInContext { hir_owner: self.hir_owner, data: &self.offset_of_data }\n+    }\n+\n+    pub fn offset_of_data_mut(&mut self) -> LocalTableInContextMut<'_, (Ty<'tcx>, Vec<FieldIdx>)> {\n+        LocalTableInContextMut { hir_owner: self.hir_owner, data: &mut self.offset_of_data }\n+    }\n }\n \n /// Validate that the given HirId (respectively its `local_id` part) can be"}, {"sha": "7ec57add66b594a3ee77116cfb8cc74f9a94222a", "filename": "compiler/rustc_mir_build/src/build/expr/as_place.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -557,6 +557,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             | ExprKind::ConstBlock { .. }\n             | ExprKind::StaticRef { .. }\n             | ExprKind::InlineAsm { .. }\n+            | ExprKind::OffsetOf { .. }\n             | ExprKind::Yield { .. }\n             | ExprKind::ThreadLocalRef(_)\n             | ExprKind::Call { .. } => {"}, {"sha": "fbde0b28f54ead908e4088fc8500344b994a96c1", "filename": "compiler/rustc_mir_build/src/build/expr/as_rvalue.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -481,6 +481,10 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                 }))))\n             }\n \n+            ExprKind::OffsetOf { container, fields } => {\n+                block.and(Rvalue::NullaryOp(NullOp::OffsetOf(fields), container))\n+            }\n+\n             ExprKind::Literal { .. }\n             | ExprKind::NamedConst { .. }\n             | ExprKind::NonHirLiteral { .. }"}, {"sha": "d9aa461c19d409d84b71115f996db90f33bca049", "filename": "compiler/rustc_mir_build/src/build/expr/category.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fcategory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fcategory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fcategory.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -67,7 +67,8 @@ impl Category {\n             | ExprKind::Repeat { .. }\n             | ExprKind::Assign { .. }\n             | ExprKind::AssignOp { .. }\n-            | ExprKind::ThreadLocalRef(_) => Some(Category::Rvalue(RvalueFunc::AsRvalue)),\n+            | ExprKind::ThreadLocalRef(_)\n+            | ExprKind::OffsetOf { .. } => Some(Category::Rvalue(RvalueFunc::AsRvalue)),\n \n             ExprKind::ConstBlock { .. }\n             | ExprKind::Literal { .. }"}, {"sha": "29ff916d2cc9c1fad984d3829d4096e2b194b6b0", "filename": "compiler/rustc_mir_build/src/build/expr/into.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Finto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Finto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Finto.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -561,7 +561,8 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             | ExprKind::ZstLiteral { .. }\n             | ExprKind::ConstParam { .. }\n             | ExprKind::ThreadLocalRef(_)\n-            | ExprKind::StaticRef { .. } => {\n+            | ExprKind::StaticRef { .. }\n+            | ExprKind::OffsetOf { .. } => {\n                 debug_assert!(match Category::of(&expr.kind).unwrap() {\n                     // should be handled above\n                     Category::Rvalue(RvalueFunc::Into) => false,"}, {"sha": "0506f2bf2385ce83446b0ff12852c22e229231ea", "filename": "compiler/rustc_mir_build/src/check_unsafety.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -323,6 +323,7 @@ impl<'a, 'tcx> Visitor<'a, 'tcx> for UnsafetyVisitor<'a, 'tcx> {\n             | ExprKind::Box { .. }\n             | ExprKind::If { .. }\n             | ExprKind::InlineAsm { .. }\n+            | ExprKind::OffsetOf { .. }\n             | ExprKind::LogicalOp { .. }\n             | ExprKind::Use { .. } => {\n                 // We don't need to save the old value and restore it"}, {"sha": "ce13d522aae0d934e67f44701f8ba60743f10999", "filename": "compiler/rustc_mir_build/src/thir/cx/expr.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -664,6 +664,14 @@ impl<'tcx> Cx<'tcx> {\n                 line_spans: asm.line_spans,\n             })),\n \n+            hir::ExprKind::OffsetOf(_, _) => {\n+                let data = self.typeck_results.offset_of_data();\n+                let &(container, ref indices) = data.get(expr.hir_id).unwrap();\n+                let fields = tcx.mk_fields_from_iter(indices.iter().copied());\n+\n+                ExprKind::OffsetOf { container, fields }\n+            }\n+\n             hir::ExprKind::ConstBlock(ref anon_const) => {\n                 let ty = self.typeck_results().node_type(anon_const.hir_id);\n                 let did = anon_const.def_id.to_def_id();"}, {"sha": "b2f2a64e29c8c2163f38b6aba44fc564d61f3299", "filename": "compiler/rustc_mir_build/src/thir/print.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fprint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fprint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fprint.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -519,6 +519,19 @@ impl<'a, 'tcx> ThirPrinter<'a, 'tcx> {\n                 self.print_inline_asm_expr(&**expr, depth_lvl + 2);\n                 print_indented!(self, \"}\", depth_lvl);\n             }\n+            OffsetOf { container, fields } => {\n+                print_indented!(self, \"OffsetOf {\", depth_lvl);\n+                print_indented!(self, format!(\"container: {:?}\", container), depth_lvl + 1);\n+                print_indented!(self, \"fields: [\", depth_lvl + 1);\n+\n+                for field in fields.iter() {\n+                    print_indented!(self, format!(\"{:?}\", field), depth_lvl + 2);\n+                    print_indented!(self, \",\", depth_lvl + 1);\n+                }\n+\n+                print_indented!(self, \"]\", depth_lvl + 1);\n+                print_indented!(self, \"}\", depth_lvl);\n+            }\n             ThreadLocalRef(def_id) => {\n                 print_indented!(self, \"ThreadLocalRef {\", depth_lvl);\n                 print_indented!(self, format!(\"def_id: {:?}\", def_id), depth_lvl + 1);"}, {"sha": "736ca62caccccb2588609ac2a8abec55ecf84b31", "filename": "compiler/rustc_mir_dataflow/src/move_paths/builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fmove_paths%2Fbuilder.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -360,7 +360,7 @@ impl<'b, 'a, 'tcx> Gatherer<'b, 'a, 'tcx> {\n             | Rvalue::AddressOf(..)\n             | Rvalue::Discriminant(..)\n             | Rvalue::Len(..)\n-            | Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf, _) => {}\n+            | Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf | NullOp::OffsetOf(..), _) => {}\n         }\n     }\n "}, {"sha": "2479856b727daa36fba3ab58f844192577d2b367", "filename": "compiler/rustc_mir_transform/src/separate_const_switch.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_transform%2Fsrc%2Fseparate_const_switch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_mir_transform%2Fsrc%2Fseparate_const_switch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fseparate_const_switch.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -303,8 +303,7 @@ fn find_determining_place<'tcx>(\n                     | Rvalue::NullaryOp(_, _)\n                     | Rvalue::ShallowInitBox(_, _)\n                     | Rvalue::UnaryOp(_, Operand::Constant(_))\n-                    | Rvalue::Cast(_, Operand::Constant(_), _)\n-                    => return None,\n+                    | Rvalue::Cast(_, Operand::Constant(_), _) => return None,\n                 }\n             }\n "}, {"sha": "3ae5b45d330249ced651f4933bb4688349124563", "filename": "compiler/rustc_passes/src/dead.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fdead.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -237,6 +237,37 @@ impl<'tcx> MarkSymbolVisitor<'tcx> {\n         }\n     }\n \n+    fn handle_offset_of(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n+        let data = self.typeck_results().offset_of_data();\n+        let &(container, ref indices) =\n+            data.get(expr.hir_id).expect(\"no offset_of_data for offset_of\");\n+\n+        let body_did = self.typeck_results().hir_owner.to_def_id();\n+        let param_env = self.tcx.param_env(body_did);\n+\n+        let mut current_ty = container;\n+\n+        for &index in indices {\n+            match current_ty.kind() {\n+                ty::Adt(def, subst) => {\n+                    let field = &def.non_enum_variant().fields[index];\n+\n+                    self.insert_def_id(field.did);\n+                    let field_ty = field.ty(self.tcx, subst);\n+\n+                    current_ty = self.tcx.normalize_erasing_regions(param_env, field_ty);\n+                }\n+                // we don't need to mark tuple fields as live,\n+                // but we may need to mark subfields\n+                ty::Tuple(tys) => {\n+                    current_ty =\n+                        self.tcx.normalize_erasing_regions(param_env, tys[index.as_usize()]);\n+                }\n+                _ => span_bug!(expr.span, \"named field access on non-ADT\"),\n+            }\n+        }\n+    }\n+\n     fn mark_live_symbols(&mut self) {\n         let mut scanned = LocalDefIdSet::default();\n         while let Some(id) = self.worklist.pop() {\n@@ -405,6 +436,9 @@ impl<'tcx> Visitor<'tcx> for MarkSymbolVisitor<'tcx> {\n             hir::ExprKind::Closure(cls) => {\n                 self.insert_def_id(cls.def_id.to_def_id());\n             }\n+            hir::ExprKind::OffsetOf(..) => {\n+                self.handle_offset_of(expr);\n+            }\n             _ => (),\n         }\n "}, {"sha": "dc5e454074deda8d002888f88e469750869f774d", "filename": "compiler/rustc_passes/src/hir_stats.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -302,7 +302,8 @@ impl<'v> hir_visit::Visitor<'v> for StatCollector<'v> {\n             [\n                 ConstBlock, Array, Call, MethodCall, Tup, Binary, Unary, Lit, Cast, Type,\n                 DropTemps, Let, If, Loop, Match, Closure, Block, Assign, AssignOp, Field, Index,\n-                Path, AddrOf, Break, Continue, Ret, InlineAsm, Struct, Repeat, Yield, Err\n+                Path, AddrOf, Break, Continue, Ret, InlineAsm, OffsetOf, Struct, Repeat, Yield,\n+                Err\n             ]\n         );\n         hir_visit::walk_expr(self, e)\n@@ -568,7 +569,7 @@ impl<'v> ast_visit::Visitor<'v> for StatCollector<'v> {\n                 Array, ConstBlock, Call, MethodCall, Tup, Binary, Unary, Lit, Cast, Type, Let,\n                 If, While, ForLoop, Loop, Match, Closure, Block, Async, Await, TryBlock, Assign,\n                 AssignOp, Field, Index, Range, Underscore, Path, AddrOf, Break, Continue, Ret,\n-                InlineAsm, FormatArgs, MacCall, Struct, Repeat, Paren, Try, Yield, Yeet, IncludedBytes, Err\n+                InlineAsm, FormatArgs, OffsetOf, MacCall, Struct, Repeat, Paren, Try, Yield, Yeet, IncludedBytes, Err\n             ]\n         );\n         ast_visit::walk_expr(self, e)"}, {"sha": "b39a8c5598f91102e9e22f85b92e0094c7049d2c", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -473,6 +473,7 @@ impl<'tcx> Visitor<'tcx> for IrMaps<'tcx> {\n             | hir::ExprKind::Struct(..)\n             | hir::ExprKind::Repeat(..)\n             | hir::ExprKind::InlineAsm(..)\n+            | hir::ExprKind::OffsetOf(..)\n             | hir::ExprKind::Type(..)\n             | hir::ExprKind::Err(_)\n             | hir::ExprKind::Path(hir::QPath::TypeRelative(..))\n@@ -1129,7 +1130,8 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n             | hir::ExprKind::ConstBlock(..)\n             | hir::ExprKind::Err(_)\n             | hir::ExprKind::Path(hir::QPath::TypeRelative(..))\n-            | hir::ExprKind::Path(hir::QPath::LangItem(..)) => succ,\n+            | hir::ExprKind::Path(hir::QPath::LangItem(..))\n+            | hir::ExprKind::OffsetOf(..) => succ,\n \n             // Note that labels have been resolved, so we don't need to look\n             // at the label ident\n@@ -1418,6 +1420,7 @@ fn check_expr<'tcx>(this: &mut Liveness<'_, 'tcx>, expr: &'tcx Expr<'tcx>) {\n         | hir::ExprKind::ConstBlock(..)\n         | hir::ExprKind::Block(..)\n         | hir::ExprKind::AddrOf(..)\n+        | hir::ExprKind::OffsetOf(..)\n         | hir::ExprKind::Struct(..)\n         | hir::ExprKind::Repeat(..)\n         | hir::ExprKind::Closure { .. }"}, {"sha": "cf8d9300a116749010bbb8a79c5048d69d5b2c72", "filename": "compiler/rustc_passes/src/naked_functions.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -203,6 +203,7 @@ impl<'tcx> CheckInlineAssembly<'tcx> {\n             | ExprKind::Break(..)\n             | ExprKind::Continue(..)\n             | ExprKind::Ret(..)\n+            | ExprKind::OffsetOf(..)\n             | ExprKind::Struct(..)\n             | ExprKind::Repeat(..)\n             | ExprKind::Yield(..) => {"}, {"sha": "9891915d076dd2bfe9eaae8d92204d5ecbd2b448", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1037,6 +1037,7 @@ symbols! {\n         object_safe_for_dispatch,\n         of,\n         offset,\n+        offset_of,\n         omit_gdb_pretty_printer_section,\n         on,\n         on_unimplemented,"}, {"sha": "589cd3cf96b3eca9ba18a7428d47ff207df107c5", "filename": "compiler/rustc_target/src/abi/mod.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_target%2Fsrc%2Fabi%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_target%2Fsrc%2Fabi%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fabi%2Fmod.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -124,6 +124,21 @@ impl<'a, Ty> TyAndLayout<'a, Ty> {\n     {\n         Ty::is_unit(self)\n     }\n+\n+    pub fn offset_of_subfield<C>(self, cx: &C, indices: impl Iterator<Item = usize>) -> Size\n+    where\n+        Ty: TyAbiInterface<'a, C>,\n+    {\n+        let mut layout = self;\n+        let mut offset = Size::ZERO;\n+\n+        for index in indices {\n+            offset += layout.fields.offset(index);\n+            layout = layout.field(cx, index);\n+        }\n+\n+        offset\n+    }\n }\n \n impl<'a, Ty> TyAndLayout<'a, Ty> {"}, {"sha": "b08a92570ed712cb5e03eeca0c152ff058d4fd71", "filename": "compiler/rustc_ty_utils/src/consts.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ty_utils%2Fsrc%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/compiler%2Frustc_ty_utils%2Fsrc%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fconsts.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -256,6 +256,7 @@ fn recurse_build<'tcx>(\n         ExprKind::VarRef { .. }\n         | ExprKind::UpvarRef { .. }\n         | ExprKind::StaticRef { .. }\n+        | ExprKind::OffsetOf { .. }\n         | ExprKind::ThreadLocalRef(_) => {\n             error(GenericConstantTooComplexSub::OperationNotSupported(node.span))?\n         }\n@@ -347,6 +348,7 @@ impl<'a, 'tcx> IsThirPolymorphic<'a, 'tcx> {\n             | thir::ExprKind::ZstLiteral { .. }\n             | thir::ExprKind::StaticRef { .. }\n             | thir::ExprKind::InlineAsm(_)\n+            | thir::ExprKind::OffsetOf { .. }\n             | thir::ExprKind::ThreadLocalRef(_)\n             | thir::ExprKind::Yield { .. } => false,\n         }"}, {"sha": "7d2f297152365ce72432c3cb1b0fa5b5a1892ba2", "filename": "library/core/src/mem/mod.rs", "status": "modified", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -1279,3 +1279,45 @@ pub trait SizedTypeProperties: Sized {\n #[doc(hidden)]\n #[unstable(feature = \"sized_type_properties\", issue = \"none\")]\n impl<T> SizedTypeProperties for T {}\n+\n+/// Expands to the offset in bytes of a field from the beginning of the given type.\n+///\n+/// Only structs, unions and tuples are supported.\n+///\n+/// Nested field accesses may be used, but not array indexes like in `C`'s `offsetof`.\n+///\n+/// Note that the output of this macro is not stable, except for `#[repr(C)]` types.\n+///\n+/// # Examples\n+///\n+/// ```\n+/// #![feature(offset_of)]\n+///\n+/// use std::mem;\n+/// #[repr(C)]\n+/// struct FieldStruct {\n+///     first: u8,\n+///     second: u16,\n+///     third: u8\n+/// }\n+///\n+/// assert_eq!(mem::offset_of!(FieldStruct, first), 0);\n+/// assert_eq!(mem::offset_of!(FieldStruct, second), 2);\n+/// assert_eq!(mem::offset_of!(FieldStruct, third), 4);\n+///\n+/// #[repr(C)]\n+/// struct NestedA {\n+///     b: NestedB\n+/// }\n+///\n+/// #[repr(C)]\n+/// struct NestedB(u8);\n+///\n+/// assert_eq!(mem::offset_of!(NestedA, b.0), 0);\n+/// ```\n+#[unstable(feature = \"offset_of\", issue = \"106655\")]\n+#[rustc_builtin_macro]\n+#[cfg(not(bootstrap))]\n+pub macro offset_of($Container:ty, $($fields:tt).+ $(,)?) {\n+    /* compiler built-in */\n+}"}, {"sha": "84859a54c2604134da5aef4a489f866de4aadd19", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -109,6 +109,7 @@\n #![feature(utf8_chunks)]\n #![feature(is_ascii_octdigit)]\n #![feature(get_many_mut)]\n+#![cfg_attr(not(bootstrap), feature(offset_of))]\n #![deny(unsafe_op_in_unsafe_fn)]\n #![deny(fuzzy_provenance_casts)]\n "}, {"sha": "7f0338169014147ac8d879cc491823a0962b160c", "filename": "library/core/tests/mem.rs", "status": "modified", "additions": 190, "deletions": 0, "changes": 190, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/library%2Fcore%2Ftests%2Fmem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/library%2Fcore%2Ftests%2Fmem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fmem.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -364,3 +364,193 @@ fn const_maybe_uninit() {\n \n     assert_eq!(FIELD_BY_FIELD, Foo { x: 1, y: 2 });\n }\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of() {\n+    #[repr(C)]\n+    struct Foo {\n+        x: u8,\n+        y: u16,\n+        z: Bar,\n+    }\n+\n+    #[repr(C)]\n+    struct Bar(u8, u8);\n+\n+    assert_eq!(offset_of!(Foo, x), 0);\n+    assert_eq!(offset_of!(Foo, y), 2);\n+    assert_eq!(offset_of!(Foo, z.0), 4);\n+    assert_eq!(offset_of!(Foo, z.1), 5);\n+\n+    // Layout of tuples is unstable\n+    assert!(offset_of!((u8, u16), 0) <= size_of::<(u8, u16)>() - 1);\n+    assert!(offset_of!((u8, u16), 1) <= size_of::<(u8, u16)>() - 2);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_union() {\n+    #[repr(C)]\n+    union Foo {\n+        x: u8,\n+        y: u16,\n+        z: Bar,\n+    }\n+\n+    #[repr(C)]\n+    #[derive(Copy, Clone)]\n+    struct Bar(u8, u8);\n+\n+    assert_eq!(offset_of!(Foo, x), 0);\n+    assert_eq!(offset_of!(Foo, y), 0);\n+    assert_eq!(offset_of!(Foo, z.0), 0);\n+    assert_eq!(offset_of!(Foo, z.1), 1);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_dst() {\n+    #[repr(C)]\n+    struct Alpha {\n+        x: u8,\n+        y: u16,\n+        z: [u8],\n+    }\n+\n+    trait Trait {}\n+\n+    #[repr(C)]\n+    struct Beta {\n+        x: u8,\n+        y: u16,\n+        z: dyn Trait,\n+    }\n+\n+    extern \"C\" {\n+        type Extern;\n+    }\n+\n+    #[repr(C)]\n+    struct Gamma {\n+        x: u8,\n+        y: u16,\n+        z: Extern,\n+    }\n+\n+    assert_eq!(offset_of!(Alpha, x), 0);\n+    assert_eq!(offset_of!(Alpha, y), 2);\n+\n+    assert_eq!(offset_of!(Beta, x), 0);\n+    assert_eq!(offset_of!(Beta, y), 2);\n+\n+    assert_eq!(offset_of!(Gamma, x), 0);\n+    assert_eq!(offset_of!(Gamma, y), 2);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_packed() {\n+    #[repr(C, packed)]\n+    struct Foo {\n+        x: u8,\n+        y: u16,\n+    }\n+\n+    assert_eq!(offset_of!(Foo, x), 0);\n+    assert_eq!(offset_of!(Foo, y), 1);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_projection() {\n+    #[repr(C)]\n+    struct Foo {\n+        x: u8,\n+        y: u16,\n+    }\n+\n+    trait Projector {\n+        type Type;\n+    }\n+\n+    impl Projector for () {\n+        type Type = Foo;\n+    }\n+\n+    assert_eq!(offset_of!(<() as Projector>::Type, x), 0);\n+    assert_eq!(offset_of!(<() as Projector>::Type, y), 2);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_alias() {\n+    #[repr(C)]\n+    struct Foo {\n+        x: u8,\n+        y: u16,\n+    }\n+\n+    type Bar = Foo;\n+\n+    assert_eq!(offset_of!(Bar, x), 0);\n+    assert_eq!(offset_of!(Bar, y), 2);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn const_offset_of() {\n+    #[repr(C)]\n+    struct Foo {\n+        x: u8,\n+        y: u16,\n+    }\n+\n+    const X_OFFSET: usize = offset_of!(Foo, x);\n+    const Y_OFFSET: usize = offset_of!(Foo, y);\n+\n+    assert_eq!(X_OFFSET, 0);\n+    assert_eq!(Y_OFFSET, 2);\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_without_const_promotion() {\n+    #[repr(C)]\n+    struct Foo<SuppressConstPromotion> {\n+        x: u8,\n+        y: u16,\n+        _scp: SuppressConstPromotion,\n+    }\n+\n+    // Normally, offset_of is always const promoted.\n+    // The generic parameter prevents this from happening.\n+    // This is needed to test the codegen impl of offset_of\n+    fn inner<SuppressConstPromotion>() {\n+        assert_eq!(offset_of!(Foo<SuppressConstPromotion>, x), 0);\n+        assert_eq!(offset_of!(Foo<SuppressConstPromotion>, y), 2);\n+    }\n+\n+    inner::<()>();\n+}\n+\n+#[test]\n+#[cfg(not(bootstrap))]\n+fn offset_of_addr() {\n+    #[repr(C)]\n+    struct Foo {\n+        x: u8,\n+        y: u16,\n+        z: Bar,\n+    }\n+\n+    #[repr(C)]\n+    struct Bar(u8, u8);\n+\n+    let base = Foo { x: 0, y: 0, z: Bar(0, 0) };\n+\n+    assert_eq!(ptr::addr_of!(base).addr() + offset_of!(Foo, x), ptr::addr_of!(base.x).addr());\n+    assert_eq!(ptr::addr_of!(base).addr() + offset_of!(Foo, y), ptr::addr_of!(base.y).addr());\n+    assert_eq!(ptr::addr_of!(base).addr() + offset_of!(Foo, z.0), ptr::addr_of!(base.z.0).addr());\n+    assert_eq!(ptr::addr_of!(base).addr() + offset_of!(Foo, z.1), ptr::addr_of!(base.z.1).addr());\n+}"}, {"sha": "5f1fdf00be8c3fc11df5dc1a0eced013ff23f69d", "filename": "src/tools/clippy/clippy_lints/src/loops/never_loop.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fnever_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fnever_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fnever_loop.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -226,7 +226,8 @@ fn never_loop_expr(expr: &Expr<'_>, ignore_ids: &mut Vec<HirId>, main_loop_id: H\n                 | InlineAsmOperand::SymStatic { .. } => NeverLoopResult::Otherwise,\n             })\n             .fold(NeverLoopResult::Otherwise, combine_seq),\n-        ExprKind::Yield(_, _)\n+        ExprKind::OffsetOf(_, _)\n+        | ExprKind::Yield(_, _)\n         | ExprKind::Closure { .. }\n         | ExprKind::Path(_)\n         | ExprKind::ConstBlock(_)"}, {"sha": "7945275393c04e5e666611c0df065b1562ae9873", "filename": "src/tools/clippy/clippy_lints/src/matches/significant_drop_in_scrutinee.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches%2Fsignificant_drop_in_scrutinee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches%2Fsignificant_drop_in_scrutinee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches%2Fsignificant_drop_in_scrutinee.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -342,6 +342,7 @@ impl<'a, 'tcx> Visitor<'tcx> for SigDropHelper<'a, 'tcx> {\n             ExprKind::DropTemps(_) |\n             ExprKind::Err(_) |\n             ExprKind::InlineAsm(_) |\n+            ExprKind::OffsetOf(_, _) |\n             ExprKind::Let(_) |\n             ExprKind::Lit(_) |\n             ExprKind::Loop(_, _, _, _) |"}, {"sha": "01927b6b5f10d91958e6c1679bcfeac2767eb6b2", "filename": "src/tools/clippy/clippy_lints/src/utils/author.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fauthor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fauthor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fauthor.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -558,6 +558,10 @@ impl<'a, 'tcx> PrintVisitor<'a, 'tcx> {\n                 kind!(\"InlineAsm(_)\");\n                 out!(\"// unimplemented: `ExprKind::InlineAsm` is not further destructured at the moment\");\n             },\n+            ExprKind::OffsetOf(container, ref fields) => {\n+                bind!(self, container, fields);\n+                kind!(\"OffsetOf({container}, {fields})\");\n+            }\n             ExprKind::Struct(qpath, fields, base) => {\n                 bind!(self, qpath, fields);\n                 opt_bind!(self, base);"}, {"sha": "3df40942e7b5a5ee3652514342da623f63ae3d8b", "filename": "src/tools/clippy/clippy_utils/src/eager_or_lazy.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Feager_or_lazy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Feager_or_lazy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Feager_or_lazy.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -218,7 +218,8 @@ fn expr_eagerness<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> EagernessS\n                 | ExprKind::AddrOf(..)\n                 | ExprKind::Struct(..)\n                 | ExprKind::Repeat(..)\n-                | ExprKind::Block(Block { stmts: [], .. }, _) => (),\n+                | ExprKind::Block(Block { stmts: [], .. }, _)\n+                | ExprKind::OffsetOf(..) => (),\n \n                 // Assignment might be to a local defined earlier, so don't eagerly evaluate.\n                 // Blocks with multiple statements might be expensive, so don't eagerly evaluate."}, {"sha": "d972ed82c258b41bcdaed8ee73ec2d0e869c7384", "filename": "src/tools/clippy/clippy_utils/src/hir_utils.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhir_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhir_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhir_utils.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -301,6 +301,9 @@ impl HirEqInterExpr<'_, '_, '_> {\n             (&ExprKind::Unary(l_op, le), &ExprKind::Unary(r_op, re)) => l_op == r_op && self.eq_expr(le, re),\n             (&ExprKind::Array(l), &ExprKind::Array(r)) => self.eq_exprs(l, r),\n             (&ExprKind::DropTemps(le), &ExprKind::DropTemps(re)) => self.eq_expr(le, re),\n+            (&ExprKind::OffsetOf(l_container, ref l_fields), &ExprKind::OffsetOf(r_container, ref r_fields)) => {\n+                self.eq_ty(l_container, r_container) && over(l_fields, r_fields, |l, r| l.name == r.name)\n+            },\n             _ => false,\n         };\n         (is_eq && (!self.should_ignore(left) || !self.should_ignore(right)))\n@@ -701,6 +704,12 @@ impl<'a, 'tcx> SpanlessHash<'a, 'tcx> {\n                     }\n                 }\n             },\n+            ExprKind::OffsetOf(container, fields) => {\n+                self.hash_ty(container);\n+                for field in fields {\n+                    self.hash_name(field.name);\n+                }\n+            },\n             ExprKind::Let(Let { pat, init, ty, .. }) => {\n                 self.hash_expr(init);\n                 if let Some(ty) = ty {"}, {"sha": "ecd712f32dc1f29fb3efa950891fe026188ab9bc", "filename": "src/tools/clippy/clippy_utils/src/qualify_min_const_fn.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fqualify_min_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fqualify_min_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fqualify_min_const_fn.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -194,7 +194,7 @@ fn check_rvalue<'tcx>(\n                 ))\n             }\n         },\n-        Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf, _) | Rvalue::ShallowInitBox(_, _) => Ok(()),\n+        Rvalue::NullaryOp(NullOp::SizeOf | NullOp::AlignOf | NullOp::OffsetOf(_), _) | Rvalue::ShallowInitBox(_, _) => Ok(()),\n         Rvalue::UnaryOp(_, operand) => {\n             let ty = operand.ty(body, tcx);\n             if ty.is_integral() || ty.is_bool() {"}, {"sha": "e81eadceec0aa5ee53dc10bd74fb2d961fbcbe42", "filename": "src/tools/clippy/clippy_utils/src/sugg.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fsugg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fsugg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fsugg.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -139,6 +139,7 @@ impl<'a> Sugg<'a> {\n             | hir::ExprKind::Field(..)\n             | hir::ExprKind::Index(..)\n             | hir::ExprKind::InlineAsm(..)\n+            | hir::ExprKind::OffsetOf(..)\n             | hir::ExprKind::ConstBlock(..)\n             | hir::ExprKind::Lit(..)\n             | hir::ExprKind::Loop(..)\n@@ -197,6 +198,7 @@ impl<'a> Sugg<'a> {\n             | ast::ExprKind::ForLoop(..)\n             | ast::ExprKind::Index(..)\n             | ast::ExprKind::InlineAsm(..)\n+            | ast::ExprKind::OffsetOf(..)\n             | ast::ExprKind::ConstBlock(..)\n             | ast::ExprKind::Lit(..)\n             | ast::ExprKind::IncludedBytes(..)"}, {"sha": "5dcd71cef127e4b9d0a4a23c54e0f198138862c0", "filename": "src/tools/clippy/clippy_utils/src/visitors.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fvisitors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fvisitors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fvisitors.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -662,6 +662,7 @@ pub fn for_each_unconsumed_temporary<'tcx, B>(\n             | ExprKind::Path(_)\n             | ExprKind::Continue(_)\n             | ExprKind::InlineAsm(_)\n+            | ExprKind::OffsetOf(..)\n             | ExprKind::Err(_) => (),\n         }\n         ControlFlow::Continue(())"}, {"sha": "824e42191364f06ef43f7df8945dac5f0064b014", "filename": "src/tools/rustfmt/src/expr.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Frustfmt%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Frustfmt%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt%2Fsrc%2Fexpr.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -399,7 +399,9 @@ pub(crate) fn format_expr(\n             }\n         }\n         ast::ExprKind::Underscore => Some(\"_\".to_owned()),\n-        ast::ExprKind::FormatArgs(..) | ast::ExprKind::IncludedBytes(..) => {\n+        ast::ExprKind::FormatArgs(..)\n+        | ast::ExprKind::IncludedBytes(..)\n+        | ast::ExprKind::OffsetOf(..) => {\n             // These do not occur in the AST because macros aren't expanded.\n             unreachable!()\n         }"}, {"sha": "ca1716574071b61f4500a6d9d42d0d6ff3160751", "filename": "src/tools/rustfmt/src/utils.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Frustfmt%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/src%2Ftools%2Frustfmt%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt%2Fsrc%2Futils.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -499,6 +499,7 @@ pub(crate) fn is_block_expr(context: &RewriteContext<'_>, expr: &ast::Expr, repr\n         | ast::ExprKind::Field(..)\n         | ast::ExprKind::IncludedBytes(..)\n         | ast::ExprKind::InlineAsm(..)\n+        | ast::ExprKind::OffsetOf(..)\n         | ast::ExprKind::Let(..)\n         | ast::ExprKind::Path(..)\n         | ast::ExprKind::Range(..)"}, {"sha": "4e2f1b39d2b160b3c46a1d43634f5f3dcb693b99", "filename": "tests/mir-opt/const_prop/offset_of.concrete.ConstProp.diff", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.concrete.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.concrete.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.concrete.ConstProp.diff?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,43 @@\n+- // MIR for `concrete` before ConstProp\n++ // MIR for `concrete` after ConstProp\n+  \n+  fn concrete() -> () {\n+      let mut _0: ();                      // return place in scope 0 at $DIR/offset_of.rs:+0:15: +0:15\n+      let _1: usize;                       // in scope 0 at $DIR/offset_of.rs:+1:9: +1:10\n+      scope 1 {\n+          debug x => _1;                   // in scope 1 at $DIR/offset_of.rs:+1:9: +1:10\n+          let _2: usize;                   // in scope 1 at $DIR/offset_of.rs:+2:9: +2:10\n+          scope 2 {\n+              debug y => _2;               // in scope 2 at $DIR/offset_of.rs:+2:9: +2:10\n+              let _3: usize;               // in scope 2 at $DIR/offset_of.rs:+3:9: +3:11\n+              scope 3 {\n+                  debug z0 => _3;          // in scope 3 at $DIR/offset_of.rs:+3:9: +3:11\n+                  let _4: usize;           // in scope 3 at $DIR/offset_of.rs:+4:9: +4:11\n+                  scope 4 {\n+                      debug z1 => _4;      // in scope 4 at $DIR/offset_of.rs:+4:9: +4:11\n+                  }\n+              }\n+          }\n+      }\n+  \n+      bb0: {\n+          StorageLive(_1);                 // scope 0 at $DIR/offset_of.rs:+1:9: +1:10\n+-         _1 = OffsetOf(Alpha, [0]);       // scope 0 at $DIR/offset_of.rs:+1:13: +1:33\n++         _1 = const 4_usize;              // scope 0 at $DIR/offset_of.rs:+1:13: +1:33\n+          StorageLive(_2);                 // scope 1 at $DIR/offset_of.rs:+2:9: +2:10\n+-         _2 = OffsetOf(Alpha, [1]);       // scope 1 at $DIR/offset_of.rs:+2:13: +2:33\n++         _2 = const 0_usize;              // scope 1 at $DIR/offset_of.rs:+2:13: +2:33\n+          StorageLive(_3);                 // scope 2 at $DIR/offset_of.rs:+3:9: +3:11\n+-         _3 = OffsetOf(Alpha, [2, 0]);    // scope 2 at $DIR/offset_of.rs:+3:14: +3:36\n++         _3 = const 2_usize;              // scope 2 at $DIR/offset_of.rs:+3:14: +3:36\n+          StorageLive(_4);                 // scope 3 at $DIR/offset_of.rs:+4:9: +4:11\n+-         _4 = OffsetOf(Alpha, [2, 1]);    // scope 3 at $DIR/offset_of.rs:+4:14: +4:36\n++         _4 = const 3_usize;              // scope 3 at $DIR/offset_of.rs:+4:14: +4:36\n+          StorageDead(_4);                 // scope 3 at $DIR/offset_of.rs:+5:1: +5:2\n+          StorageDead(_3);                 // scope 2 at $DIR/offset_of.rs:+5:1: +5:2\n+          StorageDead(_2);                 // scope 1 at $DIR/offset_of.rs:+5:1: +5:2\n+          StorageDead(_1);                 // scope 0 at $DIR/offset_of.rs:+5:1: +5:2\n+          return;                          // scope 0 at $DIR/offset_of.rs:+5:2: +5:2\n+      }\n+  }\n+  "}, {"sha": "5c6cb47089e82201d089e77162ddc93f5166d54d", "filename": "tests/mir-opt/const_prop/offset_of.generic.ConstProp.diff", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.generic.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.generic.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.generic.ConstProp.diff?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,39 @@\n+- // MIR for `generic` before ConstProp\n++ // MIR for `generic` after ConstProp\n+  \n+  fn generic() -> () {\n+      let mut _0: ();                      // return place in scope 0 at $DIR/offset_of.rs:+0:17: +0:17\n+      let _1: usize;                       // in scope 0 at $DIR/offset_of.rs:+1:9: +1:11\n+      scope 1 {\n+          debug gx => _1;                  // in scope 1 at $DIR/offset_of.rs:+1:9: +1:11\n+          let _2: usize;                   // in scope 1 at $DIR/offset_of.rs:+2:9: +2:11\n+          scope 2 {\n+              debug gy => _2;              // in scope 2 at $DIR/offset_of.rs:+2:9: +2:11\n+              let _3: usize;               // in scope 2 at $DIR/offset_of.rs:+3:9: +3:11\n+              scope 3 {\n+                  debug dx => _3;          // in scope 3 at $DIR/offset_of.rs:+3:9: +3:11\n+                  let _4: usize;           // in scope 3 at $DIR/offset_of.rs:+4:9: +4:11\n+                  scope 4 {\n+                      debug dy => _4;      // in scope 4 at $DIR/offset_of.rs:+4:9: +4:11\n+                  }\n+              }\n+          }\n+      }\n+  \n+      bb0: {\n+          StorageLive(_1);                 // scope 0 at $DIR/offset_of.rs:+1:9: +1:11\n+          _1 = OffsetOf(Gamma<T>, [0]);    // scope 0 at $DIR/offset_of.rs:+1:14: +1:37\n+          StorageLive(_2);                 // scope 1 at $DIR/offset_of.rs:+2:9: +2:11\n+          _2 = OffsetOf(Gamma<T>, [1]);    // scope 1 at $DIR/offset_of.rs:+2:14: +2:37\n+          StorageLive(_3);                 // scope 2 at $DIR/offset_of.rs:+3:9: +3:11\n+          _3 = OffsetOf(Delta<T>, [1]);    // scope 2 at $DIR/offset_of.rs:+3:14: +3:37\n+          StorageLive(_4);                 // scope 3 at $DIR/offset_of.rs:+4:9: +4:11\n+          _4 = OffsetOf(Delta<T>, [2]);    // scope 3 at $DIR/offset_of.rs:+4:14: +4:37\n+          StorageDead(_4);                 // scope 3 at $DIR/offset_of.rs:+5:1: +5:2\n+          StorageDead(_3);                 // scope 2 at $DIR/offset_of.rs:+5:1: +5:2\n+          StorageDead(_2);                 // scope 1 at $DIR/offset_of.rs:+5:1: +5:2\n+          StorageDead(_1);                 // scope 0 at $DIR/offset_of.rs:+5:1: +5:2\n+          return;                          // scope 0 at $DIR/offset_of.rs:+5:2: +5:2\n+      }\n+  }\n+  "}, {"sha": "eabdf848079862c70d0f9d29f2f37f40fe6967bd", "filename": "tests/mir-opt/const_prop/offset_of.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Foffset_of.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,49 @@\n+// unit-test\n+// compile-flags: -O\n+\n+#![feature(offset_of)]\n+\n+use std::marker::PhantomData;\n+use std::mem::offset_of;\n+\n+struct Alpha {\n+    x: u8,\n+    y: u16,\n+    z: Beta,\n+}\n+\n+struct Beta(u8, u8);\n+\n+struct Gamma<T> {\n+    x: u8,\n+    y: u16,\n+    _t: T,\n+}\n+\n+#[repr(C)]\n+struct Delta<T> {\n+    _phantom: PhantomData<T>,\n+    x: u8,\n+    y: u16,\n+}\n+\n+// EMIT_MIR offset_of.concrete.ConstProp.diff\n+fn concrete() {\n+    let x = offset_of!(Alpha, x);\n+    let y = offset_of!(Alpha, y);\n+    let z0 = offset_of!(Alpha, z.0);\n+    let z1 = offset_of!(Alpha, z.1);\n+}\n+\n+// EMIT_MIR offset_of.generic.ConstProp.diff\n+fn generic<T>() {\n+    let gx = offset_of!(Gamma<T>, x);\n+    let gy = offset_of!(Gamma<T>, y);\n+    let dx = offset_of!(Delta<T>, x);\n+    let dy = offset_of!(Delta<T>, y);\n+}\n+\n+fn main() {\n+    concrete();\n+    generic::<()>();\n+}"}, {"sha": "2c6fcef2500494b1ad51c2fec123b165ed8fcb71", "filename": "tests/ui/lint/dead-code/offset-of-correct-param-env.rs", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Flint%2Fdead-code%2Foffset-of-correct-param-env.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Flint%2Fdead-code%2Foffset-of-correct-param-env.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Fdead-code%2Foffset-of-correct-param-env.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,42 @@\n+// check-pass\n+\n+#![feature(offset_of)]\n+#![deny(dead_code)]\n+\n+// This struct contains a projection that can only be normalized after getting the field type.\n+struct A<T: Project> {\n+    a: <T as Project>::EquateParamTo,\n+}\n+\n+// This is the inner struct that we want to get.\n+struct MyFieldIsNotDead {\n+    not_dead: u8,\n+}\n+\n+// These are some helpers.\n+// Inside the param env of `test`, we want to make it so that it considers T=MyFieldIsNotDead.\n+struct GenericIsEqual<T>(T);\n+trait Project {\n+    type EquateParamTo;\n+}\n+impl<T> Project for GenericIsEqual<T> {\n+    type EquateParamTo = T;\n+}\n+\n+fn test<T>() -> usize\n+where\n+    GenericIsEqual<T>: Project<EquateParamTo = MyFieldIsNotDead>,\n+{\n+    // The first field of the A that we construct here is\n+    // `<GenericIsEqual<T>> as Project>::EquateParamTo`.\n+    // Typeck normalizes this and figures that the not_dead field is totally fine and accessible.\n+    // But importantly, the normalization ends up with T, which, as we've declared in our param\n+    // env is MyFieldDead. When we're in the param env of the `a` field, the where bound above\n+    // is not in scope, so we don't know what T is - it's generic.\n+    // If we use the wrong param env, the lint will ICE.\n+    std::mem::offset_of!(A<GenericIsEqual<T>>, a.not_dead)\n+}\n+\n+fn main() {\n+    test::<MyFieldIsNotDead>();\n+}"}, {"sha": "da91de3862fc83c164b7dbd26c47bd183f176bf9", "filename": "tests/ui/lint/dead-code/offset-of.rs", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Flint%2Fdead-code%2Foffset-of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Flint%2Fdead-code%2Foffset-of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Fdead-code%2Foffset-of.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,44 @@\n+#![feature(offset_of)]\n+#![deny(dead_code)]\n+\n+use std::mem::offset_of;\n+\n+struct Alpha {\n+    a: (),\n+    b: (), //~ ERROR field `b` is never read\n+    c: Beta,\n+}\n+\n+struct Beta {\n+    a: (), //~ ERROR field `a` is never read\n+    b: (),\n+}\n+\n+struct Gamma {\n+    a: (), //~ ERROR field `a` is never read\n+    b: (),\n+}\n+\n+struct Delta {\n+    a: (),\n+    b: (), //~ ERROR field `b` is never read\n+}\n+\n+trait Trait {\n+    type Assoc;\n+}\n+impl Trait for () {\n+    type Assoc = Delta;\n+}\n+\n+struct Project<T: Trait> {\n+    a: u8, //~ ERROR field `a` is never read\n+    b: <T as Trait>::Assoc,\n+}\n+\n+fn main() {\n+    offset_of!(Alpha, a);\n+    offset_of!(Alpha, c.b);\n+    offset_of!((Gamma,), 0.b);\n+    offset_of!(Project::<()>, b.a);\n+}"}, {"sha": "ed2916461cde8d1532b9b9612a11de59cb4f794f", "filename": "tests/ui/lint/dead-code/offset-of.stderr", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Flint%2Fdead-code%2Foffset-of.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Flint%2Fdead-code%2Foffset-of.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Fdead-code%2Foffset-of.stderr?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,50 @@\n+error: field `b` is never read\n+  --> $DIR/offset-of.rs:8:5\n+   |\n+LL | struct Alpha {\n+   |        ----- field in this struct\n+LL |     a: (),\n+LL |     b: (),\n+   |     ^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/offset-of.rs:2:9\n+   |\n+LL | #![deny(dead_code)]\n+   |         ^^^^^^^^^\n+\n+error: field `a` is never read\n+  --> $DIR/offset-of.rs:13:5\n+   |\n+LL | struct Beta {\n+   |        ---- field in this struct\n+LL |     a: (),\n+   |     ^\n+\n+error: field `a` is never read\n+  --> $DIR/offset-of.rs:18:5\n+   |\n+LL | struct Gamma {\n+   |        ----- field in this struct\n+LL |     a: (),\n+   |     ^\n+\n+error: field `b` is never read\n+  --> $DIR/offset-of.rs:24:5\n+   |\n+LL | struct Delta {\n+   |        ----- field in this struct\n+LL |     a: (),\n+LL |     b: (),\n+   |     ^\n+\n+error: field `a` is never read\n+  --> $DIR/offset-of.rs:35:5\n+   |\n+LL | struct Project<T: Trait> {\n+   |        ------- field in this struct\n+LL |     a: u8,\n+   |     ^\n+\n+error: aborting due to 5 previous errors\n+"}, {"sha": "09e071ec45420d6500047f485892a5ba71ca9eff", "filename": "tests/ui/macros/user-defined-macro-rules.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Fmacros%2Fuser-defined-macro-rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Fmacros%2Fuser-defined-macro-rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fuser-defined-macro-rules.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "previous_filename": "tests/ui/user-defined-macro-rules.rs"}, {"sha": "088086cc580524cd0a9f8aadf7e9a27ac187ca5e", "filename": "tests/ui/offset-of/auxiliary/offset-of-staged-api.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Fauxiliary%2Foffset-of-staged-api.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Fauxiliary%2Foffset-of-staged-api.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Fauxiliary%2Foffset-of-staged-api.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,33 @@\n+#![crate_type = \"lib\"]\n+#![feature(staged_api)]\n+#![stable(feature = \"stable_test_feature\", since = \"1.0\")]\n+\n+#[unstable(feature = \"unstable_test_feature\", issue = \"none\")]\n+pub struct Unstable {\n+    #[unstable(feature = \"unstable_test_feature\", issue = \"none\")]\n+    pub unstable: u8,\n+}\n+\n+#[stable(feature = \"stable_test_feature\", since = \"1.0\")]\n+pub struct Stable {\n+    #[stable(feature = \"stable_test_feature\", since = \"1.0\")]\n+    pub stable: u8,\n+}\n+\n+#[stable(feature = \"stable_test_feature\", since = \"1.0\")]\n+pub struct StableWithUnstableField {\n+    #[unstable(feature = \"unstable_test_feature\", issue = \"none\")]\n+    pub unstable: u8,\n+}\n+\n+#[stable(feature = \"stable_test_feature\", since = \"1.0\")]\n+pub struct StableWithUnstableFieldType {\n+    #[stable(feature = \"stable_test_feature\", since = \"1.0\")]\n+    pub stable: Unstable,\n+}\n+\n+#[unstable(feature = \"unstable_test_feature\", issue = \"none\")]\n+pub struct UnstableWithStableFieldType {\n+    #[unstable(feature = \"unstable_test_feature\", issue = \"none\")]\n+    pub unstable: Stable,\n+}"}, {"sha": "163b07454ecdf3baf8367a949e88ef6e053576f2", "filename": "tests/ui/offset-of/offset-of-arg-count.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-arg-count.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-arg-count.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-arg-count.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,9 @@\n+#![feature(offset_of)]\n+\n+use std::mem::offset_of;\n+\n+fn main() {\n+    offset_of!(NotEnoughArguments); //~ ERROR expected one of\n+    offset_of!(NotEnoughArgumentsWithAComma, ); //~ ERROR expected 2 arguments\n+    offset_of!(Container, field, too many arguments); //~ ERROR expected 2 arguments\n+}"}, {"sha": "ebecc982c5174c9700054088eb61d0b9a779ee76", "filename": "tests/ui/offset-of/offset-of-arg-count.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-arg-count.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-arg-count.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-arg-count.stderr?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,20 @@\n+error: expected one of `!`, `(`, `+`, `,`, `::`, or `<`, found `<eof>`\n+  --> $DIR/offset-of-arg-count.rs:6:16\n+   |\n+LL |     offset_of!(NotEnoughArguments);\n+   |                ^^^^^^^^^^^^^^^^^^ expected one of `!`, `(`, `+`, `,`, `::`, or `<`\n+\n+error: expected 2 arguments\n+  --> $DIR/offset-of-arg-count.rs:7:5\n+   |\n+LL |     offset_of!(NotEnoughArgumentsWithAComma, );\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: expected 2 arguments\n+  --> $DIR/offset-of-arg-count.rs:8:5\n+   |\n+LL |     offset_of!(Container, field, too many arguments);\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "a0269ca2d125168fe3e0e51ca9ce9ce662be4fde", "filename": "tests/ui/offset-of/offset-of-dst-field.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-dst-field.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-dst-field.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-dst-field.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,33 @@\n+#![feature(offset_of, extern_types)]\n+\n+use std::mem::offset_of;\n+\n+struct Alpha {\n+    x: u8,\n+    y: u16,\n+    z: [u8],\n+}\n+\n+trait Trait {}\n+\n+struct Beta {\n+    x: u8,\n+    y: u16,\n+    z: dyn Trait,\n+}\n+\n+extern {\n+    type Extern;\n+}\n+\n+struct Gamma {\n+    x: u8,\n+    y: u16,\n+    z: Extern,\n+}\n+\n+fn main() {\n+    offset_of!(Alpha, z); //~ ERROR the size for values of type\n+    offset_of!(Beta, z); //~ ERROR the size for values of type\n+    offset_of!(Gamma, z); //~ ERROR the size for values of type\n+}"}, {"sha": "8e88015b07a74606b19d0c3afddff24d1db3603b", "filename": "tests/ui/offset-of/offset-of-dst-field.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-dst-field.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-dst-field.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-dst-field.stderr?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,27 @@\n+error[E0277]: the size for values of type `[u8]` cannot be known at compilation time\n+  --> $DIR/offset-of-dst-field.rs:30:5\n+   |\n+LL |     offset_of!(Alpha, z);\n+   |     ^^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `[u8]`\n+\n+error[E0277]: the size for values of type `(dyn Trait + 'static)` cannot be known at compilation time\n+  --> $DIR/offset-of-dst-field.rs:31:5\n+   |\n+LL |     offset_of!(Beta, z);\n+   |     ^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `(dyn Trait + 'static)`\n+\n+error[E0277]: the size for values of type `Extern` cannot be known at compilation time\n+  --> $DIR/offset-of-dst-field.rs:32:5\n+   |\n+LL |     offset_of!(Gamma, z);\n+   |     ^^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `Extern`\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0277`."}, {"sha": "d73505821ff5341ff54131c735e6a6b8cfd92ee4", "filename": "tests/ui/offset-of/offset-of-enum.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-enum.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,13 @@\n+#![feature(offset_of)]\n+\n+use std::mem::offset_of;\n+\n+enum Alpha {\n+    One(u8),\n+    Two(u8),\n+}\n+\n+fn main() {\n+    offset_of!(Alpha::One, 0); //~ ERROR expected type, found variant `Alpha::One`\n+    offset_of!(Alpha, Two.0); //~ ERROR no field `Two` on type `Alpha`\n+}"}, {"sha": "6958d199fbdb4b1c9da13f7275bf950098d4a3f7", "filename": "tests/ui/offset-of/offset-of-enum.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-enum.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-enum.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-enum.stderr?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,19 @@\n+error[E0573]: expected type, found variant `Alpha::One`\n+  --> $DIR/offset-of-enum.rs:11:16\n+   |\n+LL |     offset_of!(Alpha::One, 0);\n+   |                ^^^^^^^^^^\n+   |                |\n+   |                not a type\n+   |                help: try using the variant's enum: `Alpha`\n+\n+error[E0609]: no field `Two` on type `Alpha`\n+  --> $DIR/offset-of-enum.rs:12:23\n+   |\n+LL |     offset_of!(Alpha, Two.0);\n+   |                       ^^^\n+\n+error: aborting due to 2 previous errors\n+\n+Some errors have detailed explanations: E0573, E0609.\n+For more information about an error, try `rustc --explain E0573`."}, {"sha": "0291b7825cabc47cc4c89abf3aa6d7a0d4bf6c7b", "filename": "tests/ui/offset-of/offset-of-private.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-private.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,16 @@\n+#![feature(offset_of)]\n+\n+use std::mem::offset_of;\n+\n+mod m {\n+    #[repr(C)]\n+    pub struct Foo {\n+        pub public: u8,\n+        private: u8,\n+    }\n+}\n+\n+fn main() {\n+    offset_of!(m::Foo, public);\n+    offset_of!(m::Foo, private); //~ ERROR field `private` of struct `Foo` is private\n+}"}, {"sha": "8a186dd5a02e7e862dc3a62f5bc638f98986d736", "filename": "tests/ui/offset-of/offset-of-private.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-private.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-private.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-private.stderr?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,9 @@\n+error[E0616]: field `private` of struct `Foo` is private\n+  --> $DIR/offset-of-private.rs:15:24\n+   |\n+LL |     offset_of!(m::Foo, private);\n+   |                        ^^^^^^^ private field\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0616`."}, {"sha": "7d2eb46c056eba68ace92fd0f61c0dcfd5a55396", "filename": "tests/ui/offset-of/offset-of-unstable-with-feature.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-unstable-with-feature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-unstable-with-feature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-unstable-with-feature.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,20 @@\n+// check-pass\n+// aux-build:offset-of-staged-api.rs\n+\n+#![feature(offset_of, unstable_test_feature)]\n+\n+use std::mem::offset_of;\n+\n+extern crate offset_of_staged_api;\n+\n+use offset_of_staged_api::*;\n+\n+fn main() {\n+    offset_of!(Unstable, unstable);\n+    offset_of!(Stable, stable);\n+    offset_of!(StableWithUnstableField, unstable);\n+    offset_of!(StableWithUnstableFieldType, stable);\n+    offset_of!(StableWithUnstableFieldType, stable.unstable);\n+    offset_of!(UnstableWithStableFieldType, unstable);\n+    offset_of!(UnstableWithStableFieldType, unstable.stable);\n+}"}, {"sha": "1e19f2091f29f0e5b70a68d9397360edf6a385ae", "filename": "tests/ui/offset-of/offset-of-unstable.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-unstable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-unstable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-unstable.rs?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,31 @@\n+// aux-build:offset-of-staged-api.rs\n+\n+#![feature(offset_of)]\n+\n+use std::mem::offset_of;\n+\n+extern crate offset_of_staged_api;\n+\n+use offset_of_staged_api::*;\n+\n+fn main() {\n+    offset_of!(\n+        //~^ ERROR use of unstable library feature\n+        Unstable, //~ ERROR use of unstable library feature\n+        unstable\n+    );\n+    offset_of!(Stable, stable);\n+    offset_of!(StableWithUnstableField, unstable); //~ ERROR use of unstable library feature\n+    offset_of!(StableWithUnstableFieldType, stable);\n+    offset_of!(StableWithUnstableFieldType, stable.unstable); //~ ERROR use of unstable library feature\n+    offset_of!(\n+        //~^ ERROR use of unstable library feature\n+        UnstableWithStableFieldType, //~ ERROR use of unstable library feature\n+        unstable\n+    );\n+    offset_of!(\n+        //~^ ERROR use of unstable library feature\n+        UnstableWithStableFieldType, //~ ERROR use of unstable library feature\n+        unstable.stable\n+    );\n+}"}, {"sha": "25811a061d7f01491232b2dd2c6709b164ac4d1c", "filename": "tests/ui/offset-of/offset-of-unstable.stderr", "status": "added", "additions": 79, "deletions": 0, "changes": 79, "blob_url": "https://github.com/rust-lang/rust/blob/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-unstable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80a2ec49a4ffb7a351c41c8db14711297324b587/tests%2Fui%2Foffset-of%2Foffset-of-unstable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foffset-of%2Foffset-of-unstable.stderr?ref=80a2ec49a4ffb7a351c41c8db14711297324b587", "patch": "@@ -0,0 +1,79 @@\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:14:9\n+   |\n+LL |         Unstable,\n+   |         ^^^^^^^^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:23:9\n+   |\n+LL |         UnstableWithStableFieldType,\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:28:9\n+   |\n+LL |         UnstableWithStableFieldType,\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:12:5\n+   |\n+LL | /     offset_of!(\n+LL | |\n+LL | |         Unstable,\n+LL | |         unstable\n+LL | |     );\n+   | |_____^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:18:5\n+   |\n+LL |     offset_of!(StableWithUnstableField, unstable);\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:20:5\n+   |\n+LL |     offset_of!(StableWithUnstableFieldType, stable.unstable);\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:21:5\n+   |\n+LL | /     offset_of!(\n+LL | |\n+LL | |         UnstableWithStableFieldType,\n+LL | |         unstable\n+LL | |     );\n+   | |_____^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error[E0658]: use of unstable library feature 'unstable_test_feature'\n+  --> $DIR/offset-of-unstable.rs:26:5\n+   |\n+LL | /     offset_of!(\n+LL | |\n+LL | |         UnstableWithStableFieldType,\n+LL | |         unstable.stable\n+LL | |     );\n+   | |_____^\n+   |\n+   = help: add `#![feature(unstable_test_feature)]` to the crate attributes to enable\n+\n+error: aborting due to 8 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}]}