{"sha": "9c74f646f484b7a8458848cf49da0e4855cb8848", "node_id": "C_kwDOAAsO6NoAKDljNzRmNjQ2ZjQ4NGI3YTg0NTg4NDhjZjQ5ZGEwZTQ4NTVjYjg4NDg", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-17T18:59:02Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-18T20:49:11Z"}, "message": "Publish platform-specific Code VSIXes", "tree": {"sha": "4911c4c4a788d02674cd1371f11a74d7db2f050e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4911c4c4a788d02674cd1371f11a74d7db2f050e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9c74f646f484b7a8458848cf49da0e4855cb8848", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9c74f646f484b7a8458848cf49da0e4855cb8848", "html_url": "https://github.com/rust-lang/rust/commit/9c74f646f484b7a8458848cf49da0e4855cb8848", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9c74f646f484b7a8458848cf49da0e4855cb8848/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c686721c0fe4dd8fef74acb502c2327e0054dff", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c686721c0fe4dd8fef74acb502c2327e0054dff", "html_url": "https://github.com/rust-lang/rust/commit/4c686721c0fe4dd8fef74acb502c2327e0054dff"}], "stats": {"total": 163, "additions": 104, "deletions": 59}, "files": [{"sha": "91a6210d269913ffedea4b7ad7bc1969bc312152", "filename": ".github/workflows/release.yaml", "status": "modified", "additions": 32, "deletions": 12, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/9c74f646f484b7a8458848cf49da0e4855cb8848/.github%2Fworkflows%2Frelease.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/9c74f646f484b7a8458848cf49da0e4855cb8848/.github%2Fworkflows%2Frelease.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Frelease.yaml?ref=9c74f646f484b7a8458848cf49da0e4855cb8848", "patch": "@@ -17,6 +17,7 @@ env:\n   RUSTUP_MAX_RETRIES: 10\n   FETCH_DEPTH: 0 # pull in the tags for the version string\n   MACOSX_DEPLOYMENT_TARGET: 10.15\n+  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc\n \n jobs:\n   dist:\n@@ -25,24 +26,28 @@ jobs:\n         include:\n           - os: windows-latest\n             target: x86_64-pc-windows-msvc\n+            code-target: win32-x64\n           - os: windows-latest\n             target: aarch64-pc-windows-msvc\n+            code-target: win32-arm64\n           - os: ubuntu-20.04\n             target: x86_64-unknown-linux-gnu\n+            code-target: linux-x64\n           - os: ubuntu-20.04\n             target: aarch64-unknown-linux-gnu\n-            cross_linker: aarch64-linux-gnu-gcc\n+            code-target: linux-arm64\n           - os: macos-11\n             target: x86_64-apple-darwin\n+            code-target: darwin-x64\n           - os: macos-11\n             target: aarch64-apple-darwin\n+            code-target: darwin-arm64\n \n     name: dist (${{ matrix.target }})\n     runs-on: ${{ matrix.os }}\n \n     env:\n       RA_TARGET: ${{ matrix.target }}\n-      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.cross_linker }}\n \n     steps:\n       - name: Checkout repository\n@@ -77,7 +82,6 @@ jobs:\n           components: rust-src\n \n       - name: Install Node.js\n-        if: matrix.target == 'x86_64-unknown-linux-gnu'\n         uses: actions/setup-node@v1\n         with:\n           node-version: 14.x\n@@ -90,13 +94,21 @@ jobs:\n         if: matrix.target == 'aarch64-unknown-linux-gnu'\n         run: sudo apt-get install gcc-aarch64-linux-gnu\n \n-      - name: Dist (generic)\n-        if: matrix.target != 'x86_64-unknown-linux-gnu'\n-        run: cargo xtask dist\n+      - name: Dist\n+        run: cargo xtask dist --client-patch-version ${{ github.run_number }}\n \n-      - name: Dist (Linux)\n-        if: matrix.target == 'x86_64-unknown-linux-gnu'\n-        run: cargo xtask dist --client-patch-version $GITHUB_RUN_NUMBER\n+      - run: npm ci\n+        working-directory: editors/code\n+\n+      - run: npx vsce package -o \"../../dist/rust-analyzer-${{ matrix.code-target }}.vsix\" --target ${{ matrix.code-target }}\n+        working-directory: editors/code\n+\n+      - if: matrix.target == 'x86_64-unknown-linux-gnu'\n+        run: rm -rf editors/code/server\n+\n+      - if: matrix.target == 'x86_64-unknown-linux-gnu'\n+        run: npx vsce package -o ../../dist/rust-analyzer.vsix\n+        working-directory: editors/code\n \n       - name: Run analysis-stats on rust-analyzer\n         if: matrix.target == 'x86_64-unknown-linux-gnu'\n@@ -126,15 +138,23 @@ jobs:\n \n     steps:\n       - name: Install dependencies\n-        run: apk add --no-cache git clang lld musl-dev\n+        run: apk add --no-cache git clang lld musl-dev nodejs npm\n \n       - name: Checkout repository\n         uses: actions/checkout@v2\n         with:\n           fetch-depth: ${{ env.FETCH_DEPTH }}\n \n       - name: Dist\n-        run: cargo xtask dist\n+        run: cargo xtask dist --client-patch-version ${{ github.run_number }}\n+\n+      - run: npm ci\n+        working-directory: editors/code\n+\n+      - run: npx vsce package -o \"../../dist/rust-analyzer-alpine-x64.vsix\" --target alpine-x64\n+        working-directory: editors/code\n+\n+      - run: rm -rf editors/code/server\n \n       - name: Upload artifacts\n         uses: actions/upload-artifact@v1\n@@ -210,4 +230,4 @@ jobs:\n         if: github.ref == 'refs/heads/release'\n         working-directory: ./editors/code\n         # token from https://dev.azure.com/rust-analyzer/\n-        run: npx vsce publish --pat ${{ secrets.MARKETPLACE_TOKEN }} --packagePath ../../dist/rust-analyzer.vsix\n+        run: npx vsce publish --pat ${{ secrets.MARKETPLACE_TOKEN }} --packagePath ../../dist/rust-analyzer-*.vsix"}, {"sha": "3acb6b3f6202d7cef902a69075c932d16a91c550", "filename": "editors/code/.gitignore", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9c74f646f484b7a8458848cf49da0e4855cb8848/editors%2Fcode%2F.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/9c74f646f484b7a8458848cf49da0e4855cb8848/editors%2Fcode%2F.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2F.gitignore?ref=9c74f646f484b7a8458848cf49da0e4855cb8848", "patch": "@@ -1,5 +1,5 @@\n out\n node_modules\n+server\n .vscode-test/\n *.vsix\n-bundle"}, {"sha": "dc0a9a2f872ca2b0c1378b7548509d1f0175aa0f", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/9c74f646f484b7a8458848cf49da0e4855cb8848/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/9c74f646f484b7a8458848cf49da0e4855cb8848/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=9c74f646f484b7a8458848cf49da0e4855cb8848", "patch": "@@ -221,9 +221,18 @@ async function bootstrapExtension(config: Config, state: PersistentState): Promi\n     );\n     if (userResponse !== \"Update\") return;\n \n-    const artifact = latestNightlyRelease.assets.find(artifact => artifact.name === \"rust-analyzer.vsix\");\n-    assert(!!artifact, `Bad release: ${JSON.stringify(latestNightlyRelease)}`);\n+    let arch = process.arch;\n+    if (arch === \"ia32\") {\n+        arch = \"x64\";\n+    }\n+    let platform = process.platform as string;\n+    if (platform === \"linux\" && isMusl()) {\n+        platform = \"alpine\";\n+    }\n+    const artifactName = `rust-analyzer-${platform}-${arch}.vsix`;\n \n+    const artifact = latestNightlyRelease.assets.find(artifact => artifact.name === artifactName);\n+    assert(!!artifact, `Bad release: ${JSON.stringify(latestNightlyRelease)}`);\n     const dest = vscode.Uri.joinPath(config.globalStorageUri, \"rust-analyzer.vsix\");\n \n     await downloadWithRetryDialog(state, async () => {"}, {"sha": "6e0902c7a076a809ab0cfe55f3474ea32bb71704", "filename": "xtask/src/dist.rs", "status": "modified", "additions": 60, "deletions": 44, "changes": 104, "blob_url": "https://github.com/rust-lang/rust/blob/9c74f646f484b7a8458848cf49da0e4855cb8848/xtask%2Fsrc%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9c74f646f484b7a8458848cf49da0e4855cb8848/xtask%2Fsrc%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fdist.rs?ref=9c74f646f484b7a8458848cf49da0e4855cb8848", "patch": "@@ -7,7 +7,7 @@ use std::{\n \n use anyhow::Result;\n use flate2::{write::GzEncoder, Compression};\n-use xshell::{cmd, mkdir_p, pushd, pushenv, read_file, rm_rf, write_file};\n+use xshell::{cmd, cp, mkdir_p, pushd, pushenv, read_file, rm_rf, write_file};\n \n use crate::{date_iso, flags, project_root};\n \n@@ -16,10 +16,15 @@ impl flags::Dist {\n         let stable =\n             std::env::var(\"GITHUB_REF\").unwrap_or_default().as_str() == \"refs/heads/release\";\n \n-        let dist = project_root().join(\"dist\");\n+        let project_root = project_root();\n+        let target = Target::get(&project_root);\n+        let dist = project_root.join(\"dist\");\n         rm_rf(&dist)?;\n         mkdir_p(&dist)?;\n \n+        let release_channel = if stable { \"stable\" } else { \"nightly\" };\n+        dist_server(release_channel, &target)?;\n+\n         if let Some(patch_version) = self.client_patch_version {\n             let version = if stable {\n                 format!(\"0.2.{}\", patch_version)\n@@ -28,20 +33,24 @@ impl flags::Dist {\n                 format!(\"0.3.{}\", patch_version)\n             };\n             let release_tag = if stable { date_iso()? } else { \"nightly\".to_string() };\n-            dist_client(&version, &release_tag)?;\n+            dist_client(&version, &release_tag, &target)?;\n         }\n-        let release_channel = if stable { \"stable\" } else { \"nightly\" };\n-        dist_server(release_channel)?;\n         Ok(())\n     }\n }\n \n-fn dist_client(version: &str, release_tag: &str) -> Result<()> {\n+fn dist_client(version: &str, release_tag: &str, target: &Target) -> Result<()> {\n+    let bundle_path = Path::new(\"editors\").join(\"code\").join(\"server\");\n+    mkdir_p(&bundle_path)?;\n+    cp(&target.server_path, &bundle_path)?;\n+    if let Some(symbols_path) = &target.symbols_path {\n+        cp(symbols_path, &bundle_path)?;\n+    }\n+\n     let _d = pushd(\"./editors/code\")?;\n     let nightly = release_tag == \"nightly\";\n \n     let mut patch = Patch::new(\"./package.json\")?;\n-\n     patch\n         .replace(r#\"\"version\": \"0.4.0-dev\"\"#, &format!(r#\"\"version\": \"{}\"\"#, version))\n         .replace(r#\"\"releaseTag\": null\"#, &format!(r#\"\"releaseTag\": \"{}\"\"#, release_tag))\n@@ -59,12 +68,10 @@ fn dist_client(version: &str, release_tag: &str) -> Result<()> {\n     }\n     patch.commit()?;\n \n-    cmd!(\"npm ci\").run()?;\n-    cmd!(\"npx vsce package -o ../../dist/rust-analyzer.vsix\").run()?;\n     Ok(())\n }\n \n-fn dist_server(release_channel: &str) -> Result<()> {\n+fn dist_server(release_channel: &str, target: &Target) -> Result<()> {\n     let _e = pushenv(\"RUST_ANALYZER_CHANNEL\", release_channel);\n     let _e = pushenv(\"CARGO_PROFILE_RELEASE_LTO\", \"thin\");\n \n@@ -73,47 +80,19 @@ fn dist_server(release_channel: &str) -> Result<()> {\n     //   * on Linux, this blows up the binary size from 8MB to 43MB, which is unreasonable.\n     // let _e = pushenv(\"CARGO_PROFILE_RELEASE_DEBUG\", \"1\");\n \n-    let target = get_target();\n-    if target.contains(\"-linux-gnu\") || target.contains(\"-linux-musl\") {\n+    if target.name.contains(\"-linux-\") {\n         env::set_var(\"CC\", \"clang\");\n     }\n \n-    cmd!(\"cargo build --manifest-path ./crates/rust-analyzer/Cargo.toml --bin rust-analyzer --target {target} --release\").run()?;\n+    let target_name = &target.name;\n+    cmd!(\"cargo build --manifest-path ./crates/rust-analyzer/Cargo.toml --bin rust-analyzer --target {target_name} --release\").run()?;\n \n-    let suffix = exe_suffix(&target);\n-    let src =\n-        Path::new(\"target\").join(&target).join(\"release\").join(format!(\"rust-analyzer{}\", suffix));\n-    let dst = Path::new(\"dist\").join(format!(\"rust-analyzer-{}{}\", target, suffix));\n-    gzip(&src, &dst.with_extension(\"gz\"))?;\n+    let dst = Path::new(\"dist\").join(&target.artifact_name);\n+    gzip(&target.server_path, &dst.with_extension(\"gz\"))?;\n \n     Ok(())\n }\n \n-fn get_target() -> String {\n-    match env::var(\"RA_TARGET\") {\n-        Ok(target) => target,\n-        _ => {\n-            if cfg!(target_os = \"linux\") {\n-                \"x86_64-unknown-linux-gnu\".to_string()\n-            } else if cfg!(target_os = \"windows\") {\n-                \"x86_64-pc-windows-msvc\".to_string()\n-            } else if cfg!(target_os = \"macos\") {\n-                \"x86_64-apple-darwin\".to_string()\n-            } else {\n-                panic!(\"Unsupported OS, maybe try setting RA_TARGET\")\n-            }\n-        }\n-    }\n-}\n-\n-fn exe_suffix(target: &str) -> String {\n-    if target.contains(\"-windows-\") {\n-        \".exe\".into()\n-    } else {\n-        \"\".into()\n-    }\n-}\n-\n fn gzip(src_path: &Path, dest_path: &Path) -> Result<()> {\n     let mut encoder = GzEncoder::new(File::create(dest_path)?, Compression::best());\n     let mut input = io::BufReader::new(File::open(src_path)?);\n@@ -122,6 +101,41 @@ fn gzip(src_path: &Path, dest_path: &Path) -> Result<()> {\n     Ok(())\n }\n \n+struct Target {\n+    name: String,\n+    server_path: PathBuf,\n+    symbols_path: Option<PathBuf>,\n+    artifact_name: String,\n+}\n+\n+impl Target {\n+    fn get(project_root: &Path) -> Self {\n+        let name = match env::var(\"RA_TARGET\") {\n+            Ok(target) => target,\n+            _ => {\n+                if cfg!(target_os = \"linux\") {\n+                    \"x86_64-unknown-linux-gnu\".to_string()\n+                } else if cfg!(target_os = \"windows\") {\n+                    \"x86_64-pc-windows-msvc\".to_string()\n+                } else if cfg!(target_os = \"macos\") {\n+                    \"x86_64-apple-darwin\".to_string()\n+                } else {\n+                    panic!(\"Unsupported OS, maybe try setting RA_TARGET\")\n+                }\n+            }\n+        };\n+        let out_path = project_root.join(\"target\").join(&name).join(\"release\");\n+        let (exe_suffix, symbols_path) = if name.contains(\"-windows-\") {\n+            (\".exe\".into(), Some(out_path.join(\"rust_analyzer.pdb\")))\n+        } else {\n+            (String::new(), None)\n+        };\n+        let server_path = out_path.join(format!(\"rust-analyzer{}\", exe_suffix));\n+        let artifact_name = format!(\"rust-analyzer-{}{}\", name, exe_suffix);\n+        Self { name, server_path, symbols_path, artifact_name }\n+    }\n+}\n+\n struct Patch {\n     path: PathBuf,\n     original_contents: String,\n@@ -149,6 +163,8 @@ impl Patch {\n \n impl Drop for Patch {\n     fn drop(&mut self) {\n-        write_file(&self.path, &self.original_contents).unwrap();\n+        // FIXME: find a way to bring this back\n+        let _ = &self.original_contents;\n+        // write_file(&self.path, &self.original_contents).unwrap();\n     }\n }"}]}