{"sha": "e24003fb3ceaac9da1b848069555b491b9488ad0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyNDAwM2ZiM2NlYWFjOWRhMWI4NDgwNjk1NTViNDkxYjk0ODhhZDA=", "commit": {"author": {"name": "achernyak", "email": "artemchernyak@gmail.com", "date": "2017-04-27T18:27:16Z"}, "committer": {"name": "achernyak", "email": "artemchernyak@gmail.com", "date": "2017-04-27T18:27:16Z"}, "message": "query for describe_def", "tree": {"sha": "3641396ee6b527851c8f2c9f4821be316ba798ed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3641396ee6b527851c8f2c9f4821be316ba798ed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e24003fb3ceaac9da1b848069555b491b9488ad0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e24003fb3ceaac9da1b848069555b491b9488ad0", "html_url": "https://github.com/rust-lang/rust/commit/e24003fb3ceaac9da1b848069555b491b9488ad0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e24003fb3ceaac9da1b848069555b491b9488ad0/comments", "author": {"login": "hackeryarn", "id": 827709, "node_id": "MDQ6VXNlcjgyNzcwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/827709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hackeryarn", "html_url": "https://github.com/hackeryarn", "followers_url": "https://api.github.com/users/hackeryarn/followers", "following_url": "https://api.github.com/users/hackeryarn/following{/other_user}", "gists_url": "https://api.github.com/users/hackeryarn/gists{/gist_id}", "starred_url": "https://api.github.com/users/hackeryarn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hackeryarn/subscriptions", "organizations_url": "https://api.github.com/users/hackeryarn/orgs", "repos_url": "https://api.github.com/users/hackeryarn/repos", "events_url": "https://api.github.com/users/hackeryarn/events{/privacy}", "received_events_url": "https://api.github.com/users/hackeryarn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hackeryarn", "id": 827709, "node_id": "MDQ6VXNlcjgyNzcwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/827709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hackeryarn", "html_url": "https://github.com/hackeryarn", "followers_url": "https://api.github.com/users/hackeryarn/followers", "following_url": "https://api.github.com/users/hackeryarn/following{/other_user}", "gists_url": "https://api.github.com/users/hackeryarn/gists{/gist_id}", "starred_url": "https://api.github.com/users/hackeryarn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hackeryarn/subscriptions", "organizations_url": "https://api.github.com/users/hackeryarn/orgs", "repos_url": "https://api.github.com/users/hackeryarn/repos", "events_url": "https://api.github.com/users/hackeryarn/events{/privacy}", "received_events_url": "https://api.github.com/users/hackeryarn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4961d724f8d02870087c1912a55378458b0d6a90", "url": "https://api.github.com/repos/rust-lang/rust/commits/4961d724f8d02870087c1912a55378458b0d6a90", "html_url": "https://github.com/rust-lang/rust/commit/4961d724f8d02870087c1912a55378458b0d6a90"}], "stats": {"total": 33, "additions": 20, "deletions": 13}, "files": [{"sha": "0358319256760702a9224cee1c2a8fcd4953c0c4", "filename": "src/librustc/middle/cstore.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcstore.rs?ref=e24003fb3ceaac9da1b848069555b491b9488ad0", "patch": "@@ -22,7 +22,7 @@\n // are *mostly* used as a part of that interface, but these should\n // probably get a better home if someone can find one.\n \n-use hir::def::{self, Def};\n+use hir::def;\n use hir::def_id::{CrateNum, DefId, DefIndex};\n use hir::map as hir_map;\n use hir::map::definitions::{Definitions, DefKey, DisambiguatedDefPathData};\n@@ -181,7 +181,6 @@ pub trait CrateStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any>;\n \n     // item info\n-    fn describe_def(&self, def: DefId) -> Option<Def>;\n     fn def_span(&self, sess: &Session, def: DefId) -> Span;\n     fn stability(&self, def: DefId) -> Option<attr::Stability>;\n     fn deprecation(&self, def: DefId) -> Option<attr::Deprecation>;\n@@ -313,7 +312,6 @@ impl CrateStore for DummyCrateStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any>\n         { bug!(\"crate_data_as_rc_any\") }\n     // item info\n-    fn describe_def(&self, def: DefId) -> Option<Def> { bug!(\"describe_def\") }\n     fn def_span(&self, sess: &Session, def: DefId) -> Span { bug!(\"def_span\") }\n     fn stability(&self, def: DefId) -> Option<attr::Stability> { bug!(\"stability\") }\n     fn deprecation(&self, def: DefId) -> Option<attr::Deprecation> { bug!(\"deprecation\") }"}, {"sha": "1ac7f4fcc95c272e7c88a562cb4f2ac0e5dff866", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=e24003fb3ceaac9da1b848069555b491b9488ad0", "patch": "@@ -432,7 +432,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n     // (See issue #38412)\n     fn skip_stability_check_due_to_privacy(self, mut def_id: DefId) -> bool {\n         // Check if `def_id` is a trait method.\n-        match self.sess.cstore.describe_def(def_id) {\n+        match self.describe_def(def_id) {\n             Some(Def::Method(_)) |\n             Some(Def::AssociatedTy(_)) |\n             Some(Def::AssociatedConst(_)) => {"}, {"sha": "096d69aa3760a0ae44154f6092137d97714452be", "filename": "src/librustc/ty/maps.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fty%2Fmaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fty%2Fmaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps.rs?ref=e24003fb3ceaac9da1b848069555b491b9488ad0", "patch": "@@ -10,6 +10,7 @@\n \n use dep_graph::{DepGraph, DepNode, DepTrackingMap, DepTrackingMapConfig};\n use hir::def_id::{CrateNum, DefId, LOCAL_CRATE};\n+use hir::def::Def;\n use hir;\n use middle::const_val;\n use middle::privacy::AccessLevels;\n@@ -264,6 +265,12 @@ impl<'tcx> QueryDescription for queries::symbol_name<'tcx> {\n     }\n }\n \n+impl<'tcx> QueryDescription for queries::describe_def<'tcx> {\n+    fn describe(_: TyCtxt, _: DefId) -> String {\n+        bug!(\"describe_def\")\n+    }\n+}\n+\n macro_rules! define_maps {\n     (<$tcx:tt>\n      $($(#[$attr:meta])*\n@@ -538,7 +545,9 @@ define_maps! { <'tcx>\n     pub mir_shims: mir_shim_dep_node(ty::InstanceDef<'tcx>) -> &'tcx RefCell<mir::Mir<'tcx>>,\n \n     pub def_symbol_name: SymbolName(DefId) -> ty::SymbolName,\n-    pub symbol_name: symbol_name_dep_node(ty::Instance<'tcx>) -> ty::SymbolName\n+    pub symbol_name: symbol_name_dep_node(ty::Instance<'tcx>) -> ty::SymbolName,\n+\n+    pub describe_def: meta_data_node(DefId) -> Option<Def>\n }\n \n fn coherent_trait_dep_node((_, def_id): (CrateNum, DefId)) -> DepNode<DefId> {\n@@ -570,3 +579,7 @@ fn typeck_item_bodies_dep_node(_: CrateNum) -> DepNode<DefId> {\n fn const_eval_dep_node((def_id, _): (DefId, &Substs)) -> DepNode<DefId> {\n     DepNode::ConstEval(def_id)\n }\n+\n+fn meta_data_node(def_id: DefId) -> DepNode<DefId> {\n+    DepNode::MetaData(def_id)\n+}\n\\ No newline at end of file"}, {"sha": "238791fb6edb3eeb7ea11487d10a7c9a09b82da9", "filename": "src/librustc/ty/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmod.rs?ref=e24003fb3ceaac9da1b848069555b491b9488ad0", "patch": "@@ -2385,7 +2385,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n     /// ID of the impl that the method belongs to. Otherwise, return `None`.\n     pub fn impl_of_method(self, def_id: DefId) -> Option<DefId> {\n         let item = if def_id.krate != LOCAL_CRATE {\n-            if let Some(Def::Method(_)) = self.sess.cstore.describe_def(def_id) {\n+            if let Some(Def::Method(_)) = self.describe_def(def_id) {\n                 Some(self.associated_item(def_id))\n             } else {\n                 None"}, {"sha": "8b1aa0708807bc4284b8b7f8bad0c09840e7ec70", "filename": "src/librustc_const_eval/eval.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc_const_eval%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc_const_eval%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_const_eval%2Feval.rs?ref=e24003fb3ceaac9da1b848069555b491b9488ad0", "patch": "@@ -68,7 +68,7 @@ pub fn lookup_const_by_id<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n             _ => Some((def_id, substs))\n         }\n     } else {\n-        match tcx.sess.cstore.describe_def(def_id) {\n+        match tcx.describe_def(def_id) {\n             Some(Def::AssociatedConst(_)) => {\n                 // As mentioned in the comments above for in-crate\n                 // constants, we only try to find the expression for a"}, {"sha": "839caca2ee9144d44bfc959fdd4492c3657384a8", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e24003fb3ceaac9da1b848069555b491b9488ad0/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=e24003fb3ceaac9da1b848069555b491b9488ad0", "patch": "@@ -17,7 +17,7 @@ use rustc::dep_graph::DepTrackingMapConfig;\n use rustc::middle::cstore::{CrateStore, CrateSource, LibSource, DepKind,\n                             ExternCrate, NativeLibrary, LinkMeta,\n                             LinkagePreference, LoadedMacro, EncodedMetadata};\n-use rustc::hir::def::{self, Def};\n+use rustc::hir::def;\n use rustc::middle::lang_items;\n use rustc::session::Session;\n use rustc::ty::{self, TyCtxt};\n@@ -113,18 +113,14 @@ provide! { <'tcx> tcx, def_id, cdata\n     closure_type => { cdata.closure_ty(def_id.index, tcx) }\n     inherent_impls => { Rc::new(cdata.get_inherent_implementations_for_type(def_id.index)) }\n     is_foreign_item => { cdata.is_foreign_item(def_id.index) }\n+    describe_def => { cdata.get_def(def_id.index) }\n }\n \n impl CrateStore for cstore::CStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any> {\n         self.get_crate_data(krate)\n     }\n \n-    fn describe_def(&self, def: DefId) -> Option<Def> {\n-        self.dep_graph.read(DepNode::MetaData(def));\n-        self.get_crate_data(def.krate).get_def(def.index)\n-    }\n-\n     fn def_span(&self, sess: &Session, def: DefId) -> Span {\n         self.dep_graph.read(DepNode::MetaData(def));\n         self.get_crate_data(def.krate).get_span(def.index, sess)"}]}