{"sha": "68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "node_id": "C_kwDOAAsO6NoAKDY4Y2ZkYmI1YzFhNmY1YzdkNzk2ZGY2NTcwMWVkZmQwYWJlZTg5ZjQ", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-13T14:02:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-13T14:02:36Z"}, "message": "Rollup merge of #99155 - Amanieu:unstable-target-features, r=davidtwco\n\nKeep unstable target features for asm feature checking\n\nInline assembly uses the target features to determine which registers\nare available on the current target. However it needs to be able to\naccess unstable target features for this.\n\nFixes #99071", "tree": {"sha": "feec2d8fddb9c59fcc2018d9cca71399b6eacb59", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/feec2d8fddb9c59fcc2018d9cca71399b6eacb59"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiztB8CRBK7hj4Ov3rIwAASt0IAK6Jf8eTmnVN/bYUCGZeMIsc\n/rzW1pF2N+QEn7T3wOvQMu7UeljYqIgmyEtCqOgKLVZvXHZmIgvnTEcKnyYYgTFT\nyGeq0iZZ4rXUR12ZI5lCAMF3TBACu/EHEPpHDRXwiOJp03D5JfkR84isOF1jIlhz\nb3rEH6uVha5e7AVqPFWzv/zaYFMl+DZmian8NgyvePi6p/fxkKBrsQfKHOPJnEl2\nKhPW7rPEb2WrbMRofKp8oz/+h9+romFB85tNn7wLcJk1dKFVxv1l5rIEdpv3DjrQ\nIXexiqUGYFdHZWZRrkZife5Jx/SU9/HSHaEqpDVHFXhqfzJbnMEActXOy3fllWE=\n=pLq2\n-----END PGP SIGNATURE-----\n", "payload": "tree feec2d8fddb9c59fcc2018d9cca71399b6eacb59\nparent 980579a5e9f5fcad63ef71f536efec15ccd56511\nparent dfe68eede3cef45c8a420aeb8ab4a57426662e04\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1657720956 +0530\ncommitter GitHub <noreply@github.com> 1657720956 +0530\n\nRollup merge of #99155 - Amanieu:unstable-target-features, r=davidtwco\n\nKeep unstable target features for asm feature checking\n\nInline assembly uses the target features to determine which registers\nare available on the current target. However it needs to be able to\naccess unstable target features for this.\n\nFixes #99071\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "html_url": "https://github.com/rust-lang/rust/commit/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "980579a5e9f5fcad63ef71f536efec15ccd56511", "url": "https://api.github.com/repos/rust-lang/rust/commits/980579a5e9f5fcad63ef71f536efec15ccd56511", "html_url": "https://github.com/rust-lang/rust/commit/980579a5e9f5fcad63ef71f536efec15ccd56511"}, {"sha": "dfe68eede3cef45c8a420aeb8ab4a57426662e04", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfe68eede3cef45c8a420aeb8ab4a57426662e04", "html_url": "https://github.com/rust-lang/rust/commit/dfe68eede3cef45c8a420aeb8ab4a57426662e04"}], "stats": {"total": 95, "additions": 67, "deletions": 28}, "files": [{"sha": "3ed3453c6c7b32f3b6e15310d04ad64e17b54d86", "filename": "compiler/rustc_codegen_cranelift/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -167,7 +167,7 @@ impl CodegenBackend for CraneliftCodegenBackend {\n         }\n     }\n \n-    fn target_features(&self, _sess: &Session) -> Vec<rustc_span::Symbol> {\n+    fn target_features(&self, _sess: &Session, _allow_unstable: bool) -> Vec<rustc_span::Symbol> {\n         vec![]\n     }\n "}, {"sha": "c21e0c5a35b801438f954a30c71f6b0140de0cf0", "filename": "compiler/rustc_codegen_gcc/src/lib.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_gcc%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_gcc%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Flib.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -140,8 +140,8 @@ impl CodegenBackend for GccCodegenBackend {\n         )\n     }\n \n-    fn target_features(&self, sess: &Session) -> Vec<Symbol> {\n-        target_features(sess)\n+    fn target_features(&self, sess: &Session, allow_unstable: bool) -> Vec<Symbol> {\n+        target_features(sess, allow_unstable)\n     }\n }\n \n@@ -298,12 +298,12 @@ pub fn target_cpu(sess: &Session) -> &str {\n     }\n }\n \n-pub fn target_features(sess: &Session) -> Vec<Symbol> {\n+pub fn target_features(sess: &Session, allow_unstable: bool) -> Vec<Symbol> {\n     supported_target_features(sess)\n         .iter()\n         .filter_map(\n             |&(feature, gate)| {\n-                if sess.is_nightly_build() || gate.is_none() { Some(feature) } else { None }\n+                if sess.is_nightly_build() || allow_unstable || gate.is_none() { Some(feature) } else { None }\n             },\n         )\n         .filter(|_feature| {"}, {"sha": "fb196ee9f5d0635592ecc1d2a0e8ba739db09839", "filename": "compiler/rustc_codegen_llvm/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_llvm%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_llvm%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Flib.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -324,8 +324,8 @@ impl CodegenBackend for LlvmCodegenBackend {\n         llvm_util::print_version();\n     }\n \n-    fn target_features(&self, sess: &Session) -> Vec<Symbol> {\n-        target_features(sess)\n+    fn target_features(&self, sess: &Session, allow_unstable: bool) -> Vec<Symbol> {\n+        target_features(sess, allow_unstable)\n     }\n \n     fn codegen_crate<'tcx>("}, {"sha": "5b3b7db12b7ced85539c16cb132e32661cfc5bd8", "filename": "compiler/rustc_codegen_llvm/src/llvm_util.rs", "status": "modified", "additions": 21, "deletions": 18, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -233,26 +233,29 @@ pub fn check_tied_features(\n \n // Used to generate cfg variables and apply features\n // Must express features in the way Rust understands them\n-pub fn target_features(sess: &Session) -> Vec<Symbol> {\n+pub fn target_features(sess: &Session, allow_unstable: bool) -> Vec<Symbol> {\n     let target_machine = create_informational_target_machine(sess);\n-    let mut features: Vec<Symbol> =\n-        supported_target_features(sess)\n-            .iter()\n-            .filter_map(|&(feature, gate)| {\n-                if sess.is_nightly_build() || gate.is_none() { Some(feature) } else { None }\n-            })\n-            .filter(|feature| {\n-                // check that all features in a given smallvec are enabled\n-                for llvm_feature in to_llvm_features(sess, feature) {\n-                    let cstr = SmallCStr::new(llvm_feature);\n-                    if !unsafe { llvm::LLVMRustHasFeature(target_machine, cstr.as_ptr()) } {\n-                        return false;\n-                    }\n+    let mut features: Vec<Symbol> = supported_target_features(sess)\n+        .iter()\n+        .filter_map(|&(feature, gate)| {\n+            if sess.is_nightly_build() || allow_unstable || gate.is_none() {\n+                Some(feature)\n+            } else {\n+                None\n+            }\n+        })\n+        .filter(|feature| {\n+            // check that all features in a given smallvec are enabled\n+            for llvm_feature in to_llvm_features(sess, feature) {\n+                let cstr = SmallCStr::new(llvm_feature);\n+                if !unsafe { llvm::LLVMRustHasFeature(target_machine, cstr.as_ptr()) } {\n+                    return false;\n                 }\n-                true\n-            })\n-            .map(|feature| Symbol::intern(feature))\n-            .collect();\n+            }\n+            true\n+        })\n+        .map(|feature| Symbol::intern(feature))\n+        .collect();\n \n     // LLVM 14 changed the ABI for i128 arguments to __float/__fix builtins on Win64\n     // (see https://reviews.llvm.org/D110413). This unstable target feature is intended for use"}, {"sha": "779bd3ea278ec25f36bfb979e2b754a861e8d4cc", "filename": "compiler/rustc_codegen_ssa/src/traits/backend.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbackend.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbackend.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbackend.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -59,7 +59,7 @@ impl<'tcx, T> Backend<'tcx> for T where\n pub trait CodegenBackend {\n     fn init(&self, _sess: &Session) {}\n     fn print(&self, _req: PrintRequest, _sess: &Session) {}\n-    fn target_features(&self, _sess: &Session) -> Vec<Symbol> {\n+    fn target_features(&self, _sess: &Session, _allow_unstable: bool) -> Vec<Symbol> {\n         vec![]\n     }\n     fn print_passes(&self) {}"}, {"sha": "f4b51b5a44243ae8f87e6e5c6881d6a697cc0d9f", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -48,7 +48,10 @@ pub fn add_configuration(\n ) {\n     let tf = sym::target_feature;\n \n-    let target_features = codegen_backend.target_features(sess);\n+    let unstable_target_features = codegen_backend.target_features(sess, true);\n+    sess.unstable_target_features.extend(unstable_target_features.iter().cloned());\n+\n+    let target_features = codegen_backend.target_features(sess, false);\n     sess.target_features.extend(target_features.iter().cloned());\n \n     cfg.extend(target_features.into_iter().map(|feat| (tf, Some(feat))));"}, {"sha": "16f4a099d80c078ccbf20677cb56bbe5b103f224", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -194,6 +194,9 @@ pub struct Session {\n \n     /// Set of enabled features for the current target.\n     pub target_features: FxHashSet<Symbol>,\n+\n+    /// Set of enabled features for the current target, including unstable ones.\n+    pub unstable_target_features: FxHashSet<Symbol>,\n }\n \n pub struct PerfStats {\n@@ -1390,6 +1393,7 @@ pub fn build_session(\n         miri_unleashed_features: Lock::new(Default::default()),\n         asm_arch,\n         target_features: FxHashSet::default(),\n+        unstable_target_features: FxHashSet::default(),\n     };\n \n     validate_commandline_args_with_session_available(&sess);"}, {"sha": "9795be1a912ad960d3413a3ddb9951cf63f1dfd4", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -3196,7 +3196,7 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, did: DefId) -> CodegenFnAttrs {\n /// Computes the set of target features used in a function for the purposes of\n /// inline assembly.\n fn asm_target_features<'tcx>(tcx: TyCtxt<'tcx>, did: DefId) -> &'tcx FxHashSet<Symbol> {\n-    let mut target_features = tcx.sess.target_features.clone();\n+    let mut target_features = tcx.sess.unstable_target_features.clone();\n     if tcx.def_kind(did).has_codegen_attrs() {\n         let attrs = tcx.codegen_fn_attrs(did);\n         target_features.extend(&attrs.target_features);"}, {"sha": "bb6201861dff6054db076b225318cd35a210fbd6", "filename": "src/test/ui/asm/issue-99071.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/src%2Ftest%2Fui%2Fasm%2Fissue-99071.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/src%2Ftest%2Fui%2Fasm%2Fissue-99071.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fissue-99071.rs?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -0,0 +1,21 @@\n+// compile-flags: --target thumbv6m-none-eabi\n+// needs-llvm-components: arm\n+// needs-asm-support\n+\n+#![feature(no_core, lang_items, rustc_attrs)]\n+#![no_core]\n+#![crate_type = \"rlib\"]\n+\n+#[rustc_builtin_macro]\n+macro_rules! asm {\n+    () => {};\n+}\n+#[lang = \"sized\"]\n+trait Sized {}\n+\n+pub fn foo() {\n+    unsafe {\n+        asm!(\"\", in(\"r8\") 0);\n+        //~^ cannot use register `r8`: high registers (r8+) can only be used as clobbers in Thumb-1 code\n+    }\n+}"}, {"sha": "47386ffa4a8c9584f2866cb253764633b306272f", "filename": "src/test/ui/asm/issue-99071.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/src%2Ftest%2Fui%2Fasm%2Fissue-99071.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/68cfdbb5c1a6f5c7d796df65701edfd0abee89f4/src%2Ftest%2Fui%2Fasm%2Fissue-99071.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fissue-99071.stderr?ref=68cfdbb5c1a6f5c7d796df65701edfd0abee89f4", "patch": "@@ -0,0 +1,8 @@\n+error: cannot use register `r8`: high registers (r8+) can only be used as clobbers in Thumb-1 code\n+  --> $DIR/issue-99071.rs:18:18\n+   |\n+LL |         asm!(\"\", in(\"r8\") 0);\n+   |                  ^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}