{"sha": "d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ4YTc5MDRlMDZlNzdiYWYxMzdiNjcxM2Y5YmY3OWY3NGFlNmVkZmU=", "commit": {"author": {"name": "Raoul Strackx", "email": "raoul.strackx@fortanix.com", "date": "2020-03-27T13:19:07Z"}, "committer": {"name": "Raoul Strackx", "email": "raoul.strackx@fortanix.com", "date": "2020-09-25T13:08:32Z"}, "message": "LVI hardening tests for cmake", "tree": {"sha": "56f4edfb43b316cdff46340eea78c3dd43939f10", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56f4edfb43b316cdff46340eea78c3dd43939f10"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "html_url": "https://github.com/rust-lang/rust/commit/d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/comments", "author": {"login": "raoulstrackx", "id": 56830709, "node_id": "MDQ6VXNlcjU2ODMwNzA5", "avatar_url": "https://avatars.githubusercontent.com/u/56830709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raoulstrackx", "html_url": "https://github.com/raoulstrackx", "followers_url": "https://api.github.com/users/raoulstrackx/followers", "following_url": "https://api.github.com/users/raoulstrackx/following{/other_user}", "gists_url": "https://api.github.com/users/raoulstrackx/gists{/gist_id}", "starred_url": "https://api.github.com/users/raoulstrackx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raoulstrackx/subscriptions", "organizations_url": "https://api.github.com/users/raoulstrackx/orgs", "repos_url": "https://api.github.com/users/raoulstrackx/repos", "events_url": "https://api.github.com/users/raoulstrackx/events{/privacy}", "received_events_url": "https://api.github.com/users/raoulstrackx/received_events", "type": "User", "site_admin": false}, "committer": {"login": "raoulstrackx", "id": 56830709, "node_id": "MDQ6VXNlcjU2ODMwNzA5", "avatar_url": "https://avatars.githubusercontent.com/u/56830709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raoulstrackx", "html_url": "https://github.com/raoulstrackx", "followers_url": "https://api.github.com/users/raoulstrackx/followers", "following_url": "https://api.github.com/users/raoulstrackx/following{/other_user}", "gists_url": "https://api.github.com/users/raoulstrackx/gists{/gist_id}", "starred_url": "https://api.github.com/users/raoulstrackx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raoulstrackx/subscriptions", "organizations_url": "https://api.github.com/users/raoulstrackx/orgs", "repos_url": "https://api.github.com/users/raoulstrackx/repos", "events_url": "https://api.github.com/users/raoulstrackx/events{/privacy}", "received_events_url": "https://api.github.com/users/raoulstrackx/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64811ed5a590ef4c89c09f4d04d3cea11251da52", "url": "https://api.github.com/repos/rust-lang/rust/commits/64811ed5a590ef4c89c09f4d04d3cea11251da52", "html_url": "https://github.com/rust-lang/rust/commit/64811ed5a590ef4c89c09f4d04d3cea11251da52"}], "stats": {"total": 120, "additions": 120, "deletions": 0}, "files": [{"sha": "f551356b2ff81dcffb5cb1670057b89fe49aa3fc", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/cmake_plus_one_c.checks", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_c.checks", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_c.checks", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_c.checks?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,6 @@\n+CHECK: cmake_plus_one_c\n+CHECK:      lfence\n+CHECK:      popq\n+CHECK-NEXT: popq [[REGISTER:%[a-z]+]]\n+CHECK-NEXT: lfence\n+CHECK-NEXT: jmpq *[[REGISTER]]"}, {"sha": "87c806f137a94493ca8f57d51b1415715872ff79", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/cmake_plus_one_c_asm.checks", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_c_asm.checks", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_c_asm.checks", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_c_asm.checks?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,16 @@\n+CHECK: cmake_plus_one_c_asm\n+CHECK:      lfence\n+CHECK:      lfence\n+CHECK:      lfence\n+CHECK:      lfence\n+CHECK:      movl\n+CHECK:      lfence\n+CHECK-NEXT: incl\n+CHECK-NEXT: jmp     0x{{[[:xdigit:]]+}} <cmake_plus_one_c_asm+0x{{[[:xdigit:]]+}}>\n+CHECK-NEXT: shlq    $0, (%rsp)\n+CHECK-NEXT: lfence\n+CHECK-NEXT: retq\n+CHECK:      popq\n+CHECK-NEXT: popq [[REGISTER:%[a-z]+]]\n+CHECK-NEXT: lfence\n+CHECK-NEXT: jmpq *[[REGISTER]]"}, {"sha": "0f403e0203c122508c7a2c418630e929942ad363", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/cmake_plus_one_cxx.checks", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_cxx.checks", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_cxx.checks", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_cxx.checks?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,6 @@\n+CHECK: cmake_plus_one_cxx\n+CHECK:      lfence\n+CHECK:      popq\n+CHECK-NEXT: popq [[REGISTER:%[a-z]+]]\n+CHECK-NEXT: lfence\n+CHECK-NEXT: jmpq *[[REGISTER]]"}, {"sha": "9cac8711ea84bcfb973d31bc882b3104ccb67fb2", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/cmake_plus_one_cxx_asm.checks", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_cxx_asm.checks", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_cxx_asm.checks", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fcmake_plus_one_cxx_asm.checks?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,16 @@\n+CHECK: cmake_plus_one_cxx_asm\n+CHECK:      lfence\n+CHECK:      lfence\n+CHECK:      lfence\n+CHECK:      lfence\n+CHECK:      movl\n+CHECK:      lfence\n+CHECK-NEXT: incl\n+CHECK-NEXT: jmp     0x{{[[:xdigit:]]+}} <cmake_plus_one_cxx_asm+0x{{[[:xdigit:]]+}}>\n+CHECK-NEXT: shlq    $0, (%rsp)\n+CHECK-NEXT: lfence\n+CHECK-NEXT: retq\n+CHECK:      popq\n+CHECK-NEXT: popq [[REGISTER:%[a-z]+]]\n+CHECK-NEXT: lfence\n+CHECK-NEXT: jmpq *[[REGISTER]]"}, {"sha": "89490686584d57657bf639f37f072285f784f967", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/enclave/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2FCargo.toml?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -10,3 +10,4 @@ edition = \"2018\"\n \n [build-dependencies]\n cc = \"1.0\"\n+cmake = \"0.1\""}, {"sha": "eff25e8641b7910d859a7b61a1b96fafeda9d0d0", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/enclave/build.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Fbuild.rs?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -8,4 +8,19 @@ fn main() {\n         .cpp_set_stdlib(None)\n         .file(\"foo_cxx.cpp\")\n         .compile(\"foo_cxx\");\n+\n+    // When the cmake crate detects the clang compiler, it passes the\n+    //  \"--target\" argument to the linker which subsequently fails. The\n+    //  `CMAKE_C_COMPILER_FORCED` option makes sure that `cmake` does not\n+    //  tries to test the compiler. From version 3.6 the option\n+    //  `CMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY` can be used\n+    //  https://cmake.org/cmake/help/v3.5/module/CMakeForceCompiler.html\n+    let dst = cmake::Config::new(\"libcmake_foo\")\n+                .build_target(\"cmake_foo\")\n+                .define(\"CMAKE_C_COMPILER_FORCED\", \"1\")\n+                .define(\"CMAKE_CXX_COMPILER_FORCED\", \"1\")\n+                .define(\"CMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY\", \"1\")\n+                .build();\n+    println!(\"cargo:rustc-link-search=native={}/build/\", dst.display());\n+    println!(\"cargo:rustc-link-lib=static=cmake_foo\");\n }"}, {"sha": "f501fe6f7dde4d4d39b8d991289ee27165d71aef", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/enclave/libcmake_foo/CMakeLists.txt", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2FCMakeLists.txt", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2FCMakeLists.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2FCMakeLists.txt?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,4 @@\n+add_library(cmake_foo STATIC\n+    src/foo.c\n+    src/foo_cxx.cpp\n+)"}, {"sha": "cbfde6ce929949a82f0b9a106f1d43582187190c", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/enclave/libcmake_foo/src/foo.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2Fsrc%2Ffoo.c", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2Fsrc%2Ffoo.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2Fsrc%2Ffoo.c?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,17 @@\n+int cmake_plus_one_c(int *arg) {\n+    return *arg + 1;\n+}\n+\n+int cmake_plus_one_c_asm(int *arg) {\n+    int value = 0;\n+\n+    asm volatile ( \"    movl (%1), %0\\n\"\n+                   \"    inc %0\\n\"\n+                   \"    jmp 1f\\n\"\n+                   \"    retq\\n\"  // never executed, but a shortcut to determine how the assembler deals with `ret` instructions\n+                   \"1:\\n\"\n+                   : \"=r\"(value)\n+                   : \"r\"(arg) );\n+\n+    return value;\n+}"}, {"sha": "63a89111c119a64700aad3a2c2c678307026932c", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/enclave/libcmake_foo/src/foo_cxx.cpp", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2Fsrc%2Ffoo_cxx.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2Fsrc%2Ffoo_cxx.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Flibcmake_foo%2Fsrc%2Ffoo_cxx.cpp?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -0,0 +1,20 @@\n+extern \"C\" int cmake_plus_one_cxx(int *arg);\n+extern \"C\" int cmake_plus_one_cxx_asm(int *arg);\n+\n+int cmake_plus_one_cxx(int *arg) {\n+    return *arg + 1;\n+}\n+\n+int cmake_plus_one_cxx_asm(int *arg) {\n+    int value = 0;\n+\n+    asm volatile ( \"    movl (%1), %0\\n\"\n+                   \"    inc %0\\n\"\n+                   \"    jmp 1f\\n\"\n+                   \"    retq\\n\"  // never executed, but a shortcut to determine how the assembler deals with `ret` instructions\n+                   \"1:\\n\"\n+                   : \"=r\"(value)\n+                   : \"r\"(arg) );\n+\n+    return value;\n+}"}, {"sha": "358547c13621dfe4679bdb15eae834e60f89b285", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/enclave/src/main.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fenclave%2Fsrc%2Fmain.rs?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -3,6 +3,10 @@ extern {\n     fn cc_plus_one_c_asm(arg : &u32) -> u32;\n     fn cc_plus_one_cxx(arg : &u32) -> u32;\n     fn cc_plus_one_cxx_asm(arg : &u32) -> u32;\n+    fn cmake_plus_one_c(arg : &u32) -> u32;\n+    fn cmake_plus_one_c_asm(arg : &u32) -> u32;\n+    fn cmake_plus_one_cxx(arg : &u32) -> u32;\n+    fn cmake_plus_one_cxx_asm(arg : &u32) -> u32;\n }\n \n fn main() {\n@@ -13,5 +17,10 @@ fn main() {\n         println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cc_plus_one_c_asm(&value));\n         println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cc_plus_one_cxx(&value));\n         println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cc_plus_one_cxx_asm(&value));\n+        \n+        println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cmake_plus_one_c(&value));\n+        println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cmake_plus_one_c_asm(&value));\n+        println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cmake_plus_one_cxx(&value));\n+        println!(\"Answer to the Ultimate Question of Life, the Universe, and Everything: {}!\", cmake_plus_one_cxx_asm(&value));\n     }\n }"}, {"sha": "1595dbbbb9f2b1a56691058467f50ee4689027d5", "filename": "src/test/run-make/x86_64-fortanix-unknown-sgx-lvi/script.sh", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fscript.sh", "raw_url": "https://github.com/rust-lang/rust/raw/d8a7904e06e77baf137b6713f9bf79f74ae6edfe/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fscript.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fx86_64-fortanix-unknown-sgx-lvi%2Fscript.sh?ref=d8a7904e06e77baf137b6713f9bf79f74ae6edfe", "patch": "@@ -39,7 +39,17 @@ build\n #check \"libunwind::Registers_x86_64::jumpto()\" jumpto.checks\n \n check \"std::io::stdio::_print::h87f0c238421c45bc\" print.checks\n+#TODO: the current passes cannot handle module level assembly!\n+#  No checks are implemented\n check cc_plus_one_c cc_plus_one_c.checks\n check cc_plus_one_c_asm cc_plus_one_c_asm.checks\n check cc_plus_one_cxx cc_plus_one_cxx.checks\n check cc_plus_one_cxx_asm cc_plus_one_cxx_asm.checks\n+\n+check cmake_plus_one_c cmake_plus_one_c.checks\n+check cmake_plus_one_c_asm cmake_plus_one_c_asm.checks\n+check cmake_plus_one_cxx cmake_plus_one_cxx.checks\n+check cmake_plus_one_cxx_asm cmake_plus_one_cxx_asm.checks\n+\n+#WARNING clang/clang++ use an integrated assembler when given an assembly file.\n+#  LVI patches are *not* applied"}]}