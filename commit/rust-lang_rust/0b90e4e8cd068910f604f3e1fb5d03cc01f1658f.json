{"sha": "0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiOTBlNGU4Y2QwNjg5MTBmNjA0ZjNlMWZiNWQwM2NjMDFmMTY1OGY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-12T10:00:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-12T10:00:09Z"}, "message": "Auto merge of #46551 - jseyfried:improve_legacy_modern_macro_interaction, r=nrc\n\nmacros: improve 1.0/2.0 interaction\n\nThis PR supports using unhygienic macros from hygienic macros without breaking the latter's hygiene.\n```rust\n// crate A:\n#[macro_export]\nmacro_rules! m1 { () => {\n    f(); // unhygienic: this macro needs `f` in its environment\n    fn g() {} // (1) unhygienic: `g` is usable outside the macro definition\n} }\n\n// crate B:\n#![feature(decl_macro)]\nextern crate A;\nuse A::m1;\n\nmacro m2() {\n    fn f() {} // (2)\n    m1!(); // After this PR, `f()` in the expansion resolves to (2), not (3)\n    g(); // After this PR, this resolves to `fn g() {}` from the above expansion.\n         // Today, it is a resolution error.\n}\n\nfn test() {\n    fn f() {} // (3)\n    m2!(); // Today, `m2!()` can see (3) even though it should be hygienic.\n    fn g() {} // Today, this conflicts with `fn g() {}` from the expansion, even though it should be hygienic.\n}\n```\n\nOnce this PR lands, you can make an existing unhygienic macro hygienic by wrapping it in a hygienic macro. There is an [example](https://github.com/rust-lang/rust/pull/46551/commits/b766fa887dc0e4b923a38751fe4d570e35a75710) of this in the tests.\n\nr? @nrc", "tree": {"sha": "272837310543b7e12169bc8d74974400634dfd57", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/272837310543b7e12169bc8d74974400634dfd57"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "html_url": "https://github.com/rust-lang/rust/commit/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "73ac5d6a80f26c692f1e084b72d69637d7de2c8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/73ac5d6a80f26c692f1e084b72d69637d7de2c8c", "html_url": "https://github.com/rust-lang/rust/commit/73ac5d6a80f26c692f1e084b72d69637d7de2c8c"}, {"sha": "b766fa887dc0e4b923a38751fe4d570e35a75710", "url": "https://api.github.com/repos/rust-lang/rust/commits/b766fa887dc0e4b923a38751fe4d570e35a75710", "html_url": "https://github.com/rust-lang/rust/commit/b766fa887dc0e4b923a38751fe4d570e35a75710"}], "stats": {"total": 226, "additions": 217, "deletions": 9}, "files": [{"sha": "b9e816baac0dc0f50f8e340eff4908b3e58ba57d", "filename": "src/libproc_macro/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibproc_macro%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibproc_macro%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibproc_macro%2Flib.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -95,7 +95,7 @@ impl FromStr for TokenStream {\n             // notify the expansion info that it is unhygienic\n             let mark = Mark::fresh(mark);\n             mark.set_expn_info(expn_info);\n-            let span = call_site.with_ctxt(call_site.ctxt().apply_mark(mark));\n+            let span = call_site.with_ctxt(SyntaxContext::empty().apply_mark(mark));\n             let stream = parse::parse_stream_from_source_str(name, src, sess, Some(span));\n             Ok(__internal::token_stream_wrap(stream))\n         })"}, {"sha": "50efd89f6fedb66b112b5f9f2fc370d10357c7f0", "filename": "src/librustc_resolve/build_reduced_graph.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fbuild_reduced_graph.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -156,7 +156,7 @@ impl<'a> Resolver<'a> {\n \n                     // Disallow `use $crate;`\n                     if source.name == keywords::DollarCrate.name() && path.segments.len() == 1 {\n-                        let crate_root = self.resolve_crate_root(source.ctxt);\n+                        let crate_root = self.resolve_crate_root(source.ctxt, true);\n                         let crate_name = match crate_root.kind {\n                             ModuleKind::Def(_, name) => name,\n                             ModuleKind::Block(..) => unreachable!(),"}, {"sha": "fd9808012131991421d338c598f5a7f98cac5a11", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -42,7 +42,7 @@ use rustc::hir::{Freevar, FreevarMap, TraitCandidate, TraitMap, GlobMap};\n use rustc::util::nodemap::{NodeMap, NodeSet, FxHashMap, FxHashSet, DefIdMap};\n \n use syntax::codemap::{dummy_spanned, respan};\n-use syntax::ext::hygiene::{Mark, SyntaxContext};\n+use syntax::ext::hygiene::{Mark, MarkKind, SyntaxContext};\n use syntax::ast::{self, Name, NodeId, Ident, SpannedIdent, FloatTy, IntTy, UintTy};\n use syntax::ext::base::SyntaxExtension;\n use syntax::ext::base::Determinacy::{self, Determined, Undetermined};\n@@ -1789,8 +1789,17 @@ impl<'a> Resolver<'a> {\n         result\n     }\n \n-    fn resolve_crate_root(&mut self, mut ctxt: SyntaxContext) -> Module<'a> {\n-        let module = match ctxt.adjust(Mark::root()) {\n+    fn resolve_crate_root(&mut self, mut ctxt: SyntaxContext, legacy: bool) -> Module<'a> {\n+        let mark = if legacy {\n+            // When resolving `$crate` from a `macro_rules!` invoked in a `macro`,\n+            // we don't want to pretend that the `macro_rules!` definition is in the `macro`\n+            // as described in `SyntaxContext::apply_mark`, so we ignore prepended modern marks.\n+            ctxt.marks().into_iter().find(|&mark| mark.kind() != MarkKind::Modern)\n+        } else {\n+            ctxt = ctxt.modern();\n+            ctxt.adjust(Mark::root())\n+        };\n+        let module = match mark {\n             Some(def) => self.macro_def_scope(def),\n             None => return self.graph_root,\n         };\n@@ -2992,11 +3001,11 @@ impl<'a> Resolver<'a> {\n                    (i == 1 && name == keywords::Crate.name() &&\n                               path[0].node.name == keywords::CrateRoot.name()) {\n                     // `::a::b` or `::crate::a::b`\n-                    module = Some(self.resolve_crate_root(ident.node.ctxt.modern()));\n+                    module = Some(self.resolve_crate_root(ident.node.ctxt, false));\n                     continue\n                 } else if i == 0 && name == keywords::DollarCrate.name() {\n                     // `$crate::a::b`\n-                    module = Some(self.resolve_crate_root(ident.node.ctxt));\n+                    module = Some(self.resolve_crate_root(ident.node.ctxt, true));\n                     continue\n                 } else if i == 1 && !token::Ident(ident.node).is_path_segment_keyword() {\n                     let prev_name = path[0].node.name;"}, {"sha": "7c2ea4a68b0060b6e7d3ca8da06b050521e3dde8", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -140,7 +140,7 @@ impl<'a> base::Resolver for Resolver<'a> {\n                 let ident = path.segments[0].identifier;\n                 if ident.name == keywords::DollarCrate.name() {\n                     path.segments[0].identifier.name = keywords::CrateRoot.name();\n-                    let module = self.0.resolve_crate_root(ident.ctxt);\n+                    let module = self.0.resolve_crate_root(ident.ctxt, true);\n                     if !module.is_local() {\n                         let span = path.segments[0].span;\n                         path.segments.insert(1, match module.kind {"}, {"sha": "132119e961bc377459d8af78f84872523c49a127", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -623,7 +623,7 @@ impl<'a, 'b:'a> ImportResolver<'a, 'b> {\n                                          \"crate root imports need to be explicitly named: \\\n                                           `use crate as name;`\".to_string()));\n                         } else {\n-                            Some(self.resolve_crate_root(source.ctxt.modern()))\n+                            Some(self.resolve_crate_root(source.ctxt.modern(), false))\n                         }\n                     } else if is_extern && !token::Ident(source).is_path_segment_keyword() {\n                         let crate_id ="}, {"sha": "b7fba9fe8dfb0671728f590523b9513e0f12d212", "filename": "src/libsyntax_pos/hygiene.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibsyntax_pos%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Flibsyntax_pos%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fhygiene.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -188,6 +188,33 @@ impl SyntaxContext {\n \n     /// Extend a syntax context with a given mark\n     pub fn apply_mark(self, mark: Mark) -> SyntaxContext {\n+        if mark.kind() == MarkKind::Modern {\n+            return self.apply_mark_internal(mark);\n+        }\n+\n+        let call_site_ctxt =\n+            mark.expn_info().map_or(SyntaxContext::empty(), |info| info.call_site.ctxt()).modern();\n+        if call_site_ctxt == SyntaxContext::empty() {\n+            return self.apply_mark_internal(mark);\n+        }\n+\n+        // Otherwise, `mark` is a macros 1.0 definition and the call site is in a\n+        // macros 2.0 expansion, i.e. a macros 1.0 invocation is in a macros 2.0 definition.\n+        //\n+        // In this case, the tokens from the macros 1.0 definition inherit the hygiene\n+        // at their invocation. That is, we pretend that the macros 1.0 definition\n+        // was defined at its invocation (i.e. inside the macros 2.0 definition)\n+        // so that the macros 2.0 definition remains hygienic.\n+        //\n+        // See the example at `test/run-pass/hygiene/legacy_interaction.rs`.\n+        let mut ctxt = call_site_ctxt;\n+        for mark in self.marks() {\n+            ctxt = ctxt.apply_mark_internal(mark);\n+        }\n+        ctxt.apply_mark_internal(mark)\n+    }\n+\n+    fn apply_mark_internal(self, mark: Mark) -> SyntaxContext {\n         HygieneData::with(|data| {\n             let syntax_contexts = &mut data.syntax_contexts;\n             let mut modern = syntax_contexts[self.0 as usize].modern;\n@@ -222,6 +249,18 @@ impl SyntaxContext {\n         })\n     }\n \n+    pub fn marks(mut self) -> Vec<Mark> {\n+        HygieneData::with(|data| {\n+            let mut marks = Vec::new();\n+            while self != SyntaxContext::empty() {\n+                marks.push(data.syntax_contexts[self.0 as usize].outer_mark);\n+                self = data.syntax_contexts[self.0 as usize].prev_ctxt;\n+            }\n+            marks.reverse();\n+            marks\n+        })\n+    }\n+\n     /// Adjust this context for resolution in a scope created by the given expansion.\n     /// For example, consider the following three resolutions of `f`:\n     ///"}, {"sha": "c614ee4d57501b3eb31b6165f74420962c22e463", "filename": "src/test/run-pass/hygiene/auxiliary/legacy_interaction.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Flegacy_interaction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Flegacy_interaction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Flegacy_interaction.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-pretty pretty-printing is unhygienic\n+\n+#[macro_export]\n+macro_rules! m {\n+    () => {\n+        fn f() {} // (2)\n+        g(); // (1)\n+    }\n+}"}, {"sha": "e10d20b6d47cf0797d2a04e49d8a85d9f2124f94", "filename": "src/test/run-pass/hygiene/auxiliary/my_crate.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Fmy_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Fmy_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Fmy_crate.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -0,0 +1,11 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub fn f() {}"}, {"sha": "298e0209a0987895c424294e666d2fbf715ffd42", "filename": "src/test/run-pass/hygiene/auxiliary/unhygienic_example.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Funhygienic_example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Funhygienic_example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fhygiene%2Fauxiliary%2Funhygienic_example.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -0,0 +1,37 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type = \"lib\"]\n+\n+extern crate my_crate;\n+\n+pub fn g() {} // (a)\n+\n+#[macro_export]\n+macro_rules! unhygienic_macro {\n+    () => {\n+        // (1) unhygienic: depends on `my_crate` in the crate root at the invocation site.\n+        ::my_crate::f();\n+\n+        // (2) unhygienic: defines `f` at the invocation site (in addition to the above point).\n+        use my_crate::f;\n+        f();\n+\n+        g(); // (3) unhygienic: `g` needs to be in scope at use site.\n+\n+        $crate::g(); // (4) hygienic: this always resolves to (a)\n+    }\n+}\n+\n+#[allow(unused)]\n+fn test_unhygienic() {\n+    unhygienic_macro!();\n+    f(); // `f` was defined at the use site\n+}"}, {"sha": "683a15b99aebea3116acb55803ee22c192ff0b8d", "filename": "src/test/run-pass/hygiene/legacy_interaction.rs", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Flegacy_interaction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Flegacy_interaction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fhygiene%2Flegacy_interaction.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -0,0 +1,50 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-pretty pretty-printing is unhygienic\n+\n+// aux-build:legacy_interaction.rs\n+\n+#![feature(decl_macro)]\n+#[allow(unused)]\n+\n+extern crate legacy_interaction;\n+// ^ defines\n+// ```rust\n+//  macro_rules! m {\n+//     () => {\n+//         fn f() // (1)\n+//         g() // (2)\n+//     }\n+// }\n+// ```rust\n+\n+mod def_site {\n+    // Unless this macro opts out of hygiene, it should resolve the same wherever it is invoked.\n+    pub macro m2() {\n+        ::legacy_interaction::m!();\n+        f(); // This should resolve to (1)\n+        fn g() {} // We want (2) resolve to this, not to (4)\n+    }\n+}\n+\n+mod use_site {\n+    fn test() {\n+        fn f() -> bool { true } // (3)\n+        fn g() -> bool { true } // (4)\n+\n+        ::def_site::m2!();\n+\n+        let _: bool = f(); // This should resolve to (3)\n+        let _: bool = g(); // This should resolve to (4)\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "5520695021438a8d7f10ff24e7e840fc27bbe8ac", "filename": "src/test/run-pass/hygiene/wrap_unhygienic_example.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fwrap_unhygienic_example.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b90e4e8cd068910f604f3e1fb5d03cc01f1658f/src%2Ftest%2Frun-pass%2Fhygiene%2Fwrap_unhygienic_example.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fhygiene%2Fwrap_unhygienic_example.rs?ref=0b90e4e8cd068910f604f3e1fb5d03cc01f1658f", "patch": "@@ -0,0 +1,43 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-pretty pretty-printing is unhygienic\n+\n+// aux-build:my_crate.rs\n+// aux-build:unhygienic_example.rs\n+\n+#![feature(decl_macro)]\n+\n+extern crate unhygienic_example;\n+extern crate my_crate; // (b)\n+\n+// Hygienic version of `unhygienic_macro`.\n+pub macro hygienic_macro() {\n+    fn g() {} // (c)\n+    ::unhygienic_example::unhygienic_macro!();\n+    // ^ Even though we invoke an unhygienic macro, `hygienic_macro` remains hygienic.\n+    // In the above expansion:\n+    // (1) `my_crate` always resolves to (b) regardless of invocation site.\n+    // (2) The defined function `f` is only usable inside this macro definition.\n+    // (3) `g` always resolves to (c) regardless of invocation site.\n+    // (4) `$crate::g` remains hygienic and continues to resolve to (a).\n+\n+    f();\n+}\n+\n+#[allow(unused)]\n+fn test_hygienic_macro() {\n+    hygienic_macro!();\n+\n+    fn f() {} // (d) no conflict\n+    f(); // resolves to (d)\n+}\n+\n+fn main() {}"}]}