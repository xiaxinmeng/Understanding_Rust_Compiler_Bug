{"sha": "ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVjMjNkYjk0OTY4MDdmNmM5NjJiNzRmZTBkNmJmMTViZTZjNmQzNWI=", "commit": {"author": {"name": "Patrick Jos\u00e9 Pereira", "email": "patrickelectric@gmail.com", "date": "2020-10-03T18:46:28Z"}, "committer": {"name": "Patrick Jos\u00e9 Pereira", "email": "patrickelectric@gmail.com", "date": "2020-10-19T12:53:35Z"}, "message": "Add linter for a single element for loop\n\nSigned-off-by: Patrick Jos\u00e9 Pereira <patrickelectric@gmail.com>", "tree": {"sha": "2defc09742fdb2b342b6107298e794c49ba0bd58", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2defc09742fdb2b342b6107298e794c49ba0bd58"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "html_url": "https://github.com/rust-lang/rust/commit/ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/comments", "author": {"login": "patrickelectric", "id": 1215497, "node_id": "MDQ6VXNlcjEyMTU0OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1215497?v=4", "gravatar_id": "", "url": "https://api.github.com/users/patrickelectric", "html_url": "https://github.com/patrickelectric", "followers_url": "https://api.github.com/users/patrickelectric/followers", "following_url": "https://api.github.com/users/patrickelectric/following{/other_user}", "gists_url": "https://api.github.com/users/patrickelectric/gists{/gist_id}", "starred_url": "https://api.github.com/users/patrickelectric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/patrickelectric/subscriptions", "organizations_url": "https://api.github.com/users/patrickelectric/orgs", "repos_url": "https://api.github.com/users/patrickelectric/repos", "events_url": "https://api.github.com/users/patrickelectric/events{/privacy}", "received_events_url": "https://api.github.com/users/patrickelectric/received_events", "type": "User", "site_admin": false}, "committer": {"login": "patrickelectric", "id": 1215497, "node_id": "MDQ6VXNlcjEyMTU0OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1215497?v=4", "gravatar_id": "", "url": "https://api.github.com/users/patrickelectric", "html_url": "https://github.com/patrickelectric", "followers_url": "https://api.github.com/users/patrickelectric/followers", "following_url": "https://api.github.com/users/patrickelectric/following{/other_user}", "gists_url": "https://api.github.com/users/patrickelectric/gists{/gist_id}", "starred_url": "https://api.github.com/users/patrickelectric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/patrickelectric/subscriptions", "organizations_url": "https://api.github.com/users/patrickelectric/orgs", "repos_url": "https://api.github.com/users/patrickelectric/repos", "events_url": "https://api.github.com/users/patrickelectric/events{/privacy}", "received_events_url": "https://api.github.com/users/patrickelectric/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3d3507230c62e94dcef2cea8c25c90d1d171e329", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d3507230c62e94dcef2cea8c25c90d1d171e329", "html_url": "https://github.com/rust-lang/rust/commit/3d3507230c62e94dcef2cea8c25c90d1d171e329"}], "stats": {"total": 122, "additions": 119, "deletions": 3}, "files": [{"sha": "1bf25bcd0f96ad60eedf1d00bff3f1d509414ed9", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -1936,6 +1936,7 @@ Released 2018-09-13\n [`single_char_pattern`]: https://rust-lang.github.io/rust-clippy/master/index.html#single_char_pattern\n [`single_char_push_str`]: https://rust-lang.github.io/rust-clippy/master/index.html#single_char_push_str\n [`single_component_path_imports`]: https://rust-lang.github.io/rust-clippy/master/index.html#single_component_path_imports\n+[`single_element_loop`]: https://rust-lang.github.io/rust-clippy/master/index.html#single_element_loop\n [`single_match`]: https://rust-lang.github.io/rust-clippy/master/index.html#single_match\n [`single_match_else`]: https://rust-lang.github.io/rust-clippy/master/index.html#single_match_else\n [`skip_while_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#skip_while_next"}, {"sha": "84ea2d5ca78c29d420a019c3dcd994735c3fecb5", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -633,6 +633,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &loops::NEEDLESS_RANGE_LOOP,\n         &loops::NEVER_LOOP,\n         &loops::SAME_ITEM_PUSH,\n+        &loops::SINGLE_ELEMENT_LOOP,\n         &loops::WHILE_IMMUTABLE_CONDITION,\n         &loops::WHILE_LET_LOOP,\n         &loops::WHILE_LET_ON_ITERATOR,\n@@ -1363,6 +1364,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&loops::NEEDLESS_RANGE_LOOP),\n         LintId::of(&loops::NEVER_LOOP),\n         LintId::of(&loops::SAME_ITEM_PUSH),\n+        LintId::of(&loops::SINGLE_ELEMENT_LOOP),\n         LintId::of(&loops::WHILE_IMMUTABLE_CONDITION),\n         LintId::of(&loops::WHILE_LET_LOOP),\n         LintId::of(&loops::WHILE_LET_ON_ITERATOR),\n@@ -1664,6 +1666,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&lifetimes::NEEDLESS_LIFETIMES),\n         LintId::of(&loops::EXPLICIT_COUNTER_LOOP),\n         LintId::of(&loops::MUT_RANGE_BOUND),\n+        LintId::of(&loops::SINGLE_ELEMENT_LOOP),\n         LintId::of(&loops::WHILE_LET_LOOP),\n         LintId::of(&manual_strip::MANUAL_STRIP),\n         LintId::of(&manual_unwrap_or::MANUAL_UNWRAP_OR),"}, {"sha": "e50aa9ac15a287cc8f6477205c7450e2445e4b1d", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 68, "deletions": 3, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -4,9 +4,10 @@ use crate::utils::sugg::Sugg;\n use crate::utils::usage::{is_unused, mutated_variables};\n use crate::utils::{\n     contains_name, get_enclosing_block, get_parent_expr, get_trait_def_id, has_iter_method, higher, implements_trait,\n-    is_integer_const, is_no_std_crate, is_refutable, is_type_diagnostic_item, last_path_segment, match_trait_method,\n-    match_type, match_var, multispan_sugg, qpath_res, snippet, snippet_with_applicability, snippet_with_macro_callsite,\n-    span_lint, span_lint_and_help, span_lint_and_sugg, span_lint_and_then, sugg, SpanlessEq,\n+    indent_of, is_integer_const, is_no_std_crate, is_refutable, is_type_diagnostic_item, last_path_segment,\n+    match_trait_method, match_type, match_var, multispan_sugg, qpath_res, single_segment_path, snippet,\n+    snippet_with_applicability, snippet_with_macro_callsite, span_lint, span_lint_and_help, span_lint_and_sugg,\n+    span_lint_and_then, sugg, SpanlessEq,\n };\n use if_chain::if_chain;\n use rustc_ast::ast;\n@@ -452,6 +453,31 @@ declare_clippy_lint! {\n     \"the same item is pushed inside of a for loop\"\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Checks whether a for loop has a single element.\n+    ///\n+    /// **Why is this bad?** There is no reason to have a loop of a\n+    /// single element.\n+    /// **Known problems:** None\n+    ///\n+    /// **Example:**\n+    /// ```rust\n+    /// let item1 = 2;\n+    /// for item in &[item1] {\n+    ///     println!(\"{}\", item);\n+    /// }\n+    /// ```\n+    /// could be written as\n+    /// ```rust\n+    /// let item1 = 2;\n+    /// let item = &item1;\n+    /// println!(\"{}\", item);\n+    /// ```\n+    pub SINGLE_ELEMENT_LOOP,\n+    complexity,\n+    \"there is no reason to have a single element loop\"\n+}\n+\n declare_lint_pass!(Loops => [\n     MANUAL_MEMCPY,\n     NEEDLESS_RANGE_LOOP,\n@@ -469,6 +495,7 @@ declare_lint_pass!(Loops => [\n     MUT_RANGE_BOUND,\n     WHILE_IMMUTABLE_CONDITION,\n     SAME_ITEM_PUSH,\n+    SINGLE_ELEMENT_LOOP,\n ]);\n \n impl<'tcx> LateLintPass<'tcx> for Loops {\n@@ -777,6 +804,7 @@ fn check_for_loop<'tcx>(\n     check_for_loop_arg(cx, pat, arg, expr);\n     check_for_loop_over_map_kv(cx, pat, arg, body, expr);\n     check_for_mut_range_bound(cx, arg, body);\n+    check_for_single_element_loop(cx, pat, arg, body, expr);\n     detect_same_item_push(cx, pat, arg, body, expr);\n }\n \n@@ -1866,6 +1894,43 @@ fn check_for_loop_over_map_kv<'tcx>(\n     }\n }\n \n+fn check_for_single_element_loop<'tcx>(\n+    cx: &LateContext<'tcx>,\n+    pat: &'tcx Pat<'_>,\n+    arg: &'tcx Expr<'_>,\n+    body: &'tcx Expr<'_>,\n+    expr: &'tcx Expr<'_>,\n+) {\n+    if_chain! {\n+        if let ExprKind::AddrOf(BorrowKind::Ref, _, ref arg_expr) = arg.kind;\n+        if let PatKind::Binding(.., target, _) = pat.kind;\n+        if let ExprKind::Array(ref arg_expr_list) = arg_expr.kind;\n+        if let [arg_expression] = arg_expr_list;\n+        if let ExprKind::Path(ref list_item) = arg_expression.kind;\n+        if let Some(list_item_name) = single_segment_path(list_item).map(|ps| ps.ident.name);\n+        if let ExprKind::Block(ref block, _) = body.kind;\n+        if !block.stmts.is_empty();\n+\n+        then {\n+            let for_span = get_span_of_entire_for_loop(expr);\n+            let mut block_str = snippet(cx, block.span, \"..\").into_owned();\n+            block_str.remove(0);\n+            block_str.pop();\n+\n+\n+            span_lint_and_sugg(\n+                cx,\n+                SINGLE_ELEMENT_LOOP,\n+                for_span,\n+                \"for loop over a single element\",\n+                \"try\",\n+                format!(\"{{\\n{}let {} = &{};{}}}\", \" \".repeat(indent_of(cx, block.stmts[0].span).unwrap_or(0)), target.name, list_item_name, block_str),\n+                Applicability::MachineApplicable\n+            )\n+        }\n+    }\n+}\n+\n struct MutatePairDelegate<'a, 'tcx> {\n     cx: &'a LateContext<'tcx>,\n     hir_id_low: Option<HirId>,"}, {"sha": "70369dc582a198acb735de8dcf1f4f529434070c", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -2125,6 +2125,13 @@ vec![\n         deprecation: None,\n         module: \"single_component_path_imports\",\n     },\n+    Lint {\n+        name: \"single_element_loop\",\n+        group: \"complexity\",\n+        desc: \"there is no reason to have a single element loop\",\n+        deprecation: None,\n+        module: \"loops\",\n+    },\n     Lint {\n         name: \"single_match\",\n         group: \"style\","}, {"sha": "8ca068293a611455cd246bd1d5a16b73456027c7", "filename": "tests/ui/single_element_loop.fixed", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/tests%2Fui%2Fsingle_element_loop.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/tests%2Fui%2Fsingle_element_loop.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_element_loop.fixed?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -0,0 +1,11 @@\n+// run-rustfix\n+// Tests from for_loop.rs that don't have suggestions\n+\n+#[warn(clippy::single_element_loop)]\n+fn main() {\n+    let item1 = 2;\n+    {\n+        let item = &item1;\n+        println!(\"{}\", item);\n+    }\n+}"}, {"sha": "57e9336a31fcf6c3d775273f7c7a78bedee5c0cf", "filename": "tests/ui/single_element_loop.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/tests%2Fui%2Fsingle_element_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/tests%2Fui%2Fsingle_element_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_element_loop.rs?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -0,0 +1,10 @@\n+// run-rustfix\n+// Tests from for_loop.rs that don't have suggestions\n+\n+#[warn(clippy::single_element_loop)]\n+fn main() {\n+    let item1 = 2;\n+    for item in &[item1] {\n+        println!(\"{}\", item);\n+    }\n+}"}, {"sha": "90be1dc328371f6bc611cc236bd14b31f600d6e1", "filename": "tests/ui/single_element_loop.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/tests%2Fui%2Fsingle_element_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ec23db9496807f6c962b74fe0d6bf15be6c6d35b/tests%2Fui%2Fsingle_element_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_element_loop.stderr?ref=ec23db9496807f6c962b74fe0d6bf15be6c6d35b", "patch": "@@ -0,0 +1,19 @@\n+error: for loop over a single element\n+  --> $DIR/single_element_loop.rs:7:5\n+   |\n+LL | /     for item in &[item1] {\n+LL | |         println!(\"{}\", item);\n+LL | |     }\n+   | |_____^\n+   |\n+   = note: `-D clippy::single-element-loop` implied by `-D warnings`\n+help: try\n+   |\n+LL |     {\n+LL |         let item = &item1;\n+LL |         println!(\"{}\", item);\n+LL |     }\n+   |\n+\n+error: aborting due to previous error\n+"}]}