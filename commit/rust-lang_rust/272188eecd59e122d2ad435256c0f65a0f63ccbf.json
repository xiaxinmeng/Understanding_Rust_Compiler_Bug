{"sha": "272188eecd59e122d2ad435256c0f65a0f63ccbf", "node_id": "C_kwDOAAsO6NoAKDI3MjE4OGVlY2Q1OWUxMjJkMmFkNDM1MjU2YzBmNjVhMGY2M2NjYmY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-12-15T00:28:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-12-15T00:28:04Z"}, "message": "Rollup merge of #90939 - estebank:wg-af-polish, r=tmandry\n\nTweak errors coming from `for`-loop, `?` and `.await` desugaring\n\n * Suggest removal of `.await` on non-`Future` expression\n * Keep track of obligations introduced by desugaring\n * Remove span pointing at method for obligation errors coming from desugaring\n * Point at called local sync `fn` and suggest making it `async`\n\n```\nerror[E0277]: `()` is not a future\n  --> $DIR/unnecessary-await.rs:9:10\n   |\nLL |     boo().await;\n   |     -----^^^^^^ `()` is not a future\n   |     |\n   |     this call returns `()`\n   |\n   = help: the trait `Future` is not implemented for `()`\nhelp: do not `.await` the expression\n   |\nLL -     boo().await;\nLL +     boo();\n   |\nhelp: alternatively, consider making `fn boo` asynchronous\n   |\nLL | async fn boo () {}\n   | +++++\n```\n\nFix #66731.", "tree": {"sha": "c1f7c6eb8711727fb3b43d592f5abf1a8abf3948", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1f7c6eb8711727fb3b43d592f5abf1a8abf3948"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/272188eecd59e122d2ad435256c0f65a0f63ccbf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhuTaVCRBK7hj4Ov3rIwAAqEYIAFUtPdMA75VybAelbp1Djlds\ny86DOInIN2YD4b4ecwnhXxAShuJCdKqCWLtd4l25oV91pHFoqD3Yos2q0aKT4wBl\nvBK9pv/FGGB4zvHH4sTllRiVi5Q10IIs3MvWvPPysPsh7Odipob63x2Td81rXYZF\nojI5snHW7q7HJFwi5TYXszz5HNLF2TIsm8QU3roQIbXTdwfISGj/LZD6Z60NhRPA\n1UHJqfKKhobVgjbQNg/AYCXAx9wZkgF8bDTU/mIAGSGBlez3Ygw2W/4VBohJBmbC\noMFwZhPhq0NF3Qj2vxuvY5o8gatXSpT7wncn/Z42e49AgLiuP3zuVEGrw26Rczw=\n=iCAB\n-----END PGP SIGNATURE-----\n", "payload": "tree c1f7c6eb8711727fb3b43d592f5abf1a8abf3948\nparent 2f4da6243f817b26c5c8156408911a01b39f9759\nparent f2fc84f60456d2acc480ca3b5616e5e9612575ec\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1639528084 +0100\ncommitter GitHub <noreply@github.com> 1639528084 +0100\n\nRollup merge of #90939 - estebank:wg-af-polish, r=tmandry\n\nTweak errors coming from `for`-loop, `?` and `.await` desugaring\n\n * Suggest removal of `.await` on non-`Future` expression\n * Keep track of obligations introduced by desugaring\n * Remove span pointing at method for obligation errors coming from desugaring\n * Point at called local sync `fn` and suggest making it `async`\n\n```\nerror[E0277]: `()` is not a future\n  --> $DIR/unnecessary-await.rs:9:10\n   |\nLL |     boo().await;\n   |     -----^^^^^^ `()` is not a future\n   |     |\n   |     this call returns `()`\n   |\n   = help: the trait `Future` is not implemented for `()`\nhelp: do not `.await` the expression\n   |\nLL -     boo().await;\nLL +     boo();\n   |\nhelp: alternatively, consider making `fn boo` asynchronous\n   |\nLL | async fn boo () {}\n   | +++++\n```\n\nFix #66731.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/272188eecd59e122d2ad435256c0f65a0f63ccbf", "html_url": "https://github.com/rust-lang/rust/commit/272188eecd59e122d2ad435256c0f65a0f63ccbf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/272188eecd59e122d2ad435256c0f65a0f63ccbf/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f4da6243f817b26c5c8156408911a01b39f9759", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f4da6243f817b26c5c8156408911a01b39f9759", "html_url": "https://github.com/rust-lang/rust/commit/2f4da6243f817b26c5c8156408911a01b39f9759"}, {"sha": "f2fc84f60456d2acc480ca3b5616e5e9612575ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2fc84f60456d2acc480ca3b5616e5e9612575ec", "html_url": "https://github.com/rust-lang/rust/commit/f2fc84f60456d2acc480ca3b5616e5e9612575ec"}], "stats": {"total": 812, "additions": 446, "deletions": 366}, "files": [{"sha": "75a45a437e77eb893757f9ebf835a5a1931da9c6", "filename": "compiler/rustc_ast_lowering/src/expr.rs", "status": "modified", "additions": 55, "deletions": 15, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -130,7 +130,15 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                         hir::AsyncGeneratorKind::Block,\n                         |this| this.with_new_scopes(|this| this.lower_block_expr(block)),\n                     ),\n-                ExprKind::Await(ref expr) => self.lower_expr_await(e.span, expr),\n+                ExprKind::Await(ref expr) => {\n+                    let span = if expr.span.hi() < e.span.hi() {\n+                        expr.span.shrink_to_hi().with_hi(e.span.hi())\n+                    } else {\n+                        // this is a recovered `await expr`\n+                        e.span\n+                    };\n+                    self.lower_expr_await(span, expr)\n+                }\n                 ExprKind::Closure(\n                     capture_clause,\n                     asyncness,\n@@ -479,8 +487,12 @@ impl<'hir> LoweringContext<'_, 'hir> {\n         expr: &'hir hir::Expr<'hir>,\n         overall_span: Span,\n     ) -> &'hir hir::Expr<'hir> {\n-        let constructor =\n-            self.arena.alloc(self.expr_lang_item_path(method_span, lang_item, ThinVec::new()));\n+        let constructor = self.arena.alloc(self.expr_lang_item_path(\n+            method_span,\n+            lang_item,\n+            ThinVec::new(),\n+            None,\n+        ));\n         self.expr_call(overall_span, constructor, std::slice::from_ref(expr))\n     }\n \n@@ -584,8 +596,12 @@ impl<'hir> LoweringContext<'_, 'hir> {\n         // `future::from_generator`:\n         let unstable_span =\n             self.mark_span_with_reason(DesugaringKind::Async, span, self.allow_gen_future.clone());\n-        let gen_future =\n-            self.expr_lang_item_path(unstable_span, hir::LangItem::FromGenerator, ThinVec::new());\n+        let gen_future = self.expr_lang_item_path(\n+            unstable_span,\n+            hir::LangItem::FromGenerator,\n+            ThinVec::new(),\n+            None,\n+        );\n \n         // `future::from_generator(generator)`:\n         hir::ExprKind::Call(self.arena.alloc(gen_future), arena_vec![self; generator])\n@@ -607,6 +623,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n     /// }\n     /// ```\n     fn lower_expr_await(&mut self, await_span: Span, expr: &Expr) -> hir::ExprKind<'hir> {\n+        let dot_await_span = expr.span.shrink_to_hi().to(await_span);\n         match self.generator_kind {\n             Some(hir::GeneratorKind::Async(_)) => {}\n             Some(hir::GeneratorKind::Gen) | None => {\n@@ -623,13 +640,14 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                 err.emit();\n             }\n         }\n-        let span = self.mark_span_with_reason(DesugaringKind::Await, await_span, None);\n+        let span = self.mark_span_with_reason(DesugaringKind::Await, dot_await_span, None);\n         let gen_future_span = self.mark_span_with_reason(\n             DesugaringKind::Await,\n             await_span,\n             self.allow_gen_future.clone(),\n         );\n         let expr = self.lower_expr_mut(expr);\n+        let expr_hir_id = expr.hir_id;\n \n         let pinned_ident = Ident::with_dummy_span(sym::pinned);\n         let (pinned_pat, pinned_pat_hid) =\n@@ -656,16 +674,19 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                 span,\n                 hir::LangItem::PinNewUnchecked,\n                 arena_vec![self; ref_mut_pinned],\n+                Some(expr_hir_id),\n             );\n             let get_context = self.expr_call_lang_item_fn_mut(\n                 gen_future_span,\n                 hir::LangItem::GetContext,\n                 arena_vec![self; task_context],\n+                Some(expr_hir_id),\n             );\n             let call = self.expr_call_lang_item_fn(\n                 span,\n                 hir::LangItem::FuturePoll,\n                 arena_vec![self; new_unchecked, get_context],\n+                Some(expr_hir_id),\n             );\n             self.arena.alloc(self.expr_unsafe(call))\n         };\n@@ -678,18 +699,28 @@ impl<'hir> LoweringContext<'_, 'hir> {\n             let (x_pat, x_pat_hid) = self.pat_ident(span, x_ident);\n             let x_expr = self.expr_ident(span, x_ident, x_pat_hid);\n             let ready_field = self.single_pat_field(span, x_pat);\n-            let ready_pat = self.pat_lang_item_variant(span, hir::LangItem::PollReady, ready_field);\n+            let ready_pat = self.pat_lang_item_variant(\n+                span,\n+                hir::LangItem::PollReady,\n+                ready_field,\n+                Some(expr_hir_id),\n+            );\n             let break_x = self.with_loop_scope(loop_node_id, move |this| {\n                 let expr_break =\n                     hir::ExprKind::Break(this.lower_loop_destination(None), Some(x_expr));\n-                this.arena.alloc(this.expr(await_span, expr_break, ThinVec::new()))\n+                this.arena.alloc(this.expr(span, expr_break, ThinVec::new()))\n             });\n             self.arm(ready_pat, break_x)\n         };\n \n         // `::std::task::Poll::Pending => {}`\n         let pending_arm = {\n-            let pending_pat = self.pat_lang_item_variant(span, hir::LangItem::PollPending, &[]);\n+            let pending_pat = self.pat_lang_item_variant(\n+                span,\n+                hir::LangItem::PollPending,\n+                &[],\n+                Some(expr_hir_id),\n+            );\n             let empty_block = self.expr_block_empty(span);\n             self.arm(pending_pat, empty_block)\n         };\n@@ -709,7 +740,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n             let unit = self.expr_unit(span);\n             let yield_expr = self.expr(\n                 span,\n-                hir::ExprKind::Yield(unit, hir::YieldSource::Await { expr: Some(expr.hir_id) }),\n+                hir::ExprKind::Yield(unit, hir::YieldSource::Await { expr: Some(expr_hir_id) }),\n                 ThinVec::new(),\n             );\n             let yield_expr = self.arena.alloc(yield_expr);\n@@ -756,6 +787,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n             into_future_span,\n             hir::LangItem::IntoFutureIntoFuture,\n             arena_vec![self; expr],\n+            Some(expr_hir_id),\n         );\n \n         // match <into_future_expr> {\n@@ -1160,7 +1192,8 @@ impl<'hir> LoweringContext<'_, 'hir> {\n     fn lower_expr_range_closed(&mut self, span: Span, e1: &Expr, e2: &Expr) -> hir::ExprKind<'hir> {\n         let e1 = self.lower_expr_mut(e1);\n         let e2 = self.lower_expr_mut(e2);\n-        let fn_path = hir::QPath::LangItem(hir::LangItem::RangeInclusiveNew, self.lower_span(span));\n+        let fn_path =\n+            hir::QPath::LangItem(hir::LangItem::RangeInclusiveNew, self.lower_span(span), None);\n         let fn_expr =\n             self.arena.alloc(self.expr(span, hir::ExprKind::Path(fn_path), ThinVec::new()));\n         hir::ExprKind::Call(fn_expr, arena_vec![self; e1, e2])\n@@ -1194,7 +1227,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n         );\n \n         hir::ExprKind::Struct(\n-            self.arena.alloc(hir::QPath::LangItem(lang_item, self.lower_span(span))),\n+            self.arena.alloc(hir::QPath::LangItem(lang_item, self.lower_span(span), None)),\n             fields,\n             None,\n         )\n@@ -1389,6 +1422,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                 head_span,\n                 hir::LangItem::IteratorNext,\n                 arena_vec![self; ref_mut_iter],\n+                None,\n             );\n             let arms = arena_vec![self; none_arm, some_arm];\n \n@@ -1417,6 +1451,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                 head_span,\n                 hir::LangItem::IntoIterIntoIter,\n                 arena_vec![self; head],\n+                None,\n             )\n         };\n \n@@ -1472,6 +1507,7 @@ impl<'hir> LoweringContext<'_, 'hir> {\n                 unstable_span,\n                 hir::LangItem::TryTraitBranch,\n                 arena_vec![self; sub_expr],\n+                None,\n             )\n         };\n \n@@ -1628,8 +1664,10 @@ impl<'hir> LoweringContext<'_, 'hir> {\n         span: Span,\n         lang_item: hir::LangItem,\n         args: &'hir [hir::Expr<'hir>],\n+        hir_id: Option<hir::HirId>,\n     ) -> hir::Expr<'hir> {\n-        let path = self.arena.alloc(self.expr_lang_item_path(span, lang_item, ThinVec::new()));\n+        let path =\n+            self.arena.alloc(self.expr_lang_item_path(span, lang_item, ThinVec::new(), hir_id));\n         self.expr_call_mut(span, path, args)\n     }\n \n@@ -1638,19 +1676,21 @@ impl<'hir> LoweringContext<'_, 'hir> {\n         span: Span,\n         lang_item: hir::LangItem,\n         args: &'hir [hir::Expr<'hir>],\n+        hir_id: Option<hir::HirId>,\n     ) -> &'hir hir::Expr<'hir> {\n-        self.arena.alloc(self.expr_call_lang_item_fn_mut(span, lang_item, args))\n+        self.arena.alloc(self.expr_call_lang_item_fn_mut(span, lang_item, args, hir_id))\n     }\n \n     fn expr_lang_item_path(\n         &mut self,\n         span: Span,\n         lang_item: hir::LangItem,\n         attrs: AttrVec,\n+        hir_id: Option<hir::HirId>,\n     ) -> hir::Expr<'hir> {\n         self.expr(\n             span,\n-            hir::ExprKind::Path(hir::QPath::LangItem(lang_item, self.lower_span(span))),\n+            hir::ExprKind::Path(hir::QPath::LangItem(lang_item, self.lower_span(span), hir_id)),\n             attrs,\n         )\n     }"}, {"sha": "e03e82b2b7784f97b46a73dcad8df3e000f68690", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -2127,21 +2127,21 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n \n     fn pat_cf_continue(&mut self, span: Span, pat: &'hir hir::Pat<'hir>) -> &'hir hir::Pat<'hir> {\n         let field = self.single_pat_field(span, pat);\n-        self.pat_lang_item_variant(span, hir::LangItem::ControlFlowContinue, field)\n+        self.pat_lang_item_variant(span, hir::LangItem::ControlFlowContinue, field, None)\n     }\n \n     fn pat_cf_break(&mut self, span: Span, pat: &'hir hir::Pat<'hir>) -> &'hir hir::Pat<'hir> {\n         let field = self.single_pat_field(span, pat);\n-        self.pat_lang_item_variant(span, hir::LangItem::ControlFlowBreak, field)\n+        self.pat_lang_item_variant(span, hir::LangItem::ControlFlowBreak, field, None)\n     }\n \n     fn pat_some(&mut self, span: Span, pat: &'hir hir::Pat<'hir>) -> &'hir hir::Pat<'hir> {\n         let field = self.single_pat_field(span, pat);\n-        self.pat_lang_item_variant(span, hir::LangItem::OptionSome, field)\n+        self.pat_lang_item_variant(span, hir::LangItem::OptionSome, field, None)\n     }\n \n     fn pat_none(&mut self, span: Span) -> &'hir hir::Pat<'hir> {\n-        self.pat_lang_item_variant(span, hir::LangItem::OptionNone, &[])\n+        self.pat_lang_item_variant(span, hir::LangItem::OptionNone, &[], None)\n     }\n \n     fn single_pat_field(\n@@ -2164,8 +2164,9 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         span: Span,\n         lang_item: hir::LangItem,\n         fields: &'hir [hir::PatField<'hir>],\n+        hir_id: Option<hir::HirId>,\n     ) -> &'hir hir::Pat<'hir> {\n-        let qpath = hir::QPath::LangItem(lang_item, self.lower_span(span));\n+        let qpath = hir::QPath::LangItem(lang_item, self.lower_span(span), hir_id);\n         self.pat(span, hir::PatKind::Struct(qpath, fields, false))\n     }\n "}, {"sha": "f044c187f39a30d2ddd599f80c369040803bc7bb", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1627,13 +1627,13 @@ pub fn is_range_literal(expr: &Expr<'_>) -> bool {\n                     | LangItem::RangeFrom\n                     | LangItem::RangeFull\n                     | LangItem::RangeToInclusive,\n-                _,\n+                ..\n             )\n         ),\n \n         // `..=` desugars into `::std::ops::RangeInclusive::new(...)`.\n         ExprKind::Call(ref func, _) => {\n-            matches!(func.kind, ExprKind::Path(QPath::LangItem(LangItem::RangeInclusiveNew, _)))\n+            matches!(func.kind, ExprKind::Path(QPath::LangItem(LangItem::RangeInclusiveNew, ..)))\n         }\n \n         _ => false,\n@@ -1788,8 +1788,8 @@ pub enum QPath<'hir> {\n     /// the `X` and `Y` nodes each being a `TyKind::Path(QPath::TypeRelative(..))`.\n     TypeRelative(&'hir Ty<'hir>, &'hir PathSegment<'hir>),\n \n-    /// Reference to a `#[lang = \"foo\"]` item.\n-    LangItem(LangItem, Span),\n+    /// Reference to a `#[lang = \"foo\"]` item. `HirId` of the inner expr.\n+    LangItem(LangItem, Span, Option<HirId>),\n }\n \n impl<'hir> QPath<'hir> {\n@@ -1798,7 +1798,7 @@ impl<'hir> QPath<'hir> {\n         match *self {\n             QPath::Resolved(_, path) => path.span,\n             QPath::TypeRelative(qself, ps) => qself.span.to(ps.ident.span),\n-            QPath::LangItem(_, span) => span,\n+            QPath::LangItem(_, span, _) => span,\n         }\n     }\n \n@@ -1808,7 +1808,7 @@ impl<'hir> QPath<'hir> {\n         match *self {\n             QPath::Resolved(_, path) => path.span,\n             QPath::TypeRelative(qself, _) => qself.span,\n-            QPath::LangItem(_, span) => span,\n+            QPath::LangItem(_, span, _) => span,\n         }\n     }\n \n@@ -1818,7 +1818,7 @@ impl<'hir> QPath<'hir> {\n         match *self {\n             QPath::Resolved(_, path) => path.segments.last().unwrap().ident.span,\n             QPath::TypeRelative(_, segment) => segment.ident.span,\n-            QPath::LangItem(_, span) => span,\n+            QPath::LangItem(_, span, _) => span,\n         }\n     }\n }"}, {"sha": "389e3845c56b9bf6b87568533c6025ce99d1e671", "filename": "compiler/rustc_hir_pretty/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_hir_pretty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_hir_pretty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_pretty%2Fsrc%2Flib.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1731,7 +1731,7 @@ impl<'a> State<'a> {\n                     colons_before_params,\n                 )\n             }\n-            hir::QPath::LangItem(lang_item, span) => {\n+            hir::QPath::LangItem(lang_item, span, _) => {\n                 self.word(\"#[lang = \\\"\");\n                 self.print_ident(Ident::new(lang_item.name(), span));\n                 self.word(\"\\\"]\");"}, {"sha": "b6151757588dd7c19470291bca4035001fe2cb6f", "filename": "compiler/rustc_lint/src/array_into_iter.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_lint%2Fsrc%2Farray_into_iter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_lint%2Fsrc%2Farray_into_iter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Farray_into_iter.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -52,7 +52,7 @@ impl<'tcx> LateLintPass<'tcx> for ArrayIntoIter {\n             if let hir::ExprKind::Call(path, [arg]) = &arg.kind {\n                 if let hir::ExprKind::Path(hir::QPath::LangItem(\n                     hir::LangItem::IntoIterIntoIter,\n-                    _,\n+                    ..,\n                 )) = &path.kind\n                 {\n                     self.for_expr_span = arg.span;"}, {"sha": "a5bd246712b8ee2a9d12d90ccd8ab31e7168ce0f", "filename": "compiler/rustc_middle/src/traits/mod.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -348,6 +348,12 @@ pub enum ObligationCauseCode<'tcx> {\n     /// If `X` is the concrete type of an opaque type `impl Y`, then `X` must implement `Y`\n     OpaqueType,\n \n+    AwaitableExpr(Option<hir::HirId>),\n+\n+    ForLoopIterator,\n+\n+    QuestionMark,\n+\n     /// Well-formed checking. If a `WellFormedLoc` is provided,\n     /// then it will be used to eprform HIR-based wf checking\n     /// after an error occurs, in order to generate a more precise error span."}, {"sha": "8968c163987dcc01951856789412932ab3d63145", "filename": "compiler/rustc_passes/src/region.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_passes%2Fsrc%2Fregion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_passes%2Fsrc%2Fregion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fregion.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -421,11 +421,14 @@ fn resolve_expr<'tcx>(visitor: &mut RegionResolutionVisitor<'tcx>, expr: &'tcx h\n         // Mark this expr's scope and all parent scopes as containing `yield`.\n         let mut scope = Scope { id: expr.hir_id.local_id, data: ScopeData::Node };\n         loop {\n-            let data = YieldData {\n-                span: expr.span,\n-                expr_and_pat_count: visitor.expr_and_pat_count,\n-                source: *source,\n+            let span = match expr.kind {\n+                hir::ExprKind::Yield(expr, hir::YieldSource::Await { .. }) => {\n+                    expr.span.shrink_to_hi().to(expr.span)\n+                }\n+                _ => expr.span,\n             };\n+            let data =\n+                YieldData { span, expr_and_pat_count: visitor.expr_and_pat_count, source: *source };\n             visitor.scope_tree.yield_in_scope.insert(scope, data);\n             if visitor.pessimistic_yield {\n                 debug!(\"resolve_expr in pessimistic_yield - marking scope {:?} for fixup\", scope);"}, {"sha": "1d9c44bffa3fc83cdf1618ef6c418a4d2b1e4534", "filename": "compiler/rustc_save_analysis/src/sig.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_save_analysis%2Fsrc%2Fsig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_save_analysis%2Fsrc%2Fsig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_save_analysis%2Fsrc%2Fsig.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -286,7 +286,7 @@ impl<'hir> Sig for hir::Ty<'hir> {\n                     refs: vec![SigElement { id, start, end }],\n                 })\n             }\n-            hir::TyKind::Path(hir::QPath::LangItem(lang_item, _)) => {\n+            hir::TyKind::Path(hir::QPath::LangItem(lang_item, _, _)) => {\n                 Ok(text_sig(format!(\"#[lang = \\\"{}\\\"]\", lang_item.name())))\n             }\n             hir::TyKind::TraitObject(bounds, ..) => {"}, {"sha": "239d9d65c58646fbcd39405dafb074e6b4d2ba52", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -439,6 +439,7 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                         self.suggest_remove_reference(&obligation, &mut err, trait_ref);\n                         self.suggest_semicolon_removal(&obligation, &mut err, span, trait_ref);\n                         self.note_version_mismatch(&mut err, &trait_ref);\n+                        self.suggest_remove_await(&obligation, &mut err);\n \n                         if Some(trait_ref.def_id()) == tcx.lang_items().try_trait() {\n                             self.suggest_await_before_try(&mut err, &obligation, trait_ref, span);"}, {"sha": "4d17a7140e80b19496efa05a6a59f0b1a68598a9", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 120, "deletions": 121, "changes": 241, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -89,6 +89,12 @@ pub trait InferCtxtExt<'tcx> {\n         trait_ref: ty::Binder<'tcx, ty::TraitRef<'tcx>>,\n     );\n \n+    fn suggest_remove_await(\n+        &self,\n+        obligation: &PredicateObligation<'tcx>,\n+        err: &mut DiagnosticBuilder<'_>,\n+    );\n+\n     fn suggest_change_mut(\n         &self,\n         obligation: &PredicateObligation<'tcx>,\n@@ -873,6 +879,63 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n         }\n     }\n \n+    fn suggest_remove_await(\n+        &self,\n+        obligation: &PredicateObligation<'tcx>,\n+        err: &mut DiagnosticBuilder<'_>,\n+    ) {\n+        let span = obligation.cause.span;\n+\n+        if let ObligationCauseCode::AwaitableExpr(hir_id) = obligation.cause.code.peel_derives() {\n+            let hir = self.tcx.hir();\n+            if let Some(node) = hir_id.and_then(|hir_id| hir.find(hir_id)) {\n+                if let hir::Node::Expr(expr) = node {\n+                    // FIXME: use `obligation.predicate.kind()...trait_ref.self_ty()` to see if we have `()`\n+                    // and if not maybe suggest doing something else? If we kept the expression around we\n+                    // could also check if it is an fn call (very likely) and suggest changing *that*, if\n+                    // it is from the local crate.\n+                    err.span_suggestion_verbose(\n+                        expr.span.shrink_to_hi().with_hi(span.hi()),\n+                        \"remove the `.await`\",\n+                        String::new(),\n+                        Applicability::MachineApplicable,\n+                    );\n+                    // FIXME: account for associated `async fn`s.\n+                    if let hir::Expr { span, kind: hir::ExprKind::Call(base, _), .. } = expr {\n+                        if let ty::PredicateKind::Trait(pred) =\n+                            obligation.predicate.kind().skip_binder()\n+                        {\n+                            err.span_label(\n+                                *span,\n+                                &format!(\"this call returns `{}`\", pred.self_ty()),\n+                            );\n+                        }\n+                        if let Some(typeck_results) =\n+                            self.in_progress_typeck_results.map(|t| t.borrow())\n+                        {\n+                            let ty = typeck_results.expr_ty_adjusted(base);\n+                            if let ty::FnDef(def_id, _substs) = ty.kind() {\n+                                if let Some(hir::Node::Item(hir::Item { span, ident, .. })) =\n+                                    hir.get_if_local(*def_id)\n+                                {\n+                                    err.span_suggestion_verbose(\n+                                        span.shrink_to_lo(),\n+                                        &format!(\n+                                            \"alternatively, consider making `fn {}` asynchronous\",\n+                                            ident\n+                                        ),\n+                                        \"async \".to_string(),\n+                                        Applicability::MaybeIncorrect,\n+                                    );\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n     /// Check if the trait bound is implemented for a different mutability and note it in the\n     /// final error.\n     fn suggest_change_mut(\n@@ -1654,130 +1717,63 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n             format!(\"does not implement `{}`\", trait_ref.print_only_trait_path())\n         };\n \n-        let mut explain_yield =\n-            |interior_span: Span, yield_span: Span, scope_span: Option<Span>| {\n-                let mut span = MultiSpan::from_span(yield_span);\n-                if let Ok(snippet) = source_map.span_to_snippet(interior_span) {\n-                    // #70935: If snippet contains newlines, display \"the value\" instead\n-                    // so that we do not emit complex diagnostics.\n-                    let snippet = &format!(\"`{}`\", snippet);\n-                    let snippet = if snippet.contains('\\n') { \"the value\" } else { snippet };\n-                    // The multispan can be complex here, like:\n-                    // note: future is not `Send` as this value is used across an await\n-                    //   --> $DIR/issue-70935-complex-spans.rs:13:9\n-                    //    |\n-                    // LL |            baz(|| async{\n-                    //    |  __________^___-\n-                    //    | | _________|\n-                    //    | ||\n-                    // LL | ||             foo(tx.clone());\n-                    // LL | ||         }).await;\n-                    //    | ||         -      ^- value is later dropped here\n-                    //    | ||_________|______|\n-                    //    | |__________|      await occurs here, with value maybe used later\n-                    //    |            has type `closure` which is not `Send`\n-                    //\n-                    // So, detect it and separate into some notes, like:\n-                    //\n-                    // note: future is not `Send` as this value is used across an await\n-                    //   --> $DIR/issue-70935-complex-spans.rs:13:9\n-                    //    |\n-                    // LL | /         baz(|| async{\n-                    // LL | |             foo(tx.clone());\n-                    // LL | |         }).await;\n-                    //    | |________________^ first, await occurs here, with the value maybe used later...\n-                    // note: the value is later dropped here\n-                    //   --> $DIR/issue-70935-complex-spans.rs:15:17\n-                    //    |\n-                    // LL |         }).await;\n-                    //    |                 ^\n-                    //\n-                    // If available, use the scope span to annotate the drop location.\n-                    if let Some(scope_span) = scope_span {\n-                        let scope_span = source_map.end_point(scope_span);\n-                        let is_overlapped =\n-                            yield_span.overlaps(scope_span) || yield_span.overlaps(interior_span);\n-                        if is_overlapped {\n-                            span.push_span_label(\n-                                yield_span,\n-                                format!(\n-                                    \"first, {} occurs here, with {} maybe used later...\",\n-                                    await_or_yield, snippet\n-                                ),\n-                            );\n-                            err.span_note(\n-                                span,\n-                                &format!(\n-                                    \"{} {} as this value is used across {}\",\n-                                    future_or_generator, trait_explanation, an_await_or_yield\n-                                ),\n-                            );\n-                            if source_map.is_multiline(interior_span) {\n-                                err.span_note(\n-                                    scope_span,\n-                                    &format!(\"{} is later dropped here\", snippet),\n-                                );\n-                                err.span_note(\n-                                    interior_span,\n-                                    &format!(\n-                                        \"this has type `{}` which {}\",\n-                                        target_ty, trait_explanation\n-                                    ),\n-                                );\n-                            } else {\n-                                let mut span = MultiSpan::from_span(scope_span);\n-                                span.push_span_label(\n-                                    interior_span,\n-                                    format!(\"has type `{}` which {}\", target_ty, trait_explanation),\n-                                );\n-                                err.span_note(span, &format!(\"{} is later dropped here\", snippet));\n-                            }\n-                        } else {\n-                            span.push_span_label(\n-                                yield_span,\n-                                format!(\n-                                    \"{} occurs here, with {} maybe used later\",\n-                                    await_or_yield, snippet\n-                                ),\n-                            );\n-                            span.push_span_label(\n-                                scope_span,\n-                                format!(\"{} is later dropped here\", snippet),\n-                            );\n-                            span.push_span_label(\n-                                interior_span,\n-                                format!(\"has type `{}` which {}\", target_ty, trait_explanation),\n-                            );\n-                            err.span_note(\n-                                span,\n-                                &format!(\n-                                    \"{} {} as this value is used across {}\",\n-                                    future_or_generator, trait_explanation, an_await_or_yield\n-                                ),\n-                            );\n-                        }\n+        let mut explain_yield = |interior_span: Span,\n+                                 yield_span: Span,\n+                                 scope_span: Option<Span>| {\n+            let mut span = MultiSpan::from_span(yield_span);\n+            if let Ok(snippet) = source_map.span_to_snippet(interior_span) {\n+                // #70935: If snippet contains newlines, display \"the value\" instead\n+                // so that we do not emit complex diagnostics.\n+                let snippet = &format!(\"`{}`\", snippet);\n+                let snippet = if snippet.contains('\\n') { \"the value\" } else { snippet };\n+                // note: future is not `Send` as this value is used across an await\n+                //   --> $DIR/issue-70935-complex-spans.rs:13:9\n+                //    |\n+                // LL |            baz(|| async {\n+                //    |  ______________-\n+                //    | |\n+                //    | |\n+                // LL | |              foo(tx.clone());\n+                // LL | |          }).await;\n+                //    | |          - ^^^^^^ await occurs here, with value maybe used later\n+                //    | |__________|\n+                //    |            has type `closure` which is not `Send`\n+                // note: value is later dropped here\n+                // LL | |          }).await;\n+                //    | |                  ^\n+                //\n+                span.push_span_label(\n+                    yield_span,\n+                    format!(\"{} occurs here, with {} maybe used later\", await_or_yield, snippet),\n+                );\n+                span.push_span_label(\n+                    interior_span,\n+                    format!(\"has type `{}` which {}\", target_ty, trait_explanation),\n+                );\n+                // If available, use the scope span to annotate the drop location.\n+                let mut scope_note = None;\n+                if let Some(scope_span) = scope_span {\n+                    let scope_span = source_map.end_point(scope_span);\n+\n+                    let msg = format!(\"{} is later dropped here\", snippet);\n+                    if source_map.is_multiline(yield_span.between(scope_span)) {\n+                        span.push_span_label(scope_span, msg);\n                     } else {\n-                        span.push_span_label(\n-                            yield_span,\n-                            format!(\n-                                \"{} occurs here, with {} maybe used later\",\n-                                await_or_yield, snippet\n-                            ),\n-                        );\n-                        span.push_span_label(\n-                            interior_span,\n-                            format!(\"has type `{}` which {}\", target_ty, trait_explanation),\n-                        );\n-                        err.span_note(\n-                            span,\n-                            &format!(\n-                                \"{} {} as this value is used across {}\",\n-                                future_or_generator, trait_explanation, an_await_or_yield\n-                            ),\n-                        );\n+                        scope_note = Some((scope_span, msg));\n                     }\n                 }\n-            };\n+                err.span_note(\n+                    span,\n+                    &format!(\n+                        \"{} {} as this value is used across {}\",\n+                        future_or_generator, trait_explanation, an_await_or_yield\n+                    ),\n+                );\n+                if let Some((span, msg)) = scope_note {\n+                    err.span_note(span, &msg);\n+                }\n+            }\n+        };\n         match interior_or_upvar_span {\n             GeneratorInteriorOrUpvar::Interior(interior_span) => {\n                 if let Some((scope_span, yield_span, expr, from_awaited_ty)) = interior_extra_info {\n@@ -1935,6 +1931,9 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n             | ObligationCauseCode::ReturnType\n             | ObligationCauseCode::ReturnValue(_)\n             | ObligationCauseCode::BlockTailExpression(_)\n+            | ObligationCauseCode::AwaitableExpr(_)\n+            | ObligationCauseCode::ForLoopIterator\n+            | ObligationCauseCode::QuestionMark\n             | ObligationCauseCode::LetElse => {}\n             ObligationCauseCode::SliceOrArrayElem => {\n                 err.note(\"slice and array elements must have `Sized` type\");"}, {"sha": "23c3b5af262a20183c3e9611b71ff11449acbd57", "filename": "compiler/rustc_typeck/src/astconv/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -2340,7 +2340,7 @@ impl<'o, 'tcx> dyn AstConv<'tcx> + 'o {\n                     .map(|(ty, _, _)| ty)\n                     .unwrap_or_else(|_| tcx.ty_error())\n             }\n-            hir::TyKind::Path(hir::QPath::LangItem(lang_item, span)) => {\n+            hir::TyKind::Path(hir::QPath::LangItem(lang_item, span, _)) => {\n                 let def_id = tcx.require_lang_item(lang_item, Some(span));\n                 let (substs, _) = self.create_substs_for_ast_path(\n                     span,"}, {"sha": "bc6ad3c9686719a8f8df63ad146276035ddd102f", "filename": "compiler/rustc_typeck/src/check/expr.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -277,8 +277,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             ExprKind::AddrOf(kind, mutbl, oprnd) => {\n                 self.check_expr_addr_of(kind, mutbl, oprnd, expected, expr)\n             }\n-            ExprKind::Path(QPath::LangItem(lang_item, _)) => {\n-                self.check_lang_item_path(lang_item, expr)\n+            ExprKind::Path(QPath::LangItem(lang_item, _, hir_id)) => {\n+                self.check_lang_item_path(lang_item, expr, hir_id)\n             }\n             ExprKind::Path(ref qpath) => self.check_expr_path(qpath, expr, &[]),\n             ExprKind::InlineAsm(asm) => self.check_expr_asm(asm),\n@@ -498,8 +498,9 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         &self,\n         lang_item: hir::LangItem,\n         expr: &'tcx hir::Expr<'tcx>,\n+        hir_id: Option<hir::HirId>,\n     ) -> Ty<'tcx> {\n-        self.resolve_lang_item_path(lang_item, expr.span, expr.hir_id).1\n+        self.resolve_lang_item_path(lang_item, expr.span, expr.hir_id, hir_id).1\n     }\n \n     pub(crate) fn check_expr_path("}, {"sha": "738af9bfb8cc56b04e6a24524d282e28de41093f", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/_impl.rs", "status": "modified", "additions": 35, "deletions": 3, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -791,6 +791,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         lang_item: hir::LangItem,\n         span: Span,\n         hir_id: hir::HirId,\n+        expr_hir_id: Option<hir::HirId>,\n     ) -> (Res, Ty<'tcx>) {\n         let def_id = self.tcx.require_lang_item(lang_item, Some(span));\n         let def_kind = self.tcx.def_kind(def_id);\n@@ -804,7 +805,23 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         let ty = item_ty.subst(self.tcx, substs);\n \n         self.write_resolution(hir_id, Ok((def_kind, def_id)));\n-        self.add_required_obligations(span, def_id, &substs);\n+        self.add_required_obligations_with_code(\n+            span,\n+            def_id,\n+            &substs,\n+            match lang_item {\n+                hir::LangItem::IntoFutureIntoFuture => {\n+                    ObligationCauseCode::AwaitableExpr(expr_hir_id)\n+                }\n+                hir::LangItem::IteratorNext | hir::LangItem::IntoIterIntoIter => {\n+                    ObligationCauseCode::ForLoopIterator\n+                }\n+                hir::LangItem::TryTraitFromOutput\n+                | hir::LangItem::TryTraitFromResidual\n+                | hir::LangItem::TryTraitBranch => ObligationCauseCode::QuestionMark,\n+                _ => traits::ItemObligation(def_id),\n+            },\n+        );\n         (Res::Def(def_kind, def_id), ty)\n     }\n \n@@ -1486,12 +1503,27 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     }\n \n     /// Add all the obligations that are required, substituting and normalized appropriately.\n-    #[tracing::instrument(level = \"debug\", skip(self, span, def_id, substs))]\n     crate fn add_required_obligations(&self, span: Span, def_id: DefId, substs: &SubstsRef<'tcx>) {\n+        self.add_required_obligations_with_code(\n+            span,\n+            def_id,\n+            substs,\n+            traits::ItemObligation(def_id),\n+        )\n+    }\n+\n+    #[tracing::instrument(level = \"debug\", skip(self, span, def_id, substs))]\n+    fn add_required_obligations_with_code(\n+        &self,\n+        span: Span,\n+        def_id: DefId,\n+        substs: &SubstsRef<'tcx>,\n+        code: ObligationCauseCode<'tcx>,\n+    ) {\n         let (bounds, _) = self.instantiate_bounds(span, def_id, &substs);\n \n         for obligation in traits::predicates_for_generics(\n-            traits::ObligationCause::new(span, self.body_id, traits::ItemObligation(def_id)),\n+            traits::ObligationCause::new(span, self.body_id, code),\n             self.param_env,\n             bounds,\n         ) {"}, {"sha": "b2641726075c99a98c4cdd3fbefdcc790fe7c6d1", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/checks.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Fchecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Fchecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Fchecks.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -938,8 +938,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n                 (result.map_or(Res::Err, |(kind, def_id)| Res::Def(kind, def_id)), ty)\n             }\n-            QPath::LangItem(lang_item, span) => {\n-                self.resolve_lang_item_path(lang_item, span, hir_id)\n+            QPath::LangItem(lang_item, span, id) => {\n+                self.resolve_lang_item_path(lang_item, span, hir_id, id)\n             }\n         }\n     }"}, {"sha": "6a414ae8c4b800981533f7e44e297caa828f28e3", "filename": "library/core/src/ops/try_trait.rs", "status": "modified", "additions": 4, "deletions": 14, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -115,15 +115,14 @@ use crate::ops::ControlFlow;\n #[unstable(feature = \"try_trait_v2\", issue = \"84277\")]\n #[rustc_on_unimplemented(\n     on(\n-        all(from_method = \"from_output\", from_desugaring = \"TryBlock\"),\n+        all(from_desugaring = \"TryBlock\"),\n         message = \"a `try` block must return `Result` or `Option` \\\n                     (or another type that implements `{Try}`)\",\n         label = \"could not wrap the final value of the block as `{Self}` doesn't implement `Try`\",\n     ),\n     on(\n-        all(from_method = \"branch\", from_desugaring = \"QuestionMark\"),\n-        message = \"the `?` operator can only be applied to values \\\n-                    that implement `{Try}`\",\n+        all(from_desugaring = \"QuestionMark\"),\n+        message = \"the `?` operator can only be applied to values that implement `{Try}`\",\n         label = \"the `?` operator cannot be applied to type `{Self}`\"\n     )\n )]\n@@ -226,7 +225,6 @@ pub trait Try: FromResidual {\n #[rustc_on_unimplemented(\n     on(\n         all(\n-            from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::result::Result<T, E>\",\n             R = \"std::option::Option<std::convert::Infallible>\"\n@@ -238,7 +236,6 @@ pub trait Try: FromResidual {\n     ),\n     on(\n         all(\n-            from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::result::Result<T, E>\",\n         ),\n@@ -252,7 +249,6 @@ pub trait Try: FromResidual {\n     ),\n     on(\n         all(\n-            from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::option::Option<T>\",\n             R = \"std::result::Result<T, E>\",\n@@ -264,7 +260,6 @@ pub trait Try: FromResidual {\n     ),\n     on(\n         all(\n-            from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::option::Option<T>\",\n         ),\n@@ -277,7 +272,6 @@ pub trait Try: FromResidual {\n     ),\n     on(\n         all(\n-            from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::ops::ControlFlow<B, C>\",\n             R = \"std::ops::ControlFlow<B, C>\",\n@@ -290,7 +284,6 @@ pub trait Try: FromResidual {\n     ),\n     on(\n         all(\n-            from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::ops::ControlFlow<B, C>\",\n             // `R` is not a `ControlFlow`, as that case was matched previously\n@@ -301,10 +294,7 @@ pub trait Try: FromResidual {\n         enclosing_scope = \"this function returns a `ControlFlow`\",\n     ),\n     on(\n-        all(\n-            from_method = \"from_residual\",\n-            from_desugaring = \"QuestionMark\"\n-        ),\n+        all(from_desugaring = \"QuestionMark\"),\n         message = \"the `?` operator can only be used in {ItemContext} \\\n                     that returns `Result` or `Option` \\\n                     (or another type that implements `{FromResidual}`)\","}, {"sha": "2f69adbd81c51eb884cb9ca25e4ac269a016b146", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.async.txt", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.async.txt", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.async.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.async.txt?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -41,9 +41,9 @@\n    41|      1|                    // executed asynchronously.\n    42|      1|    match x {\n    43|      1|        y if c(x).await == y + 1 => { d().await; }\n-                      ^0                            ^0\n+                      ^0       ^0                   ^0 ^0\n    44|      1|        y if f().await == y + 1 => (),\n-                      ^0                         ^0\n+                      ^0      ^0                 ^0\n    45|      1|        _ => (),\n    46|       |    }\n    47|      1|}"}, {"sha": "7d4447b6d5578a171f55641bbe421eb4666af734", "filename": "src/test/ui/async-await/async-error-span.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fasync-error-span.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fasync-error-span.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fasync-error-span.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -14,10 +14,10 @@ LL |     let a;\n    |         ^ cannot infer type\n    |\n note: the type is part of the `async fn` body because of this `await`\n-  --> $DIR/async-error-span.rs:14:5\n+  --> $DIR/async-error-span.rs:14:17\n    |\n LL |     get_future().await;\n-   |     ^^^^^^^^^^^^^^^^^^\n+   |                 ^^^^^^\n \n error: aborting due to 2 previous errors\n "}, {"sha": "bff282085735c8d8ba701253aed8b0c72df0c5f7", "filename": "src/test/ui/async-await/async-fn-nonsend.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-nonsend.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-nonsend.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fasync-fn-nonsend.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,13 +6,13 @@ LL |     assert_send(local_dropped_before_await());\n    |\n    = help: within `impl Future<Output = ()>`, the trait `Send` is not implemented for `Rc<()>`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/async-fn-nonsend.rs:24:5\n+  --> $DIR/async-fn-nonsend.rs:24:10\n    |\n LL |     let x = non_send();\n    |         - has type `impl Debug` which is not `Send`\n LL |     drop(x);\n LL |     fut().await;\n-   |     ^^^^^^^^^^^ await occurs here, with `x` maybe used later\n+   |          ^^^^^^ await occurs here, with `x` maybe used later\n LL | }\n    | - `x` is later dropped here\n note: required by a bound in `assert_send`\n@@ -29,12 +29,12 @@ LL |     assert_send(non_send_temporary_in_match());\n    |\n    = help: within `impl Future<Output = ()>`, the trait `Send` is not implemented for `Rc<()>`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/async-fn-nonsend.rs:33:20\n+  --> $DIR/async-fn-nonsend.rs:33:25\n    |\n LL |     match Some(non_send()) {\n    |                ---------- has type `impl Debug` which is not `Send`\n LL |         Some(_) => fut().await,\n-   |                    ^^^^^^^^^^^ await occurs here, with `non_send()` maybe used later\n+   |                         ^^^^^^ await occurs here, with `non_send()` maybe used later\n ...\n LL | }\n    | - `non_send()` is later dropped here\n@@ -52,13 +52,13 @@ LL |     assert_send(non_sync_with_method_call());\n    |\n    = help: the trait `Send` is not implemented for `dyn std::fmt::Write`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/async-fn-nonsend.rs:42:9\n+  --> $DIR/async-fn-nonsend.rs:42:14\n    |\n LL |     let f: &mut std::fmt::Formatter = panic!();\n    |         - has type `&mut Formatter<'_>` which is not `Send`\n LL |     if non_sync().fmt(f).unwrap() == () {\n LL |         fut().await;\n-   |         ^^^^^^^^^^^ await occurs here, with `f` maybe used later\n+   |              ^^^^^^ await occurs here, with `f` maybe used later\n LL |     }\n LL | }\n    | - `f` is later dropped here"}, {"sha": "b4323c314badcc4659542f884b919b924f164cdb", "filename": "src/test/ui/async-await/await-keyword/incorrect-syntax-suggestions.stderr", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fawait-keyword%2Fincorrect-syntax-suggestions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fawait-keyword%2Fincorrect-syntax-suggestions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fawait-keyword%2Fincorrect-syntax-suggestions.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -162,68 +162,68 @@ LL |     let _ = (await bar())?;\n    |              ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:71:13\n+  --> $DIR/incorrect-syntax-suggestions.rs:71:18\n    |\n LL | fn foo13() -> Result<(), ()> {\n    |    ----- this is not `async`\n LL |     let _ = bar().await();\n-   |             ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                  ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:76:13\n+  --> $DIR/incorrect-syntax-suggestions.rs:76:18\n    |\n LL | fn foo14() -> Result<(), ()> {\n    |    ----- this is not `async`\n LL |     let _ = bar().await()?;\n-   |             ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                  ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:81:13\n+  --> $DIR/incorrect-syntax-suggestions.rs:81:18\n    |\n LL | fn foo15() -> Result<(), ()> {\n    |    ----- this is not `async`\n LL |     let _ = bar().await;\n-   |             ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                  ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:85:13\n+  --> $DIR/incorrect-syntax-suggestions.rs:85:18\n    |\n LL | fn foo16() -> Result<(), ()> {\n    |    ----- this is not `async`\n LL |     let _ = bar().await?;\n-   |             ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                  ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:90:17\n+  --> $DIR/incorrect-syntax-suggestions.rs:90:22\n    |\n LL |     fn foo() -> Result<(), ()> {\n    |        --- this is not `async`\n LL |         let _ = bar().await?;\n-   |                 ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                      ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:97:17\n+  --> $DIR/incorrect-syntax-suggestions.rs:97:22\n    |\n LL |     let foo = || {\n    |               -- this is not `async`\n LL |         let _ = bar().await?;\n-   |                 ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                      ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:113:17\n+  --> $DIR/incorrect-syntax-suggestions.rs:113:29\n    |\n LL |     fn foo() -> Result<(), ()> {\n    |        --- this is not `async`\n LL |         let _ = await!(bar())?;\n-   |                 ^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                             ^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/incorrect-syntax-suggestions.rs:121:17\n+  --> $DIR/incorrect-syntax-suggestions.rs:121:29\n    |\n LL |     let foo = || {\n    |               -- this is not `async`\n LL |         let _ = await!(bar())?;\n-   |                 ^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                             ^ only allowed inside `async` functions and blocks\n \n error: aborting due to 33 previous errors\n "}, {"sha": "e205de4738f24c3ebac12fd79d0d12c27e2ae625", "filename": "src/test/ui/async-await/issue-64130-1-sync.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-1-sync.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-1-sync.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-1-sync.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,12 +6,12 @@ LL |     is_sync(bar());\n    |\n    = help: within `impl Future<Output = ()>`, the trait `Sync` is not implemented for `Foo`\n note: future is not `Sync` as this value is used across an await\n-  --> $DIR/issue-64130-1-sync.rs:15:5\n+  --> $DIR/issue-64130-1-sync.rs:15:10\n    |\n LL |     let x = Foo;\n    |         - has type `Foo` which is not `Sync`\n LL |     baz().await;\n-   |     ^^^^^^^^^^^ await occurs here, with `x` maybe used later\n+   |          ^^^^^^ await occurs here, with `x` maybe used later\n LL | }\n    | - `x` is later dropped here\n note: required by a bound in `is_sync`"}, {"sha": "2225000e2e5797c6383d1c636fdec7de1147ff0b", "filename": "src/test/ui/async-await/issue-64130-2-send.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-2-send.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-2-send.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-2-send.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,12 +6,12 @@ LL |     is_send(bar());\n    |\n    = help: within `impl Future<Output = ()>`, the trait `Send` is not implemented for `Foo`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-64130-2-send.rs:15:5\n+  --> $DIR/issue-64130-2-send.rs:15:10\n    |\n LL |     let x = Foo;\n    |         - has type `Foo` which is not `Send`\n LL |     baz().await;\n-   |     ^^^^^^^^^^^ await occurs here, with `x` maybe used later\n+   |          ^^^^^^ await occurs here, with `x` maybe used later\n LL | }\n    | - `x` is later dropped here\n note: required by a bound in `is_send`"}, {"sha": "17867a6a3f62e6b6fc48f646a2967d89cc7b96ea", "filename": "src/test/ui/async-await/issue-64130-3-other.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-3-other.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-3-other.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-3-other.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -8,12 +8,12 @@ LL |     is_qux(bar());\n    |            ^^^^^ within `impl Future<Output = ()>`, the trait `Qux` is not implemented for `Foo`\n    |\n note: future does not implement `Qux` as this value is used across an await\n-  --> $DIR/issue-64130-3-other.rs:18:5\n+  --> $DIR/issue-64130-3-other.rs:18:10\n    |\n LL |     let x = Foo;\n    |         - has type `Foo` which does not implement `Qux`\n LL |     baz().await;\n-   |     ^^^^^^^^^^^ await occurs here, with `x` maybe used later\n+   |          ^^^^^^ await occurs here, with `x` maybe used later\n LL | }\n    | - `x` is later dropped here\n note: required by a bound in `is_qux`"}, {"sha": "d631e6dc7f7e968aa80446b2791fbe7114d8a7fb", "filename": "src/test/ui/async-await/issue-64130-4-async-move.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-4-async-move.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-4-async-move.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-4-async-move.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,13 +6,13 @@ LL | pub fn foo() -> impl Future + Send {\n    |\n    = help: the trait `Sync` is not implemented for `(dyn Any + Send + 'static)`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-64130-4-async-move.rs:21:26\n+  --> $DIR/issue-64130-4-async-move.rs:21:31\n    |\n LL |         match client.status() {\n    |               ------ has type `&Client` which is not `Send`\n LL |             200 => {\n LL |                 let _x = get().await;\n-   |                          ^^^^^^^^^^^ await occurs here, with `client` maybe used later\n+   |                               ^^^^^^ await occurs here, with `client` maybe used later\n ...\n LL |     }\n    |     - `client` is later dropped here"}, {"sha": "1da80d98bf8fc465f0626b17421760c2a1fccdc6", "filename": "src/test/ui/async-await/issue-64130-non-send-future-diags.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-non-send-future-diags.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-non-send-future-diags.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-64130-non-send-future-diags.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,12 +6,12 @@ LL |     is_send(foo());\n    |\n    = help: within `impl Future<Output = ()>`, the trait `Send` is not implemented for `MutexGuard<'_, u32>`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-64130-non-send-future-diags.rs:17:5\n+  --> $DIR/issue-64130-non-send-future-diags.rs:17:10\n    |\n LL |     let g = x.lock().unwrap();\n    |         - has type `MutexGuard<'_, u32>` which is not `Send`\n LL |     baz().await;\n-   |     ^^^^^^^^^^^ await occurs here, with `g` maybe used later\n+   |          ^^^^^^ await occurs here, with `g` maybe used later\n LL | }\n    | - `g` is later dropped here\n note: required by a bound in `is_send`"}, {"sha": "f32e074d75d620a1656a053b5c2745b79e677a79", "filename": "src/test/ui/async-await/issue-67252-unnamed-future.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-67252-unnamed-future.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-67252-unnamed-future.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-67252-unnamed-future.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,12 +6,12 @@ LL |     spawn(async {\n    |\n    = help: within `impl Future<Output = [async output]>`, the trait `Send` is not implemented for `*mut ()`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-67252-unnamed-future.rs:20:9\n+  --> $DIR/issue-67252-unnamed-future.rs:20:16\n    |\n LL |         let _a = std::ptr::null_mut::<()>(); // `*mut ()` is not `Send`\n    |             -- has type `*mut ()` which is not `Send`\n LL |         AFuture.await;\n-   |         ^^^^^^^^^^^^^ await occurs here, with `_a` maybe used later\n+   |                ^^^^^^ await occurs here, with `_a` maybe used later\n LL |     });\n    |     - `_a` is later dropped here\n note: required by a bound in `spawn`"}, {"sha": "a159edd51187f35e6b2c42e6fe2378aae95de3ac", "filename": "src/test/ui/async-await/issue-70594.stderr", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-70594.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-70594.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-70594.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,10 +1,10 @@\n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-70594.rs:4:9\n+  --> $DIR/issue-70594.rs:4:11\n    |\n LL | async fn fun() {\n    |          --- this is not `async`\n LL |     [1; ().await];\n-   |         ^^^^^^^^ only allowed inside `async` functions and blocks\n+   |           ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0744]: `.await` is not allowed in a `const`\n   --> $DIR/issue-70594.rs:4:9\n@@ -13,20 +13,25 @@ LL |     [1; ().await];\n    |         ^^^^^^^^\n \n error[E0744]: `.await` is not allowed in a `const`\n-  --> $DIR/issue-70594.rs:4:9\n+  --> $DIR/issue-70594.rs:4:11\n    |\n LL |     [1; ().await];\n-   |         ^^^^^^^^\n+   |           ^^^^^^\n \n error[E0277]: `()` is not a future\n-  --> $DIR/issue-70594.rs:4:9\n+  --> $DIR/issue-70594.rs:4:11\n    |\n LL |     [1; ().await];\n-   |         ^^^^^^^^ `()` is not a future\n+   |           ^^^^^^ `()` is not a future\n    |\n    = help: the trait `Future` is not implemented for `()`\n    = note: () must be a future or must implement `IntoFuture` to be awaited\n    = note: required because of the requirements on the impl of `IntoFuture` for `()`\n+help: remove the `.await`\n+   |\n+LL -     [1; ().await];\n+LL +     [1; ()];\n+   | \n \n error: aborting due to 4 previous errors\n "}, {"sha": "db3099381196b771692e3f1b29677d201c77aea1", "filename": "src/test/ui/async-await/issue-70935-complex-spans.stderr", "status": "modified", "additions": 6, "deletions": 11, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,25 +6,20 @@ LL | fn foo(tx: std::sync::mpsc::Sender<i32>) -> impl Future + Send {\n    |\n    = help: the trait `Sync` is not implemented for `Sender<i32>`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-70935-complex-spans.rs:13:9\n+  --> $DIR/issue-70935-complex-spans.rs:15:11\n    |\n-LL | /         baz(|| async{\n+LL |           baz(|| async{\n+   |  _____________-\n LL | |             foo(tx.clone());\n LL | |         }).await;\n-   | |________________^ first, await occurs here, with the value maybe used later...\n+   | |         - ^^^^^^ await occurs here, with the value maybe used later\n+   | |_________|\n+   |           has type `[closure@$DIR/issue-70935-complex-spans.rs:13:13: 15:10]` which is not `Send`\n note: the value is later dropped here\n   --> $DIR/issue-70935-complex-spans.rs:15:17\n    |\n LL |         }).await;\n    |                 ^\n-note: this has type `[closure@$DIR/issue-70935-complex-spans.rs:13:13: 15:10]` which is not `Send`\n-  --> $DIR/issue-70935-complex-spans.rs:13:13\n-   |\n-LL |           baz(|| async{\n-   |  _____________^\n-LL | |             foo(tx.clone());\n-LL | |         }).await;\n-   | |_________^\n \n error: aborting due to previous error\n "}, {"sha": "eade6aa2d3dcc7673de407b8f2c86cbccbea88cd", "filename": "src/test/ui/async-await/issue-71137.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-71137.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissue-71137.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-71137.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,12 +6,12 @@ LL |   fake_spawn(wrong_mutex());\n    |\n    = help: within `impl Future<Output = ()>`, the trait `Send` is not implemented for `MutexGuard<'_, i32>`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-71137.rs:14:5\n+  --> $DIR/issue-71137.rs:14:25\n    |\n LL |     let mut guard = m.lock().unwrap();\n    |         --------- has type `MutexGuard<'_, i32>` which is not `Send`\n LL |     (async { \"right\"; }).await;\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^ await occurs here, with `mut guard` maybe used later\n+   |                         ^^^^^^ await occurs here, with `mut guard` maybe used later\n LL |     *guard += 1;\n LL |   }\n    |   - `mut guard` is later dropped here"}, {"sha": "f3ce5d1c897c3c5118af87de8d64fde83adf67a8", "filename": "src/test/ui/async-await/issues/issue-51719.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-51719.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-51719.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-51719.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,8 +1,8 @@\n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-51719.rs:8:19\n+  --> $DIR/issue-51719.rs:8:24\n    |\n LL |     let _gen = || foo().await;\n-   |                -- ^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                --      ^^^^^^ only allowed inside `async` functions and blocks\n    |                |\n    |                this is not `async`\n "}, {"sha": "8696a5b798b3c3259d62301ee82e28f05be5d8b0", "filename": "src/test/ui/async-await/issues/issue-51751.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-51751.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-51751.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-51751.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,11 +1,11 @@\n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-51751.rs:9:20\n+  --> $DIR/issue-51751.rs:9:26\n    |\n LL | fn main() {\n    |    ---- this is not `async`\n LL |     let result = inc(10000);\n LL |     let finished = result.await;\n-   |                    ^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                          ^^^^^^ only allowed inside `async` functions and blocks\n \n error: aborting due to previous error\n "}, {"sha": "40ccf25712e2b06dc6833b227d7e15a55a31cc85", "filename": "src/test/ui/async-await/issues/issue-62009-1.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-1.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,10 +6,10 @@ fn main() {\n     async { let (); }.await;\n     //~^ ERROR `await` is only allowed inside `async` functions and blocks\n     async {\n-    //~^ ERROR `await` is only allowed inside `async` functions and blocks\n         let task1 = print_dur().await;\n     }.await;\n+    //~^ ERROR `await` is only allowed inside `async` functions and blocks\n     (|_| 2333).await;\n     //~^ ERROR `await` is only allowed inside `async` functions and blocks\n-    //~^^ ERROR\n+    //~| ERROR is not a future\n }"}, {"sha": "3d80c34942c1b38229c258e8301654cdfd96fc18", "filename": "src/test/ui/async-await/issues/issue-62009-1.stderr", "status": "modified", "additions": 16, "deletions": 14, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-1.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,41 +1,43 @@\n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-62009-1.rs:6:5\n+  --> $DIR/issue-62009-1.rs:6:22\n    |\n LL | fn main() {\n    |    ---- this is not `async`\n LL |     async { let (); }.await;\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                      ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-62009-1.rs:8:5\n+  --> $DIR/issue-62009-1.rs:10:6\n    |\n-LL |   fn main() {\n-   |      ---- this is not `async`\n+LL | fn main() {\n+   |    ---- this is not `async`\n ...\n-LL | /     async {\n-LL | |\n-LL | |         let task1 = print_dur().await;\n-LL | |     }.await;\n-   | |___________^ only allowed inside `async` functions and blocks\n+LL |     }.await;\n+   |      ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-62009-1.rs:12:5\n+  --> $DIR/issue-62009-1.rs:12:15\n    |\n LL | fn main() {\n    |    ---- this is not `async`\n ...\n LL |     (|_| 2333).await;\n-   |     ^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |               ^^^^^^ only allowed inside `async` functions and blocks\n \n error[E0277]: `[closure@$DIR/issue-62009-1.rs:12:5: 12:15]` is not a future\n-  --> $DIR/issue-62009-1.rs:12:5\n+  --> $DIR/issue-62009-1.rs:12:15\n    |\n LL |     (|_| 2333).await;\n-   |     ^^^^^^^^^^^^^^^^ `[closure@$DIR/issue-62009-1.rs:12:5: 12:15]` is not a future\n+   |               ^^^^^^ `[closure@$DIR/issue-62009-1.rs:12:5: 12:15]` is not a future\n    |\n    = help: the trait `Future` is not implemented for `[closure@$DIR/issue-62009-1.rs:12:5: 12:15]`\n    = note: [closure@$DIR/issue-62009-1.rs:12:5: 12:15] must be a future or must implement `IntoFuture` to be awaited\n    = note: required because of the requirements on the impl of `IntoFuture` for `[closure@$DIR/issue-62009-1.rs:12:5: 12:15]`\n+help: remove the `.await`\n+   |\n+LL -     (|_| 2333).await;\n+LL +     (|_| 2333);\n+   | \n \n error: aborting due to 4 previous errors\n "}, {"sha": "92e9a8a69a88b1e0df087dc32130c454a173489e", "filename": "src/test/ui/async-await/issues/issue-62009-2.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-62009-2.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,10 +1,10 @@\n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/issue-62009-2.rs:8:5\n+  --> $DIR/issue-62009-2.rs:8:22\n    |\n LL | fn main() {\n    |    ---- this is not `async`\n LL |     (async || 2333)().await;\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                      ^^^^^^ only allowed inside `async` functions and blocks\n \n error: aborting due to previous error\n "}, {"sha": "b4d2006480390302ff4c02886bf3cfcdae3fc3dc", "filename": "src/test/ui/async-await/issues/issue-65436-raw-ptr-not-send.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-65436-raw-ptr-not-send.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-65436-raw-ptr-not-send.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-65436-raw-ptr-not-send.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,17 +6,17 @@ LL |     assert_send(async {\n    |\n    = help: within `impl Future<Output = [async output]>`, the trait `Send` is not implemented for `*const u8`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/issue-65436-raw-ptr-not-send.rs:14:9\n+  --> $DIR/issue-65436-raw-ptr-not-send.rs:14:35\n    |\n LL |         bar(Foo(std::ptr::null())).await;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ first, await occurs here, with `std::ptr::null()` maybe used later...\n+   |                 ----------------  ^^^^^^ await occurs here, with `std::ptr::null()` maybe used later\n+   |                 |\n+   |                 has type `*const u8` which is not `Send`\n note: `std::ptr::null()` is later dropped here\n   --> $DIR/issue-65436-raw-ptr-not-send.rs:14:41\n    |\n LL |         bar(Foo(std::ptr::null())).await;\n-   |                 ----------------        ^\n-   |                 |\n-   |                 has type `*const u8` which is not `Send`\n+   |                                         ^\n help: consider moving this into a `let` binding to create a shorter lived borrow\n   --> $DIR/issue-65436-raw-ptr-not-send.rs:14:13\n    |"}, {"sha": "20b827479fa808c75804caa4ff6caf5111070d0c", "filename": "src/test/ui/async-await/issues/non-async-enclosing-span.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,11 +1,11 @@\n error[E0728]: `await` is only allowed inside `async` functions and blocks\n-  --> $DIR/non-async-enclosing-span.rs:9:13\n+  --> $DIR/non-async-enclosing-span.rs:9:27\n    |\n LL | fn main() {\n    |    ---- this is not `async`\n LL |     let x = move || {};\n LL |     let y = do_the_thing().await;\n-   |             ^^^^^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+   |                           ^^^^^^ only allowed inside `async` functions and blocks\n \n error: aborting due to previous error\n "}, {"sha": "24673777b8039dd24bd54f963220920055248d60", "filename": "src/test/ui/async-await/unnecessary-await.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Funnecessary-await.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Funnecessary-await.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Funnecessary-await.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -0,0 +1,14 @@\n+// edition:2018\n+\n+async fn foo () { }\n+fn bar() -> impl std::future::Future { async {} }\n+fn boo() {}\n+\n+async fn baz() -> std::io::Result<()> {\n+    foo().await;\n+    boo().await; //~ ERROR `()` is not a future\n+    bar().await;\n+    std::io::Result::Ok(())\n+}\n+\n+fn main() {}"}, {"sha": "c3d2a6e7b1e1b6a38a41d533258ea4ebf7099150", "filename": "src/test/ui/async-await/unnecessary-await.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Funnecessary-await.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Funnecessary-await.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Funnecessary-await.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -0,0 +1,24 @@\n+error[E0277]: `()` is not a future\n+  --> $DIR/unnecessary-await.rs:9:10\n+   |\n+LL |     boo().await;\n+   |     -----^^^^^^ `()` is not a future\n+   |     |\n+   |     this call returns `()`\n+   |\n+   = help: the trait `Future` is not implemented for `()`\n+   = note: () must be a future or must implement `IntoFuture` to be awaited\n+   = note: required because of the requirements on the impl of `IntoFuture` for `()`\n+help: remove the `.await`\n+   |\n+LL -     boo().await;\n+LL +     boo();\n+   | \n+help: alternatively, consider making `fn boo` asynchronous\n+   |\n+LL | async fn boo() {}\n+   | +++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}, {"sha": "8c0ecb8785d3375dc2493ae7fc36f4612fc8d1ad", "filename": "src/test/ui/async-await/unresolved_type_param.stderr", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Funresolved_type_param.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fasync-await%2Funresolved_type_param.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Funresolved_type_param.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -5,10 +5,10 @@ LL |     bar().await;\n    |     ^^^ cannot infer type for type parameter `T` declared on the function `bar`\n    |\n note: the type is part of the `async fn` body because of this `await`\n-  --> $DIR/unresolved_type_param.rs:9:5\n+  --> $DIR/unresolved_type_param.rs:9:10\n    |\n LL |     bar().await;\n-   |     ^^^^^^^^^^^\n+   |          ^^^^^^\n \n error[E0698]: type inside `async fn` body must be known in this context\n   --> $DIR/unresolved_type_param.rs:9:5\n@@ -17,10 +17,10 @@ LL |     bar().await;\n    |     ^^^ cannot infer type for type parameter `T` declared on the function `bar`\n    |\n note: the type is part of the `async fn` body because of this `await`\n-  --> $DIR/unresolved_type_param.rs:9:5\n+  --> $DIR/unresolved_type_param.rs:9:10\n    |\n LL |     bar().await;\n-   |     ^^^^^^^^^^^\n+   |          ^^^^^^\n \n error[E0698]: type inside `async fn` body must be known in this context\n   --> $DIR/unresolved_type_param.rs:9:5\n@@ -29,10 +29,10 @@ LL |     bar().await;\n    |     ^^^ cannot infer type for type parameter `T` declared on the function `bar`\n    |\n note: the type is part of the `async fn` body because of this `await`\n-  --> $DIR/unresolved_type_param.rs:9:5\n+  --> $DIR/unresolved_type_param.rs:9:10\n    |\n LL |     bar().await;\n-   |     ^^^^^^^^^^^\n+   |          ^^^^^^\n \n error[E0698]: type inside `async fn` body must be known in this context\n   --> $DIR/unresolved_type_param.rs:9:5\n@@ -41,10 +41,10 @@ LL |     bar().await;\n    |     ^^^ cannot infer type for type parameter `T` declared on the function `bar`\n    |\n note: the type is part of the `async fn` body because of this `await`\n-  --> $DIR/unresolved_type_param.rs:9:5\n+  --> $DIR/unresolved_type_param.rs:9:10\n    |\n LL |     bar().await;\n-   |     ^^^^^^^^^^^\n+   |          ^^^^^^\n \n error[E0698]: type inside `async fn` body must be known in this context\n   --> $DIR/unresolved_type_param.rs:9:5\n@@ -53,10 +53,10 @@ LL |     bar().await;\n    |     ^^^ cannot infer type for type parameter `T` declared on the function `bar`\n    |\n note: the type is part of the `async fn` body because of this `await`\n-  --> $DIR/unresolved_type_param.rs:9:5\n+  --> $DIR/unresolved_type_param.rs:9:10\n    |\n LL |     bar().await;\n-   |     ^^^^^^^^^^^\n+   |          ^^^^^^\n \n error: aborting due to 5 previous errors\n "}, {"sha": "c6650d60c21e97371bf7d0614276a88c5eb47022", "filename": "src/test/ui/issues/issue-33941.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fissues%2Fissue-33941.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Fissues%2Fissue-33941.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-33941.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -16,10 +16,10 @@ error[E0271]: type mismatch resolving `<std::collections::hash_map::Iter<'_, _,\n   --> $DIR/issue-33941.rs:4:14\n    |\n LL |     for _ in HashMap::new().iter().cloned() {}\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected reference, found tuple\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected tuple, found reference\n    |\n-   = note: expected reference `&_`\n-                  found tuple `(&_, &_)`\n+   = note:  expected tuple `(&_, &_)`\n+           found reference `&_`\n    = note: required because of the requirements on the impl of `Iterator` for `Cloned<std::collections::hash_map::Iter<'_, _, _>>`\n    = note: required because of the requirements on the impl of `IntoIterator` for `Cloned<std::collections::hash_map::Iter<'_, _, _>>`\n "}, {"sha": "b3c9b43810cd90c845938f67dbc74d2215f2356c", "filename": "src/test/ui/lint/must_not_suspend/boxed.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fboxed.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fboxed.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fboxed.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -4,7 +4,7 @@ error: boxed `Umm` held across a suspend point, but should not be\n LL |     let _guard = bar();\n    |         ^^^^^^\n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/boxed.rs:3:9"}, {"sha": "bc1b611299a2b2caaf9e3e52af4b916f0689931e", "filename": "src/test/ui/lint/must_not_suspend/dedup.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fdedup.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fdedup.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fdedup.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -2,7 +2,7 @@ error: `No` held across a suspend point, but should not be\n   --> $DIR/dedup.rs:16:12\n    |\n LL |     wheeee(No {}).await;\n-   |     -------^^^^^------- the value is held across this suspend point\n+   |            ^^^^^ ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/dedup.rs:3:9"}, {"sha": "0d4319670e6622e7ade73ade1dc610e6e25feb41", "filename": "src/test/ui/lint/must_not_suspend/gated.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fgated.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fgated.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fgated.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -31,7 +31,7 @@ error: `MutexGuard` held across a suspend point, but should not be\n LL |     let _guard = m.lock().unwrap();\n    |         ^^^^^^\n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/gated.rs:2:9"}, {"sha": "a968b7ca0330fb7b72b3033b145624805b4006f1", "filename": "src/test/ui/lint/must_not_suspend/mutex.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fmutex.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fmutex.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fmutex.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -4,7 +4,7 @@ error: `MutexGuard` held across a suspend point, but should not be\n LL |     let _guard = m.lock().unwrap();\n    |         ^^^^^^\n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/mutex.rs:3:9"}, {"sha": "6d30f134ec4216afb0904a5ac7254f83e8a50e51", "filename": "src/test/ui/lint/must_not_suspend/ref.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -5,7 +5,7 @@ LL |         let guard = &mut self.u;\n    |                          ^^^^^^\n LL | \n LL |         other().await;\n-   |         ------------- the value is held across this suspend point\n+   |                ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/ref.rs:3:9"}, {"sha": "dd3978b02a852f36893372fe32d2e11420c37d1f", "filename": "src/test/ui/lint/must_not_suspend/trait.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Ftrait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Ftrait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Ftrait.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -5,7 +5,7 @@ LL |     let _guard1 = r#impl();\n    |         ^^^^^^^\n ...\n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/trait.rs:3:9\n@@ -25,7 +25,7 @@ LL |     let _guard2 = r#dyn();\n    |         ^^^^^^^\n LL | \n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n help: consider using a block (`{ ... }`) to shrink the value's scope, ending before the suspend point\n   --> $DIR/trait.rs:22:9"}, {"sha": "42d037b350b1999175231adb23c25d816c43aa26", "filename": "src/test/ui/lint/must_not_suspend/unit.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Funit.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Funit.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Funit.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -4,7 +4,7 @@ error: `Umm` held across a suspend point, but should not be\n LL |     let _guard = bar();\n    |         ^^^^^^\n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/unit.rs:3:9"}, {"sha": "417c397dad0101c0b48ea0e3a05f69a5e8d1601b", "filename": "src/test/ui/lint/must_not_suspend/warn.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fwarn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fwarn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fwarn.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -4,7 +4,7 @@ warning: `Umm` held across a suspend point, but should not be\n LL |     let _guard = bar();\n    |         ^^^^^^\n LL |     other().await;\n-   |     ------------- the value is held across this suspend point\n+   |            ------ the value is held across this suspend point\n    |\n note: the lint level is defined here\n   --> $DIR/warn.rs:4:9"}, {"sha": "e5fafdb075c66374f42ef4eafe0b13fb2ea52b9f", "filename": "src/tools/clippy/clippy_lints/src/methods/str_splitn.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fstr_splitn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fstr_splitn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fstr_splitn.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -204,7 +204,7 @@ fn parse_iter_usage(\n         match e.kind {\n             ExprKind::Call(\n                 Expr {\n-                    kind: ExprKind::Path(QPath::LangItem(LangItem::TryTraitBranch, _)),\n+                    kind: ExprKind::Path(QPath::LangItem(LangItem::TryTraitBranch, ..)),\n                     ..\n                 },\n                 _,"}, {"sha": "5b098659377c64805c5dc72eb8904bc740ca8ba1", "filename": "src/tools/clippy/clippy_lints/src/needless_late_init.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_late_init.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_late_init.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_late_init.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -73,7 +73,7 @@ fn contains_assign_expr<'tcx>(cx: &LateContext<'tcx>, stmt: &'tcx Stmt<'tcx>) ->\n     seen\n }\n \n-#[derive(Debug)]\n+#[derive(Debug, Clone)]\n struct LocalAssign {\n     lhs_id: HirId,\n     lhs_span: Span,\n@@ -154,9 +154,14 @@ fn assignment_suggestions<'tcx>(\n         assignments.push(assign);\n     }\n \n-    let suggestions = assignments\n+    let suggestions = assignments.clone()\n         .into_iter()\n-        .map(|assignment| Some((assignment.span, snippet_opt(cx, assignment.rhs_span)?)))\n+        .map(|assignment| Some((assignment.span.until(assignment.rhs_span), String::new())))\n+        .chain(\n+            assignments\n+                .into_iter()\n+                .map(|assignment| Some((assignment.rhs_span.shrink_to_hi().with_hi(assignment.span.hi()), String::new())))\n+        )\n         .collect::<Option<Vec<(Span, String)>>>()?;\n \n     let applicability = if suggestions.len() > 1 {"}, {"sha": "0e7ae43ce2dd53df347a380c4321f24b50f6cd51", "filename": "src/tools/clippy/clippy_lints/src/needless_question_mark.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_question_mark.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_question_mark.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_question_mark.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -105,7 +105,7 @@ fn check(cx: &LateContext<'_>, expr: &Expr<'_>) {\n         };\n         if let ExprKind::Match(inner_expr_with_q, _, MatchSource::TryDesugar) = &arg.kind;\n         if let ExprKind::Call(called, [inner_expr]) = &inner_expr_with_q.kind;\n-        if let ExprKind::Path(QPath::LangItem(LangItem::TryTraitBranch, _)) = &called.kind;\n+        if let ExprKind::Path(QPath::LangItem(LangItem::TryTraitBranch, ..)) = &called.kind;\n         if expr.span.ctxt() == inner_expr.span.ctxt();\n         let expr_ty = cx.typeck_results().expr_ty(expr);\n         let inner_ty = cx.typeck_results().expr_ty(inner_expr);"}, {"sha": "c2163a24b7f44b7271cf7116be68dea0c949707e", "filename": "src/tools/clippy/clippy_lints/src/strings.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fstrings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fstrings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fstrings.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -260,7 +260,7 @@ impl<'tcx> LateLintPass<'tcx> for StringLitAsBytes {\n             if method_names[0] == sym!(as_bytes);\n \n             // Check for slicer\n-            if let ExprKind::Struct(QPath::LangItem(LangItem::Range, _), _, _) = right.kind;\n+            if let ExprKind::Struct(QPath::LangItem(LangItem::Range, ..), _, _) = right.kind;\n \n             then {\n                 let mut applicability = Applicability::MachineApplicable;"}, {"sha": "4da32c52e750a06e47e1c68a840a83df0c429b8d", "filename": "src/tools/clippy/clippy_lints/src/try_err.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftry_err.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftry_err.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftry_err.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -65,7 +65,7 @@ impl<'tcx> LateLintPass<'tcx> for TryErr {\n             if let ExprKind::Match(match_arg, _, MatchSource::TryDesugar) = expr.kind;\n             if let ExprKind::Call(match_fun, try_args) = match_arg.kind;\n             if let ExprKind::Path(ref match_fun_path) = match_fun.kind;\n-            if matches!(match_fun_path, QPath::LangItem(LangItem::TryTraitBranch, _));\n+            if matches!(match_fun_path, QPath::LangItem(LangItem::TryTraitBranch, ..));\n             if let Some(try_arg) = try_args.get(0);\n             if let ExprKind::Call(err_fun, err_args) = try_arg.kind;\n             if let Some(err_arg) = err_args.get(0);"}, {"sha": "111413e51930bd06dacd48a0e8c99917f617d443", "filename": "src/tools/clippy/clippy_lints/src/unused_io_amount.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funused_io_amount.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funused_io_amount.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funused_io_amount.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -49,7 +49,7 @@ impl<'tcx> LateLintPass<'tcx> for UnusedIoAmount {\n                 if let hir::ExprKind::Call(func, [ref arg_0, ..]) = res.kind {\n                     if matches!(\n                         func.kind,\n-                        hir::ExprKind::Path(hir::QPath::LangItem(hir::LangItem::TryTraitBranch, _))\n+                        hir::ExprKind::Path(hir::QPath::LangItem(hir::LangItem::TryTraitBranch, ..))\n                     ) {\n                         check_map_error(cx, arg_0, expr);\n                     }"}, {"sha": "f186e1f05a0b45d3324f75717f5daf3a00d606c2", "filename": "src/tools/clippy/clippy_lints/src/utils/author.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fauthor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fauthor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fauthor.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -260,7 +260,7 @@ impl<'a, 'tcx> PrintVisitor<'a, 'tcx> {\n     }\n \n     fn qpath(&self, qpath: &Binding<&QPath<'_>>) {\n-        if let QPath::LangItem(lang_item, _) = *qpath.value {\n+        if let QPath::LangItem(lang_item, ..) = *qpath.value {\n             out!(\"if matches!({qpath}, QPath::LangItem(LangItem::{lang_item:?}, _));\");\n         } else {\n             out!(\"if match_qpath({qpath}, &[{}]);\", path_to_string(qpath.value));"}, {"sha": "fc32e49420e4b82debc05b94c593f3814a52c7f7", "filename": "src/tools/clippy/clippy_utils/src/higher.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhigher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhigher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhigher.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -218,7 +218,7 @@ impl<'a> Range<'a> {\n             hir::ExprKind::Call(path, args)\n                 if matches!(\n                     path.kind,\n-                    hir::ExprKind::Path(hir::QPath::LangItem(hir::LangItem::RangeInclusiveNew, _))\n+                    hir::ExprKind::Path(hir::QPath::LangItem(hir::LangItem::RangeInclusiveNew, ..))\n                 ) =>\n             {\n                 Some(Range {\n@@ -228,27 +228,27 @@ impl<'a> Range<'a> {\n                 })\n             },\n             hir::ExprKind::Struct(path, fields, None) => match &path {\n-                hir::QPath::LangItem(hir::LangItem::RangeFull, _) => Some(Range {\n+                hir::QPath::LangItem(hir::LangItem::RangeFull, ..) => Some(Range {\n                     start: None,\n                     end: None,\n                     limits: ast::RangeLimits::HalfOpen,\n                 }),\n-                hir::QPath::LangItem(hir::LangItem::RangeFrom, _) => Some(Range {\n+                hir::QPath::LangItem(hir::LangItem::RangeFrom, ..) => Some(Range {\n                     start: Some(get_field(\"start\", fields)?),\n                     end: None,\n                     limits: ast::RangeLimits::HalfOpen,\n                 }),\n-                hir::QPath::LangItem(hir::LangItem::Range, _) => Some(Range {\n+                hir::QPath::LangItem(hir::LangItem::Range, ..) => Some(Range {\n                     start: Some(get_field(\"start\", fields)?),\n                     end: Some(get_field(\"end\", fields)?),\n                     limits: ast::RangeLimits::HalfOpen,\n                 }),\n-                hir::QPath::LangItem(hir::LangItem::RangeToInclusive, _) => Some(Range {\n+                hir::QPath::LangItem(hir::LangItem::RangeToInclusive, ..) => Some(Range {\n                     start: None,\n                     end: Some(get_field(\"end\", fields)?),\n                     limits: ast::RangeLimits::Closed,\n                 }),\n-                hir::QPath::LangItem(hir::LangItem::RangeTo, _) => Some(Range {\n+                hir::QPath::LangItem(hir::LangItem::RangeTo, ..) => Some(Range {\n                     start: None,\n                     end: Some(get_field(\"end\", fields)?),\n                     limits: ast::RangeLimits::HalfOpen,"}, {"sha": "5b059e37886996fe085a7b90a9a61e2ffea2e237", "filename": "src/tools/clippy/clippy_utils/src/hir_utils.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhir_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhir_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fhir_utils.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -346,7 +346,7 @@ impl HirEqInterExpr<'_, '_, '_> {\n             (&QPath::TypeRelative(lty, lseg), &QPath::TypeRelative(rty, rseg)) => {\n                 self.eq_ty(lty, rty) && self.eq_path_segment(lseg, rseg)\n             },\n-            (&QPath::LangItem(llang_item, _), &QPath::LangItem(rlang_item, _)) => llang_item == rlang_item,\n+            (&QPath::LangItem(llang_item, ..), &QPath::LangItem(rlang_item, ..)) => llang_item == rlang_item,\n             _ => false,\n         }\n     }"}, {"sha": "a9f2ad36d0aba06294010d71216093977cba5319", "filename": "src/tools/clippy/tests/ui/future_not_send.stderr", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Ftests%2Fui%2Ffuture_not_send.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Ftests%2Fui%2Ffuture_not_send.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Ffuture_not_send.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -6,22 +6,22 @@ LL | async fn private_future(rc: Rc<[u8]>, cell: &Cell<usize>) -> bool {\n    |\n    = note: `-D clippy::future-not-send` implied by `-D warnings`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/future_not_send.rs:8:5\n+  --> $DIR/future_not_send.rs:8:19\n    |\n LL | async fn private_future(rc: Rc<[u8]>, cell: &Cell<usize>) -> bool {\n    |                         -- has type `std::rc::Rc<[u8]>` which is not `Send`\n LL |     async { true }.await\n-   |     ^^^^^^^^^^^^^^^^^^^^ await occurs here, with `rc` maybe used later\n+   |                   ^^^^^^ await occurs here, with `rc` maybe used later\n LL | }\n    | - `rc` is later dropped here\n    = note: `std::rc::Rc<[u8]>` doesn't implement `std::marker::Send`\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/future_not_send.rs:8:5\n+  --> $DIR/future_not_send.rs:8:19\n    |\n LL | async fn private_future(rc: Rc<[u8]>, cell: &Cell<usize>) -> bool {\n    |                                       ---- has type `&std::cell::Cell<usize>` which is not `Send`\n LL |     async { true }.await\n-   |     ^^^^^^^^^^^^^^^^^^^^ await occurs here, with `cell` maybe used later\n+   |                   ^^^^^^ await occurs here, with `cell` maybe used later\n LL | }\n    | - `cell` is later dropped here\n    = note: `std::cell::Cell<usize>` doesn't implement `std::marker::Sync`\n@@ -33,12 +33,12 @@ LL | pub async fn public_future(rc: Rc<[u8]>) {\n    |                                          ^ future returned by `public_future` is not `Send`\n    |\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/future_not_send.rs:12:5\n+  --> $DIR/future_not_send.rs:12:19\n    |\n LL | pub async fn public_future(rc: Rc<[u8]>) {\n    |                            -- has type `std::rc::Rc<[u8]>` which is not `Send`\n LL |     async { true }.await;\n-   |     ^^^^^^^^^^^^^^^^^^^^ await occurs here, with `rc` maybe used later\n+   |                   ^^^^^^ await occurs here, with `rc` maybe used later\n LL | }\n    | - `rc` is later dropped here\n    = note: `std::rc::Rc<[u8]>` doesn't implement `std::marker::Send`\n@@ -82,12 +82,12 @@ LL |     async fn private_future(&self) -> usize {\n    |                                       ^^^^^ future returned by `private_future` is not `Send`\n    |\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/future_not_send.rs:35:9\n+  --> $DIR/future_not_send.rs:35:23\n    |\n LL |     async fn private_future(&self) -> usize {\n    |                             ----- has type `&Dummy` which is not `Send`\n LL |         async { true }.await;\n-   |         ^^^^^^^^^^^^^^^^^^^^ await occurs here, with `&self` maybe used later\n+   |                       ^^^^^^ await occurs here, with `&self` maybe used later\n LL |         self.rc.len()\n LL |     }\n    |     - `&self` is later dropped here\n@@ -100,12 +100,12 @@ LL |     pub async fn public_future(&self) {\n    |                                       ^ future returned by `public_future` is not `Send`\n    |\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/future_not_send.rs:40:9\n+  --> $DIR/future_not_send.rs:40:30\n    |\n LL |     pub async fn public_future(&self) {\n    |                                ----- has type `&Dummy` which is not `Send`\n LL |         self.private_future().await;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^ await occurs here, with `&self` maybe used later\n+   |                              ^^^^^^ await occurs here, with `&self` maybe used later\n LL |     }\n    |     - `&self` is later dropped here\n    = note: `std::rc::Rc<[u8]>` doesn't implement `std::marker::Sync`\n@@ -117,12 +117,12 @@ LL | async fn generic_future<T>(t: T) -> T\n    |                                     ^ future returned by `generic_future` is not `Send`\n    |\n note: future is not `Send` as this value is used across an await\n-  --> $DIR/future_not_send.rs:54:5\n+  --> $DIR/future_not_send.rs:54:19\n    |\n LL |     let rt = &t;\n    |         -- has type `&T` which is not `Send`\n LL |     async { true }.await;\n-   |     ^^^^^^^^^^^^^^^^^^^^ await occurs here, with `rt` maybe used later\n+   |                   ^^^^^^ await occurs here, with `rt` maybe used later\n LL |     t\n LL | }\n    | - `rt` is later dropped here"}, {"sha": "32d5d04fde4d52001484eef8e615a157eaad177e", "filename": "src/tools/clippy/tests/ui/needless_late_init_fixable.fixed", "status": "removed", "additions": 0, "deletions": 38, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/2f4da6243f817b26c5c8156408911a01b39f9759/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2f4da6243f817b26c5c8156408911a01b39f9759/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.fixed?ref=2f4da6243f817b26c5c8156408911a01b39f9759", "patch": "@@ -1,38 +0,0 @@\n-// run-rustfix\n-\n-#![allow(unused, clippy::assign_op_pattern)]\n-\n-fn main() {\n-    \n-    let a = \"zero\";\n-\n-    \n-    \n-    let b = 1;\n-    let c = 2;\n-\n-    \n-    let d: usize = 1;\n-\n-    \n-    let mut e = 1;\n-    e = 2;\n-\n-    \n-    let f = match 1 {\n-        1 => \"three\",\n-        _ => return,\n-    }; // has semi\n-\n-    \n-    let g: usize = if true {\n-        5\n-    } else {\n-        panic!();\n-    };\n-\n-    \n-    let h = format!(\"{}\", e);\n-\n-    println!(\"{}\", a);\n-}"}, {"sha": "76099df0e0689cfa8e51b25fe3564315d171b2cf", "filename": "src/tools/clippy/tests/ui/needless_late_init_fixable.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.rs?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,5 +1,3 @@\n-// run-rustfix\n-\n #![allow(unused, clippy::assign_op_pattern)]\n \n fn main() {"}, {"sha": "728e19252ea707b4428fed20f466f12646e0d6d8", "filename": "src/tools/clippy/tests/ui/needless_late_init_fixable.stderr", "status": "modified", "additions": 14, "deletions": 12, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/272188eecd59e122d2ad435256c0f65a0f63ccbf/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fneedless_late_init_fixable.stderr?ref=272188eecd59e122d2ad435256c0f65a0f63ccbf", "patch": "@@ -1,5 +1,5 @@\n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:6:5\n+  --> $DIR/needless_late_init_fixable.rs:4:5\n    |\n LL |     let a;\n    |     ^^^^^^\n@@ -11,7 +11,7 @@ LL |     let a = \"zero\";\n    |     ~~~~~\n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:9:5\n+  --> $DIR/needless_late_init_fixable.rs:7:5\n    |\n LL |     let b;\n    |     ^^^^^^\n@@ -22,7 +22,7 @@ LL |     let b = 1;\n    |     ~~~~~\n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:10:5\n+  --> $DIR/needless_late_init_fixable.rs:8:5\n    |\n LL |     let c;\n    |     ^^^^^^\n@@ -33,7 +33,7 @@ LL |     let c = 2;\n    |     ~~~~~\n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:14:5\n+  --> $DIR/needless_late_init_fixable.rs:12:5\n    |\n LL |     let d: usize;\n    |     ^^^^^^^^^^^^^\n@@ -44,7 +44,7 @@ LL |     let d: usize = 1;\n    |     ~~~~~~~~~~~~\n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:17:5\n+  --> $DIR/needless_late_init_fixable.rs:15:5\n    |\n LL |     let mut e;\n    |     ^^^^^^^^^^\n@@ -55,7 +55,7 @@ LL |     let mut e = 1;\n    |     ~~~~~~~~~\n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:21:5\n+  --> $DIR/needless_late_init_fixable.rs:19:5\n    |\n LL |     let f;\n    |     ^^^^^^\n@@ -66,11 +66,12 @@ LL |     let f = match 1 {\n    |     +++++++\n help: remove the assignments from the `match` arms\n    |\n-LL |         1 => \"three\",\n-   |              ~~~~~~~\n+LL -         1 => f = \"three\",\n+LL +         1 => \"three\",\n+   | \n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:27:5\n+  --> $DIR/needless_late_init_fixable.rs:25:5\n    |\n LL |     let g: usize;\n    |     ^^^^^^^^^^^^^\n@@ -81,15 +82,16 @@ LL |     let g: usize = if true {\n    |     ++++++++++++++\n help: remove the assignments from the branches\n    |\n-LL |         5\n-   |\n+LL -         g = 5;\n+LL +         5\n+   | \n help: add a semicolon after the `if` expression\n    |\n LL |     };\n    |      +\n \n error: unneeded late initalization\n-  --> $DIR/needless_late_init_fixable.rs:34:5\n+  --> $DIR/needless_late_init_fixable.rs:32:5\n    |\n LL |     let h;\n    |     ^^^^^^"}]}