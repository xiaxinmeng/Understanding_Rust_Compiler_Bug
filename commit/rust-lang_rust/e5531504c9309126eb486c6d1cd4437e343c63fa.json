{"sha": "e5531504c9309126eb486c6d1cd4437e343c63fa", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1NTMxNTA0YzkzMDkxMjZlYjQ4NmM2ZDFjZDQ0MzdlMzQzYzYzZmE=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-08-09T00:29:21Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-08-09T00:30:21Z"}, "message": "rt: Align when comparing the insides of boxes", "tree": {"sha": "d2c383143ad3a0c86e9af5c36a238ba9ccc56fa3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2c383143ad3a0c86e9af5c36a238ba9ccc56fa3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e5531504c9309126eb486c6d1cd4437e343c63fa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e5531504c9309126eb486c6d1cd4437e343c63fa", "html_url": "https://github.com/rust-lang/rust/commit/e5531504c9309126eb486c6d1cd4437e343c63fa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e5531504c9309126eb486c6d1cd4437e343c63fa/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0459e38bde043cff95f026df6ca5482a93f287cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/0459e38bde043cff95f026df6ca5482a93f287cc", "html_url": "https://github.com/rust-lang/rust/commit/0459e38bde043cff95f026df6ca5482a93f287cc"}], "stats": {"total": 23, "additions": 10, "deletions": 13}, "files": [{"sha": "dfc4d20f49677ba059ea4c73823f394092dd04bd", "filename": "src/rt/rust_shape.cpp", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/e5531504c9309126eb486c6d1cd4437e343c63fa/src%2Frt%2Frust_shape.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e5531504c9309126eb486c6d1cd4437e343c63fa/src%2Frt%2Frust_shape.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_shape.cpp?ref=e5531504c9309126eb486c6d1cd4437e343c63fa", "patch": "@@ -910,7 +910,9 @@ class copy : public data<copy,uint8_t *> {\n class cmp : public data<cmp,ptr_pair> {\n private:\n     template<typename T>\n-    int cmp_number(ptr_pair &ptrs);\n+    void cmp_number(const data_pair<T> &nums) {\n+        result = (nums.fst < nums.snd) ? -1 : (nums.fst == nums.snd) ? 0 : 1;\n+    }\n \n public:\n     int result;\n@@ -933,20 +935,20 @@ class cmp : public data<cmp,ptr_pair> {\n     void walk_box(bool align);\n     void walk_struct(bool align, const uint8_t *end_sp);\n     void walk_tag(bool align, tag_info &tinfo,\n-                  data_pair<uint32_t> &tag_variants);\n+                  const data_pair<uint32_t> &tag_variants);\n     void walk_res(bool align, const rust_fn *dtor, uint16_t n_ty_params,\n                   const uint8_t *ty_params_sp);\n \n     template<typename T>\n-    void walk_number() { result = cmp_number<T>(dp); }\n+    void walk_number() { cmp_number(bump_dp<T>(dp)); }\n };\n \n void\n cmp::walk_box(bool align) {\n     data_pair<uint8_t *> subdp = bump_dp<uint8_t *>(dp);\n     cmp subcx(*this, ptr_pair::make(subdp));\n     subcx.dp += sizeof(uint32_t);   // Skip over the reference count.\n-    subcx.walk(false);\n+    subcx.walk(true);\n     result = subcx.result;\n }\n \n@@ -960,7 +962,10 @@ cmp::walk_struct(bool align, const uint8_t *end_sp) {\n \n void\n cmp::walk_tag(bool align, tag_info &tinfo,\n-              data_pair<uint32_t> &tag_variants) {\n+              const data_pair<uint32_t> &tag_variants) {\n+    cmp_number(tag_variants);\n+    if (result != 0)\n+        return;\n     abort();    // TODO\n }\n \n@@ -970,14 +975,6 @@ cmp::walk_res(bool align, const rust_fn *dtor, uint16_t n_ty_params,\n     abort();    // TODO\n }\n \n-template<typename T>\n-int\n-cmp::cmp_number(ptr_pair &ptrs) {\n-    T a = *(reinterpret_cast<T *>(dp.fst));\n-    T b = *(reinterpret_cast<T *>(dp.snd));\n-    return (a < b) ? -1 : (a == b) ? 0 : 1;\n-}\n-\n } // end namespace shape\n \n extern \"C\" void"}]}