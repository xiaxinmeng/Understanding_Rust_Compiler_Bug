{"sha": "1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1NzhiMWVkYzBhMWFjOWRmYTI4OWQzNjlkODhiY2QwYTdkYjIyZTM=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-03-16T19:11:48Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-03-19T03:50:30Z"}, "message": "Update submodules in parallel", "tree": {"sha": "a80bcf96782d04db659b01c53b4627afa313eb18", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a80bcf96782d04db659b01c53b4627afa313eb18"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "html_url": "https://github.com/rust-lang/rust/commit/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c2f4744d2db4e162df824d0bd0b093ba4b351545", "url": "https://api.github.com/repos/rust-lang/rust/commits/c2f4744d2db4e162df824d0bd0b093ba4b351545", "html_url": "https://github.com/rust-lang/rust/commit/c2f4744d2db4e162df824d0bd0b093ba4b351545"}], "stats": {"total": 72, "additions": 29, "deletions": 43}, "files": [{"sha": "f2664e6d196c7afcab810ab0ee15f5e30b14eb64", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 29, "deletions": 43, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "patch": "@@ -17,6 +17,7 @@ ci_dir=$(cd $(dirname $0) && pwd)\n . \"$ci_dir/shared.sh\"\n \n travis_fold start init_repo\n+travis_time_start\n \n REPO_DIR=\"$1\"\n CACHE_DIR=\"$2\"\n@@ -42,54 +43,39 @@ if grep -q RUST_RELEASE_CHANNEL=beta src/ci/run.sh; then\n   git fetch origin --unshallow beta master\n fi\n \n-travis_fold start update_cache\n-travis_time_start\n-\n-# Update the cache (a pristine copy of the rust source master)\n-retry sh -c \"rm -rf $cache_src_dir && mkdir -p $cache_src_dir && \\\n-    git clone --depth 1 https://github.com/rust-lang/rust.git $cache_src_dir\"\n-if [ -d $cache_src_dir/src/llvm ]; then\n-  (cd $cache_src_dir && git rm src/llvm)\n-fi\n-if [ -d $cache_src_dir/src/llvm-emscripten ]; then\n-  (cd $cache_src_dir && git rm src/llvm-emscripten)\n-fi\n-retry sh -c \"cd $cache_src_dir && \\\n-    git submodule deinit -f . && git submodule sync && git submodule update --init\"\n-\n-travis_fold end update_cache\n-travis_time_finish\n+function fetch_submodule {\n+    local module=$1\n+    local cached=\"download-${module//\\//-}.tar.gz\"\n+    retry sh -c \"rm -f $cached && \\\n+        curl -sSL -o $cached $2\"\n+    mkdir $module\n+    touch \"$module/.git\"\n+    tar -C $module --strip-components=1 -xf $cached\n+    rm $cached\n+}\n \n-travis_fold start update_submodules\n-travis_time_start\n-\n-# Update the submodules of the repo we're in, using the pristine repo as\n-# a cache for any object files\n-# No, `git submodule foreach` won't work:\n-# http://stackoverflow.com/questions/12641469/list-submodules-in-a-git-repository\n+included=\"src/llvm src/llvm-emscripten src/doc/book src/doc/rust-by-example\"\n modules=\"$(git config --file .gitmodules --get-regexp '\\.path$' | cut -d' ' -f2)\"\n-for module in $modules; do\n-    if [ \"$module\" = src/llvm ] || [ \"$module\" = src/llvm-emscripten ]; then\n+modules=($modules)\n+use_git=\"\"\n+urls=\"$(git config --file .gitmodules --get-regexp '\\.url$' | cut -d' ' -f2)\"\n+urls=($urls)\n+for i in ${!modules[@]}; do\n+    module=${modules[$i]}\n+    if [[ \" $included \" = *\" $module \"* ]]; then\n         commit=\"$(git ls-tree HEAD $module | awk '{print $3}')\"\n         git rm $module\n-        retry sh -c \"rm -f $commit.tar.gz && \\\n-            curl -sSL -O https://github.com/rust-lang/llvm/archive/$commit.tar.gz\"\n-        tar -C src/ -xf \"$commit.tar.gz\"\n-        rm \"$commit.tar.gz\"\n-        mv \"src/llvm-$commit\" $module\n-        continue\n-    fi\n-    if [ ! -e \"$cache_src_dir/$module/.git\" ]; then\n-        echo \"WARNING: $module not found in pristine repo\"\n-        retry sh -c \"git submodule deinit -f $module && \\\n-            git submodule update --init --recursive $module\"\n+        url=${urls[$i]}\n+        url=${url/\\.git/}\n+        fetch_submodule $module \"$url/archive/$commit.tar.gz\" &\n         continue\n+    else\n+        use_git=\"$use_git $module\"\n     fi\n-    retry sh -c \"git submodule deinit -f $module && \\\n-        git submodule update --init --recursive --reference $cache_src_dir/$module $module\"\n done\n-\n-travis_fold end update_submodules\n-travis_time_finish\n-\n+retry sh -c \"git submodule deinit -f $use_git && \\\n+    git submodule sync && \\\n+    git submodule update -j 16 --init --recursive $use_git\"\n+wait\n travis_fold end init_repo\n+travis_time_finish"}]}