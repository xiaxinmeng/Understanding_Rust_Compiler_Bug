{"sha": "07342828c5066d6a7763535b9281b5cf021dea5c", "node_id": "C_kwDOAAsO6NoAKDA3MzQyODI4YzUwNjZkNmE3NzYzNTM1YjkyODFiNWNmMDIxZGVhNWM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-11-17T14:57:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-17T14:57:56Z"}, "message": "Rollup merge of #89610 - guswynn:must_use_future, r=wesleywiser\n\nwarn on must_use use on async fn's\n\nAs referenced in #78149\n\nThis only works on `async` fn's for now, I can also look into if I can get `Box<dyn Future>` and `impl Future` working at this level (hir)", "tree": {"sha": "a11856d7964aae5f957dc27eaf11d6f7b7b66db8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a11856d7964aae5f957dc27eaf11d6f7b7b66db8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07342828c5066d6a7763535b9281b5cf021dea5c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhlRh1CRBK7hj4Ov3rIwAAZ6oIAHGh4xVVN5lm1T2lb+NRbTWS\nTL8l40TG8ESvXIwjkTUYdc2CTk4IjdlQp8ZE49dEh11+RJF2GnGgCy8E6Z1NPaqU\nNmoLKF0ziH2dNUUAFsc6uET3+Pa/oAIxw/HrBWce3uqyz+o3jyeqRkULTrtbfBV9\nJlHEHHvjTj6ANBXjS4ObAt0YK6TydLF2lpAq554vZ24vp2F5VOmcExNq8Co5heWJ\nVarO3w6rlQw6wCSDyTN/5aAHk5eY74ntbDYcZMyrQfYNsz/j/M4R7Zd9u+/64/Wc\nv22yK7+W1QwFeAj9qLI/FQYuAa9oQCBcH8JqSFsQxOEN31K7Unr2zUotfPFkJlI=\n=Fq7z\n-----END PGP SIGNATURE-----\n", "payload": "tree a11856d7964aae5f957dc27eaf11d6f7b7b66db8\nparent 41301c3b2371365b753c2ad6a74528a38f3815ce\nparent 83ce771c0f3af07803423918a63ac4f958ca6ea9\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1637161076 +0100\ncommitter GitHub <noreply@github.com> 1637161076 +0100\n\nRollup merge of #89610 - guswynn:must_use_future, r=wesleywiser\n\nwarn on must_use use on async fn's\n\nAs referenced in #78149\n\nThis only works on `async` fn's for now, I can also look into if I can get `Box<dyn Future>` and `impl Future` working at this level (hir)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07342828c5066d6a7763535b9281b5cf021dea5c", "html_url": "https://github.com/rust-lang/rust/commit/07342828c5066d6a7763535b9281b5cf021dea5c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07342828c5066d6a7763535b9281b5cf021dea5c/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41301c3b2371365b753c2ad6a74528a38f3815ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/41301c3b2371365b753c2ad6a74528a38f3815ce", "html_url": "https://github.com/rust-lang/rust/commit/41301c3b2371365b753c2ad6a74528a38f3815ce"}, {"sha": "83ce771c0f3af07803423918a63ac4f958ca6ea9", "url": "https://api.github.com/repos/rust-lang/rust/commits/83ce771c0f3af07803423918a63ac4f958ca6ea9", "html_url": "https://github.com/rust-lang/rust/commit/83ce771c0f3af07803423918a63ac4f958ca6ea9"}], "stats": {"total": 101, "additions": 101, "deletions": 0}, "files": [{"sha": "6ff2259dc5b0a9f34896513c0bc8bcc4e45de3f2", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/07342828c5066d6a7763535b9281b5cf021dea5c/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07342828c5066d6a7763535b9281b5cf021dea5c/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=07342828c5066d6a7763535b9281b5cf021dea5c", "patch": "@@ -112,6 +112,7 @@ impl CheckAttrVisitor<'tcx> {\n                     self.check_default_method_body_is_const(attr, span, target)\n                 }\n                 sym::must_not_suspend => self.check_must_not_suspend(&attr, span, target),\n+                sym::must_use => self.check_must_use(hir_id, &attr, span, target),\n                 sym::rustc_const_unstable\n                 | sym::rustc_const_stable\n                 | sym::unstable\n@@ -1046,6 +1047,37 @@ impl CheckAttrVisitor<'tcx> {\n         is_valid\n     }\n \n+    /// Warns against some misuses of `#[must_use]`\n+    fn check_must_use(\n+        &self,\n+        hir_id: HirId,\n+        attr: &Attribute,\n+        span: &Span,\n+        _target: Target,\n+    ) -> bool {\n+        let node = self.tcx.hir().get(hir_id);\n+        if let Some(fn_node) = node.fn_kind() {\n+            if let rustc_hir::IsAsync::Async = fn_node.asyncness() {\n+                self.tcx.struct_span_lint_hir(UNUSED_ATTRIBUTES, hir_id, attr.span, |lint| {\n+                    lint.build(\n+                        \"`must_use` attribute on `async` functions \\\n+                              applies to the anonymous `Future` returned by the \\\n+                              function, not the value within\",\n+                    )\n+                    .span_label(\n+                        *span,\n+                        \"this attribute does nothing, the `Future`s \\\n+                                returned by async functions are already `must_use`\",\n+                    )\n+                    .emit();\n+                });\n+            }\n+        }\n+\n+        // For now, its always valid\n+        true\n+    }\n+\n     /// Checks if `#[must_not_suspend]` is applied to a function. Returns `true` if valid.\n     fn check_must_not_suspend(&self, attr: &Attribute, span: &Span, target: Target) -> bool {\n         match target {"}, {"sha": "7d17af11573796bbf61e7c8cd5e61dbc05fbd0c3", "filename": "src/test/ui/lint/unused/unused-async.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/07342828c5066d6a7763535b9281b5cf021dea5c/src%2Ftest%2Fui%2Flint%2Funused%2Funused-async.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07342828c5066d6a7763535b9281b5cf021dea5c/src%2Ftest%2Fui%2Flint%2Funused%2Funused-async.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-async.rs?ref=07342828c5066d6a7763535b9281b5cf021dea5c", "patch": "@@ -0,0 +1,43 @@\n+// edition:2018\n+// run-pass\n+#![allow(dead_code)]\n+\n+#[must_use]\n+//~^ WARNING `must_use`\n+async fn test() -> i32 {\n+    1\n+}\n+\n+\n+struct Wowee {}\n+\n+impl Wowee {\n+    #[must_use]\n+    //~^ WARNING `must_use`\n+    async fn test_method() -> i32 {\n+        1\n+    }\n+}\n+\n+/* FIXME(guswynn) update this test when async-fn-in-traits works\n+trait Doer {\n+    #[must_use]\n+    async fn test_trait_method() -> i32;\n+    WARNING must_use\n+    async fn test_other_trait() -> i32;\n+}\n+\n+impl Doer for Wowee {\n+    async fn test_trait_method() -> i32 {\n+        1\n+    }\n+    #[must_use]\n+    async fn test_other_trait() -> i32 {\n+        WARNING must_use\n+        1\n+    }\n+}\n+*/\n+\n+fn main() {\n+}"}, {"sha": "6bbc9e2bf00885e0e29534184371d8d7dc4fd74c", "filename": "src/test/ui/lint/unused/unused-async.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/07342828c5066d6a7763535b9281b5cf021dea5c/src%2Ftest%2Fui%2Flint%2Funused%2Funused-async.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/07342828c5066d6a7763535b9281b5cf021dea5c/src%2Ftest%2Fui%2Flint%2Funused%2Funused-async.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-async.stderr?ref=07342828c5066d6a7763535b9281b5cf021dea5c", "patch": "@@ -0,0 +1,26 @@\n+warning: `must_use` attribute on `async` functions applies to the anonymous `Future` returned by the function, not the value within\n+  --> $DIR/unused-async.rs:5:1\n+   |\n+LL |   #[must_use]\n+   |   ^^^^^^^^^^^\n+LL |\n+LL | / async fn test() -> i32 {\n+LL | |     1\n+LL | | }\n+   | |_- this attribute does nothing, the `Future`s returned by async functions are already `must_use`\n+   |\n+   = note: `#[warn(unused_attributes)]` on by default\n+\n+warning: `must_use` attribute on `async` functions applies to the anonymous `Future` returned by the function, not the value within\n+  --> $DIR/unused-async.rs:15:5\n+   |\n+LL |       #[must_use]\n+   |       ^^^^^^^^^^^\n+LL |\n+LL | /     async fn test_method() -> i32 {\n+LL | |         1\n+LL | |     }\n+   | |_____- this attribute does nothing, the `Future`s returned by async functions are already `must_use`\n+\n+warning: 2 warnings emitted\n+"}]}