{"sha": "58a17026c996f8f759b775a0582d50f9130ab0f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4YTE3MDI2Yzk5NmY4Zjc1OWI3NzVhMDU4MmQ1MGY5MTMwYWIwZjY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2017-08-02T06:40:03Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2017-08-04T01:13:23Z"}, "message": "Let -Zmir-emit-validate also control whether miri even acts on the validation commands", "tree": {"sha": "44b5c208ab90cd3d5195d9b7f0fce26abc46ce7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/44b5c208ab90cd3d5195d9b7f0fce26abc46ce7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/58a17026c996f8f759b775a0582d50f9130ab0f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/58a17026c996f8f759b775a0582d50f9130ab0f6", "html_url": "https://github.com/rust-lang/rust/commit/58a17026c996f8f759b775a0582d50f9130ab0f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/58a17026c996f8f759b775a0582d50f9130ab0f6/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "766a69f6565b4f5033d8a92e88f1814371486a5f", "url": "https://api.github.com/repos/rust-lang/rust/commits/766a69f6565b4f5033d8a92e88f1814371486a5f", "html_url": "https://github.com/rust-lang/rust/commit/766a69f6565b4f5033d8a92e88f1814371486a5f"}], "stats": {"total": 21, "additions": 19, "deletions": 2}, "files": [{"sha": "5b7c932efc26de56c00f4137428042b71b748e30", "filename": "src/librustc_mir/interpret/validation.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/58a17026c996f8f759b775a0582d50f9130ab0f6/src%2Flibrustc_mir%2Finterpret%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58a17026c996f8f759b775a0582d50f9130ab0f6/src%2Flibrustc_mir%2Finterpret%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fvalidation.rs?ref=58a17026c996f8f759b775a0582d50f9130ab0f6", "patch": "@@ -39,6 +39,14 @@ impl ValidationMode {\n // Validity checks\n impl<'a, 'tcx, M: Machine<'tcx>> EvalContext<'a, 'tcx, M> {\n     pub(crate) fn validation_op(&mut self, op: ValidationOp, operand: &ValidationOperand<'tcx, mir::Lvalue<'tcx>>) -> EvalResult<'tcx> {\n+        // If mir-emit-validate is set to 0 (i.e., disabled), we may still see validation commands\n+        // because other crates may have been compiled with mir-emit-validate > 0.  Ignore those\n+        // commands.  This makes mir-emit-validate also a flag to control whether miri will do\n+        // validation or not.\n+        if self.tcx.sess.opts.debugging_opts.mir_emit_validate == 0 {\n+            return Ok(());\n+        }\n+\n         // HACK: Determine if this method is whitelisted and hence we do not perform any validation.\n         // We currently insta-UB on anything passing around uninitialized memory, so we have to whitelist\n         // the places that are allowed to do that.\n@@ -50,14 +58,14 @@ impl<'a, 'tcx, M: Machine<'tcx>> EvalContext<'a, 'tcx, M> {\n                 static ref RE: Regex = Regex::new(\"^(\\\n                     std::mem::uninitialized::|\\\n                     std::mem::forget::|\\\n-                    <std::heap::Heap as std::heap::Alloc>::|\\\n+                    <(std|alloc)::heap::Heap as (std::heap|alloc::allocator)::Alloc>::|\\\n                     <std::mem::ManuallyDrop<T>><.*>::new$|\\\n                     <std::mem::ManuallyDrop<T> as std::ops::DerefMut><.*>::deref_mut$|\\\n                     std::ptr::read::|\\\n                     \\\n                     <std::sync::Arc<T>><.*>::inner$|\\\n                     <std::sync::Arc<T>><.*>::drop_slow$|\\\n-                    std::heap::Layout::for_value::|\\\n+                    (std::heap|alloc::allocator)::Layout::for_value::|\\\n                     std::mem::(size|align)_of_val::\\\n                 )\").unwrap();\n             }"}, {"sha": "dbe80fecd00f1157ff82654647e6557ca9da220d", "filename": "tests/compile-fail/panic.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/58a17026c996f8f759b775a0582d50f9130ab0f6/tests%2Fcompile-fail%2Fpanic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58a17026c996f8f759b775a0582d50f9130ab0f6/tests%2Fcompile-fail%2Fpanic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fpanic.rs?ref=58a17026c996f8f759b775a0582d50f9130ab0f6", "patch": "@@ -1,3 +1,6 @@\n+// FIXME: Due to https://github.com/rust-lang/rust/issues/43457 we have to disable validation\n+// compile-flags: -Zmir-emit-validate=0\n+\n //error-pattern: the evaluated program panicked\n \n fn main() {"}, {"sha": "0c46acb8ade40501bbcec8483f222f4a082773e2", "filename": "tests/compile-fail/zst2.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/58a17026c996f8f759b775a0582d50f9130ab0f6/tests%2Fcompile-fail%2Fzst2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58a17026c996f8f759b775a0582d50f9130ab0f6/tests%2Fcompile-fail%2Fzst2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fzst2.rs?ref=58a17026c996f8f759b775a0582d50f9130ab0f6", "patch": "@@ -1,3 +1,6 @@\n+// FIXME: Due to https://github.com/rust-lang/rust/issues/43457 we have to disable validation\n+// compile-flags: -Zmir-emit-validate=0\n+\n // error-pattern: the evaluated program panicked\n \n #[derive(Debug)]"}, {"sha": "a6d7fdd35521d8d9604a1680256b2fff3321cce8", "filename": "tests/compile-fail/zst3.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/58a17026c996f8f759b775a0582d50f9130ab0f6/tests%2Fcompile-fail%2Fzst3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58a17026c996f8f759b775a0582d50f9130ab0f6/tests%2Fcompile-fail%2Fzst3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fzst3.rs?ref=58a17026c996f8f759b775a0582d50f9130ab0f6", "patch": "@@ -1,3 +1,6 @@\n+// FIXME: Due to https://github.com/rust-lang/rust/issues/43457 we have to disable validation\n+// compile-flags: -Zmir-emit-validate=0\n+\n // error-pattern: the evaluated program panicked\n \n #[derive(Debug)]"}]}