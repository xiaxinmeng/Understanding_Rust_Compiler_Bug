{"sha": "0db4317709cdd84c8a4cc1dc01d1f8af673bdd21", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkYjQzMTc3MDljZGQ4NGM4YTRjYzFkYzAxZDFmOGFmNjczYmRkMjE=", "commit": {"author": {"name": "QuietMisdreavus", "email": "grey@quietmisdreavus.net", "date": "2018-07-26T20:33:25Z"}, "committer": {"name": "QuietMisdreavus", "email": "grey@quietmisdreavus.net", "date": "2018-07-26T20:33:25Z"}, "message": "rustdoc: rework how default passes are chosen", "tree": {"sha": "cce8e05121c931662ee2f253c767d920570a0e03", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cce8e05121c931662ee2f253c767d920570a0e03"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21", "html_url": "https://github.com/rust-lang/rust/commit/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21/comments", "author": {"login": "QuietMisdreavus", "id": 5217170, "node_id": "MDQ6VXNlcjUyMTcxNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/5217170?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuietMisdreavus", "html_url": "https://github.com/QuietMisdreavus", "followers_url": "https://api.github.com/users/QuietMisdreavus/followers", "following_url": "https://api.github.com/users/QuietMisdreavus/following{/other_user}", "gists_url": "https://api.github.com/users/QuietMisdreavus/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuietMisdreavus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuietMisdreavus/subscriptions", "organizations_url": "https://api.github.com/users/QuietMisdreavus/orgs", "repos_url": "https://api.github.com/users/QuietMisdreavus/repos", "events_url": "https://api.github.com/users/QuietMisdreavus/events{/privacy}", "received_events_url": "https://api.github.com/users/QuietMisdreavus/received_events", "type": "User", "site_admin": false}, "committer": {"login": "QuietMisdreavus", "id": 5217170, "node_id": "MDQ6VXNlcjUyMTcxNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/5217170?v=4", "gravatar_id": "", "url": "https://api.github.com/users/QuietMisdreavus", "html_url": "https://github.com/QuietMisdreavus", "followers_url": "https://api.github.com/users/QuietMisdreavus/followers", "following_url": "https://api.github.com/users/QuietMisdreavus/following{/other_user}", "gists_url": "https://api.github.com/users/QuietMisdreavus/gists{/gist_id}", "starred_url": "https://api.github.com/users/QuietMisdreavus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/QuietMisdreavus/subscriptions", "organizations_url": "https://api.github.com/users/QuietMisdreavus/orgs", "repos_url": "https://api.github.com/users/QuietMisdreavus/repos", "events_url": "https://api.github.com/users/QuietMisdreavus/events{/privacy}", "received_events_url": "https://api.github.com/users/QuietMisdreavus/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "46804ef0cee4b55ed9922719da243b6edd9101b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/46804ef0cee4b55ed9922719da243b6edd9101b2", "html_url": "https://github.com/rust-lang/rust/commit/46804ef0cee4b55ed9922719da243b6edd9101b2"}], "stats": {"total": 76, "additions": 50, "deletions": 26}, "files": [{"sha": "00cad5e376a40f1e7d1a2f820ccd22b039211399", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 23, "deletions": 26, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=0db4317709cdd84c8a4cc1dc01d1f8af673bdd21", "patch": "@@ -373,6 +373,10 @@ pub fn main_args(args: &[String]) -> isize {\n         for &name in passes::DEFAULT_PASSES {\n             println!(\"{:>20}\", name);\n         }\n+        println!(\"\\nPasses run with `--document-private-items`:\");\n+        for &name in passes::DEFAULT_PRIVATE_PASSES {\n+            println!(\"{:>20}\", name);\n+        }\n         return 0;\n     }\n \n@@ -623,20 +627,16 @@ fn rust_input<R, F>(cratefile: PathBuf,\n where R: 'static + Send,\n       F: 'static + Send + FnOnce(Output) -> R\n {\n-    let mut default_passes = !matches.opt_present(\"no-defaults\");\n-    let mut passes = matches.opt_strs(\"passes\");\n-    let mut plugins = matches.opt_strs(\"plugins\");\n-\n-    // We hardcode in the passes here, as this is a new flag and we\n-    // are generally deprecating passes.\n-    if matches.opt_present(\"document-private-items\") {\n-        default_passes = false;\n+    let mut default_passes = if matches.opt_present(\"no-defaults\") {\n+        passes::DefaultPassOption::None\n+    } else if matches.opt_present(\"document-private-items\") {\n+        passes::DefaultPassOption::Private\n+    } else {\n+        passes::DefaultPassOption::Default\n+    };\n \n-        passes = vec![\n-            String::from(\"collapse-docs\"),\n-            String::from(\"unindent-comments\"),\n-        ];\n-    }\n+    let mut manual_passes = matches.opt_strs(\"passes\");\n+    let mut plugins = matches.opt_strs(\"plugins\");\n \n     // First, parse the crate and extract all relevant information.\n     let mut paths = SearchPaths::new();\n@@ -706,13 +706,15 @@ where R: 'static + Send,\n             if attr.is_word() {\n                 if name == Some(\"no_default_passes\") {\n                     report_deprecated_attr(\"no_default_passes\", &diag);\n-                    default_passes = false;\n+                    if default_passes == passes::DefaultPassOption::Default {\n+                        default_passes = passes::DefaultPassOption::None;\n+                    }\n                 }\n             } else if let Some(value) = attr.value_str() {\n                 let sink = match name {\n                     Some(\"passes\") => {\n                         report_deprecated_attr(\"passes = \\\"...\\\"\", &diag);\n-                        &mut passes\n+                        &mut manual_passes\n                     },\n                     Some(\"plugins\") => {\n                         report_deprecated_attr(\"plugins = \\\"...\\\"\", &diag);\n@@ -726,20 +728,15 @@ where R: 'static + Send,\n             }\n \n             if attr.is_word() && name == Some(\"document_private_items\") {\n-                default_passes = false;\n-\n-                passes = vec![\n-                    String::from(\"collapse-docs\"),\n-                    String::from(\"unindent-comments\"),\n-                ];\n+                if default_passes == passes::DefaultPassOption::Default {\n+                    default_passes = passes::DefaultPassOption::Private;\n+                }\n             }\n         }\n \n-        if default_passes {\n-            for name in passes::DEFAULT_PASSES.iter().rev() {\n-                passes.insert(0, name.to_string());\n-            }\n-        }\n+        let mut passes: Vec<String> =\n+            passes::defaults(default_passes).iter().map(|p| p.to_string()).collect();\n+        passes.extend(manual_passes);\n \n         if !plugins.is_empty() {\n             eprintln!(\"WARNING: --plugins no longer functions; see CVE-2018-1000622\");"}, {"sha": "8de4fed5bf0c0bf8d576a06b607572ae6f329937", "filename": "src/librustdoc/passes/mod.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21/src%2Flibrustdoc%2Fpasses%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0db4317709cdd84c8a4cc1dc01d1f8af673bdd21/src%2Flibrustdoc%2Fpasses%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fmod.rs?ref=0db4317709cdd84c8a4cc1dc01d1f8af673bdd21", "patch": "@@ -63,6 +63,33 @@ pub const DEFAULT_PASSES: &'static [&'static str] = &[\n     \"propagate-doc-cfg\",\n ];\n \n+pub const DEFAULT_PRIVATE_PASSES: &'static [&'static str] = &[\n+    \"strip-priv-imports\",\n+    \"collapse-docs\",\n+    \"unindent-comments\",\n+    \"propagate-doc-cfg\",\n+];\n+\n+#[derive(Copy, Clone, PartialEq, Eq, Debug)]\n+pub enum DefaultPassOption {\n+    Default,\n+    Private,\n+    None,\n+}\n+\n+pub fn defaults(default_set: DefaultPassOption) -> &'static [&'static str] {\n+    match default_set {\n+        DefaultPassOption::Default => {\n+            DEFAULT_PASSES\n+        },\n+        DefaultPassOption::Private => {\n+            DEFAULT_PRIVATE_PASSES\n+        },\n+        DefaultPassOption::None => {\n+            &[]\n+        },\n+    }\n+}\n \n struct Stripper<'a> {\n     retained: &'a mut DefIdSet,"}]}