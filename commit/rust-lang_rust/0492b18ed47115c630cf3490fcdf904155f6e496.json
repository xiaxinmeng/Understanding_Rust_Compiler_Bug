{"sha": "0492b18ed47115c630cf3490fcdf904155f6e496", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA0OTJiMThlZDQ3MTE1YzYzMGNmMzQ5MGZjZGY5MDQxNTVmNmU0OTY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-09-20T15:45:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-09-20T15:45:58Z"}, "message": "Merge #1883\n\n1883: Fix path attribute causing false \"unresolved module\" error for submodules r=matklad a=gfreezy\n\nfixed #1880\n\nCo-authored-by: gfreezy <gfreezy@gmail.com>", "tree": {"sha": "534255fd111da9af89ebe19a8f6df886783155b1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/534255fd111da9af89ebe19a8f6df886783155b1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0492b18ed47115c630cf3490fcdf904155f6e496", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdhPQ2CRBK7hj4Ov3rIwAAdHIIAGnbKLtMZcBzCAX+n+zK7ggs\nFRHGLg+/WshstSIG9WPpxMAItjtT8AXgB9jT8Yf9mn6xoSmZrkONIGX1qZbYmauV\n0wfQ53So9a8ROcxtUH5+GnBO6BYtz1gDNVy81R4Rzf1fZOfN9+4OgBRWPrVqIe8U\nxGTVGYf2pvQNMdx/zk4ctmm+VDgCiBG/F5TpTg244nE4gFdu3wh7Kg+sFCeN2KX3\n28YCPclrSFeiDXzLytCsrVS7WDWMK6TTh6UgeaL9NqACBrZU2Zt2xsDG1eWDMp3X\nyrSHkuHPN5qjnUBj5noFuCrvclxtj521nZs1Aw2vyzChRN5zjlfkJnhgUk1DEKw=\n=vQSJ\n-----END PGP SIGNATURE-----\n", "payload": "tree 534255fd111da9af89ebe19a8f6df886783155b1\nparent 24ac228c395681e600b0a7034bd332458af9ce8c\nparent 6a4cf48bffb739c3657443ae308fc0c91215d4d3\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1568994358 +0000\ncommitter GitHub <noreply@github.com> 1568994358 +0000\n\nMerge #1883\n\n1883: Fix path attribute causing false \"unresolved module\" error for submodules r=matklad a=gfreezy\n\nfixed #1880\n\nCo-authored-by: gfreezy <gfreezy@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0492b18ed47115c630cf3490fcdf904155f6e496", "html_url": "https://github.com/rust-lang/rust/commit/0492b18ed47115c630cf3490fcdf904155f6e496", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0492b18ed47115c630cf3490fcdf904155f6e496/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24ac228c395681e600b0a7034bd332458af9ce8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/24ac228c395681e600b0a7034bd332458af9ce8c", "html_url": "https://github.com/rust-lang/rust/commit/24ac228c395681e600b0a7034bd332458af9ce8c"}, {"sha": "6a4cf48bffb739c3657443ae308fc0c91215d4d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a4cf48bffb739c3657443ae308fc0c91215d4d3", "html_url": "https://github.com/rust-lang/rust/commit/6a4cf48bffb739c3657443ae308fc0c91215d4d3"}], "stats": {"total": 42, "additions": 40, "deletions": 2}, "files": [{"sha": "6b253ac409e0863bfa7c56dc913b615b572c72a9", "filename": "crates/ra_hir/src/nameres/collector.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0492b18ed47115c630cf3490fcdf904155f6e496/crates%2Fra_hir%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0492b18ed47115c630cf3490fcdf904155f6e496/crates%2Fra_hir%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Fcollector.rs?ref=0492b18ed47115c630cf3490fcdf904155f6e496", "patch": "@@ -1,5 +1,5 @@\n use ra_db::FileId;\n-use ra_syntax::ast;\n+use ra_syntax::{ast, SmolStr};\n use rustc_hash::FxHashMap;\n use test_utils::tested_by;\n \n@@ -98,6 +98,7 @@ where\n         self.def_map.modules[module_id].definition = Some(file_id);\n         ModCollector {\n             def_collector: &mut *self,\n+            attr_path: None,\n             module_id,\n             file_id: file_id.into(),\n             raw_items: &raw_items,\n@@ -474,6 +475,7 @@ where\n             ModCollector {\n                 def_collector: &mut *self,\n                 file_id,\n+                attr_path: None,\n                 module_id,\n                 raw_items: &raw_items,\n                 parent_module: None,\n@@ -497,6 +499,7 @@ struct ModCollector<'a, D> {\n     def_collector: D,\n     module_id: CrateModuleId,\n     file_id: HirFileId,\n+    attr_path: Option<&'a SmolStr>,\n     raw_items: &'a raw::RawItems,\n     parent_module: Option<ParentModule<'a>>,\n }\n@@ -551,6 +554,7 @@ where\n                 ModCollector {\n                     def_collector: &mut *self.def_collector,\n                     module_id,\n+                    attr_path: attr_path.as_ref(),\n                     file_id: self.file_id,\n                     raw_items: self.raw_items,\n                     parent_module: Some(parent_module),\n@@ -567,6 +571,7 @@ where\n                 match resolve_submodule(\n                     self.def_collector.db,\n                     self.file_id,\n+                    self.attr_path,\n                     name,\n                     is_root,\n                     attr_path.as_ref(),\n@@ -578,6 +583,7 @@ where\n                         ModCollector {\n                             def_collector: &mut *self.def_collector,\n                             module_id,\n+                            attr_path: attr_path.as_ref(),\n                             file_id: file_id.into(),\n                             raw_items: &raw_items,\n                             parent_module: None,"}, {"sha": "3aa32bd66c0f138a4c88ffbbe0dc96a2cde0f8b9", "filename": "crates/ra_hir/src/nameres/mod_resolution.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0492b18ed47115c630cf3490fcdf904155f6e496/crates%2Fra_hir%2Fsrc%2Fnameres%2Fmod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0492b18ed47115c630cf3490fcdf904155f6e496/crates%2Fra_hir%2Fsrc%2Fnameres%2Fmod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Fmod_resolution.rs?ref=0492b18ed47115c630cf3490fcdf904155f6e496", "patch": "@@ -23,6 +23,7 @@ impl<'a> ParentModule<'a> {\n pub(super) fn resolve_submodule(\n     db: &impl DefDatabase,\n     file_id: HirFileId,\n+    mod_attr_path: Option<&SmolStr>,\n     name: &Name,\n     is_root: bool,\n     attr_path: Option<&SmolStr>,\n@@ -80,7 +81,7 @@ pub(super) fn resolve_submodule(\n             ResolutionMode::OutOfLine(OutOfLineMode::WithAttributePath(path))\n         }\n         (None, None) => {\n-            let is_dir_owner = is_root || mod_name == \"mod\";\n+            let is_dir_owner = is_root || mod_name == \"mod\" || mod_attr_path.is_some();\n             if is_dir_owner {\n                 let file_mod = dir_path.join(format!(\"{}.rs\", name));\n                 let dir_mod = dir_path.join(format!(\"{}/mod.rs\", name));"}, {"sha": "e3e6f1e959bbb30696ed752b2d439041c93d38be", "filename": "crates/ra_hir/src/nameres/tests/mod_resolution.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/0492b18ed47115c630cf3490fcdf904155f6e496/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0492b18ed47115c630cf3490fcdf904155f6e496/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs?ref=0492b18ed47115c630cf3490fcdf904155f6e496", "patch": "@@ -706,3 +706,34 @@ fn unresolved_module_diagnostics() {\n     \"###\n     );\n }\n+\n+#[test]\n+fn module_resolution_decl_inside_module_in_non_crate_root_2() {\n+    let map = def_map_with_crate_graph(\n+        r###\"\n+        //- /main.rs\n+        #[path=\"module/m2.rs\"]\n+        mod module;\n+\n+        //- /module/m2.rs\n+        pub mod submod;\n+\n+        //- /module/submod.rs\n+        pub struct Baz;\n+        \"###,\n+        crate_graph! {\n+            \"main\": (\"/main.rs\", []),\n+        },\n+    );\n+\n+    assert_snapshot!(map, @r###\"\n+        \u22eecrate\n+        \u22eemodule: t\n+        \u22ee\n+        \u22eecrate::module\n+        \u22eesubmod: t\n+        \u22ee\n+        \u22eecrate::module::submod\n+        \u22eeBaz: t v\n+    \"###);\n+}"}]}