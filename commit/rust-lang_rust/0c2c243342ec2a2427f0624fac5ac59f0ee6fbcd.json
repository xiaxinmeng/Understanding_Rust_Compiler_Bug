{"sha": "0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd", "node_id": "C_kwDOAAsO6NoAKDBjMmMyNDMzNDJlYzJhMjQyN2YwNjI0ZmFjNWFjNTlmMGVlNmZiY2Q", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-06-18T01:58:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-06-18T01:58:51Z"}, "message": "Auto merge of #112599 - saethlin:cleaner-panics, r=thomcc\n\nLaunch a non-unwinding panic for misaligned pointer deref\n\nThis panic already never unwinds, but that's only because it always hits the unwind guard that's created by our `UnwindAction::Terminate`. Hitting the unwind guard generates a huge double-panic backtrace. Now we generate a normal-looking panic message when this check is hit.\n\nr? `@thomcc`", "tree": {"sha": "df08bcbf071a40581b4aa501b205d7e0b80fb332", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df08bcbf071a40581b4aa501b205d7e0b80fb332"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd", "html_url": "https://github.com/rust-lang/rust/commit/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed7281e784423249ab85c094aaba81e3b949a65f", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed7281e784423249ab85c094aaba81e3b949a65f", "html_url": "https://github.com/rust-lang/rust/commit/ed7281e784423249ab85c094aaba81e3b949a65f"}, {"sha": "7a2490eba3f161c81ad243c7d957b337dd70a2af", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a2490eba3f161c81ad243c7d957b337dd70a2af", "html_url": "https://github.com/rust-lang/rust/commit/7a2490eba3f161c81ad243c7d957b337dd70a2af"}], "stats": {"total": 15, "additions": 7, "deletions": 8}, "files": [{"sha": "856327e6ce656e18b9360316e48488a66590724f", "filename": "compiler/rustc_mir_transform/src/check_alignment.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_alignment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_alignment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_alignment.rs?ref=0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd", "patch": "@@ -9,7 +9,6 @@ use rustc_middle::mir::{\n };\n use rustc_middle::ty::{Ty, TyCtxt, TypeAndMut};\n use rustc_session::Session;\n-use rustc_target::spec::PanicStrategy;\n \n pub struct CheckAlignment;\n \n@@ -241,11 +240,10 @@ fn insert_alignment_check<'tcx>(\n                 required: Operand::Copy(alignment),\n                 found: Operand::Copy(addr),\n             }),\n-            unwind: if tcx.sess.panic_strategy() == PanicStrategy::Unwind {\n-                UnwindAction::Terminate\n-            } else {\n-                UnwindAction::Unreachable\n-            },\n+            // The panic symbol that this calls is #[rustc_nounwind]. We never want to insert an\n+            // unwind into unsafe code, because unwinding could make a failing UB check turn into\n+            // much worse UB when we start unwinding.\n+            unwind: UnwindAction::Unreachable,\n         },\n     });\n }"}, {"sha": "f0fcdab00ada166d4187c66bc827b6d89e728aa3", "filename": "library/core/src/panicking.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd/library%2Fcore%2Fsrc%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd/library%2Fcore%2Fsrc%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fpanicking.rs?ref=0c2c243342ec2a2427f0624fac5ac59f0ee6fbcd", "patch": "@@ -166,14 +166,15 @@ fn panic_bounds_check(index: usize, len: usize) -> ! {\n #[cfg_attr(not(feature = \"panic_immediate_abort\"), inline(never))]\n #[track_caller]\n #[lang = \"panic_misaligned_pointer_dereference\"] // needed by codegen for panic on misaligned pointer deref\n+#[rustc_nounwind] // `CheckAlignment` MIR pass requires this function to never unwind\n fn panic_misaligned_pointer_dereference(required: usize, found: usize) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n         super::intrinsics::abort()\n     }\n \n-    panic!(\n+    panic_nounwind_fmt(format_args!(\n         \"misaligned pointer dereference: address must be a multiple of {required:#x} but is {found:#x}\"\n-    )\n+    ))\n }\n \n /// Panic because we cannot unwind out of a function."}]}