{"sha": "899c7ad9b2003482283615902fb29513e2fc22ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5OWM3YWQ5YjIwMDM0ODIyODM2MTU5MDJmYjI5NTEzZTJmYzIyYWM=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2017-10-24T19:37:47Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2017-10-31T16:41:38Z"}, "message": "avoid unnecessary copies in liveness computation", "tree": {"sha": "f2262c8f10fc7e51fce0b385afd93f734e0ae199", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2262c8f10fc7e51fce0b385afd93f734e0ae199"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/899c7ad9b2003482283615902fb29513e2fc22ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/899c7ad9b2003482283615902fb29513e2fc22ac", "html_url": "https://github.com/rust-lang/rust/commit/899c7ad9b2003482283615902fb29513e2fc22ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/899c7ad9b2003482283615902fb29513e2fc22ac/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7523c7368c9e875eae6da46091cbf86c48041b89", "url": "https://api.github.com/repos/rust-lang/rust/commits/7523c7368c9e875eae6da46091cbf86c48041b89", "html_url": "https://github.com/rust-lang/rust/commit/7523c7368c9e875eae6da46091cbf86c48041b89"}], "stats": {"total": 41, "additions": 17, "deletions": 24}, "files": [{"sha": "df7ba3c62faeabe10821bd3814fb6fe783a26b8c", "filename": "src/librustc_mir/util/liveness.rs", "status": "modified", "additions": 17, "deletions": 24, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/899c7ad9b2003482283615902fb29513e2fc22ac/src%2Flibrustc_mir%2Futil%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/899c7ad9b2003482283615902fb29513e2fc22ac/src%2Flibrustc_mir%2Futil%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fliveness.rs?ref=899c7ad9b2003482283615902fb29513e2fc22ac", "patch": "@@ -171,40 +171,33 @@ pub fn liveness_of_locals<'tcx>(mir: &Mir<'tcx>) -> LivenessResult {\n         block(b, locals)\n     }).collect();\n \n-    let copy = |from: &IndexVec<BasicBlock, LocalSet>, to: &mut IndexVec<BasicBlock, LocalSet>| {\n-        for (i, set) in to.iter_enumerated_mut() {\n-            set.clone_from(&from[i]);\n-        }\n-    };\n-\n     let mut ins: IndexVec<_, _> = mir.basic_blocks()\n         .indices()\n-        .map(|_| LocalSet::new_empty(locals)).collect();\n+        .map(|_| LocalSet::new_empty(locals))\n+        .collect();\n     let mut outs = ins.clone();\n \n-    let mut ins_ = ins.clone();\n-    let mut outs_ = outs.clone();\n-\n-    loop {\n-        copy(&ins, &mut ins_);\n-        copy(&outs, &mut outs_);\n+    let mut changed = true;\n+    let mut bits = LocalSet::new_empty(locals);\n+    while changed {\n+        changed = false;\n \n         for b in mir.basic_blocks().indices().rev() {\n-            // out = \u222a {ins of successors}\n-            outs[b].clear();\n+            // outs[b] = \u222a {ins of successors}\n+            bits.clear();\n             for &successor in mir.basic_blocks()[b].terminator().successors().into_iter() {\n-                outs[b].union(&ins[successor]);\n+                bits.union(&ins[successor]);\n             }\n+            outs[b].clone_from(&bits);\n \n-            // in = use \u222a (out - def)\n-            ins[b].clone_from(&outs[b]);\n+            // bits = use \u222a (bits - def)\n+            def_use[b].apply(&mut bits);\n \n-            // FIXME use the return value to detect if we have changed things\n-            def_use[b].apply(&mut ins[b]);\n-        }\n-\n-        if ins_ == ins && outs_ == outs {\n-            break;\n+            // update bits on entry and flag if they have changed\n+            if ins[b] != bits {\n+                ins[b].clone_from(&bits);\n+                changed = true;\n+            }\n         }\n     }\n "}]}