{"sha": "a678e3191197f145451c97c6cc884e15cae38186", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2NzhlMzE5MTE5N2YxNDU0NTFjOTdjNmNjODg0ZTE1Y2FlMzgxODY=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-09-14T20:17:57Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-09-15T21:39:38Z"}, "message": "Hide diagnostics emitted during --cfg parsing\n\nThe early error is more than sufficient for fixing the problem.", "tree": {"sha": "f26173cb42e575a2572b40c13cb83c7172bc6fb5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f26173cb42e575a2572b40c13cb83c7172bc6fb5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a678e3191197f145451c97c6cc884e15cae38186", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a678e3191197f145451c97c6cc884e15cae38186", "html_url": "https://github.com/rust-lang/rust/commit/a678e3191197f145451c97c6cc884e15cae38186", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a678e3191197f145451c97c6cc884e15cae38186/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "457666860cf198ddacc3d235b7360499eec3b897", "url": "https://api.github.com/repos/rust-lang/rust/commits/457666860cf198ddacc3d235b7360499eec3b897", "html_url": "https://github.com/rust-lang/rust/commit/457666860cf198ddacc3d235b7360499eec3b897"}], "stats": {"total": 18, "additions": 17, "deletions": 1}, "files": [{"sha": "723855c7c29cf11b03f572dfef7a99b7b74e95e7", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a678e3191197f145451c97c6cc884e15cae38186/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a678e3191197f145451c97c6cc884e15cae38186/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=a678e3191197f145451c97c6cc884e15cae38186", "patch": "@@ -7,6 +7,7 @@ use crate::session::{early_error, early_warn, Session};\n use crate::session::search_paths::SearchPath;\n \n use rustc_data_structures::fx::FxHashSet;\n+use rustc_data_structures::sync::Lrc;\n \n use rustc_target::spec::{LinkerFlavor, MergeFunctions, PanicStrategy, RelroLevel};\n use rustc_target::spec::{Target, TargetTriple};\n@@ -19,6 +20,7 @@ use syntax::parse::{ParseSess, new_parser_from_source_str};\n use syntax::parse::token;\n use syntax::symbol::{sym, Symbol};\n use syntax::feature_gate::UnstableFeatures;\n+use syntax::source_map::SourceMap;\n \n use errors::emitter::HumanReadableErrorType;\n use errors::{ColorConfig, FatalError, Handler};\n@@ -1850,11 +1852,20 @@ pub fn rustc_optgroups() -> Vec<RustcOptGroup> {\n     opts\n }\n \n+struct NullEmitter;\n+\n+impl errors::emitter::Emitter for NullEmitter {\n+    fn emit_diagnostic(&mut self, _: &errors::DiagnosticBuilder<'_>) {}\n+}\n+\n // Converts strings provided as `--cfg [cfgspec]` into a `crate_cfg`.\n pub fn parse_cfgspecs(cfgspecs: Vec<String>) -> FxHashSet<(String, Option<String>)> {\n     syntax::with_default_globals(move || {\n         let cfg = cfgspecs.into_iter().map(|s| {\n-            let sess = ParseSess::new(FilePathMapping::empty());\n+\n+            let cm = Lrc::new(SourceMap::new(FilePathMapping::empty()));\n+            let handler = Handler::with_emitter(false, None, Box::new(NullEmitter));\n+            let sess = ParseSess::with_span_handler(handler, cm);\n             let filename = FileName::cfg_spec_source_code(&s);\n             let mut parser = new_parser_from_source_str(&sess, filename, s.to_string());\n "}, {"sha": "9fa726f93e3eada91f18a11e4d3d7a95964e78fd", "filename": "src/test/ui/conditional-compilation/cfg-arg-invalid-6.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a678e3191197f145451c97c6cc884e15cae38186/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-6.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a678e3191197f145451c97c6cc884e15cae38186/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-6.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-6.rs?ref=a678e3191197f145451c97c6cc884e15cae38186", "patch": "@@ -0,0 +1,3 @@\n+// compile-flags: --cfg a{\n+// error-pattern: invalid `--cfg` argument: `a{` (expected `key` or `key=\"value\"`)\n+fn main() {}"}, {"sha": "7d2087b4b71f71f91d05f30017635547ebbf896b", "filename": "src/test/ui/conditional-compilation/cfg-arg-invalid-6.stderr", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a678e3191197f145451c97c6cc884e15cae38186/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-6.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a678e3191197f145451c97c6cc884e15cae38186/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-6.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-6.stderr?ref=a678e3191197f145451c97c6cc884e15cae38186", "patch": "@@ -0,0 +1,2 @@\n+error: invalid `--cfg` argument: `a{` (expected `key` or `key=\"value\"`)\n+"}]}