{"sha": "59bf8a07f93d194abcc880a366bda37563a9402b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5YmY4YTA3ZjkzZDE5NGFiY2M4ODBhMzY2YmRhMzc1NjNhOTQwMmI=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-08T12:29:37Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-18T14:08:25Z"}, "message": "extract error_on_circular_module", "tree": {"sha": "961de67b00da6120562ef6e991fe1b0f10eeacdb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/961de67b00da6120562ef6e991fe1b0f10eeacdb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/59bf8a07f93d194abcc880a366bda37563a9402b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/59bf8a07f93d194abcc880a366bda37563a9402b", "html_url": "https://github.com/rust-lang/rust/commit/59bf8a07f93d194abcc880a366bda37563a9402b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/59bf8a07f93d194abcc880a366bda37563a9402b/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "463995fe2974e2473392ddf7be8699746f6b7dac", "url": "https://api.github.com/repos/rust-lang/rust/commits/463995fe2974e2473392ddf7be8699746f6b7dac", "html_url": "https://github.com/rust-lang/rust/commit/463995fe2974e2473392ddf7be8699746f6b7dac"}], "stats": {"total": 28, "additions": 19, "deletions": 9}, "files": [{"sha": "66faf295b7232b7e241dba3fb364e53307f68259", "filename": "src/librustc_parse/parser/module.rs", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/59bf8a07f93d194abcc880a366bda37563a9402b/src%2Flibrustc_parse%2Fparser%2Fmodule.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59bf8a07f93d194abcc880a366bda37563a9402b/src%2Flibrustc_parse%2Fparser%2Fmodule.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_parse%2Fparser%2Fmodule.rs?ref=59bf8a07f93d194abcc880a366bda37563a9402b", "patch": "@@ -118,15 +118,7 @@ fn eval_src_mod<'a>(\n     id: ast::Ident,\n ) -> PResult<'a, (Mod, Vec<Attribute>)> {\n     let mut included_mod_stack = sess.included_mod_stack.borrow_mut();\n-    if let Some(i) = included_mod_stack.iter().position(|p| *p == path) {\n-        let mut err = String::from(\"circular modules: \");\n-        for p in &included_mod_stack[i..] {\n-            err.push_str(&p.to_string_lossy());\n-            err.push_str(\" -> \");\n-        }\n-        err.push_str(&path.to_string_lossy());\n-        return Err(sess.span_diagnostic.struct_span_err(id.span, &err[..]));\n-    }\n+    error_on_circular_module(sess, id.span, &path, &included_mod_stack)?;\n     included_mod_stack.push(path.clone());\n     drop(included_mod_stack);\n \n@@ -140,6 +132,24 @@ fn eval_src_mod<'a>(\n     Ok(module)\n }\n \n+fn error_on_circular_module<'a>(\n+    sess: &'a ParseSess,\n+    span: Span,\n+    path: &Path,\n+    included_mod_stack: &[PathBuf],\n+) -> PResult<'a, ()> {\n+    if let Some(i) = included_mod_stack.iter().position(|p| *p == path) {\n+        let mut err = String::from(\"circular modules: \");\n+        for p in &included_mod_stack[i..] {\n+            err.push_str(&p.to_string_lossy());\n+            err.push_str(\" -> \");\n+        }\n+        err.push_str(&path.to_string_lossy());\n+        return Err(sess.span_diagnostic.struct_span_err(span, &err[..]));\n+    }\n+    Ok(())\n+}\n+\n pub fn push_directory(\n     id: Ident,\n     attrs: &[Attribute],"}]}