{"sha": "04475b92f9309356a90fe970816774d14ef5b4ed", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA0NDc1YjkyZjkzMDkzNTZhOTBmZTk3MDgxNjc3NGQxNGVmNWI0ZWQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-10-26T21:23:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-10-26T21:23:32Z"}, "message": "Auto merge of #29274 - thepowersgang:issues-29107-const-unsafe-fn-order, r=nikomatsakis\n\nThis PR switches the implemented ordering from `unsafe const fn` (as was in the original RFC) to `const unsafe fn` (which is what the lang team decided on)", "tree": {"sha": "a58af9f0164fc9dffae9a69e925bc840ed13d4b6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a58af9f0164fc9dffae9a69e925bc840ed13d4b6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/04475b92f9309356a90fe970816774d14ef5b4ed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/04475b92f9309356a90fe970816774d14ef5b4ed", "html_url": "https://github.com/rust-lang/rust/commit/04475b92f9309356a90fe970816774d14ef5b4ed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/04475b92f9309356a90fe970816774d14ef5b4ed/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c42c9881542a0f3a8b573a56cd1c12643d4be52", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c42c9881542a0f3a8b573a56cd1c12643d4be52", "html_url": "https://github.com/rust-lang/rust/commit/2c42c9881542a0f3a8b573a56cd1c12643d4be52"}, {"sha": "f9b8c49cdb75fb571c7b3ea4af90b0e96929276c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9b8c49cdb75fb571c7b3ea4af90b0e96929276c", "html_url": "https://github.com/rust-lang/rust/commit/f9b8c49cdb75fb571c7b3ea4af90b0e96929276c"}], "stats": {"total": 37, "additions": 21, "deletions": 16}, "files": [{"sha": "c4ca3fa384e968cfe7734df57b8aa52108418ea6", "filename": "src/libcore/nonzero.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibcore%2Fnonzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibcore%2Fnonzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fnonzero.rs?ref=04475b92f9309356a90fe970816774d14ef5b4ed", "patch": "@@ -55,7 +55,7 @@ macro_rules! nonzero_new {\n         /// Creates an instance of NonZero with the provided value.\n         /// You must indeed ensure that the value is actually \"non-zero\".\n         #[inline(always)]\n-        pub unsafe const fn new(inner: T) -> NonZero<T> {\n+        pub const unsafe fn new(inner: T) -> NonZero<T> {\n             NonZero(inner)\n         }\n     )"}, {"sha": "52a888d797ba922e848af5457829ba8a54c506bc", "filename": "src/libcore/ptr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibcore%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibcore%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fptr.rs?ref=04475b92f9309356a90fe970816774d14ef5b4ed", "patch": "@@ -511,7 +511,7 @@ macro_rules! unique_new {\n macro_rules! unique_new {\n     () => (\n         /// Creates a new `Unique`.\n-        pub unsafe const fn new(ptr: *mut T) -> Unique<T> {\n+        pub const unsafe fn new(ptr: *mut T) -> Unique<T> {\n             Unique { pointer: NonZero::new(ptr), _marker: PhantomData }\n         }\n     )"}, {"sha": "e153f1665e3e6db32ce9327fcf5069c2b1e0cbb6", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=04475b92f9309356a90fe970816774d14ef5b4ed", "patch": "@@ -4380,19 +4380,21 @@ impl<'a> Parser<'a> {\n     /// true if we are looking at `const ID`, false for things like `const fn` etc\n     pub fn is_const_item(&mut self) -> bool {\n         self.token.is_keyword(keywords::Const) &&\n-            !self.look_ahead(1, |t| t.is_keyword(keywords::Fn))\n+            !self.look_ahead(1, |t| t.is_keyword(keywords::Fn)) &&\n+            !self.look_ahead(1, |t| t.is_keyword(keywords::Unsafe))\n     }\n \n     /// parses all the \"front matter\" for a `fn` declaration, up to\n     /// and including the `fn` keyword:\n     ///\n     /// - `const fn`\n     /// - `unsafe fn`\n+    /// - `const unsafe fn`\n     /// - `extern fn`\n     /// - etc\n     pub fn parse_fn_front_matter(&mut self) -> PResult<(ast::Constness, ast::Unsafety, abi::Abi)> {\n-        let unsafety = try!(self.parse_unsafety());\n         let is_const_fn = try!(self.eat_keyword(keywords::Const));\n+        let unsafety = try!(self.parse_unsafety());\n         let (constness, unsafety, abi) = if is_const_fn {\n             (Constness::Const, unsafety, abi::Rust)\n         } else {\n@@ -5300,11 +5302,18 @@ impl<'a> Parser<'a> {\n             return Ok(Some(item));\n         }\n         if try!(self.eat_keyword(keywords::Const) ){\n-            if self.check_keyword(keywords::Fn) {\n+            if self.check_keyword(keywords::Fn)\n+                || (self.check_keyword(keywords::Unsafe)\n+                    && self.look_ahead(1, |t| t.is_keyword(keywords::Fn))) {\n                 // CONST FUNCTION ITEM\n+                let unsafety = if try!(self.eat_keyword(keywords::Unsafe) ){\n+                    Unsafety::Unsafe\n+                } else {\n+                    Unsafety::Normal\n+                };\n                 try!(self.bump());\n                 let (ident, item_, extra_attrs) =\n-                    try!(self.parse_item_fn(Unsafety::Normal, Constness::Const, abi::Rust));\n+                    try!(self.parse_item_fn(unsafety, Constness::Const, abi::Rust));\n                 let last_span = self.last_span;\n                 let item = self.mk_item(lo,\n                                         last_span.hi,\n@@ -5387,14 +5396,9 @@ impl<'a> Parser<'a> {\n             } else {\n                 abi::Rust\n             };\n-            let constness = if abi == abi::Rust && try!(self.eat_keyword(keywords::Const) ){\n-                Constness::Const\n-            } else {\n-                Constness::NotConst\n-            };\n             try!(self.expect_keyword(keywords::Fn));\n             let (ident, item_, extra_attrs) =\n-                try!(self.parse_item_fn(Unsafety::Unsafe, constness, abi));\n+                try!(self.parse_item_fn(Unsafety::Unsafe, Constness::NotConst, abi));\n             let last_span = self.last_span;\n             let item = self.mk_item(lo,\n                                     last_span.hi,"}, {"sha": "87cecdba28e3d2fed28305a3d635eebe280e5b8d", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=04475b92f9309356a90fe970816774d14ef5b4ed", "patch": "@@ -3058,13 +3058,14 @@ impl<'a> State<'a> {\n                                 abi: abi::Abi,\n                                 vis: ast::Visibility) -> io::Result<()> {\n         try!(word(&mut self.s, &visibility_qualified(vis, \"\")));\n-        try!(self.print_unsafety(unsafety));\n \n         match constness {\n             ast::Constness::NotConst => {}\n             ast::Constness::Const => try!(self.word_nbsp(\"const\"))\n         }\n \n+        try!(self.print_unsafety(unsafety));\n+\n         if abi != abi::Rust {\n             try!(self.word_nbsp(\"extern\"));\n             try!(self.word_nbsp(&abi.to_string()));"}, {"sha": "24ac41ce88437093797bfcd5ebe40057ff4ed72a", "filename": "src/test/compile-fail/unsafe-const-fn.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Ftest%2Fcompile-fail%2Funsafe-const-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Ftest%2Fcompile-fail%2Funsafe-const-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Funsafe-const-fn.rs?ref=04475b92f9309356a90fe970816774d14ef5b4ed", "patch": "@@ -12,7 +12,7 @@\n \n #![feature(const_fn)]\n \n-unsafe const fn dummy(v: u32) -> u32 {\n+const unsafe fn dummy(v: u32) -> u32 {\n     !v\n }\n "}, {"sha": "2511cfd042206d1257725f0770985dcc7d0c6d12", "filename": "src/test/run-pass/const-unsafe-fn.rs", "status": "renamed", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Ftest%2Frun-pass%2Fconst-unsafe-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04475b92f9309356a90fe970816774d14ef5b4ed/src%2Ftest%2Frun-pass%2Fconst-unsafe-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fconst-unsafe-fn.rs?ref=04475b92f9309356a90fe970816774d14ef5b4ed", "patch": "@@ -12,13 +12,13 @@\n \n #![feature(const_fn)]\n \n-unsafe const fn dummy(v: u32) -> u32 {\n+const unsafe fn dummy(v: u32) -> u32 {\n     !v\n }\n \n struct Type;\n impl Type {\n-    unsafe const fn new() -> Type {\n+    const unsafe fn new() -> Type {\n         Type\n     }\n }", "previous_filename": "src/test/run-pass/unsafe-const-fn.rs"}]}