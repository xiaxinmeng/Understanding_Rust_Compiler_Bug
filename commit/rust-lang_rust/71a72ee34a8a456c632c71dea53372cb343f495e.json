{"sha": "71a72ee34a8a456c632c71dea53372cb343f495e", "node_id": "C_kwDOAAsO6NoAKDcxYTcyZWUzNGE4YTQ1NmM2MzJjNzFkZWE1MzM3MmNiMzQzZjQ5NWU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-06-06T10:00:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-06-06T10:00:33Z"}, "message": "Rollup merge of #112199 - jieyouxu:issue-112188, r=compiler-errors\n\nFix suggestion for matching struct with `..` on both ends\n\n### Before This PR\n\n```\nerror: expected `}`, found `,`\n --> src\\main.rs:8:17\n  |\n8 |         Foo { .., x, .. } => (),\n  |               --^\n  |               | |\n  |               | expected `}`\n  |               `..` must be at the end and cannot have a trailing comma\n  |\nhelp: move the `..` to the end of the field list\n  |\n8 -         Foo { .., x, .. } => (),\n8 +         Foo { .., x,  , .. } => (),\n  |\n```\n\n### After This PR\n\n```\nerror: expected `}`, found `,`\n  --> tests/ui/parser/issue-112188.rs:11:17\n   |\n11 |     let Foo { .., x, .. } = f; //~ ERROR expected `}`, found `,`\n   |               --^-\n   |               | |\n   |               | expected `}`\n   |               `..` must be at the end and cannot have a trailing comma\n   |               help: remove the starting `..`\n```\n\nFixes #112188.", "tree": {"sha": "9fa404631854e7e4f81af2d35e9f9b86d11111bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9fa404631854e7e4f81af2d35e9f9b86d11111bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/71a72ee34a8a456c632c71dea53372cb343f495e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkfwPBCRBK7hj4Ov3rIwAAASYIAH7eD1l7zvCZtSkev3QBLARK\nDt7qmmMWlOp4lToQO7eft/bxnIODa/qJSKVlJ6BtMnXR1nzXXBuUDl3l5wM8IeIB\n0V6KJZJVGiKHdTfDztOfAKbkawSD7/RjXAC9Q21a8xBhoPOB2iBXtcGa0pT4n7Ah\ncQbtCMo7pWCVqGTMQTMARvkzgXU8G0610wwmKNRcMreKTK9FNb20WPsx8KUxDL4z\nh/awDL1Cb42sr50A2IYT5giI1rBXSms5uXqIgozIxJSQzLDH8UvkrCaw/sX7YhW8\nhV5EfK17iCsSQXRM7zSeFPNojLWpZg0g81Ds22B05MvzR0roCCbtjFNBp6fH04E=\n=pMUH\n-----END PGP SIGNATURE-----\n", "payload": "tree 9fa404631854e7e4f81af2d35e9f9b86d11111bd\nparent 21e7463bf8eb45cc8d9d9e4e111e64061da0d16a\nparent 2a7c6a99ef5c43311a430a07bd4eeab96a7c5d94\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1686045633 +0200\ncommitter GitHub <noreply@github.com> 1686045633 +0200\n\nRollup merge of #112199 - jieyouxu:issue-112188, r=compiler-errors\n\nFix suggestion for matching struct with `..` on both ends\n\n### Before This PR\n\n```\nerror: expected `}`, found `,`\n --> src\\main.rs:8:17\n  |\n8 |         Foo { .., x, .. } => (),\n  |               --^\n  |               | |\n  |               | expected `}`\n  |               `..` must be at the end and cannot have a trailing comma\n  |\nhelp: move the `..` to the end of the field list\n  |\n8 -         Foo { .., x, .. } => (),\n8 +         Foo { .., x,  , .. } => (),\n  |\n```\n\n### After This PR\n\n```\nerror: expected `}`, found `,`\n  --> tests/ui/parser/issue-112188.rs:11:17\n   |\n11 |     let Foo { .., x, .. } = f; //~ ERROR expected `}`, found `,`\n   |               --^-\n   |               | |\n   |               | expected `}`\n   |               `..` must be at the end and cannot have a trailing comma\n   |               help: remove the starting `..`\n```\n\nFixes #112188.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/71a72ee34a8a456c632c71dea53372cb343f495e", "html_url": "https://github.com/rust-lang/rust/commit/71a72ee34a8a456c632c71dea53372cb343f495e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/71a72ee34a8a456c632c71dea53372cb343f495e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "21e7463bf8eb45cc8d9d9e4e111e64061da0d16a", "url": "https://api.github.com/repos/rust-lang/rust/commits/21e7463bf8eb45cc8d9d9e4e111e64061da0d16a", "html_url": "https://github.com/rust-lang/rust/commit/21e7463bf8eb45cc8d9d9e4e111e64061da0d16a"}, {"sha": "2a7c6a99ef5c43311a430a07bd4eeab96a7c5d94", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a7c6a99ef5c43311a430a07bd4eeab96a7c5d94", "html_url": "https://github.com/rust-lang/rust/commit/2a7c6a99ef5c43311a430a07bd4eeab96a7c5d94"}], "stats": {"total": 124, "additions": 111, "deletions": 13}, "files": [{"sha": "fdf365178474d179e78ea91ec04668f1759f0a5c", "filename": "compiler/rustc_parse/src/parser/pat.rs", "status": "modified", "additions": 45, "deletions": 12, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/71a72ee34a8a456c632c71dea53372cb343f495e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71a72ee34a8a456c632c71dea53372cb343f495e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs?ref=71a72ee34a8a456c632c71dea53372cb343f495e", "patch": "@@ -938,7 +938,8 @@ impl<'a> Parser<'a> {\n         let mut etc = false;\n         let mut ate_comma = true;\n         let mut delayed_err: Option<DiagnosticBuilder<'a, ErrorGuaranteed>> = None;\n-        let mut etc_span = None;\n+        let mut first_etc_and_maybe_comma_span = None;\n+        let mut last_non_comma_dotdot_span = None;\n \n         while self.token != token::CloseDelim(Delimiter::Brace) {\n             let attrs = match self.parse_outer_attributes() {\n@@ -969,12 +970,27 @@ impl<'a> Parser<'a> {\n             {\n                 etc = true;\n                 let mut etc_sp = self.token.span;\n+                if first_etc_and_maybe_comma_span.is_none() {\n+                    if let Some(comma_tok) = self\n+                        .look_ahead(1, |t| if *t == token::Comma { Some(t.clone()) } else { None })\n+                    {\n+                        let nw_span = self\n+                            .sess\n+                            .source_map()\n+                            .span_extend_to_line(comma_tok.span)\n+                            .trim_start(comma_tok.span.shrink_to_lo())\n+                            .map(|s| self.sess.source_map().span_until_non_whitespace(s));\n+                        first_etc_and_maybe_comma_span = nw_span.map(|s| etc_sp.to(s));\n+                    } else {\n+                        first_etc_and_maybe_comma_span =\n+                            Some(self.sess.source_map().span_until_non_whitespace(etc_sp));\n+                    }\n+                }\n \n                 self.recover_bad_dot_dot();\n                 self.bump(); // `..` || `...` || `_`\n \n                 if self.token == token::CloseDelim(Delimiter::Brace) {\n-                    etc_span = Some(etc_sp);\n                     break;\n                 }\n                 let token_str = super::token_descr(&self.token);\n@@ -996,7 +1012,6 @@ impl<'a> Parser<'a> {\n                     ate_comma = true;\n                 }\n \n-                etc_span = Some(etc_sp.until(self.token.span));\n                 if self.token == token::CloseDelim(Delimiter::Brace) {\n                     // If the struct looks otherwise well formed, recover and continue.\n                     if let Some(sp) = comma_sp {\n@@ -1040,6 +1055,9 @@ impl<'a> Parser<'a> {\n                         }\n                     }?;\n                     ate_comma = this.eat(&token::Comma);\n+\n+                    last_non_comma_dotdot_span = Some(this.prev_token.span);\n+\n                     // We just ate a comma, so there's no need to use\n                     // `TrailingToken::Comma`\n                     Ok((field, TrailingToken::None))\n@@ -1049,15 +1067,30 @@ impl<'a> Parser<'a> {\n         }\n \n         if let Some(mut err) = delayed_err {\n-            if let Some(etc_span) = etc_span {\n-                err.multipart_suggestion(\n-                    \"move the `..` to the end of the field list\",\n-                    vec![\n-                        (etc_span, String::new()),\n-                        (self.token.span, format!(\"{}.. }}\", if ate_comma { \"\" } else { \", \" })),\n-                    ],\n-                    Applicability::MachineApplicable,\n-                );\n+            if let Some(first_etc_span) = first_etc_and_maybe_comma_span {\n+                if self.prev_token == token::DotDot {\n+                    // We have `.., x, ..`.\n+                    err.multipart_suggestion(\n+                        \"remove the starting `..`\",\n+                        vec![(first_etc_span, String::new())],\n+                        Applicability::MachineApplicable,\n+                    );\n+                } else {\n+                    if let Some(last_non_comma_dotdot_span) = last_non_comma_dotdot_span {\n+                        // We have `.., x`.\n+                        err.multipart_suggestion(\n+                            \"move the `..` to the end of the field list\",\n+                            vec![\n+                                (first_etc_span, String::new()),\n+                                (\n+                                    self.token.span.to(last_non_comma_dotdot_span.shrink_to_hi()),\n+                                    format!(\"{} .. }}\", if ate_comma { \"\" } else { \",\" }),\n+                                ),\n+                            ],\n+                            Applicability::MachineApplicable,\n+                        );\n+                    }\n+                }\n             }\n             err.emit();\n         }"}, {"sha": "5e73d8e38de816de29a7779624d2589e35fbc931", "filename": "tests/ui/parser/issue-112188.fixed", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-112188.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-112188.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fissue-112188.fixed?ref=71a72ee34a8a456c632c71dea53372cb343f495e", "patch": "@@ -0,0 +1,14 @@\n+// run-rustfix\n+\n+#![allow(unused)]\n+\n+struct Foo { x: i32 }\n+\n+fn main() {\n+    let f = Foo { x: 0 };\n+    let Foo { .. } = f;\n+    let Foo { .. } = f; //~ ERROR expected `}`, found `,`\n+    let Foo { x, .. } = f;\n+    let Foo { x, .. } = f; //~ ERROR expected `}`, found `,`\n+    let Foo { x, .. } = f; //~ ERROR expected `}`, found `,`\n+}"}, {"sha": "27ca192e52263eac3f373878af218d7899a79928", "filename": "tests/ui/parser/issue-112188.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-112188.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-112188.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fissue-112188.rs?ref=71a72ee34a8a456c632c71dea53372cb343f495e", "patch": "@@ -0,0 +1,14 @@\n+// run-rustfix\n+\n+#![allow(unused)]\n+\n+struct Foo { x: i32 }\n+\n+fn main() {\n+    let f = Foo { x: 0 };\n+    let Foo { .. } = f;\n+    let Foo { .., } = f; //~ ERROR expected `}`, found `,`\n+    let Foo { x, .. } = f;\n+    let Foo { .., x } = f; //~ ERROR expected `}`, found `,`\n+    let Foo { .., x, .. } = f; //~ ERROR expected `}`, found `,`\n+}"}, {"sha": "6d2d8e6a3b0554fdbd28ff304edf003c4545cd2f", "filename": "tests/ui/parser/issue-112188.stderr", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-112188.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-112188.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fissue-112188.stderr?ref=71a72ee34a8a456c632c71dea53372cb343f495e", "patch": "@@ -0,0 +1,37 @@\n+error: expected `}`, found `,`\n+  --> $DIR/issue-112188.rs:10:17\n+   |\n+LL |     let Foo { .., } = f;\n+   |               --^\n+   |               | |\n+   |               | expected `}`\n+   |               | help: remove this comma\n+   |               `..` must be at the end and cannot have a trailing comma\n+\n+error: expected `}`, found `,`\n+  --> $DIR/issue-112188.rs:12:17\n+   |\n+LL |     let Foo { .., x } = f;\n+   |               --^\n+   |               | |\n+   |               | expected `}`\n+   |               `..` must be at the end and cannot have a trailing comma\n+   |\n+help: move the `..` to the end of the field list\n+   |\n+LL -     let Foo { .., x } = f;\n+LL +     let Foo { x, .. } = f;\n+   |\n+\n+error: expected `}`, found `,`\n+  --> $DIR/issue-112188.rs:13:17\n+   |\n+LL |     let Foo { .., x, .. } = f;\n+   |               --^-\n+   |               | |\n+   |               | expected `}`\n+   |               `..` must be at the end and cannot have a trailing comma\n+   |               help: remove the starting `..`\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "97e16f88b8d328e6355820ec9a6a404f58150bbd", "filename": "tests/ui/parser/issue-49257.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-49257.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/71a72ee34a8a456c632c71dea53372cb343f495e/tests%2Fui%2Fparser%2Fissue-49257.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fissue-49257.stderr?ref=71a72ee34a8a456c632c71dea53372cb343f495e", "patch": "@@ -25,7 +25,7 @@ LL |     let Point { .., y } = p;\n help: move the `..` to the end of the field list\n    |\n LL -     let Point { .., y } = p;\n-LL +     let Point { y , .. } = p;\n+LL +     let Point { y, .. } = p;\n    |\n \n error: expected `}`, found `,`"}]}