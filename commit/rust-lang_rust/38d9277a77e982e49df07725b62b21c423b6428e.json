{"sha": "38d9277a77e982e49df07725b62b21c423b6428e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM4ZDkyNzdhNzdlOTgyZTQ5ZGYwNzcyNWI2MmIyMWM0MjNiNjQyOGU=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2018-10-25T09:17:39Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2018-10-25T21:25:47Z"}, "message": "Shrink `Statement`.\n\nThis commit reduces the size of `Statement` from 80 bytes to 56 bytes on\n64-bit platforms, by boxing the `AscribeUserType` variant of\n`StatementKind`.\n\nThis change reduces instruction counts on most benchmarks by 1--3%.", "tree": {"sha": "afaf8c4352a9defc433fc12911f2406b314f46a3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/afaf8c4352a9defc433fc12911f2406b314f46a3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/38d9277a77e982e49df07725b62b21c423b6428e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/38d9277a77e982e49df07725b62b21c423b6428e", "html_url": "https://github.com/rust-lang/rust/commit/38d9277a77e982e49df07725b62b21c423b6428e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/38d9277a77e982e49df07725b62b21c423b6428e/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f99911a4a0bead7dd1f9ef2f90442844434cc391", "url": "https://api.github.com/repos/rust-lang/rust/commits/f99911a4a0bead7dd1f9ef2f90442844434cc391", "html_url": "https://github.com/rust-lang/rust/commit/f99911a4a0bead7dd1f9ef2f90442844434cc391"}], "stats": {"total": 16, "additions": 10, "deletions": 6}, "files": [{"sha": "8966af728919a4b0aaeca8cbb4570326df48f574", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=38d9277a77e982e49df07725b62b21c423b6428e", "patch": "@@ -1674,6 +1674,10 @@ impl<'tcx> Statement<'tcx> {\n     /// Changes a statement to a nop. This is both faster than deleting instructions and avoids\n     /// invalidating statement indices in `Location`s.\n     pub fn make_nop(&mut self) {\n+        // `Statement` contributes significantly to peak memory usage. Make\n+        // sure it doesn't get bigger.\n+        static_assert!(STATEMENT_IS_AT_MOST_56_BYTES: mem::size_of::<Statement<'_>>() <= 56);\n+\n         self.kind = StatementKind::Nop\n     }\n \n@@ -1737,7 +1741,7 @@ pub enum StatementKind<'tcx> {\n     /// - `Contravariant` -- requires that `T_y :> T`\n     /// - `Invariant` -- requires that `T_y == T`\n     /// - `Bivariant` -- no effect\n-    AscribeUserType(Place<'tcx>, ty::Variance, UserTypeAnnotation<'tcx>),\n+    AscribeUserType(Place<'tcx>, ty::Variance, Box<UserTypeAnnotation<'tcx>>),\n \n     /// No-op. Useful for deleting instructions without affecting statement indices.\n     Nop,"}, {"sha": "befa5880e7faf103a611d3efcb3ee72066ca7f31", "filename": "src/librustc_mir/borrow_check/nll/type_check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs?ref=38d9277a77e982e49df07725b62b21c423b6428e", "patch": "@@ -1308,7 +1308,7 @@ impl<'a, 'gcx, 'tcx> TypeChecker<'a, 'gcx, 'tcx> {\n                     );\n                 };\n             }\n-            StatementKind::AscribeUserType(ref place, variance, c_ty) => {\n+            StatementKind::AscribeUserType(ref place, variance, box c_ty) => {\n                 let place_ty = place.ty(mir, tcx).to_ty(tcx);\n                 if let Err(terr) = self.relate_type_and_user_type(\n                     place_ty,"}, {"sha": "8d6b6bb5c74f133b491e94181a2e3e4fc9a6ea9b", "filename": "src/librustc_mir/build/expr/as_place.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_place.rs?ref=38d9277a77e982e49df07725b62b21c423b6428e", "patch": "@@ -147,7 +147,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                             kind: StatementKind::AscribeUserType(\n                                 place.clone(),\n                                 Variance::Invariant,\n-                                user_ty,\n+                                box user_ty,\n                             ),\n                         },\n                     );\n@@ -167,7 +167,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                             kind: StatementKind::AscribeUserType(\n                                 Place::Local(temp.clone()),\n                                 Variance::Invariant,\n-                                user_ty,\n+                                box user_ty,\n                             ),\n                         },\n                     );"}, {"sha": "caacc9311c66ba2faa4daa65074abd5ab068aac4", "filename": "src/librustc_mir/build/matches/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38d9277a77e982e49df07725b62b21c423b6428e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs?ref=38d9277a77e982e49df07725b62b21c423b6428e", "patch": "@@ -316,7 +316,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                         kind: StatementKind::AscribeUserType(\n                             place.clone(),\n                             ty::Variance::Invariant,\n-                            ascription_user_ty,\n+                            box ascription_user_ty,\n                         ),\n                     },\n                 );\n@@ -1323,7 +1323,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     kind: StatementKind::AscribeUserType(\n                         ascription.source.clone(),\n                         ty::Variance::Covariant,\n-                        ascription.user_ty,\n+                        box ascription.user_ty,\n                     ),\n                 },\n             );"}]}