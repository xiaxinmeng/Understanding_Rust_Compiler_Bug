{"sha": "3662a9fb0476f5d4209ef2471b33ce4199e01fbe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2NjJhOWZiMDQ3NmY1ZDQyMDllZjI0NzFiMzNjZTQxOTllMDFmYmU=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-20T14:26:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-20T14:26:41Z"}, "message": "Rollup merge of #63723 - josephlr:sigemptyset, r=alexcrichton\n\nConsolidate sigemptyset workarounds\n\nIn sys/unix/process, we work around the sigemptyset linking issues\non android in two different ways. This change consolidates these\nworkarounds, and avoids duplicating bindings from `libc`.", "tree": {"sha": "46072ae0149e6e85749ab33dc76783fbb69e54e7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/46072ae0149e6e85749ab33dc76783fbb69e54e7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3662a9fb0476f5d4209ef2471b33ce4199e01fbe", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdXAMhCRBK7hj4Ov3rIwAAdHIIAFFF87A46oLfP33QFd43pdD6\niLUkJLHtfwGhdeZgdavtMXAGVR6ZmKLYmAAXO0BKyP2tLm5b591aMZ69X/LU6fRs\n8YKJ/lTT6lRGA03Up49Q0wcuqefiCbJaMdogH2XQe/dXbqsILPPO2kYunrj9A/WX\nm1wlCpD0Mxv0lua5ShSH2w+UAER+DCiON8hRnFqZ/7Nap4bb2NJXO3sO3hoCZJ7D\nGSDxn+9jDsV9VNvcJeUvWml0ag8V/zIORAdZUXGr5rpTH2vZEZXvk7WBbMW1TRVr\nUCFvgqXgB9+9I+IpTewVCd5Mg9f2u5Pl9D3jmGDT8M9Kr1t39SbOtkaSiGjLQNk=\n=hmC4\n-----END PGP SIGNATURE-----\n", "payload": "tree 46072ae0149e6e85749ab33dc76783fbb69e54e7\nparent af77aedb0e895cd169614f86e59ff9f84c09f7a0\nparent 8e91dca596fcbab866a64f9502c476dff5bb06f6\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1566311201 +0200\ncommitter GitHub <noreply@github.com> 1566311201 +0200\n\nRollup merge of #63723 - josephlr:sigemptyset, r=alexcrichton\n\nConsolidate sigemptyset workarounds\n\nIn sys/unix/process, we work around the sigemptyset linking issues\non android in two different ways. This change consolidates these\nworkarounds, and avoids duplicating bindings from `libc`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3662a9fb0476f5d4209ef2471b33ce4199e01fbe", "html_url": "https://github.com/rust-lang/rust/commit/3662a9fb0476f5d4209ef2471b33ce4199e01fbe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3662a9fb0476f5d4209ef2471b33ce4199e01fbe/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "af77aedb0e895cd169614f86e59ff9f84c09f7a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/af77aedb0e895cd169614f86e59ff9f84c09f7a0", "html_url": "https://github.com/rust-lang/rust/commit/af77aedb0e895cd169614f86e59ff9f84c09f7a0"}, {"sha": "8e91dca596fcbab866a64f9502c476dff5bb06f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e91dca596fcbab866a64f9502c476dff5bb06f6", "html_url": "https://github.com/rust-lang/rust/commit/8e91dca596fcbab866a64f9502c476dff5bb06f6"}], "stats": {"total": 67, "additions": 27, "deletions": 40}, "files": [{"sha": "21fca23a8fe9ea98aa4077dcda4e40aa2e3c59a5", "filename": "src/libstd/sys/unix/process/process_common.rs", "status": "modified", "additions": 24, "deletions": 30, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/3662a9fb0476f5d4209ef2471b33ce4199e01fbe/src%2Flibstd%2Fsys%2Funix%2Fprocess%2Fprocess_common.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3662a9fb0476f5d4209ef2471b33ce4199e01fbe/src%2Flibstd%2Fsys%2Funix%2Fprocess%2Fprocess_common.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fprocess%2Fprocess_common.rs?ref=3662a9fb0476f5d4209ef2471b33ce4199e01fbe", "patch": "@@ -20,6 +20,30 @@ cfg_if::cfg_if! {\n     }\n }\n \n+// Android with api less than 21 define sig* functions inline, so it is not\n+// available for dynamic link. Implementing sigemptyset and sigaddset allow us\n+// to support older Android version (independent of libc version).\n+// The following implementations are based on https://git.io/vSkNf\n+cfg_if::cfg_if! {\n+    if #[cfg(target_os = \"android\")] {\n+        pub unsafe fn sigemptyset(set: *mut libc::sigset_t) -> libc::c_int {\n+            set.write_bytes(0u8, 1);\n+            return 0;\n+        }\n+        #[allow(dead_code)]\n+        pub unsafe fn sigaddset(set: *mut libc::sigset_t, signum: libc::c_int) -> libc::c_int {\n+            use crate::{slice, mem};\n+\n+            let raw = slice::from_raw_parts_mut(set as *mut u8, mem::size_of::<libc::sigset_t>());\n+            let bit = (signum - 1) as usize;\n+            raw[bit / 8] |= 1 << (bit % 8);\n+            return 0;\n+        }\n+    } else {\n+        pub use libc::{sigemptyset, sigaddset};\n+    }\n+}\n+\n ////////////////////////////////////////////////////////////////////////////////\n // Command\n ////////////////////////////////////////////////////////////////////////////////\n@@ -429,36 +453,6 @@ mod tests {\n         }\n     }\n \n-    // Android with api less than 21 define sig* functions inline, so it is not\n-    // available for dynamic link. Implementing sigemptyset and sigaddset allow us\n-    // to support older Android version (independent of libc version).\n-    // The following implementations are based on https://git.io/vSkNf\n-\n-    #[cfg(not(target_os = \"android\"))]\n-    extern {\n-        #[cfg_attr(target_os = \"netbsd\", link_name = \"__sigemptyset14\")]\n-        fn sigemptyset(set: *mut libc::sigset_t) -> libc::c_int;\n-\n-        #[cfg_attr(target_os = \"netbsd\", link_name = \"__sigaddset14\")]\n-        fn sigaddset(set: *mut libc::sigset_t, signum: libc::c_int) -> libc::c_int;\n-    }\n-\n-    #[cfg(target_os = \"android\")]\n-    unsafe fn sigemptyset(set: *mut libc::sigset_t) -> libc::c_int {\n-        set.write_bytes(0u8, 1);\n-        return 0;\n-    }\n-\n-    #[cfg(target_os = \"android\")]\n-    unsafe fn sigaddset(set: *mut libc::sigset_t, signum: libc::c_int) -> libc::c_int {\n-        use crate::slice;\n-\n-        let raw = slice::from_raw_parts_mut(set as *mut u8, mem::size_of::<libc::sigset_t>());\n-        let bit = (signum - 1) as usize;\n-        raw[bit / 8] |= 1 << (bit % 8);\n-        return 0;\n-    }\n-\n     // See #14232 for more information, but it appears that signal delivery to a\n     // newly spawned process may just be raced in the macOS, so to prevent this\n     // test from being flaky we ignore it on macOS."}, {"sha": "a9711c71b7aa36503480f97152227ae9ce6967e5", "filename": "src/libstd/sys/unix/process/process_unix.rs", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3662a9fb0476f5d4209ef2471b33ce4199e01fbe/src%2Flibstd%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3662a9fb0476f5d4209ef2471b33ce4199e01fbe/src%2Flibstd%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs?ref=3662a9fb0476f5d4209ef2471b33ce4199e01fbe", "patch": "@@ -214,14 +214,7 @@ impl Command {\n             // need to clean things up now to avoid confusing the program\n             // we're about to run.\n             let mut set = MaybeUninit::<libc::sigset_t>::uninit();\n-            if cfg!(target_os = \"android\") {\n-                // Implementing sigemptyset allow us to support older Android\n-                // versions. See the comment about Android and sig* functions in\n-                // process_common.rs\n-                set.as_mut_ptr().write_bytes(0u8, 1);\n-            } else {\n-                cvt(libc::sigemptyset(set.as_mut_ptr()))?;\n-            }\n+            cvt(sigemptyset(set.as_mut_ptr()))?;\n             cvt(libc::pthread_sigmask(libc::SIG_SETMASK, set.as_ptr(),\n                                          ptr::null_mut()))?;\n             let ret = sys::signal(libc::SIGPIPE, libc::SIG_DFL);\n@@ -363,10 +356,10 @@ impl Command {\n             }\n \n             let mut set = MaybeUninit::<libc::sigset_t>::uninit();\n-            cvt(libc::sigemptyset(set.as_mut_ptr()))?;\n+            cvt(sigemptyset(set.as_mut_ptr()))?;\n             cvt(libc::posix_spawnattr_setsigmask(attrs.0.as_mut_ptr(),\n                                                  set.as_ptr()))?;\n-            cvt(libc::sigaddset(set.as_mut_ptr(), libc::SIGPIPE))?;\n+            cvt(sigaddset(set.as_mut_ptr(), libc::SIGPIPE))?;\n             cvt(libc::posix_spawnattr_setsigdefault(attrs.0.as_mut_ptr(),\n                                                     set.as_ptr()))?;\n "}]}