{"sha": "fc641f21c2f1ba0dcf7bc7750844f097e25b3029", "node_id": "C_kwDOAAsO6NoAKGZjNjQxZjIxYzJmMWJhMGRjZjdiYzc3NTA4NDRmMDk3ZTI1YjMwMjk", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-07-06T09:15:45Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-07-06T10:15:13Z"}, "message": "ssa: remove dwo of metadata and allocator module\n\nCompiling with `-Csplit-debuginfo=packed` was leaving behind `.dwo`\nfiles because either the metadata or allocator module contained a DWARF\nobject which was not being removed by the\n`maybe_remove_temps_from_module` closure.", "tree": {"sha": "56e94dbb711142fbe28d83b5dbc6c01b6a2b01d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56e94dbb711142fbe28d83b5dbc6c01b6a2b01d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc641f21c2f1ba0dcf7bc7750844f097e25b3029", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc641f21c2f1ba0dcf7bc7750844f097e25b3029", "html_url": "https://github.com/rust-lang/rust/commit/fc641f21c2f1ba0dcf7bc7750844f097e25b3029", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc641f21c2f1ba0dcf7bc7750844f097e25b3029/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8371a036ea485ef8a830349c779e5acc116cfd8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/8371a036ea485ef8a830349c779e5acc116cfd8d", "html_url": "https://github.com/rust-lang/rust/commit/8371a036ea485ef8a830349c779e5acc116cfd8d"}], "stats": {"total": 32, "additions": 18, "deletions": 14}, "files": [{"sha": "c85c3bf571068e059c8cf1548d63bf73a9fb0dde", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 18, "deletions": 14, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/fc641f21c2f1ba0dcf7bc7750844f097e25b3029/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc641f21c2f1ba0dcf7bc7750844f097e25b3029/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=fc641f21c2f1ba0dcf7bc7750844f097e25b3029", "patch": "@@ -151,11 +151,23 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n             return;\n         }\n \n-        let remove_temps_from_module = |module: &CompiledModule| {\n-            if let Some(ref obj) = module.object {\n-                ensure_removed(sess.diagnostic(), obj);\n-            }\n-        };\n+        let maybe_remove_temps_from_module =\n+            |preserve_objects: bool, preserve_dwarf_objects: bool, module: &CompiledModule| {\n+                if !preserve_objects {\n+                    if let Some(ref obj) = module.object {\n+                        ensure_removed(sess.diagnostic(), obj);\n+                    }\n+                }\n+\n+                if !preserve_dwarf_objects {\n+                    if let Some(ref dwo_obj) = module.dwarf_object {\n+                        ensure_removed(sess.diagnostic(), dwo_obj);\n+                    }\n+                }\n+            };\n+\n+        let remove_temps_from_module =\n+            |module: &CompiledModule| maybe_remove_temps_from_module(false, false, module);\n \n         // Otherwise, always remove the metadata and allocator module temporaries.\n         if let Some(ref metadata_module) = codegen_results.metadata_module {\n@@ -177,15 +189,7 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n         debug!(?preserve_objects, ?preserve_dwarf_objects);\n \n         for module in &codegen_results.modules {\n-            if !preserve_objects {\n-                remove_temps_from_module(module);\n-            }\n-\n-            if !preserve_dwarf_objects {\n-                if let Some(ref obj) = module.dwarf_object {\n-                    ensure_removed(sess.diagnostic(), obj);\n-                }\n-            }\n+            maybe_remove_temps_from_module(preserve_objects, preserve_dwarf_objects, module);\n         }\n     });\n "}]}