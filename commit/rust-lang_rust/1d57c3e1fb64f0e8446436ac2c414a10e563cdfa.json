{"sha": "1d57c3e1fb64f0e8446436ac2c414a10e563cdfa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkNTdjM2UxZmI2NGYwZTg0NDY0MzZhYzJjNDE0YTEwZTU2M2NkZmE=", "commit": {"author": {"name": "hyd-dev", "email": "yd-huang@outlook.com", "date": "2021-03-15T10:24:28Z"}, "committer": {"name": "hyd-dev", "email": "yd-huang@outlook.com", "date": "2021-03-15T10:25:04Z"}, "message": "Use `rustc_interface::interface::Config::parse_sess_created` in Clippy", "tree": {"sha": "cc966db6f9ebce82307719ac14f28e4a6fd85bce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cc966db6f9ebce82307719ac14f28e4a6fd85bce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d57c3e1fb64f0e8446436ac2c414a10e563cdfa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d57c3e1fb64f0e8446436ac2c414a10e563cdfa", "html_url": "https://github.com/rust-lang/rust/commit/1d57c3e1fb64f0e8446436ac2c414a10e563cdfa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d57c3e1fb64f0e8446436ac2c414a10e563cdfa/comments", "author": null, "committer": null, "parents": [{"sha": "a189df12bd76565403c5c5c755f0daa947e46481", "url": "https://api.github.com/repos/rust-lang/rust/commits/a189df12bd76565403c5c5c755f0daa947e46481", "html_url": "https://github.com/rust-lang/rust/commit/a189df12bd76565403c5c5c755f0daa947e46481"}], "stats": {"total": 20, "additions": 8, "deletions": 12}, "files": [{"sha": "b6aed862e895fde53dfdeb385932acfda624cc76", "filename": "src/driver.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1d57c3e1fb64f0e8446436ac2c414a10e563cdfa/src%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d57c3e1fb64f0e8446436ac2c414a10e563cdfa/src%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver.rs?ref=1d57c3e1fb64f0e8446436ac2c414a10e563cdfa", "patch": "@@ -15,7 +15,7 @@ extern crate rustc_session;\n extern crate rustc_span;\n \n use rustc_interface::interface;\n-use rustc_session::Session;\n+use rustc_session::parse::ParseSess;\n use rustc_span::symbol::Symbol;\n use rustc_tools_util::VersionInfo;\n \n@@ -63,8 +63,8 @@ fn test_arg_value() {\n     assert_eq!(arg_value(args, \"--foo\", |_| true), None);\n }\n \n-fn track_clippy_args(sess: &Session, args_env_var: &Option<String>) {\n-    sess.parse_sess.env_depinfo.borrow_mut().insert((\n+fn track_clippy_args(parse_sess: &mut ParseSess, args_env_var: &Option<String>) {\n+    parse_sess.env_depinfo.get_mut().insert((\n         Symbol::intern(\"CLIPPY_ARGS\"),\n         args_env_var.as_deref().map(Symbol::intern),\n     ));\n@@ -81,14 +81,9 @@ struct RustcCallbacks {\n \n impl rustc_driver::Callbacks for RustcCallbacks {\n     fn config(&mut self, config: &mut interface::Config) {\n-        let previous = config.register_lints.take();\n         let clippy_args_var = self.clippy_args_var.take();\n-        config.register_lints = Some(Box::new(move |sess, lint_store| {\n-            if let Some(ref previous) = previous {\n-                (previous)(sess, lint_store);\n-            }\n-\n-            track_clippy_args(sess, &clippy_args_var);\n+        config.parse_sess_created = Some(Box::new(move |parse_sess| {\n+            track_clippy_args(parse_sess, &clippy_args_var);\n         }));\n     }\n }\n@@ -101,15 +96,16 @@ impl rustc_driver::Callbacks for ClippyCallbacks {\n     fn config(&mut self, config: &mut interface::Config) {\n         let previous = config.register_lints.take();\n         let clippy_args_var = self.clippy_args_var.take();\n+        config.parse_sess_created = Some(Box::new(move |parse_sess| {\n+            track_clippy_args(parse_sess, &clippy_args_var);\n+        }));\n         config.register_lints = Some(Box::new(move |sess, mut lint_store| {\n             // technically we're ~guaranteed that this is none but might as well call anything that\n             // is there already. Certainly it can't hurt.\n             if let Some(previous) = &previous {\n                 (previous)(sess, lint_store);\n             }\n \n-            track_clippy_args(sess, &clippy_args_var);\n-\n             let conf = clippy_lints::read_conf(&[], &sess);\n             clippy_lints::register_plugins(&mut lint_store, &sess, &conf);\n             clippy_lints::register_pre_expansion_lints(&mut lint_store);"}]}