{"sha": "e97383657e5dfaf7fdbc5bf331bd3caf574ba307", "node_id": "C_kwDOAAsO6NoAKGU5NzM4MzY1N2U1ZGZhZjdmZGJjNWJmMzMxYmQzY2FmNTc0YmEzMDc", "commit": {"author": {"name": "David Koloski", "email": "dkoloski@google.com", "date": "2023-05-03T18:56:04Z"}, "committer": {"name": "David Koloski", "email": "dkoloski@google.com", "date": "2023-05-03T18:56:04Z"}, "message": "Use builtin FFX isolation for Fuchsia test runner\n\nFFX has new builtin support for isolating the daemon's environment. This\nswitches the manual isolation originally written to that new builtin\nfeature.", "tree": {"sha": "02eeb01b50e80420ad06dffb95346c734bb95c68", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02eeb01b50e80420ad06dffb95346c734bb95c68"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e97383657e5dfaf7fdbc5bf331bd3caf574ba307", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e97383657e5dfaf7fdbc5bf331bd3caf574ba307", "html_url": "https://github.com/rust-lang/rust/commit/e97383657e5dfaf7fdbc5bf331bd3caf574ba307", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e97383657e5dfaf7fdbc5bf331bd3caf574ba307/comments", "author": null, "committer": null, "parents": [{"sha": "901fdb3b04375e3456b5cf771f86ecca8d6c1917", "url": "https://api.github.com/repos/rust-lang/rust/commits/901fdb3b04375e3456b5cf771f86ecca8d6c1917", "html_url": "https://github.com/rust-lang/rust/commit/901fdb3b04375e3456b5cf771f86ecca8d6c1917"}], "stats": {"total": 137, "additions": 45, "deletions": 92}, "files": [{"sha": "ecef56f56f1d5feb95f731c5c2d9da25f1867fb9", "filename": "src/ci/docker/scripts/fuchsia-test-runner.py", "status": "modified", "additions": 45, "deletions": 92, "changes": 137, "blob_url": "https://github.com/rust-lang/rust/blob/e97383657e5dfaf7fdbc5bf331bd3caf574ba307/src%2Fci%2Fdocker%2Fscripts%2Ffuchsia-test-runner.py", "raw_url": "https://github.com/rust-lang/rust/raw/e97383657e5dfaf7fdbc5bf331bd3caf574ba307/src%2Fci%2Fdocker%2Fscripts%2Ffuchsia-test-runner.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Ffuchsia-test-runner.py?ref=e97383657e5dfaf7fdbc5bf331bd3caf574ba307", "patch": "@@ -168,85 +168,17 @@ def ffx_daemon_log_path(self):\n     def ffx_isolate_dir(self):\n         return os.path.join(self.tmp_dir(), \"ffx_isolate\")\n \n-    def ffx_home_dir(self):\n-        return os.path.join(self.ffx_isolate_dir(), \"user-home\")\n+    def home_dir(self):\n+        return os.path.join(self.tmp_dir(), \"user-home\")\n \n-    def ffx_tmp_dir(self):\n-        return os.path.join(self.ffx_isolate_dir(), \"tmp\")\n-\n-    def ffx_log_dir(self):\n-        return os.path.join(self.ffx_isolate_dir(), \"log\")\n-\n-    def ffx_user_config_dir(self):\n-        return os.path.join(self.ffx_xdg_config_home(), \"Fuchsia\", \"ffx\", \"config\")\n-\n-    def ffx_user_config_path(self):\n-        return os.path.join(self.ffx_user_config_dir(), \"config.json\")\n-\n-    def ffx_xdg_config_home(self):\n-        if platform.system() == \"Darwin\":\n-            return os.path.join(self.ffx_home_dir(), \"Library\", \"Preferences\")\n-        return os.path.join(self.ffx_home_dir(), \".local\", \"share\")\n-\n-    def ffx_ascendd_path(self):\n-        return os.path.join(self.ffx_tmp_dir(), \"ascendd\")\n \n     def start_ffx_isolation(self):\n         # Most of this is translated directly from ffx's isolate library\n         os.mkdir(self.ffx_isolate_dir())\n-        os.mkdir(self.ffx_home_dir())\n-        os.mkdir(self.ffx_tmp_dir())\n-        os.mkdir(self.ffx_log_dir())\n-\n-        fuchsia_dir = os.path.join(self.ffx_home_dir(), \".fuchsia\")\n-        os.mkdir(fuchsia_dir)\n-\n-        fuchsia_debug_dir = os.path.join(fuchsia_dir, \"debug\")\n-        os.mkdir(fuchsia_debug_dir)\n-\n-        metrics_dir = os.path.join(fuchsia_dir, \"metrics\")\n-        os.mkdir(metrics_dir)\n+        os.mkdir(self.home_dir())\n \n-        analytics_path = os.path.join(metrics_dir, \"analytics-status\")\n-        with open(analytics_path, \"w\", encoding=\"utf-8\") as analytics_file:\n-            print(\"0\", file=analytics_file)\n-\n-        ffx_path = os.path.join(metrics_dir, \"ffx\")\n-        with open(ffx_path, \"w\", encoding=\"utf-8\") as ffx_file:\n-            print(\"1\", file=ffx_file)\n-\n-        os.makedirs(self.ffx_user_config_dir())\n-\n-        with open(\n-            self.ffx_user_config_path(), \"w\", encoding=\"utf-8\"\n-        ) as config_json_file:\n-            user_config_for_test = {\n-                \"log\": {\n-                    \"enabled\": True,\n-                    \"dir\": self.ffx_log_dir(),\n-                },\n-                \"overnet\": {\n-                    \"socket\": self.ffx_ascendd_path(),\n-                },\n-                \"ssh\": {\n-                    \"pub\": self.ssh_authfile_path(),\n-                    \"priv\": self.ssh_keyfile_path(),\n-                },\n-                \"test\": {\n-                    \"is_isolated\": True,\n-                    \"experimental_structured_output\": True,\n-                },\n-            }\n-            print(json.dumps(user_config_for_test), file=config_json_file)\n-\n-        ffx_env_path = os.path.join(self.ffx_user_config_dir(), \".ffx_env\")\n-        with open(ffx_env_path, \"w\", encoding=\"utf-8\") as ffx_env_file:\n-            ffx_env_config_for_test = {\n-                \"user\": self.ffx_user_config_path(),\n-                \"build\": None,\n-                \"global\": None,\n-            }\n-            print(json.dumps(ffx_env_config_for_test), file=ffx_env_file)\n+        ffx_path = self.tool_path(\"ffx\")\n+        ffx_env = self.ffx_cmd_env()\n \n         # Start ffx daemon\n         # We want this to be a long-running process that persists after the script finishes\n@@ -256,38 +188,65 @@ def start_ffx_isolation(self):\n         ) as ffx_daemon_log_file:\n             subprocess.Popen(\n                 [\n-                    self.tool_path(\"ffx\"),\n-                    \"--config\",\n-                    self.ffx_user_config_path(),\n+                    ffx_path,\n                     \"daemon\",\n                     \"start\",\n                 ],\n-                env=self.ffx_cmd_env(),\n+                env=ffx_env,\n                 stdout=ffx_daemon_log_file,\n                 stderr=ffx_daemon_log_file,\n             )\n \n+        # Disable analytics\n+        subprocess.check_call(\n+            [\n+                ffx_path,\n+                \"config\",\n+                \"analytics\",\n+                \"disable\",\n+            ],\n+            env=ffx_env,\n+            stdout=self.subprocess_output(),\n+            stderr=self.subprocess_output(),\n+        )\n+\n+        # Set configs\n+        configs = {\n+            \"log.enabled\": \"true\",\n+            \"ssh.pub\": self.ssh_authfile_path(),\n+            \"ssh.priv\": self.ssh_keyfile_path(),\n+            \"test.is_isolated\": \"true\",\n+            \"test.experimental_structured_output\": \"true\",\n+        }\n+        for key, value in configs.items():\n+            subprocess.check_call(\n+                [\n+                    self.tool_path(\"ffx\"),\n+                    \"config\",\n+                    \"set\",\n+                    key,\n+                    value,\n+                ],\n+                env=self.ffx_cmd_env(),\n+                stdout=self.subprocess_output(),\n+                stderr=self.subprocess_output(),\n+            )\n+\n     def ffx_cmd_env(self):\n-        result = {\n-            \"HOME\": self.ffx_home_dir(),\n-            \"XDG_CONFIG_HOME\": self.ffx_xdg_config_home(),\n-            \"ASCENDD\": self.ffx_ascendd_path(),\n-            \"FUCHSIA_SSH_KEY\": self.ssh_keyfile_path(),\n+        return {\n+            \"HOME\": self.home_dir(),\n+            \"FFX_ISOLATE_DIR\": self.ffx_isolate_dir(),\n             # We want to use our own specified temp directory\n             \"TMP\": self.tmp_dir(),\n             \"TEMP\": self.tmp_dir(),\n             \"TMPDIR\": self.tmp_dir(),\n             \"TEMPDIR\": self.tmp_dir(),\n         }\n \n-        return result\n-\n     def stop_ffx_isolation(self):\n         subprocess.check_call(\n             [\n                 self.tool_path(\"ffx\"),\n-                \"--config\",\n-                self.ffx_user_config_path(),\n                 \"daemon\",\n                 \"stop\",\n             ],\n@@ -709,8 +668,6 @@ def log(msg):\n             subprocess.run(\n                 [\n                     self.tool_path(\"ffx\"),\n-                    \"--config\",\n-                    self.ffx_user_config_path(),\n                     \"test\",\n                     \"run\",\n                     f\"fuchsia-pkg://{self.TEST_REPO_NAME}/{package_name}#meta/{package_name}.cm\",\n@@ -849,8 +806,6 @@ def delete_tmp(self):\n     def debug(self, args):\n         command = [\n             self.tool_path(\"ffx\"),\n-            \"--config\",\n-            self.ffx_user_config_path(),\n             \"debug\",\n             \"connect\",\n             \"--\",\n@@ -948,8 +903,6 @@ def syslog(self, args):\n         subprocess.run(\n             [\n                 self.tool_path(\"ffx\"),\n-                \"--config\",\n-                self.ffx_user_config_path(),\n                 \"log\",\n                 \"--since\",\n                 \"now\","}]}