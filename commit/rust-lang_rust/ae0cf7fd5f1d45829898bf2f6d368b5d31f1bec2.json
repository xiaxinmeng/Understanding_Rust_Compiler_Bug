{"sha": "ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFlMGNmN2ZkNWYxZDQ1ODI5ODk4YmYyZjZkMzY4YjVkMzFmMWJlYzI=", "commit": {"author": {"name": "Petr Hosek", "email": "phosek@google.com", "date": "2017-09-18T03:02:14Z"}, "committer": {"name": "James Tucker", "email": "jftucker@gmail.com", "date": "2017-09-24T20:53:10Z"}, "message": "Update Fuchsia toolchain build\n\ncompiler-rt is now being built as part of the toolchain itself.", "tree": {"sha": "33b29fa945f1df39335d9b95a940384e0e5b3502", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33b29fa945f1df39335d9b95a940384e0e5b3502"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2", "html_url": "https://github.com/rust-lang/rust/commit/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2/comments", "author": {"login": "petrhosek", "id": 283696, "node_id": "MDQ6VXNlcjI4MzY5Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/283696?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrhosek", "html_url": "https://github.com/petrhosek", "followers_url": "https://api.github.com/users/petrhosek/followers", "following_url": "https://api.github.com/users/petrhosek/following{/other_user}", "gists_url": "https://api.github.com/users/petrhosek/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrhosek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrhosek/subscriptions", "organizations_url": "https://api.github.com/users/petrhosek/orgs", "repos_url": "https://api.github.com/users/petrhosek/repos", "events_url": "https://api.github.com/users/petrhosek/events{/privacy}", "received_events_url": "https://api.github.com/users/petrhosek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "raggi", "id": 348, "node_id": "MDQ6VXNlcjM0OA==", "avatar_url": "https://avatars.githubusercontent.com/u/348?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raggi", "html_url": "https://github.com/raggi", "followers_url": "https://api.github.com/users/raggi/followers", "following_url": "https://api.github.com/users/raggi/following{/other_user}", "gists_url": "https://api.github.com/users/raggi/gists{/gist_id}", "starred_url": "https://api.github.com/users/raggi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raggi/subscriptions", "organizations_url": "https://api.github.com/users/raggi/orgs", "repos_url": "https://api.github.com/users/raggi/repos", "events_url": "https://api.github.com/users/raggi/events{/privacy}", "received_events_url": "https://api.github.com/users/raggi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "20265ef3ac5ecaa51cac6cee45d714ea49d3db31", "url": "https://api.github.com/repos/rust-lang/rust/commits/20265ef3ac5ecaa51cac6cee45d714ea49d3db31", "html_url": "https://github.com/rust-lang/rust/commit/20265ef3ac5ecaa51cac6cee45d714ea49d3db31"}], "stats": {"total": 131, "additions": 28, "deletions": 103}, "files": [{"sha": "2cb186c168338d4f63d8556714a7835178bcf7f1", "filename": "src/ci/docker/dist-fuchsia/Dockerfile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile?ref=ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2", "patch": "@@ -17,11 +17,11 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   libncurses5-dev \\\n   patch\n \n-RUN curl -L https://cmake.org/files/v3.8/cmake-3.8.0-rc1-Linux-x86_64.tar.gz | \\\n+RUN curl -L https://cmake.org/files/v3.9/cmake-3.9.2-Linux-x86_64.tar.gz | \\\n       tar xzf - -C /usr/local --strip-components=1\n \n WORKDIR /tmp\n-COPY dist-fuchsia/shared.sh dist-fuchsia/build-toolchain.sh dist-fuchsia/compiler-rt-dso-handle.patch /tmp/\n+COPY dist-fuchsia/shared.sh dist-fuchsia/build-toolchain.sh /tmp/\n RUN /tmp/build-toolchain.sh\n \n COPY scripts/sccache.sh /scripts/"}, {"sha": "57fd25c1a21cab5c9ef04d2f0b07724276ce9537", "filename": "src/ci/docker/dist-fuchsia/build-toolchain.sh", "status": "modified", "additions": 26, "deletions": 60, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh?ref=ae0cf7fd5f1d45829898bf2f6d368b5d31f1bec2", "patch": "@@ -17,14 +17,14 @@ source shared.sh\n # Download sources\n SRCS=(\n   \"https://fuchsia.googlesource.com/zircon zircon e9a26dbc70d631029f8ee9763103910b7e3a2fe1\"\n-  \"https://llvm.googlesource.com/llvm llvm 3f58a16d8eec385e2b3ebdfbb84ff9d3bf27e025\"\n-  \"https://llvm.googlesource.com/clang llvm/tools/clang 727ea63e6e82677f6e10e05e08bc7d6bdbae3111\"\n-  \"https://llvm.googlesource.com/lld llvm/tools/lld a31286c1366e5e89b8872803fded13805a1a084b\"\n-  \"https://llvm.googlesource.com/lldb llvm/tools/lldb 0b2384abec4cb99ad66687712e07dee4dd9d187e\"\n-  \"https://llvm.googlesource.com/compiler-rt llvm/runtimes/compiler-rt 9093a35c599fe41278606a20b51095ea8bd5a081\"\n-  \"https://llvm.googlesource.com/libcxx llvm/runtimes/libcxx 607e0c71ec4f7fd377ad3f6c47b08dbe89f66eaa\"\n-  \"https://llvm.googlesource.com/libcxxabi llvm/runtimes/libcxxabi 0a3a1a8a5ca5ef69e0f6b7d5b9d13e63e6fd2c19\"\n-  \"https://llvm.googlesource.com/libunwind llvm/runtimes/libunwind e128003563d99d9ee62247c4cee40f07d21c03e3\"\n+  \"https://llvm.googlesource.com/llvm llvm 65bdf0ae4a87e6992c24f06e2612909952468710\"\n+  \"https://llvm.googlesource.com/clang llvm/tools/clang 914987de45cf83636537909ce09156aa7a37d6ec\"\n+  \"https://llvm.googlesource.com/lld llvm/tools/lld f8ed4483c589b390daafac92e28f4680ad052643\"\n+  \"https://llvm.googlesource.com/lldb llvm/tools/lldb 55cf8753321782668cb7e2d879457ee1ad57a2b9\"\n+  \"https://llvm.googlesource.com/compiler-rt llvm/runtimes/compiler-rt a8682fdf74d3cb93769b7394f2cdffc5cefb8bd8\"\n+  \"https://llvm.googlesource.com/libcxx llvm/runtimes/libcxx 5f919fe349450b3da0e29611ae37f6a940179290\"\n+  \"https://llvm.googlesource.com/libcxxabi llvm/runtimes/libcxxabi caa78daf9285dada17e3e6b8aebcf7d128427f83\"\n+  \"https://llvm.googlesource.com/libunwind llvm/runtimes/libunwind 469bacd2ea64679c15bb4d86adf000f2f2c27328\"\n )\n \n fetch() {\n@@ -41,27 +41,7 @@ for i in \"${SRCS[@]}\"; do\n   fetch $i\n done\n \n-# Remove this once https://reviews.llvm.org/D28791 is resolved\n-cd llvm/runtimes/compiler-rt\n-patch -Np1 < /tmp/compiler-rt-dso-handle.patch\n-cd ../../..\n-\n-# Build toolchain\n-cd llvm\n-mkdir build\n-cd build\n-hide_output cmake -GNinja \\\n-  -DFUCHSIA_SYSROOT=${PWD}/../../zircon/third_party/ulib/musl \\\n-  -DLLVM_ENABLE_LTO=OFF \\\n-  -DCLANG_BOOTSTRAP_PASSTHROUGH=LLVM_ENABLE_LTO \\\n-  -C ../tools/clang/cmake/caches/Fuchsia.cmake \\\n-  ..\n-hide_output ninja stage2-distribution\n-hide_output ninja stage2-install-distribution\n-cd ../..\n-\n # Build sysroot\n-rm -rf llvm/runtimes/compiler-rt\n ./zircon/scripts/download-toolchain\n \n build_sysroot() {\n@@ -77,40 +57,26 @@ build_sysroot() {\n   mkdir -p $dst\n   cp -r zircon/build-${tgt}/sysroot/include $dst/\n   cp -r zircon/build-${tgt}/sysroot/lib $dst/\n-\n-  cd llvm\n-  mkdir build-runtimes-${arch}\n-  cd build-runtimes-${arch}\n-  hide_output cmake -GNinja \\\n-    -DCMAKE_C_COMPILER=clang \\\n-    -DCMAKE_CXX_COMPILER=clang++ \\\n-    -DCMAKE_AR=/usr/local/bin/llvm-ar \\\n-    -DCMAKE_RANLIB=/usr/local/bin/llvm-ranlib \\\n-    -DCMAKE_INSTALL_PREFIX= \\\n-    -DLLVM_MAIN_SRC_DIR=${PWD}/.. \\\n-    -DLLVM_BINARY_DIR=${PWD}/../build \\\n-    -DLLVM_ENABLE_WERROR=OFF \\\n-    -DCMAKE_BUILD_TYPE=Release \\\n-    -DLLVM_INCLUDE_TESTS=ON \\\n-    -DCMAKE_SYSTEM_NAME=Fuchsia \\\n-    -DCMAKE_C_COMPILER_TARGET=${arch}-fuchsia \\\n-    -DCMAKE_CXX_COMPILER_TARGET=${arch}-fuchsia \\\n-    -DUNIX=1 \\\n-    -DLIBCXX_HAS_MUSL_LIBC=ON \\\n-    -DLIBCXXABI_USE_LLVM_UNWINDER=ON \\\n-    -DCMAKE_SYSROOT=${dst} \\\n-    -DCMAKE_C_COMPILER_FORCED=TRUE \\\n-    -DCMAKE_CXX_COMPILER_FORCED=TRUE \\\n-    -DLLVM_ENABLE_LIBCXX=ON \\\n-    -DCMAKE_EXE_LINKER_FLAGS=\"-nodefaultlibs -lc\" \\\n-    -DCMAKE_SHARED_LINKER_FLAGS=\"$(clang --target=${arch}-fuchsia -print-libgcc-file-name)\" \\\n-    ../runtimes\n-  hide_output env DESTDIR=\"${dst}\" ninja install\n-  cd ../..\n }\n \n-build_sysroot \"x86_64\"\n-build_sysroot \"aarch64\"\n+for arch in x86_64 aarch64; do\n+  build_sysroot ${arch}\n+done\n+\n+# Build toolchain\n+cd llvm\n+mkdir build\n+cd build\n+hide_output cmake -GNinja \\\n+  -DFUCHSIA_x86_64_SYSROOT=/usr/local/x86_64-unknown-fuchsia \\\n+  -DFUCHSIA_aarch64_SYSROOT=/usr/local/aarch64-unknown-fuchsia \\\n+  -DLLVM_ENABLE_LTO=OFF \\\n+  -DCLANG_BOOTSTRAP_PASSTHROUGH=LLVM_ENABLE_LTO \\\n+  -C ../tools/clang/cmake/caches/Fuchsia.cmake \\\n+  ..\n+hide_output ninja stage2-distribution\n+hide_output ninja stage2-install-distribution\n+cd ../..\n \n rm -rf zircon llvm\n "}, {"sha": "0b702894bb216481125219d51de73ce4fb69cf4d", "filename": "src/ci/docker/dist-fuchsia/compiler-rt-dso-handle.patch", "status": "removed", "additions": 0, "deletions": 41, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/20265ef3ac5ecaa51cac6cee45d714ea49d3db31/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fcompiler-rt-dso-handle.patch", "raw_url": "https://github.com/rust-lang/rust/raw/20265ef3ac5ecaa51cac6cee45d714ea49d3db31/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fcompiler-rt-dso-handle.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fcompiler-rt-dso-handle.patch?ref=20265ef3ac5ecaa51cac6cee45d714ea49d3db31", "patch": "@@ -1,41 +0,0 @@\n-diff --git a/lib/builtins/CMakeLists.txt b/lib/builtins/CMakeLists.txt\n-index fc4384af2..b442264c0 100644\n---- a/lib/builtins/CMakeLists.txt\n-+++ b/lib/builtins/CMakeLists.txt\n-@@ -194,6 +194,12 @@ if(APPLE)\n-     atomic_thread_fence.c)\n- endif()\n- \n-+if(FUCHSIA)\n-+  set(GENERIC_SOURCES\n-+    ${GENERIC_SOURCES}\n-+    dso_handle.c)\n-+endif()\n-+\n- if(NOT WIN32 OR MINGW)\n-   set(GENERIC_SOURCES\n-       ${GENERIC_SOURCES}\n-diff --git a/lib/builtins/dso_handle.c b/lib/builtins/dso_handle.c\n-new file mode 100644\n-index 000000000..7766cd0aa\n---- /dev/null\n-+++ b/lib/builtins/dso_handle.c\n-@@ -0,0 +1,18 @@\n-+/* ===-- dso_handle.c - Provide __dso_handle -------------------------------===\n-+ *\n-+ *               The LLVM Compiler Infrastructure\n-+ *\n-+ * This file is dual licensed under the MIT and the University of Illinois Open\n-+ * Source Licenses. See LICENSE.TXT for details.\n-+ *\n-+ * ===----------------------------------------------------------------------===\n-+ */\n-+\n-+/* __dso_handle symbol is mandated by C++ ABI with a value which is an address\n-+ * in one of the object's segments, and as such this symbol has to be included\n-+ * statically and cannot be a part of a shared library. Traditionally, it has\n-+ * been defined in crtbegin.o but there's no principled reason for it to be\n-+ * there. We defined this symbol in the builtin library which is built as a\n-+ * static library and always included in the final link.\n-+ */\n-+__attribute__((visibility(\"hidden\"))) void *const __dso_handle;"}]}