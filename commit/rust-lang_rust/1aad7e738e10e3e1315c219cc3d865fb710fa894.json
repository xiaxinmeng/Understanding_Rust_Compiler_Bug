{"sha": "1aad7e738e10e3e1315c219cc3d865fb710fa894", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhYWQ3ZTczOGUxMGUzZTEzMTVjMjE5Y2MzZDg2NWZiNzEwZmE4OTQ=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-03-22T18:21:55Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-03-22T20:31:00Z"}, "message": "Err if the debugging options are not passed.", "tree": {"sha": "b0af4fa24e3e78b9da1cfc4c422eec8704375a33", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0af4fa24e3e78b9da1cfc4c422eec8704375a33"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1aad7e738e10e3e1315c219cc3d865fb710fa894", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1aad7e738e10e3e1315c219cc3d865fb710fa894", "html_url": "https://github.com/rust-lang/rust/commit/1aad7e738e10e3e1315c219cc3d865fb710fa894", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1aad7e738e10e3e1315c219cc3d865fb710fa894/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "219603a958f2deafd961e746b5ec963c11c44823", "url": "https://api.github.com/repos/rust-lang/rust/commits/219603a958f2deafd961e746b5ec963c11c44823", "html_url": "https://github.com/rust-lang/rust/commit/219603a958f2deafd961e746b5ec963c11c44823"}], "stats": {"total": 69, "additions": 68, "deletions": 1}, "files": [{"sha": "a86de6fc6f36856e5d29ddce61a28ad480649429", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1aad7e738e10e3e1315c219cc3d865fb710fa894/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aad7e738e10e3e1315c219cc3d865fb710fa894/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=1aad7e738e10e3e1315c219cc3d865fb710fa894", "patch": "@@ -99,6 +99,12 @@ impl CheckAttrVisitor<'tcx> {\n                 self.check_naked(hir_id, attr, span, target)\n             } else if self.tcx.sess.check_name(attr, sym::rustc_legacy_const_generics) {\n                 self.check_rustc_legacy_const_generics(&attr, span, target, item)\n+            } else if self.tcx.sess.check_name(attr, sym::rustc_clean)\n+                || self.tcx.sess.check_name(attr, sym::rustc_dirty)\n+                || self.tcx.sess.check_name(attr, sym::rustc_if_this_changed)\n+                || self.tcx.sess.check_name(attr, sym::rustc_then_this_would_need)\n+            {\n+                self.check_rustc_dirty_clean(&attr)\n             } else {\n                 // lint-only checks\n                 if self.tcx.sess.check_name(attr, sym::cold) {\n@@ -1012,6 +1018,19 @@ impl CheckAttrVisitor<'tcx> {\n         }\n     }\n \n+    /// Checks if `#[rustc_legacy_const_generics]` is applied to a function and has a valid argument.\n+    fn check_rustc_dirty_clean(&self, attr: &Attribute) -> bool {\n+        if self.tcx.sess.opts.debugging_opts.query_dep_graph {\n+            true\n+        } else {\n+            self.tcx\n+                .sess\n+                .struct_span_err(attr.span, \"attribute requires -Z query-dep-graph to be enabled\")\n+                .emit();\n+            false\n+        }\n+    }\n+\n     /// Checks if `#[link_section]` is applied to a function or static.\n     fn check_link_section(&self, hir_id: HirId, attr: &Attribute, span: &Span, target: Target) {\n         match target {"}, {"sha": "4f5f6169f36bf6d4d60ade5f535a12f525759aed", "filename": "src/test/incremental/ich_nested_items.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fincremental%2Fich_nested_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fincremental%2Fich_nested_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fich_nested_items.rs?ref=1aad7e738e10e3e1315c219cc3d865fb710fa894", "patch": "@@ -3,6 +3,7 @@\n \n // revisions: cfail1 cfail2\n // build-pass (FIXME(62277): could be check-pass?)\n+// compile-flags: -Z query-dep-graph\n \n #![crate_type = \"rlib\"]\n #![feature(rustc_attrs)]"}, {"sha": "1fb0f8aa84d11245360575117a4826cf275c64c5", "filename": "src/test/incremental/ich_resolve_results.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fincremental%2Fich_resolve_results.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fincremental%2Fich_resolve_results.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fich_resolve_results.rs?ref=1aad7e738e10e3e1315c219cc3d865fb710fa894", "patch": "@@ -2,6 +2,7 @@\n // `use` to something different.\n \n // revisions: rpass1 rpass2 rpass3\n+// compile-flags: -Z query-dep-graph\n \n #![feature(rustc_attrs)]\n "}, {"sha": "37728af95164f4861bea8b6d6cc5878dfd4bf6b0", "filename": "src/test/incremental/spans_significant_w_panic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fincremental%2Fspans_significant_w_panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fincremental%2Fspans_significant_w_panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fspans_significant_w_panic.rs?ref=1aad7e738e10e3e1315c219cc3d865fb710fa894", "patch": "@@ -3,7 +3,7 @@\n \n // revisions:rpass1 rpass2\n \n-// compile-flags: -C overflow-checks=on\n+// compile-flags: -C overflow-checks=on -Z query-dep-graph\n \n #![feature(rustc_attrs)]\n "}, {"sha": "1026efc1b1dbe15e51d8af4eeb21ae9c4354bd15", "filename": "src/test/ui/dep-graph/dep-graph-check-attr.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.rs?ref=1aad7e738e10e3e1315c219cc3d865fb710fa894", "patch": "@@ -0,0 +1,20 @@\n+// Test that using rustc_clean/dirty/if_this_changed/then_this_would_need\n+// are forbidden when `-Z query-dep-graph` is not enabled.\n+\n+#![feature(rustc_attrs)]\n+#![allow(dead_code)]\n+#![allow(unused_variables)]\n+\n+#[rustc_dirty(hir_owner)] //~ ERROR attribute requires -Z query-dep-graph\n+fn main() {}\n+\n+#[rustc_if_this_changed(hir_owner)] //~ ERROR attribute requires -Z query-dep-graph\n+struct Foo<T> {\n+    f: T,\n+}\n+\n+#[rustc_clean(hir_owner)] //~ ERROR attribute requires -Z query-dep-graph\n+type TypeAlias<T> = Foo<T>;\n+\n+#[rustc_then_this_would_need(variances_of)] //~ ERROR attribute requires -Z query-dep-graph\n+trait Use<T> {}"}, {"sha": "945a4237c1298380e88cc2f0287f58e8cb9470a3", "filename": "src/test/ui/dep-graph/dep-graph-check-attr.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1aad7e738e10e3e1315c219cc3d865fb710fa894/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.stderr?ref=1aad7e738e10e3e1315c219cc3d865fb710fa894", "patch": "@@ -0,0 +1,26 @@\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:8:1\n+   |\n+LL | #[rustc_dirty(hir_owner)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:11:1\n+   |\n+LL | #[rustc_if_this_changed(hir_owner)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:16:1\n+   |\n+LL | #[rustc_clean(hir_owner)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:19:1\n+   |\n+LL | #[rustc_then_this_would_need(variances_of)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 4 previous errors\n+"}]}