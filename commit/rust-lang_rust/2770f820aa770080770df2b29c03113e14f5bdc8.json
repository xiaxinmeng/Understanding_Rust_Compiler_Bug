{"sha": "2770f820aa770080770df2b29c03113e14f5bdc8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3NzBmODIwYWE3NzAwODA3NzBkZjJiMjljMDMxMTNlMTRmNWJkYzg=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-04-30T18:15:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-30T18:15:26Z"}, "message": "Rollup merge of #71559 - dillona:detect_git_progress_version, r=Mark-Simulacrum\n\nDetect git version before attempting to use --progress\n\nOtherwise each update is run twice and errors are printed\n\nI've tested this with:\ngit version 2.8.2.windows.1 (Windows)\ngit version 2.26.2.266.ge870325ee8 (Linux built from source)\ngit version 2.17.1 (Linux)\ngit version 2.21.1 (Apple Git-122.3) (MacOS)\n\nI've tested with Python 2.7 (Windows, Linux, MacOS), 3.6 (Linux), and 3.7 (MacOS)", "tree": {"sha": "0778a12b70e34e59dea3484f391271264a8cc6a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0778a12b70e34e59dea3484f391271264a8cc6a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2770f820aa770080770df2b29c03113e14f5bdc8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeqxW+CRBK7hj4Ov3rIwAAdHIIAJ6evBw6Vqz6UOrM5pr5dJRe\noN5qxXVPaHj19gCeB0aSi0YV7hukMHqAZxnb3ffFZVMRWl0f+/O3p2p1i2ig0GXq\noPdYPrdn8as36K1YB7475Ie1DvxzJhQzEwu0UAmsaJcABKl+bn3IwwhApzWodFR8\n/jUW/FFcFHxo989+B18rxQDHv9ltAJFeEtxnGQnHxU/QP1O1iLgoRuHIvTSSFvbF\nUlEPeaxX9ZXhGFlQl9uh3IVL7ry/SeNgvNwmAA46A94f1vpjb8Dq6j+B+58uId4T\nk2HyjvP0DYk9r1OG3zwEoYfTn5SoXBwe4rxGVvVZxy0YR7Gp/SHlmb7i8aBDX20=\n=WtNC\n-----END PGP SIGNATURE-----\n", "payload": "tree 0778a12b70e34e59dea3484f391271264a8cc6a8\nparent 5e53f80d6e72b7582239df39e26695c668a2c5e4\nparent 7ac093fda9f458ac4c9d5bd52e44d1247627a3b6\nauthor Dylan DPC <dylan.dpc@gmail.com> 1588270526 +0200\ncommitter GitHub <noreply@github.com> 1588270526 +0200\n\nRollup merge of #71559 - dillona:detect_git_progress_version, r=Mark-Simulacrum\n\nDetect git version before attempting to use --progress\n\nOtherwise each update is run twice and errors are printed\n\nI've tested this with:\ngit version 2.8.2.windows.1 (Windows)\ngit version 2.26.2.266.ge870325ee8 (Linux built from source)\ngit version 2.17.1 (Linux)\ngit version 2.21.1 (Apple Git-122.3) (MacOS)\n\nI've tested with Python 2.7 (Windows, Linux, MacOS), 3.6 (Linux), and 3.7 (MacOS)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2770f820aa770080770df2b29c03113e14f5bdc8", "html_url": "https://github.com/rust-lang/rust/commit/2770f820aa770080770df2b29c03113e14f5bdc8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2770f820aa770080770df2b29c03113e14f5bdc8/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5e53f80d6e72b7582239df39e26695c668a2c5e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e53f80d6e72b7582239df39e26695c668a2c5e4", "html_url": "https://github.com/rust-lang/rust/commit/5e53f80d6e72b7582239df39e26695c668a2c5e4"}, {"sha": "7ac093fda9f458ac4c9d5bd52e44d1247627a3b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ac093fda9f458ac4c9d5bd52e44d1247627a3b6", "html_url": "https://github.com/rust-lang/rust/commit/7ac093fda9f458ac4c9d5bd52e44d1247627a3b6"}], "stats": {"total": 26, "additions": 15, "deletions": 11}, "files": [{"sha": "2aa3f9c7ec04b3859d5b4a47264a9b36e1ccf874", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/2770f820aa770080770df2b29c03113e14f5bdc8/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/2770f820aa770080770df2b29c03113e14f5bdc8/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=2770f820aa770080770df2b29c03113e14f5bdc8", "patch": "@@ -2,6 +2,7 @@\n import argparse\n import contextlib\n import datetime\n+import distutils.version\n import hashlib\n import os\n import re\n@@ -331,6 +332,7 @@ def __init__(self):\n         self.use_locked_deps = ''\n         self.use_vendored_sources = ''\n         self.verbose = False\n+        self.git_version = None\n \n     def download_stage0(self):\n         \"\"\"Fetch the build system for Rust, written in Rust\n@@ -743,15 +745,13 @@ def update_submodule(self, module, checked_out, recorded_submodules):\n \n         run([\"git\", \"submodule\", \"-q\", \"sync\", module],\n             cwd=self.rust_root, verbose=self.verbose)\n-        try:\n-            run([\"git\", \"submodule\", \"update\",\n-                 \"--init\", \"--recursive\", \"--progress\", module],\n-                cwd=self.rust_root, verbose=self.verbose, exception=True)\n-        except RuntimeError:\n-            # Some versions of git don't support --progress.\n-            run([\"git\", \"submodule\", \"update\",\n-                 \"--init\", \"--recursive\", module],\n-                cwd=self.rust_root, verbose=self.verbose)\n+\n+        update_args = [\"git\", \"submodule\", \"update\", \"--init\", \"--recursive\"]\n+        if self.git_version >= distutils.version.LooseVersion(\"2.11.0\"):\n+            update_args.append(\"--progress\")\n+        update_args.append(module)\n+        run(update_args, cwd=self.rust_root, verbose=self.verbose, exception=True)\n+\n         run([\"git\", \"reset\", \"-q\", \"--hard\"],\n             cwd=module_path, verbose=self.verbose)\n         run([\"git\", \"clean\", \"-qdfx\"],\n@@ -763,9 +763,13 @@ def update_submodules(self):\n                 self.get_toml('submodules') == \"false\":\n             return\n \n-        # check the existence of 'git' command\n+        default_encoding = sys.getdefaultencoding()\n+\n+        # check the existence and version of 'git' command\n         try:\n-            subprocess.check_output(['git', '--version'])\n+            git_version_output = subprocess.check_output(['git', '--version'])\n+            git_version_str = git_version_output.strip().split()[2].decode(default_encoding)\n+            self.git_version = distutils.version.LooseVersion(git_version_str)\n         except (subprocess.CalledProcessError, OSError):\n             print(\"error: `git` is not found, please make sure it's installed and in the path.\")\n             sys.exit(1)"}]}