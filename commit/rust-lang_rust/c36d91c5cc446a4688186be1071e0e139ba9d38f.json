{"sha": "c36d91c5cc446a4688186be1071e0e139ba9d38f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzNmQ5MWM1Y2M0NDZhNDY4ODE4NmJlMTA3MWUwZTEzOWJhOWQzOGY=", "commit": {"author": {"name": "Andr\u00e9 Vicente Milack", "email": "andre@jungledevs.com", "date": "2019-03-06T19:22:28Z"}, "committer": {"name": "Andr\u00e9 Vicente Milack", "email": "andre@jungledevs.com", "date": "2019-03-06T19:37:15Z"}, "message": "Fix buffer invalidation at BufReader.read_vectored", "tree": {"sha": "57761b657bed34530aa949c67e755c96574184bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57761b657bed34530aa949c67e755c96574184bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c36d91c5cc446a4688186be1071e0e139ba9d38f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c36d91c5cc446a4688186be1071e0e139ba9d38f", "html_url": "https://github.com/rust-lang/rust/commit/c36d91c5cc446a4688186be1071e0e139ba9d38f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c36d91c5cc446a4688186be1071e0e139ba9d38f/comments", "author": {"login": "andre-vm", "id": 10947510, "node_id": "MDQ6VXNlcjEwOTQ3NTEw", "avatar_url": "https://avatars.githubusercontent.com/u/10947510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andre-vm", "html_url": "https://github.com/andre-vm", "followers_url": "https://api.github.com/users/andre-vm/followers", "following_url": "https://api.github.com/users/andre-vm/following{/other_user}", "gists_url": "https://api.github.com/users/andre-vm/gists{/gist_id}", "starred_url": "https://api.github.com/users/andre-vm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andre-vm/subscriptions", "organizations_url": "https://api.github.com/users/andre-vm/orgs", "repos_url": "https://api.github.com/users/andre-vm/repos", "events_url": "https://api.github.com/users/andre-vm/events{/privacy}", "received_events_url": "https://api.github.com/users/andre-vm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "andre-vm", "id": 10947510, "node_id": "MDQ6VXNlcjEwOTQ3NTEw", "avatar_url": "https://avatars.githubusercontent.com/u/10947510?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andre-vm", "html_url": "https://github.com/andre-vm", "followers_url": "https://api.github.com/users/andre-vm/followers", "following_url": "https://api.github.com/users/andre-vm/following{/other_user}", "gists_url": "https://api.github.com/users/andre-vm/gists{/gist_id}", "starred_url": "https://api.github.com/users/andre-vm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andre-vm/subscriptions", "organizations_url": "https://api.github.com/users/andre-vm/orgs", "repos_url": "https://api.github.com/users/andre-vm/repos", "events_url": "https://api.github.com/users/andre-vm/events{/privacy}", "received_events_url": "https://api.github.com/users/andre-vm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96e361f6f4319782159164ceac6e1d660e383fcb", "url": "https://api.github.com/repos/rust-lang/rust/commits/96e361f6f4319782159164ceac6e1d660e383fcb", "html_url": "https://github.com/rust-lang/rust/commit/96e361f6f4319782159164ceac6e1d660e383fcb"}], "stats": {"total": 20, "additions": 11, "deletions": 9}, "files": [{"sha": "fd4b582d7f2da042c2679ecf7cf361e21b93c645", "filename": "src/libstd/io/buffered.rs", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c36d91c5cc446a4688186be1071e0e139ba9d38f/src%2Flibstd%2Fio%2Fbuffered.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c36d91c5cc446a4688186be1071e0e139ba9d38f/src%2Flibstd%2Fio%2Fbuffered.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fbuffered.rs?ref=c36d91c5cc446a4688186be1071e0e139ba9d38f", "patch": "@@ -191,6 +191,13 @@ impl<R: Read> BufReader<R> {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     pub fn into_inner(self) -> R { self.inner }\n+\n+    /// Invalidates all data in the internal buffer.\n+    #[inline]\n+    fn discard_buffer(&mut self) {\n+        self.pos = 0;\n+        self.cap = 0;\n+    }\n }\n \n impl<R: Seek> BufReader<R> {\n@@ -225,9 +232,7 @@ impl<R: Read> Read for BufReader<R> {\n         // (larger than our internal buffer), bypass our internal buffer\n         // entirely.\n         if self.pos == self.cap && buf.len() >= self.buf.len() {\n-            // Empty the buffer\n-            self.cap = 0;\n-            self.pos = 0;\n+            self.discard_buffer();\n             return self.inner.read(buf);\n         }\n         let nread = {\n@@ -241,6 +246,7 @@ impl<R: Read> Read for BufReader<R> {\n     fn read_vectored(&mut self, bufs: &mut [IoVecMut<'_>]) -> io::Result<usize> {\n         let total_len = bufs.iter().map(|b| b.len()).sum::<usize>();\n         if self.pos == self.cap && total_len >= self.buf.len() {\n+            self.discard_buffer();\n             return self.inner.read_vectored(bufs);\n         }\n         let nread = {\n@@ -326,18 +332,14 @@ impl<R: Seek> Seek for BufReader<R> {\n             } else {\n                 // seek backwards by our remainder, and then by the offset\n                 self.inner.seek(SeekFrom::Current(-remainder))?;\n-                // Empty the buffer\n-                self.cap = 0;\n-                self.pos = 0;\n+                self.discard_buffer();\n                 result = self.inner.seek(SeekFrom::Current(n))?;\n             }\n         } else {\n             // Seeking with Start/End doesn't care about our buffer length.\n             result = self.inner.seek(pos)?;\n         }\n-        // Empty the buffer\n-        self.cap = 0;\n-        self.pos = 0;\n+        self.discard_buffer();\n         Ok(result)\n     }\n }"}]}