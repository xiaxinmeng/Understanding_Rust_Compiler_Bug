{"sha": "a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2ZDY5NGVhMDA5NWJlNzNhZmY5YzI5Y2NjMmQ1ZGEyNjBiM2JmYWU=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "arielb1@mail.tau.ac.il", "date": "2016-06-16T14:30:09Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "arielb1@mail.tau.ac.il", "date": "2016-06-16T14:30:09Z"}, "message": "fix MirSource::Promoted handling", "tree": {"sha": "116a34c30176b489b26ec28745777f1cbd6f6630", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/116a34c30176b489b26ec28745777f1cbd6f6630"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "html_url": "https://github.com/rust-lang/rust/commit/a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/comments", "author": null, "committer": null, "parents": [{"sha": "5da8bf8402a422720a659673e465c7d70d494995", "url": "https://api.github.com/repos/rust-lang/rust/commits/5da8bf8402a422720a659673e465c7d70d494995", "html_url": "https://github.com/rust-lang/rust/commit/5da8bf8402a422720a659673e465c7d70d494995"}], "stats": {"total": 32, "additions": 15, "deletions": 17}, "files": [{"sha": "4ca3907d4e602bcf94c9945818b91eed0b6eab13", "filename": "src/librustc/mir/transform.rs", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/src%2Flibrustc%2Fmir%2Ftransform.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/src%2Flibrustc%2Fmir%2Ftransform.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Ftransform.rs?ref=a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "patch": "@@ -13,7 +13,7 @@ use hir;\n use hir::map::DefPathData;\n use hir::def_id::DefId;\n use mir::mir_map::MirMap;\n-use mir::repr::Mir;\n+use mir::repr::{Mir, Promoted};\n use ty::TyCtxt;\n use syntax::ast::NodeId;\n \n@@ -32,7 +32,7 @@ pub enum MirSource {\n     Static(NodeId, hir::Mutability),\n \n     /// Promoted rvalues within a function.\n-    Promoted(NodeId, usize)\n+    Promoted(NodeId, Promoted)\n }\n \n impl<'a, 'tcx> MirSource {\n@@ -77,7 +77,12 @@ pub trait Pass {\n         DepNode::MirPass(def_id)\n     }\n     fn name(&self) -> &str {\n-        unsafe { ::std::intrinsics::type_name::<Self>() }\n+        let name = unsafe { ::std::intrinsics::type_name::<Self>() };\n+        if let Some(tail) = name.rfind(\":\") {\n+            &name[tail+1..]\n+        } else {\n+            name\n+        }\n     }\n     fn disambiguator<'a>(&'a self) -> Option<Box<fmt::Display+'a>> { None }\n }\n@@ -104,11 +109,6 @@ pub trait MirPassHook<'tcx>: Pass {\n \n /// A pass which inspects Mir of functions in isolation.\n pub trait MirPass<'tcx>: Pass {\n-    fn run_pass_on_promoted<'a>(&mut self, tcx: TyCtxt<'a, 'tcx, 'tcx>,\n-                                item_id: NodeId, index: usize,\n-                                mir: &mut Mir<'tcx>) {\n-        self.run_pass(tcx, MirSource::Promoted(item_id, index), mir);\n-    }\n     fn run_pass<'a>(&mut self, tcx: TyCtxt<'a, 'tcx, 'tcx>,\n                     src: MirSource, mir: &mut Mir<'tcx>);\n }\n@@ -133,11 +133,12 @@ impl<'tcx, T: MirPass<'tcx>> MirMapPass<'tcx> for T {\n                 hook.on_mir_pass(tcx, src, mir, self, true);\n             }\n \n-            for (i, mir) in mir.promoted.iter_mut().enumerate() {\n+            for (i, mir) in mir.promoted.iter_enumerated_mut() {\n+                let src = MirSource::Promoted(id, i);\n                 for hook in &mut *hooks {\n                     hook.on_mir_pass(tcx, src, mir, self, false);\n                 }\n-                self.run_pass_on_promoted(tcx, id, i, mir);\n+                MirPass::run_pass(self, tcx, src, mir);\n                 for hook in &mut *hooks {\n                     hook.on_mir_pass(tcx, src, mir, self, true);\n                 }"}, {"sha": "515620d425389676617e3efa5f9cbba8cf5c96b3", "filename": "src/librustc_mir/pretty.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/src%2Flibrustc_mir%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/src%2Flibrustc_mir%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fpretty.rs?ref=a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "patch": "@@ -62,7 +62,7 @@ pub fn dump_mir<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     }\n \n     let promotion_id = match src {\n-        MirSource::Promoted(_, id) => format!(\"-promoted{}\", id),\n+        MirSource::Promoted(_, id) => format!(\"-{:?}\", id),\n         _ => String::new()\n     };\n \n@@ -98,7 +98,7 @@ pub fn write_mir_pretty<'a, 'b, 'tcx, I>(tcx: TyCtxt<'b, 'tcx, 'tcx>,\n         let src = MirSource::from_node(tcx, id);\n         write_mir_fn(tcx, src, mir, w, None)?;\n \n-        for (i, mir) in mir.promoted.iter().enumerate() {\n+        for (i, mir) in mir.promoted.iter_enumerated() {\n             writeln!(w, \"\")?;\n             write_mir_fn(tcx, MirSource::Promoted(id, i), mir, w, None)?;\n         }\n@@ -292,7 +292,7 @@ fn write_mir_sig(tcx: TyCtxt, src: MirSource, mir: &Mir, w: &mut Write)\n         MirSource::Const(_) => write!(w, \"const\")?,\n         MirSource::Static(_, hir::MutImmutable) => write!(w, \"static\")?,\n         MirSource::Static(_, hir::MutMutable) => write!(w, \"static mut\")?,\n-        MirSource::Promoted(_, i) => write!(w, \"promoted{} in\", i)?\n+        MirSource::Promoted(_, i) => write!(w, \"{:?} in\", i)?\n     }\n \n     write!(w, \" {}\", tcx.node_path_str(src.item_id()))?;"}, {"sha": "c028504d6f96db5697c6bffa7fbc7fc02f0db0b0", "filename": "src/librustc_mir/transform/add_call_guards.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/src%2Flibrustc_mir%2Ftransform%2Fadd_call_guards.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6d694ea0095be73aff9c29ccc2d5da260b3bfae/src%2Flibrustc_mir%2Ftransform%2Fadd_call_guards.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fadd_call_guards.rs?ref=a6d694ea0095be73aff9c29ccc2d5da260b3bfae", "patch": "@@ -13,8 +13,6 @@ use rustc::mir::repr::*;\n use rustc::mir::transform::{MirPass, MirSource, Pass};\n use rustc_data_structures::indexed_vec::{Idx, IndexVec};\n \n-use pretty;\n-\n pub struct AddCallGuards;\n \n /**\n@@ -38,7 +36,7 @@ pub struct AddCallGuards;\n  */\n \n impl<'tcx> MirPass<'tcx> for AddCallGuards {\n-    fn run_pass<'a>(&mut self, tcx: TyCtxt<'a, 'tcx, 'tcx>, src: MirSource, mir: &mut Mir<'tcx>) {\n+    fn run_pass<'a>(&mut self, _tcx: TyCtxt<'a, 'tcx, 'tcx>, _src: MirSource, mir: &mut Mir<'tcx>) {\n         let pred_count: IndexVec<_, _> =\n             mir.predecessors().iter().map(|ps| ps.len()).collect();\n \n@@ -75,7 +73,6 @@ impl<'tcx> MirPass<'tcx> for AddCallGuards {\n             }\n         }\n \n-        pretty::dump_mir(tcx, \"break_cleanup_edges\", &0, src, mir, None);\n         debug!(\"Broke {} N edges\", new_blocks.len());\n \n         mir.basic_blocks_mut().extend(new_blocks);"}]}