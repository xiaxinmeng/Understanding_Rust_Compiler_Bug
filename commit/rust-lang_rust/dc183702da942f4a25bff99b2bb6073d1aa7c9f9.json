{"sha": "dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjMTgzNzAyZGE5NDJmNGEyNWJmZjk5YjJiYjYwNzNkMWFhN2M5Zjk=", "commit": {"author": {"name": "Roxane", "email": "roxane.fruytier@hotmail.com", "date": "2020-07-19T21:26:51Z"}, "committer": {"name": "Aman Arora", "email": "me@aman-arora.com", "date": "2020-10-11T07:32:35Z"}, "message": "Replace tuple of infer vars for upvar_tys with single infer var\n\nThis commit allows us to decide the number of captures required after\ncompleting capture ananysis, which is required as part of implementing\nRFC-2229.\n\nCo-authored-by: Aman Arora <me@aman-arora.com>\nCo-authored-by: Jenny Wills <wills.jenniferg@gmail.com>", "tree": {"sha": "838fde0482fafbe0e8dc4331051fd50683b57d55", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/838fde0482fafbe0e8dc4331051fd50683b57d55"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "html_url": "https://github.com/rust-lang/rust/commit/dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/comments", "author": {"login": "roxelo", "id": 12419401, "node_id": "MDQ6VXNlcjEyNDE5NDAx", "avatar_url": "https://avatars.githubusercontent.com/u/12419401?v=4", "gravatar_id": "", "url": "https://api.github.com/users/roxelo", "html_url": "https://github.com/roxelo", "followers_url": "https://api.github.com/users/roxelo/followers", "following_url": "https://api.github.com/users/roxelo/following{/other_user}", "gists_url": "https://api.github.com/users/roxelo/gists{/gist_id}", "starred_url": "https://api.github.com/users/roxelo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/roxelo/subscriptions", "organizations_url": "https://api.github.com/users/roxelo/orgs", "repos_url": "https://api.github.com/users/roxelo/repos", "events_url": "https://api.github.com/users/roxelo/events{/privacy}", "received_events_url": "https://api.github.com/users/roxelo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arora-aman", "id": 4193035, "node_id": "MDQ6VXNlcjQxOTMwMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4193035?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arora-aman", "html_url": "https://github.com/arora-aman", "followers_url": "https://api.github.com/users/arora-aman/followers", "following_url": "https://api.github.com/users/arora-aman/following{/other_user}", "gists_url": "https://api.github.com/users/arora-aman/gists{/gist_id}", "starred_url": "https://api.github.com/users/arora-aman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arora-aman/subscriptions", "organizations_url": "https://api.github.com/users/arora-aman/orgs", "repos_url": "https://api.github.com/users/arora-aman/repos", "events_url": "https://api.github.com/users/arora-aman/events{/privacy}", "received_events_url": "https://api.github.com/users/arora-aman/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25d2d09da7af7fcbb0661a3ff2cd1a7fba3be86e", "url": "https://api.github.com/repos/rust-lang/rust/commits/25d2d09da7af7fcbb0661a3ff2cd1a7fba3be86e", "html_url": "https://github.com/rust-lang/rust/commit/25d2d09da7af7fcbb0661a3ff2cd1a7fba3be86e"}], "stats": {"total": 273, "additions": 178, "deletions": 95}, "files": [{"sha": "708c92af14628d9e43ce87887582e546082d3942", "filename": "compiler/rustc_middle/src/ty/outlives.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_middle%2Fsrc%2Fty%2Foutlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_middle%2Fsrc%2Fty%2Foutlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Foutlives.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -96,15 +96,25 @@ fn compute_components(\n             }\n \n             ty::Closure(_, ref substs) => {\n-                for upvar_ty in substs.as_closure().upvar_tys() {\n-                    compute_components(tcx, upvar_ty, out, visited);\n+                if substs.as_closure().is_valid() {\n+                    for upvar_ty in substs.as_closure().upvar_tys() {\n+                        compute_components(tcx, upvar_ty, out, visited);\n+                    }\n+                } else {\n+                    let tupled_ty = substs.as_closure().tupled_upvars_ty();\n+                    compute_components(tcx, tupled_ty, out, visited);\n                 }\n             }\n \n             ty::Generator(_, ref substs, _) => {\n                 // Same as the closure case\n-                for upvar_ty in substs.as_generator().upvar_tys() {\n-                    compute_components(tcx, upvar_ty, out, visited);\n+                if substs.as_generator().is_valid() {\n+                    for upvar_ty in substs.as_generator().upvar_tys() {\n+                        compute_components(tcx, upvar_ty, out, visited);\n+                    }\n+                } else {\n+                    let tupled_ty = substs.as_generator().tupled_upvars_ty();\n+                    compute_components(tcx, tupled_ty, out, visited);\n                 }\n \n                 // We ignore regions in the generator interior as we don't"}, {"sha": "646042d407cbeec29e421908f637d462996509e7", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 17, "deletions": 29, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -663,18 +663,13 @@ pub trait PrettyPrinter<'tcx>:\n                     }\n                 } else {\n                     p!(print_def_path(did, substs));\n-                    if substs.as_generator().is_valid() {\n-                        // Search for the first inference variable\n-                        p!(\" upvar_tys=(\");\n-                        let mut uninferred_ty =\n-                            substs.as_generator().upvar_tys().filter(|ty| ty.is_ty_infer());\n-                        if uninferred_ty.next().is_some() {\n-                            p!(write(\"unavailable\"));\n-                        } else {\n-                            self = self.comma_sep(substs.as_generator().upvar_tys())?;\n-                        }\n-                        p!(\")\");\n+                    p!(\" upvar_tys=(\");\n+                    if !substs.as_generator().is_valid() {\n+                        p!(\"unavailable\");\n+                    } else {\n+                        self = self.comma_sep(substs.as_generator().upvar_tys())?;\n                     }\n+                    p!(\")\");\n                 }\n \n                 if substs.as_generator().is_valid() {\n@@ -704,24 +699,17 @@ pub trait PrettyPrinter<'tcx>:\n                     }\n                 } else {\n                     p!(print_def_path(did, substs));\n-                    if substs.as_closure().is_valid() {\n-                        // Search for the first inference variable\n-                        let mut uninferred_ty =\n-                            substs.as_closure().upvar_tys().filter(|ty| ty.is_ty_infer());\n-                        if uninferred_ty.next().is_some() {\n-                            // If the upvar substs contain an inference variable we haven't\n-                            // finished capture analysis.\n-                            p!(\" closure_substs=(unavailable)\");\n-                        } else {\n-                            p!(\" closure_kind_ty=\", print(substs.as_closure().kind_ty()));\n-                            p!(\n-                                \" closure_sig_as_fn_ptr_ty=\",\n-                                print(substs.as_closure().sig_as_fn_ptr_ty())\n-                            );\n-                            p!(\" upvar_tys=(\");\n-                            self = self.comma_sep(substs.as_closure().upvar_tys())?;\n-                            p!(\")\");\n-                        }\n+                    if !substs.as_closure().is_valid() {\n+                        p!(\" closure_substs=(unavailable)\");\n+                    } else {\n+                        p!(\" closure_kind_ty=\", print(substs.as_closure().kind_ty()));\n+                        p!(\n+                            \" closure_sig_as_fn_ptr_ty=\",\n+                            print(substs.as_closure().sig_as_fn_ptr_ty())\n+                        );\n+                        p!(\" upvar_tys=(\");\n+                        self = self.comma_sep(substs.as_closure().upvar_tys())?;\n+                        p!(\")\");\n                     }\n                 }\n                 p!(\"]\");"}, {"sha": "870cc4eee05058252e37c433eead1b4afcec3de5", "filename": "compiler/rustc_middle/src/ty/sty.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -656,6 +656,14 @@ impl<'tcx> UpvarSubsts<'tcx> {\n         };\n         tupled_upvars_ty.expect_ty().tuple_fields()\n     }\n+\n+    #[inline]\n+    pub fn tupled_upvars_ty(self) -> Ty<'tcx> {\n+        match self {\n+            UpvarSubsts::Closure(substs) => substs.as_closure().tupled_upvars_ty(),\n+            UpvarSubsts::Generator(substs) => substs.as_generator().tupled_upvars_ty(),\n+        }\n+    }\n }\n \n #[derive(Debug, Copy, Clone, PartialEq, PartialOrd, Ord, Eq, Hash, TyEncodable, TyDecodable)]"}, {"sha": "087f6a0deece79191dd9bd7bd6ea488d417f248a", "filename": "compiler/rustc_trait_selection/src/opaque_types.rs", "status": "modified", "additions": 28, "deletions": 12, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Fopaque_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Fopaque_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fopaque_types.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -441,6 +441,7 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n \n             for required_region in required_region_bounds {\n                 concrete_ty.visit_with(&mut ConstrainOpaqueTypeRegionVisitor {\n+                    infcx: self,\n                     op: |r| self.sub_regions(infer::CallReturn(span), required_region, r),\n                 });\n             }\n@@ -509,6 +510,7 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n             }\n         }\n         concrete_ty.visit_with(&mut ConstrainOpaqueTypeRegionVisitor {\n+            infcx: self,\n             op: |r| self.sub_regions(infer::CallReturn(span), least_region, r),\n         });\n     }\n@@ -543,6 +545,7 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n         );\n \n         concrete_ty.visit_with(&mut ConstrainOpaqueTypeRegionVisitor {\n+            infcx: self,\n             op: |r| {\n                 self.member_constraint(\n                     opaque_type_def_id,\n@@ -683,11 +686,12 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n //\n // We ignore any type parameters because impl trait values are assumed to\n // capture all the in-scope type parameters.\n-struct ConstrainOpaqueTypeRegionVisitor<OP> {\n+struct ConstrainOpaqueTypeRegionVisitor<'cx, 'tcx, OP> {\n+    infcx: &'cx InferCtxt<'cx, 'tcx>,\n     op: OP,\n }\n \n-impl<'tcx, OP> TypeVisitor<'tcx> for ConstrainOpaqueTypeRegionVisitor<OP>\n+impl<'cx, 'tcx, OP> TypeVisitor<'tcx> for ConstrainOpaqueTypeRegionVisitor<'cx, 'tcx, OP>\n where\n     OP: FnMut(ty::Region<'tcx>),\n {\n@@ -717,24 +721,36 @@ where\n             ty::Closure(_, ref substs) => {\n                 // Skip lifetime parameters of the enclosing item(s)\n \n-                for upvar_ty in substs.as_closure().upvar_tys() {\n-                    upvar_ty.visit_with(self);\n-                }\n+                let ty = self.infcx.shallow_resolve(substs.as_closure().tupled_upvars_ty());\n+                if let ty::Infer(ty::TyVar(_)) = ty.kind() {\n+                    // Not yet resolved.\n+                    ty.super_visit_with(self);\n+                } else {\n+                    for upvar_ty in substs.as_closure().upvar_tys() {\n+                        upvar_ty.visit_with(self);\n+                    }\n \n-                substs.as_closure().sig_as_fn_ptr_ty().visit_with(self);\n+                    substs.as_closure().sig_as_fn_ptr_ty().visit_with(self);\n+                }\n             }\n \n             ty::Generator(_, ref substs, _) => {\n                 // Skip lifetime parameters of the enclosing item(s)\n                 // Also skip the witness type, because that has no free regions.\n \n-                for upvar_ty in substs.as_generator().upvar_tys() {\n-                    upvar_ty.visit_with(self);\n-                }\n+                let ty = self.infcx.shallow_resolve(substs.as_generator().tupled_upvars_ty());\n+                if let ty::Infer(ty::TyVar(_)) = ty.kind() {\n+                    // Not yet resolved.\n+                    ty.super_visit_with(self);\n+                } else {\n+                    for upvar_ty in substs.as_generator().upvar_tys() {\n+                        upvar_ty.visit_with(self);\n+                    }\n \n-                substs.as_generator().return_ty().visit_with(self);\n-                substs.as_generator().yield_ty().visit_with(self);\n-                substs.as_generator().resume_ty().visit_with(self);\n+                    substs.as_generator().return_ty().visit_with(self);\n+                    substs.as_generator().yield_ty().visit_with(self);\n+                    substs.as_generator().resume_ty().visit_with(self);\n+                }\n             }\n             _ => {\n                 ty.super_visit_with(self);"}, {"sha": "5908e73d4833b1045ac20b27affdbbe631338322", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -1307,6 +1307,9 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n         let mut generator = None;\n         let mut outer_generator = None;\n         let mut next_code = Some(&obligation.cause.code);\n+\n+        let mut seen_upvar_tys_infer_tuple = false;\n+\n         while let Some(code) = next_code {\n             debug!(\"maybe_note_obligation_cause_for_async_await: code={:?}\", code);\n             match code {\n@@ -1327,6 +1330,13 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                             outer_generator = Some(did);\n                         }\n                         ty::GeneratorWitness(..) => {}\n+                        ty::Tuple(_) if !seen_upvar_tys_infer_tuple => {\n+                            // By introducing a tuple of upvar types into the chain of obligations\n+                            // of a generator, the first non-generator item is now the tuple itself,\n+                            // we shall ignore this.\n+\n+                            seen_upvar_tys_infer_tuple = true;\n+                        }\n                         _ if generator.is_none() => {\n                             trait_ref = Some(derived_obligation.parent_trait_ref.skip_binder());\n                             target_ty = Some(ty);"}, {"sha": "8212823a6dbc77ccaa76da806ff60fdd6bb6cd3f", "filename": "compiler/rustc_trait_selection/src/traits/query/dropck_outlives.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fdropck_outlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fdropck_outlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fdropck_outlives.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -110,7 +110,7 @@ pub fn trivial_dropck_outlives<'tcx>(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>) -> bool {\n         // check if *any* of those are trivial.\n         ty::Tuple(ref tys) => tys.iter().all(|t| trivial_dropck_outlives(tcx, t.expect_ty())),\n         ty::Closure(_, ref substs) => {\n-            substs.as_closure().upvar_tys().all(|t| trivial_dropck_outlives(tcx, t))\n+            trivial_dropck_outlives(tcx, substs.as_closure().tupled_upvars_ty())\n         }\n \n         ty::Adt(def, _) => {"}, {"sha": "efe01191e589d89c177277107bb4c2b4ba10439d", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 30, "deletions": 4, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -1631,7 +1631,13 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n             ty::Closure(_, substs) => {\n                 // (*) binder moved here\n-                Where(ty::Binder::bind(substs.as_closure().upvar_tys().collect()))\n+                let ty = self.infcx.shallow_resolve(substs.as_closure().tupled_upvars_ty());\n+                if let ty::Infer(ty::TyVar(_)) = ty.kind() {\n+                    // Not yet resolved.\n+                    Ambiguous\n+                } else {\n+                    Where(ty::Binder::bind(substs.as_closure().upvar_tys().collect()))\n+                }\n             }\n \n             ty::Adt(..) | ty::Projection(..) | ty::Param(..) | ty::Opaque(..) => {\n@@ -1700,11 +1706,31 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                 tys.iter().map(|k| k.expect_ty()).collect()\n             }\n \n-            ty::Closure(_, ref substs) => substs.as_closure().upvar_tys().collect(),\n+            ty::Closure(_, ref substs) => {\n+                let ty = self.infcx.shallow_resolve(substs.as_closure().tupled_upvars_ty());\n+                if let ty::Infer(ty::TyVar(_)) = ty.kind() {\n+                    // The inference variable will be replaced by a tuple once capture analysis\n+                    // completes. If the tuple meets a bound, so do all the elements within it.\n+                    vec![ty]\n+                } else {\n+                    substs.as_closure().upvar_tys().collect()\n+                }\n+            }\n \n             ty::Generator(_, ref substs, _) => {\n-                let witness = substs.as_generator().witness();\n-                substs.as_generator().upvar_tys().chain(iter::once(witness)).collect()\n+                let upvar_tys_resolved =\n+                    self.infcx.shallow_resolve(substs.as_generator().tupled_upvars_ty());\n+\n+                if let ty::Infer(ty::TyVar(_)) = upvar_tys_resolved.kind() {\n+                    // The inference variable will be replaced by a tuple once capture analysis\n+                    // completes, if the tuple meets a bound, so do all the elements within it.\n+                    let witness_resolved =\n+                        self.infcx.shallow_resolve(substs.as_generator().witness());\n+                    vec![upvar_tys_resolved, witness_resolved]\n+                } else {\n+                    let witness = substs.as_generator().witness();\n+                    substs.as_generator().upvar_tys().chain(iter::once(witness)).collect()\n+                }\n             }\n \n             ty::GeneratorWitness(types) => {"}, {"sha": "496dff6c5b2cfef66bb5fb4e6cba4ffebb177c45", "filename": "compiler/rustc_trait_selection/src/traits/wf.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fwf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fwf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fwf.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -592,10 +592,8 @@ impl<'a, 'tcx> WfPredicates<'a, 'tcx> {\n                     // anyway, except via auto trait matching (which\n                     // only inspects the upvar types).\n                     walker.skip_current_subtree(); // subtree handled below\n-                    for upvar_ty in substs.as_closure().upvar_tys() {\n-                        // FIXME(eddyb) add the type to `walker` instead of recursing.\n-                        self.compute(upvar_ty.into());\n-                    }\n+                    // FIXME(eddyb) add the type to `walker` instead of recursing.\n+                    self.compute(substs.as_closure().tupled_upvars_ty().into());\n                 }\n \n                 ty::FnPtr(_) => {"}, {"sha": "bbd3a7229a99b0afaa5f7b34a2986f849b3e48df", "filename": "compiler/rustc_traits/src/dropck_outlives.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_traits%2Fsrc%2Fdropck_outlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_traits%2Fsrc%2Fdropck_outlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fdropck_outlives.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -210,12 +210,20 @@ fn dtorck_constraint_for_ty<'tcx>(\n             Ok::<_, NoSolution>(())\n         })?,\n \n-        ty::Closure(_, substs) => rustc_data_structures::stack::ensure_sufficient_stack(|| {\n-            for ty in substs.as_closure().upvar_tys() {\n-                dtorck_constraint_for_ty(tcx, span, for_ty, depth + 1, ty, constraints)?;\n+        ty::Closure(_, substs) => {\n+            if !substs.as_closure().is_valid() {\n+                // By the time this code runs, all type variables ought to\n+                // be fully resolved.\n+                return Err(NoSolution);\n             }\n-            Ok::<_, NoSolution>(())\n-        })?,\n+\n+            rustc_data_structures::stack::ensure_sufficient_stack(|| {\n+                for ty in substs.as_closure().upvar_tys() {\n+                    dtorck_constraint_for_ty(tcx, span, for_ty, depth + 1, ty, constraints)?;\n+                }\n+                Ok::<_, NoSolution>(())\n+            })?\n+        }\n \n         ty::Generator(_, substs, _movability) => {\n             // rust-lang/rust#49918: types can be constructed, stored\n@@ -241,6 +249,12 @@ fn dtorck_constraint_for_ty<'tcx>(\n             // derived from lifetimes attached to the upvars and resume\n             // argument, and we *do* incorporate those here.\n \n+            if !substs.as_generator().is_valid() {\n+                // By the time this code runs, all type variables ought to\n+                // be fully resolved.\n+                return Err(NoSolution);\n+            }\n+\n             constraints.outlives.extend(\n                 substs\n                     .as_generator()"}, {"sha": "8bdd933644a33aa17da63d2448dff948be195a21", "filename": "compiler/rustc_typeck/src/check/closure.rs", "status": "modified", "additions": 4, "deletions": 13, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fclosure.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -81,19 +81,10 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             self.tcx.closure_base_def_id(expr_def_id.to_def_id()),\n         );\n \n-        let tupled_upvars_ty =\n-            self.tcx.mk_tup(self.tcx.upvars_mentioned(expr_def_id).iter().flat_map(|upvars| {\n-                upvars.iter().map(|(&var_hir_id, _)| {\n-                    // Create type variables (for now) to represent the transformed\n-                    // types of upvars. These will be unified during the upvar\n-                    // inference phase (`upvar.rs`).\n-                    self.infcx.next_ty_var(TypeVariableOrigin {\n-                        // FIXME(eddyb) distinguish upvar inference variables from the rest.\n-                        kind: TypeVariableOriginKind::ClosureSynthetic,\n-                        span: self.tcx.hir().span(var_hir_id),\n-                    })\n-                })\n-            }));\n+        let tupled_upvars_ty = self.infcx.next_ty_var(TypeVariableOrigin {\n+            kind: TypeVariableOriginKind::ClosureSynthetic,\n+            span: self.tcx.hir().span(expr.hir_id),\n+        });\n \n         if let Some(GeneratorTypes { resume_ty, yield_ty, interior, movability }) = generator_types\n         {"}, {"sha": "db32a73618125f04b9f62188447f88e2bb2ff794", "filename": "compiler/rustc_typeck/src/check/coercion.rs", "status": "modified", "additions": 18, "deletions": 5, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcoercion.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -39,6 +39,7 @@ use crate::astconv::AstConv;\n use crate::check::FnCtxt;\n use rustc_errors::{struct_span_err, Applicability, DiagnosticBuilder};\n use rustc_hir as hir;\n+use rustc_hir::def_id::DefId;\n use rustc_infer::infer::type_variable::{TypeVariableOrigin, TypeVariableOriginKind};\n use rustc_infer::infer::{Coercion, InferOk, InferResult};\n use rustc_middle::ty::adjustment::{\n@@ -221,11 +222,11 @@ impl<'f, 'tcx> Coerce<'f, 'tcx> {\n                 // unsafe qualifier.\n                 self.coerce_from_fn_pointer(a, a_f, b)\n             }\n-            ty::Closure(_, substs_a) => {\n+            ty::Closure(closure_def_id_a, substs_a) => {\n                 // Non-capturing closures are coercible to\n                 // function pointers or unsafe function pointers.\n                 // It cannot convert closures that require unsafe.\n-                self.coerce_closure_to_fn(a, substs_a, b)\n+                self.coerce_closure_to_fn(a, closure_def_id_a, substs_a, b)\n             }\n             _ => {\n                 // Otherwise, just use unification rules.\n@@ -762,6 +763,7 @@ impl<'f, 'tcx> Coerce<'f, 'tcx> {\n     fn coerce_closure_to_fn(\n         &self,\n         a: Ty<'tcx>,\n+        closure_def_id_a: DefId,\n         substs_a: SubstsRef<'tcx>,\n         b: Ty<'tcx>,\n     ) -> CoerceResult<'tcx> {\n@@ -772,7 +774,18 @@ impl<'f, 'tcx> Coerce<'f, 'tcx> {\n         let b = self.shallow_resolve(b);\n \n         match b.kind() {\n-            ty::FnPtr(fn_ty) if substs_a.as_closure().upvar_tys().next().is_none() => {\n+            // At this point we haven't done capture analysis, which means\n+            // that the ClosureSubsts just contains an inference variable instead\n+            // of tuple of captured types.\n+            //\n+            // All we care here is if any variable is being captured and not the exact paths,\n+            // so we check `upvars_mentioned` for root variables being captured.\n+            ty::FnPtr(fn_ty)\n+                if self\n+                    .tcx\n+                    .upvars_mentioned(closure_def_id_a.expect_local())\n+                    .map_or(true, |u| u.is_empty()) =>\n+            {\n                 // We coerce the closure, which has fn type\n                 //     `extern \"rust-call\" fn((arg0,arg1,...)) -> _`\n                 // to\n@@ -906,8 +919,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         // Function items or non-capturing closures of differing IDs or InternalSubsts.\n         let (a_sig, b_sig) = {\n             let is_capturing_closure = |ty| {\n-                if let &ty::Closure(_, substs) = ty {\n-                    substs.as_closure().upvar_tys().next().is_some()\n+                if let &ty::Closure(closure_def_id, _substs) = ty {\n+                    self.tcx.upvars_mentioned(closure_def_id.expect_local()).is_some()\n                 } else {\n                     false\n                 }"}, {"sha": "1e97bd65a79f4bb57528aee12fdcc102df613db8", "filename": "compiler/rustc_typeck/src/check/upvar.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -202,9 +202,11 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             \"analyze_closure: id={:?} substs={:?} final_upvar_tys={:?}\",\n             closure_hir_id, substs, final_upvar_tys\n         );\n-        for (upvar_ty, final_upvar_ty) in substs.upvar_tys().zip(final_upvar_tys) {\n-            self.demand_suptype(span, upvar_ty, final_upvar_ty);\n-        }\n+\n+        // Build a tuple (U0..Un) of the final upvar types U0..Un\n+        // and unify the upvar tupe type in the closure with it:\n+        let final_tupled_upvars_type = self.tcx.mk_tup(final_upvar_tys.iter());\n+        self.demand_suptype(span, substs.tupled_upvars_ty(), final_tupled_upvars_type);\n \n         // If we are also inferred the closure kind here,\n         // process any deferred resolutions."}, {"sha": "285b6543833ae6e4511b8d56e9fca0787f2772fd", "filename": "src/test/ui/closures/closure-move-sync.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fclosures%2Fclosure-move-sync.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fclosures%2Fclosure-move-sync.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2Fclosure-move-sync.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -11,6 +11,7 @@ LL |     F: Send + 'static,\n    |\n    = help: the trait `Sync` is not implemented for `std::sync::mpsc::Receiver<()>`\n    = note: required because of the requirements on the impl of `Send` for `&std::sync::mpsc::Receiver<()>`\n+   = note: required because it appears within the type `(&std::sync::mpsc::Receiver<()>,)`\n    = note: required because it appears within the type `[closure@$DIR/closure-move-sync.rs:6:27: 9:6]`\n \n error[E0277]: `Sender<()>` cannot be shared between threads safely\n@@ -26,6 +27,7 @@ LL |     F: Send + 'static,\n    |\n    = help: the trait `Sync` is not implemented for `Sender<()>`\n    = note: required because of the requirements on the impl of `Send` for `&Sender<()>`\n+   = note: required because it appears within the type `(&Sender<()>,)`\n    = note: required because it appears within the type `[closure@$DIR/closure-move-sync.rs:18:19: 18:42]`\n \n error: aborting due to 2 previous errors"}, {"sha": "5043a3be91d52627a27840bf8e6c21eec90cf3d3", "filename": "src/test/ui/generator/generator-yielding-or-returning-itself.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fgenerator-yielding-or-returning-itself.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fgenerator-yielding-or-returning-itself.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fgenerator-yielding-or-returning-itself.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -1,4 +1,4 @@\n-error[E0271]: type mismatch resolving `<[generator@$DIR/generator-yielding-or-returning-itself.rs:15:34: 19:6 _] as Generator>::Return == [generator@$DIR/generator-yielding-or-returning-itself.rs:15:34: 19:6 _]`\n+error[E0271]: type mismatch resolving `<[generator@$DIR/generator-yielding-or-returning-itself.rs:15:34: 19:6] as Generator>::Return == [generator@$DIR/generator-yielding-or-returning-itself.rs:15:34: 19:6]`\n   --> $DIR/generator-yielding-or-returning-itself.rs:15:5\n    |\n LL | pub fn want_cyclic_generator_return<T>(_: T)\n@@ -14,7 +14,7 @@ LL |     want_cyclic_generator_return(|| {\n            see issue #46062 <https://github.com/rust-lang/rust/issues/46062>\n            for more information\n \n-error[E0271]: type mismatch resolving `<[generator@$DIR/generator-yielding-or-returning-itself.rs:28:33: 32:6 _] as Generator>::Yield == [generator@$DIR/generator-yielding-or-returning-itself.rs:28:33: 32:6 _]`\n+error[E0271]: type mismatch resolving `<[generator@$DIR/generator-yielding-or-returning-itself.rs:28:33: 32:6] as Generator>::Yield == [generator@$DIR/generator-yielding-or-returning-itself.rs:28:33: 32:6]`\n   --> $DIR/generator-yielding-or-returning-itself.rs:28:5\n    |\n LL | pub fn want_cyclic_generator_yield<T>(_: T)"}, {"sha": "f5cfa83f500705c9908e7273a1f42a3204b90e98", "filename": "src/test/ui/generator/not-send-sync.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fnot-send-sync.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fnot-send-sync.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fnot-send-sync.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -9,6 +9,7 @@ LL |     assert_send(|| {\n    |\n    = help: the trait `Sync` is not implemented for `Cell<i32>`\n    = note: required because of the requirements on the impl of `Send` for `&Cell<i32>`\n+   = note: required because it appears within the type `(&Cell<i32>,)`\n    = note: required because it appears within the type `[generator@$DIR/not-send-sync.rs:16:17: 20:6 _]`\n \n error: generator cannot be shared between threads safely"}, {"sha": "f363ed6a3b9a6c01df434b845bdd1308f1c25bc2", "filename": "src/test/ui/generator/print/generator-print-verbose-2.stderr", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fprint%2Fgenerator-print-verbose-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fprint%2Fgenerator-print-verbose-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fprint%2Fgenerator-print-verbose-2.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -9,7 +9,8 @@ LL |     assert_send(|| {\n    |\n    = help: the trait `Sync` is not implemented for `Cell<i32>`\n    = note: required because of the requirements on the impl of `Send` for `&'_#3r Cell<i32>`\n-   = note: required because it appears within the type `[main::{closure#1} upvar_tys=(&'_#3r Cell<i32>) _#16t]`\n+   = note: required because it appears within the type `(&'_#3r Cell<i32>,)`\n+   = note: required because it appears within the type `[main::{closure#1} upvar_tys=(&'_#3r Cell<i32>) _#17t]`\n \n error: generator cannot be shared between threads safely\n   --> $DIR/generator-print-verbose-2.rs:12:5"}, {"sha": "d15646259b2c920658e9e676e1321853af31315f", "filename": "src/test/ui/generator/print/generator-print-verbose-3.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fprint%2Fgenerator-print-verbose-3.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fprint%2Fgenerator-print-verbose-3.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fprint%2Fgenerator-print-verbose-3.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -12,7 +12,7 @@ LL | |     };\n    | |_____^ expected `()`, found generator\n    |\n    = note: expected unit type `()`\n-              found generator `[main::{closure#0} upvar_tys=(unavailable) _#5t]`\n+              found generator `[main::{closure#0} upvar_tys=(unavailable)]`\n \n error: aborting due to previous error\n "}, {"sha": "881064d2f841865c3e1fb7eccd87fb6050117062", "filename": "src/test/ui/generator/static-not-unpin.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fstatic-not-unpin.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Fstatic-not-unpin.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fstatic-not-unpin.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -1,11 +1,11 @@\n-error[E0277]: `[static generator@$DIR/static-not-unpin.rs:11:25: 13:6 _]` cannot be unpinned\n+error[E0277]: `[static generator@$DIR/static-not-unpin.rs:11:25: 13:6]` cannot be unpinned\n   --> $DIR/static-not-unpin.rs:14:18\n    |\n LL | fn assert_unpin<T: Unpin>(_: T) {\n    |                    ----- required by this bound in `assert_unpin`\n ...\n LL |     assert_unpin(generator);\n-   |                  ^^^^^^^^^ the trait `Unpin` is not implemented for `[static generator@$DIR/static-not-unpin.rs:11:25: 13:6 _]`\n+   |                  ^^^^^^^^^ the trait `Unpin` is not implemented for `[static generator@$DIR/static-not-unpin.rs:11:25: 13:6]`\n \n error: aborting due to previous error\n "}, {"sha": "9e111d68a55b7023e7cfe06fa266132889dd763a", "filename": "src/test/ui/generator/type-mismatch-signature-deduction.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Ftype-mismatch-signature-deduction.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fgenerator%2Ftype-mismatch-signature-deduction.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Ftype-mismatch-signature-deduction.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -7,7 +7,7 @@ LL |         5\n    = note: expected type `std::result::Result<{integer}, _>`\n               found type `{integer}`\n \n-error[E0271]: type mismatch resolving `<[generator@$DIR/type-mismatch-signature-deduction.rs:6:5: 14:6 _] as Generator>::Return == i32`\n+error[E0271]: type mismatch resolving `<[generator@$DIR/type-mismatch-signature-deduction.rs:6:5: 14:6] as Generator>::Return == i32`\n   --> $DIR/type-mismatch-signature-deduction.rs:5:13\n    |\n LL | fn foo() -> impl Generator<Return = i32> {"}, {"sha": "cddfe6c694666b5482c2f4527017a206582be90f", "filename": "src/test/ui/interior-mutability/interior-mutability.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Finterior-mutability%2Finterior-mutability.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Finterior-mutability%2Finterior-mutability.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finterior-mutability%2Finterior-mutability.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -12,6 +12,7 @@ LL | pub fn catch_unwind<F: FnOnce() -> R + UnwindSafe, R>(f: F) -> Result<R> {\n    = help: within `Cell<i32>`, the trait `RefUnwindSafe` is not implemented for `UnsafeCell<i32>`\n    = note: required because it appears within the type `Cell<i32>`\n    = note: required because of the requirements on the impl of `UnwindSafe` for `&Cell<i32>`\n+   = note: required because it appears within the type `(&Cell<i32>,)`\n    = note: required because it appears within the type `[closure@$DIR/interior-mutability.rs:5:18: 5:35]`\n \n error: aborting due to previous error"}, {"sha": "f942088eb7ec609f48f5cdb1f8a0f684b44b7ffd", "filename": "src/test/ui/kindck/kindck-nonsendable-1.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fkindck%2Fkindck-nonsendable-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fkindck%2Fkindck-nonsendable-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fkindck%2Fkindck-nonsendable-1.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -10,6 +10,7 @@ LL |     bar(move|| foo(x));\n    |     `Rc<usize>` cannot be sent between threads safely\n    |\n    = help: within `[closure@$DIR/kindck-nonsendable-1.rs:9:9: 9:22]`, the trait `Send` is not implemented for `Rc<usize>`\n+   = note: required because it appears within the type `(Rc<usize>,)`\n    = note: required because it appears within the type `[closure@$DIR/kindck-nonsendable-1.rs:9:9: 9:22]`\n \n error: aborting due to previous error"}, {"sha": "0b1fcf58e2e001185d93bba320277b1f38d55d22", "filename": "src/test/ui/mismatched_types/issue-36053-2.stderr", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-36053-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-36053-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-36053-2.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -1,3 +1,11 @@\n+error[E0631]: type mismatch in closure arguments\n+  --> $DIR/issue-36053-2.rs:7:32\n+   |\n+LL |     once::<&str>(\"str\").fuse().filter(|a: &str| true).count();\n+   |                                ^^^^^^ -------------- found signature of `for<'r> fn(&'r str) -> _`\n+   |                                |\n+   |                                expected signature of `for<'r> fn(&'r &str) -> _`\n+\n error[E0599]: no method named `count` found for struct `Filter<Fuse<std::iter::Once<&str>>, [closure@$DIR/issue-36053-2.rs:7:39: 7:53]>` in the current scope\n   --> $DIR/issue-36053-2.rs:7:55\n    |\n@@ -20,14 +28,6 @@ LL | pub struct Filter<I, P> {\n            `Filter<Fuse<std::iter::Once<&str>>, [closure@$DIR/issue-36053-2.rs:7:39: 7:53]>: Iterator`\n            which is required by `&mut Filter<Fuse<std::iter::Once<&str>>, [closure@$DIR/issue-36053-2.rs:7:39: 7:53]>: Iterator`\n \n-error[E0631]: type mismatch in closure arguments\n-  --> $DIR/issue-36053-2.rs:7:32\n-   |\n-LL |     once::<&str>(\"str\").fuse().filter(|a: &str| true).count();\n-   |                                ^^^^^^ -------------- found signature of `for<'r> fn(&'r str) -> _`\n-   |                                |\n-   |                                expected signature of `for<'r> fn(&'r &str) -> _`\n-\n error: aborting due to 2 previous errors\n \n Some errors have detailed explanations: E0599, E0631."}, {"sha": "8842b18158640cf5437f735db9c32caa178c9ecf", "filename": "src/test/ui/no-send-res-ports.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fno-send-res-ports.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc183702da942f4a25bff99b2bb6073d1aa7c9f9/src%2Ftest%2Fui%2Fno-send-res-ports.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fno-send-res-ports.stderr?ref=dc183702da942f4a25bff99b2bb6073d1aa7c9f9", "patch": "@@ -19,6 +19,7 @@ LL |       F: Send + 'static,\n    = help: within `[closure@$DIR/no-send-res-ports.rs:25:19: 29:6]`, the trait `Send` is not implemented for `Rc<()>`\n    = note: required because it appears within the type `Port<()>`\n    = note: required because it appears within the type `Foo`\n+   = note: required because it appears within the type `(Foo,)`\n    = note: required because it appears within the type `[closure@$DIR/no-send-res-ports.rs:25:19: 29:6]`\n \n error: aborting due to previous error"}]}