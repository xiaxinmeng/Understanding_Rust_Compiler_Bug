{"sha": "47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ3ZjZhOWQ3OTdlNWQwYTZlMzVmYWMyYTkwM2Y0N2FkNjViYjRjNGE=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-07-15T18:01:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-15T18:01:20Z"}, "message": "Rollup merge of #74276 - lcnr:discriminant-kind-what, r=nagisa\n\nimprove DiscriminantKind handling\n\nAdds a lang item `discriminant_type` for the associated type `DiscriminantKind::Discriminant`.\n\nChanges the discriminant of generators from `i32` to `u32`, which should not be observable to fix an\noversight where MIR was using `u32` and codegen and typeck used `i32`.", "tree": {"sha": "9ff14cd7f738cadcb096deb1d49989b0d83c45d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ff14cd7f738cadcb096deb1d49989b0d83c45d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfD0RwCRBK7hj4Ov3rIwAAdHIIAJdYd9NcFZb29Yt1NLHF7tTZ\neyGKWlK2NBQWF/LZNUy16JY+K9vZ4cJReSzwft+GQykuTteLb8yKqdRgjoHr98Sm\nngGUYq5/JsWTiWQvjRuZzGnW6tIF/khnRQGyLY3j6JhTSWqMvjkhfGkVv5FKfAOB\ntfVthmOoV+U+uZZvjnLb1+/Wv+HGoXOVPhOeuZBkuMxLJzO/FwRJ08Q4lvXM19Hi\nsK/axJ6WOz7IZ7Ts89QCq/qNirq3lSq/xddo7na3+++DTA9fkt53MMDDbl3tQ+Ny\nt13neSNuqf4uz+suvq99LJ6U6SerdR+PRdP1nUkyaW88RmDeQg6xn70QZXZ9yYA=\n=vvo9\n-----END PGP SIGNATURE-----\n", "payload": "tree 9ff14cd7f738cadcb096deb1d49989b0d83c45d6\nparent 0d07db98ab5870c269493cb9fba9376b9477d4b4\nparent fcf52c167f9280efe332557195998650a99bf437\nauthor Manish Goregaokar <manishsmail@gmail.com> 1594836080 -0700\ncommitter GitHub <noreply@github.com> 1594836080 -0700\n\nRollup merge of #74276 - lcnr:discriminant-kind-what, r=nagisa\n\nimprove DiscriminantKind handling\n\nAdds a lang item `discriminant_type` for the associated type `DiscriminantKind::Discriminant`.\n\nChanges the discriminant of generators from `i32` to `u32`, which should not be observable to fix an\noversight where MIR was using `u32` and codegen and typeck used `i32`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "html_url": "https://github.com/rust-lang/rust/commit/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d07db98ab5870c269493cb9fba9376b9477d4b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d07db98ab5870c269493cb9fba9376b9477d4b4", "html_url": "https://github.com/rust-lang/rust/commit/0d07db98ab5870c269493cb9fba9376b9477d4b4"}, {"sha": "fcf52c167f9280efe332557195998650a99bf437", "url": "https://api.github.com/repos/rust-lang/rust/commits/fcf52c167f9280efe332557195998650a99bf437", "html_url": "https://github.com/rust-lang/rust/commit/fcf52c167f9280efe332557195998650a99bf437"}], "stats": {"total": 29, "additions": 12, "deletions": 17}, "files": [{"sha": "56dddee7b7799f00fd01a608f11b20a74f4f22f9", "filename": "src/libcore/marker.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibcore%2Fmarker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibcore%2Fmarker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fmarker.rs?ref=47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "patch": "@@ -693,6 +693,7 @@ mod impls {\n pub trait DiscriminantKind {\n     /// The type of the discriminant, which must satisfy the trait\n     /// bounds required by `mem::Discriminant`.\n+    #[cfg_attr(not(bootstrap), lang = \"discriminant_type\")]\n     type Discriminant: Clone + Copy + Debug + Eq + PartialEq + Hash + Send + Sync + Unpin;\n }\n "}, {"sha": "88c97d874bed6f3c9a849b8f6cc309bddaef21ea", "filename": "src/librustc_hir/lang_items.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibrustc_hir%2Flang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibrustc_hir%2Flang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_hir%2Flang_items.rs?ref=47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "patch": "@@ -193,6 +193,9 @@ language_item_table! {\n     CloneTraitLangItem,            sym::clone,              clone_trait,             Target::Trait;\n     SyncTraitLangItem,             sym::sync,               sync_trait,              Target::Trait;\n     DiscriminantKindTraitLangItem, sym::discriminant_kind,  discriminant_kind_trait, Target::Trait;\n+    // The associated item of `trait DiscriminantKind`.\n+    DiscriminantTypeLangItem,      sym::discriminant_type,  discriminant_type,       Target::AssocTy;\n+\n     FreezeTraitLangItem,           sym::freeze,             freeze_trait,            Target::Trait;\n \n     DropTraitLangItem,             sym::drop,               drop_trait,              Target::Trait;"}, {"sha": "d7651879a8af05f9876124ff415498ebb77ae142", "filename": "src/librustc_span/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibrustc_span%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibrustc_span%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Fsymbol.rs?ref=47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "patch": "@@ -327,6 +327,7 @@ symbols! {\n         diagnostic,\n         direct,\n         discriminant_kind,\n+        discriminant_type,\n         discriminant_value,\n         dispatch_from_dyn,\n         div,"}, {"sha": "c08198ec373b8114c22702872fe81a1e70a2504d", "filename": "src/librustc_trait_selection/traits/project.rs", "status": "modified", "additions": 5, "deletions": 15, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibrustc_trait_selection%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Flibrustc_trait_selection%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Ftraits%2Fproject.rs?ref=47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "patch": "@@ -23,11 +23,12 @@ use crate::traits::error_reporting::InferCtxtExt;\n use rustc_data_structures::stack::ensure_sufficient_stack;\n use rustc_errors::ErrorReported;\n use rustc_hir::def_id::DefId;\n-use rustc_hir::lang_items::{FnOnceOutputLangItem, FnOnceTraitLangItem, GeneratorTraitLangItem};\n+use rustc_hir::lang_items::{\n+    DiscriminantTypeLangItem, FnOnceOutputLangItem, FnOnceTraitLangItem, GeneratorTraitLangItem,\n+};\n use rustc_infer::infer::resolve::OpportunisticRegionResolver;\n use rustc_middle::ty::fold::{TypeFoldable, TypeFolder};\n use rustc_middle::ty::subst::Subst;\n-use rustc_middle::ty::util::IntTypeExt;\n use rustc_middle::ty::{self, ToPolyTraitRef, ToPredicate, Ty, TyCtxt, WithConstness};\n use rustc_span::symbol::sym;\n use rustc_span::DUMMY_SP;\n@@ -1324,22 +1325,11 @@ fn confirm_discriminant_kind_candidate<'cx, 'tcx>(\n     let self_ty = selcx.infcx().shallow_resolve(obligation.predicate.self_ty());\n     let substs = tcx.mk_substs([self_ty.into()].iter());\n \n-    let assoc_items = tcx.associated_items(tcx.lang_items().discriminant_kind_trait().unwrap());\n-    // FIXME: emit an error if the trait definition is wrong\n-    let discriminant_def_id = assoc_items.in_definition_order().next().unwrap().def_id;\n-\n-    let discriminant_ty = match self_ty.kind {\n-        // Use the discriminant type for enums.\n-        ty::Adt(adt, _) if adt.is_enum() => adt.repr.discr_type().to_ty(tcx),\n-        // Default to `i32` for generators.\n-        ty::Generator(..) => tcx.types.i32,\n-        // Use `u8` for all other types.\n-        _ => tcx.types.u8,\n-    };\n+    let discriminant_def_id = tcx.require_lang_item(DiscriminantTypeLangItem, None);\n \n     let predicate = ty::ProjectionPredicate {\n         projection_ty: ty::ProjectionTy { substs, item_def_id: discriminant_def_id },\n-        ty: discriminant_ty,\n+        ty: self_ty.discriminant_ty(tcx),\n     };\n \n     confirm_param_env_candidate(selcx, obligation, ty::Binder::bind(predicate))"}, {"sha": "195e77022992d567c856e58d58ac571405bf79c3", "filename": "src/test/ui/generator/discriminant.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Ftest%2Fui%2Fgenerator%2Fdiscriminant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a/src%2Ftest%2Fui%2Fgenerator%2Fdiscriminant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fdiscriminant.rs?ref=47f6a9d797e5d0a6e35fac2a903f47ad65bb4c4a", "patch": "@@ -66,8 +66,8 @@ macro_rules! yield250 {\n }\n \n fn cycle(\n-    gen: impl Generator<()> + Unpin + DiscriminantKind<Discriminant = i32>,\n-    expected_max_discr: i32\n+    gen: impl Generator<()> + Unpin + DiscriminantKind<Discriminant = u32>,\n+    expected_max_discr: u32\n ) {\n     let mut gen = Box::pin(gen);\n     let mut max_discr = 0;"}]}