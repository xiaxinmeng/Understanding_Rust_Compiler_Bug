{"sha": "e7db42fb5b9a620c5669711546663d0ccebf9291", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3ZGI0MmZiNWI5YTYyMGM1NjY5NzExNTQ2NjYzZDBjY2ViZjkyOTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-18T20:44:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-18T20:44:18Z"}, "message": "Auto merge of #46808 - eddyb:issue-46769-quick, r=arielb1\n\nrustc: ensure optimized enums have a properly aligned size.\n\nFixes #46769 by padding the optimized enums wrapping packed data as necessary.\n\nNote that this is not the only way to solve this - on nightly, #46436 makes it easier to fix without adding new padding because of the replacement of `packed` flags with a non-redundant scheme.\nBut because it can't be backported, the optimal fix will be in a separate nightly-only PR (#46809).", "tree": {"sha": "fe6313234b01b04761fc780066b27e6663eb6ea8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe6313234b01b04761fc780066b27e6663eb6ea8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e7db42fb5b9a620c5669711546663d0ccebf9291", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e7db42fb5b9a620c5669711546663d0ccebf9291", "html_url": "https://github.com/rust-lang/rust/commit/e7db42fb5b9a620c5669711546663d0ccebf9291", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e7db42fb5b9a620c5669711546663d0ccebf9291/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b058dc0107b734b0a1a664ca0209366bb59eb3e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/b058dc0107b734b0a1a664ca0209366bb59eb3e9", "html_url": "https://github.com/rust-lang/rust/commit/b058dc0107b734b0a1a664ca0209366bb59eb3e9"}, {"sha": "087f1c23a70f889ea157c68b9db36c524e95ba8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/087f1c23a70f889ea157c68b9db36c524e95ba8f", "html_url": "https://github.com/rust-lang/rust/commit/087f1c23a70f889ea157c68b9db36c524e95ba8f"}], "stats": {"total": 16, "additions": 12, "deletions": 4}, "files": [{"sha": "a2692fb8f5a1ed17728866a660964cdd2cc9cc92", "filename": "src/librustc/ty/layout.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e7db42fb5b9a620c5669711546663d0ccebf9291/src%2Flibrustc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7db42fb5b9a620c5669711546663d0ccebf9291/src%2Flibrustc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Flayout.rs?ref=e7db42fb5b9a620c5669711546663d0ccebf9291", "patch": "@@ -1492,7 +1492,7 @@ impl<'a, 'tcx> LayoutDetails {\n                             }).collect::<Result<Vec<_>, _>>()?;\n \n                             let offset = st[i].fields.offset(field_index) + offset;\n-                            let LayoutDetails { size, mut align, .. } = st[i];\n+                            let LayoutDetails { mut size, mut align, .. } = st[i];\n \n                             let mut niche_align = niche.value.align(dl);\n                             let abi = if offset.bytes() == 0 && niche.value.size(dl) == size {\n@@ -1504,6 +1504,7 @@ impl<'a, 'tcx> LayoutDetails {\n                                 Abi::Aggregate { sized: true }\n                             };\n                             align = align.max(niche_align);\n+                            size = size.abi_align(align);\n \n                             return Ok(tcx.intern_layout(LayoutDetails {\n                                 variants: Variants::NicheFilling {"}, {"sha": "b8a1e6f2f54007ae2672922c47216e3e96e21fc2", "filename": "src/test/run-pass/packed-struct-optimized-enum.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e7db42fb5b9a620c5669711546663d0ccebf9291/src%2Ftest%2Frun-pass%2Fpacked-struct-optimized-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e7db42fb5b9a620c5669711546663d0ccebf9291/src%2Ftest%2Frun-pass%2Fpacked-struct-optimized-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fpacked-struct-optimized-enum.rs?ref=e7db42fb5b9a620c5669711546663d0ccebf9291", "patch": "@@ -16,14 +16,21 @@ impl<T: Copy> Clone for Packed<T> {\n     fn clone(&self) -> Self { *self }\n }\n \n-fn main() {\n-    let one = (Some(Packed((&(), 0))), true);\n+fn sanity_check_size<T: Copy>(one: T) {\n     let two = [one, one];\n     let stride = (&two[1] as *const _ as usize) - (&two[0] as *const _ as usize);\n+    assert_eq!(stride, std::mem::size_of_val(&one));\n+}\n \n+fn main() {\n     // This can fail if rustc and LLVM disagree on the size of a type.\n     // In this case, `Option<Packed<(&(), u32)>>` was erronously not\n     // marked as packed despite needing alignment `1` and containing\n     // its `&()` discriminant, which has alignment larger than `1`.\n-    assert_eq!(stride, std::mem::size_of_val(&one));\n+    sanity_check_size((Some(Packed((&(), 0))), true));\n+\n+    // In #46769, `Option<(Packed<&()>, bool)>` was found to have\n+    // pointer alignment, without actually being aligned in size.\n+    // E.g. on 64-bit platforms, it had alignment `8` but size `9`.\n+    sanity_check_size(Some((Packed(&()), true)));\n }"}]}