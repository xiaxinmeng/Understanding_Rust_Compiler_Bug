{"sha": "67edf94416cdb8cef46360cd284efc358736d689", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY3ZWRmOTQ0MTZjZGI4Y2VmNDYzNjBjZDI4NGVmYzM1ODczNmQ2ODk=", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2021-09-17T00:30:36Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2021-09-17T00:30:36Z"}, "message": "Set the library path in sysroot-crates-are-unstable\n\nMost of the `run-make-fulldeps` tests use a make-driven rustc command\nthat includes `HOST_RPATH_DIR` in the library path, but this particular\ntest runs from python instead. When the toolchain is built without\n`rpath` enabled, we need that library path in the environment so it can\nfind its own libraries.", "tree": {"sha": "48bf881690b92b0d58c199c87c3e9efa924592b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/48bf881690b92b0d58c199c87c3e9efa924592b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/67edf94416cdb8cef46360cd284efc358736d689", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/67edf94416cdb8cef46360cd284efc358736d689", "html_url": "https://github.com/rust-lang/rust/commit/67edf94416cdb8cef46360cd284efc358736d689", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/67edf94416cdb8cef46360cd284efc358736d689/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4828d5b7f745a9e867a9b0cc7f080f287bcf55d", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4828d5b7f745a9e867a9b0cc7f080f287bcf55d", "html_url": "https://github.com/rust-lang/rust/commit/e4828d5b7f745a9e867a9b0cc7f080f287bcf55d"}], "stats": {"total": 13, "additions": 13, "deletions": 0}, "files": [{"sha": "cb77eb34fef08d77246fe41bdf4eec42d9be6b78", "filename": "src/test/run-make-fulldeps/sysroot-crates-are-unstable/test.py", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/67edf94416cdb8cef46360cd284efc358736d689/src%2Ftest%2Frun-make-fulldeps%2Fsysroot-crates-are-unstable%2Ftest.py", "raw_url": "https://github.com/rust-lang/rust/raw/67edf94416cdb8cef46360cd284efc358736d689/src%2Ftest%2Frun-make-fulldeps%2Fsysroot-crates-are-unstable%2Ftest.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsysroot-crates-are-unstable%2Ftest.py?ref=67edf94416cdb8cef46360cd284efc358736d689", "patch": "@@ -17,6 +17,17 @@ def convert_to_string(s):\n     return s\n \n \n+def set_ld_lib_path():\n+    var = os.environ.get(\"LD_LIB_PATH_ENVVAR\")\n+    rpath = os.environ.get(\"HOST_RPATH_DIR\")\n+    if var and rpath:\n+        path = os.environ.get(var)\n+        if path:\n+            os.environ[var] = rpath + os.pathsep + path\n+        else:\n+            os.environ[var] = rpath\n+\n+\n def exec_command(command, to_input=None):\n     child = None\n     if to_input is None:\n@@ -50,7 +61,9 @@ def get_all_libs(dir_path):\n             if isfile(join(dir_path, f)) and f.endswith('.rlib') and f not in STABLE_CRATES]\n \n \n+set_ld_lib_path()\n sysroot = exec_command([os.environ['RUSTC'], '--print', 'sysroot'])[0].replace('\\n', '')\n+assert sysroot, \"Could not read the rustc sysroot!\"\n libs = get_all_libs(join(sysroot, 'lib/rustlib/{}/lib'.format(os.environ['TARGET'])))\n \n ret = 0"}]}