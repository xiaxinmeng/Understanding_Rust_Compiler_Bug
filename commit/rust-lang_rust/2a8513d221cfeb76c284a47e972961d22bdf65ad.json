{"sha": "2a8513d221cfeb76c284a47e972961d22bdf65ad", "node_id": "C_kwDOAAsO6NoAKDJhODUxM2QyMjFjZmViNzZjMjg0YTQ3ZTk3Mjk2MWQyMmJkZjY1YWQ", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-12-17T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-12-17T17:23:37Z"}, "message": "Replace visitor with a loop over blocks and statements", "tree": {"sha": "8249ed6efc0eb37473c0d3010176ea53b1363501", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8249ed6efc0eb37473c0d3010176ea53b1363501"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a8513d221cfeb76c284a47e972961d22bdf65ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a8513d221cfeb76c284a47e972961d22bdf65ad", "html_url": "https://github.com/rust-lang/rust/commit/2a8513d221cfeb76c284a47e972961d22bdf65ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a8513d221cfeb76c284a47e972961d22bdf65ad/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aef17b7ae6160352e2814c8686f7e4b2ee04d9e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/aef17b7ae6160352e2814c8686f7e4b2ee04d9e4", "html_url": "https://github.com/rust-lang/rust/commit/aef17b7ae6160352e2814c8686f7e4b2ee04d9e4"}], "stats": {"total": 39, "additions": 13, "deletions": 26}, "files": [{"sha": "c33d72179ad197d121fa68cb676790f3bdbd9e7f", "filename": "compiler/rustc_mir_transform/src/cleanup_post_borrowck.rs", "status": "modified", "additions": 13, "deletions": 26, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/2a8513d221cfeb76c284a47e972961d22bdf65ad/compiler%2Frustc_mir_transform%2Fsrc%2Fcleanup_post_borrowck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a8513d221cfeb76c284a47e972961d22bdf65ad/compiler%2Frustc_mir_transform%2Fsrc%2Fcleanup_post_borrowck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcleanup_post_borrowck.rs?ref=2a8513d221cfeb76c284a47e972961d22bdf65ad", "patch": "@@ -19,41 +19,28 @@\n //! [`Nop`]: rustc_middle::mir::StatementKind::Nop\n \n use crate::MirPass;\n-use rustc_middle::mir::visit::MutVisitor;\n-use rustc_middle::mir::{Body, BorrowKind, Location, Rvalue};\n-use rustc_middle::mir::{Statement, StatementKind};\n+use rustc_middle::mir::{Body, BorrowKind, Rvalue, StatementKind};\n use rustc_middle::ty::TyCtxt;\n \n pub struct CleanupNonCodegenStatements;\n \n-pub struct DeleteNonCodegenStatements<'tcx> {\n-    tcx: TyCtxt<'tcx>,\n-}\n-\n impl<'tcx> MirPass<'tcx> for CleanupNonCodegenStatements {\n-    fn run_pass(&self, tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n-        let mut delete = DeleteNonCodegenStatements { tcx };\n-        delete.visit_body_preserves_cfg(body);\n+    fn run_pass(&self, _tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n+        for basic_block in body.basic_blocks.as_mut_preserves_cfg() {\n+            for statement in basic_block.statements.iter_mut() {\n+                match statement.kind {\n+                    StatementKind::AscribeUserType(..)\n+                    | StatementKind::Assign(box (_, Rvalue::Ref(_, BorrowKind::Shallow, _)))\n+                    | StatementKind::FakeRead(..) => statement.make_nop(),\n+                    _ => (),\n+                }\n+            }\n+        }\n+\n         body.user_type_annotations.raw.clear();\n \n         for decl in &mut body.local_decls {\n             decl.user_ty = None;\n         }\n     }\n }\n-\n-impl<'tcx> MutVisitor<'tcx> for DeleteNonCodegenStatements<'tcx> {\n-    fn tcx(&self) -> TyCtxt<'tcx> {\n-        self.tcx\n-    }\n-\n-    fn visit_statement(&mut self, statement: &mut Statement<'tcx>, location: Location) {\n-        match statement.kind {\n-            StatementKind::AscribeUserType(..)\n-            | StatementKind::Assign(box (_, Rvalue::Ref(_, BorrowKind::Shallow, _)))\n-            | StatementKind::FakeRead(..) => statement.make_nop(),\n-            _ => (),\n-        }\n-        self.super_statement(statement, location);\n-    }\n-}"}]}