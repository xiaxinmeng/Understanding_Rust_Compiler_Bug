{"sha": "71ec1457ee9868a838e4521a3510cdd416c0c295", "node_id": "C_kwDOAAsO6NoAKDcxZWMxNDU3ZWU5ODY4YTgzOGU0NTIxYTM1MTBjZGQ0MTZjMGMyOTU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-13T03:28:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-13T03:28:57Z"}, "message": "Auto merge of #105436 - nnethercote:inline-place_contents_drop_state_cannot_differ, r=spastorino\n\nInline and remove `place_contents_drop_state_cannot_differ`.\n\nIt has a single call site and is hot enough to be worth inlining. And make sure `is_terminal_path` is inlined, too.\n\nr? `@ghost`", "tree": {"sha": "69e38c2d484d12b4d64a2342e66faffac02fb3bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69e38c2d484d12b4d64a2342e66faffac02fb3bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/71ec1457ee9868a838e4521a3510cdd416c0c295", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/71ec1457ee9868a838e4521a3510cdd416c0c295", "html_url": "https://github.com/rust-lang/rust/commit/71ec1457ee9868a838e4521a3510cdd416c0c295", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/71ec1457ee9868a838e4521a3510cdd416c0c295/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b96d9e0e20adb7716aa32a56fe96fde15c75d517", "url": "https://api.github.com/repos/rust-lang/rust/commits/b96d9e0e20adb7716aa32a56fe96fde15c75d517", "html_url": "https://github.com/rust-lang/rust/commit/b96d9e0e20adb7716aa32a56fe96fde15c75d517"}, {"sha": "68a19209e0f95b7dab601a091602643665b0cbc0", "url": "https://api.github.com/repos/rust-lang/rust/commits/68a19209e0f95b7dab601a091602643665b0cbc0", "html_url": "https://github.com/rust-lang/rust/commit/68a19209e0f95b7dab601a091602643665b0cbc0"}], "stats": {"total": 97, "additions": 46, "deletions": 51}, "files": [{"sha": "3224e13f7af4bfe9da8c9fd3b045edadee2b5496", "filename": "compiler/rustc_mir_dataflow/src/drop_flag_effects.rs", "status": "modified", "additions": 46, "deletions": 51, "changes": 97, "blob_url": "https://github.com/rust-lang/rust/blob/71ec1457ee9868a838e4521a3510cdd416c0c295/compiler%2Frustc_mir_dataflow%2Fsrc%2Fdrop_flag_effects.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71ec1457ee9868a838e4521a3510cdd416c0c295/compiler%2Frustc_mir_dataflow%2Fsrc%2Fdrop_flag_effects.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fdrop_flag_effects.rs?ref=71ec1457ee9868a838e4521a3510cdd416c0c295", "patch": "@@ -29,56 +29,6 @@ where\n     None\n }\n \n-/// When enumerating the child fragments of a path, don't recurse into\n-/// paths (1.) past arrays, slices, and pointers, nor (2.) into a type\n-/// that implements `Drop`.\n-///\n-/// Places behind references or arrays are not tracked by elaboration\n-/// and are always assumed to be initialized when accessible. As\n-/// references and indexes can be reseated, trying to track them can\n-/// only lead to trouble.\n-///\n-/// Places behind ADT's with a Drop impl are not tracked by\n-/// elaboration since they can never have a drop-flag state that\n-/// differs from that of the parent with the Drop impl.\n-///\n-/// In both cases, the contents can only be accessed if and only if\n-/// their parents are initialized. This implies for example that there\n-/// is no need to maintain separate drop flags to track such state.\n-//\n-// FIXME: we have to do something for moving slice patterns.\n-fn place_contents_drop_state_cannot_differ<'tcx>(\n-    tcx: TyCtxt<'tcx>,\n-    body: &Body<'tcx>,\n-    place: mir::Place<'tcx>,\n-) -> bool {\n-    let ty = place.ty(body, tcx).ty;\n-    match ty.kind() {\n-        ty::Array(..) => {\n-            debug!(\n-                \"place_contents_drop_state_cannot_differ place: {:?} ty: {:?} => false\",\n-                place, ty\n-            );\n-            false\n-        }\n-        ty::Slice(..) | ty::Ref(..) | ty::RawPtr(..) => {\n-            debug!(\n-                \"place_contents_drop_state_cannot_differ place: {:?} ty: {:?} refd => true\",\n-                place, ty\n-            );\n-            true\n-        }\n-        ty::Adt(def, _) if (def.has_dtor(tcx) && !def.is_box()) || def.is_union() => {\n-            debug!(\n-                \"place_contents_drop_state_cannot_differ place: {:?} ty: {:?} Drop => true\",\n-                place, ty\n-            );\n-            true\n-        }\n-        _ => false,\n-    }\n-}\n-\n pub fn on_lookup_result_bits<'tcx, F>(\n     tcx: TyCtxt<'tcx>,\n     body: &Body<'tcx>,\n@@ -105,13 +55,58 @@ pub fn on_all_children_bits<'tcx, F>(\n ) where\n     F: FnMut(MovePathIndex),\n {\n+    #[inline]\n     fn is_terminal_path<'tcx>(\n         tcx: TyCtxt<'tcx>,\n         body: &Body<'tcx>,\n         move_data: &MoveData<'tcx>,\n         path: MovePathIndex,\n     ) -> bool {\n-        place_contents_drop_state_cannot_differ(tcx, body, move_data.move_paths[path].place)\n+        let place = move_data.move_paths[path].place;\n+\n+        // When enumerating the child fragments of a path, don't recurse into\n+        // paths (1.) past arrays, slices, and pointers, nor (2.) into a type\n+        // that implements `Drop`.\n+        //\n+        // Places behind references or arrays are not tracked by elaboration\n+        // and are always assumed to be initialized when accessible. As\n+        // references and indexes can be reseated, trying to track them can\n+        // only lead to trouble.\n+        //\n+        // Places behind ADT's with a Drop impl are not tracked by\n+        // elaboration since they can never have a drop-flag state that\n+        // differs from that of the parent with the Drop impl.\n+        //\n+        // In both cases, the contents can only be accessed if and only if\n+        // their parents are initialized. This implies for example that there\n+        // is no need to maintain separate drop flags to track such state.\n+        //\n+        // FIXME: we have to do something for moving slice patterns.\n+        let ty = place.ty(body, tcx).ty;\n+        match ty.kind() {\n+            ty::Adt(def, _) if (def.has_dtor(tcx) && !def.is_box()) || def.is_union() => {\n+                debug!(\n+                    \"place_contents_drop_state_cannot_differ place: {:?} ty: {:?} Drop => true\",\n+                    place, ty\n+                );\n+                true\n+            }\n+            ty::Array(..) => {\n+                debug!(\n+                    \"place_contents_drop_state_cannot_differ place: {:?} ty: {:?} => false\",\n+                    place, ty\n+                );\n+                false\n+            }\n+            ty::Slice(..) | ty::Ref(..) | ty::RawPtr(..) => {\n+                debug!(\n+                    \"place_contents_drop_state_cannot_differ place: {:?} ty: {:?} refd => true\",\n+                    place, ty\n+                );\n+                true\n+            }\n+            _ => false,\n+        }\n     }\n \n     fn on_all_children_bits<'tcx, F>("}]}