{"sha": "d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa", "node_id": "C_kwDOAAsO6NoAKGQyNTEzZGViNjI5ODlhYjZmYTMzYmNmODc0N2FjMmRmYTM2ZmZkZmE", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-11-16T10:36:41Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-11-16T10:51:24Z"}, "message": "fix: Reimplement mapping out of test/bench attributes for runnables", "tree": {"sha": "ddb8ddd6211bca3cec9e808e1f258d134194f16e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddb8ddd6211bca3cec9e808e1f258d134194f16e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa", "html_url": "https://github.com/rust-lang/rust/commit/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "73668334f05c3446b04116ccc3156240d2d8ab19", "url": "https://api.github.com/repos/rust-lang/rust/commits/73668334f05c3446b04116ccc3156240d2d8ab19", "html_url": "https://github.com/rust-lang/rust/commit/73668334f05c3446b04116ccc3156240d2d8ab19"}], "stats": {"total": 19, "additions": 17, "deletions": 2}, "files": [{"sha": "671fcb0ba8bc5911130eb820d2761ab05fa51a73", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa", "patch": "@@ -701,6 +701,16 @@ impl<N: AstNode> InFile<N> {\n     }\n }\n \n+impl InFile<ast::Fn> {\n+    pub fn map_out_of_test_attr(self, db: &dyn db::AstDatabase) -> InFile<ast::Fn> {\n+        (|| {\n+            let InFile { file_id, value } = self.file_id.call_node(db)?;\n+            ast::Fn::cast(value).map(|n| InFile::new(file_id, n))\n+        })()\n+        .unwrap_or(self)\n+    }\n+}\n+\n /// In Rust, macros expand token trees to token trees. When we want to turn a\n /// token tree into an AST node, we need to figure out what kind of AST node we\n /// want: something like `foo` can be a type, an expression, or a pattern."}, {"sha": "00b60a390260e42d2e3cae5e3c8cc5f36503ce9d", "filename": "crates/ide/src/runnables.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa/crates%2Fide%2Fsrc%2Frunnables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa/crates%2Fide%2Fsrc%2Frunnables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Frunnables.rs?ref=d2513deb62989ab6fa33bcf8747ac2dfa36ffdfa", "patch": "@@ -236,7 +236,9 @@ fn find_related_tests(\n                 .filter_map(|token| token.ancestors().find_map(ast::Fn::cast))\n                 .map(|f| hir::InFile::new(sema.hir_file_for(f.syntax()), f));\n \n-            for InFile { value: ref fn_def, .. } in functions {\n+            for fn_def in functions {\n+                // #[test/bench] expands to just the item causing us to lose the attribute, so recover them by going out of the attribute\n+                let InFile { value: fn_def, .. } = &fn_def.map_out_of_test_attr(sema.db);\n                 if let Some(runnable) = as_test_runnable(sema, fn_def) {\n                     // direct test\n                     tests.insert(runnable);\n@@ -292,7 +294,8 @@ fn parent_test_module(sema: &Semantics<RootDatabase>, fn_def: &ast::Fn) -> Optio\n }\n \n pub(crate) fn runnable_fn(sema: &Semantics<RootDatabase>, def: hir::Function) -> Option<Runnable> {\n-    let func = def.source(sema.db)?;\n+    // #[test/bench] expands to just the item causing us to lose the attribute, so recover them by going out of the attribute\n+    let func = def.source(sema.db)?.map_out_of_test_attr(sema.db);\n     let name_string = def.name(sema.db).to_string();\n \n     let root = def.module(sema.db).krate().root_module(sema.db);\n@@ -501,6 +504,8 @@ fn has_test_function_or_multiple_test_submodules(\n         match item {\n             hir::ModuleDef::Function(f) => {\n                 if let Some(it) = f.source(sema.db) {\n+                    // #[test/bench] expands to just the item causing us to lose the attribute, so recover them by going out of the attribute\n+                    let it = it.map_out_of_test_attr(sema.db);\n                     if test_related_attribute(&it.value).is_some() {\n                         return true;\n                     }"}]}