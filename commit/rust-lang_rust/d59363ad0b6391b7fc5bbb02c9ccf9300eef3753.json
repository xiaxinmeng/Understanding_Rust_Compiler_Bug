{"sha": "d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "node_id": "C_kwDOAAsO6NoAKGQ1OTM2M2FkMGI2MzkxYjdmYzViYmIwMmM5Y2NmOTMwMGVlZjM3NTM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-06-01T20:44:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-06-01T20:44:23Z"}, "message": "Auto merge of #111660 - Kobzol:try-build-skip-docs, r=mark-simulacrum\n\nDo not build docs in try builds\n\nThis PR adds a new environment variable to the optimized build Python script, which causes it to ignore certain parts of the final `dist` build (mainly docs) in try builds. This reduces the duration of try builds by ~10 minutes.", "tree": {"sha": "748d92228f5d256a808a3402397e43a81ea4c02e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/748d92228f5d256a808a3402397e43a81ea4c02e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "html_url": "https://github.com/rust-lang/rust/commit/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "789dd0b2a2cd68c129ba9b0aa1008939209adcfd", "url": "https://api.github.com/repos/rust-lang/rust/commits/789dd0b2a2cd68c129ba9b0aa1008939209adcfd", "html_url": "https://github.com/rust-lang/rust/commit/789dd0b2a2cd68c129ba9b0aa1008939209adcfd"}, {"sha": "db113b1c2bc1b09eb370407e7b217249cd5d263b", "url": "https://api.github.com/repos/rust-lang/rust/commits/db113b1c2bc1b09eb370407e7b217249cd5d263b", "html_url": "https://github.com/rust-lang/rust/commit/db113b1c2bc1b09eb370407e7b217249cd5d263b"}], "stats": {"total": 16, "additions": 16, "deletions": 0}, "files": [{"sha": "210ec72a11e0bc02bed73d36ccda1ec44e67b025", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "patch": "@@ -578,6 +578,7 @@ jobs:\n       actions: write\n     name: \"try - ${{ matrix.name }}\"\n     env:\n+      DIST_TRY_BUILD: 1\n       CI_JOB_NAME: \"${{ matrix.name }}\"\n       CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse\n       SCCACHE_BUCKET: rust-lang-ci-sccache2"}, {"sha": "2fe3438e0fe8a81bee3cc56ed10c30010b8162f7", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "patch": "@@ -264,6 +264,7 @@ docker \\\n   --env RUST_CI_OVERRIDE_RELEASE_CHANNEL \\\n   --env CI_JOB_NAME=\"${CI_JOB_NAME-$IMAGE}\" \\\n   --env BASE_COMMIT=\"$BASE_COMMIT\" \\\n+  --env DIST_TRY_BUILD \\\n   --init \\\n   --rm \\\n   rust-ci \\"}, {"sha": "d3cb6b6ed522031fc7b2ddbc0ba74bf0f782f60b", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "patch": "@@ -757,6 +757,7 @@ jobs:\n     <<: *base-ci-job\n     name: try - ${{ matrix.name }}\n     env:\n+      DIST_TRY_BUILD: 1\n       <<: [*shared-ci-variables, *prod-variables]\n     if: github.event_name == 'push' && (github.ref == 'refs/heads/try' || github.ref == 'refs/heads/try-perf') && github.repository == 'rust-lang-ci/rust'\n     strategy:"}, {"sha": "4141296bd422ea6b7a93c698c56e15801c011479", "filename": "src/ci/stage-build.py", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/src%2Fci%2Fstage-build.py", "raw_url": "https://github.com/rust-lang/rust/raw/d59363ad0b6391b7fc5bbb02c9ccf9300eef3753/src%2Fci%2Fstage-build.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fstage-build.py?ref=d59363ad0b6391b7fc5bbb02c9ccf9300eef3753", "patch": "@@ -48,6 +48,11 @@\n \n LLVM_BOLT_CRATES = LLVM_PGO_CRATES\n \n+\n+def is_try_build() -> bool:\n+    return os.environ.get(\"DIST_TRY_BUILD\", \"0\") != \"0\"\n+\n+\n class Pipeline:\n     # Paths\n     def checkout_path(self) -> Path:\n@@ -851,6 +856,13 @@ def run(runner: BenchmarkRunner):\n \n     build_args = sys.argv[1:]\n \n+    # Skip components that are not needed for try builds to speed them up\n+    if is_try_build():\n+        LOGGER.info(\"Skipping building of unimportant components for a try build\")\n+        for target in (\"rust-docs\", \"rustc-docs\", \"rust-docs-json\", \"rust-analyzer\",\n+                       \"rustc-src\", \"clippy\", \"miri\", \"rustfmt\"):\n+            build_args.extend([\"--exclude\", target])\n+\n     timer = Timer()\n     pipeline = create_pipeline()\n \n@@ -865,6 +877,7 @@ def run(runner: BenchmarkRunner):\n \n     print_binary_sizes(pipeline)\n \n+\n if __name__ == \"__main__\":\n     runner = DefaultBenchmarkRunner()\n     run(runner)"}]}