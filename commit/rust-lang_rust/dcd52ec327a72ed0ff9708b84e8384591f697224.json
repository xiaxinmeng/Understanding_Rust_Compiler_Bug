{"sha": "dcd52ec327a72ed0ff9708b84e8384591f697224", "node_id": "C_kwDOAAsO6NoAKGRjZDUyZWMzMjdhNzJlZDBmZjk3MDhiODRlODM4NDU5MWY2OTcyMjQ", "commit": {"author": {"name": "Amos Wenger", "email": "amoswenger@gmail.com", "date": "2022-07-20T15:43:45Z"}, "committer": {"name": "Amos Wenger", "email": "amoswenger@gmail.com", "date": "2022-07-20T15:43:45Z"}, "message": "Add PROC_MACRO_TEST_TOOLCHAIN environment variable\n\nThis allows overriding the toolchain used to run `proc-macro-srv` tests.", "tree": {"sha": "716742949f0d10c9345624757519c30ce1054a85", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/716742949f0d10c9345624757519c30ce1054a85"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dcd52ec327a72ed0ff9708b84e8384591f697224", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dcd52ec327a72ed0ff9708b84e8384591f697224", "html_url": "https://github.com/rust-lang/rust/commit/dcd52ec327a72ed0ff9708b84e8384591f697224", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dcd52ec327a72ed0ff9708b84e8384591f697224/comments", "author": {"login": "fasterthanlime", "id": 7998310, "node_id": "MDQ6VXNlcjc5OTgzMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/7998310?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fasterthanlime", "html_url": "https://github.com/fasterthanlime", "followers_url": "https://api.github.com/users/fasterthanlime/followers", "following_url": "https://api.github.com/users/fasterthanlime/following{/other_user}", "gists_url": "https://api.github.com/users/fasterthanlime/gists{/gist_id}", "starred_url": "https://api.github.com/users/fasterthanlime/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fasterthanlime/subscriptions", "organizations_url": "https://api.github.com/users/fasterthanlime/orgs", "repos_url": "https://api.github.com/users/fasterthanlime/repos", "events_url": "https://api.github.com/users/fasterthanlime/events{/privacy}", "received_events_url": "https://api.github.com/users/fasterthanlime/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fasterthanlime", "id": 7998310, "node_id": "MDQ6VXNlcjc5OTgzMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/7998310?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fasterthanlime", "html_url": "https://github.com/fasterthanlime", "followers_url": "https://api.github.com/users/fasterthanlime/followers", "following_url": "https://api.github.com/users/fasterthanlime/following{/other_user}", "gists_url": "https://api.github.com/users/fasterthanlime/gists{/gist_id}", "starred_url": "https://api.github.com/users/fasterthanlime/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fasterthanlime/subscriptions", "organizations_url": "https://api.github.com/users/fasterthanlime/orgs", "repos_url": "https://api.github.com/users/fasterthanlime/repos", "events_url": "https://api.github.com/users/fasterthanlime/events{/privacy}", "received_events_url": "https://api.github.com/users/fasterthanlime/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7dc36eeb781fcf35a69bb1a75e7005397a9da418", "url": "https://api.github.com/repos/rust-lang/rust/commits/7dc36eeb781fcf35a69bb1a75e7005397a9da418", "html_url": "https://github.com/rust-lang/rust/commit/7dc36eeb781fcf35a69bb1a75e7005397a9da418"}], "stats": {"total": 17, "additions": 16, "deletions": 1}, "files": [{"sha": "cd99eea5ae3f968028709cb7f76e728123417ed9", "filename": "crates/proc-macro-test/build.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/dcd52ec327a72ed0ff9708b84e8384591f697224/crates%2Fproc-macro-test%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcd52ec327a72ed0ff9708b84e8384591f697224/crates%2Fproc-macro-test%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-test%2Fbuild.rs?ref=dcd52ec327a72ed0ff9708b84e8384591f697224", "patch": "@@ -2,6 +2,10 @@\n //! `OUT_DIR`.\n //!\n //! `proc-macro-test` itself contains only a path to that artifact.\n+//!\n+//! The `PROC_MACRO_TEST_TOOLCHAIN` environment variable can be exported to use\n+//! a specific rustup toolchain: this allows testing against older ABIs (e.g.\n+//! 1.58) and future ABIs (stage1, nightly)\n \n use std::{\n     env, fs,\n@@ -13,6 +17,7 @@ use cargo_metadata::Message;\n \n fn main() {\n     println!(\"cargo:rerun-if-changed=imp\");\n+    println!(\"cargo:rerun-if-env-changed=PROC_MACRO_TEST_TOOLCHAIN\");\n \n     let out_dir = env::var_os(\"OUT_DIR\").unwrap();\n     let out_dir = Path::new(&out_dir);\n@@ -47,7 +52,17 @@ fn main() {\n     }\n \n     let target_dir = out_dir.join(\"target\");\n-    let output = Command::new(toolchain::cargo())\n+\n+    let mut cmd = if let Ok(toolchain) = std::env::var(\"PROC_MACRO_TEST_TOOLCHAIN\") {\n+        // leverage rustup to find user-specific toolchain\n+        let mut cmd = Command::new(\"cargo\");\n+        cmd.arg(format!(\"+{toolchain}\"));\n+        cmd\n+    } else {\n+        Command::new(toolchain::cargo())\n+    };\n+\n+    let output = cmd\n         .current_dir(&staging_dir)\n         .args(&[\"build\", \"-p\", \"proc-macro-test-impl\", \"--message-format\", \"json\"])\n         // Explicit override the target directory to avoid using the same one which the parent"}]}