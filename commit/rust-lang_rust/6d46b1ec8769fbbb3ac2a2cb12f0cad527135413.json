{"sha": "6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "node_id": "C_kwDOAAsO6NoAKDZkNDZiMWVjODc2OWZiYmIzYWMyYTJjYjEyZjBjYWQ1MjcxMzU0MTM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-18T16:37:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-18T16:37:33Z"}, "message": "Auto merge of #106503 - cjgillot:remap-nofilter, r=oli-obk\n\nDo not filter substs in `remap_generic_params_to_declaration_params`.\n\nThe relevant filtering should have been performed by borrowck.\n\nFixes https://github.com/rust-lang/rust/issues/105826\n\nr? types", "tree": {"sha": "580dcd2816159a172d0e2f9acdfa863ccfdb56b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/580dcd2816159a172d0e2f9acdfa863ccfdb56b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "html_url": "https://github.com/rust-lang/rust/commit/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1f72129ffe5e8c495113f9a2d4e1730f7fad3209", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f72129ffe5e8c495113f9a2d4e1730f7fad3209", "html_url": "https://github.com/rust-lang/rust/commit/1f72129ffe5e8c495113f9a2d4e1730f7fad3209"}, {"sha": "b7bb8a5ce98eddeed8c16229925688d1c2abfbc9", "url": "https://api.github.com/repos/rust-lang/rust/commits/b7bb8a5ce98eddeed8c16229925688d1c2abfbc9", "html_url": "https://github.com/rust-lang/rust/commit/b7bb8a5ce98eddeed8c16229925688d1c2abfbc9"}], "stats": {"total": 69, "additions": 41, "deletions": 28}, "files": [{"sha": "db5a67a8b442d97e13678b8262a7f2cdc197580d", "filename": "compiler/rustc_borrowck/src/region_infer/opaque_types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fopaque_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fopaque_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fopaque_types.rs?ref=6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "patch": "@@ -252,7 +252,7 @@ impl<'tcx> InferCtxtExt<'tcx> for InferCtxt<'tcx> {\n         }\n \n         let definition_ty = instantiated_ty\n-            .remap_generic_params_to_declaration_params(opaque_type_key, self.tcx, false, origin)\n+            .remap_generic_params_to_declaration_params(opaque_type_key, self.tcx, false)\n             .ty;\n \n         if !check_opaque_type_parameter_valid("}, {"sha": "30ef7f3ba2927f28aec03cbf13af091278ce4422", "filename": "compiler/rustc_hir_typeck/src/writeback.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs?ref=6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "patch": "@@ -564,7 +564,6 @@ impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n                 opaque_type_key,\n                 self.fcx.infcx.tcx,\n                 true,\n-                decl.origin,\n             );\n \n             self.typeck_results.concrete_opaque_types.insert(opaque_type_key.def_id, hidden_type);"}, {"sha": "ccac6e8f77a6557d00136dfd6eb8970d6a5e7e32", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 1, "deletions": 26, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "patch": "@@ -28,7 +28,6 @@ use crate::ty::util::Discr;\n pub use adt::*;\n pub use assoc::*;\n pub use generics::*;\n-use hir::OpaqueTyOrigin;\n use rustc_ast as ast;\n use rustc_ast::node_id::NodeMap;\n use rustc_attr as attr;\n@@ -1345,7 +1344,6 @@ impl<'tcx> OpaqueHiddenType<'tcx> {\n         tcx: TyCtxt<'tcx>,\n         // typeck errors have subpar spans for opaque types, so delay error reporting until borrowck.\n         ignore_errors: bool,\n-        origin: OpaqueTyOrigin,\n     ) -> Self {\n         let OpaqueTypeKey { def_id, substs } = opaque_type_key;\n \n@@ -1361,30 +1359,7 @@ impl<'tcx> OpaqueHiddenType<'tcx> {\n         // This zip may have several times the same lifetime in `substs` paired with a different\n         // lifetime from `id_substs`. Simply `collect`ing the iterator is the correct behaviour:\n         // it will pick the last one, which is the one we introduced in the impl-trait desugaring.\n-        let map = substs.iter().zip(id_substs);\n-\n-        let map: FxHashMap<GenericArg<'tcx>, GenericArg<'tcx>> = match origin {\n-            // HACK: The HIR lowering for async fn does not generate\n-            // any `+ Captures<'x>` bounds for the `impl Future<...>`, so all async fns with lifetimes\n-            // would now fail to compile. We should probably just make hir lowering fill this in properly.\n-            OpaqueTyOrigin::AsyncFn(_) => map.collect(),\n-            OpaqueTyOrigin::FnReturn(_) | OpaqueTyOrigin::TyAlias => {\n-                // Opaque types may only use regions that are bound. So for\n-                // ```rust\n-                // type Foo<'a, 'b, 'c> = impl Trait<'a> + 'b;\n-                // ```\n-                // we may not use `'c` in the hidden type.\n-                let variances = tcx.variances_of(def_id);\n-                debug!(?variances);\n-\n-                map.filter(|(_, v)| {\n-                    let ty::GenericArgKind::Lifetime(lt) = v.unpack() else { return true };\n-                    let ty::ReEarlyBound(ebr) = lt.kind() else { bug!() };\n-                    variances[ebr.index as usize] == ty::Variance::Invariant\n-                })\n-                .collect()\n-            }\n-        };\n+        let map = substs.iter().zip(id_substs).collect();\n         debug!(\"map = {:#?}\", map);\n \n         // Convert the type from the function into a type valid outside"}, {"sha": "06dc2d4c8d34bf812d0b69eb61e90c453fc8247b", "filename": "tests/ui/impl-trait/issues/issue-105826.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/tests%2Fui%2Fimpl-trait%2Fissues%2Fissue-105826.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d46b1ec8769fbbb3ac2a2cb12f0cad527135413/tests%2Fui%2Fimpl-trait%2Fissues%2Fissue-105826.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fissues%2Fissue-105826.rs?ref=6d46b1ec8769fbbb3ac2a2cb12f0cad527135413", "patch": "@@ -0,0 +1,39 @@\n+// check-pass\n+\n+use std::io::Write;\n+\n+struct A(Vec<u8>);\n+\n+struct B<'a> {\n+    one: &'a mut A,\n+    two: &'a mut Vec<u8>,\n+    three: Vec<u8>,\n+}\n+\n+impl<'a> B<'a> {\n+    fn one(&mut self) -> &mut impl Write {\n+        &mut self.one.0\n+    }\n+    fn two(&mut self) -> &mut impl Write {\n+        &mut *self.two\n+    }\n+    fn three(&mut self) -> &mut impl Write {\n+        &mut self.three\n+    }\n+}\n+\n+struct C<'a>(B<'a>);\n+\n+impl<'a> C<'a> {\n+    fn one(&mut self) -> &mut impl Write {\n+        self.0.one()\n+    }\n+    fn two(&mut self) -> &mut impl Write {\n+        self.0.two()\n+    }\n+    fn three(&mut self) -> &mut impl Write {\n+        self.0.three()\n+    }\n+}\n+\n+fn main() {}"}]}