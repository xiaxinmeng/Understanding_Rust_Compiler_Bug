{"sha": "a45b3ac1836b8d29a2a7b199aed169402aa01805", "node_id": "C_kwDOAAsO6NoAKGE0NWIzYWMxODM2YjhkMjlhMmE3YjE5OWFlZDE2OTQwMmFhMDE4MDU", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2022-01-04T13:06:08Z"}, "committer": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2022-01-04T13:08:44Z"}, "message": "Simpilfy thread::JoinInner.", "tree": {"sha": "d1e27f1b2cfcca32466391e358fb12a29e0939a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1e27f1b2cfcca32466391e358fb12a29e0939a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a45b3ac1836b8d29a2a7b199aed169402aa01805", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a45b3ac1836b8d29a2a7b199aed169402aa01805", "html_url": "https://github.com/rust-lang/rust/commit/a45b3ac1836b8d29a2a7b199aed169402aa01805", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a45b3ac1836b8d29a2a7b199aed169402aa01805/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b60e32c82864d841e87359333af1e6d1f9cff9ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/b60e32c82864d841e87359333af1e6d1f9cff9ee", "html_url": "https://github.com/rust-lang/rust/commit/b60e32c82864d841e87359333af1e6d1f9cff9ee"}], "stats": {"total": 18, "additions": 9, "deletions": 9}, "files": [{"sha": "c799b64c05b2d34fbbe79c99262d6829481f2a9f", "filename": "library/std/src/thread/mod.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a45b3ac1836b8d29a2a7b199aed169402aa01805/library%2Fstd%2Fsrc%2Fthread%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a45b3ac1836b8d29a2a7b199aed169402aa01805/library%2Fstd%2Fsrc%2Fthread%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fthread%2Fmod.rs?ref=a45b3ac1836b8d29a2a7b199aed169402aa01805", "patch": "@@ -498,12 +498,12 @@ impl Builder {\n             // exist after the thread has terminated, which is signaled by `Thread::join`\n             // returning.\n             native: unsafe {\n-                Some(imp::Thread::new(\n+                imp::Thread::new(\n                     stack_size,\n                     mem::transmute::<Box<dyn FnOnce() + 'a>, Box<dyn FnOnce() + 'static>>(\n                         Box::new(main),\n                     ),\n-                )?)\n+                )?\n             },\n             thread: my_thread,\n             packet: Packet(my_packet),\n@@ -1258,15 +1258,15 @@ unsafe impl<T: Sync> Sync for Packet<T> {}\n \n /// Inner representation for JoinHandle\n struct JoinInner<T> {\n-    native: Option<imp::Thread>,\n+    native: imp::Thread,\n     thread: Thread,\n     packet: Packet<T>,\n }\n \n impl<T> JoinInner<T> {\n-    fn join(&mut self) -> Result<T> {\n-        self.native.take().unwrap().join();\n-        unsafe { (*self.packet.0.get()).take().unwrap() }\n+    fn join(mut self) -> Result<T> {\n+        self.native.join();\n+        Arc::get_mut(&mut self.packet.0).unwrap().get_mut().take().unwrap()\n     }\n }\n \n@@ -1397,7 +1397,7 @@ impl<T> JoinHandle<T> {\n     /// join_handle.join().expect(\"Couldn't join on the associated thread\");\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn join(mut self) -> Result<T> {\n+    pub fn join(self) -> Result<T> {\n         self.0.join()\n     }\n \n@@ -1413,13 +1413,13 @@ impl<T> JoinHandle<T> {\n \n impl<T> AsInner<imp::Thread> for JoinHandle<T> {\n     fn as_inner(&self) -> &imp::Thread {\n-        self.0.native.as_ref().unwrap()\n+        &self.0.native\n     }\n }\n \n impl<T> IntoInner<imp::Thread> for JoinHandle<T> {\n     fn into_inner(self) -> imp::Thread {\n-        self.0.native.unwrap()\n+        self.0.native\n     }\n }\n "}]}