{"sha": "a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2YWY2ZDY1MDZlMDQyMGYyYTYyY2U1MTlkYjAyOWM5N2Y4Y2RkMGI=", "commit": {"author": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-08-09T11:05:50Z"}, "committer": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-08-29T08:34:53Z"}, "message": "Provide structured suggestion for removal of `&mut`", "tree": {"sha": "2ec17e38cfabec5be4f7d06bada6365e74363d0c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2ec17e38cfabec5be4f7d06bada6365e74363d0c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "html_url": "https://github.com/rust-lang/rust/commit/a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4368de7b1a70ca2c9f140570fdbbe974c737bc6", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4368de7b1a70ca2c9f140570fdbbe974c737bc6", "html_url": "https://github.com/rust-lang/rust/commit/e4368de7b1a70ca2c9f140570fdbbe974c737bc6"}], "stats": {"total": 42, "additions": 28, "deletions": 14}, "files": [{"sha": "4e079ed865ac31d4f29ecaea2285fd8d86407811", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/mutability_errors.rs", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs?ref=a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "patch": "@@ -12,7 +12,7 @@ use rustc_middle::{\n };\n use rustc_span::source_map::DesugaringKind;\n use rustc_span::symbol::{kw, Symbol};\n-use rustc_span::Span;\n+use rustc_span::{BytePos, Span};\n \n use crate::borrow_check::diagnostics::BorrowedContentSource;\n use crate::borrow_check::MirBorrowckCtxt;\n@@ -278,7 +278,25 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                             );\n                         }\n                     }\n-                    err.span_help(source_info.span, \"try removing `&mut` here\");\n+                    if let Ok(snippet) =\n+                        self.infcx.tcx.sess.source_map().span_to_snippet(source_info.span)\n+                    {\n+                        if snippet.starts_with(\"&mut \") {\n+                            // We don't have access to the HIR to get accurate spans, but we can\n+                            // give a best effort structured suggestion.\n+                            err.span_suggestion_verbose(\n+                                source_info.span.with_hi(source_info.span.lo() + BytePos(5)),\n+                                \"try removing `&mut` here\",\n+                                String::new(),\n+                                Applicability::MachineApplicable,\n+                            );\n+                        } else {\n+                            // This can occur with things like `(&mut self).foo()`.\n+                            err.span_help(source_info.span, \"try removing `&mut` here\");\n+                        }\n+                    } else {\n+                        err.span_help(source_info.span, \"try removing `&mut` here\");\n+                    }\n                 } else if decl.mutability == Mutability::Not\n                     && !matches!(\n                         decl.local_info,"}, {"sha": "aa7771a736cfe11cf1e5189726502a4fa6e30c2e", "filename": "src/test/ui/borrowck/mut-borrow-of-mut-ref.stderr", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmut-borrow-of-mut-ref.stderr?ref=a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "patch": "@@ -10,10 +10,9 @@ note: the binding is already a mutable borrow\n LL | pub fn f(b: &mut i32) {\n    |             ^^^^^^^^\n help: try removing `&mut` here\n-  --> $DIR/mut-borrow-of-mut-ref.rs:7:7\n    |\n-LL |     h(&mut b);\n-   |       ^^^^^^\n+LL |     h(b);\n+   |      --\n \n error[E0596]: cannot borrow `b` as mutable, as it is not declared as mutable\n   --> $DIR/mut-borrow-of-mut-ref.rs:11:12\n@@ -27,10 +26,9 @@ note: the binding is already a mutable borrow\n LL | pub fn f(b: &mut i32) {\n    |             ^^^^^^^^\n help: try removing `&mut` here\n-  --> $DIR/mut-borrow-of-mut-ref.rs:11:12\n    |\n-LL |     g(&mut &mut b);\n-   |            ^^^^^^\n+LL |     g(&mut b);\n+   |           --\n \n error[E0596]: cannot borrow `b` as mutable, as it is not declared as mutable\n   --> $DIR/mut-borrow-of-mut-ref.rs:18:12\n@@ -44,10 +42,9 @@ note: the binding is already a mutable borrow\n LL | pub fn g(b: &mut i32) {\n    |             ^^^^^^^^\n help: try removing `&mut` here\n-  --> $DIR/mut-borrow-of-mut-ref.rs:18:12\n    |\n-LL |     h(&mut &mut b);\n-   |            ^^^^^^\n+LL |     h(&mut b);\n+   |           --\n \n error[E0596]: cannot borrow `f` as mutable, as it is not declared as mutable\n   --> $DIR/mut-borrow-of-mut-ref.rs:35:5"}, {"sha": "86bc27106a9c1d2fc42841f467eb4843fe9bdba5", "filename": "src/test/ui/did_you_mean/issue-34126.stderr", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-34126.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a6af6d6506e0420f2a62ce519db029c97f8cdd0b/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-34126.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-34126.stderr?ref=a6af6d6506e0420f2a62ce519db029c97f8cdd0b", "patch": "@@ -10,10 +10,9 @@ note: the binding is already a mutable borrow\n LL |     fn start(&mut self) {\n    |              ^^^^^^^^^\n help: try removing `&mut` here\n-  --> $DIR/issue-34126.rs:6:18\n    |\n-LL |         self.run(&mut self);\n-   |                  ^^^^^^^^^\n+LL |         self.run(self);\n+   |                 --\n \n error[E0502]: cannot borrow `self` as mutable because it is also borrowed as immutable\n   --> $DIR/issue-34126.rs:6:18"}]}