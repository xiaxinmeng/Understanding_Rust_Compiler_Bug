{"sha": "22b57f6435192d5354d2c03bcb5cef5532c8a15c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIyYjU3ZjY0MzUxOTJkNTM1NGQyYzAzYmNiNWNlZjU1MzJjOGExNWM=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-04-18T17:28:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-04-18T17:28:25Z"}, "message": "Merge branch 'master' into stacked-borrows-2", "tree": {"sha": "2b6ca9fa5f5ef793c4badb01abfd650b278cde7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b6ca9fa5f5ef793c4badb01abfd650b278cde7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/22b57f6435192d5354d2c03bcb5cef5532c8a15c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcuLO5CRBK7hj4Ov3rIwAAdHIIABjKj+FRGiafPiFyvkOqd9nY\nBO2CRqQ6vVq58O5quXwVFLx5EKnhf3LlfYTWn3nrARw6G7N+6FfcqA6tahAyOlI+\n1/XjJgpJ/3XjRlIzdZV0BjI9L4ue0ntrRKyvy/27YtY9tQr/IqoVeLFEXNSGsUQl\nMeiemW9y+KU7Q195QbA7Nl7OJGysFo17OkfiGDqodyNFjY3cwuykwN4RMze0lw4f\n8IOyBF/DLtGfksZI4k8K0L6QeXPTE8knAD1cyoI80WJX6RUbYrLpbcsEZqFI/AR+\natIGZnsr5aHNi2At/fizXukjF9nz4bPU5E1B+10Qxd072DhoUlovrv5GmZdajac=\n=eYV0\n-----END PGP SIGNATURE-----\n", "payload": "tree 2b6ca9fa5f5ef793c4badb01abfd650b278cde7f\nparent 107b8b8ed920f286a21273785a1deeacf0d68799\nparent 7d7cf4d42e41437f5a5b04a6b8dd567f330ae6ee\nauthor Ralf Jung <post@ralfj.de> 1555608505 +0200\ncommitter GitHub <noreply@github.com> 1555608505 +0200\n\nMerge branch 'master' into stacked-borrows-2"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/22b57f6435192d5354d2c03bcb5cef5532c8a15c", "html_url": "https://github.com/rust-lang/rust/commit/22b57f6435192d5354d2c03bcb5cef5532c8a15c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/22b57f6435192d5354d2c03bcb5cef5532c8a15c/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "107b8b8ed920f286a21273785a1deeacf0d68799", "url": "https://api.github.com/repos/rust-lang/rust/commits/107b8b8ed920f286a21273785a1deeacf0d68799", "html_url": "https://github.com/rust-lang/rust/commit/107b8b8ed920f286a21273785a1deeacf0d68799"}, {"sha": "7d7cf4d42e41437f5a5b04a6b8dd567f330ae6ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d7cf4d42e41437f5a5b04a6b8dd567f330ae6ee", "html_url": "https://github.com/rust-lang/rust/commit/7d7cf4d42e41437f5a5b04a6b8dd567f330ae6ee"}], "stats": {"total": 84, "additions": 84, "deletions": 0}, "files": [{"sha": "ae6aff10ac209728a85fb244e787fd19cf757709", "filename": "src/fn_call.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/22b57f6435192d5354d2c03bcb5cef5532c8a15c/src%2Ffn_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22b57f6435192d5354d2c03bcb5cef5532c8a15c/src%2Ffn_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ffn_call.rs?ref=22b57f6435192d5354d2c03bcb5cef5532c8a15c", "patch": "@@ -147,6 +147,45 @@ pub trait EvalContextExt<'a, 'mir, 'tcx: 'a + 'mir>: crate::MiriEvalContextExt<'\n                     )?;\n                 }\n             }\n+            \"realloc\" => {\n+                let old_ptr = this.read_scalar(args[0])?.not_undef()?;\n+                let new_size = this.read_scalar(args[1])?.to_usize(this)?;\n+                let align = this.tcx.data_layout.pointer_align.abi;\n+                if old_ptr.is_null_ptr(this) {\n+                    if new_size == 0 {\n+                        this.write_null(dest)?;\n+                    } else {\n+                        let new_ptr = this.memory_mut().allocate(\n+                            Size::from_bytes(new_size),\n+                            align,\n+                            MiriMemoryKind::C.into()\n+                        );\n+                        this.write_scalar(Scalar::Ptr(new_ptr), dest)?;\n+                    }\n+                } else {\n+                    let old_ptr = old_ptr.to_ptr()?;\n+                    let memory = this.memory_mut();\n+                    let old_size = Size::from_bytes(memory.get(old_ptr.alloc_id)?.bytes.len() as u64);\n+                    if new_size == 0 {\n+                        memory.deallocate(\n+                            old_ptr,\n+                            Some((old_size, align)),\n+                            MiriMemoryKind::C.into(),\n+                        )?;\n+                        this.write_null(dest)?;\n+                    } else {\n+                        let new_ptr = memory.reallocate(\n+                            old_ptr,\n+                            old_size,\n+                            align,\n+                            Size::from_bytes(new_size),\n+                            align,\n+                            MiriMemoryKind::C.into(),\n+                        )?;\n+                        this.write_scalar(Scalar::Ptr(new_ptr), dest)?;\n+                    }\n+                }\n+            }\n \n             \"__rust_alloc\" => {\n                 let size = this.read_scalar(args[0])?.to_usize(this)?;"}, {"sha": "c23b3e645c70350913de10b72ba54d5602526f8a", "filename": "tests/run-pass/realloc.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/22b57f6435192d5354d2c03bcb5cef5532c8a15c/tests%2Frun-pass%2Frealloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22b57f6435192d5354d2c03bcb5cef5532c8a15c/tests%2Frun-pass%2Frealloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Frealloc.rs?ref=22b57f6435192d5354d2c03bcb5cef5532c8a15c", "patch": "@@ -0,0 +1,45 @@\n+//ignore-windows: Uses POSIX APIs\n+\n+#![feature(rustc_private)]\n+\n+use core::{slice, ptr};\n+\n+extern crate libc;\n+\n+fn main() {\n+    unsafe {\n+        // Use calloc for initialized memory\n+        let p1 = libc::calloc(20, 1);\n+\n+        // old size < new size\n+        let p2 = libc::realloc(p1, 40);\n+        let slice = slice::from_raw_parts(p2 as *const u8, 20);\n+        assert_eq!(&slice, &[0_u8; 20]);\n+\n+        // old size == new size\n+        let p3 = libc::realloc(p2, 40);\n+        let slice = slice::from_raw_parts(p3 as *const u8, 20);\n+        assert_eq!(&slice, &[0_u8; 20]);\n+\n+        // old size > new size\n+        let p4 = libc::realloc(p3, 10);\n+        let slice = slice::from_raw_parts(p4 as *const u8, 10);\n+        assert_eq!(&slice, &[0_u8; 10]);\n+\n+        libc::free(p4);\n+    }\n+\n+    unsafe {\n+        let p1 = libc::malloc(20);\n+\n+        let p2 = libc::realloc(p1, 0);\n+        assert!(p2.is_null());\n+    }\n+\n+    unsafe {\n+        let p1 = libc::realloc(ptr::null_mut(), 20);\n+        assert!(!p1.is_null());\n+\n+        libc::free(p1);\n+    }\n+}"}]}