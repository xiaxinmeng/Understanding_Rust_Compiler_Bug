{"sha": "8aa3eba564275448a7f443646fefbe6558a6e34c", "node_id": "C_kwDOAAsO6NoAKDhhYTNlYmE1NjQyNzU0NDhhN2Y0NDM2NDZmZWZiZTY1NThhNmUzNGM", "commit": {"author": {"name": "AngelicosPhosphoros", "email": "angelicos.phosphoros@protonmail.com", "date": "2023-05-21T17:53:02Z"}, "committer": {"name": "AngelicosPhosphoros", "email": "xuzin.timur@gmail.com", "date": "2023-05-25T19:34:42Z"}, "message": "Added build instructions for cranelift backend as part of Rust repo\n\nAll other instructions assume that user works with separate repository than Rust compiler repository. When one follows default instructions, cranelift codegen tries to use different sys-root and compiler internal crates which leads to compiler errors when building it.\n\nI needed to do all this steps while adding new intrinsic to rustc.", "tree": {"sha": "1715c4ffd53aa95f8dce44d4dc863f0efbb51028", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1715c4ffd53aa95f8dce44d4dc863f0efbb51028"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8aa3eba564275448a7f443646fefbe6558a6e34c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8aa3eba564275448a7f443646fefbe6558a6e34c", "html_url": "https://github.com/rust-lang/rust/commit/8aa3eba564275448a7f443646fefbe6558a6e34c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8aa3eba564275448a7f443646fefbe6558a6e34c/comments", "author": {"login": "AngelicosPhosphoros", "id": 13154246, "node_id": "MDQ6VXNlcjEzMTU0MjQ2", "avatar_url": "https://avatars.githubusercontent.com/u/13154246?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AngelicosPhosphoros", "html_url": "https://github.com/AngelicosPhosphoros", "followers_url": "https://api.github.com/users/AngelicosPhosphoros/followers", "following_url": "https://api.github.com/users/AngelicosPhosphoros/following{/other_user}", "gists_url": "https://api.github.com/users/AngelicosPhosphoros/gists{/gist_id}", "starred_url": "https://api.github.com/users/AngelicosPhosphoros/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AngelicosPhosphoros/subscriptions", "organizations_url": "https://api.github.com/users/AngelicosPhosphoros/orgs", "repos_url": "https://api.github.com/users/AngelicosPhosphoros/repos", "events_url": "https://api.github.com/users/AngelicosPhosphoros/events{/privacy}", "received_events_url": "https://api.github.com/users/AngelicosPhosphoros/received_events", "type": "User", "site_admin": false}, "committer": {"login": "AngelicosPhosphoros", "id": 13154246, "node_id": "MDQ6VXNlcjEzMTU0MjQ2", "avatar_url": "https://avatars.githubusercontent.com/u/13154246?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AngelicosPhosphoros", "html_url": "https://github.com/AngelicosPhosphoros", "followers_url": "https://api.github.com/users/AngelicosPhosphoros/followers", "following_url": "https://api.github.com/users/AngelicosPhosphoros/following{/other_user}", "gists_url": "https://api.github.com/users/AngelicosPhosphoros/gists{/gist_id}", "starred_url": "https://api.github.com/users/AngelicosPhosphoros/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AngelicosPhosphoros/subscriptions", "organizations_url": "https://api.github.com/users/AngelicosPhosphoros/orgs", "repos_url": "https://api.github.com/users/AngelicosPhosphoros/repos", "events_url": "https://api.github.com/users/AngelicosPhosphoros/events{/privacy}", "received_events_url": "https://api.github.com/users/AngelicosPhosphoros/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84644eb9c66281d31c9261a8ab7ccf99f2f2055e", "url": "https://api.github.com/repos/rust-lang/rust/commits/84644eb9c66281d31c9261a8ab7ccf99f2f2055e", "html_url": "https://github.com/rust-lang/rust/commit/84644eb9c66281d31c9261a8ab7ccf99f2f2055e"}], "stats": {"total": 26, "additions": 26, "deletions": 0}, "files": [{"sha": "26dccf309e1e402ff3e8700850bc1a2e81ad43d0", "filename": "Readme.md", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/8aa3eba564275448a7f443646fefbe6558a6e34c/Readme.md", "raw_url": "https://github.com/rust-lang/rust/raw/8aa3eba564275448a7f443646fefbe6558a6e34c/Readme.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Readme.md?ref=8aa3eba564275448a7f443646fefbe6558a6e34c", "patch": "@@ -42,6 +42,32 @@ This will build your project with rustc_codegen_cranelift instead of the usual L\n \n For additional ways to use rustc_codegen_cranelift like the JIT mode see [usage.md](docs/usage.md).\n \n+## Building and testing with changes in rustc code\n+\n+This is useful when changing code in `rustc_codegen_cranelift` as part of changing [main Rust repository](https://github.com/rust-lang/rust/).\n+This can happen, for example, when you are implementing a new compiler intrinsic.\n+\n+Instruction below uses `$RustCheckoutDir` as substitute for any folder where you cloned Rust repository.\n+\n+You need to do this steps to successfully compile and use the cranelift backend with your changes in rustc code:\n+\n+1. `cd $RustCheckoutDir`\n+2. Run `python x.py setup` and choose option for compiler (`b`).\n+3. Build compiler and necessary tools: `python x.py build --stage=2 compiler library/std src/tools/rustdoc src/tools/rustfmt`\n+   * (Optional) You can also build cargo by adding `src/tools/cargo` to previous command.\n+4. Copy exectutable files from `./build/host/stage2-tools/<your hostname triple>/release`\n+to `./build/host/stage2/bin/`. Note that you would need to do this every time you rebuilt `rust` repository.\n+5. Copy cargo from another toolchain: `cp $(rustup which cargo) .build/<your hostname triple>/stage2/bin/cargo`\n+   * Another option is to build it at step 3 and copy with other executables at step 4.\n+6. Link your new `rustc` to toolchain: `rustup toolchain link stage2 ./build/host/stage2/`.\n+7. (Windows only) compile y.rs: `rustc +stage2 -O y.rs`.\n+8. You need to prefix every `./y.rs` (or `y` if you built `y.rs`) command by `rustup run stage2` to make cg_clif use your local changes in rustc.\n+\n+  * `rustup run stage2 ./y.rs prepare`\n+  * `rustup run stage2 ./y.rs build`\n+  * (Optional) run tests: `rustup run stage2 ./y.rs test`\n+9. Now you can use your cg_clif build to compile other Rust programs, e.g. you can open any Rust crate and run commands like `$RustCheckoutDir/compiler/rustc_codegen_cranelift/dist/cargo-clif build --release`.\n+\n ## Configuration\n \n See the documentation on the `BackendConfig` struct in [config.rs](src/config.rs) for all"}]}