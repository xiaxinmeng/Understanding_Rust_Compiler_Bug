{"sha": "fcdb313bd5a37ee36247cc608d01387c7456657a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjZGIzMTNiZDVhMzdlZTM2MjQ3Y2M2MDhkMDEzODdjNzQ1NjY1N2E=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-11-11T20:35:43Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-11-11T20:35:43Z"}, "message": "Give task-perf-word-count default behavior. Closes #1172", "tree": {"sha": "8490a5fcd7b894a21ab7376d327f815b525f02e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8490a5fcd7b894a21ab7376d327f815b525f02e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fcdb313bd5a37ee36247cc608d01387c7456657a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fcdb313bd5a37ee36247cc608d01387c7456657a", "html_url": "https://github.com/rust-lang/rust/commit/fcdb313bd5a37ee36247cc608d01387c7456657a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fcdb313bd5a37ee36247cc608d01387c7456657a/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2385deaa0dcf2f3935e1c6a7d016ed25704ce063", "url": "https://api.github.com/repos/rust-lang/rust/commits/2385deaa0dcf2f3935e1c6a7d016ed25704ce063", "html_url": "https://github.com/rust-lang/rust/commit/2385deaa0dcf2f3935e1c6a7d016ed25704ce063"}], "stats": {"total": 190, "additions": 172, "deletions": 18}, "files": [{"sha": "2d4e14af0586122a03e2d2e40e97fd5413142c32", "filename": "src/test/bench/task-perf-word-count.rs", "status": "modified", "additions": 172, "deletions": 18, "changes": 190, "blob_url": "https://github.com/rust-lang/rust/blob/fcdb313bd5a37ee36247cc608d01387c7456657a/src%2Ftest%2Fbench%2Ftask-perf-word-count.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fcdb313bd5a37ee36247cc608d01387c7456657a/src%2Ftest%2Fbench%2Ftask-perf-word-count.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fbench%2Ftask-perf-word-count.rs?ref=fcdb313bd5a37ee36247cc608d01387c7456657a", "patch": "@@ -30,8 +30,8 @@ import std::comm::port;\n import std::comm::recv;\n import std::comm::send;\n \n-fn map(filename: str, emit: map_reduce::putter) {\n-    let f = result::get(io::file_reader(filename));\n+fn map(input: str, emit: map_reduce::putter) {\n+    let f = io::string_reader(input);\n \n \n     while true {\n@@ -67,7 +67,7 @@ mod map_reduce {\n \n     tag reduce_proto { emit_val(int); done; ref; release; }\n \n-    fn start_mappers(ctrl: chan<ctrl_proto>, inputs: [str]) ->\n+    fn start_mappers(ctrl: chan<ctrl_proto>, -inputs: [str]) ->\n        [joinable_task] {\n         let tasks = [];\n         for i: str in inputs {\n@@ -137,7 +137,7 @@ mod map_reduce {\n         reduce(key, bind get(p, ref_count, is_done));\n     }\n \n-    fn map_reduce(inputs: [str]) {\n+    fn map_reduce(-inputs: [str]) {\n         let ctrl = port::<ctrl_proto>();\n \n         // This task becomes the master control task. It task::_spawns\n@@ -147,9 +147,8 @@ mod map_reduce {\n \n         reducers = map::new_str_hash();\n \n-        let tasks = start_mappers(chan(ctrl), inputs);\n-\n         let num_mappers = vec::len(inputs) as int;\n+        let tasks = start_mappers(chan(ctrl), inputs);\n \n         while num_mappers > 0 {\n             alt recv(ctrl) {\n@@ -186,24 +185,20 @@ mod map_reduce {\n }\n \n fn main(argv: [str]) {\n-    if vec::len(argv) < 2u {\n-        let out = io::stdout();\n-\n-        out.write_line(#fmt[\"Usage: %s <filename> ...\", argv[0]]);\n-\n-        // TODO: run something just to make sure the code hasn't\n-        // broken yet. This is the unit test mode of this program.\n-\n-        ret;\n-    }\n-\n     // We can get by with 8k stacks, and we'll probably exhaust our\n     // address space otherwise.\n     task::set_min_stack(8192u);\n \n+    let inputs = if vec::len(argv) < 2u {\n+        [input1(), input2(), input3()]\n+    } else {\n+        vec::map({|f| result::get(io::read_whole_file_str(f)) },\n+                 vec::slice(argv, 1u, vec::len(argv)))\n+    };\n+\n     let start = time::precise_time_ns();\n \n-    map_reduce::map_reduce(vec::slice(argv, 1u, vec::len(argv)));\n+    map_reduce::map_reduce(inputs);\n     let stop = time::precise_time_ns();\n \n     let elapsed = stop - start;\n@@ -309,3 +304,162 @@ fn is_alpha_upper(c: char) -> bool {\n fn is_alpha(c: char) -> bool { is_alpha_upper(c) || is_alpha_lower(c) }\n \n fn is_word_char(c: char) -> bool { is_alpha(c) || is_digit(c) || c == '_' }\n+\n+\n+\n+fn input1() -> str { \" Lorem ipsum dolor sit amet, consectetur\n+adipiscing elit. Vestibulum tempor erat a dui commodo congue. Proin ac\n+imperdiet est. Nunc volutpat placerat justo, ac euismod nisl elementum\n+et. Nam a eros eleifend dolor porttitor auctor a a felis. Maecenas dui\n+odio, malesuada eget bibendum at, ultrices suscipit enim. Sed libero\n+dolor, sagittis eget mattis quis, imperdiet quis diam. Praesent eu\n+tristique nunc. Integer blandit commodo elementum. In eros lacus,\n+pretium vel fermentum vitae, euismod ut nulla.\n+\n+Cras eget magna tempor mauris gravida laoreet. Suspendisse venenatis\n+volutpat molestie. Pellentesque suscipit nisl feugiat sem blandit\n+venenatis. Mauris id odio nec est elementum congue sed id\n+diam. Maecenas viverra, mi id aliquam commodo, ipsum dolor iaculis\n+odio, sed fringilla neque ipsum quis orci. Pellentesque dui dolor,\n+faucibus a rutrum sed, faucibus a mi. In eget sodales\n+ipsum. Pellentesque sollicitudin dapibus diam, ac interdum tellus\n+porta ac.\n+\n+Donec ligula mi, sodales vel cursus a, dapibus ut sapien. In convallis\n+tempor libero, id dapibus mi sodales quis. Suspendisse\n+potenti. Vestibulum feugiat bibendum bibendum. Maecenas metus magna,\n+consequat in mollis at, malesuada id sem. Donec interdum viverra enim\n+nec ornare. Donec pellentesque neque magna.\n+\n+Donec euismod, ante quis tempor pretium, leo lectus ornare arcu, sed\n+porttitor nisl ipsum elementum lectus. Nam rhoncus dictum sapien sed\n+tincidunt. Integer sit amet dui orci. Quisque lectus elit, dignissim\n+eget mattis nec, cursus nec erat. Fusce vitae metus nulla, et mattis\n+quam. Nullam sit amet diam augue. Nunc non ante eu enim lacinia\n+condimentum ac eget lectus.\n+\n+Aliquam ut pulvinar tellus. Vestibulum ante ipsum primis in faucibus\n+orci luctus et ultrices posuere cubilia Curae; Pellentesque non urna\n+urna. Nulla facilisi. Aenean in felis quis massa aliquam eleifend non\n+sed libero. Proin sit amet iaculis urna. In hac habitasse platea\n+dictumst. Aenean scelerisque aliquet dolor, sit amet viverra est\n+laoreet nec. Curabitur non urna a augue rhoncus pulvinar. Integer\n+placerat vehicula nisl sed egestas. Morbi iaculis diam at erat\n+sollicitudin nec interdum libero tristique.  \" }\n+\n+fn input2() -> str { \" Lorem ipsum dolor sit amet, consectetur\n+adipiscing elit. Proin enim nibh, scelerisque faucibus accumsan id,\n+feugiat id ipsum. In luctus mauris a massa consequat dignissim. Donec\n+sit amet sem urna. Nullam pellentesque accumsan mi, at convallis arcu\n+pharetra in. Quisque euismod gravida nibh in rutrum. Phasellus laoreet\n+elit porta augue molestie nec imperdiet quam venenatis. Maecenas et\n+egestas arcu. Donec vulputate mauris enim. Aenean malesuada urna sed\n+dui eleifend quis posuere massa malesuada. Proin varius fringilla\n+feugiat. Donec mollis lorem sit amet ligula blandit quis fermentum dui\n+eleifend. Fusce molestie sodales magna in mattis. Aenean imperdiet,\n+elit sit amet accumsan vehicula, velit massa semper nibh, et varius\n+justo sem ut orci. Sed et magna lectus. Vestibulum vehicula, tellus\n+non dapibus mattis, libero ligula ullamcorper odio, in interdum odio\n+sem at mi.\n+\n+Donec ut rhoncus mi. Donec ullamcorper, sem nec laoreet ullamcorper,\n+metus metus accumsan orci, ac luctus est velit a dolor. Donec eros\n+lectus, facilisis ut volutpat sit amet, pellentesque eu\n+velit. Praesent eget nibh et arcu vestibulum consequat. Pellentesque\n+habitant morbi tristique senectus et netus et malesuada fames ac\n+turpis egestas. Pellentesque lectus est, rhoncus ut cursus sit amet,\n+hendrerit quis dui. Maecenas vel purus in tellus luctus semper vel non\n+orci. Proin viverra, erat eget pretium ultrices, quam quam vulputate\n+tortor, eu dapibus risus nunc ac ipsum. Vestibulum ante ipsum primis\n+in faucibus orci luctus et ultrices posuere cubilia Curae; Ut aliquet\n+augue volutpat arcu mattis ullamcorper. Quisque vulputate consectetur\n+massa, quis cursus mauris lacinia vitae. Morbi id mi eu leo accumsan\n+aliquet ac et arcu. Quisque risus nisi, rhoncus vulputate egestas sed,\n+rhoncus quis risus. Sed semper odio sed nulla accumsan vitae auctor\n+tortor mattis.\n+\n+Vivamus vitae mauris turpis. Praesent consectetur mi non sem lacinia a\n+cursus sapien gravida. Aenean viverra turpis sit amet ligula\n+vestibulum a ornare nunc feugiat. Mauris et risus arcu. Cras dictum\n+porta cursus. Donec tempus laoreet eros. Nam nec turpis non dui\n+hendrerit laoreet eu ut ipsum. Nam in sem eget turpis lacinia euismod\n+eu eget nulla.\n+\n+Suspendisse at varius elit. Donec consectetur pharetra massa nec\n+viverra. Cras vehicula lorem id sapien hendrerit tristique. Mauris\n+vitae mi ipsum. Suspendisse feugiat commodo iaculis. Maecenas vitae\n+dignissim nunc. Sed hendrerit, arcu et aliquet suscipit, urna quam\n+fermentum eros, vel accumsan metus quam quis risus. Praesent id eros\n+pulvinar tellus fringilla cursus. Sed nec vulputate ipsum. Suspendisse\n+sagittis, magna vitae faucibus semper, nibh felis vehicula tortor, et\n+molestie velit lorem ac massa.\n+\n+Duis aliquam accumsan lobortis. Morbi interdum cursus risus, vel\n+dapibus nisl fermentum sit amet. Etiam in mauris at lectus lacinia\n+mollis. Proin pretium sem nibh, id scelerisque arcu. Mauris pretium\n+adipiscing metus. Suspendisse quis convallis augue. Aliquam sed dui\n+augue, vel tempor ligula. Suspendisse luctus velit quis urna suscipit\n+sit amet ullamcorper nunc mollis. Praesent vitae velit justo. Donec\n+quis risus felis. Nullam rutrum, odio non varius ornare, tortor odio\n+posuere felis, eget accumsan sem sapien et nunc. Fusce mi neque,\n+elementum non convallis eu, hendrerit id arcu. Morbi tempus tincidunt\n+ullamcorper. Nullam blandit, diam quis sollicitudin tincidunt, elit\n+justo varius lacus, aliquet luctus neque nibh quis turpis. Etiam massa\n+sapien, tristique ut consectetur eu, elementum vel orci.  \" }\n+\n+fn input3() -> str { \" Lorem ipsum dolor sit amet, consectetur\n+adipiscing elit. Pellentesque bibendum sapien ut magna fringilla\n+mollis. Vivamus in neque non metus faucibus accumsan eu pretium\n+nunc. Ut erat augue, pulvinar eget blandit nec, cursus quis\n+ipsum. Aliquam eu ornare risus. Mauris ipsum tortor, posuere vel\n+gravida ut, tincidunt eu nunc. Aenean pellentesque, justo eu aliquam\n+condimentum, neque eros feugiat nibh, in dictum nisi augue euismod\n+lectus. Nam fringilla placerat metus aliquam rutrum. Nullam dapibus\n+vehicula ligula ut tempor. Aliquam vehicula, diam vitae fermentum\n+aliquam, justo augue venenatis enim, porta euismod dolor libero in\n+arcu. Sed sollicitudin dictum eros non ornare. Donec nec purus\n+orci. Mauris euismod fringilla consequat. Praesent non erat quis risus\n+dapibus semper ac adipiscing lorem. Aliquam pulvinar dapibus\n+mollis. Donec fermentum sollicitudin metus, sit amet condimentum leo\n+adipiscing a.\n+\n+Vestibulum mi felis, commodo placerat rhoncus sed, feugiat tincidunt\n+orci. Integer faucibus ornare placerat. Nam et odio massa. Suspendisse\n+porttitor nunc quis mi mollis imperdiet. Ut ut neque ipsum, sit amet\n+facilisis erat. Nam ac lacinia turpis. Vivamus ullamcorper iaculis\n+odio, et euismod sem imperdiet non. Duis porta felis sit amet nunc\n+venenatis eu vestibulum nisi scelerisque. Nullam luctus mollis nunc\n+vel pulvinar. Nam lorem tellus, imperdiet sed sodales eu, auctor ut\n+nunc.\n+\n+Nulla at mauris at leo sagittis varius eu a elit. Etiam consequat,\n+tellus ut sagittis porttitor, est justo convallis eros, quis suscipit\n+justo tortor vitae sem. In in odio augue. Pellentesque habitant morbi\n+tristique senectus et netus et malesuada fames ac turpis\n+egestas. Nulla varius ornare ligula quis euismod. Maecenas lobortis\n+sodales sapien a mattis. Nulla blandit lobortis lacus, ut lobortis\n+neque dictum ut. Praesent semper laoreet nisl. Etiam arcu eros,\n+pretium eget eleifend eu, condimentum quis leo. Donec imperdiet porta\n+erat. Aenean tempor sapien ut arcu porta mollis. Duis ultrices commodo\n+quam venenatis commodo.\n+\n+Aliquam odio tellus, tincidunt nec condimentum pellentesque, semper\n+eget magna. Nam et lacus urna. Pellentesque urna nisi, pharetra vitae\n+dignissim non, scelerisque eu massa. Sed sapien neque, cursus a\n+malesuada ut, porta et quam. Donec odio sapien, blandit non aliquam\n+vel, lobortis quis ligula. Nullam fermentum velit nec quam ultrices et\n+venenatis sapien congue. Pellentesque vitae nunc arcu. Nullam eget\n+laoreet nulla. Curabitur dignissim convallis nunc sed blandit. Sed ac\n+ipsum mi. Ut euismod tellus hendrerit arcu egestas sollicitudin. Nam\n+eget laoreet ipsum. Morbi sed nulla odio, at volutpat ante. Vivamus\n+elementum dictum gravida.\n+\n+Phasellus diam nisi, ullamcorper et placerat non, ultrices ut\n+lectus. Etiam tincidunt scelerisque imperdiet. Quisque pretium pretium\n+urna quis cursus. Sed sit amet velit sem. Maecenas eu orci et leo\n+ultricies dictum. Mauris pellentesque ante a purus gravida\n+convallis. Integer non tellus ante. Nulla hendrerit lobortis augue sit\n+amet vulputate. Donec cursus hendrerit diam convallis\n+luctus. Curabitur ipsum mauris, fermentum quis tincidunt ac, laoreet\n+sollicitudin sapien. Fusce velit urna, gravida non pulvinar eu, tempor\n+id nunc.  \" }\n\\ No newline at end of file"}]}