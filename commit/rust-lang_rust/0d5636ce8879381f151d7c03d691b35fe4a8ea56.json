{"sha": "0d5636ce8879381f151d7c03d691b35fe4a8ea56", "node_id": "C_kwDOAAsO6NoAKDBkNTYzNmNlODg3OTM4MWYxNTFkN2MwM2Q2OTFiMzVmZTRhOGVhNTY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-07-01T04:05:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-01T04:05:52Z"}, "message": "Rollup merge of #98610 - lcnr:emit_inference_failure_err-ice, r=estebank\n\nfix `emit_inference_failure_err` ICE\n\nfixes #98598\n\nthis fix doesn't make me too happy, but :shrug:", "tree": {"sha": "c9d64315df2897c91ceace5c7609d3a7f3b90252", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c9d64315df2897c91ceace5c7609d3a7f3b90252"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d5636ce8879381f151d7c03d691b35fe4a8ea56", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJivnKgCRBK7hj4Ov3rIwAAF8gIAKSZuavVTVj9DBX270Q+Mmct\nzx+hrKmLRs4doJHrIpBBhMauGoOPe3IDSQdTdIjPf/N9g75taQq3xIPfxgzoDFTQ\nDPYFfdKt7INtTYN462aush0WrYtSibhRHW2rrQ9wHkyGokIoiHHrrM0Cg1d9bdqs\nT/YtYyTKmx1LsRKn4IKHAIC+D7TXqUH2RKsIsRhhN+O0IDx9QTJ/BBRmRSFO4pKK\ndSsA+Gkb1DaVM2cw9xNjSEjoy8QHEYXdhMOzoMXI0e7v+9xL8zMhcPqQZW3MCQSG\nrZts1PA6xlSE4fbilwKN74h3Ij/+6BLD4ru79t3rqsKhZKApzKblVhX1SAhuGzg=\n=cKKY\n-----END PGP SIGNATURE-----\n", "payload": "tree c9d64315df2897c91ceace5c7609d3a7f3b90252\nparent acdcdfb61b7b472bfacbb8bb889bdf3204827f2e\nparent e043821e93588addaa0f11ad3a1bd6c9a913b098\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1656648352 +0200\ncommitter GitHub <noreply@github.com> 1656648352 +0200\n\nRollup merge of #98610 - lcnr:emit_inference_failure_err-ice, r=estebank\n\nfix `emit_inference_failure_err` ICE\n\nfixes #98598\n\nthis fix doesn't make me too happy, but :shrug:\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d5636ce8879381f151d7c03d691b35fe4a8ea56", "html_url": "https://github.com/rust-lang/rust/commit/0d5636ce8879381f151d7c03d691b35fe4a8ea56", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d5636ce8879381f151d7c03d691b35fe4a8ea56/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acdcdfb61b7b472bfacbb8bb889bdf3204827f2e", "url": "https://api.github.com/repos/rust-lang/rust/commits/acdcdfb61b7b472bfacbb8bb889bdf3204827f2e", "html_url": "https://github.com/rust-lang/rust/commit/acdcdfb61b7b472bfacbb8bb889bdf3204827f2e"}, {"sha": "e043821e93588addaa0f11ad3a1bd6c9a913b098", "url": "https://api.github.com/repos/rust-lang/rust/commits/e043821e93588addaa0f11ad3a1bd6c9a913b098", "html_url": "https://github.com/rust-lang/rust/commit/e043821e93588addaa0f11ad3a1bd6c9a913b098"}], "stats": {"total": 126, "additions": 119, "deletions": 7}, "files": [{"sha": "d290752614c298ce8fcb39d9eb049bfb7571eb8a", "filename": "compiler/rustc_infer/src/infer/error_reporting/need_type_info.rs", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -334,7 +334,6 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n         let mut local_visitor = FindInferSourceVisitor::new(&self, typeck_results, arg);\n         if let Some(body_id) = body_id {\n             let expr = self.tcx.hir().expect_expr(body_id.hir_id);\n-            debug!(?expr);\n             local_visitor.visit_expr(expr);\n         }\n \n@@ -550,6 +549,7 @@ impl<'tcx> InferSourceKind<'tcx> {\n     }\n }\n \n+#[derive(Debug)]\n struct InsertableGenericArgs<'tcx> {\n     insert_span: Span,\n     substs: SubstsRef<'tcx>,\n@@ -735,10 +735,20 @@ impl<'a, 'tcx> FindInferSourceVisitor<'a, 'tcx> {\n                     return self.path_inferred_subst_iter(expr.hir_id, substs, path);\n                 }\n             }\n-            hir::ExprKind::Struct(path, _, _) => {\n+            // FIXME(#98711): Ideally we would also deal with type relative\n+            // paths here, even if that is quite rare.\n+            //\n+            // See the `need_type_info/expr-struct-type-relative-gat.rs` test\n+            // for an example where that would be needed.\n+            //\n+            // However, the `type_dependent_def_id` for `Self::Output` in an\n+            // impl is currently the `DefId` of `Output` in the trait definition\n+            // which makes this somewhat difficult and prevents us from just\n+            // using `self.path_inferred_subst_iter` here.\n+            hir::ExprKind::Struct(&hir::QPath::Resolved(_self_ty, path), _, _) => {\n                 if let Some(ty) = self.opt_node_type(expr.hir_id) {\n                     if let ty::Adt(_, substs) = ty.kind() {\n-                        return self.path_inferred_subst_iter(expr.hir_id, substs, path);\n+                        return Box::new(self.resolved_path_inferred_subst_iter(path, substs));\n                     }\n                 }\n             }\n@@ -945,6 +955,7 @@ impl<'a, 'tcx> Visitor<'tcx> for FindInferSourceVisitor<'a, 'tcx> {\n         intravisit::walk_body(self, body);\n     }\n \n+    #[instrument(level = \"debug\", skip(self))]\n     fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n         let tcx = self.infcx.tcx;\n         match expr.kind {\n@@ -959,9 +970,9 @@ impl<'a, 'tcx> Visitor<'tcx> for FindInferSourceVisitor<'a, 'tcx> {\n             _ => intravisit::walk_expr(self, expr),\n         }\n \n-        for InsertableGenericArgs { insert_span, substs, generics_def_id, def_id } in\n-            self.expr_inferred_subst_iter(expr)\n-        {\n+        for args in self.expr_inferred_subst_iter(expr) {\n+            debug!(?args);\n+            let InsertableGenericArgs { insert_span, substs, generics_def_id, def_id } = args;\n             let generics = tcx.generics_of(generics_def_id);\n             if let Some(argument_index) =\n                 generics.own_substs(substs).iter().position(|&arg| self.generic_arg_is_target(arg))"}, {"sha": "5ad5692e7623c9abe95f91499c1671f3a7dff7ff", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/_impl.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -156,6 +156,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         self.typeck_results.borrow_mut().field_indices_mut().insert(hir_id, index);\n     }\n \n+    #[instrument(level = \"debug\", skip(self))]\n     pub(in super::super) fn write_resolution(\n         &self,\n         hir_id: hir::HirId,\n@@ -164,8 +165,8 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         self.typeck_results.borrow_mut().type_dependent_defs_mut().insert(hir_id, r);\n     }\n \n+    #[instrument(level = \"debug\", skip(self))]\n     pub fn write_method_call(&self, hir_id: hir::HirId, method: MethodCallee<'tcx>) {\n-        debug!(\"write_method_call(hir_id={:?}, method={:?})\", hir_id, method);\n         self.write_resolution(hir_id, Ok((DefKind::AssocFn, method.def_id)));\n         self.write_substs(hir_id, method.substs);\n "}, {"sha": "42af9fa8d113a4685bcc775c53e63fbf381ea558", "filename": "src/test/ui/inference/need_type_info/expr-struct-type-relative-enum.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-enum.rs?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -0,0 +1,21 @@\n+trait Foo {\n+    type Output;\n+\n+    fn baz() -> Self::Output;\n+}\n+\n+fn needs_infer<T>() {}\n+\n+enum Bar {\n+    Variant {}\n+}\n+\n+impl Foo for u8 {\n+    type Output = Bar;\n+    fn baz() -> Self::Output {\n+        needs_infer(); //~ ERROR type annotations needed\n+        Self::Output::Variant {}\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "68ecb3813483716e9d8d684a99255cce52f513d5", "filename": "src/test/ui/inference/need_type_info/expr-struct-type-relative-enum.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-enum.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-enum.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-enum.stderr?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -0,0 +1,14 @@\n+error[E0282]: type annotations needed\n+  --> $DIR/expr-struct-type-relative-enum.rs:16:9\n+   |\n+LL |         needs_infer();\n+   |         ^^^^^^^^^^^ cannot infer type of the type parameter `T` declared on the function `needs_infer`\n+   |\n+help: consider specifying the generic argument\n+   |\n+LL |         needs_infer::<T>();\n+   |                    +++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0282`."}, {"sha": "bcd29bb4e3495b78a3756a2753737cd0b727b1f9", "filename": "src/test/ui/inference/need_type_info/expr-struct-type-relative-gat.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-gat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-gat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-gat.rs?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -0,0 +1,21 @@\n+#![feature(generic_associated_types)]\n+\n+trait Foo {\n+    type Output<T>;\n+\n+    fn baz();\n+}\n+\n+enum Bar<T> {\n+    Simple {},\n+    Generic(T),\n+}\n+\n+impl Foo for u8 {\n+    type Output<T> = Bar<T>;\n+    fn baz() {\n+        Self::Output::Simple {}; //~ ERROR type annotations needed\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "65a75b68c1f080b622abff74e776596982529815", "filename": "src/test/ui/inference/need_type_info/expr-struct-type-relative-gat.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-gat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-gat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative-gat.stderr?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -0,0 +1,9 @@\n+error[E0282]: type annotations needed\n+  --> $DIR/expr-struct-type-relative-gat.rs:17:9\n+   |\n+LL |         Self::Output::Simple {};\n+   |         ^^^^^^^^^^^^ cannot infer type for type parameter `T` declared on the associated type `Output`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0282`."}, {"sha": "c3ece2b16cf08ba0bc1e34141e1177e0046d8655", "filename": "src/test/ui/inference/need_type_info/expr-struct-type-relative.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative.rs?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -0,0 +1,21 @@\n+// regression test for #98598\n+\n+trait Foo {\n+    type Output;\n+\n+    fn baz() -> Self::Output;\n+}\n+\n+fn needs_infer<T>() {}\n+\n+struct Bar {}\n+\n+impl Foo for u8 {\n+    type Output = Bar;\n+    fn baz() -> Self::Output {\n+        needs_infer(); //~ ERROR type annotations needed\n+        Self::Output {}\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "397d8e7be04ff90585b492f259f1b6fb4c368906", "filename": "src/test/ui/inference/need_type_info/expr-struct-type-relative.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0d5636ce8879381f151d7c03d691b35fe4a8ea56/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fneed_type_info%2Fexpr-struct-type-relative.stderr?ref=0d5636ce8879381f151d7c03d691b35fe4a8ea56", "patch": "@@ -0,0 +1,14 @@\n+error[E0282]: type annotations needed\n+  --> $DIR/expr-struct-type-relative.rs:16:9\n+   |\n+LL |         needs_infer();\n+   |         ^^^^^^^^^^^ cannot infer type of the type parameter `T` declared on the function `needs_infer`\n+   |\n+help: consider specifying the generic argument\n+   |\n+LL |         needs_infer::<T>();\n+   |                    +++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0282`."}]}