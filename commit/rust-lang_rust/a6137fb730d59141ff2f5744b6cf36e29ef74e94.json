{"sha": "a6137fb730d59141ff2f5744b6cf36e29ef74e94", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2MTM3ZmI3MzBkNTkxNDFmZjJmNTc0NGI2Y2YzNmUyOWVmNzRlOTQ=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-01-24T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-01-27T11:08:53Z"}, "message": "compiletest: Remove unnecessary memory allocation in iter_header\n\nReplace `BufRead::lines` with `BuRead::read_line` to reduce memory allocations.", "tree": {"sha": "e4dfa4a9526038ec2664f103844b395d22b23eef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4dfa4a9526038ec2664f103844b395d22b23eef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6137fb730d59141ff2f5744b6cf36e29ef74e94", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6137fb730d59141ff2f5744b6cf36e29ef74e94", "html_url": "https://github.com/rust-lang/rust/commit/a6137fb730d59141ff2f5744b6cf36e29ef74e94", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6137fb730d59141ff2f5744b6cf36e29ef74e94/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "320ada6479b3e29c7d9a66bc56ac44c2d2b57566", "url": "https://api.github.com/repos/rust-lang/rust/commits/320ada6479b3e29c7d9a66bc56ac44c2d2b57566", "html_url": "https://github.com/rust-lang/rust/commit/320ada6479b3e29c7d9a66bc56ac44c2d2b57566"}], "stats": {"total": 12, "additions": 9, "deletions": 3}, "files": [{"sha": "2b6016087c6bbe2164458c4bc7e6216b47051c1c", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a6137fb730d59141ff2f5744b6cf36e29ef74e94/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6137fb730d59141ff2f5744b6cf36e29ef74e94/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=a6137fb730d59141ff2f5744b6cf36e29ef74e94", "patch": "@@ -628,12 +628,18 @@ fn iter_header(testfile: &Path, cfg: Option<&str>, it: &mut dyn FnMut(&str)) {\n     // It took me like 2 days to debug why compile-flags weren\u2019t taken into account for my test :)\n     let comment_with_brace = comment.to_string() + \"[\";\n \n-    let rdr = BufReader::new(File::open(testfile).unwrap());\n-    for ln in rdr.lines() {\n+    let mut rdr = BufReader::new(File::open(testfile).unwrap());\n+    let mut ln = String::new();\n+\n+    loop {\n+        ln.clear();\n+        if rdr.read_line(&mut ln).unwrap() == 0 {\n+            break;\n+        }\n+\n         // Assume that any directives will be found before the first\n         // module or function. This doesn't seem to be an optimization\n         // with a warm page cache. Maybe with a cold one.\n-        let ln = ln.unwrap();\n         let ln = ln.trim();\n         if ln.starts_with(\"fn\") || ln.starts_with(\"mod\") {\n             return;"}]}