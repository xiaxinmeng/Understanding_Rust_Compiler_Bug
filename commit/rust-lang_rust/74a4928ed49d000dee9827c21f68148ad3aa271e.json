{"sha": "74a4928ed49d000dee9827c21f68148ad3aa271e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0YTQ5MjhlZDQ5ZDAwMGRlZTk4MjdjMjFmNjgxNDhhZDNhYTI3MWU=", "commit": {"author": {"name": "Yukio Siraichi", "email": "yukio.siraichi@gmail.com", "date": "2018-03-17T18:41:46Z"}, "committer": {"name": "Yukio Siraichi", "email": "yukio.siraichi@gmail.com", "date": "2018-03-18T23:46:28Z"}, "message": "Review fixes.\n\n- `span_suggestion` changed to `span_suggestion_short`;\n- `Span` used changed to contain only `&` refs;\n- Tests passing.", "tree": {"sha": "ebf3558038a9f22ddadff427c2c3368651d2eb01", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebf3558038a9f22ddadff427c2c3368651d2eb01"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74a4928ed49d000dee9827c21f68148ad3aa271e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74a4928ed49d000dee9827c21f68148ad3aa271e", "html_url": "https://github.com/rust-lang/rust/commit/74a4928ed49d000dee9827c21f68148ad3aa271e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74a4928ed49d000dee9827c21f68148ad3aa271e/comments", "author": {"login": "ysiraichi", "id": 3337141, "node_id": "MDQ6VXNlcjMzMzcxNDE=", "avatar_url": "https://avatars.githubusercontent.com/u/3337141?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ysiraichi", "html_url": "https://github.com/ysiraichi", "followers_url": "https://api.github.com/users/ysiraichi/followers", "following_url": "https://api.github.com/users/ysiraichi/following{/other_user}", "gists_url": "https://api.github.com/users/ysiraichi/gists{/gist_id}", "starred_url": "https://api.github.com/users/ysiraichi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ysiraichi/subscriptions", "organizations_url": "https://api.github.com/users/ysiraichi/orgs", "repos_url": "https://api.github.com/users/ysiraichi/repos", "events_url": "https://api.github.com/users/ysiraichi/events{/privacy}", "received_events_url": "https://api.github.com/users/ysiraichi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ysiraichi", "id": 3337141, "node_id": "MDQ6VXNlcjMzMzcxNDE=", "avatar_url": "https://avatars.githubusercontent.com/u/3337141?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ysiraichi", "html_url": "https://github.com/ysiraichi", "followers_url": "https://api.github.com/users/ysiraichi/followers", "following_url": "https://api.github.com/users/ysiraichi/following{/other_user}", "gists_url": "https://api.github.com/users/ysiraichi/gists{/gist_id}", "starred_url": "https://api.github.com/users/ysiraichi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ysiraichi/subscriptions", "organizations_url": "https://api.github.com/users/ysiraichi/orgs", "repos_url": "https://api.github.com/users/ysiraichi/repos", "events_url": "https://api.github.com/users/ysiraichi/events{/privacy}", "received_events_url": "https://api.github.com/users/ysiraichi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c1ba5ac62c14ab5e231edcce914fd33f0e32c2d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1ba5ac62c14ab5e231edcce914fd33f0e32c2d1", "html_url": "https://github.com/rust-lang/rust/commit/c1ba5ac62c14ab5e231edcce914fd33f0e32c2d1"}], "stats": {"total": 56, "additions": 35, "deletions": 21}, "files": [{"sha": "9b01f8899b52b3d44de2c000a0936434e0f7b3ce", "filename": "src/librustc/traits/error_reporting.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs?ref=74a4928ed49d000dee9827c21f68148ad3aa271e", "patch": "@@ -914,13 +914,14 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n                                                          new_trait_ref.to_predicate());\n \n                     if selcx.evaluate_obligation(&new_obligation) {\n-                        let remove_refs = refs_remaining + 1;\n+                        let sp = self.tcx.sess.codemap()\n+                            .span_take_while(span, |c| c.is_whitespace() || *c == '&');\n \n-                        err.span_suggestion_short(span,\n-                                                  &format!(\"consider removing {} leading `&`-references\",\n-                                                           remove_refs),\n-                                                  String::from(\"\"));\n+                        let remove_refs = refs_remaining + 1;\n+                        let format_str = format!(\"consider removing {} leading `&`-references\",\n+                                                 remove_refs);\n \n+                        err.span_suggestion_short(sp, &format_str, String::from(\"\"));\n                         break;\n                     }\n                 } else {"}, {"sha": "324d57c1194520be54a413c3757427e7545bfbad", "filename": "src/libsyntax/codemap.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Flibsyntax%2Fcodemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Flibsyntax%2Fcodemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fcodemap.rs?ref=74a4928ed49d000dee9827c21f68148ad3aa271e", "patch": "@@ -697,6 +697,22 @@ impl CodeMap {\n         sp\n     }\n \n+    /// Given a `Span`, get a shorter one until `predicate` yields false.\n+    pub fn span_take_while<P>(&self, sp: Span, predicate: P) -> Span\n+        where P: for <'r> FnMut(&'r char) -> bool\n+    {\n+        if let Ok(snippet) = self.span_to_snippet(sp) {\n+            let offset = snippet.chars()\n+                .take_while(predicate)\n+                .map(|c| c.len_utf8())\n+                .sum::<usize>();\n+\n+            sp.with_hi(BytePos(sp.lo().0 + (offset as u32)))\n+        } else {\n+            sp\n+        }\n+    }\n+\n     pub fn def_span(&self, sp: Span) -> Span {\n         self.span_until_char(sp, '{')\n     }"}, {"sha": "c47b4d283d7cda5195b9edc6087ca8931276e4cc", "filename": "src/test/ui/suggest-remove-refs-1.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Ftest%2Fui%2Fsuggest-remove-refs-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Ftest%2Fui%2Fsuggest-remove-refs-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggest-remove-refs-1.stderr?ref=74a4928ed49d000dee9827c21f68148ad3aa271e", "patch": "@@ -2,10 +2,10 @@ error[E0277]: the trait bound `&std::iter::Enumerate<std::slice::Iter<'_, {integ\n   --> $DIR/suggest-remove-refs-1.rs:14:19\n    |\n LL |     for (i, n) in &v.iter().enumerate() {\n-   |                   ^^^^^^^^^^^^^^^^^^^^^\n+   |                   -^^^^^^^^^^^^^^^^^^^^\n    |                   |\n    |                   `&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>` is not an iterator; maybe try calling `.iter()` or a similar method\n-   |                   help: consider removing 1 references `&`: `v.iter().enumerate()`\n+   |                   help: consider removing 1 leading `&`-references\n    |\n    = help: the trait `std::iter::Iterator` is not implemented for `&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>`\n    = note: required by `std::iter::IntoIterator::into_iter`"}, {"sha": "fdd654ea3923f9019a2ecc204be1e0f610ab0d64", "filename": "src/test/ui/suggest-remove-refs-2.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Ftest%2Fui%2Fsuggest-remove-refs-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Ftest%2Fui%2Fsuggest-remove-refs-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggest-remove-refs-2.stderr?ref=74a4928ed49d000dee9827c21f68148ad3aa271e", "patch": "@@ -2,10 +2,10 @@ error[E0277]: the trait bound `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {i\n   --> $DIR/suggest-remove-refs-2.rs:14:19\n    |\n LL |     for (i, n) in & & & & &v.iter().enumerate() {\n-   |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |                   ---------^^^^^^^^^^^^^^^^^^^^\n    |                   |\n    |                   `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>` is not an iterator; maybe try calling `.iter()` or a similar method\n-   |                   help: consider removing 5 references `&`: `v.iter().enumerate()`\n+   |                   help: consider removing 5 leading `&`-references\n    |\n    = help: the trait `std::iter::Iterator` is not implemented for `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>`\n    = note: required by `std::iter::IntoIterator::into_iter`"}, {"sha": "b0920a0fa523ee2b1850db901d036b29689c8955", "filename": "src/test/ui/suggest-remove-refs-3.stderr", "status": "modified", "additions": 9, "deletions": 12, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Ftest%2Fui%2Fsuggest-remove-refs-3.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/74a4928ed49d000dee9827c21f68148ad3aa271e/src%2Ftest%2Fui%2Fsuggest-remove-refs-3.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggest-remove-refs-3.stderr?ref=74a4928ed49d000dee9827c21f68148ad3aa271e", "patch": "@@ -1,21 +1,18 @@\n error[E0277]: the trait bound `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>: std::iter::Iterator` is not satisfied\n   --> $DIR/suggest-remove-refs-3.rs:14:19\n    |\n-LL |       for (i, n) in & & &\n-   |  ___________________^\n-LL | |         & &v\n-LL | |         .iter()\n-LL | |         .enumerate() {\n-   | |____________________^ `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>` is not an iterator; maybe try calling `.iter()` or a similar method\n+LL |        for (i, n) in & & &\n+   |   ___________________^\n+   |  |___________________|\n+   | ||\n+LL | ||         & &v\n+   | ||___________- help: consider removing 5 leading `&`-references\n+LL | |          .iter()\n+LL | |          .enumerate() {\n+   | |_____________________^ `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>` is not an iterator; maybe try calling `.iter()` or a similar method\n    |\n    = help: the trait `std::iter::Iterator` is not implemented for `&&&&&std::iter::Enumerate<std::slice::Iter<'_, {integer}>>`\n    = note: required by `std::iter::IntoIterator::into_iter`\n-help: consider removing 5 references `&`\n-   |\n-LL |     for (i, n) in v\n-LL |         .iter()\n-LL |         .enumerate() {\n-   |\n \n error: aborting due to previous error\n "}]}