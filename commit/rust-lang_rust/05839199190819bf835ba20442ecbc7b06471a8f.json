{"sha": "05839199190819bf835ba20442ecbc7b06471a8f", "node_id": "C_kwDOAAsO6NoAKDA1ODM5MTk5MTkwODE5YmY4MzViYTIwNDQyZWNiYzdiMDY0NzFhOGY", "commit": {"author": {"name": "Kyle Huey", "email": "khuey@kylehuey.com", "date": "2022-03-22T19:00:20Z"}, "committer": {"name": "Kyle Huey", "email": "khuey@kylehuey.com", "date": "2022-03-22T19:00:52Z"}, "message": "LSIF: consolidate references into a single edge where possible.", "tree": {"sha": "48b0483c9a6861176b7ff8b033f98c29f5441243", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/48b0483c9a6861176b7ff8b033f98c29f5441243"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/05839199190819bf835ba20442ecbc7b06471a8f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/05839199190819bf835ba20442ecbc7b06471a8f", "html_url": "https://github.com/rust-lang/rust/commit/05839199190819bf835ba20442ecbc7b06471a8f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/05839199190819bf835ba20442ecbc7b06471a8f/comments", "author": {"login": "khuey", "id": 325892, "node_id": "MDQ6VXNlcjMyNTg5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/325892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/khuey", "html_url": "https://github.com/khuey", "followers_url": "https://api.github.com/users/khuey/followers", "following_url": "https://api.github.com/users/khuey/following{/other_user}", "gists_url": "https://api.github.com/users/khuey/gists{/gist_id}", "starred_url": "https://api.github.com/users/khuey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/khuey/subscriptions", "organizations_url": "https://api.github.com/users/khuey/orgs", "repos_url": "https://api.github.com/users/khuey/repos", "events_url": "https://api.github.com/users/khuey/events{/privacy}", "received_events_url": "https://api.github.com/users/khuey/received_events", "type": "User", "site_admin": false}, "committer": {"login": "khuey", "id": 325892, "node_id": "MDQ6VXNlcjMyNTg5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/325892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/khuey", "html_url": "https://github.com/khuey", "followers_url": "https://api.github.com/users/khuey/followers", "following_url": "https://api.github.com/users/khuey/following{/other_user}", "gists_url": "https://api.github.com/users/khuey/gists{/gist_id}", "starred_url": "https://api.github.com/users/khuey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/khuey/subscriptions", "organizations_url": "https://api.github.com/users/khuey/orgs", "repos_url": "https://api.github.com/users/khuey/repos", "events_url": "https://api.github.com/users/khuey/events{/privacy}", "received_events_url": "https://api.github.com/users/khuey/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1dbc2acd455592b1def80a8108fe75d38d2f18b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1dbc2acd455592b1def80a8108fe75d38d2f18b", "html_url": "https://github.com/rust-lang/rust/commit/f1dbc2acd455592b1def80a8108fe75d38d2f18b"}], "stats": {"total": 21, "additions": 13, "deletions": 8}, "files": [{"sha": "188f9b1380e195360f56fb1f3ec340d098bb33c2", "filename": "crates/rust-analyzer/src/cli/lsif.rs", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/05839199190819bf835ba20442ecbc7b06471a8f/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05839199190819bf835ba20442ecbc7b06471a8f/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs?ref=05839199190819bf835ba20442ecbc7b06471a8f", "patch": "@@ -212,19 +212,24 @@ impl LsifManager<'_> {\n                 in_v: result_id.into(),\n                 out_v: result_set_id.into(),\n             }));\n-            for x in token.references {\n-                let vertex = *self.range_map.get(&x.range).unwrap();\n+            let edges = token.references.iter().fold(\n+                HashMap::<_, Vec<lsp_types::NumberOrString>>::new(),\n+                |mut edges, x| {\n+                    let entry =\n+                        edges.entry((x.range.file_id, x.is_definition)).or_insert_with(Vec::new);\n+                    entry.push((*self.range_map.get(&x.range).unwrap()).into());\n+                    edges\n+                },\n+            );\n+            for ((file_id, is_definition), vertices) in edges.into_iter() {\n                 self.add_edge(lsif::Edge::Item(lsif::Item {\n-                    document: (*self.file_map.get(&x.range.file_id).unwrap()).into(),\n-                    property: Some(if x.is_definition {\n+                    document: (*self.file_map.get(&file_id).unwrap()).into(),\n+                    property: Some(if is_definition {\n                         lsif::ItemKind::Definitions\n                     } else {\n                         lsif::ItemKind::References\n                     }),\n-                    edge_data: lsif::EdgeDataMultiIn {\n-                        in_vs: vec![vertex.into()],\n-                        out_v: result_id.into(),\n-                    },\n+                    edge_data: lsif::EdgeDataMultiIn { in_vs: vertices, out_v: result_id.into() },\n                 }));\n             }\n         }"}]}