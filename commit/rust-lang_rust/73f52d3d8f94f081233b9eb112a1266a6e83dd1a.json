{"sha": "73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczZjUyZDNkOGY5NGYwODEyMzNiOWViMTEyYTEyNjZhNmU4M2RkMWE=", "commit": {"author": {"name": "Vitaly _Vi Shukela", "email": "vi0oss@gmail.com", "date": "2018-01-31T00:48:16Z"}, "committer": {"name": "Vitaly _Vi Shukela", "email": "vi0oss@gmail.com", "date": "2018-01-31T00:48:16Z"}, "message": "rustdoc: Foldable impl blocks\n\nAddresses #40363, #45720, #24483, #23986 and so on\n\n* Expands and refactors collapseDocs and toggleAllDocs\n* Adds [-] toggle to all impls (including inherent impl)\n* Makes it hiding though main css file, not though element style\n\nMay need to be addressed:\n\n* \"[-]\" and anchor link copier are overlaid a bit\n* Inherent methods are also hidden by the global [-] toggle.\n* Auto-collapsing \"Iterator\" and so on by default is not implemented yet\n* Tested only shallowly and only in Chromiuim\n* No tests. Are there tests for css/js part here?\n* The new implementation may be a bit slower.", "tree": {"sha": "fc269471580112d44d879b977d83b69ee2a758db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc269471580112d44d879b977d83b69ee2a758db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABEIAB0WIQQzEHnM5f9ubG8rMBnAlyIdbgPfaAUCWnESUAAKCRDAlyIdbgPf\naLD/APoCQm1bLJLEli9OpK14LM6wH3nmLiiCqbWGaj9SjDlhVAD/Y4QciFmL/B8Y\nBI6YBhzgewjQUuZfw1YCkEe6CyF0/34=\n=uUhp\n-----END PGP SIGNATURE-----", "payload": "tree fc269471580112d44d879b977d83b69ee2a758db\nparent 21882aad7299e8e859785845ac12374990f24dae\nauthor Vitaly _Vi Shukela <vi0oss@gmail.com> 1517359696 +0300\ncommitter Vitaly _Vi Shukela <vi0oss@gmail.com> 1517359696 +0300\n\nrustdoc: Foldable impl blocks\n\nAddresses #40363, #45720, #24483, #23986 and so on\n\n* Expands and refactors collapseDocs and toggleAllDocs\n* Adds [-] toggle to all impls (including inherent impl)\n* Makes it hiding though main css file, not though element style\n\nMay need to be addressed:\n\n* \"[-]\" and anchor link copier are overlaid a bit\n* Inherent methods are also hidden by the global [-] toggle.\n* Auto-collapsing \"Iterator\" and so on by default is not implemented yet\n* Tested only shallowly and only in Chromiuim\n* No tests. Are there tests for css/js part here?\n* The new implementation may be a bit slower.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "html_url": "https://github.com/rust-lang/rust/commit/73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/comments", "author": {"login": "vi", "id": 173219, "node_id": "MDQ6VXNlcjE3MzIxOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/173219?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vi", "html_url": "https://github.com/vi", "followers_url": "https://api.github.com/users/vi/followers", "following_url": "https://api.github.com/users/vi/following{/other_user}", "gists_url": "https://api.github.com/users/vi/gists{/gist_id}", "starred_url": "https://api.github.com/users/vi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vi/subscriptions", "organizations_url": "https://api.github.com/users/vi/orgs", "repos_url": "https://api.github.com/users/vi/repos", "events_url": "https://api.github.com/users/vi/events{/privacy}", "received_events_url": "https://api.github.com/users/vi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vi", "id": 173219, "node_id": "MDQ6VXNlcjE3MzIxOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/173219?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vi", "html_url": "https://github.com/vi", "followers_url": "https://api.github.com/users/vi/followers", "following_url": "https://api.github.com/users/vi/following{/other_user}", "gists_url": "https://api.github.com/users/vi/gists{/gist_id}", "starred_url": "https://api.github.com/users/vi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vi/subscriptions", "organizations_url": "https://api.github.com/users/vi/orgs", "repos_url": "https://api.github.com/users/vi/repos", "events_url": "https://api.github.com/users/vi/events{/privacy}", "received_events_url": "https://api.github.com/users/vi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "21882aad7299e8e859785845ac12374990f24dae", "url": "https://api.github.com/repos/rust-lang/rust/commits/21882aad7299e8e859785845ac12374990f24dae", "html_url": "https://github.com/rust-lang/rust/commit/21882aad7299e8e859785845ac12374990f24dae"}], "stats": {"total": 166, "additions": 115, "deletions": 51}, "files": [{"sha": "a77161bf1a9916d72ff8fb69ffa9e70a765988c2", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 105, "deletions": 51, "changes": 156, "blob_url": "https://github.com/rust-lang/rust/blob/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "patch": "@@ -296,9 +296,9 @@\n     document.onkeydown = handleShortcut;\n     document.onclick = function(ev) {\n         if (hasClass(ev.target, 'collapse-toggle')) {\n-            collapseDocs(ev.target);\n+            collapseDocs(ev.target, \"toggle\");\n         } else if (hasClass(ev.target.parentNode, 'collapse-toggle')) {\n-            collapseDocs(ev.target.parentNode);\n+            collapseDocs(ev.target.parentNode, \"toggle\");\n         } else if (ev.target.tagName === 'SPAN' && hasClass(ev.target.parentNode, 'line-numbers')) {\n             var prev_id = 0;\n \n@@ -1618,74 +1618,124 @@\n                 e.innerHTML = labelForToggleButton(false);\n             });\n             toggle.title = \"collapse all docs\";\n-            onEach(document.getElementsByClassName(\"docblock\"), function(e) {\n-                e.style.display = 'block';\n-            });\n-            onEach(document.getElementsByClassName(\"toggle-label\"), function(e) {\n-                e.style.display = 'none';\n-            });\n-            onEach(document.getElementsByClassName(\"toggle-wrapper\"), function(e) {\n-                removeClass(e, \"collapsed\");\n-            });\n             onEach(document.getElementsByClassName(\"collapse-toggle\"), function(e) {\n-                onEveryMatchingChild(e, \"inner\", function(i_e) {\n-                    i_e.innerHTML = labelForToggleButton(false);\n-                });\n+                collapseDocs(e, \"show\");\n             });\n         } else {\n             addClass(toggle, \"will-expand\");\n             onEveryMatchingChild(toggle, \"inner\", function(e) {\n                 e.innerHTML = labelForToggleButton(true);\n             });\n             toggle.title = \"expand all docs\";\n-            onEach(document.getElementsByClassName(\"docblock\"), function(e) {\n-                e.style.display = 'none';\n-            });\n-            onEach(document.getElementsByClassName(\"toggle-label\"), function(e) {\n-                e.style.display = 'inline-block';\n-            });\n-            onEach(document.getElementsByClassName(\"toggle-wrapper\"), function(e) {\n-                addClass(e, \"collapsed\");\n-            });\n+            \n             onEach(document.getElementsByClassName(\"collapse-toggle\"), function(e) {\n-                onEveryMatchingChild(e, \"inner\", function(i_e) {\n-                    i_e.innerHTML = labelForToggleButton(true);\n-                });\n+                collapseDocs(e, \"hide\");\n             });\n         }\n     }\n \n-    function collapseDocs(toggle) {\n+    function collapseDocs(toggle, mode) {\n         if (!toggle || !toggle.parentNode) {\n             return;\n         }\n-        var relatedDoc = toggle.parentNode.nextElementSibling;\n-        if (hasClass(relatedDoc, \"stability\")) {\n-            relatedDoc = relatedDoc.nextElementSibling;\n-        }\n-        if (hasClass(relatedDoc, \"docblock\")) {\n-            if (!isHidden(relatedDoc)) {\n-                relatedDoc.style.display = 'none';\n-                onEach(toggle.childNodes, function(e) {\n-                    if (hasClass(e, 'toggle-label')) {\n+        \n+        function adjustToggle(arg) {\n+            return function(e) {\n+                if (hasClass(e, 'toggle-label')) {\n+                    if (arg) {\n                         e.style.display = 'inline-block';\n-                    }\n-                    if (hasClass(e, 'inner')) {\n-                        e.innerHTML = labelForToggleButton(true);\n-                    }\n-                });\n-                addClass(toggle.parentNode, 'collapsed');\n-            } else {\n-                relatedDoc.style.display = 'block';\n-                removeClass(toggle.parentNode, 'collapsed');\n-                onEach(toggle.childNodes, function(e) {\n-                    if (hasClass(e, 'toggle-label')) {\n+                    } else {\n                         e.style.display = 'none';\n                     }\n-                    if (hasClass(e, 'inner')) {\n-                        e.innerHTML = labelForToggleButton(false);\n+                }\n+                if (hasClass(e, 'inner')) {\n+                    e.innerHTML = labelForToggleButton(arg);\n+                }\n+            };\n+        };\n+        \n+        if (!hasClass(toggle.parentNode, \"impl\")) {\n+            var relatedDoc = toggle.parentNode.nextElementSibling;\n+            if (hasClass(relatedDoc, \"stability\")) {\n+                relatedDoc = relatedDoc.nextElementSibling;\n+            }\n+            if (hasClass(relatedDoc, \"docblock\")) {\n+                var action = mode;\n+                if (action == \"toggle\") {\n+                    if(hasClass(relatedDoc, \"hidden-by-usual-hider\")) {\n+                        action=\"show\";\n+                    } else {\n+                        action=\"hide\";\n+                    }\n+                }\n+                if (action == \"hide\") {\n+                    addClass(relatedDoc, \"hidden-by-usual-hider\");\n+                    onEach(toggle.childNodes, adjustToggle(true));\n+                    addClass(toggle.parentNode, 'collapsed');\n+                } else if (action == \"show\") {\n+                    removeClass(relatedDoc, \"hidden-by-usual-hider\");\n+                    removeClass(toggle.parentNode, 'collapsed');\n+                    onEach(toggle.childNodes, adjustToggle(false));\n+                }\n+            }\n+        } else {\n+            // we are collapsing the impl block\n+            function implHider(addOrRemove) {\n+                return function(n) {\n+                    if(hasClass(n, \"method\")) {\n+                        if (addOrRemove) {\n+                            addClass(n, \"hidden-by-impl-hider\");\n+                        } else {\n+                            removeClass(n, \"hidden-by-impl-hider\");\n+                        }\n+                        var ns = n.nextElementSibling;\n+                        while(true) {\n+                            if (ns && (\n+                                    hasClass(ns, \"docblock\") ||\n+                                    hasClass(ns, \"stability\") ||\n+                                    false\n+                                    )) {\n+                                if (addOrRemove) {\n+                                    addClass(ns, \"hidden-by-impl-hider\");\n+                                } else {\n+                                    removeClass(ns, \"hidden-by-impl-hider\");\n+                                }\n+                                ns = ns.nextElementSibling;\n+                                continue;\n+                            }\n+                            break;\n+                        }\n                     }\n-                });\n+                }\n+            }\n+            \n+            var relatedDoc = toggle.parentNode;\n+            \n+            while (!hasClass(relatedDoc, \"impl-items\")) {\n+                relatedDoc = relatedDoc.nextElementSibling;\n+            }\n+            \n+            if (!relatedDoc) return;\n+            \n+            // Hide all functions, but not associated types/consts\n+            \n+            var action = mode;\n+            if (action == \"toggle\") {\n+                if(hasClass(relatedDoc, \"fns-now-collapsed\")) {\n+                    action=\"show\";\n+                } else {\n+                    action=\"hide\";\n+                }\n+            }\n+            \n+            if(action == \"show\") {\n+                removeClass(relatedDoc, \"fns-now-collapsed\");\n+                onEach(toggle.childNodes, adjustToggle(false));\n+                onEach(relatedDoc.childNodes, implHider(false));\n+            } else if (action == \"hide\") {\n+                addClass(relatedDoc, \"fns-now-collapsed\");\n+                onEach(toggle.childNodes, adjustToggle(true));\n+                onEach(relatedDoc.childNodes, implHider(true));\n             }\n         }\n     }\n@@ -1714,8 +1764,12 @@\n              hasClass(next.nextElementSibling, 'docblock'))) {\n             insertAfter(toggle.cloneNode(true), e.childNodes[e.childNodes.length - 1]);\n         }\n+        if (hasClass(e, 'impl')) {\n+            insertAfter(toggle.cloneNode(true), e.childNodes[e.childNodes.length - 1]);\n+        }\n     }\n     onEach(document.getElementsByClassName('method'), func);\n+    onEach(document.getElementsByClassName('impl'), func);\n     onEach(document.getElementsByClassName('impl-items'), function(e) {\n         onEach(e.getElementsByClassName('associatedconstant'), func);\n     });\n@@ -1803,7 +1857,7 @@\n     onEach(document.getElementById('main').getElementsByTagName('pre'), function(e) {\n         onEach(e.getElementsByClassName('attributes'), function(i_e) {\n             i_e.parentNode.insertBefore(createToggleWrapper(), i_e);\n-            collapseDocs(i_e.previousSibling.childNodes[0]);\n+            collapseDocs(i_e.previousSibling.childNodes[0], \"toggle\");\n         });\n     });\n "}, {"sha": "d8cb9681d04b400c01d23680b943af6c28d2e1d8", "filename": "src/librustdoc/html/static/themes/dark.css", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "raw_url": "https://github.com/rust-lang/rust/raw/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css?ref=73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "patch": "@@ -386,3 +386,8 @@ kbd {\n \t\tbackground: #353535;\n \t}\n }\n+\n+.hidden-by-impl-hider, \n+.hidden-by-usual-hider {\n+\tdisplay: none;\n+}"}, {"sha": "8713f83ecb93ba4db9b20afb722f5c7112a4d4e5", "filename": "src/librustdoc/html/static/themes/main.css", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fmain.css", "raw_url": "https://github.com/rust-lang/rust/raw/73f52d3d8f94f081233b9eb112a1266a6e83dd1a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fmain.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fmain.css?ref=73f52d3d8f94f081233b9eb112a1266a6e83dd1a", "patch": "@@ -383,3 +383,8 @@ kbd {\n \t\tbackground: #fff;\n \t}\n }\n+\n+.hidden-by-impl-hider, \n+.hidden-by-usual-hider {\n+\tdisplay: none;\n+}"}]}