{"sha": "4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjYzJmZjZlMzkwYjZkODAxNWVkMWQyNjY0MjU0NTkyNjhmNmUwYjA=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-05-23T11:32:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-23T11:32:26Z"}, "message": "Merge #4555 #4575\n\n4555: VSCode: added patchelf after download for NixOS support r=matklad a=cab404\n\nThis adds Nix support, and fixes #4542 \n\n4575: Use Chalk's built-in representations for fn items and pointers r=matklad a=flodiebold\n\nThe `TypeName::FnDef` was just added; the function pointer variant has existed for a while, I just forgot about it because it's special (because fn pointers can be higher-ranked over lifetimes).\r\n\r\nWe *could* also make `FnPtr` a separate `Ty` variant instead of a `TypeCtor` variant, which would make the conversion code a bit less special-casey, but it doesn't seem worth doing right now.\n\nCo-authored-by: Vladimir Serov <me@cab404.ru>\nCo-authored-by: Cabia Rangris <me@cab404.ru>\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>", "tree": {"sha": "35aad7e9bca6db3aede78f8d12756c50aad25c76", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/35aad7e9bca6db3aede78f8d12756c50aad25c76"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeyQnKCRBK7hj4Ov3rIwAAdHIIAAA+rV5W4/eWwYv1Pbc/8bc6\nE2VzaGS6ksalvt2AVl4n0YxNDgcqU9dAV1MY0pf00+8vYBZQHWUTwmwpni9U6KSS\nv3w56jWsI10pHDVgpUUu7KR+3A9u2sXPF/4fkuljWagxvJnvhZnd2+zqBoAZlaIV\na7bE7J6TuSLy31o9gPsBsrIu45IoyoD8awwt0rvNf3ywjlZ5VCOV8sxhvbm/0rrz\nZ/a1wSt1/n7CNRQ7v6TsY8ujpj1+m4pRyyqi6uHSeyk/c+vPVCXn69QAjfeLptut\nJCVlpYbos3GHHp48krERLlkSnLwD0HkubPnjx0Xjz0jm8Z9EKSRHcSKPPtQdlVk=\n=tsLa\n-----END PGP SIGNATURE-----\n", "payload": "tree 35aad7e9bca6db3aede78f8d12756c50aad25c76\nparent ca5e4596a0585332ad8ff03b2c02bba586496947\nparent b4ef1afd300deb948ebf4bce7a3d898a1580f44f\nparent 194dd9eb0d44284f7e952a1e84296fcda4d90f5e\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1590233546 +0000\ncommitter GitHub <noreply@github.com> 1590233546 +0000\n\nMerge #4555 #4575\n\n4555: VSCode: added patchelf after download for NixOS support r=matklad a=cab404\n\nThis adds Nix support, and fixes #4542 \n\n4575: Use Chalk's built-in representations for fn items and pointers r=matklad a=flodiebold\n\nThe `TypeName::FnDef` was just added; the function pointer variant has existed for a while, I just forgot about it because it's special (because fn pointers can be higher-ranked over lifetimes).\r\n\r\nWe *could* also make `FnPtr` a separate `Ty` variant instead of a `TypeCtor` variant, which would make the conversion code a bit less special-casey, but it doesn't seem worth doing right now.\n\nCo-authored-by: Vladimir Serov <me@cab404.ru>\nCo-authored-by: Cabia Rangris <me@cab404.ru>\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "html_url": "https://github.com/rust-lang/rust/commit/4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ca5e4596a0585332ad8ff03b2c02bba586496947", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca5e4596a0585332ad8ff03b2c02bba586496947", "html_url": "https://github.com/rust-lang/rust/commit/ca5e4596a0585332ad8ff03b2c02bba586496947"}, {"sha": "b4ef1afd300deb948ebf4bce7a3d898a1580f44f", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4ef1afd300deb948ebf4bce7a3d898a1580f44f", "html_url": "https://github.com/rust-lang/rust/commit/b4ef1afd300deb948ebf4bce7a3d898a1580f44f"}, {"sha": "194dd9eb0d44284f7e952a1e84296fcda4d90f5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/194dd9eb0d44284f7e952a1e84296fcda4d90f5e", "html_url": "https://github.com/rust-lang/rust/commit/194dd9eb0d44284f7e952a1e84296fcda4d90f5e"}], "stats": {"total": 246, "additions": 227, "deletions": 19}, "files": [{"sha": "0a8bb24ac2394e7d64248294ff847cd40acad6c5", "filename": "crates/ra_hir_ty/src/db.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Fdb.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -76,6 +76,8 @@ pub trait HirDatabase: DefDatabase + Upcast<dyn DefDatabase> {\n     #[salsa::interned]\n     fn intern_type_ctor(&self, type_ctor: TypeCtor) -> crate::TypeCtorId;\n     #[salsa::interned]\n+    fn intern_callable_def(&self, callable_def: CallableDef) -> crate::CallableDefId;\n+    #[salsa::interned]\n     fn intern_type_param_id(&self, param_id: TypeParamId) -> GlobalTypeParamId;\n     #[salsa::interned]\n     fn intern_chalk_impl(&self, impl_: Impl) -> crate::traits::GlobalImplId;\n@@ -94,6 +96,9 @@ pub trait HirDatabase: DefDatabase + Upcast<dyn DefDatabase> {\n     #[salsa::invoke(crate::traits::chalk::impl_datum_query)]\n     fn impl_datum(&self, krate: CrateId, impl_id: chalk::ImplId) -> Arc<chalk::ImplDatum>;\n \n+    #[salsa::invoke(crate::traits::chalk::fn_def_datum_query)]\n+    fn fn_def_datum(&self, krate: CrateId, fn_def_id: chalk::FnDefId) -> Arc<chalk::FnDefDatum>;\n+\n     #[salsa::invoke(crate::traits::chalk::associated_ty_value_query)]\n     fn associated_ty_value(\n         &self,"}, {"sha": "93cb45a648c516d6b9be715eb4bd5183024505df", "filename": "crates/ra_hir_ty/src/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Flib.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -159,6 +159,12 @@ pub enum TypeCtor {\n pub struct TypeCtorId(salsa::InternId);\n impl_intern_key!(TypeCtorId);\n \n+/// This exists just for Chalk, because Chalk just has a single `FnDefId` where\n+/// we have different IDs for struct and enum variant constructors.\n+#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Ord, PartialOrd)]\n+pub struct CallableDefId(salsa::InternId);\n+impl_intern_key!(CallableDefId);\n+\n impl TypeCtor {\n     pub fn num_ty_params(self, db: &dyn HirDatabase) -> usize {\n         match self {"}, {"sha": "0419bc751b20a49f1095ff32e919521dfee6aee8", "filename": "crates/ra_hir_ty/src/tests/traits.rs", "status": "modified", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Ftraits.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -2643,6 +2643,80 @@ fn test() {\n     );\n }\n \n+#[test]\n+fn builtin_fn_def_copy() {\n+    assert_snapshot!(\n+        infer_with_mismatches(r#\"\n+#[lang = \"copy\"]\n+trait Copy {}\n+\n+fn foo() {}\n+fn bar<T: Copy>(T) -> T {}\n+struct Struct(usize);\n+enum Enum { Variant(usize) }\n+\n+trait Test { fn test(&self) -> bool; }\n+impl<T: Copy> Test for T {}\n+\n+fn test() {\n+    foo.test();\n+    bar.test();\n+    Struct.test();\n+    Enum::Variant.test();\n+}\n+\"#, true),\n+        // wrong result, because the built-in Copy impl for fn defs doesn't exist in Chalk yet\n+        @r###\"\n+    42..44 '{}': ()\n+    61..62 'T': {unknown}\n+    69..71 '{}': ()\n+    69..71: expected T, got ()\n+    146..150 'self': &Self\n+    202..282 '{     ...t(); }': ()\n+    208..211 'foo': fn foo()\n+    208..218 'foo.test()': {unknown}\n+    224..227 'bar': fn bar<{unknown}>({unknown}) -> {unknown}\n+    224..234 'bar.test()': {unknown}\n+    240..246 'Struct': Struct(usize) -> Struct\n+    240..253 'Struct.test()': {unknown}\n+    259..272 'Enum::Variant': Variant(usize) -> Enum\n+    259..279 'Enum::...test()': {unknown}\n+    \"###\n+    );\n+}\n+\n+#[test]\n+fn builtin_fn_ptr_copy() {\n+    assert_snapshot!(\n+        infer_with_mismatches(r#\"\n+#[lang = \"copy\"]\n+trait Copy {}\n+\n+trait Test { fn test(&self) -> bool; }\n+impl<T: Copy> Test for T {}\n+\n+fn test(f1: fn(), f2: fn(usize) -> u8, f3: fn(u8, u8) -> &u8) {\n+    f1.test();\n+    f2.test();\n+    f3.test();\n+}\n+\"#, true),\n+        @r###\"\n+    55..59 'self': &Self\n+    109..111 'f1': fn()\n+    119..121 'f2': fn(usize) -> u8\n+    140..142 'f3': fn(u8, u8) -> &u8\n+    163..211 '{     ...t(); }': ()\n+    169..171 'f1': fn()\n+    169..178 'f1.test()': bool\n+    184..186 'f2': fn(usize) -> u8\n+    184..193 'f2.test()': bool\n+    199..201 'f3': fn(u8, u8) -> &u8\n+    199..208 'f3.test()': bool\n+    \"###\n+    );\n+}\n+\n #[test]\n fn builtin_sized() {\n     assert_snapshot!("}, {"sha": "5b0f12a3c7f3ad94acb3e7cbd0e43aa02c3ea5c7", "filename": "crates/ra_hir_ty/src/traits/chalk.rs", "status": "modified", "additions": 35, "deletions": 4, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -14,7 +14,7 @@ use ra_db::{salsa::InternKey, CrateId};\n use super::{builtin, AssocTyValue, ChalkContext, Impl};\n use crate::{\n     db::HirDatabase, display::HirDisplay, method_resolution::TyFingerprint, utils::generics,\n-    DebruijnIndex, GenericPredicate, Substs, Ty, TypeCtor,\n+    CallableDef, DebruijnIndex, GenericPredicate, Substs, Ty, TypeCtor,\n };\n use chalk_rust_ir::WellKnownTrait;\n use mapping::{convert_where_clauses, generic_predicate_to_inline_bound, make_binders};\n@@ -54,10 +54,9 @@ impl<'a> chalk_solve::RustIrDatabase<Interner> for ChalkContext<'a> {\n \n     fn fn_def_datum(\n         &self,\n-        _fn_def_id: chalk_ir::FnDefId<Interner>,\n+        fn_def_id: chalk_ir::FnDefId<Interner>,\n     ) -> Arc<chalk_rust_ir::FnDefDatum<Interner>> {\n-        // We don't yet provide any FnDefs to Chalk\n-        unimplemented!()\n+        self.db.fn_def_datum(self.krate, fn_def_id)\n     }\n \n     fn impls_for_trait(\n@@ -405,6 +404,26 @@ fn type_alias_associated_ty_value(\n     Arc::new(value)\n }\n \n+pub(crate) fn fn_def_datum_query(\n+    db: &dyn HirDatabase,\n+    _krate: CrateId,\n+    fn_def_id: FnDefId,\n+) -> Arc<FnDefDatum> {\n+    let callable_def: CallableDef = from_chalk(db, fn_def_id);\n+    let generic_params = generics(db.upcast(), callable_def.into());\n+    let sig = db.callable_item_signature(callable_def);\n+    let bound_vars = Substs::bound_vars(&generic_params, DebruijnIndex::INNERMOST);\n+    let where_clauses = convert_where_clauses(db, callable_def.into(), &bound_vars);\n+    let bound = chalk_rust_ir::FnDefDatumBound {\n+        // Note: Chalk doesn't actually use this information yet as far as I am aware, but we provide it anyway\n+        argument_types: sig.value.params().iter().map(|ty| ty.clone().to_chalk(db)).collect(),\n+        return_type: sig.value.ret().clone().to_chalk(db),\n+        where_clauses,\n+    };\n+    let datum = FnDefDatum { id: fn_def_id, binders: make_binders(bound, sig.num_binders) };\n+    Arc::new(datum)\n+}\n+\n impl From<AdtId> for crate::TypeCtorId {\n     fn from(struct_id: AdtId) -> Self {\n         struct_id.0\n@@ -417,6 +436,18 @@ impl From<crate::TypeCtorId> for AdtId {\n     }\n }\n \n+impl From<FnDefId> for crate::CallableDefId {\n+    fn from(fn_def_id: FnDefId) -> Self {\n+        InternKey::from_intern_id(fn_def_id.0)\n+    }\n+}\n+\n+impl From<crate::CallableDefId> for FnDefId {\n+    fn from(callable_def_id: crate::CallableDefId) -> Self {\n+        chalk_ir::FnDefId(callable_def_id.as_intern_id())\n+    }\n+}\n+\n impl From<ImplId> for crate::traits::GlobalImplId {\n     fn from(impl_id: ImplId) -> Self {\n         InternKey::from_intern_id(impl_id.0)"}, {"sha": "2a27f8ed8b3e30355f0d5e2dfccf3976e94c30c5", "filename": "crates/ra_hir_ty/src/traits/chalk/interner.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Finterner.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Finterner.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Finterner.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -20,6 +20,8 @@ pub type ImplId = chalk_ir::ImplId<Interner>;\n pub type ImplDatum = chalk_rust_ir::ImplDatum<Interner>;\n pub type AssociatedTyValueId = chalk_rust_ir::AssociatedTyValueId<Interner>;\n pub type AssociatedTyValue = chalk_rust_ir::AssociatedTyValue<Interner>;\n+pub type FnDefId = chalk_ir::FnDefId<Interner>;\n+pub type FnDefDatum = chalk_rust_ir::FnDefDatum<Interner>;\n \n impl chalk_ir::interner::Interner for Interner {\n     type InternedType = Box<chalk_ir::TyData<Self>>; // FIXME use Arc?"}, {"sha": "7082cb09573a2a9ad7871260364c02aca98f3164", "filename": "crates/ra_hir_ty/src/traits/chalk/mapping.rs", "status": "modified", "additions": 41, "deletions": 12, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Fmapping.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Fmapping.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Fmapping.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -15,8 +15,8 @@ use crate::{\n     db::HirDatabase,\n     primitive::{FloatBitness, FloatTy, IntBitness, IntTy, Signedness, Uncertain},\n     traits::{builtin, AssocTyValue, Canonical, Impl, Obligation},\n-    ApplicationTy, GenericPredicate, InEnvironment, ProjectionPredicate, ProjectionTy, Substs,\n-    TraitEnvironment, TraitRef, Ty, TypeCtor,\n+    ApplicationTy, CallableDef, GenericPredicate, InEnvironment, ProjectionPredicate, ProjectionTy,\n+    Substs, TraitEnvironment, TraitRef, Ty, TypeCtor,\n };\n \n use super::interner::*;\n@@ -26,14 +26,19 @@ impl ToChalk for Ty {\n     type Chalk = chalk_ir::Ty<Interner>;\n     fn to_chalk(self, db: &dyn HirDatabase) -> chalk_ir::Ty<Interner> {\n         match self {\n-            Ty::Apply(apply_ty) => {\n-                if let TypeCtor::Ref(m) = apply_ty.ctor {\n-                    return ref_to_chalk(db, m, apply_ty.parameters);\n+            Ty::Apply(apply_ty) => match apply_ty.ctor {\n+                TypeCtor::Ref(m) => ref_to_chalk(db, m, apply_ty.parameters),\n+                TypeCtor::FnPtr { num_args: _ } => {\n+                    let substitution = apply_ty.parameters.to_chalk(db).shifted_in(&Interner);\n+                    chalk_ir::TyData::Function(chalk_ir::Fn { num_binders: 0, substitution })\n+                        .intern(&Interner)\n                 }\n-                let name = apply_ty.ctor.to_chalk(db);\n-                let substitution = apply_ty.parameters.to_chalk(db);\n-                chalk_ir::ApplicationTy { name, substitution }.cast(&Interner).intern(&Interner)\n-            }\n+                _ => {\n+                    let name = apply_ty.ctor.to_chalk(db);\n+                    let substitution = apply_ty.parameters.to_chalk(db);\n+                    chalk_ir::ApplicationTy { name, substitution }.cast(&Interner).intern(&Interner)\n+                }\n+            },\n             Ty::Projection(proj_ty) => {\n                 let associated_ty_id = proj_ty.associated_ty.to_chalk(db);\n                 let substitution = proj_ty.parameters.to_chalk(db);\n@@ -93,7 +98,13 @@ impl ToChalk for Ty {\n                 Ty::Projection(ProjectionTy { associated_ty, parameters })\n             }\n             chalk_ir::TyData::Alias(chalk_ir::AliasTy::Opaque(_)) => unimplemented!(),\n-            chalk_ir::TyData::Function(_) => unimplemented!(),\n+            chalk_ir::TyData::Function(chalk_ir::Fn { num_binders: _, substitution }) => {\n+                let parameters: Substs = from_chalk(db, substitution);\n+                Ty::Apply(ApplicationTy {\n+                    ctor: TypeCtor::FnPtr { num_args: (parameters.len() - 1) as u16 },\n+                    parameters,\n+                })\n+            }\n             chalk_ir::TyData::BoundVar(idx) => Ty::Bound(idx),\n             chalk_ir::TyData::InferenceVar(_iv) => Ty::Unknown,\n             chalk_ir::TyData::Dyn(where_clauses) => {\n@@ -217,11 +228,14 @@ impl ToChalk for TypeCtor {\n             TypeCtor::Slice => TypeName::Slice,\n             TypeCtor::Ref(mutability) => TypeName::Ref(mutability.to_chalk(db)),\n             TypeCtor::Str => TypeName::Str,\n+            TypeCtor::FnDef(callable_def) => {\n+                let id = callable_def.to_chalk(db);\n+                TypeName::FnDef(id)\n+            }\n             TypeCtor::Int(Uncertain::Unknown)\n             | TypeCtor::Float(Uncertain::Unknown)\n             | TypeCtor::Adt(_)\n             | TypeCtor::Array\n-            | TypeCtor::FnDef(_)\n             | TypeCtor::FnPtr { .. }\n             | TypeCtor::Never\n             | TypeCtor::Closure { .. } => {\n@@ -260,7 +274,10 @@ impl ToChalk for TypeCtor {\n             TypeName::Ref(mutability) => TypeCtor::Ref(from_chalk(db, mutability)),\n             TypeName::Str => TypeCtor::Str,\n \n-            TypeName::FnDef(_) => unreachable!(),\n+            TypeName::FnDef(fn_def_id) => {\n+                let callable_def = from_chalk(db, fn_def_id);\n+                TypeCtor::FnDef(callable_def)\n+            }\n \n             TypeName::Error => {\n                 // this should not be reached, since we don't represent TypeName::Error with TypeCtor\n@@ -347,6 +364,18 @@ impl ToChalk for Impl {\n     }\n }\n \n+impl ToChalk for CallableDef {\n+    type Chalk = FnDefId;\n+\n+    fn to_chalk(self, db: &dyn HirDatabase) -> FnDefId {\n+        db.intern_callable_def(self).into()\n+    }\n+\n+    fn from_chalk(db: &dyn HirDatabase, fn_def_id: FnDefId) -> CallableDef {\n+        db.lookup_intern_callable_def(fn_def_id.into())\n+    }\n+}\n+\n impl ToChalk for TypeAliasId {\n     type Chalk = AssocTypeId;\n "}, {"sha": "d88828c7c0a0ecc9b72c145f45d2d9e21256beba", "filename": "crates/ra_hir_ty/src/traits/chalk/tls.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Ftls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Ftls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftraits%2Fchalk%2Ftls.rs?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -247,10 +247,24 @@ impl DebugContext<'_> {\n \n     pub fn debug_fn_def_id(\n         &self,\n-        _fn_def_id: chalk_ir::FnDefId<Interner>,\n+        fn_def_id: chalk_ir::FnDefId<Interner>,\n         fmt: &mut fmt::Formatter<'_>,\n     ) -> Result<(), fmt::Error> {\n-        write!(fmt, \"fn\")\n+        let def: CallableDef = from_chalk(self.0, fn_def_id);\n+        let name = match def {\n+            CallableDef::FunctionId(ff) => self.0.function_data(ff).name.clone(),\n+            CallableDef::StructId(s) => self.0.struct_data(s).name.clone(),\n+            CallableDef::EnumVariantId(e) => {\n+                let enum_data = self.0.enum_data(e.parent);\n+                enum_data.variants[e.local_id].name.clone()\n+            }\n+        };\n+        match def {\n+            CallableDef::FunctionId(_) => write!(fmt, \"{{fn {}}}\", name),\n+            CallableDef::StructId(_) | CallableDef::EnumVariantId(_) => {\n+                write!(fmt, \"{{ctor {}}}\", name)\n+            }\n+        }\n     }\n \n     pub fn debug_const("}, {"sha": "3405634f3395c8df2f26a0857a21302087f6d509", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 48, "deletions": 1, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4cc2ff6e390b6d8015ed1d266425459268f6e0b0/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=4cc2ff6e390b6d8015ed1d266425459268f6e0b0", "patch": "@@ -1,7 +1,7 @@\n import * as vscode from 'vscode';\n import * as path from \"path\";\n import * as os from \"os\";\n-import { promises as fs } from \"fs\";\n+import { promises as fs, PathLike } from \"fs\";\n \n import * as commands from './commands';\n import { activateInlayHints } from './inlay_hints';\n@@ -12,6 +12,7 @@ import { log, assert, isValidExecutable } from './util';\n import { PersistentState } from './persistent_state';\n import { fetchRelease, download } from './net';\n import { activateTaskProvider } from './tasks';\n+import { exec } from 'child_process';\n \n let ctx: Ctx | undefined;\n \n@@ -188,6 +189,46 @@ async function bootstrapServer(config: Config, state: PersistentState): Promise<\n     return path;\n }\n \n+async function patchelf(dest: PathLike): Promise<void> {\n+    await vscode.window.withProgress(\n+        {\n+            location: vscode.ProgressLocation.Notification,\n+            title: \"Patching rust-analyzer for NixOS\"\n+        },\n+        async (progress, _) => {\n+            const expression = `\n+            {src, pkgs ? import <nixpkgs> {}}:\n+                pkgs.stdenv.mkDerivation {\n+                    name = \"rust-analyzer\";\n+                    inherit src;\n+                    phases = [ \"installPhase\" \"fixupPhase\" ];\n+                    installPhase = \"cp $src $out\";\n+                    fixupPhase = ''\n+                    chmod 755 $out\n+                    patchelf --set-interpreter \"$(cat $NIX_CC/nix-support/dynamic-linker)\" $out\n+                    '';\n+                }\n+            `;\n+            const origFile = dest + \"-orig\";\n+            await fs.rename(dest, origFile);\n+            progress.report({ message: \"Patching executable\", increment: 20 });\n+            await new Promise((resolve, reject) => {\n+                const handle = exec(`nix-build -E - --arg src '${origFile}' -o ${dest}`,\n+                    (err, stdout, stderr) => {\n+                        if (err != null) {\n+                            reject(Error(stderr));\n+                        } else {\n+                            resolve(stdout);\n+                        }\n+                    });\n+                handle.stdin?.write(expression);\n+                handle.stdin?.end();\n+            });\n+            await fs.unlink(origFile);\n+        }\n+    );\n+}\n+\n async function getServer(config: Config, state: PersistentState): Promise<string | undefined> {\n     const explicitPath = process.env.__RA_LSP_SERVER_DEBUG ?? config.serverPath;\n     if (explicitPath) {\n@@ -237,6 +278,12 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n     assert(!!artifact, `Bad release: ${JSON.stringify(release)}`);\n \n     await download(artifact.browser_download_url, dest, \"Downloading rust-analyzer server\", { mode: 0o755 });\n+\n+    // Patching executable if that's NixOS.\n+    if (await fs.stat(\"/etc/nixos\").then(_ => true).catch(_ => false)) {\n+        await patchelf(dest);\n+    }\n+\n     await state.updateServerVersion(config.package.version);\n     return dest;\n }"}]}