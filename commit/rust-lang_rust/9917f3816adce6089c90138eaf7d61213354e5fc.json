{"sha": "9917f3816adce6089c90138eaf7d61213354e5fc", "node_id": "C_kwDOAAsO6NoAKDk5MTdmMzgxNmFkY2U2MDg5YzkwMTM4ZWFmN2Q2MTIxMzM1NGU1ZmM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-06-04T09:06:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-04T09:06:42Z"}, "message": "Rollup merge of #97716 - compiler-errors:issue-97708, r=wesleywiser\n\nFix reachability analysis for const methods\n\nUse `method_might_be_inlined` directly for `ImplItemKind::Fn` instead of duplicating the logic in `def_id_represents_local_inlined_item`.\n\nThis is parallel to how we use `item_might_be_inlined` for `ItemKind::Fn` in that same body.\n\nFixes #97708", "tree": {"sha": "00bd01d6dde1cf98870a2bbb2dd029f5c08bdd47", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/00bd01d6dde1cf98870a2bbb2dd029f5c08bdd47"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9917f3816adce6089c90138eaf7d61213354e5fc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJimyCiCRBK7hj4Ov3rIwAAC4cIAERGwXcxWfX8SYeyqunbDbWE\n+GWO619kZUcktcEAbS0CLapYhiuaYJeX4SstRj3JzS1ksW2AyalPzVBpgmI+ezf8\nfZ0WyXrv+30zWqqlLUksrXGVaaVjYfmAusmDlEswqHRoFb/u0pBEbglTj5woNuOi\n2l2a+EyBjq3Qh3nYAKSZFKRnBAh+9RmMeEuM/mommLIeR0B2torMQ70Ow9+AEj2Y\nNnCON6/cY3jwg/sCKdM0CVp5RphPBg8LrC8XifnW42+Sl14RrwUtM1OpqQtysAn+\nSeg8nZnHmGIawXRC9yfsf9mQ8fMnCu3IEnKboJMjzAL4wrXBQ8AuZcloFsfLbhc=\n=+csN\n-----END PGP SIGNATURE-----\n", "payload": "tree 00bd01d6dde1cf98870a2bbb2dd029f5c08bdd47\nparent 9c794b46cf56c6617d84fc264dc1784636fa71c3\nparent 15cccb97d60a19fc7120bb57840a83bdcc90dbad\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1654333602 +0200\ncommitter GitHub <noreply@github.com> 1654333602 +0200\n\nRollup merge of #97716 - compiler-errors:issue-97708, r=wesleywiser\n\nFix reachability analysis for const methods\n\nUse `method_might_be_inlined` directly for `ImplItemKind::Fn` instead of duplicating the logic in `def_id_represents_local_inlined_item`.\n\nThis is parallel to how we use `item_might_be_inlined` for `ItemKind::Fn` in that same body.\n\nFixes #97708\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9917f3816adce6089c90138eaf7d61213354e5fc", "html_url": "https://github.com/rust-lang/rust/commit/9917f3816adce6089c90138eaf7d61213354e5fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9917f3816adce6089c90138eaf7d61213354e5fc/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c794b46cf56c6617d84fc264dc1784636fa71c3", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c794b46cf56c6617d84fc264dc1784636fa71c3", "html_url": "https://github.com/rust-lang/rust/commit/9c794b46cf56c6617d84fc264dc1784636fa71c3"}, {"sha": "15cccb97d60a19fc7120bb57840a83bdcc90dbad", "url": "https://api.github.com/repos/rust-lang/rust/commits/15cccb97d60a19fc7120bb57840a83bdcc90dbad", "html_url": "https://github.com/rust-lang/rust/commit/15cccb97d60a19fc7120bb57840a83bdcc90dbad"}], "stats": {"total": 83, "additions": 58, "deletions": 25}, "files": [{"sha": "75376cdc592d36597c1d8b5e594d825d779c69cf", "filename": "compiler/rustc_passes/src/reachable.rs", "status": "modified", "additions": 8, "deletions": 25, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/9917f3816adce6089c90138eaf7d61213354e5fc/compiler%2Frustc_passes%2Fsrc%2Freachable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9917f3816adce6089c90138eaf7d61213354e5fc/compiler%2Frustc_passes%2Fsrc%2Freachable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Freachable.rs?ref=9917f3816adce6089c90138eaf7d61213354e5fc", "patch": "@@ -148,32 +148,15 @@ impl<'tcx> ReachableContext<'tcx> {\n                 hir::TraitItemKind::Fn(_, hir::TraitFn::Required(_))\n                 | hir::TraitItemKind::Type(..) => false,\n             },\n-            Some(Node::ImplItem(impl_item)) => {\n-                match impl_item.kind {\n-                    hir::ImplItemKind::Const(..) => true,\n-                    hir::ImplItemKind::Fn(..) => {\n-                        let attrs = self.tcx.codegen_fn_attrs(def_id);\n-                        let generics = self.tcx.generics_of(def_id);\n-                        if generics.requires_monomorphization(self.tcx) || attrs.requests_inline() {\n-                            true\n-                        } else {\n-                            let hir_id = self.tcx.hir().local_def_id_to_hir_id(def_id);\n-                            let impl_did = self.tcx.hir().get_parent_item(hir_id);\n-                            // Check the impl. If the generics on the self\n-                            // type of the impl require inlining, this method\n-                            // does too.\n-                            match self.tcx.hir().expect_item(impl_did).kind {\n-                                hir::ItemKind::Impl { .. } => {\n-                                    let generics = self.tcx.generics_of(impl_did);\n-                                    generics.requires_monomorphization(self.tcx)\n-                                }\n-                                _ => false,\n-                            }\n-                        }\n-                    }\n-                    hir::ImplItemKind::TyAlias(_) => false,\n+            Some(Node::ImplItem(impl_item)) => match impl_item.kind {\n+                hir::ImplItemKind::Const(..) => true,\n+                hir::ImplItemKind::Fn(..) => {\n+                    let hir_id = self.tcx.hir().local_def_id_to_hir_id(def_id);\n+                    let impl_did = self.tcx.hir().get_parent_item(hir_id);\n+                    method_might_be_inlined(self.tcx, impl_item, impl_did)\n                 }\n-            }\n+                hir::ImplItemKind::TyAlias(_) => false,\n+            },\n             Some(_) => false,\n             None => false, // This will happen for default methods.\n         }"}, {"sha": "e296bd3911310c687b60a58e043c4158e734fbb2", "filename": "src/test/ui/codegen/auxiliary/issue-97708-aux.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/9917f3816adce6089c90138eaf7d61213354e5fc/src%2Ftest%2Fui%2Fcodegen%2Fauxiliary%2Fissue-97708-aux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9917f3816adce6089c90138eaf7d61213354e5fc/src%2Ftest%2Fui%2Fcodegen%2Fauxiliary%2Fissue-97708-aux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcodegen%2Fauxiliary%2Fissue-97708-aux.rs?ref=9917f3816adce6089c90138eaf7d61213354e5fc", "patch": "@@ -0,0 +1,41 @@\n+use std::{ptr::NonNull, task::Poll};\n+\n+struct TaskRef;\n+\n+struct Header {\n+    vtable: &'static Vtable,\n+}\n+\n+struct Vtable {\n+    poll: unsafe fn(TaskRef) -> Poll<()>,\n+    deallocate: unsafe fn(NonNull<Header>),\n+}\n+\n+// in the \"Header\" type, which is a private type in maitake\n+impl Header {\n+    pub(crate) const fn new_stub() -> Self {\n+        unsafe fn nop(_ptr: TaskRef) -> Poll<()> {\n+            Poll::Pending\n+        }\n+\n+        unsafe fn nop_deallocate(ptr: NonNull<Header>) {\n+            unreachable!(\"stub task ({ptr:p}) should never be deallocated!\");\n+        }\n+\n+        Self { vtable: &Vtable { poll: nop, deallocate: nop_deallocate } }\n+    }\n+}\n+\n+// This is a public type in `maitake`\n+#[repr(transparent)]\n+#[cfg_attr(loom, allow(dead_code))]\n+pub struct TaskStub {\n+    hdr: Header,\n+}\n+\n+impl TaskStub {\n+    /// Create a new unique stub [`Task`].\n+    pub const fn new() -> Self {\n+        Self { hdr: Header::new_stub() }\n+    }\n+}"}, {"sha": "8cb28e9f1f6613e6bdfee9b0e6a0fdc89b82c030", "filename": "src/test/ui/codegen/issue-97708.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9917f3816adce6089c90138eaf7d61213354e5fc/src%2Ftest%2Fui%2Fcodegen%2Fissue-97708.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9917f3816adce6089c90138eaf7d61213354e5fc/src%2Ftest%2Fui%2Fcodegen%2Fissue-97708.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcodegen%2Fissue-97708.rs?ref=9917f3816adce6089c90138eaf7d61213354e5fc", "patch": "@@ -0,0 +1,9 @@\n+// build-pass\n+// aux-build:issue-97708-aux.rs\n+\n+extern crate issue_97708_aux;\n+use issue_97708_aux::TaskStub;\n+\n+static TASK_STUB: TaskStub = TaskStub::new();\n+\n+fn main() {}"}]}