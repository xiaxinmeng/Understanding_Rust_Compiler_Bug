{"sha": "3ad234f53bbc97805740e238604b5e5581003de7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhZDIzNGY1M2JiYzk3ODA1NzQwZTIzODYwNGI1ZTU1ODEwMDNkZTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-06T02:26:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-06T02:26:20Z"}, "message": "Auto merge of #57286 - alexcrichton:less-thin-2-2, r=nikomatsakis\n\nbootstrap: Link LLVM as a dylib with ThinLTO (take 2)\n\nWhen building a distributed compiler on Linux where we use ThinLTO to\ncreate the LLVM shared object this commit switches the compiler to\ndynamically linking that LLVM artifact instead of statically linking to\nLLVM. The primary goal here is to reduce CI compile times, avoiding two+\nThinLTO builds of all of LLVM. By linking dynamically to LLVM we'll\nreuse the one ThinLTO step done by LLVM's build itself.\n\nLots of discussion about this change can be found [here] and down. A\nperf run will show whether this is worth it or not!\n\n[here]: https://github.com/rust-lang/rust/pull/53245#issuecomment-417015334\n\n---\n\nThis PR previously landed in https://github.com/rust-lang/rust/pull/56944, caused https://github.com/rust-lang/rust/issues/57111, and was reverted in https://github.com/rust-lang/rust/pull/57116. I've added one more commit here which should fix the breakage that we saw.", "tree": {"sha": "17118654f599fd3fef2b6dd1771954fa967bee3a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/17118654f599fd3fef2b6dd1771954fa967bee3a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ad234f53bbc97805740e238604b5e5581003de7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ad234f53bbc97805740e238604b5e5581003de7", "html_url": "https://github.com/rust-lang/rust/commit/3ad234f53bbc97805740e238604b5e5581003de7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ad234f53bbc97805740e238604b5e5581003de7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad9068f874007e732d59ffef141f3ccd43e43a6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad9068f874007e732d59ffef141f3ccd43e43a6b", "html_url": "https://github.com/rust-lang/rust/commit/ad9068f874007e732d59ffef141f3ccd43e43a6b"}, {"sha": "71fed3a8ab479ec46d9fd9a7c5c8f4ffb97786dc", "url": "https://api.github.com/repos/rust-lang/rust/commits/71fed3a8ab479ec46d9fd9a7c5c8f4ffb97786dc", "html_url": "https://github.com/rust-lang/rust/commit/71fed3a8ab479ec46d9fd9a7c5c8f4ffb97786dc"}], "stats": {"total": 234, "additions": 30, "deletions": 204}, "files": [{"sha": "cc539d4c89571b0b371f3f3c3ea784c1997bc533", "filename": "src/bootstrap/check.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcheck.rs?ref=3ad234f53bbc97805740e238604b5e5581003de7", "patch": "@@ -38,7 +38,6 @@ impl Step for Std {\n         builder.info(&format!(\"Checking std artifacts ({} -> {})\", &compiler.host, target));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &libstd_stamp(builder, compiler, target),\n                   true);\n \n@@ -85,7 +84,6 @@ impl Step for Rustc {\n         builder.info(&format!(\"Checking compiler artifacts ({} -> {})\", &compiler.host, target));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &librustc_stamp(builder, compiler, target),\n                   true);\n \n@@ -136,7 +134,6 @@ impl Step for CodegenBackend {\n         let _folder = builder.fold_output(|| format!(\"stage{}-rustc_codegen_llvm\", compiler.stage));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &codegen_backend_stamp(builder, compiler, target, backend),\n                   true);\n     }\n@@ -174,7 +171,6 @@ impl Step for Test {\n         builder.info(&format!(\"Checking test artifacts ({} -> {})\", &compiler.host, target));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &libtest_stamp(builder, compiler, target),\n                   true);\n \n@@ -222,7 +218,6 @@ impl Step for Rustdoc {\n         println!(\"Checking rustdoc artifacts ({} -> {})\", &compiler.host, target);\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &rustdoc_stamp(builder, compiler, target),\n                   true);\n "}, {"sha": "0d2546a0e9ca9f6b30c6f8bc1111ad4773dc3ab9", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 8, "deletions": 41, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=3ad234f53bbc97805740e238604b5e5581003de7", "patch": "@@ -19,6 +19,7 @@ use build_helper::{output, mtime, up_to_date};\n use filetime::FileTime;\n use serde_json;\n \n+use crate::dist;\n use crate::util::{exe, libdir, is_dylib};\n use crate::{Compiler, Mode, GitRepo};\n use crate::native;\n@@ -104,7 +105,6 @@ impl Step for Std {\n                 &compiler.host, target));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &libstd_stamp(builder, compiler, target),\n                   false);\n \n@@ -365,7 +365,6 @@ impl Step for Test {\n                 &compiler.host, target));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &libtest_stamp(builder, compiler, target),\n                   false);\n \n@@ -493,7 +492,6 @@ impl Step for Rustc {\n                  compiler.stage, &compiler.host, target));\n         run_cargo(builder,\n                   &mut cargo,\n-                  vec![],\n                   &librustc_stamp(builder, compiler, target),\n                   false);\n \n@@ -636,47 +634,18 @@ impl Step for CodegenBackend {\n \n         let out_dir = builder.cargo_out(compiler, Mode::Codegen, target);\n \n-        let mut cargo = builder.cargo(compiler, Mode::Codegen, target, \"rustc\");\n+        let mut cargo = builder.cargo(compiler, Mode::Codegen, target, \"build\");\n         cargo.arg(\"--manifest-path\")\n             .arg(builder.src.join(\"src/librustc_codegen_llvm/Cargo.toml\"));\n         rustc_cargo_env(builder, &mut cargo);\n \n         let features = build_codegen_backend(&builder, &mut cargo, &compiler, target, backend);\n \n-        let mut cargo_tails_args = vec![];\n-\n-        if builder.config.llvm_thin_lto {\n-            cargo_tails_args.push(\"--\".to_string());\n-\n-            let num_jobs = builder.jobs();\n-\n-            if !target.contains(\"msvc\") {\n-                // Here we assume that the linker is clang. If it's not, there'll\n-                // be linker errors.\n-                cargo_tails_args.push(\"-Clink-arg=-fuse-ld=lld\".to_string());\n-                cargo_tails_args.push(\"-Clink-arg=-flto=thin\".to_string());\n-\n-                if builder.config.llvm_optimize {\n-                    cargo_tails_args.push(\"-Clink-arg=-O2\".to_string());\n-                }\n-\n-                // Let's make LLD respect the `-j` option.\n-                let num_jobs_arg = format!(\"-Clink-arg=-Wl,--thinlto-jobs={}\", num_jobs);\n-                cargo_tails_args.push(num_jobs_arg);\n-            } else {\n-                // Here we assume that the linker is lld-link.exe. lld-link.exe\n-                // does not need the extra arguments except for num_jobs\n-                let num_jobs_arg = format!(\"-Clink-arg=/opt:lldltojobs={}\", num_jobs);\n-                cargo_tails_args.push(num_jobs_arg);\n-            }\n-        }\n-\n         let tmp_stamp = out_dir.join(\".tmp.stamp\");\n \n         let _folder = builder.fold_output(|| format!(\"stage{}-rustc_codegen_llvm\", compiler.stage));\n         let files = run_cargo(builder,\n                               cargo.arg(\"--features\").arg(features),\n-                              cargo_tails_args,\n                               &tmp_stamp,\n                               false);\n         if builder.config.dry_run {\n@@ -749,7 +718,9 @@ pub fn build_codegen_backend(builder: &Builder,\n                                          \"libstdc++.a\");\n                 cargo.env(\"LLVM_STATIC_STDCPP\", file);\n             }\n-            if builder.config.llvm_link_shared {\n+            if builder.config.llvm_link_shared ||\n+                (builder.config.llvm_thin_lto && backend != \"emscripten\")\n+            {\n                 cargo.env(\"LLVM_LINK_SHARED\", \"1\");\n             }\n         }\n@@ -989,6 +960,8 @@ impl Step for Assemble {\n             copy_lld_to_sysroot(builder, target_compiler, &lld_install);\n         }\n \n+        dist::maybe_install_llvm_dylib(builder, target_compiler.host, &sysroot);\n+\n         // Link the compiler binary itself into place\n         let out_dir = builder.cargo_out(build_compiler, Mode::Rustc, host);\n         let rustc = out_dir.join(exe(\"rustc_binary\", &*host));\n@@ -1015,7 +988,6 @@ pub fn add_to_sysroot(builder: &Builder, sysroot_dst: &Path, stamp: &Path) {\n \n pub fn run_cargo(builder: &Builder,\n                  cargo: &mut Command,\n-                 tail_args: Vec<String>,\n                  stamp: &Path,\n                  is_check: bool)\n     -> Vec<PathBuf>\n@@ -1038,7 +1010,7 @@ pub fn run_cargo(builder: &Builder,\n     // files we need to probe for later.\n     let mut deps = Vec::new();\n     let mut toplevel = Vec::new();\n-    let ok = stream_cargo(builder, cargo, tail_args, &mut |msg| {\n+    let ok = stream_cargo(builder, cargo, &mut |msg| {\n         let filenames = match msg {\n             CargoMessage::CompilerArtifact { filenames, .. } => filenames,\n             _ => return,\n@@ -1163,7 +1135,6 @@ pub fn run_cargo(builder: &Builder,\n pub fn stream_cargo(\n     builder: &Builder,\n     cargo: &mut Command,\n-    tail_args: Vec<String>,\n     cb: &mut dyn FnMut(CargoMessage),\n ) -> bool {\n     if builder.config.dry_run {\n@@ -1174,10 +1145,6 @@ pub fn stream_cargo(\n     cargo.arg(\"--message-format\").arg(\"json\")\n          .stdout(Stdio::piped());\n \n-    for arg in tail_args {\n-        cargo.arg(arg);\n-    }\n-\n     builder.verbose(&format!(\"running: {:?}\", cargo));\n     let mut child = match cargo.spawn() {\n         Ok(child) => child,"}, {"sha": "38869bf441a827607a63e768363bbda1f8ce7431", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 16, "deletions": 8, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=3ad234f53bbc97805740e238604b5e5581003de7", "patch": "@@ -671,10 +671,18 @@ impl Step for Std {\n         let mut src = builder.sysroot_libdir(compiler, target).to_path_buf();\n         src.pop(); // Remove the trailing /lib folder from the sysroot_libdir\n         builder.cp_filtered(&src, &dst, &|path| {\n-            let name = path.file_name().and_then(|s| s.to_str());\n-            name != Some(builder.config.rust_codegen_backends_dir.as_str()) &&\n-                name != Some(\"bin\")\n-\n+            if let Some(name) = path.file_name().and_then(|s| s.to_str()) {\n+                if name == builder.config.rust_codegen_backends_dir.as_str() {\n+                    return false\n+                }\n+                if name == \"bin\" {\n+                    return false\n+                }\n+                if name.contains(\"LLVM\") {\n+                    return false\n+                }\n+            }\n+            true\n         });\n \n         let mut cmd = rust_installer(builder);\n@@ -1877,13 +1885,13 @@ impl Step for HashSign {\n // LLVM tools are linked dynamically.\n // Note: This function does no yet support Windows but we also don't support\n //       linking LLVM tools dynamically on Windows yet.\n-fn maybe_install_llvm_dylib(builder: &Builder,\n-                            target: Interned<String>,\n-                            image: &Path) {\n+pub fn maybe_install_llvm_dylib(builder: &Builder,\n+                                target: Interned<String>,\n+                                sysroot: &Path) {\n     let src_libdir = builder\n         .llvm_out(target)\n         .join(\"lib\");\n-    let dst_libdir = image.join(\"lib/rustlib\").join(&*target).join(\"lib\");\n+    let dst_libdir = sysroot.join(\"lib/rustlib\").join(&*target).join(\"lib\");\n     t!(fs::create_dir_all(&dst_libdir));\n \n     if target.contains(\"apple-darwin\") {"}, {"sha": "d31ea0f845873743cfaa82d2020aba28981c353b", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ad234f53bbc97805740e238604b5e5581003de7/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=3ad234f53bbc97805740e238604b5e5581003de7", "patch": "@@ -77,7 +77,7 @@ impl Step for ToolBuild {\n         let _folder = builder.fold_output(|| format!(\"stage{}-{}\", compiler.stage, tool));\n         builder.info(&format!(\"Building stage{} tool {} ({})\", compiler.stage, tool, target));\n         let mut duplicates = Vec::new();\n-        let is_expected = compile::stream_cargo(builder, &mut cargo, vec![], &mut |msg| {\n+        let is_expected = compile::stream_cargo(builder, &mut cargo, &mut |msg| {\n             // Only care about big things like the RLS/Cargo for now\n             match tool {\n                 | \"rls\""}, {"sha": "20a3009378d37ec7ea5377e4a379eff43e0f70e3", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3ad234f53bbc97805740e238604b5e5581003de7/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ad234f53bbc97805740e238604b5e5581003de7/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=3ad234f53bbc97805740e238604b5e5581003de7", "patch": "@@ -200,14 +200,7 @@ pub fn run<F>(run_compiler: F) -> isize\n }\n \n fn load_backend_from_dylib(path: &Path) -> fn() -> Box<dyn CodegenBackend> {\n-    // Note that we're specifically using `open_global_now` here rather than\n-    // `open`, namely we want the behavior on Unix of RTLD_GLOBAL and RTLD_NOW,\n-    // where NOW means \"bind everything right now\" because we don't want\n-    // surprises later on and RTLD_GLOBAL allows the symbols to be made\n-    // available for future dynamic libraries opened. This is currently used by\n-    // loading LLVM and then making its symbols available for other dynamic\n-    // libraries.\n-    let lib = DynamicLibrary::open_global_now(path).unwrap_or_else(|err| {\n+    let lib = DynamicLibrary::open(Some(path)).unwrap_or_else(|err| {\n         let err = format!(\"couldn't load codegen backend {:?}: {:?}\", path, err);\n         early_error(ErrorOutputType::default(), &err);\n     });"}, {"sha": "98cf20a7ba7f40901a7bc2e902969c9c2fe04f8e", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3ad234f53bbc97805740e238604b5e5581003de7/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ad234f53bbc97805740e238604b5e5581003de7/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=3ad234f53bbc97805740e238604b5e5581003de7", "patch": "@@ -132,6 +132,10 @@ fn main() {\n             continue;\n         }\n \n+        if flag.starts_with(\"-flto\") {\n+            continue;\n+        }\n+\n         // -Wdate-time is not supported by the netbsd cross compiler\n         if is_crossed && target.contains(\"netbsd\") && flag.contains(\"date-time\") {\n             continue;"}, {"sha": "8a18aadf36a8bb635684927b165c09f869f0c862", "filename": "src/test/run-make-fulldeps/llvm-pass/Makefile", "status": "removed", "additions": 0, "deletions": 28, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2FMakefile?ref=ad9068f874007e732d59ffef141f3ccd43e43a6b", "patch": "@@ -1,28 +0,0 @@\n--include ../tools.mk\n-\n-ifeq ($(UNAME),Darwin)\n-PLUGIN_FLAGS := -C link-args=-Wl,-undefined,dynamic_lookup\n-endif\n-\n-ifeq ($(findstring stage1,$(RUST_BUILD_STAGE)),stage1)\n-# ignore stage1\n-all:\n-\n-else\n-# Windows doesn't correctly handle include statements with escaping paths,\n-# so this test will not get run on Windows.\n-ifdef IS_WINDOWS\n-all:\n-else\n-all: $(call NATIVE_STATICLIB,llvm-function-pass) $(call NATIVE_STATICLIB,llvm-module-pass)\n-\t$(RUSTC) plugin.rs -C prefer-dynamic $(PLUGIN_FLAGS)\n-\t$(RUSTC) main.rs\n-\n-$(TMPDIR)/libllvm-function-pass.o:\n-\t$(CXX) $(CFLAGS) $(LLVM_CXXFLAGS) -c llvm-function-pass.so.cc -o $(TMPDIR)/libllvm-function-pass.o\n-\n-$(TMPDIR)/libllvm-module-pass.o:\n-\t$(CXX) $(CFLAGS) $(LLVM_CXXFLAGS) -c llvm-module-pass.so.cc -o $(TMPDIR)/libllvm-module-pass.o\n-endif\n-\n-endif"}, {"sha": "267c68853ac4383d121301c7dcdb833e9b13e45a", "filename": "src/test/run-make-fulldeps/llvm-pass/llvm-function-pass.so.cc", "status": "removed", "additions": 0, "deletions": 46, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fllvm-function-pass.so.cc", "raw_url": "https://github.com/rust-lang/rust/raw/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fllvm-function-pass.so.cc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fllvm-function-pass.so.cc?ref=ad9068f874007e732d59ffef141f3ccd43e43a6b", "patch": "@@ -1,46 +0,0 @@\n-#include <stdio.h>\n-#include <stdlib.h>\n-#include <unistd.h>\n-\n-#include \"llvm/Pass.h\"\n-#include \"llvm/IR/Function.h\"\n-\n-using namespace llvm;\n-\n-namespace {\n-\n-  class TestLLVMPass : public FunctionPass {\n-\n-  public:\n-\n-    static char ID;\n-    TestLLVMPass() : FunctionPass(ID) { }\n-\n-    bool runOnFunction(Function &F) override;\n-\n-    StringRef getPassName() const override {\n-      return \"Some LLVM pass\";\n-    }\n-\n-  };\n-\n-}\n-\n-bool TestLLVMPass::runOnFunction(Function &F) {\n-  // A couple examples of operations that previously caused segmentation faults\n-  // https://github.com/rust-lang/rust/issues/31067\n-\n-  for (auto N = F.begin(); N != F.end(); ++N) {\n-    /* code */\n-  }\n-\n-  LLVMContext &C = F.getContext();\n-  IntegerType *Int8Ty  = IntegerType::getInt8Ty(C);\n-  PointerType::get(Int8Ty, 0);\n-  return true;\n-}\n-\n-char TestLLVMPass::ID = 0;\n-\n-static RegisterPass<TestLLVMPass> RegisterAFLPass(\n-  \"some-llvm-function-pass\", \"Some LLVM pass\");"}, {"sha": "b3ee0c1a6c10bb2b909161c6e13d49171e287a6b", "filename": "src/test/run-make-fulldeps/llvm-pass/llvm-module-pass.so.cc", "status": "removed", "additions": 0, "deletions": 45, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fllvm-module-pass.so.cc", "raw_url": "https://github.com/rust-lang/rust/raw/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fllvm-module-pass.so.cc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fllvm-module-pass.so.cc?ref=ad9068f874007e732d59ffef141f3ccd43e43a6b", "patch": "@@ -1,45 +0,0 @@\n-#include <stdio.h>\n-#include <stdlib.h>\n-#include <unistd.h>\n-\n-#include \"llvm/IR/Module.h\"\n-\n-using namespace llvm;\n-\n-namespace {\n-\n-  class TestLLVMPass : public ModulePass {\n-\n-  public:\n-\n-    static char ID;\n-    TestLLVMPass() : ModulePass(ID) { }\n-\n-    bool runOnModule(Module &M) override;\n-\n-    StringRef getPassName() const override {\n-      return \"Some LLVM pass\";\n-    }\n-\n-  };\n-\n-}\n-\n-bool TestLLVMPass::runOnModule(Module &M) {\n-  // A couple examples of operations that previously caused segmentation faults\n-  // https://github.com/rust-lang/rust/issues/31067\n-\n-  for (auto F = M.begin(); F != M.end(); ++F) {\n-    /* code */\n-  }\n-\n-  LLVMContext &C = M.getContext();\n-  IntegerType *Int8Ty  = IntegerType::getInt8Ty(C);\n-  PointerType::get(Int8Ty, 0);\n-  return true;\n-}\n-\n-char TestLLVMPass::ID = 0;\n-\n-static RegisterPass<TestLLVMPass> RegisterAFLPass(\n-  \"some-llvm-module-pass\", \"Some LLVM pass\");"}, {"sha": "0c13b890c6e3a4e096cd1525f5ba62fdf7586b2a", "filename": "src/test/run-make-fulldeps/llvm-pass/main.rs", "status": "removed", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fmain.rs?ref=ad9068f874007e732d59ffef141f3ccd43e43a6b", "patch": "@@ -1,4 +0,0 @@\n-#![feature(plugin)]\n-#![plugin(some_plugin)]\n-\n-fn main() {}"}, {"sha": "f0e4800046cf4da37097252d569cce8851bf0d0c", "filename": "src/test/run-make-fulldeps/llvm-pass/plugin.rs", "status": "removed", "additions": 0, "deletions": 18, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fplugin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9068f874007e732d59ffef141f3ccd43e43a6b/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fplugin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fllvm-pass%2Fplugin.rs?ref=ad9068f874007e732d59ffef141f3ccd43e43a6b", "patch": "@@ -1,18 +0,0 @@\n-#![feature(plugin_registrar, rustc_private)]\n-#![crate_type = \"dylib\"]\n-#![crate_name = \"some_plugin\"]\n-\n-extern crate rustc;\n-extern crate rustc_plugin;\n-\n-#[link(name = \"llvm-function-pass\", kind = \"static\")]\n-#[link(name = \"llvm-module-pass\", kind = \"static\")]\n-extern {}\n-\n-use rustc_plugin::registry::Registry;\n-\n-#[plugin_registrar]\n-pub fn plugin_registrar(reg: &mut Registry) {\n-    reg.register_llvm_pass(\"some-llvm-function-pass\");\n-    reg.register_llvm_pass(\"some-llvm-module-pass\");\n-}"}]}