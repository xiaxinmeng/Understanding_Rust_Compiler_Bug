{"sha": "5718cc2f9b32290dc34ce320076f92d90c00fb7d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3MThjYzJmOWIzMjI5MGRjMzRjZTMyMDA3NmY5MmQ5MGMwMGZiN2Q=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-12-29T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-12-29T00:00:00Z"}, "message": "Make forget intrinsic safe", "tree": {"sha": "1fbd30e642e861f19c4cc6fe44df9c16ce740be5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1fbd30e642e861f19c4cc6fe44df9c16ce740be5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5718cc2f9b32290dc34ce320076f92d90c00fb7d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5718cc2f9b32290dc34ce320076f92d90c00fb7d", "html_url": "https://github.com/rust-lang/rust/commit/5718cc2f9b32290dc34ce320076f92d90c00fb7d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5718cc2f9b32290dc34ce320076f92d90c00fb7d/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "158f8d034b15e65ba8dc0d066358dd0632bfcd6e", "url": "https://api.github.com/repos/rust-lang/rust/commits/158f8d034b15e65ba8dc0d066358dd0632bfcd6e", "html_url": "https://github.com/rust-lang/rust/commit/158f8d034b15e65ba8dc0d066358dd0632bfcd6e"}], "stats": {"total": 34, "additions": 17, "deletions": 17}, "files": [{"sha": "673dec6c7f9a74b81abe70d5cd8e19e8fcfea593", "filename": "compiler/rustc_typeck/src/check/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5718cc2f9b32290dc34ce320076f92d90c00fb7d/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5718cc2f9b32290dc34ce320076f92d90c00fb7d/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs?ref=5718cc2f9b32290dc34ce320076f92d90c00fb7d", "patch": "@@ -92,6 +92,7 @@ pub fn intrinsic_operation_unsafety(intrinsic: Symbol) -> hir::Unsafety {\n         | sym::rustc_peek\n         | sym::maxnumf64\n         | sym::type_name\n+        | sym::forget\n         | sym::variant_count => hir::Unsafety::Normal,\n         _ => hir::Unsafety::Unsafe,\n     }"}, {"sha": "87956787242ac6216aa6396aa3af413c1498fc9d", "filename": "library/core/src/mem/mod.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5718cc2f9b32290dc34ce320076f92d90c00fb7d/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5718cc2f9b32290dc34ce320076f92d90c00fb7d/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs?ref=5718cc2f9b32290dc34ce320076f92d90c00fb7d", "patch": "@@ -151,9 +151,14 @@ pub const fn forget<T>(t: T) {\n #[inline]\n #[unstable(feature = \"forget_unsized\", issue = \"none\")]\n pub fn forget_unsized<T: ?Sized>(t: T) {\n+    #[cfg(bootstrap)]\n     // SAFETY: the forget intrinsic could be safe, but there's no point in making it safe since\n     // we'll be implementing this function soon via `ManuallyDrop`\n-    unsafe { intrinsics::forget(t) }\n+    unsafe {\n+        intrinsics::forget(t)\n+    }\n+    #[cfg(not(bootstrap))]\n+    intrinsics::forget(t)\n }\n \n /// Returns the size of a type in bytes."}, {"sha": "096bba64c0bb882522373957cc04aa07f3df9440", "filename": "src/test/mir-opt/lower_intrinsics.forget.LowerIntrinsics.diff", "status": "modified", "additions": 9, "deletions": 15, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5718cc2f9b32290dc34ce320076f92d90c00fb7d/src%2Ftest%2Fmir-opt%2Flower_intrinsics.forget.LowerIntrinsics.diff", "raw_url": "https://github.com/rust-lang/rust/raw/5718cc2f9b32290dc34ce320076f92d90c00fb7d/src%2Ftest%2Fmir-opt%2Flower_intrinsics.forget.LowerIntrinsics.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Flower_intrinsics.forget.LowerIntrinsics.diff?ref=5718cc2f9b32290dc34ce320076f92d90c00fb7d", "patch": "@@ -4,27 +4,21 @@\n   fn forget(_1: T) -> () {\n       debug t => _1;                       // in scope 0 at $DIR/lower_intrinsics.rs:18:18: 18:19\n       let mut _0: ();                      // return place in scope 0 at $DIR/lower_intrinsics.rs:18:24: 18:24\n-      let _2: ();                          // in scope 0 at $DIR/lower_intrinsics.rs:19:14: 19:41\n-      let mut _3: T;                       // in scope 0 at $DIR/lower_intrinsics.rs:19:39: 19:40\n-      scope 1 {\n-      }\n+      let mut _2: T;                       // in scope 0 at $DIR/lower_intrinsics.rs:19:30: 19:31\n   \n       bb0: {\n-          StorageLive(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:43\n-          StorageLive(_3);                 // scope 1 at $DIR/lower_intrinsics.rs:19:39: 19:40\n-          _3 = move _1;                    // scope 1 at $DIR/lower_intrinsics.rs:19:39: 19:40\n--         _2 = std::intrinsics::forget::<T>(move _3) -> bb1; // scope 1 at $DIR/lower_intrinsics.rs:19:14: 19:41\n+          StorageLive(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:30: 19:31\n+          _2 = move _1;                    // scope 0 at $DIR/lower_intrinsics.rs:19:30: 19:31\n+-         _0 = std::intrinsics::forget::<T>(move _2) -> bb1; // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:32\n -                                          // mir::Constant\n--                                          // + span: $DIR/lower_intrinsics.rs:19:14: 19:38\n--                                          // + literal: Const { ty: unsafe extern \"rust-intrinsic\" fn(T) {std::intrinsics::forget::<T>}, val: Value(Scalar(<ZST>)) }\n-+         _2 = const ();                   // scope 1 at $DIR/lower_intrinsics.rs:19:14: 19:41\n-+         goto -> bb1;                     // scope 1 at $DIR/lower_intrinsics.rs:19:14: 19:41\n+-                                          // + span: $DIR/lower_intrinsics.rs:19:5: 19:29\n+-                                          // + literal: Const { ty: extern \"rust-intrinsic\" fn(T) {std::intrinsics::forget::<T>}, val: Value(Scalar(<ZST>)) }\n++         _0 = const ();                   // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:32\n++         goto -> bb1;                     // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:32\n       }\n   \n       bb1: {\n-          StorageDead(_3);                 // scope 1 at $DIR/lower_intrinsics.rs:19:40: 19:41\n-          StorageDead(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:43: 19:44\n-          _0 = const ();                   // scope 0 at $DIR/lower_intrinsics.rs:18:24: 20:2\n+          StorageDead(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:31: 19:32\n           goto -> bb2;                     // scope 0 at $DIR/lower_intrinsics.rs:20:1: 20:2\n       }\n   "}, {"sha": "d9891465dabb743fc4afd282f76549e7b2205f4c", "filename": "src/test/mir-opt/lower_intrinsics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5718cc2f9b32290dc34ce320076f92d90c00fb7d/src%2Ftest%2Fmir-opt%2Flower_intrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5718cc2f9b32290dc34ce320076f92d90c00fb7d/src%2Ftest%2Fmir-opt%2Flower_intrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Flower_intrinsics.rs?ref=5718cc2f9b32290dc34ce320076f92d90c00fb7d", "patch": "@@ -16,7 +16,7 @@ pub fn size_of<T>() -> usize {\n \n // EMIT_MIR lower_intrinsics.forget.LowerIntrinsics.diff\n pub fn forget<T>(t: T) {\n-    unsafe { core::intrinsics::forget(t) };\n+    core::intrinsics::forget(t)\n }\n \n // EMIT_MIR lower_intrinsics.unreachable.LowerIntrinsics.diff"}]}