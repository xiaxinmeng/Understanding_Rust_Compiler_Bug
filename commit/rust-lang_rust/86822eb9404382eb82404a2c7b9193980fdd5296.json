{"sha": "86822eb9404382eb82404a2c7b9193980fdd5296", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg2ODIyZWI5NDA0MzgyZWI4MjQwNGEyYzdiOTE5Mzk4MGZkZDUyOTY=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2018-12-07T18:51:03Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2018-12-07T18:51:03Z"}, "message": "Unconditionally emit the target-cpu LLVM attribute.", "tree": {"sha": "185f77900db55d617b29b9972effc6c42fda01fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/185f77900db55d617b29b9972effc6c42fda01fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/86822eb9404382eb82404a2c7b9193980fdd5296", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/86822eb9404382eb82404a2c7b9193980fdd5296", "html_url": "https://github.com/rust-lang/rust/commit/86822eb9404382eb82404a2c7b9193980fdd5296", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/86822eb9404382eb82404a2c7b9193980fdd5296/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58e9832a0d1681916cbcf9d7cf3de7d79dbaa8d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/58e9832a0d1681916cbcf9d7cf3de7d79dbaa8d5", "html_url": "https://github.com/rust-lang/rust/commit/58e9832a0d1681916cbcf9d7cf3de7d79dbaa8d5"}], "stats": {"total": 10, "additions": 3, "deletions": 7}, "files": [{"sha": "c919335cd4e1c734f602845ec4560f7d5ba602f0", "filename": "src/librustc_codegen_llvm/attributes.rs", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/86822eb9404382eb82404a2c7b9193980fdd5296/src%2Flibrustc_codegen_llvm%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86822eb9404382eb82404a2c7b9193980fdd5296/src%2Flibrustc_codegen_llvm%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fattributes.rs?ref=86822eb9404382eb82404a2c7b9193980fdd5296", "patch": "@@ -18,6 +18,7 @@ use rustc::session::config::Sanitizer;\n use rustc::ty::TyCtxt;\n use rustc::ty::layout::HasTyCtxt;\n use rustc::ty::query::Providers;\n+use rustc_data_structures::small_c_str::SmallCStr;\n use rustc_data_structures::sync::Lrc;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_target::spec::PanicStrategy;\n@@ -129,8 +130,7 @@ pub fn llvm_target_features(sess: &Session) -> impl Iterator<Item = &str> {\n }\n \n pub fn apply_target_cpu_attr(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value) {\n-    let cpu = llvm_util::target_cpu(cx.tcx.sess);\n-    let target_cpu = CString::new(cpu).unwrap();\n+    let target_cpu = SmallCStr::new(llvm_util::target_cpu(cx.tcx.sess));\n     llvm::AddFunctionAttrStringValue(\n             llfn,\n             llvm::AttributePlace::Function,\n@@ -220,11 +220,7 @@ pub fn from_fn_attrs(\n     // Always annotate functions with the target-cpu they are compiled for.\n     // Without this, ThinLTO won't inline Rust functions into Clang generated\n     // functions (because Clang annotates functions this way too).\n-    // NOTE: For now we just apply this if -Zcross-lang-lto is specified, since\n-    //       it introduce a little overhead and isn't really necessary otherwise.\n-    if cx.tcx.sess.opts.debugging_opts.cross_lang_lto.enabled() {\n-        apply_target_cpu_attr(cx, llfn);\n-    }\n+    apply_target_cpu_attr(cx, llfn);\n \n     let features = llvm_target_features(cx.tcx.sess)\n         .map(|s| s.to_string())"}]}