{"sha": "68a74decb683929f59588e07636e44c40434d6bc", "node_id": "C_kwDOAAsO6NoAKDY4YTc0ZGVjYjY4MzkyOWY1OTU4OGUwNzYzNmU0NGM0MDQzNGQ2YmM", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-05-17T08:45:44Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-05-17T08:45:44Z"}, "message": "Process `macro_use` prelude in semantic scope resolver", "tree": {"sha": "a74e8867c342840dec9a1875cb53360195dbe850", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a74e8867c342840dec9a1875cb53360195dbe850"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68a74decb683929f59588e07636e44c40434d6bc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmRklJ4ACgkQ4laYqTBY\nYXEqhw//W7fBrAL9FJfMcfile2hAcSps1XFZzfSljzOTWXfQYq/yoWkUsiK4qMcv\n7mQk97SGPMbB+x0F9YFqPtOceDwkFAfNfIxKA5czOpnLpoQs7COeqDXqWxxjS1Fo\nZYWo3iOMEcw+eMqhyCwZGhovdTw+g4yq14eaGnZxOi5b7ma3GoZeD2p+X5CKZrsC\nKRd5xV/T9p/Z61dqKdOrYQv3y/we0qJl6N7Pws1yvQ+8k0woWREPpDbJcS9yn20t\nroIgqx9+0Zp2giYISY2gWztmF+VmpL89ClIFPHGSuwwh80a1EhVDto5TPlUi3P84\nJtChUqaFErBSQfxGDfdMWR8DOD5j4224WbtgCmtnbU0QYIe2ZdnuDUybBXWPG2IP\nmkPNu+bYRbwSZj75QJOg23NjQiBPCTT/Va8S1ES3TpuEa2CdmkUQKcR4gQvWdkzM\n+GcRmpfAmocOdI7vzuSweRlwDlx08imEqfATZgPfn9A3b3khum8PnVCBmm4pg3rC\nXBxrRfQcauy7grJKw/uq0owM0gig69Ud/fznJKCGx2k7/7hj/8+lAJeb2ZSjeba0\nfb7d62xv/uXQW8yTZInJI8GwoENk18P4emWz/i337Hm2pF/VVE4+qYX2SRaZ0tuY\nAJY/TflGemuF9xYhULi3d3Aay8VRoeuo2ZJqV5eMjIVH8TOQck8=\n=5swV\n-----END PGP SIGNATURE-----", "payload": "tree a74e8867c342840dec9a1875cb53360195dbe850\nparent 2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1684313144 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1684313144 +0900\n\nProcess `macro_use` prelude in semantic scope resolver\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68a74decb683929f59588e07636e44c40434d6bc", "html_url": "https://github.com/rust-lang/rust/commit/68a74decb683929f59588e07636e44c40434d6bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68a74decb683929f59588e07636e44c40434d6bc/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a", "html_url": "https://github.com/rust-lang/rust/commit/2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "1e299fecc9d81426314d94917e9dc0ac7a81f92b", "filename": "crates/hir-def/src/find_path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fhir-def%2Fsrc%2Ffind_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fhir-def%2Fsrc%2Ffind_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Ffind_path.rs?ref=68a74decb683929f59588e07636e44c40434d6bc", "patch": "@@ -183,7 +183,7 @@ fn find_path_for_module(\n \n     // - if the item is the crate root of a dependency crate, return the name from the extern prelude\n     let root_def_map = crate_root.def_map(db);\n-    for (name, &def_id) in root_def_map.extern_prelude() {\n+    for (name, def_id) in root_def_map.extern_prelude() {\n         if module_id == def_id {\n             let name = scope_name.unwrap_or_else(|| name.clone());\n "}, {"sha": "176637f9d0dde163a227f0b36d69eb483c86fc64", "filename": "crates/hir-def/src/nameres.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fhir-def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fhir-def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fnameres.rs?ref=68a74decb683929f59588e07636e44c40434d6bc", "patch": "@@ -355,8 +355,12 @@ impl DefMap {\n         self.prelude\n     }\n \n-    pub(crate) fn extern_prelude(&self) -> impl Iterator<Item = (&Name, &ModuleId)> + '_ {\n-        self.extern_prelude.iter()\n+    pub(crate) fn extern_prelude(&self) -> impl Iterator<Item = (&Name, ModuleId)> + '_ {\n+        self.extern_prelude.iter().map(|(name, def)| (name, *def))\n+    }\n+\n+    pub(crate) fn macro_use_prelude(&self) -> impl Iterator<Item = (&Name, MacroId)> + '_ {\n+        self.macro_use_prelude.iter().map(|(name, def)| (name, *def))\n     }\n \n     pub fn module_id(&self, local_id: LocalModuleId) -> ModuleId {"}, {"sha": "afa3b33cc9fea1d3afdafa39cee4fa2febfdf7f1", "filename": "crates/hir-def/src/resolver.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fhir-def%2Fsrc%2Fresolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fhir-def%2Fsrc%2Fresolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fresolver.rs?ref=68a74decb683929f59588e07636e44c40434d6bc", "patch": "@@ -461,7 +461,10 @@ impl Resolver {\n                 res.add(name, ScopeDef::ModuleDef(ModuleDefId::MacroId(mac)));\n             })\n         });\n-        def_map.extern_prelude().for_each(|(name, &def)| {\n+        def_map.macro_use_prelude().for_each(|(name, def)| {\n+            res.add(name, ScopeDef::ModuleDef(def.into()));\n+        });\n+        def_map.extern_prelude().for_each(|(name, def)| {\n             res.add(name, ScopeDef::ModuleDef(ModuleDefId::ModuleId(def)));\n         });\n         BUILTIN_SCOPE.iter().for_each(|(name, &def)| {"}, {"sha": "8c038c0fbaa1c93b519549f303dacd96e24c232f", "filename": "crates/ide-completion/src/tests/flyimport.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68a74decb683929f59588e07636e44c40434d6bc/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=68a74decb683929f59588e07636e44c40434d6bc", "patch": "@@ -1265,3 +1265,24 @@ macro_rules! define_struct {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn macro_use_prelude_is_in_scope() {\n+    check(\n+        r#\"\n+//- /main.rs crate:main deps:dep\n+#[macro_use]\n+extern crate dep;\n+\n+fn main() {\n+    print$0\n+}\n+//- /lib.rs crate:dep\n+#[macro_export]\n+macro_rules! println {\n+    () => {}\n+}\n+\"#,\n+        expect![\"\"],\n+    )\n+}"}]}