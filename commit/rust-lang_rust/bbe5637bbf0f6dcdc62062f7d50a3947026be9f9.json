{"sha": "bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "node_id": "C_kwDOAAsO6NoAKGJiZTU2MzdiYmYwZjZkY2RjNjIwNjJmN2Q1MGEzOTQ3MDI2YmU5Zjk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-13T18:35:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-13T18:35:09Z"}, "message": "Auto merge of #13016 - Veykril:vscode-diag-workaround, r=Veykril\n\nMove VSCode diagnostics workaroudn into client code", "tree": {"sha": "17d6721e2ed6bafc340eac2970f9813c09fb2b4b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/17d6721e2ed6bafc340eac2970f9813c09fb2b4b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "html_url": "https://github.com/rust-lang/rust/commit/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "306687b640e0453e4a95de5eae8933f65c9e3757", "url": "https://api.github.com/repos/rust-lang/rust/commits/306687b640e0453e4a95de5eae8933f65c9e3757", "html_url": "https://github.com/rust-lang/rust/commit/306687b640e0453e4a95de5eae8933f65c9e3757"}, {"sha": "ec8256dd8027bbe5493698e4b9125f1f0cf8c646", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec8256dd8027bbe5493698e4b9125f1f0cf8c646", "html_url": "https://github.com/rust-lang/rust/commit/ec8256dd8027bbe5493698e4b9125f1f0cf8c646"}], "stats": {"total": 34, "additions": 14, "deletions": 20}, "files": [{"sha": "943d043bc1995dbfc3eb49bde756cf4fdd0c1e8f", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "patch": "@@ -1320,8 +1320,7 @@ pub(crate) fn publish_diagnostics(\n                 .unwrap(),\n             }),\n             source: Some(\"rust-analyzer\".to_string()),\n-            // https://github.com/rust-lang/rust-analyzer/issues/11404\n-            message: if !d.message.is_empty() { d.message } else { \" \".to_string() },\n+            message: d.message,\n             related_information: None,\n             tags: if d.unused { Some(vec![DiagnosticTag::UNNECESSARY]) } else { None },\n             data: None,"}, {"sha": "77419998249f41fc49f2d66e1fc3f43a83ff6765", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 4, "deletions": 18, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "patch": "@@ -327,29 +327,15 @@ impl GlobalState {\n                     continue;\n                 }\n \n-                let url = file_id_to_url(&self.vfs.read().0, file_id);\n-                let mut diagnostics =\n+                let uri = file_id_to_url(&self.vfs.read().0, file_id);\n+                let diagnostics =\n                     self.diagnostics.diagnostics_for(file_id).cloned().collect::<Vec<_>>();\n-                for d in &mut diagnostics {\n-                    // https://github.com/rust-lang/rust-analyzer/issues/11404\n-                    // FIXME: We should move this workaround into the client code\n-                    if d.message.is_empty() {\n-                        d.message = \" \".to_string();\n-                    }\n-                    if let Some(rds) = d.related_information.as_mut() {\n-                        for rd in rds {\n-                            if rd.message.is_empty() {\n-                                rd.message = \" \".to_string();\n-                            }\n-                        }\n-                    }\n-                }\n-                let version = from_proto::vfs_path(&url)\n+                let version = from_proto::vfs_path(&uri)\n                     .map(|path| self.mem_docs.get(&path).map(|it| it.version))\n                     .unwrap_or_default();\n \n                 self.send_notification::<lsp_types::notification::PublishDiagnostics>(\n-                    lsp_types::PublishDiagnosticsParams { uri: url, diagnostics, version },\n+                    lsp_types::PublishDiagnosticsParams { uri, diagnostics, version },\n                 );\n             }\n         }"}, {"sha": "40ba17844bee0675fb2a3ed17b557de58592318d", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/bbe5637bbf0f6dcdc62062f7d50a3947026be9f9/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=bbe5637bbf0f6dcdc62062f7d50a3947026be9f9", "patch": "@@ -105,6 +105,15 @@ export async function createClient(\n         traceOutputChannel: traceOutputChannel(),\n         outputChannel: outputChannel(),\n         middleware: {\n+            async handleDiagnostics(uri, diagnostics, next) {\n+                // Workaround for https://github.com/microsoft/vscode/issues/155531\n+                for (const diagnostic of diagnostics) {\n+                    if (!diagnostic.message) {\n+                        diagnostic.message = \" \";\n+                    }\n+                }\n+                next(uri, diagnostics);\n+            },\n             async provideHover(\n                 document: vscode.TextDocument,\n                 position: vscode.Position,"}]}