{"sha": "f77971e221d4726520b18217eb2acb291fb74ce9", "node_id": "C_kwDOAAsO6NoAKGY3Nzk3MWUyMjFkNDcyNjUyMGIxODIxN2ViMmFjYjI5MWZiNzRjZTk", "commit": {"author": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-05-13T12:19:01Z"}, "committer": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-05-13T15:45:19Z"}, "message": "Handle error body when in generator layout", "tree": {"sha": "dd1d7279a3ecf00afd196521081bf86dfa07fafd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dd1d7279a3ecf00afd196521081bf86dfa07fafd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f77971e221d4726520b18217eb2acb291fb74ce9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f77971e221d4726520b18217eb2acb291fb74ce9", "html_url": "https://github.com/rust-lang/rust/commit/f77971e221d4726520b18217eb2acb291fb74ce9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f77971e221d4726520b18217eb2acb291fb74ce9/comments", "author": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "committer": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "69fef92ab2f287f072b66fb7b4f62c8bb4acba43", "url": "https://api.github.com/repos/rust-lang/rust/commits/69fef92ab2f287f072b66fb7b4f62c8bb4acba43", "html_url": "https://github.com/rust-lang/rust/commit/69fef92ab2f287f072b66fb7b4f62c8bb4acba43"}], "stats": {"total": 60, "additions": 49, "deletions": 11}, "files": [{"sha": "d3495d3dbd71ae57703ff4ecb38e645c4c4efff1", "filename": "compiler/rustc_hir_analysis/src/check/check.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -1514,8 +1514,8 @@ fn opaque_type_cycle_error(\n                     }\n                     if tcx.sess.opts.unstable_opts.drop_tracking_mir\n                         && let DefKind::Generator = tcx.def_kind(closure_def_id)\n+                        && let Some(generator_layout) = tcx.mir_generator_witnesses(closure_def_id)\n                     {\n-                        let generator_layout = tcx.mir_generator_witnesses(closure_def_id);\n                         for interior_ty in &generator_layout.field_tys {\n                             label_match(interior_ty.ty, interior_ty.source_info.span);\n                         }"}, {"sha": "0d7f9b75b2267b2fd66ffdf767b36cd072f4eb77", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -1516,8 +1516,11 @@ impl<'a, 'tcx> EncodeContext<'a, 'tcx> {\n             if encode_opt {\n                 record!(self.tables.optimized_mir[def_id.to_def_id()] <- tcx.optimized_mir(def_id));\n \n-                if tcx.sess.opts.unstable_opts.drop_tracking_mir && let DefKind::Generator = self.tcx.def_kind(def_id) {\n-                    record!(self.tables.mir_generator_witnesses[def_id.to_def_id()] <- tcx.mir_generator_witnesses(def_id));\n+                if tcx.sess.opts.unstable_opts.drop_tracking_mir\n+                    && let DefKind::Generator = self.tcx.def_kind(def_id)\n+                    && let Some(witnesses) = tcx.mir_generator_witnesses(def_id)\n+                {\n+                    record!(self.tables.mir_generator_witnesses[def_id.to_def_id()] <- witnesses);\n                 }\n             }\n             if encode_const {"}, {"sha": "e4689fac8b5dbae56052d56b35ca03616a43266c", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -446,7 +446,7 @@ rustc_queries! {\n         }\n     }\n \n-    query mir_generator_witnesses(key: DefId) -> &'tcx mir::GeneratorLayout<'tcx> {\n+    query mir_generator_witnesses(key: DefId) -> &'tcx Option<mir::GeneratorLayout<'tcx>> {\n         arena_cache\n         desc { |tcx| \"generator witness types for `{}`\", tcx.def_path_str(key) }\n         cache_on_disk_if { key.is_local() }"}, {"sha": "22c5d68e9f9e1935014589bc1c8c7449147d206b", "filename": "compiler/rustc_middle/src/ty/util.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -667,10 +667,10 @@ impl<'tcx> TyCtxt<'tcx> {\n         self,\n         def_id: DefId,\n     ) -> impl Iterator<Item = ty::EarlyBinder<Ty<'tcx>>> {\n-        let generator_layout = &self.mir_generator_witnesses(def_id);\n+        let generator_layout = self.mir_generator_witnesses(def_id);\n         generator_layout\n-            .field_tys\n-            .iter()\n+            .as_ref()\n+            .map_or_else(|| [].iter(), |l| l.field_tys.iter())\n             .filter(|decl| !decl.ignore_for_traits)\n             .map(|decl| ty::EarlyBinder(decl.ty))\n     }"}, {"sha": "891e446942e018bafa7918242fb0266924812d5d", "filename": "compiler/rustc_mir_transform/src/generator.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -1397,7 +1397,7 @@ fn create_cases<'tcx>(\n pub(crate) fn mir_generator_witnesses<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     def_id: LocalDefId,\n-) -> GeneratorLayout<'tcx> {\n+) -> Option<GeneratorLayout<'tcx>> {\n     assert!(tcx.sess.opts.unstable_opts.drop_tracking_mir);\n \n     let (body, _) = tcx.mir_promoted(def_id);\n@@ -1410,6 +1410,7 @@ pub(crate) fn mir_generator_witnesses<'tcx>(\n     // Get the interior types and substs which typeck computed\n     let movable = match *gen_ty.kind() {\n         ty::Generator(_, _, movability) => movability == hir::Movability::Movable,\n+        ty::Error(_) => return None,\n         _ => span_bug!(body.span, \"unexpected generator type {}\", gen_ty),\n     };\n \n@@ -1425,7 +1426,7 @@ pub(crate) fn mir_generator_witnesses<'tcx>(\n \n     check_suspend_tys(tcx, &generator_layout, &body);\n \n-    generator_layout\n+    Some(generator_layout)\n }\n \n impl<'tcx> MirPass<'tcx> for StateTransform {"}, {"sha": "ea17f23434bce6c12f56744e6cd14e5cad820bb1", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -2447,10 +2447,9 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n             && generator_did.is_local()\n             // Try to avoid cycles.\n             && !generator_within_in_progress_typeck\n+            && let Some(generator_info) = self.tcx.mir_generator_witnesses(generator_did)\n         {\n-            let generator_info = &self.tcx.mir_generator_witnesses(generator_did);\n             debug!(?generator_info);\n-\n             'find_source: for (variant, source_info) in\n                 generator_info.variant_fields.iter().zip(&generator_info.variant_source_info)\n             {"}, {"sha": "f99d9ab6bf860c224ca5eb7afdf8913d25218bb7", "filename": "tests/ui/generator/drop-tracking-error-body.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/tests%2Fui%2Fgenerator%2Fdrop-tracking-error-body.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/tests%2Fui%2Fgenerator%2Fdrop-tracking-error-body.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fgenerator%2Fdrop-tracking-error-body.rs?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -0,0 +1,18 @@\n+// compile-flags: -Zdrop-tracking-mir --edition=2021\n+\n+#![feature(generators)]\n+\n+pub async fn async_bad_body() {\n+    match true {} //~ ERROR non-exhaustive patterns: type `bool` is non-empty\n+}\n+\n+pub fn generator_bad_body() {\n+    || {\n+        // 'non-exhaustive pattern' only seems to be reported once, so this annotation doesn't work\n+        // keep the function around so we can make sure it doesn't ICE\n+        match true {}; // ERROR non-exhaustive patterns: type `bool` is non-empty\n+        yield ();\n+    };\n+}\n+\n+fn main() {}"}, {"sha": "28a6892336ff2db8351e5d6d82479f9f2359646a", "filename": "tests/ui/generator/drop-tracking-error-body.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/f77971e221d4726520b18217eb2acb291fb74ce9/tests%2Fui%2Fgenerator%2Fdrop-tracking-error-body.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f77971e221d4726520b18217eb2acb291fb74ce9/tests%2Fui%2Fgenerator%2Fdrop-tracking-error-body.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fgenerator%2Fdrop-tracking-error-body.stderr?ref=f77971e221d4726520b18217eb2acb291fb74ce9", "patch": "@@ -0,0 +1,17 @@\n+error[E0004]: non-exhaustive patterns: type `bool` is non-empty\n+  --> $DIR/drop-tracking-error-body.rs:6:11\n+   |\n+LL |     match true {}\n+   |           ^^^^\n+   |\n+   = note: the matched value is of type `bool`\n+help: ensure that all possible cases are being handled by adding a match arm with a wildcard pattern as shown\n+   |\n+LL ~     match true {\n+LL +         _ => todo!(),\n+LL ~     }\n+   |\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0004`."}]}