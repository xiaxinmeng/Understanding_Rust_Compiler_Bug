{"sha": "13fb0794aca868c2b73493d7e008e1b395dacea4", "node_id": "C_kwDOAAsO6NoAKDEzZmIwNzk0YWNhODY4YzJiNzM0OTNkN2UwMDhlMWIzOTVkYWNlYTQ", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-05-13T10:29:05Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-05-13T10:29:05Z"}, "message": "Do not ICE on deeply nested borrows.", "tree": {"sha": "69d878a53ce66e07b279816c7a06a6caa8067607", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69d878a53ce66e07b279816c7a06a6caa8067607"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/13fb0794aca868c2b73493d7e008e1b395dacea4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/13fb0794aca868c2b73493d7e008e1b395dacea4", "html_url": "https://github.com/rust-lang/rust/commit/13fb0794aca868c2b73493d7e008e1b395dacea4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/13fb0794aca868c2b73493d7e008e1b395dacea4/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19652377c3f056aa0db32b8586e5a707b965a90d", "url": "https://api.github.com/repos/rust-lang/rust/commits/19652377c3f056aa0db32b8586e5a707b965a90d", "html_url": "https://github.com/rust-lang/rust/commit/19652377c3f056aa0db32b8586e5a707b965a90d"}], "stats": {"total": 19, "additions": 17, "deletions": 2}, "files": [{"sha": "bbd9f76ba5cc354e24cbdd048ac3ed78bee933c8", "filename": "compiler/rustc_mir_transform/src/ref_prop.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/13fb0794aca868c2b73493d7e008e1b395dacea4/compiler%2Frustc_mir_transform%2Fsrc%2Fref_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13fb0794aca868c2b73493d7e008e1b395dacea4/compiler%2Frustc_mir_transform%2Fsrc%2Fref_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fref_prop.rs?ref=13fb0794aca868c2b73493d7e008e1b395dacea4", "patch": "@@ -363,8 +363,10 @@ impl<'tcx> MutVisitor<'tcx> for Replacer<'tcx> {\n             if let Some((&PlaceElem::Deref, rest)) = target.projection.split_last() {\n                 *place = Place::from(target.local).project_deeper(rest, self.tcx);\n                 self.any_replacement = true;\n-            } else if self.fully_replacable_locals.contains(place.local) {\n-                debuginfo.references += 1;\n+            } else if self.fully_replacable_locals.contains(place.local)\n+                && let Some(references) = debuginfo.references.checked_add(1)\n+            {\n+                debuginfo.references = references;\n                 *place = target;\n                 self.any_replacement = true;\n             }"}, {"sha": "eb573790daf5ba72c43eae1007ef5c275828cee7", "filename": "tests/mir-opt/reference_prop.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/13fb0794aca868c2b73493d7e008e1b395dacea4/tests%2Fmir-opt%2Freference_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13fb0794aca868c2b73493d7e008e1b395dacea4/tests%2Fmir-opt%2Freference_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Freference_prop.rs?ref=13fb0794aca868c2b73493d7e008e1b395dacea4", "patch": "@@ -548,6 +548,18 @@ fn debuginfo() {\n     }\n }\n \n+fn many_debuginfo() {\n+    let a = 0;\n+\n+    // Verify that we do not ICE on deeply nested borrows.\n+    let many_borrow =\n+        &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\n+        &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\n+        &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\n+        &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\n+        &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&a;\n+}\n+\n fn main() {\n     let mut x = 5_usize;\n     let mut y = 7_usize;\n@@ -562,6 +574,7 @@ fn main() {\n     mut_raw_then_mut_shr();\n     unique_with_copies();\n     debuginfo();\n+    many_debuginfo();\n }\n \n // EMIT_MIR reference_prop.reference_propagation.ReferencePropagation.diff"}]}