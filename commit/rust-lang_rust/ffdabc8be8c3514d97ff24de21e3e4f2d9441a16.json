{"sha": "ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmZGFiYzhiZThjMzUxNGQ5N2ZmMjRkZTIxZTNlNGYyZDk0NDFhMTY=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-09-15T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-09-15T13:42:15Z"}, "message": "Check for shadowing issues involving block labels", "tree": {"sha": "f9c6d60ae359a4a3e1386db53438f24718f5240a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f9c6d60ae359a4a3e1386db53438f24718f5240a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "html_url": "https://github.com/rust-lang/rust/commit/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb", "url": "https://api.github.com/repos/rust-lang/rust/commits/e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb", "html_url": "https://github.com/rust-lang/rust/commit/e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb"}], "stats": {"total": 82, "additions": 61, "deletions": 21}, "files": [{"sha": "548c734b86543ef1a71ce4d314e10f1c7f1219d6", "filename": "compiler/rustc_resolve/src/late/lifetimes.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -1652,7 +1652,11 @@ fn extract_labels(ctxt: &mut LifetimeContext<'_, '_>, body: &hir::Body<'_>) {\n     }\n \n     fn expression_label(ex: &hir::Expr<'_>) -> Option<Ident> {\n-        if let hir::ExprKind::Loop(_, Some(label), ..) = ex.kind { Some(label.ident) } else { None }\n+        match ex.kind {\n+            hir::ExprKind::Loop(_, Some(label), ..) => Some(label.ident),\n+            hir::ExprKind::Block(_, Some(label)) => Some(label.ident),\n+            _ => None,\n+        }\n     }\n \n     fn check_if_label_shadows_lifetime(tcx: TyCtxt<'_>, mut scope: ScopeRef<'_>, label: Ident) {"}, {"sha": "68a19a8f6f7170c9b9a95deb61292acab941bc66", "filename": "src/test/ui/loops/loops-reject-duplicate-labels-2.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels-2.rs?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -1,7 +1,7 @@\n // check-pass\n+#![feature(label_break_value)]\n \n-\n-// Issue #21633: reject duplicate loop labels in function bodies.\n+// Issue #21633: reject duplicate loop labels and block labels in function bodies.\n //\n // This is testing the generalization (to the whole function body)\n // discussed here:\n@@ -26,6 +26,8 @@ pub fn foo() {\n     { 'lt: loop { break; } }\n     { 'lt: while let Some(_) = None::<i32> { break; } }\n                                          //~^ WARN label name `'lt` shadows a label name that is already in scope\n+    { 'bl: {} }\n+    { 'bl: {} } //~ WARN label name `'bl` shadows a label name that is already in scope\n }\n \n "}, {"sha": "2c372fcff7a12aa1c6cc37ac90c1b2e48e1b6751", "filename": "src/test/ui/loops/loops-reject-duplicate-labels-2.stderr", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels-2.stderr?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -62,5 +62,13 @@ LL |     { 'lt: loop { break; } }\n LL |     { 'lt: while let Some(_) = None::<i32> { break; } }\n    |       ^^^ label `'lt` already in scope\n \n-warning: 8 warnings emitted\n+warning: label name `'bl` shadows a label name that is already in scope\n+  --> $DIR/loops-reject-duplicate-labels-2.rs:30:7\n+   |\n+LL |     { 'bl: {} }\n+   |       --- first declared here\n+LL |     { 'bl: {} }\n+   |       ^^^ label `'bl` already in scope\n+\n+warning: 9 warnings emitted\n "}, {"sha": "c34bcf3df1d76253870af5d66e5837acb9af1772", "filename": "src/test/ui/loops/loops-reject-duplicate-labels.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels.rs?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -1,8 +1,7 @@\n // check-pass\n+#![feature(label_break_value)]\n \n-\n-// Issue #21633: reject duplicate loop labels in function bodies.\n-// This is testing the exact cases that are in the issue description.\n+// Issue #21633: reject duplicate loop labels and block labels in function bodies.\n \n #[allow(unused_labels)]\n fn foo() {\n@@ -24,6 +23,8 @@ fn foo() {\n     'lt: loop { break; }\n     'lt: while let Some(_) = None::<i32> { break; }\n                                    //~^ WARN label name `'lt` shadows a label name that is already in scope\n+    'bl: {}\n+    'bl: {} //~ WARN label name `'bl` shadows a label name that is already in scope\n }\n \n // Note however that it is okay for the same label to be reused in\n@@ -33,12 +34,16 @@ struct S;\n impl S {\n     fn m1(&self) { 'okay: loop { break 'okay; } }\n     fn m2(&self) { 'okay: loop { break 'okay; } }\n+    fn m3(&self) { 'okay: { break 'okay; } }\n+    fn m4(&self) { 'okay: { break 'okay; } }\n }\n \n \n pub fn main() {\n     let s = S;\n     s.m1();\n     s.m2();\n+    s.m3();\n+    s.m4();\n     foo();\n }"}, {"sha": "3bf3af763ecfc9aa80fb3ea306c709e0da693f6b", "filename": "src/test/ui/loops/loops-reject-duplicate-labels.stderr", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floops-reject-duplicate-labels.stderr?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -1,66 +1,74 @@\n warning: label name `'fl` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:10:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:9:5\n    |\n LL |     'fl: for _ in 0..10 { break; }\n    |     --- first declared here\n LL |     'fl: loop { break; }\n    |     ^^^ label `'fl` already in scope\n \n warning: label name `'lf` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:13:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:12:5\n    |\n LL |     'lf: loop { break; }\n    |     --- first declared here\n LL |     'lf: for _ in 0..10 { break; }\n    |     ^^^ label `'lf` already in scope\n \n warning: label name `'wl` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:15:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:14:5\n    |\n LL |     'wl: while 2 > 1 { break; }\n    |     --- first declared here\n LL |     'wl: loop { break; }\n    |     ^^^ label `'wl` already in scope\n \n warning: label name `'lw` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:17:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:16:5\n    |\n LL |     'lw: loop { break; }\n    |     --- first declared here\n LL |     'lw: while 2 > 1 { break; }\n    |     ^^^ label `'lw` already in scope\n \n warning: label name `'fw` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:19:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:18:5\n    |\n LL |     'fw: for _ in 0..10 { break; }\n    |     --- first declared here\n LL |     'fw: while 2 > 1 { break; }\n    |     ^^^ label `'fw` already in scope\n \n warning: label name `'wf` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:21:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:20:5\n    |\n LL |     'wf: while 2 > 1 { break; }\n    |     --- first declared here\n LL |     'wf: for _ in 0..10 { break; }\n    |     ^^^ label `'wf` already in scope\n \n warning: label name `'tl` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:23:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:22:5\n    |\n LL |     'tl: while let Some(_) = None::<i32> { break; }\n    |     --- first declared here\n LL |     'tl: loop { break; }\n    |     ^^^ label `'tl` already in scope\n \n warning: label name `'lt` shadows a label name that is already in scope\n-  --> $DIR/loops-reject-duplicate-labels.rs:25:5\n+  --> $DIR/loops-reject-duplicate-labels.rs:24:5\n    |\n LL |     'lt: loop { break; }\n    |     --- first declared here\n LL |     'lt: while let Some(_) = None::<i32> { break; }\n    |     ^^^ label `'lt` already in scope\n \n-warning: 8 warnings emitted\n+warning: label name `'bl` shadows a label name that is already in scope\n+  --> $DIR/loops-reject-duplicate-labels.rs:27:5\n+   |\n+LL |     'bl: {}\n+   |     --- first declared here\n+LL |     'bl: {}\n+   |     ^^^ label `'bl` already in scope\n+\n+warning: 9 warnings emitted\n "}, {"sha": "ce2d07eb06a4d766e8fcbc86ade0b87b98fb8a09", "filename": "src/test/ui/loops/loops-reject-lifetime-shadowing-label.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-lifetime-shadowing-label.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-lifetime-shadowing-label.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floops-reject-lifetime-shadowing-label.rs?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -1,10 +1,10 @@\n // check-pass\n-\n+#![feature(label_break_value)]\n #![allow(dead_code, unused_variables)]\n \n-// Issue #21633:  reject duplicate loop labels in function bodies.\n+// Issue #21633:  reject duplicate loop labels and block labels in function bodies.\n //\n-// Test rejection of lifetimes in *expressions* that shadow loop labels.\n+// Test rejection of lifetimes in *expressions* that shadow labels.\n \n fn foo() {\n     // Reusing lifetime `'a` in function item is okay.\n@@ -23,8 +23,13 @@ fn foo() {\n         assert_eq!((*b)(&z), z);\n         break 'a;\n     }\n-}\n \n+    'b: {\n+        let b = Box::new(|x: &()| ()) as Box<dyn for <'b> Fn(&'b ())>;\n+        //~^ WARN lifetime name `'b` shadows a label name that is already in scope\n+        break 'b;\n+    }\n+}\n \n pub fn main() {\n     foo();"}, {"sha": "9702b71600b5e572878742d1bc26542ae750ff84", "filename": "src/test/ui/loops/loops-reject-lifetime-shadowing-label.stderr", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-lifetime-shadowing-label.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ffdabc8be8c3514d97ff24de21e3e4f2d9441a16/src%2Ftest%2Fui%2Floops%2Floops-reject-lifetime-shadowing-label.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floops-reject-lifetime-shadowing-label.stderr?ref=ffdabc8be8c3514d97ff24de21e3e4f2d9441a16", "patch": "@@ -6,5 +6,13 @@ LL |     'a: loop {\n LL |         let b = Box::new(|x: &i8| *x) as Box<dyn for <'a> Fn(&'a i8) -> i8>;\n    |                                                       ^^ label `'a` already in scope\n \n-warning: 1 warning emitted\n+warning: lifetime name `'b` shadows a label name that is already in scope\n+  --> $DIR/loops-reject-lifetime-shadowing-label.rs:28:55\n+   |\n+LL |     'b: {\n+   |     -- first declared here\n+LL |         let b = Box::new(|x: &()| ()) as Box<dyn for <'b> Fn(&'b ())>;\n+   |                                                       ^^ label `'b` already in scope\n+\n+warning: 2 warnings emitted\n "}]}