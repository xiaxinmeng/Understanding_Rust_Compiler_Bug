{"sha": "fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "node_id": "C_kwDOAAsO6NoAKGZmZjYyOTZiNjIwMDhkODllZGZiZjlkNGFmZDI0OTZiNTNkN2QyY2Q", "commit": {"author": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2022-12-03T18:27:18Z"}, "committer": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2022-12-03T18:27:18Z"}, "message": "Destruct landing_pad return value before passing it to cg_ssa", "tree": {"sha": "ed15fa5836478a7c2b59b7d015a2142a644e0fa8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed15fa5836478a7c2b59b7d015a2142a644e0fa8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "html_url": "https://github.com/rust-lang/rust/commit/fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "703d95e183fbb678249d8f61cabc732e46884e00", "url": "https://api.github.com/repos/rust-lang/rust/commits/703d95e183fbb678249d8f61cabc732e46884e00", "html_url": "https://github.com/rust-lang/rust/commit/703d95e183fbb678249d8f61cabc732e46884e00"}], "stats": {"total": 56, "additions": 25, "deletions": 31}, "files": [{"sha": "effb2de4827518c08360bed61995f5ffe3c86a58", "filename": "compiler/rustc_codegen_gcc/src/builder.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_gcc%2Fsrc%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_gcc%2Fsrc%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Fbuilder.rs?ref=fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "patch": "@@ -1119,18 +1119,18 @@ impl<'a, 'gcc, 'tcx> BuilderMethods<'a, 'tcx> for Builder<'a, 'gcc, 'tcx> {\n         // TODO(antoyo)\n     }\n \n-    fn cleanup_landing_pad(&mut self, _ty: Type<'gcc>, _pers_fn: RValue<'gcc>) -> RValue<'gcc> {\n-        let field1 = self.context.new_field(None, self.u8_type.make_pointer(), \"landing_pad_field_1\");\n-        let field2 = self.context.new_field(None, self.i32_type, \"landing_pad_field_1\");\n-        let struct_type = self.context.new_struct_type(None, \"landing_pad\", &[field1, field2]);\n-        self.current_func().new_local(None, struct_type.as_type(), \"landing_pad\")\n-            .to_rvalue()\n+    fn cleanup_landing_pad(&mut self, _pers_fn: RValue<'gcc>) -> (RValue<'gcc>, RValue<'gcc>) {\n+        (\n+            self.current_func().new_local(None, self.u8_type.make_pointer(), \"landing_pad0\")\n+                .to_rvalue(),\n+            self.current_func().new_local(None, self.i32_type, \"landing_pad1\").to_rvalue(),\n+        )\n         // TODO(antoyo): Properly implement unwinding.\n         // the above is just to make the compilation work as it seems\n         // rustc_codegen_ssa now calls the unwinding builder methods even on panic=abort.\n     }\n \n-    fn resume(&mut self, _exn: RValue<'gcc>) {\n+    fn resume(&mut self, _exn0: RValue<'gcc>, _exn1: RValue<'gcc>) {\n         // TODO(bjorn3): Properly implement unwinding.\n         self.unreachable();\n     }"}, {"sha": "b7d6435a759b2db9823fb14d959ae72e3828f531", "filename": "compiler/rustc_codegen_llvm/src/builder.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbuilder.rs?ref=fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "patch": "@@ -961,15 +961,20 @@ impl<'a, 'll, 'tcx> BuilderMethods<'a, 'tcx> for Builder<'a, 'll, 'tcx> {\n         }\n     }\n \n-    fn cleanup_landing_pad(&mut self, ty: &'ll Type, pers_fn: &'ll Value) -> &'ll Value {\n+    fn cleanup_landing_pad(&mut self, pers_fn: &'ll Value) -> (&'ll Value, &'ll Value) {\n+        let ty = self.type_struct(&[self.type_i8p(), self.type_i32()], false);\n         let landing_pad = self.landing_pad(ty, pers_fn, 1 /* FIXME should this be 0? */);\n         unsafe {\n             llvm::LLVMSetCleanup(landing_pad, llvm::True);\n         }\n-        landing_pad\n+        (self.extract_value(landing_pad, 0), self.extract_value(landing_pad, 1))\n     }\n \n-    fn resume(&mut self, exn: &'ll Value) {\n+    fn resume(&mut self, exn0: &'ll Value, exn1: &'ll Value) {\n+        let ty = self.type_struct(&[self.type_i8p(), self.type_i32()], false);\n+        let mut exn = self.const_undef(ty);\n+        exn = self.insert_value(exn, exn0, 0);\n+        exn = self.insert_value(exn, exn1, 1);\n         unsafe {\n             llvm::LLVMBuildResume(self.llbuilder, exn);\n         }"}, {"sha": "1ef5217a2da619658fa0a27592786aaaa5f165d9", "filename": "compiler/rustc_codegen_ssa/src/mir/block.rs", "status": "modified", "additions": 8, "deletions": 19, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs?ref=fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "patch": "@@ -289,16 +289,13 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             bx.cleanup_ret(funclet, None);\n         } else {\n             let slot = self.get_personality_slot(bx);\n-            let lp0 = slot.project_field(bx, 0);\n-            let lp0 = bx.load_operand(lp0).immediate();\n-            let lp1 = slot.project_field(bx, 1);\n-            let lp1 = bx.load_operand(lp1).immediate();\n+            let exn0 = slot.project_field(bx, 0);\n+            let exn0 = bx.load_operand(exn0).immediate();\n+            let exn1 = slot.project_field(bx, 1);\n+            let exn1 = bx.load_operand(exn1).immediate();\n             slot.storage_dead(bx);\n \n-            let mut lp = bx.const_undef(self.landing_pad_type());\n-            lp = bx.insert_value(lp, lp0, 0);\n-            lp = bx.insert_value(lp, lp1, 1);\n-            bx.resume(lp);\n+            bx.resume(exn0, exn1);\n         }\n     }\n \n@@ -1635,24 +1632,17 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             let mut cleanup_bx = Bx::build(self.cx, cleanup_llbb);\n \n             let llpersonality = self.cx.eh_personality();\n-            let llretty = self.landing_pad_type();\n-            let lp = cleanup_bx.cleanup_landing_pad(llretty, llpersonality);\n+            let (exn0, exn1) = cleanup_bx.cleanup_landing_pad(llpersonality);\n \n             let slot = self.get_personality_slot(&mut cleanup_bx);\n             slot.storage_live(&mut cleanup_bx);\n-            Pair(cleanup_bx.extract_value(lp, 0), cleanup_bx.extract_value(lp, 1))\n-                .store(&mut cleanup_bx, slot);\n+            Pair(exn0, exn1).store(&mut cleanup_bx, slot);\n \n             cleanup_bx.br(llbb);\n             cleanup_llbb\n         }\n     }\n \n-    fn landing_pad_type(&self) -> Bx::Type {\n-        let cx = self.cx;\n-        cx.type_struct(&[cx.type_i8p(), cx.type_i32()], false)\n-    }\n-\n     fn unreachable_block(&mut self) -> Bx::BasicBlock {\n         self.unreachable_block.unwrap_or_else(|| {\n             let llbb = Bx::append_block(self.cx, self.llfn, \"unreachable\");\n@@ -1672,8 +1662,7 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             self.set_debug_loc(&mut bx, mir::SourceInfo::outermost(self.mir.span));\n \n             let llpersonality = self.cx.eh_personality();\n-            let llretty = self.landing_pad_type();\n-            bx.cleanup_landing_pad(llretty, llpersonality);\n+            bx.cleanup_landing_pad(llpersonality);\n \n             let (fn_abi, fn_ptr) = common::build_langcall(&bx, None, LangItem::PanicNoUnwind);\n             let fn_ty = bx.fn_decl_backend_type(&fn_abi);"}, {"sha": "194768d946674e4ae28c1a1bf7abb352def8dd63", "filename": "compiler/rustc_codegen_ssa/src/traits/builder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fff6296b62008d89edfbf9d4afd2496b53d7d2cd/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbuilder.rs?ref=fff6296b62008d89edfbf9d4afd2496b53d7d2cd", "patch": "@@ -271,8 +271,8 @@ pub trait BuilderMethods<'a, 'tcx>:\n     fn set_personality_fn(&mut self, personality: Self::Value);\n \n     // These are used by everyone except msvc\n-    fn cleanup_landing_pad(&mut self, ty: Self::Type, pers_fn: Self::Value) -> Self::Value;\n-    fn resume(&mut self, exn: Self::Value);\n+    fn cleanup_landing_pad(&mut self, pers_fn: Self::Value) -> (Self::Value, Self::Value);\n+    fn resume(&mut self, exn0: Self::Value, exn1: Self::Value);\n \n     // These are used only by msvc\n     fn cleanup_pad(&mut self, parent: Option<Self::Value>, args: &[Self::Value]) -> Self::Funclet;"}]}