{"sha": "4054030542bf06671ba478cefbfb2aa33131e839", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwNTQwMzA1NDJiZjA2NjcxYmE0NzhjZWZiZmIyYWEzMzEzMWU4Mzk=", "commit": {"author": {"name": "ritiek", "email": "ritiekmalhotra123@gmail.com", "date": "2018-01-06T06:13:34Z"}, "committer": {"name": "ritiek", "email": "ritiekmalhotra123@gmail.com", "date": "2018-01-06T06:13:34Z"}, "message": "Show line numbers", "tree": {"sha": "f008115ad8dac599c76dbcefafd01ae4ca56a002", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f008115ad8dac599c76dbcefafd01ae4ca56a002"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4054030542bf06671ba478cefbfb2aa33131e839", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4054030542bf06671ba478cefbfb2aa33131e839", "html_url": "https://github.com/rust-lang/rust/commit/4054030542bf06671ba478cefbfb2aa33131e839", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4054030542bf06671ba478cefbfb2aa33131e839/comments", "author": {"login": "ritiek", "id": 20314742, "node_id": "MDQ6VXNlcjIwMzE0NzQy", "avatar_url": "https://avatars.githubusercontent.com/u/20314742?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ritiek", "html_url": "https://github.com/ritiek", "followers_url": "https://api.github.com/users/ritiek/followers", "following_url": "https://api.github.com/users/ritiek/following{/other_user}", "gists_url": "https://api.github.com/users/ritiek/gists{/gist_id}", "starred_url": "https://api.github.com/users/ritiek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ritiek/subscriptions", "organizations_url": "https://api.github.com/users/ritiek/orgs", "repos_url": "https://api.github.com/users/ritiek/repos", "events_url": "https://api.github.com/users/ritiek/events{/privacy}", "received_events_url": "https://api.github.com/users/ritiek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ritiek", "id": 20314742, "node_id": "MDQ6VXNlcjIwMzE0NzQy", "avatar_url": "https://avatars.githubusercontent.com/u/20314742?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ritiek", "html_url": "https://github.com/ritiek", "followers_url": "https://api.github.com/users/ritiek/followers", "following_url": "https://api.github.com/users/ritiek/following{/other_user}", "gists_url": "https://api.github.com/users/ritiek/gists{/gist_id}", "starred_url": "https://api.github.com/users/ritiek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ritiek/subscriptions", "organizations_url": "https://api.github.com/users/ritiek/orgs", "repos_url": "https://api.github.com/users/ritiek/repos", "events_url": "https://api.github.com/users/ritiek/events{/privacy}", "received_events_url": "https://api.github.com/users/ritiek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45c2c9afa53fd5226b91f4571b63d9eb1e80af32", "url": "https://api.github.com/repos/rust-lang/rust/commits/45c2c9afa53fd5226b91f4571b63d9eb1e80af32", "html_url": "https://github.com/rust-lang/rust/commit/45c2c9afa53fd5226b91f4571b63d9eb1e80af32"}], "stats": {"total": 106, "additions": 101, "deletions": 5}, "files": [{"sha": "03b9c5918ac49bf337b1dc81cc0150adb1857d27", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 101, "deletions": 5, "changes": 106, "blob_url": "https://github.com/rust-lang/rust/blob/4054030542bf06671ba478cefbfb2aa33131e839/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4054030542bf06671ba478cefbfb2aa33131e839/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=4054030542bf06671ba478cefbfb2aa33131e839", "patch": "@@ -21,6 +21,7 @@ use header::TestProps;\n use util::logv;\n use regex::Regex;\n \n+use std::collections::VecDeque;\n use std::collections::HashMap;\n use std::collections::HashSet;\n use std::env;\n@@ -48,6 +49,88 @@ pub fn dylib_env_var() -> &'static str {\n     }\n }\n \n+#[derive(Debug, PartialEq)]\n+pub enum DiffLine {\n+    Context(String),\n+    Expected(String),\n+    Resulting(String),\n+}\n+\n+#[derive(Debug, PartialEq)]\n+pub struct Mismatch {\n+    pub line_number: u32,\n+    pub lines: Vec<DiffLine>,\n+}\n+\n+impl Mismatch {\n+    fn new(line_number: u32) -> Mismatch {\n+        Mismatch {\n+            line_number: line_number,\n+            lines: Vec::new(),\n+        }\n+    }\n+}\n+\n+// Produces a diff between the expected output and actual output.\n+pub fn make_diff(expected: &str, actual: &str, context_size: usize) -> Vec<Mismatch> {\n+    let mut line_number = 1;\n+    let mut context_queue: VecDeque<&str> = VecDeque::with_capacity(context_size);\n+    let mut lines_since_mismatch = context_size + 1;\n+    let mut results = Vec::new();\n+    let mut mismatch = Mismatch::new(0);\n+\n+    for result in diff::lines(actual, expected) {\n+        match result {\n+            diff::Result::Left(str) => {\n+                if lines_since_mismatch >= context_size && lines_since_mismatch > 0 {\n+                    results.push(mismatch);\n+                    mismatch = Mismatch::new(line_number - context_queue.len() as u32);\n+                }\n+\n+                while let Some(line) = context_queue.pop_front() {\n+                    mismatch.lines.push(DiffLine::Context(line.to_owned()));\n+                }\n+\n+                mismatch.lines.push(DiffLine::Resulting(str.to_owned()));\n+                lines_since_mismatch = 0;\n+            }\n+            diff::Result::Right(str) => {\n+                if lines_since_mismatch >= context_size && lines_since_mismatch > 0 {\n+                    results.push(mismatch);\n+                    mismatch = Mismatch::new(line_number - context_queue.len() as u32);\n+                }\n+\n+                while let Some(line) = context_queue.pop_front() {\n+                    mismatch.lines.push(DiffLine::Context(line.to_owned()));\n+                }\n+\n+                mismatch.lines.push(DiffLine::Expected(str.to_owned()));\n+                line_number += 1;\n+                lines_since_mismatch = 0;\n+            }\n+            diff::Result::Both(str, _) => {\n+                if context_queue.len() >= context_size {\n+                    let _ = context_queue.pop_front();\n+                }\n+\n+                if lines_since_mismatch < context_size {\n+                    mismatch.lines.push(DiffLine::Context(str.to_owned()));\n+                } else if context_size > 0 {\n+                    context_queue.push_back(str);\n+                }\n+\n+                line_number += 1;\n+                lines_since_mismatch += 1;\n+            }\n+        }\n+    }\n+\n+    results.push(mismatch);\n+    results.remove(0);\n+\n+    results\n+}\n+\n pub fn run(config: Config, testpaths: &TestPaths) {\n     match &*config.target {\n         \"arm-linux-androideabi\" | \"armv7-linux-androideabi\" | \"aarch64-linux-android\" => {\n@@ -2712,12 +2795,25 @@ impl<'test> TestCx<'test> {\n             println!(\"normalized {}:\\n{}\\n\", kind, actual);\n         } else {\n             println!(\"diff of {}:\\n\", kind);\n-            for diff in diff::lines(expected, actual) {\n-                match diff {\n-                    diff::Result::Left(l) => println!(\"-{}\", l),\n-                    diff::Result::Right(r) => println!(\"+{}\", r),\n-                    _ => {},\n+            let diff_results = make_diff(expected, actual, 3);\n+            for result in diff_results {\n+                let mut line_number = result.line_number;\n+                for line in result.lines {\n+                    match line {\n+                        DiffLine::Expected(e) => {\n+                            println!(\"-\\t{}\", e);\n+                            line_number += 1;\n+                        },\n+                        DiffLine::Context(c) => {\n+                            println!(\"{}\\t{}\", line_number, c);\n+                            line_number += 1;\n+                        },\n+                        DiffLine::Resulting(r) => {\n+                            println!(\"+\\t{}\", r);\n+                        },\n+                    }\n                 }\n+                println!(\"\");\n             }\n         }\n "}]}