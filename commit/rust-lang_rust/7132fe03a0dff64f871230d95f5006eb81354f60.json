{"sha": "7132fe03a0dff64f871230d95f5006eb81354f60", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcxMzJmZTAzYTBkZmY2NGY4NzEyMzBkOTVmNTAwNmViODEzNTRmNjA=", "commit": {"author": {"name": "St\u00e9phane Campinas", "email": "stephane.campinas@gmail.com", "date": "2018-11-04T09:51:38Z"}, "committer": {"name": "St\u00e9phane Campinas", "email": "stephane.campinas@gmail.com", "date": "2018-11-04T22:41:21Z"}, "message": "fix alignment of a struct's fields with the visual style\n\n- rewrite_with_alignment was called from the expr module with the wrong\n  shape that missed the extra offset needed for the visual style\n- rewrite_with_alignment was indenting the given shape although that\n  should have been the caller's responsability", "tree": {"sha": "2608d8827b27cca73e45afd45b4804c27a8a6b7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2608d8827b27cca73e45afd45b4804c27a8a6b7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7132fe03a0dff64f871230d95f5006eb81354f60", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCgAdFiEEipi5pnt+pUplKNfibVYg2QghATMFAlvfdZEACgkQbVYg2Qgh\nATNLvgf/Rbq06dgKGPjJDZrrtX3eHGCddlJBi7bdyLZQK6umbJDxIaxn8WfnDY4Q\nFo3sCbb08bi0IymTckxVl4lNXKmPC5dxjXEZqhLPTQscKb4SlRqXRxZF5S0A1hJr\n/B3yB80b9HGlhInDTpyYDWZZ+aTbBIJ62poGWxHbmZam3offtatzmN3RGznh/x7y\ntVNnoBeRASeD3msh+uBNnnrNmmu4R08IzNKXQtwvSmdaxAJFq134ITbJnBVZT8xF\nI3xzttKOAZFhPuGjsPgrYe2O/G7hsAF3f0iHRNqwhG/z9uzZzCsGMD0jK4xyyOWI\n8Cd/lP8zLcf3JLUc0SrCnextHlTF1Q==\n=qTYq\n-----END PGP SIGNATURE-----", "payload": "tree 2608d8827b27cca73e45afd45b4804c27a8a6b7e\nparent b8a133d432fc5af0eee5bb30d05b1e07875aea72\nauthor St\u00e9phane Campinas <stephane.campinas@gmail.com> 1541325098 +0100\ncommitter St\u00e9phane Campinas <stephane.campinas@gmail.com> 1541371281 +0100\n\nfix alignment of a struct's fields with the visual style\n\n- rewrite_with_alignment was called from the expr module with the wrong\n  shape that missed the extra offset needed for the visual style\n- rewrite_with_alignment was indenting the given shape although that\n  should have been the caller's responsability\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7132fe03a0dff64f871230d95f5006eb81354f60", "html_url": "https://github.com/rust-lang/rust/commit/7132fe03a0dff64f871230d95f5006eb81354f60", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7132fe03a0dff64f871230d95f5006eb81354f60/comments", "author": {"login": "scampi", "id": 795879, "node_id": "MDQ6VXNlcjc5NTg3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/795879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scampi", "html_url": "https://github.com/scampi", "followers_url": "https://api.github.com/users/scampi/followers", "following_url": "https://api.github.com/users/scampi/following{/other_user}", "gists_url": "https://api.github.com/users/scampi/gists{/gist_id}", "starred_url": "https://api.github.com/users/scampi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scampi/subscriptions", "organizations_url": "https://api.github.com/users/scampi/orgs", "repos_url": "https://api.github.com/users/scampi/repos", "events_url": "https://api.github.com/users/scampi/events{/privacy}", "received_events_url": "https://api.github.com/users/scampi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "scampi", "id": 795879, "node_id": "MDQ6VXNlcjc5NTg3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/795879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scampi", "html_url": "https://github.com/scampi", "followers_url": "https://api.github.com/users/scampi/followers", "following_url": "https://api.github.com/users/scampi/following{/other_user}", "gists_url": "https://api.github.com/users/scampi/gists{/gist_id}", "starred_url": "https://api.github.com/users/scampi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scampi/subscriptions", "organizations_url": "https://api.github.com/users/scampi/orgs", "repos_url": "https://api.github.com/users/scampi/repos", "events_url": "https://api.github.com/users/scampi/events{/privacy}", "received_events_url": "https://api.github.com/users/scampi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8a133d432fc5af0eee5bb30d05b1e07875aea72", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8a133d432fc5af0eee5bb30d05b1e07875aea72", "html_url": "https://github.com/rust-lang/rust/commit/b8a133d432fc5af0eee5bb30d05b1e07875aea72"}], "stats": {"total": 60, "additions": 46, "deletions": 14}, "files": [{"sha": "08b9ad3079c767358a9fc9888af4eb420146291b", "filename": "src/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -1565,7 +1565,7 @@ fn rewrite_struct_lit<'a>(\n         rewrite_with_alignment(\n             fields,\n             context,\n-            shape,\n+            v_shape,\n             mk_sp(body_lo, span.hi()),\n             one_line_width,\n         )?"}, {"sha": "7c6219a4e0489d75013e0250429e92a6e69ff903", "filename": "src/items.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -1265,7 +1265,7 @@ pub fn format_struct_struct(\n     let items_str = rewrite_with_alignment(\n         fields,\n         context,\n-        Shape::indented(offset, context.config).sub_width(1)?,\n+        Shape::indented(offset.block_indent(context.config), context.config).sub_width(1)?,\n         mk_sp(body_lo, span.hi()),\n         one_line_budget,\n     )?;"}, {"sha": "0364db763f9d69a38bba11dbf9ae0c1c9d3392d4", "filename": "src/vertical.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/src%2Fvertical.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/src%2Fvertical.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvertical.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -172,16 +172,13 @@ pub fn rewrite_with_alignment<T: AlignedItem>(\n     } else {\n         let rest_span = mk_sp(init_last_pos, span.hi());\n         let rest_str = rewrite_with_alignment(rest, context, shape, rest_span, one_line_width)?;\n-        Some(\n-            result\n-                + spaces\n-                + \"\\n\"\n-                + &shape\n-                    .indent\n-                    .block_indent(context.config)\n-                    .to_string(context.config)\n-                + &rest_str,\n-        )\n+        Some(format!(\n+            \"{}{}\\n{}{}\",\n+            result,\n+            spaces,\n+            &shape.indent.to_string(context.config),\n+            &rest_str\n+        ))\n     }\n }\n \n@@ -217,9 +214,8 @@ fn rewrite_aligned_items_inner<T: AlignedItem>(\n     offset: Indent,\n     one_line_width: usize,\n ) -> Option<String> {\n-    let item_indent = offset.block_indent(context.config);\n     // 1 = \",\"\n-    let item_shape = Shape::indented(item_indent, context.config).sub_width(1)?;\n+    let item_shape = Shape::indented(offset, context.config).sub_width(1)?;\n     let (mut field_prefix_max_width, field_prefix_min_width) =\n         struct_field_prefix_max_min_width(context, fields, item_shape);\n     let max_diff = field_prefix_max_width.saturating_sub(field_prefix_min_width);"}, {"sha": "77fb2919edbd133b5b3b04ef8ad78329fa04a320", "filename": "tests/source/alignment_2633/block_style.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Fsource%2Falignment_2633%2Fblock_style.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Fsource%2Falignment_2633%2Fblock_style.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Falignment_2633%2Fblock_style.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -0,0 +1,8 @@\n+// rustfmt-struct_field_align_threshold: 50\n+\n+fn func() {\n+    Ok(ServerInformation { name:         unwrap_message_string(items.get(0)),\n+           vendor: unwrap_message_string(items.get(1)),\n+           version: unwrap_message_string(items.get(2)),\n+           spec_version: unwrap_message_string(items.get(3)), });\n+}"}, {"sha": "f34cc621e64c0f372245b5e06a1e5c3448886c38", "filename": "tests/source/alignment_2633/visual_style.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Fsource%2Falignment_2633%2Fvisual_style.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Fsource%2Falignment_2633%2Fvisual_style.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Falignment_2633%2Fvisual_style.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -0,0 +1,9 @@\n+// rustfmt-struct_field_align_threshold: 50\n+// rustfmt-indent_style: Visual\n+\n+fn func() {\n+    Ok(ServerInformation { name:         unwrap_message_string(items.get(0)),\n+           vendor: unwrap_message_string(items.get(1)),\n+           version: unwrap_message_string(items.get(2)),\n+           spec_version: unwrap_message_string(items.get(3)), });\n+}"}, {"sha": "f13e8a8760e7d6649e8e48295e54d29737529fab", "filename": "tests/target/alignment_2633/block_style.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Ftarget%2Falignment_2633%2Fblock_style.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Ftarget%2Falignment_2633%2Fblock_style.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Falignment_2633%2Fblock_style.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -0,0 +1,10 @@\n+// rustfmt-struct_field_align_threshold: 50\n+\n+fn func() {\n+    Ok(ServerInformation {\n+        name:         unwrap_message_string(items.get(0)),\n+        vendor:       unwrap_message_string(items.get(1)),\n+        version:      unwrap_message_string(items.get(2)),\n+        spec_version: unwrap_message_string(items.get(3)),\n+    });\n+}"}, {"sha": "a381945fd8b8fd5fd8aef4b45e67250e2709d881", "filename": "tests/target/alignment_2633/horizontal_tactic.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Ftarget%2Falignment_2633%2Fhorizontal_tactic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Ftarget%2Falignment_2633%2Fhorizontal_tactic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Falignment_2633%2Fhorizontal_tactic.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "previous_filename": "tests/target/issue-2633.rs"}, {"sha": "7d21b599af4d4e265af8decec77f0853ea9ccdb7", "filename": "tests/target/alignment_2633/visual_style.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Ftarget%2Falignment_2633%2Fvisual_style.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7132fe03a0dff64f871230d95f5006eb81354f60/tests%2Ftarget%2Falignment_2633%2Fvisual_style.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Falignment_2633%2Fvisual_style.rs?ref=7132fe03a0dff64f871230d95f5006eb81354f60", "patch": "@@ -0,0 +1,9 @@\n+// rustfmt-struct_field_align_threshold: 50\n+// rustfmt-indent_style: Visual\n+\n+fn func() {\n+    Ok(ServerInformation { name:         unwrap_message_string(items.get(0)),\n+                           vendor:       unwrap_message_string(items.get(1)),\n+                           version:      unwrap_message_string(items.get(2)),\n+                           spec_version: unwrap_message_string(items.get(3)), });\n+}"}]}