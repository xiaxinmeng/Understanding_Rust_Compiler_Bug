{"sha": "92ced4a12e60811b67ed98c79c77c151581b7e07", "node_id": "C_kwDOAAsO6NoAKDkyY2VkNGExMmU2MDgxMWI2N2VkOThjNzljNzdjMTUxNTgxYjdlMDc", "commit": {"author": {"name": "Ezra Shaw", "email": "ezrasure@outlook.com", "date": "2023-01-15T02:51:52Z"}, "committer": {"name": "Ezra Shaw", "email": "ezrasure@outlook.com", "date": "2023-01-15T09:17:54Z"}, "message": "suggest `is_empty` for collections when casting to `bool`", "tree": {"sha": "be8e660da97735558301d751c47b109ffce24b58", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be8e660da97735558301d751c47b109ffce24b58"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/92ced4a12e60811b67ed98c79c77c151581b7e07", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJJBAABCAAzFiEEYSWD6p+RIeSP1N2eF81cKtrg00QFAmPDxMIVHGV6cmFzdXJl\nQG91dGxvb2suY29tAAoJEBfNXCra4NNEglcP/jjnEL8VIG4DjS7O73oredJryhL4\nldLjSF4pQLhqyOCW2j39TRzWsu2r85MI3z09Y4BuaaCB3rB6CdkRrZeIyb0dBtL4\n0omNVLOyaMQLKOJp/CVHU/D4WgFHpVqsvAitlZtAcSNEFUsqebU/41NLpl++rPPx\nPkonylDRRJ/owgeTowvWdqu+C1tKED0LL70ns4k2sBEoljerRM1+4kXc19UcjUxE\n/3VTkSpZpFIjcnCFWbpzOAIqtCMBwHcEieO2Ue+CV5hK50WzGP9AAAev+N73/gWM\ndWHznhMlr+UlVs9AVSK5xQfBdHWs6zuYWyw2rV+EAex2/Z4Qlfl9XP5fIlUSKLE3\nOV/RVJ1AHaBuG59GnZCDvV3/Y3zyUNjSI+9vV5lVJ158uVkqRl58aWhrjNBx/G7f\nWDMdGJNUbTXIPFGhOPTRhnb3L1yo1vlApXrjQrqLnBUzPZkgXu0DjuA5dIdq2B1/\nEQDNUgzDfWlAxnoBSar0nJrrBsPQ65JQhxu9KJtape16O207zjJnrsC4Isi4Hy4+\nGTXoGbJ+IIEYKyjY+vXc3fGrsNOoghD4Ifu3JIHnfPLHNi0AhxZ61H+3MfKrrIVI\nkrmNDDOpXGQN2X593j6Fn3IcWlT/Ecy1RUh/eyDODHBrbVSizjO4EvWtxiLFb2QJ\nkDDEBXPP6E1ss5eu\n=hIMK\n-----END PGP SIGNATURE-----", "payload": "tree be8e660da97735558301d751c47b109ffce24b58\nparent b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e\nauthor Ezra Shaw <ezrasure@outlook.com> 1673751112 +1300\ncommitter Ezra Shaw <ezrasure@outlook.com> 1673774274 +1300\n\nsuggest `is_empty` for collections when casting to `bool`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/92ced4a12e60811b67ed98c79c77c151581b7e07", "html_url": "https://github.com/rust-lang/rust/commit/92ced4a12e60811b67ed98c79c77c151581b7e07", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/92ced4a12e60811b67ed98c79c77c151581b7e07/comments", "author": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Ezrashaw", "id": 38062690, "node_id": "MDQ6VXNlcjM4MDYyNjkw", "avatar_url": "https://avatars.githubusercontent.com/u/38062690?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ezrashaw", "html_url": "https://github.com/Ezrashaw", "followers_url": "https://api.github.com/users/Ezrashaw/followers", "following_url": "https://api.github.com/users/Ezrashaw/following{/other_user}", "gists_url": "https://api.github.com/users/Ezrashaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ezrashaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ezrashaw/subscriptions", "organizations_url": "https://api.github.com/users/Ezrashaw/orgs", "repos_url": "https://api.github.com/users/Ezrashaw/repos", "events_url": "https://api.github.com/users/Ezrashaw/events{/privacy}", "received_events_url": "https://api.github.com/users/Ezrashaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e", "html_url": "https://github.com/rust-lang/rust/commit/b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e"}], "stats": {"total": 146, "additions": 142, "deletions": 4}, "files": [{"sha": "0a230fca107affea99ad03c0bd31a8316e59908c", "filename": "compiler/rustc_hir_typeck/src/cast.rs", "status": "modified", "additions": 45, "deletions": 1, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/92ced4a12e60811b67ed98c79c77c151581b7e07/compiler%2Frustc_hir_typeck%2Fsrc%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ced4a12e60811b67ed98c79c77c151581b7e07/compiler%2Frustc_hir_typeck%2Fsrc%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fcast.rs?ref=92ced4a12e60811b67ed98c79c77c151581b7e07", "patch": "@@ -31,7 +31,9 @@\n use super::FnCtxt;\n \n use crate::type_error_struct;\n-use rustc_errors::{struct_span_err, Applicability, DelayDm, DiagnosticBuilder, ErrorGuaranteed};\n+use rustc_errors::{\n+    struct_span_err, Applicability, DelayDm, Diagnostic, DiagnosticBuilder, ErrorGuaranteed,\n+};\n use rustc_hir as hir;\n use rustc_macros::{TypeFoldable, TypeVisitable};\n use rustc_middle::mir::Mutability;\n@@ -270,6 +272,9 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                         }\n                     ));\n                 }\n+\n+                self.try_suggest_collection_to_bool(fcx, &mut err);\n+\n                 err.emit();\n             }\n             CastError::NeedViaInt => {\n@@ -517,6 +522,9 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                 } else {\n                     err.span_label(self.span, \"invalid cast\");\n                 }\n+\n+                self.try_suggest_collection_to_bool(fcx, &mut err);\n+\n                 err.emit();\n             }\n             CastError::SizedUnsizedCast => {\n@@ -1080,4 +1088,40 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n             },\n         );\n     }\n+\n+    /// Attempt to suggest using `.is_empty` when trying to cast from a\n+    /// collection type to a boolean.\n+    fn try_suggest_collection_to_bool(&self, fcx: &FnCtxt<'a, 'tcx>, err: &mut Diagnostic) {\n+        if self.cast_ty.is_bool() {\n+            let derefed = fcx\n+                .autoderef(self.expr_span, self.expr_ty)\n+                .silence_errors()\n+                .find(|t| matches!(t.0.kind(), ty::Str | ty::Slice(..)));\n+\n+            if let Some((deref_ty, _)) = derefed {\n+                // Give a note about what the expr derefs to.\n+                if deref_ty != self.expr_ty.peel_refs() {\n+                    err.span_note(\n+                        self.expr_span,\n+                        format!(\n+                            \"this expression `Deref`s to `{}` which implements `is_empty`\",\n+                            fcx.ty_to_string(deref_ty)\n+                        ),\n+                    );\n+                }\n+\n+                // Create a multipart suggestion: add `!` and `.is_empty()` in\n+                // place of the cast.\n+                let suggestion = vec![\n+                    (self.expr_span.shrink_to_lo(), \"!\".to_string()),\n+                    (self.span.with_lo(self.expr_span.hi()), \".is_empty()\".to_string()),\n+                ];\n+\n+                err.multipart_suggestion_verbose(format!(\n+                    \"consider using the `is_empty` method on `{}` to determine if it contains anything\",\n+                    fcx.ty_to_string(self.expr_ty),\n+                ),  suggestion, Applicability::MaybeIncorrect);\n+            }\n+        }\n+    }\n }"}, {"sha": "fbebc80d91ced614a38fe76cf3acc64cf3313e9f", "filename": "tests/ui/cast/cast-as-bool.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fcast-as-bool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fcast-as-bool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcast%2Fcast-as-bool.rs?ref=92ced4a12e60811b67ed98c79c77c151581b7e07", "patch": "@@ -2,8 +2,12 @@ fn main() {\n     let u = 5 as bool; //~ ERROR cannot cast as `bool`\n                        //~| HELP compare with zero instead\n                        //~| SUGGESTION 5 != 0\n+\n     let t = (1 + 2) as bool; //~ ERROR cannot cast as `bool`\n                              //~| HELP compare with zero instead\n                              //~| SUGGESTION (1 + 2) != 0\n-    let v = \"hello\" as bool; //~ ERROR casting `&'static str` as `bool` is invalid\n+\n+    let v = \"hello\" as bool;\n+    //~^ ERROR casting `&'static str` as `bool` is invalid\n+    //~| HELP consider using the `is_empty` method on `&'static str` to determine if it contains anything\n }"}, {"sha": "19ac8f10fec216abdaf92214f69d3086aeb1791b", "filename": "tests/ui/cast/cast-as-bool.stderr", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fcast-as-bool.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fcast-as-bool.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcast%2Fcast-as-bool.stderr?ref=92ced4a12e60811b67ed98c79c77c151581b7e07", "patch": "@@ -5,16 +5,21 @@ LL |     let u = 5 as bool;\n    |             ^^^^^^^^^ help: compare with zero instead: `5 != 0`\n \n error[E0054]: cannot cast as `bool`\n-  --> $DIR/cast-as-bool.rs:5:13\n+  --> $DIR/cast-as-bool.rs:6:13\n    |\n LL |     let t = (1 + 2) as bool;\n    |             ^^^^^^^^^^^^^^^ help: compare with zero instead: `(1 + 2) != 0`\n \n error[E0606]: casting `&'static str` as `bool` is invalid\n-  --> $DIR/cast-as-bool.rs:8:13\n+  --> $DIR/cast-as-bool.rs:10:13\n    |\n LL |     let v = \"hello\" as bool;\n    |             ^^^^^^^^^^^^^^^\n+   |\n+help: consider using the `is_empty` method on `&'static str` to determine if it contains anything\n+   |\n+LL |     let v = !\"hello\".is_empty();\n+   |             +       ~~~~~~~~~~~\n \n error: aborting due to 3 previous errors\n "}, {"sha": "27e0816dd1c6a62336d4f2475b5acfc3a76226f2", "filename": "tests/ui/cast/issue-106883-is-empty.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fissue-106883-is-empty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fissue-106883-is-empty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcast%2Fissue-106883-is-empty.rs?ref=92ced4a12e60811b67ed98c79c77c151581b7e07", "patch": "@@ -0,0 +1,27 @@\n+use std::ops::Deref;\n+\n+struct Foo;\n+\n+impl Deref for Foo {\n+    type Target = [u8];\n+\n+    fn deref(&self) -> &Self::Target {\n+        &[]\n+    }\n+}\n+\n+fn main() {\n+    let _ = \"foo\" as bool;\n+    //~^ ERROR casting `&'static str` as `bool` is invalid [E0606]\n+\n+    let _ = String::from(\"foo\") as bool;\n+    //~^ ERROR non-primitive cast: `String` as `bool` [E0605]\n+\n+    let _ = Foo as bool;\n+    //~^ ERROR non-primitive cast: `Foo` as `bool` [E0605]\n+}\n+\n+fn _slice(bar: &[i32]) -> bool {\n+    bar as bool\n+    //~^ ERROR casting `&[i32]` as `bool` is invalid [E0606]\n+}"}, {"sha": "7115c7704ca29dfd4af9160e2a748e6981767857", "filename": "tests/ui/cast/issue-106883-is-empty.stderr", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fissue-106883-is-empty.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/92ced4a12e60811b67ed98c79c77c151581b7e07/tests%2Fui%2Fcast%2Fissue-106883-is-empty.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcast%2Fissue-106883-is-empty.stderr?ref=92ced4a12e60811b67ed98c79c77c151581b7e07", "patch": "@@ -0,0 +1,58 @@\n+error[E0606]: casting `&'static str` as `bool` is invalid\n+  --> $DIR/issue-106883-is-empty.rs:14:13\n+   |\n+LL |     let _ = \"foo\" as bool;\n+   |             ^^^^^^^^^^^^^\n+   |\n+help: consider using the `is_empty` method on `&'static str` to determine if it contains anything\n+   |\n+LL |     let _ = !\"foo\".is_empty();\n+   |             +     ~~~~~~~~~~~\n+\n+error[E0605]: non-primitive cast: `String` as `bool`\n+  --> $DIR/issue-106883-is-empty.rs:17:13\n+   |\n+LL |     let _ = String::from(\"foo\") as bool;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^ an `as` expression can only be used to convert between primitive types or to coerce to a specific trait object\n+   |\n+note: this expression `Deref`s to `str` which implements `is_empty`\n+  --> $DIR/issue-106883-is-empty.rs:17:13\n+   |\n+LL |     let _ = String::from(\"foo\") as bool;\n+   |             ^^^^^^^^^^^^^^^^^^^\n+help: consider using the `is_empty` method on `String` to determine if it contains anything\n+   |\n+LL |     let _ = !String::from(\"foo\").is_empty();\n+   |             +                   ~~~~~~~~~~~\n+\n+error[E0605]: non-primitive cast: `Foo` as `bool`\n+  --> $DIR/issue-106883-is-empty.rs:20:13\n+   |\n+LL |     let _ = Foo as bool;\n+   |             ^^^^^^^^^^^ an `as` expression can only be used to convert between primitive types or to coerce to a specific trait object\n+   |\n+note: this expression `Deref`s to `[u8]` which implements `is_empty`\n+  --> $DIR/issue-106883-is-empty.rs:20:13\n+   |\n+LL |     let _ = Foo as bool;\n+   |             ^^^\n+help: consider using the `is_empty` method on `Foo` to determine if it contains anything\n+   |\n+LL |     let _ = !Foo.is_empty();\n+   |             +   ~~~~~~~~~~~\n+\n+error[E0606]: casting `&[i32]` as `bool` is invalid\n+  --> $DIR/issue-106883-is-empty.rs:25:5\n+   |\n+LL |     bar as bool\n+   |     ^^^^^^^^^^^\n+   |\n+help: consider using the `is_empty` method on `&[i32]` to determine if it contains anything\n+   |\n+LL |     !bar.is_empty()\n+   |     +   ~~~~~~~~~~~\n+\n+error: aborting due to 4 previous errors\n+\n+Some errors have detailed explanations: E0605, E0606.\n+For more information about an error, try `rustc --explain E0605`."}]}