{"sha": "458aaba08467dc6b8d04b79f955a46be779d94f1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ1OGFhYmEwODQ2N2RjNmI4ZDA0Yjc5Zjk1NWE0NmJlNzc5ZDk0ZjE=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-07-19T18:57:04Z"}, "committer": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-09-13T12:08:52Z"}, "message": "Add Atomic*::from_mut.\n\nThe atomic equivalent of Cell::from_mut.", "tree": {"sha": "24aefd3e16f6a242c750e3527caac317c6d74d63", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24aefd3e16f6a242c750e3527caac317c6d74d63"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/458aaba08467dc6b8d04b79f955a46be779d94f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/458aaba08467dc6b8d04b79f955a46be779d94f1", "html_url": "https://github.com/rust-lang/rust/commit/458aaba08467dc6b8d04b79f955a46be779d94f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/458aaba08467dc6b8d04b79f955a46be779d94f1/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d6cbd21b2c5819c7fa42eb5a3713667b67e4f03", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d6cbd21b2c5819c7fa42eb5a3713667b67e4f03", "html_url": "https://github.com/rust-lang/rust/commit/2d6cbd21b2c5819c7fa42eb5a3713667b67e4f03"}], "stats": {"total": 98, "additions": 97, "deletions": 1}, "files": [{"sha": "cdd9b3ae90bbd6cc9d7d735499a09b55d9438ac0", "filename": "library/core/src/sync/atomic.rs", "status": "modified", "additions": 97, "deletions": 1, "changes": 98, "blob_url": "https://github.com/rust-lang/rust/blob/458aaba08467dc6b8d04b79f955a46be779d94f1/library%2Fcore%2Fsrc%2Fsync%2Fatomic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/458aaba08467dc6b8d04b79f955a46be779d94f1/library%2Fcore%2Fsrc%2Fsync%2Fatomic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fsync%2Fatomic.rs?ref=458aaba08467dc6b8d04b79f955a46be779d94f1", "patch": "@@ -110,6 +110,7 @@ use self::Ordering::*;\n use crate::cell::UnsafeCell;\n use crate::fmt;\n use crate::intrinsics;\n+use crate::mem::align_of;\n \n use crate::hint::spin_loop;\n \n@@ -327,6 +328,27 @@ impl AtomicBool {\n         unsafe { &mut *(self.v.get() as *mut bool) }\n     }\n \n+    /// Get atomic access to a `&mut bool`.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// #![feature(atomic_from_mut)]\n+    /// use std::sync::atomic::{AtomicBool, Ordering};\n+    ///\n+    /// let mut some_bool = true;\n+    /// let a = AtomicBool::from_mut(&mut some_bool);\n+    /// a.store(false, Ordering::Relaxed);\n+    /// assert_eq!(some_bool, false);\n+    /// ```\n+    #[inline]\n+    #[unstable(feature = \"atomic_from_mut\", issue = \"76314\")]\n+    pub fn from_mut(v: &mut bool) -> &Self {\n+        // SAFETY: the mutable reference guarantees unique ownership, and\n+        // alignment of both `bool` and `Self` is 1.\n+        unsafe { &*(v as *mut bool as *mut Self) }\n+    }\n+\n     /// Consumes the atomic and returns the contained value.\n     ///\n     /// This is safe because passing `self` by value guarantees that no other threads are\n@@ -820,6 +842,30 @@ impl<T> AtomicPtr<T> {\n         unsafe { &mut *self.p.get() }\n     }\n \n+    /// Get atomic access to a pointer.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// #![feature(atomic_from_mut)]\n+    /// use std::sync::atomic::{AtomicPtr, Ordering};\n+    ///\n+    /// let mut some_ptr = &mut 123 as *mut i32;\n+    /// let a = AtomicPtr::from_mut(&mut some_ptr);\n+    /// a.store(&mut 456, Ordering::Relaxed);\n+    /// assert_eq!(unsafe { *some_ptr }, 456);\n+    /// ```\n+    #[inline]\n+    #[unstable(feature = \"atomic_from_mut\", issue = \"76314\")]\n+    pub fn from_mut(v: &mut *mut T) -> &Self {\n+        let [] = [(); align_of::<Self>() - align_of::<*mut T>()];\n+        // SAFETY:\n+        //  - the mutable reference guarantees unique ownership.\n+        //  - the alignment of `*mut T` and `Self` is the same on all platforms\n+        //    supported by rust, as verified above.\n+        unsafe { &*(v as *mut *mut T as *mut Self) }\n+    }\n+\n     /// Consumes the atomic and returns the contained value.\n     ///\n     /// This is safe because passing `self` by value guarantees that no other threads are\n@@ -1104,6 +1150,12 @@ impl<T> From<*mut T> for AtomicPtr<T> {\n     }\n }\n \n+macro_rules! if_not_8_bit {\n+    (u8, $($tt:tt)*) => { \"\" };\n+    (i8, $($tt:tt)*) => { \"\" };\n+    ($_:ident, $($tt:tt)*) => { $($tt)* };\n+}\n+\n #[cfg(target_has_atomic_load_store = \"8\")]\n macro_rules! atomic_int {\n     ($cfg_cas:meta,\n@@ -1115,7 +1167,8 @@ macro_rules! atomic_int {\n      $stable_nand:meta,\n      $const_stable:meta,\n      $stable_init_const:meta,\n-     $s_int_type:expr, $int_ref:expr,\n+     $(from_mut: cfg($from_mut_cfg:meta),)?\n+     $s_int_type:literal, $int_ref:expr,\n      $extra_feature:expr,\n      $min_fn:ident, $max_fn:ident,\n      $align:expr,\n@@ -1226,6 +1279,45 @@ assert_eq!(some_var.load(Ordering::SeqCst), 5);\n                 }\n             }\n \n+            doc_comment! {\n+                concat!(\"Get atomic access to a `&mut \", stringify!($int_type), \"`.\n+\n+\",\n+if_not_8_bit! {\n+    $int_type,\n+    concat!(\n+        \"**Note:** This function is only available on targets where `\",\n+        stringify!($int_type), \"` has an alignment of \", $align, \" bytes.\"\n+    )\n+},\n+\"\n+\n+# Examples\n+\n+```\n+#![feature(atomic_from_mut)]\n+\", $extra_feature, \"use std::sync::atomic::{\", stringify!($atomic_type), \", Ordering};\n+\n+let mut some_int = 123;\n+let a = \", stringify!($atomic_type), \"::from_mut(&mut some_int);\n+a.store(100, Ordering::Relaxed);\n+assert_eq!(some_int, 100);\n+```\n+                \"),\n+                #[inline]\n+                $(#[cfg($from_mut_cfg)])?\n+                #[unstable(feature = \"atomic_from_mut\", issue = \"76314\")]\n+                pub fn from_mut(v: &mut $int_type) -> &Self {\n+                    let [] = [(); align_of::<Self>() - align_of::<$int_type>()];\n+                    // SAFETY:\n+                    //  - the mutable reference guarantees unique ownership.\n+                    //  - the alignment of `$int_type` and `Self` is the\n+                    //    same on all platforms enabled by `$from_mut_cfg`\n+                    //    as verified above.\n+                    unsafe { &*(v as *mut $int_type as *mut Self) }\n+                }\n+            }\n+\n             doc_comment! {\n                 concat!(\"Consumes the atomic and returns the contained value.\n \n@@ -1984,6 +2076,7 @@ atomic_int! {\n     stable(feature = \"integer_atomics_stable\", since = \"1.34.0\"),\n     rustc_const_stable(feature = \"const_integer_atomics\", since = \"1.34.0\"),\n     unstable(feature = \"integer_atomics\", issue = \"32976\"),\n+    from_mut: cfg(not(target_arch = \"x86\")),\n     \"i64\", \"../../../std/primitive.i64.html\",\n     \"\",\n     atomic_min, atomic_max,\n@@ -2002,6 +2095,7 @@ atomic_int! {\n     stable(feature = \"integer_atomics_stable\", since = \"1.34.0\"),\n     rustc_const_stable(feature = \"const_integer_atomics\", since = \"1.34.0\"),\n     unstable(feature = \"integer_atomics\", issue = \"32976\"),\n+    from_mut: cfg(not(target_arch = \"x86\")),\n     \"u64\", \"../../../std/primitive.u64.html\",\n     \"\",\n     atomic_umin, atomic_umax,\n@@ -2020,6 +2114,7 @@ atomic_int! {\n     unstable(feature = \"integer_atomics\", issue = \"32976\"),\n     rustc_const_stable(feature = \"const_integer_atomics\", since = \"1.34.0\"),\n     unstable(feature = \"integer_atomics\", issue = \"32976\"),\n+    from_mut: cfg(not(target_arch = \"x86_64\")),\n     \"i128\", \"../../../std/primitive.i128.html\",\n     \"#![feature(integer_atomics)]\\n\\n\",\n     atomic_min, atomic_max,\n@@ -2038,6 +2133,7 @@ atomic_int! {\n     unstable(feature = \"integer_atomics\", issue = \"32976\"),\n     rustc_const_stable(feature = \"const_integer_atomics\", since = \"1.34.0\"),\n     unstable(feature = \"integer_atomics\", issue = \"32976\"),\n+    from_mut: cfg(not(target_arch = \"x86_64\")),\n     \"u128\", \"../../../std/primitive.u128.html\",\n     \"#![feature(integer_atomics)]\\n\\n\",\n     atomic_umin, atomic_umax,"}]}