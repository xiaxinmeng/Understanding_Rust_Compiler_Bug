{"sha": "79f583ed6622be591886f99974766a3aeda39182", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc5ZjU4M2VkNjYyMmJlNTkxODg2Zjk5OTc0NzY2YTNhZWRhMzkxODI=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-03-23T19:47:08Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-03-23T19:51:06Z"}, "message": "Improve message usage in proc-macro\n\nReuse storage for the buffer send to child process of proc-macro.", "tree": {"sha": "a332596cd744a1d50b474b5a82d66af171048707", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a332596cd744a1d50b474b5a82d66af171048707"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/79f583ed6622be591886f99974766a3aeda39182", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/79f583ed6622be591886f99974766a3aeda39182", "html_url": "https://github.com/rust-lang/rust/commit/79f583ed6622be591886f99974766a3aeda39182", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/79f583ed6622be591886f99974766a3aeda39182/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f41ae64722ab8e501e2123018d1b0101db32442e", "url": "https://api.github.com/repos/rust-lang/rust/commits/f41ae64722ab8e501e2123018d1b0101db32442e", "html_url": "https://github.com/rust-lang/rust/commit/f41ae64722ab8e501e2123018d1b0101db32442e"}], "stats": {"total": 26, "additions": 17, "deletions": 9}, "files": [{"sha": "f525df1525d5fd5740170698494f0f3d9d778cf8", "filename": "crates/proc_macro_api/src/msg.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/79f583ed6622be591886f99974766a3aeda39182/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79f583ed6622be591886f99974766a3aeda39182/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs?ref=79f583ed6622be591886f99974766a3aeda39182", "patch": "@@ -55,8 +55,8 @@ pub enum ErrorCode {\n }\n \n pub trait Message: Serialize + DeserializeOwned {\n-    fn read(inp: &mut impl BufRead) -> io::Result<Option<Self>> {\n-        Ok(match read_json(inp)? {\n+    fn read(inp: &mut impl BufRead, buf: &mut String) -> io::Result<Option<Self>> {\n+        Ok(match read_json(inp, buf)? {\n             None => None,\n             Some(text) => {\n                 let mut deserializer = serde_json::Deserializer::from_str(&text);\n@@ -76,9 +76,13 @@ pub trait Message: Serialize + DeserializeOwned {\n impl Message for Request {}\n impl Message for Response {}\n \n-fn read_json(inp: &mut impl BufRead) -> io::Result<Option<String>> {\n+fn read_json<'a>(\n+    inp: &mut impl BufRead,\n+    mut buf: &'a mut String,\n+) -> io::Result<Option<&'a String>> {\n     loop {\n-        let mut buf = String::new();\n+        buf.clear();\n+\n         inp.read_line(&mut buf)?;\n         buf.pop(); // Remove trailing '\\n'\n "}, {"sha": "99d05aef37649da7285c36d45c9d94abfa9b11a2", "filename": "crates/proc_macro_api/src/process.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/79f583ed6622be591886f99974766a3aeda39182/crates%2Fproc_macro_api%2Fsrc%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79f583ed6622be591886f99974766a3aeda39182/crates%2Fproc_macro_api%2Fsrc%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Fprocess.rs?ref=79f583ed6622be591886f99974766a3aeda39182", "patch": "@@ -90,8 +90,10 @@ impl ProcMacroProcessSrv {\n fn client_loop(task_rx: Receiver<Task>, mut process: Process) {\n     let (mut stdin, mut stdout) = process.stdio().expect(\"couldn't access child stdio\");\n \n+    let mut buf = String::new();\n+\n     for Task { req, result_tx } in task_rx {\n-        match send_request(&mut stdin, &mut stdout, req) {\n+        match send_request(&mut stdin, &mut stdout, req, &mut buf) {\n             Ok(res) => result_tx.send(res).unwrap(),\n             Err(err) => {\n                 log::error!(\n@@ -152,7 +154,8 @@ fn send_request(\n     mut writer: &mut impl Write,\n     mut reader: &mut impl BufRead,\n     req: Request,\n+    buf: &mut String,\n ) -> io::Result<Option<Response>> {\n     req.write(&mut writer)?;\n-    Response::read(&mut reader)\n+    Response::read(&mut reader, buf)\n }"}, {"sha": "bc48f1c436cf56030bed80438375faf1b0ec8713", "filename": "crates/proc_macro_srv/src/cli.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/79f583ed6622be591886f99974766a3aeda39182/crates%2Fproc_macro_srv%2Fsrc%2Fcli.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79f583ed6622be591886f99974766a3aeda39182/crates%2Fproc_macro_srv%2Fsrc%2Fcli.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fcli.rs?ref=79f583ed6622be591886f99974766a3aeda39182", "patch": "@@ -6,8 +6,9 @@ use std::io;\n \n pub fn run() -> io::Result<()> {\n     let mut srv = ProcMacroSrv::default();\n+    let mut buf = String::new();\n \n-    while let Some(req) = read_request()? {\n+    while let Some(req) = read_request(&mut buf)? {\n         let res = match req {\n             msg::Request::ListMacro(task) => srv.list_macros(&task).map(msg::Response::ListMacro),\n             msg::Request::ExpansionMacro(task) => {\n@@ -30,8 +31,8 @@ pub fn run() -> io::Result<()> {\n     Ok(())\n }\n \n-fn read_request() -> io::Result<Option<msg::Request>> {\n-    msg::Request::read(&mut io::stdin().lock())\n+fn read_request(buf: &mut String) -> io::Result<Option<msg::Request>> {\n+    msg::Request::read(&mut io::stdin().lock(), buf)\n }\n \n fn write_response(msg: msg::Response) -> io::Result<()> {"}]}