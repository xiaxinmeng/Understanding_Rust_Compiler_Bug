{"sha": "335427a3db8fcdbddece8c7257e0ab40c8230d73", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMzNTQyN2EzZGI4ZmNkYmRkZWNlOGM3MjU3ZTBhYjQwYzgyMzBkNzM=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-03-16T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-03-16T00:00:00Z"}, "message": "Use delay_span_bug instead of panic in layout_scalar_valid_range\n\n83054 introduced validation of scalar range attributes, but panicking\ncode that uses the attribute remained reachable. Use `delay_span_bug`\ninstead to avoid the ICE.", "tree": {"sha": "3879fea499794bcc077f04ad97e5ea150795f7bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3879fea499794bcc077f04ad97e5ea150795f7bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/335427a3db8fcdbddece8c7257e0ab40c8230d73", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/335427a3db8fcdbddece8c7257e0ab40c8230d73", "html_url": "https://github.com/rust-lang/rust/commit/335427a3db8fcdbddece8c7257e0ab40c8230d73", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/335427a3db8fcdbddece8c7257e0ab40c8230d73/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "195ad4830e11a544391abe296b146450dea8411b", "url": "https://api.github.com/repos/rust-lang/rust/commits/195ad4830e11a544391abe296b146450dea8411b", "html_url": "https://github.com/rust-lang/rust/commit/195ad4830e11a544391abe296b146450dea8411b"}], "stats": {"total": 30, "additions": 23, "deletions": 7}, "files": [{"sha": "d5ad459126070d158bfe47fe053ccd76754dda1d", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/335427a3db8fcdbddece8c7257e0ab40c8230d73/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/335427a3db8fcdbddece8c7257e0ab40c8230d73/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=335427a3db8fcdbddece8c7257e0ab40c8230d73", "patch": "@@ -1091,13 +1091,16 @@ impl<'tcx> TyCtxt<'tcx> {\n                 None => return Bound::Unbounded,\n             };\n             debug!(\"layout_scalar_valid_range: attr={:?}\", attr);\n-            for meta in attr.meta_item_list().expect(\"rustc_layout_scalar_valid_range takes args\") {\n-                match meta.literal().expect(\"attribute takes lit\").kind {\n-                    ast::LitKind::Int(a, _) => return Bound::Included(a),\n-                    _ => span_bug!(attr.span, \"rustc_layout_scalar_valid_range expects int arg\"),\n-                }\n+            if let Some(\n+                &[ast::NestedMetaItem::Literal(ast::Lit { kind: ast::LitKind::Int(a, _), .. })],\n+            ) = attr.meta_item_list().as_deref()\n+            {\n+                Bound::Included(a)\n+            } else {\n+                self.sess\n+                    .delay_span_bug(attr.span, \"invalid rustc_layout_scalar_valid_range attribute\");\n+                Bound::Unbounded\n             }\n-            span_bug!(attr.span, \"no arguments to `rustc_layout_scalar_valid_range` attribute\");\n         };\n         (\n             get(sym::rustc_layout_scalar_valid_range_start),"}, {"sha": "06cf8c0f0f6d51d4ca63ef5b13e90deca07d31ad", "filename": "src/test/ui/invalid/invalid_rustc_layout_scalar_valid_range.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/335427a3db8fcdbddece8c7257e0ab40c8230d73/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs", "raw_url": "https://github.com/rust-lang/rust/raw/335427a3db8fcdbddece8c7257e0ab40c8230d73/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs?ref=335427a3db8fcdbddece8c7257e0ab40c8230d73", "patch": "@@ -15,6 +15,13 @@ enum E {\n     Y = 14,\n }\n \n+#[rustc_layout_scalar_valid_range_start(rustc_layout_scalar_valid_range_start)] //~ ERROR\n+struct NonZero<T>(T);\n+\n+fn not_field() -> impl Send {\n+    NonZero(false)\n+}\n+\n fn main() {\n     let _ = A(0);\n     let _ = B(0);"}, {"sha": "7879e7358c00aed5eae37b33067b6d0472c30d93", "filename": "src/test/ui/invalid/invalid_rustc_layout_scalar_valid_range.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/335427a3db8fcdbddece8c7257e0ab40c8230d73/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/335427a3db8fcdbddece8c7257e0ab40c8230d73/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr?ref=335427a3db8fcdbddece8c7257e0ab40c8230d73", "patch": "@@ -27,5 +27,11 @@ LL | |     Y = 14,\n LL | | }\n    | |_- not a struct\n \n-error: aborting due to 4 previous errors\n+error: expected exactly one integer literal argument\n+  --> $DIR/invalid_rustc_layout_scalar_valid_range.rs:18:1\n+   |\n+LL | #[rustc_layout_scalar_valid_range_start(rustc_layout_scalar_valid_range_start)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 5 previous errors\n "}]}