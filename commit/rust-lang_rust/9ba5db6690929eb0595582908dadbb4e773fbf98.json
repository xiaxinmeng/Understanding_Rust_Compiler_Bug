{"sha": "9ba5db6690929eb0595582908dadbb4e773fbf98", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliYTVkYjY2OTA5MjllYjA1OTU1ODI5MDhkYWRiYjRlNzczZmJmOTg=", "commit": {"author": {"name": "Seo Sanghyeon", "email": "sanxiyn@gmail.com", "date": "2015-09-21T15:33:17Z"}, "committer": {"name": "Seo Sanghyeon", "email": "sanxiyn@gmail.com", "date": "2015-09-21T15:33:17Z"}, "message": "Save bitcode before LTO when -C save-temps is given", "tree": {"sha": "2a890978b67fed85e3fd8bfe8ccde5d34898f440", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a890978b67fed85e3fd8bfe8ccde5d34898f440"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9ba5db6690929eb0595582908dadbb4e773fbf98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9ba5db6690929eb0595582908dadbb4e773fbf98", "html_url": "https://github.com/rust-lang/rust/commit/9ba5db6690929eb0595582908dadbb4e773fbf98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9ba5db6690929eb0595582908dadbb4e773fbf98/comments", "author": {"login": "sanxiyn", "id": 45249, "node_id": "MDQ6VXNlcjQ1MjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/45249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sanxiyn", "html_url": "https://github.com/sanxiyn", "followers_url": "https://api.github.com/users/sanxiyn/followers", "following_url": "https://api.github.com/users/sanxiyn/following{/other_user}", "gists_url": "https://api.github.com/users/sanxiyn/gists{/gist_id}", "starred_url": "https://api.github.com/users/sanxiyn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sanxiyn/subscriptions", "organizations_url": "https://api.github.com/users/sanxiyn/orgs", "repos_url": "https://api.github.com/users/sanxiyn/repos", "events_url": "https://api.github.com/users/sanxiyn/events{/privacy}", "received_events_url": "https://api.github.com/users/sanxiyn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sanxiyn", "id": 45249, "node_id": "MDQ6VXNlcjQ1MjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/45249?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sanxiyn", "html_url": "https://github.com/sanxiyn", "followers_url": "https://api.github.com/users/sanxiyn/followers", "following_url": "https://api.github.com/users/sanxiyn/following{/other_user}", "gists_url": "https://api.github.com/users/sanxiyn/gists{/gist_id}", "starred_url": "https://api.github.com/users/sanxiyn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sanxiyn/subscriptions", "organizations_url": "https://api.github.com/users/sanxiyn/orgs", "repos_url": "https://api.github.com/users/sanxiyn/repos", "events_url": "https://api.github.com/users/sanxiyn/events{/privacy}", "received_events_url": "https://api.github.com/users/sanxiyn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a33e48771e75c82411da2c668366bec59cee718d", "url": "https://api.github.com/repos/rust-lang/rust/commits/a33e48771e75c82411da2c668366bec59cee718d", "html_url": "https://github.com/rust-lang/rust/commit/a33e48771e75c82411da2c668366bec59cee718d"}], "stats": {"total": 16, "additions": 14, "deletions": 2}, "files": [{"sha": "ba6ec895a8e12e356d23f3094ad5e99a9cfb9ddc", "filename": "src/librustc_trans/back/lto.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/9ba5db6690929eb0595582908dadbb4e773fbf98/src%2Flibrustc_trans%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ba5db6690929eb0595582908dadbb4e773fbf98/src%2Flibrustc_trans%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flto.rs?ref=9ba5db6690929eb0595582908dadbb4e773fbf98", "patch": "@@ -15,6 +15,7 @@ use llvm;\n use llvm::archive_ro::ArchiveRO;\n use llvm::{ModuleRef, TargetMachineRef, True, False};\n use rustc::util::common::time;\n+use rustc::util::common::path2cstr;\n use back::write::{ModuleConfig, with_llvm_pmb};\n \n use libc;\n@@ -24,7 +25,9 @@ use std::ffi::CString;\n \n pub fn run(sess: &session::Session, llmod: ModuleRef,\n            tm: TargetMachineRef, reachable: &[String],\n-           config: &ModuleConfig) {\n+           config: &ModuleConfig,\n+           name_extra: &str,\n+           output_names: &config::OutputFilenames) {\n     if sess.opts.cg.prefer_dynamic {\n         sess.err(\"cannot prefer dynamic linking when performing LTO\");\n         sess.note(\"only 'staticlib' and 'bin' outputs are supported with LTO\");\n@@ -124,6 +127,14 @@ pub fn run(sess: &session::Session, llmod: ModuleRef,\n         }\n     }\n \n+    if sess.opts.cg.save_temps {\n+        let path = output_names.with_extension(&format!(\"{}.no-opt.lto.bc\", name_extra));\n+        let cstr = path2cstr(&path);\n+        unsafe {\n+            llvm::LLVMWriteBitcodeToFile(llmod, cstr.as_ptr());\n+        }\n+    }\n+\n     // Now we have one massive module inside of llmod. Time to run the\n     // LTO-specific optimization passes that LLVM provides.\n     //"}, {"sha": "94e2891f40fa070d262de6674e241281e015ce59", "filename": "src/librustc_trans/back/write.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9ba5db6690929eb0595582908dadbb4e773fbf98/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ba5db6690929eb0595582908dadbb4e773fbf98/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fwrite.rs?ref=9ba5db6690929eb0595582908dadbb4e773fbf98", "patch": "@@ -496,7 +496,8 @@ unsafe fn optimize_and_codegen(cgcx: &CodegenContext,\n         match cgcx.lto_ctxt {\n             Some((sess, reachable)) if sess.lto() =>  {\n                 time(sess.time_passes(), \"all lto passes\", ||\n-                     lto::run(sess, llmod, tm, reachable, &config));\n+                     lto::run(sess, llmod, tm, reachable, &config,\n+                              &name_extra, &output_names));\n \n                 if config.emit_lto_bc {\n                     let name = format!(\"{}.lto.bc\", name_extra);"}]}