{"sha": "58d957be3fd559787b7f489ee5f1089ce9a87f30", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4ZDk1N2JlM2ZkNTU5Nzg3YjdmNDg5ZWU1ZjEwODljZTlhODdmMzA=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-05-03T15:21:51Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-05-03T15:21:51Z"}, "message": "Check format failures explicitly in visit_block", "tree": {"sha": "92cb093963db8bd1c76c7bcd39fd18f7c236bfb3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/92cb093963db8bd1c76c7bcd39fd18f7c236bfb3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/58d957be3fd559787b7f489ee5f1089ce9a87f30", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/58d957be3fd559787b7f489ee5f1089ce9a87f30", "html_url": "https://github.com/rust-lang/rust/commit/58d957be3fd559787b7f489ee5f1089ce9a87f30", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/58d957be3fd559787b7f489ee5f1089ce9a87f30/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d14ac84a40a4eae077a691de4baae885f97ea1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d14ac84a40a4eae077a691de4baae885f97ea1c", "html_url": "https://github.com/rust-lang/rust/commit/6d14ac84a40a4eae077a691de4baae885f97ea1c"}], "stats": {"total": 29, "additions": 11, "deletions": 18}, "files": [{"sha": "5876409a9fa22e95c488dae8a1cb399cd4e746e8", "filename": "src/expr.rs", "status": "modified", "additions": 6, "deletions": 18, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/58d957be3fd559787b7f489ee5f1089ce9a87f30/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58d957be3fd559787b7f489ee5f1089ce9a87f30/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=58d957be3fd559787b7f489ee5f1089ce9a87f30", "patch": "@@ -570,19 +570,6 @@ fn rewrite_closure(capture: ast::CaptureBy,\n         rewrite.map(|rw| format!(\"{} {}\", prefix, rw))\n     }\n \n-    fn no_weird_visual_indent(block_str: &str, context: &RewriteContext) -> bool {\n-        let mut prev_indent_width = 0;\n-        for line in block_str.lines() {\n-            let cur_indent_width = line.find(|c: char| !c.is_whitespace()).unwrap_or(0);\n-            if prev_indent_width > cur_indent_width + context.config.tab_spaces &&\n-               line.find('}').unwrap_or(0) != cur_indent_width {\n-                return false;\n-            }\n-            prev_indent_width = cur_indent_width;\n-        }\n-        true\n-    }\n-\n     fn rewrite_closure_block(block: &ast::Block,\n                              prefix: String,\n                              context: &RewriteContext,\n@@ -592,9 +579,7 @@ fn rewrite_closure(capture: ast::CaptureBy,\n         // closure is large.\n         if let Some(block_str) = block.rewrite(&context, shape) {\n             let block_threshold = context.config.closure_block_indent_threshold;\n-            if (block_threshold < 0 ||\n-                block_str.matches('\\n').count() <= block_threshold as usize) &&\n-               no_weird_visual_indent(&block_str, context) {\n+            if block_threshold < 0 || block_str.matches('\\n').count() <= block_threshold as usize {\n                 if let Some(block_str) = block_str.rewrite(context, shape) {\n                     return Some(format!(\"{} {}\", prefix, block_str));\n                 }\n@@ -697,8 +682,11 @@ impl Rewrite for ast::Block {\n         };\n \n         visitor.visit_block(self);\n-\n-        Some(format!(\"{}{}\", prefix, visitor.buffer))\n+        if visitor.failed {\n+            None\n+        } else {\n+            Some(format!(\"{}{}\", prefix, visitor.buffer))\n+        }\n     }\n }\n "}, {"sha": "71013d085d51e93f2978f88a437c61a2a8e4fd80", "filename": "src/visitor.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/58d957be3fd559787b7f489ee5f1089ce9a87f30/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58d957be3fd559787b7f489ee5f1089ce9a87f30/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=58d957be3fd559787b7f489ee5f1089ce9a87f30", "patch": "@@ -39,6 +39,7 @@ pub struct FmtVisitor<'a> {\n     // FIXME: use an RAII util or closure for indenting\n     pub block_indent: Indent,\n     pub config: &'a Config,\n+    pub failed: bool,\n }\n \n impl<'a> FmtVisitor<'a> {\n@@ -65,6 +66,9 @@ impl<'a> FmtVisitor<'a> {\n                                            Shape::legacy(self.config.max_width -\n                                                          self.block_indent.width(),\n                                                          self.block_indent));\n+                if rewrite.is_none() {\n+                    self.failed = true;\n+                }\n                 self.push_rewrite(stmt.span, rewrite);\n             }\n             ast::StmtKind::Mac(ref mac) => {\n@@ -457,6 +461,7 @@ impl<'a> FmtVisitor<'a> {\n                 alignment: 0,\n             },\n             config: config,\n+            failed: false,\n         }\n     }\n "}]}