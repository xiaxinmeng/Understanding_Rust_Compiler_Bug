{"sha": "5a1a3707ff3e048c947d8b85d9e1f563775860c8", "node_id": "C_kwDOAAsO6NoAKDVhMWEzNzA3ZmYzZTA0OGM5NDdkOGI4NWQ5ZTFmNTYzNzc1ODYwYzg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-18T23:18:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-18T23:18:12Z"}, "message": "Auto merge of #94050 - michaelwoerister:fix-unsized-tuple-debuginfo, r=pnkfelix\n\ndebuginfo: Support fat pointers to unsized tuples.\n\nThis PR makes fat pointer debuginfo generation handle the case of unsized tuples.\n\nFixes #93871", "tree": {"sha": "f01e21e7bd04a478b1e1d9297ba5a417b9387a06", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f01e21e7bd04a478b1e1d9297ba5a417b9387a06"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5a1a3707ff3e048c947d8b85d9e1f563775860c8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5a1a3707ff3e048c947d8b85d9e1f563775860c8", "html_url": "https://github.com/rust-lang/rust/commit/5a1a3707ff3e048c947d8b85d9e1f563775860c8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5a1a3707ff3e048c947d8b85d9e1f563775860c8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b17226fcc11587fed612631be372a5b4cb89988a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b17226fcc11587fed612631be372a5b4cb89988a", "html_url": "https://github.com/rust-lang/rust/commit/b17226fcc11587fed612631be372a5b4cb89988a"}, {"sha": "28ca6b0f79ebe238d1deb0c06b0b17396716b958", "url": "https://api.github.com/repos/rust-lang/rust/commits/28ca6b0f79ebe238d1deb0c06b0b17396716b958", "html_url": "https://github.com/rust-lang/rust/commit/28ca6b0f79ebe238d1deb0c06b0b17396716b958"}], "stats": {"total": 36, "additions": 27, "deletions": 9}, "files": [{"sha": "acd032a7dc6d0339c227fca4e3720b3d008a04da", "filename": "compiler/rustc_codegen_llvm/src/debuginfo/utils.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5a1a3707ff3e048c947d8b85d9e1f563775860c8/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a1a3707ff3e048c947d8b85d9e1f563775860c8/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Futils.rs?ref=5a1a3707ff3e048c947d8b85d9e1f563775860c8", "patch": "@@ -6,7 +6,7 @@ use super::CrateDebugContext;\n use rustc_hir::def_id::DefId;\n use rustc_middle::ty::layout::LayoutOf;\n use rustc_middle::ty::{self, DefIdTree, Ty};\n-use rustc_target::abi::VariantIdx;\n+use rustc_target::abi::Variants;\n \n use crate::common::CodegenCx;\n use crate::llvm;\n@@ -72,20 +72,15 @@ pub(crate) fn fat_pointer_kind<'ll, 'tcx>(\n     match *pointee_ty.kind() {\n         ty::Str | ty::Slice(_) => Some(FatPtrKind::Slice),\n         ty::Dynamic(..) => Some(FatPtrKind::Dyn),\n-        ty::Adt(adt_def, _) => {\n-            assert!(adt_def.is_struct());\n-            assert!(adt_def.variants.len() == 1);\n-            let variant = &adt_def.variants[VariantIdx::from_usize(0)];\n-            assert!(!variant.fields.is_empty());\n-            let last_field_index = variant.fields.len() - 1;\n-\n+        ty::Adt(..) | ty::Tuple(..) if matches!(layout.variants, Variants::Single { .. }) => {\n+            let last_field_index = layout.fields.count() - 1;\n             debug_assert!(\n                 (0..last_field_index)\n                     .all(|field_index| { !layout.field(cx, field_index).is_unsized() })\n             );\n \n             let unsized_field = layout.field(cx, last_field_index);\n-            assert!(unsized_field.is_unsized());\n+            debug_assert!(unsized_field.is_unsized());\n             fat_pointer_kind(cx, unsized_field.ty)\n         }\n         ty::Foreign(_) => {"}, {"sha": "7ccc88ef940dcfa441f4a217fa92651607cbb3da", "filename": "src/test/debuginfo/unsized.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/5a1a3707ff3e048c947d8b85d9e1f563775860c8/src%2Ftest%2Fdebuginfo%2Funsized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a1a3707ff3e048c947d8b85d9e1f563775860c8/src%2Ftest%2Fdebuginfo%2Funsized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Funsized.rs?ref=5a1a3707ff3e048c947d8b85d9e1f563775860c8", "patch": "@@ -16,6 +16,14 @@\n // gdbg-check:$3 = {pointer = [...], vtable = [...]}\n // gdbr-check:$3 = &unsized::Foo<dyn core::fmt::Debug> {pointer: [...], vtable: [...]}\n \n+// gdb-command:print tuple_slice\n+// gdbg-check:$4 = {data_ptr = [...], length = 2}\n+// gdbr-check:$4 = &(i32, i32, [i32]) {data_ptr: [...], length: 2}\n+\n+// gdb-command:print tuple_dyn\n+// gdbg-check:$5 = {pointer = [...], vtable = [...]}\n+// gdbr-check:$5 = &(i32, i32, dyn core::fmt::Debug) {pointer: [...], vtable: [...]}\n+\n // === CDB TESTS ===================================================================================\n \n // cdb-command: g\n@@ -34,6 +42,17 @@\n // cdb-check:    [+0x000] pointer          : 0x[...] [Type: unsized::Foo<dyn$<core::fmt::Debug> > *]\n // cdb-check:    [...] vtable           : 0x[...] [Type: unsigned [...]int[...] (*)[3]]\n \n+// cdb-command:dx tuple_slice\n+// cdb-check:tuple_slice      [Type: ref$<tuple$<i32,i32,slice$<i32> > >]\n+// cdb-check:    [+0x000] data_ptr         : 0x[...] [Type: tuple$<i32,i32,slice$<i32> > *]\n+// cdb-check:    [...] length           : 0x2 [Type: unsigned [...]int[...]\n+\n+// cdb-command:dx tuple_dyn\n+// cdb-check:tuple_dyn        [Type: ref$<tuple$<i32,i32,dyn$<core::fmt::Debug> > >]\n+// cdb-check:    [+0x000] pointer          : 0x[...] [Type: tuple$<i32,i32,dyn$<core::fmt::Debug> > *]\n+// cdb-check:    [...] vtable           : 0x[...] [Type: unsigned [...]int[...] (*)[3]]\n+\n+#![feature(unsized_tuple_coercion)]\n #![feature(omit_gdb_pretty_printer_section)]\n #![omit_gdb_pretty_printer_section]\n \n@@ -51,6 +70,10 @@ fn main() {\n     let b: &Foo<Foo<[u8]>> = &foo;\n     let c: &Foo<dyn std::fmt::Debug> = &Foo { value: 7i32 };\n \n+    // Also check unsized tuples\n+    let tuple_slice: &(i32, i32, [i32]) = &(0, 1, [2, 3]);\n+    let tuple_dyn: &(i32, i32, dyn std::fmt::Debug) = &(0, 1, &3u64);\n+\n     zzz(); // #break\n }\n "}]}