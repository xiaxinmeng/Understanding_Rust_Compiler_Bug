{"sha": "e5eacf8ea9e59777d6c7d4939d91d2e96dfff838", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1ZWFjZjhlYTllNTk3NzdkNmM3ZDQ5MzlkOTFkMmU5NmRmZmY4Mzg=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2011-06-10T20:39:13Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2011-06-10T21:05:06Z"}, "message": "Use RHS type when translating assignments\n\nIn code like \"auto foo = fail\", a type gets inferred for foo\ndepending on how it's used. However, fail still has type _|_ and\nstill should be treated that way: particularly, its value shouldn't\nbe copied. Fixed trans to reflect that.", "tree": {"sha": "e3deec61583870d49b0e24c79d20a79d469f024c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e3deec61583870d49b0e24c79d20a79d469f024c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838", "html_url": "https://github.com/rust-lang/rust/commit/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1431adb404973f2f9dbce91b3c56893935df83b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1431adb404973f2f9dbce91b3c56893935df83b", "html_url": "https://github.com/rust-lang/rust/commit/f1431adb404973f2f9dbce91b3c56893935df83b"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "2c0965ead2fcf3b81ad77efd099ed6651bfe48fa", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=e5eacf8ea9e59777d6c7d4939d91d2e96dfff838", "patch": "@@ -3286,6 +3286,7 @@ fn copy_val(&@block_ctxt cx,\n            ValueRef dst,\n            ValueRef src,\n            &ty::t t) -> result {\n+\n     if (ty::type_is_scalar(cx.fcx.lcx.ccx.tcx, t) ||\n             ty::type_is_native(cx.fcx.lcx.ccx.tcx, t)) {\n         ret res(cx, cx.build.Store(src, dst));\n@@ -6646,6 +6647,11 @@ fn init_local(&@block_ctxt cx, &@ast::local local) -> result {\n         case (some(?init)) {\n             alt (init.op) {\n                 case (ast::init_assign) {\n+                    // Use the type of the RHS because if it's _|_, the LHS\n+                    // type might be something else, but we don't want to copy\n+                    // the value.\n+                    ty = node_ann_type(cx.fcx.lcx.ccx,\n+                                       ty::expr_ann(init.expr));\n                     auto sub = trans_expr(bcx, init.expr);\n                     bcx = copy_val(sub.bcx, INIT, llptr, sub.val, ty).bcx;\n                 }"}, {"sha": "593822be3cb7f4f94460cd44e03930245a2912a8", "filename": "src/test/run-fail/rhs-type.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838/src%2Ftest%2Frun-fail%2Frhs-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5eacf8ea9e59777d6c7d4939d91d2e96dfff838/src%2Ftest%2Frun-fail%2Frhs-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Frhs-type.rs?ref=e5eacf8ea9e59777d6c7d4939d91d2e96dfff838", "patch": "@@ -0,0 +1,9 @@\n+// Tests that trans treats the rhs of pth's decl\n+// as a _|_-typed thing, not a str-typed thing\n+// error-pattern:bye\n+fn main() {\n+  auto pth = fail \"bye\";\n+\n+  let rec(str t) res = rec(t=pth);\n+\n+}"}]}