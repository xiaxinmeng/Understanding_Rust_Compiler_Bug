{"sha": "409382dd3cd9113757c11d3af2c509dac2edf8f2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwOTM4MmRkM2NkOTExMzc1N2MxMWQzYWYyYzUwOWRhYzJlZGY4ZjI=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-11-24T01:50:02Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-12-12T13:38:13Z"}, "message": "Don't abort rustdoc tests if `tidy` isn't installed\n\nBefore:\n\n```\nCheck compiletest suite=rustdoc mode=rustdoc (x86_64-unknown-linux-gnu -> x86_64-unknown-linux-gnu)\n\nrunning 396 tests\n..................................................2020-11-23T12:12:37.735649Z ERROR compiletest::runtest: fatal error, panic: \"failed to run tidy - is it installed? - No such file or directory (os error 2)\"\nF................................................. 100/396\n.................................................................................................... 200/396\n.................................................................................................... 300/396\n...............................i...............2020-11-23T12:15:00.271271Z ERROR compiletest::runtest: fatal error, panic: \"failed to run tidy - is it installed? - No such file or directory (os error 2)\"\nF................................................\n```\n\nAfter:\n\n```\nCheck compiletest suite=rustdoc mode=rustdoc (x86_64-unknown-linux-gnu -> x86_64-unknown-linux-gnu)\n\nrunning 4 tests\n.FFF\nfailures:\n\n---- [rustdoc] rustdoc/fn-pointer-arg-name.rs stdout ----\n\nerror: htmldocck failed!\nstatus: exit code: 1\ncommand: \"/usr/bin/python\" \"/home/joshua/rustc/src/etc/htmldocck.py\" \"/home/joshua/rustc/build/x86_64-unknown-linux-gnu/test/rustdoc/fn-pointer-arg-name\" \"/home/joshua/rustc/src/test/rustdoc/fn-pointer-arg-name.rs\"\nstdout:\n------------------------------------------\n\n------------------------------------------\nstderr:\n------------------------------------------\n4: @has check failed\n\t`XPATH PATTERN` did not match\n\t// @has - '//*[@class=\"rust fn\"]' 'pub fn f(callback: fn(len: usize, foo: u32))'\n\nEncountered 1 errors\n\n------------------------------------------\n\ninfo: generating a diff against nightly rustdoc\nfailed to run tidy - is it installed? - Permission denied (os error 13)\nfailed to run tidy - is it installed? - Permission denied (os error 13)\n # a diff without running `tidy`\n```", "tree": {"sha": "4686ab89de1a56a388eb2f1f59407c412ad23f68", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4686ab89de1a56a388eb2f1f59407c412ad23f68"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/409382dd3cd9113757c11d3af2c509dac2edf8f2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/409382dd3cd9113757c11d3af2c509dac2edf8f2", "html_url": "https://github.com/rust-lang/rust/commit/409382dd3cd9113757c11d3af2c509dac2edf8f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/409382dd3cd9113757c11d3af2c509dac2edf8f2/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c3ed6681ff8d446e68ce272be4bf66f4145f6e29", "url": "https://api.github.com/repos/rust-lang/rust/commits/c3ed6681ff8d446e68ce272be4bf66f4145f6e29", "html_url": "https://github.com/rust-lang/rust/commit/c3ed6681ff8d446e68ce272be4bf66f4145f6e29"}], "stats": {"total": 27, "additions": 16, "deletions": 11}, "files": [{"sha": "398f3e31c6ad86f1cb6be419625400b1d6f54419", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/409382dd3cd9113757c11d3af2c509dac2edf8f2/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409382dd3cd9113757c11d3af2c509dac2edf8f2/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=409382dd3cd9113757c11d3af2c509dac2edf8f2", "patch": "@@ -2394,7 +2394,8 @@ impl<'test> TestCx<'test> {\n \n         let proc_res = new_rustdoc.document(&compare_dir);\n         if !proc_res.status.success() {\n-            proc_res.fatal(Some(\"failed to run nightly rustdoc\"), || ());\n+            eprintln!(\"failed to run nightly rustdoc\");\n+            return;\n         }\n \n         #[rustfmt::skip]\n@@ -2409,22 +2410,26 @@ impl<'test> TestCx<'test> {\n         ];\n         let tidy_dir = |dir| {\n             let tidy = |file: &_| {\n-                Command::new(\"tidy\")\n-                    .args(&tidy_args)\n-                    .arg(file)\n-                    .spawn()\n-                    .unwrap_or_else(|err| {\n-                        self.fatal(&format!(\"failed to run tidy - is it installed? - {}\", err))\n-                    })\n-                    .wait()\n-                    .unwrap()\n+                let tidy_proc = Command::new(\"tidy\").args(&tidy_args).arg(file).spawn();\n+                match tidy_proc {\n+                    Ok(mut proc) => {\n+                        proc.wait().unwrap();\n+                        true\n+                    }\n+                    Err(err) => {\n+                        eprintln!(\"failed to run tidy - is it installed? - {}\", err);\n+                        false\n+                    }\n+                }\n             };\n             for entry in walkdir::WalkDir::new(dir) {\n                 let entry = entry.expect(\"failed to read file\");\n                 if entry.file_type().is_file()\n                     && entry.path().extension().and_then(|p| p.to_str()) == Some(\"html\".into())\n                 {\n-                    tidy(entry.path());\n+                    if !tidy(entry.path()) {\n+                        return;\n+                    }\n                 }\n             }\n         };"}]}