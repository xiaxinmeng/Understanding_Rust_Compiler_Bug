{"sha": "c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "node_id": "C_kwDOAAsO6NoAKGM4MWFhNjhhZmU3YTM5NTQ0YmNjZjRhNzE5NTdiOGI1YjNjZTAyNTQ", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-12-10T18:18:21Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-12-10T18:18:21Z"}, "message": "Don't show trait flyimports for impl trait and placeholders", "tree": {"sha": "dc44dcdc6616e91588a5e232a13470e793588e92", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dc44dcdc6616e91588a5e232a13470e793588e92"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "html_url": "https://github.com/rust-lang/rust/commit/c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7fc2061eaf0ee56d12ef217629d5a15906830b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7fc2061eaf0ee56d12ef217629d5a15906830b9", "html_url": "https://github.com/rust-lang/rust/commit/a7fc2061eaf0ee56d12ef217629d5a15906830b9"}], "stats": {"total": 108, "additions": 78, "deletions": 30}, "files": [{"sha": "3739e522a182342e597e05dda7ffae119de447c0", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 26, "deletions": 14, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -2623,13 +2623,15 @@ impl Type {\n     }\n \n     pub fn autoderef<'a>(&'a self, db: &'a dyn HirDatabase) -> impl Iterator<Item = Type> + 'a {\n+        self.autoderef_(db).map(move |ty| self.derived(ty))\n+    }\n+\n+    pub fn autoderef_<'a>(&'a self, db: &'a dyn HirDatabase) -> impl Iterator<Item = Ty> + 'a {\n         // There should be no inference vars in types passed here\n         let canonical = hir_ty::replace_errors_with_variables(&self.ty);\n         let environment = self.env.env.clone();\n         let ty = InEnvironment { goal: canonical, environment };\n-        autoderef(db, Some(self.krate), ty)\n-            .map(|canonical| canonical.value)\n-            .map(move |ty| self.derived(ty))\n+        autoderef(db, Some(self.krate), ty).map(|canonical| canonical.value)\n     }\n \n     // This would be nicer if it just returned an iterator, but that runs into\n@@ -2808,22 +2810,32 @@ impl Type {\n         db: &'a dyn HirDatabase,\n     ) -> impl Iterator<Item = Trait> + 'a {\n         let _p = profile::span(\"applicable_inherent_traits\");\n-        self.autoderef(db)\n-            .filter_map(|derefed_type| derefed_type.ty.dyn_trait())\n+        self.autoderef_(db)\n+            .filter_map(|ty| ty.dyn_trait())\n             .flat_map(move |dyn_trait_id| hir_ty::all_super_traits(db.upcast(), dyn_trait_id))\n             .map(Trait::from)\n     }\n \n-    pub fn as_impl_traits(&self, db: &dyn HirDatabase) -> Option<Vec<Trait>> {\n+    pub fn env_traits<'a>(&'a self, db: &'a dyn HirDatabase) -> impl Iterator<Item = Trait> + 'a {\n+        let _p = profile::span(\"env_traits\");\n+        self.autoderef_(db)\n+            .filter(|ty| matches!(ty.kind(&Interner), TyKind::Placeholder(_)))\n+            .flat_map(|ty| {\n+                self.env\n+                    .traits_in_scope_from_clauses(ty)\n+                    .flat_map(|t| hir_ty::all_super_traits(db.upcast(), t))\n+            })\n+            .map(Trait::from)\n+    }\n+\n+    pub fn as_impl_traits(&self, db: &dyn HirDatabase) -> Option<impl Iterator<Item = Trait>> {\n         self.ty.impl_trait_bounds(db).map(|it| {\n-            it.into_iter()\n-                .filter_map(|pred| match pred.skip_binders() {\n-                    hir_ty::WhereClause::Implemented(trait_ref) => {\n-                        Some(Trait::from(trait_ref.hir_trait_id()))\n-                    }\n-                    _ => None,\n-                })\n-                .collect()\n+            it.into_iter().filter_map(|pred| match pred.skip_binders() {\n+                hir_ty::WhereClause::Implemented(trait_ref) => {\n+                    Some(Trait::from(trait_ref.hir_trait_id()))\n+                }\n+                _ => None,\n+            })\n         })\n     }\n "}, {"sha": "6af39828be59ff3b63688bf29e478cf4138f5770", "filename": "crates/hir_ty/src/method_resolution.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -719,7 +719,7 @@ fn iterate_trait_method_candidates(\n     let env_traits = match self_ty.value.kind(&Interner) {\n         TyKind::Placeholder(_) => {\n             // if we have `T: Trait` in the param env, the trait doesn't need to be in scope\n-            env.traits_in_scope_from_clauses(&self_ty.value)\n+            env.traits_in_scope_from_clauses(self_ty.value.clone())\n                 .flat_map(|t| all_super_traits(db.upcast(), t))\n                 .collect()\n         }"}, {"sha": "3876a9da26943fa2e6b8748605237916f345201f", "filename": "crates/hir_ty/src/traits.rs", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fhir_ty%2Fsrc%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fhir_ty%2Fsrc%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftraits.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -54,17 +54,13 @@ impl TraitEnvironment {\n         }\n     }\n \n-    pub(crate) fn traits_in_scope_from_clauses<'a>(\n+    pub fn traits_in_scope_from_clauses<'a>(\n         &'a self,\n-        ty: &'a Ty,\n+        ty: Ty,\n     ) -> impl Iterator<Item = TraitId> + 'a {\n-        self.traits_from_clauses.iter().filter_map(move |(self_ty, trait_id)| {\n-            if self_ty == ty {\n-                Some(*trait_id)\n-            } else {\n-                None\n-            }\n-        })\n+        self.traits_from_clauses\n+            .iter()\n+            .filter_map(move |(self_ty, trait_id)| (*self_ty == ty).then(|| *trait_id))\n     }\n }\n "}, {"sha": "55cdb3200eac96b6d9a7930a04ba24af290308db", "filename": "crates/ide/src/goto_type_definition.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide%2Fsrc%2Fgoto_type_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide%2Fsrc%2Fgoto_type_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fgoto_type_definition.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -75,7 +75,7 @@ pub(crate) fn goto_type_definition(\n                 } else if let Some(trait_) = t.as_dyn_trait() {\n                     push(trait_.into());\n                 } else if let Some(traits) = t.as_impl_traits(db) {\n-                    traits.into_iter().for_each(|it| push(it.into()));\n+                    traits.for_each(|it| push(it.into()));\n                 } else if let Some(trait_) = t.as_associated_type_parent_trait(db) {\n                     push(trait_.into());\n                 }"}, {"sha": "7d5cfaa93728a24e90d6a834e6e7204ea0a4fdcc", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -337,7 +337,7 @@ fn walk_and_push_ty(\n         } else if let Some(trait_) = t.as_dyn_trait() {\n             push_new_def(trait_.into());\n         } else if let Some(traits) = t.as_impl_traits(db) {\n-            traits.into_iter().for_each(|it| push_new_def(it.into()));\n+            traits.for_each(|it| push_new_def(it.into()));\n         } else if let Some(trait_) = t.as_associated_type_parent_trait(db) {\n             push_new_def(trait_.into());\n         }"}, {"sha": "2021db3abab2cb6f9aa114bc0b27312d0109a6c8", "filename": "crates/ide_assists/src/utils/suggest_name.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide_assists%2Fsrc%2Futils%2Fsuggest_name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide_assists%2Fsrc%2Futils%2Fsuggest_name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Futils%2Fsuggest_name.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -243,7 +243,7 @@ fn name_of_type(ty: &hir::Type, db: &RootDatabase) -> Option<String> {\n     } else if let Some(trait_) = ty.as_dyn_trait() {\n         trait_name(&trait_, db)?\n     } else if let Some(traits) = ty.as_impl_traits(db) {\n-        let mut iter = traits.into_iter().filter_map(|t| trait_name(&t, db));\n+        let mut iter = traits.filter_map(|t| trait_name(&t, db));\n         let name = iter.next()?;\n         if iter.next().is_some() {\n             return None;"}, {"sha": "1f96e122f956c66867f5152389b6165e5eba4875", "filename": "crates/ide_completion/src/tests/flyimport.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -924,6 +924,44 @@ mod bar {\n             \"#,\n         expect![[r#\"\"#]],\n     );\n+    check(\n+        r#\"\n+mod baz {\n+    pub trait DefDatabase {\n+        fn method1(&self);\n+    }\n+    pub trait HirDatabase: DefDatabase {\n+        fn method2(&self);\n+    }\n+}\n+\n+mod bar {\n+    fn test(db: &impl crate::baz::HirDatabase) {\n+        db.metho$0\n+    }\n+}\n+\"#,\n+        expect![[r#\"\"#]],\n+    );\n+    check(\n+        r#\"\n+mod baz {\n+    pub trait DefDatabase {\n+        fn method1(&self);\n+    }\n+    pub trait HirDatabase: DefDatabase {\n+        fn method2(&self);\n+    }\n+}\n+\n+mod bar {\n+    fn test<T: crate::baz::HirDatabase>(db: T) {\n+        db.metho$0\n+    }\n+}\n+\"#,\n+        expect![[r#\"\"#]],\n+    );\n }\n \n #[test]"}, {"sha": "ac0ccfa63f82ebdb6dc83aba6e89a44dc9baa641", "filename": "crates/ide_db/src/helpers/import_assets.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide_db%2Fsrc%2Fhelpers%2Fimport_assets.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c81aa68afe7a39544bccf4a71957b8b5b3ce0254/crates%2Fide_db%2Fsrc%2Fhelpers%2Fimport_assets.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Fimport_assets.rs?ref=c81aa68afe7a39544bccf4a71957b8b5b3ce0254", "patch": "@@ -454,8 +454,10 @@ fn trait_applicable_items(\n \n     let db = sema.db;\n \n-    let related_dyn_traits =\n-        trait_candidate.receiver_ty.applicable_inherent_traits(db).collect::<FxHashSet<_>>();\n+    let inherent_traits = trait_candidate.receiver_ty.applicable_inherent_traits(db);\n+    let env_traits = trait_candidate.receiver_ty.env_traits(db);\n+    let related_traits = inherent_traits.chain(env_traits).collect::<FxHashSet<_>>();\n+\n     let mut required_assoc_items = FxHashSet::default();\n     let trait_candidates = items_locator::items_with_name(\n         sema,\n@@ -467,7 +469,7 @@ fn trait_applicable_items(\n     .filter_map(|input| item_as_assoc(db, input))\n     .filter_map(|assoc| {\n         let assoc_item_trait = assoc.containing_trait(db)?;\n-        if related_dyn_traits.contains(&assoc_item_trait) {\n+        if related_traits.contains(&assoc_item_trait) {\n             None\n         } else {\n             required_assoc_items.insert(assoc);"}]}