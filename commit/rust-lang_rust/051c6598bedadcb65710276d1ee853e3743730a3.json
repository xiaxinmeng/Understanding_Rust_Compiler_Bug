{"sha": "051c6598bedadcb65710276d1ee853e3743730a3", "node_id": "C_kwDOAAsO6NoAKDA1MWM2NTk4YmVkYWRjYjY1NzEwMjc2ZDFlZTg1M2UzNzQzNzMwYTM", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-12-06T06:53:03Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-12-06T07:01:20Z"}, "message": "Resolve macro2's derive helpers in IDE layer\n\nMacro2's generally don't have derive helpers, but currently builtin\nderive macros are declared with macro2 syntax, which can have derive\nhelpers.", "tree": {"sha": "5600e72c365890099c3b4805a4b63f4113bb3687", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5600e72c365890099c3b4805a4b63f4113bb3687"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/051c6598bedadcb65710276d1ee853e3743730a3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmOO6jQACgkQ4laYqTBY\nYXGvAxAAgRi4X0Epj5r2f/W9atRHllUaYLf+eLthX/wmIY90Xj/M7IXH85zZzlTh\nplTHEoe9Sv1VCuA5SPEe/7bsCHoUmhCi/s7UmEO0QhNqz1/GzQvBSNlSVIUEowuj\nAKCsC5Qbi01SadaZgF5ST0sH4Ah+dwr8Gp8E/XGdihTgnaWrDo32J0wEmm0UonTl\nZnoC9x/ncZ/8tr8G+bXwmXc4Z1uYimETfT7iB0cyr48+jbAcEo0IBRoXhr4dOGsc\ni9xiK/eW0i1DLhoQYc+z6c9wnvFnTa5SWcRZCUuRq8J1uHYoeF6UfvtNfv3tMXlu\nZ/nFYMIXEt5hCNLChrYY0yESb8+pyKdztxKtWGNQ7tZ5FoJGLXeMmae5ZLTjhvLQ\nAN55Ccc6N+TyEAKx2BbGC3iYC+uouwLtlvEiFyBg5D/zU/V/aYo1wfKSGTHrNrQP\nxGPbUZJ9SKAj8AhBhMZx/I/2tgjxKrNgNBNVDx9sgWkG5YqMRMnsDi6KU9CrRAJF\n+3/BkLcq+0c7xbsTcrDNl7jNhGmKkoxznQFfAmxBtilITpAQq6gYhfe2TuykCaMP\nX/Fpk2d1nw9T6vCZQWcdA5m0LEqdaKdiKe5W7YIlB5embSuGgoWWF42uK0yod6oQ\nlWNLxLfGl39/BQFSRhPwHpIoGxzDTvbyW5+1/bYgCoNm2MWVH4I=\n=4a1f\n-----END PGP SIGNATURE-----", "payload": "tree 5600e72c365890099c3b4805a4b63f4113bb3687\nparent cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1670309583 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1670310080 +0900\n\nResolve macro2's derive helpers in IDE layer\n\nMacro2's generally don't have derive helpers, but currently builtin\nderive macros are declared with macro2 syntax, which can have derive\nhelpers.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/051c6598bedadcb65710276d1ee853e3743730a3", "html_url": "https://github.com/rust-lang/rust/commit/051c6598bedadcb65710276d1ee853e3743730a3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/051c6598bedadcb65710276d1ee853e3743730a3/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "html_url": "https://github.com/rust-lang/rust/commit/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf"}], "stats": {"total": 23, "additions": 20, "deletions": 3}, "files": [{"sha": "b78ab71ef21bd69e5506afc0c2d2747ab647a010", "filename": "crates/hir-def/src/data.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/051c6598bedadcb65710276d1ee853e3743730a3/crates%2Fhir-def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/051c6598bedadcb65710276d1ee853e3743730a3/crates%2Fhir-def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fdata.rs?ref=051c6598bedadcb65710276d1ee853e3743730a3", "patch": "@@ -13,7 +13,9 @@ use crate::{\n     intern::Interned,\n     item_tree::{self, AssocItem, FnFlags, ItemTree, ItemTreeId, ModItem, Param, TreeId},\n     nameres::{\n-        attr_resolution::ResolvedAttr, diagnostics::DefDiagnostic, proc_macro::ProcMacroKind,\n+        attr_resolution::ResolvedAttr,\n+        diagnostics::DefDiagnostic,\n+        proc_macro::{parse_macro_name_and_helper_attrs, ProcMacroKind},\n         DefMap,\n     },\n     type_ref::{TraitRef, TypeBound, TypeRef},\n@@ -348,6 +350,10 @@ impl ImplData {\n pub struct Macro2Data {\n     pub name: Name,\n     pub visibility: RawVisibility,\n+    // It's a bit wasteful as currently this is only for builtin `Default` derive macro, but macro2\n+    // are rarely used in practice so I think it's okay for now.\n+    /// Derive helpers, if this is a derive rustc_builtin_macro\n+    pub helpers: Option<Box<[Name]>>,\n }\n \n impl Macro2Data {\n@@ -356,9 +362,18 @@ impl Macro2Data {\n         let item_tree = loc.id.item_tree(db);\n         let makro = &item_tree[loc.id.value];\n \n+        let helpers = item_tree\n+            .attrs(db, loc.container.krate(), ModItem::from(loc.id.value).into())\n+            .by_key(\"rustc_builtin_macro\")\n+            .tt_values()\n+            .next()\n+            .and_then(|attr| parse_macro_name_and_helper_attrs(&attr.token_trees))\n+            .map(|(_, helpers)| helpers);\n+\n         Arc::new(Macro2Data {\n             name: makro.name.clone(),\n             visibility: item_tree[makro.visibility].clone(),\n+            helpers,\n         })\n     }\n }"}, {"sha": "5f36ce62f87f49dd75c583c2337cc9c69099fe05", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/051c6598bedadcb65710276d1ee853e3743730a3/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/051c6598bedadcb65710276d1ee853e3743730a3/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=051c6598bedadcb65710276d1ee853e3743730a3", "patch": "@@ -2349,12 +2349,14 @@ impl DeriveHelper {\n \n     pub fn name(&self, db: &dyn HirDatabase) -> Name {\n         match self.derive {\n-            MacroId::Macro2Id(_) => None,\n+            MacroId::Macro2Id(it) => {\n+                db.macro2_data(it).helpers.as_deref().and_then(|it| it.get(self.idx)).cloned()\n+            }\n             MacroId::MacroRulesId(_) => None,\n             MacroId::ProcMacroId(proc_macro) => db\n                 .proc_macro_data(proc_macro)\n                 .helpers\n-                .as_ref()\n+                .as_deref()\n                 .and_then(|it| it.get(self.idx))\n                 .cloned(),\n         }"}]}