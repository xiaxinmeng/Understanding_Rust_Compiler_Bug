{"sha": "ebf065e5172227a99743f4032c5bfff80d5630e6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmViZjA2NWU1MTcyMjI3YTk5NzQzZjQwMzJjNWJmZmY4MGQ1NjMwZTY=", "commit": {"author": {"name": "Takayuki Nakata", "email": "f.seasons017@gmail.com", "date": "2021-05-17T13:18:50Z"}, "committer": {"name": "Takayuki Nakata", "email": "f.seasons017@gmail.com", "date": "2021-05-17T13:18:50Z"}, "message": "Fix a `manual_unwrap_or` FP with deref coercion", "tree": {"sha": "d949445a69ba29d3de6e35c227c87aa6703aee6c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d949445a69ba29d3de6e35c227c87aa6703aee6c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ebf065e5172227a99743f4032c5bfff80d5630e6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ebf065e5172227a99743f4032c5bfff80d5630e6", "html_url": "https://github.com/rust-lang/rust/commit/ebf065e5172227a99743f4032c5bfff80d5630e6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ebf065e5172227a99743f4032c5bfff80d5630e6/comments", "author": {"login": "giraffate", "id": 17407489, "node_id": "MDQ6VXNlcjE3NDA3NDg5", "avatar_url": "https://avatars.githubusercontent.com/u/17407489?v=4", "gravatar_id": "", "url": "https://api.github.com/users/giraffate", "html_url": "https://github.com/giraffate", "followers_url": "https://api.github.com/users/giraffate/followers", "following_url": "https://api.github.com/users/giraffate/following{/other_user}", "gists_url": "https://api.github.com/users/giraffate/gists{/gist_id}", "starred_url": "https://api.github.com/users/giraffate/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/giraffate/subscriptions", "organizations_url": "https://api.github.com/users/giraffate/orgs", "repos_url": "https://api.github.com/users/giraffate/repos", "events_url": "https://api.github.com/users/giraffate/events{/privacy}", "received_events_url": "https://api.github.com/users/giraffate/received_events", "type": "User", "site_admin": false}, "committer": {"login": "giraffate", "id": 17407489, "node_id": "MDQ6VXNlcjE3NDA3NDg5", "avatar_url": "https://avatars.githubusercontent.com/u/17407489?v=4", "gravatar_id": "", "url": "https://api.github.com/users/giraffate", "html_url": "https://github.com/giraffate", "followers_url": "https://api.github.com/users/giraffate/followers", "following_url": "https://api.github.com/users/giraffate/following{/other_user}", "gists_url": "https://api.github.com/users/giraffate/gists{/gist_id}", "starred_url": "https://api.github.com/users/giraffate/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/giraffate/subscriptions", "organizations_url": "https://api.github.com/users/giraffate/orgs", "repos_url": "https://api.github.com/users/giraffate/repos", "events_url": "https://api.github.com/users/giraffate/events{/privacy}", "received_events_url": "https://api.github.com/users/giraffate/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "48dad265ab407b3aaa65166a300400be0aa79866", "url": "https://api.github.com/repos/rust-lang/rust/commits/48dad265ab407b3aaa65166a300400be0aa79866", "html_url": "https://github.com/rust-lang/rust/commit/48dad265ab407b3aaa65166a300400be0aa79866"}], "stats": {"total": 19, "additions": 19, "deletions": 0}, "files": [{"sha": "cf183d4c16f12a505143bc055e9136a1d0424feb", "filename": "clippy_lints/src/manual_unwrap_or.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ebf065e5172227a99743f4032c5bfff80d5630e6/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebf065e5172227a99743f4032c5bfff80d5630e6/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_unwrap_or.rs?ref=ebf065e5172227a99743f4032c5bfff80d5630e6", "patch": "@@ -11,6 +11,7 @@ use rustc_hir::{Arm, Expr, ExprKind, PatKind};\n use rustc_lint::LintContext;\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::lint::in_external_macro;\n+use rustc_middle::ty::adjustment::Adjust;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n \n@@ -87,6 +88,8 @@ fn lint_manual_unwrap_or<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'tcx>) {\n             if let PatKind::Binding(_, binding_hir_id, ..) = unwrap_pat.kind;\n             if path_to_local_id(unwrap_arm.body, binding_hir_id);\n             if !contains_return_break_continue_macro(or_arm.body);\n+            if !cx.typeck_results().expr_adjustments(unwrap_arm.body).iter()\n+                .any(|a| matches!(a.kind, Adjust::Deref(Some(..))));\n             then {\n                 Some(or_arm)\n             } else {"}, {"sha": "1efecb0ba12779b0bc1c5bc28071ee9d61030d09", "filename": "tests/ui/manual_unwrap_or.fixed", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ebf065e5172227a99743f4032c5bfff80d5630e6/tests%2Fui%2Fmanual_unwrap_or.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/ebf065e5172227a99743f4032c5bfff80d5630e6/tests%2Fui%2Fmanual_unwrap_or.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_unwrap_or.fixed?ref=ebf065e5172227a99743f4032c5bfff80d5630e6", "patch": "@@ -163,4 +163,12 @@ mod issue6965 {\n     }\n }\n \n+use std::rc::Rc;\n+fn format_name(name: Option<&Rc<str>>) -> &str {\n+    match name {\n+        None => \"<anon>\",\n+        Some(name) => name,\n+    }\n+}\n+\n fn main() {}"}, {"sha": "95d585ad18a96c1f093e573d081fe6dd677fcb7e", "filename": "tests/ui/manual_unwrap_or.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ebf065e5172227a99743f4032c5bfff80d5630e6/tests%2Fui%2Fmanual_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ebf065e5172227a99743f4032c5bfff80d5630e6/tests%2Fui%2Fmanual_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_unwrap_or.rs?ref=ebf065e5172227a99743f4032c5bfff80d5630e6", "patch": "@@ -205,4 +205,12 @@ mod issue6965 {\n     }\n }\n \n+use std::rc::Rc;\n+fn format_name(name: Option<&Rc<str>>) -> &str {\n+    match name {\n+        None => \"<anon>\",\n+        Some(name) => name,\n+    }\n+}\n+\n fn main() {}"}]}