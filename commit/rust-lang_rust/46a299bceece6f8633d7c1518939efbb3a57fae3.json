{"sha": "46a299bceece6f8633d7c1518939efbb3a57fae3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2YTI5OWJjZWVjZTZmODYzM2Q3YzE1MTg5MzllZmJiM2E1N2ZhZTM=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-18T14:33:36Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-18T15:00:35Z"}, "message": "Refactor goto tests to always specify texts", "tree": {"sha": "f448be34142365f77b62b6f90b2c2bbd85f1adb4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f448be34142365f77b62b6f90b2c2bbd85f1adb4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/46a299bceece6f8633d7c1518939efbb3a57fae3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/46a299bceece6f8633d7c1518939efbb3a57fae3", "html_url": "https://github.com/rust-lang/rust/commit/46a299bceece6f8633d7c1518939efbb3a57fae3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/46a299bceece6f8633d7c1518939efbb3a57fae3/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "69c944a1e27212604ce85154fd40cff1d46ad6f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/69c944a1e27212604ce85154fd40cff1d46ad6f3", "html_url": "https://github.com/rust-lang/rust/commit/69c944a1e27212604ce85154fd40cff1d46ad6f3"}], "stats": {"total": 128, "additions": 76, "deletions": 52}, "files": [{"sha": "48757f17069c759e0407db2b78c8ab91addbe5aa", "filename": "crates/ra_ide/src/goto_definition.rs", "status": "modified", "additions": 74, "deletions": 50, "changes": 124, "blob_url": "https://github.com/rust-lang/rust/blob/46a299bceece6f8633d7c1518939efbb3a57fae3/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46a299bceece6f8633d7c1518939efbb3a57fae3/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs?ref=46a299bceece6f8633d7c1518939efbb3a57fae3", "patch": "@@ -225,30 +225,35 @@ mod tests {\n \n     use crate::mock_analysis::analysis_and_position;\n \n-    fn check_goto(fixture: &str, expected: &str) {\n+    fn check_goto(fixture: &str, expected: &str, expected_range: &str) {\n         let (analysis, pos) = analysis_and_position(fixture);\n \n         let mut navs = analysis.goto_definition(pos).unwrap().unwrap().info;\n         assert_eq!(navs.len(), 1);\n-        let nav = navs.pop().unwrap();\n-        nav.assert_match(expected);\n-    }\n-\n-    fn check_goto_with_range_content(fixture: &str, expected: &str, expected_range: &str) {\n-        let (analysis, pos) = analysis_and_position(fixture);\n \n-        let mut navs = analysis.goto_definition(pos).unwrap().unwrap().info;\n-        assert_eq!(navs.len(), 1);\n         let nav = navs.pop().unwrap();\n-        let file_text = analysis.file_text(pos.file_id).unwrap();\n+        let file_text = analysis.file_text(nav.file_id()).unwrap();\n \n-        let actual_full_range = &file_text[nav.full_range()];\n-        let actual_range = &file_text[nav.range()];\n+        let mut actual = file_text[nav.full_range()].to_string();\n+        if let Some(focus) = nav.focus_range() {\n+            actual += \"|\";\n+            actual += &file_text[focus];\n+        }\n+\n+        if !expected_range.contains(\"...\") {\n+            test_utils::assert_eq_text!(&actual, expected_range);\n+        } else {\n+            let mut parts = expected_range.split(\"...\");\n+            let prefix = parts.next().unwrap();\n+            let suffix = parts.next().unwrap();\n+            assert!(\n+                actual.starts_with(prefix) && actual.ends_with(suffix),\n+                \"\\nExpected: {}\\n Actual: {}\\n\",\n+                expected_range,\n+                actual\n+            );\n+        }\n \n-        test_utils::assert_eq_text!(\n-            &format!(\"{}|{}\", actual_full_range, actual_range),\n-            expected_range\n-        );\n         nav.assert_match(expected);\n     }\n \n@@ -261,6 +266,7 @@ mod tests {\n             enum E { X(Foo<|>) }\n             \",\n             \"Foo STRUCT_DEF FileId(1) [0; 11) [7; 10)\",\n+            \"struct Foo;|Foo\",\n         );\n     }\n \n@@ -273,6 +279,7 @@ mod tests {\n             enum E { X(<|>Foo) }\n             \",\n             \"Foo STRUCT_DEF FileId(1) [0; 11) [7; 10)\",\n+            \"struct Foo;|Foo\",\n         );\n     }\n \n@@ -293,6 +300,7 @@ mod tests {\n             struct Foo;\n             \",\n             \"Foo STRUCT_DEF FileId(2) [0; 11) [7; 10)\",\n+            \"struct Foo;|Foo\",\n         );\n     }\n \n@@ -307,6 +315,7 @@ mod tests {\n             // empty\n             \",\n             \"foo SOURCE_FILE FileId(2) [0; 10)\",\n+            \"// empty\\n\\n\",\n         );\n \n         check_goto(\n@@ -318,6 +327,7 @@ mod tests {\n             // empty\n             \",\n             \"foo SOURCE_FILE FileId(2) [0; 10)\",\n+            \"// empty\\n\\n\",\n         );\n     }\n \n@@ -327,17 +337,14 @@ mod tests {\n         check_goto(\n             \"\n             //- /lib.rs\n-            macro_rules! foo {\n-                () => {\n-                    {}\n-                };\n-            }\n+            macro_rules! foo { () => { () } }\n \n             fn bar() {\n                 <|>foo!();\n             }\n             \",\n-            \"foo MACRO_CALL FileId(1) [0; 50) [13; 16)\",\n+            \"foo MACRO_CALL FileId(1) [0; 33) [13; 16)\",\n+            \"macro_rules! foo { () => { () } }|foo\",\n         );\n     }\n \n@@ -354,13 +361,10 @@ mod tests {\n \n             //- /foo/lib.rs\n             #[macro_export]\n-            macro_rules! foo {\n-                () => {\n-                    {}\n-                };\n-            }\n+            macro_rules! foo { () => { () } }\n             \",\n-            \"foo MACRO_CALL FileId(2) [0; 66) [29; 32)\",\n+            \"foo MACRO_CALL FileId(2) [0; 49) [29; 32)\",\n+            \"#[macro_export]\\nmacro_rules! foo { () => { () } }|foo\",\n         );\n     }\n \n@@ -373,19 +377,16 @@ mod tests {\n \n             //- /foo/lib.rs\n             #[macro_export]\n-            macro_rules! foo {\n-                () => {\n-                    {}\n-                };\n-            }\n+            macro_rules! foo { () => { () } }\n             \",\n-            \"foo MACRO_CALL FileId(2) [0; 66) [29; 32)\",\n+            \"foo MACRO_CALL FileId(2) [0; 49) [29; 32)\",\n+            \"#[macro_export]\\nmacro_rules! foo { () => { () } }|foo\",\n         );\n     }\n \n     #[test]\n     fn goto_definition_works_for_macro_defined_fn_with_arg() {\n-        check_goto_with_range_content(\n+        check_goto(\n             \"\n             //- /lib.rs\n             macro_rules! define_fn {\n@@ -405,7 +406,7 @@ mod tests {\n \n     #[test]\n     fn goto_definition_works_for_macro_defined_fn_no_arg() {\n-        check_goto_with_range_content(\n+        check_goto(\n             \"\n             //- /lib.rs\n             macro_rules! define_fn {\n@@ -431,14 +432,15 @@ mod tests {\n             //- /lib.rs\n             struct Foo;\n             impl Foo {\n-                fn frobnicate(&self) {  }\n+                fn frobnicate(&self) { }\n             }\n \n             fn bar(foo: &Foo) {\n                 foo.frobnicate<|>();\n             }\n             \",\n-            \"frobnicate FN_DEF FileId(1) [27; 52) [30; 40)\",\n+            \"frobnicate FN_DEF FileId(1) [27; 51) [30; 40)\",\n+            \"fn frobnicate(&self) { }|frobnicate\",\n         );\n     }\n \n@@ -457,6 +459,7 @@ mod tests {\n             }\n             \",\n             \"spam RECORD_FIELD_DEF FileId(1) [17; 26) [17; 21)\",\n+            \"spam: u32|spam\",\n         );\n     }\n \n@@ -477,6 +480,7 @@ mod tests {\n             }\n             \",\n             \"spam RECORD_FIELD_DEF FileId(1) [17; 26) [17; 21)\",\n+            \"spam: u32|spam\",\n         );\n     }\n \n@@ -493,6 +497,7 @@ mod tests {\n             }\n             \",\n             \"TUPLE_FIELD_DEF FileId(1) [11; 14)\",\n+            \"u32\",\n         );\n     }\n \n@@ -503,14 +508,15 @@ mod tests {\n             //- /lib.rs\n             struct Foo;\n             impl Foo {\n-                fn frobnicate() {  }\n+                fn frobnicate() { }\n             }\n \n             fn bar(foo: &Foo) {\n                 Foo::frobnicate<|>();\n             }\n             \",\n-            \"frobnicate FN_DEF FileId(1) [27; 47) [30; 40)\",\n+            \"frobnicate FN_DEF FileId(1) [27; 46) [30; 40)\",\n+            \"fn frobnicate() { }|frobnicate\",\n         );\n     }\n \n@@ -528,6 +534,7 @@ mod tests {\n             }\n             \",\n             \"frobnicate FN_DEF FileId(1) [16; 32) [19; 29)\",\n+            \"fn frobnicate();|frobnicate\",\n         );\n     }\n \n@@ -547,6 +554,7 @@ mod tests {\n             }\n             \",\n             \"frobnicate FN_DEF FileId(1) [30; 46) [33; 43)\",\n+            \"fn frobnicate();|frobnicate\",\n         );\n     }\n \n@@ -563,6 +571,7 @@ mod tests {\n             }\n             \",\n             \"impl IMPL_BLOCK FileId(1) [12; 73)\",\n+            \"impl Foo {...}\",\n         );\n \n         check_goto(\n@@ -576,6 +585,7 @@ mod tests {\n             }\n             \",\n             \"impl IMPL_BLOCK FileId(1) [12; 73)\",\n+            \"impl Foo {...}\",\n         );\n \n         check_goto(\n@@ -589,6 +599,7 @@ mod tests {\n             }\n             \",\n             \"impl IMPL_BLOCK FileId(1) [15; 75)\",\n+            \"impl Foo {...}\",\n         );\n \n         check_goto(\n@@ -601,6 +612,7 @@ mod tests {\n             }\n             \",\n             \"impl IMPL_BLOCK FileId(1) [15; 62)\",\n+            \"impl Foo {...}\",\n         );\n     }\n \n@@ -620,6 +632,7 @@ mod tests {\n             }\n             \",\n             \"impl IMPL_BLOCK FileId(1) [49; 115)\",\n+            \"impl Make for Foo {...}\",\n         );\n \n         check_goto(\n@@ -636,6 +649,7 @@ mod tests {\n             }\n             \",\n             \"impl IMPL_BLOCK FileId(1) [49; 115)\",\n+            \"impl Make for Foo {...}\",\n         );\n     }\n \n@@ -647,6 +661,7 @@ mod tests {\n             struct Foo<|> { value: u32 }\n             \",\n             \"Foo STRUCT_DEF FileId(1) [0; 25) [7; 10)\",\n+            \"struct Foo { value: u32 }|Foo\",\n         );\n \n         check_goto(\n@@ -657,15 +672,16 @@ mod tests {\n             }\n             \"#,\n             \"field RECORD_FIELD_DEF FileId(1) [17; 30) [17; 22)\",\n+            \"field: string|field\",\n         );\n \n         check_goto(\n             \"\n             //- /lib.rs\n-            fn foo_test<|>() {\n-            }\n+            fn foo_test<|>() { }\n             \",\n             \"foo_test FN_DEF FileId(1) [0; 17) [3; 11)\",\n+            \"fn foo_test() { }|foo_test\",\n         );\n \n         check_goto(\n@@ -676,6 +692,7 @@ mod tests {\n             }\n             \",\n             \"Foo ENUM_DEF FileId(1) [0; 25) [5; 8)\",\n+            \"enum Foo {...}|Foo\",\n         );\n \n         check_goto(\n@@ -688,22 +705,25 @@ mod tests {\n             }\n             \",\n             \"Variant2 ENUM_VARIANT FileId(1) [29; 37) [29; 37)\",\n+            \"Variant2|Variant2\",\n         );\n \n         check_goto(\n             r#\"\n             //- /lib.rs\n-            static inner<|>: &str = \"\";\n+            static INNER<|>: &str = \"\";\n             \"#,\n-            \"inner STATIC_DEF FileId(1) [0; 24) [7; 12)\",\n+            \"INNER STATIC_DEF FileId(1) [0; 24) [7; 12)\",\n+            \"static INNER: &str = \\\"\\\";|INNER\",\n         );\n \n         check_goto(\n             r#\"\n             //- /lib.rs\n-            const inner<|>: &str = \"\";\n+            const INNER<|>: &str = \"\";\n             \"#,\n-            \"inner CONST_DEF FileId(1) [0; 23) [6; 11)\",\n+            \"INNER CONST_DEF FileId(1) [0; 23) [6; 11)\",\n+            \"const INNER: &str = \\\"\\\";|INNER\",\n         );\n \n         check_goto(\n@@ -712,24 +732,25 @@ mod tests {\n             type Thing<|> = Option<()>;\n             \"#,\n             \"Thing TYPE_ALIAS_DEF FileId(1) [0; 24) [5; 10)\",\n+            \"type Thing = Option<()>;|Thing\",\n         );\n \n         check_goto(\n             r#\"\n             //- /lib.rs\n-            trait Foo<|> {\n-            }\n+            trait Foo<|> { }\n             \"#,\n             \"Foo TRAIT_DEF FileId(1) [0; 13) [6; 9)\",\n+            \"trait Foo { }|Foo\",\n         );\n \n         check_goto(\n             r#\"\n             //- /lib.rs\n-            mod bar<|> {\n-            }\n+            mod bar<|> { }\n             \"#,\n             \"bar MODULE FileId(1) [0; 11) [4; 7)\",\n+            \"mod bar { }|bar\",\n         );\n     }\n \n@@ -750,6 +771,7 @@ mod tests {\n             mod confuse_index { fn foo(); }\n             \",\n             \"foo FN_DEF FileId(1) [52; 63) [55; 58)\",\n+            \"fn foo() {}|foo\",\n         );\n     }\n \n@@ -778,6 +800,7 @@ mod tests {\n             }\n             \",\n             \"foo FN_DEF FileId(1) [398; 415) [401; 404)\",\n+            \"fn foo() -> i8 {}|foo\",\n         );\n     }\n \n@@ -791,6 +814,7 @@ mod tests {\n             }\n             \",\n             \"T TYPE_PARAM FileId(1) [11; 12)\",\n+            \"T\",\n         );\n     }\n }"}, {"sha": "659f77b71a1cef23a47c8d896f2a44e71539a2ca", "filename": "crates/test_utils/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/46a299bceece6f8633d7c1518939efbb3a57fae3/crates%2Ftest_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46a299bceece6f8633d7c1518939efbb3a57fae3/crates%2Ftest_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2Fsrc%2Flib.rs?ref=46a299bceece6f8633d7c1518939efbb3a57fae3", "patch": "@@ -207,8 +207,8 @@ pub fn lines_match(expected: &str, actual: &str) -> bool {\n     // Let's not deal with / vs \\ (windows...)\n     // First replace backslash-escaped backslashes with forward slashes\n     // which can occur in, for example, JSON output\n-    let expected = expected.replace(\"\\\\\\\\\", \"/\").replace(\"\\\\\", \"/\");\n-    let mut actual: &str = &actual.replace(\"\\\\\\\\\", \"/\").replace(\"\\\\\", \"/\");\n+    let expected = expected.replace(r\"\\\\\", \"/\").replace(r\"\\\", \"/\");\n+    let mut actual: &str = &actual.replace(r\"\\\\\", \"/\").replace(r\"\\\", \"/\");\n     for (i, part) in expected.split(\"[..]\").enumerate() {\n         match actual.find(part) {\n             Some(j) => {"}]}