{"sha": "788f2969f6d2f7339c3c1e7da225d38283597804", "node_id": "C_kwDOAAsO6NoAKDc4OGYyOTY5ZjZkMmY3MzM5YzNjMWU3ZGEyMjVkMzgyODM1OTc4MDQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-02-01T15:08:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-01T15:08:03Z"}, "message": "Rollup merge of #92021 - woodenarrow:br_single_fp_element, r=Mark-Simulacrum\n\nEliminate duplicate codes of is_single_fp_element\n\nThere are duplicate codes of is_single_fp_element function. Merge these codes to TyAndLayout impl block.\n![image](https://user-images.githubusercontent.com/95843988/146707753-ba9ffc41-5888-4a53-80cf-f4fe3bcbac54.png)", "tree": {"sha": "479a87d43b44e0b7c385a3e1d51926d95b88f3d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/479a87d43b44e0b7c385a3e1d51926d95b88f3d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/788f2969f6d2f7339c3c1e7da225d38283597804", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh+UzTCRBK7hj4Ov3rIwAAjcQIAEFdcAcSaQI+rag7dYlJh+IW\nKqbszMpVDZBHrc4B0cLMvBlpYSgSHYKkJ9iXIfXzTLtsg63dDwzpHH1ibjyBJEvp\nGF70dunOiCaBKo2ClNBYo24WN5yeeEyzcZwkd0O8HzDUKJT3DIjH9u2iGiCp+QrI\nYE2C3PiETcNYhY4670EJ0/V2HBP5rfDzDhiFlay+oi4L//yxEtftI/8EDySZgwN0\npREzDcCsPK/XpE+MLQ2RnXJmobPOpdw/aCXakMKatstjyIGuYc8TnjZQQzkXWKK7\nl3l/8C89Coxi6T4o7RO7xz7xxl1GiVtO5lIBmYtRyptG+Qq7uNZ7m+olXUyefTI=\n=YmzD\n-----END PGP SIGNATURE-----\n", "payload": "tree 479a87d43b44e0b7c385a3e1d51926d95b88f3d6\nparent a643e5980052153bdb7a8271b68bd28a2bd06126\nparent d9b98f9c2326e9916c678f252233bab5a14d0e47\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1643728083 +0100\ncommitter GitHub <noreply@github.com> 1643728083 +0100\n\nRollup merge of #92021 - woodenarrow:br_single_fp_element, r=Mark-Simulacrum\n\nEliminate duplicate codes of is_single_fp_element\n\nThere are duplicate codes of is_single_fp_element function. Merge these codes to TyAndLayout impl block.\n![image](https://user-images.githubusercontent.com/95843988/146707753-ba9ffc41-5888-4a53-80cf-f4fe3bcbac54.png)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/788f2969f6d2f7339c3c1e7da225d38283597804", "html_url": "https://github.com/rust-lang/rust/commit/788f2969f6d2f7339c3c1e7da225d38283597804", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/788f2969f6d2f7339c3c1e7da225d38283597804/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a643e5980052153bdb7a8271b68bd28a2bd06126", "url": "https://api.github.com/repos/rust-lang/rust/commits/a643e5980052153bdb7a8271b68bd28a2bd06126", "html_url": "https://github.com/rust-lang/rust/commit/a643e5980052153bdb7a8271b68bd28a2bd06126"}, {"sha": "d9b98f9c2326e9916c678f252233bab5a14d0e47", "url": "https://api.github.com/repos/rust-lang/rust/commits/d9b98f9c2326e9916c678f252233bab5a14d0e47", "html_url": "https://github.com/rust-lang/rust/commit/d9b98f9c2326e9916c678f252233bab5a14d0e47"}], "stats": {"total": 62, "additions": 22, "deletions": 40}, "files": [{"sha": "13706e8c217250a672552ddfd965721c9ad74f98", "filename": "compiler/rustc_target/src/abi/call/s390x.rs", "status": "modified", "additions": 2, "deletions": 20, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/788f2969f6d2f7339c3c1e7da225d38283597804/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fs390x.rs", "raw_url": "https://github.com/rust-lang/rust/raw/788f2969f6d2f7339c3c1e7da225d38283597804/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fs390x.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fs390x.rs?ref=788f2969f6d2f7339c3c1e7da225d38283597804", "patch": "@@ -2,7 +2,7 @@\n // for a pre-z13 machine or using -mno-vx.\n \n use crate::abi::call::{ArgAbi, FnAbi, Reg};\n-use crate::abi::{self, HasDataLayout, TyAbiInterface, TyAndLayout};\n+use crate::abi::{HasDataLayout, TyAbiInterface};\n \n fn classify_ret<Ty>(ret: &mut ArgAbi<'_, Ty>) {\n     if !ret.layout.is_aggregate() && ret.layout.size.bits() <= 64 {\n@@ -12,24 +12,6 @@ fn classify_ret<Ty>(ret: &mut ArgAbi<'_, Ty>) {\n     }\n }\n \n-fn is_single_fp_element<'a, Ty, C>(cx: &C, layout: TyAndLayout<'a, Ty>) -> bool\n-where\n-    Ty: TyAbiInterface<'a, C>,\n-    C: HasDataLayout,\n-{\n-    match layout.abi {\n-        abi::Abi::Scalar(scalar) => scalar.value.is_float(),\n-        abi::Abi::Aggregate { .. } => {\n-            if layout.fields.count() == 1 && layout.fields.offset(0).bytes() == 0 {\n-                is_single_fp_element(cx, layout.field(cx, 0))\n-            } else {\n-                false\n-            }\n-        }\n-        _ => false,\n-    }\n-}\n-\n fn classify_arg<'a, Ty, C>(cx: &C, arg: &mut ArgAbi<'a, Ty>)\n where\n     Ty: TyAbiInterface<'a, C> + Copy,\n@@ -40,7 +22,7 @@ where\n         return;\n     }\n \n-    if is_single_fp_element(cx, arg.layout) {\n+    if arg.layout.is_single_fp_element(cx) {\n         match arg.layout.size.bytes() {\n             4 => arg.cast_to(Reg::f32()),\n             8 => arg.cast_to(Reg::f64()),"}, {"sha": "d169087dfbdab26b81dd502b34d777db1d874130", "filename": "compiler/rustc_target/src/abi/call/x86.rs", "status": "modified", "additions": 2, "deletions": 20, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/788f2969f6d2f7339c3c1e7da225d38283597804/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fx86.rs", "raw_url": "https://github.com/rust-lang/rust/raw/788f2969f6d2f7339c3c1e7da225d38283597804/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fx86.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fx86.rs?ref=788f2969f6d2f7339c3c1e7da225d38283597804", "patch": "@@ -1,5 +1,5 @@\n use crate::abi::call::{ArgAttribute, FnAbi, PassMode, Reg, RegKind};\n-use crate::abi::{self, HasDataLayout, TyAbiInterface, TyAndLayout};\n+use crate::abi::{HasDataLayout, TyAbiInterface};\n use crate::spec::HasTargetSpec;\n \n #[derive(PartialEq)]\n@@ -8,24 +8,6 @@ pub enum Flavor {\n     Fastcall,\n }\n \n-fn is_single_fp_element<'a, Ty, C>(cx: &C, layout: TyAndLayout<'a, Ty>) -> bool\n-where\n-    Ty: TyAbiInterface<'a, C> + Copy,\n-    C: HasDataLayout,\n-{\n-    match layout.abi {\n-        abi::Abi::Scalar(scalar) => scalar.value.is_float(),\n-        abi::Abi::Aggregate { .. } => {\n-            if layout.fields.count() == 1 && layout.fields.offset(0).bytes() == 0 {\n-                is_single_fp_element(cx, layout.field(cx, 0))\n-            } else {\n-                false\n-            }\n-        }\n-        _ => false,\n-    }\n-}\n-\n pub fn compute_abi_info<'a, Ty, C>(cx: &C, fn_abi: &mut FnAbi<'a, Ty>, flavor: Flavor)\n where\n     Ty: TyAbiInterface<'a, C> + Copy,\n@@ -44,7 +26,7 @@ where\n             if t.abi_return_struct_as_int {\n                 // According to Clang, everyone but MSVC returns single-element\n                 // float aggregates directly in a floating-point register.\n-                if !t.is_like_msvc && is_single_fp_element(cx, fn_abi.ret.layout) {\n+                if !t.is_like_msvc && fn_abi.ret.layout.is_single_fp_element(cx) {\n                     match fn_abi.ret.layout.size.bytes() {\n                         4 => fn_abi.ret.cast_to(Reg::f32()),\n                         8 => fn_abi.ret.cast_to(Reg::f64()),"}, {"sha": "7f1fd28b30df8feabe875bbb8cd9a63fc69167dd", "filename": "compiler/rustc_target/src/abi/mod.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/788f2969f6d2f7339c3c1e7da225d38283597804/compiler%2Frustc_target%2Fsrc%2Fabi%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/788f2969f6d2f7339c3c1e7da225d38283597804/compiler%2Frustc_target%2Fsrc%2Fabi%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fabi%2Fmod.rs?ref=788f2969f6d2f7339c3c1e7da225d38283597804", "patch": "@@ -1276,6 +1276,24 @@ impl<'a, Ty> TyAndLayout<'a, Ty> {\n     {\n         Ty::ty_and_layout_pointee_info_at(self, cx, offset)\n     }\n+\n+    pub fn is_single_fp_element<C>(self, cx: &C) -> bool\n+    where\n+        Ty: TyAbiInterface<'a, C>,\n+        C: HasDataLayout,\n+    {\n+        match self.abi {\n+            Abi::Scalar(scalar) => scalar.value.is_float(),\n+            Abi::Aggregate { .. } => {\n+                if self.fields.count() == 1 && self.fields.offset(0).bytes() == 0 {\n+                    self.field(cx, 0).is_single_fp_element(cx)\n+                } else {\n+                    false\n+                }\n+            }\n+            _ => false,\n+        }\n+    }\n }\n \n impl<'a, Ty> TyAndLayout<'a, Ty> {"}]}