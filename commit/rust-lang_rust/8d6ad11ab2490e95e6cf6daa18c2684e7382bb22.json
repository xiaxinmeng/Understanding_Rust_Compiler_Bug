{"sha": "8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkNmFkMTFhYjI0OTBlOTVlNmNmNmRhYTE4YzI2ODRlNzM4MmJiMjI=", "commit": {"author": {"name": "Jan-Erik Rediger", "email": "janerik@fnordig.de", "date": "2021-02-14T15:33:03Z"}, "committer": {"name": "Ricky (deg4uss3r)", "email": "ricky@hosfelt.io", "date": "2021-02-20T21:45:00Z"}, "message": "iOS simulator: pick the target based on the environment variable\n\nLLVM picks the right things to put into the compiled object file based\non the target deployment version.\nWe need to communicate it through the target triple.\nOnly with that LLVM will use the right commands in the file to make it\nlook and behave like code compiled for the arm64 iOS simulator target.", "tree": {"sha": "86236b5eb45504eabf771577d6c5602528a13ba8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/86236b5eb45504eabf771577d6c5602528a13ba8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "comment_count": 0, "verification": {"verified": false, "reason": "no_user", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEc+Brv20PPwCixFgENuyYqioGShwFAmAxgwkACgkQNuyYqioG\nShwavw/7B+6O3jBjAHLZ3QXbRLHBvP3ORZ37Nz/7DEkC9gfwMg9Tw2Bgip01yq5q\nkwe8gNVpH5RTvkQlkP4Zc8HZ6YxPQoHB3XksLSQsKahME1CJEq+rBxM7XAI2nFc1\n7H3jMyWT7CBs8KcjmXqQbZqRYJCa5/76nQDPVjqINWCJ3Vl2tSFv4p4bKiECyzeK\nifLb703n29t+Y28ZFaveGYLd+l4aUtEHhg/Peomp8/iwdgGOhduS9r5cVCtWLPoe\nA6aysJpflDkJY3oxDFbWI7lqtoD9cBhFVQTwBdRl7d7YvCqmvEo25PWUDwEvZXdn\n0hJxsZV/t7q5AOlU4yDJNDSJlwIOfwJjqNJZFCJsvd9+xBy3/MDTGb0mTKerfGaa\nNZwR+Bp/8t5yldmSd/awQ9ibM2mDuzkcPNPchMIsWoqBjBFjD/JR15qUEzXTNs6F\nQfvgpCqf1Tas4K7q7ETnWpAW70j1tGhk9xkKnKHIgm52bgrF1b3ItgNAUqiY5lie\nmC5GhIRo6rtNJjAARgmnFZBMA8ldhJp9udnzN82Jt8to4IhW3Gv8prfv4Nj/HhFj\nu49M7s9EpOwNn+5NpNqGGOxkvZNLF4O86oXCPTPVUd29vibgCncObJUSWRJtcFOu\nEphdamTrb/UnRJk+OJ41pgSLCf5xnuBxUICDsTREj9pVH7abjL8=\n=C6rP\n-----END PGP SIGNATURE-----", "payload": "tree 86236b5eb45504eabf771577d6c5602528a13ba8\nparent f10fbbbd534e459f98a3337d1f0bf2b23d607906\nauthor Jan-Erik Rediger <janerik@fnordig.de> 1613316783 +0100\ncommitter Ricky (deg4uss3r) <ricky@hosfelt.io> 1613857500 -0500\n\niOS simulator: pick the target based on the environment variable\n\nLLVM picks the right things to put into the compiled object file based\non the target deployment version.\nWe need to communicate it through the target triple.\nOnly with that LLVM will use the right commands in the file to make it\nlook and behave like code compiled for the arm64 iOS simulator target.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "html_url": "https://github.com/rust-lang/rust/commit/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/comments", "author": {"login": "badboy", "id": 2129, "node_id": "MDQ6VXNlcjIxMjk=", "avatar_url": "https://avatars.githubusercontent.com/u/2129?v=4", "gravatar_id": "", "url": "https://api.github.com/users/badboy", "html_url": "https://github.com/badboy", "followers_url": "https://api.github.com/users/badboy/followers", "following_url": "https://api.github.com/users/badboy/following{/other_user}", "gists_url": "https://api.github.com/users/badboy/gists{/gist_id}", "starred_url": "https://api.github.com/users/badboy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/badboy/subscriptions", "organizations_url": "https://api.github.com/users/badboy/orgs", "repos_url": "https://api.github.com/users/badboy/repos", "events_url": "https://api.github.com/users/badboy/events{/privacy}", "received_events_url": "https://api.github.com/users/badboy/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f10fbbbd534e459f98a3337d1f0bf2b23d607906", "url": "https://api.github.com/repos/rust-lang/rust/commits/f10fbbbd534e459f98a3337d1f0bf2b23d607906", "html_url": "https://github.com/rust-lang/rust/commit/f10fbbbd534e459f98a3337d1f0bf2b23d607906"}], "stats": {"total": 33, "additions": 26, "deletions": 7}, "files": [{"sha": "e594ceec1b78c532ba880e2c8740ec0e2bc01a41", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios_sim.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_sim.rs?ref=8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "patch": "@@ -3,8 +3,16 @@ use crate::spec::{Target, TargetOptions};\n \n pub fn target() -> Target {\n     let base = opts(\"ios\", Arch::Arm64_sim);\n+\n+    // Clang automatically chooses a more specific target based on\n+    // IPHONEOS_DEPLOYMENT_TARGET.\n+    // This is required for the simulator target to pick the right\n+    // MACH-O commands, so we do too.\n+    let arch = \"arm64\";\n+    let llvm_target = super::apple_base::ios_sim_llvm_target(arch);\n+\n     Target {\n-        llvm_target: \"arm64-apple-ios-simulator\".to_string(),\n+        llvm_target: llvm_target,\n         pointer_width: 64,\n         data_layout: \"e-m:o-i64:64-i128:128-n32:64-S128\".to_string(),\n         arch: \"aarch64\".to_string(),"}, {"sha": "23f1357af163f22590e07fb7fed02736ab4bb552", "filename": "compiler/rustc_target/src/spec/apple_base.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_base.rs?ref=8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "patch": "@@ -54,14 +54,16 @@ pub fn opts(os: &str) -> TargetOptions {\n     }\n }\n \n-fn macos_deployment_target() -> (u32, u32) {\n-    let deployment_target = env::var(\"MACOSX_DEPLOYMENT_TARGET\").ok();\n-    let version = deployment_target\n+fn deployment_target(var_name: &str) -> Option<(u32, u32)> {\n+    let deployment_target = env::var(var_name).ok();\n+    deployment_target\n         .as_ref()\n         .and_then(|s| s.split_once('.'))\n-        .and_then(|(a, b)| a.parse::<u32>().and_then(|a| b.parse::<u32>().map(|b| (a, b))).ok());\n+        .and_then(|(a, b)| a.parse::<u32>().and_then(|a| b.parse::<u32>().map(|b| (a, b))).ok())\n+}\n \n-    version.unwrap_or((10, 7))\n+fn macos_deployment_target() -> (u32, u32) {\n+    deployment_target(\"MACOSX_DEPLOYMENT_TARGET\").unwrap_or((10, 7))\n }\n \n pub fn macos_llvm_target(arch: &str) -> String {\n@@ -84,3 +86,12 @@ pub fn macos_link_env_remove() -> Vec<String> {\n     env_remove.push(\"IPHONEOS_DEPLOYMENT_TARGET\".to_string());\n     env_remove\n }\n+\n+fn ios_deployment_target() -> (u32, u32) {\n+    deployment_target(\"IPHONEOS_DEPLOYMENT_TARGET\").unwrap_or((7, 0))\n+}\n+\n+pub fn ios_sim_llvm_target(arch: &str) -> String {\n+    let (major, minor) = ios_deployment_target();\n+    format!(\"{}-apple-ios{}.{}.0-simulator\", arch, major, minor)\n+}"}, {"sha": "ef8fe480fc4bb90257d6d5baa3e71d42fc4a31d3", "filename": "src/doc/rustc/src/platform-support.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "raw_url": "https://github.com/rust-lang/rust/raw/8d6ad11ab2490e95e6cf6daa18c2684e7382bb22/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md?ref=8d6ad11ab2490e95e6cf6daa18c2684e7382bb22", "patch": "@@ -153,7 +153,7 @@ not available.\n target | std | host | notes\n -------|-----|------|-------\n `aarch64-apple-ios-macabi` | ? |  | Apple Catalyst on ARM64\n-`aarch64-apple-ios-sim` | ? |  | Apple iOS Simulator on  ARM64\n+`aarch64-apple-ios-sim` | ? |  | Apple iOS Simulator on ARM64\n `aarch64-apple-tvos` | * |  | ARM64 tvOS\n `aarch64-unknown-freebsd` | \u2713 | \u2713 | ARM64 FreeBSD\n `aarch64-unknown-hermit` | ? |  |"}]}