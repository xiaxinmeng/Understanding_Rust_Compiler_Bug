{"sha": "a5f549eeb57da430ed48eac4d50256e8579af898", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1ZjU0OWVlYjU3ZGE0MzBlZDQ4ZWFjNGQ1MDI1NmU4NTc5YWY4OTg=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-11-10T13:45:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-10T13:45:32Z"}, "message": "Rollup merge of #78908 - liketechnik:fix_macro_expand_src_link, r=jyn514\n\n(rustdoc) [src] link for types defined by macros shows invocation, not defintion\n\nPreviously the [src] link on types defined by a macro pointed to the macro definition.\n\nThis pr makes the Clean-Implementation for Spans aware of macro defined types, so that the link points to the invocation instead.\n\nI'm not totally sure if it's okay to add the 'macro awareness' in the Clean-Implementation, because it erases that knowledge for all following code. Maybe it would be more sensible to add the check only for the link generation at https://github.com/rust-lang/rust/blob/25f6938da459a57b43bdf16ed6bdad3225b2a3ce/src/librustdoc/html/render/mod.rs#L1619\n\nCloses #39726.", "tree": {"sha": "ba2f996ab151bb1dc54810f8d9ebd6f5be7507b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba2f996ab151bb1dc54810f8d9ebd6f5be7507b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a5f549eeb57da430ed48eac4d50256e8579af898", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfqpl8CRBK7hj4Ov3rIwAAdHIIAEfR9bP1VXZcVctSg1JY+KTX\nVbNf9VOrWDJNzreTBpx8ImTSsPODBeCrdvi2UtZI63VG4v83aqFBMuBtPfGwdsMb\n+RZIoTSkA4mtCxZo0f57XpU0pXedUBXvq+Og42QhNzf0SQTvM6iN5j3wgQ807XwK\n4wylTijFyx+rs7v38ui3n4o1zl1R/VvV8tIUbSCR/jdzJib1JwsAS3e/muvssZin\nnOxGJ3E7+zRLuHoWesPO3JvjMcHVm5PeVCnJAJFO4eZ1NKgEimqfSkPD99U+EsS+\nuKEq7ZDjdk7B6VFasv5tQPFO3SXMChB3atbLLS7rkGjj/zwVUm1nnAspN9gN08Q=\n=QgVX\n-----END PGP SIGNATURE-----\n", "payload": "tree ba2f996ab151bb1dc54810f8d9ebd6f5be7507b4\nparent 6b27f0d5b9b0feb17598126f284c01f201b2c852\nparent 7beb0da4a9391facbb636a370a47d7439c8ee862\nauthor Jonas Schievink <jonasschievink@gmail.com> 1605015932 +0100\ncommitter GitHub <noreply@github.com> 1605015932 +0100\n\nRollup merge of #78908 - liketechnik:fix_macro_expand_src_link, r=jyn514\n\n(rustdoc) [src] link for types defined by macros shows invocation, not defintion\n\nPreviously the [src] link on types defined by a macro pointed to the macro definition.\n\nThis pr makes the Clean-Implementation for Spans aware of macro defined types, so that the link points to the invocation instead.\n\nI'm not totally sure if it's okay to add the 'macro awareness' in the Clean-Implementation, because it erases that knowledge for all following code. Maybe it would be more sensible to add the check only for the link generation at https://github.com/rust-lang/rust/blob/25f6938da459a57b43bdf16ed6bdad3225b2a3ce/src/librustdoc/html/render/mod.rs#L1619\n\nCloses #39726.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a5f549eeb57da430ed48eac4d50256e8579af898", "html_url": "https://github.com/rust-lang/rust/commit/a5f549eeb57da430ed48eac4d50256e8579af898", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a5f549eeb57da430ed48eac4d50256e8579af898/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b27f0d5b9b0feb17598126f284c01f201b2c852", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b27f0d5b9b0feb17598126f284c01f201b2c852", "html_url": "https://github.com/rust-lang/rust/commit/6b27f0d5b9b0feb17598126f284c01f201b2c852"}, {"sha": "7beb0da4a9391facbb636a370a47d7439c8ee862", "url": "https://api.github.com/repos/rust-lang/rust/commits/7beb0da4a9391facbb636a370a47d7439c8ee862", "html_url": "https://github.com/rust-lang/rust/commit/7beb0da4a9391facbb636a370a47d7439c8ee862"}], "stats": {"total": 24, "additions": 13, "deletions": 11}, "files": [{"sha": "ec7932d8bbfa4c1d9611803a3a80579b2ef58edf", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=a5f549eeb57da430ed48eac4d50256e8579af898", "patch": "@@ -1967,18 +1967,23 @@ impl Clean<Span> for rustc_span::Span {\n             return Span::empty();\n         }\n \n+        // Get the macro invocation instead of the definition,\n+        // in case the span is result of a macro expansion.\n+        // (See rust-lang/rust#39726)\n+        let span = self.source_callsite();\n+\n         let sm = cx.sess().source_map();\n-        let filename = sm.span_to_filename(*self);\n-        let lo = sm.lookup_char_pos(self.lo());\n-        let hi = sm.lookup_char_pos(self.hi());\n+        let filename = sm.span_to_filename(span);\n+        let lo = sm.lookup_char_pos(span.lo());\n+        let hi = sm.lookup_char_pos(span.hi());\n         Span {\n             filename,\n             cnum: lo.file.cnum,\n             loline: lo.line,\n             locol: lo.col.to_usize(),\n             hiline: hi.line,\n             hicol: hi.col.to_usize(),\n-            original: *self,\n+            original: span,\n         }\n     }\n }"}, {"sha": "6a7dbb004a3626c29d5fc3d86fa3cda27c03bbff", "filename": "src/test/rustdoc/external-macro-src.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Ftest%2Frustdoc%2Fexternal-macro-src.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Ftest%2Frustdoc%2Fexternal-macro-src.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fexternal-macro-src.rs?ref=a5f549eeb57da430ed48eac4d50256e8579af898", "patch": "@@ -1,15 +1,12 @@\n // aux-build:external-macro-src.rs\n-// ignore-tidy-linelength\n \n #![crate_name = \"foo\"]\n \n #[macro_use]\n extern crate external_macro_src;\n \n-// @has foo/index.html '//a[@href=\"../src/foo/external-macro-src.rs.html#4-15\"]' '[src]'\n+// @has foo/index.html '//a[@href=\"../src/foo/external-macro-src.rs.html#3-12\"]' '[src]'\n \n // @has foo/struct.Foo.html\n-// @has - '//a[@href=\"https://example.com/src/external_macro_src/external-macro-src.rs.html#8\"]' '[src]'\n-// @has - '//a[@href=\"https://example.com/src/external_macro_src/external-macro-src.rs.html#9-13\"]' '[src]'\n-// @has - '//a[@href=\"https://example.com/src/external_macro_src/external-macro-src.rs.html#10-12\"]' '[src]'\n+// @has - '//a[@href=\"../src/foo/external-macro-src.rs.html#12\"]' '[src]'\n make_foo!();"}, {"sha": "bd6f38e912338226d93b5f997f603f29f279158e", "filename": "src/test/rustdoc/issue-26606.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Ftest%2Frustdoc%2Fissue-26606.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Ftest%2Frustdoc%2Fissue-26606.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-26606.rs?ref=a5f549eeb57da430ed48eac4d50256e8579af898", "patch": "@@ -7,5 +7,5 @@\n extern crate issue_26606_macro;\n \n // @has issue_26606/constant.FOO.html\n-// @has - '//a/@href' '../src/issue_26606_macro/issue-26606-macro.rs.html#3'\n+// @has - '//a[@href=\"../src/issue_26606/issue-26606.rs.html#11\"]' '[src]'\n make_item!(FOO);"}, {"sha": "5e56bb5819a104b55acc98780074265dfc32bd9f", "filename": "src/test/rustdoc/thread-local-src.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Ftest%2Frustdoc%2Fthread-local-src.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5f549eeb57da430ed48eac4d50256e8579af898/src%2Ftest%2Frustdoc%2Fthread-local-src.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fthread-local-src.rs?ref=a5f549eeb57da430ed48eac4d50256e8579af898", "patch": "@@ -2,5 +2,5 @@\n \n // @has foo/index.html '//a[@href=\"../src/foo/thread-local-src.rs.html#1-6\"]' '[src]'\n \n-// @has foo/constant.FOO.html '//a/@href' 'https://doc.rust-lang.org/nightly/src/std/'\n+// @has foo/constant.FOO.html '//a[@href=\"../src/foo/thread-local-src.rs.html#6\"]' '[src]'\n thread_local!(pub static FOO: bool = false);"}]}