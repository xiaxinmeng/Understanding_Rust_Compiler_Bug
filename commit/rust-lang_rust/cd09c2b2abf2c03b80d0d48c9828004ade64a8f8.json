{"sha": "cd09c2b2abf2c03b80d0d48c9828004ade64a8f8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNkMDljMmIyYWJmMmMwM2I4MGQwZDQ4Yzk4MjgwMDRhZGU2NGE4Zjg=", "commit": {"author": {"name": "nabijaczleweli", "email": "nabijaczleweli@gmail.com", "date": "2018-03-27T21:09:35Z"}, "committer": {"name": "nabijaczleweli", "email": "nabijaczleweli@gmail.com", "date": "2018-03-29T14:47:06Z"}, "message": "Flush executables to disk after linkage\n\nA problem caused by not doing so in Chrome has been reported here:\nhttps://randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/amp/\n\nFile::sync_all() calls FlushFileBuffers() down the line,\ncausing potentially unflushed buffers on high I/O-load systems to flush\nand prevent nasty non-reproducible bugs.\n\nThe force-flush is only done on Windows and if the linker exited successfully\n\nCloses #48545", "tree": {"sha": "a290abc315a36216eaeb4ef0ab3eea8babc0fe85", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a290abc315a36216eaeb4ef0ab3eea8babc0fe85"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd09c2b2abf2c03b80d0d48c9828004ade64a8f8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJavPyNAAoJELz9CwGNJljx+/8P/i5x9SmcHgJBDlNbU1AIEUMd\nG+RDyVn1ZcTZb7ybRgMjtYx8Qwk4ckCrmEfnk+FQPt4tuPlxvuXKycOv6pSURqbQ\nONwXvKuLdc+zmcSzgalb6/+jDC4hU/lOc0HSCPaylQvy55tJBXdYsXT9mdsDYlOT\nB+DajPlxdGJJvbWhuu5xAaz7fxKhO2o0jinkha9JEEU6pQwxxJxw9YUL2Ogks5eh\nPh8t/4WNlR91P+3ON37eUa+RAF2ZBykb86cz/Oui0OJKbo5YqWA6+ipqmQ8FSQe5\n9gqvsVO5+6l99Qa7aBGWGV0yoVL8Cndq0P/XjTLRgPKBgyaNcqgTpXXz0A7sAQ9S\n0CtLvHKOtbJclpr+Eu4LX57CqWbVRFTIAGb9EPNNliJI2eMvNl1xu88VPCIF0Dy5\nSBExEXcdqdsrl/miwkGzI2whuoI40vK4HuNODV4nubjOu63s4qMV7n89XElay58J\noplLskG6UcZvJiltOWdDspRPMFQqWveCIOG16fmuEOnExeDL7ViojMzPWrLyUOpG\nTvPnBLL0ZcDONINR8LyLC37MR6A4V52CrYISXgq/qj+APfGRlrqxVvMYx2n62Rth\nhaWSwn1lq0Swf+1FIPxjbaji1dyh41pbeMyoJlv8GVPKZWDyBr8WaABKR14DB2Vp\nykG8VLFxsiwePjbzUYSL\n=c6GF\n-----END PGP SIGNATURE-----", "payload": "tree a290abc315a36216eaeb4ef0ab3eea8babc0fe85\nparent 9c9424de51da41fd3d1077ac7810276f8dc746fa\nauthor nabijaczleweli <nabijaczleweli@gmail.com> 1522184975 +0200\ncommitter nabijaczleweli <nabijaczleweli@gmail.com> 1522334826 +0200\n\nFlush executables to disk after linkage\n\nA problem caused by not doing so in Chrome has been reported here:\nhttps://randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/amp/\n\nFile::sync_all() calls FlushFileBuffers() down the line,\ncausing potentially unflushed buffers on high I/O-load systems to flush\nand prevent nasty non-reproducible bugs.\n\nThe force-flush is only done on Windows and if the linker exited successfully\n\nCloses #48545\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd09c2b2abf2c03b80d0d48c9828004ade64a8f8", "html_url": "https://github.com/rust-lang/rust/commit/cd09c2b2abf2c03b80d0d48c9828004ade64a8f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd09c2b2abf2c03b80d0d48c9828004ade64a8f8/comments", "author": {"login": "nabijaczleweli", "id": 6709544, "node_id": "MDQ6VXNlcjY3MDk1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6709544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nabijaczleweli", "html_url": "https://github.com/nabijaczleweli", "followers_url": "https://api.github.com/users/nabijaczleweli/followers", "following_url": "https://api.github.com/users/nabijaczleweli/following{/other_user}", "gists_url": "https://api.github.com/users/nabijaczleweli/gists{/gist_id}", "starred_url": "https://api.github.com/users/nabijaczleweli/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nabijaczleweli/subscriptions", "organizations_url": "https://api.github.com/users/nabijaczleweli/orgs", "repos_url": "https://api.github.com/users/nabijaczleweli/repos", "events_url": "https://api.github.com/users/nabijaczleweli/events{/privacy}", "received_events_url": "https://api.github.com/users/nabijaczleweli/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nabijaczleweli", "id": 6709544, "node_id": "MDQ6VXNlcjY3MDk1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6709544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nabijaczleweli", "html_url": "https://github.com/nabijaczleweli", "followers_url": "https://api.github.com/users/nabijaczleweli/followers", "following_url": "https://api.github.com/users/nabijaczleweli/following{/other_user}", "gists_url": "https://api.github.com/users/nabijaczleweli/gists{/gist_id}", "starred_url": "https://api.github.com/users/nabijaczleweli/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nabijaczleweli/subscriptions", "organizations_url": "https://api.github.com/users/nabijaczleweli/orgs", "repos_url": "https://api.github.com/users/nabijaczleweli/repos", "events_url": "https://api.github.com/users/nabijaczleweli/events{/privacy}", "received_events_url": "https://api.github.com/users/nabijaczleweli/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c9424de51da41fd3d1077ac7810276f8dc746fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c9424de51da41fd3d1077ac7810276f8dc746fa", "html_url": "https://github.com/rust-lang/rust/commit/9c9424de51da41fd3d1077ac7810276f8dc746fa"}], "stats": {"total": 36, "additions": 33, "deletions": 3}, "files": [{"sha": "33f6ce9975e53e8b3b79cd8db72d6e0e9d1cb397", "filename": "src/librustc_trans/back/link.rs", "status": "modified", "additions": 33, "deletions": 3, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/cd09c2b2abf2c03b80d0d48c9828004ade64a8f8/src%2Flibrustc_trans%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd09c2b2abf2c03b80d0d48c9828004ade64a8f8/src%2Flibrustc_trans%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flink.rs?ref=cd09c2b2abf2c03b80d0d48c9828004ade64a8f8", "patch": "@@ -692,7 +692,7 @@ fn link_natively(sess: &Session,\n     loop {\n         i += 1;\n         prog = time(sess, \"running linker\", || {\n-            exec_linker(sess, &mut cmd, tmpdir)\n+            exec_linker(sess, &mut cmd, out_filename, tmpdir)\n         });\n         let output = match prog {\n             Ok(ref output) => output,\n@@ -819,7 +819,7 @@ fn link_natively(sess: &Session,\n     }\n }\n \n-fn exec_linker(sess: &Session, cmd: &mut Command, tmpdir: &Path)\n+fn exec_linker(sess: &Session, cmd: &mut Command, out_filename: &Path, tmpdir: &Path)\n     -> io::Result<Output>\n {\n     // When attempting to spawn the linker we run a risk of blowing out the\n@@ -867,7 +867,37 @@ fn exec_linker(sess: &Session, cmd: &mut Command, tmpdir: &Path)\n     fs::write(&file, &bytes)?;\n     cmd2.arg(format!(\"@{}\", file.display()));\n     info!(\"invoking linker {:?}\", cmd2);\n-    return cmd2.output();\n+    let output = cmd2.output();\n+    flush_linked_file(&output, out_filename)?;\n+    return output;\n+\n+    #[cfg(unix)]\n+    fn flush_linked_file(_: &io::Result<Output>, _: &Path) -> io::Result<()> {\n+        Ok(())\n+    }\n+\n+    #[cfg(windows)]\n+    fn flush_linked_file(command_output: &io::Result<Output>, out_filename: &Path)\n+        -> io::Result<()>\n+    {\n+        // On Windows, under high I/O load, output buffers are sometimes not flushed,\n+        // even long after process exit, causing nasty, non-reproducible output bugs.\n+        //\n+        // File::sync_all() calls FlushFileBuffers() down the line, which solves the problem.\n+        //\n+        // \u0410 full writeup of the original Chrome bug can be found at\n+        // randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/amp\n+\n+        if let &Ok(ref out) = command_output {\n+            if out.status.success() {\n+                if let Ok(of) = fs::File::open(out_filename) {\n+                    of.sync_all()?;\n+                }\n+            }\n+        }\n+\n+        Ok(())\n+    }\n \n     #[cfg(unix)]\n     fn command_line_too_big(err: &io::Error) -> bool {"}]}