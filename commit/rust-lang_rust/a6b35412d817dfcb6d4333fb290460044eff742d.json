{"sha": "a6b35412d817dfcb6d4333fb290460044eff742d", "node_id": "C_kwDOAAsO6NoAKGE2YjM1NDEyZDgxN2RmY2I2ZDQzMzNmYjI5MDQ2MDA0NGVmZjc0MmQ", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-07-18T14:38:26Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-07-22T11:18:34Z"}, "message": "adjust for symbolic vtables", "tree": {"sha": "917a3e2df92774b2ab329b48f41beb52f1dbe725", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/917a3e2df92774b2ab329b48f41beb52f1dbe725"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6b35412d817dfcb6d4333fb290460044eff742d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6b35412d817dfcb6d4333fb290460044eff742d", "html_url": "https://github.com/rust-lang/rust/commit/a6b35412d817dfcb6d4333fb290460044eff742d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6b35412d817dfcb6d4333fb290460044eff742d/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9cab7979f8de065ec000a944fdf245cea2103af8", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cab7979f8de065ec000a944fdf245cea2103af8", "html_url": "https://github.com/rust-lang/rust/commit/9cab7979f8de065ec000a944fdf245cea2103af8"}], "stats": {"total": 96, "additions": 47, "deletions": 49}, "files": [{"sha": "aa7111cb81fc68f9395ff53a170425bb65c897f0", "filename": "src/intptrcast.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fintptrcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fintptrcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fintptrcast.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -86,7 +86,9 @@ impl<'mir, 'tcx> GlobalStateInner {\n         if global_state.exposed.contains(&alloc_id) {\n             let (_size, _align, kind) = ecx.get_alloc_info(alloc_id);\n             match kind {\n-                AllocKind::LiveData | AllocKind::Function => return Some(alloc_id),\n+                AllocKind::LiveData | AllocKind::Function | AllocKind::VTable => {\n+                    return Some(alloc_id);\n+                }\n                 AllocKind::Dead => {}\n             }\n         }\n@@ -187,8 +189,8 @@ impl<'mir, 'tcx> GlobalStateInner {\n \n                 // Remember next base address.  If this allocation is zero-sized, leave a gap\n                 // of at least 1 to avoid two allocations having the same base address.\n-                // (The logic in `alloc_id_from_addr` assumes unique addresses, and function\n-                // pointers to different functions need to be distinguishable!)\n+                // (The logic in `alloc_id_from_addr` assumes unique addresses, and different\n+                // function/vtable pointers need to be distinguishable!)\n                 global_state.next_base_addr = base_addr.checked_add(max(size.bytes(), 1)).unwrap();\n                 // Given that `next_base_addr` increases in each allocation, pushing the\n                 // corresponding tuple keeps `int_to_ptr_map` sorted"}, {"sha": "40f4c9ed90c00623261041c09c899f8792ea79a6", "filename": "src/machine.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmachine.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -733,7 +733,7 @@ impl<'mir, 'tcx> Machine<'mir, 'tcx> for Evaluator<'mir, 'tcx> {\n         if cfg!(debug_assertions) {\n             // The machine promises to never call us on thread-local or extern statics.\n             let alloc_id = ptr.provenance;\n-            match ecx.tcx.get_global_alloc(alloc_id) {\n+            match ecx.tcx.try_get_global_alloc(alloc_id) {\n                 Some(GlobalAlloc::Static(def_id)) if ecx.tcx.is_thread_local_static(def_id) => {\n                     panic!(\"adjust_alloc_base_pointer called on thread-local static\")\n                 }"}, {"sha": "54ab8665ce35c706c4a355e55ae59b8dea1c2179", "filename": "src/shims/backtrace.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fshims%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fshims%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fbacktrace.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -122,15 +122,17 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         let this = self.eval_context_mut();\n \n         let ptr = this.read_pointer(ptr)?;\n-        // Take apart the pointer, we need its pieces.\n+        // Take apart the pointer, we need its pieces. The offset encodes the span.\n         let (alloc_id, offset, _prov) = this.ptr_get_alloc_id(ptr)?;\n \n-        let fn_instance =\n-            if let Some(GlobalAlloc::Function(instance)) = this.tcx.get_global_alloc(alloc_id) {\n-                instance\n-            } else {\n-                throw_ub_format!(\"expected function pointer, found {:?}\", ptr);\n-            };\n+        // This has to be an actual global fn ptr, not a dlsym function.\n+        let fn_instance = if let Some(GlobalAlloc::Function(instance)) =\n+            this.tcx.try_get_global_alloc(alloc_id)\n+        {\n+            instance\n+        } else {\n+            throw_ub_format!(\"expected static function pointer, found {:?}\", ptr);\n+        };\n \n         let lo =\n             this.tcx.sess.source_map().lookup_char_pos(BytePos(offset.bytes().try_into().unwrap()));"}, {"sha": "624b32dfd495760f806bc28fbe7a5bb99c1d9a40", "filename": "src/stacked_borrows/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fstacked_borrows%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/src%2Fstacked_borrows%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstacked_borrows%2Fmod.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -799,7 +799,7 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                         stacked_borrows.history.log_protector(orig_tag, new_tag, current_span);\n                     }\n                 }\n-                AllocKind::Function | AllocKind::Dead => {\n+                AllocKind::Function | AllocKind::VTable | AllocKind::Dead => {\n                     // No stacked borrows on these allocations.\n                 }\n             }\n@@ -1143,7 +1143,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 trace!(\"Stacked Borrows tag {tag:?} exposed in {alloc_id:?}\");\n                 alloc_extra.stacked_borrows.as_ref().unwrap().borrow_mut().exposed_tags.insert(tag);\n             }\n-            AllocKind::Function | AllocKind::Dead => {\n+            AllocKind::Function | AllocKind::VTable | AllocKind::Dead => {\n                 // No stacked borrows on these allocations.\n             }\n         }"}, {"sha": "387253a3f9872e7c4a0a3f51dfdab9571db7f58b", "filename": "tests/fail/issue-miri-1112.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fissue-miri-1112.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fissue-miri-1112.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fissue-miri-1112.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -28,7 +28,7 @@ impl FunnyPointer {\n             data: data as *const _ as *const (),\n             vtable: ptr as *const _ as *const (),\n         };\n-        let obj = std::mem::transmute::<FatPointer, *mut FunnyPointer>(obj); //~ ERROR: invalid drop function pointer in vtable\n+        let obj = std::mem::transmute::<FatPointer, *mut FunnyPointer>(obj); //~ ERROR: expected a vtable pointer\n         &*obj\n     }\n }"}, {"sha": "4a2bdb0f414d44bdf8b3cc80f2c9d42b4cbf948a", "filename": "tests/fail/issue-miri-1112.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fissue-miri-1112.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fissue-miri-1112.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fissue-miri-1112.stderr?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -1,8 +1,8 @@\n-error: Undefined Behavior: constructing invalid value: encountered invalid drop function pointer in vtable (function has incompatible signature)\n+error: Undefined Behavior: constructing invalid value: encountered $HEX[ALLOC]<TAG>, but expected a vtable pointer\n   --> $DIR/issue-miri-1112.rs:LL:CC\n    |\n LL |         let obj = std::mem::transmute::<FatPointer, *mut FunnyPointer>(obj);\n-   |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ constructing invalid value: encountered invalid drop function pointer in vtable (function has incompatible signature)\n+   |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ constructing invalid value: encountered $HEX[ALLOC]<TAG>, but expected a vtable pointer\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior\n    = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information"}, {"sha": "534f811e48abe233db9855192ea24e4bc76e2d28", "filename": "tests/fail/stacked_borrows/vtable.stderr", "status": "removed", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/9cab7979f8de065ec000a944fdf245cea2103af8/tests%2Ffail%2Fstacked_borrows%2Fvtable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9cab7979f8de065ec000a944fdf245cea2103af8/tests%2Ffail%2Fstacked_borrows%2Fvtable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fstacked_borrows%2Fvtable.stderr?ref=9cab7979f8de065ec000a944fdf245cea2103af8", "patch": "@@ -1,25 +0,0 @@\n-error: Undefined Behavior: constructing invalid value: encountered vtable pointer does not have permission to read drop function pointer\n-  --> RUSTLIB/core/src/ptr/metadata.rs:LL:CC\n-   |\n-LL |     unsafe { PtrRepr { components: PtrComponents { data_address, metadata } }.const_ptr }\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ constructing invalid value: encountered vtable pointer does not have permission to read drop function pointer\n-   |\n-   = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior\n-   = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information\n-   = note: backtrace:\n-   = note: inside `std::ptr::from_raw_parts::<dyn Foo>` at RUSTLIB/core/src/ptr/metadata.rs:LL:CC\n-note: inside `uwu` at $DIR/vtable.rs:LL:CC\n-  --> $DIR/vtable.rs:LL:CC\n-   |\n-LL |     core::ptr::from_raw_parts(thin, unsafe { core::mem::transmute(meta) })\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-note: inside `main` at $DIR/vtable.rs:LL:CC\n-  --> $DIR/vtable.rs:LL:CC\n-   |\n-LL |         let _ = uwu(ptr, core::mem::transmute(meta));\n-   |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n-note: some details are omitted, run with `MIRIFLAGS=-Zmiri-backtrace=full` for a verbose backtrace\n-\n-error: aborting due to previous error\n-"}, {"sha": "2ad972a9d4d7d6a2f5ebf44d82c5550329e6a327", "filename": "tests/fail/validity/invalid_wide_raw.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fvalidity%2Finvalid_wide_raw.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fvalidity%2Finvalid_wide_raw.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fvalidity%2Finvalid_wide_raw.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -7,5 +7,5 @@ fn main() {\n         #[allow(dead_code)]\n         x: *mut dyn T,\n     }\n-    dbg!(S { x: unsafe { std::mem::transmute((0usize, 0usize)) } }); //~ ERROR: encountered dangling vtable pointer in wide pointer\n+    dbg!(S { x: unsafe { std::mem::transmute((0usize, 0usize)) } }); //~ ERROR: encountered null pointer, but expected a vtable pointer\n }"}, {"sha": "304008f65163147b2fbe3a90ef2441b15337e1dc", "filename": "tests/fail/validity/invalid_wide_raw.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fvalidity%2Finvalid_wide_raw.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Ffail%2Fvalidity%2Finvalid_wide_raw.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fvalidity%2Finvalid_wide_raw.stderr?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -1,8 +1,8 @@\n-error: Undefined Behavior: constructing invalid value: encountered dangling vtable pointer in wide pointer\n+error: Undefined Behavior: constructing invalid value: encountered null pointer, but expected a vtable pointer\n   --> $DIR/invalid_wide_raw.rs:LL:CC\n    |\n LL |     dbg!(S { x: unsafe { std::mem::transmute((0usize, 0usize)) } });\n-   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ constructing invalid value: encountered dangling vtable pointer in wide pointer\n+   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ constructing invalid value: encountered null pointer, but expected a vtable pointer\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior\n    = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information"}, {"sha": "9740d2c9ee8ed9fd4e18648c845a0972b9af406f", "filename": "tests/pass/issues/issue-miri-2123.rs", "status": "renamed", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Fpass%2Fissues%2Fissue-miri-2123.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Fpass%2Fissues%2Fissue-miri-2123.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpass%2Fissues%2Fissue-miri-2123.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -1,19 +1,21 @@\n-//@error-pattern: vtable pointer does not have permission\n-#![feature(ptr_metadata)]\n+#![feature(ptr_metadata, layout_for_ptr)]\n+\n+use std::{mem, ptr};\n \n trait Foo {}\n \n impl Foo for u32 {}\n \n fn uwu(thin: *const (), meta: &'static ()) -> *const dyn Foo {\n-    core::ptr::from_raw_parts(thin, unsafe { core::mem::transmute(meta) })\n+    ptr::from_raw_parts(thin, unsafe { mem::transmute(meta) })\n }\n \n fn main() {\n     unsafe {\n         let orig = 1_u32;\n         let x = &orig as &dyn Foo;\n         let (ptr, meta) = (x as *const dyn Foo).to_raw_parts();\n-        let _ = uwu(ptr, core::mem::transmute(meta));\n+        let ptr = uwu(ptr, mem::transmute(meta));\n+        mem::size_of_val_raw(ptr);\n     }\n }", "previous_filename": "tests/fail/stacked_borrows/vtable.rs"}, {"sha": "a271e764d9f4aa8a1ee3f5e9272e05b12524d103", "filename": "tests/pass/pointers.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Fpass%2Fpointers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6b35412d817dfcb6d4333fb290460044eff742d/tests%2Fpass%2Fpointers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpass%2Fpointers.rs?ref=a6b35412d817dfcb6d4333fb290460044eff742d", "patch": "@@ -1,4 +1,7 @@\n-use std::mem::transmute;\n+#![feature(ptr_metadata)]\n+\n+use std::mem::{self, transmute};\n+use std::ptr;\n \n fn one_line_ref() -> i16 {\n     *&1\n@@ -71,6 +74,19 @@ fn wide_ptr_ops() {\n     assert!(!(a > b));\n }\n \n+fn metadata_vtable() {\n+    let p = &0i32 as &dyn std::fmt::Debug;\n+    let meta: ptr::DynMetadata<_> = ptr::metadata(p as *const _);\n+    assert_eq!(meta.size_of(), mem::size_of::<i32>());\n+    assert_eq!(meta.align_of(), mem::align_of::<i32>());\n+\n+    type T = [i32; 16];\n+    let p = &T::default() as &dyn std::fmt::Debug;\n+    let meta: ptr::DynMetadata<_> = ptr::metadata(p as *const _);\n+    assert_eq!(meta.size_of(), mem::size_of::<T>());\n+    assert_eq!(meta.align_of(), mem::align_of::<T>());\n+}\n+\n fn main() {\n     assert_eq!(one_line_ref(), 1);\n     assert_eq!(basic_ref(), 1);\n@@ -116,4 +132,5 @@ fn main() {\n     assert!(dangling >= 4);\n \n     wide_ptr_ops();\n+    metadata_vtable();\n }"}]}