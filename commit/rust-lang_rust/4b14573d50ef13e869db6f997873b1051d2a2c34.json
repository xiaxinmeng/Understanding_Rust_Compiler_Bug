{"sha": "4b14573d50ef13e869db6f997873b1051d2a2c34", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRiMTQ1NzNkNTBlZjEzZTg2OWRiNmY5OTc4NzNiMTA1MWQyYTJjMzQ=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-05-10T22:02:05Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-05-12T17:15:06Z"}, "message": "Add minification process", "tree": {"sha": "bc6c87f6b9d7c983e51422bae15fcf72d4a1fdb5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc6c87f6b9d7c983e51422bae15fcf72d4a1fdb5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4b14573d50ef13e869db6f997873b1051d2a2c34", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4b14573d50ef13e869db6f997873b1051d2a2c34", "html_url": "https://github.com/rust-lang/rust/commit/4b14573d50ef13e869db6f997873b1051d2a2c34", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4b14573d50ef13e869db6f997873b1051d2a2c34/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8a3ec1ce6dc12f86de39bf5ac55fc2fa38358f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8a3ec1ce6dc12f86de39bf5ac55fc2fa38358f8", "html_url": "https://github.com/rust-lang/rust/commit/c8a3ec1ce6dc12f86de39bf5ac55fc2fa38358f8"}], "stats": {"total": 71, "additions": 53, "deletions": 18}, "files": [{"sha": "1746621661c752ad19085cf7219b9b9746b309b6", "filename": "src/Cargo.lock", "status": "modified", "additions": 15, "deletions": 5, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.lock?ref=4b14573d50ef13e869db6f997873b1051d2a2c34", "patch": "@@ -233,7 +233,7 @@ dependencies = [\n  \"serde_json 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"shell-escape 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"tar 0.4.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"tempfile 3.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"tempfile 3.0.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"termcolor 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"toml 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"url 1.7.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -417,7 +417,7 @@ dependencies = [\n  \"serde 1.0.40 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_derive 1.0.40 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_json 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"tempfile 3.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"tempfile 3.0.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n@@ -1169,7 +1169,7 @@ dependencies = [\n  \"serde_derive 1.0.40 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_json 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"shlex 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"tempfile 3.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"tempfile 3.0.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"toml 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"toml-query 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -1187,6 +1187,14 @@ name = \"memoffset\"\n version = \"0.2.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"minifier\"\n+version = \"0.0.11\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"regex 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"miniz-sys\"\n version = \"0.1.10\"\n@@ -2222,6 +2230,7 @@ dependencies = [\n name = \"rustdoc\"\n version = \"0.0.0\"\n dependencies = [\n+ \"minifier 0.0.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"pulldown-cmark 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -2654,7 +2663,7 @@ dependencies = [\n \n [[package]]\n name = \"tempfile\"\n-version = \"3.0.1\"\n+version = \"3.0.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"libc 0.2.40 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -3099,6 +3108,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum mdbook 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\" = \"90b5a8d7e341ceee5db3882a06078d42661ddcfa2b3687319cc5da76ec4e782f\"\n \"checksum memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"796fba70e76612589ed2ce7f45282f5af869e0fdd7cc6199fa1aa1f1d591ba9d\"\n \"checksum memoffset 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0f9dc261e2b62d7a622bf416ea3c5245cdd5d9a7fcc428c0d06804dfce1775b3\"\n+\"checksum minifier 0.0.11 (registry+https://github.com/rust-lang/crates.io-index)\" = \"26f3e36a4db1981b16567e4abfd6ddc3641bc9b950bdc868701f656bf9b74bdd\"\n \"checksum miniz-sys 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)\" = \"609ce024854aeb19a0ef7567d348aaa5a746b32fb72e336df7fcc16869d7e2b4\"\n \"checksum miow 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9224c91f82b3c47cf53dcf78dfaa20d6888fbcc5d272d5f2fcdf8a697f3c987d\"\n \"checksum nibble_vec 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c8d77f3db4bce033f4d04db08079b2ef1c3d02b44e86f25d08886fafa7756ffa\"\n@@ -3197,7 +3207,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum syntex_syntax 0.52.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"76a302e717e348aa372ff577791c3832395650073b8d8432f8b3cb170b34afde\"\n \"checksum tar 0.4.15 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6af6b94659f9a571bf769a5b71f54079393585ee0bfdd71b691be22d7d6b1d18\"\n \"checksum tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)\" = \"15f2b5fb00ccdf689e0149d1b1b3c03fead81c2b37735d812fa8bddbbf41b6d8\"\n-\"checksum tempfile 3.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"8cddbd26c5686ece823b507f304c8f188daef548b4cb753512d929ce478a093c\"\n+\"checksum tempfile 3.0.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"47776f63b85777d984a50ce49d6b9e58826b6a3766a449fc95bc66cd5663c15b\"\n \"checksum tendril 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9de21546595a0873061940d994bbbc5c35f024ae4fd61ec5c5b159115684f508\"\n \"checksum term 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"fa63644f74ce96fbeb9b794f66aff2a52d601cbd5e80f4b97123e3899f4570f1\"\n \"checksum term 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5e6b677dd1e8214ea1ef4297f85dbcbed8e8cdddb561040cc998ca2551c37561\""}, {"sha": "96a2194eeeefda76809b53d0d986462a17ca6e71", "filename": "src/librustdoc/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2FCargo.toml?ref=4b14573d50ef13e869db6f997873b1051d2a2c34", "patch": "@@ -10,3 +10,4 @@ path = \"lib.rs\"\n [dependencies]\n pulldown-cmark = { version = \"0.1.2\", default-features = false }\n tempdir = \"0.3\"\n+minifier = \"0.0.11\""}, {"sha": "f945534c409d89cd1c16e0180137e88e1a722c89", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 26, "deletions": 10, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=4b14573d50ef13e869db6f997873b1051d2a2c34", "patch": "@@ -76,6 +76,8 @@ use html::item_type::ItemType;\n use html::markdown::{self, Markdown, MarkdownHtml, MarkdownSummaryLine};\n use html::{highlight, layout};\n \n+use minifier;\n+\n /// A pair of name and its optional document.\n pub type NameDoc = (String, Option<String>);\n \n@@ -509,7 +511,8 @@ pub fn run(mut krate: clean::Crate,\n            css_file_extension: Option<PathBuf>,\n            renderinfo: RenderInfo,\n            sort_modules_alphabetically: bool,\n-           themes: Vec<PathBuf>) -> Result<(), Error> {\n+           themes: Vec<PathBuf>,\n+           enable_minification: bool) -> Result<(), Error> {\n     let src_root = match krate.src {\n         FileName::Real(ref p) => match p.parent() {\n             Some(p) => p.to_path_buf(),\n@@ -661,7 +664,7 @@ pub fn run(mut krate: clean::Crate,\n     CACHE_KEY.with(|v| *v.borrow_mut() = cache.clone());\n     CURRENT_LOCATION_KEY.with(|s| s.borrow_mut().clear());\n \n-    write_shared(&cx, &krate, &*cache, index)?;\n+    write_shared(&cx, &krate, &*cache, index, enable_minification)?;\n \n     // And finally render the whole crate's documentation\n     cx.krate(krate)\n@@ -740,7 +743,8 @@ fn build_index(krate: &clean::Crate, cache: &mut Cache) -> String {\n fn write_shared(cx: &Context,\n                 krate: &clean::Crate,\n                 cache: &Cache,\n-                search_index: String) -> Result<(), Error> {\n+                search_index: String,\n+                enable_minification: bool) -> Result<(), Error> {\n     // Write out the shared files. Note that these are shared among all rustdoc\n     // docs placed in the output directory, so this needs to be a synchronized\n     // operation with respect to all other rustdocs running around.\n@@ -814,16 +818,20 @@ themePicker.onclick = function() {{\n                        .join(\",\")).as_bytes(),\n     )?;\n \n-    write(cx.dst.join(&format!(\"main{}.js\", cx.shared.resource_suffix)),\n-                      include_bytes!(\"static/main.js\"))?;\n-    write(cx.dst.join(&format!(\"settings{}.js\", cx.shared.resource_suffix)),\n-                      include_bytes!(\"static/settings.js\"))?;\n+    write_minify(cx.dst.join(&format!(\"main{}.js\", cx.shared.resource_suffix)),\n+                 include_str!(\"static/main.js\"),\n+                 enable_minification)?;\n+    write_minify(cx.dst.join(&format!(\"settings{}.js\", cx.shared.resource_suffix)),\n+                 include_str!(\"static/settings.js\"),\n+                 enable_minification)?;\n \n     {\n         let mut data = format!(\"var resourcesSuffix = \\\"{}\\\";\\n\",\n-                               cx.shared.resource_suffix).into_bytes();\n-        data.extend_from_slice(include_bytes!(\"static/storage.js\"));\n-        write(cx.dst.join(&format!(\"storage{}.js\", cx.shared.resource_suffix)), &data)?;\n+                               cx.shared.resource_suffix);\n+        data.push_str(include_str!(\"static/storage.js\"));\n+        write_minify(cx.dst.join(&format!(\"storage{}.js\", cx.shared.resource_suffix)),\n+                     &data,\n+                     enable_minification)?;\n     }\n \n     if let Some(ref css) = cx.shared.css_file_extension {\n@@ -1020,6 +1028,14 @@ fn write(dst: PathBuf, contents: &[u8]) -> Result<(), Error> {\n     Ok(try_err!(fs::write(&dst, contents), &dst))\n }\n \n+fn write_minify(dst: PathBuf, contents: &str, enable_minification: bool) -> Result<(), Error> {\n+    if enable_minification {\n+        write(dst, minifier::js::minify(contents).as_bytes())\n+    } else {\n+        write(dst, contents.as_bytes())\n+    }\n+}\n+\n /// Takes a path to a source file and cleans the path to it. This canonicalizes\n /// things like \"..\" to components which preserve the \"top down\" hierarchy of a\n /// static HTML tree. Each component in the cleaned path will be passed as an"}, {"sha": "2e7a1c68579a925a0588f0b7f381056d53262d5c", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=4b14573d50ef13e869db6f997873b1051d2a2c34", "patch": "@@ -196,7 +196,7 @@\n                 onEach(e.getElementsByTagName('span'), function(i_e) {\n                     removeClass(i_e, 'line-highlighted');\n                 });\n-            })\n+            });\n             for (i = from; i <= to; ++i) {\n                 addClass(document.getElementById(i), 'line-highlighted');\n             }\n@@ -1944,7 +1944,7 @@\n               hasClass(next.nextElementSibling, 'docblock')))) {\n             insertAfter(toggle.cloneNode(true), e.childNodes[e.childNodes.length - 1]);\n         }\n-    }\n+    };\n     onEach(document.getElementsByClassName('method'), func);\n     onEach(document.getElementsByClassName('impl'), func);\n     onEach(document.getElementsByClassName('impl-items'), function(e) {"}, {"sha": "e79f67db130db0dfe1a101c4d419f0907f9c73c7", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b14573d50ef13e869db6f997873b1051d2a2c34/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=4b14573d50ef13e869db6f997873b1051d2a2c34", "patch": "@@ -46,6 +46,7 @@ extern crate test as testing;\n extern crate rustc_errors as errors;\n extern crate pulldown_cmark;\n extern crate tempdir;\n+extern crate minifier;\n \n extern crate serialize as rustc_serialize; // used by deriving\n \n@@ -297,6 +298,11 @@ pub fn opts() -> Vec<RustcOptGroup> {\n                      \"How errors and other messages are produced\",\n                      \"human|json|short\")\n         }),\n+        unstable(\"disable-minification\", |o| {\n+             o.optflag(\"\",\n+                       \"disable-minification\",\n+                       \"Disable minification applied on JS files\")\n+        }),\n     ]\n }\n \n@@ -478,6 +484,7 @@ pub fn main_args(args: &[String]) -> isize {\n     let linker = matches.opt_str(\"linker\").map(PathBuf::from);\n     let sort_modules_alphabetically = !matches.opt_present(\"sort-modules-by-appearance\");\n     let resource_suffix = matches.opt_str(\"resource-suffix\");\n+    let enable_minification = !matches.opt_present(\"disable-minification\");\n \n     let edition = matches.opt_str(\"edition\").unwrap_or(\"2015\".to_string());\n     let edition = match edition.parse() {\n@@ -521,7 +528,8 @@ pub fn main_args(args: &[String]) -> isize {\n                                   css_file_extension,\n                                   renderinfo,\n                                   sort_modules_alphabetically,\n-                                  themes)\n+                                  themes,\n+                                  enable_minification)\n                     .expect(\"failed to generate documentation\");\n                 0\n             }"}]}