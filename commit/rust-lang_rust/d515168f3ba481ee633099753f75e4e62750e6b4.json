{"sha": "d515168f3ba481ee633099753f75e4e62750e6b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1MTUxNjhmM2JhNDgxZWU2MzMwOTk3NTNmNzVlNGU2Mjc1MGU2YjQ=", "commit": {"author": {"name": "LeSeulArtichaut", "email": "leseulartichaut@gmail.com", "date": "2020-04-23T21:21:53Z"}, "committer": {"name": "LeSeulArtichaut", "email": "leseulartichaut@gmail.com", "date": "2020-04-23T23:48:48Z"}, "message": "Document unsafety in `core::{panicking, alloc::layout, hint, iter::adapters::zip}`", "tree": {"sha": "a86c94e3ff0a18d9723831151db3e02ce4decfb8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a86c94e3ff0a18d9723831151db3e02ce4decfb8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d515168f3ba481ee633099753f75e4e62750e6b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d515168f3ba481ee633099753f75e4e62750e6b4", "html_url": "https://github.com/rust-lang/rust/commit/d515168f3ba481ee633099753f75e4e62750e6b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d515168f3ba481ee633099753f75e4e62750e6b4/comments", "author": {"login": "LeSeulArtichaut", "id": 38361244, "node_id": "MDQ6VXNlcjM4MzYxMjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/38361244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LeSeulArtichaut", "html_url": "https://github.com/LeSeulArtichaut", "followers_url": "https://api.github.com/users/LeSeulArtichaut/followers", "following_url": "https://api.github.com/users/LeSeulArtichaut/following{/other_user}", "gists_url": "https://api.github.com/users/LeSeulArtichaut/gists{/gist_id}", "starred_url": "https://api.github.com/users/LeSeulArtichaut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LeSeulArtichaut/subscriptions", "organizations_url": "https://api.github.com/users/LeSeulArtichaut/orgs", "repos_url": "https://api.github.com/users/LeSeulArtichaut/repos", "events_url": "https://api.github.com/users/LeSeulArtichaut/events{/privacy}", "received_events_url": "https://api.github.com/users/LeSeulArtichaut/received_events", "type": "User", "site_admin": false}, "committer": {"login": "LeSeulArtichaut", "id": 38361244, "node_id": "MDQ6VXNlcjM4MzYxMjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/38361244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LeSeulArtichaut", "html_url": "https://github.com/LeSeulArtichaut", "followers_url": "https://api.github.com/users/LeSeulArtichaut/followers", "following_url": "https://api.github.com/users/LeSeulArtichaut/following{/other_user}", "gists_url": "https://api.github.com/users/LeSeulArtichaut/gists{/gist_id}", "starred_url": "https://api.github.com/users/LeSeulArtichaut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LeSeulArtichaut/subscriptions", "organizations_url": "https://api.github.com/users/LeSeulArtichaut/orgs", "repos_url": "https://api.github.com/users/LeSeulArtichaut/repos", "events_url": "https://api.github.com/users/LeSeulArtichaut/events{/privacy}", "received_events_url": "https://api.github.com/users/LeSeulArtichaut/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "413a12909f3b149af17d75268ed4a136afb82c36", "url": "https://api.github.com/repos/rust-lang/rust/commits/413a12909f3b149af17d75268ed4a136afb82c36", "html_url": "https://github.com/rust-lang/rust/commit/413a12909f3b149af17d75268ed4a136afb82c36"}], "stats": {"total": 44, "additions": 28, "deletions": 16}, "files": [{"sha": "a09c2387d0de2b597c476ffec8d78e3a568cefde", "filename": "src/libcore/alloc/layout.rs", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Falloc%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Falloc%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Falloc%2Flayout.rs?ref=d515168f3ba481ee633099753f75e4e62750e6b4", "patch": "@@ -1,5 +1,3 @@\n-// ignore-tidy-undocumented-unsafe\n-\n use crate::cmp;\n use crate::fmt;\n use crate::mem;\n@@ -77,6 +75,8 @@ impl Layout {\n             return Err(LayoutErr { private: () });\n         }\n \n+        // SAFETY: the conditions for `from_size_align_unchecked` have been\n+        // checked above.\n         unsafe { Ok(Layout::from_size_align_unchecked(size, align)) }\n     }\n \n@@ -115,7 +115,7 @@ impl Layout {\n     #[inline]\n     pub const fn new<T>() -> Self {\n         let (size, align) = size_align::<T>();\n-        // Note that the align is guaranteed by rustc to be a power of two and\n+        // SAFETY: the align is guaranteed by Rust to be a power of two and\n         // the size+align combo is guaranteed to fit in our address space. As a\n         // result use the unchecked constructor here to avoid inserting code\n         // that panics if it isn't optimized well enough.\n@@ -129,8 +129,8 @@ impl Layout {\n     #[inline]\n     pub fn for_value<T: ?Sized>(t: &T) -> Self {\n         let (size, align) = (mem::size_of_val(t), mem::align_of_val(t));\n-        // See rationale in `new` for why this is using an unsafe variant below\n         debug_assert!(Layout::from_size_align(size, align).is_ok());\n+        // SAFETY: see rationale in `new` for why this is using an unsafe variant below\n         unsafe { Layout::from_size_align_unchecked(size, align) }\n     }\n \n@@ -143,7 +143,7 @@ impl Layout {\n     #[unstable(feature = \"alloc_layout_extra\", issue = \"55724\")]\n     #[inline]\n     pub const fn dangling(&self) -> NonNull<u8> {\n-        // align is non-zero and a power of two\n+        // SAFETY: align is guaranteed to be non-zero\n         unsafe { NonNull::new_unchecked(self.align() as *mut u8) }\n     }\n \n@@ -249,11 +249,9 @@ impl Layout {\n         let padded_size = self.size() + self.padding_needed_for(self.align());\n         let alloc_size = padded_size.checked_mul(n).ok_or(LayoutErr { private: () })?;\n \n-        unsafe {\n-            // self.align is already known to be valid and alloc_size has been\n-            // padded already.\n-            Ok((Layout::from_size_align_unchecked(alloc_size, self.align()), padded_size))\n-        }\n+        // SAFETY: self.align is already known to be valid and alloc_size has been\n+        // padded already.\n+        unsafe { Ok((Layout::from_size_align_unchecked(alloc_size, self.align()), padded_size)) }\n     }\n \n     /// Creates a layout describing the record for `self` followed by"}, {"sha": "0d794de5fe84b3233d904382b15959203c126b33", "filename": "src/libcore/hint.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Fhint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Fhint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fhint.rs?ref=d515168f3ba481ee633099753f75e4e62750e6b4", "patch": "@@ -2,8 +2,6 @@\n \n //! Hints to compiler that affects how code should be emitted or optimized.\n \n-// ignore-tidy-undocumented-unsafe\n-\n use crate::intrinsics;\n \n /// Informs the compiler that this point in the code is not reachable, enabling\n@@ -68,11 +66,13 @@ pub fn spin_loop() {\n     {\n         #[cfg(target_arch = \"x86\")]\n         {\n+            // SAFETY: the `cfg` attr ensures that we only execute this on x86 targets.\n             unsafe { crate::arch::x86::_mm_pause() };\n         }\n \n         #[cfg(target_arch = \"x86_64\")]\n         {\n+            // SAFETY: the `cfg` attr ensures that we only execute this on x86_64 targets.\n             unsafe { crate::arch::x86_64::_mm_pause() };\n         }\n     }\n@@ -81,10 +81,13 @@ pub fn spin_loop() {\n     {\n         #[cfg(target_arch = \"aarch64\")]\n         {\n+            // SAFETY: the `cfg` attr ensures that we only execute this on aarch64 targets.\n             unsafe { crate::arch::aarch64::__yield() };\n         }\n         #[cfg(target_arch = \"arm\")]\n         {\n+            // SAFETY: the `cfg` attr ensures that we only execute this on arm targets\n+            // with support for the v6 feature.\n             unsafe { crate::arch::arm::__yield() };\n         }\n     }\n@@ -112,6 +115,8 @@ pub fn black_box<T>(dummy: T) -> T {\n     // this. LLVM's interpretation of inline assembly is that it's, well, a black\n     // box. This isn't the greatest implementation since it probably deoptimizes\n     // more than we want, but it's so far good enough.\n+\n+    // SAFETY: the inline assembly is a no-op.\n     unsafe {\n         llvm_asm!(\"\" : : \"r\"(&dummy));\n         dummy"}, {"sha": "e83d36a580f06464022d3b0b51bb0f2c9f64f142", "filename": "src/libcore/iter/adapters/zip.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Fiter%2Fadapters%2Fzip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Fiter%2Fadapters%2Fzip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fiter%2Fadapters%2Fzip.rs?ref=d515168f3ba481ee633099753f75e4e62750e6b4", "patch": "@@ -1,5 +1,3 @@\n-// ignore-tidy-undocumented-unsafe\n-\n use crate::cmp;\n \n use super::super::{DoubleEndedIterator, ExactSizeIterator, FusedIterator, Iterator, TrustedLen};\n@@ -176,9 +174,11 @@ where\n         if self.index < self.len {\n             let i = self.index;\n             self.index += 1;\n+            // SAFETY: `i` is smaller than `self.len`, thus smaller than `self.a.len()` and `self.b.len()`\n             unsafe { Some((self.a.get_unchecked(i), self.b.get_unchecked(i))) }\n         } else if A::may_have_side_effect() && self.index < self.a.len() {\n             // match the base implementation's potential side effects\n+            // SAFETY: we just checked that `self.index` < `self.a.len()`\n             unsafe {\n                 self.a.get_unchecked(self.index);\n             }\n@@ -203,11 +203,15 @@ where\n             let i = self.index;\n             self.index += 1;\n             if A::may_have_side_effect() {\n+                // SAFETY: the usage of `cmp::min` to calculate `delta`\n+                // ensures that `end` is smaller than or equal to `self.len`,\n+                // so `i` is also smaller than `self.len`.\n                 unsafe {\n                     self.a.get_unchecked(i);\n                 }\n             }\n             if B::may_have_side_effect() {\n+                // SAFETY: same as above.\n                 unsafe {\n                     self.b.get_unchecked(i);\n                 }\n@@ -243,6 +247,8 @@ where\n         if self.index < self.len {\n             self.len -= 1;\n             let i = self.len;\n+            // SAFETY: `i` is smaller than the previous value of `self.len`,\n+            // which is also smaller than or equal to `self.a.len()` and `self.b.len()`\n             unsafe { Some((self.a.get_unchecked(i), self.b.get_unchecked(i))) }\n         } else {\n             None"}, {"sha": "1e4209fd26be3b459e926ba0df8a60dadbf6e1e1", "filename": "src/libcore/panicking.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d515168f3ba481ee633099753f75e4e62750e6b4/src%2Flibcore%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fpanicking.rs?ref=d515168f3ba481ee633099753f75e4e62750e6b4", "patch": "@@ -19,8 +19,6 @@\n //! necessary lang items for the compiler. All panics are funneled through this\n //! one function. The actual symbol is declared through the `#[panic_handler]` attribute.\n \n-// ignore-tidy-undocumented-unsafe\n-\n #![allow(dead_code, missing_docs)]\n #![unstable(\n     feature = \"core_panic\",\n@@ -41,6 +39,7 @@ use crate::panic::{Location, PanicInfo};\n #[lang = \"panic\"] // needed by codegen for panic on overflow and other `Assert` MIR terminators\n pub fn panic(expr: &str) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n+        // SAFETY: the `abort` intrinsic has no requirements to be called.\n         unsafe { super::intrinsics::abort() }\n     }\n \n@@ -63,6 +62,7 @@ pub fn panic(expr: &str) -> ! {\n #[lang = \"panic_bounds_check\"] // needed by codegen for panic on OOB array/slice access\n fn panic_bounds_check(index: usize, len: usize) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n+        // SAFETY: the `abort` intrinsic has no requirements to be called.\n         unsafe { super::intrinsics::abort() }\n     }\n \n@@ -77,6 +77,7 @@ fn panic_bounds_check(index: usize, len: usize) -> ! {\n #[lang = \"panic_bounds_check\"] // needed by codegen for panic on OOB array/slice access\n fn panic_bounds_check(location: &Location<'_>, index: usize, len: usize) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n+        // SAFETY: the `abort` intrinsic has no requirements to be called.\n         unsafe { super::intrinsics::abort() }\n     }\n \n@@ -93,6 +94,7 @@ fn panic_bounds_check(location: &Location<'_>, index: usize, len: usize) -> ! {\n #[cfg_attr(not(bootstrap), track_caller)]\n pub fn panic_fmt(fmt: fmt::Arguments<'_>, #[cfg(bootstrap)] location: &Location<'_>) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n+        // SAFETY: the `abort` intrinsic has no requirements to be called.\n         unsafe { super::intrinsics::abort() }\n     }\n \n@@ -108,5 +110,6 @@ pub fn panic_fmt(fmt: fmt::Arguments<'_>, #[cfg(bootstrap)] location: &Location<\n     #[cfg(not(bootstrap))]\n     let pi = PanicInfo::internal_constructor(Some(&fmt), Location::caller());\n \n+    // SAFETY: `panic_impl` is defined in safe Rust code and thus is safe to call.\n     unsafe { panic_impl(&pi) }\n }"}]}