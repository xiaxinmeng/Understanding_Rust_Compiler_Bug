{"sha": "189584e792bfc10142793ca1117e803c2201991a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE4OTU4NGU3OTJiZmMxMDE0Mjc5M2NhMTExN2U4MDNjMjIwMTk5MWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-15T18:02:03Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-15T18:02:03Z"}, "message": "auto merge of #13489 : JustAPerson/rust/crate-file-name, r=alexcrichton\n\nBefore, the `--crate-file-name` flag only checked crate attributes for\r\npossible crate types. Now, if any type is specified by one or more\r\n`--crate-type` flags, only the filenames for those types will be\r\nemitted, and any types specified by crate attributes will be ignored.", "tree": {"sha": "f513dfaa24aec84db544a88d6f36b6982fbbefb3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f513dfaa24aec84db544a88d6f36b6982fbbefb3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/189584e792bfc10142793ca1117e803c2201991a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/189584e792bfc10142793ca1117e803c2201991a", "html_url": "https://github.com/rust-lang/rust/commit/189584e792bfc10142793ca1117e803c2201991a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/189584e792bfc10142793ca1117e803c2201991a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a4ffbf625774a5ebf210d2851f47338ed91bbfe", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a4ffbf625774a5ebf210d2851f47338ed91bbfe", "html_url": "https://github.com/rust-lang/rust/commit/8a4ffbf625774a5ebf210d2851f47338ed91bbfe"}, {"sha": "0162f8e6e16152224de4704ecd72d537c27046fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/0162f8e6e16152224de4704ecd72d537c27046fe", "html_url": "https://github.com/rust-lang/rust/commit/0162f8e6e16152224de4704ecd72d537c27046fe"}], "stats": {"total": 109, "additions": 74, "deletions": 35}, "files": [{"sha": "f2df445a5a276de6c3b800b954016662dc1cae04", "filename": "src/doc/rust.md", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/189584e792bfc10142793ca1117e803c2201991a/src%2Fdoc%2Frust.md", "raw_url": "https://github.com/rust-lang/rust/raw/189584e792bfc10142793ca1117e803c2201991a/src%2Fdoc%2Frust.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frust.md?ref=189584e792bfc10142793ca1117e803c2201991a", "patch": "@@ -3920,7 +3920,9 @@ link Rust crates together, and more information about native libraries can be\n found in the [ffi tutorial][ffi].\n \n In one session of compilation, the compiler can generate multiple artifacts\n-through the usage of command line flags and the `crate_type` attribute.\n+through the usage of either command line flags or the `crate_type` attribute.\n+If one or more command line flag is specified, all `crate_type` attributes will\n+be ignored in favor of only building the artifacts specified by command line.\n \n * `--crate-type=bin`, `#[crate_type = \"bin\"]` - A runnable executable will be\n   produced.  This requires that there is a `main` function in the crate which\n@@ -3963,7 +3965,10 @@ through the usage of command line flags and the `crate_type` attribute.\n \n Note that these outputs are stackable in the sense that if multiple are\n specified, then the compiler will produce each form of output at once without\n-having to recompile.\n+having to recompile. However, this only applies for outputs specified by the same\n+method. If only `crate_type` attributes are specified, then they will all be\n+built, but if one or more `--crate-type` command line flag is specified,\n+then only those outputs will be built.\n \n With all these different kinds of outputs, if crate A depends on crate B, then\n the compiler could find B in various different forms throughout the system. The"}, {"sha": "0cd0ac557787daa2eee7f6847bda0cdc302f3700", "filename": "src/librustc/driver/session.rs", "status": "modified", "additions": 41, "deletions": 33, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/189584e792bfc10142793ca1117e803c2201991a/src%2Flibrustc%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/189584e792bfc10142793ca1117e803c2201991a/src%2Flibrustc%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fsession.rs?ref=189584e792bfc10142793ca1117e803c2201991a", "patch": "@@ -498,43 +498,51 @@ pub fn collect_crate_types(session: &Session,\n     if session.opts.test {\n         return vec!(CrateTypeExecutable)\n     }\n+\n+    // Only check command line flags if present. If no types are specified by\n+    // command line, then reuse the empty `base` Vec to hold the types that\n+    // will be found in crate attributes.\n     let mut base = session.opts.crate_types.clone();\n-    let iter = attrs.iter().filter_map(|a| {\n-        if a.name().equiv(&(\"crate_type\")) {\n-            match a.value_str() {\n-                Some(ref n) if n.equiv(&(\"rlib\")) => Some(CrateTypeRlib),\n-                Some(ref n) if n.equiv(&(\"dylib\")) => Some(CrateTypeDylib),\n-                Some(ref n) if n.equiv(&(\"lib\")) => {\n-                    Some(default_lib_output())\n-                }\n-                Some(ref n) if n.equiv(&(\"staticlib\")) => {\n-                    Some(CrateTypeStaticlib)\n-                }\n-                Some(ref n) if n.equiv(&(\"bin\")) => Some(CrateTypeExecutable),\n-                Some(_) => {\n-                    session.add_lint(lint::UnknownCrateType,\n-                                     ast::CRATE_NODE_ID,\n-                                     a.span,\n-                                     ~\"invalid `crate_type` value\");\n-                    None\n-                }\n-                _ => {\n-                    session.add_lint(lint::UnknownCrateType, ast::CRATE_NODE_ID,\n-                                    a.span, ~\"`crate_type` requires a value\");\n-                    None\n+    if base.len() > 0 {\n+        return base\n+    } else {\n+        let iter = attrs.iter().filter_map(|a| {\n+            if a.name().equiv(&(\"crate_type\")) {\n+                match a.value_str() {\n+                    Some(ref n) if n.equiv(&(\"rlib\")) => Some(CrateTypeRlib),\n+                    Some(ref n) if n.equiv(&(\"dylib\")) => Some(CrateTypeDylib),\n+                    Some(ref n) if n.equiv(&(\"lib\")) => {\n+                        Some(default_lib_output())\n+                    }\n+                    Some(ref n) if n.equiv(&(\"staticlib\")) => {\n+                        Some(CrateTypeStaticlib)\n+                    }\n+                    Some(ref n) if n.equiv(&(\"bin\")) => Some(CrateTypeExecutable),\n+                    Some(_) => {\n+                        session.add_lint(lint::UnknownCrateType,\n+                                         ast::CRATE_NODE_ID,\n+                                         a.span,\n+                                         ~\"invalid `crate_type` value\");\n+                        None\n+                    }\n+                    _ => {\n+                        session.add_lint(lint::UnknownCrateType, ast::CRATE_NODE_ID,\n+                                        a.span, ~\"`crate_type` requires a value\");\n+                        None\n+                    }\n                 }\n+            } else {\n+                None\n             }\n-        } else {\n-            None\n+        });\n+        base.extend(iter);\n+        if base.len() == 0 {\n+            base.push(CrateTypeExecutable);\n         }\n-    });\n-    base.extend(iter);\n-    if base.len() == 0 {\n-        base.push(CrateTypeExecutable);\n-    }\n-    base.as_mut_slice().sort();\n-    base.dedup();\n-    return base;\n+        base.as_mut_slice().sort();\n+        base.dedup();\n+        return base;\n+    }\n }\n \n pub fn sess_os_to_meta_os(os: abi::Os) -> metadata::loader::Os {"}, {"sha": "c28bc7c7b5e93b09807c78c4fb5859beba92fa3d", "filename": "src/test/run-make/obey-crate-type-flag/Makefile", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/189584e792bfc10142793ca1117e803c2201991a/src%2Ftest%2Frun-make%2Fobey-crate-type-flag%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/189584e792bfc10142793ca1117e803c2201991a/src%2Ftest%2Frun-make%2Fobey-crate-type-flag%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fobey-crate-type-flag%2FMakefile?ref=189584e792bfc10142793ca1117e803c2201991a", "patch": "@@ -0,0 +1,13 @@\n+-include ../tools.mk\n+\n+# check that rustc builds all crate_type attributes\n+# delete rlib\n+# delete whatever dylib is made for this system\n+# check that rustc only builds --crate-type flags, ignoring attributes\n+# fail if an rlib was built\n+all:\n+\t$(RUSTC) test.rs\n+\trm $(TMPDIR)/libtest*.rlib\n+\trm $(TMPDIR)/libtest*\n+\t$(RUSTC) --crate-type dylib test.rs\n+\trm $(TMPDIR)/libtest*.rlib && exit 1 || exit 0"}, {"sha": "8eb82b48eacf7baf30a9ea77bc7855835ab9de45", "filename": "src/test/run-make/obey-crate-type-flag/test.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/189584e792bfc10142793ca1117e803c2201991a/src%2Ftest%2Frun-make%2Fobey-crate-type-flag%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/189584e792bfc10142793ca1117e803c2201991a/src%2Ftest%2Frun-make%2Fobey-crate-type-flag%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fobey-crate-type-flag%2Ftest.rs?ref=189584e792bfc10142793ca1117e803c2201991a", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type = \"rlib\"]\n+#![crate_type = \"dylib\"]\n+"}]}