{"sha": "3cd994d8a50da568ca66f69b92ee48397aa7a179", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNjZDk5NGQ4YTUwZGE1NjhjYTY2ZjY5YjkyZWU0ODM5N2FhN2ExNzk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-22T12:14:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-22T12:14:23Z"}, "message": "Merge #7389\n\n7389: Remove approximate goto def r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "85ff841289d013ba352de349385911cc9385e40b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85ff841289d013ba352de349385911cc9385e40b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3cd994d8a50da568ca66f69b92ee48397aa7a179", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgCsGfCRBK7hj4Ov3rIwAAdHIIAEtOjm11bo8JvP2rWRqDth94\nisxk/g9Ud4Vg8wuCcMmlMlXobxnBolt76wvk/Q++TuJwUlgmSjGA/6qIqPfgv/z7\nJN1UPtrTYzNRWh5jBDI2kZ//0ZU2QVwB2sbcjnOcqBaudctZe/fzDmpOUmWjXQXB\ngfuwadU6U4ULVA/Vlk8pWQzNSFCY2PVE8Kk7UaJWOniLLDHH71805zO0RQOJl7F4\ntX0Kjikox9bOgkVYzGjZPGHV36fXHYSUo5fN9gRRHO26+lhRS9Fs8o45IoYpA8gz\nFnuqpwpZtYHGtjcS++JbGuurB3mhZD1bSQc8VBiqj9pUs/oPL9l591yU4010XC0=\n=BSZk\n-----END PGP SIGNATURE-----\n", "payload": "tree 85ff841289d013ba352de349385911cc9385e40b\nparent 2ca9cb375385fceede55cfacdbadc1c6bf24e2ea\nparent f67a2eedf5118990a9aa17c307176b8b355e9759\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1611317663 +0000\ncommitter GitHub <noreply@github.com> 1611317663 +0000\n\nMerge #7389\n\n7389: Remove approximate goto def r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3cd994d8a50da568ca66f69b92ee48397aa7a179", "html_url": "https://github.com/rust-lang/rust/commit/3cd994d8a50da568ca66f69b92ee48397aa7a179", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3cd994d8a50da568ca66f69b92ee48397aa7a179/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ca9cb375385fceede55cfacdbadc1c6bf24e2ea", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ca9cb375385fceede55cfacdbadc1c6bf24e2ea", "html_url": "https://github.com/rust-lang/rust/commit/2ca9cb375385fceede55cfacdbadc1c6bf24e2ea"}, {"sha": "f67a2eedf5118990a9aa17c307176b8b355e9759", "url": "https://api.github.com/repos/rust-lang/rust/commits/f67a2eedf5118990a9aa17c307176b8b355e9759", "html_url": "https://github.com/rust-lang/rust/commit/f67a2eedf5118990a9aa17c307176b8b355e9759"}], "stats": {"total": 90, "additions": 30, "deletions": 60}, "files": [{"sha": "1a997fa40dc4d9e45de88067cf013665f18372c9", "filename": "crates/ide/src/goto_definition.rs", "status": "modified", "additions": 30, "deletions": 60, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/3cd994d8a50da568ca66f69b92ee48397aa7a179/crates%2Fide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cd994d8a50da568ca66f69b92ee48397aa7a179/crates%2Fide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fgoto_definition.rs?ref=3cd994d8a50da568ca66f69b92ee48397aa7a179", "patch": "@@ -2,16 +2,14 @@ use either::Either;\n use hir::{HasAttrs, ModuleDef, Semantics};\n use ide_db::{\n     defs::{Definition, NameClass, NameRefClass},\n-    symbol_index, RootDatabase,\n+    RootDatabase,\n };\n use syntax::{\n     ast, match_ast, AstNode, AstToken, SyntaxKind::*, SyntaxToken, TextSize, TokenAtOffset, T,\n };\n \n use crate::{\n-    display::{ToNav, TryToNav},\n-    doc_links::extract_definitions_from_markdown,\n-    runnables::doc_owner_to_def,\n+    display::TryToNav, doc_links::extract_definitions_from_markdown, runnables::doc_owner_to_def,\n     FilePosition, NavigationTarget, RangeInfo,\n };\n \n@@ -38,28 +36,26 @@ pub(crate) fn goto_definition(\n         return Some(RangeInfo::new(original_token.text_range(), vec![nav]));\n     }\n \n-    let nav_targets = match_ast! {\n+    let nav = match_ast! {\n         match parent {\n             ast::NameRef(name_ref) => {\n-                reference_definition(&sema, Either::Right(&name_ref)).to_vec()\n+                reference_definition(&sema, Either::Right(&name_ref))\n             },\n             ast::Name(name) => {\n                 let def = NameClass::classify(&sema, &name)?.referenced_or_defined(sema.db);\n-                let nav = def.try_to_nav(sema.db)?;\n-                vec![nav]\n+                def.try_to_nav(sema.db)\n             },\n             ast::Lifetime(lt) => if let Some(name_class) = NameClass::classify_lifetime(&sema, &lt) {\n                 let def = name_class.referenced_or_defined(sema.db);\n-                let nav = def.try_to_nav(sema.db)?;\n-                vec![nav]\n+                def.try_to_nav(sema.db)\n             } else {\n-                reference_definition(&sema, Either::Left(&lt)).to_vec()\n+                reference_definition(&sema, Either::Left(&lt))\n             },\n             _ => return None,\n         }\n     };\n \n-    Some(RangeInfo::new(original_token.text_range(), nav_targets))\n+    Some(RangeInfo::new(original_token.text_range(), nav.into_iter().collect()))\n }\n \n fn def_for_doc_comment(\n@@ -120,42 +116,16 @@ fn pick_best(tokens: TokenAtOffset<SyntaxToken>) -> Option<SyntaxToken> {\n     }\n }\n \n-#[derive(Debug)]\n-pub(crate) enum ReferenceResult {\n-    Exact(NavigationTarget),\n-    Approximate(Vec<NavigationTarget>),\n-}\n-\n-impl ReferenceResult {\n-    fn to_vec(self) -> Vec<NavigationTarget> {\n-        match self {\n-            ReferenceResult::Exact(target) => vec![target],\n-            ReferenceResult::Approximate(vec) => vec,\n-        }\n-    }\n-}\n-\n pub(crate) fn reference_definition(\n     sema: &Semantics<RootDatabase>,\n     name_ref: Either<&ast::Lifetime, &ast::NameRef>,\n-) -> ReferenceResult {\n+) -> Option<NavigationTarget> {\n     let name_kind = name_ref.either(\n         |lifetime| NameRefClass::classify_lifetime(sema, lifetime),\n         |name_ref| NameRefClass::classify(sema, name_ref),\n-    );\n-    if let Some(def) = name_kind {\n-        let def = def.referenced(sema.db);\n-        return match def.try_to_nav(sema.db) {\n-            Some(nav) => ReferenceResult::Exact(nav),\n-            None => ReferenceResult::Approximate(Vec::new()),\n-        };\n-    }\n-\n-    // Fallback index based approach:\n-    let name = name_ref.either(ast::Lifetime::text, ast::NameRef::text);\n-    let navs =\n-        symbol_index::index_resolve(sema.db, name).into_iter().map(|s| s.to_nav(sema.db)).collect();\n-    ReferenceResult::Approximate(navs)\n+    )?;\n+    let def = name_kind.referenced(sema.db);\n+    def.try_to_nav(sema.db)\n }\n \n #[cfg(test)]\n@@ -192,25 +162,25 @@ mod tests {\n     fn goto_def_for_extern_crate() {\n         check(\n             r#\"\n-            //- /main.rs crate:main deps:std\n-            extern crate std$0;\n-            //- /std/lib.rs crate:std\n-            // empty\n-            //^ file\n-            \"#,\n+//- /main.rs crate:main deps:std\n+extern crate std$0;\n+//- /std/lib.rs crate:std\n+// empty\n+//^ file\n+\"#,\n         )\n     }\n \n     #[test]\n     fn goto_def_for_renamed_extern_crate() {\n         check(\n             r#\"\n-            //- /main.rs crate:main deps:std\n-            extern crate std as abc$0;\n-            //- /std/lib.rs crate:std\n-            // empty\n-            //^ file\n-            \"#,\n+//- /main.rs crate:main deps:std\n+extern crate std as abc$0;\n+//- /std/lib.rs crate:std\n+// empty\n+//^ file\n+\"#,\n         )\n     }\n \n@@ -297,13 +267,13 @@ fn bar() {\n     fn goto_def_for_macros_from_other_crates() {\n         check(\n             r#\"\n-//- /lib.rs\n+//- /lib.rs crate:main deps:foo\n use foo::foo;\n fn bar() {\n     $0foo!();\n }\n \n-//- /foo/lib.rs\n+//- /foo/lib.rs crate:foo\n #[macro_export]\n macro_rules! foo { () => { () } }\n            //^^^\n@@ -315,10 +285,10 @@ macro_rules! foo { () => { () } }\n     fn goto_def_for_macros_in_use_tree() {\n         check(\n             r#\"\n-//- /lib.rs\n+//- /lib.rs crate:main deps:foo\n use foo::foo$0;\n \n-//- /foo/lib.rs\n+//- /foo/lib.rs crate:foo\n #[macro_export]\n macro_rules! foo { () => { () } }\n            //^^^\n@@ -976,10 +946,10 @@ type Alias<T> = T$0;\n     fn goto_def_for_macro_container() {\n         check(\n             r#\"\n-//- /lib.rs\n+//- /lib.rs crate:main deps:foo\n foo::module$0::mac!();\n \n-//- /foo/lib.rs\n+//- /foo/lib.rs crate:foo\n pub mod module {\n       //^^^^^^\n     #[macro_export]"}]}