{"sha": "f28d8b13dffc372b099aa9a0e906b21962569076", "node_id": "C_kwDOAAsO6NoAKGYyOGQ4YjEzZGZmYzM3MmIwOTlhYTlhMGU5MDZiMjE5NjI1NjkwNzY", "commit": {"author": {"name": "Frank King", "email": "frankking1729@gmail.com", "date": "2022-03-22T04:17:30Z"}, "committer": {"name": "Frank King", "email": "frankking1729@gmail.com", "date": "2022-03-22T04:17:30Z"}, "message": "suggest constraining param for unary ops when missing trait impl", "tree": {"sha": "4392aee4ef9d69b0b9b668c6c6c96abe1c873bef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4392aee4ef9d69b0b9b668c6c6c96abe1c873bef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f28d8b13dffc372b099aa9a0e906b21962569076", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f28d8b13dffc372b099aa9a0e906b21962569076", "html_url": "https://github.com/rust-lang/rust/commit/f28d8b13dffc372b099aa9a0e906b21962569076", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f28d8b13dffc372b099aa9a0e906b21962569076/comments", "author": {"login": "frank-king", "id": 16741972, "node_id": "MDQ6VXNlcjE2NzQxOTcy", "avatar_url": "https://avatars.githubusercontent.com/u/16741972?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frank-king", "html_url": "https://github.com/frank-king", "followers_url": "https://api.github.com/users/frank-king/followers", "following_url": "https://api.github.com/users/frank-king/following{/other_user}", "gists_url": "https://api.github.com/users/frank-king/gists{/gist_id}", "starred_url": "https://api.github.com/users/frank-king/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frank-king/subscriptions", "organizations_url": "https://api.github.com/users/frank-king/orgs", "repos_url": "https://api.github.com/users/frank-king/repos", "events_url": "https://api.github.com/users/frank-king/events{/privacy}", "received_events_url": "https://api.github.com/users/frank-king/received_events", "type": "User", "site_admin": false}, "committer": {"login": "frank-king", "id": 16741972, "node_id": "MDQ6VXNlcjE2NzQxOTcy", "avatar_url": "https://avatars.githubusercontent.com/u/16741972?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frank-king", "html_url": "https://github.com/frank-king", "followers_url": "https://api.github.com/users/frank-king/followers", "following_url": "https://api.github.com/users/frank-king/following{/other_user}", "gists_url": "https://api.github.com/users/frank-king/gists{/gist_id}", "starred_url": "https://api.github.com/users/frank-king/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frank-king/subscriptions", "organizations_url": "https://api.github.com/users/frank-king/orgs", "repos_url": "https://api.github.com/users/frank-king/repos", "events_url": "https://api.github.com/users/frank-king/events{/privacy}", "received_events_url": "https://api.github.com/users/frank-king/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "051d1176b786aadd7d7c048f822cb6bfab00fe03", "url": "https://api.github.com/repos/rust-lang/rust/commits/051d1176b786aadd7d7c048f822cb6bfab00fe03", "html_url": "https://github.com/rust-lang/rust/commit/051d1176b786aadd7d7c048f822cb6bfab00fe03"}], "stats": {"total": 59, "additions": 57, "deletions": 2}, "files": [{"sha": "e0dbe027aefe967afcab5617df5f68c4c5a0bc47", "filename": "compiler/rustc_typeck/src/check/op.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/f28d8b13dffc372b099aa9a0e906b21962569076/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f28d8b13dffc372b099aa9a0e906b21962569076/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs?ref=f28d8b13dffc372b099aa9a0e906b21962569076", "patch": "@@ -672,6 +672,27 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         ex.span,\n                         format!(\"cannot apply unary operator `{}`\", op.as_str()),\n                     );\n+                    let missing_trait = match op {\n+                        hir::UnOp::Deref => unreachable!(\"check unary op `-` or `!` only\"),\n+                        hir::UnOp::Not => \"std::ops::Not\",\n+                        hir::UnOp::Neg => \"std::ops::Neg\",\n+                    };\n+                    let mut visitor = TypeParamVisitor(vec![]);\n+                    visitor.visit_ty(operand_ty);\n+                    if let [ty] = &visitor.0[..] {\n+                        if let ty::Param(p) = *operand_ty.kind() {\n+                            suggest_constraining_param(\n+                                self.tcx,\n+                                self.body_id,\n+                                &mut err,\n+                                *ty,\n+                                operand_ty,\n+                                missing_trait,\n+                                p,\n+                                true,\n+                            );\n+                        }\n+                    }\n \n                     let sp = self.tcx.sess.source_map().start_point(ex.span);\n                     if let Some(sp) ="}, {"sha": "0e3e703a2f5ac61d6160f168fbe42aa418d49402", "filename": "src/test/ui/type/type-check/missing_trait_impl.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f28d8b13dffc372b099aa9a0e906b21962569076/src%2Ftest%2Fui%2Ftype%2Ftype-check%2Fmissing_trait_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f28d8b13dffc372b099aa9a0e906b21962569076/src%2Ftest%2Fui%2Ftype%2Ftype-check%2Fmissing_trait_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype%2Ftype-check%2Fmissing_trait_impl.rs?ref=f28d8b13dffc372b099aa9a0e906b21962569076", "patch": "@@ -8,3 +8,9 @@ fn foo<T>(x: T, y: T) {\n fn bar<T>(x: T) {\n     x += x; //~ ERROR binary assignment operation `+=` cannot be applied to type `T`\n }\n+\n+fn baz<T>(x: T) {\n+    let y = -x; //~ ERROR cannot apply unary operator `-` to type `T`\n+    let y = !x; //~ ERROR cannot apply unary operator `!` to type `T`\n+    let y = *x; //~ ERROR type `T` cannot be dereferenced\n+}"}, {"sha": "59b8692dd4d1a5851c920bf5205316fe884772e8", "filename": "src/test/ui/type/type-check/missing_trait_impl.stderr", "status": "modified", "additions": 30, "deletions": 2, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/f28d8b13dffc372b099aa9a0e906b21962569076/src%2Ftest%2Fui%2Ftype%2Ftype-check%2Fmissing_trait_impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f28d8b13dffc372b099aa9a0e906b21962569076/src%2Ftest%2Fui%2Ftype%2Ftype-check%2Fmissing_trait_impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype%2Ftype-check%2Fmissing_trait_impl.stderr?ref=f28d8b13dffc372b099aa9a0e906b21962569076", "patch": "@@ -24,7 +24,35 @@ help: consider restricting type parameter `T`\n LL | fn bar<T: std::ops::AddAssign>(x: T) {\n    |         +++++++++++++++++++++\n \n-error: aborting due to 2 previous errors\n+error[E0600]: cannot apply unary operator `-` to type `T`\n+  --> $DIR/missing_trait_impl.rs:13:13\n+   |\n+LL |     let y = -x;\n+   |             ^^ cannot apply unary operator `-`\n+   |\n+help: consider restricting type parameter `T`\n+   |\n+LL | fn baz<T: std::ops::Neg<Output = T>>(x: T) {\n+   |         +++++++++++++++++++++++++++\n+\n+error[E0600]: cannot apply unary operator `!` to type `T`\n+  --> $DIR/missing_trait_impl.rs:14:13\n+   |\n+LL |     let y = !x;\n+   |             ^^ cannot apply unary operator `!`\n+   |\n+help: consider restricting type parameter `T`\n+   |\n+LL | fn baz<T: std::ops::Not<Output = T>>(x: T) {\n+   |         +++++++++++++++++++++++++++\n+\n+error[E0614]: type `T` cannot be dereferenced\n+  --> $DIR/missing_trait_impl.rs:15:13\n+   |\n+LL |     let y = *x;\n+   |             ^^\n+\n+error: aborting due to 5 previous errors\n \n-Some errors have detailed explanations: E0368, E0369.\n+Some errors have detailed explanations: E0368, E0369, E0600, E0614.\n For more information about an error, try `rustc --explain E0368`."}]}