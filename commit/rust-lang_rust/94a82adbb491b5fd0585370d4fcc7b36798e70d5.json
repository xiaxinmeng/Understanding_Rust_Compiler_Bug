{"sha": "94a82adbb491b5fd0585370d4fcc7b36798e70d5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk0YTgyYWRiYjQ5MWI1ZmQwNTg1MzcwZDRmY2M3YjM2Nzk4ZTcwZDU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-09-20T06:29:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-09-20T06:29:42Z"}, "message": "Auto merge of #44355 - Xaeroxe:optimize_drain_filter, r=alexcrichton\n\nOptimize drain_filter\n\nThis PR cuts out two copies from each iteration of `drain_filter` by exchanging the swap operation for a copy_nonoverlapping function call instead.  Since the data being swapped is not needed anymore we can just overwrite it instead.", "tree": {"sha": "de14b4b931e0cea4245b79eb557ab7cce878c959", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/de14b4b931e0cea4245b79eb557ab7cce878c959"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/94a82adbb491b5fd0585370d4fcc7b36798e70d5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/94a82adbb491b5fd0585370d4fcc7b36798e70d5", "html_url": "https://github.com/rust-lang/rust/commit/94a82adbb491b5fd0585370d4fcc7b36798e70d5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/94a82adbb491b5fd0585370d4fcc7b36798e70d5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "54996837a399421f8d691c6901eea5ab20a30f46", "url": "https://api.github.com/repos/rust-lang/rust/commits/54996837a399421f8d691c6901eea5ab20a30f46", "html_url": "https://github.com/rust-lang/rust/commit/54996837a399421f8d691c6901eea5ab20a30f46"}, {"sha": "10384ab18a386e6f7b58c714def62e405182d968", "url": "https://api.github.com/repos/rust-lang/rust/commits/10384ab18a386e6f7b58c714def62e405182d968", "html_url": "https://github.com/rust-lang/rust/commit/10384ab18a386e6f7b58c714def62e405182d968"}], "stats": {"total": 8, "additions": 7, "deletions": 1}, "files": [{"sha": "7dd8895c1ae4cdaf5fc162e9d101dc2cd6816544", "filename": "src/liballoc/vec.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/94a82adbb491b5fd0585370d4fcc7b36798e70d5/src%2Fliballoc%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/94a82adbb491b5fd0585370d4fcc7b36798e70d5/src%2Fliballoc%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fvec.rs?ref=94a82adbb491b5fd0585370d4fcc7b36798e70d5", "patch": "@@ -2694,7 +2694,13 @@ impl<'a, T, F> Iterator for DrainFilter<'a, T, F>\n                     self.del += 1;\n                     return Some(ptr::read(&v[i]));\n                 } else if self.del > 0 {\n-                    v.swap(i - self.del, i);\n+                    let del = self.del;\n+                    let src: *const T = &v[i];\n+                    let dst: *mut T = &mut v[i - del];\n+                    // This is safe because self.vec has length 0\n+                    // thus its elements will not have Drop::drop\n+                    // called on them in the event of a panic.\n+                    ptr::copy_nonoverlapping(src, dst, 1);\n                 }\n             }\n             None"}]}