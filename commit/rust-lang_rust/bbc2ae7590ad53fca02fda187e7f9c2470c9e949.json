{"sha": "bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiYzJhZTc1OTBhZDUzZmNhMDJmZGExODdlN2Y5YzI0NzBjOWU5NDk=", "commit": {"author": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2020-01-26T21:28:09Z"}, "committer": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2020-01-26T21:32:43Z"}, "message": "rustdoc: Fix re-exporting primitive types\n\n* Generate links to the primitive type docs for re-exports.\n* Don't ICE on cross crate primitive type re-exports.\n* Make primitive type re-exports show up cross crate.", "tree": {"sha": "81c7cf5218d27e6447126afb9a354798d3e0097b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81c7cf5218d27e6447126afb9a354798d3e0097b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "html_url": "https://github.com/rust-lang/rust/commit/bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/comments", "author": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80a65bcaf2f2b8a5c659b21b32b42bc300338a0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/80a65bcaf2f2b8a5c659b21b32b42bc300338a0e", "html_url": "https://github.com/rust-lang/rust/commit/80a65bcaf2f2b8a5c659b21b32b42bc300338a0e"}], "stats": {"total": 108, "additions": 91, "deletions": 17}, "files": [{"sha": "df72bf0b56e61c07fc9ba70b123667ceacced973", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 33, "deletions": 4, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "patch": "@@ -445,12 +445,41 @@ fn build_module(cx: &DocContext<'_>, did: DefId, visited: &mut FxHashSet<DefId>)\n         // two namespaces, so the target may be listed twice. Make sure we only\n         // visit each node at most once.\n         for &item in cx.tcx.item_children(did).iter() {\n-            let def_id = item.res.def_id();\n             if item.vis == ty::Visibility::Public {\n-                if did == def_id || !visited.insert(def_id) {\n-                    continue;\n+                if let Some(def_id) = item.res.mod_def_id() {\n+                    if did == def_id || !visited.insert(def_id) {\n+                        continue;\n+                    }\n                 }\n-                if let Some(i) = try_inline(cx, item.res, item.ident.name, None, visited) {\n+                if let Res::PrimTy(p) = item.res {\n+                    // Primitive types can't be inlined so generate an import instead.\n+                    items.push(clean::Item {\n+                        name: None,\n+                        attrs: clean::Attributes::default(),\n+                        source: clean::Span::empty(),\n+                        def_id: cx.tcx.hir().local_def_id_from_node_id(ast::CRATE_NODE_ID),\n+                        visibility: clean::Public,\n+                        stability: None,\n+                        deprecation: None,\n+                        inner: clean::ImportItem(clean::Import::Simple(\n+                            item.ident.to_string(),\n+                            clean::ImportSource {\n+                                path: clean::Path {\n+                                    global: false,\n+                                    res: item.res,\n+                                    segments: vec![clean::PathSegment {\n+                                        name: clean::PrimitiveType::from(p).as_str().to_string(),\n+                                        args: clean::GenericArgs::AngleBracketed {\n+                                            args: Vec::new(),\n+                                            bindings: Vec::new(),\n+                                        },\n+                                    }],\n+                                },\n+                                did: None,\n+                            },\n+                        )),\n+                    });\n+                } else if let Some(i) = try_inline(cx, item.res, item.ident.name, None, visited) {\n                     items.extend(i)\n                 }\n             }"}, {"sha": "8501fee56cfaedfd5b41cd8c01d3df1ee2a16282", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "patch": "@@ -1290,6 +1290,19 @@ impl From<ast::FloatTy> for PrimitiveType {\n     }\n }\n \n+impl From<hir::PrimTy> for PrimitiveType {\n+    fn from(prim_ty: hir::PrimTy) -> PrimitiveType {\n+        match prim_ty {\n+            hir::PrimTy::Int(int_ty) => int_ty.into(),\n+            hir::PrimTy::Uint(uint_ty) => uint_ty.into(),\n+            hir::PrimTy::Float(float_ty) => float_ty.into(),\n+            hir::PrimTy::Str => PrimitiveType::Str,\n+            hir::PrimTy::Bool => PrimitiveType::Bool,\n+            hir::PrimTy::Char => PrimitiveType::Char,\n+        }\n+    }\n+}\n+\n #[derive(Clone, PartialEq, Eq, Debug)]\n pub enum Visibility {\n     Public,"}, {"sha": "b6a39c7422fdc809f0ef3f6e05427a5041f5d949", "filename": "src/librustdoc/clean/utils.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fclean%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fclean%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Futils.rs?ref=bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "patch": "@@ -570,14 +570,7 @@ pub fn resolve_type(cx: &DocContext<'_>, path: Path, id: hir::HirId) -> Type {\n     }\n \n     let is_generic = match path.res {\n-        Res::PrimTy(p) => match p {\n-            hir::PrimTy::Str => return Primitive(PrimitiveType::Str),\n-            hir::PrimTy::Bool => return Primitive(PrimitiveType::Bool),\n-            hir::PrimTy::Char => return Primitive(PrimitiveType::Char),\n-            hir::PrimTy::Int(int_ty) => return Primitive(int_ty.into()),\n-            hir::PrimTy::Uint(uint_ty) => return Primitive(uint_ty.into()),\n-            hir::PrimTy::Float(float_ty) => return Primitive(float_ty.into()),\n-        },\n+        Res::PrimTy(p) => return Primitive(PrimitiveType::from(p)),\n         Res::SelfTy(..) if path.segments.len() == 1 => {\n             return Generic(kw::SelfUpper.to_string());\n         }"}, {"sha": "c3313ba63ef13785f55ad1b6b1cc63cf86e1836c", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "patch": "@@ -1171,11 +1171,14 @@ impl clean::ImportSource {\n         display_fn(move |f| match self.did {\n             Some(did) => resolved_path(f, did, &self.path, true, false),\n             _ => {\n-                for (i, seg) in self.path.segments.iter().enumerate() {\n-                    if i > 0 {\n-                        write!(f, \"::\")?\n-                    }\n-                    write!(f, \"{}\", seg.name)?;\n+                for seg in &self.path.segments[..self.path.segments.len() - 1] {\n+                    write!(f, \"{}::\", seg.name)?;\n+                }\n+                let name = self.path.last_name();\n+                if let hir::def::Res::PrimTy(p) = self.path.res {\n+                    primitive_link(f, PrimitiveType::from(p), name)?;\n+                } else {\n+                    write!(f, \"{}\", name)?;\n                 }\n                 Ok(())\n             }"}, {"sha": "b2e9fa43b395afb4c102228a6a46fa4fb3cfebfa", "filename": "src/test/rustdoc/auxiliary/primitive-reexport.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Ftest%2Frustdoc%2Fauxiliary%2Fprimitive-reexport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Ftest%2Frustdoc%2Fauxiliary%2Fprimitive-reexport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fauxiliary%2Fprimitive-reexport.rs?ref=bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: --emit metadata --crate-type lib --edition 2018\n+\n+#![crate_name = \"foo\"]\n+\n+pub mod bar {\n+    pub use bool;\n+    pub use char as my_char;\n+}"}, {"sha": "de18360d4077c2615a47a5081ee0b0cd647ccf56", "filename": "src/test/rustdoc/primitive-reexport.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Ftest%2Frustdoc%2Fprimitive-reexport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc2ae7590ad53fca02fda187e7f9c2470c9e949/src%2Ftest%2Frustdoc%2Fprimitive-reexport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fprimitive-reexport.rs?ref=bbc2ae7590ad53fca02fda187e7f9c2470c9e949", "patch": "@@ -0,0 +1,28 @@\n+// aux-build: primitive-reexport.rs\n+// compile-flags:--extern foo --edition 2018\n+\n+#![crate_name = \"bar\"]\n+\n+// @has bar/p/index.html\n+// @has - '//code' 'pub use bool;'\n+// @has - '//code/a[@href=\"https://doc.rust-lang.org/nightly/std/primitive.bool.html\"]' 'bool'\n+// @has - '//code' 'pub use char as my_char;'\n+// @has - '//code/a[@href=\"https://doc.rust-lang.org/nightly/std/primitive.char.html\"]' 'char'\n+pub mod p {\n+    pub use foo::bar::*;\n+}\n+\n+// @has bar/baz/index.html\n+// @has - '//code' 'pub use bool;'\n+// @has - '//code/a[@href=\"https://doc.rust-lang.org/nightly/std/primitive.bool.html\"]' 'bool'\n+// @has - '//code' 'pub use char as my_char;'\n+// @has - '//code/a[@href=\"https://doc.rust-lang.org/nightly/std/primitive.char.html\"]' 'char'\n+pub use foo::bar as baz;\n+\n+// @has bar/index.html\n+// @has - '//code' 'pub use str;'\n+// @has - '//code/a[@href=\"https://doc.rust-lang.org/nightly/std/primitive.str.html\"]' 'str'\n+// @has - '//code' 'pub use i32 as my_i32;'\n+// @has - '//code/a[@href=\"https://doc.rust-lang.org/nightly/std/primitive.i32.html\"]' 'i32'\n+pub use str;\n+pub use i32 as my_i32;"}]}