{"sha": "ae0eb675db97a57a63f941b29754d8e32040ecc9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFlMGViNjc1ZGI5N2E1N2E2M2Y5NDFiMjk3NTRkOGUzMjA0MGVjYzk=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-06-30T06:28:39Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-07-01T16:35:55Z"}, "message": "msvc: Fix TLS destructors\n\nJust like the original article our Windows TLS support is based on predicted,\nthis symbol must be linked in on MSVC to pull in the necessary support for TLS\nvariables. This commit fixes a number of unit tests which require that TLS\ndestructors are run.", "tree": {"sha": "247e31e2ced1bc9463014f95afee0dd05f383840", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/247e31e2ced1bc9463014f95afee0dd05f383840"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ae0eb675db97a57a63f941b29754d8e32040ecc9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ae0eb675db97a57a63f941b29754d8e32040ecc9", "html_url": "https://github.com/rust-lang/rust/commit/ae0eb675db97a57a63f941b29754d8e32040ecc9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ae0eb675db97a57a63f941b29754d8e32040ecc9/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91c22b63020e15908859b11bfe777d65bc55aa98", "url": "https://api.github.com/repos/rust-lang/rust/commits/91c22b63020e15908859b11bfe777d65bc55aa98", "html_url": "https://github.com/rust-lang/rust/commit/91c22b63020e15908859b11bfe777d65bc55aa98"}], "stats": {"total": 9, "additions": 7, "deletions": 2}, "files": [{"sha": "73e45619774d7f99bc3d25e1809c146fc08542f4", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ae0eb675db97a57a63f941b29754d8e32040ecc9/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae0eb675db97a57a63f941b29754d8e32040ecc9/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=ae0eb675db97a57a63f941b29754d8e32040ecc9", "patch": "@@ -151,6 +151,7 @@\n #![cfg_attr(windows, feature(str_utf16))]\n #![cfg_attr(test, feature(float_from_str_radix, range_inclusive, float_extras))]\n #![cfg_attr(test, feature(test, rustc_private, float_consts))]\n+#![cfg_attr(target_env = \"msvc\", feature(link_args))]\n \n // Don't link to std. We are std.\n #![no_std]"}, {"sha": "a2dbb0f8342433524f6937daede9689abfc16768", "filename": "src/libstd/sys/windows/thread_local.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ae0eb675db97a57a63f941b29754d8e32040ecc9/src%2Flibstd%2Fsys%2Fwindows%2Fthread_local.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae0eb675db97a57a63f941b29754d8e32040ecc9/src%2Flibstd%2Fsys%2Fwindows%2Fthread_local.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fthread_local.rs?ref=ae0eb675db97a57a63f941b29754d8e32040ecc9", "patch": "@@ -221,8 +221,8 @@ unsafe fn unregister_dtor(key: Key) -> bool {\n //\n // # The article mentions crazy stuff about \"/INCLUDE\"?\n //\n-// It sure does! This seems to work for now, so maybe we'll just run into\n-// that if we start linking with msvc?\n+// It sure does! We include it below for MSVC targets, but it look like for GNU\n+// targets we don't require it.\n \n #[link_section = \".CRT$XLB\"]\n #[linkage = \"external\"]\n@@ -231,6 +231,10 @@ pub static p_thread_callback: unsafe extern \"system\" fn(LPVOID, DWORD,\n                                                         LPVOID) =\n         on_tls_callback;\n \n+#[cfg(target_env = \"msvc\")]\n+#[link_args = \"/INCLUDE:_tls_used\"]\n+extern {}\n+\n #[allow(warnings)]\n unsafe extern \"system\" fn on_tls_callback(h: LPVOID,\n                                           dwReason: DWORD,"}]}