{"sha": "7d076bcaa0adb15424e17e22976dc647859c12af", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdkMDc2YmNhYTBhZGIxNTQyNGUxN2UyMjk3NmRjNjQ3ODU5YzEyYWY=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-06-30T07:07:37Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-06-30T07:07:37Z"}, "message": "Get compiler to the point of building std.rc and rustc.rc.", "tree": {"sha": "13122785d3af692bb22c4e348479a3d28aeda08a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/13122785d3af692bb22c4e348479a3d28aeda08a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7d076bcaa0adb15424e17e22976dc647859c12af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7d076bcaa0adb15424e17e22976dc647859c12af", "html_url": "https://github.com/rust-lang/rust/commit/7d076bcaa0adb15424e17e22976dc647859c12af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7d076bcaa0adb15424e17e22976dc647859c12af/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "675f90eca35cd91de11700e841eb3406548160d9", "url": "https://api.github.com/repos/rust-lang/rust/commits/675f90eca35cd91de11700e841eb3406548160d9", "html_url": "https://github.com/rust-lang/rust/commit/675f90eca35cd91de11700e841eb3406548160d9"}], "stats": {"total": 14, "additions": 11, "deletions": 3}, "files": [{"sha": "e409602a69eac50f031b6cb38b5a3fec8996adea", "filename": "src/boot/me/trans.ml", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/7d076bcaa0adb15424e17e22976dc647859c12af/src%2Fboot%2Fme%2Ftrans.ml", "raw_url": "https://github.com/rust-lang/rust/raw/7d076bcaa0adb15424e17e22976dc647859c12af/src%2Fboot%2Fme%2Ftrans.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Ftrans.ml?ref=7d076bcaa0adb15424e17e22976dc647859c12af", "patch": "@@ -2218,6 +2218,13 @@ let trans_visitor\n   and exterior_rc_cell (cell:Il.cell) : Il.cell =\n     exterior_ctrl_cell cell Abi.exterior_rc_slot_field_refcnt\n \n+  and simplified_ty t =\n+    match t with\n+        Ast.TY_exterior t\n+      | Ast.TY_mutable t\n+      | Ast.TY_constrained (t, _) -> simplified_ty t\n+      | _ -> t\n+\n   and exterior_allocation_size\n       (ty:Ast.ty)\n       : Il.operand =\n@@ -2228,6 +2235,7 @@ let trans_visitor\n         | MEM_rc_struct -> word_n Abi.exterior_rc_header_size\n         | MEM_interior -> bug () \"exterior_allocation_size of MEM_interior\"\n     in\n+    let ty = simplified_ty ty in\n     let refty_sz =\n       Il.referent_ty_size abi.Abi.abi_word_bits (referent_type abi ty)\n     in\n@@ -3958,8 +3966,8 @@ let trans_visitor\n   and trans_vec_append dst_cell dst_ty src_oper src_ty =\n     let elt_ty = seq_unit_ty dst_ty in\n     let trim_trailing_null = dst_ty = Ast.TY_str in\n-      assert (src_ty = dst_ty);\n-      match src_ty with\n+      assert (simplified_ty src_ty = simplified_ty dst_ty);\n+      match simplified_ty src_ty with\n           Ast.TY_str\n         | Ast.TY_vec _ ->\n             let is_gc = if type_has_state src_ty then 1L else 0L in\n@@ -4410,7 +4418,7 @@ let trans_visitor\n     let state_ty = Ast.TY_tup [| Ast.TY_type; obj_args_ty |] in\n     let state_ptr_ty = Ast.TY_exterior state_ty in\n     let state_ptr_rty = referent_type abi state_ptr_ty in\n-    let state_malloc_sz = exterior_allocation_size state_ty in\n+    let state_malloc_sz = exterior_allocation_size state_ptr_ty in\n \n     let ctor_ty = Hashtbl.find cx.ctxt_all_item_types obj_id in\n     let obj_ty ="}]}