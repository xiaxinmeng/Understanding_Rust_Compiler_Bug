{"sha": "441b9940ecc2056f04065f8d08ae7cde8bdae684", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0MWI5OTQwZWNjMjA1NmYwNDA2NWY4ZDA4YWU3Y2RlOGJkYWU2ODQ=", "commit": {"author": {"name": "Oliver Schneider", "email": "git1984941651981@oli-obk.de", "date": "2015-07-13T08:53:16Z"}, "committer": {"name": "Oliver Schneider", "email": "git1984941651981@oli-obk.de", "date": "2015-07-13T08:53:16Z"}, "message": "simplify processing of ConstVal objects when not all variants are legal", "tree": {"sha": "b6bceaa1b2483c57d3238ce443b39972adbc2731", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6bceaa1b2483c57d3238ce443b39972adbc2731"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/441b9940ecc2056f04065f8d08ae7cde8bdae684", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/441b9940ecc2056f04065f8d08ae7cde8bdae684", "html_url": "https://github.com/rust-lang/rust/commit/441b9940ecc2056f04065f8d08ae7cde8bdae684", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/441b9940ecc2056f04065f8d08ae7cde8bdae684/comments", "author": null, "committer": null, "parents": [{"sha": "67256dff6dd7526f0be9da5092a6b3e390654c8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/67256dff6dd7526f0be9da5092a6b3e390654c8c", "html_url": "https://github.com/rust-lang/rust/commit/67256dff6dd7526f0be9da5092a6b3e390654c8c"}], "stats": {"total": 105, "additions": 51, "deletions": 54}, "files": [{"sha": "cf71c53e4032bbf6c541b2ddb3b80f9db6a0b073", "filename": "src/librustc/middle/const_eval.rs", "status": "modified", "additions": 22, "deletions": 30, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/441b9940ecc2056f04065f8d08ae7cde8bdae684/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/441b9940ecc2056f04065f8d08ae7cde8bdae684/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs?ref=441b9940ecc2056f04065f8d08ae7cde8bdae684", "patch": "@@ -273,6 +273,22 @@ pub enum ConstVal {\n     Tuple(ast::NodeId),\n }\n \n+impl ConstVal {\n+    pub fn description(&self) -> &'static str {\n+        match *self {\n+            Float(_) => \"float\",\n+            Int(i) if i < 0 => \"negative integer\",\n+            Int(_) => \"positive integer\",\n+            Uint(_) => \"unsigned integer\",\n+            Str(_) => \"string literal\",\n+            Binary(_) => \"binary array\",\n+            Bool(_) => \"boolean\",\n+            Struct(_) => \"struct\",\n+            Tuple(_) => \"tuple\",\n+        }\n+    }\n+}\n+\n pub fn const_expr_to_pat(tcx: &ty::ctxt, expr: &Expr, span: Span) -> P<ast::Pat> {\n     let pat = match expr.node {\n         ast::ExprTup(ref exprs) =>\n@@ -352,16 +368,8 @@ pub enum ErrKind {\n     InvalidOpForFloats(ast::BinOp_),\n     InvalidOpForIntUint(ast::BinOp_),\n     InvalidOpForUintInt(ast::BinOp_),\n-    NegateOnString,\n-    NegateOnBoolean,\n-    NegateOnBinary,\n-    NegateOnStruct,\n-    NegateOnTuple,\n-    NotOnFloat,\n-    NotOnString,\n-    NotOnBinary,\n-    NotOnStruct,\n-    NotOnTuple,\n+    NegateOn(ConstVal),\n+    NotOn(ConstVal),\n \n     NegateWithOverflow(i64),\n     AddiWithOverflow(i64, i64),\n@@ -397,16 +405,8 @@ impl ConstEvalErr {\n             InvalidOpForFloats(_) => \"can't do this op on floats\".into_cow(),\n             InvalidOpForIntUint(..) => \"can't do this op on an isize and usize\".into_cow(),\n             InvalidOpForUintInt(..) => \"can't do this op on a usize and isize\".into_cow(),\n-            NegateOnString => \"negate on string\".into_cow(),\n-            NegateOnBoolean => \"negate on boolean\".into_cow(),\n-            NegateOnBinary => \"negate on binary literal\".into_cow(),\n-            NegateOnStruct => \"negate on struct\".into_cow(),\n-            NegateOnTuple => \"negate on tuple\".into_cow(),\n-            NotOnFloat => \"not on float or string\".into_cow(),\n-            NotOnString => \"not on float or string\".into_cow(),\n-            NotOnBinary => \"not on binary literal\".into_cow(),\n-            NotOnStruct => \"not on struct\".into_cow(),\n-            NotOnTuple => \"not on tuple\".into_cow(),\n+            NegateOn(ref const_val) => format!(\"negate on {}\", const_val.description()).into_cow(),\n+            NotOn(ref const_val) => format!(\"not on {}\", const_val.description()).into_cow(),\n \n             NegateWithOverflow(..) => \"attempted to negate with overflow\".into_cow(),\n             AddiWithOverflow(..) => \"attempted to add with overflow\".into_cow(),\n@@ -754,23 +754,15 @@ pub fn eval_const_expr_with_substs<'tcx, S>(tcx: &ty::ctxt<'tcx>,\n               }\n               try!(const_uint_checked_neg(i, e, expr_uint_type))\n           }\n-          Str(_) => signal!(e, NegateOnString),\n-          Bool(_) => signal!(e, NegateOnBoolean),\n-          Binary(_) => signal!(e, NegateOnBinary),\n-          Tuple(_) => signal!(e, NegateOnTuple),\n-          Struct(..) => signal!(e, NegateOnStruct),\n+          const_val => signal!(e, NegateOn(const_val)),\n         }\n       }\n       ast::ExprUnary(ast::UnNot, ref inner) => {\n         match try!(eval_const_expr_partial(tcx, &**inner, ety)) {\n           Int(i) => Int(!i),\n           Uint(i) => const_uint_not(i, expr_uint_type),\n           Bool(b) => Bool(!b),\n-          Str(_) => signal!(e, NotOnString),\n-          Float(_) => signal!(e, NotOnFloat),\n-          Binary(_) => signal!(e, NotOnBinary),\n-          Tuple(_) => signal!(e, NotOnTuple),\n-          Struct(..) => signal!(e, NotOnStruct),\n+          const_val => signal!(e, NotOn(const_val)),\n         }\n       }\n       ast::ExprBinary(op, ref a, ref b) => {"}, {"sha": "705e11f0597f15f069af9408bd31234a915ffcf0", "filename": "src/librustc/middle/ty.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/441b9940ecc2056f04065f8d08ae7cde8bdae684/src%2Flibrustc%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/441b9940ecc2056f04065f8d08ae7cde8bdae684/src%2Flibrustc%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fty.rs?ref=441b9940ecc2056f04065f8d08ae7cde8bdae684", "patch": "@@ -6100,13 +6100,7 @@ impl<'tcx> ctxt<'tcx> {\n                 let found = match val {\n                     ConstVal::Uint(count) => return count as usize,\n                     ConstVal::Int(count) if count >= 0 => return count as usize,\n-                    ConstVal::Int(_) => \"negative integer\",\n-                    ConstVal::Float(_) => \"float\",\n-                    ConstVal::Str(_) => \"string\",\n-                    ConstVal::Bool(_) => \"boolean\",\n-                    ConstVal::Binary(_) => \"binary array\",\n-                    ConstVal::Struct(..) => \"struct\",\n-                    ConstVal::Tuple(_) => \"tuple\"\n+                    const_val => const_val.description(),\n                 };\n                 span_err!(self.sess, count_expr.span, E0306,\n                     \"expected positive integer for repeat count, found {}\","}, {"sha": "7a0623ba44f0240c2713d3dd644ffa5917ad6d77", "filename": "src/test/compile-fail/repeat_count.rs", "status": "modified", "additions": 28, "deletions": 17, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/441b9940ecc2056f04065f8d08ae7cde8bdae684/src%2Ftest%2Fcompile-fail%2Frepeat_count.rs", "raw_url": "https://github.com/rust-lang/rust/raw/441b9940ecc2056f04065f8d08ae7cde8bdae684/src%2Ftest%2Fcompile-fail%2Frepeat_count.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Frepeat_count.rs?ref=441b9940ecc2056f04065f8d08ae7cde8bdae684", "patch": "@@ -12,47 +12,58 @@\n \n fn main() {\n     let n = 1;\n-    let a = [0; n]; //~ ERROR expected constant integer for repeat count, found variable\n+    let a = [0; n];\n+    //~^ ERROR expected constant integer for repeat count, found variable [E0307]\n     let b = [0; ()];\n-//~^ ERROR mismatched types\n-//~| expected `usize`\n-//~| found `()`\n-//~| expected usize\n-//~| found ()\n-//~| ERROR expected positive integer for repeat count, found tuple\n+    //~^ ERROR mismatched types\n+    //~| expected `usize`\n+    //~| found `()`\n+    //~| expected usize\n+    //~| found ()) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found tuple [E0306]\n     let c = [0; true];\n     //~^ ERROR mismatched types\n     //~| expected `usize`\n     //~| found `bool`\n     //~| expected usize\n-    //~| found bool\n-    //~| ERROR expected positive integer for repeat count, found boolean\n+    //~| found bool) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found boolean [E0306]\n     let d = [0; 0.5];\n     //~^ ERROR mismatched types\n     //~| expected `usize`\n     //~| found `_`\n     //~| expected usize\n-    //~| found floating-point variable\n-    //~| ERROR expected positive integer for repeat count, found float\n+    //~| found floating-point variable) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found float [E0306]\n     let e = [0; \"foo\"];\n     //~^ ERROR mismatched types\n     //~| expected `usize`\n     //~| found `&'static str`\n     //~| expected usize\n-    //~| found &-ptr\n-    //~| ERROR expected positive integer for repeat count, found string\n+    //~| found &-ptr) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found string literal [E0306]\n     let f = [0; -4_isize];\n     //~^ ERROR mismatched types\n     //~| expected `usize`\n     //~| found `isize`\n     //~| expected usize\n-    //~| found isize\n-    //~| ERROR expected positive integer for repeat count, found negative integer\n+    //~| found isize) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found negative integer [E0306]\n     let f = [0_usize; -1_isize];\n     //~^ ERROR mismatched types\n     //~| expected `usize`\n     //~| found `isize`\n     //~| expected usize\n-    //~| found isize\n-    //~| ERROR expected positive integer for repeat count, found negative integer\n+    //~| found isize) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found negative integer [E0306]\n+    struct G {\n+        g: (),\n+    }\n+    let g = [0; G { g: () }];\n+    //~^ ERROR mismatched types\n+    //~| expected `usize`\n+    //~| found `main::G`\n+    //~| expected usize\n+    //~| found struct `main::G`) [E0308]\n+    //~| ERROR expected positive integer for repeat count, found struct [E0306]\n }"}]}