{"sha": "b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3YjUyY2M4YmYyYmNjNGNiZDIyM2E0YjYxZmUzZTM1ZTc5OGY2ZTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-21T16:15:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-21T16:15:16Z"}, "message": "Auto merge of #46877 - Deewiant:gh46843, r=eddyb\n\nMIR: terminate unreachable blocks in construct_const\n\nFixes #46843.\n\n#45821 added unreachable blocks in matches, which were terminated in\nconstruct_fn but not in construct_const, causing a panic due to \"no\nterminator on block\" when constants involved matching on enums.\n\nThe \"unimplemented expression type\" error may go away in the future, the\nkey is that we see the E0015 about using a non-const function and then\ndon't ICE.", "tree": {"sha": "b7e406e6dd07ffd6ad43ab619c06ca550f669e26", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b7e406e6dd07ffd6ad43ab619c06ca550f669e26"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2", "html_url": "https://github.com/rust-lang/rust/commit/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eff3de0927c36e6483ccb8a35c3d2da6e063de0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/eff3de0927c36e6483ccb8a35c3d2da6e063de0b", "html_url": "https://github.com/rust-lang/rust/commit/eff3de0927c36e6483ccb8a35c3d2da6e063de0b"}, {"sha": "8dfc47a4c9728ae7edcfb6a51515af00db994641", "url": "https://api.github.com/repos/rust-lang/rust/commits/8dfc47a4c9728ae7edcfb6a51515af00db994641", "html_url": "https://github.com/rust-lang/rust/commit/8dfc47a4c9728ae7edcfb6a51515af00db994641"}], "stats": {"total": 29, "additions": 29, "deletions": 0}, "files": [{"sha": "51ebb78c74ef8c80eff7961b12f0fefa6c705ce3", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2", "patch": "@@ -472,6 +472,13 @@ fn construct_const<'a, 'gcx, 'tcx>(hir: Cx<'a, 'gcx, 'tcx>,\n     // Constants can't `return` so a return block should not be created.\n     assert_eq!(builder.cached_return_block, None);\n \n+    // Constants may be match expressions in which case an unreachable block may\n+    // be created, so terminate it properly.\n+    if let Some(unreachable_block) = builder.cached_unreachable_block {\n+        builder.cfg.terminate(unreachable_block, source_info,\n+                              TerminatorKind::Unreachable);\n+    }\n+\n     builder.finish(vec![], None)\n }\n "}, {"sha": "d88b4e568b0344bb2f844e425c3c3782a352bb05", "filename": "src/test/compile-fail/issue-46843.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2/src%2Ftest%2Fcompile-fail%2Fissue-46843.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2/src%2Ftest%2Fcompile-fail%2Fissue-46843.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-46843.rs?ref=b7b52cc8bf2bcc4cbd223a4b61fe3e35e798f6e2", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+enum Thing { This, That }\n+\n+fn non_const() -> Thing {\n+    Thing::This\n+}\n+\n+pub const Q: i32 = match non_const() { //~ ERROR E0015\n+    Thing::This => 1, //~ ERROR unimplemented expression type\n+    Thing::That => 0\n+};\n+\n+fn main() {}"}]}