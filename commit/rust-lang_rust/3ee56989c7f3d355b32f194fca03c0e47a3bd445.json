{"sha": "3ee56989c7f3d355b32f194fca03c0e47a3bd445", "node_id": "C_kwDOAAsO6NoAKDNlZTU2OTg5YzdmM2QzNTViMzJmMTk0ZmNhMDNjMGU0N2EzYmQ0NDU", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-07-24T12:48:58Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-07-24T13:26:11Z"}, "message": "get rid of some uses of core_intrinsics", "tree": {"sha": "9959e1f30583d0e4d846ee7abb02f6e2715f9aec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9959e1f30583d0e4d846ee7abb02f6e2715f9aec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ee56989c7f3d355b32f194fca03c0e47a3bd445", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ee56989c7f3d355b32f194fca03c0e47a3bd445", "html_url": "https://github.com/rust-lang/rust/commit/3ee56989c7f3d355b32f194fca03c0e47a3bd445", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ee56989c7f3d355b32f194fca03c0e47a3bd445/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c33fc24566da5e342e03183c07314c910b690d25", "url": "https://api.github.com/repos/rust-lang/rust/commits/c33fc24566da5e342e03183c07314c910b690d25", "html_url": "https://github.com/rust-lang/rust/commit/c33fc24566da5e342e03183c07314c910b690d25"}], "stats": {"total": 45, "additions": 16, "deletions": 29}, "files": [{"sha": "30900a85d003f53d3e35404da071613b5383bfd1", "filename": "tests/fail/data_race/atomic_read_na_write_race1.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_read_na_write_race1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_read_na_write_race1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fdata_race%2Fatomic_read_na_write_race1.rs?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,10 +1,8 @@\n // We want to control preemption here.\n //@compile-flags: -Zmiri-preemption-rate=0\n //@ignore-target-windows: Concurrency on Windows is not supported yet.\n-#![feature(core_intrinsics)]\n \n-use std::intrinsics;\n-use std::sync::atomic::AtomicUsize;\n+use std::sync::atomic::{AtomicUsize, Ordering};\n use std::thread::spawn;\n \n #[derive(Copy, Clone)]\n@@ -23,8 +21,7 @@ pub fn main() {\n         });\n \n         let j2 = spawn(move || {\n-            //Equivalent to: (&*c.0).load(Ordering::SeqCst)\n-            intrinsics::atomic_load_seqcst(c.0 as *mut usize) //~ ERROR: Data race detected between Atomic Load on thread `<unnamed>` and Write on thread `<unnamed>`\n+            (&*c.0).load(Ordering::SeqCst) //~ ERROR: Data race detected between Atomic Load on thread `<unnamed>` and Write on thread `<unnamed>`\n         });\n \n         j1.join().unwrap();"}, {"sha": "e7a219e1235269a6dc170b8c267c47a364becb1b", "filename": "tests/fail/data_race/atomic_read_na_write_race1.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_read_na_write_race1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_read_na_write_race1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fdata_race%2Fatomic_read_na_write_race1.stderr?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,8 +1,8 @@\n error: Undefined Behavior: Data race detected between Atomic Load on thread `<unnamed>` and Write on thread `<unnamed>` at ALLOC\n   --> $DIR/atomic_read_na_write_race1.rs:LL:CC\n    |\n-LL |             intrinsics::atomic_load_seqcst(c.0 as *mut usize)\n-   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Data race detected between Atomic Load on thread `<unnamed>` and Write on thread `<unnamed>` at ALLOC\n+LL |             (&*c.0).load(Ordering::SeqCst)\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Data race detected between Atomic Load on thread `<unnamed>` and Write on thread `<unnamed>` at ALLOC\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior\n    = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information"}, {"sha": "1a79dde0b08ac3a54efa26a33d441069aaed01e2", "filename": "tests/fail/data_race/atomic_write_na_read_race2.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_read_race2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_read_race2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fdata_race%2Fatomic_write_na_read_race2.rs?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,10 +1,8 @@\n // We want to control preemption here.\n //@compile-flags: -Zmiri-preemption-rate=0\n //@ignore-target-windows: Concurrency on Windows is not supported yet.\n-#![feature(core_intrinsics)]\n \n-use std::intrinsics::atomic_store;\n-use std::sync::atomic::AtomicUsize;\n+use std::sync::atomic::{AtomicUsize, Ordering};\n use std::thread::spawn;\n \n #[derive(Copy, Clone)]\n@@ -23,8 +21,7 @@ pub fn main() {\n         });\n \n         let j2 = spawn(move || {\n-            //Equivalent to: (&*c.0).store(32, Ordering::SeqCst)\n-            atomic_store(c.0 as *mut usize, 32); //~ ERROR: Data race detected between Atomic Store on thread `<unnamed>` and Read on thread `<unnamed>`\n+            (&*c.0).store(32, Ordering::SeqCst); //~ ERROR: Data race detected between Atomic Store on thread `<unnamed>` and Read on thread `<unnamed>`\n         });\n \n         j1.join().unwrap();"}, {"sha": "e9c6005f27e6bd3178553464257cd0e588bc14cc", "filename": "tests/fail/data_race/atomic_write_na_read_race2.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_read_race2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_read_race2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fdata_race%2Fatomic_write_na_read_race2.stderr?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,7 +1,7 @@\n error: Undefined Behavior: Data race detected between Atomic Store on thread `<unnamed>` and Read on thread `<unnamed>` at ALLOC\n   --> $DIR/atomic_write_na_read_race2.rs:LL:CC\n    |\n-LL |             atomic_store(c.0 as *mut usize, 32);\n+LL |             (&*c.0).store(32, Ordering::SeqCst);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Data race detected between Atomic Store on thread `<unnamed>` and Read on thread `<unnamed>` at ALLOC\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior"}, {"sha": "04015c2d14205c6715aae577ea49a5faa52e8058", "filename": "tests/fail/data_race/atomic_write_na_write_race1.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_write_race1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_write_race1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fdata_race%2Fatomic_write_na_write_race1.rs?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,10 +1,8 @@\n // We want to control preemption here.\n //@compile-flags: -Zmiri-preemption-rate=0\n //@ignore-target-windows: Concurrency on Windows is not supported yet.\n-#![feature(core_intrinsics)]\n \n-use std::intrinsics::atomic_store;\n-use std::sync::atomic::AtomicUsize;\n+use std::sync::atomic::{AtomicUsize, Ordering};\n use std::thread::spawn;\n \n #[derive(Copy, Clone)]\n@@ -23,8 +21,7 @@ pub fn main() {\n         });\n \n         let j2 = spawn(move || {\n-            //Equivalent to: (&*c.0).store(64, Ordering::SeqCst)\n-            atomic_store(c.0 as *mut usize, 64); //~ ERROR: Data race detected between Atomic Store on thread `<unnamed>` and Write on thread `<unnamed>`\n+            (&*c.0).store(64, Ordering::SeqCst); //~ ERROR: Data race detected between Atomic Store on thread `<unnamed>` and Write on thread `<unnamed>`\n         });\n \n         j1.join().unwrap();"}, {"sha": "5ecc4ca04026320337e88348b1c71e91edfce256", "filename": "tests/fail/data_race/atomic_write_na_write_race1.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_write_race1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fdata_race%2Fatomic_write_na_write_race1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fdata_race%2Fatomic_write_na_write_race1.stderr?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,7 +1,7 @@\n error: Undefined Behavior: Data race detected between Atomic Store on thread `<unnamed>` and Write on thread `<unnamed>` at ALLOC\n   --> $DIR/atomic_write_na_write_race1.rs:LL:CC\n    |\n-LL |             atomic_store(c.0 as *mut usize, 64);\n+LL |             (&*c.0).store(64, Ordering::SeqCst);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Data race detected between Atomic Store on thread `<unnamed>` and Write on thread `<unnamed>` at ALLOC\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior"}, {"sha": "1c0b1c2be8fdaaac7c1df61db8cd478cdc12accf", "filename": "tests/fail/weak_memory/racing_mixed_size_read.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fweak_memory%2Fracing_mixed_size_read.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fweak_memory%2Fracing_mixed_size_read.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fweak_memory%2Fracing_mixed_size_read.rs?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -2,10 +2,8 @@\n //@compile-flags: -Zmiri-preemption-rate=0\n //@ignore-target-windows: Concurrency on Windows is not supported yet.\n \n-#![feature(core_intrinsics)]\n-\n-use std::sync::atomic::AtomicU32;\n use std::sync::atomic::Ordering::*;\n+use std::sync::atomic::{AtomicU16, AtomicU32};\n use std::thread::spawn;\n \n fn static_atomic(val: u32) -> &'static AtomicU32 {\n@@ -31,8 +29,8 @@ pub fn main() {\n         let x_ptr = x as *const AtomicU32 as *const u32;\n         let x_split = split_u32_ptr(x_ptr);\n         unsafe {\n-            let hi = &(*x_split)[0] as *const u16;\n-            std::intrinsics::atomic_load_relaxed(hi); //~ ERROR: imperfectly overlapping\n+            let hi = x_split as *const u16 as *const AtomicU16;\n+            (*hi).load(Relaxed); //~ ERROR: imperfectly overlapping\n         }\n     });\n "}, {"sha": "8dbf9e6948bd7975a7a0ca4a153e3b7a305abe9d", "filename": "tests/fail/weak_memory/racing_mixed_size_read.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fweak_memory%2Fracing_mixed_size_read.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Ffail%2Fweak_memory%2Fracing_mixed_size_read.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffail%2Fweak_memory%2Fracing_mixed_size_read.stderr?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -1,8 +1,8 @@\n error: unsupported operation: racy imperfectly overlapping atomic access is not possible in the C++20 memory model, and not supported by Miri's weak memory emulation\n   --> $DIR/racing_mixed_size_read.rs:LL:CC\n    |\n-LL |             std::intrinsics::atomic_load_relaxed(hi);\n-   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ racy imperfectly overlapping atomic access is not possible in the C++20 memory model, and not supported by Miri's weak memory emulation\n+LL |             (*hi).load(Relaxed);\n+   |             ^^^^^^^^^^^^^^^^^^^ racy imperfectly overlapping atomic access is not possible in the C++20 memory model, and not supported by Miri's weak memory emulation\n    |\n    = help: this is likely not a bug in the program; it indicates that the program performed an operation that the interpreter does not support\n    = note: backtrace:"}, {"sha": "d98fba26ffa80df251a754bab2a2da99241b26bf", "filename": "tests/pass/weak_memory/extra_cpp.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Fpass%2Fweak_memory%2Fextra_cpp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Fpass%2Fweak_memory%2Fextra_cpp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpass%2Fweak_memory%2Fextra_cpp.rs?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -5,7 +5,6 @@\n // but doable in safe (at least sound) Rust.\n \n #![feature(atomic_from_mut)]\n-#![feature(core_intrinsics)]\n \n use std::sync::atomic::Ordering::*;\n use std::sync::atomic::{AtomicU16, AtomicU32};"}, {"sha": "f5c6021a4a85b5b5668e2b3f950333c177320b86", "filename": "tests/pass/weak_memory/extra_cpp_unsafe.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Fpass%2Fweak_memory%2Fextra_cpp_unsafe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee56989c7f3d355b32f194fca03c0e47a3bd445/tests%2Fpass%2Fweak_memory%2Fextra_cpp_unsafe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpass%2Fweak_memory%2Fextra_cpp_unsafe.rs?ref=3ee56989c7f3d355b32f194fca03c0e47a3bd445", "patch": "@@ -7,7 +7,6 @@\n // memory model in the future.\n \n #![feature(atomic_from_mut)]\n-#![feature(core_intrinsics)]\n \n use std::sync::atomic::AtomicU32;\n use std::sync::atomic::Ordering::*;\n@@ -27,7 +26,7 @@ fn racing_mixed_atomicity_read() {\n \n     let j2 = spawn(move || {\n         let x_ptr = x as *const AtomicU32 as *const u32;\n-        unsafe { std::intrinsics::atomic_load_relaxed(x_ptr) }\n+        unsafe { x_ptr.read() }\n     });\n \n     let r1 = j1.join().unwrap();"}]}