{"sha": "5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "node_id": "C_kwDOAAsO6NoAKDUzNjBjOWJkMjJmMzY4NjVkYjUwYmI2OWQ5YmZjZTZmM2Q0ZmVjMzg", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-12-22T01:25:38Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-12-22T01:25:38Z"}, "message": "fix: Do not complete `Drop::drop`, complete `std::mem::drop` instead", "tree": {"sha": "7ff0a3b63140ebb30eeb2640003065ad1b669c0b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7ff0a3b63140ebb30eeb2640003065ad1b669c0b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "html_url": "https://github.com/rust-lang/rust/commit/5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "276687a6eeefbbc0721ded81980f88edd2178ebe", "url": "https://api.github.com/repos/rust-lang/rust/commits/276687a6eeefbbc0721ded81980f88edd2178ebe", "html_url": "https://github.com/rust-lang/rust/commit/276687a6eeefbbc0721ded81980f88edd2178ebe"}], "stats": {"total": 98, "additions": 88, "deletions": 10}, "files": [{"sha": "3cab1918f3ee5b990c855f254f4ad0f576ab74b4", "filename": "crates/ide_completion/src/completions/attribute/derive.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute%2Fderive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute%2Fderive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute%2Fderive.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -1,7 +1,7 @@\n //! Completion for derives\n use hir::{HasAttrs, MacroDef, MacroKind};\n use ide_db::{\n-    helpers::{import_assets::ImportAssets, insert_use::ImportScope, FamousDefs},\n+    helpers::{import_assets::ImportAssets, insert_use::ImportScope},\n     SymbolKind,\n };\n use itertools::Itertools;\n@@ -18,7 +18,7 @@ pub(super) fn complete_derive(\n     ctx: &CompletionContext,\n     existing_derives: &[ast::Path],\n ) {\n-    let core = FamousDefs(&ctx.sema, ctx.krate).core();\n+    let core = ctx.famous_defs().core();\n     let existing_derives: FxHashSet<_> = existing_derives\n         .into_iter()\n         .filter_map(|path| ctx.scope.speculative_resolve_as_mac(&path))"}, {"sha": "539b423cb30f94e13a5c39567b1eb8c507874539", "filename": "crates/ide_completion/src/completions/dot.rs", "status": "modified", "additions": 38, "deletions": 1, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fdot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fdot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fdot.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -76,7 +76,14 @@ fn complete_methods(\n ) {\n     if let Some(krate) = ctx.krate {\n         let mut seen_methods = FxHashSet::default();\n-        let traits_in_scope = ctx.scope.visible_traits();\n+        let mut traits_in_scope = ctx.scope.visible_traits();\n+\n+        // Remove drop from the environment as calling `Drop::drop` is not allowed\n+        if let Some(drop_trait) = ctx.famous_defs().core_ops_Drop() {\n+            cov_mark::hit!(dot_remove_drop_trait);\n+            traits_in_scope.remove(&drop_trait.into());\n+        }\n+\n         receiver.iterate_method_candidates(ctx.db, krate, &traits_in_scope, None, |_ty, func| {\n             if func.self_param(ctx.db).is_some() && seen_methods.insert(func.name(ctx.db)) {\n                 f(func);\n@@ -709,4 +716,34 @@ fn main() {\n             \"#]],\n         )\n     }\n+\n+    #[test]\n+    fn postfix_drop_completion() {\n+        cov_mark::check!(dot_remove_drop_trait);\n+        cov_mark::check!(postfix_drop_completion);\n+        check_edit(\n+            \"drop\",\n+            r#\"\n+//- minicore: drop\n+struct Vec<T>(T);\n+impl<T> Drop for Vec<T> {\n+    fn drop(&mut self) {}\n+}\n+fn main() {\n+    let x = Vec(0u32)\n+    x.$0;\n+}\n+\"#,\n+            r\"\n+struct Vec<T>(T);\n+impl<T> Drop for Vec<T> {\n+    fn drop(&mut self) {}\n+}\n+fn main() {\n+    let x = Vec(0u32)\n+    drop($0x);\n+}\n+\",\n+        )\n+    }\n }"}, {"sha": "a212a98461fda3da92feaed784c57fec74df81b7", "filename": "crates/ide_completion/src/completions/postfix.rs", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpostfix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpostfix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpostfix.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -2,9 +2,9 @@\n \n mod format_like;\n \n-use hir::Documentation;\n+use hir::{Documentation, HasAttrs};\n use ide_db::{\n-    helpers::{insert_use::ImportScope, FamousDefs, SnippetCap},\n+    helpers::{insert_use::ImportScope, SnippetCap},\n     ty_filter::TryEnum,\n };\n use syntax::{\n@@ -59,6 +59,22 @@ pub(crate) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n         None => return,\n     };\n \n+    if let Some(drop_trait) = ctx.famous_defs().core_ops_Drop() {\n+        if receiver_ty.impls_trait(ctx.db, drop_trait, &[]) {\n+            if let &[hir::AssocItem::Function(drop_fn)] = &*drop_trait.items(ctx.db) {\n+                cov_mark::hit!(postfix_drop_completion);\n+                // FIXME: check that `drop` is in scope, use fully qualified path if it isn't/if shadowed\n+                let mut item = postfix_snippet(\n+                    \"drop\",\n+                    \"fn drop(&mut self)\",\n+                    &format!(\"drop($0{})\", receiver_text),\n+                );\n+                item.set_documentation(drop_fn.docs(ctx.db));\n+                item.add_to(acc);\n+            }\n+        }\n+    }\n+\n     if !ctx.config.snippets.is_empty() {\n         add_custom_postfix_completions(acc, ctx, &postfix_snippet, &receiver_text);\n     }\n@@ -107,7 +123,7 @@ pub(crate) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n         )\n         .add_to(acc);\n         postfix_snippet(\"not\", \"!expr\", &format!(\"!{}\", receiver_text)).add_to(acc);\n-    } else if let Some(trait_) = FamousDefs(&ctx.sema, ctx.krate).core_iter_IntoIterator() {\n+    } else if let Some(trait_) = ctx.famous_defs().core_iter_IntoIterator() {\n         if receiver_ty.impls_trait(ctx.db, trait_, &[]) {\n             postfix_snippet(\n                 \"for\","}, {"sha": "b066a46065de0817178a5692d00a7a4d06d1af89", "filename": "crates/ide_completion/src/completions/record.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -1,5 +1,5 @@\n //! Complete fields in record literals and patterns.\n-use ide_db::{helpers::FamousDefs, SymbolKind};\n+use ide_db::SymbolKind;\n use syntax::{ast::Expr, T};\n \n use crate::{\n@@ -13,7 +13,7 @@ pub(crate) fn complete_record(acc: &mut Completions, ctx: &CompletionContext) ->\n             | ImmediateLocation::RecordExprUpdate(record_expr),\n         ) => {\n             let ty = ctx.sema.type_of_expr(&Expr::RecordExpr(record_expr.clone()));\n-            let default_trait = FamousDefs(&ctx.sema, ctx.krate).core_default_Default();\n+            let default_trait = ctx.famous_defs().core_default_Default();\n             let impl_default_trait = default_trait.zip(ty).map_or(false, |(default_trait, ty)| {\n                 ty.original.impls_trait(ctx.db, default_trait, &[])\n             });"}, {"sha": "d29e181bacc05beacef05eb5470febadb21e27a5", "filename": "crates/ide_completion/src/context.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcontext.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -5,6 +5,7 @@ use hir::{Local, Name, ScopeDef, Semantics, SemanticsScope, Type, TypeInfo};\n use ide_db::{\n     active_parameter::ActiveParameter,\n     base_db::{FilePosition, SourceDatabase},\n+    helpers::FamousDefs,\n     RootDatabase,\n };\n use syntax::{\n@@ -150,6 +151,10 @@ impl<'a> CompletionContext<'a> {\n         self.previous_token.as_ref().map_or(false, |tok| tok.kind() == kind)\n     }\n \n+    pub(crate) fn famous_defs(&self) -> FamousDefs {\n+        FamousDefs(&self.sema, self.krate)\n+    }\n+\n     pub(crate) fn dot_receiver(&self) -> Option<&ast::Expr> {\n         match &self.completion_location {\n             Some("}, {"sha": "4fa5aa04dead5c9256e2c71b9c623a60eebaaf45", "filename": "crates/ide_completion/src/render.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_completion%2Fsrc%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -71,6 +71,7 @@ impl<'a> RenderContext<'a> {\n                 .unwrap_or(false)\n     }\n \n+    // FIXME: remove this\n     fn docs(&self, def: impl HasAttrs) -> Option<hir::Documentation> {\n         def.docs(self.db())\n     }"}, {"sha": "ee7bf9540bc2b04b8e36b706c190e6ffd89fe676", "filename": "crates/ide_db/src/helpers/famous_defs.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_db%2Fsrc%2Fhelpers%2Ffamous_defs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Fide_db%2Fsrc%2Fhelpers%2Ffamous_defs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Ffamous_defs.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -76,6 +76,10 @@ impl FamousDefs<'_, '_> {\n         self.find_enum(\"core:ops:ControlFlow\")\n     }\n \n+    pub fn core_ops_Drop(&self) -> Option<Trait> {\n+        self.find_trait(\"core:ops:Drop\")\n+    }\n+\n     pub fn core_marker_Copy(&self) -> Option<Trait> {\n         self.find_trait(\"core:marker:Copy\")\n     }"}, {"sha": "5c63e27879d02f799c0fb5252cc0d360d3e0a104", "filename": "crates/test_utils/src/minicore.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Ftest_utils%2Fsrc%2Fminicore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5360c9bd22f36865db50bb69d9bfce6f3d4fec38/crates%2Ftest_utils%2Fsrc%2Fminicore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2Fsrc%2Fminicore.rs?ref=5360c9bd22f36865db50bb69d9bfce6f3d4fec38", "patch": "@@ -36,6 +36,7 @@\n //!     bool_impl: option, fn\n //!     add:\n //!     as_ref: sized\n+//!     drop:\n \n pub mod marker {\n     // region:sized\n@@ -118,7 +119,6 @@ pub mod clone {\n }\n // endregion:clone\n \n-\n pub mod convert {\n     // region:from\n     pub trait From<T>: Sized {\n@@ -195,6 +195,13 @@ pub mod ops {\n     };\n     // endregion:deref\n \n+    // region:drop\n+    #[lang = \"drop\"]\n+    pub trait Drop {\n+        fn drop(&mut self);\n+    }\n+    // endregion:drop\n+\n     // region:index\n     mod index {\n         #[lang = \"index\"]\n@@ -237,6 +244,12 @@ pub mod ops {\n     pub use self::index::{Index, IndexMut};\n     // endregion:index\n \n+    // region:drop\n+    pub mod mem {\n+        pub fn drop<T>(_x: T) {}\n+    }\n+    // endregion:drop\n+\n     // region:range\n     mod range {\n         #[lang = \"RangeFull\"]\n@@ -620,13 +633,15 @@ pub mod prelude {\n             clone::Clone,                       // :clone\n             cmp::{Eq, PartialEq},               // :eq\n             cmp::{Ord, PartialOrd},             // :ord\n-            convert::{From, Into},              // :from\n             convert::AsRef,                     // :as_ref\n+            convert::{From, Into},              // :from\n             default::Default,                   // :default\n             iter::{IntoIterator, Iterator},     // :iterator\n             macros::builtin::derive,            // :derive\n             marker::Copy,                       // :copy\n             marker::Sized,                      // :sized\n+            mem::drop,                          // :drop\n+            ops::Drop,                          // :drop\n             ops::{Fn, FnMut, FnOnce},           // :fn\n             option::Option::{self, None, Some}, // :option\n             result::Result::{self, Err, Ok},    // :result"}]}