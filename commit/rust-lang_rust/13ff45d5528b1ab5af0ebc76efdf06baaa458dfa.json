{"sha": "13ff45d5528b1ab5af0ebc76efdf06baaa458dfa", "node_id": "C_kwDOAAsO6NoAKDEzZmY0NWQ1NTI4YjFhYjVhZjBlYmM3NmVmZGYwNmJhYWE0NThkZmE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-15T18:11:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-15T18:11:33Z"}, "message": "Rollup merge of #100325 - aDotInTheVoid:rdj-import-impl, r=GuillaumeGomez\n\nRustdoc-Json: Don't remove impls for items imported from private modules\n\nAfter #99287, items in private modules may still be in the json output, if a public import accesses them. To reflect this, items that are imported need to be marked as retained in the `Stripper` pass, so their impls arn't removed by `ImplStripper`.\n\n[More context on zulip](https://rust-lang.zulipchat.com/#narrow/stream/266220-rustdoc/topic/Populating.20cache.2Eimpls), thanks to @ jyn514 for helping debug this.\n\n``@rustbot`` modify labels: +A-rustdoc-json +T-rustdoc\n\nr? ``@GuillaumeGomez``\n\nFixes #100252\nFixes #100242", "tree": {"sha": "87b6064c25c39a828479dc26aeebd751050225f7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/87b6064c25c39a828479dc26aeebd751050225f7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi+oxVCRBK7hj4Ov3rIwAA9/8IABYS5wdlGhpt5c6O1urYzsEk\nT3mljxN5chWisDlmVZIzYhXNQNo11dlQjpqoGagOsdayY71OrZ0/MGrSR9EeDGiN\nDRLBK+9N/SH7Kh9N6MM+n8XdbJaP2lh9SQRZvaz+eWGxtlmeZC1bOwwyoSEuO+oe\n5+7x2V2vR/rygMu0lPbeV3E4Zcm79S+vjLdpujV2u7Vl4/xr+W1G7dyk3hD1sqNB\nNa9vfliNZx3gddZmOMuHmL2tuPdoscjc+SRklyf9fCsTedMbcFFI2x7I0WAldE/B\nnlPDsd51WqR2lYewsEZ24sz5doryLk8a4Z1kUVHCgfvH3B4vvcYUYX//Z+gyJxQ=\n=2R7y\n-----END PGP SIGNATURE-----\n", "payload": "tree 87b6064c25c39a828479dc26aeebd751050225f7\nparent 710bd23df1d4b9e87a0ea15bb51ca9de8c4eea4e\nparent 44b489f27a92e7e9662f27bcebb66662f4772247\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1660587093 +0200\ncommitter GitHub <noreply@github.com> 1660587093 +0200\n\nRollup merge of #100325 - aDotInTheVoid:rdj-import-impl, r=GuillaumeGomez\n\nRustdoc-Json: Don't remove impls for items imported from private modules\n\nAfter #99287, items in private modules may still be in the json output, if a public import accesses them. To reflect this, items that are imported need to be marked as retained in the `Stripper` pass, so their impls arn't removed by `ImplStripper`.\n\n[More context on zulip](https://rust-lang.zulipchat.com/#narrow/stream/266220-rustdoc/topic/Populating.20cache.2Eimpls), thanks to @ jyn514 for helping debug this.\n\n``@rustbot`` modify labels: +A-rustdoc-json +T-rustdoc\n\nr? ``@GuillaumeGomez``\n\nFixes #100252\nFixes #100242\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa", "html_url": "https://github.com/rust-lang/rust/commit/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "710bd23df1d4b9e87a0ea15bb51ca9de8c4eea4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/710bd23df1d4b9e87a0ea15bb51ca9de8c4eea4e", "html_url": "https://github.com/rust-lang/rust/commit/710bd23df1d4b9e87a0ea15bb51ca9de8c4eea4e"}, {"sha": "44b489f27a92e7e9662f27bcebb66662f4772247", "url": "https://api.github.com/repos/rust-lang/rust/commits/44b489f27a92e7e9662f27bcebb66662f4772247", "html_url": "https://github.com/rust-lang/rust/commit/44b489f27a92e7e9662f27bcebb66662f4772247"}], "stats": {"total": 36, "additions": 35, "deletions": 1}, "files": [{"sha": "83ed3752a824cd541aa608be7c46fb97b1d234c3", "filename": "src/librustdoc/passes/stripper.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa/src%2Flibrustdoc%2Fpasses%2Fstripper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa/src%2Flibrustdoc%2Fpasses%2Fstripper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstripper.rs?ref=13ff45d5528b1ab5af0ebc76efdf06baaa458dfa", "patch": "@@ -88,7 +88,17 @@ impl<'a> DocFolder for Stripper<'a> {\n             }\n \n             // handled in the `strip-priv-imports` pass\n-            clean::ExternCrateItem { .. } | clean::ImportItem(..) => {}\n+            clean::ExternCrateItem { .. } => {}\n+            clean::ImportItem(ref imp) => {\n+                // Because json doesn't inline imports from private modules, we need to mark\n+                // the imported item as retained so it's impls won't be stripped.i\n+                //\n+                // FIXME: Is it necessary to check for json output here: See\n+                // https://github.com/rust-lang/rust/pull/100325#discussion_r941495215\n+                if let Some(did) = imp.source.did && self.is_json_output {\n+                    self.retained.insert(did.into());\n+                }\n+            }\n \n             clean::ImplItem(..) => {}\n "}, {"sha": "ef4d8aa39f88c0f60a891acf0888a1e94d153e32", "filename": "src/test/rustdoc-json/impls/import_from_private.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa/src%2Ftest%2Frustdoc-json%2Fimpls%2Fimport_from_private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13ff45d5528b1ab5af0ebc76efdf06baaa458dfa/src%2Ftest%2Frustdoc-json%2Fimpls%2Fimport_from_private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-json%2Fimpls%2Fimport_from_private.rs?ref=13ff45d5528b1ab5af0ebc76efdf06baaa458dfa", "patch": "@@ -0,0 +1,24 @@\n+// https://github.com/rust-lang/rust/issues/100252\n+\n+#![feature(no_core)]\n+#![no_core]\n+\n+mod bar {\n+    // @set baz = import_from_private.json \"$.index[*][?(@.kind=='struct')].id\"\n+    pub struct Baz;\n+    // @set impl = - \"$.index[*][?(@.kind=='impl')].id\"\n+    impl Baz {\n+        // @set doit = - \"$.index[*][?(@.kind=='method')].id\"\n+        pub fn doit() {}\n+    }\n+}\n+\n+// @set import = - \"$.index[*][?(@.kind=='import')].id\"\n+pub use bar::Baz;\n+\n+// FIXME(adotinthevoid): Use hasexact once #99474 lands\n+\n+// @has - \"$.index[*][?(@.kind=='module')].inner.items[*]\" $import\n+// @is  - \"$.index[*][?(@.kind=='import')].inner.id\" $baz\n+// @has - \"$.index[*][?(@.kind=='struct')].inner.impls[*]\" $impl\n+// @has - \"$.index[*][?(@.kind=='impl')].inner.items[*]\" $doit"}]}