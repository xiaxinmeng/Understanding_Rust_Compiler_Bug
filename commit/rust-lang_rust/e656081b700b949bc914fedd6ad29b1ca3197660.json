{"sha": "e656081b700b949bc914fedd6ad29b1ca3197660", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2NTYwODFiNzAwYjk0OWJjOTE0ZmVkZDZhZDI5YjFjYTMxOTc2NjA=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2014-12-24T06:38:10Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2014-12-25T21:16:24Z"}, "message": "Accept `?Sized` as well as `Sized?`\n\nIncludes a bit of refactoring to store `?` unbounds as bounds with a modifier, rather than in their own world, in the AST at least.", "tree": {"sha": "77915660e03576b2c484877ef9fbe0db71b86198", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/77915660e03576b2c484877ef9fbe0db71b86198"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e656081b700b949bc914fedd6ad29b1ca3197660", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e656081b700b949bc914fedd6ad29b1ca3197660", "html_url": "https://github.com/rust-lang/rust/commit/e656081b700b949bc914fedd6ad29b1ca3197660", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e656081b700b949bc914fedd6ad29b1ca3197660/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ba6102657a892457063d2d6a7cbb9632ce282c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ba6102657a892457063d2d6a7cbb9632ce282c6", "html_url": "https://github.com/rust-lang/rust/commit/5ba6102657a892457063d2d6a7cbb9632ce282c6"}], "stats": {"total": 317, "additions": 179, "deletions": 138}, "files": [{"sha": "01c62990c5a8e1de2b301a6e3a210726977d33fb", "filename": "src/librustc/lint/builtin.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fbuiltin.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -1782,9 +1782,9 @@ impl LintPass for Stability {\n         if self.is_internal(cx, item.span) { return }\n \n         match item.node {\n-            ast::ItemTrait(_, _, _, ref supertraits, _) => {\n+            ast::ItemTrait(_, _, ref supertraits, _) => {\n                 for t in supertraits.iter() {\n-                    if let ast::TraitTyParamBound(ref t) = *t {\n+                    if let ast::TraitTyParamBound(ref t, _) = *t {\n                         let id = ty::trait_ref_to_def_id(cx.tcx, &t.trait_ref);\n                         self.lint(cx, id, t.trait_ref.path.span);\n                     }"}, {"sha": "2a670b308b6b213d364c9e1014dd87b4babf39fb", "filename": "src/librustc/metadata/encoder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmetadata%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmetadata%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fencoder.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -1308,7 +1308,7 @@ fn encode_info_for_item(ecx: &EncodeContext,\n             }\n         }\n       }\n-      ast::ItemTrait(_, _, _, _, ref ms) => {\n+      ast::ItemTrait(_, _, _, ref ms) => {\n         add_to_index(item, rbml_w, index);\n         rbml_w.start_tag(tag_items_data_item);\n         encode_def_id(rbml_w, def_id);"}, {"sha": "c0d702c82a0613cf4b03bf977a7892aa573af2d8", "filename": "src/librustc/middle/infer/error_reporting.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Finfer%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Finfer%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Finfer%2Ferror_reporting.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -1043,7 +1043,6 @@ impl<'a, 'tcx> Rebuilder<'a, 'tcx> {\n                 ident: ty_param.ident,\n                 id: ty_param.id,\n                 bounds: bounds,\n-                unbound: ty_param.unbound.clone(),\n                 default: ty_param.default.clone(),\n                 span: ty_param.span,\n             }\n@@ -1063,7 +1062,7 @@ impl<'a, 'tcx> Rebuilder<'a, 'tcx> {\n                     // be passing down a map.\n                     ast::RegionTyParamBound(lt)\n                 }\n-                &ast::TraitTyParamBound(ref poly_tr) => {\n+                &ast::TraitTyParamBound(ref poly_tr, modifier) => {\n                     let tr = &poly_tr.trait_ref;\n                     let last_seg = tr.path.segments.last().unwrap();\n                     let mut insert = Vec::new();\n@@ -1087,7 +1086,7 @@ impl<'a, 'tcx> Rebuilder<'a, 'tcx> {\n                             path: new_path,\n                             ref_id: tr.ref_id,\n                         }\n-                    })\n+                    }, modifier)\n                 }\n             }\n         })"}, {"sha": "730da26eda3dccc50f2fd722ffc334596191d193", "filename": "src/librustc/middle/privacy.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Fprivacy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Fprivacy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fprivacy.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -122,7 +122,7 @@ impl<'v> Visitor<'v> for ParentVisitor {\n             // method to the root. In this case, if the trait is private, then\n             // parent all the methods to the trait to indicate that they're\n             // private.\n-            ast::ItemTrait(_, _, _, _, ref methods) if item.vis != ast::Public => {\n+            ast::ItemTrait(_, _, _, ref methods) if item.vis != ast::Public => {\n                 for m in methods.iter() {\n                     match *m {\n                         ast::ProvidedMethod(ref m) => {\n@@ -328,7 +328,7 @@ impl<'a, 'tcx, 'v> Visitor<'v> for EmbargoVisitor<'a, 'tcx> {\n \n             // Default methods on traits are all public so long as the trait\n             // is public\n-            ast::ItemTrait(_, _, _, _, ref methods) if public_first => {\n+            ast::ItemTrait(_, _, _, ref methods) if public_first => {\n                 for method in methods.iter() {\n                     match *method {\n                         ast::ProvidedMethod(ref m) => {\n@@ -1178,7 +1178,7 @@ impl<'a, 'tcx> SanePrivacyVisitor<'a, 'tcx> {\n                 }\n             }\n \n-            ast::ItemTrait(_, _, _, _, ref methods) => {\n+            ast::ItemTrait(_, _, _, ref methods) => {\n                 for m in methods.iter() {\n                     match *m {\n                         ast::ProvidedMethod(ref m) => {\n@@ -1242,7 +1242,7 @@ impl<'a, 'tcx> SanePrivacyVisitor<'a, 'tcx> {\n \n             ast::ItemStruct(ref def, _) => check_struct(&**def),\n \n-            ast::ItemTrait(_, _, _, _, ref methods) => {\n+            ast::ItemTrait(_, _, _, ref methods) => {\n                 for m in methods.iter() {\n                     match *m {\n                         ast::RequiredMethod(..) => {}\n@@ -1306,7 +1306,7 @@ impl<'a, 'tcx> VisiblePrivateTypesVisitor<'a, 'tcx> {\n \n     fn check_ty_param_bound(&self,\n                             ty_param_bound: &ast::TyParamBound) {\n-        if let ast::TraitTyParamBound(ref trait_ref) = *ty_param_bound {\n+        if let ast::TraitTyParamBound(ref trait_ref, _) = *ty_param_bound {\n             if !self.tcx.sess.features.borrow().visible_private_types &&\n                 self.path_is_private_type(trait_ref.trait_ref.ref_id) {\n                     let span = trait_ref.trait_ref.path.span;\n@@ -1349,7 +1349,7 @@ impl<'a, 'tcx, 'v> Visitor<'v> for VisiblePrivateTypesVisitor<'a, 'tcx> {\n             // namespace (the contents have their own privacies).\n             ast::ItemForeignMod(_) => {}\n \n-            ast::ItemTrait(_, _, _, ref bounds, _) => {\n+            ast::ItemTrait(_, _, ref bounds, _) => {\n                 if !self.trait_is_public(item.id) {\n                     return\n                 }"}, {"sha": "c954f68f8755ba5bfd830a94eab4a27751d8c047", "filename": "src/librustc/middle/resolve_lifetime.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -105,7 +105,7 @@ impl<'a, 'v> Visitor<'v> for LifetimeContext<'a> {\n                 ast::ItemTy(_, ref generics) |\n                 ast::ItemEnum(_, ref generics) |\n                 ast::ItemStruct(_, ref generics) |\n-                ast::ItemTrait(_, ref generics, _, _, _) |\n+                ast::ItemTrait(_, ref generics, _, _) |\n                 ast::ItemImpl(_, ref generics, _, _, _) => {\n                     // These kinds of items have only early bound lifetime parameters.\n                     let lifetimes = &generics.lifetimes;\n@@ -232,7 +232,9 @@ impl<'a, 'v> Visitor<'v> for LifetimeContext<'a> {\n         }\n     }\n \n-    fn visit_poly_trait_ref(&mut self, trait_ref: &ast::PolyTraitRef) {\n+    fn visit_poly_trait_ref(&mut self, trait_ref:\n+                            &ast::PolyTraitRef,\n+                            _modifier: &ast::TraitBoundModifier) {\n         debug!(\"visit_poly_trait_ref trait_ref={}\", trait_ref);\n \n         self.with(LateScope(&trait_ref.bound_lifetimes, self.scope), |old_scope, this| {"}, {"sha": "847a05cb42abbe46f3d4beceb5433b94d546f8a0", "filename": "src/librustc/middle/ty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fty.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -4608,7 +4608,7 @@ pub fn provided_trait_methods<'tcx>(cx: &ctxt<'tcx>, id: ast::DefId)\n         match cx.map.find(id.node) {\n             Some(ast_map::NodeItem(item)) => {\n                 match item.node {\n-                    ItemTrait(_, _, _, _, ref ms) => {\n+                    ItemTrait(_, _, _, ref ms) => {\n                         let (_, p) =\n                             ast_util::split_trait_methods(ms[]);\n                         p.iter()"}, {"sha": "47eebf6f446b5ad268ee20158367d4c25082e7d3", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 3, "deletions": 16, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -1459,7 +1459,7 @@ impl<'a> Resolver<'a> {\n \n             ItemImpl(_, _, Some(_), _, _) => parent,\n \n-            ItemTrait(_, _, _, _, ref items) => {\n+            ItemTrait(_, _, _, ref items) => {\n                 let name_bindings =\n                     self.add_child(name,\n                                    parent.clone(),\n@@ -3998,7 +3998,7 @@ impl<'a> Resolver<'a> {\n                                             impl_items[]);\n             }\n \n-            ItemTrait(_, ref generics, ref unbound, ref bounds, ref trait_items) => {\n+            ItemTrait(_, ref generics, ref bounds, ref trait_items) => {\n                 // Create a new rib for the self type.\n                 let mut self_type_rib = Rib::new(ItemRibKind);\n \n@@ -4019,13 +4019,6 @@ impl<'a> Resolver<'a> {\n                     this.resolve_type_parameter_bounds(item.id, bounds,\n                                                        TraitDerivation);\n \n-                    match *unbound {\n-                        Some(ref tpb) => {\n-                            this.resolve_trait_reference(item.id, tpb, TraitDerivation);\n-                        }\n-                        None => {}\n-                    }\n-\n                     for trait_item in (*trait_items).iter() {\n                         // Create a new rib for the trait_item-specific type\n                         // parameters.\n@@ -4273,12 +4266,6 @@ impl<'a> Resolver<'a> {\n             self.resolve_type_parameter_bound(type_parameter.id, bound,\n                                               TraitBoundingTypeParameter);\n         }\n-        match &type_parameter.unbound {\n-            &Some(ref unbound) =>\n-                self.resolve_trait_reference(\n-                    type_parameter.id, unbound, TraitBoundingTypeParameter),\n-            &None => {}\n-        }\n         match type_parameter.default {\n             Some(ref ty) => self.resolve_type(&**ty),\n             None => {}\n@@ -4300,7 +4287,7 @@ impl<'a> Resolver<'a> {\n                                     type_parameter_bound: &TyParamBound,\n                                     reference_type: TraitReferenceType) {\n         match *type_parameter_bound {\n-            TraitTyParamBound(ref tref) => {\n+            TraitTyParamBound(ref tref, _) => {\n                 self.resolve_poly_trait_reference(id, tref, reference_type)\n             }\n             RegionTyParamBound(..) => {}"}, {"sha": "92698f9bc32f5c24b69ab0e0fde8d65d3c0fb261", "filename": "src/librustc_trans/save/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_trans%2Fsave%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_trans%2Fsave%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fsave%2Fmod.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -710,7 +710,7 @@ impl <'l, 'tcx> DxrVisitor<'l, 'tcx> {\n         // super-traits\n         for super_bound in trait_refs.iter() {\n             let trait_ref = match *super_bound {\n-                ast::TraitTyParamBound(ref trait_ref) => {\n+                ast::TraitTyParamBound(ref trait_ref, _) => {\n                     trait_ref\n                 }\n                 ast::RegionTyParamBound(..) => {\n@@ -1052,7 +1052,7 @@ impl<'l, 'tcx, 'v> Visitor<'v> for DxrVisitor<'l, 'tcx> {\n                                   &**typ,\n                                   impl_items)\n             }\n-            ast::ItemTrait(_, ref generics, _, ref trait_refs, ref methods) =>\n+            ast::ItemTrait(_, ref generics, ref trait_refs, ref methods) =>\n                 self.process_trait(item, generics, trait_refs, methods),\n             ast::ItemMod(ref m) => self.process_mod(item, m),\n             ast::ItemTy(ref ty, ref ty_params) => {\n@@ -1076,7 +1076,7 @@ impl<'l, 'tcx, 'v> Visitor<'v> for DxrVisitor<'l, 'tcx> {\n     fn visit_generics(&mut self, generics: &ast::Generics) {\n         for param in generics.ty_params.iter() {\n             for bound in param.bounds.iter() {\n-                if let ast::TraitTyParamBound(ref trait_ref) = *bound {\n+                if let ast::TraitTyParamBound(ref trait_ref, _) = *bound {\n                     self.process_trait_ref(&trait_ref.trait_ref, None);\n                 }\n             }"}, {"sha": "00956c9bfc81a5f04c8708c20998b30f314fa46f", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -1625,7 +1625,7 @@ pub fn partition_bounds<'a>(tcx: &ty::ctxt,\n     let mut trait_def_ids = DefIdMap::new();\n     for ast_bound in ast_bounds.iter() {\n         match *ast_bound {\n-            ast::TraitTyParamBound(ref b) => {\n+            ast::TraitTyParamBound(ref b, ast::TraitBoundModifier::None) => {\n                 match ::lookup_def_tcx(tcx, b.trait_ref.path.span, b.trait_ref.ref_id) {\n                     def::DefTrait(trait_did) => {\n                         match trait_def_ids.get(&trait_did) {\n@@ -1663,6 +1663,7 @@ pub fn partition_bounds<'a>(tcx: &ty::ctxt,\n                 }\n                 trait_bounds.push(b);\n             }\n+            ast::TraitTyParamBound(_, ast::TraitBoundModifier::Maybe) => {}\n             ast::RegionTyParamBound(ref l) => {\n                 region_bounds.push(l);\n             }"}, {"sha": "b28793248ddaf9324174fc19c1b355659f5ddb26", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -658,7 +658,7 @@ pub fn check_item(ccx: &CrateCtxt, it: &ast::Item) {\n         }\n \n       }\n-      ast::ItemTrait(_, _, _, _, ref trait_methods) => {\n+      ast::ItemTrait(_, _, _, ref trait_methods) => {\n         let trait_def = ty::lookup_trait_def(ccx.tcx, local_def(it.id));\n         for trait_method in trait_methods.iter() {\n             match *trait_method {"}, {"sha": "83b332a7351dd48d912e7125b1e747b50ef4f241", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 28, "deletions": 31, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -259,7 +259,7 @@ fn collect_trait_methods<'a, 'tcx>(ccx: &CrateCtxt<'a, 'tcx>,\n                                    trait_def: &ty::TraitDef<'tcx>) {\n     let tcx = ccx.tcx;\n     if let ast_map::NodeItem(item) = tcx.map.get(trait_id) {\n-        if let ast::ItemTrait(_, _, _, _, ref trait_items) = item.node {\n+        if let ast::ItemTrait(_, _, _, ref trait_items) = item.node {\n             // For each method, construct a suitable ty::Method and\n             // store it into the `tcx.impl_or_trait_items` table:\n             for trait_item in trait_items.iter() {\n@@ -627,11 +627,6 @@ pub fn ensure_no_ty_param_bounds(ccx: &CrateCtxt,\n                 ast::RegionTyParamBound(..) => { }\n             }\n         }\n-\n-        match ty_param.unbound {\n-            Some(_) => { warn = true; }\n-            None => { }\n-        }\n     }\n \n     if warn {\n@@ -1146,7 +1141,7 @@ pub fn convert(ccx: &CrateCtxt, it: &ast::Item) {\n                                                AllowEqConstraints::DontAllow);\n             }\n         },\n-        ast::ItemTrait(_, _, _, _, ref trait_methods) => {\n+        ast::ItemTrait(_, _, _, ref trait_methods) => {\n             let trait_def = trait_def_of_item(ccx, it);\n \n             debug!(\"trait_def: ident={} trait_def={}\",\n@@ -1338,13 +1333,12 @@ pub fn trait_def_of_item<'a, 'tcx>(ccx: &CrateCtxt<'a, 'tcx>,\n         return def.clone();\n     }\n \n-    let (unsafety, generics, unbound, bounds, items) = match it.node {\n+    let (unsafety, generics, bounds, items) = match it.node {\n         ast::ItemTrait(unsafety,\n                        ref generics,\n-                       ref unbound,\n                        ref supertraits,\n                        ref items) => {\n-            (unsafety, generics, unbound, supertraits, items.as_slice())\n+            (unsafety, generics, supertraits, items.as_slice())\n         }\n         ref s => {\n             tcx.sess.span_bug(\n@@ -1367,7 +1361,6 @@ pub fn trait_def_of_item<'a, 'tcx>(ccx: &CrateCtxt<'a, 'tcx>,\n                                 token::SELF_KEYWORD_NAME,\n                                 self_param_ty,\n                                 bounds.as_slice(),\n-                                unbound,\n                                 it.span);\n \n     let substs = mk_item_substs(ccx, &ty_generics);\n@@ -1683,29 +1676,37 @@ fn ty_generics_for_fn_or_method<'tcx,AC>(\n                 create_type_parameters_for_associated_types)\n }\n \n-// Add the Sized bound, unless the type parameter is marked as `Sized?`.\n+// Add the Sized bound, unless the type parameter is marked as `?Sized`.\n fn add_unsized_bound<'tcx,AC>(this: &AC,\n-                              unbound: &Option<ast::TraitRef>,\n                               bounds: &mut ty::BuiltinBounds,\n-                              desc: &str,\n+                              ast_bounds: &[ast::TyParamBound],\n                               span: Span)\n                               where AC: AstConv<'tcx> {\n+    // Try to find an unbound in bounds.\n+    let mut unbound = None;\n+    for ab in ast_bounds.iter() {\n+        if let &ast::TraitTyParamBound(ref ptr, ast::TraitBoundModifier::Maybe) = ab  {\n+            if unbound.is_none() {\n+                assert!(ptr.bound_lifetimes.is_empty());\n+                unbound = Some(ptr.trait_ref.clone());\n+            } else {\n+                this.tcx().sess.span_err(span, \"type parameter has more than one relaxed default \\\n+                                                bound, only one is supported\");\n+            }\n+        }\n+    }\n+\n     let kind_id = this.tcx().lang_items.require(SizedTraitLangItem);\n     match unbound {\n-        &Some(ref tpb) => {\n+        Some(ref tpb) => {\n             // FIXME(#8559) currently requires the unbound to be built-in.\n             let trait_def_id = ty::trait_ref_to_def_id(this.tcx(), tpb);\n             match kind_id {\n                 Ok(kind_id) if trait_def_id != kind_id => {\n                     this.tcx().sess.span_warn(span,\n-                                              format!(\"default bound relaxed \\\n-                                                       for a {}, but this \\\n-                                                       does nothing because \\\n-                                                       the given bound is not \\\n-                                                       a default. \\\n-                                                       Only `Sized?` is \\\n-                                                       supported\",\n-                                                      desc)[]);\n+                                              \"default bound relaxed for a type parameter, but \\\n+                                               this does nothing because the given bound is not \\\n+                                               a default. Only `?Sized` is supported\");\n                     ty::try_add_builtin_trait(this.tcx(),\n                                               kind_id,\n                                               bounds);\n@@ -1717,7 +1718,7 @@ fn add_unsized_bound<'tcx,AC>(this: &AC,\n             ty::try_add_builtin_trait(this.tcx(), kind_id.unwrap(), bounds);\n         }\n         // No lang item for Sized, so we can't add it as a bound.\n-        &None => {}\n+        None => {}\n     }\n }\n \n@@ -1807,7 +1808,7 @@ fn ty_generics<'tcx,AC>(this: &AC,\n \n                 for bound in bound_pred.bounds.iter() {\n                     match bound {\n-                        &ast::TyParamBound::TraitTyParamBound(ref poly_trait_ref) => {\n+                        &ast::TyParamBound::TraitTyParamBound(ref poly_trait_ref, _) => {\n                             let trait_ref = astconv::instantiate_poly_trait_ref(\n                                 this,\n                                 &ExplicitRscope,\n@@ -1880,7 +1881,7 @@ fn ty_generics<'tcx,AC>(this: &AC,\n             for bound in param.bounds.iter() {\n                 // In the above example, `ast_trait_ref` is `Iterator`.\n                 let ast_trait_ref = match *bound {\n-                    ast::TraitTyParamBound(ref r) => r,\n+                    ast::TraitTyParamBound(ref r, _) => r,\n                     ast::RegionTyParamBound(..) => { continue; }\n                 };\n \n@@ -1978,7 +1979,6 @@ fn get_or_create_type_parameter_def<'tcx,AC>(this: &AC,\n                                 param.ident.name,\n                                 param_ty,\n                                 param.bounds[],\n-                                &param.unbound,\n                                 param.span);\n     let default = match param.default {\n         None => None,\n@@ -2023,7 +2023,6 @@ fn compute_bounds<'tcx,AC>(this: &AC,\n                            name_of_bounded_thing: ast::Name,\n                            param_ty: ty::ParamTy,\n                            ast_bounds: &[ast::TyParamBound],\n-                           unbound: &Option<ast::TraitRef>,\n                            span: Span)\n                            -> ty::ParamBounds<'tcx>\n                            where AC: AstConv<'tcx> {\n@@ -2032,11 +2031,9 @@ fn compute_bounds<'tcx,AC>(this: &AC,\n                                              param_ty,\n                                              ast_bounds);\n \n-\n     add_unsized_bound(this,\n-                      unbound,\n                       &mut param_bounds.builtin_bounds,\n-                      \"type parameter\",\n+                      ast_bounds,\n                       span);\n \n     check_bounds_compatible(this.tcx(),"}, {"sha": "af75cb05305f11c7ec78eae864733623b08df83b", "filename": "src/librustc_typeck/variance.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fvariance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibrustc_typeck%2Fvariance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fvariance.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -353,7 +353,7 @@ impl<'a, 'tcx, 'v> Visitor<'v> for TermsContext<'a, 'tcx> {\n         match item.node {\n             ast::ItemEnum(_, ref generics) |\n             ast::ItemStruct(_, ref generics) |\n-            ast::ItemTrait(_, ref generics, _, _, _) => {\n+            ast::ItemTrait(_, ref generics, _, _) => {\n                 for (i, p) in generics.lifetimes.iter().enumerate() {\n                     let id = p.lifetime.id;\n                     self.add_inferred(item.id, RegionParam, TypeSpace, i, id);"}, {"sha": "e002c6c5a0d68e3f0839f50bbe181ed4005630f3", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -371,18 +371,25 @@ pub const DUMMY_NODE_ID: NodeId = -1;\n /// detects Copy, Send and Sync.\n #[deriving(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Show)]\n pub enum TyParamBound {\n-    TraitTyParamBound(PolyTraitRef),\n+    TraitTyParamBound(PolyTraitRef, TraitBoundModifier),\n     RegionTyParamBound(Lifetime)\n }\n \n+/// A modifier on a bound, currently this is only used for `?Sized`, where the\n+/// modifier is `Maybe`. Negative bounds should also be handled here.\n+#[deriving(Copy, Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Show)]\n+pub enum TraitBoundModifier {\n+    None,\n+    Maybe,\n+}\n+\n pub type TyParamBounds = OwnedSlice<TyParamBound>;\n \n #[deriving(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Show)]\n pub struct TyParam {\n     pub ident: Ident,\n     pub id: NodeId,\n     pub bounds: TyParamBounds,\n-    pub unbound: Option<TraitRef>,\n     pub default: Option<P<Ty>>,\n     pub span: Span\n }\n@@ -1489,7 +1496,7 @@ pub struct PolyTraitRef {\n     pub bound_lifetimes: Vec<LifetimeDef>,\n \n     /// The `Foo<&'a T>` in `<'a> Foo<&'a T>`\n-    pub trait_ref: TraitRef\n+    pub trait_ref: TraitRef,\n }\n \n #[deriving(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Show, Copy)]\n@@ -1578,8 +1585,6 @@ pub enum Item_ {\n     /// Represents a Trait Declaration\n     ItemTrait(Unsafety,\n               Generics,\n-              Option<TraitRef>, // (optional) default bound not required for Self.\n-                                // Currently, only Sized makes sense here.\n               TyParamBounds,\n               Vec<TraitItem>),\n     ItemImpl(Unsafety,"}, {"sha": "5a4f5731be50d9267c4ab672682f4f8cbc47b9ca", "filename": "src/libsyntax/ast_map/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fast_map%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fast_map%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast_map%2Fmod.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -780,9 +780,9 @@ impl<'ast> Visitor<'ast> for NodeCollector<'ast> {\n                     None => {}\n                 }\n             }\n-            ItemTrait(_, _, _, ref bounds, ref trait_items) => {\n+            ItemTrait(_, _, ref bounds, ref trait_items) => {\n                 for b in bounds.iter() {\n-                    if let TraitTyParamBound(ref t) = *b {\n+                    if let TraitTyParamBound(ref t, TraitBoundModifier::None) = *b {\n                         self.insert(t.trait_ref.ref_id, NodeItem(i));\n                     }\n                 }"}, {"sha": "94a3784291d0bc595f56482a40a5c380a09f7de9", "filename": "src/libsyntax/config.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fconfig.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -139,11 +139,11 @@ fn fold_item_underscore<F>(cx: &mut Context<F>, item: ast::Item_) -> ast::Item_\n                                        .collect();\n             ast::ItemImpl(u, a, b, c, impl_items)\n         }\n-        ast::ItemTrait(u, a, b, c, methods) => {\n+        ast::ItemTrait(u, a, b, methods) => {\n             let methods = methods.into_iter()\n                                  .filter(|m| trait_method_in_cfg(cx, m))\n                                  .collect();\n-            ast::ItemTrait(u, a, b, c, methods)\n+            ast::ItemTrait(u, a, b, methods)\n         }\n         ast::ItemStruct(def, generics) => {\n             ast::ItemStruct(fold_struct(cx, def), generics)"}, {"sha": "239af1889090983b654ce639a698084142a21a60", "filename": "src/libsyntax/ext/build.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbuild.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -68,7 +68,6 @@ pub trait AstBuilder {\n                span: Span,\n                id: ast::Ident,\n                bounds: OwnedSlice<ast::TyParamBound>,\n-               unbound: Option<ast::TraitRef>,\n                default: Option<P<ast::Ty>>) -> ast::TyParam;\n \n     fn trait_ref(&self, path: ast::Path) -> ast::TraitRef;\n@@ -414,13 +413,11 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n                span: Span,\n                id: ast::Ident,\n                bounds: OwnedSlice<ast::TyParamBound>,\n-               unbound: Option<ast::TraitRef>,\n                default: Option<P<ast::Ty>>) -> ast::TyParam {\n         ast::TyParam {\n             ident: id,\n             id: ast::DUMMY_NODE_ID,\n             bounds: bounds,\n-            unbound: unbound,\n             default: default,\n             span: span\n         }\n@@ -455,7 +452,7 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n     }\n \n     fn typarambound(&self, path: ast::Path) -> ast::TyParamBound {\n-        ast::TraitTyParamBound(self.poly_trait_ref(path))\n+        ast::TraitTyParamBound(self.poly_trait_ref(path), ast::TraitBoundModifier::None)\n     }\n \n     fn lifetime(&self, span: Span, name: ast::Name) -> ast::Lifetime {"}, {"sha": "3c8d74c14ee6393a8b918cd8ed2f7f586cc2f2ff", "filename": "src/libsyntax/ext/deriving/decodable.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fdecodable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fdecodable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fdecodable.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -58,10 +58,10 @@ fn expand_deriving_decodable_imp<F>(cx: &mut ExtCtxt,\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds {\n             lifetimes: Vec::new(),\n-            bounds: vec!((\"__D\", None, vec!(Path::new_(\n+            bounds: vec!((\"__D\", vec!(Path::new_(\n                             vec!(krate, \"Decoder\"), None,\n                             vec!(box Literal(Path::new_local(\"__E\"))), true))),\n-                         (\"__E\", None, vec!()))\n+                         (\"__E\", vec!()))\n         },\n         methods: vec!(\n             MethodDef {"}, {"sha": "5829f34bccc5dac280e2223700933e197f986b61", "filename": "src/libsyntax/ext/deriving/encodable.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fencodable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fencodable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fencodable.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -134,10 +134,10 @@ fn expand_deriving_encodable_imp<F>(cx: &mut ExtCtxt,\n         additional_bounds: Vec::new(),\n         generics: LifetimeBounds {\n             lifetimes: Vec::new(),\n-            bounds: vec!((\"__S\", None, vec!(Path::new_(\n+            bounds: vec!((\"__S\", vec!(Path::new_(\n                             vec!(krate, \"Encoder\"), None,\n                             vec!(box Literal(Path::new_local(\"__E\"))), true))),\n-                         (\"__E\", None, vec!()))\n+                         (\"__E\", vec!()))\n         },\n         methods: vec!(\n             MethodDef {"}, {"sha": "e4e31139d82f48925941cf6da93dc5f4bcb79c81", "filename": "src/libsyntax/ext/deriving/generic/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -417,7 +417,6 @@ impl<'a> TraitDef<'a> {\n             cx.typaram(self.span,\n                        ty_param.ident,\n                        OwnedSlice::from_vec(bounds),\n-                       ty_param.unbound.clone(),\n                        None)\n         }));\n "}, {"sha": "95bdd8b9ffd2fb71116d47dfeb1efd5400c028da", "filename": "src/libsyntax/ext/deriving/generic/ty.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fty.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -189,15 +189,19 @@ impl<'a> Ty<'a> {\n }\n \n \n-fn mk_ty_param(cx: &ExtCtxt, span: Span, name: &str,\n-               bounds: &[Path], unbound: Option<ast::TraitRef>,\n-               self_ident: Ident, self_generics: &Generics) -> ast::TyParam {\n+fn mk_ty_param(cx: &ExtCtxt,\n+               span: Span,\n+               name: &str,\n+               bounds: &[Path],\n+               self_ident: Ident,\n+               self_generics: &Generics)\n+               -> ast::TyParam {\n     let bounds =\n         bounds.iter().map(|b| {\n             let path = b.to_path(cx, span, self_ident, self_generics);\n             cx.typarambound(path)\n         }).collect();\n-    cx.typaram(span, cx.ident_of(name), bounds, unbound, None)\n+    cx.typaram(span, cx.ident_of(name), bounds, None)\n }\n \n fn mk_generics(lifetimes: Vec<ast::LifetimeDef>, ty_params: Vec<ast::TyParam>)\n@@ -216,7 +220,7 @@ fn mk_generics(lifetimes: Vec<ast::LifetimeDef>, ty_params: Vec<ast::TyParam>)\n #[deriving(Clone)]\n pub struct LifetimeBounds<'a> {\n     pub lifetimes: Vec<(&'a str, Vec<&'a str>)>,\n-    pub bounds: Vec<(&'a str, Option<ast::TraitRef>, Vec<Path<'a>>)>,\n+    pub bounds: Vec<(&'a str, Vec<Path<'a>>)>,\n }\n \n impl<'a> LifetimeBounds<'a> {\n@@ -239,12 +243,11 @@ impl<'a> LifetimeBounds<'a> {\n         }).collect();\n         let ty_params = self.bounds.iter().map(|t| {\n             match t {\n-                &(ref name, ref unbound, ref bounds) => {\n+                &(ref name, ref bounds) => {\n                     mk_ty_param(cx,\n                                 span,\n                                 *name,\n                                 bounds.as_slice(),\n-                                unbound.clone(),\n                                 self_ty,\n                                 self_generics)\n                 }"}, {"sha": "72e3b45dc91b7b8217619deea64da07cc1f63c0a", "filename": "src/libsyntax/ext/deriving/hash.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fhash.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Fhash.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fhash.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -30,7 +30,7 @@ pub fn expand_deriving_hash<F>(cx: &mut ExtCtxt,\n                     vec!(box Literal(Path::new_local(\"__S\"))), true),\n          LifetimeBounds {\n              lifetimes: Vec::new(),\n-             bounds: vec!((\"__S\", None,\n+             bounds: vec!((\"__S\",\n                            vec!(Path::new(vec!(\"std\", \"hash\", \"Writer\"))))),\n          },\n          Path::new_local(\"__S\"))"}, {"sha": "1ddf5b2a5c31eef8106680a72b9491e4143ba059", "filename": "src/libsyntax/ext/deriving/rand.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Frand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fext%2Fderiving%2Frand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Frand.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -36,7 +36,6 @@ pub fn expand_deriving_rand<F>(cx: &mut ExtCtxt,\n                 generics: LifetimeBounds {\n                     lifetimes: Vec::new(),\n                     bounds: vec!((\"R\",\n-                                  None,\n                                   vec!( Path::new(vec!(\"std\", \"rand\", \"Rng\")) )))\n                 },\n                 explicit_self: None,"}, {"sha": "d8c6d4c41d365e93121064c466cea934044994aa", "filename": "src/libsyntax/fold.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffold.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -736,18 +736,17 @@ pub fn noop_fold_ty_param_bound<T>(tpb: TyParamBound, fld: &mut T)\n                                    -> TyParamBound\n                                    where T: Folder {\n     match tpb {\n-        TraitTyParamBound(ty) => TraitTyParamBound(fld.fold_poly_trait_ref(ty)),\n+        TraitTyParamBound(ty, modifier) => TraitTyParamBound(fld.fold_poly_trait_ref(ty), modifier),\n         RegionTyParamBound(lifetime) => RegionTyParamBound(fld.fold_lifetime(lifetime)),\n     }\n }\n \n pub fn noop_fold_ty_param<T: Folder>(tp: TyParam, fld: &mut T) -> TyParam {\n-    let TyParam {id, ident, bounds, unbound, default, span} = tp;\n+    let TyParam {id, ident, bounds, default, span} = tp;\n     TyParam {\n         id: fld.new_id(id),\n         ident: ident,\n         bounds: fld.fold_bounds(bounds),\n-        unbound: unbound.map(|x| fld.fold_trait_ref(x)),\n         default: default.map(|x| fld.fold_ty(x)),\n         span: span\n     }\n@@ -1043,7 +1042,7 @@ pub fn noop_fold_item_underscore<T: Folder>(i: Item_, folder: &mut T) -> Item_ {\n                      folder.fold_ty(ty),\n                      new_impl_items)\n         }\n-        ItemTrait(unsafety, generics, unbound, bounds, methods) => {\n+        ItemTrait(unsafety, generics, bounds, methods) => {\n             let bounds = folder.fold_bounds(bounds);\n             let methods = methods.into_iter().flat_map(|method| {\n                 let r = match method {\n@@ -1073,7 +1072,6 @@ pub fn noop_fold_item_underscore<T: Folder>(i: Item_, folder: &mut T) -> Item_ {\n             }).collect();\n             ItemTrait(unsafety,\n                       folder.fold_generics(generics),\n-                      unbound,\n                       bounds,\n                       methods)\n         }"}, {"sha": "4d1bf50f25fac87fb76fea91fd50ab362636ab8e", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 74, "deletions": 21, "changes": 95, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -15,7 +15,7 @@ use self::ItemOrViewItem::*;\n \n use abi;\n use ast::{AssociatedType, BareFnTy, ClosureTy};\n-use ast::{RegionTyParamBound, TraitTyParamBound};\n+use ast::{RegionTyParamBound, TraitTyParamBound, TraitBoundModifier};\n use ast::{ProvidedMethod, Public, Unsafety};\n use ast::{Mod, BiAdd, Arg, Arm, Attribute, BindByRef, BindByValue};\n use ast::{BiBitAnd, BiBitOr, BiBitXor, BiRem, Block};\n@@ -117,6 +117,13 @@ pub enum PathParsingMode {\n     LifetimeAndTypesWithColons,\n }\n \n+/// How to parse a bound, whether to allow bound modifiers such as `?`.\n+#[deriving(Copy, PartialEq)]\n+pub enum BoundParsingMode {\n+    Bare,\n+    Modified,\n+}\n+\n enum ItemOrViewItem {\n     /// Indicates a failure to parse any kind of item. The attributes are\n     /// returned.\n@@ -1087,12 +1094,12 @@ impl<'a> Parser<'a> {\n             let poly_trait_ref = ast::PolyTraitRef { bound_lifetimes: lifetime_defs,\n                                                      trait_ref: trait_ref };\n             let other_bounds = if self.eat(&token::BinOp(token::Plus)) {\n-                self.parse_ty_param_bounds()\n+                self.parse_ty_param_bounds(BoundParsingMode::Bare)\n             } else {\n                 OwnedSlice::empty()\n             };\n             let all_bounds =\n-                Some(TraitTyParamBound(poly_trait_ref)).into_iter()\n+                Some(TraitTyParamBound(poly_trait_ref, TraitBoundModifier::None)).into_iter()\n                 .chain(other_bounds.into_vec().into_iter())\n                 .collect();\n             ast::TyPolyTraitRef(all_bounds)\n@@ -1165,7 +1172,7 @@ impl<'a> Parser<'a> {\n         // To be helpful, parse the proc as ever\n         let _ = self.parse_legacy_lifetime_defs(lifetime_defs);\n         let _ = self.parse_fn_args(false, false);\n-        let _ = self.parse_colon_then_ty_param_bounds();\n+        let _ = self.parse_colon_then_ty_param_bounds(BoundParsingMode::Bare);\n         let _ = self.parse_ret_ty();\n \n         self.obsolete(proc_span, ObsoleteProcType);\n@@ -1255,7 +1262,7 @@ impl<'a> Parser<'a> {\n             inputs\n         };\n \n-        let bounds = self.parse_colon_then_ty_param_bounds();\n+        let bounds = self.parse_colon_then_ty_param_bounds(BoundParsingMode::Bare);\n \n         let output = self.parse_ret_ty();\n         let decl = P(FnDecl {\n@@ -1481,7 +1488,7 @@ impl<'a> Parser<'a> {\n             return lhs;\n         }\n \n-        let bounds = self.parse_ty_param_bounds();\n+        let bounds = self.parse_ty_param_bounds(BoundParsingMode::Bare);\n \n         // In type grammar, `+` is treated like a binary operator,\n         // and hence both L and R side are required.\n@@ -4022,28 +4029,35 @@ impl<'a> Parser<'a> {\n \n     // Parses a sequence of bounds if a `:` is found,\n     // otherwise returns empty list.\n-    fn parse_colon_then_ty_param_bounds(&mut self)\n+    fn parse_colon_then_ty_param_bounds(&mut self,\n+                                        mode: BoundParsingMode)\n                                         -> OwnedSlice<TyParamBound>\n     {\n         if !self.eat(&token::Colon) {\n             OwnedSlice::empty()\n         } else {\n-            self.parse_ty_param_bounds()\n+            self.parse_ty_param_bounds(mode)\n         }\n     }\n \n     // matches bounds    = ( boundseq )?\n     // where   boundseq  = ( polybound + boundseq ) | polybound\n     // and     polybound = ( 'for' '<' 'region '>' )? bound\n     // and     bound     = 'region | trait_ref\n-    // NB: The None/Some distinction is important for issue #7264.\n-    fn parse_ty_param_bounds(&mut self)\n+    fn parse_ty_param_bounds(&mut self,\n+                             mode: BoundParsingMode)\n                              -> OwnedSlice<TyParamBound>\n     {\n         let mut result = vec!();\n         loop {\n+            let question_span = self.span;\n+            let ate_question = self.eat(&token::Question);\n             match self.token {\n                 token::Lifetime(lifetime) => {\n+                    if ate_question {\n+                        self.span_err(question_span,\n+                                      \"`?` may only modify trait bounds, not lifetime bounds\");\n+                    }\n                     result.push(RegionTyParamBound(ast::Lifetime {\n                         id: ast::DUMMY_NODE_ID,\n                         span: self.span,\n@@ -4053,7 +4067,18 @@ impl<'a> Parser<'a> {\n                 }\n                 token::ModSep | token::Ident(..) => {\n                     let poly_trait_ref = self.parse_poly_trait_ref();\n-                    result.push(TraitTyParamBound(poly_trait_ref))\n+                    let modifier = if ate_question {\n+                        if mode == BoundParsingMode::Modified {\n+                            TraitBoundModifier::Maybe\n+                        } else {\n+                            self.span_err(question_span,\n+                                          \"unexpected `?`\");\n+                            TraitBoundModifier::None\n+                        }\n+                    } else {\n+                        TraitBoundModifier::None\n+                    };\n+                    result.push(TraitTyParamBound(poly_trait_ref, modifier))\n                 }\n                 _ => break,\n             }\n@@ -4082,13 +4107,14 @@ impl<'a> Parser<'a> {\n         }\n     }\n \n-    /// Matches typaram = (unbound`?`)? IDENT optbounds ( EQ ty )?\n+    /// Matches typaram = (unbound `?`)? IDENT (`?` unbound)? optbounds ( EQ ty )?\n     fn parse_ty_param(&mut self) -> TyParam {\n         // This is a bit hacky. Currently we are only interested in a single\n         // unbound, and it may only be `Sized`. To avoid backtracking and other\n         // complications, we parse an ident, then check for `?`. If we find it,\n         // we use the ident as the unbound, otherwise, we use it as the name of\n-        // type param.\n+        // type param. Even worse, for now, we need to check for `?` before or\n+        // after the bound.\n         let mut span = self.span;\n         let mut ident = self.parse_ident();\n         let mut unbound = None;\n@@ -4099,7 +4125,14 @@ impl<'a> Parser<'a> {\n             ident = self.parse_ident();\n         }\n \n-        let bounds = self.parse_colon_then_ty_param_bounds();\n+        let mut bounds = self.parse_colon_then_ty_param_bounds(BoundParsingMode::Modified);\n+        if let Some(unbound) = unbound {\n+            let mut bounds_as_vec = bounds.into_vec();\n+            bounds_as_vec.push(TraitTyParamBound(PolyTraitRef { bound_lifetimes: vec![],\n+                                                                trait_ref: unbound },\n+                                                 TraitBoundModifier::Maybe));\n+            bounds = OwnedSlice::from_vec(bounds_as_vec);\n+        };\n \n         let default = if self.check(&token::Eq) {\n             self.bump();\n@@ -4111,7 +4144,6 @@ impl<'a> Parser<'a> {\n             ident: ident,\n             id: ast::DUMMY_NODE_ID,\n             bounds: bounds,\n-            unbound: unbound,\n             default: default,\n             span: span,\n         }\n@@ -4253,7 +4285,7 @@ impl<'a> Parser<'a> {\n                     let bounded_ty = self.parse_ty();\n \n                     if self.eat(&token::Colon) {\n-                        let bounds = self.parse_ty_param_bounds();\n+                        let bounds = self.parse_ty_param_bounds(BoundParsingMode::Bare);\n                         let hi = self.span.hi;\n                         let span = mk_sp(lo, hi);\n \n@@ -4740,15 +4772,23 @@ impl<'a> Parser<'a> {\n     fn parse_item_trait(&mut self, unsafety: Unsafety) -> ItemInfo {\n         let ident = self.parse_ident();\n         let mut tps = self.parse_generics();\n-        let sized = self.parse_for_sized();\n+        let unbound = self.parse_for_sized();\n \n         // Parse supertrait bounds.\n-        let bounds = self.parse_colon_then_ty_param_bounds();\n+        let mut bounds = self.parse_colon_then_ty_param_bounds(BoundParsingMode::Bare);\n+\n+        if let Some(unbound) = unbound {\n+            let mut bounds_as_vec = bounds.into_vec();\n+            bounds_as_vec.push(TraitTyParamBound(PolyTraitRef { bound_lifetimes: vec![],\n+                                                                trait_ref: unbound },\n+                                                 TraitBoundModifier::Maybe));\n+            bounds = OwnedSlice::from_vec(bounds_as_vec);\n+        };\n \n         self.parse_where_clause(&mut tps);\n \n         let meths = self.parse_trait_items();\n-        (ident, ItemTrait(unsafety, tps, sized, bounds, meths), None)\n+        (ident, ItemTrait(unsafety, tps, bounds, meths), None)\n     }\n \n     fn parse_impl_items(&mut self) -> (Vec<ImplItem>, Vec<Attribute>) {\n@@ -4967,12 +5007,25 @@ impl<'a> Parser<'a> {\n     }\n \n     fn parse_for_sized(&mut self) -> Option<ast::TraitRef> {\n+        // FIXME, this should really use TraitBoundModifier, but it will get\n+        // re-jigged shortly in any case, so leaving the hacky version for now.\n         if self.eat_keyword(keywords::For) {\n             let span = self.span;\n+            let mut ate_question = false;\n+            if self.eat(&token::Question) {\n+                ate_question = true;\n+            }\n             let ident = self.parse_ident();\n-            if !self.eat(&token::Question) {\n+            if self.eat(&token::Question) {\n+                if ate_question {\n+                    self.span_err(span,\n+                        \"unexpected `?`\");\n+                }\n+                ate_question = true;\n+            }\n+            if !ate_question {\n                 self.span_err(span,\n-                    \"expected 'Sized?' after `for` in trait item\");\n+                    \"expected `?Sized` after `for` in trait item\");\n                 return None;\n             }\n             let tref = Parser::trait_ref_from_ident(ident, span);"}, {"sha": "7713a0f23d1b318a844be3ff4c880d7c2799313c", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -13,7 +13,7 @@ pub use self::AnnNode::*;\n use abi;\n use ast::{mod, FnUnboxedClosureKind, FnMutUnboxedClosureKind};\n use ast::{FnOnceUnboxedClosureKind};\n-use ast::{MethodImplItem, RegionTyParamBound, TraitTyParamBound};\n+use ast::{MethodImplItem, RegionTyParamBound, TraitTyParamBound, TraitBoundModifier};\n use ast::{RequiredMethod, ProvidedMethod, TypeImplItem, TypeTraitItem};\n use ast::{UnboxedClosureKind};\n use ast_util;\n@@ -958,19 +958,19 @@ impl<'a> State<'a> {\n                 }\n                 try!(self.bclose(item.span));\n             }\n-            ast::ItemTrait(unsafety, ref generics, ref unbound, ref bounds, ref methods) => {\n+            ast::ItemTrait(unsafety, ref generics, ref bounds, ref methods) => {\n                 try!(self.head(\"\"));\n                 try!(self.print_visibility(item.vis));\n                 try!(self.print_unsafety(unsafety));\n                 try!(self.word_nbsp(\"trait\"));\n                 try!(self.print_ident(item.ident));\n                 try!(self.print_generics(generics));\n-                if let &Some(ref tref) = unbound {\n+                // TODO find and print the unbound, remove it from bounds\n+                /*if let &Some(ref tref) = unbound {\n                     try!(space(&mut self.s));\n-                    try!(self.word_space(\"for\"));\n+                    try!(self.word_space(\"for ?\"));\n                     try!(self.print_trait_ref(tref));\n-                    try!(word(&mut self.s, \"?\"));\n-                }\n+                }*/\n                 try!(self.print_bounds(\":\", bounds[]));\n                 try!(self.print_where_clause(generics));\n                 try!(word(&mut self.s, \" \"));\n@@ -2361,7 +2361,11 @@ impl<'a> State<'a> {\n                 }\n \n                 try!(match *bound {\n-                    TraitTyParamBound(ref tref) => {\n+                    TraitTyParamBound(ref tref, TraitBoundModifier::None) => {\n+                        self.print_poly_trait_ref(tref)\n+                    }\n+                    TraitTyParamBound(ref tref, TraitBoundModifier::Maybe) => {\n+                        try!(word(&mut self.s, \"?\"));\n                         self.print_poly_trait_ref(tref)\n                     }\n                     RegionTyParamBound(ref lt) => {\n@@ -2428,10 +2432,6 @@ impl<'a> State<'a> {\n     }\n \n     pub fn print_ty_param(&mut self, param: &ast::TyParam) -> IoResult<()> {\n-        if let Some(ref tref) = param.unbound {\n-            try!(self.print_trait_ref(tref));\n-            try!(self.word_space(\"?\"));\n-        }\n         try!(self.print_ident(param.ident));\n         try!(self.print_bounds(\":\", param.bounds[]));\n         match param.default {"}, {"sha": "190531714c0f54544d2eade263d0a100ed3a8b1a", "filename": "src/libsyntax/visit.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e656081b700b949bc914fedd6ad29b1ca3197660/src%2Flibsyntax%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fvisit.rs?ref=e656081b700b949bc914fedd6ad29b1ca3197660", "patch": "@@ -85,8 +85,8 @@ pub trait Visitor<'v> {\n     fn visit_ty_param_bound(&mut self, bounds: &'v TyParamBound) {\n         walk_ty_param_bound(self, bounds)\n     }\n-    fn visit_poly_trait_ref(&mut self, t: &'v PolyTraitRef) {\n-        walk_poly_trait_ref(self, t)\n+    fn visit_poly_trait_ref(&mut self, t: &'v PolyTraitRef, m: &'v TraitBoundModifier) {\n+        walk_poly_trait_ref(self, t, m)\n     }\n     fn visit_struct_def(&mut self, s: &'v StructDef, _: Ident, _: &'v Generics, _: NodeId) {\n         walk_struct_def(self, s)\n@@ -244,7 +244,8 @@ pub fn walk_explicit_self<'v, V: Visitor<'v>>(visitor: &mut V,\n /// Like with walk_method_helper this doesn't correspond to a method\n /// in Visitor, and so it gets a _helper suffix.\n pub fn walk_poly_trait_ref<'v, V>(visitor: &mut V,\n-                                         trait_ref: &'v PolyTraitRef)\n+                                  trait_ref: &'v PolyTraitRef,\n+                                  _modifier: &'v TraitBoundModifier)\n     where V: Visitor<'v>\n {\n     walk_lifetime_decls_helper(visitor, &trait_ref.bound_lifetimes);\n@@ -324,7 +325,7 @@ pub fn walk_item<'v, V: Visitor<'v>>(visitor: &mut V, item: &'v Item) {\n                                      generics,\n                                      item.id)\n         }\n-        ItemTrait(_, ref generics, _, ref bounds, ref methods) => {\n+        ItemTrait(_, ref generics, ref bounds, ref methods) => {\n             visitor.visit_generics(generics);\n             walk_ty_param_bounds_helper(visitor, bounds);\n             for method in methods.iter() {\n@@ -558,8 +559,8 @@ pub fn walk_ty_param_bounds_helper<'v, V: Visitor<'v>>(visitor: &mut V,\n pub fn walk_ty_param_bound<'v, V: Visitor<'v>>(visitor: &mut V,\n                                                bound: &'v TyParamBound) {\n     match *bound {\n-        TraitTyParamBound(ref typ) => {\n-            visitor.visit_poly_trait_ref(typ);\n+        TraitTyParamBound(ref typ, ref modifier) => {\n+            visitor.visit_poly_trait_ref(typ, modifier);\n         }\n         RegionTyParamBound(ref lifetime) => {\n             visitor.visit_lifetime_bound(lifetime);"}]}