{"sha": "c28374ef0b1b787ba039f55341caae88081ccc78", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMyODM3NGVmMGIxYjc4N2JhMDM5ZjU1MzQxY2FhZTg4MDgxY2NjNzg=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-06-11T10:23:57Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-06-11T10:23:57Z"}, "message": "save-analysis: some refinements to JSON data\n\nSplit variable and function kinds to give more information. Give children for methods, structs, enums, and traits.", "tree": {"sha": "b86bba4a6fd410a92e5f42e8ad09946f105fe660", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b86bba4a6fd410a92e5f42e8ad09946f105fe660"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c28374ef0b1b787ba039f55341caae88081ccc78", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c28374ef0b1b787ba039f55341caae88081ccc78", "html_url": "https://github.com/rust-lang/rust/commit/c28374ef0b1b787ba039f55341caae88081ccc78", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c28374ef0b1b787ba039f55341caae88081ccc78/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9234c11e00d976e69bcab95342b8af469c82d5b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9234c11e00d976e69bcab95342b8af469c82d5b", "html_url": "https://github.com/rust-lang/rust/commit/a9234c11e00d976e69bcab95342b8af469c82d5b"}], "stats": {"total": 95, "additions": 77, "deletions": 18}, "files": [{"sha": "94e2a52c6ada9ff7df950e48f738455e3f2ceab8", "filename": "src/librustc_save_analysis/data.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdata.rs?ref=c28374ef0b1b787ba039f55341caae88081ccc78", "patch": "@@ -102,6 +102,8 @@ pub struct EnumData {\n     pub qualname: String,\n     pub span: Span,\n     pub scope: NodeId,\n+    pub variants: Vec<NodeId>,\n+\n }\n \n /// Data for extern crates.\n@@ -223,6 +225,7 @@ pub struct ModData {\n     pub span: Span,\n     pub scope: NodeId,\n     pub filename: String,\n+    pub items: Vec<NodeId>,\n }\n \n /// Data for a reference to a module.\n@@ -242,7 +245,8 @@ pub struct StructData {\n     pub ctor_id: NodeId,\n     pub qualname: String,\n     pub scope: NodeId,\n-    pub value: String\n+    pub value: String,\n+    pub fields: Vec<NodeId>,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -263,7 +267,8 @@ pub struct TraitData {\n     pub name: String,\n     pub qualname: String,\n     pub scope: NodeId,\n-    pub value: String\n+    pub value: String,\n+    pub items: Vec<NodeId>,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -317,6 +322,7 @@ pub struct UseGlobData {\n #[derive(Debug, RustcEncodable)]\n pub struct VariableData {\n     pub id: NodeId,\n+    pub kind: VariableKind,\n     pub name: String,\n     pub qualname: String,\n     pub span: Span,\n@@ -325,6 +331,14 @@ pub struct VariableData {\n     pub type_value: String,\n }\n \n+#[derive(Debug, RustcEncodable)]\n+pub enum VariableKind {\n+    Static,\n+    Const,\n+    Local,\n+    Field,\n+}\n+\n /// Data for the use of some item (e.g., the use of a local variable, which\n /// will refer to that variables declaration (by ref_id)).\n #[derive(Debug, RustcEncodable)]"}, {"sha": "a6bc6e180acbdf28bf8935519313974d48dc2f6d", "filename": "src/librustc_save_analysis/dump_visitor.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdump_visitor.rs?ref=c28374ef0b1b787ba039f55341caae88081ccc78", "patch": "@@ -356,6 +356,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 if !self.span.filter_generated(sub_span, p.span) {\n                     self.dumper.variable(VariableData {\n                         id: id,\n+                        kind: VariableKind::Local,\n                         span: sub_span.expect(\"No span found for variable\"),\n                         name: path_to_string(p),\n                         qualname: format!(\"{}::{}\", qualname, path_to_string(p)),\n@@ -519,6 +520,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n         if !self.span.filter_generated(sub_span, span) {\n             self.dumper.variable(VariableData {\n                 span: sub_span.expect(\"No span found for variable\"),\n+                kind: VariableKind::Const,\n                 id: id,\n                 name: name.to_string(),\n                 qualname: qualname,\n@@ -542,17 +544,18 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n         let qualname = format!(\"::{}\", self.tcx.node_path_str(item.id));\n \n         let sub_span = self.span.sub_span_after_keyword(item.span, keywords::Struct);\n-        let val = if let ast::ItemKind::Struct(ast::VariantData::Struct(ref fields, _), _) =\n-                    item.node {\n+        let (val, fields) =\n+            if let ast::ItemKind::Struct(ast::VariantData::Struct(ref fields, _), _) = item.node\n+        {\n             let fields_str = fields.iter()\n                                    .enumerate()\n                                    .map(|(i, f)| f.ident.map(|i| i.to_string())\n                                                   .unwrap_or(i.to_string()))\n                                    .collect::<Vec<_>>()\n                                    .join(\", \");\n-            format!(\"{} {{ {} }}\", name, fields_str)\n+            (format!(\"{} {{ {} }}\", name, fields_str), fields.iter().map(|f| f.id).collect())\n         } else {\n-            String::new()\n+            (String::new(), vec![])\n         };\n \n         if !self.span.filter_generated(sub_span, item.span) {\n@@ -563,7 +566,8 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 ctor_id: def.id(),\n                 qualname: qualname.clone(),\n                 scope: self.cur_scope,\n-                value: val\n+                value: val,\n+                fields: fields,\n             }.lower(self.tcx));\n         }\n \n@@ -718,7 +722,8 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                 name: name,\n                 qualname: qualname.clone(),\n                 scope: self.cur_scope,\n-                value: val\n+                value: val,\n+                items: methods.iter().map(|i| i.id).collect(),\n             }.lower(self.tcx));\n         }\n \n@@ -958,6 +963,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n             if !self.span.filter_generated(sub_span, p.span) {\n                 self.dumper.variable(VariableData {\n                     span: sub_span.expect(\"No span found for variable\"),\n+                    kind: VariableKind::Local,\n                     id: id,\n                     name: path_to_string(p),\n                     qualname: format!(\"{}${}\", path_to_string(p), id),\n@@ -1366,6 +1372,7 @@ impl<'v, 'l, 'tcx: 'l, 'll, D: Dump +'ll> Visitor<'v> for DumpVisitor<'l, 'tcx,\n                     if !self.span.filter_generated(Some(p.span), p.span) {\n                         self.dumper.variable(VariableData {\n                             span: p.span,\n+                            kind: VariableKind::Local,\n                             id: id,\n                             name: path_to_string(p),\n                             qualname: format!(\"{}${}\", path_to_string(p), id),"}, {"sha": "3c59765e6c1421ce7e97703ad6fa8b4f407af5a6", "filename": "src/librustc_save_analysis/external_data.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fexternal_data.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fexternal_data.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fexternal_data.rs?ref=c28374ef0b1b787ba039f55341caae88081ccc78", "patch": "@@ -14,7 +14,7 @@ use rustc::ty::TyCtxt;\n use syntax::ast::{CrateNum, NodeId};\n use syntax::codemap::{Span, CodeMap};\n \n-use super::data;\n+use data;\n \n // FIXME: this should be pub(crate), but the current snapshot doesn't allow it yet\n pub trait Lower {\n@@ -90,6 +90,7 @@ pub struct EnumData {\n     pub qualname: String,\n     pub span: SpanData,\n     pub scope: DefId,\n+    pub variants: Vec<DefId>\n }\n \n impl Lower for data::EnumData {\n@@ -103,6 +104,7 @@ impl Lower for data::EnumData {\n             qualname: self.qualname,\n             span: SpanData::from_span(self.span, tcx.sess.codemap()),\n             scope: make_def_id(self.scope, &tcx.map),\n+            variants: self.variants.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n         }\n     }\n }\n@@ -345,6 +347,7 @@ pub struct ModData {\n     pub span: SpanData,\n     pub scope: DefId,\n     pub filename: String,\n+    pub items: Vec<DefId>,\n }\n \n impl Lower for data::ModData {\n@@ -358,6 +361,7 @@ impl Lower for data::ModData {\n             span: SpanData::from_span(self.span, tcx.sess.codemap()),\n             scope: make_def_id(self.scope, &tcx.map),\n             filename: self.filename,\n+            items: self.items.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n         }\n     }\n }\n@@ -392,7 +396,8 @@ pub struct StructData {\n     pub ctor_id: DefId,\n     pub qualname: String,\n     pub scope: DefId,\n-    pub value: String\n+    pub value: String,\n+    pub fields: Vec<DefId>,\n }\n \n impl Lower for data::StructData {\n@@ -406,7 +411,8 @@ impl Lower for data::StructData {\n             ctor_id: make_def_id(self.ctor_id, &tcx.map),\n             qualname: self.qualname,\n             scope: make_def_id(self.scope, &tcx.map),\n-            value: self.value\n+            value: self.value,\n+            fields: self.fields.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n         }\n     }\n }\n@@ -445,7 +451,8 @@ pub struct TraitData {\n     pub id: DefId,\n     pub qualname: String,\n     pub scope: DefId,\n-    pub value: String\n+    pub value: String,\n+    pub items: Vec<DefId>,\n }\n \n impl Lower for data::TraitData {\n@@ -459,6 +466,7 @@ impl Lower for data::TraitData {\n             qualname: self.qualname,\n             scope: make_def_id(self.scope, &tcx.map),\n             value: self.value,\n+            items: self.items.into_iter().map(|id| make_def_id(id, &tcx.map)).collect(),\n         }\n     }\n }\n@@ -585,6 +593,7 @@ impl Lower for data::UseGlobData {\n pub struct VariableData {\n     pub id: DefId,\n     pub name: String,\n+    pub kind: data::VariableKind,\n     pub qualname: String,\n     pub span: SpanData,\n     pub scope: DefId,\n@@ -598,6 +607,7 @@ impl Lower for data::VariableData {\n     fn lower(self, tcx: TyCtxt) -> VariableData {\n         VariableData {\n             id: make_def_id(self.id, &tcx.map),\n+            kind: self.kind,\n             name: self.name,\n             qualname: self.qualname,\n             span: SpanData::from_span(self.span, tcx.sess.codemap()),"}, {"sha": "f1ca127667c62898cbf3c580452e066d58fa2d49", "filename": "src/librustc_save_analysis/json_dumper.rs", "status": "modified", "additions": 29, "deletions": 6, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fjson_dumper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Fjson_dumper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fjson_dumper.rs?ref=c28374ef0b1b787ba039f55341caae88081ccc78", "patch": "@@ -13,8 +13,9 @@ use std::io::Write;\n use rustc::hir::def_id::DefId;\n use rustc_serialize::json::as_json;\n \n-use super::external_data::*;\n-use super::dump::Dump;\n+use external_data::*;\n+use data::VariableKind;\n+use dump::Dump;\n \n pub struct JsonDumper<'b, W: Write + 'b> {\n     output: &'b mut W,\n@@ -180,6 +181,7 @@ struct Def {\n     name: String,\n     qualname: String,\n     value: String,\n+    children: Vec<Id>,\n }\n \n #[derive(Debug, RustcEncodable)]\n@@ -194,14 +196,19 @@ enum DefKind {\n     Trait,\n     // value = type + generics\n     Function,\n+    // value = type + generics\n+    Method,\n     // No id, no value.\n     Macro,\n     // value = file_name\n     Mod,\n     // value = aliased type\n     Type,\n-    // value = type and init expression\n-    Variable,\n+    // value = type and init expression (for all variable kinds).\n+    Local,\n+    Static,\n+    Const,\n+    Field,\n }\n \n impl From<EnumData> for Def {\n@@ -213,6 +220,7 @@ impl From<EnumData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: data.variants.into_iter().map(|id| From::from(id)).collect(),\n         }\n     }\n }\n@@ -226,6 +234,7 @@ impl From<TupleVariantData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: vec![],\n         }\n     }\n }\n@@ -238,6 +247,7 @@ impl From<StructVariantData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: vec![],\n         }\n     }\n }\n@@ -250,6 +260,7 @@ impl From<StructData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: data.fields.into_iter().map(|id| From::from(id)).collect(),\n         }\n     }\n }\n@@ -262,6 +273,7 @@ impl From<TraitData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: data.items.into_iter().map(|id| From::from(id)).collect(),\n         }\n     }\n }\n@@ -274,18 +286,20 @@ impl From<FunctionData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: vec![],\n         }\n     }\n }\n impl From<MethodData> for Def {\n     fn from(data: MethodData) -> Def {\n         Def {\n-            kind: DefKind::Function,\n+            kind: DefKind::Method,\n             id: From::from(data.id),\n             span: data.span,\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: vec![],\n         }\n     }\n }\n@@ -298,6 +312,7 @@ impl From<MacroData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: String::new(),\n+            children: vec![],\n         }\n     }\n }\n@@ -310,6 +325,7 @@ impl From<ModData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.filename,\n+            children: data.items.into_iter().map(|id| From::from(id)).collect(),\n         }\n     }\n }\n@@ -322,18 +338,25 @@ impl From<TypeDefData> for Def {\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: vec![],\n         }\n     }\n }\n impl From<VariableData> for Def {\n     fn from(data: VariableData) -> Def {\n         Def {\n-            kind: DefKind::Variable,\n+            kind: match data.kind {\n+                VariableKind::Static => DefKind::Static,\n+                VariableKind::Const => DefKind::Const,\n+                VariableKind::Local => DefKind::Local,\n+                VariableKind::Field => DefKind::Field,\n+            },\n             id: From::from(data.id),\n             span: data.span,\n             name: data.name,\n             qualname: data.qualname,\n             value: data.value,\n+            children: vec![],\n         }\n     }\n }"}, {"sha": "3335133816043eedb916c632434817d57c093b74", "filename": "src/librustc_save_analysis/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c28374ef0b1b787ba039f55341caae88081ccc78/src%2Flibrustc_save_analysis%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Flib.rs?ref=c28374ef0b1b787ba039f55341caae88081ccc78", "patch": "@@ -153,6 +153,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                 filter!(self.span_utils, sub_span, item.span, None);\n                 Some(Data::VariableData(VariableData {\n                     id: item.id,\n+                    kind: VariableKind::Static,\n                     name: item.ident.to_string(),\n                     qualname: qualname,\n                     span: sub_span.unwrap(),\n@@ -167,6 +168,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                 filter!(self.span_utils, sub_span, item.span, None);\n                 Some(Data::VariableData(VariableData {\n                     id: item.id,\n+                    kind: VariableKind::Const,\n                     name: item.ident.to_string(),\n                     qualname: qualname,\n                     span: sub_span.unwrap(),\n@@ -190,6 +192,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     span: sub_span.unwrap(),\n                     scope: self.enclosing_scope(item.id),\n                     filename: filename,\n+                    items: m.items.iter().map(|i| i.id).collect(),\n                 }))\n             }\n             ast::ItemKind::Enum(ref def, _) => {\n@@ -209,6 +212,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n                     span: sub_span.unwrap(),\n                     qualname: qualname,\n                     scope: self.enclosing_scope(item.id),\n+                    variants: def.variants.iter().map(|v| v.node.data.id()).collect(),\n                 }))\n             }\n             ast::ItemKind::Impl(_, _, _, ref trait_ref, ref typ, _) => {\n@@ -266,6 +270,7 @@ impl<'l, 'tcx: 'l> SaveContext<'l, 'tcx> {\n             filter!(self.span_utils, sub_span, field.span, None);\n             Some(VariableData {\n                 id: field.id,\n+                kind: VariableKind::Field,\n                 name: ident.to_string(),\n                 qualname: qualname,\n                 span: sub_span.unwrap(),"}]}