{"sha": "a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyZTNlZDVjMDU0YjU0NGRmNmNlZWI5ZTYxMmQzOWFmODE5ZjRhYWU=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-09-14T18:11:31Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-10-18T10:29:57Z"}, "message": "[const-prop] Handle MIR Rvalue::Aggregates", "tree": {"sha": "e179b39016c1fbc3dfad1393a683232f55f5cd70", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e179b39016c1fbc3dfad1393a683232f55f5cd70"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "html_url": "https://github.com/rust-lang/rust/commit/a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8f7e18ceb29d78314ceef16979ff6ce5356f4c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8f7e18ceb29d78314ceef16979ff6ce5356f4c2", "html_url": "https://github.com/rust-lang/rust/commit/c8f7e18ceb29d78314ceef16979ff6ce5356f4c2"}], "stats": {"total": 82, "additions": 75, "deletions": 7}, "files": [{"sha": "2119ee1b598efe3fa4e43f04da71502059106fb1", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -436,13 +436,13 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n \n         // if this isn't a supported operation, then return None\n         match rvalue {\n-            Rvalue::Aggregate(..) |\n             Rvalue::NullaryOp(NullOp::Box, _) |\n             Rvalue::Discriminant(..) => return None,\n \n             Rvalue::Use(_) |\n             Rvalue::Len(_) |\n             Rvalue::Repeat(..) |\n+            Rvalue::Aggregate(..) |\n             Rvalue::Cast(..) |\n             Rvalue::NullaryOp(..) |\n             Rvalue::CheckedBinaryOp(..) |\n@@ -535,6 +535,12 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n                     return None;\n                 }\n             }\n+        } else if let Rvalue::Aggregate(_, operands) = rvalue {\n+            // FIXME(wesleywiser): const eval will turn this into a `const Scalar(<ZST>)` that\n+            // `SimplifyLocals` doesn't know it can remove.\n+            if operands.len() == 0 {\n+                return None;\n+            }\n         }\n \n         self.use_ecx(source_info, |this| {"}, {"sha": "add4eef13c78477d73172764b8fc3365d671d624", "filename": "src/test/compile-fail/consts/const-err3.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fcompile-fail%2Fconsts%2Fconst-err3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fcompile-fail%2Fconsts%2Fconst-err3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fconsts%2Fconst-err3.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -14,6 +14,7 @@ fn main() {\n     //~^ ERROR const_err\n     let _e = [5u8][1];\n     //~^ ERROR const_err\n+    //~| ERROR this expression will panic at runtime\n     black_box(b);\n     black_box(c);\n     black_box(d);"}, {"sha": "0937d37be6b6e083c5bb89e26df8518d49891bca", "filename": "src/test/mir-opt/const_prop/aggregate.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fmir-opt%2Fconst_prop%2Faggregate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fmir-opt%2Fconst_prop%2Faggregate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Faggregate.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -0,0 +1,25 @@\n+// compile-flags: -O\n+\n+fn main() {\n+    let x = (0, 1, 2).1 + 0;\n+}\n+\n+// END RUST SOURCE\n+// START rustc.main.ConstProp.before.mir\n+//  bb0: {\n+//      ...\n+//      _3 = (const 0i32, const 1i32, const 2i32);\n+//      _2 = (_3.1: i32);\n+//      _1 = Add(move _2, const 0i32);\n+//      ...\n+//  }\n+// END rustc.main.ConstProp.before.mir\n+// START rustc.main.ConstProp.after.mir\n+//  bb0: {\n+//      ...\n+//      _3 = (const 0i32, const 1i32, const 2i32);\n+//      _2 = const 1i32;\n+//      _1 = Add(move _2, const 0i32);\n+//      ...\n+//  }\n+// END rustc.main.ConstProp.after.mir"}, {"sha": "58dfc5710ae4e3d7a619f6c1ffe2598a2f79ec5f", "filename": "src/test/run-fail/overflowing-rsh-5.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Frun-fail%2Foverflowing-rsh-5.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Frun-fail%2Foverflowing-rsh-5.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Foverflowing-rsh-5.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -2,6 +2,7 @@\n // compile-flags: -C debug-assertions\n \n #![warn(exceeding_bitshifts)]\n+#![warn(const_err)]\n \n fn main() {\n     let _n = 1i64 >> [64][0];"}, {"sha": "c2fec5e4860af772e9449b5e997c563c54027f8c", "filename": "src/test/run-fail/overflowing-rsh-6.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Frun-fail%2Foverflowing-rsh-6.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Frun-fail%2Foverflowing-rsh-6.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Foverflowing-rsh-6.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -2,6 +2,7 @@\n // compile-flags: -C debug-assertions\n \n #![warn(exceeding_bitshifts)]\n+#![warn(const_err)]\n #![feature(const_indexing)]\n \n fn main() {"}, {"sha": "e5ee90fc9f11f00b84eea165de12dadab70be07f", "filename": "src/test/ui/consts/const-err2.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-err2.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -23,6 +23,7 @@ fn main() {\n     //~^ ERROR const_err\n     let _e = [5u8][1];\n     //~^ ERROR index out of bounds\n+    //~| ERROR this expression will panic at runtime\n     black_box(a);\n     black_box(b);\n     black_box(c);"}, {"sha": "0a09a7213dabc8f6596c2351ddaacf9521d69570", "filename": "src/test/ui/consts/const-err2.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-err2.stderr?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -34,5 +34,11 @@ error: index out of bounds: the len is 1 but the index is 1\n LL |     let _e = [5u8][1];\n    |              ^^^^^^^^\n \n-error: aborting due to 5 previous errors\n+error: this expression will panic at runtime\n+  --> $DIR/const-err2.rs:24:14\n+   |\n+LL |     let _e = [5u8][1];\n+   |              ^^^^^^^^ index out of bounds: the len is 1 but the index is 1\n+\n+error: aborting due to 6 previous errors\n "}, {"sha": "89373f99f75c235ac7017ade4ce3679565d2a0c6", "filename": "src/test/ui/consts/const-err3.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-err3.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -23,6 +23,7 @@ fn main() {\n     //~^ ERROR const_err\n     let _e = [5u8][1];\n     //~^ ERROR const_err\n+    //~| ERROR this expression will panic at runtime\n     black_box(a);\n     black_box(b);\n     black_box(c);"}, {"sha": "42de247c8f7e074d6a9e139cae02d89e99d5104f", "filename": "src/test/ui/consts/const-err3.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err3.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fconsts%2Fconst-err3.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-err3.stderr?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -34,5 +34,11 @@ error: index out of bounds: the len is 1 but the index is 1\n LL |     let _e = [5u8][1];\n    |              ^^^^^^^^\n \n-error: aborting due to 5 previous errors\n+error: this expression will panic at runtime\n+  --> $DIR/const-err3.rs:24:14\n+   |\n+LL |     let _e = [5u8][1];\n+   |              ^^^^^^^^ index out of bounds: the len is 1 but the index is 1\n+\n+error: aborting due to 6 previous errors\n "}, {"sha": "e7221e2cbb1e134463c78a65c114b36d227bfb43", "filename": "src/test/ui/issues/issue-54348.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fissues%2Fissue-54348.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fissues%2Fissue-54348.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-54348.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -1,5 +1,7 @@\n fn main() {\n     [1][0u64 as usize];\n     [1][1.5 as usize]; //~ ERROR index out of bounds\n+    //~| ERROR this expression will panic at runtime\n     [1][1u64 as usize]; //~ ERROR index out of bounds\n+    //~| ERROR this expression will panic at runtime\n }"}, {"sha": "79320ef4f31c788bdf58fc00895b38811fea695c", "filename": "src/test/ui/issues/issue-54348.stderr", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fissues%2Fissue-54348.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Fissues%2Fissue-54348.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-54348.stderr?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -6,11 +6,23 @@ LL |     [1][1.5 as usize];\n    |\n    = note: `#[deny(const_err)]` on by default\n \n+error: this expression will panic at runtime\n+  --> $DIR/issue-54348.rs:3:5\n+   |\n+LL |     [1][1.5 as usize];\n+   |     ^^^^^^^^^^^^^^^^^ index out of bounds: the len is 1 but the index is 1\n+\n error: index out of bounds: the len is 1 but the index is 1\n-  --> $DIR/issue-54348.rs:4:5\n+  --> $DIR/issue-54348.rs:5:5\n    |\n LL |     [1][1u64 as usize];\n    |     ^^^^^^^^^^^^^^^^^^\n \n-error: aborting due to 2 previous errors\n+error: this expression will panic at runtime\n+  --> $DIR/issue-54348.rs:5:5\n+   |\n+LL |     [1][1u64 as usize];\n+   |     ^^^^^^^^^^^^^^^^^^ index out of bounds: the len is 1 but the index is 1\n+\n+error: aborting due to 4 previous errors\n "}, {"sha": "2c213daddd7527a74470d02b5a2531fad6f34241", "filename": "src/test/ui/lint/lint-exceeding-bitshifts2.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Flint%2Flint-exceeding-bitshifts2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Flint%2Flint-exceeding-bitshifts2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-exceeding-bitshifts2.rs?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -8,7 +8,7 @@ fn main() {\n       let n = 1u8 << (4+3);\n       let n = 1u8 << (4+4); //~ ERROR: attempt to shift left with overflow\n       let n = 1i64 >> [63][0];\n-      let n = 1i64 >> [64][0]; // should be linting, needs to wait for const propagation\n+      let n = 1i64 >> [64][0]; //~ ERROR: attempt to shift right with overflow\n \n       #[cfg(target_pointer_width = \"32\")]\n       const BITS: usize = 32;"}, {"sha": "d9c76d233d03eb01186e402865639ccd49d85107", "filename": "src/test/ui/lint/lint-exceeding-bitshifts2.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Flint%2Flint-exceeding-bitshifts2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a2e3ed5c054b544df6ceeb9e612d39af819f4aae/src%2Ftest%2Fui%2Flint%2Flint-exceeding-bitshifts2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-exceeding-bitshifts2.stderr?ref=a2e3ed5c054b544df6ceeb9e612d39af819f4aae", "patch": "@@ -10,6 +10,12 @@ note: lint level defined here\n LL | #![deny(exceeding_bitshifts, const_err)]\n    |         ^^^^^^^^^^^^^^^^^^^\n \n+error: attempt to shift right with overflow\n+  --> $DIR/lint-exceeding-bitshifts2.rs:11:15\n+   |\n+LL |       let n = 1i64 >> [64][0];\n+   |               ^^^^^^^^^^^^^^^\n+\n error: attempt to shift left with overflow\n   --> $DIR/lint-exceeding-bitshifts2.rs:17:15\n    |\n@@ -22,5 +28,5 @@ error: attempt to shift left with overflow\n LL |       let n = 1_usize << BITS;\n    |               ^^^^^^^^^^^^^^^\n \n-error: aborting due to 3 previous errors\n+error: aborting due to 4 previous errors\n "}]}