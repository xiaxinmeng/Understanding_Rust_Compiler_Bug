{"sha": "ce773352d06f490fb1bfb5057035e93effcf5781", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlNzczMzUyZDA2ZjQ5MGZiMWJmYjUwNTcwMzVlOTNlZmZjZjU3ODE=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2012-09-14T23:49:23Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2012-09-14T23:50:12Z"}, "message": "rustc: Make the box annihilator a language item", "tree": {"sha": "e30b4adddb1ece77809be057bb026b4adb5733c5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e30b4adddb1ece77809be057bb026b4adb5733c5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ce773352d06f490fb1bfb5057035e93effcf5781", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ce773352d06f490fb1bfb5057035e93effcf5781", "html_url": "https://github.com/rust-lang/rust/commit/ce773352d06f490fb1bfb5057035e93effcf5781", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ce773352d06f490fb1bfb5057035e93effcf5781/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7e5c870f33c8eab21540bfe045a291aedbdc838", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7e5c870f33c8eab21540bfe045a291aedbdc838", "html_url": "https://github.com/rust-lang/rust/commit/c7e5c870f33c8eab21540bfe045a291aedbdc838"}], "stats": {"total": 31, "additions": 24, "deletions": 7}, "files": [{"sha": "ed1564cc426f32ca3ee308a34aa912281ca70e67", "filename": "src/libcore/cleanup.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ce773352d06f490fb1bfb5057035e93effcf5781/src%2Flibcore%2Fcleanup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce773352d06f490fb1bfb5057035e93effcf5781/src%2Flibcore%2Fcleanup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fcleanup.rs?ref=ce773352d06f490fb1bfb5057035e93effcf5781", "patch": "@@ -5,6 +5,8 @@ use rt::rt_free;\n use sys::TypeDesc;\n use unsafe::transmute;\n \n+export annihilate;\n+\n /**\n  * Runtime structures\n  *\n@@ -65,8 +67,7 @@ struct Task {\n  * This runs at task death to free all boxes.\n  */\n \n-/// Destroys all managed memory (i.e. @ boxes) held by the current task.\n-pub unsafe fn annihilate() {\n+unsafe fn do_annihilate() {\n     let task: *Task = transmute(rustrt::rust_get_task());\n \n     // Pass 1: Make all boxes immortal.\n@@ -104,6 +105,18 @@ pub unsafe fn annihilate() {\n     }\n }\n \n+/// Destroys all managed memory (i.e. @ boxes) held by the current task.\n+#[cfg(notest)]\n+#[lang=\"annihilate\"]\n+pub unsafe fn annihilate() {\n+    do_annihilate();\n+}\n+\n+#[cfg(test)]\n+pub unsafe fn annihilate() {\n+    do_annihilate();\n+}\n+\n /// Bindings to the runtime\n extern mod rustrt {\n     #[rust_stack]\n@@ -116,7 +129,7 @@ extern mod rustrt {\n \n #[cfg(test)]\n mod tests {\n-    /*struct Knot {\n+    struct Knot {\n         mut a: Option<@Knot>\n     }\n \n@@ -147,6 +160,6 @@ mod tests {\n             unsafe::forget(f_ref);\n             unsafe::forget(f);\n         }\n-    }*/\n+    }\n }\n "}, {"sha": "1e558a8ded477110cf133cd60f92a3163f61caef", "filename": "src/libcore/core.rc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ce773352d06f490fb1bfb5057035e93effcf5781/src%2Flibcore%2Fcore.rc", "raw_url": "https://github.com/rust-lang/rust/raw/ce773352d06f490fb1bfb5057035e93effcf5781/src%2Flibcore%2Fcore.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fcore.rc?ref=ce773352d06f490fb1bfb5057035e93effcf5781", "patch": "@@ -62,6 +62,7 @@ export flate;\n export unit;\n export uniq;\n export repr;\n+export cleanup;\n \n // NDM seems to be necessary for resolve to work\n export option_iter;\n@@ -228,6 +229,7 @@ mod unsafe;\n mod mutable;\n mod flate;\n mod repr;\n+mod cleanup;\n \n // Modules supporting compiler-generated code\n // Exported but not part of the public interface\n@@ -244,7 +246,6 @@ mod unicode;\n mod private;\n mod cmath;\n mod stackwalk;\n-mod cleanup;\n \n // Local Variables:\n // mode: rust;"}, {"sha": "cd30e575bdacc9552714c727eff3af4adf5a71ff", "filename": "src/rustc/middle/lang_items.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ce773352d06f490fb1bfb5057035e93effcf5781/src%2Frustc%2Fmiddle%2Flang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce773352d06f490fb1bfb5057035e93effcf5781/src%2Frustc%2Fmiddle%2Flang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Flang_items.rs?ref=ce773352d06f490fb1bfb5057035e93effcf5781", "patch": "@@ -45,7 +45,8 @@ struct LanguageItems {\n     mut ord_trait: Option<def_id>,\n \n     mut str_eq_fn: Option<def_id>,\n-    mut uniq_str_eq_fn: Option<def_id>\n+    mut uniq_str_eq_fn: Option<def_id>,\n+    mut annihilate_fn: Option<def_id>\n }\n \n mod LanguageItems {\n@@ -73,7 +74,8 @@ mod LanguageItems {\n             ord_trait: None,\n \n             str_eq_fn: None,\n-            uniq_str_eq_fn: None\n+            uniq_str_eq_fn: None,\n+            annihilate_fn: None\n         }\n     }\n }\n@@ -107,6 +109,7 @@ fn LanguageItemCollector(crate: @crate, session: session,\n \n     item_refs.insert(~\"str_eq\", &mut items.str_eq_fn);\n     item_refs.insert(~\"uniq_str_eq\", &mut items.uniq_str_eq_fn);\n+    item_refs.insert(~\"annihilate\", &mut items.annihilate_fn);\n \n     LanguageItemCollector {\n         crate: crate,"}]}