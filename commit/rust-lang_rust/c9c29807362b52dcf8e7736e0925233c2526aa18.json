{"sha": "c9c29807362b52dcf8e7736e0925233c2526aa18", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM5YzI5ODA3MzYyYjUyZGNmOGU3NzM2ZTA5MjUyMzNjMjUyNmFhMTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-11T00:23:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-11T00:23:23Z"}, "message": "Auto merge of #47243 - wesleywiser:incr_fingerprint_encoding, r=michaelwoerister\n\n[incremental] Specialize encoding and decoding of Fingerprints\n\nThis saves the storage space used by about 32 bits per `Fingerprint`.\nOn average, this reduces the size of the `/target/{mode}/incremental`\nfolder by roughly 5% [Full details here](https://gist.github.com/wesleywiser/264076314794fbd6a4c110d7c1adc43e).\n\nFixes #45875\n\nr? @michaelwoerister", "tree": {"sha": "6d34a64d43285bfc0ede7067f13ecad0d08e5663", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d34a64d43285bfc0ede7067f13ecad0d08e5663"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c9c29807362b52dcf8e7736e0925233c2526aa18", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c9c29807362b52dcf8e7736e0925233c2526aa18", "html_url": "https://github.com/rust-lang/rust/commit/c9c29807362b52dcf8e7736e0925233c2526aa18", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c9c29807362b52dcf8e7736e0925233c2526aa18/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f62f774035735a06c880c48c0b9017fcc0577e33", "url": "https://api.github.com/repos/rust-lang/rust/commits/f62f774035735a06c880c48c0b9017fcc0577e33", "html_url": "https://github.com/rust-lang/rust/commit/f62f774035735a06c880c48c0b9017fcc0577e33"}, {"sha": "01c890ee961aa18e2bfea5c07f4cdd9a29053479", "url": "https://api.github.com/repos/rust-lang/rust/commits/01c890ee961aa18e2bfea5c07f4cdd9a29053479", "html_url": "https://github.com/rust-lang/rust/commit/01c890ee961aa18e2bfea5c07f4cdd9a29053479"}], "stats": {"total": 80, "additions": 78, "deletions": 2}, "files": [{"sha": "a7adf28c481b95c3fa352aa6345254df6f6a15be", "filename": "src/librustc/ich/fingerprint.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc%2Fich%2Ffingerprint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc%2Fich%2Ffingerprint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Ffingerprint.rs?ref=c9c29807362b52dcf8e7736e0925233c2526aa18", "patch": "@@ -8,9 +8,12 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use std::mem;\n use rustc_data_structures::stable_hasher;\n+use serialize;\n+use serialize::opaque::{EncodeResult, Encoder, Decoder};\n \n-#[derive(Eq, PartialEq, Ord, PartialOrd, Hash, Debug, Clone, Copy, RustcEncodable, RustcDecodable)]\n+#[derive(Eq, PartialEq, Ord, PartialOrd, Hash, Debug, Clone, Copy)]\n pub struct Fingerprint(u64, u64);\n \n impl Fingerprint {\n@@ -46,6 +49,21 @@ impl Fingerprint {\n         format!(\"{:x}{:x}\", self.0, self.1)\n     }\n \n+    pub fn encode_opaque(&self, encoder: &mut Encoder) -> EncodeResult {\n+        let bytes: [u8; 16] = unsafe { mem::transmute([self.0.to_le(), self.1.to_le()]) };\n+\n+        encoder.emit_raw_bytes(&bytes)\n+    }\n+\n+    pub fn decode_opaque<'a>(decoder: &mut Decoder<'a>) -> Result<Fingerprint, String> {\n+        let mut bytes = [0; 16];\n+\n+        decoder.read_raw_bytes(&mut bytes)?;\n+\n+        let [l, r]: [u64; 2] = unsafe { mem::transmute(bytes) };\n+\n+        Ok(Fingerprint(u64::from_le(l), u64::from_le(r)))\n+    }\n }\n \n impl ::std::fmt::Display for Fingerprint {\n@@ -69,3 +87,19 @@ impl<CTX> stable_hasher::HashStable<CTX> for Fingerprint {\n         ::std::hash::Hash::hash(self, hasher);\n     }\n }\n+\n+impl serialize::UseSpecializedEncodable for Fingerprint { }\n+\n+impl serialize::UseSpecializedDecodable for Fingerprint { }\n+\n+impl<'a> serialize::SpecializedEncoder<Fingerprint> for serialize::opaque::Encoder<'a> {\n+    fn specialized_encode(&mut self, f: &Fingerprint) -> Result<(), Self::Error> {\n+        f.encode_opaque(self)\n+    }\n+}\n+\n+impl<'a> serialize::SpecializedDecoder<Fingerprint> for serialize::opaque::Decoder<'a> {\n+    fn specialized_decode(&mut self) -> Result<Fingerprint, Self::Error> {\n+        Fingerprint::decode_opaque(self)\n+    }\n+}"}, {"sha": "cd796d3ad963a19daed504c3cfcb98cad6787e67", "filename": "src/librustc/ty/maps/on_disk_cache.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc%2Fty%2Fmaps%2Fon_disk_cache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc%2Fty%2Fmaps%2Fon_disk_cache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fon_disk_cache.rs?ref=c9c29807362b52dcf8e7736e0925233c2526aa18", "patch": "@@ -14,7 +14,7 @@ use hir;\n use hir::def_id::{CrateNum, DefIndex, DefId, LocalDefId,\n                   RESERVED_FOR_INCR_COMP_CACHE, LOCAL_CRATE};\n use hir::map::definitions::DefPathHash;\n-use ich::CachingCodemapView;\n+use ich::{CachingCodemapView, Fingerprint};\n use mir;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n@@ -660,6 +660,12 @@ impl<'a, 'tcx, 'x> SpecializedDecoder<NodeId> for CacheDecoder<'a, 'tcx, 'x> {\n     }\n }\n \n+impl<'a, 'tcx, 'x> SpecializedDecoder<Fingerprint> for CacheDecoder<'a, 'tcx, 'x> {\n+    fn specialized_decode(&mut self) -> Result<Fingerprint, Self::Error> {\n+        Fingerprint::decode_opaque(&mut self.opaque)\n+    }\n+}\n+\n impl<'a, 'tcx, 'x, T: Decodable> SpecializedDecoder<mir::ClearCrossCrate<T>>\n for CacheDecoder<'a, 'tcx, 'x> {\n     #[inline]\n@@ -879,6 +885,14 @@ impl<'enc, 'a, 'tcx, E> SpecializedEncoder<NodeId> for CacheEncoder<'enc, 'a, 't\n     }\n }\n \n+impl<'enc, 'a, 'tcx> SpecializedEncoder<Fingerprint>\n+for CacheEncoder<'enc, 'a, 'tcx, opaque::Encoder<'enc>>\n+{\n+    fn specialized_encode(&mut self, f: &Fingerprint) -> Result<(), Self::Error> {\n+        f.encode_opaque(&mut self.encoder)\n+    }\n+}\n+\n impl<'enc, 'a, 'tcx, E, T> SpecializedEncoder<mir::ClearCrossCrate<T>>\n for CacheEncoder<'enc, 'a, 'tcx, E>\n     where E: 'enc + ty_codec::TyEncoder,"}, {"sha": "7023bd1e6a927a52ab201cb4c910d3af8972e0a0", "filename": "src/librustc_metadata/decoder.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc_metadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc_metadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdecoder.rs?ref=c9c29807362b52dcf8e7736e0925233c2526aa18", "patch": "@@ -330,6 +330,12 @@ impl<'a, 'tcx> SpecializedDecoder<Span> for DecodeContext<'a, 'tcx> {\n     }\n }\n \n+impl<'a, 'tcx> SpecializedDecoder<Fingerprint> for DecodeContext<'a, 'tcx> {\n+    fn specialized_decode(&mut self) -> Result<Fingerprint, Self::Error> {\n+        Fingerprint::decode_opaque(&mut self.opaque)\n+    }\n+}\n+\n impl<'a, 'tcx, T: Decodable> SpecializedDecoder<mir::ClearCrossCrate<T>>\n for DecodeContext<'a, 'tcx> {\n     #[inline]"}, {"sha": "88671e9797a6c6112974fc4a05e474387c6c58cb", "filename": "src/librustc_metadata/encoder.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc_metadata%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibrustc_metadata%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fencoder.rs?ref=c9c29807362b52dcf8e7736e0925233c2526aa18", "patch": "@@ -18,6 +18,7 @@ use rustc::middle::cstore::{LinkMeta, LinkagePreference, NativeLibrary,\n use rustc::hir::def::CtorKind;\n use rustc::hir::def_id::{CrateNum, CRATE_DEF_INDEX, DefIndex, DefId, LOCAL_CRATE};\n use rustc::hir::map::definitions::DefPathTable;\n+use rustc::ich::Fingerprint;\n use rustc::middle::dependency_format::Linkage;\n use rustc::middle::lang_items;\n use rustc::mir;\n@@ -192,6 +193,12 @@ impl<'a, 'tcx> SpecializedEncoder<ty::GenericPredicates<'tcx>> for EncodeContext\n     }\n }\n \n+impl<'a, 'tcx> SpecializedEncoder<Fingerprint> for EncodeContext<'a, 'tcx> {\n+    fn specialized_encode(&mut self, f: &Fingerprint) -> Result<(), Self::Error> {\n+        f.encode_opaque(&mut self.opaque)\n+    }\n+}\n+\n impl<'a, 'tcx, T: Encodable> SpecializedEncoder<mir::ClearCrossCrate<T>>\n for EncodeContext<'a, 'tcx> {\n     fn specialized_encode(&mut self,"}, {"sha": "409366102bacd81e2678169a152c6c69e4f6dd0d", "filename": "src/libserialize/opaque.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibserialize%2Fopaque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c9c29807362b52dcf8e7736e0925233c2526aa18/src%2Flibserialize%2Fopaque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibserialize%2Fopaque.rs?ref=c9c29807362b52dcf8e7736e0925233c2526aa18", "patch": "@@ -27,6 +27,10 @@ impl<'a> Encoder<'a> {\n     pub fn new(cursor: &'a mut io::Cursor<Vec<u8>>) -> Encoder<'a> {\n         Encoder { cursor: cursor }\n     }\n+\n+    pub fn emit_raw_bytes(&mut self, s: &[u8]) -> EncodeResult {\n+        self.cursor.write_all(s)\n+    }\n }\n \n \n@@ -169,6 +173,17 @@ impl<'a> Decoder<'a> {\n     pub fn advance(&mut self, bytes: usize) {\n         self.position += bytes;\n     }\n+\n+    pub fn read_raw_bytes(&mut self, s: &mut [u8]) -> Result<(), String> {\n+        let start = self.position;\n+        let end = start + s.len();\n+\n+        s.copy_from_slice(&self.data[start..end]);\n+\n+        self.position = end;\n+\n+        Ok(())\n+    }\n }\n \n macro_rules! read_uleb128 {"}]}