{"sha": "ee130515e3788d886cdf18442871936a99c134b6", "node_id": "C_kwDOAAsO6NoAKGVlMTMwNTE1ZTM3ODhkODg2Y2RmMTg0NDI4NzE5MzZhOTljMTM0YjY", "commit": {"author": {"name": "cassaundra", "email": "cass@cassaundra.io", "date": "2021-12-29T23:41:26Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2022-03-06T17:23:50Z"}, "message": "Fix missing struct field separators under certain conditions\n\nWhen struct_field_align_threshold is non-zero and trailing_comma is set to\n\"Never,\" struct field separators are omitted between field groups. This issue is\nresolved by forcing separators between groups.\n\nFixes #4791.\n\nA test is included with a minimal reproducible example.", "tree": {"sha": "171067b8833e4c0cc49dc98e53a53d47e91f2fab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/171067b8833e4c0cc49dc98e53a53d47e91f2fab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee130515e3788d886cdf18442871936a99c134b6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee130515e3788d886cdf18442871936a99c134b6", "html_url": "https://github.com/rust-lang/rust/commit/ee130515e3788d886cdf18442871936a99c134b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee130515e3788d886cdf18442871936a99c134b6/comments", "author": {"login": "cassaundra", "id": 21976313, "node_id": "MDQ6VXNlcjIxOTc2MzEz", "avatar_url": "https://avatars.githubusercontent.com/u/21976313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cassaundra", "html_url": "https://github.com/cassaundra", "followers_url": "https://api.github.com/users/cassaundra/followers", "following_url": "https://api.github.com/users/cassaundra/following{/other_user}", "gists_url": "https://api.github.com/users/cassaundra/gists{/gist_id}", "starred_url": "https://api.github.com/users/cassaundra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cassaundra/subscriptions", "organizations_url": "https://api.github.com/users/cassaundra/orgs", "repos_url": "https://api.github.com/users/cassaundra/repos", "events_url": "https://api.github.com/users/cassaundra/events{/privacy}", "received_events_url": "https://api.github.com/users/cassaundra/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "272fb42f06479afb62a9503f181540101f67982a", "url": "https://api.github.com/repos/rust-lang/rust/commits/272fb42f06479afb62a9503f181540101f67982a", "html_url": "https://github.com/rust-lang/rust/commit/272fb42f06479afb62a9503f181540101f67982a"}], "stats": {"total": 51, "additions": 48, "deletions": 3}, "files": [{"sha": "a06bc995aa55e5885a918ec6a313893f530d1706", "filename": "src/vertical.rs", "status": "modified", "additions": 20, "deletions": 3, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/ee130515e3788d886cdf18442871936a99c134b6/src%2Fvertical.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee130515e3788d886cdf18442871936a99c134b6/src%2Fvertical.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvertical.rs?ref=ee130515e3788d886cdf18442871936a99c134b6", "patch": "@@ -160,8 +160,18 @@ pub(crate) fn rewrite_with_alignment<T: AlignedItem>(\n     };\n     let init_span = mk_sp(span.lo(), init_last_pos);\n     let one_line_width = if rest.is_empty() { one_line_width } else { 0 };\n-    let result =\n-        rewrite_aligned_items_inner(context, init, init_span, shape.indent, one_line_width)?;\n+\n+    // if another group follows, we must force a separator\n+    let force_separator = !rest.is_empty();\n+\n+    let result = rewrite_aligned_items_inner(\n+        context,\n+        init,\n+        init_span,\n+        shape.indent,\n+        one_line_width,\n+        force_separator,\n+    )?;\n     if rest.is_empty() {\n         Some(result + spaces)\n     } else {\n@@ -201,6 +211,7 @@ fn rewrite_aligned_items_inner<T: AlignedItem>(\n     span: Span,\n     offset: Indent,\n     one_line_width: usize,\n+    force_trailing_separator: bool,\n ) -> Option<String> {\n     // 1 = \",\"\n     let item_shape = Shape::indented(offset, context.config).sub_width(1)?;\n@@ -246,9 +257,15 @@ fn rewrite_aligned_items_inner<T: AlignedItem>(\n             });\n     }\n \n+    let separator_tactic = if force_trailing_separator {\n+        SeparatorTactic::Always\n+    } else {\n+        context.config.trailing_comma()\n+    };\n+\n     let fmt = ListFormatting::new(item_shape, context.config)\n         .tactic(tactic)\n-        .trailing_separator(context.config.trailing_comma())\n+        .trailing_separator(separator_tactic)\n         .preserve_newline(true);\n     write_list(&items, &fmt)\n }"}, {"sha": "4760022eeaf0d7de1497c1b92ac252137f85f8c9", "filename": "tests/source/issue_4791.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ee130515e3788d886cdf18442871936a99c134b6/tests%2Fsource%2Fissue_4791.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee130515e3788d886cdf18442871936a99c134b6/tests%2Fsource%2Fissue_4791.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue_4791.rs?ref=ee130515e3788d886cdf18442871936a99c134b6", "patch": "@@ -0,0 +1,14 @@\n+// rustfmt-struct_field_align_threshold: 30\n+// rustfmt-trailing_comma: Never\n+\n+struct Foo {\n+    group_a: u8,\n+\n+    group_b: u8,\n+}\n+\n+struct Bar {\n+    group_a: u8,\n+\n+    group_b: u8\n+}"}, {"sha": "fff58be99a5096d8c5ff07de952585aa3d19c6fc", "filename": "tests/target/issue_4791.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ee130515e3788d886cdf18442871936a99c134b6/tests%2Ftarget%2Fissue_4791.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee130515e3788d886cdf18442871936a99c134b6/tests%2Ftarget%2Fissue_4791.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue_4791.rs?ref=ee130515e3788d886cdf18442871936a99c134b6", "patch": "@@ -0,0 +1,14 @@\n+// rustfmt-struct_field_align_threshold: 30\n+// rustfmt-trailing_comma: Never\n+\n+struct Foo {\n+    group_a: u8,\n+\n+    group_b: u8\n+}\n+\n+struct Bar {\n+    group_a: u8,\n+\n+    group_b: u8\n+}"}]}