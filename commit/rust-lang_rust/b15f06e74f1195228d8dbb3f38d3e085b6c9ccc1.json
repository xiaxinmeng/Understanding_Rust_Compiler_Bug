{"sha": "b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "node_id": "C_kwDOAAsO6NoAKGIxNWYwNmU3NGYxMTk1MjI4ZDhkYmIzZjM4ZDNlMDg1YjZjOWNjYzE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-04T00:22:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-04T00:22:17Z"}, "message": "Auto merge of #9093 - Jarcho:deref_ice, r=giraffate\n\nFix ICE in `dereference.rs`\n\nfixes #9089\nchangelog: Fix ICE when dereferencing or borrowing on explicit returns from closures", "tree": {"sha": "7372d13766b3e1d74511461eb334f9e1d28bd4b1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7372d13766b3e1d74511461eb334f9e1d28bd4b1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "html_url": "https://github.com/rust-lang/rust/commit/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8c8987749b999b25408763544fc17030fa3fb92f", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c8987749b999b25408763544fc17030fa3fb92f", "html_url": "https://github.com/rust-lang/rust/commit/8c8987749b999b25408763544fc17030fa3fb92f"}, {"sha": "3e80d3988d70847e6b870749641ea6d434ff261b", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e80d3988d70847e6b870749641ea6d434ff261b", "html_url": "https://github.com/rust-lang/rust/commit/3e80d3988d70847e6b870749641ea6d434ff261b"}], "stats": {"total": 56, "additions": 42, "deletions": 14}, "files": [{"sha": "14e8d5940cffbcfd65c8c317bc10512de89dfbe2", "filename": "clippy_lints/src/dereference.rs", "status": "modified", "additions": 27, "deletions": 13, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/clippy_lints%2Fsrc%2Fdereference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/clippy_lints%2Fsrc%2Fdereference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdereference.rs?ref=b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "patch": "@@ -8,7 +8,7 @@ use rustc_data_structures::fx::FxIndexMap;\n use rustc_errors::Applicability;\n use rustc_hir::intravisit::{walk_ty, Visitor};\n use rustc_hir::{\n-    self as hir, BindingAnnotation, Body, BodyId, BorrowKind, Expr, ExprKind, GenericArg, HirId, ImplItem,\n+    self as hir, BindingAnnotation, Body, BodyId, BorrowKind, Expr, ExprKind, FnRetTy, GenericArg, HirId, ImplItem,\n     ImplItemKind, Item, ItemKind, Local, MatchSource, Mutability, Node, Pat, PatKind, Path, QPath, TraitItem,\n     TraitItemKind, TyKind, UnOp,\n };\n@@ -717,18 +717,32 @@ fn walk_parents<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> (Position, &\n \n             Node::Expr(parent) if parent.span.ctxt() == ctxt => match parent.kind {\n                 ExprKind::Ret(_) => {\n-                    let output = cx\n-                        .tcx\n-                        .fn_sig(cx.tcx.hir().body_owner_def_id(cx.enclosing_body.unwrap()))\n-                        .skip_binder()\n-                        .output();\n-                    Some(if !output.is_ref() {\n-                        Position::Other(precedence)\n-                    } else if output.has_placeholders() || output.has_opaque_types() {\n-                        Position::ReborrowStable(precedence)\n-                    } else {\n-                        Position::DerefStable(precedence)\n-                    })\n+                    let owner_id = cx.tcx.hir().body_owner(cx.enclosing_body.unwrap());\n+                    Some(\n+                        if let Node::Expr(Expr {\n+                            kind: ExprKind::Closure { fn_decl, .. },\n+                            ..\n+                        }) = cx.tcx.hir().get(owner_id)\n+                        {\n+                            match fn_decl.output {\n+                                FnRetTy::Return(ty) => binding_ty_auto_deref_stability(ty, precedence),\n+                                FnRetTy::DefaultReturn(_) => Position::Other(precedence),\n+                            }\n+                        } else {\n+                            let output = cx\n+                                .tcx\n+                                .fn_sig(cx.tcx.hir().local_def_id(owner_id))\n+                                .skip_binder()\n+                                .output();\n+                            if !output.is_ref() {\n+                                Position::Other(precedence)\n+                            } else if output.has_placeholders() || output.has_opaque_types() {\n+                                Position::ReborrowStable(precedence)\n+                            } else {\n+                                Position::DerefStable(precedence)\n+                            }\n+                        },\n+                    )\n                 },\n                 ExprKind::Call(func, _) if func.hir_id == child_id => (child_id == e.hir_id).then(|| Position::Callee),\n                 ExprKind::Call(func, args) => args"}, {"sha": "a650fdc1f897256ab98026823f52aaeec250c19e", "filename": "tests/ui/explicit_auto_deref.fixed", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/tests%2Fui%2Fexplicit_auto_deref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/tests%2Fui%2Fexplicit_auto_deref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.fixed?ref=b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "patch": "@@ -211,4 +211,8 @@ fn main() {\n     unsafe {\n         var(0, &**x);\n     }\n+\n+    let s = &\"str\";\n+    let _ = || return *s;\n+    let _ = || -> &'static str { return s };\n }"}, {"sha": "8f4f352576a734514f2648b826205efc4eb219e9", "filename": "tests/ui/explicit_auto_deref.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/tests%2Fui%2Fexplicit_auto_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/tests%2Fui%2Fexplicit_auto_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.rs?ref=b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "patch": "@@ -211,4 +211,8 @@ fn main() {\n     unsafe {\n         var(0, &**x);\n     }\n+\n+    let s = &\"str\";\n+    let _ = || return *s;\n+    let _ = || -> &'static str { return *s };\n }"}, {"sha": "92765307ea73d55f30a30ecdbc984ba42a645066", "filename": "tests/ui/explicit_auto_deref.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/tests%2Fui%2Fexplicit_auto_deref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1/tests%2Fui%2Fexplicit_auto_deref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.stderr?ref=b15f06e74f1195228d8dbb3f38d3e085b6c9ccc1", "patch": "@@ -192,5 +192,11 @@ error: deref which would be done by auto-deref\n LL |     f_str(&&**ref_str); // `needless_borrow` will suggest removing only one reference\n    |            ^^^^^^^^^^ help: try this: `ref_str`\n \n-error: aborting due to 32 previous errors\n+error: deref which would be done by auto-deref\n+  --> $DIR/explicit_auto_deref.rs:217:41\n+   |\n+LL |     let _ = || -> &'static str { return *s };\n+   |                                         ^^ help: try this: `s`\n+\n+error: aborting due to 33 previous errors\n "}]}