{"sha": "658ba9e29cb64f1ec483c35522b2268edb3deb21", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY1OGJhOWUyOWNiNjRmMWVjNDgzYzM1NTIyYjIyNjhlZGIzZGViMjE=", "commit": {"author": {"name": "R\u00fcdiger Herrmann", "email": "ruediger.herrmann@gmx.de", "date": "2020-12-05T13:28:15Z"}, "committer": {"name": "R\u00fcdiger Herrmann", "email": "ruediger.herrmann@gmx.de", "date": "2020-12-21T17:42:42Z"}, "message": "Delete related whitespace when removing unused param\n\nInclude adjacent whitespace in the text edits to remove the\nparameter declaration and its occurences in calling code.\n\nhttps://github.com/rust-analyzer/rust-analyzer/issues/6663", "tree": {"sha": "63332d5ef61f9ba8ffb4d60e214ab817c0d76f2f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/63332d5ef61f9ba8ffb4d60e214ab817c0d76f2f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/658ba9e29cb64f1ec483c35522b2268edb3deb21", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/658ba9e29cb64f1ec483c35522b2268edb3deb21", "html_url": "https://github.com/rust-lang/rust/commit/658ba9e29cb64f1ec483c35522b2268edb3deb21", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/658ba9e29cb64f1ec483c35522b2268edb3deb21/comments", "author": {"login": "rherrmann", "id": 607182, "node_id": "MDQ6VXNlcjYwNzE4Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/607182?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rherrmann", "html_url": "https://github.com/rherrmann", "followers_url": "https://api.github.com/users/rherrmann/followers", "following_url": "https://api.github.com/users/rherrmann/following{/other_user}", "gists_url": "https://api.github.com/users/rherrmann/gists{/gist_id}", "starred_url": "https://api.github.com/users/rherrmann/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rherrmann/subscriptions", "organizations_url": "https://api.github.com/users/rherrmann/orgs", "repos_url": "https://api.github.com/users/rherrmann/repos", "events_url": "https://api.github.com/users/rherrmann/events{/privacy}", "received_events_url": "https://api.github.com/users/rherrmann/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rherrmann", "id": 607182, "node_id": "MDQ6VXNlcjYwNzE4Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/607182?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rherrmann", "html_url": "https://github.com/rherrmann", "followers_url": "https://api.github.com/users/rherrmann/followers", "following_url": "https://api.github.com/users/rherrmann/following{/other_user}", "gists_url": "https://api.github.com/users/rherrmann/gists{/gist_id}", "starred_url": "https://api.github.com/users/rherrmann/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rherrmann/subscriptions", "organizations_url": "https://api.github.com/users/rherrmann/orgs", "repos_url": "https://api.github.com/users/rherrmann/repos", "events_url": "https://api.github.com/users/rherrmann/events{/privacy}", "received_events_url": "https://api.github.com/users/rherrmann/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8a73fe655f7bf9778deeec4c8b4b541e0af398b", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8a73fe655f7bf9778deeec4c8b4b541e0af398b", "html_url": "https://github.com/rust-lang/rust/commit/c8a73fe655f7bf9778deeec4c8b4b541e0af398b"}], "stats": {"total": 81, "additions": 74, "deletions": 7}, "files": [{"sha": "f72dd49edc6b913472ef1c6adb4ab28349f87e00", "filename": "crates/assists/src/handlers/remove_unused_param.rs", "status": "modified", "additions": 74, "deletions": 7, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/658ba9e29cb64f1ec483c35522b2268edb3deb21/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/658ba9e29cb64f1ec483c35522b2268edb3deb21/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs?ref=658ba9e29cb64f1ec483c35522b2268edb3deb21", "patch": "@@ -2,9 +2,10 @@ use ide_db::{defs::Definition, search::Reference};\n use syntax::{\n     algo::find_node_at_range,\n     ast::{self, ArgListOwner},\n-    AstNode, SyntaxNode, TextRange, T,\n+    AstNode, SyntaxKind, SyntaxNode, TextRange, T,\n };\n use test_utils::mark;\n+use SyntaxKind::WHITESPACE;\n \n use crate::{\n     assist_context::AssistBuilder, utils::next_prev, AssistContext, AssistId, AssistKind, Assists,\n@@ -56,7 +57,7 @@ pub(crate) fn remove_unused_param(acc: &mut Assists, ctx: &AssistContext) -> Opt\n         \"Remove unused parameter\",\n         param.syntax().text_range(),\n         |builder| {\n-            builder.delete(range_with_coma(param.syntax()));\n+            builder.delete(range_to_remove(param.syntax()));\n             for usage in fn_def.usages(&ctx.sema).all() {\n                 process_usage(ctx, builder, usage, param_position);\n             }\n@@ -80,19 +81,34 @@ fn process_usage(\n     let arg = call_expr.arg_list()?.args().nth(arg_to_remove)?;\n \n     builder.edit_file(usage.file_range.file_id);\n-    builder.delete(range_with_coma(arg.syntax()));\n+    builder.delete(range_to_remove(arg.syntax()));\n \n     Some(())\n }\n \n-fn range_with_coma(node: &SyntaxNode) -> TextRange {\n-    let up_to = next_prev().find_map(|dir| {\n+fn range_to_remove(node: &SyntaxNode) -> TextRange {\n+    let up_to_comma = next_prev().find_map(|dir| {\n         node.siblings_with_tokens(dir)\n             .filter_map(|it| it.into_token())\n             .find(|it| it.kind() == T![,])\n+            .map(|it| (dir, it))\n     });\n-    let up_to = up_to.map_or(node.text_range(), |it| it.text_range());\n-    node.text_range().cover(up_to)\n+    if let Some((dir, token)) = up_to_comma {\n+        if node.next_sibling().is_some() {\n+            let up_to_space = token\n+                .siblings_with_tokens(dir)\n+                .skip(1)\n+                .take_while(|it| it.kind() == WHITESPACE)\n+                .last()\n+                .and_then(|it| it.into_token());\n+            return node\n+                .text_range()\n+                .cover(up_to_space.map_or(token.text_range(), |it| it.text_range()));\n+        }\n+        node.text_range().cover(token.text_range())\n+    } else {\n+        node.text_range()\n+    }\n }\n \n #[cfg(test)]\n@@ -118,6 +134,57 @@ fn b() { foo(9, ) }\n         );\n     }\n \n+    #[test]\n+    fn remove_unused_first_param() {\n+        check_assist(\n+            remove_unused_param,\n+            r#\"\n+fn foo(<|>x: i32, y: i32) { y; }\n+fn a() { foo(1, 2) }\n+fn b() { foo(1, 2,) }\n+\"#,\n+            r#\"\n+fn foo(y: i32) { y; }\n+fn a() { foo(2) }\n+fn b() { foo(2,) }\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn remove_unused_single_param() {\n+        check_assist(\n+            remove_unused_param,\n+            r#\"\n+fn foo(<|>x: i32) { 0; }\n+fn a() { foo(1) }\n+fn b() { foo(1, ) }\n+\"#,\n+            r#\"\n+fn foo() { 0; }\n+fn a() { foo() }\n+fn b() { foo( ) }\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn remove_unused_surrounded_by_parms() {\n+        check_assist(\n+            remove_unused_param,\n+            r#\"\n+fn foo(x: i32, <|>y: i32, z: i32) { x; }\n+fn a() { foo(1, 2, 3) }\n+fn b() { foo(1, 2, 3,) }\n+\"#,\n+            r#\"\n+fn foo(x: i32, z: i32) { x; }\n+fn a() { foo(1, 3) }\n+fn b() { foo(1, 3,) }\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn remove_unused_qualified_call() {\n         check_assist("}]}