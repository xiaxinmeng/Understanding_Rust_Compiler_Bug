{"sha": "f13d16621eafc54e806367ea24e191cce8af66d4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYxM2QxNjYyMWVhZmM1NGU4MDYzNjdlYTI0ZTE5MWNjZThhZjY2ZDQ=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2018-11-18T22:24:49Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-11-19T14:06:22Z"}, "message": "Rollup merge of #55962 - QuietMisdreavus:tricky-spans, r=GuillaumeGomez\n\nrustdoc: properly calculate spans for intra-doc link resolution errors\n\nFixes https://github.com/rust-lang/rust/issues/55723\n\nWhen rustdoc is reporting a resolution error for intra-doc links, it needs to convert a span from one relative to the *markdown* (as the links are only found on the final markdown text) to one relative to the *source code* (as the error reporting is meant to show where the line is in the source, so the user can fix it). However, a calculation for how much \"offset\" to apply had a subtle error: it trimmed the whole line when attempting to account for leading indentation. This caused it to add in *trailing* whitespace into this calculation, which created an incorrect span.\n\nIn a lot of situations, this isn't a problem - the span will be shifted in the code slightly, but the warning will still be displayed and mostly legible. However, there is one important situation where this can cause an ICE: multi-byte codepoints. If a shifted span now has a starting point in the middle of a multi-byte codepoint, libsyntax will panic when trying to track what source item it corresponds to. This flew under our radar because trailing whitespace and multi-byte codepoints are both situations that we don't run into in the compiler repo.\n\n(There is one more situation where this can error, that will be much harder to fix: block-style doc comments. Lines in a block-style doc comment have a zero-or-more (usually one) character offset per line, causing this calculation to be way off. I'm punting that to another issue, though...)", "tree": {"sha": "93927b69b036832be7271d667ff896f079cfab4d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/93927b69b036832be7271d667ff896f079cfab4d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f13d16621eafc54e806367ea24e191cce8af66d4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlvyw14ACgkQ/vbIBR0O\nATxgiQ//UlzNZKmYlRDKjxUdmonwpnau9sScjzEZoQkaSvrdtiZppOn2s/hcVk1V\nOPk6/cjpgyIYcYzr2eemu0Gpaz8DPVNHsg/DB7tmQ/1ej+Ga8nn6S30Dwbl9sluu\nQ9iCU0Aeu+hu65YxX58ltEmCHS/+oKdzu5un2/Fk2w/KAt+5x7KO+IYVW2djoXxC\ni+D7EXomUGv2PZEwW5pXC3NQZ4gHgsfUfodW086ldoE5uHpyvpxtOrrT3eKmv9C9\n3l54tRcifYzZ48m+oFikjDgIrDlP3EO6T47PQBtflywZurktubpLlOGDEuYK4Sbb\nstbPD+4mN5zI/YdySXzKoO8AT/sSY1dB/Gjzkx5TKNdr+BQ4/mQVdkFPXBHOpSFq\n/RuXAMc+bNZWw0n2xCTzccEt5PkjYGHRQcarhn/hswTMvD9E13tzoPukJ4PjMn6T\nlGGME7+gSGeCudPicUVfWHvs90i/OLbTf8PDKTgzYsGKDlvCLlwz0+wAwDh7e44Y\nAgswAin219SPpMAnNgQdYv2gqvvczIMN+i69IvquMCk0+h0wv2UJLCvcPum0ss6X\nzIKLv0zEWg9Od2Nn3dlItES8opA1wzxQfLHLNo55eHg8gR4Vr/KUuxHFTNty90Cx\nIE3f/EcgJJ2Lt41rL8L40knfFpcdory65MHKONeWiu8llbgcgNI=\n=+ODV\n-----END PGP SIGNATURE-----", "payload": "tree 93927b69b036832be7271d667ff896f079cfab4d\nparent 989d06a76dd5f43ce6237440366a83eb1e436763\nparent aa3d7a4e6e62aad4f96d7f0b547853641d980eca\nauthor Pietro Albini <pietro@pietroalbini.org> 1542579889 +0100\ncommitter kennytm <kennytm@gmail.com> 1542636382 +0800\n\nRollup merge of #55962 - QuietMisdreavus:tricky-spans, r=GuillaumeGomez\n\nrustdoc: properly calculate spans for intra-doc link resolution errors\n\nFixes https://github.com/rust-lang/rust/issues/55723\n\nWhen rustdoc is reporting a resolution error for intra-doc links, it needs to convert a span from one relative to the *markdown* (as the links are only found on the final markdown text) to one relative to the *source code* (as the error reporting is meant to show where the line is in the source, so the user can fix it). However, a calculation for how much \"offset\" to apply had a subtle error: it trimmed the whole line when attempting to account for leading indentation. This caused it to add in *trailing* whitespace into this calculation, which created an incorrect span.\n\nIn a lot of situations, this isn't a problem - the span will be shifted in the code slightly, but the warning will still be displayed and mostly legible. However, there is one important situation where this can cause an ICE: multi-byte codepoints. If a shifted span now has a starting point in the middle of a multi-byte codepoint, libsyntax will panic when trying to track what source item it corresponds to. This flew under our radar because trailing whitespace and multi-byte codepoints are both situations that we don't run into in the compiler repo.\n\n(There is one more situation where this can error, that will be much harder to fix: block-style doc comments. Lines in a block-style doc comment have a zero-or-more (usually one) character offset per line, causing this calculation to be way off. I'm punting that to another issue, though...)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f13d16621eafc54e806367ea24e191cce8af66d4", "html_url": "https://github.com/rust-lang/rust/commit/f13d16621eafc54e806367ea24e191cce8af66d4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f13d16621eafc54e806367ea24e191cce8af66d4/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "989d06a76dd5f43ce6237440366a83eb1e436763", "url": "https://api.github.com/repos/rust-lang/rust/commits/989d06a76dd5f43ce6237440366a83eb1e436763", "html_url": "https://github.com/rust-lang/rust/commit/989d06a76dd5f43ce6237440366a83eb1e436763"}, {"sha": "aa3d7a4e6e62aad4f96d7f0b547853641d980eca", "url": "https://api.github.com/repos/rust-lang/rust/commits/aa3d7a4e6e62aad4f96d7f0b547853641d980eca", "html_url": "https://github.com/rust-lang/rust/commit/aa3d7a4e6e62aad4f96d7f0b547853641d980eca"}], "stats": {"total": 39, "additions": 38, "deletions": 1}, "files": [{"sha": "f3ded2a5376a601d73c28a9acbb223a818e300ba", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f13d16621eafc54e806367ea24e191cce8af66d4/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f13d16621eafc54e806367ea24e191cce8af66d4/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=f13d16621eafc54e806367ea24e191cce8af66d4", "patch": "@@ -527,7 +527,7 @@ fn resolution_failure(\n                 doc_comment_padding +\n                     // Each subsequent leading whitespace and `///`\n                     code_dox.lines().skip(1).take(line_offset - 1).fold(0, |sum, line| {\n-                        sum + doc_comment_padding + line.len() - line.trim().len()\n+                        sum + doc_comment_padding + line.len() - line.trim_start().len()\n                     })\n             };\n "}, {"sha": "12e59a4813f8539d01bfa71ca62c59c09c4e91a1", "filename": "src/test/rustdoc-ui/intra-link-span-ice-55723.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f13d16621eafc54e806367ea24e191cce8af66d4/src%2Ftest%2Frustdoc-ui%2Fintra-link-span-ice-55723.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f13d16621eafc54e806367ea24e191cce8af66d4/src%2Ftest%2Frustdoc-ui%2Fintra-link-span-ice-55723.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-link-span-ice-55723.rs?ref=f13d16621eafc54e806367ea24e191cce8af66d4", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-tidy-end-whitespace\n+\n+#![deny(intra_doc_link_resolution_failure)]\n+\n+// An error in calculating spans while reporting intra-doc link resolution errors caused rustdoc to\n+// attempt to slice in the middle of a multibyte character. See\n+// https://github.com/rust-lang/rust/issues/55723\n+\n+/// ## For example:\n+///  \n+/// \uff08arr[i]\uff09\n+pub fn test_ice() {\n+    unimplemented!();\n+}"}, {"sha": "7ae6af4a75e8c6699fa387125f909e039a2d3488", "filename": "src/test/rustdoc-ui/intra-link-span-ice-55723.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f13d16621eafc54e806367ea24e191cce8af66d4/src%2Ftest%2Frustdoc-ui%2Fintra-link-span-ice-55723.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f13d16621eafc54e806367ea24e191cce8af66d4/src%2Ftest%2Frustdoc-ui%2Fintra-link-span-ice-55723.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-link-span-ice-55723.stderr?ref=f13d16621eafc54e806367ea24e191cce8af66d4", "patch": "@@ -0,0 +1,13 @@\n+error: `[i]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-link-span-ice-55723.rs:21:10\n+   |\n+LL | /// \uff08arr[i]\uff09\n+   |           ^ cannot be resolved, ignoring\n+   |\n+note: lint level defined here\n+  --> $DIR/intra-link-span-ice-55723.rs:13:9\n+   |\n+LL | #![deny(intra_doc_link_resolution_failure)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   = help: to escape `[` and `]` characters, just add '/' before them like `/[` or `/]`\n+"}]}