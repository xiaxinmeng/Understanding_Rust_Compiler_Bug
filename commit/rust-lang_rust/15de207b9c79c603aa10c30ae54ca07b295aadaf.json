{"sha": "15de207b9c79c603aa10c30ae54ca07b295aadaf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1ZGUyMDdiOWM3OWM2MDNhYTEwYzMwYWU1NGNhMDdiMjk1YWFkYWY=", "commit": {"author": {"name": "Cyryl P\u0142otnicki-Chudyk", "email": "cyplo@cyplo.net", "date": "2016-05-08T07:54:50Z"}, "committer": {"name": "Cyryl P\u0142otnicki-Chudyk", "email": "cyplo@cyplo.net", "date": "2016-05-08T07:54:50Z"}, "message": "Better error handling for bootstrap file downloads.\n\nRemove the temp files if something goes wrong.", "tree": {"sha": "1a82b985d5ff130ebb7294aa6c9fe13782459957", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a82b985d5ff130ebb7294aa6c9fe13782459957"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/15de207b9c79c603aa10c30ae54ca07b295aadaf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/15de207b9c79c603aa10c30ae54ca07b295aadaf", "html_url": "https://github.com/rust-lang/rust/commit/15de207b9c79c603aa10c30ae54ca07b295aadaf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/15de207b9c79c603aa10c30ae54ca07b295aadaf/comments", "author": {"login": "cyplo", "id": 217899, "node_id": "MDQ6VXNlcjIxNzg5OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/217899?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cyplo", "html_url": "https://github.com/cyplo", "followers_url": "https://api.github.com/users/cyplo/followers", "following_url": "https://api.github.com/users/cyplo/following{/other_user}", "gists_url": "https://api.github.com/users/cyplo/gists{/gist_id}", "starred_url": "https://api.github.com/users/cyplo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cyplo/subscriptions", "organizations_url": "https://api.github.com/users/cyplo/orgs", "repos_url": "https://api.github.com/users/cyplo/repos", "events_url": "https://api.github.com/users/cyplo/events{/privacy}", "received_events_url": "https://api.github.com/users/cyplo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cyplo", "id": 217899, "node_id": "MDQ6VXNlcjIxNzg5OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/217899?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cyplo", "html_url": "https://github.com/cyplo", "followers_url": "https://api.github.com/users/cyplo/followers", "following_url": "https://api.github.com/users/cyplo/following{/other_user}", "gists_url": "https://api.github.com/users/cyplo/gists{/gist_id}", "starred_url": "https://api.github.com/users/cyplo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cyplo/subscriptions", "organizations_url": "https://api.github.com/users/cyplo/orgs", "repos_url": "https://api.github.com/users/cyplo/repos", "events_url": "https://api.github.com/users/cyplo/events{/privacy}", "received_events_url": "https://api.github.com/users/cyplo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18dafe83b5411e76a13f5e813dae1bec71ef07a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/18dafe83b5411e76a13f5e813dae1bec71ef07a6", "html_url": "https://github.com/rust-lang/rust/commit/18dafe83b5411e76a13f5e813dae1bec71ef07a6"}], "stats": {"total": 34, "additions": 20, "deletions": 14}, "files": [{"sha": "c9167d7638a3a78eeed2cb610a8eadc873bd4785", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 20, "deletions": 14, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/15de207b9c79c603aa10c30ae54ca07b295aadaf/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/15de207b9c79c603aa10c30ae54ca07b295aadaf/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=15de207b9c79c603aa10c30ae54ca07b295aadaf", "patch": "@@ -21,17 +21,23 @@\n \n def get(url, path, verbose=False):\n     sha_url = url + \".sha256\"\n-    temp_file = tempfile.NamedTemporaryFile(delete=False)\n-    temp_path = temp_file.name\n-    sha_file = tempfile.NamedTemporaryFile(suffix=\".sha256\", delete=True)\n-    sha_path = sha_file.name\n-    download(sha_path, sha_url, verbose)\n-    download(temp_path, url, verbose)\n-    verify(sha_path, temp_path, verbose)\n-    sha_file.close()\n-    print(\"moving \" + temp_path + \" to \" + path)\n-    shutil.move(temp_path, path)\n-    temp_file.close()\n+    with tempfile.NamedTemporaryFile(delete=False) as temp_file:\n+        temp_path = temp_file.name\n+    with tempfile.NamedTemporaryFile(suffix=\".sha256\", delete=False) as sha_file:\n+        sha_path = sha_file.name\n+\n+    try:\n+        download(sha_path, sha_url, verbose)\n+        download(temp_path, url, verbose)\n+        verify(temp_path, sha_path, verbose)\n+        print(\"moving \" + temp_path + \" to \" + path)\n+        shutil.move(temp_path, path)\n+    finally:\n+        print(\"removing \" + sha_path)\n+        os.unlink(sha_path)\n+        if os.path.isfile(temp_path):\n+            print(\"removing \" + temp_path)\n+            os.unlink(temp_path)\n \n \n def download(path, url, verbose):\n@@ -46,9 +52,9 @@ def download(path, url, verbose):\n         run([\"curl\", \"-o\", path, url], verbose=verbose)\n \n \n-def verify(sha_path, temp_path, verbose):\n-    print(\"verifying \" + temp_path)\n-    with open(temp_path, \"rb\") as f:\n+def verify(path, sha_path, verbose):\n+    print(\"verifying \" + path)\n+    with open(path, \"rb\") as f:\n         found = hashlib.sha256(f.read()).hexdigest()\n     with open(sha_path, \"r\") as f:\n         expected, _ = f.readline().split()"}]}