{"sha": "0dc2557c1202a89f10eec424bb2625bd1615319d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkYzI1NTdjMTIwMmE4OWYxMGVlYzQyNGJiMjYyNWJkMTYxNTMxOWQ=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-01-20T05:44:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-20T05:44:42Z"}, "message": "Rollup merge of #68326 - ollie27:rustdoc_hightlight_fatal_errors, r=GuillaumeGomez\n\nrustdoc: Catch fatal errors when syntax highlighting\n\nFor some errors the lexer will unwind so we need to handle that in addition to handling `token::Unknown`.\n\nFixes #56885\n\nr? @GuillaumeGomez", "tree": {"sha": "d0a0e869d252f5c7d6379da8e42f8c043c17db80", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0a0e869d252f5c7d6379da8e42f8c043c17db80"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0dc2557c1202a89f10eec424bb2625bd1615319d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeJT5KCRBK7hj4Ov3rIwAAdHIIAIaM+nwT3FXlhz4dADCDDV7y\nY9CwS7pZ0TomMDEcVZOW2MdvEN6HjHV48+co7nX/L+nlg4g1SB1SZyngNKtVzPFW\nY0oOs1Do32r9b1P91FvcVrzzZz31SpY0TIV1cD3+F2GovOnWLiYUuoICuw4l8Njy\n3lB49VToGqa0sOwJjwa7H3Vp8g+tjZa7hMUUfo09M3SwWhtjUIFr+GjAUBpJEc/L\nv0vMKB3eersBtp0xfpcCAWxV4YzrvrdyyTPm8Znu5IEfLzdq/MRTd4zUTrfSKm1v\nieQXnlur8/IN4F8QpoTrtwYC1ogGDTsxosHsuWTZAPEgMDFBn0UTTW1OAFQVKhY=\n=pJom\n-----END PGP SIGNATURE-----\n", "payload": "tree d0a0e869d252f5c7d6379da8e42f8c043c17db80\nparent 29b854fb741809c29764e33fc17c32ba9c6523ba\nparent 79061d0e02f70ecbf3333057eac36dcc6c4b1727\nauthor Dylan DPC <dylan.dpc@gmail.com> 1579499082 +0530\ncommitter GitHub <noreply@github.com> 1579499082 +0530\n\nRollup merge of #68326 - ollie27:rustdoc_hightlight_fatal_errors, r=GuillaumeGomez\n\nrustdoc: Catch fatal errors when syntax highlighting\n\nFor some errors the lexer will unwind so we need to handle that in addition to handling `token::Unknown`.\n\nFixes #56885\n\nr? @GuillaumeGomez\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0dc2557c1202a89f10eec424bb2625bd1615319d", "html_url": "https://github.com/rust-lang/rust/commit/0dc2557c1202a89f10eec424bb2625bd1615319d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0dc2557c1202a89f10eec424bb2625bd1615319d/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "29b854fb741809c29764e33fc17c32ba9c6523ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/29b854fb741809c29764e33fc17c32ba9c6523ba", "html_url": "https://github.com/rust-lang/rust/commit/29b854fb741809c29764e33fc17c32ba9c6523ba"}, {"sha": "79061d0e02f70ecbf3333057eac36dcc6c4b1727", "url": "https://api.github.com/repos/rust-lang/rust/commits/79061d0e02f70ecbf3333057eac36dcc6c4b1727", "html_url": "https://github.com/rust-lang/rust/commit/79061d0e02f70ecbf3333057eac36dcc6c4b1727"}], "stats": {"total": 38, "additions": 34, "deletions": 4}, "files": [{"sha": "5bea1b56141591d90ee7e386d5f579ea0a40249e", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=0dc2557c1202a89f10eec424bb2625bd1615319d", "patch": "@@ -41,7 +41,7 @@ pub fn render_with_highlighting(\n     let fm = sess\n         .source_map()\n         .new_source_file(FileName::Custom(String::from(\"rustdoc-highlighting\")), src.to_owned());\n-    let highlight_result = {\n+    let highlight_result = rustc_driver::catch_fatal_errors(|| {\n         let lexer = lexer::StringReader::new(&sess, fm, None);\n         let mut classifier = Classifier::new(lexer, sess.source_map());\n \n@@ -51,7 +51,8 @@ pub fn render_with_highlighting(\n         } else {\n             Ok(String::from_utf8_lossy(&highlighted_source).into_owned())\n         }\n-    };\n+    })\n+    .unwrap_or(Err(()));\n \n     match highlight_result {\n         Ok(highlighted_source) => {"}, {"sha": "2903fd9dcd6602734033bcddf2ecf4b3cb860a62", "filename": "src/librustdoc/passes/check_code_block_syntax.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs?ref=0dc2557c1202a89f10eec424bb2625bd1615319d", "patch": "@@ -40,7 +40,7 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n             dox[code_block.code].to_owned(),\n         );\n \n-        let validation_status = {\n+        let validation_status = rustc_driver::catch_fatal_errors(|| {\n             let mut has_syntax_errors = false;\n             let mut only_whitespace = true;\n             // even if there is a syntax error, we need to run the lexer over the whole file\n@@ -61,7 +61,8 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n             } else {\n                 None\n             }\n-        };\n+        })\n+        .unwrap_or(Some(CodeBlockInvalid::SyntaxError));\n \n         if let Some(code_block_invalid) = validation_status {\n             let mut diag = if let Some(sp) ="}, {"sha": "72037dd74be355d9d0ada09fbff99b0774fd15d3", "filename": "src/test/rustdoc-ui/invalid-syntax.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.rs?ref=0dc2557c1202a89f10eec424bb2625bd1615319d", "patch": "@@ -93,3 +93,9 @@ pub fn empty_rust_with_whitespace() {}\n ///\n pub fn indent_after_fenced() {}\n //~^^^ WARNING could not parse code block as Rust code\n+\n+/// ```\n+/// \"invalid\n+/// ```\n+pub fn invalid() {}\n+//~^^^^ WARNING could not parse code block as Rust code"}, {"sha": "a90d3bbb979f66ad7edf09e2f2b24bb91af954c6", "filename": "src/test/rustdoc-ui/invalid-syntax.stderr", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.stderr?ref=0dc2557c1202a89f10eec424bb2625bd1615319d", "patch": "@@ -132,3 +132,18 @@ LL | ///     \\____/\n    |\n    = note: error from rustc: unknown start of token: \\\n \n+warning: could not parse code block as Rust code\n+  --> $DIR/invalid-syntax.rs:97:5\n+   |\n+LL |   /// ```\n+   |  _____^\n+LL | | /// \"invalid\n+LL | | /// ```\n+   | |_______^\n+   |\n+   = note: error from rustc: unterminated double quote string\n+help: mark blocks that do not contain Rust code as text\n+   |\n+LL | /// ```text\n+   |     ^^^^^^^\n+"}, {"sha": "afef86ec9c77f265f481bb0d6d73accece4a4664", "filename": "src/test/rustdoc/bad-codeblock-syntax.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Ftest%2Frustdoc%2Fbad-codeblock-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dc2557c1202a89f10eec424bb2625bd1615319d/src%2Ftest%2Frustdoc%2Fbad-codeblock-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fbad-codeblock-syntax.rs?ref=0dc2557c1202a89f10eec424bb2625bd1615319d", "patch": "@@ -33,3 +33,10 @@ pub fn ok() {}\n /// <script>alert(\"not valid Rust\");</script>\n /// ```\n pub fn escape() {}\n+\n+// @has bad_codeblock_syntax/fn.unterminated.html\n+// @has - '//*[@class=\"docblock\"]/pre/code' '\"unterminated'\n+/// ```\n+/// \"unterminated\n+/// ```\n+pub fn unterminated() {}"}]}