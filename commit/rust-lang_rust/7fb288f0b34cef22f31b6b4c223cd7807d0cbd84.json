{"sha": "7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdmYjI4OGYwYjM0Y2VmMjJmMzFiNmI0YzIyM2NkNzgwN2QwY2JkODQ=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-05-01T22:45:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-05-01T22:45:23Z"}, "message": "Merge pull request #1487 from topecongiro/issue1470\n\nUse block indent when visual indent exceeds max_width", "tree": {"sha": "4eaa04ae07b8b086b1c30d04204b20d22afa2ee4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4eaa04ae07b8b086b1c30d04204b20d22afa2ee4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "html_url": "https://github.com/rust-lang/rust/commit/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c546f1b396f7bfad89f30d9f595baa589a99a4fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/c546f1b396f7bfad89f30d9f595baa589a99a4fe", "html_url": "https://github.com/rust-lang/rust/commit/c546f1b396f7bfad89f30d9f595baa589a99a4fe"}, {"sha": "c7e9bcadaab1665b5e46797984c6a8ab3885718a", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7e9bcadaab1665b5e46797984c6a8ab3885718a", "html_url": "https://github.com/rust-lang/rust/commit/c7e9bcadaab1665b5e46797984c6a8ab3885718a"}], "stats": {"total": 66, "additions": 63, "deletions": 3}, "files": [{"sha": "d64a9a75ad34ca7af9d7e2b8bc814a4982f0be49", "filename": "src/expr.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "patch": "@@ -2103,13 +2103,15 @@ pub fn rewrite_assign_rhs<S: Into<String>>(context: &RewriteContext,\n             let new_offset = shape.indent.block_indent(context.config);\n             let max_width = try_opt!((shape.width + shape.indent.width())\n                                          .checked_sub(new_offset.width()));\n-            let new_rhs = ex.rewrite(context, Shape::legacy(max_width, new_offset));\n+            let new_shape = Shape::legacy(max_width, new_offset);\n+            let new_rhs = ex.rewrite(context, new_shape);\n \n             // FIXME: DRY!\n             match (rhs, new_rhs) {\n                 (Some(ref orig_rhs), Some(ref replacement_rhs))\n-                    if count_line_breaks(orig_rhs) >\n-                       count_line_breaks(replacement_rhs) + 1 => {\n+                    if count_line_breaks(orig_rhs) > count_line_breaks(replacement_rhs) + 1 ||\n+                       (orig_rhs.rewrite(context, shape).is_none() &&\n+                        replacement_rhs.rewrite(context, new_shape).is_some()) => {\n                     result.push_str(&format!(\"\\n{}\", new_offset.to_string(context.config)));\n                     result.push_str(replacement_rhs);\n                 }"}, {"sha": "34d5bf399544dc85df45491b65f07802f6d22ba4", "filename": "tests/source/large_vec.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/tests%2Fsource%2Flarge_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/tests%2Fsource%2Flarge_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Flarge_vec.rs?ref=7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "patch": "@@ -0,0 +1,29 @@\n+// See #1470.\n+\n+impl Environment {\n+    pub fn new_root() -> Rc<RefCell<Environment>> {\n+        let mut env = Environment::new();\n+        let builtin_functions = &[(\"println\",\n+                                   Function::NativeVoid(CallSign {\n+                                                            num_params: 0,\n+                                                            variadic: true,\n+                                                            param_types: vec![],\n+                                                        },\n+                                                        native_println)),\n+                                  (\"run_http_server\",\n+                                   Function::NativeVoid(CallSign {\n+                                                            num_params: 1,\n+                                                            variadic: false,\n+                                                            param_types:\n+                                                                vec![Some(ConstraintType::Function)],\n+                                                        },\n+                                                        native_run_http_server)),\n+                                  (\"len\",\n+                                   Function::NativeReturning(CallSign {\n+                                                                 num_params: 1,\n+                                                                 variadic: false,\n+                                                                 param_types: vec![None],\n+                                                             },\n+                                                             native_len))];\n+    }\n+}"}, {"sha": "44f6d52650c1bfcbb227bf6bb11583ae1a35b8b6", "filename": "tests/target/large_vec.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/tests%2Ftarget%2Flarge_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7fb288f0b34cef22f31b6b4c223cd7807d0cbd84/tests%2Ftarget%2Flarge_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Flarge_vec.rs?ref=7fb288f0b34cef22f31b6b4c223cd7807d0cbd84", "patch": "@@ -0,0 +1,29 @@\n+// See #1470.\n+\n+impl Environment {\n+    pub fn new_root() -> Rc<RefCell<Environment>> {\n+        let mut env = Environment::new();\n+        let builtin_functions =\n+            &[(\"println\",\n+               Function::NativeVoid(CallSign {\n+                                        num_params: 0,\n+                                        variadic: true,\n+                                        param_types: vec![],\n+                                    },\n+                                    native_println)),\n+              (\"run_http_server\",\n+               Function::NativeVoid(CallSign {\n+                                        num_params: 1,\n+                                        variadic: false,\n+                                        param_types: vec![Some(ConstraintType::Function)],\n+                                    },\n+                                    native_run_http_server)),\n+              (\"len\",\n+               Function::NativeReturning(CallSign {\n+                                             num_params: 1,\n+                                             variadic: false,\n+                                             param_types: vec![None],\n+                                         },\n+                                         native_len))];\n+    }\n+}"}]}