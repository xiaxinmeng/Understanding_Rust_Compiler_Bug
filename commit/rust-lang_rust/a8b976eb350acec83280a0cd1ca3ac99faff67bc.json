{"sha": "a8b976eb350acec83280a0cd1ca3ac99faff67bc", "node_id": "C_kwDOAAsO6NoAKGE4Yjk3NmViMzUwYWNlYzgzMjgwYTBjZDFjYTNhYzk5ZmFmZjY3YmM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-10T19:50:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-10T19:50:47Z"}, "message": "Auto merge of #1904 - camelid:uninit-num, r=RalfJung\n\nAdd flag to check for uninitialized numbers\n\nCloses #1340.\n\nCompanion rustc PR that implements this in the Miri engine: rust-lang/rust#88670\n\nr? `@RalfJung`", "tree": {"sha": "7278052f7ae2cec3658aee07edf6a7de1ac7f31e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7278052f7ae2cec3658aee07edf6a7de1ac7f31e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a8b976eb350acec83280a0cd1ca3ac99faff67bc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a8b976eb350acec83280a0cd1ca3ac99faff67bc", "html_url": "https://github.com/rust-lang/rust/commit/a8b976eb350acec83280a0cd1ca3ac99faff67bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a8b976eb350acec83280a0cd1ca3ac99faff67bc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3f2c9ee17e64c89b1dd89c5970f106f3f74416cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f2c9ee17e64c89b1dd89c5970f106f3f74416cc", "html_url": "https://github.com/rust-lang/rust/commit/3f2c9ee17e64c89b1dd89c5970f106f3f74416cc"}, {"sha": "6dd10820dd207d392f58b36ff919b8b17cfa1261", "url": "https://api.github.com/repos/rust-lang/rust/commits/6dd10820dd207d392f58b36ff919b8b17cfa1261", "html_url": "https://github.com/rust-lang/rust/commit/6dd10820dd207d392f58b36ff919b8b17cfa1261"}], "stats": {"total": 86, "additions": 79, "deletions": 7}, "files": [{"sha": "504759eabd247a077e0ab2299efe056666ac6420", "filename": "README.md", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -199,6 +199,10 @@ up the sysroot.  If you are using `miri` (the Miri driver) directly, see the\n Miri adds its own set of `-Z` flags, which are usually set via the `MIRIFLAGS`\n environment variable:\n \n+* `-Zmiri-check-number-validity` enables checking of integer and float validity\n+  (e.g., they must be initialized and not carry pointer provenance) as part of\n+  enforcing validity invariants. This has no effect when\n+  `-Zmiri-disable-validation` is present.\n * `-Zmiri-compare-exchange-weak-failure-rate=<rate>` changes the failure rate of\n   `compare_exchange_weak` operations. The default is `0.8` (so 4 out of 5 weak ops will fail).\n   You can change it to any value between `0.0` and `1.0`, where `1.0` means it"}, {"sha": "d43b9e8197bbac0344d4b945adb665348d3d5eec", "filename": "rust-version", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/rust-version", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/rust-version", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rust-version?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -1 +1 @@\n-db062de72b0a064f45b6f86894cbdc7c0ec68844\n+68ca579406f2fa9ec62710e4a4d5d3e07a168d3c"}, {"sha": "cf32e6332269068aa92fdb6a374316a57b88445c", "filename": "src/bin/miri.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -313,6 +313,9 @@ fn main() {\n                 \"-Zmiri-symbolic-alignment-check\" => {\n                     miri_config.check_alignment = miri::AlignmentCheck::Symbolic;\n                 }\n+                \"-Zmiri-check-number-validity\" => {\n+                    miri_config.check_number_validity = true;\n+                }\n                 \"-Zmiri-disable-abi-check\" => {\n                     miri_config.check_abi = false;\n                 }"}, {"sha": "ac32af30c1de3507115e507813062f12d959c506", "filename": "src/eval.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Feval.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -66,6 +66,8 @@ pub struct MiriConfig {\n     pub stacked_borrows: bool,\n     /// Controls alignment checking.\n     pub check_alignment: AlignmentCheck,\n+    /// Controls integer and float validity (e.g., initialization) checking.\n+    pub check_number_validity: bool,\n     /// Controls function [ABI](Abi) checking.\n     pub check_abi: bool,\n     /// Action for an op requiring communication with the host.\n@@ -104,6 +106,7 @@ impl Default for MiriConfig {\n             validate: true,\n             stacked_borrows: true,\n             check_alignment: AlignmentCheck::Int,\n+            check_number_validity: false,\n             check_abi: true,\n             isolated_op: IsolatedOp::Reject(RejectOpWith::Abort),\n             ignore_leaks: false,"}, {"sha": "0ead28b36c75cf0d4cdbb4bc0b2a4917d583ce6d", "filename": "src/machine.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmachine.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -304,6 +304,9 @@ pub struct Evaluator<'mir, 'tcx> {\n     /// Whether to enforce the validity invariant.\n     pub(crate) validate: bool,\n \n+    /// Whether to enforce validity (e.g., initialization) of integers and floats.\n+    pub(crate) enforce_number_validity: bool,\n+\n     /// Whether to enforce [ABI](Abi) of function calls.\n     pub(crate) enforce_abi: bool,\n \n@@ -356,6 +359,7 @@ impl<'mir, 'tcx> Evaluator<'mir, 'tcx> {\n             tls: TlsData::default(),\n             isolated_op: config.isolated_op,\n             validate: config.validate,\n+            enforce_number_validity: config.check_number_validity,\n             enforce_abi: config.check_abi,\n             file_handler: Default::default(),\n             dir_handler: Default::default(),\n@@ -426,6 +430,11 @@ impl<'mir, 'tcx> Machine<'mir, 'tcx> for Evaluator<'mir, 'tcx> {\n         ecx.machine.validate\n     }\n \n+    #[inline(always)]\n+    fn enforce_number_validity(ecx: &InterpCx<'mir, 'tcx, Self>) -> bool {\n+        ecx.machine.enforce_number_validity\n+    }\n+\n     #[inline(always)]\n     fn enforce_abi(ecx: &InterpCx<'mir, 'tcx, Self>) -> bool {\n         ecx.machine.enforce_abi"}, {"sha": "606f58a207e568b8f921c74376e80f531dcb1237", "filename": "src/shims/posix/sync.rs", "status": "modified", "additions": 23, "deletions": 6, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Fshims%2Fposix%2Fsync.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/src%2Fshims%2Fposix%2Fsync.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fposix%2Fsync.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -1,5 +1,8 @@\n use std::time::SystemTime;\n \n+use rustc_hir::LangItem;\n+use rustc_middle::ty::{layout::TyAndLayout, query::TyCtxtAt, subst::Subst, Ty};\n+\n use crate::*;\n use thread::Time;\n \n@@ -44,7 +47,7 @@ fn mutexattr_set_kind<'mir, 'tcx: 'mir>(\n     attr_op: &OpTy<'tcx, Tag>,\n     kind: impl Into<ScalarMaybeUninit<Tag>>,\n ) -> InterpResult<'tcx, ()> {\n-    ecx.write_scalar_at_offset(attr_op, 0, kind, ecx.machine.layouts.i32)\n+    ecx.write_scalar_at_offset(attr_op, 0, kind, layout_of_maybe_uninit(ecx.tcx, ecx.tcx.types.i32))\n }\n \n // pthread_mutex_t is between 24 and 48 bytes, depending on the platform.\n@@ -79,7 +82,7 @@ fn mutex_set_kind<'mir, 'tcx: 'mir>(\n         mutex_op,\n         offset,\n         kind,\n-        ecx.machine.layouts.i32,\n+        layout_of_maybe_uninit(ecx.tcx, ecx.tcx.types.i32),\n         AtomicWriteOp::Relaxed,\n     )\n }\n@@ -100,7 +103,7 @@ fn mutex_set_id<'mir, 'tcx: 'mir>(\n         mutex_op,\n         4,\n         id,\n-        ecx.machine.layouts.u32,\n+        layout_of_maybe_uninit(ecx.tcx, ecx.tcx.types.u32),\n         AtomicWriteOp::Relaxed,\n     )\n }\n@@ -144,7 +147,7 @@ fn rwlock_set_id<'mir, 'tcx: 'mir>(\n         rwlock_op,\n         4,\n         id,\n-        ecx.machine.layouts.u32,\n+        layout_of_maybe_uninit(ecx.tcx, ecx.tcx.types.u32),\n         AtomicWriteOp::Relaxed,\n     )\n }\n@@ -211,7 +214,7 @@ fn cond_set_id<'mir, 'tcx: 'mir>(\n         cond_op,\n         4,\n         id,\n-        ecx.machine.layouts.u32,\n+        layout_of_maybe_uninit(ecx.tcx, ecx.tcx.types.u32),\n         AtomicWriteOp::Relaxed,\n     )\n }\n@@ -244,7 +247,12 @@ fn cond_set_clock_id<'mir, 'tcx: 'mir>(\n     cond_op: &OpTy<'tcx, Tag>,\n     clock_id: impl Into<ScalarMaybeUninit<Tag>>,\n ) -> InterpResult<'tcx, ()> {\n-    ecx.write_scalar_at_offset(cond_op, 8, clock_id, ecx.machine.layouts.i32)\n+    ecx.write_scalar_at_offset(\n+        cond_op,\n+        8,\n+        clock_id,\n+        layout_of_maybe_uninit(ecx.tcx, ecx.tcx.types.i32),\n+    )\n }\n \n /// Try to reacquire the mutex associated with the condition variable after we\n@@ -788,3 +796,12 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         Ok(0)\n     }\n }\n+\n+fn layout_of_maybe_uninit<'tcx>(tcx: TyCtxtAt<'tcx>, param: Ty<'tcx>) -> TyAndLayout<'tcx> {\n+    let def_id = tcx.require_lang_item(LangItem::MaybeUninit, None);\n+    let def_ty = tcx.type_of(def_id);\n+    let ty = def_ty.subst(*tcx, &[param.into()]);\n+\n+    let param_env = tcx.param_env(def_id);\n+    tcx.layout_of(param_env.and(ty)).unwrap()\n+}"}, {"sha": "06953e1ced96698bb7d7749145b75d3c486b44ab", "filename": "tests/compile-fail/uninit_float.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_float.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_float.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Funinit_float.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: -Zmiri-check-number-validity\n+\n+// This test is adapted from https://github.com/rust-lang/miri/issues/1340#issue-600900312.\n+\n+fn main() {\n+    let _val = unsafe { std::mem::MaybeUninit::<f32>::uninit().assume_init() };\n+    //~^ ERROR type validation failed at .value: encountered uninitialized bytes, but expected initialized plain (non-pointer) bytes\n+}"}, {"sha": "757f69c050fe50f1b71c289bb78ab8e55bbf5198", "filename": "tests/compile-fail/uninit_integer.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_integer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_integer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Funinit_integer.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: -Zmiri-check-number-validity\n+\n+// This test is from https://github.com/rust-lang/miri/issues/1340#issue-600900312.\n+\n+fn main() {\n+    let _val = unsafe { std::mem::MaybeUninit::<usize>::uninit().assume_init() };\n+    //~^ ERROR type validation failed at .value: encountered uninitialized bytes, but expected initialized plain (non-pointer) bytes\n+}"}, {"sha": "bb5d7314a7c1f8d536af40ed55018528b75851ec", "filename": "tests/compile-fail/uninit_integer_signed.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_integer_signed.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_integer_signed.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Funinit_integer_signed.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: -Zmiri-check-number-validity\n+\n+// This test is adapted from https://github.com/rust-lang/miri/issues/1340#issue-600900312.\n+\n+fn main() {\n+    let _val = unsafe { std::mem::MaybeUninit::<i32>::uninit().assume_init() };\n+    //~^ ERROR type validation failed at .value: encountered uninitialized bytes, but expected initialized plain (non-pointer) bytes\n+}"}, {"sha": "beb9ad12709417ba9d4df6aee34aab488658ee8d", "filename": "tests/compile-fail/uninit_raw_ptr.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_raw_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Fcompile-fail%2Funinit_raw_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Funinit_raw_ptr.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -0,0 +1,4 @@\n+fn main() {\n+    let _val = unsafe { std::mem::MaybeUninit::<*const u8>::uninit().assume_init() };\n+    //~^ ERROR type validation failed at .value: encountered uninitialized raw pointer\n+}"}, {"sha": "77d6af6e99cf7a029ada6df42ef446fd07c9efc8", "filename": "tests/run-pass/uninit_number_ignored.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Frun-pass%2Funinit_number_ignored.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8b976eb350acec83280a0cd1ca3ac99faff67bc/tests%2Frun-pass%2Funinit_number_ignored.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Funinit_number_ignored.rs?ref=a8b976eb350acec83280a0cd1ca3ac99faff67bc", "patch": "@@ -0,0 +1,8 @@\n+// This test is adapted from https://github.com/rust-lang/miri/issues/1340#issue-600900312.\n+// This test passes because -Zmiri-check-number-validity is not passed.\n+\n+fn main() {\n+    let _val1 = unsafe { std::mem::MaybeUninit::<usize>::uninit().assume_init() };\n+    let _val2 = unsafe { std::mem::MaybeUninit::<i32>::uninit().assume_init() };\n+    let _val3 = unsafe { std::mem::MaybeUninit::<f32>::uninit().assume_init() };\n+}"}]}