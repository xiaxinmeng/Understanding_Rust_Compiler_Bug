{"sha": "ffb6b23c75add6192a133b15be946cc2199ed971", "node_id": "C_kwDOAAsO6NoAKGZmYjZiMjNjNzVhZGQ2MTkyYTEzM2IxNWJlOTQ2Y2MyMTk5ZWQ5NzE", "commit": {"author": {"name": "Dorian Scheidt", "email": "dorian.scheidt@gmail.com", "date": "2022-07-17T21:45:10Z"}, "committer": {"name": "Dorian Scheidt", "email": "dorian.scheidt@gmail.com", "date": "2022-07-18T21:44:04Z"}, "message": "fix: Prevent panic in Remove Unused Parameter assist\n\nInstead of calling `builder.delete` for every text range we find with\n`process_usage`, we now ensure that the ranges do not overlap before removing\nthem. If a range is fully contained by a prior one, it is dropped.\n\nfixes #12784", "tree": {"sha": "d9ca6baaca374f5262627213a7dffe013e5fe22f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9ca6baaca374f5262627213a7dffe013e5fe22f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffb6b23c75add6192a133b15be946cc2199ed971", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffb6b23c75add6192a133b15be946cc2199ed971", "html_url": "https://github.com/rust-lang/rust/commit/ffb6b23c75add6192a133b15be946cc2199ed971", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffb6b23c75add6192a133b15be946cc2199ed971/comments", "author": {"login": "DorianListens", "id": 5692947, "node_id": "MDQ6VXNlcjU2OTI5NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/5692947?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DorianListens", "html_url": "https://github.com/DorianListens", "followers_url": "https://api.github.com/users/DorianListens/followers", "following_url": "https://api.github.com/users/DorianListens/following{/other_user}", "gists_url": "https://api.github.com/users/DorianListens/gists{/gist_id}", "starred_url": "https://api.github.com/users/DorianListens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DorianListens/subscriptions", "organizations_url": "https://api.github.com/users/DorianListens/orgs", "repos_url": "https://api.github.com/users/DorianListens/repos", "events_url": "https://api.github.com/users/DorianListens/events{/privacy}", "received_events_url": "https://api.github.com/users/DorianListens/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DorianListens", "id": 5692947, "node_id": "MDQ6VXNlcjU2OTI5NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/5692947?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DorianListens", "html_url": "https://github.com/DorianListens", "followers_url": "https://api.github.com/users/DorianListens/followers", "following_url": "https://api.github.com/users/DorianListens/following{/other_user}", "gists_url": "https://api.github.com/users/DorianListens/gists{/gist_id}", "starred_url": "https://api.github.com/users/DorianListens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DorianListens/subscriptions", "organizations_url": "https://api.github.com/users/DorianListens/orgs", "repos_url": "https://api.github.com/users/DorianListens/repos", "events_url": "https://api.github.com/users/DorianListens/events{/privacy}", "received_events_url": "https://api.github.com/users/DorianListens/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc05192e1106668912dab2800215e39f0aa4b98f", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc05192e1106668912dab2800215e39f0aa4b98f", "html_url": "https://github.com/rust-lang/rust/commit/dc05192e1106668912dab2800215e39f0aa4b98f"}], "stats": {"total": 41, "additions": 37, "deletions": 4}, "files": [{"sha": "928a5a386eb11c539e60bb3c83bc0d95b7f3c6fa", "filename": "crates/ide-assists/src/handlers/remove_unused_param.rs", "status": "modified", "additions": 37, "deletions": 4, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/ffb6b23c75add6192a133b15be946cc2199ed971/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffb6b23c75add6192a133b15be946cc2199ed971/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs?ref=ffb6b23c75add6192a133b15be946cc2199ed971", "patch": "@@ -96,12 +96,20 @@ fn process_usages(\n ) {\n     let source_file = ctx.sema.parse(file_id);\n     builder.edit_file(file_id);\n-    for usage in references {\n-        if let Some(text_range) = process_usage(&source_file, usage, arg_to_remove, is_self_present)\n-        {\n-            builder.delete(text_range);\n+    let possible_ranges = references\n+        .into_iter()\n+        .filter_map(|usage| process_usage(&source_file, usage, arg_to_remove, is_self_present));\n+\n+    let mut ranges_to_delete: Vec<TextRange> = vec![];\n+    for range in possible_ranges {\n+        if !ranges_to_delete.iter().any(|it| it.contains_range(range)) {\n+            ranges_to_delete.push(range)\n         }\n     }\n+\n+    for range in ranges_to_delete {\n+        builder.delete(range)\n+    }\n }\n \n fn process_usage(\n@@ -370,6 +378,31 @@ fn main() {\n     S.f(92);\n     S::f(&S);\n }\n+\"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn nested_call() {\n+        check_assist(\n+            remove_unused_param,\n+            r#\"\n+fn foo(x: i32, $0y: i32) -> i32 {\n+    x\n+}\n+\n+fn bar() {\n+    foo(1, foo(2, 3));\n+}\n+\"#,\n+            r#\"\n+fn foo(x: i32) -> i32 {\n+    x\n+}\n+\n+fn bar() {\n+    foo(1);\n+}\n \"#,\n         )\n     }"}]}