{"sha": "262a698875b4b46b63137777e8d948ee22fef240", "node_id": "C_kwDOAAsO6NoAKDI2MmE2OTg4NzViNGI0NmI2MzEzNzc3N2U4ZDk0OGVlMjJmZWYyNDA", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-18T15:38:01Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-18T15:44:16Z"}, "message": "Prepare Code extension for bundling", "tree": {"sha": "29d006cc997af4dcfb1a70739e88f1145ccf7d91", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29d006cc997af4dcfb1a70739e88f1145ccf7d91"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/262a698875b4b46b63137777e8d948ee22fef240", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/262a698875b4b46b63137777e8d948ee22fef240", "html_url": "https://github.com/rust-lang/rust/commit/262a698875b4b46b63137777e8d948ee22fef240", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/262a698875b4b46b63137777e8d948ee22fef240/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f1a3ae5ab46132de350147753443be2ba87a756", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f1a3ae5ab46132de350147753443be2ba87a756", "html_url": "https://github.com/rust-lang/rust/commit/9f1a3ae5ab46132de350147753443be2ba87a756"}], "stats": {"total": 20, "additions": 19, "deletions": 1}, "files": [{"sha": "cfcad7c66b7c876b751b13237a5f7a8c8153e786", "filename": "docs/user/manual.adoc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/262a698875b4b46b63137777e8d948ee22fef240/docs%2Fuser%2Fmanual.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/262a698875b4b46b63137777e8d948ee22fef240/docs%2Fuser%2Fmanual.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fmanual.adoc?ref=262a698875b4b46b63137777e8d948ee22fef240", "patch": "@@ -74,6 +74,8 @@ The server binary is stored in:\n * macOS: `~/Library/Application\\ Support/Code/User/globalStorage/matklad.rust-analyzer`\n * Windows: `%APPDATA%\\Code\\User\\globalStorage\\matklad.rust-analyzer`\n \n+However, if you are using a version of the extension with a bundled server binary and you are not running NixOS, the server binary might be instead running from: `~/.vscode/extensions/matklad.rust-analyzer-VERSION`.\n+\n Note that we only support two most recent versions of VS Code.\n \n ==== Updates"}, {"sha": "09dc27056b37a52c24f0a33ccb6049200a7f9de5", "filename": "editors/code/.vscodeignore", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/262a698875b4b46b63137777e8d948ee22fef240/editors%2Fcode%2F.vscodeignore", "raw_url": "https://github.com/rust-lang/rust/raw/262a698875b4b46b63137777e8d948ee22fef240/editors%2Fcode%2F.vscodeignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2F.vscodeignore?ref=262a698875b4b46b63137777e8d948ee22fef240", "patch": "@@ -10,4 +10,5 @@\n !package-lock.json\n !package.json\n !ra_syntax_tree.tmGrammar.json\n+!server\n !README.md"}, {"sha": "cb0868db59798702252ba66f4793aad1fcd26ae7", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/262a698875b4b46b63137777e8d948ee22fef240/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/262a698875b4b46b63137777e8d948ee22fef240/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=262a698875b4b46b63137777e8d948ee22fef240", "patch": "@@ -36,9 +36,11 @@ export class Config {\n     } = vscode.extensions.getExtension(this.extensionId)!.packageJSON;\n \n     readonly globalStorageUri: vscode.Uri;\n+    readonly installUri: vscode.Uri;\n \n     constructor(ctx: vscode.ExtensionContext) {\n         this.globalStorageUri = ctx.globalStorageUri;\n+        this.installUri = ctx.extensionUri;\n         vscode.workspace.onDidChangeConfiguration(this.onDidChangeConfiguration, this, ctx.subscriptions);\n         this.refreshLogging();\n     }"}, {"sha": "e2a9c4c737deee7c665ed800748f39f4d9fab571", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/262a698875b4b46b63137777e8d948ee22fef240/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/262a698875b4b46b63137777e8d948ee22fef240/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=262a698875b4b46b63137777e8d948ee22fef240", "patch": "@@ -345,7 +345,20 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n     }\n     const ext = platform.indexOf(\"-windows-\") !== -1 ? \".exe\" : \"\";\n     const dest = vscode.Uri.joinPath(config.globalStorageUri, `rust-analyzer-${platform}${ext}`);\n-    const exists = await vscode.workspace.fs.stat(dest).then(() => true, () => false);\n+    const bundled = vscode.Uri.joinPath(config.installUri, \"server\", `rust-analyzer${ext}`);\n+    const bundledExists = await vscode.workspace.fs.stat(bundled).then(() => true, () => false);\n+    let exists = await vscode.workspace.fs.stat(dest).then(() => true, () => false);\n+    if (bundledExists) {\n+        await state.updateServerVersion(config.package.version);\n+        if (!await isNixOs()) {\n+            return bundled.fsPath;\n+        }\n+        if (!exists) {\n+            await vscode.workspace.fs.copy(bundled, dest);\n+            await patchelf(dest);\n+            exists = true;\n+        }\n+    }\n     if (!exists) {\n         await state.updateServerVersion(undefined);\n     }"}]}