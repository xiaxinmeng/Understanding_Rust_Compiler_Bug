{"sha": "36aee1c52663472870d2fe43658b27a74e1e6f9a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2YWVlMWM1MjY2MzQ3Mjg3MGQyZmU0MzY1OGIyN2E3NGUxZTZmOWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-18T15:55:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-18T15:55:06Z"}, "message": "Auto merge of #6928 - mgacek8:issue6675_or_fun_call_unsafe_blocks, r=phansch\n\nor_fun_call: trigger on unsafe blocks\n\nfixes #6675\nchangelog: or_fun_call: trigger on unsafe blocks", "tree": {"sha": "56ff65be9938d95bb9b054319d835d77cdf7dc96", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56ff65be9938d95bb9b054319d835d77cdf7dc96"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36aee1c52663472870d2fe43658b27a74e1e6f9a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36aee1c52663472870d2fe43658b27a74e1e6f9a", "html_url": "https://github.com/rust-lang/rust/commit/36aee1c52663472870d2fe43658b27a74e1e6f9a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36aee1c52663472870d2fe43658b27a74e1e6f9a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d686196b9281fa474ae41934ac367702e586687", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d686196b9281fa474ae41934ac367702e586687", "html_url": "https://github.com/rust-lang/rust/commit/4d686196b9281fa474ae41934ac367702e586687"}, {"sha": "b1f89ee02ff05d559a27949601bef628e498b128", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1f89ee02ff05d559a27949601bef628e498b128", "html_url": "https://github.com/rust-lang/rust/commit/b1f89ee02ff05d559a27949601bef628e498b128"}], "stats": {"total": 61, "additions": 58, "deletions": 3}, "files": [{"sha": "e6b473dbafa4c5c9e9929bba36481a05271ea8fe", "filename": "clippy_lints/src/methods/or_fun_call.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/36aee1c52663472870d2fe43658b27a74e1e6f9a/clippy_lints%2Fsrc%2Fmethods%2For_fun_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36aee1c52663472870d2fe43658b27a74e1e6f9a/clippy_lints%2Fsrc%2Fmethods%2For_fun_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2For_fun_call.rs?ref=36aee1c52663472870d2fe43658b27a74e1e6f9a", "patch": "@@ -6,6 +6,7 @@ use clippy_utils::{contains_return, get_trait_def_id, last_path_segment, paths};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n+use rustc_hir::{BlockCheckMode, UnsafeSource};\n use rustc_lint::LateContext;\n use rustc_middle::ty;\n use rustc_span::source_map::Span;\n@@ -154,7 +155,6 @@ pub(super) fn check<'tcx>(\n             }\n         }\n     }\n-\n     if args.len() == 2 {\n         match args[1].kind {\n             hir::ExprKind::Call(ref fun, ref or_args) => {\n@@ -167,7 +167,16 @@ pub(super) fn check<'tcx>(\n             hir::ExprKind::Index(..) | hir::ExprKind::MethodCall(..) => {\n                 check_general_case(cx, name, method_span, &args[0], &args[1], expr.span, None);\n             },\n-            _ => {},\n+            hir::ExprKind::Block(block, _) => {\n+                if let BlockCheckMode::UnsafeBlock(UnsafeSource::UserProvided) = block.rules {\n+                    if let Some(block_expr) = block.expr {\n+                        if let hir::ExprKind::MethodCall(..) = block_expr.kind {\n+                            check_general_case(cx, name, method_span, &args[0], &args[1], expr.span, None);\n+                        }\n+                    }\n+                }\n+            },\n+            _ => (),\n         }\n     }\n }"}, {"sha": "660245f10c37896aea4a96ea323fc6b1058ff95e", "filename": "tests/ui/or_fun_call.fixed", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/36aee1c52663472870d2fe43658b27a74e1e6f9a/tests%2Fui%2For_fun_call.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/36aee1c52663472870d2fe43658b27a74e1e6f9a/tests%2Fui%2For_fun_call.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2For_fun_call.fixed?ref=36aee1c52663472870d2fe43658b27a74e1e6f9a", "patch": "@@ -132,4 +132,18 @@ fn f() -> Option<()> {\n     Some(())\n }\n \n+mod issue6675 {\n+    unsafe fn foo() {\n+        let mut s = \"test\".to_owned();\n+        None.unwrap_or_else(|| s.as_mut_vec());\n+    }\n+\n+    fn bar() {\n+        let mut s = \"test\".to_owned();\n+        None.unwrap_or_else(|| unsafe { s.as_mut_vec() });\n+        #[rustfmt::skip]\n+        None.unwrap_or_else(|| unsafe { s.as_mut_vec() });\n+    }\n+}\n+\n fn main() {}"}, {"sha": "c589b170bddc2431ca01cb553fa2192ec0b3d298", "filename": "tests/ui/or_fun_call.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/36aee1c52663472870d2fe43658b27a74e1e6f9a/tests%2Fui%2For_fun_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36aee1c52663472870d2fe43658b27a74e1e6f9a/tests%2Fui%2For_fun_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2For_fun_call.rs?ref=36aee1c52663472870d2fe43658b27a74e1e6f9a", "patch": "@@ -132,4 +132,18 @@ fn f() -> Option<()> {\n     Some(())\n }\n \n+mod issue6675 {\n+    unsafe fn foo() {\n+        let mut s = \"test\".to_owned();\n+        None.unwrap_or(s.as_mut_vec());\n+    }\n+\n+    fn bar() {\n+        let mut s = \"test\".to_owned();\n+        None.unwrap_or(unsafe { s.as_mut_vec() });\n+        #[rustfmt::skip]\n+        None.unwrap_or( unsafe { s.as_mut_vec() }    );\n+    }\n+}\n+\n fn main() {}"}, {"sha": "d63b34435927e38613e199e057d1f0f3ac338e51", "filename": "tests/ui/or_fun_call.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/36aee1c52663472870d2fe43658b27a74e1e6f9a/tests%2Fui%2For_fun_call.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/36aee1c52663472870d2fe43658b27a74e1e6f9a/tests%2Fui%2For_fun_call.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2For_fun_call.stderr?ref=36aee1c52663472870d2fe43658b27a74e1e6f9a", "patch": "@@ -114,5 +114,23 @@ error: use of `or` followed by a function call\n LL |         .or(Some(Bar(b, Duration::from_secs(2))));\n    |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try this: `or_else(|| Some(Bar(b, Duration::from_secs(2))))`\n \n-error: aborting due to 19 previous errors\n+error: use of `unwrap_or` followed by a function call\n+  --> $DIR/or_fun_call.rs:138:14\n+   |\n+LL |         None.unwrap_or(s.as_mut_vec());\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: try this: `unwrap_or_else(|| s.as_mut_vec())`\n+\n+error: use of `unwrap_or` followed by a function call\n+  --> $DIR/or_fun_call.rs:143:14\n+   |\n+LL |         None.unwrap_or(unsafe { s.as_mut_vec() });\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try this: `unwrap_or_else(|| unsafe { s.as_mut_vec() })`\n+\n+error: use of `unwrap_or` followed by a function call\n+  --> $DIR/or_fun_call.rs:145:14\n+   |\n+LL |         None.unwrap_or( unsafe { s.as_mut_vec() }    );\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try this: `unwrap_or_else(|| unsafe { s.as_mut_vec() })`\n+\n+error: aborting due to 22 previous errors\n "}]}