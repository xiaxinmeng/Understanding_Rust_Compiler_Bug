{"sha": "1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmZjBiYTAzZWY3MWFiZjFmNzQ0ZDlhY2JhNmQ5YjNjODJjOTc2NGI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-06-07T13:33:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-07T13:33:42Z"}, "message": "Rollup merge of #72970 - OddCoincidence:feature-gated-lints, r=petrochenkov\n\nProperly handle feature-gated lints\n\nCloses #72694", "tree": {"sha": "80669d163f2a59e816938dcc5b103bdf7c8ab430", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/80669d163f2a59e816938dcc5b103bdf7c8ab430"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe3Oy2CRBK7hj4Ov3rIwAAdHIIAEQDFHooKma+8kdP4Iml8i7d\nU4ulbm5DXVBUYeQRqYRSiCR0MMleYd+TdbFwq6c/b0PyUXvkOH82gSVuCpU/LNMz\nf65546y/snruStfumgAqbTVeoaLiDBM27Sgo+g7ySdJ7fN3Ix9ahkyXIEClSXb2K\nKJcgvJrqGJHutjJbqBE35XecvEAFfWQk16Y5FmCPadHfvsaTRO8zVdX8gS5eMXN/\nxfoprjfz7E7NI9NKaDgp1oP07zU3O6d3SkNwnrjsyVAGSrX3W9Z/LewgHG0fHrsr\nJUZhFACKRIWNgNj6IA7tOPNsi+rzYmJ/eWsOyYUHrT7KnJYeqLUN5JO8ObkBbRo=\n=dDTk\n-----END PGP SIGNATURE-----\n", "payload": "tree 80669d163f2a59e816938dcc5b103bdf7c8ab430\nparent cbab74528acb244a146c6bc0754efca5f0e9e5a7\nparent e7e6bc1126884fb20233b1be104af6458cad7c76\nauthor Dylan DPC <dylan.dpc@gmail.com> 1591536822 +0200\ncommitter GitHub <noreply@github.com> 1591536822 +0200\n\nRollup merge of #72970 - OddCoincidence:feature-gated-lints, r=petrochenkov\n\nProperly handle feature-gated lints\n\nCloses #72694\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "html_url": "https://github.com/rust-lang/rust/commit/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cbab74528acb244a146c6bc0754efca5f0e9e5a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbab74528acb244a146c6bc0754efca5f0e9e5a7", "html_url": "https://github.com/rust-lang/rust/commit/cbab74528acb244a146c6bc0754efca5f0e9e5a7"}, {"sha": "e7e6bc1126884fb20233b1be104af6458cad7c76", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7e6bc1126884fb20233b1be104af6458cad7c76", "html_url": "https://github.com/rust-lang/rust/commit/e7e6bc1126884fb20233b1be104af6458cad7c76"}], "stats": {"total": 50, "additions": 29, "deletions": 21}, "files": [{"sha": "05e7c9a0c780de86898cb28e32a1118872a05495", "filename": "src/librustc_lint/levels.rs", "status": "modified", "additions": 15, "deletions": 14, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustc_lint%2Flevels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustc_lint%2Flevels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Flevels.rs?ref=1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "patch": "@@ -214,9 +214,9 @@ impl<'s> LintLevelsBuilder<'s> {\n                 match store.check_lint_name(&name.as_str(), tool_name) {\n                     CheckLintNameResult::Ok(ids) => {\n                         let src = LintSource::Node(name, li.span(), reason);\n-                        for id in ids {\n-                            self.check_gated_lint(*id, attr.span);\n-                            specs.insert(*id, (level, src));\n+                        for &id in ids {\n+                            self.check_gated_lint(id, attr.span);\n+                            specs.insert(id, (level, src));\n                         }\n                     }\n \n@@ -386,17 +386,18 @@ impl<'s> LintLevelsBuilder<'s> {\n         BuilderPush { prev, changed: prev != self.cur }\n     }\n \n-    fn check_gated_lint(&self, id: LintId, span: Span) {\n-        if id == LintId::of(builtin::UNSAFE_OP_IN_UNSAFE_FN)\n-            && !self.sess.features_untracked().unsafe_block_in_unsafe_fn\n-        {\n-            feature_err(\n-                &self.sess.parse_sess,\n-                sym::unsafe_block_in_unsafe_fn,\n-                span,\n-                \"the `unsafe_op_in_unsafe_fn` lint is unstable\",\n-            )\n-            .emit();\n+    /// Checks if the lint is gated on a feature that is not enabled.\n+    fn check_gated_lint(&self, lint_id: LintId, span: Span) {\n+        if let Some(feature) = lint_id.lint.feature_gate {\n+            if !self.sess.features_untracked().enabled(feature) {\n+                feature_err(\n+                    &self.sess.parse_sess,\n+                    feature,\n+                    span,\n+                    &format!(\"the `{}` lint is unstable\", lint_id.lint.name_lower()),\n+                )\n+                .emit();\n+            }\n         }\n     }\n "}, {"sha": "ffb45793090750926b7dc798751ca57e90675bd2", "filename": "src/librustc_session/lint.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustc_session%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustc_session%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Flint.rs?ref=1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "patch": "@@ -85,6 +85,9 @@ pub struct Lint {\n     pub future_incompatible: Option<FutureIncompatibleInfo>,\n \n     pub is_plugin: bool,\n+\n+    /// `Some` if this lint is feature gated, otherwise `None`.\n+    pub feature_gate: Option<Symbol>,\n }\n \n /// Extra information for a future incompatibility lint.\n@@ -107,6 +110,7 @@ impl Lint {\n             is_plugin: false,\n             report_in_external_macro: false,\n             future_incompatible: None,\n+            feature_gate: None,\n         }\n     }\n \n@@ -276,7 +280,9 @@ macro_rules! declare_lint {\n         );\n     );\n     ($vis: vis $NAME: ident, $Level: ident, $desc: expr,\n-     $(@future_incompatible = $fi:expr;)? $($v:ident),*) => (\n+     $(@future_incompatible = $fi:expr;)?\n+     $(@feature_gate = $gate:expr;)?\n+     $($v:ident),*) => (\n         $vis static $NAME: &$crate::lint::Lint = &$crate::lint::Lint {\n             name: stringify!($NAME),\n             default_level: $crate::lint::$Level,\n@@ -285,6 +291,7 @@ macro_rules! declare_lint {\n             is_plugin: false,\n             $($v: true,)*\n             $(future_incompatible: Some($fi),)*\n+            $(feature_gate: Some($gate),)*\n             ..$crate::lint::Lint::default_fields_for_macro()\n         };\n     );\n@@ -328,6 +335,7 @@ macro_rules! declare_tool_lint {\n             report_in_external_macro: $external,\n             future_incompatible: None,\n             is_plugin: true,\n+            feature_gate: None,\n         };\n     );\n }"}, {"sha": "bb0d6e1a47eaddb5f06458999fa5f67b39afbede", "filename": "src/librustc_session/lint/builtin.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustc_session%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustc_session%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Flint%2Fbuiltin.rs?ref=1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "patch": "@@ -7,6 +7,7 @@\n use crate::lint::FutureIncompatibleInfo;\n use crate::{declare_lint, declare_lint_pass};\n use rustc_span::edition::Edition;\n+use rustc_span::symbol::sym;\n \n declare_lint! {\n     pub ILL_FORMED_ATTRIBUTE_INPUT,\n@@ -530,6 +531,7 @@ declare_lint! {\n     pub UNSAFE_OP_IN_UNSAFE_FN,\n     Allow,\n     \"unsafe operations in unsafe functions without an explicit unsafe block are deprecated\",\n+    @feature_gate = sym::unsafe_block_in_unsafe_fn;\n }\n \n declare_lint_pass! {"}, {"sha": "1690b946bb625050fde5de6d9a8c5c7926c412f1", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=1ff0ba03ef71abf1f744d9acba6d9b3c82c9764b", "patch": "@@ -225,11 +225,6 @@ where\n {\n     let warnings_lint_name = lint::builtin::WARNINGS.name;\n \n-    // Whitelist feature-gated lints to avoid feature errors when trying to\n-    // allow all lints.\n-    // FIXME(#72694): handle feature-gated lints properly.\n-    let unsafe_op_in_unsafe_fn_name = rustc_lint::builtin::UNSAFE_OP_IN_UNSAFE_FN.name;\n-\n     whitelisted_lints.push(warnings_lint_name.to_owned());\n     whitelisted_lints.extend(lint_opts.iter().map(|(lint, _)| lint).cloned());\n \n@@ -241,7 +236,9 @@ where\n \n     let lint_opts = lints()\n         .filter_map(|lint| {\n-            if lint.name == warnings_lint_name || lint.name == unsafe_op_in_unsafe_fn_name {\n+            // Whitelist feature-gated lints to avoid feature errors when trying to\n+            // allow all lints.\n+            if lint.name == warnings_lint_name || lint.feature_gate.is_some() {\n                 None\n             } else {\n                 filter_call(lint)"}]}