{"sha": "9576ee97d1f824281e34ecd531965c33bb2e9dd2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1NzZlZTk3ZDFmODI0MjgxZTM0ZWNkNTMxOTY1YzMzYmIyZTlkZDI=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-12-30T09:15:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-30T09:15:25Z"}, "message": "Rollup merge of #80477 - tmiasko:safe-forget, r=oli-obk\n\nMake forget intrinsic safe", "tree": {"sha": "300a2ac290a7cb048723a35ae6abedf9183ecf0d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/300a2ac290a7cb048723a35ae6abedf9183ecf0d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9576ee97d1f824281e34ecd531965c33bb2e9dd2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf7EUtCRBK7hj4Ov3rIwAAdHIIAJvWLABPs22BRIKZNVnGmJnN\n6mbBE5S9PVXLA0hOzkWjgGPKFVT6R+8ySFlzhbMH9h6b7pa6luioXKfRDI+21Nb7\naybugoiqNr0+4ErQwLIPY+kl0vBVVXOOkSQI8muVStofT+vbWB7XBUX1guu6KhRX\nIpkK2lfLYkC1QsvI9ySlbhTw9b/ZYd06JhTZ2KBBDit9OeV5HT1YCSdgiecwE+uT\ne4U7fNl8TImzuKxpziNK+LM85IcxvfSV0UcO8t0XyMSACM8oA0yP5UC+xDxMi4ya\nWUBNUSDv0/uJVQPOuz/ExkxSvhxrEKQa+IwGA93wLZYbDhPAtsdqqV38bYwvaNM=\n=71vQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 300a2ac290a7cb048723a35ae6abedf9183ecf0d\nparent bdc215a8b9bd917e8902f113a9f65afe1d25ffe2\nparent 5718cc2f9b32290dc34ce320076f92d90c00fb7d\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1609319725 +0900\ncommitter GitHub <noreply@github.com> 1609319725 +0900\n\nRollup merge of #80477 - tmiasko:safe-forget, r=oli-obk\n\nMake forget intrinsic safe\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9576ee97d1f824281e34ecd531965c33bb2e9dd2", "html_url": "https://github.com/rust-lang/rust/commit/9576ee97d1f824281e34ecd531965c33bb2e9dd2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9576ee97d1f824281e34ecd531965c33bb2e9dd2/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bdc215a8b9bd917e8902f113a9f65afe1d25ffe2", "url": "https://api.github.com/repos/rust-lang/rust/commits/bdc215a8b9bd917e8902f113a9f65afe1d25ffe2", "html_url": "https://github.com/rust-lang/rust/commit/bdc215a8b9bd917e8902f113a9f65afe1d25ffe2"}, {"sha": "5718cc2f9b32290dc34ce320076f92d90c00fb7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/5718cc2f9b32290dc34ce320076f92d90c00fb7d", "html_url": "https://github.com/rust-lang/rust/commit/5718cc2f9b32290dc34ce320076f92d90c00fb7d"}], "stats": {"total": 34, "additions": 17, "deletions": 17}, "files": [{"sha": "673dec6c7f9a74b81abe70d5cd8e19e8fcfea593", "filename": "compiler/rustc_typeck/src/check/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9576ee97d1f824281e34ecd531965c33bb2e9dd2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9576ee97d1f824281e34ecd531965c33bb2e9dd2/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs?ref=9576ee97d1f824281e34ecd531965c33bb2e9dd2", "patch": "@@ -92,6 +92,7 @@ pub fn intrinsic_operation_unsafety(intrinsic: Symbol) -> hir::Unsafety {\n         | sym::rustc_peek\n         | sym::maxnumf64\n         | sym::type_name\n+        | sym::forget\n         | sym::variant_count => hir::Unsafety::Normal,\n         _ => hir::Unsafety::Unsafe,\n     }"}, {"sha": "87956787242ac6216aa6396aa3af413c1498fc9d", "filename": "library/core/src/mem/mod.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9576ee97d1f824281e34ecd531965c33bb2e9dd2/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9576ee97d1f824281e34ecd531965c33bb2e9dd2/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmem%2Fmod.rs?ref=9576ee97d1f824281e34ecd531965c33bb2e9dd2", "patch": "@@ -151,9 +151,14 @@ pub const fn forget<T>(t: T) {\n #[inline]\n #[unstable(feature = \"forget_unsized\", issue = \"none\")]\n pub fn forget_unsized<T: ?Sized>(t: T) {\n+    #[cfg(bootstrap)]\n     // SAFETY: the forget intrinsic could be safe, but there's no point in making it safe since\n     // we'll be implementing this function soon via `ManuallyDrop`\n-    unsafe { intrinsics::forget(t) }\n+    unsafe {\n+        intrinsics::forget(t)\n+    }\n+    #[cfg(not(bootstrap))]\n+    intrinsics::forget(t)\n }\n \n /// Returns the size of a type in bytes."}, {"sha": "096bba64c0bb882522373957cc04aa07f3df9440", "filename": "src/test/mir-opt/lower_intrinsics.forget.LowerIntrinsics.diff", "status": "modified", "additions": 9, "deletions": 15, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/9576ee97d1f824281e34ecd531965c33bb2e9dd2/src%2Ftest%2Fmir-opt%2Flower_intrinsics.forget.LowerIntrinsics.diff", "raw_url": "https://github.com/rust-lang/rust/raw/9576ee97d1f824281e34ecd531965c33bb2e9dd2/src%2Ftest%2Fmir-opt%2Flower_intrinsics.forget.LowerIntrinsics.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Flower_intrinsics.forget.LowerIntrinsics.diff?ref=9576ee97d1f824281e34ecd531965c33bb2e9dd2", "patch": "@@ -4,27 +4,21 @@\n   fn forget(_1: T) -> () {\n       debug t => _1;                       // in scope 0 at $DIR/lower_intrinsics.rs:18:18: 18:19\n       let mut _0: ();                      // return place in scope 0 at $DIR/lower_intrinsics.rs:18:24: 18:24\n-      let _2: ();                          // in scope 0 at $DIR/lower_intrinsics.rs:19:14: 19:41\n-      let mut _3: T;                       // in scope 0 at $DIR/lower_intrinsics.rs:19:39: 19:40\n-      scope 1 {\n-      }\n+      let mut _2: T;                       // in scope 0 at $DIR/lower_intrinsics.rs:19:30: 19:31\n   \n       bb0: {\n-          StorageLive(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:43\n-          StorageLive(_3);                 // scope 1 at $DIR/lower_intrinsics.rs:19:39: 19:40\n-          _3 = move _1;                    // scope 1 at $DIR/lower_intrinsics.rs:19:39: 19:40\n--         _2 = std::intrinsics::forget::<T>(move _3) -> bb1; // scope 1 at $DIR/lower_intrinsics.rs:19:14: 19:41\n+          StorageLive(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:30: 19:31\n+          _2 = move _1;                    // scope 0 at $DIR/lower_intrinsics.rs:19:30: 19:31\n+-         _0 = std::intrinsics::forget::<T>(move _2) -> bb1; // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:32\n -                                          // mir::Constant\n--                                          // + span: $DIR/lower_intrinsics.rs:19:14: 19:38\n--                                          // + literal: Const { ty: unsafe extern \"rust-intrinsic\" fn(T) {std::intrinsics::forget::<T>}, val: Value(Scalar(<ZST>)) }\n-+         _2 = const ();                   // scope 1 at $DIR/lower_intrinsics.rs:19:14: 19:41\n-+         goto -> bb1;                     // scope 1 at $DIR/lower_intrinsics.rs:19:14: 19:41\n+-                                          // + span: $DIR/lower_intrinsics.rs:19:5: 19:29\n+-                                          // + literal: Const { ty: extern \"rust-intrinsic\" fn(T) {std::intrinsics::forget::<T>}, val: Value(Scalar(<ZST>)) }\n++         _0 = const ();                   // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:32\n++         goto -> bb1;                     // scope 0 at $DIR/lower_intrinsics.rs:19:5: 19:32\n       }\n   \n       bb1: {\n-          StorageDead(_3);                 // scope 1 at $DIR/lower_intrinsics.rs:19:40: 19:41\n-          StorageDead(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:43: 19:44\n-          _0 = const ();                   // scope 0 at $DIR/lower_intrinsics.rs:18:24: 20:2\n+          StorageDead(_2);                 // scope 0 at $DIR/lower_intrinsics.rs:19:31: 19:32\n           goto -> bb2;                     // scope 0 at $DIR/lower_intrinsics.rs:20:1: 20:2\n       }\n   "}, {"sha": "d9891465dabb743fc4afd282f76549e7b2205f4c", "filename": "src/test/mir-opt/lower_intrinsics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9576ee97d1f824281e34ecd531965c33bb2e9dd2/src%2Ftest%2Fmir-opt%2Flower_intrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9576ee97d1f824281e34ecd531965c33bb2e9dd2/src%2Ftest%2Fmir-opt%2Flower_intrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Flower_intrinsics.rs?ref=9576ee97d1f824281e34ecd531965c33bb2e9dd2", "patch": "@@ -16,7 +16,7 @@ pub fn size_of<T>() -> usize {\n \n // EMIT_MIR lower_intrinsics.forget.LowerIntrinsics.diff\n pub fn forget<T>(t: T) {\n-    unsafe { core::intrinsics::forget(t) };\n+    core::intrinsics::forget(t)\n }\n \n // EMIT_MIR lower_intrinsics.unreachable.LowerIntrinsics.diff"}]}