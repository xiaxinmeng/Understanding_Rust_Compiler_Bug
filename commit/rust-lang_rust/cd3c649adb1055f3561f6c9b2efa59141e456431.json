{"sha": "cd3c649adb1055f3561f6c9b2efa59141e456431", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNkM2M2NDlhZGIxMDU1ZjM1NjFmNmM5YjJlZmE1OTE0MWU0NTY0MzE=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-12-21T11:53:56Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-12-21T11:53:56Z"}, "message": "Merge pull request #508 from devonhollowood/underscore_macros\n\nImplement #507", "tree": {"sha": "58e791bfa815e7e543d12c2dc904ff72e46d0c58", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/58e791bfa815e7e543d12c2dc904ff72e46d0c58"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd3c649adb1055f3561f6c9b2efa59141e456431", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd3c649adb1055f3561f6c9b2efa59141e456431", "html_url": "https://github.com/rust-lang/rust/commit/cd3c649adb1055f3561f6c9b2efa59141e456431", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd3c649adb1055f3561f6c9b2efa59141e456431/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a32445aa7fdc7d38fdfeb23e07536ff11c860bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a32445aa7fdc7d38fdfeb23e07536ff11c860bc", "html_url": "https://github.com/rust-lang/rust/commit/4a32445aa7fdc7d38fdfeb23e07536ff11c860bc"}, {"sha": "b6766a0dcf66650a24820929c20be237e37230bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6766a0dcf66650a24820929c20be237e37230bc", "html_url": "https://github.com/rust-lang/rust/commit/b6766a0dcf66650a24820929c20be237e37230bc"}], "stats": {"total": 46, "additions": 39, "deletions": 7}, "files": [{"sha": "609f847b4a96970a2e46e4d54023fc4d8c10e5be", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cd3c649adb1055f3561f6c9b2efa59141e456431/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/cd3c649adb1055f3561f6c9b2efa59141e456431/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=cd3c649adb1055f3561f6c9b2efa59141e456431", "patch": "@@ -24,6 +24,7 @@ compiletest_rs = \"0.0.11\"\n regex = \"*\"\n regex_macros = \"*\"\n lazy_static = \"*\"\n+rustc-serialize = \"0.3\"\n \n [features]\n "}, {"sha": "139dfde36815a71e82e1d2ba39445ff15482cc24", "filename": "src/misc.rs", "status": "modified", "additions": 21, "deletions": 6, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/cd3c649adb1055f3561f6c9b2efa59141e456431/src%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd3c649adb1055f3561f6c9b2efa59141e456431/src%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmisc.rs?ref=cd3c649adb1055f3561f6c9b2efa59141e456431", "patch": "@@ -3,15 +3,15 @@ use syntax::ptr::P;\n use rustc_front::hir::*;\n use reexport::*;\n use rustc_front::util::{is_comparison_binop, binop_to_string};\n-use syntax::codemap::{Span, Spanned};\n+use syntax::codemap::{Span, Spanned, ExpnFormat};\n use rustc_front::intravisit::FnKind;\n use rustc::middle::ty;\n use rustc::middle::const_eval::ConstVal::Float;\n use rustc::middle::const_eval::eval_const_expr_partial;\n use rustc::middle::const_eval::EvalHint::ExprTypeChecked;\n \n use utils::{get_item_name, match_path, snippet, get_parent_expr, span_lint};\n-use utils::{span_help_and_lint, in_external_macro, walk_ptrs_ty, is_integer_literal};\n+use utils::{span_help_and_lint, walk_ptrs_ty, is_integer_literal};\n \n /// **What it does:** This lint checks for function arguments and let bindings denoted as `ref`. It is `Warn` by default.\n ///\n@@ -345,14 +345,17 @@ impl LintPass for UsedUnderscoreBinding {\n \n impl LateLintPass for UsedUnderscoreBinding {\n     fn check_expr(&mut self, cx: &LateContext, expr: &Expr) {\n+        if in_attributes_expansion(cx, expr) { // Don't lint things expanded by #[derive(...)], etc\n+            return;\n+        }\n         let needs_lint = match expr.node {\n             ExprPath(_, ref path) => {\n                 let ident = path.segments.last()\n                                 .expect(\"path should always have at least one segment\")\n                                 .identifier;\n                 ident.name.as_str().chars().next() == Some('_') //starts with '_'\n                 && ident.name.as_str().chars().skip(1).next() != Some('_') //doesn't start with \"__\"\n-                && ident.name != ident.unhygienic_name //not in macro\n+                && ident.name != ident.unhygienic_name //not in bang macro\n                 && is_used(cx, expr)\n             },\n             ExprField(_, spanned) => {\n@@ -362,9 +365,6 @@ impl LateLintPass for UsedUnderscoreBinding {\n             },\n             _ => false\n         };\n-        if in_external_macro(cx, expr.span) {\n-            return\n-        }\n         if needs_lint {\n             cx.span_lint(USED_UNDERSCORE_BINDING, expr.span,\n                          \"used binding which is prefixed with an underscore. A leading underscore \\\n@@ -373,6 +373,8 @@ impl LateLintPass for UsedUnderscoreBinding {\n     }\n }\n \n+/// Heuristic to see if an expression is used. Should be compatible with `unused_variables`'s idea\n+/// of what it means for an expression to be \"used\".\n fn is_used(cx: &LateContext, expr: &Expr) -> bool {\n     if let Some(ref parent) = get_parent_expr(cx, expr) {\n         match parent.node {\n@@ -385,3 +387,16 @@ fn is_used(cx: &LateContext, expr: &Expr) -> bool {\n         true\n     }\n }\n+\n+/// Test whether an expression is in a macro expansion (e.g. something generated by #[derive(...)]\n+/// or the like)\n+fn in_attributes_expansion(cx: &LateContext, expr: &Expr) -> bool {\n+    cx.sess().codemap().with_expn_info(expr.span.expn_id, |info_opt| {\n+        info_opt.map_or(false, |info| {\n+            match info.callee.format {\n+                ExpnFormat::MacroAttribute(_) => true,\n+                _ => false,\n+            }\n+        })\n+    })\n+}"}, {"sha": "39a33c96876ea6bced24c8f24cbfbce45004988d", "filename": "tests/compile-fail/used_underscore_binding.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cd3c649adb1055f3561f6c9b2efa59141e456431/tests%2Fcompile-fail%2Fused_underscore_binding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd3c649adb1055f3561f6c9b2efa59141e456431/tests%2Fcompile-fail%2Fused_underscore_binding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fused_underscore_binding.rs?ref=cd3c649adb1055f3561f6c9b2efa59141e456431", "patch": "@@ -9,7 +9,7 @@ fn prefix_underscore(_foo: u32) -> u32 {\n \n /// Test that we lint even if the use is within a macro expansion\n fn in_macro(_foo: u32) {\n-    println!(\"{}\", _foo); // doesn't warn, nut should #507\n+    println!(\"{}\", _foo); //~ ERROR used binding which is prefixed with an underscore\n }\n \n // Struct for testing use of fields prefixed with an underscore"}, {"sha": "4170f907b0ae69940af9288895d7eac13723c79f", "filename": "tests/used_underscore_binding_macro.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/cd3c649adb1055f3561f6c9b2efa59141e456431/tests%2Fused_underscore_binding_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd3c649adb1055f3561f6c9b2efa59141e456431/tests%2Fused_underscore_binding_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fused_underscore_binding_macro.rs?ref=cd3c649adb1055f3561f6c9b2efa59141e456431", "patch": "@@ -0,0 +1,16 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+extern crate rustc_serialize;\n+\n+/// Test that we do not lint for unused underscores in a MacroAttribute expansion\n+#[deny(used_underscore_binding)]\n+#[derive(RustcEncodable)]\n+struct MacroAttributesTest {\n+    _foo: u32,\n+}\n+\n+#[test]\n+fn macro_attributes_test() {\n+    let _ = MacroAttributesTest{_foo: 0};\n+}"}]}