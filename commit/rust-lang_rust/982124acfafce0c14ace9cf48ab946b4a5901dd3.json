{"sha": "982124acfafce0c14ace9cf48ab946b4a5901dd3", "node_id": "C_kwDOAAsO6NoAKDk4MjEyNGFjZmFmY2UwYzE0YWNlOWNmNDhhYjk0NmI0YTU5MDFkZDM", "commit": {"author": {"name": "Georg Brandl", "email": "georg@python.org", "date": "2021-11-20T10:23:49Z"}, "committer": {"name": "Georg Brandl", "email": "georg@python.org", "date": "2021-11-20T10:57:25Z"}, "message": "Add new lint `octal_escapes`\n\nThis checks for sequences in strings that would be octal character\nescapes in C, but are not supported in Rust.  It suggests either\nto use the `\\x00` escape, or an equivalent hex escape if the octal\nwas intended.", "tree": {"sha": "8df9a87a48a8142ed79b06c66408fa4c95c82e3e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8df9a87a48a8142ed79b06c66408fa4c95c82e3e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/982124acfafce0c14ace9cf48ab946b4a5901dd3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/982124acfafce0c14ace9cf48ab946b4a5901dd3", "html_url": "https://github.com/rust-lang/rust/commit/982124acfafce0c14ace9cf48ab946b4a5901dd3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/982124acfafce0c14ace9cf48ab946b4a5901dd3/comments", "author": {"login": "birkenfeld", "id": 144359, "node_id": "MDQ6VXNlcjE0NDM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/144359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/birkenfeld", "html_url": "https://github.com/birkenfeld", "followers_url": "https://api.github.com/users/birkenfeld/followers", "following_url": "https://api.github.com/users/birkenfeld/following{/other_user}", "gists_url": "https://api.github.com/users/birkenfeld/gists{/gist_id}", "starred_url": "https://api.github.com/users/birkenfeld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/birkenfeld/subscriptions", "organizations_url": "https://api.github.com/users/birkenfeld/orgs", "repos_url": "https://api.github.com/users/birkenfeld/repos", "events_url": "https://api.github.com/users/birkenfeld/events{/privacy}", "received_events_url": "https://api.github.com/users/birkenfeld/received_events", "type": "User", "site_admin": false}, "committer": {"login": "birkenfeld", "id": 144359, "node_id": "MDQ6VXNlcjE0NDM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/144359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/birkenfeld", "html_url": "https://github.com/birkenfeld", "followers_url": "https://api.github.com/users/birkenfeld/followers", "following_url": "https://api.github.com/users/birkenfeld/following{/other_user}", "gists_url": "https://api.github.com/users/birkenfeld/gists{/gist_id}", "starred_url": "https://api.github.com/users/birkenfeld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/birkenfeld/subscriptions", "organizations_url": "https://api.github.com/users/birkenfeld/orgs", "repos_url": "https://api.github.com/users/birkenfeld/repos", "events_url": "https://api.github.com/users/birkenfeld/events{/privacy}", "received_events_url": "https://api.github.com/users/birkenfeld/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "38bd2514ad7d039f6836b0a05dda4dc5f0849942", "url": "https://api.github.com/repos/rust-lang/rust/commits/38bd2514ad7d039f6836b0a05dda4dc5f0849942", "html_url": "https://github.com/rust-lang/rust/commit/38bd2514ad7d039f6836b0a05dda4dc5f0849942"}], "stats": {"total": 216, "additions": 216, "deletions": 0}, "files": [{"sha": "401557b3eacd73fe36e46c5346bfb8f9dd066ba5", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -3056,6 +3056,7 @@ Released 2018-09-13\n [`nonsensical_open_options`]: https://rust-lang.github.io/rust-clippy/master/index.html#nonsensical_open_options\n [`nonstandard_macro_braces`]: https://rust-lang.github.io/rust-clippy/master/index.html#nonstandard_macro_braces\n [`not_unsafe_ptr_arg_deref`]: https://rust-lang.github.io/rust-clippy/master/index.html#not_unsafe_ptr_arg_deref\n+[`octal_escapes`]: https://rust-lang.github.io/rust-clippy/master/index.html#octal_escapes\n [`ok_expect`]: https://rust-lang.github.io/rust-clippy/master/index.html#ok_expect\n [`op_ref`]: https://rust-lang.github.io/rust-clippy/master/index.html#op_ref\n [`option_as_ref_deref`]: https://rust-lang.github.io/rust-clippy/master/index.html#option_as_ref_deref"}, {"sha": "612240135ac637ecb9b6c937d3f747ac508345ad", "filename": "clippy_lints/src/lib.register_all.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.register_all.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.register_all.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_all.rs?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -219,6 +219,7 @@ store.register_group(true, \"clippy::all\", Some(\"clippy_all\"), vec![\n     LintId::of(non_expressive_names::JUST_UNDERSCORES_AND_DIGITS),\n     LintId::of(non_octal_unix_permissions::NON_OCTAL_UNIX_PERMISSIONS),\n     LintId::of(non_send_fields_in_send_ty::NON_SEND_FIELDS_IN_SEND_TY),\n+    LintId::of(octal_escapes::OCTAL_ESCAPES),\n     LintId::of(open_options::NONSENSICAL_OPEN_OPTIONS),\n     LintId::of(option_env_unwrap::OPTION_ENV_UNWRAP),\n     LintId::of(overflow_check_conditional::OVERFLOW_CHECK_CONDITIONAL),"}, {"sha": "19c35a5e5f401b713cb6cfbfb1e7ea9927be3aba", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -380,6 +380,7 @@ store.register_lints(&[\n     non_octal_unix_permissions::NON_OCTAL_UNIX_PERMISSIONS,\n     non_send_fields_in_send_ty::NON_SEND_FIELDS_IN_SEND_TY,\n     nonstandard_macro_braces::NONSTANDARD_MACRO_BRACES,\n+    octal_escapes::OCTAL_ESCAPES,\n     open_options::NONSENSICAL_OPEN_OPTIONS,\n     option_env_unwrap::OPTION_ENV_UNWRAP,\n     option_if_let_else::OPTION_IF_LET_ELSE,"}, {"sha": "414bfc42fdfcdabe6fecf7e701c1474b61ccf774", "filename": "clippy_lints/src/lib.register_suspicious.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_suspicious.rs?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -16,6 +16,7 @@ store.register_group(true, \"clippy::suspicious\", Some(\"clippy_suspicious\"), vec!\n     LintId::of(methods::SUSPICIOUS_MAP),\n     LintId::of(mut_key::MUTABLE_KEY_TYPE),\n     LintId::of(non_send_fields_in_send_ty::NON_SEND_FIELDS_IN_SEND_TY),\n+    LintId::of(octal_escapes::OCTAL_ESCAPES),\n     LintId::of(suspicious_trait_impl::SUSPICIOUS_ARITHMETIC_IMPL),\n     LintId::of(suspicious_trait_impl::SUSPICIOUS_OP_ASSIGN_IMPL),\n ])"}, {"sha": "3dafdf8f0d5e2f29beb2f536dc46cca2c56aa6ef", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -312,6 +312,7 @@ mod non_expressive_names;\n mod non_octal_unix_permissions;\n mod non_send_fields_in_send_ty;\n mod nonstandard_macro_braces;\n+mod octal_escapes;\n mod open_options;\n mod option_env_unwrap;\n mod option_if_let_else;\n@@ -849,6 +850,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(match_str_case_mismatch::MatchStrCaseMismatch));\n     store.register_late_pass(move || Box::new(format_args::FormatArgs));\n     store.register_late_pass(|| Box::new(trailing_empty_array::TrailingEmptyArray));\n+    store.register_early_pass(|| Box::new(octal_escapes::OctalEscapes));\n     // add lints here, do not remove this comment, it's used in `new_lint`\n }\n "}, {"sha": "9ae269bc7d99ff0141d5dc1147542213fd8a783f", "filename": "clippy_lints/src/octal_escapes.rs", "status": "added", "additions": 131, "deletions": 0, "changes": 131, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Foctal_escapes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/clippy_lints%2Fsrc%2Foctal_escapes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Foctal_escapes.rs?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -0,0 +1,131 @@\n+use clippy_utils::diagnostics::span_lint_and_then;\n+use rustc_ast::ast::{Expr, ExprKind};\n+use rustc_ast::token::{Lit, LitKind};\n+use rustc_errors::Applicability;\n+use rustc_lint::{EarlyContext, EarlyLintPass};\n+use rustc_middle::lint::in_external_macro;\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_span::Span;\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for `\\0` escapes in string and byte literals that look like octal character\n+    /// escapes in C\n+    ///\n+    /// ### Why is this bad?\n+    /// Rust does not support octal notation for character escapes. `\\0` is always a\n+    /// null byte/character, and any following digits do not form part of the escape\n+    /// sequence.\n+    ///\n+    /// ### Known problems\n+    /// The actual meaning can be the intended one. `\\x00` can be used in these\n+    /// cases to be unambigious.\n+    ///\n+    /// # Example\n+    /// ```rust\n+    /// // Bad\n+    /// let one = \"\\033[1m Bold? \\033[0m\";  // \\033 intended as escape\n+    /// let two = \"\\033\\0\";                 // \\033 intended as null-3-3\n+    ///\n+    /// // Good\n+    /// let one = \"\\x1b[1mWill this be bold?\\x1b[0m\";\n+    /// let two = \"\\x0033\\x00\";\n+    /// ```\n+    #[clippy::version = \"1.58.0\"]\n+    pub OCTAL_ESCAPES,\n+    suspicious,\n+    \"string escape sequences looking like octal characters\"\n+}\n+\n+declare_lint_pass!(OctalEscapes => [OCTAL_ESCAPES]);\n+\n+impl EarlyLintPass for OctalEscapes {\n+    fn check_expr(&mut self, cx: &EarlyContext<'tcx>, expr: &Expr) {\n+        if in_external_macro(cx.sess, expr.span) {\n+            return;\n+        }\n+\n+        if let ExprKind::Lit(lit) = &expr.kind {\n+            if matches!(lit.token.kind, LitKind::Str) {\n+                check_lit(cx, &lit.token, lit.span, true);\n+            } else if matches!(lit.token.kind, LitKind::ByteStr) {\n+                check_lit(cx, &lit.token, lit.span, false);\n+            }\n+        }\n+    }\n+}\n+\n+fn check_lit(cx: &EarlyContext<'tcx>, lit: &Lit, span: Span, is_string: bool) {\n+    let contents = lit.symbol.as_str();\n+    let mut iter = contents.char_indices();\n+\n+    // go through the string, looking for \\0[0-7]\n+    while let Some((from, ch)) = iter.next() {\n+        if ch == '\\\\' {\n+            if let Some((mut to, '0')) = iter.next() {\n+                // collect all further potentially octal digits\n+                while let Some((j, '0'..='7')) = iter.next() {\n+                    to = j + 1;\n+                }\n+                // if it's more than just `\\0` we have a match\n+                if to > from + 2 {\n+                    emit(cx, &contents, from, to, span, is_string);\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+fn emit(cx: &EarlyContext<'tcx>, contents: &str, from: usize, to: usize, span: Span, is_string: bool) {\n+    // construct a replacement escape for that case that octal was intended\n+    let escape = &contents[from + 1..to];\n+    let literal_suggestion = if is_string {\n+        u32::from_str_radix(escape, 8).ok().and_then(|n| {\n+            if n < 256 {\n+                Some(format!(\"\\\\x{:02x}\", n))\n+            } else if n <= std::char::MAX as u32 {\n+                Some(format!(\"\\\\u{{{:x}}}\", n))\n+            } else {\n+                None\n+            }\n+        })\n+    } else {\n+        u8::from_str_radix(escape, 8).ok().map(|n| format!(\"\\\\x{:02x}\", n))\n+    };\n+\n+    span_lint_and_then(\n+        cx,\n+        OCTAL_ESCAPES,\n+        span,\n+        &format!(\n+            \"octal-looking escape in {} literal\",\n+            if is_string { \"string\" } else { \"byte string\" }\n+        ),\n+        |diag| {\n+            diag.help(&format!(\n+                \"octal escapes are not supported, `\\\\0` is always a null {}\",\n+                if is_string { \"character\" } else { \"byte\" }\n+            ));\n+            // suggestion 1: equivalent hex escape\n+            if let Some(sugg) = literal_suggestion {\n+                diag.span_suggestion(\n+                    span,\n+                    \"if an octal escape is intended, use\",\n+                    format!(\"\\\"{}{}{}\\\"\", &contents[..from], sugg, &contents[to..]),\n+                    Applicability::MaybeIncorrect,\n+                );\n+            }\n+            // suggestion 2: unambiguous null byte\n+            diag.span_suggestion(\n+                span,\n+                &format!(\n+                    \"if the null {} is intended, disambiguate using\",\n+                    if is_string { \"character\" } else { \"byte\" }\n+                ),\n+                format!(\"\\\"{}\\\\x00{}\\\"\", &contents[..from], &contents[from + 2..]),\n+                Applicability::MaybeIncorrect,\n+            );\n+        },\n+    );\n+}"}, {"sha": "5ddee73c020ee768842e8f9634771e09707f3bfa", "filename": "tests/ui/octal_escapes.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/tests%2Fui%2Foctal_escapes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/tests%2Fui%2Foctal_escapes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foctal_escapes.rs?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -0,0 +1,12 @@\n+#![warn(clippy::octal_escapes)]\n+\n+fn main() {\n+    let _bad1 = \"\\033[0m\";\n+    let _bad2 = b\"\\033[0m\";\n+    let _bad3 = \"\\\\\\033[0m\";\n+    let _bad4 = \"\\01234567\";\n+    let _bad5 = \"\\0\\03\";\n+\n+    let _good1 = \"\\\\033[0m\";\n+    let _good2 = \"\\0\\\\0\";\n+}"}, {"sha": "8a93e781bed298ba9dcca584c3041cb84b774202", "filename": "tests/ui/octal_escapes.stderr", "status": "added", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/982124acfafce0c14ace9cf48ab946b4a5901dd3/tests%2Fui%2Foctal_escapes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/982124acfafce0c14ace9cf48ab946b4a5901dd3/tests%2Fui%2Foctal_escapes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foctal_escapes.stderr?ref=982124acfafce0c14ace9cf48ab946b4a5901dd3", "patch": "@@ -0,0 +1,67 @@\n+error: octal-looking escape in string literal\n+  --> $DIR/octal_escapes.rs:4:17\n+   |\n+LL |     let _bad1 = \"/033[0m\";\n+   |                 ^^^^^^^^^\n+   |\n+   = note: `-D clippy::octal-escapes` implied by `-D warnings`\n+   = help: octal escapes are not supported, `/0` is always a null character\n+help: if an octal escape is intended, use\n+   |\n+LL |     let _bad1 = \"/x1b[0m\";\n+   |                 ~~~~~~~~~\n+help: if the null character is intended, disambiguate using\n+   |\n+LL |     let _bad1 = \"/x0033[0m\";\n+   |                 ~~~~~~~~~~~\n+\n+error: octal-looking escape in byte string literal\n+  --> $DIR/octal_escapes.rs:5:17\n+   |\n+LL |     let _bad2 = b\"/033[0m\";\n+   |                 ^^^^^^^^^^\n+   |\n+   = help: octal escapes are not supported, `/0` is always a null byte\n+help: if an octal escape is intended, use\n+   |\n+LL |     let _bad2 = \"/x1b[0m\";\n+   |                 ~~~~~~~~~\n+help: if the null byte is intended, disambiguate using\n+   |\n+LL |     let _bad2 = \"/x0033[0m\";\n+   |                 ~~~~~~~~~~~\n+\n+error: octal-looking escape in string literal\n+  --> $DIR/octal_escapes.rs:6:17\n+   |\n+LL |     let _bad3 = \"//033[0m\";\n+   |                 ^^^^^^^^^^^\n+   |\n+   = help: octal escapes are not supported, `/0` is always a null character\n+help: if an octal escape is intended, use\n+   |\n+LL |     let _bad3 = \"//x1b[0m\";\n+   |                 ~~~~~~~~~~~\n+help: if the null character is intended, disambiguate using\n+   |\n+LL |     let _bad3 = \"//x0033[0m\";\n+   |                 ~~~~~~~~~~~~~\n+\n+error: octal-looking escape in string literal\n+  --> $DIR/octal_escapes.rs:7:17\n+   |\n+LL |     let _bad4 = \"/01234567\";\n+   |                 ^^^^^^^^^^^\n+   |\n+   = help: octal escapes are not supported, `/0` is always a null character\n+help: if an octal escape is intended, use\n+   |\n+LL |     let _bad4 = \"/u{53977}\";\n+   |                 ~~~~~~~~~~~\n+help: if the null character is intended, disambiguate using\n+   |\n+LL |     let _bad4 = \"/x001234567\";\n+   |                 ~~~~~~~~~~~~~\n+\n+error: aborting due to 4 previous errors\n+"}]}