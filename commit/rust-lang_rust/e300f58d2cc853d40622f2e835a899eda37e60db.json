{"sha": "e300f58d2cc853d40622f2e835a899eda37e60db", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUzMDBmNThkMmNjODUzZDQwNjIyZjJlODM1YTg5OWVkYTM3ZTYwZGI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-08-14T17:17:16Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-08-14T17:17:16Z"}, "message": "internal: remove one more usage of old editing API.", "tree": {"sha": "983bb5d8c1ee59fde83f7b94a7310f7164eb8089", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/983bb5d8c1ee59fde83f7b94a7310f7164eb8089"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e300f58d2cc853d40622f2e835a899eda37e60db", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e300f58d2cc853d40622f2e835a899eda37e60db", "html_url": "https://github.com/rust-lang/rust/commit/e300f58d2cc853d40622f2e835a899eda37e60db", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e300f58d2cc853d40622f2e835a899eda37e60db/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a26b1c3923b29d6787bbcb107eea0be60529eaa1", "url": "https://api.github.com/repos/rust-lang/rust/commits/a26b1c3923b29d6787bbcb107eea0be60529eaa1", "html_url": "https://github.com/rust-lang/rust/commit/a26b1c3923b29d6787bbcb107eea0be60529eaa1"}], "stats": {"total": 80, "additions": 25, "deletions": 55}, "files": [{"sha": "c5540fa8426cf9f6dc479aa92feb107f38aaa075", "filename": "crates/ide_assists/src/utils.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fide_assists%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fide_assists%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Futils.rs?ref=e300f58d2cc853d40622f2e835a899eda37e60db", "patch": "@@ -130,7 +130,8 @@ pub fn add_trait_assoc_items_to_impl(\n     let items = items.into_iter().map(|assoc_item| {\n         let assoc_item = assoc_item.clone_for_update();\n         transform.apply(assoc_item.syntax());\n-        edit::remove_attrs_and_docs(&assoc_item).clone_subtree().clone_for_update()\n+        edit::remove_attrs_and_docs(&assoc_item);\n+        assoc_item\n     });\n \n     let res = impl_.clone_for_update();"}, {"sha": "aa110b089987c4304a18da41b91ac1901ff6c3be", "filename": "crates/ide_completion/src/completions/trait_impl.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ftrait_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ftrait_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ftrait_impl.rs?ref=e300f58d2cc853d40622f2e835a899eda37e60db", "patch": "@@ -194,10 +194,10 @@ fn get_transformed_assoc_item(\n     );\n \n     transform.apply(assoc_item.syntax());\n-    Some(match assoc_item {\n-        ast::AssocItem::Fn(func) => ast::AssocItem::Fn(edit::remove_attrs_and_docs(&func)),\n-        _ => assoc_item,\n-    })\n+    if let ast::AssocItem::Fn(func) = &assoc_item {\n+        edit::remove_attrs_and_docs(func)\n+    }\n+    Some(assoc_item)\n }\n \n fn add_type_alias_impl(\n@@ -253,7 +253,7 @@ fn add_const_impl(\n }\n \n fn make_const_compl_syntax(const_: &ast::Const) -> String {\n-    let const_ = edit::remove_attrs_and_docs(const_);\n+    edit::remove_attrs_and_docs(const_);\n \n     let const_start = const_.syntax().text_range().start();\n     let const_end = const_.syntax().text_range().end();"}, {"sha": "904a38471e746337ac74090e60d4264fd28e489c", "filename": "crates/syntax/src/algo.rs", "status": "modified", "additions": 1, "deletions": 36, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fsyntax%2Fsrc%2Falgo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fsyntax%2Fsrc%2Falgo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Falgo.rs?ref=e300f58d2cc853d40622f2e835a899eda37e60db", "patch": "@@ -1,6 +1,6 @@\n //! Collection of assorted algorithms for syntax trees.\n \n-use std::{hash::BuildHasherDefault, ops::RangeInclusive};\n+use std::hash::BuildHasherDefault;\n \n use indexmap::IndexMap;\n use itertools::Itertools;\n@@ -295,41 +295,6 @@ fn _insert_children(\n     with_children(parent, new_children)\n }\n \n-/// Replaces all nodes in `to_delete` with nodes from `to_insert`\n-///\n-/// This is a type-unsafe low-level editing API, if you need to use it,\n-/// prefer to create a type-safe abstraction on top of it instead.\n-pub fn replace_children(\n-    parent: &SyntaxNode,\n-    to_delete: RangeInclusive<SyntaxElement>,\n-    to_insert: impl IntoIterator<Item = SyntaxElement>,\n-) -> SyntaxNode {\n-    let mut to_insert = to_insert.into_iter();\n-    _replace_children(parent, to_delete, &mut to_insert)\n-}\n-\n-fn _replace_children(\n-    parent: &SyntaxNode,\n-    to_delete: RangeInclusive<SyntaxElement>,\n-    to_insert: &mut dyn Iterator<Item = SyntaxElement>,\n-) -> SyntaxNode {\n-    let start = position_of_child(parent, to_delete.start().clone());\n-    let end = position_of_child(parent, to_delete.end().clone());\n-    let parent_green = parent.green();\n-    let mut old_children = parent_green.children().map(|it| match it {\n-        NodeOrToken::Token(it) => NodeOrToken::Token(it.to_owned()),\n-        NodeOrToken::Node(it) => NodeOrToken::Node(it.to_owned()),\n-    });\n-\n-    let before = old_children.by_ref().take(start).collect::<Vec<_>>();\n-    let new_children = before\n-        .into_iter()\n-        .chain(to_insert.map(to_green_element))\n-        .chain(old_children.skip(end + 1 - start))\n-        .collect::<Vec<_>>();\n-    with_children(parent, new_children)\n-}\n-\n fn with_children(\n     parent: &SyntaxNode,\n     new_children: Vec<NodeOrToken<rowan::GreenNode, rowan::GreenToken>>,"}, {"sha": "01d6add36d5e69d66d7a34e553c179c64d086617", "filename": "crates/syntax/src/ast/edit.rs", "status": "modified", "additions": 17, "deletions": 13, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fsyntax%2Fsrc%2Fast%2Fedit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e300f58d2cc853d40622f2e835a899eda37e60db/crates%2Fsyntax%2Fsrc%2Fast%2Fedit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fedit.rs?ref=e300f58d2cc853d40622f2e835a899eda37e60db", "patch": "@@ -48,22 +48,26 @@ impl ast::UseTree {\n     }\n }\n \n-#[must_use]\n-pub fn remove_attrs_and_docs<N: ast::AttrsOwner>(node: &N) -> N {\n-    N::cast(remove_attrs_and_docs_inner(node.syntax().clone())).unwrap()\n+pub fn remove_attrs_and_docs<N: ast::AttrsOwner>(node: &N) {\n+    remove_attrs_and_docs_inner(node.syntax())\n }\n \n-fn remove_attrs_and_docs_inner(mut node: SyntaxNode) -> SyntaxNode {\n-    while let Some(start) =\n-        node.children_with_tokens().find(|it| it.kind() == ATTR || it.kind() == COMMENT)\n-    {\n-        let end = match &start.next_sibling_or_token() {\n-            Some(el) if el.kind() == WHITESPACE => el.clone(),\n-            Some(_) | None => start.clone(),\n-        };\n-        node = algo::replace_children(&node, start..=end, &mut iter::empty());\n+fn remove_attrs_and_docs_inner(node: &SyntaxNode) {\n+    let mut remove_next_ws = false;\n+    for child in node.children_with_tokens() {\n+        match child.kind() {\n+            ATTR | COMMENT => {\n+                remove_next_ws = true;\n+                child.detach();\n+                continue;\n+            }\n+            WHITESPACE if remove_next_ws => {\n+                child.detach();\n+            }\n+            _ => (),\n+        }\n+        remove_next_ws = false;\n     }\n-    node\n }\n \n #[derive(Debug, Clone, Copy)]"}]}