{"sha": "a247fffdf618cc39ce83d181d4c58da1ec8803a2", "node_id": "C_kwDOAAsO6NoAKGEyNDdmZmZkZjYxOGNjMzljZTgzZDE4MWQ0YzU4ZGExZWM4ODAzYTI", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-02-25T17:38:51Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-02-25T17:38:51Z"}, "message": "Resolve `$crate` in `HirDisplay` of `Path`", "tree": {"sha": "81ec5a9d2f7bf5adf7e5731050665753a8dbea5e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81ec5a9d2f7bf5adf7e5731050665753a8dbea5e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a247fffdf618cc39ce83d181d4c58da1ec8803a2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a247fffdf618cc39ce83d181d4c58da1ec8803a2", "html_url": "https://github.com/rust-lang/rust/commit/a247fffdf618cc39ce83d181d4c58da1ec8803a2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a247fffdf618cc39ce83d181d4c58da1ec8803a2/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ab896e38e124676c4d0532b74f4d0d714b33b2f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab896e38e124676c4d0532b74f4d0d714b33b2f9", "html_url": "https://github.com/rust-lang/rust/commit/ab896e38e124676c4d0532b74f4d0d714b33b2f9"}], "stats": {"total": 43, "additions": 42, "deletions": 1}, "files": [{"sha": "2020834fbc49752a7bb09aa365face1040fdf06d", "filename": "crates/hir_ty/src/display.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a247fffdf618cc39ce83d181d4c58da1ec8803a2/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a247fffdf618cc39ce83d181d4c58da1ec8803a2/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs?ref=a247fffdf618cc39ce83d181d4c58da1ec8803a2", "patch": "@@ -1189,7 +1189,18 @@ impl HirDisplay for Path {\n                     write!(f, \"super\")?;\n                 }\n             }\n-            (_, PathKind::DollarCrate(_)) => write!(f, \"{{extern_crate}}\")?,\n+            (_, PathKind::DollarCrate(id)) => {\n+                // Resolve `$crate` to the crate's display name.\n+                // FIXME: should use the dependency name instead if available, but that depends on\n+                // the crate invoking `HirDisplay`\n+                let crate_graph = f.db.crate_graph();\n+                let name = crate_graph[*id]\n+                    .display_name\n+                    .as_ref()\n+                    .map(|name| name.canonical_name())\n+                    .unwrap_or(\"$crate\");\n+                write!(f, \"{name}\")?\n+            }\n         }\n \n         for (seg_idx, segment) in self.segments().iter().enumerate() {"}, {"sha": "df0ca941c99d80247c657b457f4914549765f4cb", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/a247fffdf618cc39ce83d181d4c58da1ec8803a2/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a247fffdf618cc39ce83d181d4c58da1ec8803a2/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=a247fffdf618cc39ce83d181d4c58da1ec8803a2", "patch": "@@ -4583,3 +4583,33 @@ pub struct Foo;\n         \"##]],\n     );\n }\n+\n+#[test]\n+fn hover_dollar_crate() {\n+    // $crate should be resolved to the right crate name.\n+\n+    check(\n+        r#\"\n+//- /main.rs crate:main deps:dep\n+dep::m!(KONST$0);\n+//- /dep.rs crate:dep\n+#[macro_export]\n+macro_rules! m {\n+    ( $name:ident ) => { const $name: $crate::Type = $crate::Type; };\n+}\n+\n+pub struct Type;\n+\"#,\n+        expect![[r#\"\n+            *KONST*\n+\n+            ```rust\n+            main\n+            ```\n+\n+            ```rust\n+            const KONST: dep::Type = $crate::Type\n+            ```\n+        \"#]],\n+    );\n+}"}]}