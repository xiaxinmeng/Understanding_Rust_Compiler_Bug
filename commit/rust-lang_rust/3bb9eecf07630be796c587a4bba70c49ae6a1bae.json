{"sha": "3bb9eecf07630be796c587a4bba70c49ae6a1bae", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiYjllZWNmMDc2MzBiZTc5NmM1ODdhNGJiYTcwYzQ5YWU2YTFiYWU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-20T14:33:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-20T14:33:00Z"}, "message": "Auto merge of #89069 - bjorn3:optimize_sharded_new, r=Mark-Simulacrum\n\nUse <[T; N]>::map in Sharded instead of SmallVec and unsafe code\n\nThis results in a lot less assembly", "tree": {"sha": "5dcfee7839db0fea42610d3b7827e37bb2c10686", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5dcfee7839db0fea42610d3b7827e37bb2c10686"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3bb9eecf07630be796c587a4bba70c49ae6a1bae", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3bb9eecf07630be796c587a4bba70c49ae6a1bae", "html_url": "https://github.com/rust-lang/rust/commit/3bb9eecf07630be796c587a4bba70c49ae6a1bae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3bb9eecf07630be796c587a4bba70c49ae6a1bae/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "db1fb85cff63ad5fffe435e17128f99f9e1d970c", "url": "https://api.github.com/repos/rust-lang/rust/commits/db1fb85cff63ad5fffe435e17128f99f9e1d970c", "html_url": "https://github.com/rust-lang/rust/commit/db1fb85cff63ad5fffe435e17128f99f9e1d970c"}, {"sha": "7b50fd54501cadde9674abe0e5e1e95f70c9c854", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b50fd54501cadde9674abe0e5e1e95f70c9c854", "html_url": "https://github.com/rust-lang/rust/commit/7b50fd54501cadde9674abe0e5e1e95f70c9c854"}], "stats": {"total": 20, "additions": 1, "deletions": 19}, "files": [{"sha": "417c61242a539d584e1aac62e7bad937b379b321", "filename": "compiler/rustc_data_structures/src/sharded.rs", "status": "modified", "additions": 1, "deletions": 19, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/3bb9eecf07630be796c587a4bba70c49ae6a1bae/compiler%2Frustc_data_structures%2Fsrc%2Fsharded.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bb9eecf07630be796c587a4bba70c49ae6a1bae/compiler%2Frustc_data_structures%2Fsrc%2Fsharded.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fsharded.rs?ref=3bb9eecf07630be796c587a4bba70c49ae6a1bae", "patch": "@@ -1,6 +1,5 @@\n use crate::fx::{FxHashMap, FxHasher};\n use crate::sync::{Lock, LockGuard};\n-use smallvec::SmallVec;\n use std::borrow::Borrow;\n use std::collections::hash_map::RawEntryMut;\n use std::hash::{Hash, Hasher};\n@@ -37,24 +36,7 @@ impl<T: Default> Default for Sharded<T> {\n impl<T> Sharded<T> {\n     #[inline]\n     pub fn new(mut value: impl FnMut() -> T) -> Self {\n-        // Create a vector of the values we want\n-        let mut values: SmallVec<[_; SHARDS]> =\n-            (0..SHARDS).map(|_| CacheAligned(Lock::new(value()))).collect();\n-\n-        // Create an uninitialized array\n-        let mut shards: mem::MaybeUninit<[CacheAligned<Lock<T>>; SHARDS]> =\n-            mem::MaybeUninit::uninit();\n-\n-        unsafe {\n-            // Copy the values into our array\n-            let first = shards.as_mut_ptr() as *mut CacheAligned<Lock<T>>;\n-            values.as_ptr().copy_to_nonoverlapping(first, SHARDS);\n-\n-            // Ignore the content of the vector\n-            values.set_len(0);\n-\n-            Sharded { shards: shards.assume_init() }\n-        }\n+        Sharded { shards: [(); SHARDS].map(|()| CacheAligned(Lock::new(value()))) }\n     }\n \n     /// The shard is selected by hashing `val` with `FxHasher`."}]}