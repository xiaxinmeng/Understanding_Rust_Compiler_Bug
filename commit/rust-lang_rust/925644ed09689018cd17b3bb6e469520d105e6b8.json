{"sha": "925644ed09689018cd17b3bb6e469520d105e6b8", "node_id": "C_kwDOAAsO6NoAKDkyNTY0NGVkMDk2ODkwMThjZDE3YjNiYjZlNDY5NTIwZDEwNWU2Yjg", "commit": {"author": {"name": "Jakub Ber\u00e1nek", "email": "berykubik@gmail.com", "date": "2022-08-20T11:40:18Z"}, "committer": {"name": "Jakub Ber\u00e1nek", "email": "berykubik@gmail.com", "date": "2022-08-29T08:56:56Z"}, "message": "Track PGO profiles in depinfo", "tree": {"sha": "518508bfa8bb2943783bc1b4d5a4c64cceb1aa02", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/518508bfa8bb2943783bc1b4d5a4c64cceb1aa02"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/925644ed09689018cd17b3bb6e469520d105e6b8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEEzFQynJm4WzBnfhz8kJzQ0mSDUWsFAmMMf18ACgkQkJzQ0mSD\nUWu8ugv+JCYEwkBv79/v5tJiPoNm9nKoizcRoD+wYjnMACS5GkuGD20FmewcK5gp\n/SLMOTzQOaRjcQ+FR14yqgcRtBr4fYRUwDq94C2kXSlcegRdAFZqteGnFv+fnSAM\nnXargDv6T+KdS4+3ont/dvXNWFjAn+TYVxbXOGjGOIM7K5NxoU78SdlBOEyvAsXZ\nycC1DiKLQP+5P2uSeQd3INLJFBTLSuXW0jm4ddzZxjnPTifYgunZfiKjh2zwHGxE\nENud3K+2XroVEO/RMvtq5kYfY2z3HCxpasuPXADR/+R+YZ2VRAc0HCmo1o7k7Ocz\nmlz7oyQI0rp26xwSxgCAaYAVmvGyMOw1WZ2xqnr0eh6X5rqpGbH1j13633268mNj\nL8oSVcRr8mMvv8l49ffEI9scsxPygKUdLwObWBEhZYZ1zD8/JsqUkcH8C2HGFMqp\nrxwZAn0zsGxH+DNZpkW/j6+aYV8mg/M+5rSJg+GJ3ztO7e0UQs735ULXarD7WLVT\ntbLVUMZM\n=e18O\n-----END PGP SIGNATURE-----", "payload": "tree 518508bfa8bb2943783bc1b4d5a4c64cceb1aa02\nparent 6c943bad02626dddc5e5135b23c77429b6e4a063\nauthor Jakub Ber\u00e1nek <berykubik@gmail.com> 1660995618 +0200\ncommitter Jakub Ber\u00e1nek <berykubik@gmail.com> 1661763416 +0200\n\nTrack PGO profiles in depinfo\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/925644ed09689018cd17b3bb6e469520d105e6b8", "html_url": "https://github.com/rust-lang/rust/commit/925644ed09689018cd17b3bb6e469520d105e6b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/925644ed09689018cd17b3bb6e469520d105e6b8/comments", "author": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6c943bad02626dddc5e5135b23c77429b6e4a063", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c943bad02626dddc5e5135b23c77429b6e4a063", "html_url": "https://github.com/rust-lang/rust/commit/6c943bad02626dddc5e5135b23c77429b6e4a063"}], "stats": {"total": 44, "additions": 41, "deletions": 3}, "files": [{"sha": "149b3697d9101a187f42567306fb05e329bbe985", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/925644ed09689018cd17b3bb6e469520d105e6b8/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/925644ed09689018cd17b3bb6e469520d105e6b8/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=925644ed09689018cd17b3bb6e469520d105e6b8", "patch": "@@ -593,13 +593,24 @@ fn write_out_deps(\n         // Account for explicitly marked-to-track files\n         // (e.g. accessed in proc macros).\n         let file_depinfo = sess.parse_sess.file_depinfo.borrow();\n-        let extra_tracked_files = file_depinfo.iter().map(|path_sym| {\n-            let path = PathBuf::from(path_sym.as_str());\n+\n+        let normalize_path = |path: PathBuf| {\n             let file = FileName::from(path);\n             escape_dep_filename(&file.prefer_local().to_string())\n-        });\n+        };\n+\n+        let extra_tracked_files =\n+            file_depinfo.iter().map(|path_sym| normalize_path(PathBuf::from(path_sym.as_str())));\n         files.extend(extra_tracked_files);\n \n+        // We also need to track used PGO profile files\n+        if let Some(ref profile_instr) = sess.opts.cg.profile_use {\n+            files.push(normalize_path(profile_instr.as_path().to_path_buf()));\n+        }\n+        if let Some(ref profile_sample) = sess.opts.unstable_opts.profile_sample_use {\n+            files.push(normalize_path(profile_sample.as_path().to_path_buf()));\n+        }\n+\n         if sess.binary_dep_depinfo() {\n             if let Some(ref backend) = sess.opts.unstable_opts.codegen_backend {\n                 if backend.contains('.') {"}, {"sha": "60b59c04aa95c71364627dda2afe8dedb2c2e0be", "filename": "src/test/run-make/track-pgo-dep-info/Makefile", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/925644ed09689018cd17b3bb6e469520d105e6b8/src%2Ftest%2Frun-make%2Ftrack-pgo-dep-info%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/925644ed09689018cd17b3bb6e469520d105e6b8/src%2Ftest%2Frun-make%2Ftrack-pgo-dep-info%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Ftrack-pgo-dep-info%2FMakefile?ref=925644ed09689018cd17b3bb6e469520d105e6b8", "patch": "@@ -0,0 +1,26 @@\n+# needs-profiler-support\n+# ignore-windows-gnu\n+\n+-include ../../run-make-fulldeps/tools.mk\n+\n+# FIXME(eddyb) provide `HOST_RUSTC` and `TARGET_RUSTC`\n+# instead of hardcoding them everywhere they're needed.\n+ifeq ($(IS_MUSL_HOST),1)\n+ADDITIONAL_ARGS := $(RUSTFLAGS)\n+endif\n+\n+all:\n+\t# Generate PGO profiles\n+\t$(BARE_RUSTC) $(ADDITIONAL_ARGS) -Cprofile-generate=$(TMPDIR)/profiles --out-dir $(TMPDIR) main.rs\n+\t$(TMPDIR)/main\n+\n+\t# Merge profiles\n+\t\"$(LLVM_BIN_DIR)/llvm-profdata\" merge \\\n+\t\t-o \"$(TMPDIR)/merged.profdata\" \\\n+\t\t\"$(TMPDIR)/profiles\" || exit 1\n+\n+\t# Use the profile\n+\t$(RUSTC) -Cprofile-use=$(TMPDIR)/merged.profdata --emit dep-info main.rs\n+\n+\t# Check that profile file is in depinfo\n+\t$(CGREP) \"merged.profdata\" < $(TMPDIR)/main.d"}, {"sha": "f328e4d9d04c31d0d70d16d21a07d1613be9d577", "filename": "src/test/run-make/track-pgo-dep-info/main.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/925644ed09689018cd17b3bb6e469520d105e6b8/src%2Ftest%2Frun-make%2Ftrack-pgo-dep-info%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/925644ed09689018cd17b3bb6e469520d105e6b8/src%2Ftest%2Frun-make%2Ftrack-pgo-dep-info%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Ftrack-pgo-dep-info%2Fmain.rs?ref=925644ed09689018cd17b3bb6e469520d105e6b8", "patch": "@@ -0,0 +1 @@\n+fn main() {}"}]}