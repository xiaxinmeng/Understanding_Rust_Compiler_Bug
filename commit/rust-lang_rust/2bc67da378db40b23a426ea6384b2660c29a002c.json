{"sha": "2bc67da378db40b23a426ea6384b2660c29a002c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiYzY3ZGEzNzhkYjQwYjIzYTQyNmVhNjM4NGIyNjYwYzI5YTAwMmM=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2018-12-09T14:31:12Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2018-12-19T20:17:53Z"}, "message": "proc_macro: Accept `$crate` as an identifier if it comes from the compiler", "tree": {"sha": "e96b2c51937ae33a44fa349f2abe1a042621358b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e96b2c51937ae33a44fa349f2abe1a042621358b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2bc67da378db40b23a426ea6384b2660c29a002c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2bc67da378db40b23a426ea6384b2660c29a002c", "html_url": "https://github.com/rust-lang/rust/commit/2bc67da378db40b23a426ea6384b2660c29a002c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2bc67da378db40b23a426ea6384b2660c29a002c/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a8ef260bef994c1e9d3444356fa9f33c01943c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a8ef260bef994c1e9d3444356fa9f33c01943c1", "html_url": "https://github.com/rust-lang/rust/commit/8a8ef260bef994c1e9d3444356fa9f33c01943c1"}], "stats": {"total": 34, "additions": 34, "deletions": 0}, "files": [{"sha": "ca960cbe41b5d288a7e78aa3a590aa4f122f52dd", "filename": "src/libsyntax_ext/proc_macro_server.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2bc67da378db40b23a426ea6384b2660c29a002c/src%2Flibsyntax_ext%2Fproc_macro_server.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2bc67da378db40b23a426ea6384b2660c29a002c/src%2Flibsyntax_ext%2Fproc_macro_server.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fproc_macro_server.rs?ref=2bc67da378db40b23a426ea6384b2660c29a002c", "patch": "@@ -150,6 +150,8 @@ impl FromInternal<(TokenStream, &'_ ParseSess, &'_ mut Vec<Self>)>\n             Question => op!('?'),\n             SingleQuote => op!('\\''),\n \n+            Ident(ident, false) if ident.name == keywords::DollarCrate.name() =>\n+                tt!(Ident::dollar_crate()),\n             Ident(ident, is_raw) => tt!(Ident::new(ident.name, is_raw)),\n             Lifetime(ident) => {\n                 let ident = ident.without_first_quote();\n@@ -359,6 +361,10 @@ impl Ident {\n         }\n         Ident { sym, is_raw, span }\n     }\n+    fn dollar_crate(span: Span) -> Ident {\n+        // `$crate` is accepted as an ident only if it comes from the compiler.\n+        Ident { sym: keywords::DollarCrate.name(), is_raw: false, span }\n+    }\n }\n \n // FIXME(eddyb) `Literal` should not expose internal `Debug` impls."}, {"sha": "b0727a33332e7e874130c5f7c69ff125438936f8", "filename": "src/test/ui/proc-macro/auxiliary/dollar-crate.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2bc67da378db40b23a426ea6384b2660c29a002c/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fdollar-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2bc67da378db40b23a426ea6384b2660c29a002c/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fdollar-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fauxiliary%2Fdollar-crate.rs?ref=2bc67da378db40b23a426ea6384b2660c29a002c", "patch": "@@ -0,0 +1,12 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::TokenStream;\n+\n+#[proc_macro]\n+pub fn normalize(input: TokenStream) -> TokenStream {\n+    input.into_iter().collect()\n+}"}, {"sha": "b8b1ddd5d1cbb6b6a6f3ce384fde0adf4f372c51", "filename": "src/test/ui/proc-macro/dollar-crate.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2bc67da378db40b23a426ea6384b2660c29a002c/src%2Ftest%2Fui%2Fproc-macro%2Fdollar-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2bc67da378db40b23a426ea6384b2660c29a002c/src%2Ftest%2Fui%2Fproc-macro%2Fdollar-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fdollar-crate.rs?ref=2bc67da378db40b23a426ea6384b2660c29a002c", "patch": "@@ -0,0 +1,16 @@\n+// compile-pass\n+// aux-build:dollar-crate.rs\n+\n+extern crate dollar_crate;\n+\n+type S = u8;\n+\n+macro_rules! check { () => {\n+    dollar_crate::normalize! {\n+        type A = $crate::S;\n+    }\n+}}\n+\n+check!();\n+\n+fn main() {}"}]}