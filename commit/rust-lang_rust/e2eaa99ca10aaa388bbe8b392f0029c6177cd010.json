{"sha": "e2eaa99ca10aaa388bbe8b392f0029c6177cd010", "node_id": "C_kwDOAAsO6NoAKGUyZWFhOTljYTEwYWFhMzg4YmJlOGIzOTJmMDAyOWM2MTc3Y2QwMTA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-18T12:42:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-18T12:42:05Z"}, "message": "Auto merge of #12788 - hasali19:extract-var-mut, r=jonas-schievink\n\nFix extract variable assist for subexpression in mutable borrow\n\nThis checks if the expression is in a mutable borrow and if so makes the extracted variable `mut`.\n\nCloses #12786", "tree": {"sha": "e12f96a61f4da59732437fe0bb0b8ef25bce0296", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e12f96a61f4da59732437fe0bb0b8ef25bce0296"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2eaa99ca10aaa388bbe8b392f0029c6177cd010", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2eaa99ca10aaa388bbe8b392f0029c6177cd010", "html_url": "https://github.com/rust-lang/rust/commit/e2eaa99ca10aaa388bbe8b392f0029c6177cd010", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2eaa99ca10aaa388bbe8b392f0029c6177cd010/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee2d5fed30ecbe0123c2c2f0aab328b6d609a294", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee2d5fed30ecbe0123c2c2f0aab328b6d609a294", "html_url": "https://github.com/rust-lang/rust/commit/ee2d5fed30ecbe0123c2c2f0aab328b6d609a294"}, {"sha": "ea19e703049f60008f1f5ea4c79ac5b0b4bcc986", "url": "https://api.github.com/repos/rust-lang/rust/commits/ea19e703049f60008f1f5ea4c79ac5b0b4bcc986", "html_url": "https://github.com/rust-lang/rust/commit/ea19e703049f60008f1f5ea4c79ac5b0b4bcc986"}], "stats": {"total": 36, "additions": 31, "deletions": 5}, "files": [{"sha": "500db158e6fab177679b8cbaf1543f20d844039b", "filename": "crates/ide-assists/src/handlers/extract_variable.rs", "status": "modified", "additions": 31, "deletions": 5, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/e2eaa99ca10aaa388bbe8b392f0029c6177cd010/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fextract_variable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2eaa99ca10aaa388bbe8b392f0029c6177cd010/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fextract_variable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fextract_variable.rs?ref=e2eaa99ca10aaa388bbe8b392f0029c6177cd010", "patch": "@@ -58,6 +58,12 @@ pub(crate) fn extract_variable(acc: &mut Assists, ctx: &AssistContext) -> Option\n         _ => \"\",\n     };\n \n+    let parent_ref_expr = to_extract.syntax().parent().and_then(ast::RefExpr::cast);\n+    let var_modifier = match parent_ref_expr {\n+        Some(expr) if expr.mut_token().is_some() => \"mut \",\n+        _ => \"\",\n+    };\n+\n     let anchor = Anchor::from(&to_extract)?;\n     let indent = anchor.syntax().prev_sibling_or_token()?.as_token()?.clone();\n     let target = to_extract.syntax().text_range();\n@@ -85,7 +91,7 @@ pub(crate) fn extract_variable(acc: &mut Assists, ctx: &AssistContext) -> Option\n \n             match anchor {\n                 Anchor::Before(_) | Anchor::Replace(_) => {\n-                    format_to!(buf, \"let {} = {}\", var_name, reference_modifier)\n+                    format_to!(buf, \"let {}{} = {}\", var_modifier, var_name, reference_modifier)\n                 }\n                 Anchor::WrapInBlock(_) => {\n                     format_to!(buf, \"{{ let {} = {}\", var_name, reference_modifier)\n@@ -100,8 +106,10 @@ pub(crate) fn extract_variable(acc: &mut Assists, ctx: &AssistContext) -> Option\n                 }\n                 match ctx.config.snippet_cap {\n                     Some(cap) => {\n-                        let snip = buf\n-                            .replace(&format!(\"let {}\", var_name), &format!(\"let $0{}\", var_name));\n+                        let snip = buf.replace(\n+                            &format!(\"let {}{}\", var_modifier, var_name),\n+                            &format!(\"let {}$0{}\", var_modifier, var_name),\n+                        );\n                         edit.replace_snippet(cap, expr_range, snip)\n                     }\n                     None => edit.replace(expr_range, buf),\n@@ -126,8 +134,10 @@ pub(crate) fn extract_variable(acc: &mut Assists, ctx: &AssistContext) -> Option\n             let offset = anchor.syntax().text_range().start();\n             match ctx.config.snippet_cap {\n                 Some(cap) => {\n-                    let snip =\n-                        buf.replace(&format!(\"let {}\", var_name), &format!(\"let $0{}\", var_name));\n+                    let snip = buf.replace(\n+                        &format!(\"let {}{}\", var_modifier, var_name),\n+                        &format!(\"let {}$0{}\", var_modifier, var_name),\n+                    );\n                     edit.insert_snippet(cap, offset, snip)\n                 }\n                 None => edit.insert(offset, buf),\n@@ -1247,6 +1257,22 @@ fn foo() {\n     let local = &S::new();\n     let $0x = &local.sub;\n     x.do_thing();\n+}\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn test_extract_var_for_mutable_borrow() {\n+        check_assist(\n+            extract_variable,\n+            r#\"\n+fn foo() {\n+    let v = &mut $00$0;\n+}\"#,\n+            r#\"\n+fn foo() {\n+    let mut $0var_name = 0;\n+    let v = &mut var_name;\n }\"#,\n         );\n     }"}]}