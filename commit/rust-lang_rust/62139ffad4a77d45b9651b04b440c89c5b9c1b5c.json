{"sha": "62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyMTM5ZmZhZDRhNzdkNDViOTY1MWIwNGI0NDBjODljNWI5YzFiNWM=", "commit": {"author": {"name": "Tyson Nottingham", "email": "tgnottingham@gmail.com", "date": "2021-01-01T22:06:17Z"}, "committer": {"name": "Tyson Nottingham", "email": "tgnottingham@gmail.com", "date": "2021-01-12T19:22:57Z"}, "message": "Remove DepKind::CrateMetadata and pre-allocation of DepNodes\n\nRemove much of the special-case handling around crate metadata\ndependency tracking by replacing `DepKind::CrateMetadata` and the\npre-allocation of corresponding `DepNodes` with on-demand invocation\nof the `crate_hash` query.", "tree": {"sha": "d0fc8cd89acc34f082884682709cc85be11784fb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0fc8cd89acc34f082884682709cc85be11784fb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "html_url": "https://github.com/rust-lang/rust/commit/62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/comments", "author": {"login": "tgnottingham", "id": 3668166, "node_id": "MDQ6VXNlcjM2NjgxNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/3668166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tgnottingham", "html_url": "https://github.com/tgnottingham", "followers_url": "https://api.github.com/users/tgnottingham/followers", "following_url": "https://api.github.com/users/tgnottingham/following{/other_user}", "gists_url": "https://api.github.com/users/tgnottingham/gists{/gist_id}", "starred_url": "https://api.github.com/users/tgnottingham/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tgnottingham/subscriptions", "organizations_url": "https://api.github.com/users/tgnottingham/orgs", "repos_url": "https://api.github.com/users/tgnottingham/repos", "events_url": "https://api.github.com/users/tgnottingham/events{/privacy}", "received_events_url": "https://api.github.com/users/tgnottingham/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tgnottingham", "id": 3668166, "node_id": "MDQ6VXNlcjM2NjgxNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/3668166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tgnottingham", "html_url": "https://github.com/tgnottingham", "followers_url": "https://api.github.com/users/tgnottingham/followers", "following_url": "https://api.github.com/users/tgnottingham/following{/other_user}", "gists_url": "https://api.github.com/users/tgnottingham/gists{/gist_id}", "starred_url": "https://api.github.com/users/tgnottingham/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tgnottingham/subscriptions", "organizations_url": "https://api.github.com/users/tgnottingham/orgs", "repos_url": "https://api.github.com/users/tgnottingham/repos", "events_url": "https://api.github.com/users/tgnottingham/events{/privacy}", "received_events_url": "https://api.github.com/users/tgnottingham/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "497c9a256b1c2961e91565ccc6e0dd3a87a031ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/497c9a256b1c2961e91565ccc6e0dd3a87a031ed", "html_url": "https://github.com/rust-lang/rust/commit/497c9a256b1c2961e91565ccc6e0dd3a87a031ed"}], "stats": {"total": 131, "additions": 24, "deletions": 107}, "files": [{"sha": "95456c07b10aaaa2308de79d753fc716e3b16afc", "filename": "compiler/rustc_incremental/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_incremental%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_incremental%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Flib.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -17,7 +17,6 @@ mod persist;\n pub use assert_dep_graph::assert_dep_graph;\n pub use persist::copy_cgu_workproduct_to_incr_comp_cache_dir;\n pub use persist::delete_workproduct_files;\n-pub use persist::dep_graph_tcx_init;\n pub use persist::finalize_session_directory;\n pub use persist::garbage_collect_session_directories;\n pub use persist::in_incr_comp_dir;"}, {"sha": "0add0c5aa268ed23f060a0877b25229f2a473ca4", "filename": "compiler/rustc_incremental/src/persist/load.rs", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -4,7 +4,6 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_hir::definitions::Definitions;\n use rustc_middle::dep_graph::{PreviousDepGraph, SerializedDepGraph, WorkProduct, WorkProductId};\n use rustc_middle::ty::query::OnDiskCache;\n-use rustc_middle::ty::TyCtxt;\n use rustc_serialize::opaque::Decoder;\n use rustc_serialize::Decodable as RustcDecodable;\n use rustc_session::Session;\n@@ -15,14 +14,6 @@ use super::file_format;\n use super::fs::*;\n use super::work_product;\n \n-pub fn dep_graph_tcx_init(tcx: TyCtxt<'_>) {\n-    if !tcx.dep_graph.is_fully_enabled() {\n-        return;\n-    }\n-\n-    tcx.allocate_metadata_dep_nodes();\n-}\n-\n type WorkProductMap = FxHashMap<WorkProductId, WorkProduct>;\n \n pub enum LoadResult<T> {"}, {"sha": "8821b34b50212d758607017cb5faa0cf31f53f26", "filename": "compiler/rustc_incremental/src/persist/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fmod.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -15,7 +15,6 @@ pub use fs::garbage_collect_session_directories;\n pub use fs::in_incr_comp_dir;\n pub use fs::in_incr_comp_dir_sess;\n pub use fs::prepare_session_directory;\n-pub use load::dep_graph_tcx_init;\n pub use load::load_query_result_cache;\n pub use load::LoadResult;\n pub use load::{load_dep_graph, DepGraphFuture};"}, {"sha": "ead2512d3b2a54eb4f56ac936896c9db0a988512", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -797,12 +797,6 @@ pub fn create_global_ctxt<'tcx>(\n         })\n     });\n \n-    // Do some initialization of the DepGraph that can only be done with the tcx available.\n-    let icx = ty::tls::ImplicitCtxt::new(&gcx);\n-    ty::tls::enter_context(&icx, |_| {\n-        icx.tcx.sess.time(\"dep_graph_tcx_init\", || rustc_incremental::dep_graph_tcx_init(icx.tcx));\n-    });\n-\n     QueryContext(gcx)\n }\n "}, {"sha": "e864f53f73dcefb5d2af203180733ab645145a14", "filename": "compiler/rustc_metadata/src/rmeta/decoder.rs", "status": "modified", "additions": 1, "deletions": 33, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -10,7 +10,7 @@ use rustc_data_structures::captures::Captures;\n use rustc_data_structures::fingerprint::{Fingerprint, FingerprintDecoder};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::svh::Svh;\n-use rustc_data_structures::sync::{AtomicCell, Lock, LockGuard, Lrc, OnceCell};\n+use rustc_data_structures::sync::{Lock, LockGuard, Lrc, OnceCell};\n use rustc_data_structures::unhash::UnhashMap;\n use rustc_errors::ErrorReported;\n use rustc_expand::base::{SyntaxExtension, SyntaxExtensionKind};\n@@ -21,7 +21,6 @@ use rustc_hir::def_id::{CrateNum, DefId, DefIndex, CRATE_DEF_INDEX, LOCAL_CRATE}\n use rustc_hir::definitions::{DefKey, DefPath, DefPathData, DefPathHash};\n use rustc_hir::lang_items;\n use rustc_index::vec::{Idx, IndexVec};\n-use rustc_middle::dep_graph::{self, DepNode, DepNodeExt, DepNodeIndex};\n use rustc_middle::hir::exports::Export;\n use rustc_middle::middle::cstore::{CrateSource, ExternCrate};\n use rustc_middle::middle::cstore::{ForeignModule, LinkagePreference, NativeLib};\n@@ -84,11 +83,6 @@ crate struct CrateMetadata {\n     def_path_hash_map: OnceCell<UnhashMap<DefPathHash, DefIndex>>,\n     /// Used for decoding interpret::AllocIds in a cached & thread-safe manner.\n     alloc_decoding_state: AllocDecodingState,\n-    /// The `DepNodeIndex` of the `DepNode` representing this upstream crate.\n-    /// It is initialized on the first access in `get_crate_dep_node_index()`.\n-    /// Do not access the value directly, as it might not have been initialized yet.\n-    /// The field must always be initialized to `DepNodeIndex::INVALID`.\n-    dep_node_index: AtomicCell<DepNodeIndex>,\n     /// Caches decoded `DefKey`s.\n     def_key_cache: Lock<FxHashMap<DefIndex, DefKey>>,\n     /// Caches decoded `DefPathHash`es.\n@@ -1592,31 +1586,6 @@ impl<'a, 'tcx> CrateMetadataRef<'a> {\n         self.def_path_hash_unlocked(index, &mut def_path_hashes)\n     }\n \n-    /// Get the `DepNodeIndex` corresponding this crate. The result of this\n-    /// method is cached in the `dep_node_index` field.\n-    fn get_crate_dep_node_index(&self, tcx: TyCtxt<'tcx>) -> DepNodeIndex {\n-        let mut dep_node_index = self.dep_node_index.load();\n-\n-        if unlikely!(dep_node_index == DepNodeIndex::INVALID) {\n-            // We have not cached the DepNodeIndex for this upstream crate yet,\n-            // so use the dep-graph to find it out and cache it.\n-            // Note that multiple threads can enter this block concurrently.\n-            // That is fine because the DepNodeIndex remains constant\n-            // throughout the whole compilation session, and multiple stores\n-            // would always write the same value.\n-\n-            let def_path_hash = self.def_path_hash(CRATE_DEF_INDEX);\n-            let dep_node =\n-                DepNode::from_def_path_hash(def_path_hash, dep_graph::DepKind::CrateMetadata);\n-\n-            dep_node_index = tcx.dep_graph.dep_node_index_of(&dep_node);\n-            assert!(dep_node_index != DepNodeIndex::INVALID);\n-            self.dep_node_index.store(dep_node_index);\n-        }\n-\n-        dep_node_index\n-    }\n-\n     /// Imports the source_map from an external crate into the source_map of the crate\n     /// currently being compiled (the \"local crate\").\n     ///\n@@ -1833,7 +1802,6 @@ impl CrateMetadata {\n             source_map_import_info: OnceCell::new(),\n             def_path_hash_map: Default::default(),\n             alloc_decoding_state,\n-            dep_node_index: AtomicCell::new(DepNodeIndex::INVALID),\n             cnum,\n             cnum_map,\n             dependencies,"}, {"sha": "979e70b9e3145e9ae1cff3600ab09de1a6188367", "filename": "compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -44,18 +44,33 @@ macro_rules! provide {\n                 let ($def_id, $other) = def_id_arg.into_args();\n                 assert!(!$def_id.is_local());\n \n-                let $cdata = CStore::from_tcx($tcx).get_crate_data($def_id.krate);\n-\n                 if $tcx.dep_graph.is_fully_enabled() {\n-                    let crate_dep_node_index = $cdata.get_crate_dep_node_index($tcx);\n-                    $tcx.dep_graph.read_index(crate_dep_node_index);\n+                    $tcx.ensure().crate_hash($def_id.krate);\n                 }\n \n+                let $cdata = CStore::from_tcx($tcx).get_crate_data($def_id.krate);\n+\n                 $compute\n             })*\n \n+            // The other external query providers call `crate_hash` in order to register a\n+            // dependency on the crate metadata. The `crate_hash` implementation differs in\n+            // that it doesn't need to do this (and can't, as it would cause a query cycle).\n+            fn crate_hash<'tcx>(\n+                tcx: TyCtxt<'tcx>,\n+                def_id_arg: ty::query::query_keys::crate_hash<'tcx>,\n+            ) -> ty::query::query_values::crate_hash<'tcx> {\n+                let _prof_timer = tcx.prof.generic_activity(\"metadata_decode_entry_crate_hash\");\n+\n+                let (def_id, _) = def_id_arg.into_args();\n+                assert!(!def_id.is_local());\n+\n+                CStore::from_tcx(tcx).get_crate_data(def_id.krate).root.hash\n+            }\n+\n             *providers = Providers {\n                 $($name,)*\n+                crate_hash,\n                 ..*providers\n             };\n         }\n@@ -191,7 +206,6 @@ provide! { <'tcx> tcx, def_id, other, cdata,\n         })\n     }\n     crate_disambiguator => { cdata.root.disambiguator }\n-    crate_hash => { cdata.root.hash }\n     crate_host_hash => { cdata.host_hash }\n     original_crate_name => { cdata.root.name }\n "}, {"sha": "195c00f35350cc628ef19a7cc950b3af251d9b84", "filename": "compiler/rustc_middle/src/dep_graph/dep_node.rs", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -214,17 +214,6 @@ pub mod dep_kind {\n         try_load_from_on_disk_cache: |_, _| {},\n     };\n \n-    // Represents metadata from an extern crate.\n-    pub const CrateMetadata: DepKindStruct = DepKindStruct {\n-        has_params: true,\n-        is_anon: false,\n-        is_eval_always: true,\n-\n-        can_reconstruct_query_key: || true,\n-        force_from_dep_node: |_, dep_node| bug!(\"force_from_dep_node: encountered {:?}\", dep_node),\n-        try_load_from_on_disk_cache: |_, _| {},\n-    };\n-\n     pub const TraitSelect: DepKindStruct = DepKindStruct {\n         has_params: false,\n         is_anon: true,\n@@ -379,9 +368,6 @@ rustc_dep_node_append!([define_dep_nodes!][ <'tcx>\n     // We use this for most things when incr. comp. is turned off.\n     [] Null,\n \n-    // Represents metadata from an extern crate.\n-    [eval_always] CrateMetadata(CrateNum),\n-\n     [anon] TraitSelect,\n \n     [] CompileCodegenUnit(Symbol),"}, {"sha": "50c9a696fb98ec752771554936c0c6c1cfafc748", "filename": "compiler/rustc_middle/src/dep_graph/mod.rs", "status": "modified", "additions": 2, "deletions": 13, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -115,20 +115,9 @@ impl<'tcx> DepContext for TyCtxt<'tcx> {\n         // be removed. https://github.com/rust-lang/rust/issues/62649 is one such\n         // bug that must be fixed before removing this.\n         match dep_node.kind {\n-            DepKind::hir_owner | DepKind::hir_owner_nodes | DepKind::CrateMetadata => {\n+            DepKind::hir_owner | DepKind::hir_owner_nodes => {\n                 if let Some(def_id) = dep_node.extract_def_id(*self) {\n-                    if def_id_corresponds_to_hir_dep_node(*self, def_id.expect_local()) {\n-                        if dep_node.kind == DepKind::CrateMetadata {\n-                            // The `DefPath` has corresponding node,\n-                            // and that node should have been marked\n-                            // either red or green in `data.colors`.\n-                            bug!(\n-                                \"DepNode {:?} should have been \\\n-                             pre-marked as red or green but wasn't.\",\n-                                dep_node\n-                            );\n-                        }\n-                    } else {\n+                    if !def_id_corresponds_to_hir_dep_node(*self, def_id.expect_local()) {\n                         // This `DefPath` does not have a\n                         // corresponding `DepNode` (e.g. a\n                         // struct field), and the ` DefPath`"}, {"sha": "bc15991089e30a7d0fe20b49b00adbdb52095d75", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 2, "deletions": 25, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62139ffad4a77d45b9651b04b440c89c5b9c1b5c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=62139ffad4a77d45b9651b04b440c89c5b9c1b5c", "patch": "@@ -1,7 +1,7 @@\n //! Type context book-keeping.\n \n use crate::arena::Arena;\n-use crate::dep_graph::{self, DepGraph, DepKind, DepNode, DepNodeExt};\n+use crate::dep_graph::DepGraph;\n use crate::hir::exports::ExportMap;\n use crate::ich::{NodeIdHashingMode, StableHashingContext};\n use crate::infer::canonical::{Canonical, CanonicalVarInfo, CanonicalVarInfos};\n@@ -37,8 +37,7 @@ use rustc_data_structures::sync::{self, Lock, Lrc, WorkerLocal};\n use rustc_errors::ErrorReported;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n-use rustc_hir::def_id::{CrateNum, DefId, DefIdMap, LocalDefId};\n-use rustc_hir::def_id::{CRATE_DEF_INDEX, LOCAL_CRATE};\n+use rustc_hir::def_id::{CrateNum, DefId, DefIdMap, LocalDefId, LOCAL_CRATE};\n use rustc_hir::definitions::Definitions;\n use rustc_hir::intravisit::Visitor;\n use rustc_hir::lang_items::LangItem;\n@@ -1315,28 +1314,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         StableHashingContext::ignore_spans(self.sess, krate, self.definitions, &*self.cstore)\n     }\n \n-    // This method makes sure that we have a DepNode and a Fingerprint for\n-    // every upstream crate. It needs to be called once right after the tcx is\n-    // created.\n-    // With full-fledged red/green, the method will probably become unnecessary\n-    // as this will be done on-demand.\n-    pub fn allocate_metadata_dep_nodes(self) {\n-        // We cannot use the query versions of crates() and crate_hash(), since\n-        // those would need the DepNodes that we are allocating here.\n-        for cnum in self.cstore.crates_untracked() {\n-            let def_path_hash = self.def_path_hash(DefId { krate: cnum, index: CRATE_DEF_INDEX });\n-            let dep_node = DepNode::from_def_path_hash(def_path_hash, DepKind::CrateMetadata);\n-            let crate_hash = self.cstore.crate_hash_untracked(cnum);\n-            self.dep_graph.with_task(\n-                dep_node,\n-                self,\n-                crate_hash,\n-                |_, x| x, // No transformation needed\n-                dep_graph::hash_result,\n-            );\n-        }\n-    }\n-\n     pub fn serialize_query_result_cache(self, encoder: &mut FileEncoder) -> FileEncodeResult {\n         self.queries.on_disk_cache.as_ref().map(|c| c.serialize(self, encoder)).unwrap_or(Ok(()))\n     }"}]}