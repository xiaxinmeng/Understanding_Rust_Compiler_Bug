{"sha": "4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjZjdlZmM4ZjdkZjIxNWIwZmY5ZTNlYTE1Yjc4OTBiODRkYjFiNTE=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-04-04T01:54:57Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-04-04T03:24:29Z"}, "message": "rt: Fix bugs in the osmain scheduler", "tree": {"sha": "77e9ae322815a9a749b7116348863eeb64868e34", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/77e9ae322815a9a749b7116348863eeb64868e34"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51", "html_url": "https://github.com/rust-lang/rust/commit/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0e12854edc10070759688b598a3885cbeb82e28", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0e12854edc10070759688b598a3885cbeb82e28", "html_url": "https://github.com/rust-lang/rust/commit/c0e12854edc10070759688b598a3885cbeb82e28"}], "stats": {"total": 19, "additions": 13, "deletions": 6}, "files": [{"sha": "32e34dc9337f3e1c9adc28eb0f433731b0afb12c", "filename": "src/rt/rust_kernel.cpp", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51/src%2Frt%2Frust_kernel.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51/src%2Frt%2Frust_kernel.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_kernel.cpp?ref=4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51", "patch": "@@ -83,11 +83,10 @@ rust_kernel::create_scheduler(rust_sched_launcher_factory *launchfac,\n             // The OS main scheduler may not exit while there are other\n             // schedulers\n             KLOG_(\"Disallowing osmain scheduler to exit\");\n-            sched_lock.unlock();\n-            rust_scheduler *sched = get_scheduler_by_id(osmain_scheduler);\n+            rust_scheduler *sched =\n+                get_scheduler_by_id_nolock(osmain_scheduler);\n             assert(sched != NULL);\n             sched->disallow_exit();\n-            sched_lock.lock();\n         }\n \n         id = max_sched_id++;\n@@ -106,6 +105,12 @@ rust_kernel::create_scheduler(rust_sched_launcher_factory *launchfac,\n rust_scheduler *\n rust_kernel::get_scheduler_by_id(rust_sched_id id) {\n     scoped_lock with(sched_lock);\n+    return get_scheduler_by_id_nolock(id);\n+}\n+\n+rust_scheduler *\n+rust_kernel::get_scheduler_by_id_nolock(rust_sched_id id) {\n+    sched_lock.must_have_lock();\n     sched_map::iterator iter = sched_table.find(id);\n     if (iter != sched_table.end()) {\n         return iter->second;\n@@ -137,6 +142,7 @@ rust_kernel::wait_for_schedulers()\n     while (!sched_table.empty()) {\n         while (!join_list.empty()) {\n             rust_sched_id id = join_list.back();\n+            KLOG_(\"Deleting scheduler %d\", id);\n             join_list.pop_back();\n             sched_map::iterator iter = sched_table.find(id);\n             I(this, iter != sched_table.end());\n@@ -146,12 +152,11 @@ rust_kernel::wait_for_schedulers()\n             delete sched;\n             if (sched_table.size() == 1) {\n                 KLOG_(\"Allowing osmain scheduler to exit\");\n-                sched_lock.unlock();\n                 // It's only the osmain scheduler left. Tell it to exit\n-                rust_scheduler *sched = get_scheduler_by_id(osmain_scheduler);\n+                rust_scheduler *sched =\n+                    get_scheduler_by_id_nolock(osmain_scheduler);\n                 assert(sched != NULL);\n                 sched->allow_exit();\n-                sched_lock.lock();\n             }\n         }\n         if (!sched_table.empty()) {"}, {"sha": "52399cf4e2caf4e5abf78250533bceace645875f", "filename": "src/rt/rust_kernel.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51/src%2Frt%2Frust_kernel.h", "raw_url": "https://github.com/rust-lang/rust/raw/4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51/src%2Frt%2Frust_kernel.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_kernel.h?ref=4cf7efc8f7df215b0ff9e3ea15b7890b84db1b51", "patch": "@@ -57,6 +57,8 @@ class rust_kernel {\n     // on the main thread\n     rust_sched_driver *osmain_driver;\n \n+    rust_scheduler* get_scheduler_by_id_nolock(rust_sched_id id);\n+\n public:\n \n     struct rust_env *env;"}]}