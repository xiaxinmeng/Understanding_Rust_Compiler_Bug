{"sha": "067d87e8a9f170452a5554dcc7b3e264cc12142b", "node_id": "C_kwDOAAsO6NoAKDA2N2Q4N2U4YTlmMTcwNDUyYTU1NTRkY2M3YjNlMjY0Y2MxMjE0MmI", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-12-09T17:04:32Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-12-09T17:04:32Z"}, "message": "Remove some allocs", "tree": {"sha": "f9382349ca9500fdd56fcfdf1f684ee730faf91c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f9382349ca9500fdd56fcfdf1f684ee730faf91c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/067d87e8a9f170452a5554dcc7b3e264cc12142b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/067d87e8a9f170452a5554dcc7b3e264cc12142b", "html_url": "https://github.com/rust-lang/rust/commit/067d87e8a9f170452a5554dcc7b3e264cc12142b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/067d87e8a9f170452a5554dcc7b3e264cc12142b/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6df9bd42f44c5f70903021f83c6ada0c6e3c6916", "url": "https://api.github.com/repos/rust-lang/rust/commits/6df9bd42f44c5f70903021f83c6ada0c6e3c6916", "html_url": "https://github.com/rust-lang/rust/commit/6df9bd42f44c5f70903021f83c6ada0c6e3c6916"}], "stats": {"total": 7, "additions": 5, "deletions": 2}, "files": [{"sha": "9f68b800a55ebd8571ef5654c1e3452fcb36f8e2", "filename": "crates/hir_def/src/resolver.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/067d87e8a9f170452a5554dcc7b3e264cc12142b/crates%2Fhir_def%2Fsrc%2Fresolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/067d87e8a9f170452a5554dcc7b3e264cc12142b/crates%2Fhir_def%2Fsrc%2Fresolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fresolver.rs?ref=067d87e8a9f170452a5554dcc7b3e264cc12142b", "patch": "@@ -8,7 +8,7 @@ use hir_expand::{\n };\n use indexmap::IndexMap;\n use rustc_hash::FxHashSet;\n-use smallvec::SmallVec;\n+use smallvec::{smallvec, SmallVec};\n \n use crate::{\n     body::scope::{ExprScopes, ScopeId},\n@@ -567,6 +567,8 @@ pub fn resolver_for_scope(\n     let mut r = owner.resolver(db);\n     let scopes = db.expr_scopes(owner);\n     let scope_chain = scopes.scope_chain(scope_id).collect::<Vec<_>>();\n+    r.scopes.reserve(scope_chain.len());\n+\n     for scope in scope_chain.into_iter().rev() {\n         if let Some(block) = scopes.block(scope) {\n             if let Some(def_map) = db.block_def_map(block) {\n@@ -739,12 +741,13 @@ pub trait HasResolver: Copy {\n impl HasResolver for ModuleId {\n     fn resolver(self, db: &dyn DefDatabase) -> Resolver {\n         let mut def_map = self.def_map(db);\n-        let mut modules = vec![(def_map.clone(), self.local_id)];\n+        let mut modules: SmallVec<[_; 2]> = smallvec![(def_map.clone(), self.local_id)];\n         while let Some(parent) = def_map.parent() {\n             def_map = parent.def_map(db);\n             modules.push((def_map.clone(), parent.local_id));\n         }\n         let mut resolver = Resolver::default();\n+        resolver.scopes.reserve(modules.len());\n         for (def_map, module) in modules.into_iter().rev() {\n             resolver = resolver.push_module_scope(def_map, module);\n         }"}]}