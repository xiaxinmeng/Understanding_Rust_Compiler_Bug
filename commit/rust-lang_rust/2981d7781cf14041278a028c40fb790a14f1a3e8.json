{"sha": "2981d7781cf14041278a028c40fb790a14f1a3e8", "node_id": "C_kwDOAAsO6NoAKDI5ODFkNzc4MWNmMTQwNDEyNzhhMDI4YzQwZmI3OTBhMTRmMWEzZTg", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-03-30T12:07:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-30T12:07:00Z"}, "message": "Rollup merge of #109509 - ehuss:overlapping-tests, r=Mark-Simulacrum\n\ncompiletest: Don't allow tests with overlapping prefix names\n\nSome tests will delete their output directory before starting. The output directory is based on the test names. If one test is the prefix of another test, then when that test starts, it could try to delete the output directory of the other test with the longer path, or otherwise clash with it while the two tests are trying to create/delete/modify the same directory.\n\nIn practice, this manifested as a random error on macOS where two tests were trying to create/delete/create `rustdoc/primitive` and `rustdoc/primitive/no_std`, which resulted in an EINVAL (InvalidInput) error.\n\nThis renames some of the offending tests, adds `compiletest-ignore-dir` to prevent compiletest from processing some files, and adds a check to prevent this from happening in the future.\n\nFixes #109397", "tree": {"sha": "33a349b2c2f3088e91b65ff94e7126b91af34674", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33a349b2c2f3088e91b65ff94e7126b91af34674"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2981d7781cf14041278a028c40fb790a14f1a3e8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkJXtkCRBK7hj4Ov3rIwAAycYIAKHsjUt5EBJ66bNJrC4qvZWt\nRRixGdW3GfjcWRrtXIrwuWW8x9i1Y0DB36Q867VBmaNSDsoGsJbUlZIuAPI42xDg\njkGO0PraB35EY0XDYOPF3DLL0UkB5/UCNL/95O0kzV0GYR/qRuKjjzA6aKNQys+T\n4OweRuerP3nssZhX57ujgWhCgr2haUQtKCpNbOeU3KWlgpJvKJfHWQjmDyZmup/+\nC63Xz6cQsxGW0HUUvGk8CMXIktwX3wtT+VlQSEL8VAwVYSV4G+fBBQIfg8zVdDPI\nnSEFqTKnWWXhPDg8jrgV2yzEIba6lgMVmScEERNt7aLcs+10Tc94TlrpL15/U6A=\n=PmE+\n-----END PGP SIGNATURE-----\n", "payload": "tree 33a349b2c2f3088e91b65ff94e7126b91af34674\nparent d6f27401f12f02876aa6fe53139b030033f37e5e\nparent 1692d0c142985a01a2770da8654912dc40342412\nauthor Yuki Okushi <jtitor@2k36.org> 1680178020 +0900\ncommitter GitHub <noreply@github.com> 1680178020 +0900\n\nRollup merge of #109509 - ehuss:overlapping-tests, r=Mark-Simulacrum\n\ncompiletest: Don't allow tests with overlapping prefix names\n\nSome tests will delete their output directory before starting. The output directory is based on the test names. If one test is the prefix of another test, then when that test starts, it could try to delete the output directory of the other test with the longer path, or otherwise clash with it while the two tests are trying to create/delete/modify the same directory.\n\nIn practice, this manifested as a random error on macOS where two tests were trying to create/delete/create `rustdoc/primitive` and `rustdoc/primitive/no_std`, which resulted in an EINVAL (InvalidInput) error.\n\nThis renames some of the offending tests, adds `compiletest-ignore-dir` to prevent compiletest from processing some files, and adds a check to prevent this from happening in the future.\n\nFixes #109397\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2981d7781cf14041278a028c40fb790a14f1a3e8", "html_url": "https://github.com/rust-lang/rust/commit/2981d7781cf14041278a028c40fb790a14f1a3e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2981d7781cf14041278a028c40fb790a14f1a3e8/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6f27401f12f02876aa6fe53139b030033f37e5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6f27401f12f02876aa6fe53139b030033f37e5e", "html_url": "https://github.com/rust-lang/rust/commit/d6f27401f12f02876aa6fe53139b030033f37e5e"}, {"sha": "1692d0c142985a01a2770da8654912dc40342412", "url": "https://api.github.com/repos/rust-lang/rust/commits/1692d0c142985a01a2770da8654912dc40342412", "html_url": "https://github.com/rust-lang/rust/commit/1692d0c142985a01a2770da8654912dc40342412"}], "stats": {"total": 37, "additions": 35, "deletions": 2}, "files": [{"sha": "7048b0e08bbfd0e82b020ccf3175b1617ad347af", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 35, "deletions": 2, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=2981d7781cf14041278a028c40fb790a14f1a3e8", "patch": "@@ -12,6 +12,7 @@ use build_helper::git::{get_git_modified_files, get_git_untracked_files};\n use core::panic;\n use getopts::Options;\n use lazycell::LazyCell;\n+use std::collections::BTreeSet;\n use std::ffi::OsString;\n use std::fs;\n use std::io::{self, ErrorKind};\n@@ -409,7 +410,9 @@ pub fn run_tests(config: Config) {\n \n     let mut tests = Vec::new();\n     for c in &configs {\n-        make_tests(c, &mut tests);\n+        let mut found_paths = BTreeSet::new();\n+        make_tests(c, &mut tests, &mut found_paths);\n+        check_overlapping_tests(&found_paths);\n     }\n \n     tests.sort_by(|a, b| a.desc.name.as_slice().cmp(&b.desc.name.as_slice()));\n@@ -535,7 +538,11 @@ pub fn test_opts(config: &Config) -> test::TestOpts {\n     }\n }\n \n-pub fn make_tests(config: &Config, tests: &mut Vec<test::TestDescAndFn>) {\n+pub fn make_tests(\n+    config: &Config,\n+    tests: &mut Vec<test::TestDescAndFn>,\n+    found_paths: &mut BTreeSet<PathBuf>,\n+) {\n     debug!(\"making tests from {:?}\", config.src_base.display());\n     let inputs = common_inputs_stamp(config);\n     let modified_tests = modified_tests(config, &config.src_base).unwrap_or_else(|err| {\n@@ -547,6 +554,7 @@ pub fn make_tests(config: &Config, tests: &mut Vec<test::TestDescAndFn>) {\n         &PathBuf::new(),\n         &inputs,\n         tests,\n+        found_paths,\n         &modified_tests,\n     )\n     .unwrap_or_else(|_| panic!(\"Could not read tests from {}\", config.src_base.display()));\n@@ -617,6 +625,7 @@ fn collect_tests_from_dir(\n     relative_dir_path: &Path,\n     inputs: &Stamp,\n     tests: &mut Vec<test::TestDescAndFn>,\n+    found_paths: &mut BTreeSet<PathBuf>,\n     modified_tests: &Vec<PathBuf>,\n ) -> io::Result<()> {\n     // Ignore directories that contain a file named `compiletest-ignore-dir`.\n@@ -650,6 +659,8 @@ fn collect_tests_from_dir(\n         let file_name = file.file_name();\n         if is_test(&file_name) && (!config.only_modified || modified_tests.contains(&file_path)) {\n             debug!(\"found test file: {:?}\", file_path.display());\n+            let rel_test_path = relative_dir_path.join(file_path.file_stem().unwrap());\n+            found_paths.insert(rel_test_path);\n             let paths =\n                 TestPaths { file: file_path, relative_dir: relative_dir_path.to_path_buf() };\n \n@@ -664,6 +675,7 @@ fn collect_tests_from_dir(\n                     &relative_file_path,\n                     inputs,\n                     tests,\n+                    found_paths,\n                     modified_tests,\n                 )?;\n             }\n@@ -1079,3 +1091,24 @@ fn extract_lldb_version(full_version_line: &str) -> Option<(u32, bool)> {\n fn not_a_digit(c: char) -> bool {\n     !c.is_digit(10)\n }\n+\n+fn check_overlapping_tests(found_paths: &BTreeSet<PathBuf>) {\n+    let mut collisions = Vec::new();\n+    for path in found_paths {\n+        for ancestor in path.ancestors().skip(1) {\n+            if found_paths.contains(ancestor) {\n+                collisions.push((path, ancestor.clone()));\n+            }\n+        }\n+    }\n+    if !collisions.is_empty() {\n+        let collisions: String = collisions\n+            .into_iter()\n+            .map(|(path, check_parent)| format!(\"test {path:?} clashes with {check_parent:?}\\n\"))\n+            .collect();\n+        panic!(\n+            \"{collisions}\\n\\\n+            Tests cannot have overlapping names. Make sure they use unique prefixes.\"\n+        );\n+    }\n+}"}, {"sha": "516c7c0c6fe9bd40da798b32a95b1b6998ed672c", "filename": "tests/rustdoc/primitive/primitive.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Frustdoc%2Fprimitive%2Fprimitive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Frustdoc%2Fprimitive%2Fprimitive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fprimitive%2Fprimitive.rs?ref=2981d7781cf14041278a028c40fb790a14f1a3e8", "previous_filename": "tests/rustdoc/primitive.rs"}, {"sha": "5407fb6dd28040e099e56116c80fb4bd91b498a8", "filename": "tests/ui/impl-trait/multiple-lifetimes/multiple-lifetimes.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fimpl-trait%2Fmultiple-lifetimes%2Fmultiple-lifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fimpl-trait%2Fmultiple-lifetimes%2Fmultiple-lifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fmultiple-lifetimes%2Fmultiple-lifetimes.rs?ref=2981d7781cf14041278a028c40fb790a14f1a3e8", "previous_filename": "tests/ui/impl-trait/multiple-lifetimes.rs"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "tests/ui/modules_and_files_visibility/mod_file_disambig_aux/compiletest-ignore-dir", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fmodules_and_files_visibility%2Fmod_file_disambig_aux%2Fcompiletest-ignore-dir", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fmodules_and_files_visibility%2Fmod_file_disambig_aux%2Fcompiletest-ignore-dir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodules_and_files_visibility%2Fmod_file_disambig_aux%2Fcompiletest-ignore-dir?ref=2981d7781cf14041278a028c40fb790a14f1a3e8"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "tests/ui/non_modrs_mods_and_inline_mods/x/y/z/compiletest-ignore-dir", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fnon_modrs_mods_and_inline_mods%2Fx%2Fy%2Fz%2Fcompiletest-ignore-dir", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fnon_modrs_mods_and_inline_mods%2Fx%2Fy%2Fz%2Fcompiletest-ignore-dir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnon_modrs_mods_and_inline_mods%2Fx%2Fy%2Fz%2Fcompiletest-ignore-dir?ref=2981d7781cf14041278a028c40fb790a14f1a3e8"}, {"sha": "87064c6a42b117b589b0f0d545a277012053a9b2", "filename": "tests/ui/use/use-mod/use-mod.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fuse%2Fuse-mod%2Fuse-mod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fuse%2Fuse-mod%2Fuse-mod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse%2Fuse-mod%2Fuse-mod.rs?ref=2981d7781cf14041278a028c40fb790a14f1a3e8", "previous_filename": "tests/ui/use/use-mod.rs"}, {"sha": "0cae5eb14aeebaccfde6421ff15258c5144aae8d", "filename": "tests/ui/use/use-mod/use-mod.stderr", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fuse%2Fuse-mod%2Fuse-mod.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fuse%2Fuse-mod%2Fuse-mod.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse%2Fuse-mod%2Fuse-mod.stderr?ref=2981d7781cf14041278a028c40fb790a14f1a3e8", "previous_filename": "tests/ui/use/use-mod.stderr"}, {"sha": "1beee4a514379f3f3ccf3273a2f4f6d159adfcac", "filename": "tests/ui/use/use.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fuse%2Fuse.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2981d7781cf14041278a028c40fb790a14f1a3e8/tests%2Fui%2Fuse%2Fuse.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse%2Fuse.rs?ref=2981d7781cf14041278a028c40fb790a14f1a3e8", "previous_filename": "tests/ui/use.rs"}]}