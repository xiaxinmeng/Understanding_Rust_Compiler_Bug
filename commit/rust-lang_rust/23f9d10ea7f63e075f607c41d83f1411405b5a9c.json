{"sha": "23f9d10ea7f63e075f607c41d83f1411405b5a9c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIzZjlkMTBlYTdmNjNlMDc1ZjYwN2M0MWQ4M2YxNDExNDA1YjVhOWM=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-01-19T19:04:40Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-02-19T16:51:57Z"}, "message": "Make encode_query_results more generic.", "tree": {"sha": "da6007c3aaf48bb75719be568030598030694bb5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da6007c3aaf48bb75719be568030598030694bb5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/23f9d10ea7f63e075f607c41d83f1411405b5a9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/23f9d10ea7f63e075f607c41d83f1411405b5a9c", "html_url": "https://github.com/rust-lang/rust/commit/23f9d10ea7f63e075f607c41d83f1411405b5a9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/23f9d10ea7f63e075f607c41d83f1411405b5a9c/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24dbb61e5895e0f1433182f17d34eda1c94b130f", "url": "https://api.github.com/repos/rust-lang/rust/commits/24dbb61e5895e0f1433182f17d34eda1c94b130f", "html_url": "https://github.com/rust-lang/rust/commit/24dbb61e5895e0f1433182f17d34eda1c94b130f"}], "stats": {"total": 16, "additions": 9, "deletions": 7}, "files": [{"sha": "c71de7f4cd706be9a0ea0d2e990f7237c0498d08", "filename": "compiler/rustc_middle/src/ty/query/on_disk_cache.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/23f9d10ea7f63e075f607c41d83f1411405b5a9c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23f9d10ea7f63e075f607c41d83f1411405b5a9c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs?ref=23f9d10ea7f63e075f607c41d83f1411405b5a9c", "patch": "@@ -3,7 +3,6 @@ use crate::mir::interpret::{AllocDecodingSession, AllocDecodingState};\n use crate::mir::{self, interpret};\n use crate::ty::codec::{RefDecodable, TyDecoder, TyEncoder};\n use crate::ty::context::TyCtxt;\n-use crate::ty::query::QueryCtxt;\n use crate::ty::{self, Ty};\n use rustc_data_structures::fingerprint::{Fingerprint, FingerprintDecoder, FingerprintEncoder};\n use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexSet};\n@@ -15,6 +14,8 @@ use rustc_hir::def_id::{CrateNum, DefId, DefIndex, LocalDefId, LOCAL_CRATE};\n use rustc_hir::definitions::DefPathHash;\n use rustc_hir::definitions::Definitions;\n use rustc_index::vec::{Idx, IndexVec};\n+use rustc_query_system::dep_graph::DepContext;\n+use rustc_query_system::query::QueryContext;\n use rustc_serialize::{\n     opaque::{self, FileEncodeResult, FileEncoder},\n     Decodable, Decoder, Encodable, Encoder,\n@@ -1215,18 +1216,19 @@ impl<'a> Decodable<opaque::Decoder<'a>> for IntEncodedWithFixedSize {\n     }\n }\n \n-pub fn encode_query_results<'a, 'tcx, Q>(\n-    tcx: QueryCtxt<'tcx>,\n+pub fn encode_query_results<'a, 'tcx, CTX, Q>(\n+    tcx: CTX,\n     encoder: &mut CacheEncoder<'a, 'tcx, FileEncoder>,\n     query_result_index: &mut EncodedQueryResultIndex,\n ) -> FileEncodeResult\n where\n-    Q: super::QueryDescription<QueryCtxt<'tcx>> + super::QueryAccessors<QueryCtxt<'tcx>>,\n+    CTX: QueryContext + 'tcx,\n+    Q: super::QueryDescription<CTX> + super::QueryAccessors<CTX>,\n     Q::Value: Encodable<CacheEncoder<'a, 'tcx, FileEncoder>>,\n {\n     let _timer = tcx\n-        .sess\n-        .prof\n+        .dep_context()\n+        .profiler()\n         .extra_verbose_generic_activity(\"encode_query_results_for\", std::any::type_name::<Q>());\n \n     assert!(Q::query_state(tcx).all_inactive());"}, {"sha": "53bac4181e67b091c3bb8c73ac842f821eaaf093", "filename": "compiler/rustc_middle/src/ty/query/plumbing.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/23f9d10ea7f63e075f607c41d83f1411405b5a9c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23f9d10ea7f63e075f607c41d83f1411405b5a9c/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fplumbing.rs?ref=23f9d10ea7f63e075f607c41d83f1411405b5a9c", "patch": "@@ -251,7 +251,7 @@ impl<'tcx> QueryCtxt<'tcx> {\n         macro_rules! encode_queries {\n             ($($query:ident,)*) => {\n                 $(\n-                    on_disk_cache::encode_query_results::<ty::query::queries::$query<'_>>(\n+                    on_disk_cache::encode_query_results::<_, ty::query::queries::$query<'_>>(\n                         self,\n                         encoder,\n                         query_result_index"}]}