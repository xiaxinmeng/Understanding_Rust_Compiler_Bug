{"sha": "a6133206d1614624bbb51650d33fae04d70bc21a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2MTMzMjA2ZDE2MTQ2MjRiYmI1MTY1MGQzM2ZhZTA0ZDcwYmMyMWE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-09T10:19:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-09T10:19:26Z"}, "message": "Merge #3527\n\n3527: Simplify r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "461dd502837fe3091e0057f31faa1515fca1ca49", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/461dd502837fe3091e0057f31faa1515fca1ca49"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6133206d1614624bbb51650d33fae04d70bc21a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeZhguCRBK7hj4Ov3rIwAAdHIIALJXS60yPVTjw6+tKgi6UqUq\nx+cL7xfgeBHYMrRmG2LhTvpZ7OqGyuIk52de2maim8MPhJJiqbcVoYvfTVM4sWNa\ncDkoJNM0WE/tAMlRLRA4XDeYeo+iWeFh0jXR+aeaYhwBgo0VBZaUyTnwiGkTBC5c\nJjReVlyP8UCE/7HtvO9qgcrMhuuvSVpHZmmIiS1FXmQqUS8dQkoSLxPxn8maL5E4\nURdcfdf+h4ukS4FWlwlWI9XC5XrpHKjteq0nrPuIFyYJnh8BpxjIHniHTnoT7E5Z\nK5hn5YjkwvRZnNhzxRDJkp7rGBR1Ol69Pzh3tmIjRD80ymynrbRivpYgb82IqU8=\n=DNNQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 461dd502837fe3091e0057f31faa1515fca1ca49\nparent 0dbd8ff59b854570329c325431126a078505e5f5\nparent 100cbc57ce2bd903ecab7d8bfb0abf7777076510\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1583749166 +0000\ncommitter GitHub <noreply@github.com> 1583749166 +0000\n\nMerge #3527\n\n3527: Simplify r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6133206d1614624bbb51650d33fae04d70bc21a", "html_url": "https://github.com/rust-lang/rust/commit/a6133206d1614624bbb51650d33fae04d70bc21a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6133206d1614624bbb51650d33fae04d70bc21a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0dbd8ff59b854570329c325431126a078505e5f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/0dbd8ff59b854570329c325431126a078505e5f5", "html_url": "https://github.com/rust-lang/rust/commit/0dbd8ff59b854570329c325431126a078505e5f5"}, {"sha": "100cbc57ce2bd903ecab7d8bfb0abf7777076510", "url": "https://api.github.com/repos/rust-lang/rust/commits/100cbc57ce2bd903ecab7d8bfb0abf7777076510", "html_url": "https://github.com/rust-lang/rust/commit/100cbc57ce2bd903ecab7d8bfb0abf7777076510"}], "stats": {"total": 93, "additions": 37, "deletions": 56}, "files": [{"sha": "b77640b2bc67e8b33c447691c495ee5682a77ee8", "filename": "crates/ra_db/src/input.rs", "status": "modified", "additions": 21, "deletions": 38, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_db%2Fsrc%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_db%2Fsrc%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Finput.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -6,7 +6,7 @@\n //! actual IO. See `vfs` and `project_model` in the `rust-analyzer` crate for how\n //! actual IO is done and lowered to input.\n \n-use std::{fmt, str::FromStr};\n+use std::{fmt, ops, str::FromStr};\n \n use ra_cfg::CfgOptions;\n use ra_syntax::SmolStr;\n@@ -111,8 +111,8 @@ pub struct CrateData {\n     /// This actual crate name can be different in a particular dependent crate\n     /// or may even be missing for some cases, such as a dummy crate for the code snippet.\n     pub display_name: Option<String>,\n-    cfg_options: CfgOptions,\n-    env: Env,\n+    pub cfg_options: CfgOptions,\n+    pub env: Env,\n     pub dependencies: Vec<Dependency>,\n }\n \n@@ -142,17 +142,20 @@ impl CrateGraph {\n         cfg_options: CfgOptions,\n         env: Env,\n     ) -> CrateId {\n-        let data = CrateData::new(file_id, edition, display_name, cfg_options, env);\n+        let data = CrateData {\n+            root_file_id: file_id,\n+            edition,\n+            display_name,\n+            cfg_options,\n+            env,\n+            dependencies: Vec::new(),\n+        };\n         let crate_id = CrateId(self.arena.len() as u32);\n         let prev = self.arena.insert(crate_id, data);\n         assert!(prev.is_none());\n         crate_id\n     }\n \n-    pub fn cfg_options(&self, crate_id: CrateId) -> &CfgOptions {\n-        &self.arena[&crate_id].cfg_options\n-    }\n-\n     pub fn add_dep(\n         &mut self,\n         from: CrateId,\n@@ -174,10 +177,6 @@ impl CrateGraph {\n         self.arena.keys().copied()\n     }\n \n-    pub fn crate_data(&self, crate_id: &CrateId) -> &CrateData {\n-        &self.arena[crate_id]\n-    }\n-\n     // FIXME: this only finds one crate with the given root; we could have multiple\n     pub fn crate_id_for_crate_root(&self, file_id: FileId) -> Option<CrateId> {\n         let (&crate_id, _) =\n@@ -207,8 +206,8 @@ impl CrateGraph {\n             return false;\n         }\n \n-        for dep in &self.crate_data(&from).dependencies {\n-            let crate_id = dep.crate_id();\n+        for dep in &self[from].dependencies {\n+            let crate_id = dep.crate_id;\n             if crate_id == target {\n                 return true;\n             }\n@@ -221,30 +220,20 @@ impl CrateGraph {\n     }\n }\n \n+impl ops::Index<CrateId> for CrateGraph {\n+    type Output = CrateData;\n+    fn index(&self, crate_id: CrateId) -> &CrateData {\n+        &self.arena[&crate_id]\n+    }\n+}\n+\n impl CrateId {\n     pub fn shift(self, amount: u32) -> CrateId {\n         CrateId(self.0 + amount)\n     }\n }\n \n impl CrateData {\n-    fn new(\n-        root_file_id: FileId,\n-        edition: Edition,\n-        display_name: Option<String>,\n-        cfg_options: CfgOptions,\n-        env: Env,\n-    ) -> CrateData {\n-        CrateData {\n-            root_file_id,\n-            edition,\n-            display_name,\n-            dependencies: Vec::new(),\n-            cfg_options,\n-            env,\n-        }\n-    }\n-\n     fn add_dep(&mut self, name: SmolStr, crate_id: CrateId) {\n         self.dependencies.push(Dependency { name, crate_id })\n     }\n@@ -272,12 +261,6 @@ impl fmt::Display for Edition {\n     }\n }\n \n-impl Dependency {\n-    pub fn crate_id(&self) -> CrateId {\n-        self.crate_id\n-    }\n-}\n-\n #[derive(Debug)]\n pub struct ParseEditionError {\n     invalid_input: String,\n@@ -376,7 +359,7 @@ mod tests {\n             .add_dep(crate1, CrateName::normalize_dashes(\"crate-name-with-dashes\"), crate2)\n             .is_ok());\n         assert_eq!(\n-            graph.crate_data(&crate1).dependencies,\n+            graph[crate1].dependencies,\n             vec![Dependency { crate_id: crate2, name: \"crate_name_with_dashes\".into() }]\n         );\n     }"}, {"sha": "41d4e2ed3ed199e710d51c3e69c60731cbc25a0e", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -54,12 +54,11 @@ pub struct CrateDependency {\n \n impl Crate {\n     pub fn dependencies(self, db: &impl DefDatabase) -> Vec<CrateDependency> {\n-        db.crate_graph()\n-            .crate_data(&self.id)\n+        db.crate_graph()[self.id]\n             .dependencies\n             .iter()\n             .map(|dep| {\n-                let krate = Crate { id: dep.crate_id() };\n+                let krate = Crate { id: dep.crate_id };\n                 let name = dep.as_name();\n                 CrateDependency { krate, name }\n             })\n@@ -72,7 +71,7 @@ impl Crate {\n         crate_graph\n             .iter()\n             .filter(|&krate| {\n-                crate_graph.crate_data(&krate).dependencies.iter().any(|it| it.crate_id == self.id)\n+                crate_graph[krate].dependencies.iter().any(|it| it.crate_id == self.id)\n             })\n             .map(|id| Crate { id })\n             .collect()\n@@ -84,11 +83,11 @@ impl Crate {\n     }\n \n     pub fn root_file(self, db: &impl DefDatabase) -> FileId {\n-        db.crate_graph().crate_data(&self.id).root_file_id\n+        db.crate_graph()[self.id].root_file_id\n     }\n \n     pub fn edition(self, db: &impl DefDatabase) -> Edition {\n-        db.crate_graph().crate_data(&self.id).edition\n+        db.crate_graph()[self.id].edition\n     }\n \n     pub fn all(db: &impl DefDatabase) -> Vec<Crate> {"}, {"sha": "07ca74ec3d8cd46da5f307816b6da51da8bbfd5c", "filename": "crates/ra_hir_def/src/find_path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Ffind_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Ffind_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Ffind_path.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -176,7 +176,7 @@ fn find_importable_locations(\n     // directly (only through reexports in direct dependencies).\n     for krate in Some(from.krate)\n         .into_iter()\n-        .chain(crate_graph.crate_data(&from.krate).dependencies.iter().map(|dep| dep.crate_id))\n+        .chain(crate_graph[from.krate].dependencies.iter().map(|dep| dep.crate_id))\n     {\n         result.extend(\n             importable_locations_in_crate(db, item, krate)"}, {"sha": "6de49730e8b75f62d0235846469d78d08fab5df7", "filename": "crates/ra_hir_def/src/lang_item.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Flang_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Flang_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Flang_item.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -116,8 +116,7 @@ impl LangItems {\n         if let Some(target) = start_crate_target {\n             return Some(*target);\n         }\n-        db.crate_graph()\n-            .crate_data(&start_crate)\n+        db.crate_graph()[start_crate]\n             .dependencies\n             .iter()\n             .find_map(|dep| db.lang_item(dep.crate_id, item.clone()))"}, {"sha": "066b43ef9a596cfe68a002897552239949b8c17b", "filename": "crates/ra_hir_def/src/nameres.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -179,7 +179,7 @@ impl CrateDefMap {\n     pub(crate) fn crate_def_map_query(db: &impl DefDatabase, krate: CrateId) -> Arc<CrateDefMap> {\n         let _p = profile(\"crate_def_map_query\");\n         let def_map = {\n-            let edition = db.crate_graph().crate_data(&krate).edition;\n+            let edition = db.crate_graph()[krate].edition;\n             let mut modules: Arena<LocalModuleId, ModuleData> = Arena::default();\n             let root = modules.alloc(ModuleData::default());\n             CrateDefMap {"}, {"sha": "d0459d9b099b1bc1e3b0e3f9a3bf5aed88af9520", "filename": "crates/ra_hir_def/src/nameres/collector.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -34,7 +34,7 @@ pub(super) fn collect_defs(db: &impl DefDatabase, mut def_map: CrateDefMap) -> C\n     let crate_graph = db.crate_graph();\n \n     // populate external prelude\n-    for dep in &crate_graph.crate_data(&def_map.krate).dependencies {\n+    for dep in &crate_graph[def_map.krate].dependencies {\n         let dep_def_map = db.crate_def_map(dep.crate_id);\n         log::debug!(\"crate dep {:?} -> {:?}\", dep.name, dep.crate_id);\n         def_map.extern_prelude.insert(\n@@ -51,7 +51,7 @@ pub(super) fn collect_defs(db: &impl DefDatabase, mut def_map: CrateDefMap) -> C\n         }\n     }\n \n-    let cfg_options = crate_graph.cfg_options(def_map.krate);\n+    let cfg_options = &crate_graph[def_map.krate].cfg_options;\n \n     let mut collector = DefCollector {\n         db,\n@@ -128,7 +128,7 @@ where\n     DB: DefDatabase,\n {\n     fn collect(&mut self) {\n-        let file_id = self.db.crate_graph().crate_data(&self.def_map.krate).root_file_id;\n+        let file_id = self.db.crate_graph()[self.def_map.krate].root_file_id;\n         let raw_items = self.db.raw_items(file_id.into());\n         let module_id = self.def_map.root;\n         self.def_map.modules[module_id].origin = ModuleOrigin::CrateRoot { definition: file_id };\n@@ -954,7 +954,7 @@ mod tests {\n         let krate = db.test_crate();\n \n         let def_map = {\n-            let edition = db.crate_graph().crate_data(&krate).edition;\n+            let edition = db.crate_graph()[krate].edition;\n             let mut modules: Arena<LocalModuleId, ModuleData> = Arena::default();\n             let root = modules.alloc(ModuleData::default());\n             CrateDefMap {"}, {"sha": "6e1c8e42aeed62851131b8c885a56d79ca7393a7", "filename": "crates/ra_hir_ty/src/traits.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_ty%2Fsrc%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_hir_ty%2Fsrc%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftraits.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -47,7 +47,7 @@ pub(crate) fn impls_for_trait_query(\n     // will only ever get called for a few crates near the root of the tree (the\n     // ones the user is editing), so this may actually be a waste of memory. I'm\n     // doing it like this mainly for simplicity for now.\n-    for dep in &db.crate_graph().crate_data(&krate).dependencies {\n+    for dep in &db.crate_graph()[krate].dependencies {\n         impls.extend(db.impls_for_trait(dep.crate_id, trait_).iter());\n     }\n     let crate_impl_defs = db.impls_in_crate(krate);"}, {"sha": "25e038a55dde22922e73948d149dda24c505e334", "filename": "crates/ra_ide/src/hover.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_ide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_ide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fhover.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -121,7 +121,7 @@ fn definition_owner_name(db: &RootDatabase, def: &Definition) -> Option<String>\n \n fn determine_mod_path(db: &RootDatabase, def: &Definition) -> Option<String> {\n     let mod_path = def.module(db).map(|module| {\n-        once(db.crate_graph().crate_data(&module.krate().into()).display_name.clone())\n+        once(db.crate_graph()[module.krate().into()].display_name.clone())\n             .chain(\n                 module\n                     .path_to_root(db)"}, {"sha": "c60e86aead536bf3065ae9fe1447ff9d0d86f3d8", "filename": "crates/ra_ide/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_ide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6133206d1614624bbb51650d33fae04d70bc21a/crates%2Fra_ide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Flib.rs?ref=a6133206d1614624bbb51650d33fae04d70bc21a", "patch": "@@ -421,12 +421,12 @@ impl Analysis {\n \n     /// Returns the edition of the given crate.\n     pub fn crate_edition(&self, crate_id: CrateId) -> Cancelable<Edition> {\n-        self.with_db(|db| db.crate_graph().crate_data(&crate_id).edition)\n+        self.with_db(|db| db.crate_graph()[crate_id].edition)\n     }\n \n     /// Returns the root file of the given crate.\n     pub fn crate_root(&self, crate_id: CrateId) -> Cancelable<FileId> {\n-        self.with_db(|db| db.crate_graph().crate_data(&crate_id).root_file_id)\n+        self.with_db(|db| db.crate_graph()[crate_id].root_file_id)\n     }\n \n     /// Returns the set of possible targets to run for the current file."}]}