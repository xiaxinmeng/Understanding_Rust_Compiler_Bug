{"sha": "ac19420535b41d3b2a0ba68803f9426e3a89abed", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjMTk0MjA1MzViNDFkM2IyYTBiYTY4ODAzZjk0MjZlM2E4OWFiZWQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-31T20:24:28Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-31T20:24:28Z"}, "message": "rustbuild: Clean more on `make clean`\n\nBe sure to not use the old build cache for the bootstrap build system nor the\nold caches of the compiler/cargo extractions (in case something went wrong).\n\nCloses #33986", "tree": {"sha": "af91544ac71a6abe9a944b99dde60f99f4282192", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af91544ac71a6abe9a944b99dde60f99f4282192"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac19420535b41d3b2a0ba68803f9426e3a89abed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac19420535b41d3b2a0ba68803f9426e3a89abed", "html_url": "https://github.com/rust-lang/rust/commit/ac19420535b41d3b2a0ba68803f9426e3a89abed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac19420535b41d3b2a0ba68803f9426e3a89abed/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "298730e7032cd55809423773da397cd5c7d827d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/298730e7032cd55809423773da397cd5c7d827d4", "html_url": "https://github.com/rust-lang/rust/commit/298730e7032cd55809423773da397cd5c7d827d4"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "ffb93f2d3ee674cf16bd92b18cac8fee659771e3", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ac19420535b41d3b2a0ba68803f9426e3a89abed/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/ac19420535b41d3b2a0ba68803f9426e3a89abed/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=ac19420535b41d3b2a0ba68803f9426e3a89abed", "patch": "@@ -181,13 +181,13 @@ def cargo_stamp(self):\n         return os.path.join(self.bin_root(), '.cargo-stamp')\n \n     def rustc_out_of_date(self):\n-        if not os.path.exists(self.rustc_stamp()):\n+        if not os.path.exists(self.rustc_stamp()) or self.clean:\n             return True\n         with open(self.rustc_stamp(), 'r') as f:\n             return self.stage0_rustc_date() != f.read()\n \n     def cargo_out_of_date(self):\n-        if not os.path.exists(self.cargo_stamp()):\n+        if not os.path.exists(self.cargo_stamp()) or self.clean:\n             return True\n         with open(self.cargo_stamp(), 'r') as f:\n             return self.stage0_cargo_date() != f.read()\n@@ -234,8 +234,11 @@ def exe_suffix(self):\n             return ''\n \n     def build_bootstrap(self):\n+        build_dir = os.path.join(self.build_dir, \"bootstrap\")\n+        if self.clean and os.path.exists(build_dir):\n+            shutil.rmtree(build_dir)\n         env = os.environ.copy()\n-        env[\"CARGO_TARGET_DIR\"] = os.path.join(self.build_dir, \"bootstrap\")\n+        env[\"CARGO_TARGET_DIR\"] = build_dir\n         env[\"RUSTC\"] = self.rustc()\n         env[\"LD_LIBRARY_PATH\"] = os.path.join(self.bin_root(), \"lib\")\n         env[\"DYLD_LIBRARY_PATH\"] = os.path.join(self.bin_root(), \"lib\")\n@@ -340,6 +343,7 @@ def build_triple(self):\n def main():\n     parser = argparse.ArgumentParser(description='Build rust')\n     parser.add_argument('--config')\n+    parser.add_argument('--clean', action='store_true')\n     parser.add_argument('-v', '--verbose', action='store_true')\n \n     args = [a for a in sys.argv if a != '-h']\n@@ -352,6 +356,7 @@ def main():\n     rb.rust_root = os.path.abspath(os.path.join(__file__, '../../..'))\n     rb.build_dir = os.path.join(os.getcwd(), \"build\")\n     rb.verbose = args.verbose\n+    rb.clean = args.clean\n \n     try:\n         with open(args.config or 'config.toml') as config:"}]}