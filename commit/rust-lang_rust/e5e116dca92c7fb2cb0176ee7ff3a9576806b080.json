{"sha": "e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "node_id": "C_kwDOAAsO6NoAKGU1ZTExNmRjYTkyYzdmYjJjYjAxNzZlZTdmZjNhOTU3NjgwNmIwODA", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev+love@gmail.com", "date": "2023-01-09T23:05:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-09T23:05:34Z"}, "message": "Rollup merge of #106204 - compiler-errors:no-take-opaques-in-compare, r=oli-obk\n\nNo need to take opaques in `check_type_bounds`\n\n`InferCtxt` already has its defining use anchor set to err\n\nr? ``@oli-obk``", "tree": {"sha": "97dae1e51b60a665b89a3df08d76474ace13aa17", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/97dae1e51b60a665b89a3df08d76474ace13aa17"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjvJ2+CRBK7hj4Ov3rIwAASGEIAJLta/kc2R0SLTbgumO1Ar3J\n0ngYapeyCDoWb+6AHAOHLJ4ny8wvdp50DMYCSPGvmb+07tSw2HJOlxmw4c3O9Wzy\noSaK3H5Nf5W5OssBj1NIW+w42RqDDoXkn0IGo7ptihQDwm8H+OVvPLxM6leic73B\nffHZr5omMSIOT86U3Ng1SnsrdrUdwHCRkZrsCrQjmqlbHhyoOZaVA7f4FsG/yHs5\nwsHx0mGIPHVo7H3657lWb/UqwJ9jba/wlpje+VZmYVEDmk/Xch1jXGzUYhPJ2K69\nRpZQ/evs+ATa+ZwranQMZhDWLH4buPI6bGmwzBlNFfjrlS5+aSwo/N/yCcl22qk=\n=+87b\n-----END PGP SIGNATURE-----\n", "payload": "tree 97dae1e51b60a665b89a3df08d76474ace13aa17\nparent 684a3717cb78ef8a8c3182b0b2ef630dadb7c4aa\nparent f769d34291e489db19d3c972348ddb24b6b32481\nauthor Yuki Okushi <huyuumi.dev+love@gmail.com> 1673305534 +0900\ncommitter GitHub <noreply@github.com> 1673305534 +0900\n\nRollup merge of #106204 - compiler-errors:no-take-opaques-in-compare, r=oli-obk\n\nNo need to take opaques in `check_type_bounds`\n\n`InferCtxt` already has its defining use anchor set to err\n\nr? ``@oli-obk``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "html_url": "https://github.com/rust-lang/rust/commit/e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/comments", "author": null, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "684a3717cb78ef8a8c3182b0b2ef630dadb7c4aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/684a3717cb78ef8a8c3182b0b2ef630dadb7c4aa", "html_url": "https://github.com/rust-lang/rust/commit/684a3717cb78ef8a8c3182b0b2ef630dadb7c4aa"}, {"sha": "f769d34291e489db19d3c972348ddb24b6b32481", "url": "https://api.github.com/repos/rust-lang/rust/commits/f769d34291e489db19d3c972348ddb24b6b32481", "html_url": "https://github.com/rust-lang/rust/commit/f769d34291e489db19d3c972348ddb24b6b32481"}], "stats": {"total": 50, "additions": 14, "deletions": 36}, "files": [{"sha": "4fe14c7af2faaa84fef3d08f130c1ee0a43f33e6", "filename": "compiler/rustc_borrowck/src/region_infer/opaque_types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fopaque_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fopaque_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fopaque_types.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -318,7 +318,7 @@ impl<'tcx> InferCtxtExt<'tcx> for InferCtxt<'tcx> {\n \n         // This is still required for many(half of the tests in ui/type-alias-impl-trait)\n         // tests to pass\n-        let _ = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n+        let _ = infcx.take_opaque_types();\n \n         if errors.is_empty() {\n             definition_ty"}, {"sha": "7a3db191f0c66eef0436ae8844e9ca6e5e33c3cb", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -209,7 +209,7 @@ pub(crate) fn type_check<'mir, 'tcx>(\n     );\n \n     translate_outlives_facts(&mut checker);\n-    let opaque_type_values = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n+    let opaque_type_values = infcx.take_opaque_types();\n \n     let opaque_type_values = opaque_type_values\n         .into_iter()"}, {"sha": "f5f3d5de6b5a2f15088c28e0399ac5a3ca324d8e", "filename": "compiler/rustc_const_eval/src/util/compare_types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_const_eval%2Fsrc%2Futil%2Fcompare_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_const_eval%2Fsrc%2Futil%2Fcompare_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Futil%2Fcompare_types.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -58,6 +58,6 @@ pub fn is_subtype<'tcx>(\n     // even if they're constrained in our current function.\n     //\n     // It seems very unlikely that this hides any bugs.\n-    let _ = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n+    let _ = infcx.take_opaque_types();\n     errors.is_empty()\n }"}, {"sha": "43795cfba3fd81edc85efcd69526445e26c82a54", "filename": "compiler/rustc_hir_analysis/src/check/check.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -475,7 +475,7 @@ fn check_opaque_meets_bounds<'tcx>(\n         }\n     }\n     // Clean up after ourselves\n-    let _ = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n+    let _ = infcx.take_opaque_types();\n }\n \n fn is_enum_of_nonnullable_ptr<'tcx>("}, {"sha": "7af89934d1420eea5e4461e267710b54f589204d", "filename": "compiler/rustc_hir_analysis/src/check/compare_impl_item.rs", "status": "modified", "additions": 1, "deletions": 17, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_impl_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_impl_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_impl_item.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -424,7 +424,7 @@ fn compare_asyncness<'tcx>(\n             ty::Alias(ty::Opaque, ..) => {\n                 // allow both `async fn foo()` and `fn foo() -> impl Future`\n             }\n-            ty::Error(rustc_errors::ErrorGuaranteed { .. }) => {\n+            ty::Error(_) => {\n                 // We don't know if it's ok, but at least it's already an error.\n             }\n             _ => {\n@@ -1972,22 +1972,6 @@ pub(super) fn check_type_bounds<'tcx>(\n         &outlives_environment,\n     )?;\n \n-    let constraints = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n-    for (key, value) in constraints {\n-        infcx\n-            .err_ctxt()\n-            .report_mismatched_types(\n-                &ObligationCause::misc(\n-                    value.hidden_type.span,\n-                    tcx.hir().local_def_id_to_hir_id(impl_ty.def_id.expect_local()),\n-                ),\n-                tcx.mk_opaque(key.def_id.to_def_id(), key.substs),\n-                value.hidden_type.ty,\n-                TypeError::Mismatch,\n-            )\n-            .emit();\n-    }\n-\n     Ok(())\n }\n "}, {"sha": "8c24b6006444a8dc26d21d57b009768b05a0ad82", "filename": "compiler/rustc_hir_typeck/src/writeback.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fwriteback.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -534,8 +534,7 @@ impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n \n     #[instrument(skip(self), level = \"debug\")]\n     fn visit_opaque_types(&mut self) {\n-        let opaque_types =\n-            self.fcx.infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n+        let opaque_types = self.fcx.infcx.take_opaque_types();\n         for (opaque_type_key, decl) in opaque_types {\n             let hidden_type = self.resolve(decl.hidden_type, &decl.hidden_type.span);\n             let opaque_type_key = self.resolve(opaque_type_key, &decl.hidden_type.span);"}, {"sha": "3d49182f0b8172d1edd7bb371b743ef0989e8243", "filename": "compiler/rustc_infer/src/infer/canonical/query_response.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fquery_response.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fquery_response.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fquery_response.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -156,10 +156,7 @@ impl<'tcx> InferCtxt<'tcx> {\n     /// As the new solver does canonicalization slightly differently, this is also used there\n     /// for now. This should hopefully change fairly soon.\n     pub fn take_opaque_types_for_query_response(&self) -> Vec<(Ty<'tcx>, Ty<'tcx>)> {\n-        self.inner\n-            .borrow_mut()\n-            .opaque_type_storage\n-            .take_opaque_types()\n+        std::mem::take(&mut self.inner.borrow_mut().opaque_type_storage.opaque_types)\n             .into_iter()\n             .map(|(k, v)| (self.tcx.mk_opaque(k.def_id.to_def_id(), k.substs), v.hidden_type.ty))\n             .collect()"}, {"sha": "6bef3f000a5ac54fb4a16c34a2cdd5cfa5049ed0", "filename": "compiler/rustc_infer/src/infer/mod.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fmod.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -1338,6 +1338,12 @@ impl<'tcx> InferCtxt<'tcx> {\n         var_infos\n     }\n \n+    #[instrument(level = \"debug\", skip(self), ret)]\n+    pub fn take_opaque_types(&self) -> opaque_types::OpaqueTypeMap<'tcx> {\n+        debug_assert_ne!(self.defining_use_anchor, DefiningAnchor::Error);\n+        std::mem::take(&mut self.inner.borrow_mut().opaque_type_storage.opaque_types)\n+    }\n+\n     pub fn ty_to_string(&self, t: Ty<'tcx>) -> String {\n         self.resolve_vars_if_possible(t).to_string()\n     }"}, {"sha": "ae4b85c8799ef130b252ffe50a210834c6bcfd58", "filename": "compiler/rustc_infer/src/infer/opaque_types/table.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types%2Ftable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types%2Ftable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types%2Ftable.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -29,11 +29,6 @@ impl<'tcx> OpaqueTypeStorage<'tcx> {\n         }\n     }\n \n-    #[instrument(level = \"debug\", ret)]\n-    pub fn take_opaque_types(&mut self) -> OpaqueTypeMap<'tcx> {\n-        std::mem::take(&mut self.opaque_types)\n-    }\n-\n     #[inline]\n     pub(crate) fn with_log<'a>(\n         &'a mut self,"}, {"sha": "37b40a2f75adc108a77765070c011073a69da460", "filename": "compiler/rustc_trait_selection/src/traits/mod.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -450,9 +450,6 @@ pub fn impossible_predicates<'tcx>(\n     }\n     let errors = ocx.select_all_or_error();\n \n-    // Clean up after ourselves\n-    let _ = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n-\n     let result = !errors.is_empty();\n     debug!(\"impossible_predicates = {:?}\", result);\n     result"}, {"sha": "f127ef8343f91e5a262beed9bd805e6a582a237b", "filename": "compiler/rustc_traits/src/codegen.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_traits%2Fsrc%2Fcodegen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e116dca92c7fb2cb0176ee7ff3a9576806b080/compiler%2Frustc_traits%2Fsrc%2Fcodegen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fcodegen.rs?ref=e5e116dca92c7fb2cb0176ee7ff3a9576806b080", "patch": "@@ -82,7 +82,7 @@ pub fn codegen_select_candidate<'tcx>(\n     // Opaque types may have gotten their hidden types constrained, but we can ignore them safely\n     // as they will get constrained elsewhere, too.\n     // (ouz-a) This is required for `type-alias-impl-trait/assoc-projection-ice.rs` to pass\n-    let _ = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n+    let _ = infcx.take_opaque_types();\n \n     Ok(&*tcx.arena.alloc(impl_source))\n }"}]}