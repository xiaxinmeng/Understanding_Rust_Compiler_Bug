{"sha": "c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM1ZmE4NmRhMDRjNjdhZDJjOTQ3YWE0ZmE3NTNhNTVhZDJkOWNhZWM=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2017-11-20T08:51:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-11-20T08:51:12Z"}, "message": "Merge pull request #2203 from clippered/float_cmp_const\n\nFix #1142 float constant comparison lint", "tree": {"sha": "594a148a00702e2712d66887c0958ca625668675", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/594a148a00702e2712d66887c0958ca625668675"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaEpeACRBK7hj4Ov3rIwAAdHIIAAwOurr273ImRzG7+//dnhUv\nLtt/ke29XHUTf8uOvAmCzgZjhisSUacc3tskilgM7ipAaf+8pCkyIxVKWXrANNwQ\nNYsPHIkJhILOFkWMSbJDvtRiH5q6Cqj6vFb03n6m53uJQMyFf6FCZm2Fdk+ckTNn\ng9wB+ZzRPM5ewpJf/GHpGUdNW0SJ95RIb7pUHNmrGNIUwnlNcrl/RqcWdld8BbMo\ngAY2iP1LaaZN9+yr7F5tvkq4FVauPbJLL4DBDoWLbYrsN3COUUwMGihrjJ7rc1lv\ne8t/koTVu8WDEV8EPkPScNlcQBctcZEjet+Q4zJXHII38ZT1llvFWdB1MlJ4o0o=\n=Zyah\n-----END PGP SIGNATURE-----\n", "payload": "tree 594a148a00702e2712d66887c0958ca625668675\nparent 80c9803bdbd01dae40c3114a2576630443138886\nparent 66bc12564a5c7494cb17ac816255ac87b6f4016b\nauthor Oliver Schneider <oli-obk@users.noreply.github.com> 1511167872 +0100\ncommitter GitHub <noreply@github.com> 1511167872 +0100\n\nMerge pull request #2203 from clippered/float_cmp_const\n\nFix #1142 float constant comparison lint"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "html_url": "https://github.com/rust-lang/rust/commit/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80c9803bdbd01dae40c3114a2576630443138886", "url": "https://api.github.com/repos/rust-lang/rust/commits/80c9803bdbd01dae40c3114a2576630443138886", "html_url": "https://github.com/rust-lang/rust/commit/80c9803bdbd01dae40c3114a2576630443138886"}, {"sha": "66bc12564a5c7494cb17ac816255ac87b6f4016b", "url": "https://api.github.com/repos/rust-lang/rust/commits/66bc12564a5c7494cb17ac816255ac87b6f4016b", "html_url": "https://github.com/rust-lang/rust/commit/66bc12564a5c7494cb17ac816255ac87b6f4016b"}], "stats": {"total": 171, "additions": 169, "deletions": 2}, "files": [{"sha": "6ceb6176bd78aa9a45e1501062450fa33b3a0bdf", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "patch": "@@ -367,6 +367,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         arithmetic::INTEGER_ARITHMETIC,\n         array_indexing::INDEXING_SLICING,\n         assign_ops::ASSIGN_OPS,\n+        misc::FLOAT_CMP_CONST,\n     ]);\n \n     reg.register_lint_group(\"clippy_pedantic\", vec!["}, {"sha": "c9c404c1740b14f9baef66a7ee8779979f384103", "filename": "clippy_lints/src/misc.rs", "status": "modified", "additions": 38, "deletions": 2, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/clippy_lints%2Fsrc%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/clippy_lints%2Fsrc%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc.rs?ref=c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "patch": "@@ -13,6 +13,7 @@ use utils::{get_item_name, get_parent_expr, implements_trait, in_constant, in_ma\n             span_lint_and_then, walk_ptrs_ty};\n use utils::sugg::Sugg;\n use syntax::ast::{FloatTy, LitKind, CRATE_NODE_ID};\n+use consts::constant;\n \n /// **What it does:** Checks for function arguments and let bindings denoted as\n /// `ref`.\n@@ -200,6 +201,27 @@ declare_lint! {\n     \"using 0 as *{const, mut} T\"\n }\n \n+/// **What it does:** Checks for (in-)equality comparisons on floating-point\n+/// value and constant, except in functions called `*eq*` (which probably\n+/// implement equality for a type involving floats).\n+///\n+/// **Why is this bad?** Floating point calculations are usually imprecise, so\n+/// asking if two values are *exactly* equal is asking for trouble. For a good\n+/// guide on what to do, see [the floating point\n+/// guide](http://www.floating-point-gui.de/errors/comparison).\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:**\n+/// ```rust\n+/// const ONE == 1.00f64\n+/// x == ONE  // where both are floats\n+/// ```\n+declare_restriction_lint! {\n+    pub FLOAT_CMP_CONST,\n+    \"using `==` or `!=` on float constants instead of comparing difference with an epsilon\"\n+}\n+\n #[derive(Copy, Clone)]\n pub struct Pass;\n \n@@ -214,7 +236,8 @@ impl LintPass for Pass {\n             REDUNDANT_PATTERN,\n             USED_UNDERSCORE_BINDING,\n             SHORT_CIRCUIT_STATEMENT,\n-            ZERO_PTR\n+            ZERO_PTR,\n+            FLOAT_CMP_CONST\n         )\n     }\n }\n@@ -334,7 +357,12 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n                             return;\n                         }\n                     }\n-                    span_lint_and_then(cx, FLOAT_CMP, expr.span, \"strict comparison of f32 or f64\", |db| {\n+                    let (lint, msg) = if is_named_constant(cx, left) || is_named_constant(cx, right) {\n+                        (FLOAT_CMP_CONST, \"strict comparison of f32 or f64 constant\")\n+                    } else {\n+                        (FLOAT_CMP, \"strict comparison of f32 or f64\")\n+                    };\n+                    span_lint_and_then(cx, lint, expr.span, msg, |db| {\n                         let lhs = Sugg::hir(cx, left, \"..\");\n                         let rhs = Sugg::hir(cx, right, \"..\");\n \n@@ -423,6 +451,14 @@ fn check_nan(cx: &LateContext, path: &Path, expr: &Expr) {\n     }\n }\n \n+fn is_named_constant<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr) -> bool {\n+    if let Some((_, res)) = constant(cx, expr) {\n+        res\n+    } else {\n+       false\n+    }\n+}\n+\n fn is_allowed<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr) -> bool {\n     let parent_item = cx.tcx.hir.get_parent(expr.id);\n     let parent_def_id = cx.tcx.hir.local_def_id(parent_item);"}, {"sha": "adf2ab70368a901aac30c614e7f43f74eac75cbd", "filename": "tests/ui/float_cmp_const.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/tests%2Fui%2Ffloat_cmp_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/tests%2Fui%2Ffloat_cmp_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffloat_cmp_const.rs?ref=c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "patch": "@@ -0,0 +1,45 @@\n+\n+\n+\n+#![warn(float_cmp_const)]\n+#![allow(float_cmp)]\n+#![allow(unused, no_effect, unnecessary_operation)]\n+\n+const ONE: f32 = 1.0;\n+const TWO: f32 = 2.0;\n+\n+fn eq_one(x: f32) -> bool {\n+    if x.is_nan() { false } else { x == ONE } // no error, inside \"eq\" fn\n+}\n+\n+fn main() {\n+    // has errors\n+    1f32 == ONE;\n+    TWO == ONE;\n+    TWO != ONE;\n+    ONE + ONE == TWO;\n+    1 as f32 == ONE;\n+\n+    let v = 0.9;\n+    v == ONE;\n+    v != ONE;\n+\n+    // no errors, lower than or greater than comparisons\n+    v < ONE;\n+    v > ONE;\n+    v <= ONE;\n+    v >= ONE;\n+\n+    // no errors, zero and infinity values\n+    ONE != 0f32;\n+    TWO == 0f32;\n+    ONE != ::std::f32::INFINITY;\n+    ONE == ::std::f32::NEG_INFINITY;\n+\n+    // no errors, but will warn float_cmp if '#![allow(float_cmp)]' above is removed\n+    let w = 1.1;\n+    v == w;\n+    v != w;\n+    v == 1.0;\n+    v != 1.0;\n+}"}, {"sha": "fe277de28dd552ddede7bcfd19f0b7696839e9f6", "filename": "tests/ui/float_cmp_const.stderr", "status": "added", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/tests%2Fui%2Ffloat_cmp_const.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c5fa86da04c67ad2c947aa4fa753a55ad2d9caec/tests%2Fui%2Ffloat_cmp_const.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffloat_cmp_const.stderr?ref=c5fa86da04c67ad2c947aa4fa753a55ad2d9caec", "patch": "@@ -0,0 +1,85 @@\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:17:5\n+   |\n+17 |     1f32 == ONE;\n+   |     ^^^^^^^^^^^ help: consider comparing them within some error: `(1f32 - ONE).abs() < error`\n+   |\n+   = note: `-D float-cmp-const` implied by `-D warnings`\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:17:5\n+   |\n+17 |     1f32 == ONE;\n+   |     ^^^^^^^^^^^\n+\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:18:5\n+   |\n+18 |     TWO == ONE;\n+   |     ^^^^^^^^^^ help: consider comparing them within some error: `(TWO - ONE).abs() < error`\n+   |\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:18:5\n+   |\n+18 |     TWO == ONE;\n+   |     ^^^^^^^^^^\n+\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:19:5\n+   |\n+19 |     TWO != ONE;\n+   |     ^^^^^^^^^^ help: consider comparing them within some error: `(TWO - ONE).abs() < error`\n+   |\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:19:5\n+   |\n+19 |     TWO != ONE;\n+   |     ^^^^^^^^^^\n+\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:20:5\n+   |\n+20 |     ONE + ONE == TWO;\n+   |     ^^^^^^^^^^^^^^^^ help: consider comparing them within some error: `(ONE + ONE - TWO).abs() < error`\n+   |\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:20:5\n+   |\n+20 |     ONE + ONE == TWO;\n+   |     ^^^^^^^^^^^^^^^^\n+\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:21:5\n+   |\n+21 |     1 as f32 == ONE;\n+   |     ^^^^^^^^^^^^^^^ help: consider comparing them within some error: `(1 as f32 - ONE).abs() < error`\n+   |\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:21:5\n+   |\n+21 |     1 as f32 == ONE;\n+   |     ^^^^^^^^^^^^^^^\n+\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:24:5\n+   |\n+24 |     v == ONE;\n+   |     ^^^^^^^^ help: consider comparing them within some error: `(v - ONE).abs() < error`\n+   |\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:24:5\n+   |\n+24 |     v == ONE;\n+   |     ^^^^^^^^\n+\n+error: strict comparison of f32 or f64 constant\n+  --> $DIR/float_cmp_const.rs:25:5\n+   |\n+25 |     v != ONE;\n+   |     ^^^^^^^^ help: consider comparing them within some error: `(v - ONE).abs() < error`\n+   |\n+note: std::f32::EPSILON and std::f64::EPSILON are available.\n+  --> $DIR/float_cmp_const.rs:25:5\n+   |\n+25 |     v != ONE;\n+   |     ^^^^^^^^\n+"}]}