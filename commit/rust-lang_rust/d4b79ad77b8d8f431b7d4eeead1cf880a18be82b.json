{"sha": "d4b79ad77b8d8f431b7d4eeead1cf880a18be82b", "node_id": "C_kwDOAAsO6NoAKGQ0Yjc5YWQ3N2I4ZDhmNDMxYjdkNGVlZWFkMWNmODgwYTE4YmU4MmI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-02T14:20:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-02T14:20:36Z"}, "message": "Auto merge of #12678 - Veykril:flyimport, r=Veykril\n\nfix: Trigger flyimport completions in item lists again\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/12656", "tree": {"sha": "a30045351dfcf6829f5e0ef5f73df6b431f99339", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a30045351dfcf6829f5e0ef5f73df6b431f99339"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b", "html_url": "https://github.com/rust-lang/rust/commit/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec78b6b08af38df0b06422c050968945fb9e02c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec78b6b08af38df0b06422c050968945fb9e02c0", "html_url": "https://github.com/rust-lang/rust/commit/ec78b6b08af38df0b06422c050968945fb9e02c0"}, {"sha": "cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd42b20ce36adc8c2beda8d8e86a91b479cd182f", "html_url": "https://github.com/rust-lang/rust/commit/cd42b20ce36adc8c2beda8d8e86a91b479cd182f"}], "stats": {"total": 32, "additions": 28, "deletions": 4}, "files": [{"sha": "1c62347fb5b5dfb28f9b811c0df78a6440ce5d41", "filename": "crates/ide-completion/src/completions/flyimport.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fflyimport.rs?ref=d4b79ad77b8d8f431b7d4eeead1cf880a18be82b", "patch": "@@ -5,7 +5,10 @@ use ide_db::imports::{\n     insert_use::ImportScope,\n };\n use itertools::Itertools;\n-use syntax::{ast, AstNode, SyntaxNode, T};\n+use syntax::{\n+    ast::{self},\n+    AstNode, SyntaxNode, T,\n+};\n \n use crate::{\n     context::{\n@@ -123,6 +126,7 @@ pub(crate) fn import_on_the_fly_path(\n                 | PathKind::Type { .. }\n                 | PathKind::Attr { .. }\n                 | PathKind::Derive { .. }\n+                | PathKind::Item { .. }\n                 | PathKind::Pat { .. },\n             qualified,\n             ..\n@@ -161,7 +165,7 @@ pub(crate) fn import_on_the_fly_pat(\n     let potential_import_name = import_name(ctx);\n     let import_assets = import_assets_for_path(ctx, &potential_import_name, None)?;\n \n-    import_on_the_fly_pat2(\n+    import_on_the_fly_pat_(\n         acc,\n         ctx,\n         pattern_ctx,\n@@ -227,7 +231,7 @@ fn import_on_the_fly(\n                 | PathKind::Pat { .. },\n                 ItemInNs::Macros(mac),\n             ) => mac.is_fn_like(ctx.db),\n-            (PathKind::Item { .. }, _) => true,\n+            (PathKind::Item { .. }, ..) => false,\n \n             (PathKind::Expr { .. }, ItemInNs::Types(_) | ItemInNs::Values(_)) => true,\n \n@@ -279,7 +283,7 @@ fn import_on_the_fly(\n     Some(())\n }\n \n-fn import_on_the_fly_pat2(\n+fn import_on_the_fly_pat_(\n     acc: &mut Completions,\n     ctx: &CompletionContext,\n     pattern_ctx: &PatternContext,"}, {"sha": "0bba7f2459cafae4a0e246586c0af6c278e09e9b", "filename": "crates/ide-completion/src/tests/flyimport.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4b79ad77b8d8f431b7d4eeead1cf880a18be82b/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=d4b79ad77b8d8f431b7d4eeead1cf880a18be82b", "patch": "@@ -1210,3 +1210,23 @@ fn f<T>() where T: Comp$0\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn flyimport_source_file() {\n+    check(\n+        r#\"\n+//- /main.rs crate:main deps:dep\n+def$0\n+//- /lib.rs crate:dep\n+#[macro_export]\n+macro_rules! define_struct {\n+    () => {\n+        pub struct Foo;\n+    };\n+}\n+\"#,\n+        expect![[r#\"\n+            ma define_struct!(\u2026) (use dep::define_struct) macro_rules! define_struct\n+        \"#]],\n+    );\n+}"}]}