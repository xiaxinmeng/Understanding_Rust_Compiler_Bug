{"sha": "2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "node_id": "C_kwDOAAsO6NoAKDJiZTAxMmEwYzY2NGJmMWVlOTBhZjBlNWNhYzlhM2UzZTI0ZjQ2NjY", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-05-08T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-05-08T21:48:23Z"}, "message": "Use sparse representation of switch sources\n\nto avoid quadratic space overhead", "tree": {"sha": "3db2ef367e84fcfcb6adba09433e1e41cd3acc60", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3db2ef367e84fcfcb6adba09433e1e41cd3acc60"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "html_url": "https://github.com/rust-lang/rust/commit/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fbc3cc18bee7fb6dfd39e11521783f00506ca06b", "url": "https://api.github.com/repos/rust-lang/rust/commits/fbc3cc18bee7fb6dfd39e11521783f00506ca06b", "html_url": "https://github.com/rust-lang/rust/commit/fbc3cc18bee7fb6dfd39e11521783f00506ca06b"}], "stats": {"total": 18, "additions": 8, "deletions": 10}, "files": [{"sha": "2c97c7704e77dbc5d7452218b899a1d23c8adb40", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "patch": "@@ -580,8 +580,8 @@ impl<'tcx> Body<'tcx> {\n         self.predecessor_cache.compute(&self.basic_blocks)\n     }\n \n-    /// `body.switch_sources()[target][switch]` returns a list of switch values\n-    /// that lead to a `target` block from a `switch` block.\n+    /// `body.switch_sources()[&(target, switch)]` returns a list of switch\n+    /// values that lead to a `target` block from a `switch` block.\n     #[inline]\n     pub fn switch_sources(&self) -> &SwitchSources {\n         self.switch_source_cache.compute(&self.basic_blocks)"}, {"sha": "adeeec70d1c0bb80b6af435db5519818b2d57eae", "filename": "compiler/rustc_middle/src/mir/switch_sources.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fswitch_sources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fswitch_sources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fswitch_sources.rs?ref=2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "patch": "@@ -2,14 +2,15 @@\n //! `Predecessors`/`PredecessorCache`.\n \n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n+use rustc_data_structures::stable_map::FxHashMap;\n use rustc_data_structures::sync::OnceCell;\n use rustc_index::vec::IndexVec;\n use rustc_serialize as serialize;\n use smallvec::SmallVec;\n \n use crate::mir::{BasicBlock, BasicBlockData, Terminator, TerminatorKind};\n \n-pub type SwitchSources = IndexVec<BasicBlock, IndexVec<BasicBlock, SmallVec<[Option<u128>; 1]>>>;\n+pub type SwitchSources = FxHashMap<(BasicBlock, BasicBlock), SmallVec<[Option<u128>; 1]>>;\n \n #[derive(Clone, Debug)]\n pub(super) struct SwitchSourceCache {\n@@ -35,19 +36,16 @@ impl SwitchSourceCache {\n         basic_blocks: &IndexVec<BasicBlock, BasicBlockData<'_>>,\n     ) -> &SwitchSources {\n         self.cache.get_or_init(|| {\n-            let mut switch_sources = IndexVec::from_elem(\n-                IndexVec::from_elem(SmallVec::new(), basic_blocks),\n-                basic_blocks,\n-            );\n+            let mut switch_sources: SwitchSources = FxHashMap::default();\n             for (bb, data) in basic_blocks.iter_enumerated() {\n                 if let Some(Terminator {\n                     kind: TerminatorKind::SwitchInt { targets, .. }, ..\n                 }) = &data.terminator\n                 {\n                     for (value, target) in targets.iter() {\n-                        switch_sources[target][bb].push(Some(value));\n+                        switch_sources.entry((target, bb)).or_default().push(Some(value));\n                     }\n-                    switch_sources[targets.otherwise()][bb].push(None);\n+                    switch_sources.entry((targets.otherwise(), bb)).or_default().push(None);\n                 }\n             }\n "}, {"sha": "18795128b8571ca0f56d3a70f0d9a93ec0a72936", "filename": "compiler/rustc_mir_dataflow/src/framework/direction.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/compiler%2Frustc_mir_dataflow%2Fsrc%2Fframework%2Fdirection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be012a0c664bf1ee90af0e5cac9a3e3e24f4666/compiler%2Frustc_mir_dataflow%2Fsrc%2Fframework%2Fdirection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fframework%2Fdirection.rs?ref=2be012a0c664bf1ee90af0e5cac9a3e3e24f4666", "patch": "@@ -322,7 +322,7 @@ where\n     fn apply(&mut self, mut apply_edge_effect: impl FnMut(&mut D, SwitchIntTarget)) {\n         assert!(!self.effects_applied);\n \n-        let values = &self.body.switch_sources()[self.bb][self.pred];\n+        let values = &self.body.switch_sources()[&(self.bb, self.pred)];\n         let targets = values.iter().map(|&value| SwitchIntTarget { value, target: self.bb });\n \n         let mut tmp = None;"}]}