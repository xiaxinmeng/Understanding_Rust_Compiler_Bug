{"sha": "11379f0494b6a8c81b3fb9e0411651bc749aaa06", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExMzc5ZjA0OTRiNmE4YzgxYjNmYjllMDQxMTY1MWJjNzQ5YWFhMDY=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-05-04T15:41:40Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-05-04T15:41:40Z"}, "message": "Do not ICE on invalid const param\n\nWhen encountering a path that can't have generics, do not call\n`generics_of`. This would happen when writing something like\n`path::this_is_a_mod<const_val>`.\n\nFix #84831.", "tree": {"sha": "233e954daa881db154ab742d9d31c74cc381278d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/233e954daa881db154ab742d9d31c74cc381278d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/11379f0494b6a8c81b3fb9e0411651bc749aaa06", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/11379f0494b6a8c81b3fb9e0411651bc749aaa06", "html_url": "https://github.com/rust-lang/rust/commit/11379f0494b6a8c81b3fb9e0411651bc749aaa06", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/11379f0494b6a8c81b3fb9e0411651bc749aaa06/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0309953232d9957aef4c7c5a24fcb30735b2066b", "url": "https://api.github.com/repos/rust-lang/rust/commits/0309953232d9957aef4c7c5a24fcb30735b2066b", "html_url": "https://github.com/rust-lang/rust/commit/0309953232d9957aef4c7c5a24fcb30735b2066b"}], "stats": {"total": 55, "additions": 54, "deletions": 1}, "files": [{"sha": "97b6f5cf41211fb8873f22eb9c263b4f8383bcff", "filename": "compiler/rustc_typeck/src/collect/type_of.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/11379f0494b6a8c81b3fb9e0411651bc749aaa06/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/11379f0494b6a8c81b3fb9e0411651bc749aaa06/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs?ref=11379f0494b6a8c81b3fb9e0411651bc749aaa06", "patch": "@@ -191,7 +191,25 @@ pub(super) fn opt_const_param_of(tcx: TyCtxt<'_>, def_id: LocalDefId) -> Option<\n                     Res::Def(DefKind::Ctor(..), def_id) => {\n                         tcx.generics_of(tcx.parent(def_id).unwrap())\n                     }\n-                    Res::Def(_, def_id) => tcx.generics_of(def_id),\n+                    // Other `DefKind`s don't have generics and would ICE when calling\n+                    // `generics_of`.\n+                    Res::Def(\n+                        DefKind::Struct\n+                        | DefKind::Union\n+                        | DefKind::Enum\n+                        | DefKind::Variant\n+                        | DefKind::Trait\n+                        | DefKind::OpaqueTy\n+                        | DefKind::TyAlias\n+                        | DefKind::ForeignTy\n+                        | DefKind::TraitAlias\n+                        | DefKind::AssocTy\n+                        | DefKind::Fn\n+                        | DefKind::AssocFn\n+                        | DefKind::AssocConst\n+                        | DefKind::Impl,\n+                        def_id,\n+                    ) => tcx.generics_of(def_id),\n                     Res::Err => {\n                         tcx.sess.delay_span_bug(tcx.def_span(def_id), \"anon const with Res::Err\");\n                         return None;"}, {"sha": "c646f71072532a4631ddfd8009793527b796ddcc", "filename": "src/test/ui/typeck/issue-84831.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/11379f0494b6a8c81b3fb9e0411651bc749aaa06/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.rs", "raw_url": "https://github.com/rust-lang/rust/raw/11379f0494b6a8c81b3fb9e0411651bc749aaa06/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.rs?ref=11379f0494b6a8c81b3fb9e0411651bc749aaa06", "patch": "@@ -0,0 +1,9 @@\n+fn f() {\n+    std::<0>; //~ ERROR expected value\n+}\n+fn j() {\n+    std::<_ as _>; //~ ERROR expected value\n+    //~^ ERROR expected one of `,` or `>`, found keyword `as`\n+}\n+\n+fn main () {}"}, {"sha": "e3cce10a00fd1fc68cb81190b8fba7993322f3ad", "filename": "src/test/ui/typeck/issue-84831.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/11379f0494b6a8c81b3fb9e0411651bc749aaa06/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/11379f0494b6a8c81b3fb9e0411651bc749aaa06/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.stderr?ref=11379f0494b6a8c81b3fb9e0411651bc749aaa06", "patch": "@@ -0,0 +1,26 @@\n+error: expected one of `,` or `>`, found keyword `as`\n+  --> $DIR/issue-84831.rs:5:13\n+   |\n+LL |     std::<_ as _>;\n+   |             ^^ expected one of `,` or `>`\n+   |\n+help: expressions must be enclosed in braces to be used as const generic arguments\n+   |\n+LL |     std::<{ _ as _ }>;\n+   |           ^        ^\n+\n+error[E0423]: expected value, found crate `std`\n+  --> $DIR/issue-84831.rs:2:5\n+   |\n+LL |     std::<0>;\n+   |     ^^^^^^^^ not a value\n+\n+error[E0423]: expected value, found crate `std`\n+  --> $DIR/issue-84831.rs:5:5\n+   |\n+LL |     std::<_ as _>;\n+   |     ^^^^^^^^^^^^^ not a value\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0423`."}]}