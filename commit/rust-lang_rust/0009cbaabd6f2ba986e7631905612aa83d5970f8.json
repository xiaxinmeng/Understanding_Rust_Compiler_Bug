{"sha": "0009cbaabd6f2ba986e7631905612aa83d5970f8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAwMDljYmFhYmQ2ZjJiYTk4NmU3NjMxOTA1NjEyYWE4M2Q1OTcwZjg=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-10-09T13:04:22Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-10-13T10:53:24Z"}, "message": "Add check for HTML comments", "tree": {"sha": "f10505b7dc53d38cbcdce88d7baa27c21beaa51b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f10505b7dc53d38cbcdce88d7baa27c21beaa51b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0009cbaabd6f2ba986e7631905612aa83d5970f8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0009cbaabd6f2ba986e7631905612aa83d5970f8", "html_url": "https://github.com/rust-lang/rust/commit/0009cbaabd6f2ba986e7631905612aa83d5970f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0009cbaabd6f2ba986e7631905612aa83d5970f8/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "861b8921c08e3cbe2ff8176679cc0cb3216bb2e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/861b8921c08e3cbe2ff8176679cc0cb3216bb2e3", "html_url": "https://github.com/rust-lang/rust/commit/861b8921c08e3cbe2ff8176679cc0cb3216bb2e3"}], "stats": {"total": 52, "additions": 46, "deletions": 6}, "files": [{"sha": "8bb71cef1c7ec64977fe76a87a7561638a827cf1", "filename": "src/librustdoc/passes/html_tags.rs", "status": "modified", "additions": 29, "deletions": 5, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/0009cbaabd6f2ba986e7631905612aa83d5970f8/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0009cbaabd6f2ba986e7631905612aa83d5970f8/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs?ref=0009cbaabd6f2ba986e7631905612aa83d5970f8", "patch": "@@ -4,11 +4,11 @@ use crate::core::DocContext;\n use crate::fold::DocFolder;\n use crate::html::markdown::opts;\n use core::ops::Range;\n-use std::iter::Peekable;\n-use std::str::CharIndices;\n use pulldown_cmark::{Event, Parser};\n use rustc_feature::UnstableFeatures;\n use rustc_session::lint;\n+use std::iter::Peekable;\n+use std::str::CharIndices;\n \n pub const CHECK_INVALID_HTML_TAGS: Pass = Pass {\n     name: \"check-invalid-html-tags\",\n@@ -104,8 +104,7 @@ fn extract_html_tag(\n             tag_name.push(c);\n         } else {\n             if !tag_name.is_empty() {\n-                let mut r =\n-                    Range { start: range.start + start_pos, end: range.start + pos };\n+                let mut r = Range { start: range.start + start_pos, end: range.start + pos };\n                 if c == '>' {\n                     // In case we have a tag without attribute, we can consider the span to\n                     // refer to it fully.\n@@ -143,6 +142,27 @@ fn extract_html_tag(\n     }\n }\n \n+fn extract_html_comment(\n+    text: &str,\n+    range: &Range<usize>,\n+    start_pos: usize,\n+    iter: &mut Peekable<CharIndices<'_>>,\n+    f: &impl Fn(&str, &Range<usize>),\n+) {\n+    // We first skip the \"!--\" part.\n+    let mut iter = iter.skip(3);\n+    while let Some((pos, c)) = iter.next() {\n+        if c == '-' && text[pos..].starts_with(\"-->\") {\n+            // All good, we can leave!\n+            return;\n+        }\n+    }\n+    f(\n+        \"Unclosed HTML comment\",\n+        &Range { start: range.start + start_pos, end: range.start + start_pos + 3 },\n+    );\n+}\n+\n fn extract_tags(\n     tags: &mut Vec<(String, Range<usize>)>,\n     text: &str,\n@@ -153,7 +173,11 @@ fn extract_tags(\n \n     while let Some((start_pos, c)) = iter.next() {\n         if c == '<' {\n-            extract_html_tag(tags, text, &range, start_pos, &mut iter, f);\n+            if text[start_pos..].starts_with(\"<!--\") {\n+                extract_html_comment(text, &range, start_pos, &mut iter, f);\n+            } else {\n+                extract_html_tag(tags, text, &range, start_pos, &mut iter, f);\n+            }\n         }\n     }\n }"}, {"sha": "14aa9e1b99c1c9289b6c1bcc53d72c908042565e", "filename": "src/test/rustdoc-ui/invalid-html-tags.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0009cbaabd6f2ba986e7631905612aa83d5970f8/src%2Ftest%2Frustdoc-ui%2Finvalid-html-tags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0009cbaabd6f2ba986e7631905612aa83d5970f8/src%2Ftest%2Frustdoc-ui%2Finvalid-html-tags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-html-tags.rs?ref=0009cbaabd6f2ba986e7631905612aa83d5970f8", "patch": "@@ -73,3 +73,13 @@ pub fn e() {}\n /// <div></div\n //~^ ERROR unclosed HTML tag `div`\n pub fn f() {}\n+\n+/// <!---->\n+/// <!-- -->\n+/// <!-- <div> -->\n+/// <!-- <!-- -->\n+pub fn g() {}\n+\n+/// <!--\n+//~^ ERROR Unclosed HTML comment\n+pub fn h() {}"}, {"sha": "821d2bb78e66951546a55e7e60cab152a8056079", "filename": "src/test/rustdoc-ui/invalid-html-tags.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0009cbaabd6f2ba986e7631905612aa83d5970f8/src%2Ftest%2Frustdoc-ui%2Finvalid-html-tags.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0009cbaabd6f2ba986e7631905612aa83d5970f8/src%2Ftest%2Frustdoc-ui%2Finvalid-html-tags.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-html-tags.stderr?ref=0009cbaabd6f2ba986e7631905612aa83d5970f8", "patch": "@@ -76,5 +76,11 @@ error: unclosed HTML tag `div`\n LL | /// <div></div\n    |     ^^^^^\n \n-error: aborting due to 12 previous errors\n+error: Unclosed HTML comment\n+  --> $DIR/invalid-html-tags.rs:83:5\n+   |\n+LL | /// <!--\n+   |     ^^^\n+\n+error: aborting due to 13 previous errors\n "}]}