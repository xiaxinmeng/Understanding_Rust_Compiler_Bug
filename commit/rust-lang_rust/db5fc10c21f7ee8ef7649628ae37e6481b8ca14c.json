{"sha": "db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiNWZjMTBjMjFmN2VlOGVmNzY0OTYyOGFlMzdlNjQ4MWI4Y2ExNGM=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-10-28T09:59:59Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-11-12T01:57:26Z"}, "message": "[mir-opt] Turn on the `ConstProp` pass by default\n\nperf.rlo shows that running the `ConstProp` pass results in\nacross-the-board wins regardless of debug or opt complilation mode. As a\nresult, we're turning it on to get the compile time benefits.\n\n`ConstProp` doesn't currently intern the memory used by its `Machine` so\nwe can't yet propagate allocations which is why\n`ConstProp::should_const_prop()` checks if the value being propagated is\na scalar or not.", "tree": {"sha": "42229563ddaf7be2c0e814e5a40bf6771701a6a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/42229563ddaf7be2c0e814e5a40bf6771701a6a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "html_url": "https://github.com/rust-lang/rust/commit/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bc0e288ad02ef362b5a6c42aaf61f2901c9b46db", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc0e288ad02ef362b5a6c42aaf61f2901c9b46db", "html_url": "https://github.com/rust-lang/rust/commit/bc0e288ad02ef362b5a6c42aaf61f2901c9b46db"}], "stats": {"total": 61, "additions": 37, "deletions": 24}, "files": [{"sha": "ecd45788d041cdba72748ef86dc07a166d211f47", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 27, "deletions": 14, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "patch": "@@ -641,8 +641,21 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n         }\n     }\n \n-    fn should_const_prop(&self) -> bool {\n-        self.tcx.sess.opts.debugging_opts.mir_opt_level >= 2\n+    fn should_const_prop(&mut self, op: OpTy<'tcx>) -> bool {\n+        if self.tcx.sess.opts.debugging_opts.mir_opt_level >= 2 {\n+            return true;\n+        } else if self.tcx.sess.opts.debugging_opts.mir_opt_level == 0 {\n+            return false;\n+        }\n+\n+        match *op {\n+            interpret::Operand::Immediate(Immediate::Scalar(ScalarMaybeUndef::Scalar(s))) =>\n+                s.is_bits(),\n+            interpret::Operand::Immediate(Immediate::ScalarPair(ScalarMaybeUndef::Scalar(l),\n+                                                                ScalarMaybeUndef::Scalar(r))) =>\n+                l.is_bits() && r.is_bits(),\n+            _ => false\n+        }\n     }\n }\n \n@@ -742,15 +755,15 @@ impl<'mir, 'tcx> MutVisitor<'tcx> for ConstPropagator<'mir, 'tcx> {\n                         if self.can_const_prop[local] {\n                             trace!(\"propagated into {:?}\", local);\n \n-                            if self.should_const_prop() {\n-                                let value =\n-                                    self.get_const(local).expect(\"local was dead/uninitialized\");\n-                                trace!(\"replacing {:?} with {:?}\", rval, value);\n-                                self.replace_with_const(\n-                                    rval,\n-                                    value,\n-                                    statement.source_info,\n-                                );\n+                            if let Some(value) = self.get_const(local) {\n+                                if self.should_const_prop(value) {\n+                                    trace!(\"replacing {:?} with {:?}\", rval, value);\n+                                    self.replace_with_const(\n+                                        rval,\n+                                        value,\n+                                        statement.source_info,\n+                                    );\n+                                }\n                             }\n                         } else {\n                             trace!(\"can't propagate into {:?}\", local);\n@@ -852,7 +865,7 @@ impl<'mir, 'tcx> MutVisitor<'tcx> for ConstPropagator<'mir, 'tcx> {\n                             &msg,\n                         );\n                     } else {\n-                        if self.should_const_prop() {\n+                        if self.should_const_prop(value) {\n                             if let ScalarMaybeUndef::Scalar(scalar) = value_const {\n                                 *cond = self.operand_from_scalar(\n                                     scalar,\n@@ -865,8 +878,8 @@ impl<'mir, 'tcx> MutVisitor<'tcx> for ConstPropagator<'mir, 'tcx> {\n                 }\n             },\n             TerminatorKind::SwitchInt { ref mut discr, switch_ty, .. } => {\n-                if self.should_const_prop() {\n-                    if let Some(value) = self.eval_operand(&discr, source_info) {\n+                if let Some(value) = self.eval_operand(&discr, source_info) {\n+                    if self.should_const_prop(value) {\n                         if let ScalarMaybeUndef::Scalar(scalar) =\n                                 self.ecx.read_scalar(value).unwrap() {\n                             *discr = self.operand_from_scalar(scalar, switch_ty, source_info.span);"}, {"sha": "a8be10ba3ce0aace871a323ad7d4a299a8273e21", "filename": "src/test/codegen/optimize-attr-1.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Ftest%2Fcodegen%2Foptimize-attr-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Ftest%2Fcodegen%2Foptimize-attr-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Foptimize-attr-1.rs?ref=db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "patch": "@@ -8,7 +8,7 @@\n \n // CHECK-LABEL: define i32 @nothing\n // CHECK-SAME: [[NOTHING_ATTRS:#[0-9]+]]\n-// NO-OPT: ret i32 %_1.0\n+// NO-OPT: ret i32 4\n // SIZE-OPT: ret i32 4\n // SPEEC-OPT: ret i32 4\n #[no_mangle]\n@@ -18,7 +18,7 @@ pub fn nothing() -> i32 {\n \n // CHECK-LABEL: define i32 @size\n // CHECK-SAME: [[SIZE_ATTRS:#[0-9]+]]\n-// NO-OPT: ret i32 %_1.0\n+// NO-OPT: ret i32 6\n // SIZE-OPT: ret i32 6\n // SPEED-OPT: ret i32 6\n #[optimize(size)]\n@@ -31,7 +31,7 @@ pub fn size() -> i32 {\n // NO-OPT-SAME: [[NOTHING_ATTRS]]\n // SPEED-OPT-SAME: [[NOTHING_ATTRS]]\n // SIZE-OPT-SAME: [[SPEED_ATTRS:#[0-9]+]]\n-// NO-OPT: ret i32 %_1.0\n+// NO-OPT: ret i32 8\n // SIZE-OPT: ret i32 8\n // SPEED-OPT: ret i32 8\n #[optimize(speed)]"}, {"sha": "615f1fe1fd0b888ca79b9b0145884c9ebc062c5e", "filename": "src/test/incremental/hashes/while_let_loops.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Ftest%2Fincremental%2Fhashes%2Fwhile_let_loops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Ftest%2Fincremental%2Fhashes%2Fwhile_let_loops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fhashes%2Fwhile_let_loops.rs?ref=db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "patch": "@@ -48,7 +48,7 @@ pub fn change_loop_condition() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn change_loop_condition() {\n     let mut _x = 0;\n@@ -70,7 +70,7 @@ pub fn add_break() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir, typeck_tables_of\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, typeck_tables_of\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn add_break() {\n     let mut _x = 0;\n@@ -141,7 +141,7 @@ pub fn change_break_label() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn change_break_label() {\n     let mut _x = 0;\n@@ -191,7 +191,7 @@ pub fn change_continue_label() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn change_continue_label() {\n     let mut _x = 0;\n@@ -216,7 +216,7 @@ pub fn change_continue_to_break() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn change_continue_to_break() {\n     let mut _x = 0;"}, {"sha": "70d0f86c3d268eed931ff5f4983d3d013a5132c9", "filename": "src/test/incremental/hashes/while_loops.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Ftest%2Fincremental%2Fhashes%2Fwhile_loops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5fc10c21f7ee8ef7649628ae37e6481b8ca14c/src%2Ftest%2Fincremental%2Fhashes%2Fwhile_loops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fhashes%2Fwhile_loops.rs?ref=db5fc10c21f7ee8ef7649628ae37e6481b8ca14c", "patch": "@@ -48,7 +48,7 @@ pub fn change_loop_condition() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn change_loop_condition() {\n     let mut _x = 0;\n@@ -191,7 +191,7 @@ pub fn change_continue_label() {\n }\n \n #[cfg(not(cfail1))]\n-#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built, optimized_mir\")]\n+#[rustc_clean(cfg=\"cfail2\", except=\"HirBody, mir_built\")]\n #[rustc_clean(cfg=\"cfail3\")]\n pub fn change_continue_label() {\n     let mut _x = 0;"}]}