{"sha": "616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYxNmFmNmViODM2MzBiNzZiYjNhOWJkZTU3YTAwZjVlYmU1ZGJkNmM=", "commit": {"author": {"name": "Steven Fackler", "email": "sfackler@gmail.com", "date": "2014-12-05T07:02:36Z"}, "committer": {"name": "Steven Fackler", "email": "sfackler@gmail.com", "date": "2014-12-06T23:13:48Z"}, "message": "Allow message specification for should_fail\n\nThe test harness will make sure that the panic message contains the\nspecified string. This is useful to help make `#[should_fail]` tests a\nbit less brittle by decreasing the chance that the test isn't\n\"accidentally\" passing due to a panic occurring earlier than expected.\nThe behavior is in some ways similar to JUnit's `expected` feature:\n`@Test(expected=NullPointerException.class)`.\n\nWithout the message assertion, this test would pass even though it's not\nactually reaching the intended part of the code:\n```rust\n #[test]\n #[should_fail(message = \"out of bounds\")]\nfn test_oob_array_access() {\n    let idx: uint = from_str(\"13o\").unwrap(); // oops, this will panic\n    [1i32, 2, 3][idx];\n}\n```", "tree": {"sha": "494380149d05abc6c6954b1b6bcbee856563d163", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/494380149d05abc6c6954b1b6bcbee856563d163"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "html_url": "https://github.com/rust-lang/rust/commit/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/comments", "author": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sfackler", "id": 1455697, "node_id": "MDQ6VXNlcjE0NTU2OTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1455697?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sfackler", "html_url": "https://github.com/sfackler", "followers_url": "https://api.github.com/users/sfackler/followers", "following_url": "https://api.github.com/users/sfackler/following{/other_user}", "gists_url": "https://api.github.com/users/sfackler/gists{/gist_id}", "starred_url": "https://api.github.com/users/sfackler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sfackler/subscriptions", "organizations_url": "https://api.github.com/users/sfackler/orgs", "repos_url": "https://api.github.com/users/sfackler/repos", "events_url": "https://api.github.com/users/sfackler/events{/privacy}", "received_events_url": "https://api.github.com/users/sfackler/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de83d7dd191bf5564855057a29f9b5d9dcfcb201", "url": "https://api.github.com/repos/rust-lang/rust/commits/de83d7dd191bf5564855057a29f9b5d9dcfcb201", "html_url": "https://github.com/rust-lang/rust/commit/de83d7dd191bf5564855057a29f9b5d9dcfcb201"}], "stats": {"total": 179, "additions": 150, "deletions": 29}, "files": [{"sha": "47ab675aff9347f95e99d1e7a2ce80a31abf940d", "filename": "src/compiletest/compiletest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Fcompiletest%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Fcompiletest%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcompiletest%2Fcompiletest.rs?ref=616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "patch": "@@ -346,7 +346,7 @@ pub fn make_test(config: &Config, testfile: &Path, f: || -> test::TestFn)\n         desc: test::TestDesc {\n             name: make_test_name(config, testfile),\n             ignore: header::is_test_ignored(config, testfile),\n-            should_fail: false\n+            should_fail: test::ShouldFail::No,\n         },\n         testfn: f(),\n     }"}, {"sha": "5759adf32440ee90ed0753674e4fda87621d5b78", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "patch": "@@ -280,7 +280,7 @@ impl Collector {\n             desc: testing::TestDesc {\n                 name: testing::DynTestName(name),\n                 ignore: should_ignore,\n-                should_fail: false, // compiler failures are test failures\n+                should_fail: testing::ShouldFail::No, // compiler failures are test failures\n             },\n             testfn: testing::DynTestFn(proc() {\n                 runtest(test.as_slice(),"}, {"sha": "3d2cb9884341ddcb4a3eab336c098e641994a716", "filename": "src/libsyntax/test.rs", "status": "modified", "additions": 30, "deletions": 4, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Flibsyntax%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Flibsyntax%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftest.rs?ref=616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "patch": "@@ -37,12 +37,17 @@ use {ast, ast_util};\n use ptr::P;\n use util::small_vector::SmallVector;\n \n+enum ShouldFail {\n+    No,\n+    Yes(Option<InternedString>),\n+}\n+\n struct Test {\n     span: Span,\n     path: Vec<ast::Ident> ,\n     bench: bool,\n     ignore: bool,\n-    should_fail: bool\n+    should_fail: ShouldFail\n }\n \n struct TestCtxt<'a> {\n@@ -360,8 +365,16 @@ fn is_ignored(i: &ast::Item) -> bool {\n     i.attrs.iter().any(|attr| attr.check_name(\"ignore\"))\n }\n \n-fn should_fail(i: &ast::Item) -> bool {\n-    attr::contains_name(i.attrs.as_slice(), \"should_fail\")\n+fn should_fail(i: &ast::Item) -> ShouldFail {\n+    match i.attrs.iter().find(|attr| attr.check_name(\"should_fail\")) {\n+        Some(attr) => {\n+            let msg = attr.meta_item_list()\n+                .and_then(|list| list.iter().find(|mi| mi.check_name(\"message\")))\n+                .and_then(|mi| mi.value_str());\n+            ShouldFail::Yes(msg)\n+        }\n+        None => ShouldFail::No,\n+    }\n }\n \n /*\n@@ -550,7 +563,20 @@ fn mk_test_desc_and_fn_rec(cx: &TestCtxt, test: &Test) -> P<ast::Expr> {\n                                   vec![name_expr]);\n \n     let ignore_expr = ecx.expr_bool(span, test.ignore);\n-    let fail_expr = ecx.expr_bool(span, test.should_fail);\n+    let should_fail_path = |name| {\n+        ecx.path(span, vec![self_id, test_id, ecx.ident_of(\"ShouldFail\"), ecx.ident_of(name)])\n+    };\n+    let fail_expr = match test.should_fail {\n+        ShouldFail::No => ecx.expr_path(should_fail_path(\"No\")),\n+        ShouldFail::Yes(ref msg) => {\n+            let path = should_fail_path(\"Yes\");\n+            let arg = match *msg {\n+                Some(ref msg) => ecx.expr_some(span, ecx.expr_str(span, msg.clone())),\n+                None => ecx.expr_none(span),\n+            };\n+            ecx.expr_call(span, ecx.expr_path(path), vec![arg])\n+        }\n+    };\n \n     // self::test::TestDesc { ... }\n     let desc_expr = ecx.expr_struct("}, {"sha": "5cdd346f9816c03e96c8c262c3117831c38d8d04", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 70, "deletions": 23, "changes": 93, "blob_url": "https://github.com/rust-lang/rust/blob/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "patch": "@@ -47,6 +47,7 @@ use self::TestEvent::*;\n use self::NamePadding::*;\n use self::OutputLocation::*;\n \n+use std::any::{Any, AnyRefExt};\n use std::collections::TreeMap;\n use stats::Stats;\n use getopts::{OptGroup, optflag, optopt};\n@@ -78,7 +79,7 @@ pub mod test {\n              MetricChange, Improvement, Regression, LikelyNoise,\n              StaticTestFn, StaticTestName, DynTestName, DynTestFn,\n              run_test, test_main, test_main_static, filter_tests,\n-             parse_opts, StaticBenchFn};\n+             parse_opts, StaticBenchFn, ShouldFail};\n }\n \n pub mod stats;\n@@ -184,13 +185,19 @@ pub struct Bencher {\n     pub bytes: u64,\n }\n \n+#[deriving(Clone, Show, PartialEq, Eq, Hash)]\n+pub enum ShouldFail {\n+    No,\n+    Yes(Option<&'static str>)\n+}\n+\n // The definition of a single test. A test runner will run a list of\n // these.\n #[deriving(Clone, Show, PartialEq, Eq, Hash)]\n pub struct TestDesc {\n     pub name: TestName,\n     pub ignore: bool,\n-    pub should_fail: bool,\n+    pub should_fail: ShouldFail,\n }\n \n #[deriving(Show)]\n@@ -346,7 +353,7 @@ fn optgroups() -> Vec<getopts::OptGroup> {\n \n fn usage(binary: &str) {\n     let message = format!(\"Usage: {} [OPTIONS] [FILTER]\", binary);\n-    println!(r\"{usage}\n+    println!(r#\"{usage}\n \n The FILTER regex is tested against the name of all tests to run, and\n only those tests that match are run.\n@@ -366,10 +373,12 @@ Test Attributes:\n                      function takes one argument (test::Bencher).\n     #[should_fail] - This function (also labeled with #[test]) will only pass if\n                      the code causes a failure (an assertion failure or panic!)\n+                     A message may be provided, which the failure string must\n+                     contain: #[should_fail(message = \"foo\")].\n     #[ignore]      - When applied to a function which is already attributed as a\n                      test, then the test runner will ignore these tests during\n                      normal test runs. Running with --ignored will run these\n-                     tests.\",\n+                     tests.\"#,\n              usage = getopts::usage(message.as_slice(),\n                                     optgroups().as_slice()));\n }\n@@ -902,13 +911,13 @@ fn should_sort_failures_before_printing_them() {\n     let test_a = TestDesc {\n         name: StaticTestName(\"a\"),\n         ignore: false,\n-        should_fail: false\n+        should_fail: ShouldFail::No\n     };\n \n     let test_b = TestDesc {\n         name: StaticTestName(\"b\"),\n         ignore: false,\n-        should_fail: false\n+        should_fail: ShouldFail::No\n     };\n \n     let mut st = ConsoleTestState {\n@@ -1114,7 +1123,7 @@ pub fn run_test(opts: &TestOpts,\n \n             let stdout = reader.read_to_end().unwrap().into_iter().collect();\n             let task_result = result_future.into_inner();\n-            let test_result = calc_result(&desc, task_result.is_ok());\n+            let test_result = calc_result(&desc, task_result);\n             monitor_ch.send((desc.clone(), test_result, stdout));\n         })\n     }\n@@ -1148,13 +1157,17 @@ pub fn run_test(opts: &TestOpts,\n     }\n }\n \n-fn calc_result(desc: &TestDesc, task_succeeded: bool) -> TestResult {\n-    if task_succeeded {\n-        if desc.should_fail { TrFailed }\n-        else { TrOk }\n-    } else {\n-        if desc.should_fail { TrOk }\n-        else { TrFailed }\n+fn calc_result(desc: &TestDesc, task_result: Result<(), Box<Any+Send>>) -> TestResult {\n+    match (&desc.should_fail, task_result) {\n+        (&ShouldFail::No, Ok(())) |\n+        (&ShouldFail::Yes(None), Err(_)) => TrOk,\n+        (&ShouldFail::Yes(Some(msg)), Err(ref err))\n+            if err.downcast_ref::<String>()\n+                .map(|e| &**e)\n+                .or_else(|| err.downcast_ref::<&'static str>().map(|e| *e))\n+                .map(|e| e.contains(msg))\n+                .unwrap_or(false) => TrOk,\n+        _ => TrFailed,\n     }\n }\n \n@@ -1437,7 +1450,7 @@ mod tests {\n                TestDesc, TestDescAndFn, TestOpts, run_test,\n                Metric, MetricMap, MetricAdded, MetricRemoved,\n                Improvement, Regression, LikelyNoise,\n-               StaticTestName, DynTestName, DynTestFn};\n+               StaticTestName, DynTestName, DynTestFn, ShouldFail};\n     use std::io::TempDir;\n \n     #[test]\n@@ -1447,7 +1460,7 @@ mod tests {\n             desc: TestDesc {\n                 name: StaticTestName(\"whatever\"),\n                 ignore: true,\n-                should_fail: false\n+                should_fail: ShouldFail::No,\n             },\n             testfn: DynTestFn(proc() f()),\n         };\n@@ -1464,7 +1477,7 @@ mod tests {\n             desc: TestDesc {\n                 name: StaticTestName(\"whatever\"),\n                 ignore: true,\n-                should_fail: false\n+                should_fail: ShouldFail::No,\n             },\n             testfn: DynTestFn(proc() f()),\n         };\n@@ -1481,7 +1494,24 @@ mod tests {\n             desc: TestDesc {\n                 name: StaticTestName(\"whatever\"),\n                 ignore: false,\n-                should_fail: true\n+                should_fail: ShouldFail::Yes(None)\n+            },\n+            testfn: DynTestFn(proc() f()),\n+        };\n+        let (tx, rx) = channel();\n+        run_test(&TestOpts::new(), false, desc, tx);\n+        let (_, res, _) = rx.recv();\n+        assert!(res == TrOk);\n+    }\n+\n+    #[test]\n+    fn test_should_fail_good_message() {\n+        fn f() { panic!(\"an error message\"); }\n+        let desc = TestDescAndFn {\n+            desc: TestDesc {\n+                name: StaticTestName(\"whatever\"),\n+                ignore: false,\n+                should_fail: ShouldFail::Yes(Some(\"error message\"))\n             },\n             testfn: DynTestFn(proc() f()),\n         };\n@@ -1491,14 +1521,31 @@ mod tests {\n         assert!(res == TrOk);\n     }\n \n+    #[test]\n+    fn test_should_fail_bad_message() {\n+        fn f() { panic!(\"an error message\"); }\n+        let desc = TestDescAndFn {\n+            desc: TestDesc {\n+                name: StaticTestName(\"whatever\"),\n+                ignore: false,\n+                should_fail: ShouldFail::Yes(Some(\"foobar\"))\n+            },\n+            testfn: DynTestFn(proc() f()),\n+        };\n+        let (tx, rx) = channel();\n+        run_test(&TestOpts::new(), false, desc, tx);\n+        let (_, res, _) = rx.recv();\n+        assert!(res == TrFailed);\n+    }\n+\n     #[test]\n     fn test_should_fail_but_succeeds() {\n         fn f() { }\n         let desc = TestDescAndFn {\n             desc: TestDesc {\n                 name: StaticTestName(\"whatever\"),\n                 ignore: false,\n-                should_fail: true\n+                should_fail: ShouldFail::Yes(None)\n             },\n             testfn: DynTestFn(proc() f()),\n         };\n@@ -1544,15 +1591,15 @@ mod tests {\n                 desc: TestDesc {\n                     name: StaticTestName(\"1\"),\n                     ignore: true,\n-                    should_fail: false,\n+                    should_fail: ShouldFail::No,\n                 },\n                 testfn: DynTestFn(proc() {}),\n             },\n             TestDescAndFn {\n                 desc: TestDesc {\n                     name: StaticTestName(\"2\"),\n                     ignore: false,\n-                    should_fail: false\n+                    should_fail: ShouldFail::No,\n                 },\n                 testfn: DynTestFn(proc() {}),\n             });\n@@ -1588,7 +1635,7 @@ mod tests {\n                     desc: TestDesc {\n                         name: DynTestName((*name).clone()),\n                         ignore: false,\n-                        should_fail: false\n+                        should_fail: ShouldFail::No,\n                     },\n                     testfn: DynTestFn(testfn),\n                 };\n@@ -1629,7 +1676,7 @@ mod tests {\n                 desc: TestDesc {\n                     name: DynTestName(name.to_string()),\n                     ignore: false,\n-                    should_fail: false\n+                    should_fail: ShouldFail::No,\n                 },\n                 testfn: DynTestFn(test_fn)\n             }"}, {"sha": "dc703de489c10dc10fa3f8a96f59d4e2e09ff1c9", "filename": "src/test/run-fail/test-should-fail-bad-message.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Ftest%2Frun-fail%2Ftest-should-fail-bad-message.rs", "raw_url": "https://github.com/rust-lang/rust/raw/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Ftest%2Frun-fail%2Ftest-should-fail-bad-message.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Ftest-should-fail-bad-message.rs?ref=616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// check-stdout\n+// error-pattern:task 'test_foo' panicked at\n+// compile-flags: --test\n+// ignore-pretty: does not work well with `--test`\n+\n+#[test]\n+#[should_fail(message = \"foobar\")]\n+fn test_foo() {\n+    panic!(\"blah\")\n+}\n+\n+"}, {"sha": "9d422700fbf7d540d01f1bbeb499519ed6678609", "filename": "src/test/run-pass/test-should-fail-good-message.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Ftest%2Frun-pass%2Ftest-should-fail-good-message.rs", "raw_url": "https://github.com/rust-lang/rust/raw/616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c/src%2Ftest%2Frun-pass%2Ftest-should-fail-good-message.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Ftest-should-fail-good-message.rs?ref=616af6eb83630b76bb3a9bde57a00f5ebe5dbd6c", "patch": "@@ -0,0 +1,26 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --test\n+// ignore-pretty: does not work well with `--test`\n+\n+#[test]\n+#[should_fail(message = \"foo\")]\n+fn test_foo() {\n+    panic!(\"foo bar\")\n+}\n+\n+#[test]\n+#[should_fail(message = \"foo\")]\n+fn test_foo_dynamic() {\n+    panic!(\"{} bar\", \"foo\")\n+}\n+\n+"}]}