{"sha": "e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU4MmJiOTE1ZTRkYWVkZTgzMmIzZGNiNDVkZjZiOGY0Y2MzNTY5YzQ=", "commit": {"author": {"name": "Vadim Chugunov", "email": "vadimcn@gmail.com", "date": "2015-08-21T07:41:07Z"}, "committer": {"name": "Vadim Chugunov", "email": "vadimcn@gmail.com", "date": "2015-09-25T05:07:12Z"}, "message": "Fix dllimports of static data from rlibs", "tree": {"sha": "d2c1076b72ecad24b06d437027e57c4f06bd144b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2c1076b72ecad24b06d437027e57c4f06bd144b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "html_url": "https://github.com/rust-lang/rust/commit/e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/comments", "author": {"login": "vadimcn", "id": 3203809, "node_id": "MDQ6VXNlcjMyMDM4MDk=", "avatar_url": "https://avatars.githubusercontent.com/u/3203809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vadimcn", "html_url": "https://github.com/vadimcn", "followers_url": "https://api.github.com/users/vadimcn/followers", "following_url": "https://api.github.com/users/vadimcn/following{/other_user}", "gists_url": "https://api.github.com/users/vadimcn/gists{/gist_id}", "starred_url": "https://api.github.com/users/vadimcn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vadimcn/subscriptions", "organizations_url": "https://api.github.com/users/vadimcn/orgs", "repos_url": "https://api.github.com/users/vadimcn/repos", "events_url": "https://api.github.com/users/vadimcn/events{/privacy}", "received_events_url": "https://api.github.com/users/vadimcn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vadimcn", "id": 3203809, "node_id": "MDQ6VXNlcjMyMDM4MDk=", "avatar_url": "https://avatars.githubusercontent.com/u/3203809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vadimcn", "html_url": "https://github.com/vadimcn", "followers_url": "https://api.github.com/users/vadimcn/followers", "following_url": "https://api.github.com/users/vadimcn/following{/other_user}", "gists_url": "https://api.github.com/users/vadimcn/gists{/gist_id}", "starred_url": "https://api.github.com/users/vadimcn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vadimcn/subscriptions", "organizations_url": "https://api.github.com/users/vadimcn/orgs", "repos_url": "https://api.github.com/users/vadimcn/repos", "events_url": "https://api.github.com/users/vadimcn/events{/privacy}", "received_events_url": "https://api.github.com/users/vadimcn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cefe5f25b27b27c9d2f8685a7e16c852f9f77f60", "url": "https://api.github.com/repos/rust-lang/rust/commits/cefe5f25b27b27c9d2f8685a7e16c852f9f77f60", "html_url": "https://github.com/rust-lang/rust/commit/cefe5f25b27b27c9d2f8685a7e16c852f9f77f60"}], "stats": {"total": 136, "additions": 105, "deletions": 31}, "files": [{"sha": "02aeb1103539a3df8969d95ae13dcafb5fdde495", "filename": "src/librustc_trans/trans/base.rs", "status": "modified", "additions": 69, "deletions": 31, "changes": 100, "blob_url": "https://github.com/rust-lang/rust/blob/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fbase.rs?ref=e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "patch": "@@ -2570,20 +2570,6 @@ fn internalize_symbols(cx: &SharedCrateContext, reachable: &HashSet<&str>) {\n     unsafe {\n         let mut declared = HashSet::new();\n \n-        let iter_globals = |llmod| {\n-            ValueIter {\n-                cur: llvm::LLVMGetFirstGlobal(llmod),\n-                step: llvm::LLVMGetNextGlobal,\n-            }\n-        };\n-\n-        let iter_functions = |llmod| {\n-            ValueIter {\n-                cur: llvm::LLVMGetFirstFunction(llmod),\n-                step: llvm::LLVMGetNextFunction,\n-            }\n-        };\n-\n         // Collect all external declarations in all compilation units.\n         for ccx in cx.iter() {\n             for val in iter_globals(ccx.llmod()).chain(iter_functions(ccx.llmod())) {\n@@ -2623,28 +2609,74 @@ fn internalize_symbols(cx: &SharedCrateContext, reachable: &HashSet<&str>) {\n             }\n         }\n     }\n+}\n \n+// Create a `__imp_<symbol> = &symbol` global for every public static `symbol`.\n+// This is required to satisfy `dllimport` references to static data in .rlibs\n+// when using MSVC linker.  We do this only for data, as linker can fix up\n+// code references on its own.\n+// See #26591, #27438\n+fn create_imps(cx: &SharedCrateContext, _reachable: &HashSet<&str>) {\n+    unsafe {\n \n-    struct ValueIter {\n-        cur: ValueRef,\n-        step: unsafe extern \"C\" fn(ValueRef) -> ValueRef,\n+        for ccx in cx.iter() {\n+            let exported: Vec<_> = iter_globals(ccx.llmod())\n+                .filter(|&val| llvm::LLVMGetLinkage(val) == llvm::ExternalLinkage as c_uint &&\n+                               llvm::LLVMIsDeclaration(val) == 0)\n+                .collect();\n+\n+            let i8p_ty = Type::i8p(&ccx);\n+            for val in exported {\n+                let name = CStr::from_ptr(llvm::LLVMGetValueName(val));\n+                let imp_name = String::from(\"__imp_\") +\n+                               str::from_utf8(name.to_bytes()).unwrap();\n+                let imp_name = CString::new(imp_name).unwrap();\n+                let imp = llvm::LLVMAddGlobal(ccx.llmod(), i8p_ty.to_ref(),\n+                                              imp_name.as_ptr() as *const _);\n+                llvm::LLVMSetInitializer(imp, llvm::LLVMConstBitCast(val, i8p_ty.to_ref()));\n+                llvm::SetLinkage(imp, llvm::ExternalLinkage);\n+            }\n+        }\n     }\n+}\n \n-    impl Iterator for ValueIter {\n-        type Item = ValueRef;\n+struct ValueIter {\n+    cur: ValueRef,\n+    step: unsafe extern \"C\" fn(ValueRef) -> ValueRef,\n+}\n \n-        fn next(&mut self) -> Option<ValueRef> {\n-            let old = self.cur;\n-            if !old.is_null() {\n-                self.cur = unsafe {\n-                    let step: unsafe extern \"C\" fn(ValueRef) -> ValueRef =\n-                        mem::transmute_copy(&self.step);\n-                    step(old)\n-                };\n-                Some(old)\n-            } else {\n-                None\n-            }\n+impl Iterator for ValueIter {\n+    type Item = ValueRef;\n+\n+    fn next(&mut self) -> Option<ValueRef> {\n+        let old = self.cur;\n+        if !old.is_null() {\n+            self.cur = unsafe {\n+                let step: unsafe extern \"C\" fn(ValueRef) -> ValueRef =\n+                    mem::transmute_copy(&self.step);\n+                step(old)\n+            };\n+            Some(old)\n+        } else {\n+            None\n+        }\n+    }\n+}\n+\n+fn iter_globals(llmod: llvm::ModuleRef) -> ValueIter {\n+    unsafe {\n+        ValueIter {\n+            cur: llvm::LLVMGetFirstGlobal(llmod),\n+            step: llvm::LLVMGetNextGlobal,\n+        }\n+    }\n+}\n+\n+fn iter_functions(llmod: llvm::ModuleRef) -> ValueIter {\n+    unsafe {\n+        ValueIter {\n+            cur: llvm::LLVMGetFirstFunction(llmod),\n+            step: llvm::LLVMGetNextFunction,\n         }\n     }\n }\n@@ -2824,6 +2856,12 @@ pub fn trans_crate(tcx: &ty::ctxt, analysis: ty::CrateAnalysis) -> CrateTranslat\n                             &reachable_symbols.iter().map(|x| &x[..]).collect());\n     }\n \n+    if sess.target.target.options.is_like_msvc &&\n+       sess.crate_types.borrow().iter().any(|ct| *ct == config::CrateTypeRlib ||\n+                                                 *ct == config::CrateTypeStaticlib) {\n+        create_imps(&shared_ccx, &reachable_symbols.iter().map(|x| &x[..]).collect());\n+    }\n+\n     let metadata_module = ModuleTranslation {\n         llcx: shared_ccx.metadata_llcx(),\n         llmod: shared_ccx.metadata_llmod(),"}, {"sha": "251a3a9768d78b0a5b428ea0c38370459e18a2ea", "filename": "src/test/run-make/msvc-data-only/Makefile", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Ftest%2Frun-make%2Fmsvc-data-only%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Ftest%2Frun-make%2Fmsvc-data-only%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fmsvc-data-only%2FMakefile?ref=e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "patch": "@@ -0,0 +1,8 @@\n+# Test that on *-pc-windows-msvc we can link to a rlib containing only data.\n+# See #26591, #27438\n+\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) foo.rs\n+\t$(RUSTC) bar.rs"}, {"sha": "0e3af9ff3fd485bdeb3231fc03c8f9b300abbd67", "filename": "src/test/run-make/msvc-data-only/bar.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Ftest%2Frun-make%2Fmsvc-data-only%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Ftest%2Frun-make%2Fmsvc-data-only%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fmsvc-data-only%2Fbar.rs?ref=e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+extern crate foo;\n+\n+fn main() {\n+    println!(\"The answer is {} !\", foo::FOO);\n+}"}, {"sha": "38bff8be125b6b0abf5c986207f6a2dd2944bc3c", "filename": "src/test/run-make/msvc-data-only/foo.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Ftest%2Frun-make%2Fmsvc-data-only%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e82bb915e4daede832b3dcb45df6b8f4cc3569c4/src%2Ftest%2Frun-make%2Fmsvc-data-only%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fmsvc-data-only%2Ffoo.rs?ref=e82bb915e4daede832b3dcb45df6b8f4cc3569c4", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type = \"rlib\"]\n+\n+pub static FOO: i32 = 42;"}]}