{"sha": "26f38c0f344f35e8d252ed756bf6794cbe974329", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI2ZjM4YzBmMzQ0ZjM1ZThkMjUyZWQ3NTZiZjY3OTRjYmU5NzQzMjk=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-08-26T23:54:06Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-08-26T23:54:06Z"}, "message": "Do not suggest dereferencing in macro", "tree": {"sha": "be4fbb6272c867fffbd9313b9208b612e246430b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be4fbb6272c867fffbd9313b9208b612e246430b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/26f38c0f344f35e8d252ed756bf6794cbe974329", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/26f38c0f344f35e8d252ed756bf6794cbe974329", "html_url": "https://github.com/rust-lang/rust/commit/26f38c0f344f35e8d252ed756bf6794cbe974329", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/26f38c0f344f35e8d252ed756bf6794cbe974329/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "caed80ba4ba8d9f4d3fa8aa9af6c4092d779cd9d", "url": "https://api.github.com/repos/rust-lang/rust/commits/caed80ba4ba8d9f4d3fa8aa9af6c4092d779cd9d", "html_url": "https://github.com/rust-lang/rust/commit/caed80ba4ba8d9f4d3fa8aa9af6c4092d779cd9d"}], "stats": {"total": 55, "additions": 37, "deletions": 18}, "files": [{"sha": "f0ca0df1b48bf37c0b5d96937b887951ab372c9c", "filename": "src/librustc_typeck/check/demand.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/26f38c0f344f35e8d252ed756bf6794cbe974329/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26f38c0f344f35e8d252ed756bf6794cbe974329/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs?ref=26f38c0f344f35e8d252ed756bf6794cbe974329", "patch": "@@ -351,11 +351,14 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n                             if !self.infcx.type_moves_by_default(self.param_env,\n                                                                 checked,\n                                                                 sp) {\n-                                let sp = cm.call_span_if_macro(sp);\n-                                if let Ok(code) = cm.span_to_snippet(sp) {\n-                                    return Some((sp,\n-                                                 \"consider dereferencing the borrow\",\n-                                                 format!(\"*{}\", code)));\n+                                // do not suggest if the span comes from a macro (#52783)\n+                                if let (Ok(code),\n+                                        true) = (cm.span_to_snippet(sp), sp == expr.span) {\n+                                    return Some((\n+                                        sp,\n+                                        \"consider dereferencing the borrow\",\n+                                        format!(\"*{}\", code),\n+                                    ));\n                                 }\n                             }\n                         }"}, {"sha": "49df7108f29a1da735ec1c150983d20a5c54b0c1", "filename": "src/test/ui/deref-suggestion.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/26f38c0f344f35e8d252ed756bf6794cbe974329/src%2Ftest%2Fui%2Fderef-suggestion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26f38c0f344f35e8d252ed756bf6794cbe974329/src%2Ftest%2Fui%2Fderef-suggestion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-suggestion.rs?ref=26f38c0f344f35e8d252ed756bf6794cbe974329", "patch": "@@ -15,20 +15,26 @@ macro_rules! borrow {\n fn foo(_: String) {}\n \n fn foo2(s: &String) {\n-    foo(s); //~ ERROR mismatched types\n+    foo(s);\n+    //~^ ERROR mismatched types\n }\n \n fn foo3(_: u32) {}\n fn foo4(u: &u32) {\n-    foo3(u); //~ ERROR mismatched types\n+    foo3(u);\n+    //~^ ERROR mismatched types\n }\n \n fn main() {\n     let s = String::new();\n     let r_s = &s;\n     foo2(r_s);\n-    foo(&\"aaa\".to_owned()); //~ ERROR mismatched types\n-    foo(&mut \"aaa\".to_owned()); //~ ERROR mismatched types\n+    foo(&\"aaa\".to_owned());\n+    //~^ ERROR mismatched types\n+    foo(&mut \"aaa\".to_owned());\n+    //~^ ERROR mismatched types\n     foo3(borrow!(0));\n     foo4(&0);\n-}\n+    assert_eq!(3i32, &3i32);\n+    //~^ ERROR mismatched types\n+}\n\\ No newline at end of file"}, {"sha": "9811c5969dad69ebc7d00ab10c10603cf02f2249", "filename": "src/test/ui/deref-suggestion.stderr", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/26f38c0f344f35e8d252ed756bf6794cbe974329/src%2Ftest%2Fui%2Fderef-suggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/26f38c0f344f35e8d252ed756bf6794cbe974329/src%2Ftest%2Fui%2Fderef-suggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-suggestion.stderr?ref=26f38c0f344f35e8d252ed756bf6794cbe974329", "patch": "@@ -1,7 +1,7 @@\n error[E0308]: mismatched types\n   --> $DIR/deref-suggestion.rs:18:9\n    |\n-LL |     foo(s); //~ ERROR mismatched types\n+LL |     foo(s);\n    |         ^\n    |         |\n    |         expected struct `std::string::String`, found reference\n@@ -11,9 +11,9 @@ LL |     foo(s); //~ ERROR mismatched types\n               found type `&std::string::String`\n \n error[E0308]: mismatched types\n-  --> $DIR/deref-suggestion.rs:23:10\n+  --> $DIR/deref-suggestion.rs:24:10\n    |\n-LL |     foo3(u); //~ ERROR mismatched types\n+LL |     foo3(u);\n    |          ^\n    |          |\n    |          expected u32, found &u32\n@@ -23,9 +23,9 @@ LL |     foo3(u); //~ ERROR mismatched types\n               found type `&u32`\n \n error[E0308]: mismatched types\n-  --> $DIR/deref-suggestion.rs:30:9\n+  --> $DIR/deref-suggestion.rs:32:9\n    |\n-LL |     foo(&\"aaa\".to_owned()); //~ ERROR mismatched types\n+LL |     foo(&\"aaa\".to_owned());\n    |         ^^^^^^^^^^^^^^^^^\n    |         |\n    |         expected struct `std::string::String`, found reference\n@@ -35,9 +35,9 @@ LL |     foo(&\"aaa\".to_owned()); //~ ERROR mismatched types\n               found type `&std::string::String`\n \n error[E0308]: mismatched types\n-  --> $DIR/deref-suggestion.rs:31:9\n+  --> $DIR/deref-suggestion.rs:34:9\n    |\n-LL |     foo(&mut \"aaa\".to_owned()); //~ ERROR mismatched types\n+LL |     foo(&mut \"aaa\".to_owned());\n    |         ^^^^^^^^^^^^^^^^^^^^^\n    |         |\n    |         expected struct `std::string::String`, found mutable reference\n@@ -58,6 +58,16 @@ LL |     foo3(borrow!(0));\n    = note: expected type `u32`\n               found type `&{integer}`\n \n-error: aborting due to 5 previous errors\n+error[E0308]: mismatched types\n+  --> $DIR/deref-suggestion.rs:38:5\n+   |\n+LL |     assert_eq!(3i32, &3i32);\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^ expected i32, found &i32\n+   |\n+   = note: expected type `i32`\n+              found type `&i32`\n+   = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)\n+\n+error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0308`."}]}