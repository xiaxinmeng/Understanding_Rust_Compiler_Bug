{"sha": "6fdb81fa17b3c7147a69edc5217c9f93ff485410", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmZGI4MWZhMTdiM2M3MTQ3YTY5ZWRjNTIxN2M5ZjkzZmY0ODU0MTA=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-03-16T01:05:29Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-03-16T01:05:29Z"}, "message": "rustc: Open \"use\"d crates with the LLVM object file reader", "tree": {"sha": "8597afa912813b40e1ce54436309c0e8df99bb30", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8597afa912813b40e1ce54436309c0e8df99bb30"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6fdb81fa17b3c7147a69edc5217c9f93ff485410", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6fdb81fa17b3c7147a69edc5217c9f93ff485410", "html_url": "https://github.com/rust-lang/rust/commit/6fdb81fa17b3c7147a69edc5217c9f93ff485410", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6fdb81fa17b3c7147a69edc5217c9f93ff485410/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "71b6e602c54f78dc2f8f33de2d74b40879316165", "url": "https://api.github.com/repos/rust-lang/rust/commits/71b6e602c54f78dc2f8f33de2d74b40879316165", "html_url": "https://github.com/rust-lang/rust/commit/71b6e602c54f78dc2f8f33de2d74b40879316165"}], "stats": {"total": 30, "additions": 27, "deletions": 3}, "files": [{"sha": "2a4b4c57c25cb78cb94b84b3144ff25d3fc17e84", "filename": "src/comp/front/creader.rs", "status": "modified", "additions": 26, "deletions": 3, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/6fdb81fa17b3c7147a69edc5217c9f93ff485410/src%2Fcomp%2Ffront%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fdb81fa17b3c7147a69edc5217c9f93ff485410/src%2Fcomp%2Ffront%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Ffront%2Fcreader.rs?ref=6fdb81fa17b3c7147a69edc5217c9f93ff485410", "patch": "@@ -2,11 +2,17 @@\n \n import driver.session;\n import front.ast;\n+import lib.llvm.llvmext;\n+import lib.llvm.mk_memory_buffer;\n+import lib.llvm.mk_object_file;\n+import lib.llvm.mk_section_iter;\n import middle.fold;\n import util.common;\n import util.common.span;\n \n+import std._str;\n import std.fs;\n+import std.os;\n import std.map.hashmap;\n \n // TODO: map to a real type here.\n@@ -17,12 +23,29 @@ type env = @rec(\n \n // TODO: return something\n fn load_crate(ast.ident ident, vec[str] library_search_paths) -> @() {\n+    auto filename = os.dylib_filename(ident);\n     for (str library_search_path in library_search_paths) {\n-        auto path = fs.connect(library_search_path, ident);\n-        // TODO\n+        auto path = fs.connect(library_search_path, filename);\n+        auto pb = _str.buf(path);\n+        auto llmb = llvmext.LLVMRustCreateMemoryBufferWithContentsOfFile(pb);\n+        if ((llmb as int) != 0) {\n+            auto llof = mk_object_file(llmb);\n+            if ((llof.llof as int) != 0) {\n+                auto llsi = mk_section_iter(llof.llof);\n+                while ((llvmext.LLVMIsSectionIteratorAtEnd(llof.llof,\n+                        llsi.llsi) as int) == 0) {\n+                    // TODO: check name, pass contents off.\n+\n+                    llvmext.LLVMMoveToNextSection(llsi.llsi);\n+                }\n+            }\n+        }\n     }\n \n-    ret @();\n+    // TODO: write line number of \"use\" statement\n+    log #fmt(\"can't find a crate named '%s' (looked for '%s' in %s)\",\n+        ident, filename, _str.connect(library_search_paths, \", \"));\n+    fail;\n }\n \n fn fold_view_item_use(&env e, &span sp, ast.ident ident,"}, {"sha": "4bf1161d0b8465e4f8848bcd6517891253fedc44", "filename": "src/comp/rustc.rc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6fdb81fa17b3c7147a69edc5217c9f93ff485410/src%2Fcomp%2Frustc.rc", "raw_url": "https://github.com/rust-lang/rust/raw/6fdb81fa17b3c7147a69edc5217c9f93ff485410/src%2Fcomp%2Frustc.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Frustc.rc?ref=6fdb81fa17b3c7147a69edc5217c9f93ff485410", "patch": "@@ -42,6 +42,7 @@ mod util {\n }\n \n auth driver.rustc.main = impure;\n+auth front.creader.load_crate = unsafe;\n auth middle.metadata = unsafe;\n auth middle.trans = unsafe;\n auth middle.trans.copy_args_to_allocas = impure;"}]}