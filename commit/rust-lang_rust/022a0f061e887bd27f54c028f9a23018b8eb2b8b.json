{"sha": "022a0f061e887bd27f54c028f9a23018b8eb2b8b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyMmEwZjA2MWU4ODdiZDI3ZjU0YzAyOGY5YTIzMDE4YjhlYjJiOGI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-17T17:20:32Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-17T17:28:27Z"}, "message": "Correctly parse attributes on fn parameters", "tree": {"sha": "6f1f7c1c7ba6300c87350946f0033d73c02f9546", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6f1f7c1c7ba6300c87350946f0033d73c02f9546"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/022a0f061e887bd27f54c028f9a23018b8eb2b8b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/022a0f061e887bd27f54c028f9a23018b8eb2b8b", "html_url": "https://github.com/rust-lang/rust/commit/022a0f061e887bd27f54c028f9a23018b8eb2b8b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/022a0f061e887bd27f54c028f9a23018b8eb2b8b/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0a6471384529bd8861c628756695c52be4c6837f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a6471384529bd8861c628756695c52be4c6837f", "html_url": "https://github.com/rust-lang/rust/commit/0a6471384529bd8861c628756695c52be4c6837f"}], "stats": {"total": 127, "additions": 71, "deletions": 56}, "files": [{"sha": "9e2f02d43560445fb46b5906374e4d97d04ba8b2", "filename": "crates/parser/src/grammar/params.rs", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/022a0f061e887bd27f54c028f9a23018b8eb2b8b/crates%2Fparser%2Fsrc%2Fgrammar%2Fparams.rs", "raw_url": "https://github.com/rust-lang/rust/raw/022a0f061e887bd27f54c028f9a23018b8eb2b8b/crates%2Fparser%2Fsrc%2Fgrammar%2Fparams.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fparser%2Fsrc%2Fgrammar%2Fparams.rs?ref=022a0f061e887bd27f54c028f9a23018b8eb2b8b", "patch": "@@ -41,22 +41,32 @@ fn list_(p: &mut Parser, flavor: Flavor) {\n         FnDef | FnTrait | FnPointer => (T!['('], T![')']),\n     };\n \n-    let m = p.start();\n+    let list_marker = p.start();\n     p.bump(bra);\n \n+    let mut param_marker = None;\n     if let FnDef = flavor {\n         // test self_param_outer_attr\n         // fn f(#[must_use] self) {}\n         let m = p.start();\n         attributes::outer_attrs(p);\n-        opt_self_param(p, m);\n+        match opt_self_param(p, m) {\n+            Ok(()) => {}\n+            Err(m) => param_marker = Some(m),\n+        }\n     }\n \n     while !p.at(EOF) && !p.at(ket) {\n         // test param_outer_arg\n         // fn f(#[attr1] pat: Type) {}\n-        let m = p.start();\n-        attributes::outer_attrs(p);\n+        let m = match param_marker.take() {\n+            Some(m) => m,\n+            None => {\n+                let m = p.start();\n+                attributes::outer_attrs(p);\n+                m\n+            }\n+        };\n \n         if !p.at_ts(PARAM_FIRST) {\n             p.error(\"expected value parameter\");\n@@ -72,8 +82,12 @@ fn list_(p: &mut Parser, flavor: Flavor) {\n         }\n     }\n \n+    if let Some(m) = param_marker {\n+        m.abandon(p);\n+    }\n+\n     p.expect(ket);\n-    m.complete(p, PARAM_LIST);\n+    list_marker.complete(p, PARAM_LIST);\n }\n \n const PARAM_FIRST: TokenSet = patterns::PATTERN_FIRST.union(types::TYPE_FIRST);\n@@ -153,7 +167,7 @@ fn variadic_param(p: &mut Parser) -> bool {\n //     fn d(&'a mut self, x: i32) {}\n //     fn e(mut self) {}\n // }\n-fn opt_self_param(p: &mut Parser, m: Marker) {\n+fn opt_self_param(p: &mut Parser, m: Marker) -> Result<(), Marker> {\n     if p.at(T![self]) || p.at(T![mut]) && p.nth(1) == T![self] {\n         p.eat(T![mut]);\n         self_as_name(p);\n@@ -176,7 +190,7 @@ fn opt_self_param(p: &mut Parser, m: Marker) {\n                 | (T![&], LIFETIME_IDENT, T![self], _)\n                 | (T![&], LIFETIME_IDENT, T![mut], T![self])\n         ) {\n-            return m.abandon(p);\n+            return Err(m);\n         }\n         p.bump(T![&]);\n         if p.at(LIFETIME_IDENT) {\n@@ -189,6 +203,7 @@ fn opt_self_param(p: &mut Parser, m: Marker) {\n     if !p.at(T![')']) {\n         p.expect(T![,]);\n     }\n+    Ok(())\n }\n \n fn self_as_name(p: &mut Parser) {"}, {"sha": "a84088bf30dd0b6d96660a5f0bdc766c0e4cd82c", "filename": "crates/syntax/test_data/parser/inline/ok/0139_param_outer_arg.rast", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/022a0f061e887bd27f54c028f9a23018b8eb2b8b/crates%2Fsyntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0139_param_outer_arg.rast", "raw_url": "https://github.com/rust-lang/rust/raw/022a0f061e887bd27f54c028f9a23018b8eb2b8b/crates%2Fsyntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0139_param_outer_arg.rast", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0139_param_outer_arg.rast?ref=022a0f061e887bd27f54c028f9a23018b8eb2b8b", "patch": "@@ -6,16 +6,16 @@ SOURCE_FILE@0..28\n       IDENT@3..4 \"f\"\n     PARAM_LIST@4..24\n       L_PAREN@4..5 \"(\"\n-      ATTR@5..13\n-        POUND@5..6 \"#\"\n-        L_BRACK@6..7 \"[\"\n-        PATH@7..12\n-          PATH_SEGMENT@7..12\n-            NAME_REF@7..12\n-              IDENT@7..12 \"attr1\"\n-        R_BRACK@12..13 \"]\"\n-      WHITESPACE@13..14 \" \"\n-      PARAM@14..23\n+      PARAM@5..23\n+        ATTR@5..13\n+          POUND@5..6 \"#\"\n+          L_BRACK@6..7 \"[\"\n+          PATH@7..12\n+            PATH_SEGMENT@7..12\n+              NAME_REF@7..12\n+                IDENT@7..12 \"attr1\"\n+          R_BRACK@12..13 \"]\"\n+        WHITESPACE@13..14 \" \"\n         IDENT_PAT@14..17\n           NAME@14..17\n             IDENT@14..17 \"pat\""}, {"sha": "88470c41c047e20e246e86db7352768350220032", "filename": "crates/syntax/test_data/parser/ok/0051_parameter_attrs.rast", "status": "modified", "additions": 39, "deletions": 39, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/022a0f061e887bd27f54c028f9a23018b8eb2b8b/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0051_parameter_attrs.rast", "raw_url": "https://github.com/rust-lang/rust/raw/022a0f061e887bd27f54c028f9a23018b8eb2b8b/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0051_parameter_attrs.rast", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0051_parameter_attrs.rast?ref=022a0f061e887bd27f54c028f9a23018b8eb2b8b", "patch": "@@ -6,25 +6,25 @@ SOURCE_FILE@0..519\n       IDENT@3..5 \"g1\"\n     PARAM_LIST@5..34\n       L_PAREN@5..6 \"(\"\n-      ATTR@6..14\n-        POUND@6..7 \"#\"\n-        L_BRACK@7..8 \"[\"\n-        PATH@8..13\n-          PATH_SEGMENT@8..13\n-            NAME_REF@8..13\n-              IDENT@8..13 \"attr1\"\n-        R_BRACK@13..14 \"]\"\n-      WHITESPACE@14..15 \" \"\n-      ATTR@15..23\n-        POUND@15..16 \"#\"\n-        L_BRACK@16..17 \"[\"\n-        PATH@17..22\n-          PATH_SEGMENT@17..22\n-            NAME_REF@17..22\n-              IDENT@17..22 \"attr2\"\n-        R_BRACK@22..23 \"]\"\n-      WHITESPACE@23..24 \" \"\n-      PARAM@24..33\n+      PARAM@6..33\n+        ATTR@6..14\n+          POUND@6..7 \"#\"\n+          L_BRACK@7..8 \"[\"\n+          PATH@8..13\n+            PATH_SEGMENT@8..13\n+              NAME_REF@8..13\n+                IDENT@8..13 \"attr1\"\n+          R_BRACK@13..14 \"]\"\n+        WHITESPACE@14..15 \" \"\n+        ATTR@15..23\n+          POUND@15..16 \"#\"\n+          L_BRACK@16..17 \"[\"\n+          PATH@17..22\n+            PATH_SEGMENT@17..22\n+              NAME_REF@17..22\n+                IDENT@17..22 \"attr2\"\n+          R_BRACK@22..23 \"]\"\n+        WHITESPACE@23..24 \" \"\n         IDENT_PAT@24..27\n           NAME@24..27\n             IDENT@24..27 \"pat\"\n@@ -48,16 +48,16 @@ SOURCE_FILE@0..519\n       IDENT@41..43 \"g2\"\n     PARAM_LIST@43..59\n       L_PAREN@43..44 \"(\"\n-      ATTR@44..52\n-        POUND@44..45 \"#\"\n-        L_BRACK@45..46 \"[\"\n-        PATH@46..51\n-          PATH_SEGMENT@46..51\n-            NAME_REF@46..51\n-              IDENT@46..51 \"attr1\"\n-        R_BRACK@51..52 \"]\"\n-      WHITESPACE@52..53 \" \"\n-      PARAM@53..58\n+      PARAM@44..58\n+        ATTR@44..52\n+          POUND@44..45 \"#\"\n+          L_BRACK@45..46 \"[\"\n+          PATH@46..51\n+            PATH_SEGMENT@46..51\n+              NAME_REF@46..51\n+                IDENT@46..51 \"attr1\"\n+          R_BRACK@51..52 \"]\"\n+        WHITESPACE@52..53 \" \"\n         IDENT_PAT@53..54\n           NAME@53..54\n             IDENT@53..54 \"x\"\n@@ -203,16 +203,16 @@ SOURCE_FILE@0..519\n           IDENT@193..196 \"bar\"\n         PARAM_LIST@196..233\n           L_PAREN@196..197 \"(\"\n-          ATTR@197..204\n-            POUND@197..198 \"#\"\n-            L_BRACK@198..199 \"[\"\n-            PATH@199..203\n-              PATH_SEGMENT@199..203\n-                NAME_REF@199..203\n-                  IDENT@199..203 \"attr\"\n-            R_BRACK@203..204 \"]\"\n-          WHITESPACE@204..205 \" \"\n-          PARAM@205..211\n+          PARAM@197..211\n+            ATTR@197..204\n+              POUND@197..198 \"#\"\n+              L_BRACK@198..199 \"[\"\n+              PATH@199..203\n+                PATH_SEGMENT@199..203\n+                  NAME_REF@199..203\n+                    IDENT@199..203 \"attr\"\n+              R_BRACK@203..204 \"]\"\n+            WHITESPACE@204..205 \" \"\n             WILDCARD_PAT@205..206\n               UNDERSCORE@205..206 \"_\"\n             COLON@206..207 \":\""}]}