{"sha": "1225e122fda8cfbe3a5da6007e912f204b97f8c4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyMjVlMTIyZmRhOGNmYmUzYTVkYTYwMDdlOTEyZjIwNGI5N2Y4YzQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-07-30T22:58:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-30T22:58:20Z"}, "message": "Auto merge of #34904 - petrochenkov:rustcall, r=nikomatsakis\n\nProperly feature gate all unstable ABIs\n\nFixes https://github.com/rust-lang/rust/issues/34900\n[breaking-change]\nr? @pnkfelix\n\n---\nFunction-visiting machinery for AST/HIR is surprisingly error-prone, it's *very* easy to miss some cases or visit something twice while writing a visitor. This is the true problem behind https://github.com/rust-lang/rust/issues/34900. I'll try to restructure these visitors a bit and send one more PR later.", "tree": {"sha": "fbfd07e09c0072d30c173e72d80fcf81790acf02", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fbfd07e09c0072d30c173e72d80fcf81790acf02"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1225e122fda8cfbe3a5da6007e912f204b97f8c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1225e122fda8cfbe3a5da6007e912f204b97f8c4", "html_url": "https://github.com/rust-lang/rust/commit/1225e122fda8cfbe3a5da6007e912f204b97f8c4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1225e122fda8cfbe3a5da6007e912f204b97f8c4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9dba50b0595be75852d27afa03c85622cdf03d6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/9dba50b0595be75852d27afa03c85622cdf03d6f", "html_url": "https://github.com/rust-lang/rust/commit/9dba50b0595be75852d27afa03c85622cdf03d6f"}, {"sha": "9292c0bc91a9165a2dc7baa4d154079ad0a5f5c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/9292c0bc91a9165a2dc7baa4d154079ad0a5f5c9", "html_url": "https://github.com/rust-lang/rust/commit/9292c0bc91a9165a2dc7baa4d154079ad0a5f5c9"}], "stats": {"total": 176, "additions": 103, "deletions": 73}, "files": [{"sha": "1470eac98295e8860c02464d7e445e68e2593aeb", "filename": "src/doc/book/closures.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Fdoc%2Fbook%2Fclosures.md", "raw_url": "https://github.com/rust-lang/rust/raw/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Fdoc%2Fbook%2Fclosures.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fbook%2Fclosures.md?ref=1225e122fda8cfbe3a5da6007e912f204b97f8c4", "patch": "@@ -223,6 +223,7 @@ trait system to overload operators. Calling functions is no different. We have\n three separate traits to overload with:\n \n ```rust\n+# #![feature(unboxed_closures)]\n # mod foo {\n pub trait Fn<Args> : FnMut<Args> {\n     extern \"rust-call\" fn call(&self, args: Args) -> Self::Output;"}, {"sha": "29da0fb1a2735aa14c4ac71633ac9be97f9b9ebb", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 41, "deletions": 32, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=1225e122fda8cfbe3a5da6007e912f204b97f8c4", "patch": "@@ -810,6 +810,29 @@ macro_rules! gate_feature_post {\n     }}\n }\n \n+impl<'a> PostExpansionVisitor<'a> {\n+    fn check_abi(&self, abi: Abi, span: Span) {\n+        match abi {\n+            Abi::RustIntrinsic =>\n+                gate_feature_post!(&self, intrinsics, span,\n+                                   \"intrinsics are subject to change\"),\n+            Abi::PlatformIntrinsic => {\n+                gate_feature_post!(&self, platform_intrinsics, span,\n+                                   \"platform intrinsics are experimental and possibly buggy\")\n+            },\n+            Abi::Vectorcall => {\n+                gate_feature_post!(&self, abi_vectorcall, span,\n+                                   \"vectorcall is experimental and subject to change\")\n+            }\n+            Abi::RustCall => {\n+                gate_feature_post!(&self, unboxed_closures, span,\n+                                   \"rust-call ABI is subject to change\");\n+            }\n+            _ => {}\n+        }\n+    }\n+}\n+\n impl<'a> Visitor for PostExpansionVisitor<'a> {\n     fn visit_attribute(&mut self, attr: &ast::Attribute) {\n         if !self.context.cm.span_allows_unstable(attr.span) {\n@@ -841,21 +864,7 @@ impl<'a> Visitor for PostExpansionVisitor<'a> {\n                                        across platforms, it is recommended to \\\n                                        use `#[link(name = \\\"foo\\\")]` instead\")\n                 }\n-                match foreign_module.abi {\n-                    Abi::RustIntrinsic =>\n-                        gate_feature_post!(&self, intrinsics, i.span,\n-                                           \"intrinsics are subject to change\"),\n-                    Abi::PlatformIntrinsic => {\n-                        gate_feature_post!(&self, platform_intrinsics, i.span,\n-                                           \"platform intrinsics are experimental \\\n-                                            and possibly buggy\")\n-                    },\n-                    Abi::Vectorcall => {\n-                        gate_feature_post!(&self, abi_vectorcall, i.span,\n-                                           \"vectorcall is experimental and subject to change\")\n-                    }\n-                    _ => ()\n-                }\n+                self.check_abi(foreign_module.abi, i.span);\n             }\n \n             ast::ItemKind::Fn(..) => {\n@@ -938,6 +947,16 @@ impl<'a> Visitor for PostExpansionVisitor<'a> {\n         visit::walk_foreign_item(self, i)\n     }\n \n+    fn visit_ty(&mut self, ty: &ast::Ty) {\n+        match ty.node {\n+            ast::TyKind::BareFn(ref bare_fn_ty) => {\n+                self.check_abi(bare_fn_ty.abi, ty.span);\n+            }\n+            _ => {}\n+        }\n+        visit::walk_ty(self, ty)\n+    }\n+\n     fn visit_expr(&mut self, e: &ast::Expr) {\n         match e.node {\n             ast::ExprKind::Box(_) => {\n@@ -1025,23 +1044,10 @@ impl<'a> Visitor for PostExpansionVisitor<'a> {\n         }\n \n         match fn_kind {\n-            FnKind::ItemFn(_, _, _, _, abi, _) if abi == Abi::RustIntrinsic => {\n-                gate_feature_post!(&self, intrinsics,\n-                                  span,\n-                                  \"intrinsics are subject to change\")\n-            }\n             FnKind::ItemFn(_, _, _, _, abi, _) |\n-            FnKind::Method(_, &ast::MethodSig { abi, .. }, _) => match abi {\n-                Abi::RustCall => {\n-                    gate_feature_post!(&self, unboxed_closures, span,\n-                        \"rust-call ABI is subject to change\");\n-                },\n-                Abi::Vectorcall => {\n-                    gate_feature_post!(&self, abi_vectorcall, span,\n-                        \"vectorcall is experimental and subject to change\");\n-                },\n-                _ => {}\n-            },\n+            FnKind::Method(_, &ast::MethodSig { abi, .. }, _) => {\n+                self.check_abi(abi, span);\n+            }\n             _ => {}\n         }\n         visit::walk_fn(self, fn_kind, fn_decl, block, span);\n@@ -1054,7 +1060,10 @@ impl<'a> Visitor for PostExpansionVisitor<'a> {\n                                   ti.span,\n                                   \"associated constants are experimental\")\n             }\n-            ast::TraitItemKind::Method(ref sig, _) => {\n+            ast::TraitItemKind::Method(ref sig, ref block) => {\n+                if block.is_none() {\n+                    self.check_abi(sig.abi, ti.span);\n+                }\n                 if sig.constness == ast::Constness::Const {\n                     gate_feature_post!(&self, const_fn, ti.span, \"const fn is unstable\");\n                 }"}, {"sha": "2a731596b4be8005c57ac9ba2ecdee156654b9d4", "filename": "src/test/compile-fail/E0045.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Ftest%2Fcompile-fail%2FE0045.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Ftest%2Fcompile-fail%2FE0045.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2FE0045.rs?ref=1225e122fda8cfbe3a5da6007e912f204b97f8c4", "patch": "@@ -8,7 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-extern \"rust-call\" { fn foo(x: u8, ...); } //~ ERROR E0045\n+extern \"Rust\" { fn foo(x: u8, ...); } //~ ERROR E0045\n \n fn main() {\n }"}, {"sha": "79f3c8dc7762589a5d440a1011720b641f1da6f8", "filename": "src/test/compile-fail/feature-gate-abi-vectorcall.rs", "status": "removed", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/9dba50b0595be75852d27afa03c85622cdf03d6f/src%2Ftest%2Fcompile-fail%2Ffeature-gate-abi-vectorcall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dba50b0595be75852d27afa03c85622cdf03d6f/src%2Ftest%2Fcompile-fail%2Ffeature-gate-abi-vectorcall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-abi-vectorcall.rs?ref=9dba50b0595be75852d27afa03c85622cdf03d6f", "patch": "@@ -1,19 +0,0 @@\n-// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-extern \"vectorcall\" {   //~ ERROR vectorcall is experimental and subject to change\n-    fn bar();\n-}\n-\n-extern \"vectorcall\" fn baz() {  //~ ERROR vectorcall is experimental and subject to change\n-}\n-\n-fn main() {\n-}"}, {"sha": "0c01f955c063bbdf5c5a605b36eac664592d55b5", "filename": "src/test/compile-fail/feature-gate-abi.rs", "status": "added", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Ftest%2Fcompile-fail%2Ffeature-gate-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1225e122fda8cfbe3a5da6007e912f204b97f8c4/src%2Ftest%2Fcompile-fail%2Ffeature-gate-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-abi.rs?ref=1225e122fda8cfbe3a5da6007e912f204b97f8c4", "patch": "@@ -0,0 +1,60 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Functions\n+extern \"rust-intrinsic\" fn f1() {} //~ ERROR intrinsics are subject to change\n+extern \"platform-intrinsic\" fn f2() {} //~ ERROR platform intrinsics are experimental\n+extern \"vectorcall\" fn f3() {} //~ ERROR vectorcall is experimental and subject to change\n+extern \"rust-call\" fn f4() {} //~ ERROR rust-call ABI is subject to change\n+\n+// Methods in trait definition\n+trait Tr {\n+    extern \"rust-intrinsic\" fn m1(); //~ ERROR intrinsics are subject to change\n+    extern \"platform-intrinsic\" fn m2(); //~ ERROR platform intrinsics are experimental\n+    extern \"vectorcall\" fn m3(); //~ ERROR vectorcall is experimental and subject to change\n+    extern \"rust-call\" fn m4(); //~ ERROR rust-call ABI is subject to change\n+\n+    extern \"rust-intrinsic\" fn dm1() {} //~ ERROR intrinsics are subject to change\n+    extern \"platform-intrinsic\" fn dm2() {} //~ ERROR platform intrinsics are experimental\n+    extern \"vectorcall\" fn dm3() {} //~ ERROR vectorcall is experimental and subject to change\n+    extern \"rust-call\" fn dm4() {} //~ ERROR rust-call ABI is subject to change\n+}\n+\n+struct S;\n+\n+// Methods in trait impl\n+impl Tr for S {\n+    extern \"rust-intrinsic\" fn m1() {} //~ ERROR intrinsics are subject to change\n+    extern \"platform-intrinsic\" fn m2() {} //~ ERROR platform intrinsics are experimental\n+    extern \"vectorcall\" fn m3() {} //~ ERROR vectorcall is experimental and subject to change\n+    extern \"rust-call\" fn m4() {} //~ ERROR rust-call ABI is subject to change\n+}\n+\n+// Methods in inherent impl\n+impl S {\n+    extern \"rust-intrinsic\" fn im1() {} //~ ERROR intrinsics are subject to change\n+    extern \"platform-intrinsic\" fn im2() {} //~ ERROR platform intrinsics are experimental\n+    extern \"vectorcall\" fn im3() {} //~ ERROR vectorcall is experimental and subject to change\n+    extern \"rust-call\" fn im4() {} //~ ERROR rust-call ABI is subject to change\n+}\n+\n+// Function pointer types\n+type A1 = extern \"rust-intrinsic\" fn(); //~ ERROR intrinsics are subject to change\n+type A2 = extern \"platform-intrinsic\" fn(); //~ ERROR platform intrinsics are experimental\n+type A3 = extern \"vectorcall\" fn(); //~ ERROR vectorcall is experimental and subject to change\n+type A4 = extern \"rust-call\" fn(); //~ ERROR rust-call ABI is subject to change\n+\n+// Foreign modules\n+extern \"rust-intrinsic\" {} //~ ERROR intrinsics are subject to change\n+extern \"platform-intrinsic\" {} //~ ERROR platform intrinsics are experimental\n+extern \"vectorcall\" {} //~ ERROR vectorcall is experimental and subject to change\n+extern \"rust-call\" {} //~ ERROR rust-call ABI is subject to change\n+\n+fn main() {}"}, {"sha": "029a9cad65fcfe3869fa53904eb47ca1dbfad181", "filename": "src/test/compile-fail/feature-gate-rust-call.rs", "status": "removed", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/9dba50b0595be75852d27afa03c85622cdf03d6f/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rust-call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dba50b0595be75852d27afa03c85622cdf03d6f/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rust-call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rust-call.rs?ref=9dba50b0595be75852d27afa03c85622cdf03d6f", "patch": "@@ -1,21 +0,0 @@\n-// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-extern \"rust-call\" fn foo() { } //~ ERROR rust-call ABI is subject to change\n-\n-trait Foo {\n-    extern \"rust-call\" fn foo();\n-}\n-\n-impl Foo for i32 {\n-    extern \"rust-call\" fn foo() { } //~ ERROR rust-call ABI is subject to change\n-}\n-\n-fn main() { }"}]}