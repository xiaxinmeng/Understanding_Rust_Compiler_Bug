{"sha": "62c260de8c621f577d33970613c6b611e2de7d8e", "node_id": "C_kwDOAAsO6NoAKDYyYzI2MGRlOGM2MjFmNTc3ZDMzOTcwNjEzYzZiNjExZTJkZTdkOGU", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-06-07T09:41:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-07T09:41:08Z"}, "message": "Rollup merge of #97738 - Kixiron:zst-panic, r=eddyb\n\nFix ICEs from zsts within unsized types with non-zero offsets\n\n- Fixes #97732\n- Fixes ICEs while compiling `alloc` with `-Z randomize-layout`\n\nr? ``@eddyb``", "tree": {"sha": "b1cd703d752f77cb4db9803fa762a537728fc3e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1cd703d752f77cb4db9803fa762a537728fc3e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62c260de8c621f577d33970613c6b611e2de7d8e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJinx00CRBK7hj4Ov3rIwAAXBAIAKFUHnyoGarIn8NjQnM1KGQU\neqHcSM+hEep3G2k7chB6Wsi1g1IcoNmInAJf9y16WSidx4Vq1EVRNmtaUW6YbLHf\nU406z2UvrLRsmKrIPdB1mlb9/iRY7iulJf0JqS4fBspqo3BY3rOy/FI2ynfmto6z\nwfeUQU/becI3y7YhtgCMLuIz9DY+4rn/UJn/oWXlVgaw48DItGiNpyvZfxA3YkRg\n3X2eQ6/gQ+HIgR6r/KcE48aFxw94kkwChteUnHo8fxOCXq1iw658E82KOt0nm9IH\nZw2o3nkQ8Oj5QL6VhLG81ug6h1rxSZx2muCjAKxyYxvlRPMgLdinuXj+qRuIrvo=\n=2AsQ\n-----END PGP SIGNATURE-----\n", "payload": "tree b1cd703d752f77cb4db9803fa762a537728fc3e1\nparent 2035b50d80e32a0fe192c73399baf702ea1c411d\nparent 10336cf1624ada36e8ba64e851d4df3f2976da81\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1654594868 +0200\ncommitter GitHub <noreply@github.com> 1654594868 +0200\n\nRollup merge of #97738 - Kixiron:zst-panic, r=eddyb\n\nFix ICEs from zsts within unsized types with non-zero offsets\n\n- Fixes #97732\n- Fixes ICEs while compiling `alloc` with `-Z randomize-layout`\n\nr? ``@eddyb``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62c260de8c621f577d33970613c6b611e2de7d8e", "html_url": "https://github.com/rust-lang/rust/commit/62c260de8c621f577d33970613c6b611e2de7d8e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62c260de8c621f577d33970613c6b611e2de7d8e/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2035b50d80e32a0fe192c73399baf702ea1c411d", "url": "https://api.github.com/repos/rust-lang/rust/commits/2035b50d80e32a0fe192c73399baf702ea1c411d", "html_url": "https://github.com/rust-lang/rust/commit/2035b50d80e32a0fe192c73399baf702ea1c411d"}, {"sha": "10336cf1624ada36e8ba64e851d4df3f2976da81", "url": "https://api.github.com/repos/rust-lang/rust/commits/10336cf1624ada36e8ba64e851d4df3f2976da81", "html_url": "https://github.com/rust-lang/rust/commit/10336cf1624ada36e8ba64e851d4df3f2976da81"}], "stats": {"total": 33, "additions": 31, "deletions": 2}, "files": [{"sha": "7e2e85ead5469044af314f1cf226195cc19dd08e", "filename": "compiler/rustc_codegen_ssa/src/base.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/62c260de8c621f577d33970613c6b611e2de7d8e/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c260de8c621f577d33970613c6b611e2de7d8e/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs?ref=62c260de8c621f577d33970613c6b611e2de7d8e", "patch": "@@ -216,11 +216,12 @@ pub fn unsize_ptr<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n             let mut result = None;\n             for i in 0..src_layout.fields.count() {\n                 let src_f = src_layout.field(bx.cx(), i);\n-                assert_eq!(src_layout.fields.offset(i).bytes(), 0);\n-                assert_eq!(dst_layout.fields.offset(i).bytes(), 0);\n                 if src_f.is_zst() {\n                     continue;\n                 }\n+\n+                assert_eq!(src_layout.fields.offset(i).bytes(), 0);\n+                assert_eq!(dst_layout.fields.offset(i).bytes(), 0);\n                 assert_eq!(src_layout.size, src_f.size);\n \n                 let dst_f = dst_layout.field(bx.cx(), i);"}, {"sha": "72f765033969a69ecc50266c6a90078e6084257c", "filename": "src/test/ui/unsized/issue-97732.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/62c260de8c621f577d33970613c6b611e2de7d8e/src%2Ftest%2Fui%2Funsized%2Fissue-97732.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c260de8c621f577d33970613c6b611e2de7d8e/src%2Ftest%2Fui%2Funsized%2Fissue-97732.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsized%2Fissue-97732.rs?ref=62c260de8c621f577d33970613c6b611e2de7d8e", "patch": "@@ -0,0 +1,28 @@\n+// check-pass\n+\n+#![feature(coerce_unsized)]\n+\n+// Ensure that unsizing structs that contain ZSTs at non-zero offsets don't ICE\n+\n+use std::ops::CoerceUnsized;\n+\n+#[repr(C)]\n+pub struct BoxWithZstTail<T: ?Sized>(Box<T>, ());\n+\n+impl<S: ?Sized, T: ?Sized> CoerceUnsized<BoxWithZstTail<T>> for BoxWithZstTail<S> where\n+    Box<S>: CoerceUnsized<Box<T>>\n+{\n+}\n+\n+pub fn noop_dyn_upcast_with_zst_tail(\n+    b: BoxWithZstTail<dyn ToString + Send>,\n+) -> BoxWithZstTail<dyn ToString> {\n+    b\n+}\n+\n+fn main() {\n+    let original = \"foo\";\n+    let boxed = BoxWithZstTail(Box::new(original) as Box<dyn ToString + Send>, ());\n+    let noop_upcasted = noop_dyn_upcast_with_zst_tail(boxed);\n+    assert_eq!(original, noop_upcasted.0.to_string());\n+}"}]}