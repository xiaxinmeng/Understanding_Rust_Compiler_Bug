{"sha": "88a19197b9f57b84a091c34d59c3d9ae72f03511", "node_id": "C_kwDOAAsO6NoAKDg4YTE5MTk3YjlmNTdiODRhMDkxYzM0ZDU5YzNkOWFlNzJmMDM1MTE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-16T07:36:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-16T07:36:11Z"}, "message": "Rollup merge of #104193 - TaKO8Ki:fix-104142, r=cjgillot\n\nShift no characters when using raw string literals\n\nFixes #104142\n\nGiven the following code:\n\n```rust\nfn main() {\n    println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#);\n}\n```\n\nThe current output is:\n\n```\nerror: invalid format string: unmatched `}` found\n --> src/main.rs:2:59\n  |\n2 |     println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#); //~ ERROR invalid format string: unmatched `}` found\n  |                                                           ^ unmatched `}` in format string\n  |\n  = note: if you intended to print `}`, you can escape it using `}}`\n\nerror: could not compile `debug_playground` due to previous error\n```\n\nThe output should look like:\n\n```\nerror: invalid format string: unmatched `}` found\n --> src/main.rs:2:45\n  |\n2 |     println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#); //~ ERROR invalid format string: unmatched `}` found\n  |                                             ^ unmatched `}` in format string\n  |\n  = note: if you intended to print `}`, you can escape it using `}}`\n\nerror: could not compile `debug_playground` due to previous error\n```\n\nThis pull request fixes the wrong span for `invalid format string` error and also solves the ICE.", "tree": {"sha": "3ce9f8c94c0ad22433de9f93c38a3bc0e5e5de60", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ce9f8c94c0ad22433de9f93c38a3bc0e5e5de60"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/88a19197b9f57b84a091c34d59c3d9ae72f03511", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjdJLrCRBK7hj4Ov3rIwAAZvIIAJmsZJTlQfXwRTjrC2ObOpaZ\nCA0f9mXeBC796KOeMCphkevwb3XFvupfvr3UJKtmSCNGX9EfQf5eO5yg3yy2NSCI\nKwp761YY2iyPJeidzoTP7J7r/3YQWDSjcbyZCpTDYuKRmjJD/xJNi04ngZka8J41\nt6OW8oTEk4gb/MEAhq9PRELuNLV3XC2SjCjK8B8iLy9Y0CkglzUxk9rpUv5RaC7j\nWdbco8pEPCuDE5qkQtRFlhKP41Kx1wLIUVLOJ7K8MIPHdxMpfbdVEn5tt/dIfvDI\noA3OG2nQHDI+COuv7tNgTa+ETQf5sl4f04De1TtNAdbRBzBXWg9eQRh7/H9TYyI=\n=rGqD\n-----END PGP SIGNATURE-----\n", "payload": "tree 3ce9f8c94c0ad22433de9f93c38a3bc0e5e5de60\nparent 91963cc244f4986818dadbb2c73dd6f67e779802\nparent 9857de218f10cfbe750d4c8165d960ae0da63cf4\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1668584171 +0100\ncommitter GitHub <noreply@github.com> 1668584171 +0100\n\nRollup merge of #104193 - TaKO8Ki:fix-104142, r=cjgillot\n\nShift no characters when using raw string literals\n\nFixes #104142\n\nGiven the following code:\n\n```rust\nfn main() {\n    println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#);\n}\n```\n\nThe current output is:\n\n```\nerror: invalid format string: unmatched `}` found\n --> src/main.rs:2:59\n  |\n2 |     println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#); //~ ERROR invalid format string: unmatched `}` found\n  |                                                           ^ unmatched `}` in format string\n  |\n  = note: if you intended to print `}`, you can escape it using `}}`\n\nerror: could not compile `debug_playground` due to previous error\n```\n\nThe output should look like:\n\n```\nerror: invalid format string: unmatched `}` found\n --> src/main.rs:2:45\n  |\n2 |     println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#); //~ ERROR invalid format string: unmatched `}` found\n  |                                             ^ unmatched `}` in format string\n  |\n  = note: if you intended to print `}`, you can escape it using `}}`\n\nerror: could not compile `debug_playground` due to previous error\n```\n\nThis pull request fixes the wrong span for `invalid format string` error and also solves the ICE.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/88a19197b9f57b84a091c34d59c3d9ae72f03511", "html_url": "https://github.com/rust-lang/rust/commit/88a19197b9f57b84a091c34d59c3d9ae72f03511", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/88a19197b9f57b84a091c34d59c3d9ae72f03511/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91963cc244f4986818dadbb2c73dd6f67e779802", "url": "https://api.github.com/repos/rust-lang/rust/commits/91963cc244f4986818dadbb2c73dd6f67e779802", "html_url": "https://github.com/rust-lang/rust/commit/91963cc244f4986818dadbb2c73dd6f67e779802"}, {"sha": "9857de218f10cfbe750d4c8165d960ae0da63cf4", "url": "https://api.github.com/repos/rust-lang/rust/commits/9857de218f10cfbe750d4c8165d960ae0da63cf4", "html_url": "https://github.com/rust-lang/rust/commit/9857de218f10cfbe750d4c8165d960ae0da63cf4"}], "stats": {"total": 179, "additions": 103, "deletions": 76}, "files": [{"sha": "0113eb4e3d1029911abf26519c4b742b2e62630e", "filename": "compiler/rustc_parse_format/src/lib.rs", "status": "modified", "additions": 74, "deletions": 76, "changes": 150, "blob_url": "https://github.com/rust-lang/rust/blob/88a19197b9f57b84a091c34d59c3d9ae72f03511/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88a19197b9f57b84a091c34d59c3d9ae72f03511/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs?ref=88a19197b9f57b84a091c34d59c3d9ae72f03511", "patch": "@@ -818,96 +818,94 @@ fn find_skips_from_snippet(\n         _ => return (vec![], false),\n     };\n \n-    fn find_skips(snippet: &str, is_raw: bool) -> Vec<usize> {\n-        let mut s = snippet.char_indices();\n-        let mut skips = vec![];\n-        while let Some((pos, c)) = s.next() {\n-            match (c, s.clone().next()) {\n-                // skip whitespace and empty lines ending in '\\\\'\n-                ('\\\\', Some((next_pos, '\\n'))) if !is_raw => {\n-                    skips.push(pos);\n-                    skips.push(next_pos);\n-                    let _ = s.next();\n+    if str_style.is_some() {\n+        return (vec![], true);\n+    }\n \n-                    while let Some((pos, c)) = s.clone().next() {\n-                        if matches!(c, ' ' | '\\n' | '\\t') {\n-                            skips.push(pos);\n-                            let _ = s.next();\n-                        } else {\n-                            break;\n-                        }\n-                    }\n-                }\n-                ('\\\\', Some((next_pos, 'n' | 't' | 'r' | '0' | '\\\\' | '\\'' | '\\\"'))) => {\n-                    skips.push(next_pos);\n-                    let _ = s.next();\n-                }\n-                ('\\\\', Some((_, 'x'))) if !is_raw => {\n-                    for _ in 0..3 {\n-                        // consume `\\xAB` literal\n-                        if let Some((pos, _)) = s.next() {\n-                            skips.push(pos);\n-                        } else {\n-                            break;\n-                        }\n+    let snippet = &snippet[1..snippet.len() - 1];\n+\n+    let mut s = snippet.char_indices();\n+    let mut skips = vec![];\n+    while let Some((pos, c)) = s.next() {\n+        match (c, s.clone().next()) {\n+            // skip whitespace and empty lines ending in '\\\\'\n+            ('\\\\', Some((next_pos, '\\n'))) => {\n+                skips.push(pos);\n+                skips.push(next_pos);\n+                let _ = s.next();\n+\n+                while let Some((pos, c)) = s.clone().next() {\n+                    if matches!(c, ' ' | '\\n' | '\\t') {\n+                        skips.push(pos);\n+                        let _ = s.next();\n+                    } else {\n+                        break;\n                     }\n                 }\n-                ('\\\\', Some((_, 'u'))) if !is_raw => {\n+            }\n+            ('\\\\', Some((next_pos, 'n' | 't' | 'r' | '0' | '\\\\' | '\\'' | '\\\"'))) => {\n+                skips.push(next_pos);\n+                let _ = s.next();\n+            }\n+            ('\\\\', Some((_, 'x'))) => {\n+                for _ in 0..3 {\n+                    // consume `\\xAB` literal\n                     if let Some((pos, _)) = s.next() {\n                         skips.push(pos);\n+                    } else {\n+                        break;\n                     }\n-                    if let Some((next_pos, next_c)) = s.next() {\n-                        if next_c == '{' {\n-                            // consume up to 6 hexanumeric chars\n-                            let digits_len =\n-                                s.clone().take(6).take_while(|(_, c)| c.is_digit(16)).count();\n-\n-                            let len_utf8 = s\n-                                .as_str()\n-                                .get(..digits_len)\n-                                .and_then(|digits| u32::from_str_radix(digits, 16).ok())\n-                                .and_then(char::from_u32)\n-                                .map_or(1, char::len_utf8);\n-\n-                            // Skip the digits, for chars that encode to more than 1 utf-8 byte\n-                            // exclude as many digits as it is greater than 1 byte\n-                            //\n-                            // So for a 3 byte character, exclude 2 digits\n-                            let required_skips =\n-                                digits_len.saturating_sub(len_utf8.saturating_sub(1));\n-\n-                            // skip '{' and '}' also\n-                            for pos in (next_pos..).take(required_skips + 2) {\n-                                skips.push(pos)\n-                            }\n+                }\n+            }\n+            ('\\\\', Some((_, 'u'))) => {\n+                if let Some((pos, _)) = s.next() {\n+                    skips.push(pos);\n+                }\n+                if let Some((next_pos, next_c)) = s.next() {\n+                    if next_c == '{' {\n+                        // consume up to 6 hexanumeric chars\n+                        let digits_len =\n+                            s.clone().take(6).take_while(|(_, c)| c.is_digit(16)).count();\n+\n+                        let len_utf8 = s\n+                            .as_str()\n+                            .get(..digits_len)\n+                            .and_then(|digits| u32::from_str_radix(digits, 16).ok())\n+                            .and_then(char::from_u32)\n+                            .map_or(1, char::len_utf8);\n+\n+                        // Skip the digits, for chars that encode to more than 1 utf-8 byte\n+                        // exclude as many digits as it is greater than 1 byte\n+                        //\n+                        // So for a 3 byte character, exclude 2 digits\n+                        let required_skips = digits_len.saturating_sub(len_utf8.saturating_sub(1));\n+\n+                        // skip '{' and '}' also\n+                        for pos in (next_pos..).take(required_skips + 2) {\n+                            skips.push(pos)\n+                        }\n \n-                            s.nth(digits_len);\n-                        } else if next_c.is_digit(16) {\n-                            skips.push(next_pos);\n-                            // We suggest adding `{` and `}` when appropriate, accept it here as if\n-                            // it were correct\n-                            let mut i = 0; // consume up to 6 hexanumeric chars\n-                            while let (Some((next_pos, c)), _) = (s.next(), i < 6) {\n-                                if c.is_digit(16) {\n-                                    skips.push(next_pos);\n-                                } else {\n-                                    break;\n-                                }\n-                                i += 1;\n+                        s.nth(digits_len);\n+                    } else if next_c.is_digit(16) {\n+                        skips.push(next_pos);\n+                        // We suggest adding `{` and `}` when appropriate, accept it here as if\n+                        // it were correct\n+                        let mut i = 0; // consume up to 6 hexanumeric chars\n+                        while let (Some((next_pos, c)), _) = (s.next(), i < 6) {\n+                            if c.is_digit(16) {\n+                                skips.push(next_pos);\n+                            } else {\n+                                break;\n                             }\n+                            i += 1;\n                         }\n                     }\n                 }\n-                _ => {}\n             }\n+            _ => {}\n         }\n-        skips\n     }\n-\n-    let r_start = str_style.map_or(0, |r| r + 1);\n-    let r_end = str_style.unwrap_or(0);\n-    let s = &snippet[r_start + 1..snippet.len() - r_end - 1];\n-    (find_skips(s, str_style.is_some()), true)\n+    (skips, true)\n }\n \n #[cfg(test)]"}, {"sha": "9f0bc01a749cf52c88b7671fcf8233d77c15fb3f", "filename": "src/test/ui/fmt/format-raw-string-error.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fformat-raw-string-error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fformat-raw-string-error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Fformat-raw-string-error.rs?ref=88a19197b9f57b84a091c34d59c3d9ae72f03511", "patch": "@@ -0,0 +1,3 @@\n+fn main() {\n+    println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#); //~ ERROR invalid format string: unmatched `}` found\n+}"}, {"sha": "8d61950d8c2adf0399664e5551d2f0ae8e55c287", "filename": "src/test/ui/fmt/format-raw-string-error.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fformat-raw-string-error.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fformat-raw-string-error.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Fformat-raw-string-error.stderr?ref=88a19197b9f57b84a091c34d59c3d9ae72f03511", "patch": "@@ -0,0 +1,10 @@\n+error: invalid format string: unmatched `}` found\n+  --> $DIR/format-raw-string-error.rs:2:45\n+   |\n+LL |     println!(r#\"\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'\\'}\"#);\n+   |                                             ^ unmatched `}` in format string\n+   |\n+   = note: if you intended to print `}`, you can escape it using `}}`\n+\n+error: aborting due to previous error\n+"}, {"sha": "8d7283a7197807ceb4496dece340d7fa6e60715b", "filename": "src/test/ui/fmt/issue-104142.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fissue-104142.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fissue-104142.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Fissue-104142.rs?ref=88a19197b9f57b84a091c34d59c3d9ae72f03511", "patch": "@@ -0,0 +1,6 @@\n+fn main() {\n+    println!(\n+        r#\"\n+    \\\"\\'}\uff64\"# //~ ERROR invalid format string: unmatched `}` found\n+    );\n+}"}, {"sha": "d41644faa2827a04f9ed0e5a01333a91caf3aa73", "filename": "src/test/ui/fmt/issue-104142.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fissue-104142.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/88a19197b9f57b84a091c34d59c3d9ae72f03511/src%2Ftest%2Fui%2Ffmt%2Fissue-104142.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Fissue-104142.stderr?ref=88a19197b9f57b84a091c34d59c3d9ae72f03511", "patch": "@@ -0,0 +1,10 @@\n+error: invalid format string: unmatched `}` found\n+  --> $DIR/issue-104142.rs:4:9\n+   |\n+LL |     \\\"\\'}\uff64\"#\n+   |         ^ unmatched `}` in format string\n+   |\n+   = note: if you intended to print `}`, you can escape it using `}}`\n+\n+error: aborting due to previous error\n+"}]}