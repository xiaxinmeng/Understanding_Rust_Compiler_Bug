{"sha": "8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "node_id": "C_kwDOAAsO6NoAKDhhOWQ2YmY0ZmQ1NDBiMmEyODgyMTkzY2JkNjIzMmI4NmU1ZGNkN2U", "commit": {"author": {"name": "onestacked", "email": "chrisi.schrefl@gmail.com", "date": "2023-02-04T16:48:46Z"}, "committer": {"name": "onestacked", "email": "chrisi.schrefl@gmail.com", "date": "2023-03-18T08:17:37Z"}, "message": "Mark DoubleEndedIterator as #[const_trait] using rustc_do_not_const_check, implement const Iterator and DoubleEndedIterator for Range.", "tree": {"sha": "c0ce385558ad256a9b9098842b485a8012c13c79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c0ce385558ad256a9b9098842b485a8012c13c79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "html_url": "https://github.com/rust-lang/rust/commit/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/comments", "author": {"login": "chriss0612", "id": 18047460, "node_id": "MDQ6VXNlcjE4MDQ3NDYw", "avatar_url": "https://avatars.githubusercontent.com/u/18047460?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chriss0612", "html_url": "https://github.com/chriss0612", "followers_url": "https://api.github.com/users/chriss0612/followers", "following_url": "https://api.github.com/users/chriss0612/following{/other_user}", "gists_url": "https://api.github.com/users/chriss0612/gists{/gist_id}", "starred_url": "https://api.github.com/users/chriss0612/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chriss0612/subscriptions", "organizations_url": "https://api.github.com/users/chriss0612/orgs", "repos_url": "https://api.github.com/users/chriss0612/repos", "events_url": "https://api.github.com/users/chriss0612/events{/privacy}", "received_events_url": "https://api.github.com/users/chriss0612/received_events", "type": "User", "site_admin": false}, "committer": {"login": "chriss0612", "id": 18047460, "node_id": "MDQ6VXNlcjE4MDQ3NDYw", "avatar_url": "https://avatars.githubusercontent.com/u/18047460?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chriss0612", "html_url": "https://github.com/chriss0612", "followers_url": "https://api.github.com/users/chriss0612/followers", "following_url": "https://api.github.com/users/chriss0612/following{/other_user}", "gists_url": "https://api.github.com/users/chriss0612/gists{/gist_id}", "starred_url": "https://api.github.com/users/chriss0612/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chriss0612/subscriptions", "organizations_url": "https://api.github.com/users/chriss0612/orgs", "repos_url": "https://api.github.com/users/chriss0612/repos", "events_url": "https://api.github.com/users/chriss0612/events{/privacy}", "received_events_url": "https://api.github.com/users/chriss0612/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7bc67ef6e02d69023c6fb04c2258beab54ac22b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bc67ef6e02d69023c6fb04c2258beab54ac22b8", "html_url": "https://github.com/rust-lang/rust/commit/7bc67ef6e02d69023c6fb04c2258beab54ac22b8"}], "stats": {"total": 94, "additions": 70, "deletions": 24}, "files": [{"sha": "f19636fba5d95fdde9209b61da38ca554b347a78", "filename": "library/core/src/iter/range.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Fiter%2Frange.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Fiter%2Frange.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Frange.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -1,4 +1,5 @@\n use crate::convert::TryFrom;\n+use crate::marker::Destruct;\n use crate::mem;\n use crate::ops::{self, Try};\n \n@@ -522,6 +523,7 @@ macro_rules! range_incl_exact_iter_impl {\n }\n \n /// Specialization implementations for `Range`.\n+#[const_trait]\n trait RangeIteratorImpl {\n     type Item;\n \n@@ -536,7 +538,7 @@ trait RangeIteratorImpl {\n     fn spec_advance_back_by(&mut self, n: usize) -> Result<(), usize>;\n }\n \n-impl<A: Step> RangeIteratorImpl for ops::Range<A> {\n+impl<A: ~const Step + ~const Destruct> const RangeIteratorImpl for ops::Range<A> {\n     type Item = A;\n \n     #[inline]\n@@ -622,7 +624,7 @@ impl<A: Step> RangeIteratorImpl for ops::Range<A> {\n     }\n }\n \n-impl<T: TrustedStep> RangeIteratorImpl for ops::Range<T> {\n+impl<T: ~const TrustedStep + ~const Destruct> const RangeIteratorImpl for ops::Range<T> {\n     #[inline]\n     fn spec_next(&mut self) -> Option<T> {\n         if self.start < self.end {\n@@ -710,7 +712,8 @@ impl<T: TrustedStep> RangeIteratorImpl for ops::Range<T> {\n }\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-impl<A: Step> Iterator for ops::Range<A> {\n+#[rustc_const_unstable(feature = \"const_iter\", issue = \"92476\")]\n+impl<A: ~const Step + ~const Destruct> const Iterator for ops::Range<A> {\n     type Item = A;\n \n     #[inline]\n@@ -820,7 +823,8 @@ range_incl_exact_iter_impl! {\n }\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-impl<A: Step> DoubleEndedIterator for ops::Range<A> {\n+#[rustc_const_unstable(feature = \"const_iter\", issue = \"92476\")]\n+impl<A: ~const Step + ~const Destruct> const DoubleEndedIterator for ops::Range<A> {\n     #[inline]\n     fn next_back(&mut self) -> Option<A> {\n         self.spec_next_back()"}, {"sha": "7a10dea500a969a7e344d79b97cf3f6c590535b0", "filename": "library/core/src/iter/traits/double_ended.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fdouble_ended.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fdouble_ended.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fdouble_ended.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -1,3 +1,4 @@\n+use crate::marker::Destruct;\n use crate::ops::{ControlFlow, Try};\n \n /// An iterator able to yield elements from both ends.\n@@ -37,6 +38,7 @@ use crate::ops::{ControlFlow, Try};\n /// ```\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n #[cfg_attr(not(test), rustc_diagnostic_item = \"DoubleEndedIterator\")]\n+#[const_trait]\n pub trait DoubleEndedIterator: Iterator {\n     /// Removes and returns an element from the end of the iterator.\n     ///\n@@ -131,7 +133,10 @@ pub trait DoubleEndedIterator: Iterator {\n     /// [`Err(k)`]: Err\n     #[inline]\n     #[unstable(feature = \"iter_advance_by\", reason = \"recently added\", issue = \"77404\")]\n-    fn advance_back_by(&mut self, n: usize) -> Result<(), usize> {\n+    fn advance_back_by(&mut self, n: usize) -> Result<(), usize>\n+    where\n+        Self::Item: ~const Destruct,\n+    {\n         for i in 0..n {\n             self.next_back().ok_or(i)?;\n         }\n@@ -181,6 +186,7 @@ pub trait DoubleEndedIterator: Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iter_nth_back\", since = \"1.37.0\")]\n+    #[rustc_do_not_const_check]\n     fn nth_back(&mut self, n: usize) -> Option<Self::Item> {\n         self.advance_back_by(n).ok()?;\n         self.next_back()\n@@ -218,6 +224,7 @@ pub trait DoubleEndedIterator: Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iterator_try_fold\", since = \"1.27.0\")]\n+    #[rustc_do_not_const_check]\n     fn try_rfold<B, F, R>(&mut self, init: B, mut f: F) -> R\n     where\n         Self: Sized,\n@@ -289,6 +296,7 @@ pub trait DoubleEndedIterator: Iterator {\n     #[doc(alias = \"foldr\")]\n     #[inline]\n     #[stable(feature = \"iter_rfold\", since = \"1.27.0\")]\n+    #[rustc_do_not_const_check]\n     fn rfold<B, F>(mut self, init: B, mut f: F) -> B\n     where\n         Self: Sized,\n@@ -344,6 +352,7 @@ pub trait DoubleEndedIterator: Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"iter_rfind\", since = \"1.27.0\")]\n+    #[rustc_do_not_const_check]\n     fn rfind<P>(&mut self, predicate: P) -> Option<Self::Item>\n     where\n         Self: Sized,"}, {"sha": "6fc86550b63e75bd081303a20e46be2db8159ff8", "filename": "library/core/src/iter/traits/iterator.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -1,5 +1,6 @@\n use crate::array;\n use crate::cmp::{self, Ordering};\n+use crate::marker::Destruct;\n use crate::ops::{ChangeOutputType, ControlFlow, FromResidual, Residual, Try};\n \n use super::super::try_process;\n@@ -336,8 +337,10 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"iter_advance_by\", reason = \"recently added\", issue = \"77404\")]\n-    #[rustc_do_not_const_check]\n-    fn advance_by(&mut self, n: usize) -> Result<(), usize> {\n+    fn advance_by(&mut self, n: usize) -> Result<(), usize>\n+    where\n+        Self::Item: ~const Destruct,\n+    {\n         for i in 0..n {\n             self.next().ok_or(i)?;\n         }\n@@ -385,8 +388,10 @@ pub trait Iterator {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    #[rustc_do_not_const_check]\n-    fn nth(&mut self, n: usize) -> Option<Self::Item> {\n+    fn nth(&mut self, n: usize) -> Option<Self::Item>\n+    where\n+        Self::Item: ~const Destruct,\n+    {\n         self.advance_by(n).ok()?;\n         self.next()\n     }"}, {"sha": "1076d357070ef5ee265cc807b75de0698f80021d", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -123,6 +123,7 @@\n #![feature(const_index_range_slice_index)]\n #![feature(const_inherent_unchecked_arith)]\n #![feature(const_int_unchecked_arith)]\n+#![feature(const_intoiterator_identity)]\n #![feature(const_intrinsic_forget)]\n #![feature(const_ipv4)]\n #![feature(const_ipv6)]"}, {"sha": "d56687e48c96a0d15a3e56477c52219fedda8253", "filename": "library/core/tests/iter/consts.rs", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Ftests%2Fiter%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Ftests%2Fiter%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fiter%2Fconsts.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -0,0 +1,36 @@\n+#[test]\n+fn const_manual_iter() {\n+    struct S(bool);\n+\n+    impl const Iterator for S {\n+        type Item = ();\n+\n+        fn next(&mut self) -> Option<Self::Item> {\n+            if self.0 == false {\n+                self.0 = true;\n+                Some(())\n+            } else {\n+                None\n+            }\n+        }\n+    }\n+    const {\n+        let mut val = S(false);\n+        assert!(val.next().is_some());\n+        assert!(val.next().is_none());\n+        assert!(val.next().is_none());\n+    }\n+}\n+\n+#[test]\n+fn const_range() {\n+    const {\n+        let mut arr = [0; 3];\n+        for i in 0..arr.len() {\n+            arr[i] = i;\n+        }\n+        assert!(arr[0] == 0);\n+        assert!(arr[1] == 1);\n+        assert!(arr[2] == 2);\n+    }\n+}"}, {"sha": "cbb18e79e2d430de00d042d5759e565f4415a249", "filename": "library/core/tests/iter/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Ftests%2Fiter%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Ftests%2Fiter%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fiter%2Fmod.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -20,6 +20,8 @@ mod range;\n mod sources;\n mod traits;\n \n+mod consts;\n+\n use core::cell::Cell;\n use core::convert::TryFrom;\n use core::iter::*;"}, {"sha": "637cc6e9f629bfffc8625047e58bc1bea247d399", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -12,8 +12,11 @@\n #![feature(const_caller_location)]\n #![feature(const_cell_into_inner)]\n #![feature(const_convert)]\n+#![feature(const_for)]\n #![feature(const_hash)]\n #![feature(const_heap)]\n+#![feature(const_intoiterator_identity)]\n+#![feature(const_iter)]\n #![feature(const_maybe_uninit_as_mut_ptr)]\n #![feature(const_maybe_uninit_assume_init_read)]\n #![feature(const_nonnull_new)]"}, {"sha": "e6f7dc410b6147512fcbd31fd377202cff4bf9ce", "filename": "tests/ui/typeck/typeck_type_placeholder_item.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -228,5 +228,4 @@ fn evens_squared(n: usize) -> _ {\n \n const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n //~^ ERROR the trait bound\n-//~| ERROR the trait bound\n //~| ERROR the placeholder"}, {"sha": "9144ab9e3a6bd39daea117d723c949abeaa5b094", "filename": "tests/ui/typeck/typeck_type_placeholder_item.stderr", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr?ref=8a9d6bf4fd540b2a2882193cbd6232b86e5dcd7e", "patch": "@@ -437,19 +437,6 @@ LL | fn evens_squared(n: usize) -> _ {\n    |                               not allowed in type signatures\n    |                               help: replace with an appropriate return type: `impl Iterator<Item = usize>`\n \n-error[E0277]: the trait bound `std::ops::Range<{integer}>: Iterator` is not satisfied\n-  --> $DIR/typeck_type_placeholder_item.rs:229:22\n-   |\n-LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n-   |                      ^^^^^^ `std::ops::Range<{integer}>` is not an iterator\n-   |\n-   = help: the trait `~const Iterator` is not implemented for `std::ops::Range<{integer}>`\n-note: the trait `Iterator` is implemented for `std::ops::Range<{integer}>`, but that implementation is not `const`\n-  --> $DIR/typeck_type_placeholder_item.rs:229:14\n-   |\n-LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n-   |              ^^^^^^^\n-\n error[E0277]: the trait bound `Filter<std::ops::Range<{integer}>, [closure@$DIR/typeck_type_placeholder_item.rs:229:29: 229:32]>: Iterator` is not satisfied\n   --> $DIR/typeck_type_placeholder_item.rs:229:45\n    |\n@@ -677,7 +664,7 @@ LL |     const D: _ = 42;\n    |              not allowed in type signatures\n    |              help: replace with the correct type: `i32`\n \n-error: aborting due to 73 previous errors\n+error: aborting due to 72 previous errors\n \n Some errors have detailed explanations: E0121, E0277, E0282, E0403.\n For more information about an error, try `rustc --explain E0121`."}]}