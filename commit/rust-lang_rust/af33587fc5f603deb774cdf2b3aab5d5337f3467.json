{"sha": "af33587fc5f603deb774cdf2b3aab5d5337f3467", "node_id": "C_kwDOAAsO6NoAKGFmMzM1ODdmYzVmNjAzZGViNzc0Y2RmMmIzYWFiNWQ1MzM3ZjM0Njc", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-09-29T17:15:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-29T17:15:20Z"}, "message": "Rollup merge of #102468 - RalfJung:tidy, r=jyn514\n\ntidy: make rustc dependency error less confusing\n\nThe current wording leads to very confusing messages:\n```\ntidy error: Dependencies for main workspace not explicitly permitted:\n* unicode-ident 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)\n```\nMiri is part of that workspace, and there never was a problem adding Miri dependencies. The actual error is that due to a crate bump this now showed up as a rustc dependency, and *those* are restricted.", "tree": {"sha": "0dbbadcfb9959c049e285929e41cc9d927d6fa0b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0dbbadcfb9959c049e285929e41cc9d927d6fa0b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af33587fc5f603deb774cdf2b3aab5d5337f3467", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjNdKoCRBK7hj4Ov3rIwAADZwIAJV1j8gAUyWN09LfK8CG5WI0\n6Ef8H/l6rTksAV52pF7OO0cSWCcJ67iYljHlP7pxQXA3HCGPsTIsB4MVpg6Z8+Wk\nOAmpJZQPVR5udgmErhwyfkVmf2x6MIy7EfAIhlDaWsYgmobgzsqoOTBfz9I4nBg6\n1iJetu24V/fEgjplJdW9yNLX4zHe/yQW1YpCsqjfe0oM2juNEzn1xNiqN4b8FG09\nM2bYsMk+5DHj69kwZZyFdJ+gnZHG09t8hwddR9AQ/kn9tlpN0cUFTOFG1iJa80Vv\n8szJgjkL9TO36755eTU5tUmi4ONwFrQxHmXXs9IjgYLejeaShMCw+qevbqAP0wU=\n=bMSD\n-----END PGP SIGNATURE-----\n", "payload": "tree 0dbbadcfb9959c049e285929e41cc9d927d6fa0b\nparent 8a73397a62a77429a64e4b8a04e2094e05bbfefe\nparent 79ad594488716b36305bd06feb565860812e4d6a\nauthor Michael Howell <michael@notriddle.com> 1664471720 -0700\ncommitter GitHub <noreply@github.com> 1664471720 -0700\n\nRollup merge of #102468 - RalfJung:tidy, r=jyn514\n\ntidy: make rustc dependency error less confusing\n\nThe current wording leads to very confusing messages:\n```\ntidy error: Dependencies for main workspace not explicitly permitted:\n* unicode-ident 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)\n```\nMiri is part of that workspace, and there never was a problem adding Miri dependencies. The actual error is that due to a crate bump this now showed up as a rustc dependency, and *those* are restricted.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af33587fc5f603deb774cdf2b3aab5d5337f3467", "html_url": "https://github.com/rust-lang/rust/commit/af33587fc5f603deb774cdf2b3aab5d5337f3467", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af33587fc5f603deb774cdf2b3aab5d5337f3467/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a73397a62a77429a64e4b8a04e2094e05bbfefe", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a73397a62a77429a64e4b8a04e2094e05bbfefe", "html_url": "https://github.com/rust-lang/rust/commit/8a73397a62a77429a64e4b8a04e2094e05bbfefe"}, {"sha": "79ad594488716b36305bd06feb565860812e4d6a", "url": "https://api.github.com/repos/rust-lang/rust/commits/79ad594488716b36305bd06feb565860812e4d6a", "html_url": "https://github.com/rust-lang/rust/commit/79ad594488716b36305bd06feb565860812e4d6a"}], "stats": {"total": 33, "additions": 15, "deletions": 18}, "files": [{"sha": "d4733107e793dfe318531e64ab00b4110effb9ca", "filename": "src/tools/tidy/src/deps.rs", "status": "modified", "additions": 15, "deletions": 18, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/af33587fc5f603deb774cdf2b3aab5d5337f3467/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af33587fc5f603deb774cdf2b3aab5d5337f3467/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs?ref=af33587fc5f603deb774cdf2b3aab5d5337f3467", "patch": "@@ -73,14 +73,11 @@ const EXCEPTIONS_BOOTSTRAP: &[(&str, &str)] = &[\n /// these and all their dependencies *must not* be in the exception list.\n const RUNTIME_CRATES: &[&str] = &[\"std\", \"core\", \"alloc\", \"test\", \"panic_abort\", \"panic_unwind\"];\n \n-/// Crates whose dependencies must be explicitly permitted.\n-const RESTRICTED_DEPENDENCY_CRATES: &[&str] = &[\"rustc_driver\", \"rustc_codegen_llvm\"];\n-\n /// Crates rustc is allowed to depend on. Avoid adding to the list if possible.\n ///\n /// This list is here to provide a speed-bump to adding a new dependency to\n /// rustc. Please check with the compiler team before adding an entry.\n-const PERMITTED_DEPENDENCIES: &[&str] = &[\n+const PERMITTED_RUSTC_DEPENDENCIES: &[&str] = &[\n     \"addr2line\",\n     \"adler\",\n     \"ahash\",\n@@ -307,7 +304,7 @@ const PERMITTED_CRANELIFT_DEPENDENCIES: &[&str] = &[\n ];\n \n const FORBIDDEN_TO_HAVE_DUPLICATES: &[&str] = &[\n-    // These two crates take quite a long time to build, so don't allow two versions of them\n+    // This crate takes quite a long time to build, so don't allow two versions of them\n     // to accidentally sneak into our dependency graph, in order to ensure we keep our CI times\n     // under control.\n     \"cargo\",\n@@ -324,12 +321,12 @@ pub fn check(root: &Path, cargo: &Path, bad: &mut bool) {\n         .features(cargo_metadata::CargoOpt::AllFeatures);\n     let metadata = t!(cmd.exec());\n     let runtime_ids = compute_runtime_crates(&metadata);\n-    check_exceptions(&metadata, EXCEPTIONS, runtime_ids, bad);\n-    check_dependencies(\n+    check_license_exceptions(&metadata, EXCEPTIONS, runtime_ids, bad);\n+    check_permitted_dependencies(\n         &metadata,\n-        \"main workspace\",\n-        PERMITTED_DEPENDENCIES,\n-        RESTRICTED_DEPENDENCY_CRATES,\n+        \"rustc\",\n+        PERMITTED_RUSTC_DEPENDENCIES,\n+        &[\"rustc_driver\", \"rustc_codegen_llvm\"],\n         bad,\n     );\n     check_crate_duplicate(&metadata, FORBIDDEN_TO_HAVE_DUPLICATES, bad);\n@@ -342,8 +339,8 @@ pub fn check(root: &Path, cargo: &Path, bad: &mut bool) {\n         .features(cargo_metadata::CargoOpt::AllFeatures);\n     let metadata = t!(cmd.exec());\n     let runtime_ids = HashSet::new();\n-    check_exceptions(&metadata, EXCEPTIONS_CRANELIFT, runtime_ids, bad);\n-    check_dependencies(\n+    check_license_exceptions(&metadata, EXCEPTIONS_CRANELIFT, runtime_ids, bad);\n+    check_permitted_dependencies(\n         &metadata,\n         \"cranelift\",\n         PERMITTED_CRANELIFT_DEPENDENCIES,\n@@ -358,13 +355,13 @@ pub fn check(root: &Path, cargo: &Path, bad: &mut bool) {\n         .features(cargo_metadata::CargoOpt::AllFeatures);\n     let metadata = t!(cmd.exec());\n     let runtime_ids = HashSet::new();\n-    check_exceptions(&metadata, EXCEPTIONS_BOOTSTRAP, runtime_ids, bad);\n+    check_license_exceptions(&metadata, EXCEPTIONS_BOOTSTRAP, runtime_ids, bad);\n }\n \n /// Check that all licenses are in the valid list in `LICENSES`.\n ///\n-/// Packages listed in `EXCEPTIONS` are allowed for tools.\n-fn check_exceptions(\n+/// Packages listed in `exceptions` are allowed for tools.\n+fn check_license_exceptions(\n     metadata: &Metadata,\n     exceptions: &[(&str, &str)],\n     runtime_ids: HashSet<&PackageId>,\n@@ -434,11 +431,11 @@ fn check_exceptions(\n     }\n }\n \n-/// Checks the dependency of `RESTRICTED_DEPENDENCY_CRATES` at the given path. Changes `bad` to\n+/// Checks the dependency of `restricted_dependency_crates` at the given path. Changes `bad` to\n /// `true` if a check failed.\n ///\n-/// Specifically, this checks that the dependencies are on the `PERMITTED_DEPENDENCIES`.\n-fn check_dependencies(\n+/// Specifically, this checks that the dependencies are on the `permitted_dependencies`.\n+fn check_permitted_dependencies(\n     metadata: &Metadata,\n     descr: &str,\n     permitted_dependencies: &[&'static str],"}]}