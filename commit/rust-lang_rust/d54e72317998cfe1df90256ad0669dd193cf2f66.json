{"sha": "d54e72317998cfe1df90256ad0669dd193cf2f66", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1NGU3MjMxNzk5OGNmZTFkZjkwMjU2YWQwNjY5ZGQxOTNjZjJmNjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-12-18T04:38:27Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-12-18T04:38:27Z"}, "message": "Auto merge of #38440 - alexcrichton:fix-osx-nightlies, r=brson\n\nrustbuild: Fix LC_ID_DYLIB directives on OSX\n\nCurrently libraries installed by rustbuild on OSX have an incorrect\n`LC_ID_DYLIB` directive located in the dynamic libraries that are\ninstalled. The directive we expect looks like:\n\n    @rpath/libstd.dylib\n\nWhich means that if you want to find that dynamic library you should\nlook at the dylib's other `@rpath` directives. Typically our `@rpath`\ndirectives look like `@loader_path/../lib` for the compiler as that's\nwhere the installed libraries will be located. Currently, though,\nrustbuild produces dylibs with the directive that looks like:\n\n    /Users/rustbuild/src/rust-buildbot/slave/nightly-dist-rustc-mac/build/build/x86_64-apple-darwin/stage1-std/x86_64-apple-darwin/release/deps/libstd-713ad88203512705.dylib\n\nIn other words, the build directory is encoded erroneously. The compiler\nalready [knows how] to change this directive, but it only passes that\nargument when `-C rpath` is also passed. The rustbuild system, however,\nexplicitly [does not pass] this option explicitly and instead bakes its\nown. This logic then also erroneously didn't pass `-Wl,-install_name`\nlike the compiler.\n\n[knows how]: https://github.com/rust-lang/rust/blob/4a008cccaabc8b3fe65ccf5868b9d16319c9ac58/src/librustc_trans/back/linker.rs#L210-L214\n[does not pass]: https://github.com/rust-lang/rust/blob/4a008cccaabc8b3fe65ccf5868b9d16319c9ac58/src/bootstrap/bin/rustc.rs#L133-L158\n\nTo fix this regression this patch introduces a new `-Z` flag, `-Z\nosx-rpath-install-name` which basically just forces the compiler to take\nthe previous `-install_name` branch when creating a dynamic library.\nHopefully we can sort out a better rpath story in the future, but for\nnow this \"hack\" should suffice in getting our nightly builds back to the\nsame state as before.\n\nCloses #38430", "tree": {"sha": "5b78018b6c394f0ec47cc0b9837b2315e8c3012f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5b78018b6c394f0ec47cc0b9837b2315e8c3012f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d54e72317998cfe1df90256ad0669dd193cf2f66", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d54e72317998cfe1df90256ad0669dd193cf2f66", "html_url": "https://github.com/rust-lang/rust/commit/d54e72317998cfe1df90256ad0669dd193cf2f66", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d54e72317998cfe1df90256ad0669dd193cf2f66/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "32d02bbafa26c4986428669c7aefc231b0cc3915", "url": "https://api.github.com/repos/rust-lang/rust/commits/32d02bbafa26c4986428669c7aefc231b0cc3915", "html_url": "https://github.com/rust-lang/rust/commit/32d02bbafa26c4986428669c7aefc231b0cc3915"}, {"sha": "1b8e6c152c827751ee22bf8cfca6f6ca4ade2798", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b8e6c152c827751ee22bf8cfca6f6ca4ade2798", "html_url": "https://github.com/rust-lang/rust/commit/1b8e6c152c827751ee22bf8cfca6f6ca4ade2798"}], "stats": {"total": 18, "additions": 17, "deletions": 1}, "files": [{"sha": "20ff9d9af3c0ea2feb10bde885b2f121c54f0b81", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d54e72317998cfe1df90256ad0669dd193cf2f66/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d54e72317998cfe1df90256ad0669dd193cf2f66/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=d54e72317998cfe1df90256ad0669dd193cf2f66", "patch": "@@ -158,6 +158,15 @@ fn main() {\n         // to change a flag in a binary?\n         if env::var(\"RUSTC_RPATH\") == Ok(\"true\".to_string()) {\n             let rpath = if target.contains(\"apple\") {\n+\n+                // Note that we need to take one extra step on OSX to also pass\n+                // `-Wl,-instal_name,@rpath/...` to get things to work right. To\n+                // do that we pass a weird flag to the compiler to get it to do\n+                // so. Note that this is definitely a hack, and we should likely\n+                // flesh out rpath support more fully in the future.\n+                if stage != \"0\" {\n+                    cmd.arg(\"-Z\").arg(\"osx-rpath-install-name\");\n+                }\n                 Some(\"-Wl,-rpath,@loader_path/../lib\")\n             } else if !target.contains(\"windows\") {\n                 Some(\"-Wl,-rpath,$ORIGIN/../lib\")"}, {"sha": "a415d1f991fcd18a59817d98b9a8b06334769347", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d54e72317998cfe1df90256ad0669dd193cf2f66/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d54e72317998cfe1df90256ad0669dd193cf2f66/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=d54e72317998cfe1df90256ad0669dd193cf2f66", "patch": "@@ -928,6 +928,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n           \"print some statistics about MIR\"),\n     always_encode_mir: bool = (false, parse_bool, [TRACKED],\n           \"encode MIR of all functions into the crate metadata\"),\n+    osx_rpath_install_name: bool = (false, parse_bool, [TRACKED],\n+          \"pass `-install_name @rpath/...` to the OSX linker\"),\n }\n \n pub fn default_lib_output() -> CrateType {"}, {"sha": "a147b598940a234100258990cb4e2c53e0cf764c", "filename": "src/librustc_trans/back/linker.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d54e72317998cfe1df90256ad0669dd193cf2f66/src%2Flibrustc_trans%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d54e72317998cfe1df90256ad0669dd193cf2f66/src%2Flibrustc_trans%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flinker.rs?ref=d54e72317998cfe1df90256ad0669dd193cf2f66", "patch": "@@ -207,7 +207,12 @@ impl<'a> Linker for GnuLinker<'a> {\n         if self.sess.target.target.options.is_like_osx {\n             self.cmd.args(&[\"-dynamiclib\", \"-Wl,-dylib\"]);\n \n-            if self.sess.opts.cg.rpath {\n+            // Note that the `osx_rpath_install_name` option here is a hack\n+            // purely to support rustbuild right now, we should get a more\n+            // principled solution at some point to force the compiler to pass\n+            // the right `-Wl,-install_name` with an `@rpath` in it.\n+            if self.sess.opts.cg.rpath ||\n+               self.sess.opts.debugging_opts.osx_rpath_install_name {\n                 let mut v = OsString::from(\"-Wl,-install_name,@rpath/\");\n                 v.push(out_filename.file_name().unwrap());\n                 self.cmd.arg(&v);"}]}