{"sha": "0a916a43e9a0d2dd0143ce87d3f437148f7b0155", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhOTE2YTQzZTlhMGQyZGQwMTQzY2U4N2QzZjQzNzE0OGY3YjAxNTU=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-10-28T07:56:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-10-28T07:56:21Z"}, "message": "Rollup merge of #45505 - spk:use-expect-instead-unwrap, r=kennytm\n\nUse expect for current_dir on librustc/session mod\n\nReference bug https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=871638\n\nLike described on the reference bug report:\n\n~~~\n$ mkdir dir\n$ cd dir\n$ rm -rf ../dir\n$ RUST_BACKTRACE=1 rustc -C target-cpu=help\nerror: internal compiler error: unexpected panic\n\nnote: the compiler unexpectedly panicked. this is a bug.\n\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\n\nnote: run with `RUST_BACKTRACE=1` for a backtrace\n\nthread 'rustc' panicked at 'called `Result::unwrap()` on an `Err` value: Error { repr: Os { code: 2, message: \"No such file or directory\" } }', src/libcore/result.rs:837\nstack backtrace:\n   1:     0x7f7d23970dda - <unknown>\n   2:     0x7f7d2398305f - <unknown>\n   3:     0x7f7d2397f8a5 - <unknown>\n   4:     0x7f7d2397ffc7 - std::panicking::rust_panic_with_hook::h109e116a3a861224\n   5:     0x7f7d2397fe54 - <unknown>\n   6:     0x7f7d2397fd79 - std::panicking::begin_panic_fmt::h26713cea9bce3ab0\n   7:     0x7f7d2397fd07 - rust_begin_unwind\n   8:     0x7f7d239cb41d - core::panicking::panic_fmt::hcfbb59eeb7f27f75\n   9:     0x7f7d20be63d3 - <unknown>\n  10:     0x7f7d20d6ebcc - rustc::session::build_session_::h7a3559f2373a5d05\n  11:     0x7f7d20d6dd7e - rustc::session::build_session_with_codemap::h68bc7bcd2f34eee4\n  12:     0x7f7d20d6d72c - rustc::session::build_session::h437fda3c327a8bde\n  13:     0x7f7d23d26030 - <rustc_driver::RustcDefaultCalls as rustc_driver::CompilerCalls<'a>>::no_input::h8047df7741757d1c\n  14:     0x7f7d23d21d27 - rustc_driver::run_compiler::hafe7bbfedf95a825\n  15:     0x7f7d23c57378 - <unknown>\n  16:     0x7f7d2398ae0a - __rust_maybe_catch_panic\n  17:     0x7f7d23c76fa8 - <unknown>\n  18:     0x7f7d2397eb74 - <unknown>\n  19:     0x7f7d1ed4f493 - start_thread\n  20:     0x7f7d23645afe - __clone\n  21:                0x0 - <unknown>\n~~~\n\nWith this patch this will give instead:\n\n~~~\nerror: Current directory is invalid: No such file or directory (os error 2)\n~~~", "tree": {"sha": "c9fc29452a74d274c9f2e5b8675ad7d60efa9be8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c9fc29452a74d274c9f2e5b8675ad7d60efa9be8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a916a43e9a0d2dd0143ce87d3f437148f7b0155", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a916a43e9a0d2dd0143ce87d3f437148f7b0155", "html_url": "https://github.com/rust-lang/rust/commit/0a916a43e9a0d2dd0143ce87d3f437148f7b0155", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a916a43e9a0d2dd0143ce87d3f437148f7b0155/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "71b876bca0d5fe250f8579c853425f00fbd8e491", "url": "https://api.github.com/repos/rust-lang/rust/commits/71b876bca0d5fe250f8579c853425f00fbd8e491", "html_url": "https://github.com/rust-lang/rust/commit/71b876bca0d5fe250f8579c853425f00fbd8e491"}, {"sha": "cfc916ebf8a9039e321924ed111727c2fcfb3e70", "url": "https://api.github.com/repos/rust-lang/rust/commits/cfc916ebf8a9039e321924ed111727c2fcfb3e70", "html_url": "https://github.com/rust-lang/rust/commit/cfc916ebf8a9039e321924ed111727c2fcfb3e70"}], "stats": {"total": 7, "additions": 6, "deletions": 1}, "files": [{"sha": "c87881341daa240a436abc2e844f03417bb052e2", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0a916a43e9a0d2dd0143ce87d3f437148f7b0155/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a916a43e9a0d2dd0143ce87d3f437148f7b0155/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=0a916a43e9a0d2dd0143ce87d3f437148f7b0155", "patch": "@@ -776,7 +776,12 @@ pub fn build_session_(sopts: config::Options,\n     let print_fuel_crate = sopts.debugging_opts.print_fuel.clone();\n     let print_fuel = Cell::new(0);\n \n-    let working_dir = env::current_dir().unwrap().to_string_lossy().into_owned();\n+    let working_dir = match env::current_dir() {\n+        Ok(dir) => dir.to_string_lossy().into_owned(),\n+        Err(e) => {\n+            panic!(p_s.span_diagnostic.fatal(&format!(\"Current directory is invalid: {}\", e)))\n+        }\n+    };\n     let working_dir = file_path_mapping.map_prefix(working_dir);\n \n     let sess = Session {"}]}