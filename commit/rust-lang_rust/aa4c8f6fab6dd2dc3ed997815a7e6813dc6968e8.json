{"sha": "aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8", "node_id": "C_kwDOAAsO6NoAKGFhNGM4ZjZmYWI2ZGQyZGMzZWQ5OTc4MTVhN2U2ODEzZGM2OTY4ZTg", "commit": {"author": {"name": "Krasimir Georgiev", "email": "krasimir@google.com", "date": "2022-06-29T08:41:32Z"}, "committer": {"name": "Krasimir Georgiev", "email": "krasimir@google.com", "date": "2022-07-04T12:33:23Z"}, "message": "adapt native-link-modifier-bundle test to use llvm-nm", "tree": {"sha": "14d840dcee0e6130ee35ce3e80af39b45aeb7e58", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/14d840dcee0e6130ee35ce3e80af39b45aeb7e58"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8", "html_url": "https://github.com/rust-lang/rust/commit/aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8/comments", "author": {"login": "krasimirgg", "id": 29306214, "node_id": "MDQ6VXNlcjI5MzA2MjE0", "avatar_url": "https://avatars.githubusercontent.com/u/29306214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krasimirgg", "html_url": "https://github.com/krasimirgg", "followers_url": "https://api.github.com/users/krasimirgg/followers", "following_url": "https://api.github.com/users/krasimirgg/following{/other_user}", "gists_url": "https://api.github.com/users/krasimirgg/gists{/gist_id}", "starred_url": "https://api.github.com/users/krasimirgg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krasimirgg/subscriptions", "organizations_url": "https://api.github.com/users/krasimirgg/orgs", "repos_url": "https://api.github.com/users/krasimirgg/repos", "events_url": "https://api.github.com/users/krasimirgg/events{/privacy}", "received_events_url": "https://api.github.com/users/krasimirgg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "krasimirgg", "id": 29306214, "node_id": "MDQ6VXNlcjI5MzA2MjE0", "avatar_url": "https://avatars.githubusercontent.com/u/29306214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krasimirgg", "html_url": "https://github.com/krasimirgg", "followers_url": "https://api.github.com/users/krasimirgg/followers", "following_url": "https://api.github.com/users/krasimirgg/following{/other_user}", "gists_url": "https://api.github.com/users/krasimirgg/gists{/gist_id}", "starred_url": "https://api.github.com/users/krasimirgg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krasimirgg/subscriptions", "organizations_url": "https://api.github.com/users/krasimirgg/orgs", "repos_url": "https://api.github.com/users/krasimirgg/repos", "events_url": "https://api.github.com/users/krasimirgg/events{/privacy}", "received_events_url": "https://api.github.com/users/krasimirgg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "493c960a3e6cdd2e2fbe8b6ea130fadea05f1ab0", "url": "https://api.github.com/repos/rust-lang/rust/commits/493c960a3e6cdd2e2fbe8b6ea130fadea05f1ab0", "html_url": "https://github.com/rust-lang/rust/commit/493c960a3e6cdd2e2fbe8b6ea130fadea05f1ab0"}], "stats": {"total": 24, "additions": 14, "deletions": 10}, "files": [{"sha": "e4b0f74ac26ac00df92b796a91feba6b48067dde", "filename": "src/test/run-make/native-link-modifier-bundle/Makefile", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8/src%2Ftest%2Frun-make%2Fnative-link-modifier-bundle%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8/src%2Ftest%2Frun-make%2Fnative-link-modifier-bundle%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-bundle%2FMakefile?ref=aa4c8f6fab6dd2dc3ed997815a7e6813dc6968e8", "patch": "@@ -3,27 +3,31 @@\n \n -include ../../run-make-fulldeps/tools.mk\n \n+# We're using the llvm-nm instead of the system nm to ensure it is compatible\n+# with the LLVM bitcode generated by rustc.\n+NM = \"$(LLVM_BIN_DIR)\"/llvm-nm\n+\n all: $(call NATIVE_STATICLIB,native-staticlib)\n \t# Build a staticlib and a rlib, the `native_func` symbol will be bundled into them\n \t$(RUSTC) bundled.rs --crate-type=staticlib --crate-type=rlib\n-\tnm $(TMPDIR)/libbundled.a | $(CGREP) -e \"T _*native_func\"\n-\tnm $(TMPDIR)/libbundled.a | $(CGREP) -e \"U _*native_func\"\n-\tnm $(TMPDIR)/libbundled.rlib | $(CGREP) -e \"T _*native_func\"\n-\tnm $(TMPDIR)/libbundled.rlib | $(CGREP) -e \"U _*native_func\"\n+\t$(NM) $(TMPDIR)/libbundled.a | $(CGREP) -e \"T _*native_func\"\n+\t$(NM) $(TMPDIR)/libbundled.a | $(CGREP) -e \"U _*native_func\"\n+\t$(NM) $(TMPDIR)/libbundled.rlib | $(CGREP) -e \"T _*native_func\"\n+\t$(NM) $(TMPDIR)/libbundled.rlib | $(CGREP) -e \"U _*native_func\"\n \n \t# Build a staticlib and a rlib, the `native_func` symbol will not be bundled into it\n \t$(RUSTC) non-bundled.rs --crate-type=staticlib --crate-type=rlib\n-\tnm $(TMPDIR)/libnon_bundled.a | $(CGREP) -ve \"T _*native_func\"\n-\tnm $(TMPDIR)/libnon_bundled.a | $(CGREP) -e \"U _*native_func\"\n-\tnm $(TMPDIR)/libnon_bundled.rlib | $(CGREP) -ve \"T _*native_func\"\n-\tnm $(TMPDIR)/libnon_bundled.rlib | $(CGREP) -e \"U _*native_func\"\n+\t$(NM) $(TMPDIR)/libnon_bundled.a | $(CGREP) -ve \"T _*native_func\"\n+\t$(NM) $(TMPDIR)/libnon_bundled.a | $(CGREP) -e \"U _*native_func\"\n+\t$(NM) $(TMPDIR)/libnon_bundled.rlib | $(CGREP) -ve \"T _*native_func\"\n+\t$(NM) $(TMPDIR)/libnon_bundled.rlib | $(CGREP) -e \"U _*native_func\"\n \n \t# Build a cdylib, `native-staticlib` will not appear on the linker line because it was bundled previously\n \t# The cdylib will contain the `native_func` symbol in the end\n \t$(RUSTC) cdylib-bundled.rs --crate-type=cdylib --print link-args | $(CGREP) -ve '-l[\" ]*native-staticlib'\n-\tnm $(call DYLIB,cdylib_bundled) | $(CGREP) -e \"[Tt] _*native_func\"\n+\t$(NM) $(call DYLIB,cdylib_bundled) | $(CGREP) -e \"[Tt] _*native_func\"\n \n \t# Build a cdylib, `native-staticlib` will appear on the linker line because it was not bundled previously\n \t# The cdylib will contain the `native_func` symbol in the end\n \t$(RUSTC) cdylib-non-bundled.rs --crate-type=cdylib --print link-args | $(CGREP) -e '-l[\" ]*native-staticlib'\n-\tnm $(call DYLIB,cdylib_non_bundled) | $(CGREP) -e \"[Tt] _*native_func\"\n+\t$(NM) $(call DYLIB,cdylib_non_bundled) | $(CGREP) -e \"[Tt] _*native_func\""}]}