{"sha": "4b8078424ebe6327ed80113063985014470afabb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRiODA3ODQyNGViZTYzMjdlZDgwMTEzMDYzOTg1MDE0NDcwYWZhYmI=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2015-11-25T21:15:46Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2015-11-25T21:15:46Z"}, "message": "Consider a crate staged if it has `stable` or `unstable` in its root", "tree": {"sha": "334eb08734a31141ee50dca55f97b073a17fe764", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/334eb08734a31141ee50dca55f97b073a17fe764"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4b8078424ebe6327ed80113063985014470afabb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4b8078424ebe6327ed80113063985014470afabb", "html_url": "https://github.com/rust-lang/rust/commit/4b8078424ebe6327ed80113063985014470afabb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4b8078424ebe6327ed80113063985014470afabb/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "62f5232edbfe7293f897db84eb3fc5bb2ed01e10", "url": "https://api.github.com/repos/rust-lang/rust/commits/62f5232edbfe7293f897db84eb3fc5bb2ed01e10", "html_url": "https://github.com/rust-lang/rust/commit/62f5232edbfe7293f897db84eb3fc5bb2ed01e10"}], "stats": {"total": 30, "additions": 15, "deletions": 15}, "files": [{"sha": "4a28872b1b8d659099f81e997f3f75de5d16d494", "filename": "src/librustc/metadata/creader.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc%2Fmetadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc%2Fmetadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcreader.rs?ref=4b8078424ebe6327ed80113063985014470afabb", "patch": "@@ -350,16 +350,8 @@ impl<'a> CrateReader<'a> {\n     fn is_staged_api(&self, data: &[u8]) -> bool {\n         let attrs = decoder::get_crate_attributes(data);\n         for attr in &attrs {\n-            if attr.name() == \"feature\" {\n-                if let Some(metas) = attr.meta_item_list() {\n-                    for meta in metas {\n-                        if let ast::MetaWord(ref name) = meta.node {\n-                            if &name[..] == \"staged_api\" {\n-                                return true\n-                            }\n-                        }\n-                    }\n-                }\n+            if attr.name() == \"stable\" || attr.name() == \"unstable\" {\n+                return true\n             }\n         }\n         false"}, {"sha": "9ba49633f2b3ba701a6f07f47dc94fc0555d006a", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=4b8078424ebe6327ed80113063985014470afabb", "patch": "@@ -85,7 +85,7 @@ impl<'a, 'tcx: 'a> Annotator<'a, 'tcx> {\n                    item_sp: Span, kind: AnnotationKind, visit_children: F)\n         where F: FnOnce(&mut Annotator)\n     {\n-        if self.index.staged_api[&LOCAL_CRATE] {\n+        if self.index.staged_api[&LOCAL_CRATE] && self.tcx.sess.features.borrow().staged_api {\n             debug!(\"annotate(id = {:?}, attrs = {:?})\", id, attrs);\n             if let Some(mut stab) = attr::find_stability(self.tcx.sess.diagnostic(),\n                                                          attrs, item_sp) {\n@@ -279,9 +279,17 @@ impl<'tcx> Index<'tcx> {\n                            |v| intravisit::walk_crate(v, krate));\n     }\n \n-    pub fn new(sess: &Session) -> Index<'tcx> {\n+    pub fn new(krate: &Crate) -> Index<'tcx> {\n+        let mut is_staged_api = false;\n+        for attr in &krate.attrs {\n+            if attr.name() == \"stable\" || attr.name() == \"unstable\" {\n+                is_staged_api = true;\n+                break\n+            }\n+        }\n+\n         let mut staged_api = FnvHashMap();\n-        staged_api.insert(LOCAL_CRATE, sess.features.borrow().staged_api);\n+        staged_api.insert(LOCAL_CRATE, is_staged_api);\n         Index {\n             staged_api: staged_api,\n             map: DefIdMap(),"}, {"sha": "a1bec7e78a3adb5622ad63d55d9711337172ef9a", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=4b8078424ebe6327ed80113063985014470afabb", "patch": "@@ -738,7 +738,7 @@ pub fn phase_3_run_analysis_passes<'tcx, F, R>(sess: &'tcx Session,\n                                freevars,\n                                region_map,\n                                lang_items,\n-                               stability::Index::new(sess),\n+                               stability::Index::new(krate),\n                                |tcx| {\n                                    // passes are timed inside typeck\n                                    typeck::check_crate(tcx, trait_map);"}, {"sha": "e33f5df4d3da42905db9baf522aa389ca1d8bf09", "filename": "src/librustc_driver/test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc_driver%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b8078424ebe6327ed80113063985014470afabb/src%2Flibrustc_driver%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Ftest.rs?ref=4b8078424ebe6327ed80113063985014470afabb", "patch": "@@ -136,7 +136,7 @@ fn test_env<F>(source_string: &str,\n                                freevars,\n                                region_map,\n                                lang_items,\n-                               stability::Index::new(&sess),\n+                               stability::Index::new(krate),\n                                |tcx| {\n                                    let infcx = infer::new_infer_ctxt(tcx, &tcx.tables, None, false);\n                                    body(Env { infcx: &infcx });"}]}