{"sha": "ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVjOGFlNGIwZWI0ODYwZjJlZDMwNzYzZDE5NmEzZmUwZDdhZjcyYzI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-11-13T14:28:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-11-13T14:28:57Z"}, "message": "Auto merge of #29811 - bluss:binary-heap-sift-less, r=gankro\n\nBinaryHeap: Simplify sift down\n\nSift down was doing all too much work: it can stop directly when the\ncurrent element obeys the heap property in relation to its children.\n\nIn the old code, sift down didn't compare the element to sift down at\nall, so it was maximally sifted down and relied on the sift up call to\nput it in the correct location.\n\nThis should speed up heapify and .pop().\n\nAlso rename Hole::removed() to Hole::element()", "tree": {"sha": "b6c50ce2b6a99a3df901de1a08ccf2b3917762c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6c50ce2b6a99a3df901de1a08ccf2b3917762c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2", "html_url": "https://github.com/rust-lang/rust/commit/ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b12a3582b113c0f9c217f6311ec0d47fd0f79016", "url": "https://api.github.com/repos/rust-lang/rust/commits/b12a3582b113c0f9c217f6311ec0d47fd0f79016", "html_url": "https://github.com/rust-lang/rust/commit/b12a3582b113c0f9c217f6311ec0d47fd0f79016"}, {"sha": "81fcdd4af9c9e99cf2031c5f09a5f1a1dbf3bfc5", "url": "https://api.github.com/repos/rust-lang/rust/commits/81fcdd4af9c9e99cf2031c5f09a5f1a1dbf3bfc5", "html_url": "https://github.com/rust-lang/rust/commit/81fcdd4af9c9e99cf2031c5f09a5f1a1dbf3bfc5"}], "stats": {"total": 15, "additions": 8, "deletions": 7}, "files": [{"sha": "57646bef124c84621aa549ef757a008f54d88f3f", "filename": "src/libcollections/binary_heap.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2/src%2Flibcollections%2Fbinary_heap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2/src%2Flibcollections%2Fbinary_heap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fbinary_heap.rs?ref=ec8ae4b0eb4860f2ed30763d196a3fe0d7af72c2", "patch": "@@ -522,29 +522,30 @@ impl<T: Ord> BinaryHeap<T> {\n \n             while hole.pos() > start {\n                 let parent = (hole.pos() - 1) / 2;\n-                if hole.removed() <= hole.get(parent) { break }\n+                if hole.element() <= hole.get(parent) { break; }\n                 hole.move_to(parent);\n             }\n         }\n     }\n \n-    fn sift_down_range(&mut self, mut pos: usize, end: usize) {\n-        let start = pos;\n+    /// Take an element at `pos` and move it down the heap,\n+    /// while its children are larger.\n+    fn sift_down_range(&mut self, pos: usize, end: usize) {\n         unsafe {\n             let mut hole = Hole::new(&mut self.data, pos);\n             let mut child = 2 * pos + 1;\n             while child < end {\n                 let right = child + 1;\n+                // compare with the greater of the two children\n                 if right < end && !(hole.get(child) > hole.get(right)) {\n                     child = right;\n                 }\n+                // if we are already in order, stop.\n+                if hole.element() >= hole.get(child) { break; }\n                 hole.move_to(child);\n                 child = 2 * hole.pos() + 1;\n             }\n-\n-            pos = hole.pos;\n         }\n-        self.sift_up(start, pos);\n     }\n \n     fn sift_down(&mut self, pos: usize) {\n@@ -606,7 +607,7 @@ impl<'a, T> Hole<'a, T> {\n \n     /// Return a reference to the element removed\n     #[inline(always)]\n-    fn removed(&self) -> &T {\n+    fn element(&self) -> &T {\n         self.elt.as_ref().unwrap()\n     }\n "}]}