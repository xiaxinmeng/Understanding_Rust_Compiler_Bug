{"sha": "f17edf9829e88090445a7f8b3e74979ca08ecfa0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYxN2VkZjk4MjllODgwOTA0NDVhN2Y4YjNlNzQ5NzljYTA4ZWNmYTA=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-08-18T01:14:47Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-08-18T01:14:57Z"}, "message": "rustc: Use obstacks in lieu of dynamically-allocated frames only when the frame is actually dynamically-sized", "tree": {"sha": "fd90dd7fc3cbba3c4aa6efd9cb64525bb359807c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd90dd7fc3cbba3c4aa6efd9cb64525bb359807c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f17edf9829e88090445a7f8b3e74979ca08ecfa0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f17edf9829e88090445a7f8b3e74979ca08ecfa0", "html_url": "https://github.com/rust-lang/rust/commit/f17edf9829e88090445a7f8b3e74979ca08ecfa0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f17edf9829e88090445a7f8b3e74979ca08ecfa0/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b7af403843d54c3200f8f9accbd2b279d6a7a0c", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b7af403843d54c3200f8f9accbd2b279d6a7a0c", "html_url": "https://github.com/rust-lang/rust/commit/0b7af403843d54c3200f8f9accbd2b279d6a7a0c"}], "stats": {"total": 81, "additions": 57, "deletions": 24}, "files": [{"sha": "9d797db2ee9bc725ffc90442a2317363c582e268", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=f17edf9829e88090445a7f8b3e74979ca08ecfa0", "patch": "@@ -466,17 +466,28 @@ fn alloca(cx: &@block_ctxt, t: TypeRef) -> ValueRef {\n }\n \n fn array_alloca(cx: &@block_ctxt, t: TypeRef, n: ValueRef) -> ValueRef {\n+    let bcx = cx;\n     let builder = new_builder(cx.fcx.lldynamicallocas);\n+    let lltaskptr = bcx_fcx(bcx).lltaskptr;\n     alt bcx_fcx(cx).llobstacktoken {\n         none. {\n-            let dynastack_mark = bcx_ccx(cx).upcalls.dynastack_mark;\n-            let lltaskptr = bcx_fcx(cx).lltaskptr;\n             bcx_fcx(cx).llobstacktoken =\n-                some(builder.Call(dynastack_mark, ~[lltaskptr]));\n+                some(mk_obstack_token(bcx_ccx(cx), cx.fcx.lldynamicallocas,\n+                                      lltaskptr));\n         }\n         some(_) { /* no-op */ }\n     }\n-    ret builder.ArrayAlloca(t, n);\n+\n+    let dynastack_alloc = bcx_ccx(bcx).upcalls.dynastack_alloc;\n+    let llsz = builder.Mul(C_uint(llsize_of_real(bcx_ccx(bcx), t)), n);\n+    let llresult = builder.Call(dynastack_alloc, ~[lltaskptr, llsz]);\n+    ret builder.PointerCast(llresult, T_ptr(t));\n+}\n+\n+fn mk_obstack_token(ccx: &@crate_ctxt, lldynamicallocas: BasicBlockRef,\n+                    lltaskptr: ValueRef) -> ValueRef {\n+    let builder = new_builder(lldynamicallocas);\n+    ret builder.Call(ccx.upcalls.dynastack_mark, ~[lltaskptr]);\n }\n \n "}, {"sha": "d37e01f573c604e7d9a947988f061c2bc3117d9c", "filename": "src/comp/middle/trans_common.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Fcomp%2Fmiddle%2Ftrans_common.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Fcomp%2Fmiddle%2Ftrans_common.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans_common.rs?ref=f17edf9829e88090445a7f8b3e74979ca08ecfa0", "patch": "@@ -217,7 +217,6 @@ type fn_ctxt = {\n     mutable llreturn: BasicBlockRef,\n \n     // The token used to clear the dynamic allocas at the end of this frame.\n-    // Will be |none| if there are no dynamic allocas.\n     mutable llobstacktoken: option::t<ValueRef>,\n \n     // The 'self' object currently in use in this function, if there"}, {"sha": "f76a80aada9851de4967a9d66d57a667d4256e19", "filename": "src/rt/rust_obstack.cpp", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_obstack.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_obstack.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_obstack.cpp?ref=f17edf9829e88090445a7f8b3e74979ca08ecfa0", "patch": "@@ -14,7 +14,12 @@\n #undef max\n #endif\n \n-const size_t DEFAULT_CHUNK_SIZE = 4096;\n+//#define DPRINT(fmt,...)     fprintf(stderr, fmt, ##__VA_ARGS__)\n+#define DPRINT(fmt,...)\n+\n+//const size_t DEFAULT_CHUNK_SIZE = 4096;\n+const size_t DEFAULT_CHUNK_SIZE = 300000;\n+const size_t DEFAULT_ALIGNMENT = 16;\n \n struct rust_obstack_chunk {\n     rust_obstack_chunk *prev;\n@@ -32,8 +37,13 @@ struct rust_obstack_chunk {\n \n void *\n rust_obstack_chunk::alloc(size_t len) {\n-    if (len > size - alen)\n+    alen = align_to(alen, DEFAULT_ALIGNMENT);\n+\n+    if (len > size - alen) {\n+        DPRINT(\"Not enough space, len=%lu!\\n\", len);\n+        assert(0);\n         return NULL;    // Not enough space.\n+    }\n     void *result = data + alen;\n     alen += len;\n     return result;\n@@ -42,7 +52,7 @@ rust_obstack_chunk::alloc(size_t len) {\n bool\n rust_obstack_chunk::free(void *ptr) {\n     uint8_t *p = (uint8_t *)ptr;\n-    if (p < data || p >= data + size)\n+    if (p < data || p > data + size)\n         return false;\n     assert(p <= data + alen);\n     alen = (size_t)(p - data);\n@@ -54,6 +64,7 @@ void *\n rust_obstack::alloc_new(size_t len) {\n     size_t chunk_size = std::max(len, DEFAULT_CHUNK_SIZE);\n     void *ptr = task->malloc(sizeof(chunk) + chunk_size, \"obstack\");\n+    DPRINT(\"making new chunk at %p, len %lu\\n\", ptr, chunk_size);\n     chunk = new(ptr) rust_obstack_chunk(chunk, chunk_size);\n     return chunk->alloc(len);\n }\n@@ -70,8 +81,12 @@ void *\n rust_obstack::alloc(size_t len) {\n     if (!chunk)\n         return alloc_new(len);\n+\n+    DPRINT(\"alloc sz %u\", (uint32_t)len);\n+\n     void *ptr = chunk->alloc(len);\n     ptr = ptr ? ptr : alloc_new(len);\n+\n     return ptr;\n }\n \n@@ -80,8 +95,11 @@ rust_obstack::free(void *ptr) {\n     if (!ptr)\n         return;\n \n+    DPRINT(\"free ptr %p\\n\", ptr);\n+\n     assert(chunk);\n     while (!chunk->free(ptr)) {\n+        DPRINT(\"deleting chunk at %p\\n\", chunk);\n         rust_obstack_chunk *prev = chunk->prev;\n         task->free(chunk);\n         chunk = prev;"}, {"sha": "e5b96e7e91f7f5ef442f35038bf637ac084cc323", "filename": "src/rt/rust_shape.cpp", "status": "modified", "additions": 10, "deletions": 15, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_shape.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_shape.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_shape.cpp?ref=f17edf9829e88090445a7f8b3e74979ca08ecfa0", "patch": "@@ -64,18 +64,6 @@ const uint8_t CMP_LT = 1u;\n const uint8_t CMP_LE = 2u;\n \n \n-// Utility functions\n-\n-// Rounds |size| to the nearest |alignment|. Invariant: |alignment| is a power\n-// of two.\n-template<typename T>\n-static inline T\n-align_to(T size, size_t alignment) {\n-    assert(alignment);\n-    T x = (T)(((uintptr_t)size + alignment - 1) & ~(alignment - 1));\n-    return x;\n-}\n-\n // Utility classes\n \n struct size_align {\n@@ -185,11 +173,18 @@ class ptr_pair {\n     }\n };\n \n-inline ptr_pair\n-align_to(const ptr_pair &pair, size_t n) {\n-    return ptr_pair::make(align_to(pair.fst, n), align_to(pair.snd, n));\n+}   // end namespace shape\n+\n+\n+inline shape::ptr_pair\n+align_to(const shape::ptr_pair &pair, size_t n) {\n+    return shape::ptr_pair::make(align_to(pair.fst, n),\n+                                 align_to(pair.snd, n));\n }\n \n+\n+namespace shape {\n+\n // NB: This function does not align.\n template<typename T>\n inline data_pair<T>"}, {"sha": "ac99f501f25ae6eacebf5d2c1e2308c1f361cc74", "filename": "src/rt/rust_upcall.cpp", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_upcall.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_upcall.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_upcall.cpp?ref=f17edf9829e88090445a7f8b3e74979ca08ecfa0", "patch": "@@ -430,7 +430,7 @@ upcall_dynastack_mark(rust_task *task) {\n /** Allocates space in the dynamic stack and returns it. */\n extern \"C\" CDECL void *\n upcall_dynastack_alloc(rust_task *task, size_t sz) {\n-    return task->dynastack.alloc(sz);\n+    return sz ? task->dynastack.alloc(sz) : NULL;\n }\n \n /** Frees space in the dynamic stack. */"}, {"sha": "401c39413b6590960e870661b4d545050efea47c", "filename": "src/rt/rust_util.h", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_util.h", "raw_url": "https://github.com/rust-lang/rust/raw/f17edf9829e88090445a7f8b3e74979ca08ecfa0/src%2Frt%2Frust_util.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_util.h?ref=f17edf9829e88090445a7f8b3e74979ca08ecfa0", "patch": "@@ -125,6 +125,16 @@ next_power_of_two(size_t s)\n     return tmp + 1;\n }\n \n+// Rounds |size| to the nearest |alignment|. Invariant: |alignment| is a power\n+// of two.\n+template<typename T>\n+static inline T\n+align_to(T size, size_t alignment) {\n+    assert(alignment);\n+    T x = (T)(((uintptr_t)size + alignment - 1) & ~(alignment - 1));\n+    return x;\n+}\n+\n // Initialization helper for ISAAC RNG\n \n template <typename sched_or_kernel>"}]}