{"sha": "63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzZDZlZjY1YWYwNmVlN2E2MmM3YjBhODdkOTU1ZDYwOGQwZTc4MjY=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-04-05T05:21:36Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-04-05T05:21:36Z"}, "message": "Query-ify Instance::resolve", "tree": {"sha": "d62802e03f44ad6e4c09616b0aa11726efb7c1cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d62802e03f44ad6e4c09616b0aa11726efb7c1cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl6JavsACgkQtAh+UQ6Y\nsWTBiw/+LRw8o1ebwONW1VjPPW3g6x8YzaTowtc4NABhPR8Uxj+f/ft7y80/fC2i\nMCMZsQKgtjZWVLY2BMon6o+BtzGEeoNGTXjesblvZz8oycY4Sms37mMs0WfJMdVz\nMY73lKfEnqyzTlPJtx/b+M/tSviq1oHLMXwAsE9q1wXpC5qBgdRuZFgRRyekWtSk\n30jofc3DxRG996xmeEkDEWBgDTVaj6wpuKjuoavOL4gA+UY8Oe50GAZlAA65buOy\nmNvgli/5ESIFJIWSlkPemq13/TjB43xErHkvA4O6f306xdtTaFVlBxbbQ0XYKFZH\nR5xh5IkbhgpaFmTxMTYgYifwZxNDCOvc/1UfJWry0MsL9f/nekuiaDc309VWidmW\nyoE/MDQZUZFTu1knUXS75THNEr9/rsadoiwoJVrwmiJX9kPMeXGARoZ1Z1Xck/Dj\njyk3F2qf0FYpMQlavTW3FxR97HA+hWWUrTeRCEQrcL/spAg9qxWRTPx4gi+ZGhfT\n+kgV60DvMmcnTQT5tr6PAmU45xYL5bfFrdjZW9FPYP8uGEKCtBOmIy64rC1anKjy\nriJe/UfdFeIHmvW+3PyAUzeUDCLhzhvcdasLeUhZmzbRn4sCEHEULJ3Ndk8mRtJK\nRLyH28y+qGF8IWq6f1D6WkmtmFZlFVh3U3sgk3pzAHjy16rHkyg=\n=hkI/\n-----END PGP SIGNATURE-----", "payload": "tree d62802e03f44ad6e4c09616b0aa11726efb7c1cf\nparent 853c4774e26ea97b45fe74de9a6f68e526784323\nauthor Aaron Hill <aa1ronham@gmail.com> 1586064096 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1586064096 -0400\n\nQuery-ify Instance::resolve\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "html_url": "https://github.com/rust-lang/rust/commit/63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "853c4774e26ea97b45fe74de9a6f68e526784323", "url": "https://api.github.com/repos/rust-lang/rust/commits/853c4774e26ea97b45fe74de9a6f68e526784323", "html_url": "https://github.com/rust-lang/rust/commit/853c4774e26ea97b45fe74de9a6f68e526784323"}], "stats": {"total": 49, "additions": 24, "deletions": 25}, "files": [{"sha": "913c67d045e5980e24b03bbe8d3f9e650e163f85", "filename": "src/librustc_interface/callbacks.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_interface%2Fcallbacks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_interface%2Fcallbacks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Fcallbacks.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -58,5 +58,4 @@ pub fn setup_callbacks() {\n     rustc_span::SPAN_DEBUG.swap(&(span_debug as fn(_, &mut fmt::Formatter<'_>) -> _));\n     rustc_hir::def_id::DEF_ID_DEBUG.swap(&(def_id_debug as fn(_, &mut fmt::Formatter<'_>) -> _));\n     TRACK_DIAGNOSTICS.swap(&(track_diagnostic as fn(&_)));\n-    rustc_middle::ty::RESOLVE_INSTANCE.swap(&(rustc_ty::instance::resolve_instance as _));\n }"}, {"sha": "c26c043994f54dbefb0f494e38e4fb83dc40725c", "filename": "src/librustc_middle/query/mod.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fquery%2Fmod.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -1257,5 +1257,9 @@ rustc_queries! {\n             eval_always\n             desc { \"looking up enabled feature gates\" }\n         }\n+\n+        query resolve_instance(key: (ty::ParamEnv<'tcx>, DefId, SubstsRef<'tcx>)) -> Option<ty::Instance<'tcx>> {\n+            desc { \"resolving instance `{:?}` `{:?}` with {:?}\", key.1, key.2, key.0 }\n+        }\n     }\n }"}, {"sha": "cf0222370f288f2871cb713732a9f8709fec5567", "filename": "src/librustc_middle/ty/instance.rs", "status": "modified", "additions": 3, "deletions": 20, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Finstance.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -1,7 +1,6 @@\n use crate::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use crate::ty::print::{FmtPrinter, Printer};\n use crate::ty::{self, SubstsRef, Ty, TyCtxt, TypeFoldable};\n-use rustc_data_structures::AtomicRef;\n use rustc_hir::def::Namespace;\n use rustc_hir::def_id::{CrateNum, DefId};\n use rustc_hir::lang_items::DropInPlaceFnLangItem;\n@@ -289,7 +288,9 @@ impl<'tcx> Instance<'tcx> {\n         def_id: DefId,\n         substs: SubstsRef<'tcx>,\n     ) -> Option<Instance<'tcx>> {\n-        (*RESOLVE_INSTANCE)(tcx, param_env, def_id, substs)\n+        // All regions in the result of this query are erased, so it's\n+        // fine to erase all of the input regions.\n+        tcx.resolve_instance((tcx.erase_regions(&param_env), def_id, tcx.erase_regions(&substs)))\n     }\n \n     pub fn resolve_for_fn_ptr(\n@@ -440,21 +441,3 @@ fn needs_fn_once_adapter_shim(\n         (ty::ClosureKind::FnMut, _) | (ty::ClosureKind::FnOnce, _) => Err(()),\n     }\n }\n-\n-fn resolve_instance_default(\n-    _tcx: TyCtxt<'tcx>,\n-    _param_env: ty::ParamEnv<'tcx>,\n-    _def_id: DefId,\n-    _substs: SubstsRef<'tcx>,\n-) -> Option<Instance<'tcx>> {\n-    unimplemented!()\n-}\n-\n-pub static RESOLVE_INSTANCE: AtomicRef<\n-    for<'tcx> fn(\n-        TyCtxt<'tcx>,\n-        ty::ParamEnv<'tcx>,\n-        DefId,\n-        SubstsRef<'tcx>,\n-    ) -> Option<Instance<'tcx>>,\n-> = AtomicRef::new(&(resolve_instance_default as _));"}, {"sha": "0ebd55a6c024c86dc5821f63b2039d38c1763020", "filename": "src/librustc_middle/ty/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fmod.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -81,7 +81,6 @@ pub use self::context::{\n     CtxtInterners, GeneratorInteriorTypeCause, GlobalCtxt, Lift, TypeckTables,\n };\n \n-pub use self::instance::RESOLVE_INSTANCE;\n pub use self::instance::{Instance, InstanceDef};\n \n pub use self::trait_def::TraitDef;"}, {"sha": "438e7ed4331a3e433e6af11ee51056d6a0cc10a8", "filename": "src/librustc_middle/ty/query/keys.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fty%2Fquery%2Fkeys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_middle%2Fty%2Fquery%2Fkeys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fquery%2Fkeys.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -296,3 +296,14 @@ impl Key for (Symbol, u32, u32) {\n         DUMMY_SP\n     }\n }\n+\n+impl<'tcx> Key for (ty::ParamEnv<'tcx>, DefId, SubstsRef<'tcx>) {\n+    type CacheSelector = DefaultCacheSelector;\n+\n+    fn query_crate(&self) -> CrateNum {\n+        self.1.krate\n+    }\n+    fn default_span(&self, tcx: TyCtxt<'_>) -> Span {\n+        tcx.def_span(self.1)\n+    }\n+}"}, {"sha": "955e2e3615909dc1fd708f50bb396b8ab936f33d", "filename": "src/librustc_ty/instance.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_ty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_ty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Finstance.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -11,9 +11,7 @@ use log::debug;\n \n pub fn resolve_instance<'tcx>(\n     tcx: TyCtxt<'tcx>,\n-    param_env: ty::ParamEnv<'tcx>,\n-    def_id: DefId,\n-    substs: SubstsRef<'tcx>,\n+    (param_env, def_id, substs): (ty::ParamEnv<'tcx>, DefId, SubstsRef<'tcx>),\n ) -> Option<Instance<'tcx>> {\n     debug!(\"resolve(def_id={:?}, substs={:?})\", def_id, substs);\n     let result = if let Some(trait_def_id) = tcx.trait_of_item(def_id) {\n@@ -199,3 +197,7 @@ fn resolve_associated_item<'tcx>(\n         traits::VtableAutoImpl(..) | traits::VtableParam(..) | traits::VtableTraitAlias(..) => None,\n     }\n }\n+\n+pub fn provide(providers: &mut ty::query::Providers<'_>) {\n+    *providers = ty::query::Providers { resolve_instance, ..*providers };\n+}"}, {"sha": "75e62e796408a6b3822ef13dca1f3bb37c235374", "filename": "src/librustc_ty/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_ty%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63d6ef65af06ee7a62c7b0a87d955d608d0e7826/src%2Flibrustc_ty%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Flib.rs?ref=63d6ef65af06ee7a62c7b0a87d955d608d0e7826", "patch": "@@ -25,4 +25,5 @@ pub fn provide(providers: &mut Providers<'_>) {\n     common_traits::provide(providers);\n     needs_drop::provide(providers);\n     ty::provide(providers);\n+    instance::provide(providers);\n }"}]}