{"sha": "4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRhODNhOTNlOWFmZDI5ZTc0OTRhZjNjYzJhMzNjNDRlYzMyYjAzMDM=", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2021-07-07T17:50:50Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2021-07-07T17:50:50Z"}, "message": "Cleanup: unify lint name checking\n\nThis change merges `check_lint_and_tool_name` into `check_lint_name` in\norder to avoid having two very similar functions.\n\nAlso adds the `.stderr` file back for the test case, since apparently\nit is still needed.", "tree": {"sha": "ebbfeff4198dd4e2439078a5c771da62682ef98c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebbfeff4198dd4e2439078a5c771da62682ef98c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "html_url": "https://github.com/rust-lang/rust/commit/4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5413d2e52981924bd42a5497ea4a0bf76f2a572f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5413d2e52981924bd42a5497ea4a0bf76f2a572f", "html_url": "https://github.com/rust-lang/rust/commit/5413d2e52981924bd42a5497ea4a0bf76f2a572f"}], "stats": {"total": 46, "additions": 25, "deletions": 21}, "files": [{"sha": "b6ea89b50743c9bd622362ab7cbeeef54fca7d8c", "filename": "compiler/rustc_lint/src/context.rs", "status": "modified", "additions": 10, "deletions": 18, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs?ref=4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "patch": "@@ -344,9 +344,9 @@ impl LintStore {\n         level: Level,\n         crate_attrs: &[ast::Attribute],\n     ) {\n-        let (tool_name, lint_name) = parse_lint_and_tool_name(lint_name);\n+        let (tool_name, lint_name_only) = parse_lint_and_tool_name(lint_name);\n \n-        let db = match self.check_lint_and_tool_name(sess, tool_name, lint_name, crate_attrs) {\n+        let db = match self.check_lint_name(sess, lint_name_only, tool_name, crate_attrs) {\n             CheckLintNameResult::Ok(_) => None,\n             CheckLintNameResult::Warning(ref msg, _) => Some(sess.struct_warn(msg)),\n             CheckLintNameResult::NoLint(suggestion) => {\n@@ -408,22 +408,6 @@ impl LintStore {\n         }\n     }\n \n-    pub fn check_lint_and_tool_name(\n-        &self,\n-        sess: &Session,\n-        tool_name: Option<Symbol>,\n-        lint_name: &str,\n-        crate_attrs: &[ast::Attribute],\n-    ) -> CheckLintNameResult<'_> {\n-        if let Some(tool_name) = tool_name {\n-            if !is_known_lint_tool(tool_name, sess, crate_attrs) {\n-                return CheckLintNameResult::NoTool;\n-            }\n-        }\n-\n-        self.check_lint_name(lint_name, tool_name)\n-    }\n-\n     /// Checks the name of a lint for its existence, and whether it was\n     /// renamed or removed. Generates a DiagnosticBuilder containing a\n     /// warning for renamed and removed lints. This is over both lint\n@@ -433,9 +417,17 @@ impl LintStore {\n     /// printing duplicate warnings.\n     pub fn check_lint_name(\n         &self,\n+        sess: &Session,\n         lint_name: &str,\n         tool_name: Option<Symbol>,\n+        crate_attrs: &[ast::Attribute],\n     ) -> CheckLintNameResult<'_> {\n+        if let Some(tool_name) = tool_name {\n+            if !is_known_lint_tool(tool_name, sess, crate_attrs) {\n+                return CheckLintNameResult::NoTool;\n+            }\n+        }\n+\n         let complete_name = if let Some(tool_name) = tool_name {\n             format!(\"{}::{}\", tool_name, lint_name)\n         } else {"}, {"sha": "b603483414fd7ba11fcba39aad89c1a89feace3b", "filename": "compiler/rustc_lint/src/levels.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flevels.rs?ref=4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "patch": "@@ -328,8 +328,7 @@ impl<'s> LintLevelsBuilder<'s> {\n                 };\n                 let tool_name = tool_ident.map(|ident| ident.name);\n                 let name = pprust::path_to_string(&meta_item.path);\n-                let lint_result =\n-                    store.check_lint_and_tool_name(sess, tool_name, &name, self.crate_attrs);\n+                let lint_result = store.check_lint_name(sess, &name, tool_name, self.crate_attrs);\n                 match &lint_result {\n                     CheckLintNameResult::Ok(ids) => {\n                         let src = LintLevelSource::Node(\n@@ -477,7 +476,9 @@ impl<'s> LintLevelsBuilder<'s> {\n                 if let CheckLintNameResult::Warning(_, Some(new_name)) = lint_result {\n                     // Ignore any errors or warnings that happen because the new name is inaccurate\n                     // NOTE: `new_name` already includes the tool name, so we don't have to add it again.\n-                    if let CheckLintNameResult::Ok(ids) = store.check_lint_name(&new_name, None) {\n+                    if let CheckLintNameResult::Ok(ids) =\n+                        store.check_lint_name(sess, &new_name, None, self.crate_attrs)\n+                    {\n                         let src = LintLevelSource::Node(Symbol::intern(&new_name), sp, reason);\n                         for &id in ids {\n                             self.check_gated_lint(id, attr.span);"}, {"sha": "c9a2aff2137a72310c98f37b08e3d937eea5b0a2", "filename": "src/test/ui/lint/command-line-register-unknown-lint-tool.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/src%2Ftest%2Fui%2Flint%2Fcommand-line-register-unknown-lint-tool.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4a83a93e9afd29e7494af3cc2a33c44ec32b0303/src%2Ftest%2Fui%2Flint%2Fcommand-line-register-unknown-lint-tool.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fcommand-line-register-unknown-lint-tool.stderr?ref=4a83a93e9afd29e7494af3cc2a33c44ec32b0303", "patch": "@@ -0,0 +1,11 @@\n+error[E0602]: unknown lint tool: `unknown_tool`\n+   |\n+   = note: requested on the command line with `-A unknown_tool::foo`\n+\n+error[E0602]: unknown lint tool: `unknown_tool`\n+   |\n+   = note: requested on the command line with `-A unknown_tool::foo`\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0602`."}]}