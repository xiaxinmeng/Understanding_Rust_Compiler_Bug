{"sha": "9a99979cc4653fc54008590314028da36b7f21f0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhOTk5NzljYzQ2NTNmYzU0MDA4NTkwMzE0MDI4ZGEzNmI3ZjIxZjA=", "commit": {"author": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2016-04-30T02:01:47Z"}, "committer": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2016-04-30T02:01:47Z"}, "message": "fix #887: New lints for integer/floating-point arithmetic", "tree": {"sha": "f3bc31ac5dff7ecf1a3ae51a3e5ac114065af804", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f3bc31ac5dff7ecf1a3ae51a3e5ac114065af804"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a99979cc4653fc54008590314028da36b7f21f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a99979cc4653fc54008590314028da36b7f21f0", "html_url": "https://github.com/rust-lang/rust/commit/9a99979cc4653fc54008590314028da36b7f21f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a99979cc4653fc54008590314028da36b7f21f0/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "51500882166c403907be4d2977df6a30d5d1993b", "url": "https://api.github.com/repos/rust-lang/rust/commits/51500882166c403907be4d2977df6a30d5d1993b", "html_url": "https://github.com/rust-lang/rust/commit/51500882166c403907be4d2977df6a30d5d1993b"}], "stats": {"total": 146, "additions": 145, "deletions": 1}, "files": [{"sha": "6c51e5595a9b9d46e6730b0cf4f3252caf67e1d1", "filename": "CHANGELOG.md", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9a99979cc4653fc54008590314028da36b7f21f0/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/9a99979cc4653fc54008590314028da36b7f21f0/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=9a99979cc4653fc54008590314028da36b7f21f0", "patch": "@@ -107,6 +107,7 @@ All notable changes to this project will be documented in this file.\n [`explicit_iter_loop`]: https://github.com/Manishearth/rust-clippy/wiki#explicit_iter_loop\n [`extend_from_slice`]: https://github.com/Manishearth/rust-clippy/wiki#extend_from_slice\n [`filter_next`]: https://github.com/Manishearth/rust-clippy/wiki#filter_next\n+[`float_arithmetic`]: https://github.com/Manishearth/rust-clippy/wiki#float_arithmetic\n [`float_cmp`]: https://github.com/Manishearth/rust-clippy/wiki#float_cmp\n [`for_kv_map`]: https://github.com/Manishearth/rust-clippy/wiki#for_kv_map\n [`for_loop_over_option`]: https://github.com/Manishearth/rust-clippy/wiki#for_loop_over_option\n@@ -118,6 +119,7 @@ All notable changes to this project will be documented in this file.\n [`indexing_slicing`]: https://github.com/Manishearth/rust-clippy/wiki#indexing_slicing\n [`ineffective_bit_mask`]: https://github.com/Manishearth/rust-clippy/wiki#ineffective_bit_mask\n [`inline_always`]: https://github.com/Manishearth/rust-clippy/wiki#inline_always\n+[`integer_arithmetic`]: https://github.com/Manishearth/rust-clippy/wiki#integer_arithmetic\n [`invalid_regex`]: https://github.com/Manishearth/rust-clippy/wiki#invalid_regex\n [`invalid_upcast_comparisons`]: https://github.com/Manishearth/rust-clippy/wiki#invalid_upcast_comparisons\n [`items_after_statements`]: https://github.com/Manishearth/rust-clippy/wiki#items_after_statements"}, {"sha": "3b0ca3f4a3848766b7abe0edacec434b6f5e9ba7", "filename": "README.md", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9a99979cc4653fc54008590314028da36b7f21f0/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/9a99979cc4653fc54008590314028da36b7f21f0/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=9a99979cc4653fc54008590314028da36b7f21f0", "patch": "@@ -14,7 +14,7 @@ Table of contents:\n * [License](#license)\n \n ##Lints\n-There are 144 lints included in this crate:\n+There are 146 lints included in this crate:\n \n name                                                                                                                 | default | meaning\n ---------------------------------------------------------------------------------------------------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n@@ -56,6 +56,7 @@ name\n [explicit_iter_loop](https://github.com/Manishearth/rust-clippy/wiki#explicit_iter_loop)                             | warn    | for-looping over `_.iter()` or `_.iter_mut()` when `&_` or `&mut _` would do\n [extend_from_slice](https://github.com/Manishearth/rust-clippy/wiki#extend_from_slice)                               | warn    | `.extend_from_slice(_)` is a faster way to extend a Vec by a slice\n [filter_next](https://github.com/Manishearth/rust-clippy/wiki#filter_next)                                           | warn    | using `filter(p).next()`, which is more succinctly expressed as `.find(p)`\n+[float_arithmetic](https://github.com/Manishearth/rust-clippy/wiki#float_arithmetic)                                 | allow   | Any floating-point arithmetic statement\n [float_cmp](https://github.com/Manishearth/rust-clippy/wiki#float_cmp)                                               | warn    | using `==` or `!=` on float values (as floating-point operations usually involve rounding errors, it is always better to check for approximate equality within small bounds)\n [for_kv_map](https://github.com/Manishearth/rust-clippy/wiki#for_kv_map)                                             | warn    | looping on a map using `iter` when `keys` or `values` would do\n [for_loop_over_option](https://github.com/Manishearth/rust-clippy/wiki#for_loop_over_option)                         | warn    | for-looping over an `Option`, which is more clearly expressed as an `if let`\n@@ -67,6 +68,7 @@ name\n [indexing_slicing](https://github.com/Manishearth/rust-clippy/wiki#indexing_slicing)                                 | allow   | indexing/slicing usage\n [ineffective_bit_mask](https://github.com/Manishearth/rust-clippy/wiki#ineffective_bit_mask)                         | warn    | expressions where a bit mask will be rendered useless by a comparison, e.g. `(x | 1) > 2`\n [inline_always](https://github.com/Manishearth/rust-clippy/wiki#inline_always)                                       | warn    | `#[inline(always)]` is a bad idea in most cases\n+[integer_arithmetic](https://github.com/Manishearth/rust-clippy/wiki#integer_arithmetic)                             | allow   | Any integer arithmetic statement\n [invalid_regex](https://github.com/Manishearth/rust-clippy/wiki#invalid_regex)                                       | deny    | finds invalid regular expressions in `Regex::new(_)` invocations\n [invalid_upcast_comparisons](https://github.com/Manishearth/rust-clippy/wiki#invalid_upcast_comparisons)             | warn    | a comparison involving an upcast which is always true or false\n [items_after_statements](https://github.com/Manishearth/rust-clippy/wiki#items_after_statements)                     | allow   | finds blocks where an item comes after a statement"}, {"sha": "72375f4a15ebe012d9b2825f8cde7f2f16e82ea6", "filename": "src/arithmetic.rs", "status": "added", "additions": 104, "deletions": 0, "changes": 104, "blob_url": "https://github.com/rust-lang/rust/blob/9a99979cc4653fc54008590314028da36b7f21f0/src%2Farithmetic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a99979cc4653fc54008590314028da36b7f21f0/src%2Farithmetic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Farithmetic.rs?ref=9a99979cc4653fc54008590314028da36b7f21f0", "patch": "@@ -0,0 +1,104 @@\n+use rustc::hir;\n+use rustc::lint::*;\n+use syntax::codemap::Span;\n+use utils::span_lint;\n+\n+/// **What it does:** This lint checks for plain integer arithmetic\n+///\n+/// **Why is this bad?** This is only checked against overflow in debug builds.\n+/// In some applications one wants explicitly checked, wrapping or saturating\n+/// arithmetic.\n+///\n+/// **Known problems:** None\n+///\n+/// **Example:**\n+/// ```\n+/// a + 1\n+/// ```\n+declare_lint! {\n+    pub INTEGER_ARITHMETIC,\n+    Allow,\n+    \"Any integer arithmetic statement\"\n+}\n+\n+/// **What it does:** This lint checks for float arithmetic\n+///\n+/// **Why is this bad?** For some embedded systems or kernel development, it\n+/// can be useful to rule out floating-point numbers\n+///\n+/// **Known problems:** None\n+///\n+/// **Example:**\n+/// ```\n+/// a + 1.0\n+/// ```\n+declare_lint! {\n+    pub FLOAT_ARITHMETIC,\n+    Allow,\n+    \"Any floating-point arithmetic statement\"\n+}\n+\n+#[derive(Copy, Clone, Default)]\n+pub struct Arithmetic {\n+    span: Option<Span>\n+}\n+\n+impl LintPass for Arithmetic {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(INTEGER_ARITHMETIC, FLOAT_ARITHMETIC)\n+    }\n+}\n+\n+impl LateLintPass for Arithmetic {\n+    fn check_expr(&mut self, cx: &LateContext, expr: &hir::Expr) {\n+        if let Some(_) = self.span { return; }\n+        match expr.node {\n+            hir::ExprBinary(ref op, ref l, ref r) => {\n+                match op.node {\n+                    hir::BiRem | hir::BiAnd | hir::BiOr | hir::BiBitAnd | \n+                    hir::BiBitOr | hir::BiBitXor | hir::BiShl | hir::BiShr | \n+                    hir::BiEq | hir::BiLt | hir::BiLe | hir::BiNe | hir::BiGe | \n+                    hir::BiGt => return,\n+                    _ => ()\n+                }\n+                let (l_ty, r_ty) = (cx.tcx.expr_ty(l), cx.tcx.expr_ty(r));\n+                if l_ty.is_integral() && r_ty.is_integral() {\n+                    span_lint(cx, \n+                              INTEGER_ARITHMETIC, \n+                              expr.span,\n+                              \"integer arithmetic detected\");\n+                    self.span = Some(expr.span);                    \n+                } else if l_ty.is_floating_point() && r_ty.is_floating_point() {\n+                    span_lint(cx,\n+                              FLOAT_ARITHMETIC,\n+                              expr.span,\n+                              \"floating-point arithmetic detected\");\n+                    self.span = Some(expr.span);                    \n+                }\n+            },\n+            hir::ExprUnary(hir::UnOp::UnNeg, ref arg) => {\n+                let ty = cx.tcx.expr_ty(arg);\n+                if ty.is_integral() {\n+                    span_lint(cx, \n+                              INTEGER_ARITHMETIC, \n+                              expr.span,\n+                              \"integer arithmetic detected\");\n+                    self.span = Some(expr.span);\n+                } else if ty.is_floating_point() {\n+                    span_lint(cx,\n+                              FLOAT_ARITHMETIC,\n+                              expr.span,\n+                              \"floating-point arithmetic detected\");\n+                    self.span = Some(expr.span);\n+                }\n+            },\n+            _ => ()\n+        }\n+    }\n+    \n+    fn check_expr_post(&mut self, _: &LateContext, expr: &hir::Expr) {\n+        if Some(expr.span) == self.span {\n+            self.span = None;\n+        }\n+    }\n+}"}, {"sha": "584ae7f77ebdbab4c474a59cc323ec06be655415", "filename": "src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9a99979cc4653fc54008590314028da36b7f21f0/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a99979cc4653fc54008590314028da36b7f21f0/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=9a99979cc4653fc54008590314028da36b7f21f0", "patch": "@@ -7,6 +7,7 @@\n #![feature(question_mark)]\n #![feature(stmt_expr_attributes)]\n #![allow(indexing_slicing, shadow_reuse, unknown_lints)]\n+#![allow(float_arithmetic, integer_arithmetic)]\n \n // this only exists to allow the \"dogfood\" integration test to work\n #[allow(dead_code)]\n@@ -49,6 +50,7 @@ pub mod utils;\n \n // begin lints modules, do not remove this comment, it\u2019s used in `update_lints`\n pub mod approx_const;\n+pub mod arithmetic;\n pub mod array_indexing;\n pub mod attrs;\n pub mod bit_mask;\n@@ -238,8 +240,11 @@ pub fn plugin_registrar(reg: &mut Registry) {\n     reg.register_late_lint_pass(box neg_multiply::NegMultiply);\n     reg.register_late_lint_pass(box unsafe_removed_from_name::UnsafeNameRemoval);\n     reg.register_late_lint_pass(box mem_forget::MemForget);\n+    reg.register_late_lint_pass(box arithmetic::Arithmetic::default());\n \n     reg.register_lint_group(\"clippy_pedantic\", vec![\n+        arithmetic::FLOAT_ARITHMETIC,\n+        arithmetic::INTEGER_ARITHMETIC,\n         array_indexing::INDEXING_SLICING,\n         booleans::NONMINIMAL_BOOL,\n         enum_glob_use::ENUM_GLOB_USE,"}, {"sha": "856f390943ba91d34b11786360fe0e09acd7976e", "filename": "tests/compile-fail/arithmetic.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/9a99979cc4653fc54008590314028da36b7f21f0/tests%2Fcompile-fail%2Farithmetic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a99979cc4653fc54008590314028da36b7f21f0/tests%2Fcompile-fail%2Farithmetic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Farithmetic.rs?ref=9a99979cc4653fc54008590314028da36b7f21f0", "patch": "@@ -0,0 +1,31 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+#![deny(integer_arithmetic, float_arithmetic)]\n+#![allow(unused, shadow_reuse, shadow_unrelated, no_effect)]\n+fn main() {\n+    let i = 1i32;\n+    1 + i; //~ERROR integer arithmetic detected\n+    i * 2; //~ERROR integer arithmetic detected\n+    1 % //~ERROR integer arithmetic detected\n+    i / 2; \n+    i - 2 + 2 - i; //~ERROR integer arithmetic detected\n+    -i; //~ERROR integer arithmetic detected\n+    \n+    i & 1; // no wrapping\n+    i | 1; \n+    i ^ 1;\n+    i % 7;\n+    i >> 1;\n+    i << 1;\n+    \n+    let f = 1.0f32;\n+    \n+    f * 2.0; //~ERROR floating-point arithmetic detected\n+    \n+    1.0 + f; //~ERROR floating-point arithmetic detected\n+    f * 2.0; //~ERROR floating-point arithmetic detected\n+    f / 2.0; //~ERROR floating-point arithmetic detected\n+    f - 2.0 * 4.2; //~ERROR floating-point arithmetic detected\n+    -f; //~ERROR floating-point arithmetic detected\n+}"}]}