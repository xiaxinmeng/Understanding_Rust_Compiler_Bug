{"sha": "05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1ZGM1ZTlmNDc3MjliOGJiYTg5ZjdiMGUyYjU0ZWE3ZGQxZTE3Nzc=", "commit": {"author": {"name": "Paul Daniel Faria", "email": "Nashenas88@users.noreply.github.com", "date": "2019-11-13T04:41:43Z"}, "committer": {"name": "Paul Daniel Faria", "email": "Nashenas88@users.noreply.github.com", "date": "2019-12-02T13:41:30Z"}, "message": "Compute predecessors in mir_build query and use existing cache for generating ReadOnlyBodyCache, remove unneeded fns", "tree": {"sha": "776ff2e1367119464d6bb6b7b92c6dcc19ce6384", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/776ff2e1367119464d6bb6b7b92c6dcc19ce6384"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "html_url": "https://github.com/rust-lang/rust/commit/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/comments", "author": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed90818ac8b826249f786aae701bf1602a830a8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed90818ac8b826249f786aae701bf1602a830a8f", "html_url": "https://github.com/rust-lang/rust/commit/ed90818ac8b826249f786aae701bf1602a830a8f"}], "stats": {"total": 21, "additions": 7, "deletions": 14}, "files": [{"sha": "44d534caa7590504a0f497e3e939aa21cfdc9331", "filename": "src/librustc/mir/cache.rs", "status": "modified", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/src%2Flibrustc%2Fmir%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/src%2Flibrustc%2Fmir%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fcache.rs?ref=05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "patch": "@@ -181,8 +181,6 @@ impl BodyCache<'tcx> {\n         ReadOnlyBodyCache::new(&self.cache, &self.body)\n     }\n \n-    pub fn cache(&self) -> &Cache { &self.cache }\n-\n     pub fn basic_blocks_mut(&mut self) -> &mut IndexVec<BasicBlock, BasicBlockData<'tcx>> {\n         self.cache.basic_blocks_mut(&mut self.body)\n     }\n@@ -240,14 +238,6 @@ impl ReadOnlyBodyCache<'a, 'tcx> {\n         }\n     }\n \n-    pub fn from_external_cache(cache: &'a mut Cache, body: &'a Body<'tcx>) -> Self {\n-        cache.ensure_predecessors(body);\n-        Self {\n-            cache,\n-            body,\n-        }\n-    }\n-\n     #[inline]\n     pub fn predecessors(&self) -> &IndexVec<BasicBlock, Vec<BasicBlock>> {\n         self.cache.predecessors.as_ref().unwrap()"}, {"sha": "b84461d6b9275480a0b5b872ed2501e423b9eb6e", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "patch": "@@ -196,7 +196,9 @@ pub fn mir_build(tcx: TyCtxt<'_>, def_id: DefId) -> BodyCache<'_> {\n \n         lints::check(tcx, &body, def_id);\n \n-        BodyCache::new(body)\n+        let mut body = BodyCache::new(body);\n+        body.ensure_predecessors();\n+        body\n     })\n }\n "}, {"sha": "2c45dcfbe2665c077c70617c29ed0e290170e02a", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=05dc5e9f47729b8bba89f7b0e2b54ea7dd1e1777", "patch": "@@ -528,9 +528,10 @@ fn unsafety_check_result(tcx: TyCtxt<'_>, def_id: DefId) -> UnsafetyCheckResult\n         hir::BodyOwnerKind::Static(_) => (true, false),\n     };\n     let mut checker = UnsafetyChecker::new(const_context, min_const_fn, body, tcx, param_env);\n-    let mut cache = body.cache().clone();\n-    let read_only_cache = ReadOnlyBodyCache::from_external_cache(&mut cache, body);\n-    checker.visit_body(read_only_cache);\n+    // mir_built ensures that body has a computed cache, so we don't (and can't) attempt to\n+    // recompute it here.\n+    let body = body.unwrap_read_only();\n+    checker.visit_body(body);\n \n     check_unused_unsafe(tcx, def_id, &checker.used_unsafe, &mut checker.inherited_blocks);\n     UnsafetyCheckResult {"}]}