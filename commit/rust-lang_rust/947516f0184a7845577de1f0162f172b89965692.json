{"sha": "947516f0184a7845577de1f0162f172b89965692", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk0NzUxNmYwMTg0YTc4NDU1NzdkZTFmMDE2MmYxNzJiODk5NjU2OTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-09T16:46:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-09T16:46:09Z"}, "message": "Auto merge of #6130 - Ambroisie:lint-ptr-eq, r=Manishearth\n\nNew lint: Recommend using `ptr::eq` when possible\n\nThis is based almost entirely on the code available in the previous PR #4596. I merely updated the code to make it compile.\n\nFixes #3661.\n\n- [ ] I'm not sure about the lint name, but it was the one used in the original PR.\n- [X] Added passing UI tests (including committed `.stderr` file)\n- [X] `cargo test` passes locally\n- [X] Executed `cargo dev update_lints`\n- [X] Added lint documentation\n- [X] Run `cargo dev fmt`\n\n---\n\nchangelog: none", "tree": {"sha": "61b5a9a9d3bf857ee0188b1d8ac168ee49eeb27d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/61b5a9a9d3bf857ee0188b1d8ac168ee49eeb27d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/947516f0184a7845577de1f0162f172b89965692", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/947516f0184a7845577de1f0162f172b89965692", "html_url": "https://github.com/rust-lang/rust/commit/947516f0184a7845577de1f0162f172b89965692", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/947516f0184a7845577de1f0162f172b89965692/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fcf22d90bb9087f03e60c03ccccdc2f95668bf88", "url": "https://api.github.com/repos/rust-lang/rust/commits/fcf22d90bb9087f03e60c03ccccdc2f95668bf88", "html_url": "https://github.com/rust-lang/rust/commit/fcf22d90bb9087f03e60c03ccccdc2f95668bf88"}, {"sha": "6edde811b5437f926c26b1b844acd60e3dd0a0c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6edde811b5437f926c26b1b844acd60e3dd0a0c9", "html_url": "https://github.com/rust-lang/rust/commit/6edde811b5437f926c26b1b844acd60e3dd0a0c9"}], "stats": {"total": 201, "additions": 201, "deletions": 0}, "files": [{"sha": "6fb6cf75d96fe717608a19a17415f18423c12a4e", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -1892,6 +1892,7 @@ Released 2018-09-13\n [`print_with_newline`]: https://rust-lang.github.io/rust-clippy/master/index.html#print_with_newline\n [`println_empty_string`]: https://rust-lang.github.io/rust-clippy/master/index.html#println_empty_string\n [`ptr_arg`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_arg\n+[`ptr_eq`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_eq\n [`ptr_offset_with_cast`]: https://rust-lang.github.io/rust-clippy/master/index.html#ptr_offset_with_cast\n [`pub_enum_variant_names`]: https://rust-lang.github.io/rust-clippy/master/index.html#pub_enum_variant_names\n [`question_mark`]: https://rust-lang.github.io/rust-clippy/master/index.html#question_mark"}, {"sha": "097eca0af578cfc67538f2b306f0ca623f986b25", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -281,6 +281,7 @@ mod path_buf_push_overwrite;\n mod pattern_type_mismatch;\n mod precedence;\n mod ptr;\n+mod ptr_eq;\n mod ptr_offset_with_cast;\n mod question_mark;\n mod ranges;\n@@ -778,6 +779,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &ptr::CMP_NULL,\n         &ptr::MUT_FROM_REF,\n         &ptr::PTR_ARG,\n+        &ptr_eq::PTR_EQ,\n         &ptr_offset_with_cast::PTR_OFFSET_WITH_CAST,\n         &question_mark::QUESTION_MARK,\n         &ranges::RANGE_MINUS_ONE,\n@@ -916,6 +918,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     let verbose_bit_mask_threshold = conf.verbose_bit_mask_threshold;\n     store.register_late_pass(move || box bit_mask::BitMask::new(verbose_bit_mask_threshold));\n     store.register_late_pass(|| box ptr::Ptr);\n+    store.register_late_pass(|| box ptr_eq::PtrEq);\n     store.register_late_pass(|| box needless_bool::NeedlessBool);\n     store.register_late_pass(|| box needless_bool::BoolComparison);\n     store.register_late_pass(|| box approx_const::ApproxConstant);\n@@ -1457,6 +1460,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&ptr::CMP_NULL),\n         LintId::of(&ptr::MUT_FROM_REF),\n         LintId::of(&ptr::PTR_ARG),\n+        LintId::of(&ptr_eq::PTR_EQ),\n         LintId::of(&ptr_offset_with_cast::PTR_OFFSET_WITH_CAST),\n         LintId::of(&question_mark::QUESTION_MARK),\n         LintId::of(&ranges::RANGE_ZIP_WITH_LEN),\n@@ -1611,6 +1615,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&panic_unimplemented::PANIC_PARAMS),\n         LintId::of(&ptr::CMP_NULL),\n         LintId::of(&ptr::PTR_ARG),\n+        LintId::of(&ptr_eq::PTR_EQ),\n         LintId::of(&question_mark::QUESTION_MARK),\n         LintId::of(&redundant_field_names::REDUNDANT_FIELD_NAMES),\n         LintId::of(&redundant_static_lifetimes::REDUNDANT_STATIC_LIFETIMES),"}, {"sha": "3be792ce5e4fa5c3bed6da95be0393a11e3892fa", "filename": "clippy_lints/src/ptr_eq.rs", "status": "added", "additions": 96, "deletions": 0, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/clippy_lints%2Fsrc%2Fptr_eq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/clippy_lints%2Fsrc%2Fptr_eq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fptr_eq.rs?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -0,0 +1,96 @@\n+use crate::utils;\n+use if_chain::if_chain;\n+use rustc_errors::Applicability;\n+use rustc_hir::{BinOpKind, Expr, ExprKind};\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Use `std::ptr::eq` when applicable\n+    ///\n+    /// **Why is this bad?** `ptr::eq` can be used to compare `&T` references\n+    /// (which coerce to `*const T` implicitly) by their address rather than\n+    /// comparing the values they point to.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    ///\n+    /// ```rust\n+    /// let a = &[1, 2, 3];\n+    /// let b = &[1, 2, 3];\n+    ///\n+    /// assert!(a as *const _ as usize == b as *const _ as usize);\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// let a = &[1, 2, 3];\n+    /// let b = &[1, 2, 3];\n+    ///\n+    /// assert!(std::ptr::eq(a, b));\n+    /// ```\n+    pub PTR_EQ,\n+    style,\n+    \"use `std::ptr::eq` when comparing raw pointers\"\n+}\n+\n+declare_lint_pass!(PtrEq => [PTR_EQ]);\n+\n+static LINT_MSG: &str = \"use `std::ptr::eq` when comparing raw pointers\";\n+\n+impl LateLintPass<'_> for PtrEq {\n+    fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) {\n+        if utils::in_macro(expr.span) {\n+            return;\n+        }\n+\n+        if let ExprKind::Binary(ref op, ref left, ref right) = expr.kind {\n+            if BinOpKind::Eq == op.node {\n+                let (left, right) = match (expr_as_cast_to_usize(cx, left), expr_as_cast_to_usize(cx, right)) {\n+                    (Some(lhs), Some(rhs)) => (lhs, rhs),\n+                    _ => (&**left, &**right),\n+                };\n+\n+                if_chain! {\n+                    if let Some(left_var) = expr_as_cast_to_raw_pointer(cx, left);\n+                    if let Some(right_var) = expr_as_cast_to_raw_pointer(cx, right);\n+                    if let Some(left_snip) = utils::snippet_opt(cx, left_var.span);\n+                    if let Some(right_snip) = utils::snippet_opt(cx, right_var.span);\n+                    then {\n+                        utils::span_lint_and_sugg(\n+                            cx,\n+                            PTR_EQ,\n+                            expr.span,\n+                            LINT_MSG,\n+                            \"try\",\n+                            format!(\"std::ptr::eq({}, {})\", left_snip, right_snip),\n+                            Applicability::MachineApplicable,\n+                            );\n+                    }\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+// If the given expression is a cast to an usize, return the lhs of the cast\n+// E.g., `foo as *const _ as usize` returns `foo as *const _`.\n+fn expr_as_cast_to_usize<'tcx>(cx: &LateContext<'tcx>, cast_expr: &'tcx Expr<'_>) -> Option<&'tcx Expr<'tcx>> {\n+    if cx.typeck_results().expr_ty(cast_expr) == cx.tcx.types.usize {\n+        if let ExprKind::Cast(ref expr, _) = cast_expr.kind {\n+            return Some(expr);\n+        }\n+    }\n+    None\n+}\n+\n+// If the given expression is a cast to a `*const` pointer, return the lhs of the cast\n+// E.g., `foo as *const _` returns `foo`.\n+fn expr_as_cast_to_raw_pointer<'tcx>(cx: &LateContext<'tcx>, cast_expr: &'tcx Expr<'_>) -> Option<&'tcx Expr<'tcx>> {\n+    if cx.typeck_results().expr_ty(cast_expr).is_unsafe_ptr() {\n+        if let ExprKind::Cast(ref expr, _) = cast_expr.kind {\n+            return Some(expr);\n+        }\n+    }\n+    None\n+}"}, {"sha": "96c9d12d75fbb62eb53a503c3206f2b2071a0dcd", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -1844,6 +1844,13 @@ pub static ref ALL_LINTS: Vec<Lint> = vec![\n         deprecation: None,\n         module: \"ptr\",\n     },\n+    Lint {\n+        name: \"ptr_eq\",\n+        group: \"style\",\n+        desc: \"use `std::ptr::eq` when comparing raw pointers\",\n+        deprecation: None,\n+        module: \"ptr_eq\",\n+    },\n     Lint {\n         name: \"ptr_offset_with_cast\",\n         group: \"complexity\","}, {"sha": "209081e6e8011b6fb5c7bcd4b9c915d7624f8544", "filename": "tests/ui/ptr_eq.fixed", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/tests%2Fui%2Fptr_eq.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/tests%2Fui%2Fptr_eq.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_eq.fixed?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -0,0 +1,38 @@\n+// run-rustfix\n+#![warn(clippy::ptr_eq)]\n+\n+macro_rules! mac {\n+    ($a:expr, $b:expr) => {\n+        $a as *const _ as usize == $b as *const _ as usize\n+    };\n+}\n+\n+macro_rules! another_mac {\n+    ($a:expr, $b:expr) => {\n+        $a as *const _ == $b as *const _\n+    };\n+}\n+\n+fn main() {\n+    let a = &[1, 2, 3];\n+    let b = &[1, 2, 3];\n+\n+    let _ = std::ptr::eq(a, b);\n+    let _ = std::ptr::eq(a, b);\n+    let _ = a.as_ptr() == b as *const _;\n+    let _ = a.as_ptr() == b.as_ptr();\n+\n+    // Do not lint\n+\n+    let _ = mac!(a, b);\n+    let _ = another_mac!(a, b);\n+\n+    let a = &mut [1, 2, 3];\n+    let b = &mut [1, 2, 3];\n+\n+    let _ = a.as_mut_ptr() == b as *mut [i32] as *mut _;\n+    let _ = a.as_mut_ptr() == b.as_mut_ptr();\n+\n+    let _ = a == b;\n+    let _ = core::ptr::eq(a, b);\n+}"}, {"sha": "69162870807a2c9665de1016e102c9eaf4263a55", "filename": "tests/ui/ptr_eq.rs", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/tests%2Fui%2Fptr_eq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/tests%2Fui%2Fptr_eq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_eq.rs?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -0,0 +1,38 @@\n+// run-rustfix\n+#![warn(clippy::ptr_eq)]\n+\n+macro_rules! mac {\n+    ($a:expr, $b:expr) => {\n+        $a as *const _ as usize == $b as *const _ as usize\n+    };\n+}\n+\n+macro_rules! another_mac {\n+    ($a:expr, $b:expr) => {\n+        $a as *const _ == $b as *const _\n+    };\n+}\n+\n+fn main() {\n+    let a = &[1, 2, 3];\n+    let b = &[1, 2, 3];\n+\n+    let _ = a as *const _ as usize == b as *const _ as usize;\n+    let _ = a as *const _ == b as *const _;\n+    let _ = a.as_ptr() == b as *const _;\n+    let _ = a.as_ptr() == b.as_ptr();\n+\n+    // Do not lint\n+\n+    let _ = mac!(a, b);\n+    let _ = another_mac!(a, b);\n+\n+    let a = &mut [1, 2, 3];\n+    let b = &mut [1, 2, 3];\n+\n+    let _ = a.as_mut_ptr() == b as *mut [i32] as *mut _;\n+    let _ = a.as_mut_ptr() == b.as_mut_ptr();\n+\n+    let _ = a == b;\n+    let _ = core::ptr::eq(a, b);\n+}"}, {"sha": "45d8c60382b59829048fe8dc5fcfe811307b94b1", "filename": "tests/ui/ptr_eq.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/947516f0184a7845577de1f0162f172b89965692/tests%2Fui%2Fptr_eq.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/947516f0184a7845577de1f0162f172b89965692/tests%2Fui%2Fptr_eq.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_eq.stderr?ref=947516f0184a7845577de1f0162f172b89965692", "patch": "@@ -0,0 +1,16 @@\n+error: use `std::ptr::eq` when comparing raw pointers\n+  --> $DIR/ptr_eq.rs:20:13\n+   |\n+LL |     let _ = a as *const _ as usize == b as *const _ as usize;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `std::ptr::eq(a, b)`\n+   |\n+   = note: `-D clippy::ptr-eq` implied by `-D warnings`\n+\n+error: use `std::ptr::eq` when comparing raw pointers\n+  --> $DIR/ptr_eq.rs:21:13\n+   |\n+LL |     let _ = a as *const _ == b as *const _;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `std::ptr::eq(a, b)`\n+\n+error: aborting due to 2 previous errors\n+"}]}