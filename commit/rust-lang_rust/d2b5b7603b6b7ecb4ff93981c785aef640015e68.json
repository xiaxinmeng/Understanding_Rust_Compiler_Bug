{"sha": "d2b5b7603b6b7ecb4ff93981c785aef640015e68", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyYjViNzYwM2I2YjdlY2I0ZmY5Mzk4MWM3ODVhZWY2NDAwMTVlNjg=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-06-09T14:49:02Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-06-09T20:31:49Z"}, "message": "Do not push a commit if the toolstate is unchanged.\n\nThis should greatly reduce the commits on the rust-toolstate repository.\n\n`publish_toolstate.py` defaults to keep the old status if a new one is not\nfound, so nothing needs to be changed to that file.", "tree": {"sha": "4a240d3e625f50d85163363526daa84ab659ff8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a240d3e625f50d85163363526daa84ab659ff8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2b5b7603b6b7ecb4ff93981c785aef640015e68", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlscOTUACgkQ/vbIBR0O\nATwu6RAArCFNXwqe4Fbq/wYicZ4ICk7igez3yQkqEKYndi4XWS2+79c+pZ26h1qq\n3WKvyAWWYfY7mvjy2mNGEZYd3XUB8yGeD2MdEQIy496XfdgBOGsecRBIdP5eJe9M\napptIyNMMhLwPp5qoSIy7cTlo6GAC/4zqFw49sNpmKAkOy/MEeetqR0rDrJXk5/m\nDgQVvL5dHVlF0cqQnVzl5Y8JHEjTgCn33PvTDC8svSfSxwcoHVRqyyZaMZJ+//0V\nC7yFJS3zEPt83uUCRC2de7ddtfxZY/5H6/X1uZ/YKfknofVoOlHrlSXKvRBlPYLe\nUF0+zbO3iyhuRvSrPvUrWUYb05LI+ZZLNoF5BjCPIWQcxQZqHJhGjCp9AETHLmwc\nWw3gsqfUCZt83KQ2xy1W1Y8Cc+3qozCdEBVUTVkj7QTLp5A0Z9ebZcMo2Iv30YKg\nYVznWhukEk+BEZGaq6Ad0IZsT6ms0cAqBYV/IclfjNx01L/74XLEvgzE7u20m6IX\nTbGISiHuxpbP9mg1qp2Ce7Kzg7ENLXVER/3Kuj8PO8T1+RmB1GPozu34QkaSZSq1\nsPrEcEwhnRAP7xyi41tvtVXtRsLlqmxpPmvbtqk49QoRbQmyBdrvlDkND2PkWZYp\n6/5v/eaBKeq34RzuXAtfd+hyOYa4eDGfZxJg57zY4mzfAaBMUtM=\n=irye\n-----END PGP SIGNATURE-----", "payload": "tree 4a240d3e625f50d85163363526daa84ab659ff8b\nparent 14d50bfecb569aee7ee42430f50d46252b303d24\nauthor kennytm <kennytm@gmail.com> 1528555742 +0800\ncommitter kennytm <kennytm@gmail.com> 1528576309 +0800\n\nDo not push a commit if the toolstate is unchanged.\n\nThis should greatly reduce the commits on the rust-toolstate repository.\n\n`publish_toolstate.py` defaults to keep the old status if a new one is not\nfound, so nothing needs to be changed to that file.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2b5b7603b6b7ecb4ff93981c785aef640015e68", "html_url": "https://github.com/rust-lang/rust/commit/d2b5b7603b6b7ecb4ff93981c785aef640015e68", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2b5b7603b6b7ecb4ff93981c785aef640015e68/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "14d50bfecb569aee7ee42430f50d46252b303d24", "url": "https://api.github.com/repos/rust-lang/rust/commits/14d50bfecb569aee7ee42430f50d46252b303d24", "html_url": "https://github.com/rust-lang/rust/commit/14d50bfecb569aee7ee42430f50d46252b303d24"}], "stats": {"total": 39, "additions": 27, "deletions": 12}, "files": [{"sha": "208aab434ce1fa84f289b5e0c044a4bda3afd0fc", "filename": "src/ci/docker/x86_64-gnu-tools/checkregression.py", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d2b5b7603b6b7ecb4ff93981c785aef640015e68/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fcheckregression.py", "raw_url": "https://github.com/rust-lang/rust/raw/d2b5b7603b6b7ecb4ff93981c785aef640015e68/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fcheckregression.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fcheckregression.py?ref=d2b5b7603b6b7ecb4ff93981c785aef640015e68", "patch": "@@ -18,6 +18,7 @@\n     os_name = sys.argv[1]\n     toolstate_file = sys.argv[2]\n     current_state = sys.argv[3]\n+    verb = sys.argv[4] # 'regressed' or 'changed'\n \n     with open(toolstate_file, 'r') as f:\n         toolstate = json.load(f)\n@@ -29,10 +30,17 @@\n         tool = cur['tool']\n         state = cur[os_name]\n         new_state = toolstate.get(tool, '')\n-        if new_state < state:\n+        if verb == 'regressed':\n+            updated = new_state < state\n+        elif verb == 'changed':\n+            updated = new_state != state\n+        else:\n+            print('Unknown verb {}'.format(updated))\n+            sys.exit(2)\n+        if updated:\n             print(\n-                'Error: The state of \"{}\" has regressed from \"{}\" to \"{}\"'\n-                .format(tool, state, new_state)\n+                'The state of \"{}\" has {} from \"{}\" to \"{}\"'\n+                .format(tool, verb, state, new_state)\n             )\n             regressed = True\n "}, {"sha": "d26be93861c0fa29f8b697ac988bddd053e4c7c3", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d2b5b7603b6b7ecb4ff93981c785aef640015e68/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/d2b5b7603b6b7ecb4ff93981c785aef640015e68/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=d2b5b7603b6b7ecb4ff93981c785aef640015e68", "patch": "@@ -91,19 +91,26 @@ status_check() {\n \n status_check \"submodule_changed\"\n \n-if [ \"$RUST_RELEASE_CHANNEL\" = nightly -a -n \"${TOOLSTATE_REPO_ACCESS_TOKEN+is_set}\" ]; then\n-    . \"$(dirname $0)/repo.sh\"\n-    MESSAGE_FILE=$(mktemp -t msg.XXXXXX)\n-    echo \"($OS CI update)\" > \"$MESSAGE_FILE\"\n-    commit_toolstate_change \"$MESSAGE_FILE\" \\\n+CHECK_NOT=\"$(dirname $0)/checkregression.py\"\n+change_toolstate() {\n+    # only update the history\n+    if python2.7 \"$CHECK_NOT\" \"$OS\" \"$TOOLSTATE_FILE\" \"_data/latest.json\" changed; then\n+        echo 'Toolstate is not changed. Not updating.'\n+    else\n+        if [ $SIX_WEEK_CYCLE -eq 5 ]; then\n+            python2.7 \"$CHECK_NOT\" \"$OS\" \"$TOOLSTATE_FILE\" \"_data/latest.json\" regressed\n+        fi\n         sed -i \"1 a\\\\\n $COMMIT\\t$(cat \"$TOOLSTATE_FILE\")\n \" \"history/$OS.tsv\"\n-    # if we are at the last week in the 6-week release cycle, reject any kind of regression.\n-    if [ $SIX_WEEK_CYCLE -eq 5 ]; then\n-        python2.7 \"$(dirname $0)/checkregression.py\" \\\n-            \"$OS\" \"$TOOLSTATE_FILE\" \"rust-toolstate/_data/latest.json\"\n     fi\n+}\n+\n+if [ \"$RUST_RELEASE_CHANNEL\" = nightly -a -n \"${TOOLSTATE_REPO_ACCESS_TOKEN+is_set}\" ]; then\n+    . \"$(dirname $0)/repo.sh\"\n+    MESSAGE_FILE=$(mktemp -t msg.XXXXXX)\n+    echo \"($OS CI update)\" > \"$MESSAGE_FILE\"\n+    commit_toolstate_change \"$MESSAGE_FILE\" change_toolstate\n     rm -f \"$MESSAGE_FILE\"\n     exit 0\n fi"}]}