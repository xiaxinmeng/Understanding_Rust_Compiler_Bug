{"sha": "212fc2134d0bb919a5c7d0a6aec1dd88a230a444", "node_id": "C_kwDOAAsO6NoAKDIxMmZjMjEzNGQwYmI5MTlhNWM3ZDBhNmFlYzFkZDg4YTIzMGE0NDQ", "commit": {"author": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-04-25T00:53:06Z"}, "committer": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-05-10T23:13:54Z"}, "message": "Fix running bootstrap tests on a fresh clone\n\nIn #96303, I changed the tests not to manage submodules, with the main\ngoal of avoiding a clone for llvm-project. Unfortunately, there are some tests\nwhich depend on submodules - I didn't notice locally because they were already checked out for me,\nand CI doesn't use submodule handling at all. Fresh clones, however, were impacted:\n```\nfailures:\n\n---- builder::tests::defaults::doc_default stdout ----\nthread 'main' panicked at 'fs::read_dir(builder.src.join(&relative_path).join(\"redirects\")) failed with No such file or directory (os error 2)', src/bootstrap/doc.rs:232:21\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n\n---- builder::tests::dist::dist_only_cross_host stdout ----\nthread 'main' panicked at 'fs::read_to_string(&toml_file_name) failed with No such file or directory (os error 2)', src/bootstrap/lib.rs:1314:20\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n```\n\nTry and get the best of both worlds by only checking out the submodules actually used in tests.", "tree": {"sha": "8b173378e83275082baf23bd1e630273b0fbf9b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b173378e83275082baf23bd1e630273b0fbf9b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/212fc2134d0bb919a5c7d0a6aec1dd88a230a444", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/212fc2134d0bb919a5c7d0a6aec1dd88a230a444", "html_url": "https://github.com/rust-lang/rust/commit/212fc2134d0bb919a5c7d0a6aec1dd88a230a444", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/212fc2134d0bb919a5c7d0a6aec1dd88a230a444/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18f314e7027fe7084aaab8620c624a0d7bd29e70", "url": "https://api.github.com/repos/rust-lang/rust/commits/18f314e7027fe7084aaab8620c624a0d7bd29e70", "html_url": "https://github.com/rust-lang/rust/commit/18f314e7027fe7084aaab8620c624a0d7bd29e70"}], "stats": {"total": 12, "additions": 12, "deletions": 0}, "files": [{"sha": "d3e91c75837a0dd8a9d6b665b7c08c77fde0ce71", "filename": "src/bootstrap/builder/tests.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/212fc2134d0bb919a5c7d0a6aec1dd88a230a444/src%2Fbootstrap%2Fbuilder%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/212fc2134d0bb919a5c7d0a6aec1dd88a230a444/src%2Fbootstrap%2Fbuilder%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder%2Ftests.rs?ref=212fc2134d0bb919a5c7d0a6aec1dd88a230a444", "patch": "@@ -7,7 +7,19 @@ fn configure(cmd: &str, host: &[&str], target: &[&str]) -> Config {\n     // don't save toolstates\n     config.save_toolstates = None;\n     config.dry_run = true;\n+\n+    // Ignore most submodules, since we don't need them for a dry run.\n+    // But make sure to check out the `doc` and `rust-analyzer` submodules, since some steps need them\n+    // just to know which commands to run.\n+    let submodule_build = Build::new(Config {\n+        // don't include LLVM, so CI doesn't require ninja/cmake to be installed\n+        rust_codegen_backends: vec![],\n+        ..Config::parse(&[\"check\".to_owned()])\n+    });\n+    submodule_build.update_submodule(Path::new(\"src/doc/book\"));\n+    submodule_build.update_submodule(Path::new(\"src/tools/rust-analyzer\"));\n     config.submodules = Some(false);\n+\n     config.ninja_in_file = false;\n     // try to avoid spurious failures in dist where we create/delete each others file\n     // HACK: rather than pull in `tempdir`, use the one that cargo has conveniently created for us"}]}