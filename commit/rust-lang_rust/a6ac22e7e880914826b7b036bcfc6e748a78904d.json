{"sha": "a6ac22e7e880914826b7b036bcfc6e748a78904d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2YWMyMmU3ZTg4MDkxNDgyNmI3YjAzNmJjZmM2ZTc0OGE3ODkwNGQ=", "commit": {"author": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2019-10-30T19:22:29Z"}, "committer": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2019-10-30T19:51:14Z"}, "message": "Change CrateMetadata's source_map_import_info from RwLock to Once\n\nThis field is created lazily on first use and after that is read only.\nThat's exactly what Once is for.", "tree": {"sha": "5f274a8085a0e41b9bc33c1374d920903cb305ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f274a8085a0e41b9bc33c1374d920903cb305ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6ac22e7e880914826b7b036bcfc6e748a78904d", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEmNHc6jmXzkUyxd4xiMlBzaHUZDIFAl256bMACgkQiMlBzaHU\nZDJlQBAAgbz66W3sydhsNX1sQ+pNdMJpLEisB8cr6+RygW1hyLsIqt9lEcm9sRXD\n3R6B8HoxHEEvO1k+X8i2pbQPxAmHXiFC3q0wQ9Vl0N7U59VNX/L2cnsymosSph0C\nWi7G42Qqg52xkJsNyp/Z7CKREsBPkMgESrlLMXUz6K7vt4XCNIMHb6kcfoaK2kD2\n3M2pvBaIQi1RNV+vOtEUAfK2PCLw6Vjs4puoEv69ey52NQDbaMzFdkytmz8oUkyz\ngtHVSo+kS1jp+GJLyO6RMd8bypZ6AtOEVgYg6+IA5pHvVXxDiF89lRJLGsybuHqh\n4M45yPuNLJKTwjl++vmO4KPtHjHKP0Oate995T2H1XqrHd02s3Ejpypr4cNDQiUV\n2V3b60oTRk6neCgJq/mgQ+sbjiU1vWhhaLgMypn6EUDnv1chosQBwHBgf2bJwz2g\nrCJ2YHfacznrgJ67b9ux6uyfV+sXpGqr22T+lxiRFxbgL35bF7ufvM1P3CEv7ScK\nAPiDKcHGz0UbIJZHq8th2hP9Aen2nri+mK9aodE5iJ4GhSI2g0Y+FGg8dDRoVVCZ\nbWfDeNkhupChnOo523L6zUNGB/BnEctnzyRagBCRonZ0/Oi3BrtE+8hDpQLQakWJ\n61FI6SzgCeNDwT3IEh8TOfnG+Q1mwkVC5GOYJnbbwxd+RISx9Ec=\n=abvJ\n-----END PGP SIGNATURE-----", "payload": "tree 5f274a8085a0e41b9bc33c1374d920903cb305ea\nparent 308c4a620dde80f4b319bd3acbb2ef45cb12efa0\nauthor Santiago Pastorino <spastorino@gmail.com> 1572463349 -0300\ncommitter Santiago Pastorino <spastorino@gmail.com> 1572465074 -0300\n\nChange CrateMetadata's source_map_import_info from RwLock to Once\n\nThis field is created lazily on first use and after that is read only.\nThat's exactly what Once is for.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6ac22e7e880914826b7b036bcfc6e748a78904d", "html_url": "https://github.com/rust-lang/rust/commit/a6ac22e7e880914826b7b036bcfc6e748a78904d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6ac22e7e880914826b7b036bcfc6e748a78904d/comments", "author": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "committer": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "308c4a620dde80f4b319bd3acbb2ef45cb12efa0", "url": "https://api.github.com/repos/rust-lang/rust/commits/308c4a620dde80f4b319bd3acbb2ef45cb12efa0", "html_url": "https://github.com/rust-lang/rust/commit/308c4a620dde80f4b319bd3acbb2ef45cb12efa0"}], "stats": {"total": 149, "additions": 66, "deletions": 83}, "files": [{"sha": "540b06b3a8be99e692201836c32fc11a7b1ca0b8", "filename": "src/librustc_metadata/creader.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a6ac22e7e880914826b7b036bcfc6e748a78904d/src%2Flibrustc_metadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6ac22e7e880914826b7b036bcfc6e748a78904d/src%2Flibrustc_metadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcreader.rs?ref=a6ac22e7e880914826b7b036bcfc6e748a78904d", "patch": "@@ -3,7 +3,7 @@\n use crate::cstore::{self, CStore, MetadataBlob};\n use crate::locator::{self, CratePaths};\n use crate::schema::{CrateRoot, CrateDep};\n-use rustc_data_structures::sync::{RwLock, Lock, AtomicCell};\n+use rustc_data_structures::sync::{Lock, Once, AtomicCell};\n \n use rustc::hir::def_id::CrateNum;\n use rustc_data_structures::svh::Svh;\n@@ -249,7 +249,7 @@ impl<'a> CrateLoader<'a> {\n             cnum_map,\n             cnum,\n             dependencies: Lock::new(dependencies),\n-            source_map_import_info: RwLock::new(vec![]),\n+            source_map_import_info: Once::new(),\n             alloc_decoding_state: AllocDecodingState::new(interpret_alloc_index),\n             dep_kind: Lock::new(dep_kind),\n             source,"}, {"sha": "8dfc921c95b3d1205848148a491c2c5b345802a4", "filename": "src/librustc_metadata/cstore.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a6ac22e7e880914826b7b036bcfc6e748a78904d/src%2Flibrustc_metadata%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6ac22e7e880914826b7b036bcfc6e748a78904d/src%2Flibrustc_metadata%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore.rs?ref=a6ac22e7e880914826b7b036bcfc6e748a78904d", "patch": "@@ -9,7 +9,7 @@ use rustc::middle::cstore::{CrateSource, DepKind, ExternCrate};\n use rustc::mir::interpret::AllocDecodingState;\n use rustc_index::vec::IndexVec;\n use rustc::util::nodemap::FxHashMap;\n-use rustc_data_structures::sync::{Lrc, RwLock, Lock, MetadataRef, AtomicCell};\n+use rustc_data_structures::sync::{Lrc, Lock, MetadataRef, Once, AtomicCell};\n use syntax::ast;\n use syntax::edition::Edition;\n use syntax_expand::base::SyntaxExtension;\n@@ -62,7 +62,7 @@ crate struct CrateMetadata {\n     /// Proc macro descriptions for this crate, if it's a proc macro crate.\n     crate raw_proc_macros: Option<&'static [ProcMacro]>,\n     /// Source maps for code from the crate.\n-    crate source_map_import_info: RwLock<Vec<ImportedSourceFile>>,\n+    crate source_map_import_info: Once<Vec<ImportedSourceFile>>,\n     /// Used for decoding interpret::AllocIds in a cached & thread-safe manner.\n     crate alloc_decoding_state: AllocDecodingState,\n     /// The `DepNodeIndex` of the `DepNode` representing this upstream crate."}, {"sha": "b1110ce80a85c969f5f350bc7338385d5688d742", "filename": "src/librustc_metadata/decoder.rs", "status": "modified", "additions": 62, "deletions": 79, "changes": 141, "blob_url": "https://github.com/rust-lang/rust/blob/a6ac22e7e880914826b7b036bcfc6e748a78904d/src%2Flibrustc_metadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6ac22e7e880914826b7b036bcfc6e748a78904d/src%2Flibrustc_metadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdecoder.rs?ref=a6ac22e7e880914826b7b036bcfc6e748a78904d", "patch": "@@ -5,7 +5,7 @@ use crate::schema::*;\n use crate::table::{FixedSizeEncoding, PerDefTable};\n \n use rustc_index::vec::IndexVec;\n-use rustc_data_structures::sync::{Lrc, ReadGuard};\n+use rustc_data_structures::sync::Lrc;\n use rustc::hir::map::{DefKey, DefPath, DefPathData, DefPathHash};\n use rustc::hir;\n use rustc::middle::cstore::{LinkagePreference, NativeLibrary, ForeignModule};\n@@ -1290,86 +1290,69 @@ impl<'a, 'tcx> CrateMetadata {\n     fn imported_source_files(\n         &'a self,\n         local_source_map: &source_map::SourceMap,\n-    ) -> ReadGuard<'a, Vec<cstore::ImportedSourceFile>> {\n-        {\n-            let source_files = self.source_map_import_info.borrow();\n-            if !source_files.is_empty() {\n-                return source_files;\n-            }\n-        }\n-\n-        // Lock the source_map_import_info to ensure this only happens once\n-        let mut source_map_import_info = self.source_map_import_info.borrow_mut();\n-\n-        if !source_map_import_info.is_empty() {\n-            drop(source_map_import_info);\n-            return self.source_map_import_info.borrow();\n-        }\n-\n-        let external_source_map = self.root.source_map.decode(self);\n-\n-        let imported_source_files = external_source_map.map(|source_file_to_import| {\n-            // We can't reuse an existing SourceFile, so allocate a new one\n-            // containing the information we need.\n-            let syntax_pos::SourceFile { name,\n-                                      name_was_remapped,\n-                                      src_hash,\n-                                      start_pos,\n-                                      end_pos,\n-                                      mut lines,\n-                                      mut multibyte_chars,\n-                                      mut non_narrow_chars,\n-                                      mut normalized_pos,\n-                                      name_hash,\n-                                      .. } = source_file_to_import;\n-\n-            let source_length = (end_pos - start_pos).to_usize();\n-\n-            // Translate line-start positions and multibyte character\n-            // position into frame of reference local to file.\n-            // `SourceMap::new_imported_source_file()` will then translate those\n-            // coordinates to their new global frame of reference when the\n-            // offset of the SourceFile is known.\n-            for pos in &mut lines {\n-                *pos = *pos - start_pos;\n-            }\n-            for mbc in &mut multibyte_chars {\n-                mbc.pos = mbc.pos - start_pos;\n-            }\n-            for swc in &mut non_narrow_chars {\n-                *swc = *swc - start_pos;\n-            }\n-            for np in &mut normalized_pos {\n-                np.pos = np.pos - start_pos;\n-            }\n-\n-            let local_version = local_source_map.new_imported_source_file(name,\n-                                                                   name_was_remapped,\n-                                                                   self.cnum.as_u32(),\n-                                                                   src_hash,\n-                                                                   name_hash,\n-                                                                   source_length,\n-                                                                   lines,\n-                                                                   multibyte_chars,\n-                                                                   non_narrow_chars,\n-                                                                   normalized_pos);\n-            debug!(\"CrateMetaData::imported_source_files alloc \\\n-                    source_file {:?} original (start_pos {:?} end_pos {:?}) \\\n-                    translated (start_pos {:?} end_pos {:?})\",\n-                   local_version.name, start_pos, end_pos,\n-                   local_version.start_pos, local_version.end_pos);\n-\n-            cstore::ImportedSourceFile {\n-                original_start_pos: start_pos,\n-                original_end_pos: end_pos,\n-                translated_source_file: local_version,\n-            }\n-        }).collect();\n+    ) -> &[cstore::ImportedSourceFile] {\n+        self.source_map_import_info.init_locking(|| {\n+            let external_source_map = self.root.source_map.decode(self);\n+\n+            external_source_map.map(|source_file_to_import| {\n+                // We can't reuse an existing SourceFile, so allocate a new one\n+                // containing the information we need.\n+                let syntax_pos::SourceFile { name,\n+                                          name_was_remapped,\n+                                          src_hash,\n+                                          start_pos,\n+                                          end_pos,\n+                                          mut lines,\n+                                          mut multibyte_chars,\n+                                          mut non_narrow_chars,\n+                                          mut normalized_pos,\n+                                          name_hash,\n+                                          .. } = source_file_to_import;\n+\n+                let source_length = (end_pos - start_pos).to_usize();\n+\n+                // Translate line-start positions and multibyte character\n+                // position into frame of reference local to file.\n+                // `SourceMap::new_imported_source_file()` will then translate those\n+                // coordinates to their new global frame of reference when the\n+                // offset of the SourceFile is known.\n+                for pos in &mut lines {\n+                    *pos = *pos - start_pos;\n+                }\n+                for mbc in &mut multibyte_chars {\n+                    mbc.pos = mbc.pos - start_pos;\n+                }\n+                for swc in &mut non_narrow_chars {\n+                    *swc = *swc - start_pos;\n+                }\n+                for np in &mut normalized_pos {\n+                    np.pos = np.pos - start_pos;\n+                }\n \n-        *source_map_import_info = imported_source_files;\n-        drop(source_map_import_info);\n+                let local_version = local_source_map.new_imported_source_file(name,\n+                                                                       name_was_remapped,\n+                                                                       self.cnum.as_u32(),\n+                                                                       src_hash,\n+                                                                       name_hash,\n+                                                                       source_length,\n+                                                                       lines,\n+                                                                       multibyte_chars,\n+                                                                       non_narrow_chars,\n+                                                                       normalized_pos);\n+                debug!(\"CrateMetaData::imported_source_files alloc \\\n+                        source_file {:?} original (start_pos {:?} end_pos {:?}) \\\n+                        translated (start_pos {:?} end_pos {:?})\",\n+                       local_version.name, start_pos, end_pos,\n+                       local_version.start_pos, local_version.end_pos);\n+\n+                cstore::ImportedSourceFile {\n+                    original_start_pos: start_pos,\n+                    original_end_pos: end_pos,\n+                    translated_source_file: local_version,\n+                }\n+            }).collect()\n+        });\n \n-        // This shouldn't borrow twice, but there is no way to downgrade RefMut to Ref.\n         self.source_map_import_info.borrow()\n     }\n "}]}