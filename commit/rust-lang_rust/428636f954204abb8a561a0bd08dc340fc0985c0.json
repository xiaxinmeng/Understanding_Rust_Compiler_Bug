{"sha": "428636f954204abb8a561a0bd08dc340fc0985c0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQyODYzNmY5NTQyMDRhYmI4YTU2MWEwYmQwOGRjMzQwZmMwOTg1YzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-15T05:20:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-15T05:20:49Z"}, "message": "Auto merge of #84997 - pietroalbini:ci-verify-channel, r=Mark-Simulacrum\n\nError out if a PR is sent to the wrong channel\n\nIt happened multiple times that a PR meant to go on beta ends up being opened (and occasionally merged) to master. This PR does two things:\n\n* Moves the definition of the channel in `src/ci/channel` so it's easier for tools to read it. I was not sure whether to move it to `src/channel` (like `src/version`): ended up with `src/ci` as it's currently only used for CI, but I'm open to moving it to `src`. We'll need to update the release process after this.\n* Adds a check on **non-bors** builds that errors out if the base branch is not the expected one for the currently defined channel. This will not cause problems for promotion PRs, as those PRs are meant to also update the channel name.\n\nr? `@Mark-Simulacrum`", "tree": {"sha": "d679746e5d66a484f90e9159f14b291fb17e5361", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d679746e5d66a484f90e9159f14b291fb17e5361"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/428636f954204abb8a561a0bd08dc340fc0985c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/428636f954204abb8a561a0bd08dc340fc0985c0", "html_url": "https://github.com/rust-lang/rust/commit/428636f954204abb8a561a0bd08dc340fc0985c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/428636f954204abb8a561a0bd08dc340fc0985c0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1025db84a68b948139b5adcd55da31bce32da8f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/1025db84a68b948139b5adcd55da31bce32da8f3", "html_url": "https://github.com/rust-lang/rust/commit/1025db84a68b948139b5adcd55da31bce32da8f3"}, {"sha": "a8da3335e6e6f6d6ad8500205ded61a5351dc2b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/a8da3335e6e6f6d6ad8500205ded61a5351dc2b4", "html_url": "https://github.com/rust-lang/rust/commit/a8da3335e6e6f6d6ad8500205ded61a5351dc2b4"}], "stats": {"total": 73, "additions": 65, "deletions": 8}, "files": [{"sha": "aa9d97ba477b76b85fddb9391195d4b1a6ce1fca", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/428636f954204abb8a561a0bd08dc340fc0985c0/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/428636f954204abb8a561a0bd08dc340fc0985c0/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=428636f954204abb8a561a0bd08dc340fc0985c0", "patch": "@@ -72,6 +72,9 @@ jobs:\n       - name: decide whether to skip this job\n         run: src/ci/scripts/should-skip-this.sh\n         if: success() && !env.SKIP_JOB\n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        if: success() && !env.SKIP_JOB\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:\n@@ -434,6 +437,9 @@ jobs:\n       - name: decide whether to skip this job\n         run: src/ci/scripts/should-skip-this.sh\n         if: success() && !env.SKIP_JOB\n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        if: success() && !env.SKIP_JOB\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:\n@@ -541,6 +547,9 @@ jobs:\n       - name: decide whether to skip this job\n         run: src/ci/scripts/should-skip-this.sh\n         if: success() && !env.SKIP_JOB\n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        if: success() && !env.SKIP_JOB\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:"}, {"sha": "bf867e0ae5b6c08df1118a2ece970677bc479f1b", "filename": "src/ci/channel", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fchannel", "raw_url": "https://github.com/rust-lang/rust/raw/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fchannel", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fchannel?ref=428636f954204abb8a561a0bd08dc340fc0985c0", "patch": "@@ -0,0 +1 @@\n+nightly"}, {"sha": "343091cb779fc2705a153c71c9c59c50a935f5fd", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=428636f954204abb8a561a0bd08dc340fc0985c0", "patch": "@@ -126,6 +126,10 @@ x--expand-yaml-anchors--remove:\n         run: src/ci/scripts/should-skip-this.sh\n         <<: *step\n \n+      - name: ensure the channel matches the target branch\n+        run: src/ci/scripts/verify-channel.sh\n+        <<: *step\n+\n       - name: configure GitHub Actions to kill the build when outdated\n         uses: rust-lang/simpleinfra/github-actions/cancel-outdated-builds@master\n         with:"}, {"sha": "35f80a935c6937ea022eef265ed2f9e89701542a", "filename": "src/ci/run.sh", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=428636f954204abb8a561a0bd08dc340fc0985c0", "patch": "@@ -62,17 +62,10 @@ if [ \"$DIST_SRC\" = \"\" ]; then\n   RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --disable-dist-src\"\n fi\n \n-# If we're deploying artifacts then we set the release channel, otherwise if\n-# we're not deploying then we want to be sure to enable all assertions because\n-# we'll be running tests\n-#\n-# FIXME: need a scheme for changing this `nightly` value to `beta` and `stable`\n-#        either automatically or manually.\n-export RUST_RELEASE_CHANNEL=nightly\n-\n # Always set the release channel for bootstrap; this is normally not important (i.e., only dist\n # builds would seem to matter) but in practice bootstrap wants to know whether we're targeting\n # master, beta, or stable with a build to determine whether to run some checks (notably toolstate).\n+export RUST_RELEASE_CHANNEL=\"$(cat \"${ci_dir}/channel\")\"\n RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --release-channel=$RUST_RELEASE_CHANNEL\"\n \n if [ \"$DEPLOY$DEPLOY_ALT\" = \"1\" ]; then"}, {"sha": "d02dc362c63b664a6475f11fc6a10532520442be", "filename": "src/ci/scripts/verify-channel.sh", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fscripts%2Fverify-channel.sh", "raw_url": "https://github.com/rust-lang/rust/raw/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fscripts%2Fverify-channel.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Fverify-channel.sh?ref=428636f954204abb8a561a0bd08dc340fc0985c0", "patch": "@@ -0,0 +1,38 @@\n+#!/bin/bash\n+# We want to make sure all PRs are targeting the right branch when they're\n+# opened, otherwise we risk (for example) to land a beta-specific change to the\n+# master branch. This script ensures the branch of the PR matches the channel.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n+\n+if isCiBranch auto || isCiBranch try; then\n+    echo \"channel verification is only executed on PR builds\"\n+    exit\n+fi\n+\n+channel=$(cat \"$(ciCheckoutPath)/src/ci/channel\")\n+case \"${channel}\" in\n+    nightly)\n+        channel_branch=\"master\"\n+        ;;\n+    beta)\n+        channel_branch=\"beta\"\n+        ;;\n+    stable)\n+        channel_branch=\"stable\"\n+        ;;\n+    *)\n+        echo \"error: unknown channel defined in src/ci/channel: ${channel}\"\n+        exit 1\n+esac\n+\n+branch=\"$(ciBaseBranch)\"\n+if [[ \"${branch}\" != \"${channel_branch}\" ]]; then\n+    echo \"error: PRs changing the \\`${channel}\\` channel should be sent to the \\\n+\\`${channel_branch}\\` branch!\"\n+\n+    exit 1\n+fi"}, {"sha": "332a949a4dc51bda7202d33aa63337d8902c4212", "filename": "src/ci/shared.sh", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/428636f954204abb8a561a0bd08dc340fc0985c0/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=428636f954204abb8a561a0bd08dc340fc0985c0", "patch": "@@ -73,6 +73,18 @@ function isCiBranch {\n     fi\n }\n \n+function ciBaseBranch {\n+    if isAzurePipelines; then\n+        echo \"unsupported on Azure Pipelines\"\n+        exit 1\n+    elif isGitHubActions; then\n+        echo \"${GITHUB_BASE_REF#refs/heads/}\"\n+    else\n+        echo \"ciBaseBranch only works inside CI!\"\n+        exit 1\n+    fi\n+}\n+\n function ciCommit {\n     if isAzurePipelines; then\n         echo \"${BUILD_SOURCEVERSION}\""}]}