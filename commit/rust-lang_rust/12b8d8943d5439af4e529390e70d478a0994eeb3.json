{"sha": "12b8d8943d5439af4e529390e70d478a0994eeb3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyYjhkODk0M2Q1NDM5YWY0ZTUyOTM5MGU3MGQ0NzhhMDk5NGVlYjM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-09-25T17:42:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-25T17:42:52Z"}, "message": "Rollup merge of #77183 - bugadani:issue-77088, r=varkor\n\nAllow multiple allow_internal_unstable attributes\n\nFixes #77088", "tree": {"sha": "bbbdbb7e54c33a24f23981e1c97f77ae8fbe5791", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbbdbb7e54c33a24f23981e1c97f77ae8fbe5791"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12b8d8943d5439af4e529390e70d478a0994eeb3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfbiwcCRBK7hj4Ov3rIwAAdHIIAJzWz4EaPeKT5ZIENyqZeo9A\nbd/re78LxGJSFmgwhewWCmoQh+5OJrqiQTLC4g9loTDsuMT1oQdQrDypz4PCbwI9\nrHWbanPsu+UCzHP4NT4QeGiQqsVxT6vWtjvQm/h+u7bPjIbHfBlmvgCZghgNdCJj\nAql23X33neCaeEaDK/9Sbx4jet/INqkWLg2sDvsSiQygB/CYYryf99H4o96mUVik\nG0nT7nuLlCG/ZK4FkYQsvvNAUd08baV4XGGjhl7qPKgM1ZTJV/11JgWg5uqKzZEN\n5U3HLlQo/HxK+KXu+mao2Ir7Pz/IhRP9veOSsUtlL/NWuWp27nnyItJfzU4k9lU=\n=W0h6\n-----END PGP SIGNATURE-----\n", "payload": "tree bbbdbb7e54c33a24f23981e1c97f77ae8fbe5791\nparent a7bdf851cfc869fe0a1938705bc62493034c2ea0\nparent 54c9c949a171b9c55d265ab4831d310e5865b4ee\nauthor Jonas Schievink <jonasschievink@gmail.com> 1601055772 +0200\ncommitter GitHub <noreply@github.com> 1601055772 +0200\n\nRollup merge of #77183 - bugadani:issue-77088, r=varkor\n\nAllow multiple allow_internal_unstable attributes\n\nFixes #77088\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12b8d8943d5439af4e529390e70d478a0994eeb3", "html_url": "https://github.com/rust-lang/rust/commit/12b8d8943d5439af4e529390e70d478a0994eeb3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12b8d8943d5439af4e529390e70d478a0994eeb3/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7bdf851cfc869fe0a1938705bc62493034c2ea0", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7bdf851cfc869fe0a1938705bc62493034c2ea0", "html_url": "https://github.com/rust-lang/rust/commit/a7bdf851cfc869fe0a1938705bc62493034c2ea0"}, {"sha": "54c9c949a171b9c55d265ab4831d310e5865b4ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/54c9c949a171b9c55d265ab4831d310e5865b4ee", "html_url": "https://github.com/rust-lang/rust/commit/54c9c949a171b9c55d265ab4831d310e5865b4ee"}], "stats": {"total": 39, "additions": 28, "deletions": 11}, "files": [{"sha": "03dbcc450246f742fbca3d6859f346790b0219db", "filename": "compiler/rustc_attr/src/builtin.rs", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/12b8d8943d5439af4e529390e70d478a0994eeb3/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12b8d8943d5439af4e529390e70d478a0994eeb3/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs?ref=12b8d8943d5439af4e529390e70d478a0994eeb3", "patch": "@@ -1022,14 +1022,21 @@ pub fn find_transparency(\n \n pub fn allow_internal_unstable<'a>(\n     sess: &'a Session,\n-    attrs: &[Attribute],\n+    attrs: &'a [Attribute],\n ) -> Option<impl Iterator<Item = Symbol> + 'a> {\n-    let attr = sess.find_by_name(attrs, sym::allow_internal_unstable)?;\n-    let list = attr.meta_item_list().or_else(|| {\n-        sess.diagnostic()\n-            .span_err(attr.span, \"allow_internal_unstable expects list of feature names\");\n-        None\n-    })?;\n+    let attrs = sess.filter_by_name(attrs, sym::allow_internal_unstable);\n+    let list = attrs\n+        .filter_map(move |attr| {\n+            attr.meta_item_list().or_else(|| {\n+                sess.diagnostic().span_err(\n+                    attr.span,\n+                    \"`allow_internal_unstable` expects a list of feature names\",\n+                );\n+                None\n+            })\n+        })\n+        .flatten();\n+\n     Some(list.into_iter().filter_map(move |it| {\n         let name = it.ident().map(|ident| ident.name);\n         if name.is_none() {"}, {"sha": "eb4d6cb380efe78e78d5898f99e5343800bc87fc", "filename": "src/test/ui/internal/auxiliary/internal_unstable.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/12b8d8943d5439af4e529390e70d478a0994eeb3/src%2Ftest%2Fui%2Finternal%2Fauxiliary%2Finternal_unstable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12b8d8943d5439af4e529390e70d478a0994eeb3/src%2Ftest%2Fui%2Finternal%2Fauxiliary%2Finternal_unstable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finternal%2Fauxiliary%2Finternal_unstable.rs?ref=12b8d8943d5439af4e529390e70d478a0994eeb3", "patch": "@@ -52,6 +52,15 @@ macro_rules! access_field_allow {\n     ($e: expr) => { $e.x }\n }\n \n+// regression test for #77088\n+#[stable(feature = \"stable\", since = \"1.0.0\")]\n+#[allow_internal_unstable(struct_field)]\n+#[allow_internal_unstable(struct2_field)]\n+#[macro_export]\n+macro_rules! access_field_allow2 {\n+    ($e: expr) => { $e.x }\n+}\n+\n #[stable(feature = \"stable\", since = \"1.0.0\")]\n #[allow_internal_unstable()]\n #[macro_export]"}, {"sha": "94bd6aab23bffe6a4f5d16c3ca23569f0445a729", "filename": "src/test/ui/internal/internal-unstable.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/12b8d8943d5439af4e529390e70d478a0994eeb3/src%2Ftest%2Fui%2Finternal%2Finternal-unstable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12b8d8943d5439af4e529390e70d478a0994eeb3/src%2Ftest%2Fui%2Finternal%2Finternal-unstable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finternal%2Finternal-unstable.rs?ref=12b8d8943d5439af4e529390e70d478a0994eeb3", "patch": "@@ -28,6 +28,7 @@ fn main() {\n     construct_unstable_allow!(0);\n     |x: internal_unstable::Foo| { call_method_allow!(x) };\n     |x: internal_unstable::Bar| { access_field_allow!(x) };\n+    |x: internal_unstable::Bar| { access_field_allow2!(x) }; // regression test for #77088\n \n     // bad.\n     pass_through_allow!(internal_unstable::unstable()); //~ ERROR use of unstable"}, {"sha": "2e6360c75c42af9f4ecd0909e921fff942e3e32b", "filename": "src/test/ui/internal/internal-unstable.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/12b8d8943d5439af4e529390e70d478a0994eeb3/src%2Ftest%2Fui%2Finternal%2Finternal-unstable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/12b8d8943d5439af4e529390e70d478a0994eeb3/src%2Ftest%2Fui%2Finternal%2Finternal-unstable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finternal%2Finternal-unstable.stderr?ref=12b8d8943d5439af4e529390e70d478a0994eeb3", "patch": "@@ -1,29 +1,29 @@\n error[E0658]: use of unstable library feature 'function'\n-  --> $DIR/internal-unstable.rs:33:25\n+  --> $DIR/internal-unstable.rs:34:25\n    |\n LL |     pass_through_allow!(internal_unstable::unstable());\n    |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = help: add `#![feature(function)]` to the crate attributes to enable\n \n error[E0658]: use of unstable library feature 'function'\n-  --> $DIR/internal-unstable.rs:35:27\n+  --> $DIR/internal-unstable.rs:36:27\n    |\n LL |     pass_through_noallow!(internal_unstable::unstable());\n    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = help: add `#![feature(function)]` to the crate attributes to enable\n \n error[E0658]: use of unstable library feature 'function'\n-  --> $DIR/internal-unstable.rs:39:22\n+  --> $DIR/internal-unstable.rs:40:22\n    |\n LL |     println!(\"{:?}\", internal_unstable::unstable());\n    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = help: add `#![feature(function)]` to the crate attributes to enable\n \n error[E0658]: use of unstable library feature 'function'\n-  --> $DIR/internal-unstable.rs:41:10\n+  --> $DIR/internal-unstable.rs:42:10\n    |\n LL |     bar!(internal_unstable::unstable());\n    |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^"}]}