{"sha": "5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwOTJkOGMxYWU1MDAxMGQzNWY2ODYwYjY0MjBhNjlkZGNkOWNhNDU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-06-05T12:29:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-05T12:29:52Z"}, "message": "Merge #9147\n\n9147: internal: enable proc macros and build scripts in cli r=flodiebold a=lnicola\n\n\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "bb90ff3cd3e5185fe2a4fc35b0d171a6679e691b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb90ff3cd3e5185fe2a4fc35b0d171a6679e691b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgu25ACRBK7hj4Ov3rIwAAcVcIACynsAK+7EYswM+UJJwNcEjA\nc3qpxBBxkvY4gP1/fSFySV4W8KGRvXLwavjO50ac0XnP75uMdvH5mYIxtse3bjCH\nC7tc+kq2t3juvEkifnbPifLFgpSQG3r6fOSf1b7YA0daJXUHlMB8riW4Fpb3uNlt\nTnTXH2qtie/0sEcEypUEkjjFBjHSyueJNdu8P94UyC6oWpQbyQlNEdwiU5lshWt1\noZqyWeVidISe8ploAw6v0BP5gYUBuNHR9SH/gi/e2xVh2PfRRO+NwB0t8H4EqVO6\n1HVlp6+p8mIbBSuB/QqVw8hp6zncvnJKtfR+tL/ufkZUXN1JsYFfnCWK1rWFw14=\n=CJZ7\n-----END PGP SIGNATURE-----\n", "payload": "tree bb90ff3cd3e5185fe2a4fc35b0d171a6679e691b\nparent 4c54ec1c3cd45db142d2e4592606b0021cf66033\nparent 18484365e69de06f20c234d57888a4b13ad9442b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1622896192 +0000\ncommitter GitHub <noreply@github.com> 1622896192 +0000\n\nMerge #9147\n\n9147: internal: enable proc macros and build scripts in cli r=flodiebold a=lnicola\n\n\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "html_url": "https://github.com/rust-lang/rust/commit/5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c54ec1c3cd45db142d2e4592606b0021cf66033", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c54ec1c3cd45db142d2e4592606b0021cf66033", "html_url": "https://github.com/rust-lang/rust/commit/4c54ec1c3cd45db142d2e4592606b0021cf66033"}, {"sha": "18484365e69de06f20c234d57888a4b13ad9442b", "url": "https://api.github.com/repos/rust-lang/rust/commits/18484365e69de06f20c234d57888a4b13ad9442b", "html_url": "https://github.com/rust-lang/rust/commit/18484365e69de06f20c234d57888a4b13ad9442b"}], "stats": {"total": 43, "additions": 21, "deletions": 22}, "files": [{"sha": "19173241b2803ae6b234158af037bc7a5e4d46f2", "filename": "crates/rust-analyzer/src/bin/flags.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fflags.rs?ref=5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "patch": "@@ -67,10 +67,10 @@ xflags::xflags! {\n             /// Don't load sysroot crates (`std`, `core` & friends).\n             optional --no-sysroot\n \n-            /// Load OUT_DIR values by running `cargo check` before analysis.\n-            optional --load-output-dirs\n-            /// Use proc-macro-srv for proc-macro expanding.\n-            optional --with-proc-macro\n+            /// Don't run build scripts or load `OUT_DIR` values by running `cargo check` before analysis.\n+            optional --disable-build-scripts\n+            /// Don't use expand proc macros.\n+            optional --disable-proc-macros\n             /// Only resolve names, don't run type inference.\n             optional --skip-inference\n         }\n@@ -79,10 +79,10 @@ xflags::xflags! {\n             /// Directory with Cargo.toml.\n             required path: PathBuf\n         {\n-            /// Load OUT_DIR values by running `cargo check` before analysis.\n-            optional --load-output-dirs\n-            /// Use proc-macro-srv for proc-macro expanding.\n-            optional --with-proc-macro\n+            /// Don't run build scripts or load `OUT_DIR` values by running `cargo check` before analysis.\n+            optional --disable-build-scripts\n+            /// Don't use expand proc macros.\n+            optional --disable-proc-macros\n         }\n \n         cmd ssr\n@@ -158,17 +158,17 @@ pub struct AnalysisStats {\n     pub only: Option<String>,\n     pub with_deps: bool,\n     pub no_sysroot: bool,\n-    pub load_output_dirs: bool,\n-    pub with_proc_macro: bool,\n+    pub disable_build_scripts: bool,\n+    pub disable_proc_macros: bool,\n     pub skip_inference: bool,\n }\n \n #[derive(Debug)]\n pub struct Diagnostics {\n     pub path: PathBuf,\n \n-    pub load_output_dirs: bool,\n-    pub with_proc_macro: bool,\n+    pub disable_build_scripts: bool,\n+    pub disable_proc_macros: bool,\n }\n \n #[derive(Debug)]"}, {"sha": "afc96505fa3a2ef4f0acef3a159ef75bc235b2a0", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "patch": "@@ -91,14 +91,14 @@ fn try_main() -> Result<()> {\n             with_deps: cmd.with_deps,\n             no_sysroot: cmd.no_sysroot,\n             path: cmd.path,\n-            load_output_dirs: cmd.load_output_dirs,\n-            with_proc_macro: cmd.with_proc_macro,\n+            enable_build_scripts: !cmd.disable_build_scripts,\n+            enable_proc_macros: !cmd.disable_proc_macros,\n             skip_inference: cmd.skip_inference,\n         }\n         .run(verbosity)?,\n \n         flags::RustAnalyzerCmd::Diagnostics(cmd) => {\n-            cli::diagnostics(&cmd.path, cmd.load_output_dirs, cmd.with_proc_macro)?\n+            cli::diagnostics(&cmd.path, !cmd.disable_build_scripts, !cmd.disable_proc_macros)?\n         }\n         flags::RustAnalyzerCmd::Ssr(cmd) => cli::apply_ssr_rules(cmd.rule)?,\n         flags::RustAnalyzerCmd::Search(cmd) => cli::search_for_patterns(cmd.pattern, cmd.debug)?,"}, {"sha": "5364e907c0932126b3e4480cfb01b20353cefbc0", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "patch": "@@ -51,8 +51,8 @@ pub struct AnalysisStatsCmd {\n     pub with_deps: bool,\n     pub no_sysroot: bool,\n     pub path: PathBuf,\n-    pub load_output_dirs: bool,\n-    pub with_proc_macro: bool,\n+    pub enable_build_scripts: bool,\n+    pub enable_proc_macros: bool,\n     pub skip_inference: bool,\n }\n \n@@ -67,9 +67,9 @@ impl AnalysisStatsCmd {\n         let mut cargo_config = CargoConfig::default();\n         cargo_config.no_sysroot = self.no_sysroot;\n         let load_cargo_config = LoadCargoConfig {\n-            load_out_dirs_from_check: self.load_output_dirs,\n+            load_out_dirs_from_check: self.enable_build_scripts,\n             wrap_rustc: false,\n-            with_proc_macro: self.with_proc_macro,\n+            with_proc_macro: self.enable_proc_macros,\n         };\n         let (host, vfs, _proc_macro) =\n             load_workspace_at(&self.path, &cargo_config, &load_cargo_config, &|_| {})?;"}, {"sha": "34679062f9ffaad37b5439c95f938b6ca3d676a7", "filename": "xtask/src/metrics.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/xtask%2Fsrc%2Fmetrics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5092d8c1ae50010d35f6860b6420a69ddcd9ca45/xtask%2Fsrc%2Fmetrics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fmetrics.rs?ref=5092d8c1ae50010d35f6860b6420a69ddcd9ca45", "patch": "@@ -81,9 +81,8 @@ impl Metrics {\n     }\n     fn measure_analysis_stats_path(&mut self, name: &str, path: &str) -> Result<()> {\n         eprintln!(\"\\nMeasuring analysis-stats/{}\", name);\n-        let output =\n-            cmd!(\"./target/release/rust-analyzer --quiet analysis-stats --memory-usage {path}\")\n-                .read()?;\n+        let output = cmd!(\"./target/release/rust-analyzer -q analysis-stats --memory-usage {path}\")\n+            .read()?;\n         for (metric, value, unit) in parse_metrics(&output) {\n             self.report(&format!(\"analysis-stats/{}/{}\", name, metric), value, unit.into());\n         }"}]}