{"sha": "cbf4b4664068e255fac92f898b9a0e046680dd08", "node_id": "C_kwDOAAsO6NoAKGNiZjRiNDY2NDA2OGUyNTVmYWM5MmY4OThiOWEwZTA0NjY4MGRkMDg", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-02-06T03:13:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-06T03:13:36Z"}, "message": "Rollup merge of #93669 - compiler-errors:const-generic-args, r=lcnr\n\nResolve lifetimes for const generic defaults\n\nWe weren't visiting the const generic default argument in `rustc_resolve::late::lifetimes`. This seems to fix the issue, and we deny any non-`'static` lifetimes anyways.\n\nFixes #93647", "tree": {"sha": "d2425ecc7860c3012ebc85cc3781b58a1218ca3f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2425ecc7860c3012ebc85cc3781b58a1218ca3f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbf4b4664068e255fac92f898b9a0e046680dd08", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh/zzgCRBK7hj4Ov3rIwAALPQIABrjoGmCCi9lPihQzLyRNUVF\nqBDRUK8B2ihr04K46Sjr5KlPPELBpAi4dGh9kIEr3AxUszuS4vUKqUJKpYejH8zd\nkV94VlxYXTN97q6U76k1UkNLvCIAPDunx3Ya2dptCUAebpm63fqIviv4qK+Nb788\n7j6nn7MjjSUyZyZUOvQbt0r550Zl45amlv2Dd0+37VuOZoyLgX2+y7Ya/LSCKRK/\n+qMopqudqnSyaL8G83NA1+4bArAKeW3HesI7BDOVCjStivU/Q7Qu9MIOWEvYm9aT\nUHLxDaT1jI4FcnN6W340WZmVa0DPvdLzVHUsA2wepM7vIc5q5lIbmYFf0Xy13s4=\n=22Gk\n-----END PGP SIGNATURE-----\n", "payload": "tree d2425ecc7860c3012ebc85cc3781b58a1218ca3f\nparent b7287e9e4f2541635ed09412c823d9711014e1c8\nparent bcf98841d47b23dfc4cc85568fcd8dbb79748965\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1644117216 +0100\ncommitter GitHub <noreply@github.com> 1644117216 +0100\n\nRollup merge of #93669 - compiler-errors:const-generic-args, r=lcnr\n\nResolve lifetimes for const generic defaults\n\nWe weren't visiting the const generic default argument in `rustc_resolve::late::lifetimes`. This seems to fix the issue, and we deny any non-`'static` lifetimes anyways.\n\nFixes #93647\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbf4b4664068e255fac92f898b9a0e046680dd08", "html_url": "https://github.com/rust-lang/rust/commit/cbf4b4664068e255fac92f898b9a0e046680dd08", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbf4b4664068e255fac92f898b9a0e046680dd08/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b7287e9e4f2541635ed09412c823d9711014e1c8", "url": "https://api.github.com/repos/rust-lang/rust/commits/b7287e9e4f2541635ed09412c823d9711014e1c8", "html_url": "https://github.com/rust-lang/rust/commit/b7287e9e4f2541635ed09412c823d9711014e1c8"}, {"sha": "bcf98841d47b23dfc4cc85568fcd8dbb79748965", "url": "https://api.github.com/repos/rust-lang/rust/commits/bcf98841d47b23dfc4cc85568fcd8dbb79748965", "html_url": "https://github.com/rust-lang/rust/commit/bcf98841d47b23dfc4cc85568fcd8dbb79748965"}], "stats": {"total": 41, "additions": 40, "deletions": 1}, "files": [{"sha": "f3d57139e08174bb315eb29077326172b17a08ef", "filename": "compiler/rustc_resolve/src/late/lifetimes.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cbf4b4664068e255fac92f898b9a0e046680dd08/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf4b4664068e255fac92f898b9a0e046680dd08/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs?ref=cbf4b4664068e255fac92f898b9a0e046680dd08", "patch": "@@ -1339,11 +1339,14 @@ impl<'a, 'tcx> Visitor<'tcx> for LifetimeContext<'a, 'tcx> {\n                             this.visit_ty(&ty);\n                         }\n                     }\n-                    GenericParamKind::Const { ref ty, .. } => {\n+                    GenericParamKind::Const { ref ty, default } => {\n                         let was_in_const_generic = this.is_in_const_generic;\n                         this.is_in_const_generic = true;\n                         walk_list!(this, visit_param_bound, param.bounds);\n                         this.visit_ty(&ty);\n+                        if let Some(default) = default {\n+                            this.visit_body(this.tcx.hir().body(default.body));\n+                        }\n                         this.is_in_const_generic = was_in_const_generic;\n                     }\n                 }"}, {"sha": "6a8fe64d1875dd5be7bb8ff22dcf41e6d3be401c", "filename": "src/test/ui/const-generics/issue-93647.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fissue-93647.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fissue-93647.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fissue-93647.rs?ref=cbf4b4664068e255fac92f898b9a0e046680dd08", "patch": "@@ -0,0 +1,6 @@\n+struct X<const N: usize = {\n+    (||1usize)()\n+    //~^ ERROR calls in constants are limited to\n+}>;\n+\n+fn main() {}"}, {"sha": "0fe54e7de41f086ef1846675a953b291236b791b", "filename": "src/test/ui/const-generics/issue-93647.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fissue-93647.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fissue-93647.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fissue-93647.stderr?ref=cbf4b4664068e255fac92f898b9a0e046680dd08", "patch": "@@ -0,0 +1,9 @@\n+error[E0015]: calls in constants are limited to constant functions, tuple structs and tuple variants\n+  --> $DIR/issue-93647.rs:2:5\n+   |\n+LL |     (||1usize)()\n+   |     ^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0015`."}, {"sha": "3018439afa7170e39bfccecd96d0698a7b0eb29d", "filename": "src/test/ui/const-generics/outer-lifetime-in-const-generic-default.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fouter-lifetime-in-const-generic-default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fouter-lifetime-in-const-generic-default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fouter-lifetime-in-const-generic-default.rs?ref=cbf4b4664068e255fac92f898b9a0e046680dd08", "patch": "@@ -0,0 +1,10 @@\n+struct Foo<\n+    'a,\n+    const N: usize = {\n+        let x: &'a ();\n+        //~^ ERROR use of non-static lifetime `'a` in const generic\n+        3\n+    },\n+>(&'a ());\n+\n+fn main() {}"}, {"sha": "9d9555d3f647f396c89ecd3c16610dbadf6d219e", "filename": "src/test/ui/const-generics/outer-lifetime-in-const-generic-default.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fouter-lifetime-in-const-generic-default.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cbf4b4664068e255fac92f898b9a0e046680dd08/src%2Ftest%2Fui%2Fconst-generics%2Fouter-lifetime-in-const-generic-default.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fouter-lifetime-in-const-generic-default.stderr?ref=cbf4b4664068e255fac92f898b9a0e046680dd08", "patch": "@@ -0,0 +1,11 @@\n+error[E0771]: use of non-static lifetime `'a` in const generic\n+  --> $DIR/outer-lifetime-in-const-generic-default.rs:4:17\n+   |\n+LL |         let x: &'a ();\n+   |                 ^^\n+   |\n+   = note: for more information, see issue #74052 <https://github.com/rust-lang/rust/issues/74052>\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0771`."}]}