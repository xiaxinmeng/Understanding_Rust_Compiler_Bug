{"sha": "b0ed808266e346b0f9330822f874e930710df4ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIwZWQ4MDgyNjZlMzQ2YjBmOTMzMDgyMmY4NzRlOTMwNzEwZGY0ZWM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-13T09:18:47Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-13T09:18:47Z"}, "message": "Merge #3553\n\n3553: Completions do not show for function with same name as mod r=matklad a=JoshMcguigan\n\nfixes #3444 \r\n\r\nI've added a test case in `crates/ra_ide/src/completion/complete_path.rs` which verifies the described behavior in #3444. Digging in, I found that [the module scope iterator](https://github.com/JoshMcguigan/rust-analyzer/blob/ba62d8bd1ce8a68b8d21aaf89ae1ea6787f18366/crates/ra_ide/src/completion/complete_path.rs#L22) only provides the module `z`, and does not provide the function `z` (although if I name the function something else then it does show up here). \r\n\r\nI thought perhaps the name wasn't being properly resolved, but I added a test in `crates/ra_hir_def/src/nameres/tests.rs` which seems to suggest that it is? I've tried to figure out how to bridge the gap between these two tests (one passing, one failing) to see where the function `z` is being dropped, but to this point I haven't been able to track it down.\r\n\r\nAny pointers on where I might look for this? \n\nCo-authored-by: Josh Mcguigan <joshmcg88@gmail.com>", "tree": {"sha": "5fec1ee6c1af3e3763c3a694a34789e856fc9d13", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5fec1ee6c1af3e3763c3a694a34789e856fc9d13"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b0ed808266e346b0f9330822f874e930710df4ec", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJea0/3CRBK7hj4Ov3rIwAAdHIIAJnbPuBdkbmL47nWbpvXp36G\nbivUtbZGoy1ABtnMWiPOb2SgZxslba0Gtm59m+eRqCg+AVO2i/gGOC2ZeQHkXDna\ne6Akci/2723PLAB2zQeIXgJ9rfzvQsD04Zi5jRL8oXjvBfgcHS5FpiZUEwwfWpC7\nbK4SNE47ylpgGLrDBjQto+QRKb3csuhIIqFZfenSwiJwISscDFCPAcVD3JADmcEM\nI3GAGPyF1h3EW9uY30DL8DnKq0Qcl/ZAdbdGXXGQiCgYHVQBQXMKOuUX2CRXyJFS\n5LB2dGsJ5/hl0N84cQvzD77gB6KhrpiQnO/kH3+ZBBPU3CxFvKBCLY+sJCNwUrM=\n=WqoQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 5fec1ee6c1af3e3763c3a694a34789e856fc9d13\nparent 56590097ed71374902f1e1c44cde487db4e3ab4f\nparent 7208498d54b9f3d386b58f901c911a35170057ce\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1584091127 +0000\ncommitter GitHub <noreply@github.com> 1584091127 +0000\n\nMerge #3553\n\n3553: Completions do not show for function with same name as mod r=matklad a=JoshMcguigan\n\nfixes #3444 \r\n\r\nI've added a test case in `crates/ra_ide/src/completion/complete_path.rs` which verifies the described behavior in #3444. Digging in, I found that [the module scope iterator](https://github.com/JoshMcguigan/rust-analyzer/blob/ba62d8bd1ce8a68b8d21aaf89ae1ea6787f18366/crates/ra_ide/src/completion/complete_path.rs#L22) only provides the module `z`, and does not provide the function `z` (although if I name the function something else then it does show up here). \r\n\r\nI thought perhaps the name wasn't being properly resolved, but I added a test in `crates/ra_hir_def/src/nameres/tests.rs` which seems to suggest that it is? I've tried to figure out how to bridge the gap between these two tests (one passing, one failing) to see where the function `z` is being dropped, but to this point I haven't been able to track it down.\r\n\r\nAny pointers on where I might look for this? \n\nCo-authored-by: Josh Mcguigan <joshmcg88@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b0ed808266e346b0f9330822f874e930710df4ec", "html_url": "https://github.com/rust-lang/rust/commit/b0ed808266e346b0f9330822f874e930710df4ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b0ed808266e346b0f9330822f874e930710df4ec/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "56590097ed71374902f1e1c44cde487db4e3ab4f", "url": "https://api.github.com/repos/rust-lang/rust/commits/56590097ed71374902f1e1c44cde487db4e3ab4f", "html_url": "https://github.com/rust-lang/rust/commit/56590097ed71374902f1e1c44cde487db4e3ab4f"}, {"sha": "7208498d54b9f3d386b58f901c911a35170057ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/7208498d54b9f3d386b58f901c911a35170057ce", "html_url": "https://github.com/rust-lang/rust/commit/7208498d54b9f3d386b58f901c911a35170057ce"}], "stats": {"total": 119, "additions": 108, "deletions": 11}, "files": [{"sha": "f3707f11625d1cbf578b0a5895dfe4b642c1c5da", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b0ed808266e346b0f9330822f874e930710df4ec/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/b0ed808266e346b0f9330822f874e930710df4ec/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=b0ed808266e346b0f9330822f874e930710df4ec", "patch": "@@ -940,6 +940,7 @@ dependencies = [\n name = \"ra_hir\"\n version = \"0.1.0\"\n dependencies = [\n+ \"arrayvec\",\n  \"either\",\n  \"itertools\",\n  \"log\","}, {"sha": "42193b492954275c9609c3a0f19b27f078da42b4", "filename": "crates/ra_hir/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2FCargo.toml?ref=b0ed808266e346b0f9330822f874e930710df4ec", "patch": "@@ -11,6 +11,7 @@ doctest = false\n log = \"0.4.8\"\n rustc-hash = \"1.1.0\"\n either = \"1.5.3\"\n+arrayvec = \"0.5.1\"\n \n itertools = \"0.8.2\"\n "}, {"sha": "9e2fa03f886f07d47ea7d3b0d2233619386db48c", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 38, "deletions": 10, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=b0ed808266e346b0f9330822f874e930710df4ec", "patch": "@@ -1,6 +1,7 @@\n //! FIXME: write short doc here\n use std::sync::Arc;\n \n+use arrayvec::ArrayVec;\n use either::Either;\n use hir_def::{\n     adt::StructKind,\n@@ -226,7 +227,11 @@ impl Module {\n                     Some((name, def))\n                 }\n             })\n-            .map(|(name, def)| (name.clone(), def.into()))\n+            .flat_map(|(name, def)|\n+                ScopeDef::all_items(def)\n+                    .into_iter()\n+                    .map(move |item| (name.clone(), item))\n+            )\n             .collect()\n     }\n \n@@ -1288,15 +1293,38 @@ pub enum ScopeDef {\n     Unknown,\n }\n \n-impl From<PerNs> for ScopeDef {\n-    fn from(def: PerNs) -> Self {\n-        def.take_types()\n-            .or_else(|| def.take_values())\n-            .map(|module_def_id| ScopeDef::ModuleDef(module_def_id.into()))\n-            .or_else(|| {\n-                def.take_macros().map(|macro_def_id| ScopeDef::MacroDef(macro_def_id.into()))\n-            })\n-            .unwrap_or(ScopeDef::Unknown)\n+impl ScopeDef {\n+    pub fn all_items(def: PerNs) -> ArrayVec<[Self; 3]> {\n+        let mut items = ArrayVec::new();\n+\n+        match (def.take_types(), def.take_values()) {\n+            (Some(m1), None) => \n+                items.push(ScopeDef::ModuleDef(m1.into())),\n+            (None, Some(m2)) =>\n+                items.push(ScopeDef::ModuleDef(m2.into())),\n+            (Some(m1), Some(m2)) => {\n+                // Some items, like unit structs and enum variants, are\n+                // returned as both a type and a value. Here we want\n+                // to de-duplicate them.\n+                if m1 != m2 {\n+                    items.push(ScopeDef::ModuleDef(m1.into()));\n+                    items.push(ScopeDef::ModuleDef(m2.into()));\n+                } else {\n+                    items.push(ScopeDef::ModuleDef(m1.into()));\n+                }\n+            },\n+            (None, None) => {},\n+        };\n+\n+        if let Some(macro_def_id) = def.take_macros() {\n+            items.push(ScopeDef::MacroDef(macro_def_id.into()));\n+        }\n+\n+        if items.is_empty() {\n+            items.push(ScopeDef::Unknown);\n+        }\n+\n+        items\n     }\n }\n "}, {"sha": "e83eb1fdc20f5633d8f9b86f6b106e08df3259c8", "filename": "crates/ra_hir/src/semantics.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsemantics.rs?ref=b0ed808266e346b0f9330822f874e930710df4ec", "patch": "@@ -344,7 +344,13 @@ impl<'a, DB: HirDatabase> SemanticsScope<'a, DB> {\n \n         resolver.process_all_names(self.db, &mut |name, def| {\n             let def = match def {\n-                resolver::ScopeDef::PerNs(it) => it.into(),\n+                resolver::ScopeDef::PerNs(it) => {\n+                    let items = ScopeDef::all_items(it);\n+                    for item in items {\n+                        f(name.clone(), item);\n+                    }\n+                    return\n+                },\n                 resolver::ScopeDef::ImplSelfType(it) => ScopeDef::ImplSelfType(it.into()),\n                 resolver::ScopeDef::AdtSelfType(it) => ScopeDef::AdtSelfType(it.into()),\n                 resolver::ScopeDef::GenericParam(id) => ScopeDef::GenericParam(TypeParam { id }),"}, {"sha": "3f33a75b9a9a76301181fbb9c4a4c1037239878e", "filename": "crates/ra_hir_def/src/nameres/tests.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Ftests.rs?ref=b0ed808266e346b0f9330822f874e930710df4ec", "patch": "@@ -101,6 +101,28 @@ fn crate_def_map_super_super() {\n     \"###)\n }\n \n+#[test]\n+fn crate_def_map_fn_mod_same_name() {\n+    let map = def_map(\n+        \"\n+        //- /lib.rs\n+        mod m {\n+            pub mod z {}\n+            pub fn z() {}\n+        }\n+        \",\n+    );\n+    assert_snapshot!(map, @r###\"\n+        \u22eecrate\n+        \u22eem: t\n+        \u22ee\n+        \u22eecrate::m\n+        \u22eez: t v\n+        \u22ee\n+        \u22eecrate::m::z\n+    \"###)\n+}\n+\n #[test]\n fn bogus_paths() {\n     covers!(bogus_paths);"}, {"sha": "648c1d39b2b3043496151b9e046dc2ee40b112f5", "filename": "crates/ra_ide/src/completion/complete_path.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0ed808266e346b0f9330822f874e930710df4ec/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_path.rs?ref=b0ed808266e346b0f9330822f874e930710df4ec", "patch": "@@ -967,4 +967,43 @@ mod tests {\n         ]\n         \"###);\n     }\n+\n+    #[test]\n+    fn function_mod_share_name() {\n+        assert_debug_snapshot!(\n+        do_reference_completion(\n+                r\"\n+                fn foo() {\n+                    self::m::<|>\n+                }\n+\n+                mod m {\n+                    pub mod z {}\n+                    pub fn z() {}\n+                }\n+                \",\n+        ),\n+            @r###\"\n+        [\n+            CompletionItem {\n+                label: \"z\",\n+                source_range: [57; 57),\n+                delete: [57; 57),\n+                insert: \"z\",\n+                kind: Module,\n+            },\n+            CompletionItem {\n+                label: \"z()\",\n+                source_range: [57; 57),\n+                delete: [57; 57),\n+                insert: \"z()$0\",\n+                kind: Function,\n+                lookup: \"z\",\n+                detail: \"pub fn z()\",\n+            },\n+        ]\n+        \"###\n+        );\n+    }\n+\n }"}]}