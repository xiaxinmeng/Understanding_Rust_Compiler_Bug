{"sha": "6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "node_id": "C_kwDOAAsO6NoAKDZiNWY2M2MzZmM0Y2M1YmNhYWY1Y2FkNjBlMmNjN2U1NmRmMzQ4N2Y", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-12-14T17:58:01Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-12-17T12:46:47Z"}, "message": "Constify (most) `Option` methods", "tree": {"sha": "4936460deb12354e669311c50e929f35166add54", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4936460deb12354e669311c50e929f35166add54"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE3RQPHNISvvEnSKtjbQF6ltjmwvkFAmG8hrcACgkQbQF6ltjm\nwvnlGQ//W2SUJXAk1PmHeleMATua42+gG10G1EAIIdJp15Nwr2OvDnDB9Wk8+fKV\n/EvyYdXF2Wu7THbfm6Fv3qJm2jIrc++wyz+XWnTxxm1mJhYlw7zT/HHDtPvhFoCs\n3aFOw+oaMEjW7IM3K3Ke5TeIlt4JMCpgtOGgXZpAtRyHrrcE5UP0FDRnFyHnE9/T\ne4FfTE7tqEHFSKoZbbZBDs/LCbOmM9VykNP2x9d+Ogx7cScMN8N+hLvnHWFyHkfh\nU7x9P6n5/qHB7Gr7m9PlAG488+hp/cxNjwuC1vGKGR8HduD9DPXk+Hb/zbMTkLxI\n9Mbwm0d8+D7v1uEa3mkVbWzv9HviPic60OR/xSh4/e8IhdFYvDafkug2+fQTs9W2\n9qw8igtvrQ/uYhDftFVkGaiDQS/N1JMBjm/Rv5DqrsNSqaRUDHtsg7Ecn6gczwMH\ntDQNELnAOFLp5kK0vVe8qQMirUnQe7AkvDzF20QtmKICMKbLdvd1l/Jm0UBRfkBO\nLxCmI72S79hgDu5dhTt0c/vkMqm/aLXhAPbniJJQg2osfPY0wpmzfNE6IEfe4UWi\n47FvDDssDEq9uYtR31bWKMi6itCpEJ7sgemagYYUYtlsfWn1SUJNn8Ij7bx5SNYZ\n6zfTRQwqzxIX5TLHY//nONRLL+aYjDzMXh6lFEfvnV27RLFvuSE=\n=Jtph\n-----END PGP SIGNATURE-----", "payload": "tree 4936460deb12354e669311c50e929f35166add54\nparent 9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53\nauthor Deadbeef <ent3rm4n@gmail.com> 1639504681 +0800\ncommitter Deadbeef <ent3rm4n@gmail.com> 1639745207 +0800\n\nConstify (most) `Option` methods\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "html_url": "https://github.com/rust-lang/rust/commit/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53", "html_url": "https://github.com/rust-lang/rust/commit/9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53"}], "stats": {"total": 343, "additions": 282, "deletions": 61}, "files": [{"sha": "67f77f14a6e6bcb0382e7b5f68f347795226e8a9", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "patch": "@@ -123,6 +123,7 @@\n #![feature(const_num_from_num)]\n #![feature(const_ops)]\n #![feature(const_option)]\n+#![feature(const_option_ext)]\n #![feature(const_pin)]\n #![feature(const_replace)]\n #![feature(const_ptr_is_null)]"}, {"sha": "5e375d27bddb7a7cd640d291effba5d796fb0b20", "filename": "library/core/src/option.rs", "status": "modified", "additions": 191, "deletions": 51, "changes": 242, "blob_url": "https://github.com/rust-lang/rust/blob/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Fsrc%2Foption.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Fsrc%2Foption.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Foption.rs?ref=6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "patch": "@@ -589,12 +589,13 @@ impl<T> Option<T> {\n     #[must_use]\n     #[inline]\n     #[unstable(feature = \"option_result_contains\", issue = \"62358\")]\n-    pub fn contains<U>(&self, x: &U) -> bool\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn contains<U>(&self, x: &U) -> bool\n     where\n-        U: PartialEq<T>,\n+        U: ~const PartialEq<T>,\n     {\n         match self {\n-            Some(y) => x == y,\n+            Some(y) => x.eq(y),\n             None => false,\n         }\n     }\n@@ -660,10 +661,14 @@ impl<T> Option<T> {\n     #[inline]\n     #[must_use]\n     #[stable(feature = \"pin\", since = \"1.33.0\")]\n-    pub fn as_pin_ref(self: Pin<&Self>) -> Option<Pin<&T>> {\n-        // SAFETY: `x` is guaranteed to be pinned because it comes from `self`\n-        // which is pinned.\n-        unsafe { Pin::get_ref(self).as_ref().map(|x| Pin::new_unchecked(x)) }\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn as_pin_ref(self: Pin<&Self>) -> Option<Pin<&T>> {\n+        match Pin::get_ref(self).as_ref() {\n+            // SAFETY: `x` is guaranteed to be pinned because it comes from `self`\n+            // which is pinned.\n+            Some(x) => unsafe { Some(Pin::new_unchecked(x)) },\n+            None => None,\n+        }\n     }\n \n     /// Converts from <code>[Pin]<[&mut] Option\\<T>></code> to <code>Option<[Pin]<[&mut] T>></code>.\n@@ -672,10 +677,16 @@ impl<T> Option<T> {\n     #[inline]\n     #[must_use]\n     #[stable(feature = \"pin\", since = \"1.33.0\")]\n-    pub fn as_pin_mut(self: Pin<&mut Self>) -> Option<Pin<&mut T>> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn as_pin_mut(self: Pin<&mut Self>) -> Option<Pin<&mut T>> {\n         // SAFETY: `get_unchecked_mut` is never used to move the `Option` inside `self`.\n         // `x` is guaranteed to be pinned because it comes from `self` which is pinned.\n-        unsafe { Pin::get_unchecked_mut(self).as_mut().map(|x| Pin::new_unchecked(x)) }\n+        unsafe {\n+            match Pin::get_unchecked_mut(self).as_mut() {\n+                Some(x) => Some(Pin::new_unchecked(x)),\n+                None => None,\n+            }\n+        }\n     }\n \n     /////////////////////////////////////////////////////////////////////////\n@@ -764,7 +775,11 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn unwrap_or(self, default: T) -> T {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn unwrap_or(self, default: T) -> T\n+    where\n+        T: ~const Drop,\n+    {\n         match self {\n             Some(x) => x,\n             None => default,\n@@ -782,7 +797,12 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn unwrap_or_else<F: FnOnce() -> T>(self, f: F) -> T {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn unwrap_or_else<F>(self, f: F) -> T\n+    where\n+        F: ~const FnOnce() -> T,\n+        F: ~const Drop,\n+    {\n         match self {\n             Some(x) => x,\n             None => f(),\n@@ -812,7 +832,8 @@ impl<T> Option<T> {\n     #[inline]\n     #[track_caller]\n     #[stable(feature = \"option_result_unwrap_unchecked\", since = \"1.58.0\")]\n-    pub unsafe fn unwrap_unchecked(self) -> T {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const unsafe fn unwrap_unchecked(self) -> T {\n         debug_assert!(self.is_some());\n         match self {\n             Some(val) => val,\n@@ -842,7 +863,12 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn map<U, F: FnOnce(T) -> U>(self, f: F) -> Option<U> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn map<U, F>(self, f: F) -> Option<U>\n+    where\n+        F: ~const FnOnce(T) -> U,\n+        F: ~const Drop,\n+    {\n         match self {\n             Some(x) => Some(f(x)),\n             None => None,\n@@ -866,7 +892,12 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"result_option_inspect\", issue = \"91345\")]\n-    pub fn inspect<F: FnOnce(&T)>(self, f: F) -> Self {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn inspect<F>(self, f: F) -> Self\n+    where\n+        F: ~const FnOnce(&T),\n+        F: ~const Drop,\n+    {\n         if let Some(ref x) = self {\n             f(x);\n         }\n@@ -894,7 +925,13 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn map_or<U, F: FnOnce(T) -> U>(self, default: U, f: F) -> U {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn map_or<U, F>(self, default: U, f: F) -> U\n+    where\n+        F: ~const FnOnce(T) -> U,\n+        F: ~const Drop,\n+        U: ~const Drop,\n+    {\n         match self {\n             Some(t) => f(t),\n             None => default,\n@@ -917,7 +954,14 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn map_or_else<U, D: FnOnce() -> U, F: FnOnce(T) -> U>(self, default: D, f: F) -> U {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn map_or_else<U, D, F>(self, default: D, f: F) -> U\n+    where\n+        D: ~const FnOnce() -> U,\n+        D: ~const Drop,\n+        F: ~const FnOnce(T) -> U,\n+        F: ~const Drop,\n+    {\n         match self {\n             Some(t) => f(t),\n             None => default(),\n@@ -947,7 +991,11 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn ok_or<E>(self, err: E) -> Result<T, E> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn ok_or<E>(self, err: E) -> Result<T, E>\n+    where\n+        E: ~const Drop,\n+    {\n         match self {\n             Some(v) => Ok(v),\n             None => Err(err),\n@@ -972,7 +1020,12 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn ok_or_else<E, F: FnOnce() -> E>(self, err: F) -> Result<T, E> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn ok_or_else<E, F>(self, err: F) -> Result<T, E>\n+    where\n+        F: ~const FnOnce() -> E,\n+        F: ~const Drop,\n+    {\n         match self {\n             Some(v) => Ok(v),\n             None => Err(err()),\n@@ -1049,7 +1102,12 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn and<U>(self, optb: Option<U>) -> Option<U> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn and<U>(self, optb: Option<U>) -> Option<U>\n+    where\n+        T: ~const Drop,\n+        U: ~const Drop,\n+    {\n         match self {\n             Some(_) => optb,\n             None => None,\n@@ -1074,7 +1132,12 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn and_then<U, F: FnOnce(T) -> Option<U>>(self, f: F) -> Option<U> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn and_then<U, F>(self, f: F) -> Option<U>\n+    where\n+        F: ~const FnOnce(T) -> Option<U>,\n+        F: ~const Drop,\n+    {\n         match self {\n             Some(x) => f(x),\n             None => None,\n@@ -1107,7 +1170,13 @@ impl<T> Option<T> {\n     /// [`Some(t)`]: Some\n     #[inline]\n     #[stable(feature = \"option_filter\", since = \"1.27.0\")]\n-    pub fn filter<P: FnOnce(&T) -> bool>(self, predicate: P) -> Self {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn filter<P>(self, predicate: P) -> Self\n+    where\n+        T: ~const Drop,\n+        P: ~const FnOnce(&T) -> bool,\n+        P: ~const Drop,\n+    {\n         if let Some(x) = self {\n             if predicate(&x) {\n                 return Some(x);\n@@ -1145,9 +1214,13 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn or(self, optb: Option<T>) -> Option<T> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn or(self, optb: Option<T>) -> Option<T>\n+    where\n+        T: ~const Drop,\n+    {\n         match self {\n-            Some(_) => self,\n+            Some(x) => Some(x),\n             None => optb,\n         }\n     }\n@@ -1167,9 +1240,14 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn or_else<F: FnOnce() -> Option<T>>(self, f: F) -> Option<T> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn or_else<F>(self, f: F) -> Option<T>\n+    where\n+        F: ~const FnOnce() -> Option<T>,\n+        F: ~const Drop,\n+    {\n         match self {\n-            Some(_) => self,\n+            Some(x) => Some(x),\n             None => f(),\n         }\n     }\n@@ -1197,7 +1275,11 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"option_xor\", since = \"1.37.0\")]\n-    pub fn xor(self, optb: Option<T>) -> Option<T> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn xor(self, optb: Option<T>) -> Option<T>\n+    where\n+        T: ~const Drop,\n+    {\n         match (self, optb) {\n             (Some(a), None) => Some(a),\n             (None, Some(b)) => Some(b),\n@@ -1231,7 +1313,11 @@ impl<T> Option<T> {\n     #[must_use = \"if you intended to set a value, consider assignment instead\"]\n     #[inline]\n     #[stable(feature = \"option_insert\", since = \"1.53.0\")]\n-    pub fn insert(&mut self, value: T) -> &mut T {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn insert(&mut self, value: T) -> &mut T\n+    where\n+        T: ~const Drop,\n+    {\n         *self = Some(value);\n \n         // SAFETY: the code above just filled the option\n@@ -1260,8 +1346,18 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"option_entry\", since = \"1.20.0\")]\n-    pub fn get_or_insert(&mut self, value: T) -> &mut T {\n-        self.get_or_insert_with(|| value)\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn get_or_insert(&mut self, value: T) -> &mut T\n+    where\n+        T: ~const Drop,\n+    {\n+        if let None = *self {\n+            *self = Some(value);\n+        }\n+\n+        // SAFETY: a `None` variant for `self` would have been replaced by a `Some`\n+        // variant in the code above.\n+        unsafe { self.as_mut().unwrap_unchecked() }\n     }\n \n     /// Inserts the default value into the option if it is [`None`], then\n@@ -1285,11 +1381,17 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[unstable(feature = \"option_get_or_insert_default\", issue = \"82901\")]\n-    pub fn get_or_insert_default(&mut self) -> &mut T\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn get_or_insert_default(&mut self) -> &mut T\n     where\n-        T: Default,\n+        T: ~const Default,\n     {\n-        self.get_or_insert_with(Default::default)\n+        #[rustc_allow_const_fn_unstable(const_fn_trait_bound)]\n+        const fn default<T: ~const Default>() -> T {\n+            T::default()\n+        }\n+\n+        self.get_or_insert_with(default)\n     }\n \n     /// Inserts a value computed from `f` into the option if it is [`None`],\n@@ -1311,17 +1413,21 @@ impl<T> Option<T> {\n     /// ```\n     #[inline]\n     #[stable(feature = \"option_entry\", since = \"1.20.0\")]\n-    pub fn get_or_insert_with<F: FnOnce() -> T>(&mut self, f: F) -> &mut T {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn get_or_insert_with<F>(&mut self, f: F) -> &mut T\n+    where\n+        F: ~const FnOnce() -> T,\n+        F: ~const Drop,\n+    {\n         if let None = *self {\n-            *self = Some(f());\n+            // the compiler isn't smart enough to know that we are not dropping a `T`\n+            // here and wants us to ensure `T` can be dropped at compile time.\n+            mem::forget(mem::replace(self, Some(f())))\n         }\n \n-        match self {\n-            Some(v) => v,\n-            // SAFETY: a `None` variant for `self` would have been replaced by a `Some`\n-            // variant in the code above.\n-            None => unsafe { hint::unreachable_unchecked() },\n-        }\n+        // SAFETY: a `None` variant for `self` would have been replaced by a `Some`\n+        // variant in the code above.\n+        unsafe { self.as_mut().unwrap_unchecked() }\n     }\n \n     /////////////////////////////////////////////////////////////////////////\n@@ -1391,7 +1497,12 @@ impl<T> Option<T> {\n     /// assert_eq!(x.zip(z), None);\n     /// ```\n     #[stable(feature = \"option_zip_option\", since = \"1.46.0\")]\n-    pub fn zip<U>(self, other: Option<U>) -> Option<(T, U)> {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn zip<U>(self, other: Option<U>) -> Option<(T, U)>\n+    where\n+        T: ~const Drop,\n+        U: ~const Drop,\n+    {\n         match (self, other) {\n             (Some(a), Some(b)) => Some((a, b)),\n             _ => None,\n@@ -1427,11 +1538,18 @@ impl<T> Option<T> {\n     /// assert_eq!(x.zip_with(None, Point::new), None);\n     /// ```\n     #[unstable(feature = \"option_zip\", issue = \"70086\")]\n-    pub fn zip_with<U, F, R>(self, other: Option<U>, f: F) -> Option<R>\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn zip_with<U, F, R>(self, other: Option<U>, f: F) -> Option<R>\n     where\n-        F: FnOnce(T, U) -> R,\n+        F: ~const FnOnce(T, U) -> R,\n+        F: ~const Drop,\n+        T: ~const Drop,\n+        U: ~const Drop,\n     {\n-        Some(f(self?, other?))\n+        match (self, other) {\n+            (Some(a), Some(b)) => Some(f(a, b)),\n+            _ => None,\n+        }\n     }\n }\n \n@@ -1503,8 +1621,12 @@ impl<T: Copy> Option<&mut T> {\n     /// ```\n     #[must_use = \"`self` will be dropped if the result is not used\"]\n     #[stable(feature = \"copied\", since = \"1.35.0\")]\n-    pub fn copied(self) -> Option<T> {\n-        self.map(|&mut t| t)\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn copied(self) -> Option<T> {\n+        match self {\n+            Some(&mut t) => Some(t),\n+            None => None,\n+        }\n     }\n }\n \n@@ -1591,7 +1713,11 @@ impl<T: Default> Option<T> {\n     /// [`FromStr`]: crate::str::FromStr\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn unwrap_or_default(self) -> T {\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn unwrap_or_default(self) -> T\n+    where\n+        T: ~const Default,\n+    {\n         match self {\n             Some(x) => x,\n             None => Default::default(),\n@@ -1615,8 +1741,15 @@ impl<T: Deref> Option<T> {\n     /// assert_eq!(x.as_deref(), None);\n     /// ```\n     #[stable(feature = \"option_deref\", since = \"1.40.0\")]\n-    pub fn as_deref(&self) -> Option<&T::Target> {\n-        self.as_ref().map(|t| t.deref())\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn as_deref(&self) -> Option<&T::Target>\n+    where\n+        T: ~const Deref,\n+    {\n+        match self.as_ref() {\n+            Some(t) => Some(t.deref()),\n+            None => None,\n+        }\n     }\n }\n \n@@ -1636,8 +1769,15 @@ impl<T: DerefMut> Option<T> {\n     /// }), Some(\"HEY\".to_owned().as_mut_str()));\n     /// ```\n     #[stable(feature = \"option_deref\", since = \"1.40.0\")]\n-    pub fn as_deref_mut(&mut self) -> Option<&mut T::Target> {\n-        self.as_mut().map(|t| t.deref_mut())\n+    #[rustc_const_unstable(feature = \"const_option_ext\", issue = \"none\")]\n+    pub const fn as_deref_mut(&mut self) -> Option<&mut T::Target>\n+    where\n+        T: ~const DerefMut,\n+    {\n+        match self.as_mut() {\n+            Some(t) => Some(t.deref_mut()),\n+            None => None,\n+        }\n     }\n }\n "}, {"sha": "21562acf3d766cad63cc648c08f0f907ad34e4c7", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "patch": "@@ -70,8 +70,10 @@\n #![feature(portable_simd)]\n #![feature(ptr_metadata)]\n #![feature(once_cell)]\n+#![feature(option_result_contains)]\n #![feature(unsized_tuple_coercion)]\n #![feature(const_option)]\n+#![feature(const_option_ext)]\n #![feature(const_result)]\n #![feature(integer_atomics)]\n #![feature(int_roundings)]"}, {"sha": "da692461261fcc6cf44941729e87abe33cceb628", "filename": "library/core/tests/option.rs", "status": "modified", "additions": 88, "deletions": 10, "changes": 98, "blob_url": "https://github.com/rust-lang/rust/blob/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Ftests%2Foption.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f/library%2Fcore%2Ftests%2Foption.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Foption.rs?ref=6b5f63c3fc4cc5bcaaf5cad60e2cc7e56df3487f", "patch": "@@ -86,17 +86,49 @@ fn test_and() {\n     let x: Option<isize> = None;\n     assert_eq!(x.and(Some(2)), None);\n     assert_eq!(x.and(None::<isize>), None);\n+\n+    const FOO: Option<isize> = Some(1);\n+    const A: Option<isize> = FOO.and(Some(2));\n+    const B: Option<isize> = FOO.and(None);\n+    assert_eq!(A, Some(2));\n+    assert_eq!(B, None);\n+\n+    const BAR: Option<isize> = None;\n+    const C: Option<isize> = BAR.and(Some(2));\n+    const D: Option<isize> = BAR.and(None);\n+    assert_eq!(C, None);\n+    assert_eq!(D, None);\n }\n \n #[test]\n fn test_and_then() {\n+    const fn plus_one(x: isize) -> Option<isize> {\n+        Some(x + 1)\n+    }\n+\n+    const fn none(_: isize) -> Option<isize> {\n+        None\n+    }\n+\n     let x: Option<isize> = Some(1);\n-    assert_eq!(x.and_then(|x| Some(x + 1)), Some(2));\n-    assert_eq!(x.and_then(|_| None::<isize>), None);\n+    assert_eq!(x.and_then(plus_one), Some(2));\n+    assert_eq!(x.and_then(none), None);\n \n     let x: Option<isize> = None;\n-    assert_eq!(x.and_then(|x| Some(x + 1)), None);\n-    assert_eq!(x.and_then(|_| None::<isize>), None);\n+    assert_eq!(x.and_then(plus_one), None);\n+    assert_eq!(x.and_then(none), None);\n+\n+    const FOO: Option<isize> = Some(1);\n+    const A: Option<isize> = FOO.and_then(plus_one);\n+    const B: Option<isize> = FOO.and_then(none);\n+    assert_eq!(A, Some(2));\n+    assert_eq!(B, None);\n+\n+    const BAR: Option<isize> = None;\n+    const C: Option<isize> = BAR.and_then(plus_one);\n+    const D: Option<isize> = BAR.and_then(none);\n+    assert_eq!(C, None);\n+    assert_eq!(D, None);\n }\n \n #[test]\n@@ -108,17 +140,49 @@ fn test_or() {\n     let x: Option<isize> = None;\n     assert_eq!(x.or(Some(2)), Some(2));\n     assert_eq!(x.or(None), None);\n+\n+    const FOO: Option<isize> = Some(1);\n+    const A: Option<isize> = FOO.or(Some(2));\n+    const B: Option<isize> = FOO.or(None);\n+    assert_eq!(A, Some(1));\n+    assert_eq!(B, Some(1));\n+\n+    const BAR: Option<isize> = None;\n+    const C: Option<isize> = BAR.or(Some(2));\n+    const D: Option<isize> = BAR.or(None);\n+    assert_eq!(C, Some(2));\n+    assert_eq!(D, None);\n }\n \n #[test]\n fn test_or_else() {\n+    const fn two() -> Option<isize> {\n+        Some(2)\n+    }\n+\n+    const fn none() -> Option<isize> {\n+        None\n+    }\n+\n     let x: Option<isize> = Some(1);\n-    assert_eq!(x.or_else(|| Some(2)), Some(1));\n-    assert_eq!(x.or_else(|| None), Some(1));\n+    assert_eq!(x.or_else(two), Some(1));\n+    assert_eq!(x.or_else(none), Some(1));\n \n     let x: Option<isize> = None;\n-    assert_eq!(x.or_else(|| Some(2)), Some(2));\n-    assert_eq!(x.or_else(|| None), None);\n+    assert_eq!(x.or_else(two), Some(2));\n+    assert_eq!(x.or_else(none), None);\n+\n+    const FOO: Option<isize> = Some(1);\n+    const A: Option<isize> = FOO.or_else(two);\n+    const B: Option<isize> = FOO.or_else(none);\n+    assert_eq!(A, Some(1));\n+    assert_eq!(B, Some(1));\n+\n+    const BAR: Option<isize> = None;\n+    const C: Option<isize> = BAR.or_else(two);\n+    const D: Option<isize> = BAR.or_else(none);\n+    assert_eq!(C, Some(2));\n+    assert_eq!(D, None);\n }\n \n #[test]\n@@ -149,15 +213,29 @@ fn test_unwrap_or() {\n \n     let x: Option<isize> = None;\n     assert_eq!(x.unwrap_or(2), 2);\n+\n+    const A: isize = Some(1).unwrap_or(2);\n+    const B: isize = None.unwrap_or(2);\n+    assert_eq!(A, 1);\n+    assert_eq!(B, 2);\n }\n \n #[test]\n fn test_unwrap_or_else() {\n+    const fn two() -> isize {\n+        2\n+    }\n+\n     let x: Option<isize> = Some(1);\n-    assert_eq!(x.unwrap_or_else(|| 2), 1);\n+    assert_eq!(x.unwrap_or_else(two), 1);\n \n     let x: Option<isize> = None;\n-    assert_eq!(x.unwrap_or_else(|| 2), 2);\n+    assert_eq!(x.unwrap_or_else(two), 2);\n+\n+    const A: isize = Some(1).unwrap_or_else(two);\n+    const B: isize = None.unwrap_or_else(two);\n+    assert_eq!(A, 1);\n+    assert_eq!(B, 2);\n }\n \n #[test]"}]}