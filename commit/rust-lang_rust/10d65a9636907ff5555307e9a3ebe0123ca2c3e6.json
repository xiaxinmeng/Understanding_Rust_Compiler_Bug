{"sha": "10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "node_id": "C_kwDOAAsO6NoAKDEwZDY1YTk2MzY5MDdmZjU1NTUzMDdlOWEzZWJlMDEyM2NhMmMzZTY", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-11-05T14:58:14Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-11-09T16:41:51Z"}, "message": "Allow to run a specific rustdoc-js* test", "tree": {"sha": "d6f095661be4ecc23c11209d955d6a786247265d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d6f095661be4ecc23c11209d955d6a786247265d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "html_url": "https://github.com/rust-lang/rust/commit/10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "489ec310d2eadbdbdafc172fb09e9d598c01c93e", "url": "https://api.github.com/repos/rust-lang/rust/commits/489ec310d2eadbdbdafc172fb09e9d598c01c93e", "html_url": "https://github.com/rust-lang/rust/commit/489ec310d2eadbdbdafc172fb09e9d598c01c93e"}], "stats": {"total": 103, "additions": 64, "deletions": 39}, "files": [{"sha": "22bf6b8a9d4dce99392222a591a10154fb821e7d", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 20, "deletions": 33, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "patch": "@@ -763,7 +763,7 @@ impl Step for RustdocJSStd {\n     const ONLY_HOSTS: bool = true;\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n-        run.path(\"src/test/rustdoc-js-std\")\n+        run.suite_path(\"src/test/rustdoc-js-std\")\n     }\n \n     fn make_run(run: RunConfig<'_>) {\n@@ -783,6 +783,17 @@ impl Step for RustdocJSStd {\n                 .arg(builder.doc_out(self.target))\n                 .arg(\"--test-folder\")\n                 .arg(builder.src.join(\"src/test/rustdoc-js-std\"));\n+            for path in &builder.paths {\n+                if let Some(p) =\n+                    util::is_valid_test_suite_arg(path, \"src/test/rustdoc-js-std\", builder)\n+                {\n+                    if !p.ends_with(\".js\") {\n+                        eprintln!(\"A non-js file was given: `{}`\", path.display());\n+                        panic!(\"Cannot run rustdoc-js-std tests\");\n+                    }\n+                    command.arg(\"--test-file\").arg(path);\n+                }\n+            }\n             builder.ensure(crate::doc::Std { target: self.target, stage: builder.top_stage });\n             builder.run(&mut command);\n         } else {\n@@ -803,7 +814,7 @@ impl Step for RustdocJSNotStd {\n     const ONLY_HOSTS: bool = true;\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n-        run.path(\"src/test/rustdoc-js\")\n+        run.suite_path(\"src/test/rustdoc-js\")\n     }\n \n     fn make_run(run: RunConfig<'_>) {\n@@ -938,8 +949,12 @@ impl Step for RustdocGUI {\n             .arg(\"--tests-folder\")\n             .arg(builder.build.src.join(\"src/test/rustdoc-gui\"));\n         for path in &builder.paths {\n-            if let Some(name) = path.file_name().and_then(|f| f.to_str()) {\n-                if name.ends_with(\".goml\") {\n+            if let Some(p) = util::is_valid_test_suite_arg(path, \"src/test/rustdoc-gui\", builder) {\n+                if !p.ends_with(\".goml\") {\n+                    eprintln!(\"A non-goml file was given: `{}`\", path.display());\n+                    panic!(\"Cannot run rustdoc-gui tests\");\n+                }\n+                if let Some(name) = path.file_name().and_then(|f| f.to_str()) {\n                     command.arg(\"--file\").arg(name);\n                 }\n             }\n@@ -1416,35 +1431,7 @@ note: if you're sure you want to do this, please open an issue as to why. In the\n         // Get test-args by striping suite path\n         let mut test_args: Vec<&str> = paths\n             .iter()\n-            .map(|p| match p.strip_prefix(\".\") {\n-                Ok(path) => path,\n-                Err(_) => p,\n-            })\n-            .filter(|p| p.starts_with(suite_path))\n-            .filter(|p| {\n-                let exists = p.is_dir() || p.is_file();\n-                if !exists {\n-                    if let Some(p) = p.to_str() {\n-                        builder.info(&format!(\n-                            \"Warning: Skipping \\\"{}\\\": not a regular file or directory\",\n-                            p\n-                        ));\n-                    }\n-                }\n-                exists\n-            })\n-            .filter_map(|p| {\n-                // Since test suite paths are themselves directories, if we don't\n-                // specify a directory or file, we'll get an empty string here\n-                // (the result of the test suite directory without its suite prefix).\n-                // Therefore, we need to filter these out, as only the first --test-args\n-                // flag is respected, so providing an empty --test-args conflicts with\n-                // any following it.\n-                match p.strip_prefix(suite_path).ok().and_then(|p| p.to_str()) {\n-                    Some(s) if !s.is_empty() => Some(s),\n-                    _ => None,\n-                }\n-            })\n+            .filter_map(|p| util::is_valid_test_suite_arg(p, suite_path, builder))\n             .collect();\n \n         test_args.append(&mut builder.config.cmd.test_args());"}, {"sha": "57178aa382ffd789ac68a6fb9b9cf9051aceb7b8", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "patch": "@@ -310,3 +310,35 @@ pub fn use_host_linker(target: TargetSelection) -> bool {\n         || target.contains(\"fuchsia\")\n         || target.contains(\"bpf\"))\n }\n+\n+pub fn is_valid_test_suite_arg<'a, P: AsRef<Path>>(\n+    path: &'a Path,\n+    suite_path: P,\n+    builder: &Builder<'_>,\n+) -> Option<&'a str> {\n+    let suite_path = suite_path.as_ref();\n+    let path = match path.strip_prefix(\".\") {\n+        Ok(p) => p,\n+        Err(_) => path,\n+    };\n+    if !path.starts_with(suite_path) {\n+        return None;\n+    }\n+    let exists = path.is_dir() || path.is_file();\n+    if !exists {\n+        if let Some(p) = path.to_str() {\n+            builder.info(&format!(\"Warning: Skipping \\\"{}\\\": not a regular file or directory\", p));\n+        }\n+        return None;\n+    }\n+    // Since test suite paths are themselves directories, if we don't\n+    // specify a directory or file, we'll get an empty string here\n+    // (the result of the test suite directory without its suite prefix).\n+    // Therefore, we need to filter these out, as only the first --test-args\n+    // flag is respected, so providing an empty --test-args conflicts with\n+    // any following it.\n+    match path.strip_prefix(suite_path).ok().and_then(|p| p.to_str()) {\n+        Some(s) if !s.is_empty() => Some(s),\n+        _ => None,\n+    }\n+}"}, {"sha": "4f73a7f634098f2f7d6846e593a083c24877fcb4", "filename": "src/tools/rustdoc-js/tester.js", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/src%2Ftools%2Frustdoc-js%2Ftester.js", "raw_url": "https://github.com/rust-lang/rust/raw/10d65a9636907ff5555307e9a3ebe0123ca2c3e6/src%2Ftools%2Frustdoc-js%2Ftester.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustdoc-js%2Ftester.js?ref=10d65a9636907ff5555307e9a3ebe0123ca2c3e6", "patch": "@@ -401,7 +401,8 @@ function showHelp() {\n     console.log(\"  --doc-folder [PATH]        : location of the generated doc folder\");\n     console.log(\"  --help                     : show this message then quit\");\n     console.log(\"  --crate-name [STRING]      : crate name to be used\");\n-    console.log(\"  --test-file [PATH]         : location of the JS test file\");\n+    console.log(\"  --test-file [PATHs]        : location of the JS test files (can be called \" +\n+                \"multiple times)\");\n     console.log(\"  --test-folder [PATH]       : location of the JS tests folder\");\n     console.log(\"  --resource-suffix [STRING] : suffix to refer to the correct files\");\n }\n@@ -412,7 +413,7 @@ function parseOptions(args) {\n         \"resource_suffix\": \"\",\n         \"doc_folder\": \"\",\n         \"test_folder\": \"\",\n-        \"test_file\": \"\",\n+        \"test_file\": [],\n     };\n     var correspondences = {\n         \"--resource-suffix\": \"resource_suffix\",\n@@ -429,7 +430,11 @@ function parseOptions(args) {\n                 console.log(\"Missing argument after `\" + args[i - 1] + \"` option.\");\n                 return null;\n             }\n-            opts[correspondences[args[i - 1]]] = args[i];\n+            if (args[i - 1] !== \"--test-file\") {\n+                opts[correspondences[args[i - 1]]] = args[i];\n+            } else {\n+                opts[correspondences[args[i - 1]]].push(args[i]);\n+            }\n         } else if (args[i] === \"--help\") {\n             showHelp();\n             process.exit(0);\n@@ -471,9 +476,10 @@ function main(argv) {\n     var errors = 0;\n \n     if (opts[\"test_file\"].length !== 0) {\n-        errors += checkFile(opts[\"test_file\"], opts, loaded, index);\n-    }\n-    if (opts[\"test_folder\"].length !== 0) {\n+        opts[\"test_file\"].forEach(function(file) {\n+            errors += checkFile(file, opts, loaded, index);\n+        });\n+    } else if (opts[\"test_folder\"].length !== 0) {\n         fs.readdirSync(opts[\"test_folder\"]).forEach(function(file) {\n             if (!file.endsWith(\".js\")) {\n                 return;"}]}