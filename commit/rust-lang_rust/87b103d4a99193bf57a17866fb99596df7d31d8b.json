{"sha": "87b103d4a99193bf57a17866fb99596df7d31d8b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3YjEwM2Q0YTk5MTkzYmY1N2ExNzg2NmZiOTk1OTZkZjdkMzFkOGI=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-06-25T03:52:07Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-07-04T22:19:48Z"}, "message": "Add a \"total\" measurement to -Ztime-passes.\n\nThis is useful for getting the total compilation time at the end.\nTo do this, the patch changes `print_time_passes_entry` to not increment\nthe depth, which means that `print_time_passes_entry_internal` is no\nlonger needed.", "tree": {"sha": "87d9e0adca979cefefb75c2d3e21bd94a6e07871", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/87d9e0adca979cefefb75c2d3e21bd94a6e07871"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/87b103d4a99193bf57a17866fb99596df7d31d8b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/87b103d4a99193bf57a17866fb99596df7d31d8b", "html_url": "https://github.com/rust-lang/rust/commit/87b103d4a99193bf57a17866fb99596df7d31d8b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/87b103d4a99193bf57a17866fb99596df7d31d8b/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90419d36bd05718bce2b1a6eafaac8469a327bec", "url": "https://api.github.com/repos/rust-lang/rust/commits/90419d36bd05718bce2b1a6eafaac8469a327bec", "html_url": "https://github.com/rust-lang/rust/commit/90419d36bd05718bce2b1a6eafaac8469a327bec"}], "stats": {"total": 53, "additions": 32, "deletions": 21}, "files": [{"sha": "8e7936dae0976ca7563923d9531c427d6d193521", "filename": "src/librustc/util/common.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc%2Futil%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc%2Futil%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Futil%2Fcommon.rs?ref=87b103d4a99193bf57a17866fb99596df7d31d8b", "patch": "@@ -170,7 +170,7 @@ pub fn time_ext<T, F>(do_it: bool, sess: Option<&Session>, what: &str, f: F) ->\n         }\n     }\n \n-    print_time_passes_entry_internal(what, dur);\n+    print_time_passes_entry(true, what, dur);\n \n     TIME_DEPTH.with(|slot| slot.set(old));\n \n@@ -182,18 +182,6 @@ pub fn print_time_passes_entry(do_it: bool, what: &str, dur: Duration) {\n         return\n     }\n \n-    let old = TIME_DEPTH.with(|slot| {\n-        let r = slot.get();\n-        slot.set(r + 1);\n-        r\n-    });\n-\n-    print_time_passes_entry_internal(what, dur);\n-\n-    TIME_DEPTH.with(|slot| slot.set(old));\n-}\n-\n-fn print_time_passes_entry_internal(what: &str, dur: Duration) {\n     let indentation = TIME_DEPTH.with(|slot| slot.get());\n \n     let mem_string = match get_resident() {"}, {"sha": "7bb2cc7c08977c0a03dd05a1f7e6225cf591437c", "filename": "src/librustc_codegen_ssa/back/write.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs?ref=87b103d4a99193bf57a17866fb99596df7d31d8b", "patch": "@@ -1554,7 +1554,7 @@ fn start_executing_work<B: ExtraBackendMethods>(\n             let total_llvm_time = Instant::now().duration_since(llvm_start_time);\n             // This is the top-level timing for all of LLVM, set the time-depth\n             // to zero.\n-            set_time_depth(0);\n+            set_time_depth(1);\n             print_time_passes_entry(cgcx.time_passes,\n                                     \"LLVM passes\",\n                                     total_llvm_time);"}, {"sha": "a554bf7761c93cbfeeac7732c1b54447e231f037", "filename": "src/librustc_codegen_ssa/base.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc_codegen_ssa%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc_codegen_ssa%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fbase.rs?ref=87b103d4a99193bf57a17866fb99596df7d31d8b", "patch": "@@ -25,7 +25,7 @@ use rustc::ty::{self, Ty, TyCtxt, Instance};\n use rustc::ty::layout::{self, Align, TyLayout, LayoutOf, VariantIdx, HasTyCtxt};\n use rustc::ty::query::Providers;\n use rustc::middle::cstore::{self, LinkagePreference};\n-use rustc::util::common::{time, print_time_passes_entry};\n+use rustc::util::common::{time, print_time_passes_entry, set_time_depth, time_depth};\n use rustc::session::config::{self, EntryFnType, Lto};\n use rustc::session::Session;\n use rustc::util::nodemap::FxHashMap;\n@@ -639,9 +639,12 @@ pub fn codegen_crate<B: ExtraBackendMethods>(\n \n     // Since the main thread is sometimes blocked during codegen, we keep track\n     // -Ztime-passes output manually.\n+    let time_depth = time_depth();\n+    set_time_depth(time_depth + 1);\n     print_time_passes_entry(tcx.sess.time_passes(),\n                             \"codegen to LLVM IR\",\n                             total_codegen_time);\n+    set_time_depth(time_depth);\n \n     ::rustc_incremental::assert_module_sources::assert_module_sources(tcx);\n "}, {"sha": "3258e2517319b7a577785d971c888fa219955c8f", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 26, "deletions": 6, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87b103d4a99193bf57a17866fb99596df7d31d8b/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=87b103d4a99193bf57a17866fb99596df7d31d8b", "patch": "@@ -38,7 +38,8 @@ use rustc::session::{early_error, early_warn};\n use rustc::lint::Lint;\n use rustc::lint;\n use rustc::hir::def_id::LOCAL_CRATE;\n-use rustc::util::common::{time, ErrorReported, install_panic_hook};\n+use rustc::util::common::{ErrorReported, install_panic_hook, print_time_passes_entry};\n+use rustc::util::common::{set_time_depth, time};\n use rustc_metadata::locator;\n use rustc_metadata::cstore::CStore;\n use rustc_codegen_utils::codegen_backend::CodegenBackend;\n@@ -54,11 +55,12 @@ use std::default::Default;\n use std::env;\n use std::ffi::OsString;\n use std::io::{self, Read, Write};\n+use std::mem;\n use std::panic::{self, catch_unwind};\n use std::path::PathBuf;\n use std::process::{self, Command, Stdio};\n use std::str;\n-use std::mem;\n+use std::time::Instant;\n \n use syntax::ast;\n use syntax::source_map::FileLoader;\n@@ -72,7 +74,7 @@ pub mod pretty;\n /// Exit status code used for successful compilation and help output.\n pub const EXIT_SUCCESS: i32 = 0;\n \n-/// Exit status code used for compilation failures and  invalid flags.\n+/// Exit status code used for compilation failures and invalid flags.\n pub const EXIT_FAILURE: i32 = 1;\n \n const BUG_REPORT_URL: &str = \"https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.\\\n@@ -118,6 +120,18 @@ pub struct DefaultCallbacks;\n \n impl Callbacks for DefaultCallbacks {}\n \n+#[derive(Default)]\n+pub struct TimePassesCallbacks {\n+    time_passes: bool,\n+}\n+\n+impl Callbacks for TimePassesCallbacks {\n+    fn config(&mut self, config: &mut interface::Config) {\n+        self.time_passes =\n+            config.opts.debugging_opts.time_passes || config.opts.debugging_opts.time;\n+    }\n+}\n+\n // Parse args and run the compiler. This is the primary entry point for rustc.\n // See comments on CompilerCalls below for details about the callbacks argument.\n // The FileLoader provides a way to load files from sources other than the file system.\n@@ -1169,18 +1183,24 @@ pub fn init_rustc_env_logger() {\n }\n \n pub fn main() {\n+    let start = Instant::now();\n     init_rustc_env_logger();\n+    let mut callbacks = TimePassesCallbacks::default();\n     let result = report_ices_to_stderr_if_any(|| {\n         let args = env::args_os().enumerate()\n             .map(|(i, arg)| arg.into_string().unwrap_or_else(|arg| {\n                 early_error(ErrorOutputType::default(),\n                             &format!(\"Argument {} is not valid Unicode: {:?}\", i, arg))\n             }))\n             .collect::<Vec<_>>();\n-        run_compiler(&args, &mut DefaultCallbacks, None, None)\n+        run_compiler(&args, &mut callbacks, None, None)\n     }).and_then(|result| result);\n-    process::exit(match result {\n+    let exit_code = match result {\n         Ok(_) => EXIT_SUCCESS,\n         Err(_) => EXIT_FAILURE,\n-    });\n+    };\n+    // The extra `\\t` is necessary to align this label with the others.\n+    set_time_depth(0);\n+    print_time_passes_entry(callbacks.time_passes, \"\\ttotal\", start.elapsed());\n+    process::exit(exit_code);\n }"}]}