{"sha": "f709999161265cb0eb2754eb18852d69fa29e9a1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3MDk5OTkxNjEyNjVjYjBlYjI3NTRlYjE4ODUyZDY5ZmEyOWU5YTE=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-07-23T19:31:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-23T19:31:13Z"}, "message": "Rollup merge of #87380 - jyn514:smarter-submodule-defaults, r=Mark-Simulacrum\n\nDon't default to `submodules = true` unless the rust repo has a .git directory\n\nShould hopefully fix https://github.com/rust-lang/rust/pull/82653#issuecomment-885093033 - `@semarie` can you confirm?\n\nr? `@Mark-Simulacrum`", "tree": {"sha": "529d846b09870dd8826fca3c4cb7b5f31d89ebd4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/529d846b09870dd8826fca3c4cb7b5f31d89ebd4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f709999161265cb0eb2754eb18852d69fa29e9a1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg+xkBCRBK7hj4Ov3rIwAACCkIAJ+qipUakJLwaKU4T+0U5ZpT\nfwF0T48ot41wNROY58auN9yfRMevqfe+bUPtirnXTK4ll9xrF3Ud6XIWQrlF7lQP\nswnYu9SCjb+j1PuaodlgyffTrFmVd7ZgfMiE8sM/BoiCCoGPfGUTn95lCY6463Af\nXXHJlYJ4EIcFph9lgwFyk0RwHEV9eKp7Z2bMI1LmdGGFpLwjHJyVNHPHirZD4kzK\nvVzkOJGbc7Kl2I8zlT7Ztijepssgloy+jIoI/09u1vMbr8Mk75PrpDewc79/AONT\n6ARQzKzGkOoYbiq90Y5D51TEx/rfGiEgb0eY0HCZiaAPOpSkmM/KiqIpnaLwdLQ=\n=9hi1\n-----END PGP SIGNATURE-----\n", "payload": "tree 529d846b09870dd8826fca3c4cb7b5f31d89ebd4\nparent 1b9cd8bbb8c6c63bead5d278704f08b98a1b4eb6\nparent 6194cc8f485954b659c1f196b46fcb67fd73d455\nauthor Yuki Okushi <jtitor@2k36.org> 1627068673 +0900\ncommitter GitHub <noreply@github.com> 1627068673 +0900\n\nRollup merge of #87380 - jyn514:smarter-submodule-defaults, r=Mark-Simulacrum\n\nDon't default to `submodules = true` unless the rust repo has a .git directory\n\nShould hopefully fix https://github.com/rust-lang/rust/pull/82653#issuecomment-885093033 - `@semarie` can you confirm?\n\nr? `@Mark-Simulacrum`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f709999161265cb0eb2754eb18852d69fa29e9a1", "html_url": "https://github.com/rust-lang/rust/commit/f709999161265cb0eb2754eb18852d69fa29e9a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f709999161265cb0eb2754eb18852d69fa29e9a1/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b9cd8bbb8c6c63bead5d278704f08b98a1b4eb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b9cd8bbb8c6c63bead5d278704f08b98a1b4eb6", "html_url": "https://github.com/rust-lang/rust/commit/1b9cd8bbb8c6c63bead5d278704f08b98a1b4eb6"}, {"sha": "6194cc8f485954b659c1f196b46fcb67fd73d455", "url": "https://api.github.com/repos/rust-lang/rust/commits/6194cc8f485954b659c1f196b46fcb67fd73d455", "html_url": "https://github.com/rust-lang/rust/commit/6194cc8f485954b659c1f196b46fcb67fd73d455"}], "stats": {"total": 15, "additions": 10, "deletions": 5}, "files": [{"sha": "4b3c25b02c2789ca327b318a6688e566e222b08c", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f709999161265cb0eb2754eb18852d69fa29e9a1/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f709999161265cb0eb2754eb18852d69fa29e9a1/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=f709999161265cb0eb2754eb18852d69fa29e9a1", "patch": "@@ -13,6 +13,7 @@ use std::path::{Path, PathBuf};\n use std::str::FromStr;\n \n use crate::cache::{Interned, INTERNER};\n+use crate::channel::GitInfo;\n pub use crate::flags::Subcommand;\n use crate::flags::{Color, Flags};\n use crate::util::exe;\n@@ -48,7 +49,7 @@ pub struct Config {\n     /// Call Build::ninja() instead of this.\n     pub ninja_in_file: bool,\n     pub verbose: usize,\n-    pub submodules: bool,\n+    pub submodules: Option<bool>,\n     pub fast_submodules: bool,\n     pub compiler_docs: bool,\n     pub docs_minification: bool,\n@@ -552,7 +553,7 @@ impl Config {\n         config.backtrace = true;\n         config.rust_optimize = true;\n         config.rust_optimize_tests = true;\n-        config.submodules = true;\n+        config.submodules = None;\n         config.fast_submodules = true;\n         config.docs = true;\n         config.docs_minification = true;\n@@ -658,11 +659,11 @@ impl Config {\n         config.npm = build.npm.map(PathBuf::from);\n         config.gdb = build.gdb.map(PathBuf::from);\n         config.python = build.python.map(PathBuf::from);\n+        config.submodules = build.submodules;\n         set(&mut config.low_priority, build.low_priority);\n         set(&mut config.compiler_docs, build.compiler_docs);\n         set(&mut config.docs_minification, build.docs_minification);\n         set(&mut config.docs, build.docs);\n-        set(&mut config.submodules, build.submodules);\n         set(&mut config.fast_submodules, build.fast_submodules);\n         set(&mut config.locked_deps, build.locked_deps);\n         set(&mut config.vendor, build.vendor);\n@@ -1083,6 +1084,10 @@ impl Config {\n     pub fn llvm_enabled(&self) -> bool {\n         self.rust_codegen_backends.contains(&INTERNER.intern_str(\"llvm\"))\n     }\n+\n+    pub fn submodules(&self, rust_info: &GitInfo) -> bool {\n+        self.submodules.unwrap_or(rust_info.is_git())\n+    }\n }\n \n fn set<T>(field: &mut T, val: Option<T>) {"}, {"sha": "245f3eada2af7719d6ab33a61912ed15b3257883", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f709999161265cb0eb2754eb18852d69fa29e9a1/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f709999161265cb0eb2754eb18852d69fa29e9a1/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=f709999161265cb0eb2754eb18852d69fa29e9a1", "patch": "@@ -486,7 +486,7 @@ impl Build {\n             t!(std::fs::read_dir(dir)).next().is_none()\n         }\n \n-        if !self.config.submodules {\n+        if !self.config.submodules(&self.rust_info) {\n             return;\n         }\n \n@@ -562,7 +562,7 @@ impl Build {\n             \"library/stdarch\",\n         ];\n         // Avoid running git when there isn't a git checkout.\n-        if !self.config.submodules {\n+        if !self.config.submodules(&self.rust_info) {\n             return;\n         }\n         let output = output("}]}