{"sha": "15ade4d5043300b8fc0ac6e555a2998a6a8315b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1YWRlNGQ1MDQzMzAwYjhmYzBhYzZlNTU1YTI5OThhNmE4MzE1Yjg=", "commit": {"author": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-01-08T19:21:30Z"}, "committer": {"name": "Simonas Kazlauskas", "email": "git@kazlauskas.me", "date": "2021-01-09T16:29:25Z"}, "message": "Support `download-ci-llvm` on NixOS\n\nIn particular, the CI built `libLLVM-*.so` needs to have `libz.so`\nRPATHed so that binaries like `llvm-config` work at all.", "tree": {"sha": "2a0009115af65d2791e0d27430926b521638e643", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a0009115af65d2791e0d27430926b521638e643"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/15ade4d5043300b8fc0ac6e555a2998a6a8315b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/15ade4d5043300b8fc0ac6e555a2998a6a8315b8", "html_url": "https://github.com/rust-lang/rust/commit/15ade4d5043300b8fc0ac6e555a2998a6a8315b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/15ade4d5043300b8fc0ac6e555a2998a6a8315b8/comments", "author": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nagisa", "id": 679122, "node_id": "MDQ6VXNlcjY3OTEyMg==", "avatar_url": "https://avatars.githubusercontent.com/u/679122?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nagisa", "html_url": "https://github.com/nagisa", "followers_url": "https://api.github.com/users/nagisa/followers", "following_url": "https://api.github.com/users/nagisa/following{/other_user}", "gists_url": "https://api.github.com/users/nagisa/gists{/gist_id}", "starred_url": "https://api.github.com/users/nagisa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nagisa/subscriptions", "organizations_url": "https://api.github.com/users/nagisa/orgs", "repos_url": "https://api.github.com/users/nagisa/repos", "events_url": "https://api.github.com/users/nagisa/events{/privacy}", "received_events_url": "https://api.github.com/users/nagisa/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ddf2cc7f8eb34f1a63b491d6a52e3e8208393c09", "url": "https://api.github.com/repos/rust-lang/rust/commits/ddf2cc7f8eb34f1a63b491d6a52e3e8208393c09", "html_url": "https://github.com/rust-lang/rust/commit/ddf2cc7f8eb34f1a63b491d6a52e3e8208393c09"}], "stats": {"total": 23, "additions": 15, "deletions": 8}, "files": [{"sha": "6d2d7bbbef92c55993167d4d9588e7f05556e92e", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 15, "deletions": 8, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/15ade4d5043300b8fc0ac6e555a2998a6a8315b8/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/15ade4d5043300b8fc0ac6e555a2998a6a8315b8/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=15ade4d5043300b8fc0ac6e555a2998a6a8315b8", "patch": "@@ -413,7 +413,7 @@ def download_stage0(self):\n             lib_dir = \"{}/lib\".format(self.bin_root())\n             for lib in os.listdir(lib_dir):\n                 if lib.endswith(\".so\"):\n-                    self.fix_bin_or_dylib(\"{}/{}\".format(lib_dir, lib))\n+                    self.fix_bin_or_dylib(os.path.join(lib_dir, lib), rpath_libz=True)\n             with output(self.rustc_stamp()) as rust_stamp:\n                 rust_stamp.write(self.date)\n \n@@ -451,10 +451,15 @@ def download_stage0(self):\n                 \"{}/src/bootstrap/download-ci-llvm-stamp\".format(top_level),\n             ]).decode(sys.getdefaultencoding()).strip()\n             llvm_assertions = self.get_toml('assertions', 'llvm') == 'true'\n+            llvm_root = self.llvm_root()\n+            llvm_lib = os.path.join(llvm_root, \"lib\")\n             if self.program_out_of_date(self.llvm_stamp(), llvm_sha + str(llvm_assertions)):\n                 self._download_ci_llvm(llvm_sha, llvm_assertions)\n                 for binary in [\"llvm-config\", \"FileCheck\"]:\n-                    self.fix_bin_or_dylib(\"{}/bin/{}\".format(self.llvm_root(), binary))\n+                    self.fix_bin_or_dylib(os.path.join(llvm_root, \"bin\", binary), rpath_libz=True)\n+                for lib in os.listdir(llvm_lib):\n+                    if lib.endswith(\".so\"):\n+                        self.fix_bin_or_dylib(os.path.join(llvm_lib, lib), rpath_libz=True)\n                 with output(self.llvm_stamp()) as llvm_stamp:\n                     llvm_stamp.write(llvm_sha + str(llvm_assertions))\n \n@@ -501,7 +506,7 @@ def _download_ci_llvm(self, llvm_sha, llvm_assertions):\n                 match=\"rust-dev\",\n                 verbose=self.verbose)\n \n-    def fix_bin_or_dylib(self, fname):\n+    def fix_bin_or_dylib(self, fname, rpath_libz=False):\n         \"\"\"Modifies the interpreter section of 'fname' to fix the dynamic linker,\n         or the RPATH section, to fix the dynamic library search path\n \n@@ -571,20 +576,22 @@ def fix_bin_or_dylib(self, fname):\n             self.nix_deps_dir = nix_deps_dir\n \n         patchelf = \"{}/patchelf/bin/patchelf\".format(nix_deps_dir)\n+        patchelf_args = []\n \n-        if fname.endswith(\".so\"):\n-            # Dynamic library, patch RPATH to point to system dependencies.\n+        if rpath_libz:\n+            # Patch RPATH to add `zlib` dependency that stems from LLVM\n             dylib_deps = [\"zlib\"]\n             rpath_entries = [\n                 # Relative default, all binary and dynamic libraries we ship\n                 # appear to have this (even when `../lib` is redundant).\n                 \"$ORIGIN/../lib\",\n             ] + [\"{}/{}/lib\".format(nix_deps_dir, dep) for dep in dylib_deps]\n-            patchelf_args = [\"--set-rpath\", \":\".join(rpath_entries)]\n-        else:\n+            patchelf_args += [\"--set-rpath\", \":\".join(rpath_entries)]\n+        if not fname.endswith(\".so\"):\n+            # Finally, set the corret .interp for binaries\n             bintools_dir = \"{}/stdenv.cc.bintools\".format(nix_deps_dir)\n             with open(\"{}/nix-support/dynamic-linker\".format(bintools_dir)) as dynamic_linker:\n-                patchelf_args = [\"--set-interpreter\", dynamic_linker.read().rstrip()]\n+                patchelf_args += [\"--set-interpreter\", dynamic_linker.read().rstrip()]\n \n         try:\n             subprocess.check_output([patchelf] + patchelf_args + [fname])"}]}