{"sha": "32c8c5df06c025441ad04791d7982d65c79a60e4", "node_id": "C_kwDOAAsO6NoAKDMyYzhjNWRmMDZjMDI1NDQxYWQwNDc5MWQ3OTgyZDY1Yzc5YTYwZTQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-23T10:46:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-23T10:46:50Z"}, "message": "Auto merge of #97195 - notriddle:notriddle/cleanup, r=GuillaumeGomez\n\nrustdoc: shrink GenericArgs/PathSegment with boxed slices\n\nThis PR also contains a few cleanup bits and pieces, but one of them is a broken intra-doc link, and the other is removing an unused Hash impl. The last commit is the one that matters.", "tree": {"sha": "058065c389f9b6dad37a129390e63cacaf0f6fcd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/058065c389f9b6dad37a129390e63cacaf0f6fcd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/32c8c5df06c025441ad04791d7982d65c79a60e4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/32c8c5df06c025441ad04791d7982d65c79a60e4", "html_url": "https://github.com/rust-lang/rust/commit/32c8c5df06c025441ad04791d7982d65c79a60e4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/32c8c5df06c025441ad04791d7982d65c79a60e4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e2f65586366b731f13a10021c5191a664f4adc2", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e2f65586366b731f13a10021c5191a664f4adc2", "html_url": "https://github.com/rust-lang/rust/commit/9e2f65586366b731f13a10021c5191a664f4adc2"}, {"sha": "207f64948f1a9a3e3c8ac363be5ea4dcfebd200c", "url": "https://api.github.com/repos/rust-lang/rust/commits/207f64948f1a9a3e3c8ac363be5ea4dcfebd200c", "html_url": "https://github.com/rust-lang/rust/commit/207f64948f1a9a3e3c8ac363be5ea4dcfebd200c"}], "stats": {"total": 75, "additions": 38, "deletions": 37}, "files": [{"sha": "73d6566e3cd977655f2c1b5c07476aefe8aef1c3", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -182,7 +182,7 @@ impl RibKind<'_> {\n /// stack. This may be, for example, a `let` statement (because it introduces variables), a macro,\n /// etc.\n ///\n-/// Different [rib kinds](enum.RibKind) are transparent for different names.\n+/// Different [rib kinds](enum@RibKind) are transparent for different names.\n ///\n /// The resolution keeps a separate stack of ribs as it traverses the AST for each namespace. When\n /// resolving, the name is looked up from inside out."}, {"sha": "1ccd6a2c0ef28ce39a47c199e5bf7eaed328b827", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -544,7 +544,7 @@ fn build_module(\n                                 segments: vec![clean::PathSegment {\n                                     name: prim_ty.as_sym(),\n                                     args: clean::GenericArgs::AngleBracketed {\n-                                        args: Vec::new(),\n+                                        args: Default::default(),\n                                         bindings: ThinVec::new(),\n                                     },\n                                 }],"}, {"sha": "9d5619bacf516797fed496e279d2c5f2c1a2e307", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -420,7 +420,7 @@ fn projection_to_path_segment(ty: ty::ProjectionTy<'_>, cx: &mut DocContext<'_>)\n     PathSegment {\n         name: item.name,\n         args: GenericArgs::AngleBracketed {\n-            args: substs_to_args(cx, &ty.substs[generics.parent_count..], false),\n+            args: substs_to_args(cx, &ty.substs[generics.parent_count..], false).into(),\n             bindings: Default::default(),\n         },\n     }\n@@ -1205,7 +1205,7 @@ impl Clean<Item> for ty::AssocItem {\n                                             || generics\n                                                 .params\n                                                 .iter()\n-                                                .zip(args)\n+                                                .zip(args.iter())\n                                                 .any(|(param, arg)| !param_eq_arg(param, arg))\n                                         {\n                                             return false;\n@@ -1837,7 +1837,7 @@ impl Clean<GenericArgs> for hir::GenericArgs<'_> {\n             let output = self.bindings[0].ty().clean(cx);\n             let output =\n                 if output != Type::Tuple(Vec::new()) { Some(Box::new(output)) } else { None };\n-            let inputs = self.inputs().iter().map(|x| x.clean(cx)).collect();\n+            let inputs = self.inputs().iter().map(|x| x.clean(cx)).collect::<Vec<_>>().into();\n             GenericArgs::Parenthesized { inputs, output }\n         } else {\n             let args = self\n@@ -1852,8 +1852,9 @@ impl Clean<GenericArgs> for hir::GenericArgs<'_> {\n                     hir::GenericArg::Const(ct) => GenericArg::Const(Box::new(ct.clean(cx))),\n                     hir::GenericArg::Infer(_inf) => GenericArg::Infer,\n                 })\n-                .collect();\n-            let bindings = self.bindings.iter().map(|x| x.clean(cx)).collect();\n+                .collect::<Vec<_>>()\n+                .into();\n+            let bindings = self.bindings.iter().map(|x| x.clean(cx)).collect::<Vec<_>>().into();\n             GenericArgs::AngleBracketed { args, bindings }\n         }\n     }"}, {"sha": "1bb0219c42a3e9cd630a9f2bf692b19022814686", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -994,7 +994,7 @@ pub(crate) struct DocFragment {\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n rustc_data_structures::static_assert_size!(DocFragment, 32);\n \n-#[derive(Clone, Copy, PartialEq, Eq, Debug, Hash)]\n+#[derive(Clone, Copy, PartialEq, Eq, Debug)]\n pub(crate) enum DocFragmentKind {\n     /// A doc fragment created from a `///` or `//!` doc comment.\n     SugaredDoc,\n@@ -2182,14 +2182,14 @@ rustc_data_structures::static_assert_size!(GenericArg, 80);\n \n #[derive(Clone, PartialEq, Eq, Debug, Hash)]\n pub(crate) enum GenericArgs {\n-    AngleBracketed { args: Vec<GenericArg>, bindings: ThinVec<TypeBinding> },\n-    Parenthesized { inputs: Vec<Type>, output: Option<Box<Type>> },\n+    AngleBracketed { args: Box<[GenericArg]>, bindings: ThinVec<TypeBinding> },\n+    Parenthesized { inputs: Box<[Type]>, output: Option<Box<Type>> },\n }\n \n // `GenericArgs` is in every `PathSegment`, so its size can significantly\n // affect rustdoc's memory usage.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n-rustc_data_structures::static_assert_size!(GenericArgs, 40);\n+rustc_data_structures::static_assert_size!(GenericArgs, 32);\n \n #[derive(Clone, PartialEq, Eq, Debug, Hash)]\n pub(crate) struct PathSegment {\n@@ -2200,7 +2200,7 @@ pub(crate) struct PathSegment {\n // `PathSegment` usually occurs multiple times in every `Path`, so its size can\n // significantly affect rustdoc's memory usage.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n-rustc_data_structures::static_assert_size!(PathSegment, 48);\n+rustc_data_structures::static_assert_size!(PathSegment, 40);\n \n #[derive(Clone, Debug)]\n pub(crate) struct Typedef {"}, {"sha": "47597e0413ae1c1c287a0905885104ba789b5100", "filename": "src/librustdoc/clean/utils.rs", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fclean%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Futils.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -80,23 +80,23 @@ pub(crate) fn substs_to_args(\n     substs: &[ty::subst::GenericArg<'_>],\n     mut skip_first: bool,\n ) -> Vec<GenericArg> {\n-    substs\n-        .iter()\n-        .filter_map(|kind| match kind.unpack() {\n-            GenericArgKind::Lifetime(lt) => match *lt {\n-                ty::ReLateBound(_, ty::BoundRegion { kind: ty::BrAnon(_), .. }) => {\n-                    Some(GenericArg::Lifetime(Lifetime::elided()))\n-                }\n-                _ => lt.clean(cx).map(GenericArg::Lifetime),\n-            },\n-            GenericArgKind::Type(_) if skip_first => {\n-                skip_first = false;\n-                None\n+    let mut ret_val =\n+        Vec::with_capacity(substs.len().saturating_sub(if skip_first { 1 } else { 0 }));\n+    ret_val.extend(substs.iter().filter_map(|kind| match kind.unpack() {\n+        GenericArgKind::Lifetime(lt) => match *lt {\n+            ty::ReLateBound(_, ty::BoundRegion { kind: ty::BrAnon(_), .. }) => {\n+                Some(GenericArg::Lifetime(Lifetime::elided()))\n             }\n-            GenericArgKind::Type(ty) => Some(GenericArg::Type(ty.clean(cx))),\n-            GenericArgKind::Const(ct) => Some(GenericArg::Const(Box::new(ct.clean(cx)))),\n-        })\n-        .collect()\n+            _ => lt.clean(cx).map(GenericArg::Lifetime),\n+        },\n+        GenericArgKind::Type(_) if skip_first => {\n+            skip_first = false;\n+            None\n+        }\n+        GenericArgKind::Type(ty) => Some(GenericArg::Type(ty.clean(cx))),\n+        GenericArgKind::Const(ct) => Some(GenericArg::Const(Box::new(ct.clean(cx)))),\n+    }));\n+    ret_val\n }\n \n fn external_generic_args(\n@@ -112,8 +112,8 @@ fn external_generic_args(\n         let inputs =\n             // The trait's first substitution is the one after self, if there is one.\n             match substs.iter().nth(if has_self { 1 } else { 0 }).unwrap().expect_ty().kind() {\n-                ty::Tuple(tys) => tys.iter().map(|t| t.clean(cx)).collect(),\n-                _ => return GenericArgs::AngleBracketed { args, bindings: bindings.into() },\n+                ty::Tuple(tys) => tys.iter().map(|t| t.clean(cx)).collect::<Vec<_>>().into(),\n+                _ => return GenericArgs::AngleBracketed { args: args.into(), bindings: bindings.into() },\n             };\n         let output = None;\n         // FIXME(#20299) return type comes from a projection now\n@@ -123,7 +123,7 @@ fn external_generic_args(\n         // };\n         GenericArgs::Parenthesized { inputs, output }\n     } else {\n-        GenericArgs::AngleBracketed { args, bindings: bindings.into() }\n+        GenericArgs::AngleBracketed { args: args.into(), bindings: bindings.into() }\n     }\n }\n \n@@ -148,7 +148,7 @@ pub(super) fn external_path(\n /// Remove the generic arguments from a path.\n pub(crate) fn strip_path_generics(mut path: Path) -> Path {\n     for ps in path.segments.iter_mut() {\n-        ps.args = GenericArgs::AngleBracketed { args: vec![], bindings: ThinVec::new() }\n+        ps.args = GenericArgs::AngleBracketed { args: Default::default(), bindings: ThinVec::new() }\n     }\n \n     path"}, {"sha": "da32d8c90be647b348dbcd29433412aa81fd1258", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -457,7 +457,7 @@ impl clean::GenericArgs {\n                             f.write_str(\"&lt;\")?;\n                         }\n                         let mut comma = false;\n-                        for arg in args {\n+                        for arg in args.iter() {\n                             if comma {\n                                 f.write_str(\", \")?;\n                             }\n@@ -468,7 +468,7 @@ impl clean::GenericArgs {\n                                 write!(f, \"{}\", arg.print(cx))?;\n                             }\n                         }\n-                        for binding in bindings {\n+                        for binding in bindings.iter() {\n                             if comma {\n                                 f.write_str(\", \")?;\n                             }\n@@ -489,7 +489,7 @@ impl clean::GenericArgs {\n                 clean::GenericArgs::Parenthesized { inputs, output } => {\n                     f.write_str(\"(\")?;\n                     let mut comma = false;\n-                    for ty in inputs {\n+                    for ty in inputs.iter() {\n                         if comma {\n                             f.write_str(\", \")?;\n                         }"}, {"sha": "bc9920730dd3c55c4f75d3afeed3bd211cf7d084", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32c8c5df06c025441ad04791d7982d65c79a60e4/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=32c8c5df06c025441ad04791d7982d65c79a60e4", "patch": "@@ -119,11 +119,11 @@ impl FromWithTcx<clean::GenericArgs> for GenericArgs {\n         use clean::GenericArgs::*;\n         match args {\n             AngleBracketed { args, bindings } => GenericArgs::AngleBracketed {\n-                args: args.into_iter().map(|a| a.into_tcx(tcx)).collect(),\n+                args: args.into_vec().into_iter().map(|a| a.into_tcx(tcx)).collect(),\n                 bindings: bindings.into_iter().map(|a| a.into_tcx(tcx)).collect(),\n             },\n             Parenthesized { inputs, output } => GenericArgs::Parenthesized {\n-                inputs: inputs.into_iter().map(|a| a.into_tcx(tcx)).collect(),\n+                inputs: inputs.into_vec().into_iter().map(|a| a.into_tcx(tcx)).collect(),\n                 output: output.map(|a| (*a).into_tcx(tcx)),\n             },\n         }"}]}