{"sha": "ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkNGRmNzI2ZmRiM2JiMjVmMzVkZWFlZmRiZTNmZTMxMjNjZjk3YzY=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2016-12-21T14:46:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-12-21T14:46:00Z"}, "message": "Merge pull request #1393 from oli-obk/linkedlists\n\nDon\u2019t warn for types used in trait implementation", "tree": {"sha": "82da33536b4a77418dd3b11123d0487a4a18d0fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82da33536b4a77418dd3b11123d0487a4a18d0fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6", "html_url": "https://github.com/rust-lang/rust/commit/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5060d2fa7cdbe9dc201c64f0814f776a429f4d3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/5060d2fa7cdbe9dc201c64f0814f776a429f4d3e", "html_url": "https://github.com/rust-lang/rust/commit/5060d2fa7cdbe9dc201c64f0814f776a429f4d3e"}, {"sha": "00a3bfb8eba20f3d3d5b9623e8737616dfdd4f1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/00a3bfb8eba20f3d3d5b9623e8737616dfdd4f1c", "html_url": "https://github.com/rust-lang/rust/commit/00a3bfb8eba20f3d3d5b9623e8737616dfdd4f1c"}], "stats": {"total": 107, "additions": 100, "deletions": 7}, "files": [{"sha": "5885d7863b7104c7226afb84f2c9c82d2c6e0b76", "filename": "clippy_lints/src/types.rs", "status": "modified", "additions": 73, "deletions": 5, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6/clippy_lints%2Fsrc%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6/clippy_lints%2Fsrc%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes.rs?ref=ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6", "patch": "@@ -70,11 +70,47 @@ impl LintPass for TypePass {\n }\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for TypePass {\n-    fn check_ty(&mut self, cx: &LateContext<'a, 'tcx>, ast_ty: &'tcx Ty) {\n-        if in_macro(cx, ast_ty.span) {\n-            return;\n+    fn check_fn(&mut self, cx: &LateContext, _: FnKind, decl: &FnDecl, _: &Expr, _: Span, id: NodeId) {\n+        // skip trait implementations, see #605\n+        if let Some(map::NodeItem(item)) = cx.tcx.map.find(cx.tcx.map.get_parent(id)) {\n+            if let ItemImpl(_, _, _, Some(..), _, _) = item.node {\n+                return;\n+            }\n+        }\n+\n+        check_fn_decl(cx, decl);\n+    }\n+\n+    fn check_struct_field(&mut self, cx: &LateContext, field: &StructField) {\n+        check_ty(cx, &field.ty);\n+    }\n+\n+    fn check_trait_item(&mut self, cx: &LateContext, item: &TraitItem) {\n+        match item.node {\n+            ConstTraitItem(ref ty, _) |\n+            TypeTraitItem(_, Some(ref ty)) => check_ty(cx, ty),\n+            MethodTraitItem(ref sig, _) => check_fn_decl(cx, &sig.decl),\n+            _ => (),\n         }\n-        if let TyPath(ref qpath) = ast_ty.node {\n+    }\n+}\n+\n+fn check_fn_decl(cx: &LateContext, decl: &FnDecl) {\n+    for input in &decl.inputs {\n+        check_ty(cx, &input.ty);\n+    }\n+\n+    if let FunctionRetTy::Return(ref ty) = decl.output {\n+        check_ty(cx, ty);\n+    }\n+}\n+\n+fn check_ty(cx: &LateContext, ast_ty: &Ty) {\n+    if in_macro(cx, ast_ty.span) {\n+        return;\n+    }\n+    match ast_ty.node {\n+        TyPath(ref qpath) => {\n             let def = cx.tcx.tables().qpath_def(qpath, ast_ty.id);\n             if let Some(def_id) = opt_def_id(def) {\n                 if Some(def_id) == cx.tcx.lang_items.owned_box() {\n@@ -92,16 +128,48 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for TypePass {\n                                            ast_ty.span,\n                                            \"you seem to be trying to use `Box<Vec<T>>`. Consider using just `Vec<T>`\",\n                                            \"`Vec<T>` is already on the heap, `Box<Vec<T>>` makes an extra allocation.\");\n+                        return; // don't recurse into the type\n                     }}\n                 } else if match_def_path(cx, def_id, &paths::LINKED_LIST) {\n                     span_help_and_lint(cx,\n                                        LINKEDLIST,\n                                        ast_ty.span,\n                                        \"I see you're using a LinkedList! Perhaps you meant some other data structure?\",\n                                        \"a VecDeque might work\");\n+                    return; // don't recurse into the type\n                 }\n             }\n-        }\n+            match *qpath {\n+                QPath::Resolved(Some(ref ty), ref p) => {\n+                    check_ty(cx, ty);\n+                    for ty in p.segments.iter().flat_map(|seg| seg.parameters.types()) {\n+                        check_ty(cx, ty);\n+                    }\n+                },\n+                QPath::Resolved(None, ref p) => {\n+                    for ty in p.segments.iter().flat_map(|seg| seg.parameters.types()) {\n+                        check_ty(cx, ty);\n+                    }\n+                },\n+                QPath::TypeRelative(ref ty, ref seg) => {\n+                    check_ty(cx, ty);\n+                    for ty in seg.parameters.types() {\n+                        check_ty(cx, ty);\n+                    }\n+                },\n+            }\n+        },\n+        // recurse\n+        TySlice(ref ty) |\n+        TyArray(ref ty, _) |\n+        TyPtr(MutTy { ref ty, .. }) |\n+        TyRptr(_, MutTy { ref ty, .. }) => check_ty(cx, ty),\n+        TyTup(ref tys) => {\n+            for ty in tys {\n+                check_ty(cx, ty);\n+            }\n+        },\n+        _ => {},\n     }\n }\n "}, {"sha": "63c678eb69c285dabf478fef2ed0b05e223c8e26", "filename": "tests/compile-fail/dlist.rs", "status": "modified", "additions": 27, "deletions": 2, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6/tests%2Fcompile-fail%2Fdlist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6/tests%2Fcompile-fail%2Fdlist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fdlist.rs?ref=ad4df726fdb3bb25f35deaefdbe3fe3123cf97c6", "patch": "@@ -1,14 +1,39 @@\n #![feature(plugin, collections)]\n+#![feature(associated_type_defaults)]\n+#![feature(associated_consts)]\n \n #![plugin(clippy)]\n #![deny(clippy)]\n+#![allow(dead_code)]\n \n extern crate collections;\n use collections::linked_list::LinkedList;\n \n-pub fn test(_: LinkedList<u8>) {  //~ ERROR I see you're using a LinkedList!\n+trait Foo {\n+    type Baz = LinkedList<u8>; //~ ERROR I see you're using a LinkedList!\n+    fn foo(LinkedList<u8>); //~ ERROR I see you're using a LinkedList!\n+    const BAR : Option<LinkedList<u8>>; //~ ERROR I see you're using a LinkedList!\n+}\n+\n+// ok, we don\u2019t want to warn for implementations, see #605\n+impl Foo for LinkedList<u8> {\n+    fn foo(_: LinkedList<u8>) {}\n+    const BAR : Option<LinkedList<u8>> = None;\n+}\n+\n+struct Bar;\n+impl Bar {\n+    fn foo(_: LinkedList<u8>) {} //~ ERROR I see you're using a LinkedList!\n+}\n+\n+pub fn test(my_favourite_linked_list: LinkedList<u8>) { //~ ERROR I see you're using a LinkedList!\n+    println!(\"{:?}\", my_favourite_linked_list)\n+}\n+\n+pub fn test_ret() -> Option<LinkedList<u8>> { //~ ERROR I see you're using a LinkedList!\n+    unimplemented!();\n }\n \n fn main(){\n-    test(LinkedList::new()); //~ ERROR I see you're using a LinkedList!\n+    test(LinkedList::new());\n }"}]}