{"sha": "e1d8806efd702ee396992677cd04ab40c329d5d7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxZDg4MDZlZmQ3MDJlZTM5Njk5MjY3N2NkMDRhYjQwYzMyOWQ1ZDc=", "commit": {"author": {"name": "Austin Hicks", "email": "camlorn@camlorn.net", "date": "2016-12-20T02:14:27Z"}, "committer": {"name": "Austin Hicks", "email": "camlorn@camlorn.net", "date": "2016-12-20T02:14:27Z"}, "message": "Fix closure debuginfo.", "tree": {"sha": "b6f7bd728810fbb814b773d9b6a2f61af781dd87", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6f7bd728810fbb814b773d9b6a2f61af781dd87"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1d8806efd702ee396992677cd04ab40c329d5d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1d8806efd702ee396992677cd04ab40c329d5d7", "html_url": "https://github.com/rust-lang/rust/commit/e1d8806efd702ee396992677cd04ab40c329d5d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1d8806efd702ee396992677cd04ab40c329d5d7/comments", "author": {"login": "ahicks92", "id": 6968705, "node_id": "MDQ6VXNlcjY5Njg3MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/6968705?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahicks92", "html_url": "https://github.com/ahicks92", "followers_url": "https://api.github.com/users/ahicks92/followers", "following_url": "https://api.github.com/users/ahicks92/following{/other_user}", "gists_url": "https://api.github.com/users/ahicks92/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahicks92/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahicks92/subscriptions", "organizations_url": "https://api.github.com/users/ahicks92/orgs", "repos_url": "https://api.github.com/users/ahicks92/repos", "events_url": "https://api.github.com/users/ahicks92/events{/privacy}", "received_events_url": "https://api.github.com/users/ahicks92/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ahicks92", "id": 6968705, "node_id": "MDQ6VXNlcjY5Njg3MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/6968705?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahicks92", "html_url": "https://github.com/ahicks92", "followers_url": "https://api.github.com/users/ahicks92/followers", "following_url": "https://api.github.com/users/ahicks92/following{/other_user}", "gists_url": "https://api.github.com/users/ahicks92/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahicks92/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahicks92/subscriptions", "organizations_url": "https://api.github.com/users/ahicks92/orgs", "repos_url": "https://api.github.com/users/ahicks92/repos", "events_url": "https://api.github.com/users/ahicks92/events{/privacy}", "received_events_url": "https://api.github.com/users/ahicks92/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3f9823d5f53230e83b707b4876b5bb271a4c22ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f9823d5f53230e83b707b4876b5bb271a4c22ef", "html_url": "https://github.com/rust-lang/rust/commit/3f9823d5f53230e83b707b4876b5bb271a4c22ef"}], "stats": {"total": 14, "additions": 9, "deletions": 5}, "files": [{"sha": "94dc9a5fdb48946b308d3f29086044b1ec7bb0e1", "filename": "src/librustc_trans/mir/mod.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e1d8806efd702ee396992677cd04ab40c329d5d7/src%2Flibrustc_trans%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1d8806efd702ee396992677cd04ab40c329d5d7/src%2Flibrustc_trans%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fmir%2Fmod.rs?ref=e1d8806efd702ee396992677cd04ab40c329d5d7", "patch": "@@ -10,14 +10,13 @@\n \n use libc::c_uint;\n use llvm::{self, ValueRef};\n-use rustc::ty;\n+use rustc::ty::{self, layout};\n use rustc::mir;\n use rustc::mir::tcx::LvalueTy;\n use session::config::FullDebugInfo;\n use base;\n use common::{self, Block, BlockAndBuilder, CrateContext, FunctionContext, C_null};\n use debuginfo::{self, declare_local, DebugLoc, VariableAccess, VariableKind, FunctionDebugContext};\n-use machine;\n use type_of;\n \n use syntax_pos::{DUMMY_SP, NO_EXPANSION, COMMAND_LINE_EXPN, BytePos};\n@@ -494,10 +493,15 @@ fn arg_local_refs<'bcx, 'tcx>(bcx: &BlockAndBuilder<'bcx, 'tcx>,\n                 llval\n             };\n \n-            let llclosurety = type_of::type_of(bcx.ccx(), closure_ty);\n+            let layout = bcx.ccx().layout_of(closure_ty);\n+            let offsets = match *layout {\n+                layout::Univariant { ref variant, .. } => &variant.offsets[..],\n+                _ => bug!(\"Closures are only supposed to be Univariant\")\n+            };\n+\n             for (i, (decl, ty)) in mir.upvar_decls.iter().zip(upvar_tys).enumerate() {\n-                let byte_offset_of_var_in_env =\n-                    machine::llelement_offset(bcx.ccx(), llclosurety, i);\n+                let byte_offset_of_var_in_env = offsets[i].bytes();\n+\n \n                 let ops = unsafe {\n                     [llvm::LLVMRustDIBuilderCreateOpDeref(),"}]}