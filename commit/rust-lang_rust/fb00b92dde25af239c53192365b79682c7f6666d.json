{"sha": "fb00b92dde25af239c53192365b79682c7f6666d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZiMDBiOTJkZGUyNWFmMjM5YzUzMTkyMzY1Yjc5NjgyYzdmNjY2NmQ=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-03-30T14:20:27Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-03-30T14:29:43Z"}, "message": "internal: revive google_cpu_profile infra", "tree": {"sha": "4ddd8f38c780effbfd86bf1e5f4b0c2a6ae2ffa2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ddd8f38c780effbfd86bf1e5f4b0c2a6ae2ffa2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fb00b92dde25af239c53192365b79682c7f6666d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fb00b92dde25af239c53192365b79682c7f6666d", "html_url": "https://github.com/rust-lang/rust/commit/fb00b92dde25af239c53192365b79682c7f6666d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fb00b92dde25af239c53192365b79682c7f6666d/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8447ecf747f7488a904a47a53a770848e5beaf12", "url": "https://api.github.com/repos/rust-lang/rust/commits/8447ecf747f7488a904a47a53a770848e5beaf12", "html_url": "https://github.com/rust-lang/rust/commit/8447ecf747f7488a904a47a53a770848e5beaf12"}], "stats": {"total": 58, "additions": 46, "deletions": 12}, "files": [{"sha": "cae6caeaa669c034f69725d0e5847da6a773262a", "filename": "crates/profile/src/google_cpu_profiler.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fb00b92dde25af239c53192365b79682c7f6666d/crates%2Fprofile%2Fsrc%2Fgoogle_cpu_profiler.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb00b92dde25af239c53192365b79682c7f6666d/crates%2Fprofile%2Fsrc%2Fgoogle_cpu_profiler.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fprofile%2Fsrc%2Fgoogle_cpu_profiler.rs?ref=fb00b92dde25af239c53192365b79682c7f6666d", "patch": "@@ -14,26 +14,31 @@ extern \"C\" {\n     fn ProfilerStop();\n }\n \n-static PROFILER_STATE: AtomicUsize = AtomicUsize::new(OFF);\n const OFF: usize = 0;\n const ON: usize = 1;\n const PENDING: usize = 2;\n \n-pub fn start(path: &Path) {\n-    if PROFILER_STATE.compare_and_swap(OFF, PENDING, Ordering::SeqCst) != OFF {\n+fn transition(current: usize, new: usize) -> bool {\n+    static STATE: AtomicUsize = AtomicUsize::new(OFF);\n+\n+    STATE.compare_exchange(current, new, Ordering::SeqCst, Ordering::SeqCst).is_ok()\n+}\n+\n+pub(crate) fn start(path: &Path) {\n+    if !transition(OFF, PENDING) {\n         panic!(\"profiler already started\");\n     }\n     let path = CString::new(path.display().to_string()).unwrap();\n     if unsafe { ProfilerStart(path.as_ptr()) } == 0 {\n         panic!(\"profiler failed to start\")\n     }\n-    assert!(PROFILER_STATE.compare_and_swap(PENDING, ON, Ordering::SeqCst) == PENDING);\n+    assert!(transition(PENDING, ON));\n }\n \n-pub fn stop() {\n-    if PROFILER_STATE.compare_and_swap(ON, PENDING, Ordering::SeqCst) != ON {\n+pub(crate) fn stop() {\n+    if !transition(ON, PENDING) {\n         panic!(\"profiler is not started\")\n     }\n     unsafe { ProfilerStop() };\n-    assert!(PROFILER_STATE.compare_and_swap(PENDING, OFF, Ordering::SeqCst) == PENDING);\n+    assert!(transition(PENDING, OFF));\n }"}, {"sha": "a31fb8f4393771894545bcacf3331c798a0ad5d9", "filename": "crates/profile/src/lib.rs", "status": "modified", "additions": 32, "deletions": 5, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/fb00b92dde25af239c53192365b79682c7f6666d/crates%2Fprofile%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb00b92dde25af239c53192365b79682c7f6666d/crates%2Fprofile%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fprofile%2Fsrc%2Flib.rs?ref=fb00b92dde25af239c53192365b79682c7f6666d", "patch": "@@ -52,16 +52,25 @@ impl Drop for Scope {\n /// Usage:\n /// 1. Install gpref_tools (https://github.com/gperftools/gperftools), probably packaged with your Linux distro.\n /// 2. Build with `cpu_profiler` feature.\n-/// 3. Tun the code, the *raw* output would be in the `./out.profile` file.\n+/// 3. Run the code, the *raw* output would be in the `./out.profile` file.\n /// 4. Install pprof for visualization (https://github.com/google/pprof).\n /// 5. Bump sampling frequency to once per ms: `export CPUPROFILE_FREQUENCY=1000`\n /// 6. Use something like `pprof -svg target/release/rust-analyzer ./out.profile` to see the results.\n ///\n /// For example, here's how I run profiling on NixOS:\n ///\n /// ```bash\n-/// $ nix-shell -p gperftools --run \\\n-///     'cargo run --release -p rust-analyzer -- parse < ~/projects/rustbench/parser.rs > /dev/null'\n+/// $ bat -p shell.nix\n+/// with import <nixpkgs> {};\n+/// mkShell {\n+///   buildInputs = [ gperftools ];\n+///   shellHook = ''\n+///     export LD_LIBRARY_PATH=\"${gperftools}/lib:\"\n+///   '';\n+/// }\n+/// $ set -x CPUPROFILE_FREQUENCY 1000\n+/// $ nix-shell --run 'cargo test --release --package rust-analyzer --lib -- benchmarks::benchmark_integrated_highlighting --exact --nocapture'\n+/// $ pprof -svg target/release/deps/rust_analyzer-8739592dc93d63cb crates/rust-analyzer/out.profile > profile.svg\n /// ```\n ///\n /// See this diff for how to profile completions:\n@@ -81,7 +90,9 @@ pub fn cpu_span() -> CpuSpan {\n \n     #[cfg(not(feature = \"cpu_profiler\"))]\n     {\n-        eprintln!(\"cpu_profiler feature is disabled\")\n+        eprintln!(\n+            r#\"cpu profiling is disabled, uncomment `default = [ \"cpu_profiler\" ]` in Cargo.toml to enable.\"#\n+        )\n     }\n \n     CpuSpan { _private: () }\n@@ -91,7 +102,23 @@ impl Drop for CpuSpan {\n     fn drop(&mut self) {\n         #[cfg(feature = \"cpu_profiler\")]\n         {\n-            google_cpu_profiler::stop()\n+            google_cpu_profiler::stop();\n+            let profile_data = std::env::current_dir().unwrap().join(\"out.profile\");\n+            eprintln!(\"Profile data saved to:\\n\\n    {}\\n\", profile_data.display());\n+            let mut cmd = std::process::Command::new(\"pprof\");\n+            cmd.arg(\"-svg\").arg(std::env::current_exe().unwrap()).arg(&profile_data);\n+            let out = cmd.output();\n+\n+            match out {\n+                Ok(out) if out.status.success() => {\n+                    let svg = profile_data.with_extension(\"svg\");\n+                    std::fs::write(&svg, &out.stdout).unwrap();\n+                    eprintln!(\"Profile rendered to:\\n\\n    {}\\n\", svg.display());\n+                }\n+                _ => {\n+                    eprintln!(\"Failed to run:\\n\\n   {:?}\\n\", cmd);\n+                }\n+            }\n         }\n     }\n }"}, {"sha": "bf569b40bb6098de464d8c77ab7bdc0419f40edb", "filename": "crates/rust-analyzer/src/benchmarks.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb00b92dde25af239c53192365b79682c7f6666d/crates%2Frust-analyzer%2Fsrc%2Fbenchmarks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb00b92dde25af239c53192365b79682c7f6666d/crates%2Frust-analyzer%2Fsrc%2Fbenchmarks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbenchmarks.rs?ref=fb00b92dde25af239c53192365b79682c7f6666d", "patch": "@@ -51,6 +51,7 @@ fn benchmark_integrated_highlighting() {\n     }\n \n     profile::init_from(\"*>100\");\n+    // let _s = profile::heartbeat_span();\n \n     {\n         let _it = stdx::timeit(\"change\");\n@@ -63,6 +64,7 @@ fn benchmark_integrated_highlighting() {\n \n     {\n         let _it = stdx::timeit(\"after change\");\n+        let _span = profile::cpu_span();\n         let analysis = host.analysis();\n         analysis.highlight_as_html(file_id, false).unwrap();\n     }"}]}