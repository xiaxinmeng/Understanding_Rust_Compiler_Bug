{"sha": "09fc5e1dd7f8635d111c12e745cf782fe3b58d95", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5ZmM1ZTFkZDdmODYzNWQxMTFjMTJlNzQ1Y2Y3ODJmZTNiNThkOTU=", "commit": {"author": {"name": "Danny Zhu", "email": "dzhu@dzhu.us", "date": "2021-04-25T20:28:38Z"}, "committer": {"name": "Danny Zhu", "email": "dzhu@dzhu.us", "date": "2021-04-25T21:08:56Z"}, "message": "Check more carefully for cases where a rename can't be done\n\nAttempting to rename an element of a tuple field would previously\nreplace the type with the new name, which doesn't make sense; now it\nfails instead.\n\nThe check is done in both `prepare_rename` and `rename` so that the case\nis caught before the user is prompted for a new name. Some other\nexisting failure cases are also now additionally checked in\n`prepare_rename`.", "tree": {"sha": "d96e6a788638b64c3203b499f5f97985adab60f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d96e6a788638b64c3203b499f5f97985adab60f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/09fc5e1dd7f8635d111c12e745cf782fe3b58d95", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/09fc5e1dd7f8635d111c12e745cf782fe3b58d95", "html_url": "https://github.com/rust-lang/rust/commit/09fc5e1dd7f8635d111c12e745cf782fe3b58d95", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/09fc5e1dd7f8635d111c12e745cf782fe3b58d95/comments", "author": {"login": "dzhu", "id": 596106, "node_id": "MDQ6VXNlcjU5NjEwNg==", "avatar_url": "https://avatars.githubusercontent.com/u/596106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dzhu", "html_url": "https://github.com/dzhu", "followers_url": "https://api.github.com/users/dzhu/followers", "following_url": "https://api.github.com/users/dzhu/following{/other_user}", "gists_url": "https://api.github.com/users/dzhu/gists{/gist_id}", "starred_url": "https://api.github.com/users/dzhu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dzhu/subscriptions", "organizations_url": "https://api.github.com/users/dzhu/orgs", "repos_url": "https://api.github.com/users/dzhu/repos", "events_url": "https://api.github.com/users/dzhu/events{/privacy}", "received_events_url": "https://api.github.com/users/dzhu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dzhu", "id": 596106, "node_id": "MDQ6VXNlcjU5NjEwNg==", "avatar_url": "https://avatars.githubusercontent.com/u/596106?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dzhu", "html_url": "https://github.com/dzhu", "followers_url": "https://api.github.com/users/dzhu/followers", "following_url": "https://api.github.com/users/dzhu/following{/other_user}", "gists_url": "https://api.github.com/users/dzhu/gists{/gist_id}", "starred_url": "https://api.github.com/users/dzhu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dzhu/subscriptions", "organizations_url": "https://api.github.com/users/dzhu/orgs", "repos_url": "https://api.github.com/users/dzhu/repos", "events_url": "https://api.github.com/users/dzhu/events{/privacy}", "received_events_url": "https://api.github.com/users/dzhu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b4defd2409d6a6120b40a0730e9822a819e971d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b4defd2409d6a6120b40a0730e9822a819e971d", "html_url": "https://github.com/rust-lang/rust/commit/1b4defd2409d6a6120b40a0730e9822a819e971d"}], "stats": {"total": 111, "additions": 105, "deletions": 6}, "files": [{"sha": "2079c22a37e07144498b17470e9656e8380693bd", "filename": "crates/ide/src/display/navigation_target.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/09fc5e1dd7f8635d111c12e745cf782fe3b58d95/crates%2Fide%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09fc5e1dd7f8635d111c12e745cf782fe3b58d95/crates%2Fide%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdisplay%2Fnavigation_target.rs?ref=09fc5e1dd7f8635d111c12e745cf782fe3b58d95", "patch": "@@ -20,7 +20,7 @@ use syntax::{\n \n use crate::FileSymbol;\n \n-/// `NavigationTarget` represents and element in the editor's UI which you can\n+/// `NavigationTarget` represents an element in the editor's UI which you can\n /// click on to navigate to a particular piece of code.\n ///\n /// Typically, a `NavigationTarget` corresponds to some element in the source\n@@ -35,12 +35,10 @@ pub struct NavigationTarget {\n     /// Clients should use this range to answer \"is the cursor inside the\n     /// element?\" question.\n     pub full_range: TextRange,\n-    /// A \"most interesting\" range withing the `full_range`.\n+    /// A \"most interesting\" range within the `full_range`.\n     ///\n     /// Typically, `full_range` is the whole syntax node, including doc\n-    /// comments, and `focus_range` is the range of the identifier. \"Most\n-    /// interesting\" range within the full range, typically the range of\n-    /// identifier.\n+    /// comments, and `focus_range` is the range of the identifier.\n     ///\n     /// Clients should place the cursor on this range when navigating to this target.\n     pub focus_range: Option<TextRange>,"}, {"sha": "175e7a31d897811c8831b07612caca6a83f7482a", "filename": "crates/ide/src/references/rename.rs", "status": "modified", "additions": 102, "deletions": 1, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/09fc5e1dd7f8635d111c12e745cf782fe3b58d95/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09fc5e1dd7f8635d111c12e745cf782fe3b58d95/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences%2Frename.rs?ref=09fc5e1dd7f8635d111c12e745cf782fe3b58d95", "patch": "@@ -50,6 +50,17 @@ pub(crate) fn prepare_rename(\n     let sema = Semantics::new(db);\n     let source_file = sema.parse(position.file_id);\n     let syntax = source_file.syntax();\n+\n+    let def = find_definition(&sema, syntax, position)?;\n+    match def {\n+        Definition::SelfType(_) => bail!(\"Cannot rename `Self`\"),\n+        Definition::ModuleDef(ModuleDef::BuiltinType(_)) => bail!(\"Cannot rename builtin type\"),\n+        _ => {}\n+    };\n+    let nav =\n+        def.try_to_nav(sema.db).ok_or_else(|| format_err!(\"No references found at position\"))?;\n+    nav.focus_range.ok_or_else(|| format_err!(\"No identifier available to rename\"))?;\n+\n     let name_like = sema\n         .find_node_at_offset_with_descend(&syntax, position.offset)\n         .ok_or_else(|| format_err!(\"No references found at position\"))?;\n@@ -507,7 +518,8 @@ fn source_edit_from_def(\n         def.try_to_nav(sema.db).ok_or_else(|| format_err!(\"No references found at position\"))?;\n \n     let mut replacement_text = String::new();\n-    let mut repl_range = nav.focus_or_full_range();\n+    let mut repl_range =\n+        nav.focus_range.ok_or_else(|| format_err!(\"No identifier available to rename\"))?;\n     if let Definition::Local(local) = def {\n         if let Either::Left(pat) = local.source(sema.db).value {\n             if matches!(\n@@ -625,6 +637,49 @@ foo!(Foo$0);\",\n         check_prepare(r\"struct$0 Foo;\", expect![[r#\"No references found at position\"#]]);\n     }\n \n+    #[test]\n+    fn test_prepare_rename_tuple_field() {\n+        check_prepare(\n+            r#\"\n+struct Foo(i32);\n+\n+fn baz() {\n+    let mut x = Foo(4);\n+    x.0$0 = 5;\n+}\n+\"#,\n+            expect![[r#\"No identifier available to rename\"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn test_prepare_rename_builtin() {\n+        check_prepare(\n+            r#\"\n+fn foo() {\n+    let x: i32$0 = 0;\n+}\n+\"#,\n+            expect![[r#\"Cannot rename builtin type\"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn test_prepare_rename_self() {\n+        check_prepare(\n+            r#\"\n+struct Foo {}\n+\n+impl Foo {\n+    fn foo(self) -> Self$0 {\n+        self\n+    }\n+}\n+\"#,\n+            expect![[r#\"Cannot rename `Self`\"#]],\n+        );\n+    }\n+\n     #[test]\n     fn test_rename_to_underscore() {\n         check(\"_\", r#\"fn main() { let i$0 = 1; }\"#, r#\"fn main() { let _ = 1; }\"#);\n@@ -1787,4 +1842,50 @@ fn foo() {\n \"#,\n         )\n     }\n+\n+    #[test]\n+    fn test_rename_tuple_field() {\n+        check(\n+            \"foo\",\n+            r#\"\n+struct Foo(i32);\n+\n+fn baz() {\n+    let mut x = Foo(4);\n+    x.0$0 = 5;\n+}\n+\"#,\n+            \"error: No identifier available to rename\",\n+        );\n+    }\n+\n+    #[test]\n+    fn test_rename_builtin() {\n+        check(\n+            \"foo\",\n+            r#\"\n+fn foo() {\n+    let x: i32$0 = 0;\n+}\n+\"#,\n+            \"error: Cannot rename builtin type\",\n+        );\n+    }\n+\n+    #[test]\n+    fn test_rename_self() {\n+        check(\n+            \"foo\",\n+            r#\"\n+struct Foo {}\n+\n+impl Foo {\n+    fn foo(self) -> Self$0 {\n+        self\n+    }\n+}\n+\"#,\n+            \"error: Cannot rename `Self`\",\n+        );\n+    }\n }"}]}