{"sha": "f04f38d3d79c3cc51956bc530a34e32945cdb294", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYwNGYzOGQzZDc5YzNjYzUxOTU2YmM1MzBhMzRlMzI5NDVjZGIyOTQ=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-04-07T01:12:40Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-04-07T01:12:40Z"}, "message": "nameres: collect unnamed consts", "tree": {"sha": "130dca17ca576146796b1877a81e17def36f2f02", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/130dca17ca576146796b1877a81e17def36f2f02"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f04f38d3d79c3cc51956bc530a34e32945cdb294", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f04f38d3d79c3cc51956bc530a34e32945cdb294", "html_url": "https://github.com/rust-lang/rust/commit/f04f38d3d79c3cc51956bc530a34e32945cdb294", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f04f38d3d79c3cc51956bc530a34e32945cdb294/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e7ac2b830f692fd993a9b30b6be96a4206b8229", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e7ac2b830f692fd993a9b30b6be96a4206b8229", "html_url": "https://github.com/rust-lang/rust/commit/3e7ac2b830f692fd993a9b30b6be96a4206b8229"}], "stats": {"total": 43, "additions": 29, "deletions": 14}, "files": [{"sha": "08feee1e7d649d6cf58cc4a20072cebe2d0df08e", "filename": "crates/hir_def/src/item_scope.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f04f38d3d79c3cc51956bc530a34e32945cdb294/crates%2Fhir_def%2Fsrc%2Fitem_scope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f04f38d3d79c3cc51956bc530a34e32945cdb294/crates%2Fhir_def%2Fsrc%2Fitem_scope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_scope.rs?ref=f04f38d3d79c3cc51956bc530a34e32945cdb294", "patch": "@@ -11,7 +11,7 @@ use rustc_hash::{FxHashMap, FxHashSet};\n use stdx::format_to;\n \n use crate::{\n-    db::DefDatabase, per_ns::PerNs, visibility::Visibility, AdtId, BuiltinType, ImplId,\n+    db::DefDatabase, per_ns::PerNs, visibility::Visibility, AdtId, BuiltinType, ConstId, ImplId,\n     LocalModuleId, MacroDefId, ModuleDefId, ModuleId, TraitId,\n };\n \n@@ -37,6 +37,7 @@ pub struct ItemScope {\n \n     defs: Vec<ModuleDefId>,\n     impls: Vec<ImplId>,\n+    unnamed_consts: Vec<ConstId>,\n     /// Traits imported via `use Trait as _;`.\n     unnamed_trait_imports: FxHashMap<TraitId, Visibility>,\n     /// Macros visible in current module in legacy textual scope\n@@ -156,6 +157,10 @@ impl ItemScope {\n         self.impls.push(imp)\n     }\n \n+    pub(crate) fn define_unnamed_const(&mut self, konst: ConstId) {\n+        self.unnamed_consts.push(konst);\n+    }\n+\n     pub(crate) fn define_legacy_macro(&mut self, name: Name, mac: MacroDefId) {\n         self.legacy_macros.insert(name, mac);\n     }\n@@ -295,6 +300,7 @@ impl ItemScope {\n             unresolved,\n             defs,\n             impls,\n+            unnamed_consts,\n             unnamed_trait_imports,\n             legacy_macros,\n         } = self;\n@@ -304,6 +310,7 @@ impl ItemScope {\n         unresolved.shrink_to_fit();\n         defs.shrink_to_fit();\n         impls.shrink_to_fit();\n+        unnamed_consts.shrink_to_fit();\n         unnamed_trait_imports.shrink_to_fit();\n         legacy_macros.shrink_to_fit();\n     }"}, {"sha": "492d8c71ff83cd8970ac23aec3b8deec345ae566", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 21, "deletions": 13, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/f04f38d3d79c3cc51956bc530a34e32945cdb294/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f04f38d3d79c3cc51956bc530a34e32945cdb294/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=f04f38d3d79c3cc51956bc530a34e32945cdb294", "patch": "@@ -1163,19 +1163,27 @@ impl ModCollector<'_, '_> {\n                 }\n                 ModItem::Const(id) => {\n                     let it = &self.item_tree[id];\n-\n-                    if let Some(name) = &it.name {\n-                        def = Some(DefData {\n-                            id: ConstLoc {\n-                                container: module.into(),\n-                                id: ItemTreeId::new(self.file_id, id),\n-                            }\n-                            .intern(self.def_collector.db)\n-                            .into(),\n-                            name,\n-                            visibility: &self.item_tree[it.visibility],\n-                            has_constructor: false,\n-                        });\n+                    let const_id = ConstLoc {\n+                        container: module.into(),\n+                        id: ItemTreeId::new(self.file_id, id),\n+                    }\n+                    .intern(self.def_collector.db);\n+\n+                    match &it.name {\n+                        Some(name) => {\n+                            def = Some(DefData {\n+                                id: const_id.into(),\n+                                name,\n+                                visibility: &self.item_tree[it.visibility],\n+                                has_constructor: false,\n+                            });\n+                        }\n+                        None => {\n+                            // const _: T = ...;\n+                            self.def_collector.def_map.modules[self.module_id]\n+                                .scope\n+                                .define_unnamed_const(const_id);\n+                        }\n                     }\n                 }\n                 ModItem::Static(id) => {"}]}