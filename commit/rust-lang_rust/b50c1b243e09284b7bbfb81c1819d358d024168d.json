{"sha": "b50c1b243e09284b7bbfb81c1819d358d024168d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1MGMxYjI0M2UwOTI4NGI3YmJmYjgxYzE4MTlkMzU4ZDAyNDE2OGQ=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-11-06T13:17:40Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-11-19T21:42:46Z"}, "message": "Make const_eval_raw query return just an AllocId", "tree": {"sha": "60e5acbf4bfad1941db531f57f81bfe971d4575d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/60e5acbf4bfad1941db531f57f81bfe971d4575d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b50c1b243e09284b7bbfb81c1819d358d024168d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b50c1b243e09284b7bbfb81c1819d358d024168d", "html_url": "https://github.com/rust-lang/rust/commit/b50c1b243e09284b7bbfb81c1819d358d024168d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b50c1b243e09284b7bbfb81c1819d358d024168d/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39852cae2b7486a7fb15a90866b9ad0b7bb7615d", "url": "https://api.github.com/repos/rust-lang/rust/commits/39852cae2b7486a7fb15a90866b9ad0b7bb7615d", "html_url": "https://github.com/rust-lang/rust/commit/39852cae2b7486a7fb15a90866b9ad0b7bb7615d"}], "stats": {"total": 161, "additions": 97, "deletions": 64}, "files": [{"sha": "679107160a6fc4a4785d6aea8639d401363cdd4a", "filename": "src/librustc/ich/impls_ty.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_ty.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -317,6 +317,10 @@ impl_stable_hash_for!(\n         ByRef(id, alloc, offset),\n     }\n );\n+impl_stable_hash_for!(struct ::mir::interpret::RawConst<'tcx> {\n+    alloc_id,\n+    ty,\n+});\n \n impl_stable_hash_for! {\n     impl<Tag> for struct mir::interpret::Pointer<Tag> {"}, {"sha": "f1ac4b210583e6d935b6cc9983cf4284d798f171", "filename": "src/librustc/mir/interpret/error.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fmir%2Finterpret%2Ferror.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fmir%2Finterpret%2Ferror.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Ferror.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -16,7 +16,7 @@ use ty::{self, Ty, layout};\n use ty::layout::{Size, Align, LayoutError};\n use rustc_target::spec::abi::Abi;\n \n-use super::{Pointer, InboundsCheck, ScalarMaybeUndef};\n+use super::{RawConst, Pointer, InboundsCheck, ScalarMaybeUndef};\n \n use backtrace::Backtrace;\n \n@@ -46,6 +46,7 @@ impl ErrorHandled {\n     }\n }\n \n+pub type ConstEvalRawResult<'tcx> = Result<RawConst<'tcx>, ErrorHandled>;\n pub type ConstEvalResult<'tcx> = Result<&'tcx ty::Const<'tcx>, ErrorHandled>;\n \n #[derive(Clone, Debug, RustcEncodable, RustcDecodable)]"}, {"sha": "9369b6e56f1d018f3992c096ccc648da1dedcc62", "filename": "src/librustc/mir/interpret/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fmir%2Finterpret%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fmir%2Finterpret%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Fmod.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -22,10 +22,10 @@ mod pointer;\n \n pub use self::error::{\n     EvalError, EvalResult, EvalErrorKind, AssertMessage, ConstEvalErr, struct_error,\n-    FrameInfo, ConstEvalResult, ErrorHandled,\n+    FrameInfo, ConstEvalRawResult, ConstEvalResult, ErrorHandled,\n };\n \n-pub use self::value::{Scalar, ConstValue, ScalarMaybeUndef};\n+pub use self::value::{Scalar, ScalarMaybeUndef, RawConst, ConstValue};\n \n pub use self::allocation::{\n     InboundsCheck, Allocation, AllocationExtra,"}, {"sha": "4bcba9d54674e3f7f610b59ab4bfaa2c26170b01", "filename": "src/librustc/mir/interpret/value.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fmir%2Finterpret%2Fvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fmir%2Finterpret%2Fvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Fvalue.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -10,19 +10,28 @@\n \n use std::fmt;\n \n-use ty::layout::{HasDataLayout, Size};\n-use ty::subst::Substs;\n-use hir::def_id::DefId;\n+use crate::ty::{Ty, subst::Substs, layout::{HasDataLayout, Size}};\n+use crate::hir::def_id::DefId;\n \n use super::{EvalResult, Pointer, PointerArithmetic, Allocation, AllocId, sign_extend, truncate};\n \n+/// Represents the result of a raw const operation, pre-validation.\n+#[derive(Copy, Clone, Debug, Eq, PartialEq, RustcEncodable, RustcDecodable, Hash)]\n+pub struct RawConst<'tcx> {\n+    // the value lives here, at offset 0, and that allocation definitely is a `AllocType::Memory`\n+    // (so you can use `AllocMap::unwrap_memory`).\n+    pub alloc_id: AllocId,\n+    pub ty: Ty<'tcx>,\n+}\n+\n /// Represents a constant value in Rust. Scalar and ScalarPair are optimizations which\n /// matches the LocalValue optimizations for easy conversions between Value and ConstValue.\n #[derive(Copy, Clone, Debug, Eq, PartialEq, PartialOrd, Ord, RustcEncodable, RustcDecodable, Hash)]\n pub enum ConstValue<'tcx> {\n     /// Never returned from the `const_eval` query, but the HIR contains these frequently in order\n     /// to allow HIR creation to happen for everything before needing to be able to run constant\n     /// evaluation\n+    /// FIXME: The query should then return a type that does not even have this variant.\n     Unevaluated(DefId, &'tcx Substs<'tcx>),\n \n     /// Used only for types with layout::abi::Scalar ABI and ZSTs"}, {"sha": "22bd1e26ba3eea36d86e2e30da850cbd1c44b178", "filename": "src/librustc/ty/query/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -27,7 +27,7 @@ use middle::stability::{self, DeprecationEntry};\n use middle::lib_features::LibFeatures;\n use middle::lang_items::{LanguageItems, LangItem};\n use middle::exported_symbols::{SymbolExportLevel, ExportedSymbol};\n-use mir::interpret::ConstEvalResult;\n+use mir::interpret::{ConstEvalRawResult, ConstEvalResult};\n use mir::mono::CodegenUnit;\n use mir;\n use mir::interpret::GlobalId;\n@@ -309,7 +309,7 @@ define_queries! { <'tcx>\n         /// validation. Please add a comment to every use site explaining why using `const_eval`\n         /// isn't sufficient\n         [] fn const_eval_raw: const_eval_raw_dep_node(ty::ParamEnvAnd<'tcx, GlobalId<'tcx>>)\n-            -> ConstEvalResult<'tcx>,\n+            -> ConstEvalRawResult<'tcx>,\n \n         /// Results of evaluating const items or constants embedded in\n         /// other items (such as enum variant explicit discriminants)."}, {"sha": "4e727de535822dfd9af4a22d73a7201034f7fa96", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 24, "deletions": 22, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -31,8 +31,8 @@ use rustc::util::common::ErrorReported;\n use syntax::ast::Mutability;\n use syntax::source_map::{Span, DUMMY_SP};\n \n-use interpret::{self,\n-    PlaceTy, MemPlace, OpTy, Operand, Immediate, Scalar, ConstValue, Pointer,\n+use crate::interpret::{self,\n+    PlaceTy, MPlaceTy, MemPlace, OpTy, Operand, Immediate, Scalar, RawConst, ConstValue, Pointer,\n     EvalResult, EvalError, EvalErrorKind, GlobalId, EvalContext, StackPopCleanup,\n     Allocation, AllocId, MemoryKind,\n     snapshot, RefTracking,\n@@ -94,11 +94,13 @@ pub(crate) fn eval_promoted<'a, 'mir, 'tcx>(\n     cid: GlobalId<'tcx>,\n     mir: &'mir mir::Mir<'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n-) -> EvalResult<'tcx, OpTy<'tcx>> {\n+) -> EvalResult<'tcx, MPlaceTy<'tcx>> {\n     let mut ecx = mk_borrowck_eval_cx(tcx, cid.instance, mir, DUMMY_SP).unwrap();\n     eval_body_using_ecx(&mut ecx, cid, Some(mir), param_env)\n }\n \n+// FIXME: This thing is a bad hack. We should get rid of it.  Ideally constants are always\n+// in an allocation.\n pub fn op_to_const<'tcx>(\n     ecx: &CompileTimeEvalContext<'_, '_, 'tcx>,\n     op: OpTy<'tcx>,\n@@ -150,7 +152,7 @@ fn eval_body_and_ecx<'a, 'mir, 'tcx>(\n     cid: GlobalId<'tcx>,\n     mir: Option<&'mir mir::Mir<'tcx>>,\n     param_env: ty::ParamEnv<'tcx>,\n-) -> (EvalResult<'tcx, OpTy<'tcx>>, CompileTimeEvalContext<'a, 'mir, 'tcx>) {\n+) -> (EvalResult<'tcx, MPlaceTy<'tcx>>, CompileTimeEvalContext<'a, 'mir, 'tcx>) {\n     // we start out with the best span we have\n     // and try improving it down the road when more information is available\n     let span = tcx.def_span(cid.instance.def_id());\n@@ -166,7 +168,7 @@ fn eval_body_using_ecx<'mir, 'tcx>(\n     cid: GlobalId<'tcx>,\n     mir: Option<&'mir mir::Mir<'tcx>>,\n     param_env: ty::ParamEnv<'tcx>,\n-) -> EvalResult<'tcx, OpTy<'tcx>> {\n+) -> EvalResult<'tcx, MPlaceTy<'tcx>> {\n     debug!(\"eval_body_using_ecx: {:?}, {:?}\", cid, param_env);\n     let tcx = ecx.tcx.tcx;\n     let mut mir = match mir {\n@@ -206,7 +208,7 @@ fn eval_body_using_ecx<'mir, 'tcx>(\n     ecx.memory.intern_static(ret.ptr.to_ptr()?.alloc_id, mutability)?;\n \n     debug!(\"eval_body_using_ecx done: {:?}\", *ret);\n-    Ok(ret.into())\n+    Ok(ret)\n }\n \n impl<'tcx> Into<EvalError<'tcx>> for ConstEvalError {\n@@ -534,15 +536,17 @@ pub fn error_to_const_error<'a, 'mir, 'tcx>(\n     ConstEvalErr { error: error.kind, stacktrace, span: ecx.tcx.span }\n }\n \n-fn validate_const<'a, 'tcx>(\n+fn validate_and_turn_into_const<'a, 'tcx>(\n     tcx: ty::TyCtxt<'a, 'tcx, 'tcx>,\n-    constant: &'tcx ty::Const<'tcx>,\n+    constant: RawConst<'tcx>,\n     key: ty::ParamEnvAnd<'tcx, GlobalId<'tcx>>,\n ) -> ::rustc::mir::interpret::ConstEvalResult<'tcx> {\n     let cid = key.value;\n     let ecx = mk_eval_cx(tcx, cid.instance, key.param_env).unwrap();\n     let val = (|| {\n-        let op = ecx.const_to_op(constant)?;\n+        let op = ecx.raw_const_to_mplace(constant)?.into();\n+        // FIXME: Once the visitor infrastructure landed, change validation to\n+        // work directly on `MPlaceTy`.\n         let mut ref_tracking = RefTracking::new(op);\n         while let Some((op, path)) = ref_tracking.todo.pop() {\n             ecx.validate_operand(\n@@ -552,7 +556,10 @@ fn validate_const<'a, 'tcx>(\n                 /* const_mode */ true,\n             )?;\n         }\n-        Ok(constant)\n+        // Now that we validated, turn this into a proper constant\n+        let def_id = cid.instance.def.def_id();\n+        let normalize = tcx.is_static(def_id).is_none() && cid.promoted.is_none();\n+        op_to_const(&ecx, op, normalize)\n     })();\n \n     val.map_err(|error| {\n@@ -591,14 +598,14 @@ pub fn const_eval_provider<'a, 'tcx>(\n         }\n     }\n     tcx.const_eval_raw(key).and_then(|val| {\n-        validate_const(tcx, val, key)\n+        validate_and_turn_into_const(tcx, val, key)\n     })\n }\n \n pub fn const_eval_raw_provider<'a, 'tcx>(\n     tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     key: ty::ParamEnvAnd<'tcx, GlobalId<'tcx>>,\n-) -> ::rustc::mir::interpret::ConstEvalResult<'tcx> {\n+) -> ::rustc::mir::interpret::ConstEvalRawResult<'tcx> {\n     // Because the constant is computed twice (once per value of `Reveal`), we are at risk of\n     // reporting the same error twice here. To resolve this, we check whether we can evaluate the\n     // constant in the more restrictive `Reveal::UserFacing`, which most likely already was\n@@ -648,16 +655,11 @@ pub fn const_eval_raw_provider<'a, 'tcx>(\n     };\n \n     let (res, ecx) = eval_body_and_ecx(tcx, cid, None, key.param_env);\n-    res.and_then(|op| {\n-        let normalize = tcx.is_static(def_id).is_none() && cid.promoted.is_none();\n-        if !normalize {\n-            // Sanity check: These must always be a MemPlace\n-            match op.op {\n-                Operand::Indirect(_) => { /* all is good */ },\n-                Operand::Immediate(_) => bug!(\"const eval gave us an Immediate\"),\n-            }\n-        }\n-        op_to_const(&ecx, op, normalize)\n+    res.and_then(|place| {\n+        Ok(RawConst {\n+            alloc_id: place.to_ptr().expect(\"we allocated this ptr!\").alloc_id,\n+            ty: place.layout.ty\n+        })\n     }).map_err(|error| {\n         let err = error_to_const_error(&ecx, error);\n         // errors in statics are always emitted as fatal errors"}, {"sha": "7dd42c6664968c3099af4f802e700e1dacda6ea3", "filename": "src/librustc_mir/interpret/memory.rs", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Finterpret%2Fmemory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Finterpret%2Fmemory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fmemory.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -28,7 +28,7 @@ use rustc_data_structures::fx::{FxHashSet, FxHashMap};\n use syntax::ast::Mutability;\n \n use super::{\n-    Pointer, AllocId, Allocation, ConstValue, GlobalId, AllocationExtra, InboundsCheck,\n+    Pointer, AllocId, Allocation, GlobalId, AllocationExtra, InboundsCheck,\n     EvalResult, Scalar, EvalErrorKind, AllocType, PointerArithmetic,\n     Machine, AllocMap, MayLeak, ScalarMaybeUndef, ErrorHandled,\n };\n@@ -374,14 +374,11 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> Memory<'a, 'mir, 'tcx, M> {\n                 ErrorHandled::Reported => EvalErrorKind::ReferencedConstant.into(),\n                 ErrorHandled::TooGeneric => EvalErrorKind::TooGeneric.into(),\n             }\n-        }).map(|const_val| {\n-            if let ConstValue::ByRef(_, allocation, _) = const_val.val {\n-                // We got tcx memory. Let the machine figure out whether and how to\n-                // turn that into memory with the right pointer tag.\n-                M::adjust_static_allocation(allocation)\n-            } else {\n-                bug!(\"Matching on non-ByRef static\")\n-            }\n+        }).map(|raw_const| {\n+            let allocation = tcx.alloc_map.lock().unwrap_memory(raw_const.alloc_id);\n+            // We got tcx memory. Let the machine figure out whether and how to\n+            // turn that into memory with the right pointer tag.\n+            M::adjust_static_allocation(allocation)\n         })\n     }\n "}, {"sha": "16f1e487f59a1e40522c0b94e53b0053bb7ed0cb", "filename": "src/librustc_mir/interpret/operand.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Foperand.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -536,7 +536,8 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n     }\n \n     // Also used e.g. when miri runs into a constant.\n-    pub(super) fn const_value_to_op(\n+    // FIXME: Can we avoid converting with ConstValue and Const?  We should be using RawConst.\n+    fn const_value_to_op(\n         &self,\n         val: ConstValue<'tcx>,\n     ) -> EvalResult<'tcx, Operand<M::PointerTag>> {"}, {"sha": "104d66f7bde21c555e934d4c7b0bd4ac93f3f61d", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -20,12 +20,10 @@ use rustc::mir;\n use rustc::ty::{self, Ty};\n use rustc::ty::layout::{self, Size, Align, LayoutOf, TyLayout, HasDataLayout, VariantIdx};\n \n-use rustc::mir::interpret::{\n-    GlobalId, AllocId, Allocation, Scalar, EvalResult, Pointer, PointerArithmetic\n-};\n use super::{\n+    GlobalId, AllocId, Allocation, Scalar, EvalResult, Pointer, PointerArithmetic,\n     EvalContext, Machine, AllocMap, AllocationExtra,\n-    Immediate, ImmTy, ScalarMaybeUndef, Operand, OpTy, MemoryKind\n+    RawConst, Immediate, ImmTy, ScalarMaybeUndef, Operand, OpTy, MemoryKind\n };\n \n #[derive(Copy, Clone, Debug, Hash, PartialEq, Eq)]\n@@ -981,6 +979,19 @@ where\n         Ok(OpTy { op, layout: place.layout })\n     }\n \n+    pub fn raw_const_to_mplace(\n+        &self,\n+        raw: RawConst<'tcx>,\n+    ) -> EvalResult<'tcx, MPlaceTy<'tcx, M::PointerTag>> {\n+        // This must be an allocation in `tcx`\n+        assert!(self.tcx.alloc_map.lock().get(raw.alloc_id).is_some());\n+        let layout = self.layout_of(raw.ty)?;\n+        Ok(MPlaceTy::from_aligned_ptr(\n+            Pointer::new(raw.alloc_id, Size::ZERO).with_default_tag(),\n+            layout,\n+        ))\n+    }\n+\n     /// Turn a place with a `dyn Trait` type into a place with the actual dynamic type.\n     /// Also return some more information so drop doesn't have to run the same code twice.\n     pub(super) fn unpack_dyn_trait(&self, mplace: MPlaceTy<'tcx, M::PointerTag>)"}, {"sha": "6b8233c941e8bb90fb4e43bb76e4c73142016ca9", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -309,7 +309,7 @@ impl<'a, 'mir, 'tcx> ConstPropagator<'a, 'mir, 'tcx> {\n                     eval_promoted(this.tcx, cid, this.mir, this.param_env)\n                 })?;\n                 trace!(\"evaluated promoted {:?} to {:?}\", promoted, res);\n-                Some((res, source_info.span))\n+                Some((res.into(), source_info.span))\n             },\n             _ => None,\n         }"}, {"sha": "129177e9a1ae92b550c3f3e87e791797ef3a378e", "filename": "src/test/ui/consts/const-err4.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-err4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-err4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-err4.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -16,7 +16,7 @@ union Foo {\n \n enum Bar {\n     Boo = [unsafe { Foo { b: () }.a }; 4][3],\n-    //~^ ERROR evaluation of constant value failed\n+    //~^ ERROR it is undefined behavior to use this value\n }\n \n fn main() {"}, {"sha": "2f58712be28f671170beceae6c06b4e2d7635588", "filename": "src/test/ui/consts/const-err4.stderr", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-err4.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-err4.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-err4.stderr?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -1,8 +1,10 @@\n-error[E0080]: evaluation of constant value failed\n+error[E0080]: it is undefined behavior to use this value\n   --> $DIR/const-err4.rs:18:11\n    |\n LL |     Boo = [unsafe { Foo { b: () }.a }; 4][3],\n-   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ attempted to read undefined bytes\n+   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed: encountered uninitialized bytes, but expected initialized plain bits\n+   |\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n error: aborting due to previous error\n "}, {"sha": "cc5ddb4401644b8f7ad407070d43a9b4fea07d83", "filename": "src/test/ui/consts/const-eval/const-pointer-values-in-various-types.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst-pointer-values-in-various-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst-pointer-values-in-various-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst-pointer-values-in-various-types.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -37,7 +37,7 @@ fn main() {\n     //~^ ERROR it is undefined behavior to use this value\n \n     const I32_REF_U128_UNION: u128 = unsafe { Nonsense { int_32_ref: &3 }.uint_128 };\n-    //~^ ERROR any use of this value will cause an error\n+    //~^ ERROR it is undefined behavior to use this value\n \n     const I32_REF_I8_UNION: i8 = unsafe { Nonsense { int_32_ref: &3 }.int_8 };\n     //~^ ERROR any use of this value will cause an error\n@@ -52,7 +52,7 @@ fn main() {\n     //~^ ERROR it is undefined behavior to use this value\n \n     const I32_REF_I128_UNION: i128 = unsafe { Nonsense { int_32_ref: &3 }.int_128 };\n-    //~^ ERROR any use of this value will cause an error\n+    //~^ ERROR it is undefined behavior to use this value\n \n     const I32_REF_F32_UNION: f32 = unsafe { Nonsense { int_32_ref: &3 }.float_32 };\n     //~^ ERROR any use of this value will cause an error"}, {"sha": "60079193ee8e4917b03a5b274fea899fed0337fd", "filename": "src/test/ui/consts/const-eval/const-pointer-values-in-various-types.stderr", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst-pointer-values-in-various-types.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst-pointer-values-in-various-types.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst-pointer-values-in-various-types.stderr?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -40,11 +40,13 @@ LL |     const I32_REF_U64_UNION: u64 = unsafe { Nonsense { int_32_ref: &3 }.uin\n    |\n    = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n-error: any use of this value will cause an error\n+error[E0080]: it is undefined behavior to use this value\n   --> $DIR/const-pointer-values-in-various-types.rs:39:5\n    |\n LL |     const I32_REF_U128_UNION: u128 = unsafe { Nonsense { int_32_ref: &3 }.uint_128 };\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ attempted to read undefined bytes\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed: encountered uninitialized bytes, but expected initialized plain bits\n+   |\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n error: any use of this value will cause an error\n   --> $DIR/const-pointer-values-in-various-types.rs:42:5\n@@ -78,11 +80,13 @@ LL |     const I32_REF_I64_UNION: i64 = unsafe { Nonsense { int_32_ref: &3 }.int\n    |\n    = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n-error: any use of this value will cause an error\n+error[E0080]: it is undefined behavior to use this value\n   --> $DIR/const-pointer-values-in-various-types.rs:54:5\n    |\n LL |     const I32_REF_I128_UNION: i128 = unsafe { Nonsense { int_32_ref: &3 }.int_128 };\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ attempted to read undefined bytes\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed: encountered uninitialized bytes, but expected initialized plain bits\n+   |\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n error: any use of this value will cause an error\n   --> $DIR/const-pointer-values-in-various-types.rs:57:5"}, {"sha": "2bdad3af889dcf0f3a1bb409c959dc5d1e382b33", "filename": "src/test/ui/consts/const-eval/union-const-eval-field.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-const-eval-field.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-const-eval-field.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-const-eval-field.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -34,7 +34,8 @@ const fn read_field2() -> Field2 {\n }\n \n const fn read_field3() -> Field3 {\n-    const FIELD3: Field3 = unsafe { UNION.field3 }; //~ ERROR any use of this value\n+    const FIELD3: Field3 = unsafe { UNION.field3 };\n+    //~^ ERROR it is undefined behavior to use this value\n     FIELD3\n }\n "}, {"sha": "035a95a14c831ebcefe9c6579b5bd53b3e113b63", "filename": "src/test/ui/consts/const-eval/union-const-eval-field.stderr", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-const-eval-field.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-const-eval-field.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-const-eval-field.stderr?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -1,10 +1,11 @@\n-error: any use of this value will cause an error\n+error[E0080]: it is undefined behavior to use this value\n   --> $DIR/union-const-eval-field.rs:37:5\n    |\n-LL |     const FIELD3: Field3 = unsafe { UNION.field3 }; //~ ERROR any use of this value\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ attempted to read undefined bytes\n+LL |     const FIELD3: Field3 = unsafe { UNION.field3 };\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed: encountered uninitialized bytes, but expected initialized plain bits\n    |\n-   = note: #[deny(const_err)] on by default\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n error: aborting due to previous error\n \n+For more information about this error, try `rustc --explain E0080`."}, {"sha": "6bd63472b212a287805c5426772825c2c8f21c70", "filename": "src/test/ui/consts/const-eval/union-ice.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-ice.rs?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -20,7 +20,7 @@ union DummyUnion {\n \n const UNION: DummyUnion = DummyUnion { field1: 1065353216 };\n \n-const FIELD3: Field3 = unsafe { UNION.field3 }; //~ ERROR will cause an error\n+const FIELD3: Field3 = unsafe { UNION.field3 }; //~ ERROR it is undefined behavior to use this value\n \n const FIELD_PATH: Struct = Struct { //~ ERROR it is undefined behavior to use this value\n     a: 42,"}, {"sha": "a6b49e0cda3a317bc47433f90438943d9f3bc63b", "filename": "src/test/ui/consts/const-eval/union-ice.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-ice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b50c1b243e09284b7bbfb81c1819d358d024168d/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-ice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Funion-ice.stderr?ref=b50c1b243e09284b7bbfb81c1819d358d024168d", "patch": "@@ -1,10 +1,10 @@\n-error: any use of this value will cause an error\n+error[E0080]: it is undefined behavior to use this value\n   --> $DIR/union-ice.rs:23:1\n    |\n-LL | const FIELD3: Field3 = unsafe { UNION.field3 }; //~ ERROR will cause an error\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ attempted to read undefined bytes\n+LL | const FIELD3: Field3 = unsafe { UNION.field3 }; //~ ERROR it is undefined behavior to use this value\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed: encountered uninitialized bytes, but expected initialized plain bits\n    |\n-   = note: #[deny(const_err)] on by default\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rust compiler repository if you believe it should not be considered undefined behavior\n \n error[E0080]: it is undefined behavior to use this value\n   --> $DIR/union-ice.rs:25:1"}]}