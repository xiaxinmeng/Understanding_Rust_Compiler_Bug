{"sha": "1a0278e1d17f66ddc5975f38387746f85c6602ce", "node_id": "C_kwDOAAsO6NoAKDFhMDI3OGUxZDE3ZjY2ZGRjNTk3NWYzODM4Nzc0NmY4NWM2NjAyY2U", "commit": {"author": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2022-01-21T01:23:27Z"}, "committer": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2022-01-21T19:39:18Z"}, "message": "Work around missing code coverage data causing llvm-cov failures\n\nIf we do not add code coverage instrumentation to the `Body` of a\nfunction, then when we go to generate the function record for it, we\nwon't write any data and this later causes llvm-cov to fail when\nprocessing data for the entire coverage report.\n\nI've identified two main cases where we do not currently add code\ncoverage instrumentation to the `Body` of a function:\n\n  1. If the function has a single `BasicBlock` and it ends with a\n     `TerminatorKind::Unreachable`.\n\n  2. If the function is created using a proc macro of some kind.\n\nFor case 1, this typically not important as this most often occurs as\nthe result of function definitions that take or return uninhabited\ntypes. These kinds of functions, by definition, cannot even be called so\nthey logically should not be counted in code coverage statistics.\n\nFor case 2, I haven't looked into this very much but I've noticed while\ntesting this patch that (other than functions which are covered by case\n1) the skipped function coverage debug message is occasionally triggered\nin large crate graphs by functions generated from a proc macro. This may\nhave something to do with weird spans being generated by the proc macro\nbut this is just a guess.\n\nI think it's reasonable to land this change since currently, we fail to\ngenerate *any* results from llvm-cov when a function has no coverage\ninstrumentation applied to it. With this change, we get coverage data\nfor all functions other than the two cases discussed above.", "tree": {"sha": "89bfc7ad4c0a2ef14ca11f50a127d38874f3095e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/89bfc7ad4c0a2ef14ca11f50a127d38874f3095e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1a0278e1d17f66ddc5975f38387746f85c6602ce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1a0278e1d17f66ddc5975f38387746f85c6602ce", "html_url": "https://github.com/rust-lang/rust/commit/1a0278e1d17f66ddc5975f38387746f85c6602ce", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1a0278e1d17f66ddc5975f38387746f85c6602ce/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5e57faa78aa7661c6000204591558f6665f11abc", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e57faa78aa7661c6000204591558f6665f11abc", "html_url": "https://github.com/rust-lang/rust/commit/5e57faa78aa7661c6000204591558f6665f11abc"}], "stats": {"total": 74, "additions": 70, "deletions": 4}, "files": [{"sha": "3014d2f1930eef5210cf4d4f9e0ccf1c4ea270cb", "filename": "compiler/rustc_codegen_llvm/src/coverageinfo/mapgen.rs", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/1a0278e1d17f66ddc5975f38387746f85c6602ce/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmapgen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a0278e1d17f66ddc5975f38387746f85c6602ce/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmapgen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmapgen.rs?ref=1a0278e1d17f66ddc5975f38387746f85c6602ce", "patch": "@@ -9,6 +9,7 @@ use rustc_data_structures::fx::FxIndexSet;\n use rustc_hir::def::DefKind;\n use rustc_hir::def_id::DefIdSet;\n use rustc_llvm::RustString;\n+use rustc_middle::bug;\n use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use rustc_middle::mir::coverage::CodeRegion;\n use rustc_middle::ty::TyCtxt;\n@@ -76,10 +77,18 @@ pub fn finalize<'ll, 'tcx>(cx: &CodegenCx<'ll, 'tcx>) {\n         let coverage_mapping_buffer = llvm::build_byte_buffer(|coverage_mapping_buffer| {\n             mapgen.write_coverage_mapping(expressions, counter_regions, coverage_mapping_buffer);\n         });\n-        debug_assert!(\n-            !coverage_mapping_buffer.is_empty(),\n-            \"Every `FunctionCoverage` should have at least one counter\"\n-        );\n+\n+        if coverage_mapping_buffer.is_empty() {\n+            if function_coverage.is_used() {\n+                bug!(\n+                    \"A used function should have had coverage mapping data but did not: {}\",\n+                    mangled_function_name\n+                );\n+            } else {\n+                debug!(\"unused function had no coverage mapping data: {}\", mangled_function_name);\n+                continue;\n+            }\n+        }\n \n         function_data.push((mangled_function_name, source_hash, is_used, coverage_mapping_buffer));\n     }"}, {"sha": "a1655adedd44705fd962eb6b3cd5fee940a8ffe3", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.issue-93054.txt", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/1a0278e1d17f66ddc5975f38387746f85c6602ce/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.issue-93054.txt", "raw_url": "https://github.com/rust-lang/rust/raw/1a0278e1d17f66ddc5975f38387746f85c6602ce/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.issue-93054.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.issue-93054.txt?ref=1a0278e1d17f66ddc5975f38387746f85c6602ce", "patch": "@@ -0,0 +1,29 @@\n+    1|       |// Regression test for #93054: Functions using uninhabited types often only have a single,\n+    2|       |// unreachable basic block which doesn't get instrumented. This should not cause llvm-cov to fail.\n+    3|       |// Since these kinds functions can't be invoked anyway, it's ok to not have coverage data for them.\n+    4|       |\n+    5|       |// compile-flags: --edition=2021\n+    6|       |\n+    7|       |enum Never { }\n+    8|       |\n+    9|       |impl Never {\n+   10|       |    fn foo(self) {\n+   11|       |        match self { }\n+   12|       |        make().map(|never| match never { });\n+   13|       |    }\n+   14|       |\n+   15|       |    fn bar(&self) {\n+   16|       |        match *self { }\n+   17|       |    }\n+   18|       |}\n+   19|       |\n+   20|      0|async fn foo2(never: Never) {\n+   21|       |    match never { }\n+   22|       |}\n+   23|       |\n+   24|      0|fn make() -> Option<Never> {\n+   25|      0|    None\n+   26|      0|}\n+   27|       |\n+   28|      1|fn main() { }\n+"}, {"sha": "c160b3db03f8e49e35dd704fd247ca90b53c766c", "filename": "src/test/run-make-fulldeps/coverage/issue-93054.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/1a0278e1d17f66ddc5975f38387746f85c6602ce/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fissue-93054.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a0278e1d17f66ddc5975f38387746f85c6602ce/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fissue-93054.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fissue-93054.rs?ref=1a0278e1d17f66ddc5975f38387746f85c6602ce", "patch": "@@ -0,0 +1,28 @@\n+// Regression test for #93054: Functions using uninhabited types often only have a single,\n+// unreachable basic block which doesn't get instrumented. This should not cause llvm-cov to fail.\n+// Since these kinds functions can't be invoked anyway, it's ok to not have coverage data for them.\n+\n+// compile-flags: --edition=2021\n+\n+enum Never { }\n+\n+impl Never {\n+    fn foo(self) {\n+        match self { }\n+        make().map(|never| match never { });\n+    }\n+\n+    fn bar(&self) {\n+        match *self { }\n+    }\n+}\n+\n+async fn foo2(never: Never) {\n+    match never { }\n+}\n+\n+fn make() -> Option<Never> {\n+    None\n+}\n+\n+fn main() { }"}]}