{"sha": "4c37ad660714ab65d20226c743f686cf6174abc7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjMzdhZDY2MDcxNGFiNjVkMjAyMjZjNzQzZjY4NmNmNjE3NGFiYzc=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2016-05-17T16:51:45Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2016-09-23T15:01:04Z"}, "message": "Add attribute support to generic lifetime and type parameters.\n\nI am using `ThinAttributes` rather than a vector for attributes\nattached to generics, since I expect almost all lifetime and types\nparameters to not carry any attributes.", "tree": {"sha": "6c9f765283c1543b88b5c36958a0adf9df50824d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6c9f765283c1543b88b5c36958a0adf9df50824d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4c37ad660714ab65d20226c743f686cf6174abc7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4c37ad660714ab65d20226c743f686cf6174abc7", "html_url": "https://github.com/rust-lang/rust/commit/4c37ad660714ab65d20226c743f686cf6174abc7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4c37ad660714ab65d20226c743f686cf6174abc7/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2c53ea66bc1491ef125b35fa30c1cc890cde82c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2c53ea66bc1491ef125b35fa30c1cc890cde82c", "html_url": "https://github.com/rust-lang/rust/commit/f2c53ea66bc1491ef125b35fa30c1cc890cde82c"}], "stats": {"total": 99, "additions": 85, "deletions": 14}, "files": [{"sha": "c5765f159a9cff6d2a822309f804cd57206af1bd", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -121,6 +121,7 @@ impl fmt::Debug for Lifetime {\n /// A lifetime definition, e.g. `'a: 'b+'c+'d`\n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n pub struct LifetimeDef {\n+    pub attrs: ThinVec<Attribute>,\n     pub lifetime: Lifetime,\n     pub bounds: Vec<Lifetime>\n }\n@@ -370,6 +371,7 @@ pub type TyParamBounds = P<[TyParamBound]>;\n \n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n pub struct TyParam {\n+    pub attrs: ThinVec<Attribute>,\n     pub ident: Ident,\n     pub id: NodeId,\n     pub bounds: TyParamBounds,"}, {"sha": "b822599e941f1ad10bdd7ccae30ea8989c7273f2", "filename": "src/libsyntax/ext/build.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fext%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fext%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbuild.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -73,6 +73,7 @@ pub trait AstBuilder {\n     fn typaram(&self,\n                span: Span,\n                id: ast::Ident,\n+               attrs: Vec<ast::Attribute>,\n                bounds: ast::TyParamBounds,\n                default: Option<P<ast::Ty>>) -> ast::TyParam;\n \n@@ -83,6 +84,7 @@ pub trait AstBuilder {\n     fn lifetime_def(&self,\n                     span: Span,\n                     name: ast::Name,\n+                    attrs: Vec<ast::Attribute>,\n                     bounds: Vec<ast::Lifetime>)\n                     -> ast::LifetimeDef;\n \n@@ -452,11 +454,13 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n     fn typaram(&self,\n                span: Span,\n                id: ast::Ident,\n+               attrs: Vec<ast::Attribute>,\n                bounds: ast::TyParamBounds,\n                default: Option<P<ast::Ty>>) -> ast::TyParam {\n         ast::TyParam {\n             ident: id,\n             id: ast::DUMMY_NODE_ID,\n+            attrs: attrs.into(),\n             bounds: bounds,\n             default: default,\n             span: span\n@@ -503,9 +507,11 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n     fn lifetime_def(&self,\n                     span: Span,\n                     name: ast::Name,\n+                    attrs: Vec<ast::Attribute>,\n                     bounds: Vec<ast::Lifetime>)\n                     -> ast::LifetimeDef {\n         ast::LifetimeDef {\n+            attrs: attrs.into(),\n             lifetime: self.lifetime(span, name),\n             bounds: bounds\n         }"}, {"sha": "67372351b44d96b29171ec81c569759e62ac5d84", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -302,6 +302,9 @@ declare_features! (\n     // Used to identify the `compiler_builtins` crate\n     // rustc internal\n     (active, compiler_builtins, \"1.13.0\", None),\n+\n+    // Allows attributes on lifetime/type formal parameters in generics (RFC 1327)\n+    (active, generic_param_attrs, \"1.11.0\", Some(34761)),\n );\n \n declare_features! (\n@@ -1208,6 +1211,24 @@ impl<'a> Visitor for PostExpansionVisitor<'a> {\n \n         visit::walk_vis(self, vis)\n     }\n+\n+    fn visit_generics(&mut self, g: &ast::Generics) {\n+        for t in &g.ty_params {\n+            if !t.attrs.is_empty() {\n+                gate_feature_post!(&self, generic_param_attrs, t.attrs[0].span,\n+                                   \"attributes on type parameter bindings are experimental\");\n+            }\n+        }\n+        visit::walk_generics(self, g)\n+    }\n+\n+    fn visit_lifetime_def(&mut self, lifetime_def: &ast::LifetimeDef) {\n+        if !lifetime_def.attrs.is_empty() {\n+            gate_feature_post!(&self, generic_param_attrs, lifetime_def.attrs[0].span,\n+                               \"attributes on lifetime bindings are experimental\");\n+        }\n+        visit::walk_lifetime_def(self, lifetime_def)\n+    }\n }\n \n pub fn get_features(span_handler: &Handler, krate_attrs: &[ast::Attribute]) -> Features {"}, {"sha": "e28c67602c532a28bf6166fccbab19437fe7536e", "filename": "src/libsyntax/fold.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffold.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -662,8 +662,13 @@ pub fn noop_fold_ty_param_bound<T>(tpb: TyParamBound, fld: &mut T)\n }\n \n pub fn noop_fold_ty_param<T: Folder>(tp: TyParam, fld: &mut T) -> TyParam {\n-    let TyParam {id, ident, bounds, default, span} = tp;\n+    let TyParam {attrs, id, ident, bounds, default, span} = tp;\n+    let attrs: Vec<_> = attrs.into();\n     TyParam {\n+        attrs: attrs.into_iter()\n+            .flat_map(|x| fld.fold_attribute(x).into_iter())\n+            .collect::<Vec<_>>()\n+            .into(),\n         id: fld.new_id(id),\n         ident: ident,\n         bounds: fld.fold_bounds(bounds),\n@@ -687,7 +692,12 @@ pub fn noop_fold_lifetime<T: Folder>(l: Lifetime, fld: &mut T) -> Lifetime {\n \n pub fn noop_fold_lifetime_def<T: Folder>(l: LifetimeDef, fld: &mut T)\n                                          -> LifetimeDef {\n+    let attrs: Vec<_> = l.attrs.into();\n     LifetimeDef {\n+        attrs: attrs.into_iter()\n+            .flat_map(|x| fld.fold_attribute(x).into_iter())\n+            .collect::<Vec<_>>()\n+            .into(),\n         lifetime: fld.fold_lifetime(l.lifetime),\n         bounds: fld.fold_lifetimes(l.bounds),\n     }"}, {"sha": "fe5ff5c47b24895bc5bcd69f60271b35b56ab032", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 38, "deletions": 9, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -1184,7 +1184,7 @@ impl<'a> Parser<'a> {\n         let lo = self.span.lo;\n \n         let (name, node) = if self.eat_keyword(keywords::Type) {\n-            let TyParam {ident, bounds, default, ..} = self.parse_ty_param()?;\n+            let TyParam {ident, bounds, default, ..} = self.parse_ty_param(vec![])?;\n             self.expect(&token::Semi)?;\n             (ident, TraitItemKind::Type(bounds, default))\n         } else if self.is_const_item() {\n@@ -1923,10 +1923,22 @@ impl<'a> Parser<'a> {\n \n     /// Parses `lifetime_defs = [ lifetime_defs { ',' lifetime_defs } ]` where `lifetime_def  =\n     /// lifetime [':' lifetimes]`\n-    pub fn parse_lifetime_defs(&mut self) -> PResult<'a, Vec<ast::LifetimeDef>> {\n-\n+    ///\n+    /// If `followed_by_ty_params` is None, then we are in a context\n+    /// where only lifetime parameters are allowed, and thus we should\n+    /// error if we encounter attributes after the bound lifetimes.\n+    ///\n+    /// If `followed_by_ty_params` is Some(r), then there may be type\n+    /// parameter bindings after the lifetimes, so we should pass\n+    /// along the parsed attributes to be attached to the first such\n+    /// type parmeter.\n+    pub fn parse_lifetime_defs(&mut self,\n+                               followed_by_ty_params: Option<&mut Vec<ast::Attribute>>)\n+                               -> PResult<'a, Vec<ast::LifetimeDef>>\n+    {\n         let mut res = Vec::new();\n         loop {\n+            let attrs = self.parse_outer_attributes()?;\n             match self.token {\n                 token::Lifetime(_) => {\n                     let lifetime = self.parse_lifetime()?;\n@@ -1936,11 +1948,20 @@ impl<'a> Parser<'a> {\n                         } else {\n                             Vec::new()\n                         };\n-                    res.push(ast::LifetimeDef { lifetime: lifetime,\n+                    res.push(ast::LifetimeDef { attrs: attrs.into(),\n+                                                lifetime: lifetime,\n                                                 bounds: bounds });\n                 }\n \n                 _ => {\n+                    if let Some(recv) = followed_by_ty_params {\n+                        assert!(recv.is_empty());\n+                        *recv = attrs;\n+                    } else {\n+                        let msg = \"encountered trailing attributes after lifetime parameters\";\n+                        return Err(self.fatal(msg));\n+                    }\n+                    debug!(\"parse_lifetime_defs ret {:?}\", res);\n                     return Ok(res);\n                 }\n             }\n@@ -4238,7 +4259,7 @@ impl<'a> Parser<'a> {\n     }\n \n     /// Matches typaram = IDENT (`?` unbound)? optbounds ( EQ ty )?\n-    fn parse_ty_param(&mut self) -> PResult<'a, TyParam> {\n+    fn parse_ty_param(&mut self, preceding_attrs: Vec<ast::Attribute>) -> PResult<'a, TyParam> {\n         let span = self.span;\n         let ident = self.parse_ident()?;\n \n@@ -4252,6 +4273,7 @@ impl<'a> Parser<'a> {\n         };\n \n         Ok(TyParam {\n+            attrs: preceding_attrs.into(),\n             ident: ident,\n             id: ast::DUMMY_NODE_ID,\n             bounds: bounds,\n@@ -4272,11 +4294,18 @@ impl<'a> Parser<'a> {\n         let span_lo = self.span.lo;\n \n         if self.eat(&token::Lt) {\n-            let lifetime_defs = self.parse_lifetime_defs()?;\n+            let mut attrs = vec![];\n+            let lifetime_defs = self.parse_lifetime_defs(Some(&mut attrs))?;\n             let mut seen_default = false;\n+            let mut post_lifetime_attrs = Some(attrs);\n             let ty_params = self.parse_seq_to_gt(Some(token::Comma), |p| {\n                 p.forbid_lifetime()?;\n-                let ty_param = p.parse_ty_param()?;\n+                let attrs = match post_lifetime_attrs.as_mut() {\n+                    None => p.parse_outer_attributes()?,\n+                    Some(attrs) => mem::replace(attrs, vec![]),\n+                };\n+                post_lifetime_attrs = None;\n+                let ty_param = p.parse_ty_param(attrs)?;\n                 if ty_param.default.is_some() {\n                     seen_default = true;\n                 } else if seen_default {\n@@ -4433,7 +4462,7 @@ impl<'a> Parser<'a> {\n                     let bound_lifetimes = if self.eat_keyword(keywords::For) {\n                         // Higher ranked constraint.\n                         self.expect(&token::Lt)?;\n-                        let lifetime_defs = self.parse_lifetime_defs()?;\n+                        let lifetime_defs = self.parse_lifetime_defs(None)?;\n                         self.expect_gt()?;\n                         lifetime_defs\n                     } else {\n@@ -5006,7 +5035,7 @@ impl<'a> Parser<'a> {\n     fn parse_late_bound_lifetime_defs(&mut self) -> PResult<'a, Vec<ast::LifetimeDef>> {\n         if self.eat_keyword(keywords::For) {\n             self.expect(&token::Lt)?;\n-            let lifetime_defs = self.parse_lifetime_defs()?;\n+            let lifetime_defs = self.parse_lifetime_defs(None)?;\n             self.expect_gt()?;\n             Ok(lifetime_defs)\n         } else {"}, {"sha": "70864c3a6e67496659ad5287f54c58017f808637", "filename": "src/libsyntax/visit.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fvisit.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -201,6 +201,7 @@ pub fn walk_lifetime<V: Visitor>(visitor: &mut V, lifetime: &Lifetime) {\n pub fn walk_lifetime_def<V: Visitor>(visitor: &mut V, lifetime_def: &LifetimeDef) {\n     visitor.visit_lifetime(&lifetime_def.lifetime);\n     walk_list!(visitor, visit_lifetime, &lifetime_def.bounds);\n+    walk_list!(visitor, visit_attribute, &*lifetime_def.attrs);\n }\n \n pub fn walk_poly_trait_ref<V>(visitor: &mut V, trait_ref: &PolyTraitRef, _: &TraitBoundModifier)\n@@ -474,6 +475,7 @@ pub fn walk_generics<V: Visitor>(visitor: &mut V, generics: &Generics) {\n         visitor.visit_ident(param.span, param.ident);\n         walk_list!(visitor, visit_ty_param_bound, &param.bounds);\n         walk_list!(visitor, visit_ty, &param.default);\n+        walk_list!(visitor, visit_attribute, &*param.attrs);\n     }\n     walk_list!(visitor, visit_lifetime_def, &generics.lifetimes);\n     for predicate in &generics.where_clause.predicates {"}, {"sha": "bc47d8f4e613741977ac0dc0a52c3b78acd40aed", "filename": "src/libsyntax_ext/deriving/generic/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -536,7 +536,7 @@ impl<'a> TraitDef<'a> {\n                 bounds.push((*declared_bound).clone());\n             }\n \n-            cx.typaram(self.span, ty_param.ident, P::from_vec(bounds), None)\n+            cx.typaram(self.span, ty_param.ident, vec![], P::from_vec(bounds), None)\n         }));\n \n         // and similarly for where clauses"}, {"sha": "4749d082bc0ec3dcd0723e57a000862ed3e866f7", "filename": "src/libsyntax_ext/deriving/generic/ty.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c37ad660714ab65d20226c743f686cf6174abc7/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fty.rs?ref=4c37ad660714ab65d20226c743f686cf6174abc7", "patch": "@@ -194,6 +194,7 @@ impl<'a> Ty<'a> {\n fn mk_ty_param(cx: &ExtCtxt,\n                span: Span,\n                name: &str,\n+               attrs: &[ast::Attribute],\n                bounds: &[Path],\n                self_ident: Ident,\n                self_generics: &Generics)\n@@ -204,7 +205,7 @@ fn mk_ty_param(cx: &ExtCtxt,\n             cx.typarambound(path)\n         })\n         .collect();\n-    cx.typaram(span, cx.ident_of(name), bounds, None)\n+    cx.typaram(span, cx.ident_of(name), attrs.to_owned(), bounds, None)\n }\n \n fn mk_generics(lifetimes: Vec<ast::LifetimeDef>, ty_params: Vec<ast::TyParam>, span: Span)\n@@ -246,15 +247,15 @@ impl<'a> LifetimeBounds<'a> {\n                 let bounds = bounds.iter()\n                     .map(|b| cx.lifetime(span, cx.ident_of(*b).name))\n                     .collect();\n-                cx.lifetime_def(span, cx.ident_of(*lt).name, bounds)\n+                cx.lifetime_def(span, cx.ident_of(*lt).name, vec![], bounds)\n             })\n             .collect();\n         let ty_params = self.bounds\n             .iter()\n             .map(|t| {\n                 match *t {\n                     (ref name, ref bounds) => {\n-                        mk_ty_param(cx, span, *name, bounds, self_ty, self_generics)\n+                        mk_ty_param(cx, span, *name, &[], bounds, self_ty, self_generics)\n                     }\n                 }\n             })"}]}