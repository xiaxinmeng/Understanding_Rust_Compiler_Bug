{"sha": "20c64cc0e6a025179c68cb0e76e4eca5f986271d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIwYzY0Y2MwZTZhMDI1MTc5YzY4Y2IwZTc2ZTRlY2E1Zjk4NjI3MWQ=", "commit": {"author": {"name": "Alexander Gonzalez", "email": "alexfertel97@gmail.com", "date": "2021-07-23T02:08:28Z"}, "committer": {"name": "Alexander Gonzalez", "email": "alexfertel97@gmail.com", "date": "2021-07-27T22:29:22Z"}, "message": "feat: Extend the server with the hover_range capability", "tree": {"sha": "8ac17d19af5af3845c94b1a4225a5cae1b58fced", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ac17d19af5af3845c94b1a4225a5cae1b58fced"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/20c64cc0e6a025179c68cb0e76e4eca5f986271d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/20c64cc0e6a025179c68cb0e76e4eca5f986271d", "html_url": "https://github.com/rust-lang/rust/commit/20c64cc0e6a025179c68cb0e76e4eca5f986271d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/20c64cc0e6a025179c68cb0e76e4eca5f986271d/comments", "author": {"login": "alexfertel", "id": 22298999, "node_id": "MDQ6VXNlcjIyMjk4OTk5", "avatar_url": "https://avatars.githubusercontent.com/u/22298999?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexfertel", "html_url": "https://github.com/alexfertel", "followers_url": "https://api.github.com/users/alexfertel/followers", "following_url": "https://api.github.com/users/alexfertel/following{/other_user}", "gists_url": "https://api.github.com/users/alexfertel/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexfertel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexfertel/subscriptions", "organizations_url": "https://api.github.com/users/alexfertel/orgs", "repos_url": "https://api.github.com/users/alexfertel/repos", "events_url": "https://api.github.com/users/alexfertel/events{/privacy}", "received_events_url": "https://api.github.com/users/alexfertel/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexfertel", "id": 22298999, "node_id": "MDQ6VXNlcjIyMjk4OTk5", "avatar_url": "https://avatars.githubusercontent.com/u/22298999?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexfertel", "html_url": "https://github.com/alexfertel", "followers_url": "https://api.github.com/users/alexfertel/followers", "following_url": "https://api.github.com/users/alexfertel/following{/other_user}", "gists_url": "https://api.github.com/users/alexfertel/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexfertel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexfertel/subscriptions", "organizations_url": "https://api.github.com/users/alexfertel/orgs", "repos_url": "https://api.github.com/users/alexfertel/repos", "events_url": "https://api.github.com/users/alexfertel/events{/privacy}", "received_events_url": "https://api.github.com/users/alexfertel/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a2a0b7abb5f7de9675cd2b84287dc1e4156001b", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a2a0b7abb5f7de9675cd2b84287dc1e4156001b", "html_url": "https://github.com/rust-lang/rust/commit/6a2a0b7abb5f7de9675cd2b84287dc1e4156001b"}], "stats": {"total": 50, "additions": 44, "deletions": 6}, "files": [{"sha": "afa67f72bed6b8d85610b0ea87aea2d758615b59", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=20c64cc0e6a025179c68cb0e76e4eca5f986271d", "patch": "@@ -241,6 +241,13 @@ fn try_hover_for_lint(attr: &ast::Attr, token: &SyntaxToken) -> Option<RangeInfo\n     ))\n }\n \n+pub(crate) fn hover_range(\n+    db: &RootDatabase,\n+    range: FileRange,\n+    config: &HoverConfig,\n+) -> Option<RangeInfo<HoverResult>> {\n+}\n+\n fn show_implementations_action(db: &RootDatabase, def: Definition) -> Option<HoverAction> {\n     fn to_action(nav_target: NavigationTarget) -> HoverAction {\n         HoverAction::Implementation(FilePosition {"}, {"sha": "b6b741a22ab6e1b5124899d8cdc0f0f4818497ee", "filename": "crates/ide/src/lib.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Fide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Fide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Flib.rs?ref=20c64cc0e6a025179c68cb0e76e4eca5f986271d", "patch": "@@ -423,6 +423,15 @@ impl Analysis {\n         self.with_db(|db| hover::hover(db, position, config))\n     }\n \n+    /// Returns a short text displaying the type for the expression.\n+    pub fn hover_range(\n+        &self,\n+        config: &HoverConfig,\n+        range: FileRange,\n+    ) -> Cancellable<Option<RangeInfo<HoverResult>>> {\n+        self.with_db(|db| hover::hover_range(db, range, config))\n+    }\n+\n     /// Return URL(s) for the documentation of the symbol under the cursor.\n     pub fn external_docs(\n         &self,"}, {"sha": "ede3103abfa00aa83559613484e942bd6b1ae446", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=20c64cc0e6a025179c68cb0e76e4eca5f986271d", "patch": "@@ -867,14 +867,29 @@ pub(crate) fn handle_signature_help(\n \n pub(crate) fn handle_hover(\n     snap: GlobalStateSnapshot,\n-    params: lsp_types::HoverParams,\n+    params: lsp_ext::HoverParams,\n ) -> Result<Option<lsp_ext::Hover>> {\n     let _p = profile::span(\"handle_hover\");\n-    let position = from_proto::file_position(&snap, params.text_document_position_params)?;\n-    let info = match snap.analysis.hover(&snap.config.hover(), position)? {\n-        None => return Ok(None),\n-        Some(info) => info,\n+    let file_id = from_proto::file_id(&snap, &params.text_document.uri)?;\n+    let range = from_proto::file_range(&snap, params.text_document, params.range)?;\n+\n+    let info = if range.end - range.start == 1 {\n+        // It's a hover over a position\n+        match snap\n+            .analysis\n+            .hover(&snap.config.hover(), FilePosition { file_id, offset: range.start })?\n+        {\n+            None => return Ok(None),\n+            Some(info) => info,\n+        }\n+    } else {\n+        // It's a hover over a range\n+        match snap.analysis.hover_range(&snap.config.hover(), range)? {\n+            None => return Ok(None),\n+            Some(info) => info,\n+        }\n     };\n+\n     let line_index = snap.file_line_index(position.file_id)?;\n     let range = to_proto::range(&line_index, info.range);\n     let hover = lsp_ext::Hover {"}, {"sha": "f6abd95e1e6c10fbd22f2994ab29099eaa5d60ba", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20c64cc0e6a025179c68cb0e76e4eca5f986271d/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=20c64cc0e6a025179c68cb0e76e4eca5f986271d", "patch": "@@ -376,11 +376,18 @@ pub struct SnippetTextEdit {\n pub enum HoverRequest {}\n \n impl Request for HoverRequest {\n-    type Params = lsp_types::HoverParams;\n+    type Params = HoverParams;\n     type Result = Option<Hover>;\n     const METHOD: &'static str = \"textDocument/hover\";\n }\n \n+#[derive(Deserialize, Serialize, Debug)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct HoverParams {\n+    pub text_document: TextDocumentIdentifier,\n+    pub range: Range,\n+}\n+\n #[derive(Debug, PartialEq, Clone, Deserialize, Serialize)]\n pub struct Hover {\n     #[serde(flatten)]"}]}