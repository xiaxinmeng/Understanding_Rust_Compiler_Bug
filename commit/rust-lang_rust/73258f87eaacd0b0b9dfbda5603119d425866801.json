{"sha": "73258f87eaacd0b0b9dfbda5603119d425866801", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczMjU4Zjg3ZWFhY2QwYjBiOWRmYmRhNTYwMzExOWQ0MjU4NjY4MDE=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-10-01T00:13:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-01T00:13:43Z"}, "message": "Rollup merge of #77324 - Aaron1011:fix/const-item-mutation-ptr, r=petrochenkov\n\nDon't fire `const_item_mutation` lint on writes through a pointer\n\nFixes #77321", "tree": {"sha": "31aa5f750ef0946fafb3fce16da249e101382487", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/31aa5f750ef0946fafb3fce16da249e101382487"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/73258f87eaacd0b0b9dfbda5603119d425866801", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfdR83CRBK7hj4Ov3rIwAAdHIIAH+1zSmr2NcCO/GIuIYqGmvi\n+vC6rd15q/JcJZjw8EcoqitB/nNcBCGFNhQcLBx/l3LcWEe9y0koCOBwc1l+Y2H/\nmolJMDNE1jgTVyseBWEEV4j5HAiIAMA4UvMZLM5fHkuB6+HPqBAmboogZ3Ae1r1R\nv/W1WYDPn3Ce+Kq78J8Am0eLlgP1EQjp8soyXPQCWKc8SXyVHr6v5XD9ipIBfeu7\nswUfHVR7YUZvON8VfXfS8xAAUheg7NlC5C2sI26Z5aMRi3zVH6Xr8ZPPNRAXXas6\nYaDeWD8iUtCQRy4z+tk4yomhBbESDIbkeToXe5SSkLuQqQUH3m2dT397LtkOCrE=\n=dWJW\n-----END PGP SIGNATURE-----\n", "payload": "tree 31aa5f750ef0946fafb3fce16da249e101382487\nparent 0044a9c08478d54047abc812a86220cd33f5f120\nparent c6107c53d72250d8c1d41f161ce54648bef4d9d2\nauthor Dylan DPC <dylan.dpc@gmail.com> 1601511223 +0200\ncommitter GitHub <noreply@github.com> 1601511223 +0200\n\nRollup merge of #77324 - Aaron1011:fix/const-item-mutation-ptr, r=petrochenkov\n\nDon't fire `const_item_mutation` lint on writes through a pointer\n\nFixes #77321\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/73258f87eaacd0b0b9dfbda5603119d425866801", "html_url": "https://github.com/rust-lang/rust/commit/73258f87eaacd0b0b9dfbda5603119d425866801", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/73258f87eaacd0b0b9dfbda5603119d425866801/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0044a9c08478d54047abc812a86220cd33f5f120", "url": "https://api.github.com/repos/rust-lang/rust/commits/0044a9c08478d54047abc812a86220cd33f5f120", "html_url": "https://github.com/rust-lang/rust/commit/0044a9c08478d54047abc812a86220cd33f5f120"}, {"sha": "c6107c53d72250d8c1d41f161ce54648bef4d9d2", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6107c53d72250d8c1d41f161ce54648bef4d9d2", "html_url": "https://github.com/rust-lang/rust/commit/c6107c53d72250d8c1d41f161ce54648bef4d9d2"}], "stats": {"total": 73, "additions": 44, "deletions": 29}, "files": [{"sha": "0281c478a6ca06fbee0bb8331bada6183114ae54", "filename": "compiler/rustc_mir/src/transform/check_const_item_mutation.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/73258f87eaacd0b0b9dfbda5603119d425866801/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/73258f87eaacd0b0b9dfbda5603119d425866801/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs?ref=73258f87eaacd0b0b9dfbda5603119d425866801", "patch": "@@ -60,11 +60,15 @@ impl<'a, 'tcx> Visitor<'tcx> for ConstMutationChecker<'a, 'tcx> {\n             // so emitting a lint would be redundant.\n             if !lhs.projection.is_empty() {\n                 if let Some(def_id) = self.is_const_item(lhs.local) {\n-                    self.lint_const_item_usage(def_id, loc, |lint| {\n-                        let mut lint = lint.build(\"attempting to modify a `const` item\");\n-                        lint.note(\"each usage of a `const` item creates a new temporary - the original `const` item will not be modified\");\n-                        lint\n-                    })\n+                    // Don't lint on writes through a pointer\n+                    // (e.g. `unsafe { *FOO = 0; *BAR.field = 1; }`)\n+                    if !matches!(lhs.projection.last(), Some(PlaceElem::Deref)) {\n+                        self.lint_const_item_usage(def_id, loc, |lint| {\n+                            let mut lint = lint.build(\"attempting to modify a `const` item\");\n+                            lint.note(\"each usage of a `const` item creates a new temporary - the original `const` item will not be modified\");\n+                            lint\n+                        })\n+                    }\n                 }\n             }\n             // We are looking for MIR of the form:"}, {"sha": "43371560e02c1d3e4eaae76ffd0f05727daf25b5", "filename": "src/test/ui/lint/lint-const-item-mutation.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/73258f87eaacd0b0b9dfbda5603119d425866801/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/73258f87eaacd0b0b9dfbda5603119d425866801/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs?ref=73258f87eaacd0b0b9dfbda5603119d425866801", "patch": "@@ -3,13 +3,15 @@\n struct MyStruct {\n     field: bool,\n     inner_array: [char; 1],\n+    raw_ptr: *mut u8\n }\n impl MyStruct {\n     fn use_mut(&mut self) {}\n }\n \n const ARRAY: [u8; 1] = [25];\n-const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'] };\n+const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n+const RAW_PTR: *mut u8 = 1 as *mut u8;\n \n fn main() {\n     ARRAY[0] = 5; //~ WARN attempting to modify\n@@ -18,4 +20,13 @@ fn main() {\n     MY_STRUCT.use_mut(); //~ WARN taking\n     &mut MY_STRUCT; //~ WARN taking\n     (&mut MY_STRUCT).use_mut(); //~ WARN taking\n+\n+    // Test that we don't warn when writing through\n+    // a raw pointer\n+    // This is U.B., but this test is check-pass,\n+    // so this never actually executes\n+    unsafe {\n+        *RAW_PTR = 0;\n+        *MY_STRUCT.raw_ptr = 0;\n+    }\n }"}, {"sha": "c5a221128ffaba262590a7d29e3b6224ae4a5fce", "filename": "src/test/ui/lint/lint-const-item-mutation.stderr", "status": "modified", "additions": 23, "deletions": 23, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/73258f87eaacd0b0b9dfbda5603119d425866801/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/73258f87eaacd0b0b9dfbda5603119d425866801/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr?ref=73258f87eaacd0b0b9dfbda5603119d425866801", "patch": "@@ -1,89 +1,89 @@\n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:15:5\n+  --> $DIR/lint-const-item-mutation.rs:17:5\n    |\n LL |     ARRAY[0] = 5;\n    |     ^^^^^^^^^^^^\n    |\n    = note: `#[warn(const_item_mutation)]` on by default\n    = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n note: `const` item defined here\n-  --> $DIR/lint-const-item-mutation.rs:11:1\n+  --> $DIR/lint-const-item-mutation.rs:12:1\n    |\n LL | const ARRAY: [u8; 1] = [25];\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:16:5\n+  --> $DIR/lint-const-item-mutation.rs:18:5\n    |\n LL |     MY_STRUCT.field = false;\n    |     ^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n note: `const` item defined here\n-  --> $DIR/lint-const-item-mutation.rs:12:1\n+  --> $DIR/lint-const-item-mutation.rs:13:1\n    |\n-LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'] };\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:17:5\n+  --> $DIR/lint-const-item-mutation.rs:19:5\n    |\n LL |     MY_STRUCT.inner_array[0] = 'b';\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n note: `const` item defined here\n-  --> $DIR/lint-const-item-mutation.rs:12:1\n+  --> $DIR/lint-const-item-mutation.rs:13:1\n    |\n-LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'] };\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:18:5\n+  --> $DIR/lint-const-item-mutation.rs:20:5\n    |\n LL |     MY_STRUCT.use_mut();\n    |     ^^^^^^^^^^^^^^^^^^^\n    |\n    = note: each usage of a `const` item creates a new temporary\n    = note: the mutable reference will refer to this temporary, not the original `const` item\n note: mutable reference created due to call to this method\n-  --> $DIR/lint-const-item-mutation.rs:8:5\n+  --> $DIR/lint-const-item-mutation.rs:9:5\n    |\n LL |     fn use_mut(&mut self) {}\n    |     ^^^^^^^^^^^^^^^^^^^^^\n note: `const` item defined here\n-  --> $DIR/lint-const-item-mutation.rs:12:1\n+  --> $DIR/lint-const-item-mutation.rs:13:1\n    |\n-LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'] };\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:19:5\n+  --> $DIR/lint-const-item-mutation.rs:21:5\n    |\n LL |     &mut MY_STRUCT;\n    |     ^^^^^^^^^^^^^^\n    |\n    = note: each usage of a `const` item creates a new temporary\n    = note: the mutable reference will refer to this temporary, not the original `const` item\n note: `const` item defined here\n-  --> $DIR/lint-const-item-mutation.rs:12:1\n+  --> $DIR/lint-const-item-mutation.rs:13:1\n    |\n-LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'] };\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:20:5\n+  --> $DIR/lint-const-item-mutation.rs:22:5\n    |\n LL |     (&mut MY_STRUCT).use_mut();\n    |     ^^^^^^^^^^^^^^^^\n    |\n    = note: each usage of a `const` item creates a new temporary\n    = note: the mutable reference will refer to this temporary, not the original `const` item\n note: `const` item defined here\n-  --> $DIR/lint-const-item-mutation.rs:12:1\n+  --> $DIR/lint-const-item-mutation.rs:13:1\n    |\n-LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'] };\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: 6 warnings emitted\n "}]}