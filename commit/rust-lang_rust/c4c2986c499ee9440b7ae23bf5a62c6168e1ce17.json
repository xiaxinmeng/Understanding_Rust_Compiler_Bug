{"sha": "c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0YzI5ODZjNDk5ZWU5NDQwYjdhZTIzYmY1YTYyYzYxNjhlMWNlMTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-08T07:15:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-08T07:15:48Z"}, "message": "Auto merge of #87815 - BoxyUwU:cec-generics-of-ice, r=eddyb\n\nencode `generics_of` for fields and ty params\n\nFixes #87674\nFixes #87603\n\nICE was caused by calling `generics_of` on a `DefId` without any `generics_of` results. This was happening when we call `generics_of` on parent `DefId`s of an unevaluated const when we evaluate it.\n\nr? `@lcnr`", "tree": {"sha": "1e2f367baacd72f1fecd2e17f9ed28240ddfa345", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1e2f367baacd72f1fecd2e17f9ed28240ddfa345"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "html_url": "https://github.com/rust-lang/rust/commit/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d10c2a3302d53e10a4ad3ac581103faaae9eeb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d10c2a3302d53e10a4ad3ac581103faaae9eeb6", "html_url": "https://github.com/rust-lang/rust/commit/2d10c2a3302d53e10a4ad3ac581103faaae9eeb6"}, {"sha": "8ff2eccd80248030d66c7f4466935df85dfa36b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ff2eccd80248030d66c7f4466935df85dfa36b0", "html_url": "https://github.com/rust-lang/rust/commit/8ff2eccd80248030d66c7f4466935df85dfa36b0"}], "stats": {"total": 85, "additions": 83, "deletions": 2}, "files": [{"sha": "b7921c403bb7bd44a9f27ae6f3c84f32dd4d74d9", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "patch": "@@ -918,12 +918,12 @@ fn should_encode_generics(def_kind: DefKind) -> bool {\n         | DefKind::AnonConst\n         | DefKind::OpaqueTy\n         | DefKind::Impl\n+        | DefKind::Field\n+        | DefKind::TyParam\n         | DefKind::Closure\n         | DefKind::Generator => true,\n         DefKind::Mod\n-        | DefKind::Field\n         | DefKind::ForeignMod\n-        | DefKind::TyParam\n         | DefKind::ConstParam\n         | DefKind::Macro(..)\n         | DefKind::Use"}, {"sha": "576276d902d60468f1d9c9a603d01f4ee2f2c117", "filename": "src/test/ui/const-generics/auxiliary/generics_of_parent.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fauxiliary%2Fgenerics_of_parent.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fauxiliary%2Fgenerics_of_parent.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fauxiliary%2Fgenerics_of_parent.rs?ref=c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "patch": "@@ -0,0 +1,23 @@\n+#![feature(const_generics, const_evaluatable_checked)]\n+#![allow(incomplete_features)]\n+\n+// library portion of regression test for #87674\n+pub struct Foo<const N: usize>([(); N + 1])\n+where\n+    [(); N + 1]: ;\n+\n+// library portion of regression test for #87603\n+pub struct S<T: Copy + Default, const N: usize>\n+where\n+    [T; N * 2]: Sized,\n+{\n+    pub s: [T; N * 2],\n+}\n+impl<T: Default + Copy, const N: usize> S<T, N>\n+where\n+    [T; N * 2]: Sized,\n+{\n+    pub fn test() -> Self {\n+        S { s: [T::default(); N * 2] }\n+    }\n+}"}, {"sha": "0d03f56854a77f7ee398af38702b5ac3b61fde45", "filename": "src/test/ui/const-generics/auxiliary/generics_of_parent_impl_trait.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fauxiliary%2Fgenerics_of_parent_impl_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fauxiliary%2Fgenerics_of_parent_impl_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fauxiliary%2Fgenerics_of_parent_impl_trait.rs?ref=c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "patch": "@@ -0,0 +1,8 @@\n+#![feature(const_generics, const_evaluatable_checked)]\n+#![allow(incomplete_features)]\n+\n+// library portion of testing that `impl Trait<{ expr }>` doesnt\n+// ice because of a `DefKind::TyParam` parent\n+pub fn foo<const N: usize>(foo: impl Into<[(); N + 1]>) {\n+    foo.into();\n+}"}, {"sha": "31be8e7d111c73f55f6bbd96257a28c268f78b4e", "filename": "src/test/ui/const-generics/parent_generics_of_encoding.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding.rs?ref=c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "patch": "@@ -0,0 +1,25 @@\n+// aux-build:generics_of_parent.rs\n+// check-pass\n+#![feature(const_generics, const_evaluatable_checked)]\n+#![allow(incomplete_features)]\n+\n+extern crate generics_of_parent;\n+\n+use generics_of_parent::{Foo, S};\n+\n+fn main() {\n+    // regression test for #87603\n+    const N: usize = 2;\n+    let x: S<u8, N> = S::test();\n+}\n+\n+// regression test for #87674\n+fn new<U>(a: U) -> U {\n+    a\n+}\n+fn foo<const N: usize>(bar: &mut Foo<N>)\n+where\n+    [(); N + 1]: ,\n+{\n+    *bar = new(loop {});\n+}"}, {"sha": "988777b1c90c1d31baf6c11882bcc4d3b86acf1b", "filename": "src/test/ui/const-generics/parent_generics_of_encoding_impl_trait.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding_impl_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding_impl_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding_impl_trait.rs?ref=c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "patch": "@@ -0,0 +1,11 @@\n+// aux-build:generics_of_parent_impl_trait.rs\n+#![feature(const_generics, const_evaluatable_checked)]\n+#![allow(incomplete_features)]\n+\n+extern crate generics_of_parent_impl_trait;\n+\n+fn main() {\n+    // check for `impl Trait<{ const }>` which has a parent of a `DefKind::TyParam`\n+    generics_of_parent_impl_trait::foo([()]);\n+    //~^ error: type annotations needed:\n+}"}, {"sha": "6c0d5c4f079605d8411e4cd3907c77ab6e304c04", "filename": "src/test/ui/const-generics/parent_generics_of_encoding_impl_trait.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding_impl_trait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4c2986c499ee9440b7ae23bf5a62c6168e1ce17/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding_impl_trait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fparent_generics_of_encoding_impl_trait.stderr?ref=c4c2986c499ee9440b7ae23bf5a62c6168e1ce17", "patch": "@@ -0,0 +1,14 @@\n+error[E0284]: type annotations needed: cannot satisfy `the constant `foo::{opaque#0}::{constant#0}` can be evaluated`\n+  --> $DIR/parent_generics_of_encoding_impl_trait.rs:9:5\n+   |\n+LL |     generics_of_parent_impl_trait::foo([()]);\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ cannot satisfy `the constant `foo::{opaque#0}::{constant#0}` can be evaluated`\n+   |\n+  ::: $DIR/auxiliary/generics_of_parent_impl_trait.rs:6:48\n+   |\n+LL | pub fn foo<const N: usize>(foo: impl Into<[(); N + 1]>) {\n+   |                                                ----- required by this bound in `foo`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0284`."}]}