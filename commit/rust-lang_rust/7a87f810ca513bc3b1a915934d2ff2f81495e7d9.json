{"sha": "7a87f810ca513bc3b1a915934d2ff2f81495e7d9", "node_id": "C_kwDOAAsO6NoAKDdhODdmODEwY2E1MTNiYzNiMWE5MTU5MzRkMmZmMmY4MTQ5NWU3ZDk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-18T08:10:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-18T08:10:31Z"}, "message": "Auto merge of #12576 - harpsword:fold_range_non_block_match_arm, r=Veykril\n\nfeat: add fold range for multi line match arm list\n\nfix: #11893", "tree": {"sha": "d67afa985aa48791931762e073907e62a614182c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d67afa985aa48791931762e073907e62a614182c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a87f810ca513bc3b1a915934d2ff2f81495e7d9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a87f810ca513bc3b1a915934d2ff2f81495e7d9", "html_url": "https://github.com/rust-lang/rust/commit/7a87f810ca513bc3b1a915934d2ff2f81495e7d9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a87f810ca513bc3b1a915934d2ff2f81495e7d9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b1f9efa65c906ff84c8e1def1b0ebe6b12b3b6dc", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1f9efa65c906ff84c8e1def1b0ebe6b12b3b6dc", "html_url": "https://github.com/rust-lang/rust/commit/b1f9efa65c906ff84c8e1def1b0ebe6b12b3b6dc"}, {"sha": "3a78cc5e676715261e34d62da662c4a5119ed504", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a78cc5e676715261e34d62da662c4a5119ed504", "html_url": "https://github.com/rust-lang/rust/commit/3a78cc5e676715261e34d62da662c4a5119ed504"}], "stats": {"total": 50, "additions": 49, "deletions": 1}, "files": [{"sha": "c694d95d537ff6a5343b348d29f538716dc4503b", "filename": "crates/ide/src/folding_ranges.rs", "status": "modified", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/7a87f810ca513bc3b1a915934d2ff2f81495e7d9/crates%2Fide%2Fsrc%2Ffolding_ranges.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a87f810ca513bc3b1a915934d2ff2f81495e7d9/crates%2Fide%2Fsrc%2Ffolding_ranges.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Ffolding_ranges.rs?ref=7a87f810ca513bc3b1a915934d2ff2f81495e7d9", "patch": "@@ -24,6 +24,7 @@ pub enum FoldKind {\n     Array,\n     WhereClause,\n     ReturnType,\n+    MatchArm,\n }\n \n #[derive(Debug)]\n@@ -117,6 +118,11 @@ pub(crate) fn folding_ranges(file: &SourceFile) -> Vec<Fold> {\n                                 res.push(Fold { range, kind: FoldKind::WhereClause })\n                             }\n                         },\n+                        ast::MatchArm(match_arm) => {\n+                            if let Some(range) = fold_range_for_multiline_match_arm(match_arm) {\n+                                res.push(Fold {range, kind: FoldKind::MatchArm})\n+                            }\n+                        },\n                         _ => (),\n                     }\n                 }\n@@ -264,6 +270,16 @@ fn fold_range_for_where_clause(where_clause: ast::WhereClause) -> Option<TextRan\n     None\n }\n \n+fn fold_range_for_multiline_match_arm(match_arm: ast::MatchArm) -> Option<TextRange> {\n+    if let Some(_) = fold_kind(match_arm.expr()?.syntax().kind()) {\n+        return None;\n+    }\n+    if match_arm.expr()?.syntax().text().contains_char('\\n') {\n+        return Some(match_arm.expr()?.syntax().text_range());\n+    }\n+    None\n+}\n+\n #[cfg(test)]\n mod tests {\n     use test_utils::extract_tags;\n@@ -299,6 +315,7 @@ mod tests {\n                 FoldKind::Array => \"array\",\n                 FoldKind::WhereClause => \"whereclause\",\n                 FoldKind::ReturnType => \"returntype\",\n+                FoldKind::MatchArm => \"matcharm\",\n             };\n             assert_eq!(kind, &attr.unwrap());\n         }\n@@ -456,6 +473,36 @@ fn main() <fold block>{\n         );\n     }\n \n+    #[test]\n+    fn test_fold_multiline_non_block_match_arm() {\n+        check(\n+            r#\"\n+            fn main() <fold block>{\n+                match foo <fold block>{\n+                    block => <fold block>{\n+                    }</fold>,\n+                    matcharm => <fold matcharm>some.\n+                        call().\n+                        chain()</fold>,\n+                    matcharm2\n+                        => 0,\n+                    match_expr => <fold matcharm>match foo2 <fold block>{\n+                        bar => (),\n+                    }</fold></fold>,\n+                    array_list => <fold array>[\n+                        1,\n+                        2,\n+                        3,\n+                    ]</fold>,\n+                    strustS => <fold matcharm>StructS <fold block>{\n+                        a: 31,\n+                    }</fold></fold>,\n+                }</fold>\n+            }</fold>\n+            \"#,\n+        )\n+    }\n+\n     #[test]\n     fn fold_big_calls() {\n         check("}, {"sha": "3d702fe8dc23c12898091c2c3c5232db1ca80d5b", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7a87f810ca513bc3b1a915934d2ff2f81495e7d9/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a87f810ca513bc3b1a915934d2ff2f81495e7d9/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=7a87f810ca513bc3b1a915934d2ff2f81495e7d9", "patch": "@@ -670,7 +670,8 @@ pub(crate) fn folding_range(\n         | FoldKind::Statics\n         | FoldKind::WhereClause\n         | FoldKind::ReturnType\n-        | FoldKind::Array => None,\n+        | FoldKind::Array\n+        | FoldKind::MatchArm => None,\n     };\n \n     let range = range(line_index, fold.range);"}]}