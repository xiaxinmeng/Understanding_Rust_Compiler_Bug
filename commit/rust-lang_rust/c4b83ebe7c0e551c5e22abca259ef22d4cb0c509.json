{"sha": "c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "node_id": "C_kwDOAAsO6NoAKGM0YjgzZWJlN2MwZTU1MWM1ZTIyYWJjYTI1OWVmMjJkNGNiMGM1MDk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-20T05:08:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-20T05:08:59Z"}, "message": "Rollup merge of #100507 - cameron1024:suggest-lazy, r=compiler-errors\n\nsuggest `once_cell::Lazy` for non-const statics\n\nAddresses https://github.com/rust-lang/rust/issues/100410\n\nSome questions:\n - removing the `if` seems to include too many cases (e.g. calls to non-const functions inside a `const fn`), but this code excludes the following case:\n```rust\nconst FOO: Foo = non_const_fn();\n```\nShould we suggest `once_cell` in this case as well?\n - The original issue mentions suggesting `AtomicI32` instead of `Mutex<i32>`, should this PR address that as well?", "tree": {"sha": "23806a75e76323681aa26dae4c953f3a3b8dcbbb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23806a75e76323681aa26dae4c953f3a3b8dcbbb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjAGxrCRBK7hj4Ov3rIwAA3vMIAHz9lwyhmLvMyusBkHYz5lqG\nq4ksyqx65edb302NhMfaugcDlU8UMc3ksFg3S3IfCj7gXXnXF3hRJWcKrrlxNe8V\nNuafQ1X9127/w7Qa5H6WzIOlnlcLjXTkDqMdrZOetC4ELcdu2ztmwKL2ZISTMT1B\nSI/CpswedZq4Obw7UXMRUTTLM60TURq3kYjI8I/HkT+0RC1TBf7sdESh0nqLB435\nqp8KuUOlmPaNhImtLS+xjPVPQLRL84Po9+sbC2RpaLiosVE90jbi+E2WqMHCMjUN\nSxkt6W9Qmd8Td0OETP4vgA7rk4fJyB4BJcF8uiyr3YWDCKtEPY3AXMcG2XLdftI=\n=aT4i\n-----END PGP SIGNATURE-----\n", "payload": "tree 23806a75e76323681aa26dae4c953f3a3b8dcbbb\nparent 368f08a65f66cdd0b26298fb86a175188d9c34bb\nparent 34e0d9a0bb409bb6c7fc45f1c222340b02989b8b\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1660972139 +0200\ncommitter GitHub <noreply@github.com> 1660972139 +0200\n\nRollup merge of #100507 - cameron1024:suggest-lazy, r=compiler-errors\n\nsuggest `once_cell::Lazy` for non-const statics\n\nAddresses https://github.com/rust-lang/rust/issues/100410\n\nSome questions:\n - removing the `if` seems to include too many cases (e.g. calls to non-const functions inside a `const fn`), but this code excludes the following case:\n```rust\nconst FOO: Foo = non_const_fn();\n```\nShould we suggest `once_cell` in this case as well?\n - The original issue mentions suggesting `AtomicI32` instead of `Mutex<i32>`, should this PR address that as well?\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "html_url": "https://github.com/rust-lang/rust/commit/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "368f08a65f66cdd0b26298fb86a175188d9c34bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/368f08a65f66cdd0b26298fb86a175188d9c34bb", "html_url": "https://github.com/rust-lang/rust/commit/368f08a65f66cdd0b26298fb86a175188d9c34bb"}, {"sha": "34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "url": "https://api.github.com/repos/rust-lang/rust/commits/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "html_url": "https://github.com/rust-lang/rust/commit/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b"}], "stats": {"total": 14, "additions": 14, "deletions": 0}, "files": [{"sha": "c9cfc1f3f469c8f3ce3d5598a14e97f61cbea19f", "filename": "compiler/rustc_const_eval/src/transform/check_consts/ops.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -1,6 +1,7 @@\n //! Concrete error types for all operations which may be invalid in a certain const context.\n \n use hir::def_id::LocalDefId;\n+use hir::ConstContext;\n use rustc_errors::{\n     error_code, struct_span_err, Applicability, DiagnosticBuilder, ErrorGuaranteed,\n };\n@@ -331,6 +332,10 @@ impl<'tcx> NonConstOp<'tcx> for FnCallNonConst<'tcx> {\n             ccx.const_kind(),\n         ));\n \n+        if let ConstContext::Static(_) = ccx.const_kind() {\n+            err.note(\"consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\");\n+        }\n+\n         err\n     }\n }"}, {"sha": "245c3a40e05062631907c8ea7913337c4a79f0bc", "filename": "src/test/ui/borrowck/issue-64453.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fborrowck%2Fissue-64453.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fborrowck%2Fissue-64453.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-64453.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -14,6 +14,7 @@ LL | static settings_dir: String = format!(\"\");\n    |                               ^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n    = note: this error originates in the macro `format` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error[E0507]: cannot move out of static item `settings_dir`"}, {"sha": "3c193ca34acce85b4c6a27c672a295fcb0934c58", "filename": "src/test/ui/check-static-values-constraints.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fcheck-static-values-constraints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fcheck-static-values-constraints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcheck-static-values-constraints.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -22,6 +22,7 @@ LL |     field2: SafeEnum::Variant4(\"str\".to_string())\n    |                                      ^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error[E0010]: allocations are not allowed in statics\n   --> $DIR/check-static-values-constraints.rs:94:5"}, {"sha": "0fec3581873eb73c5114f702e3e66ea9fa1bec4f", "filename": "src/test/ui/consts/issue-32829-2.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fconsts%2Fissue-32829-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fconsts%2Fissue-32829-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-32829-2.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -13,6 +13,7 @@ LL |         invalid();\n    |         ^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error[E0015]: cannot call non-const fn `invalid` in statics\n   --> $DIR/issue-32829-2.rs:54:9\n@@ -21,6 +22,7 @@ LL |         invalid();\n    |         ^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to 3 previous errors\n "}, {"sha": "1e0652722ff2d9f3628515bb247869b9545d25a4", "filename": "src/test/ui/consts/mir_check_nonconst.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fconsts%2Fmir_check_nonconst.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fconsts%2Fmir_check_nonconst.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmir_check_nonconst.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -5,6 +5,7 @@ LL | static foo: Foo = bar();\n    |                   ^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to previous error\n "}, {"sha": "e320df4b7ad8f95dc2ce29b443abed72b28ea08c", "filename": "src/test/ui/issues/issue-16538.mir.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fissues%2Fissue-16538.mir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fissues%2Fissue-16538.mir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-16538.mir.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -5,6 +5,7 @@ LL | static foo: &Y::X = &*Y::foo(Y::x as *const Y::X);\n    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error[E0133]: use of extern static is unsafe and requires unsafe function or block\n   --> $DIR/issue-16538.rs:14:30"}, {"sha": "4a862869274f8943d827673209b7d51140492e77", "filename": "src/test/ui/issues/issue-16538.thir.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fissues%2Fissue-16538.thir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fissues%2Fissue-16538.thir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-16538.thir.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -21,6 +21,7 @@ LL | static foo: &Y::X = &*Y::foo(Y::x as *const Y::X);\n    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to 3 previous errors\n "}, {"sha": "c6c80e41cf67e29e9a2fd19bc8d431d5db5a0374", "filename": "src/test/ui/issues/issue-25901.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fissues%2Fissue-25901.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fissues%2Fissue-25901.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-25901.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -16,6 +16,7 @@ note: impl defined here, but it is not `const`\n LL | impl Deref for A {\n    | ^^^^^^^^^^^^^^^^\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to previous error\n "}, {"sha": "dec0123184d705564f59607e4e0a7649c5ed6f63", "filename": "src/test/ui/static/static-vec-repeat-not-constant.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fstatic%2Fstatic-vec-repeat-not-constant.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c4b83ebe7c0e551c5e22abca259ef22d4cb0c509/src%2Ftest%2Fui%2Fstatic%2Fstatic-vec-repeat-not-constant.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstatic%2Fstatic-vec-repeat-not-constant.stderr?ref=c4b83ebe7c0e551c5e22abca259ef22d4cb0c509", "patch": "@@ -5,6 +5,7 @@ LL | static a: [isize; 2] = [foo(); 2];\n    |                         ^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to previous error\n "}]}