{"sha": "f6e4751ebeaac327db7fe444ed7991f70e8fd929", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2ZTQ3NTFlYmVhYWMzMjdkYjdmZTQ0NGVkNzk5MWY3MGU4ZmQ5Mjk=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-21T16:37:14Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-22T23:09:45Z"}, "message": "Disallow toolstate regression at the last week of the 6-week cycle.", "tree": {"sha": "12bc8da7f94aedc40e657f69fd553bb5f53f62c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/12bc8da7f94aedc40e657f69fd553bb5f53f62c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6e4751ebeaac327db7fe444ed7991f70e8fd929", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlqPTbkACgkQ/vbIBR0O\nATxRGxAAidSE8ZuZrWqpJNif1VqhRtLgATnteWKUZBGBWQSMKPohLIIDRVOC9srj\nMYqguLQEg6Zfn5RRsEx91ueWGeMHewS9SqJhkbpbzT5vr8OTVZFrvixX70wq560B\nfOM6bnIwdvQ8z63L94DV3nAb9pSQNSHWoQktDnEo1HqcFojSARTjX1XxIqLgm1lY\nZGNaUJRPCgVY9NKOKtHpdNR0lMT5eT8OkYgNcK8X3WkHjrB0XfL5QoGa95HYUpUc\nsp9lPObO4LMJyRkiVKCSxF+EOmxDrphbxgqzNIUAMdPjFOd/Fsbl9inaQ2+2Ue7g\nazCYm9fAdRc13G03AiuDtCCWoKnVkw7+DiiBkxO0yXZlXrrbF4bM8zlVN/xYLJJy\ngtJsT2LbeJ3RjS/x2Ot+vsnzIgpIwpOJURCZrnolL9vjaSZgXqmBedV9d7F8kqO4\ntRjuYdPjKh1qw62s/t5oJUIq2CtD6E+D9nRqgqVx+tfWOg35DlTQmh9mh+5lMopw\nkorp+tjymkhFcHKLkD7W49O4UIVaRoJF2Vqtl61ELUZ9TcPLjGUrg3IZNCpW8jU8\nv8a+amSRXvVgx+Y6i814qVm08VHfPLiaVirlcMu8TPxAH/GVt8oca9dAdfLkt2EF\nJiGMt1OG2slZy+n9vtpuuYGuSkHqOflodhQaoCV4d+CEiwymyss=\n=eb7c\n-----END PGP SIGNATURE-----", "payload": "tree 12bc8da7f94aedc40e657f69fd553bb5f53f62c6\nparent e18105079e4d0b925897fbb786cebb9539662e13\nauthor kennytm <kennytm@gmail.com> 1519231034 +0800\ncommitter kennytm <kennytm@gmail.com> 1519340985 +0800\n\nDisallow toolstate regression at the last week of the 6-week cycle.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6e4751ebeaac327db7fe444ed7991f70e8fd929", "html_url": "https://github.com/rust-lang/rust/commit/f6e4751ebeaac327db7fe444ed7991f70e8fd929", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6e4751ebeaac327db7fe444ed7991f70e8fd929/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e18105079e4d0b925897fbb786cebb9539662e13", "url": "https://api.github.com/repos/rust-lang/rust/commits/e18105079e4d0b925897fbb786cebb9539662e13", "html_url": "https://github.com/rust-lang/rust/commit/e18105079e4d0b925897fbb786cebb9539662e13"}], "stats": {"total": 49, "additions": 49, "deletions": 0}, "files": [{"sha": "bab9145cbcb9c78ed68ee5c5a06fdf28cca932a6", "filename": "src/ci/docker/x86_64-gnu-tools/Dockerfile", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f6e4751ebeaac327db7fe444ed7991f70e8fd929/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/f6e4751ebeaac327db7fe444ed7991f70e8fd929/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile?ref=f6e4751ebeaac327db7fe444ed7991f70e8fd929", "patch": "@@ -17,6 +17,7 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n+COPY x86_64-gnu-tools/checkregression.py /tmp/\n COPY x86_64-gnu-tools/checktools.sh /tmp/\n COPY x86_64-gnu-tools/repo.sh /tmp/\n "}, {"sha": "df791d12645fdea798b18f5df759de51019a5501", "filename": "src/ci/docker/x86_64-gnu-tools/checkregression.py", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/f6e4751ebeaac327db7fe444ed7991f70e8fd929/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fcheckregression.py", "raw_url": "https://github.com/rust-lang/rust/raw/f6e4751ebeaac327db7fe444ed7991f70e8fd929/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fcheckregression.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fcheckregression.py?ref=f6e4751ebeaac327db7fe444ed7991f70e8fd929", "patch": "@@ -0,0 +1,40 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+\n+# Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+import sys\n+import json\n+\n+if __name__ == '__main__':\n+    os_name = sys.argv[1]\n+    toolstate_file = sys.argv[2]\n+    current_state = sys.argv[3]\n+\n+    with open(toolstate_file, 'r') as f:\n+        toolstate = json.load(f)\n+    with open(current_state, 'r') as f:\n+        current = json.load(f)\n+\n+    regressed = False\n+    for cur in current:\n+        tool = cur['tool']\n+        state = cur[os_name]\n+        new_state = toolstate.get(tool, '')\n+        if new_state < state:\n+            print(\n+                'Error: The state of \"{}\" has regressed from \"{}\" to \"{}\"'\n+                .format(tool, state, new_state)\n+            )\n+            regressed = True\n+\n+    if regressed:\n+        sys.exit(1)"}, {"sha": "a7d0c6a1e6a7f342afa2b6cdb0b5b1532599a9c0", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f6e4751ebeaac327db7fe444ed7991f70e8fd929/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f6e4751ebeaac327db7fe444ed7991f70e8fd929/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=f6e4751ebeaac327db7fe444ed7991f70e8fd929", "patch": "@@ -17,6 +17,9 @@ TOOLSTATE_FILE=\"$(realpath $2)\"\n OS=\"$3\"\n COMMIT=\"$(git rev-parse HEAD)\"\n CHANGED_FILES=\"$(git diff --name-status HEAD HEAD^)\"\n+SIX_WEEK_CYCLE=\"$(( ($(date +%s) / 604800 - 3) % 6 ))\"\n+# ^ 1970 Jan 1st is a Thursday, and our release dates are also on Thursdays,\n+#   thus we could divide by 604800 (7 days in seconds) directly.\n \n touch \"$TOOLSTATE_FILE\"\n \n@@ -59,6 +62,11 @@ if [ \"$RUST_RELEASE_CHANNEL\" = nightly -a -n \"${TOOLSTATE_REPO_ACCESS_TOKEN+is_s\n         sed -i \"1 a\\\\\n $COMMIT\\t$(cat \"$TOOLSTATE_FILE\")\n \" \"history/$OS.tsv\"\n+    # if we are at the last week in the 6-week release cycle, reject any kind of regression.\n+    if [ $SIX_WEEK_CYCLE -eq 5 ]; then\n+        python2.7 \"$(dirname $0)/checkregression.py\" \\\n+            \"$OS\" \"$TOOLSTATE_FILE\" \"rust-toolstate/_data/latest.json\"\n+    fi\n     rm -f \"$MESSAGE_FILE\"\n     exit 0\n fi"}]}