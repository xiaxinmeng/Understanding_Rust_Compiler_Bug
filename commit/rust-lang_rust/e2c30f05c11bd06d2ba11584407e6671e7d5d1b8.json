{"sha": "e2c30f05c11bd06d2ba11584407e6671e7d5d1b8", "node_id": "C_kwDOAAsO6NoAKGUyYzMwZjA1YzExYmQwNmQyYmExMTU4NDQwN2U2NjcxZTdkNWQxYjg", "commit": {"author": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2021-10-27T15:24:00Z"}, "committer": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2021-10-27T18:08:42Z"}, "message": "Ignore references to type aliases in ptr_arg\n\nWorks using the fact that the hir path will point to a TyAlias, rather\nthan being resolved to the underlying type", "tree": {"sha": "6d60d21955cf47f66037e3870d9221595f392829", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d60d21955cf47f66037e3870d9221595f392829"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8", "html_url": "https://github.com/rust-lang/rust/commit/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8/comments", "author": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "444ef3e4d5f794baf0ee063ca2bfe52971b73b2f", "url": "https://api.github.com/repos/rust-lang/rust/commits/444ef3e4d5f794baf0ee063ca2bfe52971b73b2f", "html_url": "https://github.com/rust-lang/rust/commit/444ef3e4d5f794baf0ee063ca2bfe52971b73b2f"}], "stats": {"total": 57, "additions": 36, "deletions": 21}, "files": [{"sha": "8a36e20fc973d678297d14718039e8913af8acc7", "filename": "clippy_lints/src/ptr.rs", "status": "modified", "additions": 32, "deletions": 21, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8/clippy_lints%2Fsrc%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8/clippy_lints%2Fsrc%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fptr.rs?ref=e2c30f05c11bd06d2ba11584407e6671e7d5d1b8", "patch": "@@ -3,16 +3,16 @@\n use clippy_utils::diagnostics::{span_lint, span_lint_and_sugg, span_lint_and_then};\n use clippy_utils::ptr::get_spans;\n use clippy_utils::source::snippet_opt;\n-use clippy_utils::ty::{is_type_diagnostic_item, match_type, walk_ptrs_hir_ty};\n+use clippy_utils::ty::walk_ptrs_hir_ty;\n use clippy_utils::{expr_path_res, is_lint_allowed, match_any_diagnostic_items, paths};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n+use rustc_hir::def::Res;\n use rustc_hir::{\n-    BinOpKind, BodyId, Expr, ExprKind, FnDecl, FnRetTy, GenericArg, HirId, Impl, ImplItem, ImplItemKind, Item,\n-    ItemKind, Lifetime, MutTy, Mutability, Node, PathSegment, QPath, TraitFn, TraitItem, TraitItemKind, Ty, TyKind,\n+    BinOpKind, BodyId, Expr, ExprKind, FnDecl, FnRetTy, GenericArg, Impl, ImplItem, ImplItemKind, Item, ItemKind,\n+    Lifetime, MutTy, Mutability, Node, PathSegment, QPath, TraitFn, TraitItem, TraitItemKind, Ty, TyKind,\n };\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n use rustc_span::symbol::Symbol;\n@@ -153,7 +153,7 @@ declare_lint_pass!(Ptr => [PTR_ARG, CMP_NULL, MUT_FROM_REF, INVALID_NULL_PTR_USA\n impl<'tcx> LateLintPass<'tcx> for Ptr {\n     fn check_item(&mut self, cx: &LateContext<'tcx>, item: &'tcx Item<'_>) {\n         if let ItemKind::Fn(ref sig, _, body_id) = item.kind {\n-            check_fn(cx, sig.decl, item.hir_id(), Some(body_id));\n+            check_fn(cx, sig.decl, Some(body_id));\n         }\n     }\n \n@@ -165,7 +165,7 @@ impl<'tcx> LateLintPass<'tcx> for Ptr {\n                     return; // ignore trait impls\n                 }\n             }\n-            check_fn(cx, sig.decl, item.hir_id(), Some(body_id));\n+            check_fn(cx, sig.decl, Some(body_id));\n         }\n     }\n \n@@ -176,7 +176,7 @@ impl<'tcx> LateLintPass<'tcx> for Ptr {\n             } else {\n                 None\n             };\n-            check_fn(cx, sig.decl, item.hir_id(), body_id);\n+            check_fn(cx, sig.decl, body_id);\n         }\n     }\n \n@@ -244,22 +244,31 @@ fn check_invalid_ptr_usage<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) {\n }\n \n #[allow(clippy::too_many_lines)]\n-fn check_fn(cx: &LateContext<'_>, decl: &FnDecl<'_>, fn_id: HirId, opt_body_id: Option<BodyId>) {\n-    let fn_def_id = cx.tcx.hir().local_def_id(fn_id);\n-    let sig = cx.tcx.fn_sig(fn_def_id);\n-    let fn_ty = sig.skip_binder();\n+fn check_fn(cx: &LateContext<'_>, decl: &FnDecl<'_>, opt_body_id: Option<BodyId>) {\n     let body = opt_body_id.map(|id| cx.tcx.hir().body(id));\n \n-    for (idx, (arg, ty)) in decl.inputs.iter().zip(fn_ty.inputs()).enumerate() {\n+    for (idx, arg) in decl.inputs.iter().enumerate() {\n         // Honor the allow attribute on parameters. See issue 5644.\n         if let Some(body) = &body {\n             if is_lint_allowed(cx, PTR_ARG, body.params[idx].hir_id) {\n                 continue;\n             }\n         }\n \n-        if let ty::Ref(_, ty, Mutability::Not) = ty.kind() {\n-            if is_type_diagnostic_item(cx, ty, sym::Vec) {\n+        let (item_name, path) = if_chain! {\n+            if let TyKind::Rptr(_, MutTy { ty, mutbl: Mutability::Not }) = arg.kind;\n+            if let TyKind::Path(QPath::Resolved(_, path)) = ty.kind;\n+            if let Res::Def(_, did) = path.res;\n+            if let Some(item_name) = cx.tcx.get_diagnostic_name(did);\n+            then {\n+                (item_name, path)\n+            } else {\n+                continue\n+            }\n+        };\n+\n+        match item_name {\n+            sym::Vec => {\n                 if let Some(spans) = get_spans(cx, opt_body_id, idx, &[(\"clone\", \".to_owned()\")]) {\n                     span_lint_and_then(\n                         cx,\n@@ -289,7 +298,8 @@ fn check_fn(cx: &LateContext<'_>, decl: &FnDecl<'_>, fn_id: HirId, opt_body_id:\n                         },\n                     );\n                 }\n-            } else if is_type_diagnostic_item(cx, ty, sym::String) {\n+            },\n+            sym::String => {\n                 if let Some(spans) = get_spans(cx, opt_body_id, idx, &[(\"clone\", \".to_string()\"), (\"as_str\", \"\")]) {\n                     span_lint_and_then(\n                         cx,\n@@ -311,7 +321,8 @@ fn check_fn(cx: &LateContext<'_>, decl: &FnDecl<'_>, fn_id: HirId, opt_body_id:\n                         },\n                     );\n                 }\n-            } else if is_type_diagnostic_item(cx, ty, sym::PathBuf) {\n+            },\n+            sym::PathBuf => {\n                 if let Some(spans) = get_spans(cx, opt_body_id, idx, &[(\"clone\", \".to_path_buf()\"), (\"as_path\", \"\")]) {\n                     span_lint_and_then(\n                         cx,\n@@ -338,11 +349,10 @@ fn check_fn(cx: &LateContext<'_>, decl: &FnDecl<'_>, fn_id: HirId, opt_body_id:\n                         },\n                     );\n                 }\n-            } else if match_type(cx, ty, &paths::COW) {\n+            },\n+            sym::Cow => {\n                 if_chain! {\n-                    if let TyKind::Rptr(_, MutTy { ty, ..} ) = arg.kind;\n-                    if let TyKind::Path(QPath::Resolved(None, pp)) = ty.kind;\n-                    if let [ref bx] = *pp.segments;\n+                    if let [ref bx] = *path.segments;\n                     if let Some(params) = bx.args;\n                     if !params.parenthesized;\n                     if let Some(inner) = params.args.iter().find_map(|arg| match arg {\n@@ -363,7 +373,8 @@ fn check_fn(cx: &LateContext<'_>, decl: &FnDecl<'_>, fn_id: HirId, opt_body_id:\n                         );\n                     }\n                 }\n-            }\n+            },\n+            _ => {},\n         }\n     }\n "}, {"sha": "b29b26583b75f153d71ef31a9527811e0db19438", "filename": "tests/ui/ptr_arg.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8/tests%2Fui%2Fptr_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2c30f05c11bd06d2ba11584407e6671e7d5d1b8/tests%2Fui%2Fptr_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_arg.rs?ref=e2c30f05c11bd06d2ba11584407e6671e7d5d1b8", "patch": "@@ -160,3 +160,7 @@ mod issue6509 {\n         let _ = str.clone().clone();\n     }\n }\n+\n+// No error for types behind an alias (#7699)\n+type A = Vec<u8>;\n+fn aliased(a: &A) {}"}]}