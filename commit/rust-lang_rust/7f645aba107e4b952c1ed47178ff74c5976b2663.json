{"sha": "7f645aba107e4b952c1ed47178ff74c5976b2663", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdmNjQ1YWJhMTA3ZTRiOTUyYzFlZDQ3MTc4ZmY3NGM1OTc2YjI2NjM=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2020-05-02T22:39:33Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2020-05-02T22:43:55Z"}, "message": "Don't skip building LLVM if already built", "tree": {"sha": "c0ef206680bbe3ef303c830ff643a8c2f083f698", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c0ef206680bbe3ef303c830ff643a8c2f083f698"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7f645aba107e4b952c1ed47178ff74c5976b2663", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7f645aba107e4b952c1ed47178ff74c5976b2663", "html_url": "https://github.com/rust-lang/rust/commit/7f645aba107e4b952c1ed47178ff74c5976b2663", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7f645aba107e4b952c1ed47178ff74c5976b2663/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "131e120585e635929051a6b3e0b450eb943a3636", "url": "https://api.github.com/repos/rust-lang/rust/commits/131e120585e635929051a6b3e0b450eb943a3636", "html_url": "https://github.com/rust-lang/rust/commit/131e120585e635929051a6b3e0b450eb943a3636"}], "stats": {"total": 24, "additions": 18, "deletions": 6}, "files": [{"sha": "a878c730706cb453ae05733a456b2dd8a21d4ec4", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/7f645aba107e4b952c1ed47178ff74c5976b2663/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f645aba107e4b952c1ed47178ff74c5976b2663/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=7f645aba107e4b952c1ed47178ff74c5976b2663", "patch": "@@ -765,9 +765,17 @@ impl<'a> Builder<'a> {\n         }\n \n         // Set a flag for `check`/`clippy`/`fix`, so that certain build\n-        // scripts can do less work (e.g. not building/requiring LLVM).\n+        // scripts can do less work (i.e. not building/requiring LLVM).\n         if cmd == \"check\" || cmd == \"clippy\" || cmd == \"fix\" {\n-            cargo.env(\"RUST_CHECK\", \"1\");\n+            // If we've not yet built LLVM, or it's stale, then bust\n+            // the librustc_llvm cache. That will always work, even though it\n+            // may mean that on the next non-check build we'll need to rebuild\n+            // librustc_llvm. But if LLVM is stale, that'll be a tiny amount\n+            // of work comparitively, and we'd likely need to rebuild it anyway,\n+            // so that's okay.\n+            if crate::native::prebuilt_llvm_config(self, target).is_err() {\n+                cargo.env(\"RUST_CHECK\", \"1\");\n+            }\n         }\n \n         let stage = if compiler.stage == 0 && self.local_rebuild {"}, {"sha": "0c754936bc242fccf076abe6c1fc91b7e79f007e", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7f645aba107e4b952c1ed47178ff74c5976b2663/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f645aba107e4b952c1ed47178ff74c5976b2663/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=7f645aba107e4b952c1ed47178ff74c5976b2663", "patch": "@@ -517,9 +517,13 @@ pub fn rustc_cargo_env(builder: &Builder<'_>, cargo: &mut Cargo, target: Interne\n     // librustc_llvm and librustc_codegen_llvm.\n     //\n     // Note that this is disabled if LLVM itself is disabled or we're in a check\n-    // build, where if we're in a check build there's no need to build all of\n-    // LLVM and such.\n-    if builder.config.llvm_enabled() && builder.kind != Kind::Check {\n+    // build. If we are in a check build we still go ahead here presuming we've\n+    // detected that LLVM is alreay built and good to go which helps prevent\n+    // busting caches (e.g. like #71152).\n+    if builder.config.llvm_enabled()\n+        && (builder.kind != Kind::Check\n+            || crate::native::prebuilt_llvm_config(builder, target).is_ok())\n+    {\n         if builder.is_rust_llvm(target) {\n             cargo.env(\"LLVM_RUSTLLVM\", \"1\");\n         }"}, {"sha": "e97fa4345fe7c1f209ac4a9269eed2b242a4c55c", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7f645aba107e4b952c1ed47178ff74c5976b2663/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f645aba107e4b952c1ed47178ff74c5976b2663/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=7f645aba107e4b952c1ed47178ff74c5976b2663", "patch": "@@ -15,9 +15,9 @@ fn detect_llvm_link() -> (&'static str, &'static str) {\n }\n \n fn main() {\n+    println!(\"cargo:rerun-if-env-changed=RUST_CHECK\");\n     if env::var_os(\"RUST_CHECK\").is_some() {\n         // If we're just running `check`, there's no need for LLVM to be built.\n-        println!(\"cargo:rerun-if-env-changed=RUST_CHECK\");\n         return;\n     }\n "}]}