{"sha": "7febdb7b15681a6a70da191128a9552f35ed5644", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdmZWJkYjdiMTU2ODFhNmE3MGRhMTkxMTI4YTk1NTJmMzVlZDU2NDQ=", "commit": {"author": {"name": "Corey Richardson", "email": "corey@octayn.net", "date": "2014-03-18T13:46:43Z"}, "committer": {"name": "Corey Richardson", "email": "corey@octayn.net", "date": "2014-03-27T06:48:08Z"}, "message": "rustc: mark references w/anonymous lifetime nocapture\n\nCloses #6751", "tree": {"sha": "94ba070cee3103a01ed965471e7169421388219b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/94ba070cee3103a01ed965471e7169421388219b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7febdb7b15681a6a70da191128a9552f35ed5644", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7febdb7b15681a6a70da191128a9552f35ed5644", "html_url": "https://github.com/rust-lang/rust/commit/7febdb7b15681a6a70da191128a9552f35ed5644", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7febdb7b15681a6a70da191128a9552f35ed5644/comments", "author": {"login": "emberian", "id": 704250, "node_id": "MDQ6VXNlcjcwNDI1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/704250?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emberian", "html_url": "https://github.com/emberian", "followers_url": "https://api.github.com/users/emberian/followers", "following_url": "https://api.github.com/users/emberian/following{/other_user}", "gists_url": "https://api.github.com/users/emberian/gists{/gist_id}", "starred_url": "https://api.github.com/users/emberian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emberian/subscriptions", "organizations_url": "https://api.github.com/users/emberian/orgs", "repos_url": "https://api.github.com/users/emberian/repos", "events_url": "https://api.github.com/users/emberian/events{/privacy}", "received_events_url": "https://api.github.com/users/emberian/received_events", "type": "User", "site_admin": false}, "committer": {"login": "emberian", "id": 704250, "node_id": "MDQ6VXNlcjcwNDI1MA==", "avatar_url": "https://avatars.githubusercontent.com/u/704250?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emberian", "html_url": "https://github.com/emberian", "followers_url": "https://api.github.com/users/emberian/followers", "following_url": "https://api.github.com/users/emberian/following{/other_user}", "gists_url": "https://api.github.com/users/emberian/gists{/gist_id}", "starred_url": "https://api.github.com/users/emberian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emberian/subscriptions", "organizations_url": "https://api.github.com/users/emberian/orgs", "repos_url": "https://api.github.com/users/emberian/repos", "events_url": "https://api.github.com/users/emberian/events{/privacy}", "received_events_url": "https://api.github.com/users/emberian/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c83994e0f492d5e416537cb7ce1063662c0e44e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/c83994e0f492d5e416537cb7ce1063662c0e44e7", "html_url": "https://github.com/rust-lang/rust/commit/c83994e0f492d5e416537cb7ce1063662c0e44e7"}], "stats": {"total": 52, "additions": 49, "deletions": 3}, "files": [{"sha": "fee15230575f93b5ff64573b568c697c1e1fd276", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7febdb7b15681a6a70da191128a9552f35ed5644/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7febdb7b15681a6a70da191128a9552f35ed5644/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=7febdb7b15681a6a70da191128a9552f35ed5644", "patch": "@@ -246,6 +246,7 @@ fn get_extern_rust_fn(ccx: &CrateContext, inputs: &[ty::t], output: ty::t,\n pub fn decl_rust_fn(ccx: &CrateContext, has_env: bool,\n                     inputs: &[ty::t], output: ty::t,\n                     name: &str) -> ValueRef {\n+    use middle::ty::{FreeRegion, BrAnon, ReFree, ReLateBound};\n     let llfty = type_of_rust_fn(ccx, has_env, inputs, output);\n     let llfn = decl_cdecl_fn(ccx.llmod, name, llfty, output);\n \n@@ -265,7 +266,17 @@ pub fn decl_rust_fn(ccx: &CrateContext, has_env: bool,\n                 unsafe {\n                     llvm::LLVMAddAttribute(llarg, lib::llvm::NoAliasAttribute as c_uint);\n                 }\n-            }\n+            },\n+            // When a reference in an argument has no named lifetime, it's\n+            // impossible for that reference to escape this function(ie, be\n+            // returned).\n+            ty::ty_rptr(ReFree(FreeRegion { scope_id: _, bound_region: BrAnon(_) }), _) |\n+                ty::ty_rptr(ReLateBound(_, BrAnon(_)), _) => {\n+                debug!(\"marking argument of {} as nocapture because of anonymous lifetime\", name);\n+                unsafe {\n+                    llvm::LLVMAddAttribute(llarg, lib::llvm::NoCaptureAttribute as c_uint);\n+                }\n+            },\n             _ => {\n                 // For non-immediate arguments the callee gets its own copy of\n                 // the value on the stack, so there are no aliases"}, {"sha": "30f272d16b05b89848a97937e3698b099651f93c", "filename": "src/librustc/middle/trans/callee.rs", "status": "modified", "additions": 37, "deletions": 2, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/7febdb7b15681a6a70da191128a9552f35ed5644/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7febdb7b15681a6a70da191128a9552f35ed5644/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs?ref=7febdb7b15681a6a70da191128a9552f35ed5644", "patch": "@@ -20,7 +20,7 @@ use std::slice;\n \n use back::abi;\n use driver::session;\n-use lib::llvm::{ValueRef, NoAliasAttribute, StructRetAttribute};\n+use lib::llvm::{ValueRef, NoAliasAttribute, StructRetAttribute, NoCaptureAttribute};\n use lib::llvm::llvm;\n use metadata::csearch;\n use middle::trans::base;\n@@ -661,9 +661,15 @@ pub fn trans_call_inner<'a>(\n             llargs.push(opt_llretslot.unwrap());\n         }\n \n+        // start at 1, because index 0 is the return value of the llvm func\n+        let mut first_arg_offset = 1;\n+\n         // Push the environment (or a trait object's self).\n         match (llenv, llself) {\n-            (Some(llenv), None) => llargs.push(llenv),\n+            (Some(llenv), None) => {\n+                first_arg_offset += 1;\n+                llargs.push(llenv)\n+            },\n             (None, Some(llself)) => llargs.push(llself),\n             _ => {}\n         }\n@@ -682,6 +688,11 @@ pub fn trans_call_inner<'a>(\n         let mut attrs = Vec::new();\n         if type_of::return_uses_outptr(ccx, ret_ty) {\n             attrs.push((1, StructRetAttribute));\n+            // The outptr can be noalias and nocapture because it's entirely\n+            // invisible to the program.\n+            attrs.push((1, NoAliasAttribute));\n+            attrs.push((1, NoCaptureAttribute));\n+            first_arg_offset += 1;\n         }\n \n         // The `noalias` attribute on the return value is useful to a\n@@ -695,6 +706,30 @@ pub fn trans_call_inner<'a>(\n             _ => {}\n         }\n \n+        debug!(\"trans_callee_inner: first_arg_offset={}\", first_arg_offset);\n+\n+        for (idx, &t) in ty::ty_fn_args(callee_ty).iter().enumerate().map(|(i, v)| (i+first_arg_offset, v)) {\n+            use middle::ty::{FreeRegion, BrAnon, ReFree, ReLateBound};\n+            if !type_is_immediate(ccx, t) {\n+                // if it's not immediate, we have a program-invisible pointer,\n+                // which it can't possibly capture\n+                attrs.push((idx, NoCaptureAttribute));\n+                debug!(\"trans_callee_inner: argument {} nocapture because it's non-immediate\", idx);\n+                continue;\n+            }\n+\n+            let t_ = ty::get(t);\n+            match t_.sty {\n+                ty::ty_rptr(ReFree(FreeRegion { scope_id: _, bound_region: BrAnon(_) }), _) |\n+                    ty::ty_rptr(ReLateBound(_, BrAnon(_)), _) => {\n+\n+                    debug!(\"trans_callee_inner: argument {} nocapture because of anonymous lifetime\", idx);\n+                    attrs.push((idx, NoCaptureAttribute));\n+                },\n+                _ => { }\n+            }\n+        }\n+\n         // Invoke the actual rust fn and update bcx/llresult.\n         let (llret, b) = base::invoke(bcx,\n                                       llfn,"}]}