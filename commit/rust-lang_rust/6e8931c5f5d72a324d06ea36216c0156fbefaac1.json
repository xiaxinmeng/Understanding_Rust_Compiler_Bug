{"sha": "6e8931c5f5d72a324d06ea36216c0156fbefaac1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlODkzMWM1ZjVkNzJhMzI0ZDA2ZWEzNjIxNmMwMTU2ZmJlZmFhYzE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-02-26T17:30:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-02-26T17:30:48Z"}, "message": "Auto merge of #3821 - g-bartoszek:redundant_closure-different-borrow-levels, r=oli-obk\n\ndo not trigger redundant_closure when there is a difference in borrow\u2026\n\n\u2026 level between closure parameter and \"self\", fixes  #3802", "tree": {"sha": "cb740418ed8d90a691dc69d3e88d68d093f9b436", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb740418ed8d90a691dc69d3e88d68d093f9b436"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6e8931c5f5d72a324d06ea36216c0156fbefaac1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6e8931c5f5d72a324d06ea36216c0156fbefaac1", "html_url": "https://github.com/rust-lang/rust/commit/6e8931c5f5d72a324d06ea36216c0156fbefaac1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6e8931c5f5d72a324d06ea36216c0156fbefaac1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "76f9c22fde8f62547f17fd15c3664b74798686d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/76f9c22fde8f62547f17fd15c3664b74798686d3", "html_url": "https://github.com/rust-lang/rust/commit/76f9c22fde8f62547f17fd15c3664b74798686d3"}, {"sha": "a7f4d41a7d1aa8547df583bd0239a3e35c740018", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7f4d41a7d1aa8547df583bd0239a3e35c740018", "html_url": "https://github.com/rust-lang/rust/commit/a7f4d41a7d1aa8547df583bd0239a3e35c740018"}], "stats": {"total": 31, "additions": 22, "deletions": 9}, "files": [{"sha": "331d1a0ec1dcffc8499c93d184a194cf685e2648", "filename": "clippy_lints/src/eta_reduction.rs", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/6e8931c5f5d72a324d06ea36216c0156fbefaac1/clippy_lints%2Fsrc%2Feta_reduction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e8931c5f5d72a324d06ea36216c0156fbefaac1/clippy_lints%2Fsrc%2Feta_reduction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Feta_reduction.rs?ref=6e8931c5f5d72a324d06ea36216c0156fbefaac1", "patch": "@@ -133,25 +133,30 @@ fn get_ufcs_type_name(\n     let actual_type_of_self = &cx.tables.node_type(self_arg.hir_id).sty;\n \n     if let Some(trait_id) = cx.tcx.trait_of_item(method_def_id) {\n-        //if the method expectes &self, ufcs requires explicit borrowing so closure can't be removed\n-        return match (expected_type_of_self, actual_type_of_self) {\n-            (ty::Ref(_, _, _), ty::Ref(_, _, _)) => Some(cx.tcx.item_path_str(trait_id)),\n-            (l, r) => match (l, r) {\n-                (ty::Ref(_, _, _), _) | (_, ty::Ref(_, _, _)) => None,\n-                (_, _) => Some(cx.tcx.item_path_str(trait_id)),\n-            },\n-        };\n+        if match_borrow_depth(expected_type_of_self, actual_type_of_self) {\n+            return Some(cx.tcx.item_path_str(trait_id));\n+        }\n     }\n \n     cx.tcx.impl_of_method(method_def_id).and_then(|_| {\n-        //a type may implicitly implement other types methods (e.g. Deref)\n+        //a type may implicitly implement other type's methods (e.g. Deref)\n         if match_types(expected_type_of_self, actual_type_of_self) {\n             return Some(get_type_name(cx, &actual_type_of_self));\n         }\n         None\n     })\n }\n \n+fn match_borrow_depth(lhs: &ty::TyKind<'_>, rhs: &ty::TyKind<'_>) -> bool {\n+    match (lhs, rhs) {\n+        (ty::Ref(_, t1, _), ty::Ref(_, t2, _)) => match_borrow_depth(&t1.sty, &t2.sty),\n+        (l, r) => match (l, r) {\n+            (ty::Ref(_, _, _), _) | (_, ty::Ref(_, _, _)) => false,\n+            (_, _) => true,\n+        },\n+    }\n+}\n+\n fn match_types(lhs: &ty::TyKind<'_>, rhs: &ty::TyKind<'_>) -> bool {\n     match (lhs, rhs) {\n         (ty::Bool, ty::Bool)"}, {"sha": "f777939c67d2f11261f32ebbafa88c6f1f061920", "filename": "tests/ui/eta.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6e8931c5f5d72a324d06ea36216c0156fbefaac1/tests%2Fui%2Feta.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e8931c5f5d72a324d06ea36216c0156fbefaac1/tests%2Fui%2Feta.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.rs?ref=6e8931c5f5d72a324d06ea36216c0156fbefaac1", "patch": "@@ -88,6 +88,14 @@ fn test_redundant_closures_containing_method_calls() {\n     let c = Some(TestStruct { some_ref: &i })\n         .as_ref()\n         .map(|c| c.to_ascii_uppercase());\n+\n+    fn test_different_borrow_levels<T>(t: &[&T])\n+    where\n+        T: TestTrait,\n+    {\n+        t.iter().filter(|x| x.trait_foo_ref());\n+        t.iter().map(|x| x.trait_foo_ref());\n+    }\n }\n \n fn meta<F>(f: F)"}]}