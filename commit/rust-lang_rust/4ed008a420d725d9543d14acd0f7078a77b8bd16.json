{"sha": "4ed008a420d725d9543d14acd0f7078a77b8bd16", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlZDAwOGE0MjBkNzI1ZDk1NDNkMTRhY2QwZjcwNzhhNzdiOGJkMTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-18T13:09:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-18T13:09:01Z"}, "message": "Auto merge of #62682 - alessandrod:issue-58375, r=eddyb\n\nNormalize type parameters in create_mono_items_for_default_impls.\n\nFix for https://github.com/rust-lang/rust/issues/58375. I've added a test in `src/tests/run-pass` to reproduce the bug, not sure that's the best place for it.\n\nSee https://github.com/rust-lang/rust/issues/58375#issuecomment-509156977 for more context.", "tree": {"sha": "49491d2d792fce60e1b96e192ac80893d894c2f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/49491d2d792fce60e1b96e192ac80893d894c2f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ed008a420d725d9543d14acd0f7078a77b8bd16", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ed008a420d725d9543d14acd0f7078a77b8bd16", "html_url": "https://github.com/rust-lang/rust/commit/4ed008a420d725d9543d14acd0f7078a77b8bd16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ed008a420d725d9543d14acd0f7078a77b8bd16/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "21d5b8bf0c26e3ee4c270ce5527df66b1af56513", "url": "https://api.github.com/repos/rust-lang/rust/commits/21d5b8bf0c26e3ee4c270ce5527df66b1af56513", "html_url": "https://github.com/rust-lang/rust/commit/21d5b8bf0c26e3ee4c270ce5527df66b1af56513"}, {"sha": "745c76d657ebbe29265100e5381f8bf326c54567", "url": "https://api.github.com/repos/rust-lang/rust/commits/745c76d657ebbe29265100e5381f8bf326c54567", "html_url": "https://github.com/rust-lang/rust/commit/745c76d657ebbe29265100e5381f8bf326c54567"}], "stats": {"total": 31, "additions": 29, "deletions": 2}, "files": [{"sha": "ee0f9119544bf41f487cd50725ef7d643b27895e", "filename": "src/librustc_mir/monomorphize/collector.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4ed008a420d725d9543d14acd0f7078a77b8bd16/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ed008a420d725d9543d14acd0f7078a77b8bd16/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs?ref=4ed008a420d725d9543d14acd0f7078a77b8bd16", "patch": "@@ -1143,6 +1143,11 @@ fn create_mono_items_for_default_impls<'tcx>(\n                    def_id_to_string(tcx, impl_def_id));\n \n             if let Some(trait_ref) = tcx.impl_trait_ref(impl_def_id) {\n+                let param_env = ty::ParamEnv::reveal_all();\n+                let trait_ref = tcx.normalize_erasing_regions(\n+                    param_env,\n+                    trait_ref,\n+                );\n                 let overridden_methods: FxHashSet<_> =\n                     impl_item_refs.iter()\n                                   .map(|iiref| iiref.ident.modern())\n@@ -1165,9 +1170,8 @@ fn create_mono_items_for_default_impls<'tcx>(\n                             }\n                         }\n                     });\n-\n                     let instance = ty::Instance::resolve(tcx,\n-                                                         ty::ParamEnv::reveal_all(),\n+                                                         param_env,\n                                                          method.def_id,\n                                                          substs).unwrap();\n "}, {"sha": "6730217626f3ece6fad97ca7b5e66897970931bf", "filename": "src/test/run-pass/issue-58375-monomorphize-default-impls.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/4ed008a420d725d9543d14acd0f7078a77b8bd16/src%2Ftest%2Frun-pass%2Fissue-58375-monomorphize-default-impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ed008a420d725d9543d14acd0f7078a77b8bd16/src%2Ftest%2Frun-pass%2Fissue-58375-monomorphize-default-impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-58375-monomorphize-default-impls.rs?ref=4ed008a420d725d9543d14acd0f7078a77b8bd16", "patch": "@@ -0,0 +1,23 @@\n+// Make sure that the mono-item collector does not crash when trying to\n+// instantiate a default impl for DecodeUtf16<<u8 as A>::Item>\n+// See https://github.com/rust-lang/rust/issues/58375\n+// compile-flags:-C link-dead-code\n+\n+#![crate_type = \"rlib\"]\n+\n+pub struct DecodeUtf16<I>(I);\n+\n+pub trait Arbitrary {\n+    fn arbitrary() {}\n+}\n+\n+pub trait A {\n+    type Item;\n+}\n+\n+impl A for u8 {\n+    type Item = char;\n+}\n+\n+impl Arbitrary for DecodeUtf16<<u8 as A>::Item>  {\n+}"}]}