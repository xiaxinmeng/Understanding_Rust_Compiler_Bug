{"sha": "dd6683fcda991536c54d419a6ecc710f21226225", "node_id": "C_kwDOAAsO6NoAKGRkNjY4M2ZjZGE5OTE1MzZjNTRkNDE5YTZlY2M3MTBmMjEyMjYyMjU", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-03-27T23:09:38Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-03-27T23:10:02Z"}, "message": "suggest wrapping patterns with compatible enum variants", "tree": {"sha": "62514414f1f02dab28eb8122b646e40f958c8324", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/62514414f1f02dab28eb8122b646e40f958c8324"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd6683fcda991536c54d419a6ecc710f21226225", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd6683fcda991536c54d419a6ecc710f21226225", "html_url": "https://github.com/rust-lang/rust/commit/dd6683fcda991536c54d419a6ecc710f21226225", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd6683fcda991536c54d419a6ecc710f21226225/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d7aca22e7fd9fdfdc60e30117e54ed479fd7bf7a", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7aca22e7fd9fdfdc60e30117e54ed479fd7bf7a", "html_url": "https://github.com/rust-lang/rust/commit/d7aca22e7fd9fdfdc60e30117e54ed479fd7bf7a"}], "stats": {"total": 194, "additions": 194, "deletions": 0}, "files": [{"sha": "6e007b181f2c2b1682c6a9d282edfbd12a578fbc", "filename": "compiler/rustc_infer/src/infer/error_reporting/mod.rs", "status": "modified", "additions": 69, "deletions": 0, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/dd6683fcda991536c54d419a6ecc710f21226225/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd6683fcda991536c54d419a6ecc710f21226225/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=dd6683fcda991536c54d419a6ecc710f21226225", "patch": "@@ -65,6 +65,7 @@ use rustc_hir::def_id::DefId;\n use rustc_hir::lang_items::LangItem;\n use rustc_hir::{Item, ItemKind, Node};\n use rustc_middle::dep_graph::DepContext;\n+use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::{\n     self,\n     error::TypeError,\n@@ -1736,6 +1737,7 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n             };\n \n             if should_suggest_fixes {\n+                self.suggest_tuple_pattern(cause, &exp_found, diag);\n                 self.suggest_as_ref_where_appropriate(span, &exp_found, diag);\n                 self.suggest_accessing_field_where_appropriate(cause, &exp_found, diag);\n                 self.suggest_await_on_expect_found(cause, span, &exp_found, diag);\n@@ -1766,6 +1768,73 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n         self.note_error_origin(diag, cause, exp_found, terr);\n     }\n \n+    fn suggest_tuple_pattern(\n+        &self,\n+        cause: &ObligationCause<'tcx>,\n+        exp_found: &ty::error::ExpectedFound<Ty<'tcx>>,\n+        diag: &mut Diagnostic,\n+    ) {\n+        // Heavily inspired by `FnCtxt::suggest_compatible_variants`, with\n+        // some modifications due to that being in typeck and this being in infer.\n+        if let ObligationCauseCode::Pattern { .. } = cause.code() {\n+            if let ty::Adt(expected_adt, substs) = exp_found.expected.kind() {\n+                let compatible_variants: Vec<_> = expected_adt\n+                    .variants()\n+                    .iter()\n+                    .filter(|variant| {\n+                        variant.fields.len() == 1 && variant.ctor_kind == hir::def::CtorKind::Fn\n+                    })\n+                    .filter_map(|variant| {\n+                        let sole_field = &variant.fields[0];\n+                        let sole_field_ty = sole_field.ty(self.tcx, substs);\n+                        if same_type_modulo_infer(sole_field_ty, exp_found.found) {\n+                            let variant_path =\n+                                with_no_trimmed_paths!(self.tcx.def_path_str(variant.def_id));\n+                            // FIXME #56861: DRYer prelude filtering\n+                            if let Some(path) = variant_path.strip_prefix(\"std::prelude::\") {\n+                                if let Some((_, path)) = path.split_once(\"::\") {\n+                                    return Some(path.to_string());\n+                                }\n+                            }\n+                            Some(variant_path)\n+                        } else {\n+                            None\n+                        }\n+                    })\n+                    .collect();\n+                match &compatible_variants[..] {\n+                    [] => {}\n+                    [variant] => {\n+                        diag.multipart_suggestion_verbose(\n+                            &format!(\"try wrapping the pattern in `{}`\", variant),\n+                            vec![\n+                                (cause.span.shrink_to_lo(), format!(\"{}(\", variant)),\n+                                (cause.span.shrink_to_hi(), \")\".to_string()),\n+                            ],\n+                            Applicability::MaybeIncorrect,\n+                        );\n+                    }\n+                    _ => {\n+                        // More than one matching variant.\n+                        diag.multipart_suggestions(\n+                            &format!(\n+                                \"try wrapping the pattern in a variant of `{}`\",\n+                                self.tcx.def_path_str(expected_adt.did())\n+                            ),\n+                            compatible_variants.into_iter().map(|variant| {\n+                                vec![\n+                                    (cause.span.shrink_to_lo(), format!(\"{}(\", variant)),\n+                                    (cause.span.shrink_to_hi(), \")\".to_string()),\n+                                ]\n+                            }),\n+                            Applicability::MaybeIncorrect,\n+                        );\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n     pub fn get_impl_future_output_ty(&self, ty: Ty<'tcx>) -> Option<Binder<'tcx, Ty<'tcx>>> {\n         if let ty::Opaque(def_id, substs) = ty.kind() {\n             let future_trait = self.tcx.require_lang_item(LangItem::Future, None);"}, {"sha": "09e12dab2d3fc6533f48419777c03aa47333974b", "filename": "src/test/ui/did_you_mean/compatible-variants-in-pat.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fdid_you_mean%2Fcompatible-variants-in-pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fdid_you_mean%2Fcompatible-variants-in-pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fcompatible-variants-in-pat.rs?ref=dd6683fcda991536c54d419a6ecc710f21226225", "patch": "@@ -0,0 +1,41 @@\n+enum Foo {\n+    Bar(Bar),\n+}\n+struct Bar {\n+    x: i32,\n+}\n+\n+fn a(f: Foo) {\n+    match f {\n+        Bar { x } => {\n+            //~^ ERROR mismatched types\n+            //~| HELP try wrapping\n+        }\n+    }\n+}\n+\n+struct S;\n+\n+fn b(s: Option<S>) {\n+    match s {\n+        S => {\n+            //~^ ERROR mismatched types\n+            //~| HELP try wrapping\n+            //~| HELP introduce a new binding instead\n+        }\n+        _ => {}\n+    }\n+}\n+\n+fn c(s: Result<S, S>) {\n+    match s {\n+        S => {\n+            //~^ ERROR mismatched types\n+            //~| HELP try wrapping\n+            //~| HELP introduce a new binding instead\n+        }\n+        _ => {}\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "a4c77e08efe1996908742b9489997610cb76ec2b", "filename": "src/test/ui/did_you_mean/compatible-variants-in-pat.stderr", "status": "added", "additions": 68, "deletions": 0, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fdid_you_mean%2Fcompatible-variants-in-pat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fdid_you_mean%2Fcompatible-variants-in-pat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fcompatible-variants-in-pat.stderr?ref=dd6683fcda991536c54d419a6ecc710f21226225", "patch": "@@ -0,0 +1,68 @@\n+error[E0308]: mismatched types\n+  --> $DIR/compatible-variants-in-pat.rs:10:9\n+   |\n+LL |     match f {\n+   |           - this expression has type `Foo`\n+LL |         Bar { x } => {\n+   |         ^^^^^^^^^ expected enum `Foo`, found struct `Bar`\n+   |\n+help: try wrapping the pattern in `Foo::Bar`\n+   |\n+LL |         Foo::Bar(Bar { x }) => {\n+   |         +++++++++         +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/compatible-variants-in-pat.rs:21:9\n+   |\n+LL | struct S;\n+   | --------- unit struct defined here\n+...\n+LL |     match s {\n+   |           - this expression has type `Option<S>`\n+LL |         S => {\n+   |         ^\n+   |         |\n+   |         expected enum `Option`, found struct `S`\n+   |         `S` is interpreted as a unit struct, not a new binding\n+   |\n+   = note: expected enum `Option<S>`\n+            found struct `S`\n+help: try wrapping the pattern in `Some`\n+   |\n+LL |         Some(S) => {\n+   |         +++++ +\n+help: introduce a new binding instead\n+   |\n+LL |         other_s => {\n+   |         ~~~~~~~\n+\n+error[E0308]: mismatched types\n+  --> $DIR/compatible-variants-in-pat.rs:32:9\n+   |\n+LL | struct S;\n+   | --------- unit struct defined here\n+...\n+LL |     match s {\n+   |           - this expression has type `Result<S, S>`\n+LL |         S => {\n+   |         ^\n+   |         |\n+   |         expected enum `Result`, found struct `S`\n+   |         `S` is interpreted as a unit struct, not a new binding\n+   |\n+   = note: expected enum `Result<S, S>`\n+            found struct `S`\n+help: try wrapping the pattern in a variant of `Result`\n+   |\n+LL |         Ok(S) => {\n+   |         +++ +\n+LL |         Err(S) => {\n+   |         ++++ +\n+help: introduce a new binding instead\n+   |\n+LL |         other_s => {\n+   |         ~~~~~~~\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "4b027eba2c25ea43ed1b2f456669847b6b45b989", "filename": "src/test/ui/issues/issue-12552.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fissues%2Fissue-12552.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fissues%2Fissue-12552.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-12552.stderr?ref=dd6683fcda991536c54d419a6ecc710f21226225", "patch": "@@ -8,6 +8,10 @@ LL |     Some(k) => match k {\n    |\n    = note: expected enum `Result<_, {integer}>`\n               found enum `Option<_>`\n+help: try wrapping the pattern in `Ok`\n+   |\n+LL |     Ok(Some(k)) => match k {\n+   |     +++       +\n \n error[E0308]: mismatched types\n   --> $DIR/issue-12552.rs:9:5\n@@ -20,6 +24,10 @@ LL |     None => ()\n    |\n    = note: expected enum `Result<_, {integer}>`\n               found enum `Option<_>`\n+help: try wrapping the pattern in `Ok`\n+   |\n+LL |     Ok(None) => ()\n+   |     +++    +\n \n error: aborting due to 2 previous errors\n "}, {"sha": "29ba44f136afa48b41a334d4cc87088b63df1819", "filename": "src/test/ui/issues/issue-3680.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fissues%2Fissue-3680.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fissues%2Fissue-3680.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-3680.stderr?ref=dd6683fcda991536c54d419a6ecc710f21226225", "patch": "@@ -8,6 +8,10 @@ LL |         Err(_) => ()\n    |\n    = note: expected enum `Option<_>`\n               found enum `Result<_, _>`\n+help: try wrapping the pattern in `Some`\n+   |\n+LL |         Some(Err(_)) => ()\n+   |         +++++      +\n \n error: aborting due to previous error\n "}, {"sha": "9d5b8d9d3fc1b9f08ba4566a337fc8ce5a3cdb85", "filename": "src/test/ui/issues/issue-5358-1.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fissues%2Fissue-5358-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd6683fcda991536c54d419a6ecc710f21226225/src%2Ftest%2Fui%2Fissues%2Fissue-5358-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-5358-1.stderr?ref=dd6683fcda991536c54d419a6ecc710f21226225", "patch": "@@ -8,6 +8,10 @@ LL |         Either::Right(_) => {}\n    |\n    = note: expected struct `S`\n                 found enum `Either<_, _>`\n+help: try wrapping the pattern in `S`\n+   |\n+LL |         S(Either::Right(_)) => {}\n+   |         ++                +\n help: you might have meant to use field `0` whose type is `Either<usize, usize>`\n    |\n LL |     match S(Either::Left(5)).0 {"}]}