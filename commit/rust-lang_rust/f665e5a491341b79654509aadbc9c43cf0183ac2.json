{"sha": "f665e5a491341b79654509aadbc9c43cf0183ac2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2NjVlNWE0OTEzNDFiNzk2NTQ1MDlhYWRiYzljNDNjZjAxODNhYzI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-03-27T19:37:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-27T19:37:09Z"}, "message": "Rollup merge of #82993 - camelid:source-use-diag, r=jyn514\n\nrustdoc: Use diagnostics for error when including sources\n\nThis error probably almost never happens, but we should still use the\ndiagnostic infrastructure. My guess is that the error was added back\nbefore rustdoc used the rustc diagnostic infrastructure (it was all\n`println!` and `eprintln!` back then!) and since it likely rarely occurs\nand this code doesn't change that much, no one thought to transition it\nto using diagnostics.\n\nNote that the old error was actually a warning (it didn't stop the rest\nof doc building). It seems very unlikely that this would fail without\nthe rest of the doc build failing, so it makes more sense for it to be a\nhard error.\n\nThe error looks like this:\n\n    error: failed to render source code for `src/test/rustdoc/smart-punct.rs`: \"bar\": foo\n      --> src/test/rustdoc/smart-punct.rs:3:1\n       |\n    3  | / #![crate_name = \"foo\"]\n    4  | |\n    5  | | //! This is the \"start\" of the 'document'! How'd you know that \"it's\" ...\n    6  | | //!\n    ...  |\n    22 | | //! I say \"don't smart-punct me -- please!\"\n    23 | | //! ```\n       | |_______^\n\nI wasn't sure how to trigger the error, so to create that message I\ntemporarily made rustdoc always emit it. That's also why it says \"bar\"\nand \"foo\" instead of a real error message.\n\nNote that the span of the diagnostic starts at line 3 because line 1 of\nthat file is a (non-doc) comment and line 2 is a blank line.", "tree": {"sha": "d34af82071f263013cb182cd56b3b2d8c9a3ad51", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d34af82071f263013cb182cd56b3b2d8c9a3ad51"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f665e5a491341b79654509aadbc9c43cf0183ac2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgX4llCRBK7hj4Ov3rIwAAdHIIAGJPJl6OC1Evi1wqCcC27G3X\nBd0SzFKXpJ+KpYcMZADuP5WRAgacYSGZ/88xtkejpqu9FG5D9rOdXABuOVCH4EqM\nUcoo0zjtxgicMBOidgFzTOAmqC3WH8n0UTReXQRNqKMvECGltwGDkGGKfoNqhhlF\nB+siN8sRa6cvzr91MCh3eb0eLk8PlHiDywzFkyPDsnJTxoo3qd3NvvDrm6ynw/kr\np9DwSxGYf4U3oZIIbUQKC+qj/tqhRp4SJN9NRM4lx2S4I1kp5QpIflqU3RvfoCG5\nRTu70JhlgpH4I1jC5WtXGBMP018zF5euheHtvGIVlId4F+6OK7aCTrM3FD1dvko=\n=9WUt\n-----END PGP SIGNATURE-----\n", "payload": "tree d34af82071f263013cb182cd56b3b2d8c9a3ad51\nparent b2e254318d4a23a07f2f7321c1a17430ba941ee9\nparent 3d8ce0aa55c182e569ad7015a0af752ef92e2572\nauthor Dylan DPC <dylan.dpc@gmail.com> 1616873829 +0100\ncommitter GitHub <noreply@github.com> 1616873829 +0100\n\nRollup merge of #82993 - camelid:source-use-diag, r=jyn514\n\nrustdoc: Use diagnostics for error when including sources\n\nThis error probably almost never happens, but we should still use the\ndiagnostic infrastructure. My guess is that the error was added back\nbefore rustdoc used the rustc diagnostic infrastructure (it was all\n`println!` and `eprintln!` back then!) and since it likely rarely occurs\nand this code doesn't change that much, no one thought to transition it\nto using diagnostics.\n\nNote that the old error was actually a warning (it didn't stop the rest\nof doc building). It seems very unlikely that this would fail without\nthe rest of the doc build failing, so it makes more sense for it to be a\nhard error.\n\nThe error looks like this:\n\n    error: failed to render source code for `src/test/rustdoc/smart-punct.rs`: \"bar\": foo\n      --> src/test/rustdoc/smart-punct.rs:3:1\n       |\n    3  | / #![crate_name = \"foo\"]\n    4  | |\n    5  | | //! This is the \"start\" of the 'document'! How'd you know that \"it's\" ...\n    6  | | //!\n    ...  |\n    22 | | //! I say \"don't smart-punct me -- please!\"\n    23 | | //! ```\n       | |_______^\n\nI wasn't sure how to trigger the error, so to create that message I\ntemporarily made rustdoc always emit it. That's also why it says \"bar\"\nand \"foo\" instead of a real error message.\n\nNote that the span of the diagnostic starts at line 3 because line 1 of\nthat file is a (non-doc) comment and line 2 is a blank line.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f665e5a491341b79654509aadbc9c43cf0183ac2", "html_url": "https://github.com/rust-lang/rust/commit/f665e5a491341b79654509aadbc9c43cf0183ac2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f665e5a491341b79654509aadbc9c43cf0183ac2/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2e254318d4a23a07f2f7321c1a17430ba941ee9", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2e254318d4a23a07f2f7321c1a17430ba941ee9", "html_url": "https://github.com/rust-lang/rust/commit/b2e254318d4a23a07f2f7321c1a17430ba941ee9"}, {"sha": "3d8ce0aa55c182e569ad7015a0af752ef92e2572", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d8ce0aa55c182e569ad7015a0af752ef92e2572", "html_url": "https://github.com/rust-lang/rust/commit/3d8ce0aa55c182e569ad7015a0af752ef92e2572"}], "stats": {"total": 8, "additions": 3, "deletions": 5}, "files": [{"sha": "001c8b090448bed2bb20ce825f4295a5a5c9155c", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f665e5a491341b79654509aadbc9c43cf0183ac2/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f665e5a491341b79654509aadbc9c43cf0183ac2/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=f665e5a491341b79654509aadbc9c43cf0183ac2", "patch": "@@ -54,12 +54,10 @@ impl DocFolder for SourceCollector<'_, '_> {\n             self.scx.include_sources = match self.emit_source(&filename) {\n                 Ok(()) => true,\n                 Err(e) => {\n-                    println!(\n-                        \"warning: source code was requested to be rendered, \\\n-                         but processing `{}` had an error: {}\",\n-                        filename, e\n+                    self.scx.tcx.sess.span_err(\n+                        item.span.inner(),\n+                        &format!(\"failed to render source code for `{}`: {}\", filename, e),\n                     );\n-                    println!(\"         skipping rendering of source code\");\n                     false\n                 }\n             };"}]}