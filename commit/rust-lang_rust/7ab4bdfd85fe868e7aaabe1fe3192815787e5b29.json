{"sha": "7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhYjRiZGZkODVmZTg2OGU3YWFhYmUxZmUzMTkyODE1Nzg3ZTViMjk=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-07-10T05:23:29Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-07-10T05:23:29Z"}, "message": "Use correct one line budget when rewriting index", "tree": {"sha": "f6dbe445a45676fbb325b59dff8e87957f79d7f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f6dbe445a45676fbb325b59dff8e87957f79d7f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "html_url": "https://github.com/rust-lang/rust/commit/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0a42648678b83f0af19116250dfc0bd4a2e1ac4c", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a42648678b83f0af19116250dfc0bd4a2e1ac4c", "html_url": "https://github.com/rust-lang/rust/commit/0a42648678b83f0af19116250dfc0bd4a2e1ac4c"}], "stats": {"total": 29, "additions": 22, "deletions": 7}, "files": [{"sha": "d9524c46fa52abb04ad4fae0f1d3437762afb2ce", "filename": "src/expr.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "patch": "@@ -2494,13 +2494,18 @@ fn rewrite_index(\n         (\"[\", \"]\")\n     };\n \n-    let offset = expr_str.len() + lbr.len();\n-    let orig_index_rw = shape\n-        .visual_indent(offset)\n-        .sub_width(offset + rbr.len())\n-        .and_then(|index_shape| index.rewrite(context, index_shape));\n+    let offset = last_line_width(&expr_str) + lbr.len();\n+    let rhs_overhead = shape.rhs_overhead(context.config);\n+    let index_shape = if expr_str.contains('\\n') {\n+        Shape::legacy(context.config.max_width(), shape.indent)\n+            .offset_left(offset)\n+            .and_then(|shape| shape.sub_width(rbr.len() + rhs_overhead))\n+    } else {\n+        shape.visual_indent(offset).sub_width(offset + rbr.len())\n+    };\n+    let orig_index_rw = index_shape.and_then(|s| index.rewrite(context, s));\n \n-    // Return if everything fits in a single line.\n+    // Return if index fits in a single line.\n     match orig_index_rw {\n         Some(ref index_str) if !index_str.contains('\\n') => {\n             return Some(format!(\"{}{}{}{}\", expr_str, lbr, index_str, rbr));\n@@ -2510,7 +2515,6 @@ fn rewrite_index(\n \n     // Try putting index on the next line and see if it fits in a single line.\n     let indent = shape.indent.block_indent(context.config);\n-    let rhs_overhead = shape.rhs_overhead(context.config);\n     let index_shape = try_opt!(Shape::indented(indent, context.config).offset_left(lbr.len()));\n     let index_shape = try_opt!(index_shape.sub_width(rbr.len() + rhs_overhead));\n     let new_index_rw = index.rewrite(context, index_shape);"}, {"sha": "fb0bd905d0aae5c26d931465153ea876ae251044", "filename": "tests/source/expr.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/tests%2Fsource%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/tests%2Fsource%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fexpr.rs?ref=7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "patch": "@@ -222,6 +222,8 @@ fn casts() {\n fn indices() {\n     let x = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa+bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb+cccccccccccccccc) [ x + y + z ];\n     let y = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb + cccccccccccccccc)[ xxxxx + yyyyy + zzzzz ];\n+    let z = xxxxxxxxxx.x().y().zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()[aaaaa];\n+    let z = xxxxxxxxxx.x().y().zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()[aaaaa];\n }\n \n fn repeats() {"}, {"sha": "26963540fcca036a69897b455f30a8371a2ad759", "filename": "tests/target/expr.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/tests%2Ftarget%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29/tests%2Ftarget%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fexpr.rs?ref=7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "patch": "@@ -283,6 +283,15 @@ fn indices() {\n         [x + y + z];\n     let y = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb + cccccccccccccccc)\n         [xxxxx + yyyyy + zzzzz];\n+    let z = xxxxxxxxxx\n+        .x()\n+        .y()\n+        .zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()[aaaaa];\n+    let z = xxxxxxxxxx\n+        .x()\n+        .y()\n+        .zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()\n+        [aaaaa];\n }\n \n fn repeats() {"}]}