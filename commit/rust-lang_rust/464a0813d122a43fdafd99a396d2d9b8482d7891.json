{"sha": "464a0813d122a43fdafd99a396d2d9b8482d7891", "node_id": "C_kwDOAAsO6NoAKDQ2NGEwODEzZDEyMmE0M2ZkYWZkOTlhMzk2ZDJkOWI4NDgyZDc4OTE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-09T12:38:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-09T12:38:30Z"}, "message": "Rollup merge of #92510 - inquisitivecrystal:foreign-block, r=cjgillot\n\nDon't resolve blocks in foreign functions\n\nAlthough it is an error for a foreign function to have a block, it is still possible at the level of the AST. #74204 made AST lowering skip over blocks belonging to foreign functions, since they're invalid. However, resolve still treated these blocks normally, resulting in a mismatch between the HIR and resolve, which could cause an ICE under certain circumstances. This PR changes resolve to skip over blocks belonging to foreign functions, as AST lowering does.\n\nFixes #91370.\n\nr? ``@cjgillot``", "tree": {"sha": "ed10fc49131fd65e0c12c425208810554ee9341a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed10fc49131fd65e0c12c425208810554ee9341a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/464a0813d122a43fdafd99a396d2d9b8482d7891", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh2tdGCRBK7hj4Ov3rIwAAgHUIAFq9PYhafczzcHxEuF7YAY5Q\n/qYArKOjf5CVU9bvsqEQq5+ZNDjElK5WC45tgP/SlMMLbAldbv16zGZOUkqnVbdE\nU7GXGqP63bua5FRq03HYB58KHQfFacdeD53Iv1Y1s+JmpPXF474XpMoNtvaX5myN\n7sQ+rcUjWpuaDOngMl71I+nVB+P61uft4nPFNDG/mHe7KiIWnn3K2lkWjggdVbaU\nFJmvNcOHsJcVj8eq20ieCIu9g/D4LzRnjLEHtl36MKVeg6FE4ViRUeekaE7Id517\nBSblxA3WO0xe1Cw45tJazoFTNk8B/fKO/vp94yR5W0bLyHh/qIFxoqYx44OnRSo=\n=v+jM\n-----END PGP SIGNATURE-----\n", "payload": "tree ed10fc49131fd65e0c12c425208810554ee9341a\nparent 598364c99533ddbdd033fdd727a5794536b56063\nparent 42de973099a14c0efa9059b1bf820d8a9c61f326\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1641731910 +0100\ncommitter GitHub <noreply@github.com> 1641731910 +0100\n\nRollup merge of #92510 - inquisitivecrystal:foreign-block, r=cjgillot\n\nDon't resolve blocks in foreign functions\n\nAlthough it is an error for a foreign function to have a block, it is still possible at the level of the AST. #74204 made AST lowering skip over blocks belonging to foreign functions, since they're invalid. However, resolve still treated these blocks normally, resulting in a mismatch between the HIR and resolve, which could cause an ICE under certain circumstances. This PR changes resolve to skip over blocks belonging to foreign functions, as AST lowering does.\n\nFixes #91370.\n\nr? ``@cjgillot``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/464a0813d122a43fdafd99a396d2d9b8482d7891", "html_url": "https://github.com/rust-lang/rust/commit/464a0813d122a43fdafd99a396d2d9b8482d7891", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/464a0813d122a43fdafd99a396d2d9b8482d7891/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "598364c99533ddbdd033fdd727a5794536b56063", "url": "https://api.github.com/repos/rust-lang/rust/commits/598364c99533ddbdd033fdd727a5794536b56063", "html_url": "https://github.com/rust-lang/rust/commit/598364c99533ddbdd033fdd727a5794536b56063"}, {"sha": "42de973099a14c0efa9059b1bf820d8a9c61f326", "url": "https://api.github.com/repos/rust-lang/rust/commits/42de973099a14c0efa9059b1bf820d8a9c61f326", "html_url": "https://github.com/rust-lang/rust/commit/42de973099a14c0efa9059b1bf820d8a9c61f326"}], "stats": {"total": 46, "additions": 43, "deletions": 3}, "files": [{"sha": "1b02511fd7c2f29934c626631aad5aa259ad6886", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/464a0813d122a43fdafd99a396d2d9b8482d7891/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/464a0813d122a43fdafd99a396d2d9b8482d7891/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=464a0813d122a43fdafd99a396d2d9b8482d7891", "patch": "@@ -520,9 +520,16 @@ impl<'a: 'ast, 'ast> Visitor<'ast> for LateResolutionVisitor<'a, '_, 'ast> {\n     }\n     fn visit_fn(&mut self, fn_kind: FnKind<'ast>, sp: Span, _: NodeId) {\n         let rib_kind = match fn_kind {\n-            // Bail if there's no body.\n-            FnKind::Fn(.., None) => return visit::walk_fn(self, fn_kind, sp),\n-            FnKind::Fn(FnCtxt::Free | FnCtxt::Foreign, ..) => FnItemRibKind,\n+            // Bail if the function is foreign, and thus cannot validly have\n+            // a body, or if there's no body for some other reason.\n+            FnKind::Fn(FnCtxt::Foreign, _, sig, ..) | FnKind::Fn(_, _, sig, .., None) => {\n+                // We don't need to deal with patterns in parameters, because\n+                // they are not possible for foreign or bodiless functions.\n+                self.visit_fn_header(&sig.header);\n+                visit::walk_fn_decl(self, &sig.decl);\n+                return;\n+            }\n+            FnKind::Fn(FnCtxt::Free, ..) => FnItemRibKind,\n             FnKind::Fn(FnCtxt::Assoc(_), ..) => NormalRibKind,\n             FnKind::Closure(..) => ClosureOrAsyncRibKind,\n         };"}, {"sha": "2ac3ca29355d849da230edb65f22277810446c52", "filename": "src/test/ui/foreign/issue-91370-foreign-fn-block-impl.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/464a0813d122a43fdafd99a396d2d9b8482d7891/src%2Ftest%2Fui%2Fforeign%2Fissue-91370-foreign-fn-block-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/464a0813d122a43fdafd99a396d2d9b8482d7891/src%2Ftest%2Fui%2Fforeign%2Fissue-91370-foreign-fn-block-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fforeign%2Fissue-91370-foreign-fn-block-impl.rs?ref=464a0813d122a43fdafd99a396d2d9b8482d7891", "patch": "@@ -0,0 +1,12 @@\n+// Regression test for issue #91370.\n+\n+extern {\n+    //~^ `extern` blocks define existing foreign functions\n+    fn f() {\n+        //~^ incorrect function inside `extern` block\n+        //~| cannot have a body\n+        impl Copy for u8 {}\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "4fb2f8c659c53786ddfd4db2d95485ca125b16b3", "filename": "src/test/ui/foreign/issue-91370-foreign-fn-block-impl.stderr", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/464a0813d122a43fdafd99a396d2d9b8482d7891/src%2Ftest%2Fui%2Fforeign%2Fissue-91370-foreign-fn-block-impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/464a0813d122a43fdafd99a396d2d9b8482d7891/src%2Ftest%2Fui%2Fforeign%2Fissue-91370-foreign-fn-block-impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fforeign%2Fissue-91370-foreign-fn-block-impl.stderr?ref=464a0813d122a43fdafd99a396d2d9b8482d7891", "patch": "@@ -0,0 +1,21 @@\n+error: incorrect function inside `extern` block\n+  --> $DIR/issue-91370-foreign-fn-block-impl.rs:5:8\n+   |\n+LL |   extern {\n+   |   ------ `extern` blocks define existing foreign functions and functions inside of them cannot have a body\n+LL |\n+LL |       fn f() {\n+   |  ________^___-\n+   | |        |\n+   | |        cannot have a body\n+LL | |\n+LL | |\n+LL | |         impl Copy for u8 {}\n+LL | |     }\n+   | |_____- help: remove the invalid body: `;`\n+   |\n+   = help: you might have meant to write a function accessible through FFI, which can be done by writing `extern fn` outside of the `extern` block\n+   = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n+\n+error: aborting due to previous error\n+"}]}