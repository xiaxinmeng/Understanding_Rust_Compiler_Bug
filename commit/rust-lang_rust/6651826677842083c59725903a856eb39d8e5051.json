{"sha": "6651826677842083c59725903a856eb39d8e5051", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2NTE4MjY2Nzc4NDIwODNjNTk3MjU5MDNhODU2ZWIzOWQ4ZTUwNTE=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-04-19T23:40:46Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-04-19T23:41:08Z"}, "message": "rustc: Cache the results of type_of()", "tree": {"sha": "b1ffc8f3bf31b7c1432ef9c600849b6b5cb56bd2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1ffc8f3bf31b7c1432ef9c600849b6b5cb56bd2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6651826677842083c59725903a856eb39d8e5051", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6651826677842083c59725903a856eb39d8e5051", "html_url": "https://github.com/rust-lang/rust/commit/6651826677842083c59725903a856eb39d8e5051", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6651826677842083c59725903a856eb39d8e5051/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5475c0009ca594e86ddb4c122a88e63261299e8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5475c0009ca594e86ddb4c122a88e63261299e8f", "html_url": "https://github.com/rust-lang/rust/commit/5475c0009ca594e86ddb4c122a88e63261299e8f"}], "stats": {"total": 41, "additions": 25, "deletions": 16}, "files": [{"sha": "d3ccd909805e6c88619f9ef7776894569ab0c0f3", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6651826677842083c59725903a856eb39d8e5051/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6651826677842083c59725903a856eb39d8e5051/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=6651826677842083c59725903a856eb39d8e5051", "patch": "@@ -110,6 +110,7 @@ state type crate_ctxt = rec(session.session sess,\n                             hashmap[ast.def_id,()] obj_methods,\n                             hashmap[@ty.t, @tydesc_info] tydescs,\n                             hashmap[str, ValueRef] module_data,\n+                            hashmap[@ty.t, TypeRef] lltypes,\n                             @glue_fns glues,\n                             namegen names,\n                             vec[str] path,\n@@ -676,6 +677,11 @@ fn type_of_native_fn(@crate_ctxt cx, ast.native_abi abi,\n }\n \n fn type_of_inner(@crate_ctxt cx, @ty.t t) -> TypeRef {\n+    // Check the cache.\n+    if (cx.lltypes.contains_key(t)) {\n+        ret cx.lltypes.get(t);\n+    }\n+\n     let TypeRef llty = 0 as TypeRef;\n \n     alt (t.struct) {\n@@ -779,6 +785,7 @@ fn type_of_inner(@crate_ctxt cx, @ty.t t) -> TypeRef {\n \n     check (llty as int != 0);\n     llvm.LLVMAddTypeName(cx.llmod, _str.buf(ty.ty_to_str(t)), llty);\n+    cx.lltypes.insert(t, llty);\n     ret llty;\n }\n \n@@ -7476,6 +7483,7 @@ fn trans_crate(session.session sess, @ast.crate crate,\n     auto eqer = ty.eq_ty;\n     auto tag_sizes = map.mk_hashmap[@ty.t,uint](hasher, eqer);\n     auto tydescs = map.mk_hashmap[@ty.t,@tydesc_info](hasher, eqer);\n+    auto lltypes = map.mk_hashmap[@ty.t,TypeRef](hasher, eqer);\n     let vec[ast.ty_param] obj_typarams = vec();\n     let vec[ast.obj_field] obj_fields = vec();\n \n@@ -7500,6 +7508,7 @@ fn trans_crate(session.session sess, @ast.crate crate,\n                     obj_methods = new_def_hash[()](),\n                     tydescs = tydescs,\n                     module_data = new_str_hash[ValueRef](),\n+                    lltypes = lltypes,\n                     glues = glues,\n                     names = namegen(0),\n                     path = pth,"}, {"sha": "950b43b0c5201c9c91c2e8ecc9a48b4591bcb93c", "filename": "src/comp/rustc.rc", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/6651826677842083c59725903a856eb39d8e5051/src%2Fcomp%2Frustc.rc", "raw_url": "https://github.com/rust-lang/rust/raw/6651826677842083c59725903a856eb39d8e5051/src%2Fcomp%2Frustc.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Frustc.rc?ref=6651826677842083c59725903a856eb39d8e5051", "patch": "@@ -3,6 +3,22 @@\n \n use std;\n \n+mod middle {\n+    mod trans;\n+    mod ty;\n+    mod fold;\n+    mod metadata;\n+    mod resolve;\n+    mod capture;\n+    mod typeck;\n+    mod typestate_check;\n+}\n+\n+mod pretty {\n+    mod pprust;\n+    mod pp;\n+}\n+\n mod front {\n     mod ast;\n     mod creader;\n@@ -14,17 +30,6 @@ mod front {\n     mod eval;\n }\n \n-mod middle {\n-    mod fold;\n-    mod metadata;\n-    mod resolve;\n-    mod capture;\n-    mod trans;\n-    mod ty;\n-    mod typeck;\n-    mod typestate_check;\n-}\n-\n mod back {\n     mod abi;\n     mod x86;\n@@ -35,11 +40,6 @@ mod driver {\n     mod session;\n }\n \n-mod pretty {\n-    mod pp;\n-    mod pprust;\n-}\n-\n mod util {\n     mod common;\n     mod typestate_ann;"}]}