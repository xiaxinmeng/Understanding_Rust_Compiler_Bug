{"sha": "953727f57474e540315ef16f11ad7dfafdfd9db9", "node_id": "C_kwDOAAsO6NoAKDk1MzcyN2Y1NzQ3NGU1NDAzMTVlZjE2ZjExYWQ3ZGZhZmRmZDlkYjk", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-30T19:10:35Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-30T19:11:55Z"}, "message": "better error for rustc_strict_coherence misuse", "tree": {"sha": "739023261eec52399ff38e8256f44b9d810cc2c1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/739023261eec52399ff38e8256f44b9d810cc2c1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/953727f57474e540315ef16f11ad7dfafdfd9db9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/953727f57474e540315ef16f11ad7dfafdfd9db9", "html_url": "https://github.com/rust-lang/rust/commit/953727f57474e540315ef16f11ad7dfafdfd9db9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/953727f57474e540315ef16f11ad7dfafdfd9db9/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ab74459b86465e751fc8f6fa9934687423ce2a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ab74459b86465e751fc8f6fa9934687423ce2a6", "html_url": "https://github.com/rust-lang/rust/commit/5ab74459b86465e751fc8f6fa9934687423ce2a6"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "81d8e8a473bb7184ca5b3892d727eb7523954682", "filename": "compiler/rustc_error_messages/locales/en-US/middle.ftl", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/953727f57474e540315ef16f11ad7dfafdfd9db9/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmiddle.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/953727f57474e540315ef16f11ad7dfafdfd9db9/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmiddle.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmiddle.ftl?ref=953727f57474e540315ef16f11ad7dfafdfd9db9", "patch": "@@ -27,3 +27,7 @@ middle_values_too_big =\n \n middle_cannot_be_normalized =\n     unable to determine layout for `{$ty}` because `{$failure_ty}` cannot be normalized\n+\n+middle_strict_coherence_needs_negative_coherence =\n+    to use `strict_coherence` on this trait, the `with_negative_coherence` feature must be enabled\n+    .label = due to this attribute"}, {"sha": "43903e6739f9195bd56bdfdecde6e38226f86fea", "filename": "compiler/rustc_middle/src/error.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/953727f57474e540315ef16f11ad7dfafdfd9db9/compiler%2Frustc_middle%2Fsrc%2Ferror.rs", "raw_url": "https://github.com/rust-lang/rust/raw/953727f57474e540315ef16f11ad7dfafdfd9db9/compiler%2Frustc_middle%2Fsrc%2Ferror.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ferror.rs?ref=953727f57474e540315ef16f11ad7dfafdfd9db9", "patch": "@@ -55,3 +55,12 @@ pub struct ConstEvalNonIntError {\n     #[primary_span]\n     pub span: Span,\n }\n+\n+#[derive(Diagnostic)]\n+#[diag(middle_strict_coherence_needs_negative_coherence)]\n+pub(crate) struct StrictCoherenceNeedsNegativeCoherence {\n+    #[primary_span]\n+    pub span: Span,\n+    #[label]\n+    pub attr_span: Option<Span>,\n+}"}, {"sha": "f1c2158826189eb5a7a7205e432e10ae1398c50c", "filename": "compiler/rustc_middle/src/traits/specialization_graph.rs", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/953727f57474e540315ef16f11ad7dfafdfd9db9/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fspecialization_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/953727f57474e540315ef16f11ad7dfafdfd9db9/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fspecialization_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fspecialization_graph.rs?ref=953727f57474e540315ef16f11ad7dfafdfd9db9", "patch": "@@ -1,3 +1,4 @@\n+use crate::error::StrictCoherenceNeedsNegativeCoherence;\n use crate::ty::fast_reject::SimplifiedType;\n use crate::ty::visit::TypeVisitable;\n use crate::ty::{self, TyCtxt};\n@@ -65,9 +66,21 @@ impl OverlapMode {\n \n         if with_negative_coherence {\n             if strict_coherence { OverlapMode::Strict } else { OverlapMode::WithNegative }\n-        } else if strict_coherence {\n-            bug!(\"To use strict_coherence you need to set with_negative_coherence feature flag\");\n         } else {\n+            if strict_coherence {\n+                let attr_span = trait_id\n+                    .as_local()\n+                    .into_iter()\n+                    .flat_map(|local_def_id| {\n+                        tcx.hir().attrs(tcx.hir().local_def_id_to_hir_id(local_def_id))\n+                    })\n+                    .find(|attr| attr.has_name(sym::rustc_strict_coherence))\n+                    .map(|attr| attr.span);\n+                tcx.sess.emit_err(StrictCoherenceNeedsNegativeCoherence {\n+                    span: tcx.def_span(trait_id),\n+                    attr_span,\n+                });\n+            }\n             OverlapMode::Stable\n         }\n     }"}, {"sha": "221683dd56f480a30e087616def60aa22b6320a9", "filename": "src/test/ui/coherence/strict-coherence-needs-negative-coherence.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/953727f57474e540315ef16f11ad7dfafdfd9db9/src%2Ftest%2Fui%2Fcoherence%2Fstrict-coherence-needs-negative-coherence.rs", "raw_url": "https://github.com/rust-lang/rust/raw/953727f57474e540315ef16f11ad7dfafdfd9db9/src%2Ftest%2Fui%2Fcoherence%2Fstrict-coherence-needs-negative-coherence.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fstrict-coherence-needs-negative-coherence.rs?ref=953727f57474e540315ef16f11ad7dfafdfd9db9", "patch": "@@ -0,0 +1,7 @@\n+#![feature(rustc_attrs)]\n+\n+#[rustc_strict_coherence]\n+trait Foo {}\n+//~^ ERROR to use `strict_coherence` on this trait, the `with_negative_coherence` feature must be enabled\n+\n+fn main() {}"}, {"sha": "b5472928778eb3b13f2863fcd5a8847933cc2b6d", "filename": "src/test/ui/coherence/strict-coherence-needs-negative-coherence.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/953727f57474e540315ef16f11ad7dfafdfd9db9/src%2Ftest%2Fui%2Fcoherence%2Fstrict-coherence-needs-negative-coherence.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/953727f57474e540315ef16f11ad7dfafdfd9db9/src%2Ftest%2Fui%2Fcoherence%2Fstrict-coherence-needs-negative-coherence.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fstrict-coherence-needs-negative-coherence.stderr?ref=953727f57474e540315ef16f11ad7dfafdfd9db9", "patch": "@@ -0,0 +1,10 @@\n+error: to use `strict_coherence` on this trait, the `with_negative_coherence` feature must be enabled\n+  --> $DIR/strict-coherence-needs-negative-coherence.rs:4:1\n+   |\n+LL | #[rustc_strict_coherence]\n+   | ------------------------- due to this attribute\n+LL | trait Foo {}\n+   | ^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}