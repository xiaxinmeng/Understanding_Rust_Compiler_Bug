{"sha": "598364c99533ddbdd033fdd727a5794536b56063", "node_id": "C_kwDOAAsO6NoAKDU5ODM2NGM5OTUzM2RkYmRkMDMzZmRkNzI3YTU3OTQ1MzZiNTYwNjM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-09T12:38:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-09T12:38:29Z"}, "message": "Rollup merge of #92490 - jsha:crates-in-results, r=GuillaumeGomez\n\nMove crate drop-down to search results page\n\nThis reduces clutter on doc pages.\n\nPart of #59840\n\nr? ```@GuillaumeGomez```\n\nDemo: https://rustdoc.crud.net/jsha/crates-in-results/std/index.html?search=str", "tree": {"sha": "e384737a0abdab3a553160b06d2d64492ff40e1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e384737a0abdab3a553160b06d2d64492ff40e1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/598364c99533ddbdd033fdd727a5794536b56063", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh2tdFCRBK7hj4Ov3rIwAAQpEIAExGFCDBaX8rswQ75qGVwXgZ\no5g/LWgvkJB7wyibBUmaepyhniv68406QmnTYShwe4HQZ5ukzUmAj/w9ySbIUjKn\nZIeRLxfqAXXOjvn+tKi/tJSAFILYxgtt+8fd+BHSLiGclKQvdyWOreHukpQuZX1X\nlHCUv2qo4Kogsn13x8qELEjjdFdhJg+ZE/9H5RIQ0y7d2C40ZoNubT0Me1NbWbjB\neFBxekhLODFJF4cyUmMlN3PVrzZOhPqa33QCTcDOm/9KXFClTg8tUOD49ecwfPWP\ns5Db6H5J5VrNvsKlJyEdIULoLjnHfAQEIaW7Dnpv5OoYfVTJFciX71YgIu73e2c=\n=SxxW\n-----END PGP SIGNATURE-----\n", "payload": "tree e384737a0abdab3a553160b06d2d64492ff40e1e\nparent 8dc3bf7221d69e4fbfb847ed209c39aae3f6c7a9\nparent 8abb4bb698c9d74507adb9cd7b54a032f3c1b595\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1641731909 +0100\ncommitter GitHub <noreply@github.com> 1641731909 +0100\n\nRollup merge of #92490 - jsha:crates-in-results, r=GuillaumeGomez\n\nMove crate drop-down to search results page\n\nThis reduces clutter on doc pages.\n\nPart of #59840\n\nr? ```@GuillaumeGomez```\n\nDemo: https://rustdoc.crud.net/jsha/crates-in-results/std/index.html?search=str\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/598364c99533ddbdd033fdd727a5794536b56063", "html_url": "https://github.com/rust-lang/rust/commit/598364c99533ddbdd033fdd727a5794536b56063", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/598364c99533ddbdd033fdd727a5794536b56063/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8dc3bf7221d69e4fbfb847ed209c39aae3f6c7a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/8dc3bf7221d69e4fbfb847ed209c39aae3f6c7a9", "html_url": "https://github.com/rust-lang/rust/commit/8dc3bf7221d69e4fbfb847ed209c39aae3f6c7a9"}, {"sha": "8abb4bb698c9d74507adb9cd7b54a032f3c1b595", "url": "https://api.github.com/repos/rust-lang/rust/commits/8abb4bb698c9d74507adb9cd7b54a032f3c1b595", "html_url": "https://github.com/rust-lang/rust/commit/8abb4bb698c9d74507adb9cd7b54a032f3c1b595"}], "stats": {"total": 85, "additions": 45, "deletions": 40}, "files": [{"sha": "66333e2b99214a3e9ab794afce703b991ba6ba0c", "filename": "src/ci/docker/host-x86_64/mingw-check/Dockerfile", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Fci%2Fdocker%2Fhost-x86_64%2Fmingw-check%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Fci%2Fdocker%2Fhost-x86_64%2Fmingw-check%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fmingw-check%2FDockerfile?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -17,12 +17,12 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   pkg-config \\\n   mingw-w64\n \n-RUN curl -sL https://nodejs.org/dist/v14.4.0/node-v14.4.0-linux-x64.tar.xz | tar -xJ\n-ENV PATH=\"/node-v14.4.0-linux-x64/bin:${PATH}\"\n+RUN curl -sL https://nodejs.org/dist/v16.9.0/node-v16.9.0-linux-x64.tar.xz | tar -xJ\n+ENV PATH=\"/node-v16.9.0-linux-x64/bin:${PATH}\"\n # Install es-check\n # Pin its version to prevent unrelated CI failures due to future es-check versions.\n-RUN npm install es-check@5.2.3 -g\n-RUN npm install eslint@7.20.0 -g\n+RUN npm install es-check@6.1.1 -g\n+RUN npm install eslint@8.6.0 -g\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n@@ -40,5 +40,5 @@ ENV SCRIPT python3 ../x.py --stage 2 test src/tools/expand-yaml-anchors && \\\n            /scripts/validate-toolstate.sh && \\\n            /scripts/validate-error-codes.sh && \\\n            # Runs checks to ensure that there are no ES5 issues in our JS code.\n-           es-check es5 ../src/librustdoc/html/static/js/*.js && \\\n+           es-check es6 ../src/librustdoc/html/static/js/*.js && \\\n            eslint ../src/librustdoc/html/static/js/*.js"}, {"sha": "fab64abc3e1493c2eab1a9e6b3952522d16a7cd9", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -866,18 +866,24 @@ h2.small-section-header > .anchor {\n \tdisplay: inline-flex;\n \twidth: calc(100% - 63px);\n }\n+.search-results-title {\n+\tdisplay: inline;\n+}\n+#search-settings {\n+\tfont-size: 1.5rem;\n+\tfont-weight: 500;\n+\tmargin-bottom: 20px;\n+}\n #crate-search {\n \tmin-width: 115px;\n \tmargin-top: 5px;\n-\tpadding: 6px;\n-\tpadding-right: 19px;\n-\tflex: none;\n+\tmargin-left: 0.2em;\n+\tpadding-left: 0.3em;\n+\tpadding-right: 23px;\n \tborder: 0;\n-\tborder-right: 0;\n-\tborder-radius: 4px 0 0 4px;\n+\tborder-radius: 4px;\n \toutline: none;\n \tcursor: pointer;\n-\tborder-right: 1px solid;\n \t-moz-appearance: none;\n \t-webkit-appearance: none;\n \t/* Removes default arrow from firefox */"}, {"sha": "e859431e1f189e68a7b761d85374b89df4a929a4", "filename": "src/librustdoc/html/static/js/search.js", "status": "modified", "additions": 22, "deletions": 17, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -1085,7 +1085,7 @@ window.initSearch = function(rawSearchIndex) {\n         return \"<button>\" + text + \" <div class=\\\"count\\\">(\" + nbElems + \")</div></button>\";\n     }\n \n-    function showResults(results, go_to_first) {\n+    function showResults(results, go_to_first, filterCrates) {\n         var search = searchState.outputElement();\n         if (go_to_first || (results.others.length === 1\n             && getSettingValue(\"go-to-only-result\") === \"true\"\n@@ -1126,9 +1126,16 @@ window.initSearch = function(rawSearchIndex) {\n             }\n         }\n \n-        var output = \"<h1>Results for \" + escape(query.query) +\n+        let crates = `<select id=\"crate-search\"><option value=\"All crates\">All crates</option>`;\n+        for (let c of window.ALL_CRATES) {\n+            crates += `<option value=\"${c}\" ${c == filterCrates && \"selected\"}>${c}</option>`;\n+        }\n+        crates += `</select>`;\n+        var output = `<div id=\"search-settings\">\n+            <h1 class=\"search-results-title\">Results for ${escape(query.query)} ` +\n             (query.type ? \" (type: \" + escape(query.type) + \")\" : \"\") + \"</h1>\" +\n-            \"<div id=\\\"titles\\\">\" +\n+            ` in ${crates} ` +\n+            `</div><div id=\"titles\">` +\n             makeTabHeader(0, \"In Names\", ret_others[1]) +\n             makeTabHeader(1, \"In Parameters\", ret_in_args[1]) +\n             makeTabHeader(2, \"In Return Types\", ret_returned[1]) +\n@@ -1141,6 +1148,7 @@ window.initSearch = function(rawSearchIndex) {\n         resultsElem.appendChild(ret_returned[0]);\n \n         search.innerHTML = output;\n+        document.getElementById(\"crate-search\").addEventListener(\"input\", updateCrate);\n         search.appendChild(resultsElem);\n         // Reset focused elements.\n         searchState.focusedByTab = [null, null, null];\n@@ -1316,7 +1324,8 @@ window.initSearch = function(rawSearchIndex) {\n         }\n \n         var filterCrates = getFilterCrates();\n-        showResults(execSearch(query, searchWords, filterCrates), params[\"go_to_first\"]);\n+        showResults(execSearch(query, searchWords, filterCrates),\n+            params[\"go_to_first\"], filterCrates);\n     }\n \n     function buildIndex(rawSearchIndex) {\n@@ -1552,19 +1561,6 @@ window.initSearch = function(rawSearchIndex) {\n             }\n         });\n \n-\n-        var selectCrate = document.getElementById(\"crate-search\");\n-        if (selectCrate) {\n-            selectCrate.onchange = function() {\n-                updateLocalStorage(\"rustdoc-saved-filter-crate\", selectCrate.value);\n-                // In case you \"cut\" the entry from the search input, then change the crate filter\n-                // before paste back the previous search, you get the old search results without\n-                // the filter. To prevent this, we need to remove the previous results.\n-                currentResults = null;\n-                search(undefined, true);\n-            };\n-        }\n-\n         // Push and pop states are used to add search results to the browser\n         // history.\n         if (searchState.browserSupportsHistoryApi()) {\n@@ -1616,6 +1612,15 @@ window.initSearch = function(rawSearchIndex) {\n         };\n     }\n \n+    function updateCrate(ev) {\n+        updateLocalStorage(\"rustdoc-saved-filter-crate\", ev.target.value);\n+        // In case you \"cut\" the entry from the search input, then change the crate filter\n+        // before paste back the previous search, you get the old search results without\n+        // the filter. To prevent this, we need to remove the previous results.\n+        currentResults = null;\n+        search(undefined, true);\n+    }\n+\n     searchWords = buildIndex(rawSearchIndex);\n     registerSearchEvents();\n     // If there's a search term in the URL, execute the search now."}, {"sha": "5cade1b1a4c73d370929ef831f7eb2eeca368913", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -105,11 +105,7 @@\n                     </div> {#- -#}\n                     <form class=\"search-form\"> {#- -#}\n                         <div class=\"search-container\"> {#- -#}\n-                            <div>{%- if layout.generate_search_filter -%}\n-                                <select id=\"crate-search\"> {#- -#}\n-                                    <option value=\"All crates\">All crates</option> {#- -#}\n-                                </select> {#- -#}\n-                                {%- endif -%}\n+                            <div>\n                                 <input {# -#}\n                                     class=\"search-input\" {# -#}\n                                     name=\"search\" {# -#}"}, {"sha": "712920b16a91babf02b44faa00719b5ec5bf0b5a", "filename": "src/test/rustdoc-gui/escape-key.goml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Ftest%2Frustdoc-gui%2Fescape-key.goml", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Ftest%2Frustdoc-gui%2Fescape-key.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fescape-key.goml?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -1,7 +1,7 @@\n goto: file://|DOC_PATH|/test_docs/index.html\n // First, we check that the search results are hidden when the Escape key is pressed.\n write: (\".search-input\", \"test\")\n-wait-for: \"#search > h1\" // The search element is empty before the first search \n+wait-for: \"#search h1\" // The search element is empty before the first search \n assert-attribute: (\"#search\", {\"class\": \"content\"})\n assert-attribute: (\"#main-content\", {\"class\": \"content hidden\"})\n press-key: \"Escape\""}, {"sha": "e5cdf3ea7a1699c3636e58c675bdb50f93122291", "filename": "src/test/rustdoc-gui/search-filter.goml", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Ftest%2Frustdoc-gui%2Fsearch-filter.goml", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Ftest%2Frustdoc-gui%2Fsearch-filter.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsearch-filter.goml?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -5,14 +5,12 @@ write: (\".search-input\", \"test\")\n wait-for: \"#titles\"\n assert-text: (\"#results .externcrate\", \"test_docs\")\n \n-goto: file://|DOC_PATH|/test_docs/index.html\n+wait-for: \"#crate-search\"\n // We now want to change the crate filter.\n click: \"#crate-search\"\n // We select \"lib2\" option then press enter to change the filter.\n press-key: \"ArrowDown\"\n press-key: \"Enter\"\n-// We now make the search again.\n-write: (\".search-input\", \"test\")\n // Waiting for the search results to appear...\n wait-for: \"#titles\"\n // We check that there is no more \"test_docs\" appearing."}, {"sha": "6e0ad8e0fa7fbcc48020e4bea2b82ae8ac393137", "filename": "src/test/rustdoc-gui/toggle-docs-mobile.goml", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/598364c99533ddbdd033fdd727a5794536b56063/src%2Ftest%2Frustdoc-gui%2Ftoggle-docs-mobile.goml", "raw_url": "https://github.com/rust-lang/rust/raw/598364c99533ddbdd033fdd727a5794536b56063/src%2Ftest%2Frustdoc-gui%2Ftoggle-docs-mobile.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Ftoggle-docs-mobile.goml?ref=598364c99533ddbdd033fdd727a5794536b56063", "patch": "@@ -1,12 +1,12 @@\n goto: file://|DOC_PATH|/test_docs/struct.Foo.html\n size: (433, 600)\n assert-attribute: (\".top-doc\", {\"open\": \"\"})\n-click: (4, 280) // This is the position of the top doc comment toggle\n+click: (4, 240) // This is the position of the top doc comment toggle\n assert-attribute-false: (\".top-doc\", {\"open\": \"\"})\n-click: (4, 280)\n+click: (4, 240)\n assert-attribute: (\".top-doc\", {\"open\": \"\"})\n // To ensure that the toggle isn't over the text, we check that the toggle isn't clicked.\n-click: (3, 280)\n+click: (3, 240)\n assert-attribute: (\".top-doc\", {\"open\": \"\"})\n \n // Assert the position of the toggle on the top doc block."}]}