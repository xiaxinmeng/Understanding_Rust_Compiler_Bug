{"sha": "64bf5a8687c78cf7dc605cc8c8b63748a2746943", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY0YmY1YTg2ODdjNzhjZjdkYzYwNWNjOGM4YjYzNzQ4YTI3NDY5NDM=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2014-12-04T01:23:15Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2014-12-04T06:49:42Z"}, "message": "Add a cache so we don't create so many shims.", "tree": {"sha": "b9a35f5e0a2b1eee1749e8848fbe5306aeffe188", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b9a35f5e0a2b1eee1749e8848fbe5306aeffe188"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/64bf5a8687c78cf7dc605cc8c8b63748a2746943", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/64bf5a8687c78cf7dc605cc8c8b63748a2746943", "html_url": "https://github.com/rust-lang/rust/commit/64bf5a8687c78cf7dc605cc8c8b63748a2746943", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/64bf5a8687c78cf7dc605cc8c8b63748a2746943/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39221a013fdbfcc05d44fc7a62650f62c7b833e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/39221a013fdbfcc05d44fc7a62650f62c7b833e9", "html_url": "https://github.com/rust-lang/rust/commit/39221a013fdbfcc05d44fc7a62650f62c7b833e9"}], "stats": {"total": 13, "additions": 13, "deletions": 0}, "files": [{"sha": "176fe7096e751c885517512145b2a2fbd7309884", "filename": "src/librustc_trans/trans/callee.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/64bf5a8687c78cf7dc605cc8c8b63748a2746943/src%2Flibrustc_trans%2Ftrans%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64bf5a8687c78cf7dc605cc8c8b63748a2746943/src%2Flibrustc_trans%2Ftrans%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fcallee.rs?ref=64bf5a8687c78cf7dc605cc8c8b63748a2746943", "patch": "@@ -262,6 +262,12 @@ pub fn trans_fn_pointer_shim<'a, 'tcx>(\n     let _icx = push_ctxt(\"trans_fn_pointer_shim\");\n     let tcx = ccx.tcx();\n \n+    let bare_fn_ty = ty::normalize_ty(tcx, bare_fn_ty);\n+    match ccx.fn_pointer_shims().borrow().get(&bare_fn_ty) {\n+        Some(&llval) => { return llval; }\n+        None => { }\n+    }\n+\n     debug!(\"trans_fn_pointer_shim(bare_fn_ty={})\",\n            bare_fn_ty.repr(tcx));\n \n@@ -345,6 +351,8 @@ pub fn trans_fn_pointer_shim<'a, 'tcx>(\n \n     finish_fn(&fcx, bcx, output_ty);\n \n+    ccx.fn_pointer_shims().borrow_mut().insert(bare_fn_ty, llfn);\n+\n     llfn\n }\n "}, {"sha": "eedfd8df2c0abe295fcb379043d4427e0a0b413e", "filename": "src/librustc_trans/trans/context.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/64bf5a8687c78cf7dc605cc8c8b63748a2746943/src%2Flibrustc_trans%2Ftrans%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64bf5a8687c78cf7dc605cc8c8b63748a2746943/src%2Flibrustc_trans%2Ftrans%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fcontext.rs?ref=64bf5a8687c78cf7dc605cc8c8b63748a2746943", "patch": "@@ -84,6 +84,7 @@ pub struct LocalCrateContext<'tcx> {\n     tn: TypeNames,\n     externs: RefCell<ExternMap>,\n     item_vals: RefCell<NodeMap<ValueRef>>,\n+    fn_pointer_shims: RefCell<FnvHashMap<Ty<'tcx>, ValueRef>>,\n     drop_glues: RefCell<FnvHashMap<Ty<'tcx>, ValueRef>>,\n     tydescs: RefCell<FnvHashMap<Ty<'tcx>, Rc<tydesc_info<'tcx>>>>,\n     /// Set when running emit_tydescs to enforce that no more tydescs are\n@@ -573,6 +574,10 @@ impl<'b, 'tcx> CrateContext<'b, 'tcx> {\n         &self.shared.link_meta\n     }\n \n+    pub fn fn_pointer_shims(&self) -> &RefCell<FnvHashMap<Ty<'tcx>, ValueRef>> {\n+        &self.local.fn_pointer_shims\n+    }\n+\n     pub fn drop_glues<'a>(&'a self) -> &'a RefCell<FnvHashMap<Ty<'tcx>, ValueRef>> {\n         &self.local.drop_glues\n     }"}]}