{"sha": "9205e3d800c09c826d6ef6533a00d231cfce8f5a", "node_id": "C_kwDOAAsO6NoAKDkyMDVlM2Q4MDBjMDljODI2ZDZlZjY1MzNhMDBkMjMxY2ZjZThmNWE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-10T11:13:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-10T11:13:05Z"}, "message": "Auto merge of #7800 - 1nF0rmed:no-lint-in-match-single-amp, r=llogiq\n\nRefactor `clippy::match_ref_pats` to check for multiple reference patterns\n\nfixes #7740\n\nWhen there is only one pattern, to begin with, i.e. a single deref(`&`), then in such cases we suppress `clippy::match_ref_pats`.\nThis is done by checking the count of the reference pattern and emitting `clippy::match_ref_pats` when more than one pattern is present.\n\nRemoved certain errors in the `stderr` tests as they would not be triggered.\n\nchangelog: Refactor `clippy::match_ref_pats` to check for multiple reference patterns", "tree": {"sha": "440c33e5fdbe32fa8aa769609636214ea53f36fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/440c33e5fdbe32fa8aa769609636214ea53f36fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9205e3d800c09c826d6ef6533a00d231cfce8f5a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9205e3d800c09c826d6ef6533a00d231cfce8f5a", "html_url": "https://github.com/rust-lang/rust/commit/9205e3d800c09c826d6ef6533a00d231cfce8f5a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9205e3d800c09c826d6ef6533a00d231cfce8f5a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f1555f123be0c58390679c8aa99dca9b79c1bf3", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f1555f123be0c58390679c8aa99dca9b79c1bf3", "html_url": "https://github.com/rust-lang/rust/commit/8f1555f123be0c58390679c8aa99dca9b79c1bf3"}, {"sha": "1080f6c70c132ef20bf0310c1845c92f55a3d5b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/1080f6c70c132ef20bf0310c1845c92f55a3d5b5", "html_url": "https://github.com/rust-lang/rust/commit/1080f6c70c132ef20bf0310c1845c92f55a3d5b5"}], "stats": {"total": 144, "additions": 58, "deletions": 86}, "files": [{"sha": "b643fba5d328865baded5f1192cca02fa6ae979a", "filename": "clippy_lints/src/matches.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9205e3d800c09c826d6ef6533a00d231cfce8f5a/clippy_lints%2Fsrc%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9205e3d800c09c826d6ef6533a00d231cfce8f5a/clippy_lints%2Fsrc%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches.rs?ref=9205e3d800c09c826d6ef6533a00d231cfce8f5a", "patch": "@@ -1187,7 +1187,7 @@ where\n     'b: 'a,\n     I: Clone + Iterator<Item = &'a Pat<'b>>,\n {\n-    if !has_only_ref_pats(pats.clone()) {\n+    if !has_multiple_ref_pats(pats.clone()) {\n         return;\n     }\n \n@@ -1693,26 +1693,26 @@ fn is_ref_some_arm(cx: &LateContext<'_>, arm: &Arm<'_>) -> Option<BindingAnnotat\n     None\n }\n \n-fn has_only_ref_pats<'a, 'b, I>(pats: I) -> bool\n+fn has_multiple_ref_pats<'a, 'b, I>(pats: I) -> bool\n where\n     'b: 'a,\n     I: Iterator<Item = &'a Pat<'b>>,\n {\n-    let mut at_least_one_is_true = false;\n+    let mut ref_count = 0;\n     for opt in pats.map(|pat| match pat.kind {\n         PatKind::Ref(..) => Some(true), // &-patterns\n         PatKind::Wild => Some(false),   // an \"anything\" wildcard is also fine\n         _ => None,                      // any other pattern is not fine\n     }) {\n         if let Some(inner) = opt {\n             if inner {\n-                at_least_one_is_true = true;\n+                ref_count += 1;\n             }\n         } else {\n             return false;\n         }\n     }\n-    at_least_one_is_true\n+    ref_count > 1\n }\n \n pub fn overlapping<T>(ranges: &[SpannedRange<T>]) -> Option<(&SpannedRange<T>, &SpannedRange<T>)>"}, {"sha": "d7cedf9f9f1596dfabb659099e2922281b410f93", "filename": "tests/ui/match_expr_like_matches_macro.stderr", "status": "modified", "additions": 1, "deletions": 34, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9205e3d800c09c826d6ef6533a00d231cfce8f5a/tests%2Fui%2Fmatch_expr_like_matches_macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9205e3d800c09c826d6ef6533a00d231cfce8f5a/tests%2Fui%2Fmatch_expr_like_matches_macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_expr_like_matches_macro.stderr?ref=9205e3d800c09c826d6ef6533a00d231cfce8f5a", "patch": "@@ -110,23 +110,6 @@ LL | |             _ => false,\n LL | |         };\n    | |_________^ help: try this: `matches!(&val, &Some(ref _a))`\n \n-error: you don't need to add `&` to both the expression and the patterns\n-  --> $DIR/match_expr_like_matches_macro.rs:166:20\n-   |\n-LL |           let _res = match &val {\n-   |  ____________________^\n-LL | |             &Some(ref _a) => true,\n-LL | |             _ => false,\n-LL | |         };\n-   | |_________^\n-   |\n-   = note: `-D clippy::match-ref-pats` implied by `-D warnings`\n-help: try\n-   |\n-LL ~         let _res = match val {\n-LL ~             Some(ref _a) => true,\n-   |\n-\n error: match expression looks like `matches!` macro\n   --> $DIR/match_expr_like_matches_macro.rs:178:20\n    |\n@@ -137,21 +120,5 @@ LL | |             _ => false,\n LL | |         };\n    | |_________^ help: try this: `matches!(&val, &Some(ref _a))`\n \n-error: you don't need to add `&` to both the expression and the patterns\n-  --> $DIR/match_expr_like_matches_macro.rs:178:20\n-   |\n-LL |           let _res = match &val {\n-   |  ____________________^\n-LL | |             &Some(ref _a) => true,\n-LL | |             _ => false,\n-LL | |         };\n-   | |_________^\n-   |\n-help: try\n-   |\n-LL ~         let _res = match val {\n-LL ~             Some(ref _a) => true,\n-   |\n-\n-error: aborting due to 14 previous errors\n+error: aborting due to 12 previous errors\n "}, {"sha": "50246486bb6fc9371206f17adfe284b5e722a566", "filename": "tests/ui/match_ref_pats.rs", "status": "modified", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/9205e3d800c09c826d6ef6533a00d231cfce8f5a/tests%2Fui%2Fmatch_ref_pats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9205e3d800c09c826d6ef6533a00d231cfce8f5a/tests%2Fui%2Fmatch_ref_pats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_ref_pats.rs?ref=9205e3d800c09c826d6ef6533a00d231cfce8f5a", "patch": "@@ -72,4 +72,46 @@ mod ice_3719 {\n     }\n }\n \n+mod issue_7740 {\n+    macro_rules! foobar_variant(\n+        ($idx:expr) => (FooBar::get($idx).unwrap())\n+    );\n+\n+    enum FooBar {\n+        Foo,\n+        Bar,\n+        FooBar,\n+        BarFoo,\n+    }\n+\n+    impl FooBar {\n+        fn get(idx: u8) -> Option<&'static Self> {\n+            match idx {\n+                0 => Some(&FooBar::Foo),\n+                1 => Some(&FooBar::Bar),\n+                2 => Some(&FooBar::FooBar),\n+                3 => Some(&FooBar::BarFoo),\n+                _ => None,\n+            }\n+        }\n+    }\n+\n+    fn issue_7740() {\n+        // Issue #7740\n+        match foobar_variant!(0) {\n+            &FooBar::Foo => println!(\"Foo\"),\n+            &FooBar::Bar => println!(\"Bar\"),\n+            &FooBar::FooBar => println!(\"FooBar\"),\n+            _ => println!(\"Wild\"),\n+        }\n+\n+        // This shouldn't trigger\n+        if let &FooBar::BarFoo = foobar_variant!(3) {\n+            println!(\"BarFoo\");\n+        } else {\n+            println!(\"Wild\");\n+        }\n+    }\n+}\n+\n fn main() {}"}, {"sha": "901820077e20e974b651c9a68ef26df9b364cf59", "filename": "tests/ui/match_ref_pats.stderr", "status": "modified", "additions": 10, "deletions": 47, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/9205e3d800c09c826d6ef6533a00d231cfce8f5a/tests%2Fui%2Fmatch_ref_pats.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9205e3d800c09c826d6ef6533a00d231cfce8f5a/tests%2Fui%2Fmatch_ref_pats.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_ref_pats.stderr?ref=9205e3d800c09c826d6ef6533a00d231cfce8f5a", "patch": "@@ -15,21 +15,6 @@ LL ~             Some(v) => println!(\"{:?}\", v),\n LL ~             None => println!(\"none\"),\n    |\n \n-error: you don't need to add `&` to all patterns\n-  --> $DIR/match_ref_pats.rs:18:5\n-   |\n-LL | /     match tup {\n-LL | |         &(v, 1) => println!(\"{}\", v),\n-LL | |         _ => println!(\"none\"),\n-LL | |     }\n-   | |_____^\n-   |\n-help: instead of prefixing all patterns with `&`, you can dereference the expression\n-   |\n-LL ~     match *tup {\n-LL ~         (v, 1) => println!(\"{}\", v),\n-   |\n-\n error: you don't need to add `&` to both the expression and the patterns\n   --> $DIR/match_ref_pats.rs:24:5\n    |\n@@ -54,52 +39,30 @@ LL |     if let &None = a {\n    |\n    = note: `-D clippy::redundant-pattern-matching` implied by `-D warnings`\n \n-error: you don't need to add `&` to all patterns\n-  --> $DIR/match_ref_pats.rs:36:5\n-   |\n-LL | /     if let &None = a {\n-LL | |         println!(\"none\");\n-LL | |     }\n-   | |_____^\n-   |\n-help: instead of prefixing all patterns with `&`, you can dereference the expression\n-   |\n-LL |     if let None = *a {\n-   |            ~~~~   ~~\n-\n error: redundant pattern matching, consider using `is_none()`\n   --> $DIR/match_ref_pats.rs:41:12\n    |\n LL |     if let &None = &b {\n    |     -------^^^^^----- help: try this: `if b.is_none()`\n \n-error: you don't need to add `&` to both the expression and the patterns\n-  --> $DIR/match_ref_pats.rs:41:5\n-   |\n-LL | /     if let &None = &b {\n-LL | |         println!(\"none\");\n-LL | |     }\n-   | |_____^\n-   |\n-help: try\n-   |\n-LL |     if let None = b {\n-   |            ~~~~   ~\n-\n error: you don't need to add `&` to all patterns\n-  --> $DIR/match_ref_pats.rs:68:9\n+  --> $DIR/match_ref_pats.rs:101:9\n    |\n-LL | /         match foo_variant!(0) {\n-LL | |             &Foo::A => println!(\"A\"),\n+LL | /         match foobar_variant!(0) {\n+LL | |             &FooBar::Foo => println!(\"Foo\"),\n+LL | |             &FooBar::Bar => println!(\"Bar\"),\n+LL | |             &FooBar::FooBar => println!(\"FooBar\"),\n LL | |             _ => println!(\"Wild\"),\n LL | |         }\n    | |_________^\n    |\n help: instead of prefixing all patterns with `&`, you can dereference the expression\n    |\n-LL ~         match *foo_variant!(0) {\n-LL ~             Foo::A => println!(\"A\"),\n+LL ~         match *foobar_variant!(0) {\n+LL ~             FooBar::Foo => println!(\"Foo\"),\n+LL ~             FooBar::Bar => println!(\"Bar\"),\n+LL ~             FooBar::FooBar => println!(\"FooBar\"),\n    |\n \n-error: aborting due to 8 previous errors\n+error: aborting due to 5 previous errors\n "}]}