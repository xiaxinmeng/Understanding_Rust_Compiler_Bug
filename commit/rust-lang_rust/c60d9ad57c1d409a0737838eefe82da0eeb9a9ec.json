{"sha": "c60d9ad57c1d409a0737838eefe82da0eeb9a9ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2MGQ5YWQ1N2MxZDQwOWEwNzM3ODM4ZWVmZTgyZGEwZWViOWE5ZWM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-11T17:52:01Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-11T18:16:10Z"}, "message": "mk: Fix rpath on cross compile builds\n\nAfter removing absolute rpaths, cross compile builds (notably the nightly\nbuilders) broke. This is because the RPATH was pointing at an empty directory\nbecause only the rustc binary is copied over, not all of the target libraries.\nThis modifies the cross compile logic to fixup the rpath of the stage0\ncross-compiled rustc to point to where it came from.", "tree": {"sha": "a3e9dc859574bd06198d81063742e5b1b8cc3a7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3e9dc859574bd06198d81063742e5b1b8cc3a7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c60d9ad57c1d409a0737838eefe82da0eeb9a9ec", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c60d9ad57c1d409a0737838eefe82da0eeb9a9ec", "html_url": "https://github.com/rust-lang/rust/commit/c60d9ad57c1d409a0737838eefe82da0eeb9a9ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c60d9ad57c1d409a0737838eefe82da0eeb9a9ec/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "65abf96fb6630d7ddbcdc3b39f599c02ecfc2f1e", "url": "https://api.github.com/repos/rust-lang/rust/commits/65abf96fb6630d7ddbcdc3b39f599c02ecfc2f1e", "html_url": "https://github.com/rust-lang/rust/commit/65abf96fb6630d7ddbcdc3b39f599c02ecfc2f1e"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "24ab522ec609881a762a0a3008be67b824bae378", "filename": "mk/main.mk", "status": "modified", "additions": 32, "deletions": 4, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/c60d9ad57c1d409a0737838eefe82da0eeb9a9ec/mk%2Fmain.mk", "raw_url": "https://github.com/rust-lang/rust/raw/c60d9ad57c1d409a0737838eefe82da0eeb9a9ec/mk%2Fmain.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fmain.mk?ref=c60d9ad57c1d409a0737838eefe82da0eeb9a9ec", "patch": "@@ -349,21 +349,44 @@ EXTRAFLAGS_STAGE$(1) = $$(RUSTFLAGS_STAGE$(1))\n \n CFGFLAG$(1)_T_$(2)_H_$(3) = stage$(1)\n \n+endef\n+\n+# Same macro/variables as above, but defined in a separate loop so it can use\n+# all the varibles above for all archs. The RPATH_VAR setup sometimes needs to\n+# reach across triples to get things in order.\n+define SREQ_CMDS\n+\n+ifeq ($$(OSTYPE_$(3)),apple-darwin)\n+  RPATH_VAR$(1)_T_$(2)_H_$(3) := \\\n+      DYLD_LIBRARY_PATH=\"$$$$DYLD_LIBRARY_PATH:$$(CURDIR)/$$(HLIB$(1)_H_$(3))\"\n+else\n+  RPATH_VAR$(1)_T_$(2)_H_$(3) := \\\n+      LD_LIBRARY_PATH=\"$$$$LD_LIBRARY_PATH:$$(CURDIR)/$$(HLIB$(1)_H_$(3))\"\n+endif\n+\n # Pass --cfg stage0 only for the build->host part of stage0;\n # if you're building a cross config, the host->* parts are\n # effectively stage1, since it uses the just-built stage0.\n+#\n+# This logic is similar to how the LD_LIBRARY_PATH variable must\n+# change be slightly different when doing cross compilations.\n+# The build doesn't copy over all target libraries into\n+# a new directory, so we need to point the library path at\n+# the build directory where all the target libraries came\n+# from (the stage0 build host). Otherwise the relative rpaths\n+# inside of the rustc binary won't get resolved correctly.\n ifeq ($(1),0)\n ifneq ($(strip $(CFG_BUILD)),$(strip $(3)))\n CFGFLAG$(1)_T_$(2)_H_$(3) = stage1\n-endif\n-endif\n \n ifeq ($$(OSTYPE_$(3)),apple-darwin)\n   RPATH_VAR$(1)_T_$(2)_H_$(3) := \\\n-      DYLD_LIBRARY_PATH=\"$$$$DYLD_LIBRARY_PATH:$$(CURDIR)/$$(HLIB$(1)_H_$(3))\"\n+      DYLD_LIBRARY_PATH=\"$$$$DYLD_LIBRARY_PATH:$$(CURDIR)/$$(TLIB1_T_$(2)_H_$(CFG_BUILD))\"\n else\n   RPATH_VAR$(1)_T_$(2)_H_$(3) := \\\n-      LD_LIBRARY_PATH=\"$$$$LD_LIBRARY_PATH:$$(CURDIR)/$$(HLIB$(1)_H_$(3))\"\n+      LD_LIBRARY_PATH=\"$$$$LD_LIBRARY_PATH:$$(CURDIR)/$$(TLIB1_T_$(2)_H_$(CFG_BUILD))\"\n+endif\n+endif\n endif\n \n STAGE$(1)_T_$(2)_H_$(3) := \t\t\t\t\t\t\\\n@@ -390,6 +413,11 @@ $(foreach build,$(CFG_HOST), \\\n   $(eval $(foreach stage,$(STAGES), \\\n    $(eval $(call SREQ,$(stage),$(target),$(build))))))))\n \n+$(foreach build,$(CFG_HOST), \\\n+ $(eval $(foreach target,$(CFG_TARGET), \\\n+  $(eval $(foreach stage,$(STAGES), \\\n+   $(eval $(call SREQ_CMDS,$(stage),$(target),$(build))))))))\n+\n ######################################################################\n # rustc-H-targets\n #"}]}