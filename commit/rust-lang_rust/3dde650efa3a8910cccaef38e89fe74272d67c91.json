{"sha": "3dde650efa3a8910cccaef38e89fe74272d67c91", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkZGU2NTBlZmEzYTg5MTBjY2NhZWYzOGU4OWZlNzQyNzJkNjdjOTE=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-06T20:41:54Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-06T20:46:16Z"}, "message": "Move injection of attributes from command line to `libsyntax_ext`", "tree": {"sha": "4eb06c7afafb94ed4b06b3be217ff1a4eb47023f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4eb06c7afafb94ed4b06b3be217ff1a4eb47023f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3dde650efa3a8910cccaef38e89fe74272d67c91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3dde650efa3a8910cccaef38e89fe74272d67c91", "html_url": "https://github.com/rust-lang/rust/commit/3dde650efa3a8910cccaef38e89fe74272d67c91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3dde650efa3a8910cccaef38e89fe74272d67c91/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4894123d21ed4b153a2e5c32c0870cb2d97f9b46", "url": "https://api.github.com/repos/rust-lang/rust/commits/4894123d21ed4b153a2e5c32c0870cb2d97f9b46", "html_url": "https://github.com/rust-lang/rust/commit/4894123d21ed4b153a2e5c32c0870cb2d97f9b46"}], "stats": {"total": 96, "additions": 48, "deletions": 48}, "files": [{"sha": "08ae3360eb94fbe04ded0ada31d72dd95911482c", "filename": "src/librustc_interface/passes.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibrustc_interface%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibrustc_interface%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Fpasses.rs?ref=3dde650efa3a8910cccaef38e89fe74272d67c91", "patch": "@@ -230,7 +230,9 @@ pub fn register_plugins<'a>(\n     crate_name: &str,\n ) -> Result<(ast::Crate, PluginInfo)> {\n     krate = time(sess, \"attributes injection\", || {\n-        syntax::attr::inject(krate, &sess.parse_sess, &sess.opts.debugging_opts.crate_attr)\n+        syntax_ext::cmdline_attrs::inject(\n+            krate, &sess.parse_sess, &sess.opts.debugging_opts.crate_attr\n+        )\n     });\n \n     let (mut krate, features) = syntax::config::features("}, {"sha": "69de3150354e7fe15537e19f4dbfd4234d6a15d7", "filename": "src/libsyntax/attr/mod.rs", "status": "modified", "additions": 13, "deletions": 46, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax%2Fattr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax%2Fattr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr%2Fmod.rs?ref=3dde650efa3a8910cccaef38e89fe74272d67c91", "patch": "@@ -16,7 +16,7 @@ use crate::mut_visit::visit_clobber;\n use crate::source_map::{BytePos, Spanned, DUMMY_SP};\n use crate::parse::lexer::comments::{doc_comment_style, strip_doc_comment_decoration};\n use crate::parse::parser::Parser;\n-use crate::parse::{self, ParseSess, PResult};\n+use crate::parse::{ParseSess, PResult};\n use crate::parse::token::{self, Token};\n use crate::ptr::P;\n use crate::symbol::{sym, Symbol};\n@@ -25,7 +25,7 @@ use crate::tokenstream::{TokenStream, TokenTree, DelimSpan};\n use crate::GLOBALS;\n \n use log::debug;\n-use syntax_pos::{FileName, Span};\n+use syntax_pos::Span;\n \n use std::iter;\n use std::ops::DerefMut;\n@@ -381,28 +381,25 @@ crate fn mk_attr_id() -> AttrId {\n     AttrId(id)\n }\n \n-/// Returns an inner attribute with the given value and span.\n-pub fn mk_attr_inner(item: MetaItem) -> Attribute {\n+pub fn mk_attr(style: AttrStyle, path: Path, tokens: TokenStream, span: Span) -> Attribute {\n     Attribute {\n         id: mk_attr_id(),\n-        style: ast::AttrStyle::Inner,\n-        path: item.path,\n-        tokens: item.node.tokens(item.span),\n+        style,\n+        path,\n+        tokens,\n         is_sugared_doc: false,\n-        span: item.span,\n+        span,\n     }\n }\n \n+/// Returns an inner attribute with the given value and span.\n+pub fn mk_attr_inner(item: MetaItem) -> Attribute {\n+    mk_attr(AttrStyle::Inner, item.path, item.node.tokens(item.span), item.span)\n+}\n+\n /// Returns an outer attribute with the given value and span.\n pub fn mk_attr_outer(item: MetaItem) -> Attribute {\n-    Attribute {\n-        id: mk_attr_id(),\n-        style: ast::AttrStyle::Outer,\n-        path: item.path,\n-        tokens: item.node.tokens(item.span),\n-        is_sugared_doc: false,\n-        span: item.span,\n-    }\n+    mk_attr(AttrStyle::Outer, item.path, item.node.tokens(item.span), item.span)\n }\n \n pub fn mk_sugared_doc_attr(text: Symbol, span: Span) -> Attribute {\n@@ -716,33 +713,3 @@ derive_has_attrs! {\n     Item, Expr, Local, ast::ForeignItem, ast::StructField, ast::ImplItem, ast::TraitItem, ast::Arm,\n     ast::Field, ast::FieldPat, ast::Variant, ast::Param\n }\n-\n-pub fn inject(mut krate: ast::Crate, parse_sess: &ParseSess, attrs: &[String]) -> ast::Crate {\n-    for raw_attr in attrs {\n-        let mut parser = parse::new_parser_from_source_str(\n-            parse_sess,\n-            FileName::cli_crate_attr_source_code(&raw_attr),\n-            raw_attr.clone(),\n-        );\n-\n-        let start_span = parser.token.span;\n-        let (path, tokens) = panictry!(parser.parse_meta_item_unrestricted());\n-        let end_span = parser.token.span;\n-        if parser.token != token::Eof {\n-            parse_sess.span_diagnostic\n-                .span_err(start_span.to(end_span), \"invalid crate attribute\");\n-            continue;\n-        }\n-\n-        krate.attrs.push(Attribute {\n-            id: mk_attr_id(),\n-            style: AttrStyle::Inner,\n-            path,\n-            tokens,\n-            is_sugared_doc: false,\n-            span: start_span.to(end_span),\n-        });\n-    }\n-\n-    krate\n-}"}, {"sha": "d9c4baad49ded7a98a038f75a4ccbeb66549abbc", "filename": "src/libsyntax/parse/attr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax%2Fparse%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax%2Fparse%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fattr.rs?ref=3dde650efa3a8910cccaef38e89fe74272d67c91", "patch": "@@ -176,7 +176,7 @@ impl<'a> Parser<'a> {\n     /// PATH\n     /// PATH `=` TOKEN_TREE\n     /// The delimiters or `=` are still put into the resulting token stream.\n-    crate fn parse_meta_item_unrestricted(&mut self) -> PResult<'a, (ast::Path, TokenStream)> {\n+    pub fn parse_meta_item_unrestricted(&mut self) -> PResult<'a, (ast::Path, TokenStream)> {\n         let meta = match self.token.kind {\n             token::Interpolated(ref nt) => match **nt {\n                 Nonterminal::NtMeta(ref meta) => Some(meta.clone()),"}, {"sha": "bb8e3df3db9215fcf33b57397070b190c2b5b3dd", "filename": "src/libsyntax_ext/cmdline_attrs.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax_ext%2Fcmdline_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax_ext%2Fcmdline_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fcmdline_attrs.rs?ref=3dde650efa3a8910cccaef38e89fe74272d67c91", "patch": "@@ -0,0 +1,30 @@\n+//! Attributes injected into the crate root from command line using `-Z crate-attr`.\n+\n+use syntax::ast::{self, AttrStyle};\n+use syntax::attr::mk_attr;\n+use syntax::panictry;\n+use syntax::parse::{self, token, ParseSess};\n+use syntax_pos::FileName;\n+\n+pub fn inject(mut krate: ast::Crate, parse_sess: &ParseSess, attrs: &[String]) -> ast::Crate {\n+    for raw_attr in attrs {\n+        let mut parser = parse::new_parser_from_source_str(\n+            parse_sess,\n+            FileName::cli_crate_attr_source_code(&raw_attr),\n+            raw_attr.clone(),\n+        );\n+\n+        let start_span = parser.token.span;\n+        let (path, tokens) = panictry!(parser.parse_meta_item_unrestricted());\n+        let end_span = parser.token.span;\n+        if parser.token != token::Eof {\n+            parse_sess.span_diagnostic\n+                .span_err(start_span.to(end_span), \"invalid crate attribute\");\n+            continue;\n+        }\n+\n+        krate.attrs.push(mk_attr(AttrStyle::Inner, path, tokens, start_span.to(end_span)));\n+    }\n+\n+    krate\n+}"}, {"sha": "5c0a63ebbe7cb0d29ddac8436638f2e6ff5747c9", "filename": "src/libsyntax_ext/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax_ext%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3dde650efa3a8910cccaef38e89fe74272d67c91/src%2Flibsyntax_ext%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Flib.rs?ref=3dde650efa3a8910cccaef38e89fe74272d67c91", "patch": "@@ -40,6 +40,7 @@ mod source_util;\n mod test;\n mod trace_macros;\n \n+pub mod cmdline_attrs;\n pub mod plugin_macro_defs;\n pub mod proc_macro_harness;\n pub mod standard_library_imports;"}]}