{"sha": "cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "node_id": "C_kwDOAAsO6NoAKGNmNTRiOGMzYTRkN2FlZTBiY2M1N2U3YTUwOWM3NGVlMGI0NTFmYWY", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-11-07T12:24:17Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-12-06T07:00:46Z"}, "message": "Parse and collect derive helpers for builtin derive macros", "tree": {"sha": "33aa18f1d40e5824eefd8da032364a207cb192e3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33aa18f1d40e5824eefd8da032364a207cb192e3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmOO6LoACgkQ4laYqTBY\nYXF2MA//TwmnBiGnItTOSfGya22xRYUkravnUs47B2PwcH9wJj/bY4eHKibd3TZ/\nID4rCLKQMgBsgjzjGBnSQT8eirv6l6ZHw9dX6glEp7iruApNe2kSnu8Zfyl0RqfB\nv4Yiz/m5WslIzeXoAmW6CD1RM07dn8VVAr71T4XGtmVGFjrBXXQG/2Txp4sZcuOK\nkJW08nP7C31JGTwhxkWK6YFijsh2fu8WnGFYawi1R8mfMumY7/X8cLeXIOxLqmWh\n2PoRBhIhR9w6WB5pDpjoCb9iqjZ3YUqw0Vvkn6tHz0OfwXzLssRVrVO4f1poJXKh\njNXCwIkrWmOeQssMcwYqYnovI24YS3LNI0pvQLhwmjLBGJm4ylfsugwF26cshXpH\nD9G9JFt0upwvNLAvYWgipGLFZEg2ZSPgGyRo2xR3gqwKDimLs/re1+bY5jPzV+Il\nSJQ2BC1+34DxiXzAiAPh6oyYdeje/f7FwzMhXF1lE4AIRzPCmvswygrqPXgX2e9w\nSqzmt0eZ4vGmLUgirv+YP09SKX/xWBIrs2/hqsTbtD/l/6rdN902PzJpvfXkJaKT\n5RoiakzU4TXLp0m3jsS3URE0Q5Pl1eOeRO7aYzxI02g1IZKMMP1JDvTiHrjuZNYu\nQo5kzA1pbpFYz5c/RrTZU2iLVjEx/nzm9DW/lQ8UJ6z6URIXdgc=\n=J7l3\n-----END PGP SIGNATURE-----", "payload": "tree 33aa18f1d40e5824eefd8da032364a207cb192e3\nparent f9bd48770832a8556ccd1b8e9f147d3f16bcc44a\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1667823857 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1670310046 +0900\n\nParse and collect derive helpers for builtin derive macros\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "html_url": "https://github.com/rust-lang/rust/commit/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f9bd48770832a8556ccd1b8e9f147d3f16bcc44a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9bd48770832a8556ccd1b8e9f147d3f16bcc44a", "html_url": "https://github.com/rust-lang/rust/commit/f9bd48770832a8556ccd1b8e9f147d3f16bcc44a"}], "stats": {"total": 130, "additions": 93, "deletions": 37}, "files": [{"sha": "f21d674f20d6a60405d048580e29f8120a6882c1", "filename": "crates/hir-def/src/nameres/collector.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Fhir-def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Fhir-def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fnameres%2Fcollector.rs?ref=cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "patch": "@@ -40,7 +40,7 @@ use crate::{\n         diagnostics::DefDiagnostic,\n         mod_resolution::ModDir,\n         path_resolution::ReachedFixedPoint,\n-        proc_macro::{ProcMacroDef, ProcMacroKind},\n+        proc_macro::{parse_macro_name_and_helper_attrs, ProcMacroDef, ProcMacroKind},\n         BuiltinShadowMode, DefMap, ModuleData, ModuleOrigin, ResolveMode,\n     },\n     path::{ImportAlias, ModPath, PathKind},\n@@ -2005,6 +2005,7 @@ impl ModCollector<'_, '_> {\n         let ast_id = InFile::new(self.file_id(), mac.ast_id.upcast());\n \n         // Case 1: builtin macros\n+        let mut helpers_opt = None;\n         let attrs = self.item_tree.attrs(self.def_collector.db, krate, ModItem::from(id).into());\n         let expander = if attrs.by_key(\"rustc_builtin_macro\").exists() {\n             if let Some(expander) = find_builtin_macro(&mac.name) {\n@@ -2013,6 +2014,25 @@ impl ModCollector<'_, '_> {\n                     Either::Right(it) => MacroExpander::BuiltInEager(it),\n                 }\n             } else if let Some(expander) = find_builtin_derive(&mac.name) {\n+                if let Some(attr) = attrs.by_key(\"rustc_builtin_macro\").tt_values().next() {\n+                    // NOTE: The item *may* have both `#[rustc_builtin_macro]` and `#[proc_macro_derive]`,\n+                    // in which case rustc ignores the helper attributes from the latter, but it\n+                    // \"doesn't make sense in practice\" (see rust-lang/rust#87027).\n+                    if let Some((name, helpers)) =\n+                        parse_macro_name_and_helper_attrs(&attr.token_trees)\n+                    {\n+                        // NOTE: rustc overrides the name if the macro name if it's different from the\n+                        // macro name, but we assume it isn't as there's no such case yet. FIXME if\n+                        // the following assertion fails.\n+                        stdx::always!(\n+                            name == mac.name,\n+                            \"built-in macro {} has #[rustc_builtin_macro] which declares different name {}\",\n+                            mac.name,\n+                            name\n+                        );\n+                        helpers_opt = Some(helpers);\n+                    }\n+                }\n                 MacroExpander::BuiltInDerive(expander)\n             } else if let Some(expander) = find_builtin_attr(&mac.name) {\n                 MacroExpander::BuiltInAttr(expander)\n@@ -2037,6 +2057,12 @@ impl ModCollector<'_, '_> {\n             macro_id,\n             &self.item_tree[mac.visibility],\n         );\n+        if let Some(helpers) = helpers_opt {\n+            self.def_collector\n+                .def_map\n+                .exported_derives\n+                .insert(macro_id_to_def_id(self.def_collector.db, macro_id.into()), helpers);\n+        }\n     }\n \n     fn collect_macro_call(&mut self, mac: &MacroCall, container: ItemContainerId) {"}, {"sha": "06b23392cfe46f4e167ec364f4fcc7e016871b47", "filename": "crates/hir-def/src/nameres/proc_macro.rs", "status": "modified", "additions": 43, "deletions": 35, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Fhir-def%2Fsrc%2Fnameres%2Fproc_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Fhir-def%2Fsrc%2Fnameres%2Fproc_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fnameres%2Fproc_macro.rs?ref=cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "patch": "@@ -37,45 +37,53 @@ impl Attrs {\n             Some(ProcMacroDef { name: func_name.clone(), kind: ProcMacroKind::Attr })\n         } else if self.by_key(\"proc_macro_derive\").exists() {\n             let derive = self.by_key(\"proc_macro_derive\").tt_values().next()?;\n+            let def = parse_macro_name_and_helper_attrs(&derive.token_trees)\n+                .map(|(name, helpers)| ProcMacroDef { name, kind: ProcMacroKind::CustomDerive { helpers } });\n \n-            match &*derive.token_trees {\n-                // `#[proc_macro_derive(Trait)]`\n-                [TokenTree::Leaf(Leaf::Ident(trait_name))] => Some(ProcMacroDef {\n-                    name: trait_name.as_name(),\n-                    kind: ProcMacroKind::CustomDerive { helpers: Box::new([]) },\n-                }),\n-\n-                // `#[proc_macro_derive(Trait, attributes(helper1, helper2, ...))]`\n-                [\n-                    TokenTree::Leaf(Leaf::Ident(trait_name)),\n-                    TokenTree::Leaf(Leaf::Punct(comma)),\n-                    TokenTree::Leaf(Leaf::Ident(attributes)),\n-                    TokenTree::Subtree(helpers)\n-                ] if comma.char == ',' && attributes.text == \"attributes\" =>\n-                {\n-                    let helpers = helpers.token_trees.iter()\n-                        .filter(|tt| !matches!(tt, TokenTree::Leaf(Leaf::Punct(comma)) if comma.char == ','))\n-                        .map(|tt| {\n-                            match tt {\n-                                TokenTree::Leaf(Leaf::Ident(helper)) => Some(helper.as_name()),\n-                                _ => None\n-                            }\n-                        })\n-                        .collect::<Option<Box<[_]>>>()?;\n-\n-                    Some(ProcMacroDef {\n-                        name: trait_name.as_name(),\n-                        kind: ProcMacroKind::CustomDerive { helpers },\n-                    })\n-                }\n-\n-                _ => {\n-                    tracing::trace!(\"malformed `#[proc_macro_derive]`: {}\", derive);\n-                    None\n-                }\n+            if def.is_none() {\n+                tracing::trace!(\"malformed `#[proc_macro_derive]`: {}\", derive);\n             }\n+\n+            def\n         } else {\n             None\n         }\n     }\n }\n+\n+// This fn is intended for `#[proc_macro_derive(..)]` and `#[rustc_builtin_macro(..)]`, which have\n+// the same strucuture.\n+#[rustfmt::skip]\n+pub(crate) fn parse_macro_name_and_helper_attrs(tt: &[TokenTree]) -> Option<(Name, Box<[Name]>)> {\n+    match tt {\n+        // `#[proc_macro_derive(Trait)]`\n+        // `#[rustc_builtin_macro(Trait)]`\n+        [TokenTree::Leaf(Leaf::Ident(trait_name))] => Some((trait_name.as_name(), Box::new([]))),\n+\n+        // `#[proc_macro_derive(Trait, attributes(helper1, helper2, ...))]`\n+        // `#[rustc_builtin_macro(Trait, attributes(helper1, helper2, ...))]`\n+        [\n+            TokenTree::Leaf(Leaf::Ident(trait_name)),\n+            TokenTree::Leaf(Leaf::Punct(comma)),\n+            TokenTree::Leaf(Leaf::Ident(attributes)),\n+            TokenTree::Subtree(helpers)\n+        ] if comma.char == ',' && attributes.text == \"attributes\" =>\n+        {\n+            let helpers = helpers\n+                .token_trees\n+                .iter()\n+                .filter(\n+                    |tt| !matches!(tt, TokenTree::Leaf(Leaf::Punct(comma)) if comma.char == ','),\n+                )\n+                .map(|tt| match tt {\n+                    TokenTree::Leaf(Leaf::Ident(helper)) => Some(helper.as_name()),\n+                    _ => None,\n+                })\n+                .collect::<Option<Box<[_]>>>()?;\n+\n+            Some((trait_name.as_name(), helpers))\n+        }\n+\n+        _ => None,\n+    }\n+}"}, {"sha": "fe0ad4f3863c469aaae629dc121d1d764e8d8586", "filename": "crates/hir-def/src/nameres/tests/macros.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Fhir-def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Fhir-def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs?ref=cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "patch": "@@ -822,6 +822,28 @@ fn derive() {}\n     );\n }\n \n+#[test]\n+fn resolves_derive_helper_rustc_builtin_macro() {\n+    cov_mark::check!(resolved_derive_helper);\n+    // This is NOT the correct usage of `default` helper attribute, but we don't resolve helper\n+    // attributes on non mod items in hir nameres.\n+    check(\n+        r#\"\n+//- minicore: derive, default\n+#[derive(Default)]\n+#[default]\n+enum E {\n+    A,\n+    B,\n+}\n+\"#,\n+        expect![[r#\"\n+            crate\n+            E: t\n+        \"#]],\n+    );\n+}\n+\n #[test]\n fn unresolved_attr_with_cfg_attr_hang() {\n     // Another regression test for https://github.com/rust-lang/rust-analyzer/issues/8905"}, {"sha": "013fd6b4fdf1732b7935e34706845076f0979812", "filename": "crates/test-utils/src/minicore.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Ftest-utils%2Fsrc%2Fminicore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf/crates%2Ftest-utils%2Fsrc%2Fminicore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest-utils%2Fsrc%2Fminicore.rs?ref=cf54b8c3a4d7aee0bcc57e7a509c74ee0b451faf", "patch": "@@ -112,7 +112,7 @@ pub mod default {\n         fn default() -> Self;\n     }\n     // region:derive\n-    #[rustc_builtin_macro]\n+    #[rustc_builtin_macro(Default, attributes(default))]\n     pub macro Default($item:item) {}\n     // endregion:derive\n }"}]}