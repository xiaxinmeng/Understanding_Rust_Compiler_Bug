{"sha": "af3d4cb936592ba53593ba869213c1af61b4166f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmM2Q0Y2I5MzY1OTJiYTUzNTkzYmE4NjkyMTNjMWFmNjFiNDE2NmY=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-07-15T18:01:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-15T18:01:02Z"}, "message": "Rollup merge of #72973 - msizanoen1:riscv-host, r=pietroalbini\n\nRISC-V GNU/Linux as host platform\n\nThis PR add a new builder named `dist-riscv64-linux` that builds the compiler toolchain for RISC-V 64-bit GNU/Linux.\n\nr? @alexcrichton", "tree": {"sha": "51d3b37f5a0d085af88b595b09ffa18539e79d0a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/51d3b37f5a0d085af88b595b09ffa18539e79d0a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af3d4cb936592ba53593ba869213c1af61b4166f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfD0ReCRBK7hj4Ov3rIwAAdHIIAIO3O02KpnCVLdLDyiuF0Pik\nCpq43F42bPf+ehUyriWXkF8CpMQged8MEEeBDxVqGsMkC/a7Wv9dXqqTk/j9ENie\nIzJ1/C9nQHJlkla4dmojmk1u+z0Mmj6fztUl8DClk5yJYcjOwVYScTD4RzlMWFdp\nXVgzAzxdH/2CbIlO/hZcpJLBupMbH69cHbD65IGHrTnqmm2mb9lGb7Y8Hq9sVQVL\nBMZc9cFg+qDo+Ur9zMxG0IE2ulqZEkbeIFrhYqQoES7izatZXmY8zc271QFMYZ0x\naGfHP86hniZ0loV79sJBB3tvnlQ7GM+mmGsuEudl9sYJwED2CEUX6MnKPP+mRIc=\n=7Cgs\n-----END PGP SIGNATURE-----\n", "payload": "tree 51d3b37f5a0d085af88b595b09ffa18539e79d0a\nparent 7e11379f3b4c376fbb9a6c4d44f3286ccc28d149\nparent 933ba82266da94a812cc3052c6b91b7f8f5b4c35\nauthor Manish Goregaokar <manishsmail@gmail.com> 1594836062 -0700\ncommitter GitHub <noreply@github.com> 1594836062 -0700\n\nRollup merge of #72973 - msizanoen1:riscv-host, r=pietroalbini\n\nRISC-V GNU/Linux as host platform\n\nThis PR add a new builder named `dist-riscv64-linux` that builds the compiler toolchain for RISC-V 64-bit GNU/Linux.\n\nr? @alexcrichton\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af3d4cb936592ba53593ba869213c1af61b4166f", "html_url": "https://github.com/rust-lang/rust/commit/af3d4cb936592ba53593ba869213c1af61b4166f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af3d4cb936592ba53593ba869213c1af61b4166f/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e11379f3b4c376fbb9a6c4d44f3286ccc28d149", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e11379f3b4c376fbb9a6c4d44f3286ccc28d149", "html_url": "https://github.com/rust-lang/rust/commit/7e11379f3b4c376fbb9a6c4d44f3286ccc28d149"}, {"sha": "933ba82266da94a812cc3052c6b91b7f8f5b4c35", "url": "https://api.github.com/repos/rust-lang/rust/commits/933ba82266da94a812cc3052c6b91b7f8f5b4c35", "html_url": "https://github.com/rust-lang/rust/commit/933ba82266da94a812cc3052c6b91b7f8f5b4c35"}], "stats": {"total": 94, "additions": 69, "deletions": 25}, "files": [{"sha": "29421895a9482789c5d1605084cfb244174e141e", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -297,6 +297,9 @@ jobs:\n           - name: dist-powerpc64le-linux\n             os: ubuntu-latest-xl\n             env: {}\n+          - name: dist-riscv64-linux\n+            os: ubuntu-latest-xl\n+            env: {}\n           - name: dist-s390x-linux\n             os: ubuntu-latest-xl\n             env: {}"}, {"sha": "b7c527f6712e1d48184e5ad45fec504cdcfe4bbb", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 22, "deletions": 2, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -112,6 +112,15 @@ impl Step for Llvm {\n     /// Compile LLVM for `target`.\n     fn run(self, builder: &Builder<'_>) -> PathBuf {\n         let target = self.target;\n+        let target_native = if self.target.starts_with(\"riscv\") {\n+            // RISC-V target triples in Rust is not named the same as C compiler target triples.\n+            // This converts Rust RISC-V target triples to C compiler triples.\n+            let idx = target.find('-').unwrap();\n+\n+            format!(\"riscv{}{}\", &target[5..7], &target[idx..])\n+        } else {\n+            target.to_string()\n+        };\n \n         let Meta { stamp, build_llvm_config, out_dir, root } =\n             match prebuilt_llvm_config(builder, target) {\n@@ -165,8 +174,8 @@ impl Step for Llvm {\n             .define(\"LLVM_ENABLE_BINDINGS\", \"OFF\")\n             .define(\"LLVM_ENABLE_Z3_SOLVER\", \"OFF\")\n             .define(\"LLVM_PARALLEL_COMPILE_JOBS\", builder.jobs().to_string())\n-            .define(\"LLVM_TARGET_ARCH\", target.split('-').next().unwrap())\n-            .define(\"LLVM_DEFAULT_TARGET_TRIPLE\", target);\n+            .define(\"LLVM_TARGET_ARCH\", target_native.split('-').next().unwrap())\n+            .define(\"LLVM_DEFAULT_TARGET_TRIPLE\", target_native);\n \n         if !target.contains(\"netbsd\") {\n             cfg.define(\"LLVM_ENABLE_ZLIB\", \"ON\");\n@@ -213,6 +222,17 @@ impl Step for Llvm {\n             }\n         }\n \n+        if target.starts_with(\"riscv\") {\n+            // In RISC-V, using C++ atomics require linking to `libatomic` but the LLVM build\n+            // system check cannot detect this. Therefore it is set manually here.\n+            if !builder.config.llvm_tools_enabled {\n+                cfg.define(\"CMAKE_EXE_LINKER_FLAGS\", \"-latomic\");\n+            } else {\n+                cfg.define(\"CMAKE_EXE_LINKER_FLAGS\", \"-latomic -static-libstdc++\");\n+            }\n+            cfg.define(\"CMAKE_SHARED_LINKER_FLAGS\", \"-latomic\");\n+        }\n+\n         if target.contains(\"msvc\") {\n             cfg.define(\"LLVM_USE_CRT_DEBUG\", \"MT\");\n             cfg.define(\"LLVM_USE_CRT_RELEASE\", \"MT\");"}, {"sha": "1786baa0278b9896df976494b3051a9eedfc972f", "filename": "src/ci/azure-pipelines/auto.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fazure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fazure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fauto.yml?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -53,6 +53,7 @@ jobs:\n       dist-powerpc-linux: {}\n       dist-powerpc64-linux: {}\n       dist-powerpc64le-linux: {}\n+      dist-riscv64-linux: {}\n       dist-s390x-linux: {}\n       dist-x86_64-freebsd: {}\n       dist-x86_64-illumos: {}"}, {"sha": "dff7c475157a239b8928090f85e6b8b9023adacf", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/Dockerfile", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2FDockerfile?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -0,0 +1,31 @@\n+FROM ubuntu:18.04\n+\n+COPY scripts/cross-apt-packages.sh /scripts/\n+RUN sh /scripts/cross-apt-packages.sh\n+\n+COPY host-x86_64/dist-riscv64-linux/crosstool-ng.sh /scripts/\n+RUN sh /scripts/crosstool-ng.sh\n+\n+COPY scripts/rustbuild-setup.sh /scripts/\n+RUN sh /scripts/rustbuild-setup.sh\n+USER rustbuild\n+WORKDIR /tmp\n+\n+COPY host-x86_64/dist-riscv64-linux/build-toolchains.sh host-x86_64/dist-riscv64-linux/riscv64-unknown-linux-gnu.config /tmp/\n+RUN ./build-toolchains.sh\n+\n+USER root\n+\n+COPY scripts/sccache.sh /scripts/\n+RUN sh /scripts/sccache.sh\n+\n+ENV PATH=$PATH:/x-tools/riscv64-unknown-linux-gnu/bin\n+\n+ENV CC_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-gcc \\\n+    AR_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-ar \\\n+    CXX_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-g++\n+\n+ENV HOSTS=riscv64gc-unknown-linux-gnu\n+\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV SCRIPT python3 ../x.py dist --target $HOSTS --host $HOSTS"}, {"sha": "6a7c022d01a5d86b1ee93392284e36653c87fdbd", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/build-toolchains.sh", "status": "renamed", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fbuild-toolchains.sh", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fbuild-toolchains.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fbuild-toolchains.sh?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -19,9 +19,9 @@ exit 1\n   set -x\n }\n \n-mkdir -p /tmp/build-riscv\n-cp riscv64-unknown-linux-gnu.config /tmp/build-riscv/.config\n-cd /tmp/build-riscv\n+mkdir build\n+cd build\n+cp ../riscv64-unknown-linux-gnu.config .config\n hide_output ct-ng build\n cd ..\n-rm -rf build-riscv\n+rm -rf build", "previous_filename": "src/ci/docker/host-x86_64/dist-various-1/build-riscv-toolchain.sh"}, {"sha": "fb067a79a5c85c93691cdf5244394982d465289f", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/crosstool-ng.sh", "status": "renamed", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fcrosstool-ng.sh", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fcrosstool-ng.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Fcrosstool-ng.sh?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -1,4 +1,3 @@\n-#!/bin/bash\n set -ex\n \n # Mirrored from https://github.com/crosstool-ng/crosstool-ng/archive/crosstool-ng-1.24.0.tar.gz", "previous_filename": "src/ci/docker/host-x86_64/dist-various-1/crosstool-ng.sh"}, {"sha": "dbb4be550dd70072efaaa4b525c901892ffc75e4", "filename": "src/ci/docker/host-x86_64/dist-riscv64-linux/riscv64-unknown-linux-gnu.config", "status": "renamed", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Friscv64-unknown-linux-gnu.config", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Friscv64-unknown-linux-gnu.config", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-riscv64-linux%2Friscv64-unknown-linux-gnu.config?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -17,8 +17,6 @@ CT_CONFIGURE_has_gnu_m4_1_4_12_or_newer=y\n CT_CONFIGURE_has_python_3_4_or_newer=y\n CT_CONFIGURE_has_bison_2_7_or_newer=y\n CT_CONFIGURE_has_python=y\n-CT_CONFIGURE_has_dtc=y\n-CT_CONFIGURE_has_svn=y\n CT_CONFIGURE_has_git=y\n CT_CONFIGURE_has_md5sum=y\n CT_CONFIGURE_has_sha1sum=y", "previous_filename": "src/ci/docker/host-x86_64/dist-various-1/riscv64-unknown-linux-gnu.config"}, {"sha": "ac228cfe01d800cb777297c58631957487e42d3d", "filename": "src/ci/docker/host-x86_64/dist-various-1/Dockerfile", "status": "modified", "additions": 0, "deletions": 16, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -47,18 +47,6 @@ RUN add-apt-repository ppa:team-gcc-arm-embedded/ppa && \\\n     apt-get update && \\\n     apt-get install -y --no-install-recommends gcc-arm-embedded\n \n-COPY scripts/rustbuild-setup.sh host-x86_64/dist-various-1/build-riscv-toolchain.sh host-x86_64/dist-various-1/riscv64-unknown-linux-gnu.config host-x86_64/dist-various-1/crosstool-ng.sh /build/\n-RUN ./crosstool-ng.sh\n-\n-# Crosstool-ng will refuse to build as root\n-RUN sh ./rustbuild-setup.sh\n-USER rustbuild\n-\n-RUN ./build-riscv-toolchain.sh\n-\n-USER root\n-ENV PATH=/x-tools/riscv64-unknown-linux-gnu/bin:$PATH\n-\n COPY host-x86_64/dist-various-1/build-rumprun.sh /build\n RUN ./build-rumprun.sh\n \n@@ -158,7 +146,6 @@ ENV TARGETS=$TARGETS,riscv32imc-unknown-none-elf\n ENV TARGETS=$TARGETS,riscv32imac-unknown-none-elf\n ENV TARGETS=$TARGETS,riscv64imac-unknown-none-elf\n ENV TARGETS=$TARGETS,riscv64gc-unknown-none-elf\n-ENV TARGETS=$TARGETS,riscv64gc-unknown-linux-gnu\n ENV TARGETS=$TARGETS,armebv7r-none-eabi\n ENV TARGETS=$TARGETS,armebv7r-none-eabihf\n ENV TARGETS=$TARGETS,armv7r-none-eabi\n@@ -186,9 +173,6 @@ ENV CC_mipsel_unknown_linux_musl=mipsel-openwrt-linux-gcc \\\n     CFLAGS_aarch64_unknown_none_softfloat=-mstrict-align -march=armv8-a+nofp+nosimd \\\n     CC_aarch64_unknown_none=aarch64-none-elf-gcc \\\n     CFLAGS_aarch64_unknown_none=-mstrict-align -march=armv8-a+fp+simd \\\n-    CC_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-gcc \\\n-    AR_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-ar \\\n-    CXX_riscv64gc_unknown_linux_gnu=riscv64-unknown-linux-gnu-g++ \\\n     CC_riscv32i_unknown_none_elf=false \\\n     CC_riscv32imc_unknown_none_elf=false \\\n     CC_riscv32imac_unknown_none_elf=false \\"}, {"sha": "8545ec15d32800a41d8f77f00934218ef0006c35", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -341,6 +341,9 @@ jobs:\n           - name: dist-powerpc64le-linux\n             <<: *job-linux-xl\n \n+          - name: dist-riscv64-linux\n+            <<: *job-linux-xl\n+\n           - name: dist-s390x-linux\n             <<: *job-linux-xl\n "}, {"sha": "5145b3b5e6fcc9cf423c52a0d250a8183213f9c1", "filename": "src/librustc_llvm/build.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Flibrustc_llvm%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af3d4cb936592ba53593ba869213c1af61b4166f/src%2Flibrustc_llvm%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fbuild.rs?ref=af3d4cb936592ba53593ba869213c1af61b4166f", "patch": "@@ -275,6 +275,11 @@ fn main() {\n         \"stdc++\"\n     };\n \n+    // RISC-V requires libatomic for sub-word atomic operations\n+    if target.starts_with(\"riscv\") {\n+        println!(\"cargo:rustc-link-lib=atomic\");\n+    }\n+\n     // C++ runtime library\n     if !target.contains(\"msvc\") {\n         if let Some(s) = llvm_static_stdcpp {"}]}