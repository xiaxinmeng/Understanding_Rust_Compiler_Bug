{"sha": "cf2433a74f7474f7d41e9842d7de465b0966831a", "node_id": "C_kwDOAAsO6NoAKGNmMjQzM2E3NGY3NDc0ZjdkNDFlOTg0MmQ3ZGU0NjViMDk2NjgzMWE", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2022-07-12T14:10:22Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2022-07-30T20:59:17Z"}, "message": "Use LocalDefId for closures more", "tree": {"sha": "052e864c933d409ad398e7e146fecbafd287a63b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/052e864c933d409ad398e7e146fecbafd287a63b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf2433a74f7474f7d41e9842d7de465b0966831a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf2433a74f7474f7d41e9842d7de465b0966831a", "html_url": "https://github.com/rust-lang/rust/commit/cf2433a74f7474f7d41e9842d7de465b0966831a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf2433a74f7474f7d41e9842d7de465b0966831a/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1202bbaf48a0a919a2e0cfd8b7dce97e8fc3030d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1202bbaf48a0a919a2e0cfd8b7dce97e8fc3030d", "html_url": "https://github.com/rust-lang/rust/commit/1202bbaf48a0a919a2e0cfd8b7dce97e8fc3030d"}], "stats": {"total": 337, "additions": 165, "deletions": 172}, "files": [{"sha": "826e9181589134ca56f69ca7192451e8b4990fd5", "filename": "compiler/rustc_borrowck/src/diagnostics/conflict_errors.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -6,7 +6,6 @@ use rustc_errors::{\n     struct_span_err, Applicability, Diagnostic, DiagnosticBuilder, ErrorGuaranteed, MultiSpan,\n };\n use rustc_hir as hir;\n-use rustc_hir::def_id::DefId;\n use rustc_hir::intravisit::{walk_block, walk_expr, Visitor};\n use rustc_hir::{AsyncGeneratorKind, GeneratorKind};\n use rustc_infer::infer::TyCtxtInferExt;\n@@ -21,6 +20,7 @@ use rustc_middle::ty::{\n     self, subst::Subst, suggest_constraining_type_params, EarlyBinder, PredicateKind, Ty,\n };\n use rustc_mir_dataflow::move_paths::{InitKind, MoveOutIndex, MovePathIndex};\n+use rustc_span::def_id::LocalDefId;\n use rustc_span::hygiene::DesugaringKind;\n use rustc_span::symbol::sym;\n use rustc_span::{BytePos, Span, Symbol};\n@@ -2224,7 +2224,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 let ty = self.infcx.tcx.type_of(self.mir_def_id());\n                 match ty.kind() {\n                     ty::FnDef(_, _) | ty::FnPtr(_) => self.annotate_fn_sig(\n-                        self.mir_def_id().to_def_id(),\n+                        self.mir_def_id(),\n                         self.infcx.tcx.fn_sig(self.mir_def_id()),\n                     ),\n                     _ => None,\n@@ -2268,8 +2268,8 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                         // Check if our `target` was captured by a closure.\n                         if let Rvalue::Aggregate(\n                             box AggregateKind::Closure(def_id, substs),\n-                            operands,\n-                        ) = rvalue\n+                            ref operands,\n+                        ) = *rvalue\n                         {\n                             for operand in operands {\n                                 let (Operand::Copy(assigned_from) | Operand::Move(assigned_from)) = operand else {\n@@ -2293,7 +2293,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                                 // into a place then we should annotate the closure in\n                                 // case it ends up being assigned into the return place.\n                                 annotated_closure =\n-                                    self.annotate_fn_sig(*def_id, substs.as_closure().sig());\n+                                    self.annotate_fn_sig(def_id, substs.as_closure().sig());\n                                 debug!(\n                                     \"annotate_argument_and_return_for_borrow: \\\n                                      annotated_closure={:?} assigned_from_local={:?} \\\n@@ -2415,12 +2415,12 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n     /// references.\n     fn annotate_fn_sig(\n         &self,\n-        did: DefId,\n+        did: LocalDefId,\n         sig: ty::PolyFnSig<'tcx>,\n     ) -> Option<AnnotatedBorrowFnSignature<'tcx>> {\n         debug!(\"annotate_fn_sig: did={:?} sig={:?}\", did, sig);\n-        let is_closure = self.infcx.tcx.is_closure(did);\n-        let fn_hir_id = self.infcx.tcx.hir().local_def_id_to_hir_id(did.as_local()?);\n+        let is_closure = self.infcx.tcx.is_closure(did.to_def_id());\n+        let fn_hir_id = self.infcx.tcx.hir().local_def_id_to_hir_id(did);\n         let fn_decl = self.infcx.tcx.hir().fn_decl_by_hir_id(fn_hir_id)?;\n \n         // We need to work out which arguments to highlight. We do this by looking"}, {"sha": "0300180f80a80275af945920f33d232c35d192c6", "filename": "compiler/rustc_borrowck/src/diagnostics/mod.rs", "status": "modified", "additions": 13, "deletions": 18, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmod.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -5,16 +5,17 @@ use rustc_const_eval::util::{call_kind, CallDesugaringKind};\n use rustc_errors::{Applicability, Diagnostic};\n use rustc_hir as hir;\n use rustc_hir::def::Namespace;\n-use rustc_hir::def_id::DefId;\n use rustc_hir::GeneratorKind;\n use rustc_infer::infer::TyCtxtInferExt;\n+use rustc_middle::mir::tcx::PlaceTy;\n use rustc_middle::mir::{\n     AggregateKind, Constant, FakeReadCause, Field, Local, LocalInfo, LocalKind, Location, Operand,\n     Place, PlaceRef, ProjectionElem, Rvalue, Statement, StatementKind, Terminator, TerminatorKind,\n };\n use rustc_middle::ty::print::Print;\n use rustc_middle::ty::{self, DefIdTree, Instance, Ty, TyCtxt};\n use rustc_mir_dataflow::move_paths::{InitLocation, LookupResult};\n+use rustc_span::def_id::LocalDefId;\n use rustc_span::{symbol::sym, Span, DUMMY_SP};\n use rustc_target::abi::VariantIdx;\n use rustc_trait_selection::traits::type_known_to_meet_bound_modulo_regions;\n@@ -41,7 +42,6 @@ pub(crate) use outlives_suggestion::OutlivesSuggestionBuilder;\n pub(crate) use region_errors::{ErrorConstraintInfo, RegionErrorKind, RegionErrors};\n pub(crate) use region_name::{RegionName, RegionNameSource};\n pub(crate) use rustc_const_eval::util::CallKind;\n-use rustc_middle::mir::tcx::PlaceTy;\n \n pub(super) struct IncludingDowncast(pub(super) bool);\n \n@@ -325,10 +325,11 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                     // so it's safe to call `expect_local`.\n                     //\n                     // We know the field exists so it's safe to call operator[] and `unwrap` here.\n+                    let def_id = def_id.expect_local();\n                     let var_id = self\n                         .infcx\n                         .tcx\n-                        .typeck(def_id.expect_local())\n+                        .typeck(def_id)\n                         .closure_min_captures_flattened(def_id)\n                         .nth(field.index())\n                         .unwrap()\n@@ -715,12 +716,11 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n \n         debug!(\"move_spans: moved_place={:?} location={:?} stmt={:?}\", moved_place, location, stmt);\n         if let StatementKind::Assign(box (_, Rvalue::Aggregate(ref kind, ref places))) = stmt.kind {\n-            match kind {\n-                box AggregateKind::Closure(def_id, _)\n-                | box AggregateKind::Generator(def_id, _, _) => {\n+            match **kind {\n+                AggregateKind::Closure(def_id, _) | AggregateKind::Generator(def_id, _, _) => {\n                     debug!(\"move_spans: def_id={:?} places={:?}\", def_id, places);\n                     if let Some((args_span, generator_kind, capture_kind_span, path_span)) =\n-                        self.closure_span(*def_id, moved_place, places)\n+                        self.closure_span(def_id, moved_place, places)\n                     {\n                         return ClosureUse {\n                             generator_kind,\n@@ -847,7 +847,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n             if let StatementKind::Assign(box (_, Rvalue::Aggregate(ref kind, ref places))) =\n                 stmt.kind\n             {\n-                let (def_id, is_generator) = match kind {\n+                let (&def_id, is_generator) = match kind {\n                     box AggregateKind::Closure(def_id, _) => (def_id, false),\n                     box AggregateKind::Generator(def_id, _, _) => (def_id, true),\n                     _ => continue,\n@@ -858,7 +858,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                     def_id, is_generator, places\n                 );\n                 if let Some((args_span, generator_kind, capture_kind_span, path_span)) =\n-                    self.closure_span(*def_id, Place::from(target).as_ref(), places)\n+                    self.closure_span(def_id, Place::from(target).as_ref(), places)\n                 {\n                     return ClosureUse { generator_kind, args_span, capture_kind_span, path_span };\n                 } else {\n@@ -879,25 +879,20 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n     /// The second span is the location the use resulting in the captured path of the capture\n     fn closure_span(\n         &self,\n-        def_id: DefId,\n+        def_id: LocalDefId,\n         target_place: PlaceRef<'tcx>,\n         places: &[Operand<'tcx>],\n     ) -> Option<(Span, Option<GeneratorKind>, Span, Span)> {\n         debug!(\n             \"closure_span: def_id={:?} target_place={:?} places={:?}\",\n             def_id, target_place, places\n         );\n-        let local_did = def_id.as_local()?;\n-        let hir_id = self.infcx.tcx.hir().local_def_id_to_hir_id(local_did);\n+        let hir_id = self.infcx.tcx.hir().local_def_id_to_hir_id(def_id);\n         let expr = &self.infcx.tcx.hir().expect_expr(hir_id).kind;\n         debug!(\"closure_span: hir_id={:?} expr={:?}\", hir_id, expr);\n         if let hir::ExprKind::Closure(&hir::Closure { body, fn_decl_span, .. }) = expr {\n-            for (captured_place, place) in self\n-                .infcx\n-                .tcx\n-                .typeck(def_id.expect_local())\n-                .closure_min_captures_flattened(def_id)\n-                .zip(places)\n+            for (captured_place, place) in\n+                self.infcx.tcx.typeck(def_id).closure_min_captures_flattened(def_id).zip(places)\n             {\n                 match place {\n                     Operand::Copy(place) | Operand::Move(place)"}, {"sha": "ec95b786707889495d33d76e70b9447e935b6663", "filename": "compiler/rustc_borrowck/src/diagnostics/mutability_errors.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmutability_errors.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -343,7 +343,7 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                 );\n                 let tcx = self.infcx.tcx;\n                 if let ty::Closure(id, _) = *the_place_err.ty(self.body, tcx).ty.kind() {\n-                    self.show_mutating_upvar(tcx, id, the_place_err, &mut err);\n+                    self.show_mutating_upvar(tcx, id.expect_local(), the_place_err, &mut err);\n                 }\n             }\n \n@@ -382,7 +382,7 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                 if let ty::Ref(_, ty, Mutability::Mut) = the_place_err.ty(self.body, tcx).ty.kind()\n                     && let ty::Closure(id, _) = *ty.kind()\n                 {\n-                    self.show_mutating_upvar(tcx, id, the_place_err, &mut err);\n+                    self.show_mutating_upvar(tcx, id.expect_local(), the_place_err, &mut err);\n                 }\n             }\n \n@@ -685,11 +685,10 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n     fn show_mutating_upvar(\n         &self,\n         tcx: TyCtxt<'_>,\n-        id: hir::def_id::DefId,\n+        closure_local_def_id: hir::def_id::LocalDefId,\n         the_place_err: PlaceRef<'tcx>,\n         err: &mut Diagnostic,\n     ) {\n-        let closure_local_def_id = id.expect_local();\n         let tables = tcx.typeck(closure_local_def_id);\n         let closure_hir_id = tcx.hir().local_def_id_to_hir_id(closure_local_def_id);\n         if let Some((span, closure_kind_origin)) =\n@@ -699,7 +698,8 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                 let upvar = ty::place_to_string_for_capture(tcx, closure_kind_origin);\n                 let root_hir_id = upvar_id.var_path.hir_id;\n                 // we have an origin for this closure kind starting at this root variable so it's safe to unwrap here\n-                let captured_places = tables.closure_min_captures[&id].get(&root_hir_id).unwrap();\n+                let captured_places =\n+                    tables.closure_min_captures[&closure_local_def_id].get(&root_hir_id).unwrap();\n \n                 let origin_projection = closure_kind_origin\n                     .projections"}, {"sha": "f68358ecfe6d203de81ac6945addce03da4de1ee", "filename": "compiler/rustc_borrowck/src/diagnostics/region_name.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fregion_name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fregion_name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fregion_name.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -189,7 +189,7 @@ impl Display for RegionName {\n \n impl<'tcx> MirBorrowckCtxt<'_, 'tcx> {\n     pub(crate) fn mir_def_id(&self) -> hir::def_id::LocalDefId {\n-        self.body.source.def_id().as_local().unwrap()\n+        self.body.source.def_id().expect_local()\n     }\n \n     pub(crate) fn mir_hir_id(&self) -> hir::HirId {"}, {"sha": "4f2a7bccefb683948d516e8d88b4c2305767cfe8", "filename": "compiler/rustc_borrowck/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -189,7 +189,7 @@ fn do_mir_borrowck<'a, 'tcx>(\n         errors.set_tainted_by_errors();\n     }\n     let upvars: Vec<_> = tables\n-        .closure_min_captures_flattened(def.did.to_def_id())\n+        .closure_min_captures_flattened(def.did)\n         .map(|captured_place| {\n             let capture = captured_place.info.capture_kind;\n             let by_ref = match capture {\n@@ -1295,7 +1295,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 match **aggregate_kind {\n                     AggregateKind::Closure(def_id, _) | AggregateKind::Generator(def_id, _, _) => {\n                         let BorrowCheckResult { used_mut_upvars, .. } =\n-                            self.infcx.tcx.mir_borrowck(def_id.expect_local());\n+                            self.infcx.tcx.mir_borrowck(def_id);\n                         debug!(\"{:?} used_mut_upvars={:?}\", def_id, used_mut_upvars);\n                         for field in used_mut_upvars {\n                             self.propagate_closure_used_mut_upvar(&operands[field.index()]);"}, {"sha": "f7d35da02597d8f65a7f4e7a1d858c377476b2ca", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 7, "deletions": 10, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -1847,14 +1847,11 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                     let tcx = self.tcx();\n                     let def_id = uv.def.def_id_for_type_of();\n                     if tcx.def_kind(def_id) == DefKind::InlineConst {\n-                        let predicates = self.prove_closure_bounds(\n-                            tcx,\n-                            def_id.expect_local(),\n-                            uv.substs,\n-                            location,\n-                        );\n+                        let def_id = def_id.expect_local();\n+                        let predicates =\n+                            self.prove_closure_bounds(tcx, def_id, uv.substs, location);\n                         self.normalize_and_prove_instantiated_predicates(\n-                            def_id,\n+                            def_id.to_def_id(),\n                             predicates,\n                             location.to_locations(),\n                         );\n@@ -2514,9 +2511,9 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n             aggregate_kind, location\n         );\n \n-        let (def_id, instantiated_predicates) = match aggregate_kind {\n+        let (def_id, instantiated_predicates) = match *aggregate_kind {\n             AggregateKind::Adt(adt_did, _, substs, _, _) => {\n-                (*adt_did, tcx.predicates_of(*adt_did).instantiate(tcx, substs))\n+                (adt_did, tcx.predicates_of(adt_did).instantiate(tcx, substs))\n             }\n \n             // For closures, we have some **extra requirements** we\n@@ -2541,7 +2538,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n             // clauses on the struct.\n             AggregateKind::Closure(def_id, substs)\n             | AggregateKind::Generator(def_id, substs, _) => {\n-                (*def_id, self.prove_closure_bounds(tcx, def_id.expect_local(), substs, location))\n+                (def_id.to_def_id(), self.prove_closure_bounds(tcx, def_id, substs, location))\n             }\n \n             AggregateKind::Array(_) | AggregateKind::Tuple => {"}, {"sha": "6f6717721fb5a0df81c15a0e101c43dd3c95c7e1", "filename": "compiler/rustc_const_eval/src/interpret/validity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -238,7 +238,7 @@ impl<'rt, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> ValidityVisitor<'rt, 'mir, '\n                 if let Some(local_def_id) = def_id.as_local() {\n                     let tables = self.ecx.tcx.typeck(local_def_id);\n                     if let Some(captured_place) =\n-                        tables.closure_min_captures_flattened(*def_id).nth(field)\n+                        tables.closure_min_captures_flattened(local_def_id).nth(field)\n                     {\n                         // Sometimes the index is beyond the number of upvars (seen\n                         // for a generator)."}, {"sha": "64e158ba348fcb6327c8dfbab17a27f370b92df7", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 32, "deletions": 40, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -1983,53 +1983,45 @@ impl<'tcx> Debug for Rvalue<'tcx> {\n                     }\n \n                     AggregateKind::Closure(def_id, substs) => ty::tls::with(|tcx| {\n-                        if let Some(def_id) = def_id.as_local() {\n-                            let name = if tcx.sess.opts.unstable_opts.span_free_formats {\n-                                let substs = tcx.lift(substs).unwrap();\n-                                format!(\n-                                    \"[closure@{}]\",\n-                                    tcx.def_path_str_with_substs(def_id.to_def_id(), substs),\n-                                )\n-                            } else {\n-                                let span = tcx.def_span(def_id);\n-                                format!(\n-                                    \"[closure@{}]\",\n-                                    tcx.sess.source_map().span_to_diagnostic_string(span)\n-                                )\n-                            };\n-                            let mut struct_fmt = fmt.debug_struct(&name);\n-\n-                            // FIXME(project-rfc-2229#48): This should be a list of capture names/places\n-                            if let Some(upvars) = tcx.upvars_mentioned(def_id) {\n-                                for (&var_id, place) in iter::zip(upvars.keys(), places) {\n-                                    let var_name = tcx.hir().name(var_id);\n-                                    struct_fmt.field(var_name.as_str(), place);\n-                                }\n-                            }\n-\n-                            struct_fmt.finish()\n+                        let name = if tcx.sess.opts.unstable_opts.span_free_formats {\n+                            let substs = tcx.lift(substs).unwrap();\n+                            format!(\n+                                \"[closure@{}]\",\n+                                tcx.def_path_str_with_substs(def_id.to_def_id(), substs),\n+                            )\n                         } else {\n-                            write!(fmt, \"[closure]\")\n+                            let span = tcx.def_span(def_id);\n+                            format!(\n+                                \"[closure@{}]\",\n+                                tcx.sess.source_map().span_to_diagnostic_string(span)\n+                            )\n+                        };\n+                        let mut struct_fmt = fmt.debug_struct(&name);\n+\n+                        // FIXME(project-rfc-2229#48): This should be a list of capture names/places\n+                        if let Some(upvars) = tcx.upvars_mentioned(def_id) {\n+                            for (&var_id, place) in iter::zip(upvars.keys(), places) {\n+                                let var_name = tcx.hir().name(var_id);\n+                                struct_fmt.field(var_name.as_str(), place);\n+                            }\n                         }\n+\n+                        struct_fmt.finish()\n                     }),\n \n                     AggregateKind::Generator(def_id, _, _) => ty::tls::with(|tcx| {\n-                        if let Some(def_id) = def_id.as_local() {\n-                            let name = format!(\"[generator@{:?}]\", tcx.def_span(def_id));\n-                            let mut struct_fmt = fmt.debug_struct(&name);\n-\n-                            // FIXME(project-rfc-2229#48): This should be a list of capture names/places\n-                            if let Some(upvars) = tcx.upvars_mentioned(def_id) {\n-                                for (&var_id, place) in iter::zip(upvars.keys(), places) {\n-                                    let var_name = tcx.hir().name(var_id);\n-                                    struct_fmt.field(var_name.as_str(), place);\n-                                }\n+                        let name = format!(\"[generator@{:?}]\", tcx.def_span(def_id));\n+                        let mut struct_fmt = fmt.debug_struct(&name);\n+\n+                        // FIXME(project-rfc-2229#48): This should be a list of capture names/places\n+                        if let Some(upvars) = tcx.upvars_mentioned(def_id) {\n+                            for (&var_id, place) in iter::zip(upvars.keys(), places) {\n+                                let var_name = tcx.hir().name(var_id);\n+                                struct_fmt.field(var_name.as_str(), place);\n                             }\n-\n-                            struct_fmt.finish()\n-                        } else {\n-                            write!(fmt, \"[generator]\")\n                         }\n+\n+                        struct_fmt.finish()\n                     }),\n                 }\n             }"}, {"sha": "8e3c2283efc6d4413fc1ed21f63c4f015311c1a5", "filename": "compiler/rustc_middle/src/mir/syntax.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fsyntax.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -18,6 +18,7 @@ use rustc_hir::{self, GeneratorKind};\n use rustc_target::abi::VariantIdx;\n \n use rustc_ast::Mutability;\n+use rustc_span::def_id::LocalDefId;\n use rustc_span::symbol::Symbol;\n use rustc_span::Span;\n use rustc_target::asm::InlineAsmRegOrRegClass;\n@@ -340,8 +341,11 @@ pub enum FakeReadCause {\n     /// If a closure pattern matches a Place starting with an Upvar, then we introduce a\n     /// FakeRead for that Place outside the closure, in such a case this option would be\n     /// Some(closure_def_id).\n-    /// Otherwise, the value of the optional DefId will be None.\n-    ForMatchedPlace(Option<DefId>),\n+    /// Otherwise, the value of the optional LocalDefId will be None.\n+    //\n+    // We can use LocaDefId here since fake read statements are removed\n+    // before codegen in the `CleanupNonCodegenStatements` pass.\n+    ForMatchedPlace(Option<LocalDefId>),\n \n     /// A fake read of the RefWithinGuard version of a bind-by-value variable\n     /// in a match guard to ensure that its value hasn't change by the time\n@@ -365,7 +369,7 @@ pub enum FakeReadCause {\n     /// FakeRead for that Place outside the closure, in such a case this option would be\n     /// Some(closure_def_id).\n     /// Otherwise, the value of the optional DefId will be None.\n-    ForLet(Option<DefId>),\n+    ForLet(Option<LocalDefId>),\n \n     /// If we have an index expression like\n     ///\n@@ -1095,8 +1099,10 @@ pub enum AggregateKind<'tcx> {\n     /// active field index would identity the field `c`\n     Adt(DefId, VariantIdx, SubstsRef<'tcx>, Option<UserTypeAnnotationIndex>, Option<usize>),\n \n-    Closure(DefId, SubstsRef<'tcx>),\n-    Generator(DefId, SubstsRef<'tcx>, hir::Movability),\n+    // Note: We can use LocalDefId since closures and generators a deaggregated\n+    // before codegen.\n+    Closure(LocalDefId, SubstsRef<'tcx>),\n+    Generator(LocalDefId, SubstsRef<'tcx>, hir::Movability),\n }\n \n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]"}, {"sha": "405003156c40e9f2087f465eab58b48db6171cbc", "filename": "compiler/rustc_middle/src/mir/tcx.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftcx.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftcx.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Ftcx.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -205,9 +205,9 @@ impl<'tcx> Rvalue<'tcx> {\n                 AggregateKind::Adt(did, _, substs, _, _) => {\n                     tcx.bound_type_of(did).subst(tcx, substs)\n                 }\n-                AggregateKind::Closure(did, substs) => tcx.mk_closure(did, substs),\n+                AggregateKind::Closure(did, substs) => tcx.mk_closure(did.to_def_id(), substs),\n                 AggregateKind::Generator(did, substs, movability) => {\n-                    tcx.mk_generator(did, substs, movability)\n+                    tcx.mk_generator(did.to_def_id(), substs, movability)\n                 }\n             },\n             Rvalue::ShallowInitBox(_, ty) => tcx.mk_box(ty),"}, {"sha": "ffa66b79dbf825fcb2a21f7cb4034a156413ee4a", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -413,12 +413,12 @@ rustc_queries! {\n     }\n \n     query symbols_for_closure_captures(\n-        key: (LocalDefId, DefId)\n+        key: (LocalDefId, LocalDefId)\n     ) -> Vec<rustc_span::Symbol> {\n         storage(ArenaCacheSelector<'tcx>)\n         desc {\n             |tcx| \"symbols for captures of closure `{}` in `{}`\",\n-            tcx.def_path_str(key.1),\n+            tcx.def_path_str(key.1.to_def_id()),\n             tcx.def_path_str(key.0.to_def_id())\n         }\n     }"}, {"sha": "8b27ca570469766bb7732919bf594694abb02240", "filename": "compiler/rustc_middle/src/thir.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fthir.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -27,6 +27,7 @@ use rustc_span::{Span, Symbol, DUMMY_SP};\n use rustc_target::abi::VariantIdx;\n use rustc_target::asm::InlineAsmRegOrRegClass;\n \n+use rustc_span::def_id::LocalDefId;\n use std::fmt;\n use std::ops::Index;\n \n@@ -405,7 +406,7 @@ pub enum ExprKind<'tcx> {\n     },\n     /// A closure definition.\n     Closure {\n-        closure_id: DefId,\n+        closure_id: LocalDefId,\n         substs: UpvarSubsts<'tcx>,\n         upvars: Box<[ExprId]>,\n         movability: Option<hir::Movability>,"}, {"sha": "0d6c26a582246b532de2a5c36be35a5198bb2f7f", "filename": "compiler/rustc_middle/src/ty/closure.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fty%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fty%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fclosure.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -59,7 +59,7 @@ pub type UpvarCaptureMap = FxHashMap<UpvarId, UpvarCapture>;\n \n /// Given the closure DefId this map provides a map of root variables to minimum\n /// set of `CapturedPlace`s that need to be tracked to support all captures of that closure.\n-pub type MinCaptureInformationMap<'tcx> = FxHashMap<DefId, RootVariableMinCaptureList<'tcx>>;\n+pub type MinCaptureInformationMap<'tcx> = FxHashMap<LocalDefId, RootVariableMinCaptureList<'tcx>>;\n \n /// Part of `MinCaptureInformationMap`; Maps a root variable to the list of `CapturedPlace`.\n /// Used to track the minimum set of `Place`s that need to be captured to support all\n@@ -253,7 +253,7 @@ impl<'tcx> CapturedPlace<'tcx> {\n \n fn symbols_for_closure_captures<'tcx>(\n     tcx: TyCtxt<'tcx>,\n-    def_id: (LocalDefId, DefId),\n+    def_id: (LocalDefId, LocalDefId),\n ) -> Vec<Symbol> {\n     let typeck_results = tcx.typeck(def_id.0);\n     let captures = typeck_results.closure_min_captures_flattened(def_id.1);"}, {"sha": "2714493b9fc611592acb8e446552faaa76c979f4", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -570,7 +570,7 @@ pub struct TypeckResults<'tcx> {\n     /// we never capture `t`. This becomes an issue when we build MIR as we require\n     /// information on `t` in order to create place `t.0` and `t.1`. We can solve this\n     /// issue by fake reading `t`.\n-    pub closure_fake_reads: FxHashMap<DefId, Vec<(HirPlace<'tcx>, FakeReadCause, hir::HirId)>>,\n+    pub closure_fake_reads: FxHashMap<LocalDefId, Vec<(HirPlace<'tcx>, FakeReadCause, hir::HirId)>>,\n \n     /// Tracks the rvalue scoping rules which defines finer scoping for rvalue expressions\n     /// by applying extended parameter rules.\n@@ -589,7 +589,7 @@ pub struct TypeckResults<'tcx> {\n \n     /// Contains the data for evaluating the effect of feature `capture_disjoint_fields`\n     /// on closure size.\n-    pub closure_size_eval: FxHashMap<DefId, ClosureSizeProfileData<'tcx>>,\n+    pub closure_size_eval: FxHashMap<LocalDefId, ClosureSizeProfileData<'tcx>>,\n }\n \n impl<'tcx> TypeckResults<'tcx> {\n@@ -811,7 +811,7 @@ impl<'tcx> TypeckResults<'tcx> {\n     /// by the closure.\n     pub fn closure_min_captures_flattened(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n     ) -> impl Iterator<Item = &ty::CapturedPlace<'tcx>> {\n         self.closure_min_captures\n             .get(&closure_def_id)"}, {"sha": "0c06aad4e44d50a2c515b8a8290afbbe330b15f9", "filename": "compiler/rustc_mir_build/src/build/expr/as_place.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -3,7 +3,7 @@\n use crate::build::expr::category::Category;\n use crate::build::ForGuard::{OutsideGuard, RefWithinGuard};\n use crate::build::{BlockAnd, BlockAndExtension, Builder};\n-use rustc_hir::def_id::{DefId, LocalDefId};\n+use rustc_hir::def_id::LocalDefId;\n use rustc_middle::hir::place::Projection as HirProjection;\n use rustc_middle::hir::place::ProjectionKind as HirProjectionKind;\n use rustc_middle::middle::region;\n@@ -58,7 +58,7 @@ pub(crate) enum PlaceBase {\n         /// HirId of the upvar\n         var_hir_id: LocalVarId,\n         /// DefId of the closure\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         /// The trait closure implements, `Fn`, `FnMut`, `FnOnce`\n         closure_kind: ty::ClosureKind,\n     },\n@@ -176,7 +176,7 @@ fn compute_capture_idx<'tcx>(\n fn find_capture_matching_projections<'a, 'tcx>(\n     typeck_results: &'a ty::TypeckResults<'tcx>,\n     var_hir_id: LocalVarId,\n-    closure_def_id: DefId,\n+    closure_def_id: LocalDefId,\n     projections: &[PlaceElem<'tcx>],\n ) -> Option<(usize, &'a ty::CapturedPlace<'tcx>)> {\n     let closure_min_captures = typeck_results.closure_min_captures.get(&closure_def_id)?;\n@@ -242,7 +242,7 @@ fn to_upvars_resolved_place_builder<'a, 'tcx>(\n             };\n \n             // We won't be building MIR if the closure wasn't local\n-            let closure_hir_id = tcx.hir().local_def_id_to_hir_id(closure_def_id.expect_local());\n+            let closure_hir_id = tcx.hir().local_def_id_to_hir_id(closure_def_id);\n             let closure_ty = typeck_results.node_type(closure_hir_id);\n \n             let substs = match closure_ty.kind() {\n@@ -626,11 +626,11 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n     fn lower_captured_upvar(\n         &mut self,\n         block: BasicBlock,\n-        closure_expr_id: LocalDefId,\n+        closure_def_id: LocalDefId,\n         var_hir_id: LocalVarId,\n     ) -> BlockAnd<PlaceBuilder<'tcx>> {\n         let closure_ty =\n-            self.typeck_results.node_type(self.tcx.hir().local_def_id_to_hir_id(closure_expr_id));\n+            self.typeck_results.node_type(self.tcx.hir().local_def_id_to_hir_id(closure_def_id));\n \n         let closure_kind = if let ty::Closure(_, closure_substs) = closure_ty.kind() {\n             self.infcx.closure_kind(closure_substs).unwrap()\n@@ -639,11 +639,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             ty::ClosureKind::FnOnce\n         };\n \n-        block.and(PlaceBuilder::from(PlaceBase::Upvar {\n-            var_hir_id,\n-            closure_def_id: closure_expr_id.to_def_id(),\n-            closure_kind,\n-        }))\n+        block.and(PlaceBuilder::from(PlaceBase::Upvar { var_hir_id, closure_def_id, closure_kind }))\n     }\n \n     /// Lower an index expression"}, {"sha": "12b8ceede0fe2a6a92986b9ca740b9227918a171", "filename": "compiler/rustc_mir_build/src/build/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -672,7 +672,7 @@ where\n                 Some(builder.in_scope(arg_scope_s, LintLevel::Inherited, |builder| {\n                     builder.args_and_body(\n                         START_BLOCK,\n-                        fn_def.did.to_def_id(),\n+                        fn_def.did,\n                         &arguments,\n                         arg_scope,\n                         &thir[expr],\n@@ -895,7 +895,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n     fn args_and_body(\n         &mut self,\n         mut block: BasicBlock,\n-        fn_def_id: DefId,\n+        fn_def_id: LocalDefId,\n         arguments: &[ArgInfo<'tcx>],\n         argument_scope: region::Scope,\n         expr: &Expr<'tcx>,"}, {"sha": "951247dd3b60d5fdc499b73d6db5c8652d2a5ef9", "filename": "compiler/rustc_mir_build/src/check_unsafety.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -408,7 +408,6 @@ impl<'a, 'tcx> Visitor<'a, 'tcx> for UnsafetyVisitor<'a, 'tcx> {\n                 movability: _,\n                 fake_reads: _,\n             } => {\n-                let closure_id = closure_id.expect_local();\n                 let closure_def = if let Some((did, const_param_id)) =\n                     ty::WithOptConstParam::try_lookup(closure_id, self.tcx)\n                 {"}, {"sha": "985601712c4f09a7c2f5d3114102f1fb66fd99da", "filename": "compiler/rustc_mir_build/src/thir/cx/expr.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -523,6 +523,7 @@ impl<'tcx> Cx<'tcx> {\n                         span_bug!(expr.span, \"closure expr w/o closure type: {:?}\", closure_ty);\n                     }\n                 };\n+                let def_id = def_id.expect_local();\n \n                 let upvars = self\n                     .typeck_results"}, {"sha": "ede44628919807fd18b093cdbec6c9426ee46ad2", "filename": "compiler/rustc_mir_transform/src/check_unsafety.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -129,7 +129,7 @@ impl<'tcx> Visitor<'tcx> for UnsafetyChecker<'_, 'tcx> {\n                 }\n                 &AggregateKind::Closure(def_id, _) | &AggregateKind::Generator(def_id, _, _) => {\n                     let UnsafetyCheckResult { violations, used_unsafe_blocks, .. } =\n-                        self.tcx.unsafety_check_result(def_id.expect_local());\n+                        self.tcx.unsafety_check_result(def_id);\n                     self.register_violations(\n                         violations,\n                         used_unsafe_blocks.iter().map(|(&h, &d)| (h, d)),"}, {"sha": "847e64dc2a2f1c3469187c30c1dba8569b50e933", "filename": "compiler/rustc_monomorphize/src/util.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_monomorphize%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_monomorphize%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_monomorphize%2Fsrc%2Futil.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -17,8 +17,8 @@ pub(crate) fn dump_closure_profile<'tcx>(tcx: TyCtxt<'tcx>, closure_instance: In\n         return;\n     };\n \n-    let closure_def_id = closure_instance.def_id();\n-    let typeck_results = tcx.typeck(closure_def_id.expect_local());\n+    let closure_def_id = closure_instance.def_id().expect_local();\n+    let typeck_results = tcx.typeck(closure_def_id);\n \n     if typeck_results.closure_size_eval.contains_key(&closure_def_id) {\n         let param_env = ty::ParamEnv::reveal_all();"}, {"sha": "461dd52b9f2f5c734021e4ab37c89e08fef4ea4a", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -519,7 +519,7 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n     fn new(ir: &'a mut IrMaps<'tcx>, body_owner: LocalDefId) -> Liveness<'a, 'tcx> {\n         let typeck_results = ir.tcx.typeck(body_owner);\n         let param_env = ir.tcx.param_env(body_owner);\n-        let closure_min_captures = typeck_results.closure_min_captures.get(&body_owner.to_def_id());\n+        let closure_min_captures = typeck_results.closure_min_captures.get(&body_owner);\n         let closure_ln = ir.add_live_node(ClosureNode);\n         let exit_ln = ir.add_live_node(ExitNode);\n "}, {"sha": "49175e97f41711407d452e8f6928d63e26438ad4", "filename": "compiler/rustc_query_impl/src/keys.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_query_impl%2Fsrc%2Fkeys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_query_impl%2Fsrc%2Fkeys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fkeys.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -191,6 +191,16 @@ impl Key for (LocalDefId, DefId) {\n     }\n }\n \n+impl Key for (LocalDefId, LocalDefId) {\n+    #[inline(always)]\n+    fn query_crate_is_local(&self) -> bool {\n+        true\n+    }\n+    fn default_span(&self, tcx: TyCtxt<'_>) -> Span {\n+        self.0.default_span(tcx)\n+    }\n+}\n+\n impl Key for (DefId, Option<Ident>) {\n     #[inline(always)]\n     fn query_crate_is_local(&self) -> bool {"}, {"sha": "75f5aced85577ad2209fcd508d918acff5799dce", "filename": "compiler/rustc_typeck/src/check/callee.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcallee.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -5,7 +5,7 @@ use crate::type_error_struct;\n use rustc_errors::{struct_span_err, Applicability, Diagnostic};\n use rustc_hir as hir;\n use rustc_hir::def::{self, Namespace, Res};\n-use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n+use rustc_hir::def_id::DefId;\n use rustc_infer::{\n     infer,\n     traits::{self, Obligation},\n@@ -19,11 +19,13 @@ use rustc_middle::ty::adjustment::{\n };\n use rustc_middle::ty::subst::{Subst, SubstsRef};\n use rustc_middle::ty::{self, Ty, TyCtxt, TypeVisitable};\n+use rustc_span::def_id::LocalDefId;\n use rustc_span::symbol::{sym, Ident};\n use rustc_span::Span;\n use rustc_target::spec::abi;\n use rustc_trait_selection::autoderef::Autoderef;\n use rustc_trait_selection::traits::query::evaluate_obligation::InferCtxtExt;\n+\n use std::iter;\n \n /// Checks that it is legal to call methods of the trait corresponding\n@@ -59,7 +61,7 @@ pub fn check_legal_trait_for_method_call(\n \n enum CallStep<'tcx> {\n     Builtin(Ty<'tcx>),\n-    DeferredClosure(DefId, ty::FnSig<'tcx>),\n+    DeferredClosure(LocalDefId, ty::FnSig<'tcx>),\n     /// E.g., enum variant constructors.\n     Overloaded(MethodCallee<'tcx>),\n }\n@@ -145,7 +147,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             }\n \n             ty::Closure(def_id, substs) => {\n-                assert_eq!(def_id.krate, LOCAL_CRATE);\n+                let def_id = def_id.expect_local();\n \n                 // Check whether this is a call to a closure where we\n                 // haven't yet decided on whether the closure is fn vs\n@@ -558,7 +560,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         call_expr: &'tcx hir::Expr<'tcx>,\n         arg_exprs: &'tcx [hir::Expr<'tcx>],\n         expected: Expectation<'tcx>,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         fn_sig: ty::FnSig<'tcx>,\n     ) -> Ty<'tcx> {\n         // `fn_sig` is the *signature* of the closure being called. We\n@@ -581,7 +583,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             arg_exprs,\n             fn_sig.c_variadic,\n             TupleArgumentsFlag::TupleArguments,\n-            Some(closure_def_id),\n+            Some(closure_def_id.to_def_id()),\n         );\n \n         fn_sig.output()"}, {"sha": "22087219667b21df772b0e5ddf3a153e4d1bc83f", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/_impl.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2F_impl.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -29,6 +29,7 @@ use rustc_middle::ty::{\n     ToPredicate, Ty, UserType,\n };\n use rustc_session::lint;\n+use rustc_span::def_id::LocalDefId;\n use rustc_span::hygiene::DesugaringKind;\n use rustc_span::symbol::{kw, sym, Ident};\n use rustc_span::{Span, DUMMY_SP};\n@@ -114,7 +115,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n     pub(in super::super) fn record_deferred_call_resolution(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         r: DeferredCallResolution<'tcx>,\n     ) {\n         let mut deferred_call_resolutions = self.deferred_call_resolutions.borrow_mut();\n@@ -123,7 +124,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n     pub(in super::super) fn remove_deferred_call_resolutions(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n     ) -> Vec<DeferredCallResolution<'tcx>> {\n         let mut deferred_call_resolutions = self.deferred_call_resolutions.borrow_mut();\n         deferred_call_resolutions.remove(&closure_def_id).unwrap_or_default()"}, {"sha": "6312b8d49f4af4a435c55db0cc2851c4157bfe9e", "filename": "compiler/rustc_typeck/src/check/inherited.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Finherited.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Finherited.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Finherited.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -2,13 +2,14 @@ use super::callee::DeferredCallResolution;\n \n use rustc_data_structures::fx::FxHashSet;\n use rustc_hir as hir;\n-use rustc_hir::def_id::{DefIdMap, LocalDefId};\n+use rustc_hir::def_id::LocalDefId;\n use rustc_hir::HirIdMap;\n use rustc_infer::infer;\n use rustc_infer::infer::{InferCtxt, InferOk, TyCtxtInferExt};\n use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::visit::TypeVisitable;\n use rustc_middle::ty::{self, Ty, TyCtxt};\n+use rustc_span::def_id::LocalDefIdMap;\n use rustc_span::{self, Span};\n use rustc_trait_selection::infer::InferCtxtExt as _;\n use rustc_trait_selection::traits::{self, ObligationCause, TraitEngine, TraitEngineExt};\n@@ -46,7 +47,7 @@ pub struct Inherited<'a, 'tcx> {\n     // decision. We keep these deferred resolutions grouped by the\n     // def-id of the closure, so that once we decide, we can easily go\n     // back and process them.\n-    pub(super) deferred_call_resolutions: RefCell<DefIdMap<Vec<DeferredCallResolution<'tcx>>>>,\n+    pub(super) deferred_call_resolutions: RefCell<LocalDefIdMap<Vec<DeferredCallResolution<'tcx>>>>,\n \n     pub(super) deferred_cast_checks: RefCell<Vec<super::cast::CastCheck<'tcx>>>,\n "}, {"sha": "dd8f943b985ffecb56859814bb43d25e4e9f10ea", "filename": "compiler/rustc_typeck/src/check/upvar.rs", "status": "modified", "additions": 21, "deletions": 26, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -35,7 +35,6 @@ use super::FnCtxt;\n use crate::expr_use_visitor as euv;\n use rustc_errors::{Applicability, MultiSpan};\n use rustc_hir as hir;\n-use rustc_hir::def_id::DefId;\n use rustc_hir::def_id::LocalDefId;\n use rustc_hir::intravisit::{self, Visitor};\n use rustc_infer::infer::UpvarRegion;\n@@ -186,27 +185,25 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 );\n             }\n         };\n+        let closure_def_id = closure_def_id.expect_local();\n \n         let infer_kind = if let UpvarSubsts::Closure(closure_substs) = substs {\n             self.closure_kind(closure_substs).is_none().then_some(closure_substs)\n         } else {\n             None\n         };\n \n-        let local_def_id = closure_def_id.expect_local();\n-\n-        let body_owner_def_id = self.tcx.hir().body_owner_def_id(body.id());\n-        assert_eq!(body_owner_def_id.to_def_id(), closure_def_id);\n+        assert_eq!(self.tcx.hir().body_owner_def_id(body.id()), closure_def_id);\n         let mut delegate = InferBorrowKind {\n             fcx: self,\n-            closure_def_id: local_def_id,\n+            closure_def_id,\n             capture_information: Default::default(),\n             fake_reads: Default::default(),\n         };\n         euv::ExprUseVisitor::new(\n             &mut delegate,\n             &self.infcx,\n-            body_owner_def_id,\n+            closure_def_id,\n             self.param_env,\n             &self.typeck_results.borrow(),\n         )\n@@ -224,7 +221,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n         self.compute_min_captures(closure_def_id, capture_information, span);\n \n-        let closure_hir_id = self.tcx.hir().local_def_id_to_hir_id(local_def_id);\n+        let closure_hir_id = self.tcx.hir().local_def_id_to_hir_id(closure_def_id);\n \n         if should_do_rust_2021_incompatible_closure_captures_analysis(self.tcx, closure_hir_id) {\n             self.perform_2229_migration_anaysis(closure_def_id, body_id, capture_clause, span);\n@@ -239,7 +236,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n             if let Some(upvars) = self.tcx.upvars_mentioned(closure_def_id) {\n                 for var_hir_id in upvars.keys() {\n-                    let place = self.place_for_root_variable(local_def_id, *var_hir_id);\n+                    let place = self.place_for_root_variable(closure_def_id, *var_hir_id);\n \n                     debug!(\"seed place {:?}\", place);\n \n@@ -333,7 +330,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     }\n \n     // Returns a list of `Ty`s for each upvar.\n-    fn final_upvar_tys(&self, closure_id: DefId) -> Vec<Ty<'tcx>> {\n+    fn final_upvar_tys(&self, closure_id: LocalDefId) -> Vec<Ty<'tcx>> {\n         self.typeck_results\n             .borrow()\n             .closure_min_captures_flattened(closure_id)\n@@ -511,7 +508,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     /// ```\n     fn compute_min_captures(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         capture_information: InferredCaptureInformation<'tcx>,\n         closure_span: Span,\n     ) {\n@@ -730,7 +727,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     /// `disjoint_capture_drop_reorder` if needed.\n     fn perform_2229_migration_anaysis(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         body_id: hir::BodyId,\n         capture_clause: hir::CaptureBy,\n         span: Span,\n@@ -746,8 +743,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             let (migration_string, migrated_variables_concat) =\n                 migration_suggestion_for_2229(self.tcx, &need_migrations);\n \n-            let closure_hir_id =\n-                self.tcx.hir().local_def_id_to_hir_id(closure_def_id.expect_local());\n+            let closure_hir_id = self.tcx.hir().local_def_id_to_hir_id(closure_def_id);\n             let closure_head_span = self.tcx.def_span(closure_def_id);\n             self.tcx.struct_span_lint_hir(\n                 lint::builtin::RUST_2021_INCOMPATIBLE_CLOSURE_CAPTURES,\n@@ -1058,15 +1054,15 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     #[instrument(level = \"debug\", skip(self))]\n     fn compute_2229_migrations_for_drop(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         closure_span: Span,\n         min_captures: Option<&ty::RootVariableMinCaptureList<'tcx>>,\n         closure_clause: hir::CaptureBy,\n         var_hir_id: hir::HirId,\n     ) -> Option<FxHashSet<UpvarMigrationInfo>> {\n         let ty = self.resolve_vars_if_possible(self.node_ty(var_hir_id));\n \n-        if !ty.has_significant_drop(self.tcx, self.tcx.param_env(closure_def_id.expect_local())) {\n+        if !ty.has_significant_drop(self.tcx, self.tcx.param_env(closure_def_id)) {\n             debug!(\"does not have significant drop\");\n             return None;\n         }\n@@ -1160,7 +1156,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     #[instrument(level = \"debug\", skip(self))]\n     fn compute_2229_migrations(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         closure_span: Span,\n         closure_clause: hir::CaptureBy,\n         min_captures: Option<&ty::RootVariableMinCaptureList<'tcx>>,\n@@ -1343,14 +1339,13 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     /// implements Drop which will be affected since `y` isn't completely captured.\n     fn has_significant_drop_outside_of_captures(\n         &self,\n-        closure_def_id: DefId,\n+        closure_def_id: LocalDefId,\n         closure_span: Span,\n         base_path_ty: Ty<'tcx>,\n         captured_by_move_projs: Vec<&[Projection<'tcx>]>,\n     ) -> bool {\n-        let needs_drop = |ty: Ty<'tcx>| {\n-            ty.has_significant_drop(self.tcx, self.tcx.param_env(closure_def_id.expect_local()))\n-        };\n+        let needs_drop =\n+            |ty: Ty<'tcx>| ty.has_significant_drop(self.tcx, self.tcx.param_env(closure_def_id));\n \n         let is_drop_defined_for_ty = |ty: Ty<'tcx>| {\n             let drop_trait = self.tcx.require_lang_item(hir::LangItem::Drop, Some(closure_span));\n@@ -1360,7 +1355,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     drop_trait,\n                     ty,\n                     ty_params,\n-                    self.tcx.param_env(closure_def_id.expect_local()),\n+                    self.tcx.param_env(closure_def_id),\n                 )\n                 .must_apply_modulo_regions()\n         };\n@@ -1518,13 +1513,13 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n-    fn should_log_capture_analysis(&self, closure_def_id: DefId) -> bool {\n-        self.tcx.has_attr(closure_def_id, sym::rustc_capture_analysis)\n+    fn should_log_capture_analysis(&self, closure_def_id: LocalDefId) -> bool {\n+        self.tcx.has_attr(closure_def_id.to_def_id(), sym::rustc_capture_analysis)\n     }\n \n     fn log_capture_analysis_first_pass(\n         &self,\n-        closure_def_id: rustc_hir::def_id::DefId,\n+        closure_def_id: LocalDefId,\n         capture_information: &InferredCaptureInformation<'tcx>,\n         closure_span: Span,\n     ) {\n@@ -1543,7 +1538,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n-    fn log_closure_min_capture_info(&self, closure_def_id: DefId, closure_span: Span) {\n+    fn log_closure_min_capture_info(&self, closure_def_id: LocalDefId, closure_span: Span) {\n         if self.should_log_capture_analysis(closure_def_id) {\n             if let Some(min_captures) =\n                 self.typeck_results.borrow().closure_min_captures.get(&closure_def_id)"}, {"sha": "f549807c39c91c7626dd99f2e4dc1e5003809d92", "filename": "compiler/rustc_typeck/src/check/writeback.rs", "status": "modified", "additions": 11, "deletions": 14, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwriteback.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -8,7 +8,6 @@ use hir::def_id::LocalDefId;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::ErrorGuaranteed;\n use rustc_hir as hir;\n-use rustc_hir::def_id::DefId;\n use rustc_hir::intravisit::{self, Visitor};\n use rustc_infer::infer::error_reporting::TypeAnnotationNeeded::E0282;\n use rustc_infer::infer::InferCtxt;\n@@ -348,14 +347,13 @@ impl<'cx, 'tcx> Visitor<'tcx> for WritebackCx<'cx, 'tcx> {\n \n impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n     fn eval_closure_size(&mut self) {\n-        let mut res: FxHashMap<DefId, ClosureSizeProfileData<'tcx>> = Default::default();\n-        for (closure_def_id, data) in self.fcx.typeck_results.borrow().closure_size_eval.iter() {\n-            let closure_hir_id =\n-                self.tcx().hir().local_def_id_to_hir_id(closure_def_id.expect_local());\n+        let mut res: FxHashMap<LocalDefId, ClosureSizeProfileData<'tcx>> = Default::default();\n+        for (&closure_def_id, data) in self.fcx.typeck_results.borrow().closure_size_eval.iter() {\n+            let closure_hir_id = self.tcx().hir().local_def_id_to_hir_id(closure_def_id);\n \n             let data = self.resolve(*data, &closure_hir_id);\n \n-            res.insert(*closure_def_id, data);\n+            res.insert(closure_def_id, data);\n         }\n \n         self.typeck_results.closure_size_eval = res;\n@@ -365,7 +363,7 @@ impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n             self.fcx.typeck_results.borrow().closure_min_captures.len(),\n             Default::default(),\n         );\n-        for (closure_def_id, root_min_captures) in\n+        for (&closure_def_id, root_min_captures) in\n             self.fcx.typeck_results.borrow().closure_min_captures.iter()\n         {\n             let mut root_var_map_wb = ty::RootVariableMinCaptureList::with_capacity_and_hasher(\n@@ -377,37 +375,36 @@ impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n                     .iter()\n                     .map(|captured_place| {\n                         let locatable = captured_place.info.path_expr_id.unwrap_or_else(|| {\n-                            self.tcx().hir().local_def_id_to_hir_id(closure_def_id.expect_local())\n+                            self.tcx().hir().local_def_id_to_hir_id(closure_def_id)\n                         });\n \n                         self.resolve(captured_place.clone(), &locatable)\n                     })\n                     .collect();\n                 root_var_map_wb.insert(*var_hir_id, min_list_wb);\n             }\n-            min_captures_wb.insert(*closure_def_id, root_var_map_wb);\n+            min_captures_wb.insert(closure_def_id, root_var_map_wb);\n         }\n \n         self.typeck_results.closure_min_captures = min_captures_wb;\n     }\n \n     fn visit_fake_reads_map(&mut self) {\n         let mut resolved_closure_fake_reads: FxHashMap<\n-            DefId,\n+            LocalDefId,\n             Vec<(HirPlace<'tcx>, FakeReadCause, hir::HirId)>,\n         > = Default::default();\n-        for (closure_def_id, fake_reads) in\n+        for (&closure_def_id, fake_reads) in\n             self.fcx.typeck_results.borrow().closure_fake_reads.iter()\n         {\n             let mut resolved_fake_reads = Vec::<(HirPlace<'tcx>, FakeReadCause, hir::HirId)>::new();\n             for (place, cause, hir_id) in fake_reads.iter() {\n-                let locatable =\n-                    self.tcx().hir().local_def_id_to_hir_id(closure_def_id.expect_local());\n+                let locatable = self.tcx().hir().local_def_id_to_hir_id(closure_def_id);\n \n                 let resolved_fake_read = self.resolve(place.clone(), &locatable);\n                 resolved_fake_reads.push((resolved_fake_read, *cause, *hir_id));\n             }\n-            resolved_closure_fake_reads.insert(*closure_def_id, resolved_fake_reads);\n+            resolved_closure_fake_reads.insert(closure_def_id, resolved_fake_reads);\n         }\n         self.typeck_results.closure_fake_reads = resolved_closure_fake_reads;\n     }"}, {"sha": "74a5b6e42c30a8a417dce88f60b75322227c08b5", "filename": "compiler/rustc_typeck/src/expr_use_visitor.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/compiler%2Frustc_typeck%2Fsrc%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fexpr_use_visitor.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -468,7 +468,7 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n             self.borrow_expr(discr, ty::ImmBorrow);\n         } else {\n             let closure_def_id = match discr_place.place.base {\n-                PlaceBase::Upvar(upvar_id) => Some(upvar_id.closure_expr_id.to_def_id()),\n+                PlaceBase::Upvar(upvar_id) => Some(upvar_id.closure_expr_id),\n                 _ => None,\n             };\n \n@@ -642,7 +642,7 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n \n     fn walk_arm(&mut self, discr_place: &PlaceWithHirId<'tcx>, arm: &hir::Arm<'_>) {\n         let closure_def_id = match discr_place.place.base {\n-            PlaceBase::Upvar(upvar_id) => Some(upvar_id.closure_expr_id.to_def_id()),\n+            PlaceBase::Upvar(upvar_id) => Some(upvar_id.closure_expr_id),\n             _ => None,\n         };\n \n@@ -666,7 +666,7 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n     /// let binding, and *not* a match arm or nested pat.)\n     fn walk_irrefutable_pat(&mut self, discr_place: &PlaceWithHirId<'tcx>, pat: &hir::Pat<'_>) {\n         let closure_def_id = match discr_place.place.base {\n-            PlaceBase::Upvar(upvar_id) => Some(upvar_id.closure_expr_id.to_def_id()),\n+            PlaceBase::Upvar(upvar_id) => Some(upvar_id.closure_expr_id),\n             _ => None,\n         };\n \n@@ -763,7 +763,7 @@ impl<'a, 'tcx> ExprUseVisitor<'a, 'tcx> {\n         debug!(\"walk_captures({:?})\", closure_expr);\n \n         let tcx = self.tcx();\n-        let closure_def_id = tcx.hir().local_def_id(closure_expr.hir_id).to_def_id();\n+        let closure_def_id = tcx.hir().local_def_id(closure_expr.hir_id);\n         let upvars = tcx.upvars_mentioned(self.body_owner);\n \n         // For purposes of this function, generator and closures are equivalent."}, {"sha": "018059facbd184dc7128d1ce14afc1bd55a2a4fd", "filename": "src/tools/clippy/clippy_utils/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf2433a74f7474f7d41e9842d7de465b0966831a/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf2433a74f7474f7d41e9842d7de465b0966831a/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs?ref=cf2433a74f7474f7d41e9842d7de465b0966831a", "patch": "@@ -968,7 +968,7 @@ pub fn can_move_expr_to_closure<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'\n                     }\n                 },\n                 ExprKind::Closure { .. } => {\n-                    let closure_id = self.cx.tcx.hir().local_def_id(e.hir_id).to_def_id();\n+                    let closure_id = self.cx.tcx.hir().local_def_id(e.hir_id);\n                     for capture in self.cx.typeck_results().closure_min_captures_flattened(closure_id) {\n                         let local_id = match capture.place.base {\n                             PlaceBase::Local(id) => id,"}]}