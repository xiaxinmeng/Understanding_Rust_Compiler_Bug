{"sha": "f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "node_id": "C_kwDOAAsO6NoAKGY3ZTJjYjQ0NzBmNTI4OGU2NjU3MTY2ZmIwZmNkZjRiNzA0MzUxN2Y", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-09T03:44:21Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-09T03:44:21Z"}, "message": "Auto merge of #9308 - daxpedda:missing-const-for-fn, r=Jarcho\n\nUse `check_proc_macro` for `missing_const_for_fn`\n\nThis uses `@Jarcho's` #8694 implementation to fix `missing_const_for_fn` linting in proc-macros.\nI'm not 100% sure what I'm doing here, any feedback is appreciated.\n\nPreviously: https://github.com/Jarcho/rust-clippy/pull/1.\nFixes #8854.\n\nchangelog: [`missing_const_for_fn`]: No longer lints in proc-macros", "tree": {"sha": "4707680f190d213701786a5615617f3697a7a398", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4707680f190d213701786a5615617f3697a7a398"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "html_url": "https://github.com/rust-lang/rust/commit/f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3af9072bc6ecd429f9101301166331dec21a1300", "url": "https://api.github.com/repos/rust-lang/rust/commits/3af9072bc6ecd429f9101301166331dec21a1300", "html_url": "https://github.com/rust-lang/rust/commit/3af9072bc6ecd429f9101301166331dec21a1300"}, {"sha": "fd605816287de96486066accf4e3a10e412ff055", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd605816287de96486066accf4e3a10e412ff055", "html_url": "https://github.com/rust-lang/rust/commit/fd605816287de96486066accf4e3a10e412ff055"}], "stats": {"total": 61, "additions": 54, "deletions": 7}, "files": [{"sha": "bc304c081b9062ec2f121665a81db06a6a20d48b", "filename": "clippy_lints/src/missing_const_for_fn.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/clippy_lints%2Fsrc%2Fmissing_const_for_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/clippy_lints%2Fsrc%2Fmissing_const_for_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmissing_const_for_fn.rs?ref=f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "patch": "@@ -1,7 +1,9 @@\n use clippy_utils::diagnostics::span_lint;\n use clippy_utils::qualify_min_const_fn::is_min_const_fn;\n use clippy_utils::ty::has_drop;\n-use clippy_utils::{fn_has_unsatisfiable_preds, is_entrypoint_fn, meets_msrv, msrvs, trait_ref_of_method};\n+use clippy_utils::{\n+    fn_has_unsatisfiable_preds, is_entrypoint_fn, is_from_proc_macro, meets_msrv, msrvs, trait_ref_of_method,\n+};\n use rustc_hir as hir;\n use rustc_hir::def_id::CRATE_DEF_ID;\n use rustc_hir::intravisit::FnKind;\n@@ -86,10 +88,10 @@ impl MissingConstForFn {\n impl<'tcx> LateLintPass<'tcx> for MissingConstForFn {\n     fn check_fn(\n         &mut self,\n-        cx: &LateContext<'_>,\n-        kind: FnKind<'_>,\n+        cx: &LateContext<'tcx>,\n+        kind: FnKind<'tcx>,\n         _: &FnDecl<'_>,\n-        _: &Body<'_>,\n+        body: &Body<'tcx>,\n         span: Span,\n         hir_id: HirId,\n     ) {\n@@ -144,6 +146,10 @@ impl<'tcx> LateLintPass<'tcx> for MissingConstForFn {\n             }\n         }\n \n+        if is_from_proc_macro(cx, &(&kind, body, hir_id, span)) {\n+            return;\n+        }\n+\n         let mir = cx.tcx.optimized_mir(def_id);\n \n         if let Err((span, err)) = is_min_const_fn(cx.tcx, mir, self.msrv) {"}, {"sha": "8335ffae81eb7ce64c97caba247b02847103ca86", "filename": "clippy_utils/src/check_proc_macro.rs", "status": "modified", "additions": 35, "deletions": 3, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/clippy_utils%2Fsrc%2Fcheck_proc_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/clippy_utils%2Fsrc%2Fcheck_proc_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fcheck_proc_macro.rs?ref=f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "patch": "@@ -14,9 +14,9 @@\n \n use rustc_ast::ast::{IntTy, LitIntType, LitKind, StrStyle, UintTy};\n use rustc_hir::{\n-    Block, BlockCheckMode, Closure, Destination, Expr, ExprKind, FieldDef, FnHeader, Impl, ImplItem, ImplItemKind,\n-    IsAuto, Item, ItemKind, LoopSource, MatchSource, QPath, TraitItem, TraitItemKind, UnOp, UnsafeSource, Unsafety,\n-    Variant, VariantData, YieldSource,\n+    intravisit::FnKind, Block, BlockCheckMode, Body, Closure, Destination, Expr, ExprKind, FieldDef, FnHeader, HirId,\n+    Impl, ImplItem, ImplItemKind, IsAuto, Item, ItemKind, LoopSource, MatchSource, Node, QPath, TraitItem,\n+    TraitItemKind, UnOp, UnsafeSource, Unsafety, Variant, VariantData, YieldSource,\n };\n use rustc_lint::{LateContext, LintContext};\n use rustc_middle::ty::TyCtxt;\n@@ -250,6 +250,26 @@ fn variant_search_pat(v: &Variant<'_>) -> (Pat, Pat) {\n     }\n }\n \n+fn fn_kind_pat(tcx: TyCtxt<'_>, kind: &FnKind<'_>, body: &Body<'_>, hir_id: HirId) -> (Pat, Pat) {\n+    let (start_pat, end_pat) = match kind {\n+        FnKind::ItemFn(.., header) => (fn_header_search_pat(*header), Pat::Str(\"\")),\n+        FnKind::Method(.., sig) => (fn_header_search_pat(sig.header), Pat::Str(\"\")),\n+        FnKind::Closure => return (Pat::Str(\"\"), expr_search_pat(tcx, &body.value).1),\n+    };\n+    let start_pat = match tcx.hir().get(hir_id) {\n+        Node::Item(Item { vis_span, .. }) | Node::ImplItem(ImplItem { vis_span, .. }) => {\n+            if vis_span.is_empty() {\n+                start_pat\n+            } else {\n+                Pat::Str(\"pub\")\n+            }\n+        },\n+        Node::TraitItem(_) => start_pat,\n+        _ => Pat::Str(\"\"),\n+    };\n+    (start_pat, end_pat)\n+}\n+\n pub trait WithSearchPat {\n     type Context: LintContext;\n     fn search_pat(&self, cx: &Self::Context) -> (Pat, Pat);\n@@ -277,6 +297,18 @@ impl_with_search_pat!(LateContext: ImplItem with impl_item_search_pat);\n impl_with_search_pat!(LateContext: FieldDef with field_def_search_pat);\n impl_with_search_pat!(LateContext: Variant with variant_search_pat);\n \n+impl<'cx> WithSearchPat for (&FnKind<'cx>, &Body<'cx>, HirId, Span) {\n+    type Context = LateContext<'cx>;\n+\n+    fn search_pat(&self, cx: &Self::Context) -> (Pat, Pat) {\n+        fn_kind_pat(cx.tcx, self.0, self.1, self.2)\n+    }\n+\n+    fn span(&self) -> Span {\n+        self.3\n+    }\n+}\n+\n /// Checks if the item likely came from a proc-macro.\n ///\n /// This should be called after `in_external_macro` and the initial pattern matching of the ast as"}, {"sha": "b950248ef942024d0e003fc5be16c8ba0c249101", "filename": "tests/ui/missing_const_for_fn/cant_be_const.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/tests%2Fui%2Fmissing_const_for_fn%2Fcant_be_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7e2cb4470f5288e6657166fb0fcdf4b7043517f/tests%2Fui%2Fmissing_const_for_fn%2Fcant_be_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmissing_const_for_fn%2Fcant_be_const.rs?ref=f7e2cb4470f5288e6657166fb0fcdf4b7043517f", "patch": "@@ -3,12 +3,16 @@\n //! The .stderr output of this test should be empty. Otherwise it's a bug somewhere.\n \n // aux-build:helper.rs\n+// aux-build:../../auxiliary/proc_macro_with_span.rs\n \n #![warn(clippy::missing_const_for_fn)]\n #![feature(start)]\n #![feature(custom_inner_attributes)]\n \n extern crate helper;\n+extern crate proc_macro_with_span;\n+\n+use proc_macro_with_span::with_span;\n \n struct Game;\n \n@@ -119,3 +123,8 @@ mod const_fn_stabilized_after_msrv {\n         byte.is_ascii_digit();\n     }\n }\n+\n+with_span! {\n+    span\n+    fn dont_check_in_proc_macro() {}\n+}"}]}