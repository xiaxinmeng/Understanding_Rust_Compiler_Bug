{"sha": "844dc31494ad130169477c57c9ba10acd5e8923f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0NGRjMzE0OTRhZDEzMDE2OTQ3N2M1N2M5YmExMGFjZDVlODkyM2Y=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2020-06-30T07:13:15Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2020-06-30T07:13:15Z"}, "message": "ci: fix wasm32 broken due to a NodeJS version bump\n\nEmscripten's SDK recently bumped the version of NodeJS they shipped, but\nour Dockerfile for the wasm32 builder hardcoded the version number. This\nwill cause consistent CI failures once the currently cached image is\nrebuilt (either due to a change or due to the cache expiring).\n\nThis commit fixes the problem by finding the latest version of NodeJS in\nthe Emscripten SDK and symlinking it to a \"latest\" directory, which is\nthen added to the PATH.", "tree": {"sha": "0a85c4f8611382857b2eca60a7320dd85a2477fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a85c4f8611382857b2eca60a7320dd85a2477fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/844dc31494ad130169477c57c9ba10acd5e8923f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl7653oACgkQPgar6Auq\n8Zxi+w/6AoC5F/RLC1iq2+uaKnLXSgBYgZVbTXCcnh+gKAdQ2xheNgjBJ2BmO1Kr\nI/bJXKdhGvKr2if9cITbbpjr7KkqqQFSRpG2G/ikMrZceT4NZyxJ1YcAVgQny5on\nOp1iLA+E7CttxQoIUhIE57ONvdiemDJNOUBU5QKklpUowIIv4my9wEcYtgv3G2Ck\nfv7QcpfSPcu3ntF7anwO6ZO7bBYZ67iwbkInXMxuwymZoKsZXf6GEo+SDYEs9deh\n+kdRiCWA16guE/OjHRQsPThYuYT8O0Fwx+bxorT8ghScOArd0yS2IZT4dObjamnd\nPaLzsfjp3D+fQOnh858rWJE89bfXRHWVrGByvk8rQUv4SGKl+A3ik2cXiJDPgof6\nYTDacSPMg1oUwUKfk09XWuCJozmnYw+gFtXyl3qXGMN/GxNJwKkj3NUkc+obaRm3\ng++sWrz+CDcfQ/TFCcgvk26LcVMFLQmD8vKorJXl2l2jD6nQIHt5DDLM5gd+w4Wv\nUSDtLuUnhYrCNwwqQ5J4RYa25tMOuJg7lhi8pAu36zMZ7EY6M/bHttyo9nx83nsk\nO/g6BtrX1I1CVCWw7HJb9sZl9KFNM+6EASDiy7FDiyBoTIJ3Px2qGLjGxoHEaxQw\nQNrepoIyTvHQP1z+rRQsRhVAdFfqO87iLXUFfZjtBY2Y853Py3g=\n=iGNG\n-----END PGP SIGNATURE-----", "payload": "tree 0a85c4f8611382857b2eca60a7320dd85a2477fa\nparent a1528c432e45339d9b5602a19ac3571e2900d37b\nauthor Pietro Albini <pietro@pietroalbini.org> 1593501195 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1593501195 +0200\n\nci: fix wasm32 broken due to a NodeJS version bump\n\nEmscripten's SDK recently bumped the version of NodeJS they shipped, but\nour Dockerfile for the wasm32 builder hardcoded the version number. This\nwill cause consistent CI failures once the currently cached image is\nrebuilt (either due to a change or due to the cache expiring).\n\nThis commit fixes the problem by finding the latest version of NodeJS in\nthe Emscripten SDK and symlinking it to a \"latest\" directory, which is\nthen added to the PATH.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/844dc31494ad130169477c57c9ba10acd5e8923f", "html_url": "https://github.com/rust-lang/rust/commit/844dc31494ad130169477c57c9ba10acd5e8923f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/844dc31494ad130169477c57c9ba10acd5e8923f/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1528c432e45339d9b5602a19ac3571e2900d37b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1528c432e45339d9b5602a19ac3571e2900d37b", "html_url": "https://github.com/rust-lang/rust/commit/a1528c432e45339d9b5602a19ac3571e2900d37b"}], "stats": {"total": 13, "additions": 12, "deletions": 1}, "files": [{"sha": "92461305320eee8d67e68f3f67c5d4bcc863c4a7", "filename": "src/ci/docker/wasm32/Dockerfile", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/844dc31494ad130169477c57c9ba10acd5e8923f/src%2Fci%2Fdocker%2Fwasm32%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/844dc31494ad130169477c57c9ba10acd5e8923f/src%2Fci%2Fdocker%2Fwasm32%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fwasm32%2FDockerfile?ref=844dc31494ad130169477c57c9ba10acd5e8923f", "patch": "@@ -25,7 +25,18 @@ RUN ln `which python3` /usr/bin/python\n \n ENV PATH=$PATH:/emsdk-portable\n ENV PATH=$PATH:/emsdk-portable/upstream/emscripten/\n-ENV PATH=$PATH:/emsdk-portable/node/12.9.1_64bit/bin/\n+\n+# Rust's build system requires NodeJS to be in the path, but the directory in\n+# which emsdk stores it contains the version number. This caused breakages in\n+# the past when emsdk bumped the node version causing the path to point to a\n+# missing directory.\n+#\n+# To avoid the problem this symlinks the latest NodeJs version available to\n+# \"latest\", and adds that to the path.\n+RUN ln -s /emsdk-portable/node/$(ls /emsdk-portable/node | sort -V | tail -n 1) \\\n+          /emsdk-portable/node/latest\n+ENV PATH=$PATH:/emsdk-portable/node/latest/bin/\n+\n ENV BINARYEN_ROOT=/emsdk-portable/upstream/\n ENV EMSDK=/emsdk-portable\n ENV EM_CONFIG=/emsdk-portable/.emscripten"}]}