{"sha": "9b6c5109058d0662c9340b0328bcad591458f35d", "node_id": "C_kwDOAAsO6NoAKDliNmM1MTA5MDU4ZDA2NjJjOTM0MGIwMzI4YmNhZDU5MTQ1OGYzNWQ", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-04-01T09:34:39Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2021-12-07T16:47:21Z"}, "message": "Future compatibility warning on cfg_attr on crate_type and crate_name", "tree": {"sha": "b15e9ae6165e7c77601ab4336588ec2b6cf85b7c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b15e9ae6165e7c77601ab4336588ec2b6cf85b7c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b6c5109058d0662c9340b0328bcad591458f35d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b6c5109058d0662c9340b0328bcad591458f35d", "html_url": "https://github.com/rust-lang/rust/commit/9b6c5109058d0662c9340b0328bcad591458f35d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b6c5109058d0662c9340b0328bcad591458f35d/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5c94945096265b6d675b2f55a247c4799de8d87", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5c94945096265b6d675b2f55a247c4799de8d87", "html_url": "https://github.com/rust-lang/rust/commit/c5c94945096265b6d675b2f55a247c4799de8d87"}], "stats": {"total": 105, "additions": 92, "deletions": 13}, "files": [{"sha": "5221ab4b6133a67a228d26c3d6a9bcde24f22c60", "filename": "compiler/rustc_expand/src/config.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/9b6c5109058d0662c9340b0328bcad591458f35d/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b6c5109058d0662c9340b0328bcad591458f35d/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs?ref=9b6c5109058d0662c9340b0328bcad591458f35d", "patch": "@@ -402,7 +402,24 @@ impl<'a> StripUnconfigured<'a> {\n                 );\n                 trees.push((bracket_group, Spacing::Alone));\n                 let tokens = Some(LazyTokenStream::new(AttrAnnotatedTokenStream::new(trees)));\n-                self.process_cfg_attr(attr::mk_attr_from_item(item, tokens, attr.style, span))\n+                let attr = attr::mk_attr_from_item(item, tokens, attr.style, span);\n+                if attr.has_name(sym::crate_type) {\n+                    self.sess.parse_sess.buffer_lint(\n+                        rustc_lint_defs::builtin::DEPRECATED_CFG_ATTR_CRATE_TYPE_NAME,\n+                        attr.span,\n+                        ast::CRATE_NODE_ID,\n+                        \"`crate_type` within an `#![cfg_attr] attribute is deprecated`\",\n+                    );\n+                }\n+                if attr.has_name(sym::crate_name) {\n+                    self.sess.parse_sess.buffer_lint(\n+                        rustc_lint_defs::builtin::DEPRECATED_CFG_ATTR_CRATE_TYPE_NAME,\n+                        attr.span,\n+                        ast::CRATE_NODE_ID,\n+                        \"`crate_name` within an `#![cfg_attr] attribute is deprecated`\",\n+                    );\n+                }\n+                self.process_cfg_attr(attr)\n             })\n             .collect()\n     }"}, {"sha": "c9294c68a7dc9b4999c73143d451f49edc92d3a5", "filename": "compiler/rustc_lint_defs/src/builtin.rs", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/9b6c5109058d0662c9340b0328bcad591458f35d/compiler%2Frustc_lint_defs%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b6c5109058d0662c9340b0328bcad591458f35d/compiler%2Frustc_lint_defs%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint_defs%2Fsrc%2Fbuiltin.rs?ref=9b6c5109058d0662c9340b0328bcad591458f35d", "patch": "@@ -2960,6 +2960,41 @@ declare_lint! {\n     \"detects large moves or copies\",\n }\n \n+declare_lint! {\n+    /// The `deprecated_cfg_attr_crate_type_name` lint detects uses of the\n+    /// `#![cfg_attr(..., crate_type = \"...\")]` and\n+    /// `#![cfg_attr(..., crate_name = \"...\")]` attributes to conditionally\n+    /// specify the crate type and name in the source code.\n+    ///\n+    /// ### Example\n+    ///\n+    /// ```rust\n+    /// #![cfg_attr(debug_assertions, crate_type = \"lib\")]\n+    /// ```\n+    ///\n+    /// {{produces}}\n+    ///\n+    ///\n+    /// ### Explanation\n+    ///\n+    /// The `#![crate_type]` and `#![crate_name]` attributes require a hack in\n+    /// the compiler to be able to change the used crate type and crate name\n+    /// after macros have been expanded. Neither attribute works in combination\n+    /// with Cargo as it explicitly passes `--crate-type` and `--crate-name` on\n+    /// the commandline. These values must match the value used in the source\n+    /// code to prevent an error.\n+    ///\n+    /// To fix the warning use `--crate-type` on the commandline when running\n+    /// rustc instead of `#![cfg_attr(..., crate_type = \"...\")]` and\n+    /// `--crate-name` instead of `#![cfg_attr(..., crate_name = \"...\")]`.\n+    pub DEPRECATED_CFG_ATTR_CRATE_TYPE_NAME,\n+    Warn,\n+    \"detects usage of `#![cfg_attr(..., crate_type/crate_name = \\\"...\\\")]`\",\n+    @future_incompatible = FutureIncompatibleInfo {\n+        reference: \"issue #91632 <https://github.com/rust-lang/rust/issues/91632>\",\n+    };\n+}\n+\n declare_lint_pass! {\n     /// Does nothing as a lint pass, but registers some `Lint`s\n     /// that are used by other parts of the compiler.\n@@ -3056,6 +3091,7 @@ declare_lint_pass! {\n         NON_EXHAUSTIVE_OMITTED_PATTERNS,\n         TEXT_DIRECTION_CODEPOINT_IN_COMMENT,\n         DEREF_INTO_DYN_SUPERTRAIT,\n+        DEPRECATED_CFG_ATTR_CRATE_TYPE_NAME,\n     ]\n }\n "}, {"sha": "1e0f5d79c0b426cf461417a8077192b2b0461d1b", "filename": "src/test/ui/cfg/auxiliary/crate-attributes-using-cfg_attr.rs", "status": "removed", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c5c94945096265b6d675b2f55a247c4799de8d87/src%2Ftest%2Fui%2Fcfg%2Fauxiliary%2Fcrate-attributes-using-cfg_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5c94945096265b6d675b2f55a247c4799de8d87/src%2Ftest%2Fui%2Fcfg%2Fauxiliary%2Fcrate-attributes-using-cfg_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfg%2Fauxiliary%2Fcrate-attributes-using-cfg_attr.rs?ref=c5c94945096265b6d675b2f55a247c4799de8d87", "patch": "@@ -1,6 +0,0 @@\n-// no-prefer-dynamic\n-// compile-flags: --cfg foo\n-\n-#![cfg_attr(foo, crate_type=\"lib\")]\n-\n-pub fn foo() {}"}, {"sha": "43b266b778f0eeb4c689dfc51d03041339621dfb", "filename": "src/test/ui/cfg/crate-attributes-using-cfg_attr.rs", "status": "removed", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c5c94945096265b6d675b2f55a247c4799de8d87/src%2Ftest%2Fui%2Fcfg%2Fcrate-attributes-using-cfg_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5c94945096265b6d675b2f55a247c4799de8d87/src%2Ftest%2Fui%2Fcfg%2Fcrate-attributes-using-cfg_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfg%2Fcrate-attributes-using-cfg_attr.rs?ref=c5c94945096265b6d675b2f55a247c4799de8d87", "patch": "@@ -1,6 +0,0 @@\n-// run-pass\n-// aux-build:crate-attributes-using-cfg_attr.rs\n-\n-extern crate crate_attributes_using_cfg_attr;\n-\n-pub fn main() {}"}, {"sha": "ef12b05fab23723c9fa2084f2c36d0e62be657b5", "filename": "src/test/ui/cfg/future-compat-crate-attributes-using-cfg_attr.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9b6c5109058d0662c9340b0328bcad591458f35d/src%2Ftest%2Fui%2Fcfg%2Ffuture-compat-crate-attributes-using-cfg_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b6c5109058d0662c9340b0328bcad591458f35d/src%2Ftest%2Fui%2Fcfg%2Ffuture-compat-crate-attributes-using-cfg_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfg%2Ffuture-compat-crate-attributes-using-cfg_attr.rs?ref=9b6c5109058d0662c9340b0328bcad591458f35d", "patch": "@@ -0,0 +1,12 @@\n+// check-fail\n+// compile-flags:--cfg foo\n+\n+#![deny(warnings)]\n+#![cfg_attr(foo, crate_type=\"bin\")]\n+//~^ERROR `crate_type` within\n+//~| WARN this was previously accepted\n+#![cfg_attr(foo, crate_name=\"bar\")]\n+//~^ERROR `crate_name` within\n+//~| WARN this was previously accepted\n+\n+fn main() {}"}, {"sha": "5df2eacc96e1ee9461d588c8b67a801dccce69a7", "filename": "src/test/ui/cfg/future-compat-crate-attributes-using-cfg_attr.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/9b6c5109058d0662c9340b0328bcad591458f35d/src%2Ftest%2Fui%2Fcfg%2Ffuture-compat-crate-attributes-using-cfg_attr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9b6c5109058d0662c9340b0328bcad591458f35d/src%2Ftest%2Fui%2Fcfg%2Ffuture-compat-crate-attributes-using-cfg_attr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfg%2Ffuture-compat-crate-attributes-using-cfg_attr.stderr?ref=9b6c5109058d0662c9340b0328bcad591458f35d", "patch": "@@ -0,0 +1,26 @@\n+error: `crate_type` within an `#![cfg_attr] attribute is deprecated`\n+  --> $DIR/future-compat-crate-attributes-using-cfg_attr.rs:5:18\n+   |\n+LL | #![cfg_attr(foo, crate_type=\"bin\")]\n+   |                  ^^^^^^^^^^^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/future-compat-crate-attributes-using-cfg_attr.rs:4:9\n+   |\n+LL | #![deny(warnings)]\n+   |         ^^^^^^^^\n+   = note: `#[deny(deprecated_cfg_attr_crate_type_name)]` implied by `#[deny(warnings)]`\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #91632 <https://github.com/rust-lang/rust/issues/91632>\n+\n+error: `crate_name` within an `#![cfg_attr] attribute is deprecated`\n+  --> $DIR/future-compat-crate-attributes-using-cfg_attr.rs:8:18\n+   |\n+LL | #![cfg_attr(foo, crate_name=\"bar\")]\n+   |                  ^^^^^^^^^^^^^^^^\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #91632 <https://github.com/rust-lang/rust/issues/91632>\n+\n+error: aborting due to 2 previous errors\n+"}]}