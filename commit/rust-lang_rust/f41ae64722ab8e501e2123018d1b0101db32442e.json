{"sha": "f41ae64722ab8e501e2123018d1b0101db32442e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0MWFlNjQ3MjJhYjhlNTAxZTIxMjMwMThkMWIwMTAxZGIzMjQ0MmU=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-03-23T03:22:33Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-03-23T19:44:28Z"}, "message": "Ignore proc-macro stdout to prevent IPC crash", "tree": {"sha": "dc8b1bb7af970bdeb2fcad7316be9bb87a6ff928", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dc8b1bb7af970bdeb2fcad7316be9bb87a6ff928"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f41ae64722ab8e501e2123018d1b0101db32442e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f41ae64722ab8e501e2123018d1b0101db32442e", "html_url": "https://github.com/rust-lang/rust/commit/f41ae64722ab8e501e2123018d1b0101db32442e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f41ae64722ab8e501e2123018d1b0101db32442e/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4b997b86633b1c0ca134d89e8236d285422c04e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b997b86633b1c0ca134d89e8236d285422c04e3", "html_url": "https://github.com/rust-lang/rust/commit/4b997b86633b1c0ca134d89e8236d285422c04e3"}], "stats": {"total": 29, "additions": 22, "deletions": 7}, "files": [{"sha": "21e56cc831b081d4a1b2cddb4cc10b304e14e579", "filename": "crates/proc_macro_api/src/msg.rs", "status": "modified", "additions": 18, "deletions": 7, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/f41ae64722ab8e501e2123018d1b0101db32442e/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41ae64722ab8e501e2123018d1b0101db32442e/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs?ref=f41ae64722ab8e501e2123018d1b0101db32442e", "patch": "@@ -77,13 +77,24 @@ impl Message for Request {}\n impl Message for Response {}\n \n fn read_json(inp: &mut impl BufRead) -> io::Result<Option<String>> {\n-    let mut buf = String::new();\n-    inp.read_line(&mut buf)?;\n-    buf.pop(); // Remove trailing '\\n'\n-    Ok(match buf.len() {\n-        0 => None,\n-        _ => Some(buf),\n-    })\n+    loop {\n+        let mut buf = String::new();\n+        inp.read_line(&mut buf)?;\n+        buf.pop(); // Remove trailing '\\n'\n+\n+        if buf.is_empty() {\n+            return Ok(None);\n+        }\n+\n+        // Some ill behaved macro try to use stdout for debugging\n+        // We ignore it here\n+        if !buf.starts_with(\"{\") {\n+            log::error!(\"proc-macro tried to print : {}\", buf);\n+            continue;\n+        }\n+\n+        return Ok(Some(buf));\n+    }\n }\n \n fn write_json(out: &mut impl Write, msg: &str) -> io::Result<()> {"}, {"sha": "4442cbff68101f209689822c608789fdeeb3e01a", "filename": "crates/rust-analyzer/tests/rust-analyzer/main.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f41ae64722ab8e501e2123018d1b0101db32442e/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f41ae64722ab8e501e2123018d1b0101db32442e/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fmain.rs?ref=f41ae64722ab8e501e2123018d1b0101db32442e", "patch": "@@ -712,6 +712,10 @@ pub fn foo(_input: TokenStream) -> TokenStream {\n     // We hard code the output here for preventing to use any deps\n     let mut res = TokenStream::new();\n \n+    // ill behaved proc-macro will use the stdout\n+    // we should ignore it\n+    println!(\"I am bad guy\");\n+\n     // impl Bar for Foo { fn bar() {} }\n     let mut tokens = vec![t!(\"impl\"), t!(\"Bar\"), t!(\"for\"), t!(\"Foo\")];\n     let mut fn_stream = TokenStream::new();"}]}