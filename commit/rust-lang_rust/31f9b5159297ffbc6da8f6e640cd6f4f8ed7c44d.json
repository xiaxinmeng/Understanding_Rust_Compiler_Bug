{"sha": "31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxZjliNTE1OTI5N2ZmYmM2ZGE4ZjZlNjQwY2Q2ZjRmOGVkN2M0NGQ=", "commit": {"author": {"name": "Ben Blum", "email": "bblum@andrew.cmu.edu", "date": "2013-08-08T23:34:08Z"}, "committer": {"name": "Ben Blum", "email": "bblum@andrew.cmu.edu", "date": "2013-08-12T17:54:21Z"}, "message": "Make cell with_ref/with_mut_ref use finally. Close #7975.", "tree": {"sha": "9d14178854b1beed81e89b0431a00b1ab14790a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d14178854b1beed81e89b0431a00b1ab14790a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d", "html_url": "https://github.com/rust-lang/rust/commit/31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d/comments", "author": {"login": "bblum", "id": 1820515, "node_id": "MDQ6VXNlcjE4MjA1MTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bblum", "html_url": "https://github.com/bblum", "followers_url": "https://api.github.com/users/bblum/followers", "following_url": "https://api.github.com/users/bblum/following{/other_user}", "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}", "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bblum/subscriptions", "organizations_url": "https://api.github.com/users/bblum/orgs", "repos_url": "https://api.github.com/users/bblum/repos", "events_url": "https://api.github.com/users/bblum/events{/privacy}", "received_events_url": "https://api.github.com/users/bblum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bblum", "id": 1820515, "node_id": "MDQ6VXNlcjE4MjA1MTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1820515?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bblum", "html_url": "https://github.com/bblum", "followers_url": "https://api.github.com/users/bblum/followers", "following_url": "https://api.github.com/users/bblum/following{/other_user}", "gists_url": "https://api.github.com/users/bblum/gists{/gist_id}", "starred_url": "https://api.github.com/users/bblum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bblum/subscriptions", "organizations_url": "https://api.github.com/users/bblum/orgs", "repos_url": "https://api.github.com/users/bblum/repos", "events_url": "https://api.github.com/users/bblum/events{/privacy}", "received_events_url": "https://api.github.com/users/bblum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c8c09d40fc3e34b1e8cc2cd58fd644488aa71327", "url": "https://api.github.com/repos/rust-lang/rust/commits/c8c09d40fc3e34b1e8cc2cd58fd644488aa71327", "html_url": "https://github.com/rust-lang/rust/commit/c8c09d40fc3e34b1e8cc2cd58fd644488aa71327"}], "stats": {"total": 16, "additions": 8, "deletions": 8}, "files": [{"sha": "372effad61d3c99713e2734f81a0651f95fecef9", "filename": "src/libstd/cell.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d/src%2Flibstd%2Fcell.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d/src%2Flibstd%2Fcell.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fcell.rs?ref=31f9b5159297ffbc6da8f6e640cd6f4f8ed7c44d", "patch": "@@ -13,6 +13,7 @@\n #[missing_doc];\n \n use cast::transmute_mut;\n+use unstable::finally::Finally;\n use prelude::*;\n \n /*\n@@ -65,18 +66,17 @@ impl<T> Cell<T> {\n \n     /// Calls a closure with a reference to the value.\n     pub fn with_ref<R>(&self, op: &fn(v: &T) -> R) -> R {\n-        let v = self.take();\n-        let r = op(&v);\n-        self.put_back(v);\n-        r\n+        do self.with_mut_ref |ptr| { op(ptr) }\n     }\n \n     /// Calls a closure with a mutable reference to the value.\n     pub fn with_mut_ref<R>(&self, op: &fn(v: &mut T) -> R) -> R {\n-        let mut v = self.take();\n-        let r = op(&mut v);\n-        self.put_back(v);\n-        r\n+        let mut v = Some(self.take());\n+        do (|| {\n+            op(v.get_mut_ref())\n+        }).finally {\n+            self.put_back(v.take_unwrap());\n+        }\n     }\n }\n "}]}