{"sha": "a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1ZDg1YTYzNTZkYzc2MWQwNDdmNDZiZjA0ZWFlMDlkYzlhYjgwZjk=", "commit": {"author": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2021-05-23T10:52:41Z"}, "committer": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2021-05-23T10:52:41Z"}, "message": "Add test for #8931 and better checking", "tree": {"sha": "c02c9f04b9f1ef694d2a1e0680e137e060a7cda2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c02c9f04b9f1ef694d2a1e0680e137e060a7cda2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "html_url": "https://github.com/rust-lang/rust/commit/a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bc1ba1549d97e7d5ddceb16b7238ae8aab5794d0", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc1ba1549d97e7d5ddceb16b7238ae8aab5794d0", "html_url": "https://github.com/rust-lang/rust/commit/bc1ba1549d97e7d5ddceb16b7238ae8aab5794d0"}], "stats": {"total": 127, "additions": 114, "deletions": 13}, "files": [{"sha": "800101c91968f879d6b331f242bfe5ea7c3bcfb7", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "patch": "@@ -2053,7 +2053,7 @@ impl Type {\n         name: Option<&Name>,\n         mut callback: impl FnMut(&Ty, AssocItem) -> Option<T>,\n     ) -> Option<T> {\n-        let canonical = hir_ty::replace_errors_with_variables(self.ty.clone());\n+        let canonical = hir_ty::replace_errors_with_variables(&self.ty);\n \n         let env = self.env.clone();\n         let krate = krate.id;\n@@ -2222,7 +2222,7 @@ impl Type {\n     }\n \n     pub fn could_unify_with(&self, db: &dyn HirDatabase, other: &Type) -> bool {\n-        let tys = hir_ty::replace_errors_with_variables((self.ty.clone(), other.ty.clone()));\n+        let tys = hir_ty::replace_errors_with_variables(&(self.ty.clone(), other.ty.clone()));\n         could_unify(db, self.env.clone(), &tys)\n     }\n }"}, {"sha": "ef021978aded67a22552bbfc15737f4eabb67302", "filename": "crates/hir_ty/src/lib.rs", "status": "modified", "additions": 83, "deletions": 11, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/crates%2Fhir_ty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/crates%2Fhir_ty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Flib.rs?ref=a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "patch": "@@ -43,7 +43,6 @@ use hir_def::{\n     type_ref::{ConstScalar, Rawness},\n     TypeParamId,\n };\n-use stdx::always;\n \n use crate::{db::HirDatabase, utils::generics};\n \n@@ -329,14 +328,17 @@ pub(crate) fn fold_tys<T: HasInterner<Interner = Interner> + Fold<Interner>>(\n     t.fold_with(&mut TyFolder(f), binders).expect(\"fold failed unexpectedly\")\n }\n \n-pub fn replace_errors_with_variables<T>(t: T) -> Canonical<T::Result>\n+/// 'Canonicalizes' the `t` by replacing any errors with new variables. Also\n+/// ensures there are no unbound variables or inference variables anywhere in\n+/// the `t`.\n+pub fn replace_errors_with_variables<T>(t: &T) -> Canonical<T::Result>\n where\n-    T: HasInterner<Interner = Interner> + Fold<Interner>,\n+    T: HasInterner<Interner = Interner> + Fold<Interner> + Clone,\n     T::Result: HasInterner<Interner = Interner>,\n {\n     use chalk_ir::{\n         fold::{Folder, SuperFold},\n-        Fallible,\n+        Fallible, NoSolution,\n     };\n     struct ErrorReplacer {\n         vars: usize,\n@@ -363,18 +365,88 @@ where\n \n         fn fold_inference_ty(\n             &mut self,\n-            var: InferenceVar,\n-            kind: TyVariableKind,\n+            _var: InferenceVar,\n+            _kind: TyVariableKind,\n+            _outer_binder: DebruijnIndex,\n+        ) -> Fallible<Ty> {\n+            if cfg!(debug_assertions) {\n+                // we don't want to just panic here, because then the error message\n+                // won't contain the whole thing, which would not be very helpful\n+                Err(NoSolution)\n+            } else {\n+                Ok(TyKind::Error.intern(&Interner))\n+            }\n+        }\n+\n+        fn fold_free_var_ty(\n+            &mut self,\n+            _bound_var: BoundVar,\n             _outer_binder: DebruijnIndex,\n         ) -> Fallible<Ty> {\n-            always!(false);\n-            Ok(TyKind::InferenceVar(var, kind).intern(&Interner))\n+            if cfg!(debug_assertions) {\n+                // we don't want to just panic here, because then the error message\n+                // won't contain the whole thing, which would not be very helpful\n+                Err(NoSolution)\n+            } else {\n+                Ok(TyKind::Error.intern(&Interner))\n+            }\n+        }\n+\n+        fn fold_inference_const(\n+            &mut self,\n+            _ty: Ty,\n+            _var: InferenceVar,\n+            _outer_binder: DebruijnIndex,\n+        ) -> Fallible<Const> {\n+            if cfg!(debug_assertions) {\n+                Err(NoSolution)\n+            } else {\n+                Ok(dummy_usize_const())\n+            }\n+        }\n+\n+        fn fold_free_var_const(\n+            &mut self,\n+            _ty: Ty,\n+            _bound_var: BoundVar,\n+            _outer_binder: DebruijnIndex,\n+        ) -> Fallible<Const> {\n+            if cfg!(debug_assertions) {\n+                Err(NoSolution)\n+            } else {\n+                Ok(dummy_usize_const())\n+            }\n+        }\n+\n+        fn fold_inference_lifetime(\n+            &mut self,\n+            _var: InferenceVar,\n+            _outer_binder: DebruijnIndex,\n+        ) -> Fallible<Lifetime> {\n+            if cfg!(debug_assertions) {\n+                Err(NoSolution)\n+            } else {\n+                Ok(static_lifetime())\n+            }\n+        }\n+\n+        fn fold_free_var_lifetime(\n+            &mut self,\n+            _bound_var: BoundVar,\n+            _outer_binder: DebruijnIndex,\n+        ) -> Fallible<Lifetime> {\n+            if cfg!(debug_assertions) {\n+                Err(NoSolution)\n+            } else {\n+                Ok(static_lifetime())\n+            }\n         }\n     }\n     let mut error_replacer = ErrorReplacer { vars: 0 };\n-    let value = t\n-        .fold_with(&mut error_replacer, DebruijnIndex::INNERMOST)\n-        .expect(\"fold failed unexpectedly\");\n+    let value = match t.clone().fold_with(&mut error_replacer, DebruijnIndex::INNERMOST) {\n+        Ok(t) => t,\n+        Err(_) => panic!(\"Encountered unbound or inference vars in {:?}\", t),\n+    };\n     let kinds = (0..error_replacer.vars).map(|_| {\n         chalk_ir::CanonicalVarKind::new(\n             chalk_ir::VariableKind::Ty(TyVariableKind::General),"}, {"sha": "1bff559365be9bc72595c741b591295f9fb023a0", "filename": "crates/ide_completion/src/completions/dot.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fdot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5d85a6356dc761d047f46bf04eae09dc9ab80f9/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fdot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fdot.rs?ref=a5d85a6356dc761d047f46bf04eae09dc9ab80f9", "patch": "@@ -454,4 +454,33 @@ mod foo {\n             \"#]],\n         );\n     }\n+\n+    #[test]\n+    fn issue_8931() {\n+        check(\n+            r#\"\n+#[lang = \"fn_once\"]\n+trait FnOnce<Args> {\n+    type Output;\n+}\n+struct S;\n+\n+struct Foo;\n+impl Foo {\n+    fn foo(&self) -> &[u8] { loop {} }\n+}\n+\n+impl S {\n+    fn indented(&mut self, f: impl FnOnce(&mut Self)) {\n+    }\n+\n+    fn f(&mut self, v: Foo) {\n+        self.indented(|this| v.$0)\n+    }\n+}\n+        \"#,\n+            expect![[r#\"\n+            \"#]],\n+        );\n+    }\n }"}]}