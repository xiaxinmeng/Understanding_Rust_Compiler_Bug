{"sha": "cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "node_id": "C_kwDOAAsO6NoAKGNlY2I5MDFlNjgzY2RjMWEyZmZiYjFlMzMxYmE0ZjI2MmUyMjE1YzA", "commit": {"author": {"name": "Andy Wang", "email": "cbeuw.andy@gmail.com", "date": "2023-04-11T14:23:35Z"}, "committer": {"name": "Andy Wang", "email": "cbeuw.andy@gmail.com", "date": "2023-04-11T14:23:35Z"}, "message": "Add Offset binary op to custom mir", "tree": {"sha": "9939ddb334d43179bee358eae0192a52f118724a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9939ddb334d43179bee358eae0192a52f118724a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCAAdFiEE7dcbcBMl24/h63ldGBtJ+fOPM3QFAmQ1bWcACgkQGBtJ+fOP\nM3Qy6AwAiTv6vmn3oVhImVRARGRZetDwYLtK31q96IgHVn21XzPk5/lL1EAeI1dI\nHUndGq6Z9az54a+o0ZT0oH6RPC3BLC/nEq9YlBarTkTkn7au/HrB5vVeg8pfpNBH\nolZ3aHrUauDgqFlfTzRVbr7i06FZzzwqMOW1OjnjVu57gWrZJFT49Tzv+BIls/Q8\nx3XDVo9UAtTwcm6Lmqp+L6g6dmx6BIwYwDlVBhS8ypUR4A9MPL9unIQc4LimWd2/\nOybOYy85tiCsNNGF4BfRWBoaoGlPW3BGJqXbAQAVqSHiFYJQSTpYkdszyUN6IXEr\nmSR+HxLhu31JZm+lPw167ja5HIl2GcXU5mB/w9j42O3ymc5VRJrz7vwNlscC1jga\n4QZwlLcCNHqUV7xZVyHpoJiqh2AEt8/KjCz4tmlYkpP+Mdo04NX466SUgoSRj4hX\nlat1MJyU7OHZb+dwKgUKUoARHXpLejDCaxdHHGUhyVnqGtAAIT4tLXqru2Kmug6F\nKtK08MDs\n=Ut9q\n-----END PGP SIGNATURE-----", "payload": "tree 9939ddb334d43179bee358eae0192a52f118724a\nparent dfe024e1041d1cba1d3191024de3b7128c6734e6\nauthor Andy Wang <cbeuw.andy@gmail.com> 1681223015 +0200\ncommitter Andy Wang <cbeuw.andy@gmail.com> 1681223015 +0200\n\nAdd Offset binary op to custom mir\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "html_url": "https://github.com/rust-lang/rust/commit/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/comments", "author": {"login": "cbeuw", "id": 7034308, "node_id": "MDQ6VXNlcjcwMzQzMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/7034308?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cbeuw", "html_url": "https://github.com/cbeuw", "followers_url": "https://api.github.com/users/cbeuw/followers", "following_url": "https://api.github.com/users/cbeuw/following{/other_user}", "gists_url": "https://api.github.com/users/cbeuw/gists{/gist_id}", "starred_url": "https://api.github.com/users/cbeuw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cbeuw/subscriptions", "organizations_url": "https://api.github.com/users/cbeuw/orgs", "repos_url": "https://api.github.com/users/cbeuw/repos", "events_url": "https://api.github.com/users/cbeuw/events{/privacy}", "received_events_url": "https://api.github.com/users/cbeuw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cbeuw", "id": 7034308, "node_id": "MDQ6VXNlcjcwMzQzMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/7034308?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cbeuw", "html_url": "https://github.com/cbeuw", "followers_url": "https://api.github.com/users/cbeuw/followers", "following_url": "https://api.github.com/users/cbeuw/following{/other_user}", "gists_url": "https://api.github.com/users/cbeuw/gists{/gist_id}", "starred_url": "https://api.github.com/users/cbeuw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cbeuw/subscriptions", "organizations_url": "https://api.github.com/users/cbeuw/orgs", "repos_url": "https://api.github.com/users/cbeuw/repos", "events_url": "https://api.github.com/users/cbeuw/events{/privacy}", "received_events_url": "https://api.github.com/users/cbeuw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dfe024e1041d1cba1d3191024de3b7128c6734e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfe024e1041d1cba1d3191024de3b7128c6734e6", "html_url": "https://github.com/rust-lang/rust/commit/dfe024e1041d1cba1d3191024de3b7128c6734e6"}], "stats": {"total": 28, "additions": 28, "deletions": 0}, "files": [{"sha": "931fe1b2433a0cb56efc6bebe1609cbde205117e", "filename": "compiler/rustc_mir_build/src/build/custom/parse/instruction.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs?ref=cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "patch": "@@ -148,6 +148,11 @@ impl<'tcx, 'body> ParseCtxt<'tcx, 'body> {\n                     )),\n                 )\n             },\n+            @call(\"mir_offset\", args) => {\n+                let ptr = self.parse_operand(args[0])?;\n+                let offset = self.parse_operand(args[1])?;\n+                Ok(Rvalue::BinaryOp(BinOp::Offset, Box::new((ptr, offset))))\n+            },\n             @call(\"mir_len\", args) => Ok(Rvalue::Len(self.parse_place(args[0])?)),\n             ExprKind::Borrow { borrow_kind, arg } => Ok(\n                 Rvalue::Ref(self.tcx.lifetimes.re_erased, *borrow_kind, self.parse_place(*arg)?)"}, {"sha": "d9d62eb759e69ca984a384a4c10ee3d4f5a42f27", "filename": "library/core/src/intrinsics/mir.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs?ref=cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "patch": "@@ -232,6 +232,7 @@\n //!  - `&`, `&mut`, `addr_of!`, and `addr_of_mut!` all work to create their associated rvalue.\n //!  - [`Discriminant`] and [`Len`] have associated functions.\n //!  - Unary and binary operations use their normal Rust syntax - `a * b`, `!c`, etc.\n+//!  - The binary operation `Offset` can be created via [`Offset`].\n //!  - Checked binary operations are represented by wrapping the associated binop in [`Checked`].\n //!  - Array repetition syntax (`[foo; 10]`) creates the associated rvalue.\n //!\n@@ -289,6 +290,7 @@ define!(\n     fn Discriminant<T>(place: T) -> <T as ::core::marker::DiscriminantKind>::Discriminant\n );\n define!(\"mir_set_discriminant\", fn SetDiscriminant<T>(place: T, index: u32));\n+define!(\"mir_offset\", fn Offset<T, U>(ptr: T, count: U) -> T);\n define!(\n     \"mir_field\",\n     /// Access the field with the given index of some place."}, {"sha": "f614aef4029d0127d091b66a6a2027929007339a", "filename": "tests/mir-opt/building/custom/references.raw_pointer_offset.built.after.mir", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.raw_pointer_offset.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.raw_pointer_offset.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.raw_pointer_offset.built.after.mir?ref=cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "patch": "@@ -0,0 +1,10 @@\n+// MIR for `raw_pointer_offset` after built\n+\n+fn raw_pointer_offset(_1: *const i32) -> *const i32 {\n+    let mut _0: *const i32;              // return place in scope 0 at $DIR/references.rs:+0:45: +0:55\n+\n+    bb0: {\n+        _0 = Offset(_1, const 1_isize);  // scope 0 at $DIR/references.rs:+2:9: +2:33\n+        return;                          // scope 0 at $DIR/references.rs:+3:9: +3:17\n+    }\n+}"}, {"sha": "f87f6664c7a5c55b86fa488c7f6092de604b84f3", "filename": "tests/mir-opt/building/custom/references.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cecb901e683cdc1a2ffbb1e331ba4f262e2215c0/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Freferences.rs?ref=cecb901e683cdc1a2ffbb1e331ba4f262e2215c0", "patch": "@@ -45,11 +45,22 @@ pub fn raw_pointer(x: *const i32) -> *const i32 {\n     })\n }\n \n+// EMIT_MIR references.raw_pointer_offset.built.after.mir\n+#[custom_mir(dialect = \"built\")]\n+pub fn raw_pointer_offset(x: *const i32) -> *const i32 {\n+    mir!({\n+        RET = Offset(x, 1_isize);\n+        Return()\n+    })\n+}\n+\n fn main() {\n     let mut x = 5;\n+    let arr = [1, 2];\n     assert_eq!(*mut_ref(&mut x), 5);\n     assert_eq!(*immut_ref(&x), 5);\n     unsafe {\n         assert_eq!(*raw_pointer(addr_of!(x)), 5);\n+        assert_eq!(*raw_pointer_offset(addr_of!(arr[0])), 2);\n     }\n }"}]}