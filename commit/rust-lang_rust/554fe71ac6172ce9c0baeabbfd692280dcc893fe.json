{"sha": "554fe71ac6172ce9c0baeabbfd692280dcc893fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1NGZlNzFhYzYxNzJjZTljMGJhZWFiYmZkNjkyMjgwZGNjODkzZmU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-02-17T02:58:21Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-02-17T02:58:21Z"}, "message": "Auto merge of #47906 - Zoxc:nocycle, r=nikomatsakis\n\nAdd a `fatal_cycle` attribute for queries which indicates that they will cause a fatal error on query cycles\n\nThis moves us towards the goal of having cycle errors be non-fatal by not relying on the default implementation of `ty::maps::values::Value` which aborts on errors.\n\nr? @nikomatsakis", "tree": {"sha": "e227ba3fa9a3000c5be13c96e55414b69904ffda", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e227ba3fa9a3000c5be13c96e55414b69904ffda"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/554fe71ac6172ce9c0baeabbfd692280dcc893fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/554fe71ac6172ce9c0baeabbfd692280dcc893fe", "html_url": "https://github.com/rust-lang/rust/commit/554fe71ac6172ce9c0baeabbfd692280dcc893fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/554fe71ac6172ce9c0baeabbfd692280dcc893fe/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58a8e0c27152e9306f8e0cd4fa3a162f5ae8e8c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/58a8e0c27152e9306f8e0cd4fa3a162f5ae8e8c4", "html_url": "https://github.com/rust-lang/rust/commit/58a8e0c27152e9306f8e0cd4fa3a162f5ae8e8c4"}, {"sha": "e236994c5e4c448fba3c02874f875b0844e43725", "url": "https://api.github.com/repos/rust-lang/rust/commits/e236994c5e4c448fba3c02874f875b0844e43725", "html_url": "https://github.com/rust-lang/rust/commit/e236994c5e4c448fba3c02874f875b0844e43725"}], "stats": {"total": 36, "additions": 27, "deletions": 9}, "files": [{"sha": "21ffe6b895e72cca62aefae16ae84a78a278fab1", "filename": "src/librustc/ty/maps/mod.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/554fe71ac6172ce9c0baeabbfd692280dcc893fe/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/554fe71ac6172ce9c0baeabbfd692280dcc893fe/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs?ref=554fe71ac6172ce9c0baeabbfd692280dcc893fe", "patch": "@@ -78,6 +78,11 @@ pub use self::on_disk_cache::OnDiskCache;\n // a way that memoizes and does dep-graph tracking,\n // wrapping around the actual chain of providers that\n // the driver creates (using several `rustc_*` crates).\n+//\n+// The result of query must implement Clone. They must also implement ty::maps::values::Value\n+// which produces an appropiate error value if the query resulted in a query cycle.\n+// Queries marked with `fatal_cycle` do not need that implementation\n+// as they will raise an fatal error on query cycles instead.\n define_maps! { <'tcx>\n     /// Records the type of every item.\n     [] fn type_of: TypeOfItem(DefId) -> Ty<'tcx>,\n@@ -267,13 +272,13 @@ define_maps! { <'tcx>\n     [] fn dylib_dependency_formats: DylibDepFormats(CrateNum)\n                                     -> Rc<Vec<(CrateNum, LinkagePreference)>>,\n \n-    [] fn is_panic_runtime: IsPanicRuntime(CrateNum) -> bool,\n-    [] fn is_compiler_builtins: IsCompilerBuiltins(CrateNum) -> bool,\n-    [] fn has_global_allocator: HasGlobalAllocator(CrateNum) -> bool,\n-    [] fn is_sanitizer_runtime: IsSanitizerRuntime(CrateNum) -> bool,\n-    [] fn is_profiler_runtime: IsProfilerRuntime(CrateNum) -> bool,\n-    [] fn panic_strategy: GetPanicStrategy(CrateNum) -> PanicStrategy,\n-    [] fn is_no_builtins: IsNoBuiltins(CrateNum) -> bool,\n+    [fatal_cycle] fn is_panic_runtime: IsPanicRuntime(CrateNum) -> bool,\n+    [fatal_cycle] fn is_compiler_builtins: IsCompilerBuiltins(CrateNum) -> bool,\n+    [fatal_cycle] fn has_global_allocator: HasGlobalAllocator(CrateNum) -> bool,\n+    [fatal_cycle] fn is_sanitizer_runtime: IsSanitizerRuntime(CrateNum) -> bool,\n+    [fatal_cycle] fn is_profiler_runtime: IsProfilerRuntime(CrateNum) -> bool,\n+    [fatal_cycle] fn panic_strategy: GetPanicStrategy(CrateNum) -> PanicStrategy,\n+    [fatal_cycle] fn is_no_builtins: IsNoBuiltins(CrateNum) -> bool,\n \n     [] fn extern_crate: ExternCrate(DefId) -> Rc<Option<ExternCrate>>,\n "}, {"sha": "f02c7cbd0ea3e8dcf6d36bbd9201cd97e541a44c", "filename": "src/librustc/ty/maps/plumbing.rs", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/554fe71ac6172ce9c0baeabbfd692280dcc893fe/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/554fe71ac6172ce9c0baeabbfd692280dcc893fe/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs?ref=554fe71ac6172ce9c0baeabbfd692280dcc893fe", "patch": "@@ -183,6 +183,19 @@ macro_rules! profq_key {\n     }\n }\n \n+macro_rules! handle_cycle_error {\n+    ([][$this: expr]) => {{\n+        Value::from_cycle_error($this.global_tcx())\n+    }};\n+    ([fatal_cycle$(, $modifiers:ident)*][$this:expr]) => {{\n+        $this.tcx.sess.abort_if_errors();\n+        unreachable!();\n+    }};\n+    ([$other:ident$(, $modifiers:ident)*][$($args:tt)*]) => {\n+        handle_cycle_error!([$($modifiers),*][$($args)*])\n+    };\n+}\n+\n macro_rules! define_maps {\n     (<$tcx:tt>\n      $($(#[$attr:meta])*\n@@ -564,7 +577,7 @@ macro_rules! define_maps {\n             pub fn $name(self, key: $K) -> $V {\n                 queries::$name::try_get(self.tcx, self.span, key).unwrap_or_else(|mut e| {\n                     e.emit();\n-                    Value::from_cycle_error(self.global_tcx())\n+                    handle_cycle_error!([$($modifiers)*][self])\n                 })\n             })*\n         }\n@@ -583,7 +596,7 @@ macro_rules! define_maps {\n \n macro_rules! define_map_struct {\n     (tcx: $tcx:tt,\n-     input: ($(([$(modifiers:tt)*] [$($attr:tt)*] [$name:ident]))*)) => {\n+     input: ($(([$($modifiers:tt)*] [$($attr:tt)*] [$name:ident]))*)) => {\n         pub struct Maps<$tcx> {\n             providers: IndexVec<CrateNum, Providers<$tcx>>,\n             query_stack: RefCell<Vec<(Span, Query<$tcx>)>>,"}]}