{"sha": "8cb3426f16e22215f9a8dd61bb8b965fb9b26023", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjYjM0MjZmMTZlMjIyMTVmOWE4ZGQ2MWJiOGI5NjVmYjliMjYwMjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-04T23:21:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-04T23:21:36Z"}, "message": "auto merge of #9723 : blake2-ppc/rust/trans-no-push-ctxt-clone, r=alexcrichton\n\nAvoid cloning the stack on every `push_ctxt` call in trans\r\n\r\nRewrite the use of TLS variable for `push_ctxt` so that it uses a ~[]\r\ninstead of a @~[]. Before it cloned the whole vector on each push and\r\npop, which is unnecessary.", "tree": {"sha": "09f66e0a9730281aaee65121da54de27b0275036", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/09f66e0a9730281aaee65121da54de27b0275036"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8cb3426f16e22215f9a8dd61bb8b965fb9b26023", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8cb3426f16e22215f9a8dd61bb8b965fb9b26023", "html_url": "https://github.com/rust-lang/rust/commit/8cb3426f16e22215f9a8dd61bb8b965fb9b26023", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8cb3426f16e22215f9a8dd61bb8b965fb9b26023/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5295f9c4713e77dbb8dfc76bc91e10fceaabbb2", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5295f9c4713e77dbb8dfc76bc91e10fceaabbb2", "html_url": "https://github.com/rust-lang/rust/commit/c5295f9c4713e77dbb8dfc76bc91e10fceaabbb2"}, {"sha": "87294c23baacaee17a13d2f7316fffc76239cff5", "url": "https://api.github.com/repos/rust-lang/rust/commits/87294c23baacaee17a13d2f7316fffc76239cff5", "html_url": "https://github.com/rust-lang/rust/commit/87294c23baacaee17a13d2f7316fffc76239cff5"}], "stats": {"total": 22, "additions": 11, "deletions": 11}, "files": [{"sha": "2c0497283c19c04a56224baf64ae77e45cc4e410", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/8cb3426f16e22215f9a8dd61bb8b965fb9b26023/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8cb3426f16e22215f9a8dd61bb8b965fb9b26023/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=8cb3426f16e22215f9a8dd61bb8b965fb9b26023", "patch": "@@ -92,17 +92,19 @@ use syntax::visit::Visitor;\n \n pub use middle::trans::context::task_llcx;\n \n-local_data_key!(task_local_insn_key: @~[&'static str])\n+local_data_key!(task_local_insn_key: ~[&'static str])\n \n pub fn with_insn_ctxt(blk: &fn(&[&'static str])) {\n-    let opt = local_data::get(task_local_insn_key, |k| k.map_move(|k| *k));\n-    if opt.is_some() {\n-        blk(*opt.unwrap());\n+    do local_data::get(task_local_insn_key) |c| {\n+        match c {\n+            Some(ctx) => blk(*ctx),\n+            None => ()\n+        }\n     }\n }\n \n pub fn init_insn_ctxt() {\n-    local_data::set(task_local_insn_key, @~[]);\n+    local_data::set(task_local_insn_key, ~[]);\n }\n \n pub struct _InsnCtxt { _x: () }\n@@ -111,10 +113,9 @@ pub struct _InsnCtxt { _x: () }\n impl Drop for _InsnCtxt {\n     fn drop(&mut self) {\n         do local_data::modify(task_local_insn_key) |c| {\n-            do c.map_move |ctx| {\n-                let mut ctx = (*ctx).clone();\n+            do c.map_move |mut ctx| {\n                 ctx.pop();\n-                @ctx\n+                ctx\n             }\n         }\n     }\n@@ -123,10 +124,9 @@ impl Drop for _InsnCtxt {\n pub fn push_ctxt(s: &'static str) -> _InsnCtxt {\n     debug2!(\"new InsnCtxt: {}\", s);\n     do local_data::modify(task_local_insn_key) |c| {\n-        do c.map_move |ctx| {\n-            let mut ctx = (*ctx).clone();\n+        do c.map_move |mut ctx| {\n             ctx.push(s);\n-            @ctx\n+            ctx\n         }\n     }\n     _InsnCtxt { _x: () }"}]}