{"sha": "19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE5ZTFhYWM2ZWE5ODc5YzZkMTBlZWQ3MTA2YjNiYzg4M2U1YmY5YTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-15T02:10:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-15T02:10:11Z"}, "message": "Auto merge of #77756 - alarsyo:setup-llvm-detect, r=jyn514\n\nDetect configuration for LLVM during setup\n\nThis is a first draft to address #77579, setting `download-ci-llvm` to true on Linux, but I could also implement the `if-available` setting mentioned in the issue.\n\nOn other platforms I was thinking about using [the which crate](https://crates.io/crates/which), if adding a dependency on it is considered okay of course, to detect the presence of `llvm-config` in the path, and use it if found. Still a work in progress of course.", "tree": {"sha": "857c0b411226e175cf39aa250537179101f76a59", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/857c0b411226e175cf39aa250537179101f76a59"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "html_url": "https://github.com/rust-lang/rust/commit/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f42692b1cc1552abf905f9b6650061d246024252", "url": "https://api.github.com/repos/rust-lang/rust/commits/f42692b1cc1552abf905f9b6650061d246024252", "html_url": "https://github.com/rust-lang/rust/commit/f42692b1cc1552abf905f9b6650061d246024252"}, {"sha": "b8ae4c5e36d5ce36bf255dbaa66f64450b21efa5", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8ae4c5e36d5ce36bf255dbaa66f64450b21efa5", "html_url": "https://github.com/rust-lang/rust/commit/b8ae4c5e36d5ce36bf255dbaa66f64450b21efa5"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "ce37adeb28c93383ada9571ae9d72a8dba1c6732", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "patch": "@@ -447,7 +447,8 @@ def download_stage0(self):\n \n     def downloading_llvm(self):\n         opt = self.get_toml('download-ci-llvm', 'llvm')\n-        return opt == \"true\"\n+        return opt == \"true\" \\\n+            or (opt == \"if-available\" and self.build == \"x86_64-unknown-linux-gnu\")\n \n     def _download_stage0_helper(self, filename, pattern, tarball_suffix, date=None):\n         if date is None:\n@@ -892,7 +893,7 @@ def update_submodules(self):\n         submodules_names = []\n         for module in submodules:\n             if module.endswith(\"llvm-project\"):\n-                if self.get_toml('llvm-config') or self.get_toml('download-ci-llvm') == 'true':\n+                if self.get_toml('llvm-config') or self.downloading_llvm():\n                     if self.get_toml('lld') != 'true':\n                         continue\n             check = self.check_submodule(module, slow_submodules)\n@@ -1003,6 +1004,16 @@ def bootstrap(help_triggered):\n         with open(toml_path) as config:\n             build.config_toml = config.read()\n \n+    profile = build.get_toml('profile')\n+    if profile is not None:\n+        include_file = 'config.{}.toml'.format(profile)\n+        include_dir = os.path.join(build.rust_root, 'src', 'bootstrap', 'defaults')\n+        include_path = os.path.join(include_dir, include_file)\n+        # HACK: This works because `build.get_toml()` returns the first match it finds for a\n+        # specific key, so appending our defaults at the end allows the user to override them\n+        with open(include_path) as included_toml:\n+            build.config_toml += os.linesep + included_toml.read()\n+\n     config_verbose = build.get_toml('verbose', 'build')\n     if config_verbose is not None:\n         build.verbose = max(build.verbose, int(config_verbose))"}, {"sha": "3c1249f8de43445f257f381a5f5a07fdc3373f82", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "patch": "@@ -391,7 +391,7 @@ struct Llvm {\n     use_libcxx: Option<bool>,\n     use_linker: Option<String>,\n     allow_old_toolchain: Option<bool>,\n-    download_ci_llvm: Option<bool>,\n+    download_ci_llvm: Option<StringOrBool>,\n }\n \n #[derive(Deserialize, Default, Clone, Merge)]\n@@ -735,7 +735,14 @@ impl Config {\n             set(&mut config.llvm_use_libcxx, llvm.use_libcxx);\n             config.llvm_use_linker = llvm.use_linker.clone();\n             config.llvm_allow_old_toolchain = llvm.allow_old_toolchain;\n-            config.llvm_from_ci = llvm.download_ci_llvm.unwrap_or(false);\n+            config.llvm_from_ci = match llvm.download_ci_llvm {\n+                Some(StringOrBool::String(s)) => {\n+                    assert!(s == \"if-available\", \"unknown option `{}` for download-ci-llvm\", s);\n+                    config.build.triple == \"x86_64-unknown-linux-gnu\"\n+                }\n+                Some(StringOrBool::Bool(b)) => b,\n+                None => false,\n+            };\n \n             if config.llvm_from_ci {\n                 // None of the LLVM options, except assertions, are supported"}, {"sha": "0ca928843d5896cce3186dbec3cd0d501612eb8e", "filename": "src/bootstrap/defaults/config.compiler.toml", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml", "raw_url": "https://github.com/rust-lang/rust/raw/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml?ref=19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "patch": "@@ -6,3 +6,8 @@\n debug-logging = true\n # This greatly increases the speed of rebuilds, especially when there are only minor changes. However, it makes the initial build slightly slower.\n incremental = true\n+\n+[llvm]\n+# Will download LLVM from CI if available on your platform (Linux only for now)\n+# https://github.com/rust-lang/rust/issues/77084 tracks support for more platforms\n+download-ci-llvm = \"if-available\""}, {"sha": "9874fdb767f62fdd3d3cb9bb2f8df0dd0c5b85d7", "filename": "src/bootstrap/defaults/config.library.toml", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml", "raw_url": "https://github.com/rust-lang/rust/raw/19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml?ref=19e1aac6ea9879c6d10eed7106b3bc883e5bf9a5", "patch": "@@ -8,3 +8,8 @@ bench-stage = 0\n [rust]\n # This greatly increases the speed of rebuilds, especially when there are only minor changes. However, it makes the initial build slightly slower.\n incremental = true\n+\n+[llvm]\n+# Will download LLVM from CI if available on your platform (Linux only for now)\n+# https://github.com/rust-lang/rust/issues/77084 tracks support for more platforms\n+download-ci-llvm = \"if-available\""}]}