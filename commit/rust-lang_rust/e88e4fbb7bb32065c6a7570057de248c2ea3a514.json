{"sha": "e88e4fbb7bb32065c6a7570057de248c2ea3a514", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU4OGU0ZmJiN2JiMzIwNjVjNmE3NTcwMDU3ZGUyNDhjMmVhM2E1MTQ=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2020-09-28T11:02:28Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2020-09-28T11:02:28Z"}, "message": "Add more comments about proc macro resolution", "tree": {"sha": "15f7d5875620b5b06771969c9ba75bc28564dc78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/15f7d5875620b5b06771969c9ba75bc28564dc78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e88e4fbb7bb32065c6a7570057de248c2ea3a514", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e88e4fbb7bb32065c6a7570057de248c2ea3a514", "html_url": "https://github.com/rust-lang/rust/commit/e88e4fbb7bb32065c6a7570057de248c2ea3a514", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e88e4fbb7bb32065c6a7570057de248c2ea3a514/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e799dbe5d7cc5d09ee5457595425cf2f42e1c113", "url": "https://api.github.com/repos/rust-lang/rust/commits/e799dbe5d7cc5d09ee5457595425cf2f42e1c113", "html_url": "https://github.com/rust-lang/rust/commit/e799dbe5d7cc5d09ee5457595425cf2f42e1c113"}], "stats": {"total": 20, "additions": 20, "deletions": 0}, "files": [{"sha": "100e25ffcf05733fe05a1284628870c0ce64c558", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e88e4fbb7bb32065c6a7570057de248c2ea3a514/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e88e4fbb7bb32065c6a7570057de248c2ea3a514/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=e88e4fbb7bb32065c6a7570057de248c2ea3a514", "patch": "@@ -203,6 +203,10 @@ struct DefCollector<'a> {\n     unexpanded_attribute_macros: Vec<DeriveDirective>,\n     mod_dirs: FxHashMap<LocalModuleId, ModDir>,\n     cfg_options: &'a CfgOptions,\n+    /// List of procedural macros defined by this crate. This is read from the dynamic library\n+    /// built by the build system, and is the list of proc. macros we can actually expand. It is\n+    /// empty when proc. macro support is disabled (in which case we still do name resolution for\n+    /// them).\n     proc_macros: Vec<(Name, ProcMacroExpander)>,\n     exports_proc_macros: bool,\n     from_glob_import: PerNsGlobImports,\n@@ -279,6 +283,22 @@ impl DefCollector<'_> {\n         }\n     }\n \n+    /// Adds a definition of procedural macro `name` to the root module.\n+    ///\n+    /// # Notes on procedural macro resolution\n+    ///\n+    /// Procedural macro functionality is provided by the build system: It has to build the proc\n+    /// macro and pass the resulting dynamic library to rust-analyzer.\n+    ///\n+    /// When procedural macro support is enabled, the list of proc macros exported by a crate is\n+    /// known before we resolve names in the crate. This list is stored in `self.proc_macros` and is\n+    /// derived from the dynamic library.\n+    ///\n+    /// However, we *also* would like to be able to at least *resolve* macros on our own, without\n+    /// help by the build system. So, when the macro isn't found in `self.proc_macros`, we instead\n+    /// use a dummy expander that always errors. This comes with the drawback of macros potentially\n+    /// going out of sync with what the build system sees (since we resolve using VFS state, but\n+    /// Cargo builds only on-disk files). We could and probably should add diagnostics for that.\n     fn resolve_proc_macro(&mut self, name: &Name) {\n         self.exports_proc_macros = true;\n         let macro_def = match self.proc_macros.iter().find(|(n, _)| n == name) {"}]}