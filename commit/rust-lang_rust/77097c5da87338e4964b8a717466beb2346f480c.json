{"sha": "77097c5da87338e4964b8a717466beb2346f480c", "node_id": "C_kwDOAAsO6NoAKDc3MDk3YzVkYTg3MzM4ZTQ5NjRiOGE3MTc0NjZiZWIyMzQ2ZjQ4MGM", "commit": {"author": {"name": "Pietro Albini", "email": "pietro.albini@ferrous-systems.com", "date": "2022-06-07T11:29:39Z"}, "committer": {"name": "Pietro Albini", "email": "pietro.albini@ferrous-systems.com", "date": "2022-06-09T17:43:11Z"}, "message": "change stage0.json to reduce the chance of merge conflicts", "tree": {"sha": "1add442d939cb29e2394b7377e23f13abbaefb59", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1add442d939cb29e2394b7377e23f13abbaefb59"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/77097c5da87338e4964b8a717466beb2346f480c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEMycKYjxLY0eb13b7zXazX3c0dp4FAmKiMS8ACgkQzXazX3c0\ndp4SwA//UIoTFAya6C6PeiU4cDVJt6jI6k/zKC8e1kPqtYtsWcfcN7ge5divwGcb\nZ6RhxzhYRedjBuRJYvSNE/lqJVH1FZZPVi94lePvAVgb2hrR4pMl1ZwCK6dSa3jY\n2m9TR3Wmr6J4sdRGDa4BRgkcPWWdge+/C/bFZQeiAx3rVlvhK1RiM/k1AfS81eod\nzUId/dXx8v+HvPxsZ9u/zWsCiukyeLj2j3+U3QWafiZzvyPaqz794gOreO81yY+W\nh6DAIY7UL4F9JZ/MDnRVLFt2SSWzVT9ha8xYNwrjvnrWGDA81oKAUGcYmvCsxcZt\nXIGlSqePHU0t+qEql/GfF78SlalY1vFcIcP2trXTSFI9oE+ESxbHTH4dSDjFJno5\ndInmbI3UC9lwefTrzl3r23xbhiRsVARQWv2qZqWxsMhQm3fH5NC6VfMTu5GGWyh4\nsBWeKBGHyNsCuu6l51+PzDhBI5Hr5nHJcx2ir3ynYD76y8iyu+cWZ/cePDAOHw1N\nNf9od7BZRnpa4Wos12u3cY04Dv3qEwqbhKVmdd2ilrrxuqzu43P2UA05Wiq2NsUr\nzgjYNjZ7znem307ZWyKGfiD12KeUKEYtHP2HxYye/yfmpE3k7k9OiLF2tUz1dxxT\n6XdDg5rPZQE9Z4qyUBu7BVJv3BCMjzPNQCa2oSmj3gYl1iQE0xM=\n=2Q4L\n-----END PGP SIGNATURE-----", "payload": "tree 1add442d939cb29e2394b7377e23f13abbaefb59\nparent 97f3ecda016ca7ab3edf64e11901466f879d4483\nauthor Pietro Albini <pietro.albini@ferrous-systems.com> 1654601379 +0200\ncommitter Pietro Albini <pietro.albini@ferrous-systems.com> 1654796591 +0200\n\nchange stage0.json to reduce the chance of merge conflicts\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/77097c5da87338e4964b8a717466beb2346f480c", "html_url": "https://github.com/rust-lang/rust/commit/77097c5da87338e4964b8a717466beb2346f480c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/77097c5da87338e4964b8a717466beb2346f480c/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97f3ecda016ca7ab3edf64e11901466f879d4483", "url": "https://api.github.com/repos/rust-lang/rust/commits/97f3ecda016ca7ab3edf64e11901466f879d4483", "html_url": "https://github.com/rust-lang/rust/commit/97f3ecda016ca7ab3edf64e11901466f879d4483"}], "stats": {"total": 38, "additions": 31, "deletions": 7}, "files": [{"sha": "b6b502f4cf0cbefa998eac2b7cb17d0b88d8f42d", "filename": "src/stage0.json", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/77097c5da87338e4964b8a717466beb2346f480c/src%2Fstage0.json", "raw_url": "https://github.com/rust-lang/rust/raw/77097c5da87338e4964b8a717466beb2346f480c/src%2Fstage0.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstage0.json?ref=77097c5da87338e4964b8a717466beb2346f480c", "patch": "@@ -1,11 +1,20 @@\n {\n-  \"__comment\": \"Generated by `./x.py run src/tools/bump-stage0`. Run that command again to update the bootstrap compiler.\",\n   \"config\": {\n     \"dist_server\": \"https://static.rust-lang.org\",\n     \"artifacts_server\": \"https://ci-artifacts.rust-lang.org/rustc-builds\",\n     \"artifacts_with_llvm_assertions_server\": \"https://ci-artifacts.rust-lang.org/rustc-builds-alt\",\n     \"git_merge_commit_email\": \"bors@rust-lang.org\"\n   },\n+  \"__comments\": [\n+    \"The configuration above this comment is editable, and can be changed\",\n+    \"by forks of the repository if they have alternate values.\",\n+    \"\",\n+    \"The section below is generated by `./x.py run src/tools/bump-stage0`,\",\n+    \"run that command again to update the bootstrap compiler.\",\n+    \"\",\n+    \"All changes below this comment will be overridden the next time the\",\n+    \"tool is executed.\"\n+  ],\n   \"compiler\": {\n     \"date\": \"2022-05-20\",\n     \"version\": \"beta\""}, {"sha": "7c6e4bb4fb5be92e1a4bdac241d2c4c74f5eec77", "filename": "src/tools/bump-stage0/src/main.rs", "status": "modified", "additions": 21, "deletions": 6, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/77097c5da87338e4964b8a717466beb2346f480c/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/77097c5da87338e4964b8a717466beb2346f480c/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs?ref=77097c5da87338e4964b8a717466beb2346f480c", "patch": "@@ -10,6 +10,8 @@ const RUSTFMT_COMPONENTS: &[&str] = &[\"rustfmt-preview\"];\n \n struct Tool {\n     config: Config,\n+    comments: Vec<String>,\n+\n     channel: Channel,\n     version: [u16; 3],\n     checksums: IndexMap<String, String>,\n@@ -35,7 +37,13 @@ impl Tool {\n \n         let existing: Stage0 = serde_json::from_slice(&std::fs::read(PATH)?)?;\n \n-        Ok(Self { channel, version, config: existing.config, checksums: IndexMap::new() })\n+        Ok(Self {\n+            channel,\n+            version,\n+            config: existing.config,\n+            comments: existing.comments,\n+            checksums: IndexMap::new(),\n+        })\n     }\n \n     fn update_json(mut self) -> Result<(), Error> {\n@@ -44,9 +52,6 @@ impl Tool {\n             format!(\n                 \"{}\\n\",\n                 serde_json::to_string_pretty(&Stage0 {\n-                    comment: \"Generated by `./x.py run src/tools/bump-stage0`. \\\n-                              Run that command again to update the bootstrap compiler.\"\n-                        .into(),\n                     compiler: self.detect_compiler()?,\n                     rustfmt: self.detect_rustfmt()?,\n                     checksums_sha256: {\n@@ -56,6 +61,7 @@ impl Tool {\n                         self.checksums\n                     },\n                     config: self.config,\n+                    comments: self.comments,\n                 })?\n             ),\n         )?;\n@@ -172,9 +178,18 @@ enum Channel {\n \n #[derive(Debug, serde::Serialize, serde::Deserialize)]\n struct Stage0 {\n-    #[serde(rename = \"__comment\")]\n-    comment: String,\n     config: Config,\n+    // Comments are explicitly below the config, do not move them above.\n+    //\n+    // Downstream forks of the compiler codebase can change the configuration values defined above,\n+    // but doing so would risk merge conflicts whenever they import new changes that include a\n+    // bootstrap compiler bump.\n+    //\n+    // To lessen the pain, a big block of comments is placed between the configuration and the\n+    // auto-generated parts of the file, preventing git diffs of the config to include parts of the\n+    // auto-egenrated content and vice versa. This should prevent merge conflicts.\n+    #[serde(rename = \"__comments\")]\n+    comments: Vec<String>,\n     compiler: Stage0Toolchain,\n     rustfmt: Option<Stage0Toolchain>,\n     checksums_sha256: IndexMap<String, String>,"}]}