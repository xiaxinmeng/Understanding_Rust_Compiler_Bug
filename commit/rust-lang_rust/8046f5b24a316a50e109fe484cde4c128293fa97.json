{"sha": "8046f5b24a316a50e109fe484cde4c128293fa97", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwNDZmNWIyNGEzMTZhNTBlMTA5ZmU0ODRjZGU0YzEyODI5M2ZhOTc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-10-30T07:40:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-30T07:40:23Z"}, "message": "Merge #2125\n\n2125: don't add macro braces in use items r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "296c398809c7905147ae1a55747462682347aac6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/296c398809c7905147ae1a55747462682347aac6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8046f5b24a316a50e109fe484cde4c128293fa97", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJduT5nCRBK7hj4Ov3rIwAAdHIIACVXslbAATSI7Vn9tkSelNVW\nctOjvr00rKbo3xYZwkoEJhtKKGsE47qW7CeHl8PWe/NFsTSpc7u8ncn3k85tQzIx\npsitvbS5s5LaGDhKlN4vRRyx0AhMDZOjFbfj8ykV3UKs3UqJ7BOhejQ4/MX2IReC\nNYNNLqMAiqxzPn6QKFZwbPSXHRiTqRGfqqtvpbOmkcCZFolx0JVhRYH75FUV2jQi\nPfPXHihFBnIjDRP+gHlF60EzvRlYBjI91dLDbel2KO3z8qDlDPcYkS0EB0FmfYgX\nIQptO/fG9DW090rv3JROZZLvw8JmT9Bt5REvYOco8pJQ52YmVY3zYdYdqyXr/Tw=\n=OBdP\n-----END PGP SIGNATURE-----\n", "payload": "tree 296c398809c7905147ae1a55747462682347aac6\nparent 00bc907969117541c10fb7b16be45f0b9f7984ae\nparent d7a7da8261795e15aef77ad306ada00c853fb913\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1572421223 +0000\ncommitter GitHub <noreply@github.com> 1572421223 +0000\n\nMerge #2125\n\n2125: don't add macro braces in use items r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8046f5b24a316a50e109fe484cde4c128293fa97", "html_url": "https://github.com/rust-lang/rust/commit/8046f5b24a316a50e109fe484cde4c128293fa97", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8046f5b24a316a50e109fe484cde4c128293fa97/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "00bc907969117541c10fb7b16be45f0b9f7984ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/00bc907969117541c10fb7b16be45f0b9f7984ae", "html_url": "https://github.com/rust-lang/rust/commit/00bc907969117541c10fb7b16be45f0b9f7984ae"}, {"sha": "d7a7da8261795e15aef77ad306ada00c853fb913", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7a7da8261795e15aef77ad306ada00c853fb913", "html_url": "https://github.com/rust-lang/rust/commit/d7a7da8261795e15aef77ad306ada00c853fb913"}], "stats": {"total": 70, "additions": 53, "deletions": 17}, "files": [{"sha": "f7e98e6df2dec61f60eb51f079e68ead31cfc45b", "filename": "crates/ra_ide_api/src/completion/presentation.rs", "status": "modified", "additions": 53, "deletions": 17, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/8046f5b24a316a50e109fe484cde4c128293fa97/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8046f5b24a316a50e109fe484cde4c128293fa97/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs?ref=8046f5b24a316a50e109fe484cde4c128293fa97", "patch": "@@ -164,27 +164,32 @@ impl Completions {\n         name: Option<String>,\n         macro_: hir::MacroDef,\n     ) {\n+        let name = match name {\n+            Some(it) => it,\n+            None => return,\n+        };\n+\n         let ast_node = macro_.source(ctx.db).ast;\n-        if let Some(name) = name {\n-            let detail = macro_label(&ast_node);\n+        let detail = macro_label(&ast_node);\n+\n+        let docs = macro_.docs(ctx.db);\n+        let macro_declaration = format!(\"{}!\", name);\n+\n+        let mut builder =\n+            CompletionItem::new(CompletionKind::Reference, ctx.source_range(), &macro_declaration)\n+                .kind(CompletionItemKind::Macro)\n+                .set_documentation(docs.clone())\n+                .detail(detail);\n \n-            let docs = macro_.docs(ctx.db);\n+        builder = if ctx.use_item_syntax.is_some() {\n+            builder.insert_text(name)\n+        } else {\n             let macro_braces_to_insert =\n                 self.guess_macro_braces(&name, docs.as_ref().map_or(\"\", |s| s.as_str()));\n-            let macro_declaration = name + \"!\";\n-\n-            let builder = CompletionItem::new(\n-                CompletionKind::Reference,\n-                ctx.source_range(),\n-                &macro_declaration,\n-            )\n-            .kind(CompletionItemKind::Macro)\n-            .set_documentation(docs)\n-            .detail(detail)\n-            .insert_snippet(macro_declaration + macro_braces_to_insert);\n+            builder.insert_snippet(macro_declaration + macro_braces_to_insert)\n+        };\n \n-            self.add(builder);\n-        }\n+        self.add(builder);\n     }\n \n     fn add_function_with_name(\n@@ -281,10 +286,11 @@ fn has_non_default_type_params(def: hir::GenericDef, db: &db::RootDatabase) -> b\n \n #[cfg(test)]\n mod tests {\n-    use crate::completion::{do_completion, CompletionItem, CompletionKind};\n     use insta::assert_debug_snapshot;\n     use test_utils::covers;\n \n+    use crate::completion::{do_completion, CompletionItem, CompletionKind};\n+\n     fn do_reference_completion(code: &str) -> Vec<CompletionItem> {\n         do_completion(code, CompletionKind::Reference)\n     }\n@@ -576,4 +582,34 @@ mod tests {\n         \"###\n         );\n     }\n+\n+    #[test]\n+    fn dont_insert_macro_call_braces_in_use() {\n+        assert_debug_snapshot!(\n+            do_reference_completion(\n+                r\"\n+                //- /main.rs\n+                use foo::<|>;\n+\n+                //- /foo/lib.rs\n+                #[macro_export]\n+                macro_rules frobnicate {\n+                    () => ()\n+                }\n+                \"\n+            ),\n+            @r###\"\n+        [\n+            CompletionItem {\n+                label: \"frobnicate!\",\n+                source_range: [9; 9),\n+                delete: [9; 9),\n+                insert: \"frobnicate\",\n+                kind: Macro,\n+                detail: \"#[macro_export]\\nmacro_rules! frobnicate\",\n+            },\n+        ]\n+        \"###\n+        )\n+    }\n }"}]}