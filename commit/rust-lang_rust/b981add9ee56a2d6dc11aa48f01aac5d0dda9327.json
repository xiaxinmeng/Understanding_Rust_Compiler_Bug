{"sha": "b981add9ee56a2d6dc11aa48f01aac5d0dda9327", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5ODFhZGQ5ZWU1NmEyZDZkYzExYWE0OGYwMWFhYzVkMGRkYTkzMjc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-06-02T05:01:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-06-02T05:01:36Z"}, "message": "auto merge of #14569 : skade/rust/rustdoc-robust-langstring-parsing, r=alexcrichton\n\nThis changes the parsing of the language string\r\nin code examples so that unrecognized examples\r\nare not considered Rust code. This was, for example,\r\nthe case when a code example was marked `sh` for shell\r\ncode.\r\n\r\nThis relieves authors of having to mark those samples\r\nas `notrust`.\r\n\r\nAlso adds recognition of the positive marker `rust`.\r\n\r\nBy default, unmarked examples are still considered rust.", "tree": {"sha": "4f8a29d4d85894500c04aa540bd0d8b85f99d04b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4f8a29d4d85894500c04aa540bd0d8b85f99d04b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b981add9ee56a2d6dc11aa48f01aac5d0dda9327", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b981add9ee56a2d6dc11aa48f01aac5d0dda9327", "html_url": "https://github.com/rust-lang/rust/commit/b981add9ee56a2d6dc11aa48f01aac5d0dda9327", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b981add9ee56a2d6dc11aa48f01aac5d0dda9327/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2be0c5b5f59fd6bcd3f003632d26b1cd204e5cd0", "url": "https://api.github.com/repos/rust-lang/rust/commits/2be0c5b5f59fd6bcd3f003632d26b1cd204e5cd0", "html_url": "https://github.com/rust-lang/rust/commit/2be0c5b5f59fd6bcd3f003632d26b1cd204e5cd0"}, {"sha": "3fef7a74ca9a642f51cdf8ec4f148916580b34ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/3fef7a74ca9a642f51cdf8ec4f148916580b34ce", "html_url": "https://github.com/rust-lang/rust/commit/3fef7a74ca9a642f51cdf8ec4f148916580b34ce"}], "stats": {"total": 53, "additions": 49, "deletions": 4}, "files": [{"sha": "48393db3b7d86e45f9671fe903268e533b22ce79", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 49, "deletions": 4, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/b981add9ee56a2d6dc11aa48f01aac5d0dda9327/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b981add9ee56a2d6dc11aa48f01aac5d0dda9327/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=b981add9ee56a2d6dc11aa48f01aac5d0dda9327", "patch": "@@ -287,10 +287,7 @@ pub fn find_testable_code(doc: &str, tests: &mut ::test::Collector) {\n                 slice::raw::buf_as_slice((*lang).data,\n                                        (*lang).size as uint, |lang| {\n                     let s = str::from_utf8(lang).unwrap();\n-                    (s.contains(\"should_fail\"),\n-                     s.contains(\"no_run\"),\n-                     s.contains(\"ignore\"),\n-                     s.contains(\"notrust\"))\n+                    parse_lang_string(s)\n                 })\n             };\n             if notrust { return }\n@@ -340,6 +337,35 @@ pub fn find_testable_code(doc: &str, tests: &mut ::test::Collector) {\n     }\n }\n \n+fn parse_lang_string(string: &str) -> (bool,bool,bool,bool) {\n+    let mut seen_rust_tags = false;\n+    let mut seen_other_tags = false;\n+    let mut should_fail = false;\n+    let mut no_run = false;\n+    let mut ignore = false;\n+    let mut notrust = false;\n+\n+    let mut tokens = string.as_slice().split(|c: char|\n+      !(c == '_' || c == '-' || c.is_alphanumeric())\n+    );\n+\n+    for token in tokens {\n+        match token {\n+            \"\" => {},\n+            \"should_fail\" => { should_fail = true; seen_rust_tags = true; },\n+            \"no_run\" => { no_run = true; seen_rust_tags = true; },\n+            \"ignore\" => { ignore = true; seen_rust_tags = true; },\n+            \"notrust\" => { notrust = true; seen_rust_tags = true; },\n+            \"rust\" => { notrust = false; seen_rust_tags = true; },\n+            _ => { seen_other_tags = true }\n+        }\n+    }\n+\n+    let notrust = notrust || (seen_other_tags && !seen_rust_tags);\n+\n+    (should_fail, no_run, ignore, notrust)\n+}\n+\n /// By default this markdown renderer generates anchors for each header in the\n /// rendered document. The anchor name is the contents of the header spearated\n /// by hyphens, and a task-local map is used to disambiguate among duplicate\n@@ -367,3 +393,22 @@ impl<'a> fmt::Show for MarkdownWithToc<'a> {\n         render(fmt, md.as_slice(), true)\n     }\n }\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::parse_lang_string;\n+\n+    #[test]\n+    fn test_parse_lang_string() {\n+        assert_eq!(parse_lang_string(\"\"), (false,false,false,false))\n+        assert_eq!(parse_lang_string(\"rust\"), (false,false,false,false))\n+        assert_eq!(parse_lang_string(\"sh\"), (false,false,false,true))\n+        assert_eq!(parse_lang_string(\"notrust\"), (false,false,false,true))\n+        assert_eq!(parse_lang_string(\"ignore\"), (false,false,true,false))\n+        assert_eq!(parse_lang_string(\"should_fail\"), (true,false,false,false))\n+        assert_eq!(parse_lang_string(\"no_run\"), (false,true,false,false))\n+        assert_eq!(parse_lang_string(\"{.no_run .example}\"), (false,true,false,false))\n+        assert_eq!(parse_lang_string(\"{.sh .should_fail}\"), (true,false,false,false))\n+        assert_eq!(parse_lang_string(\"{.example .rust}\"), (false,false,false,false))\n+    }\n+}\n\\ No newline at end of file"}]}