{"sha": "fbcd751ea15e96c293f83655be31e64a5751fa36", "node_id": "C_kwDOAAsO6NoAKGZiY2Q3NTFlYTE1ZTk2YzI5M2Y4MzY1NWJlMzFlNjRhNTc1MWZhMzY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-16T14:39:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-16T14:39:45Z"}, "message": "Rollup merge of #104137 - StackDoubleFlow:err-lsc-unsupported, r=bjorn3\n\nIssue error when -C link-self-contained option is used on unsupported platforms\n\nThe documentation was also updated to reflect this.\n\nI'm assuming the supported platforms are the same as initially written in [RELEASES.md](https://github.com/rust-lang/rust/blob/master/RELEASES.md#compiler-17).\n\nFixes #103576", "tree": {"sha": "6e993402123b9e222c4be4fa8b9666d8448abc6b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6e993402123b9e222c4be4fa8b9666d8448abc6b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fbcd751ea15e96c293f83655be31e64a5751fa36", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjdPYxCRBK7hj4Ov3rIwAAtrYIAEd8ZVs9EiNQMZrgEC/p3edJ\nzZb2dBJ4440ML6/GJN0vTg1jRNV1nch8XsJ0oVn2uqdqjDi88JA/KlybzqcT1ChW\nvd7QDPIN39/RQ4CYKOZAHGrnvTMsY8GoYuyO447Noj9CmplufxEDo/+8sf8Kn9Qa\nL54mtpPzaTzxlLVUIzIPp+kHWFcrRFmvm5hnbZQtobXJ/YMJ27NIEIXtEAvu97mz\nk7Mn6SbTpSuX40xu/GhF5bNkImL+IaRq61jNOGfd4Rr+3Jc30O/P28cfZoblK/C1\nRprGcmSZYrnc1M/Na5xiRyi40i6wRsh/Oib3ruoVjL2BMugv5OIZSuFU1tEHZWg=\n=cFpg\n-----END PGP SIGNATURE-----\n", "payload": "tree 6e993402123b9e222c4be4fa8b9666d8448abc6b\nparent 56a28a65f54b846abc93945a58a5e3b93b109dc6\nparent 0b6dce43096aff3eb8a3e0e43442441185129025\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1668609585 +0100\ncommitter GitHub <noreply@github.com> 1668609585 +0100\n\nRollup merge of #104137 - StackDoubleFlow:err-lsc-unsupported, r=bjorn3\n\nIssue error when -C link-self-contained option is used on unsupported platforms\n\nThe documentation was also updated to reflect this.\n\nI'm assuming the supported platforms are the same as initially written in [RELEASES.md](https://github.com/rust-lang/rust/blob/master/RELEASES.md#compiler-17).\n\nFixes #103576\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fbcd751ea15e96c293f83655be31e64a5751fa36", "html_url": "https://github.com/rust-lang/rust/commit/fbcd751ea15e96c293f83655be31e64a5751fa36", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fbcd751ea15e96c293f83655be31e64a5751fa36/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "56a28a65f54b846abc93945a58a5e3b93b109dc6", "url": "https://api.github.com/repos/rust-lang/rust/commits/56a28a65f54b846abc93945a58a5e3b93b109dc6", "html_url": "https://github.com/rust-lang/rust/commit/56a28a65f54b846abc93945a58a5e3b93b109dc6"}, {"sha": "0b6dce43096aff3eb8a3e0e43442441185129025", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b6dce43096aff3eb8a3e0e43442441185129025", "html_url": "https://github.com/rust-lang/rust/commit/0b6dce43096aff3eb8a3e0e43442441185129025"}], "stats": {"total": 23, "additions": 16, "deletions": 7}, "files": [{"sha": "2091730af22672758311fb41df19fb3be433e499", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=fbcd751ea15e96c293f83655be31e64a5751fa36", "patch": "@@ -1588,6 +1588,9 @@ fn detect_self_contained_mingw(sess: &Session) -> bool {\n /// We only provide such support for a very limited number of targets.\n fn self_contained(sess: &Session, crate_type: CrateType) -> bool {\n     if let Some(self_contained) = sess.opts.cg.link_self_contained {\n+        if sess.target.link_self_contained == LinkSelfContainedDefault::False {\n+            sess.emit_err(errors::UnsupportedLinkSelfContained);\n+        }\n         return self_contained;\n     }\n "}, {"sha": "ade50af0aee8d7dabcc31b835100c55db03f2418", "filename": "compiler/rustc_codegen_ssa/src/errors.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_codegen_ssa%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_codegen_ssa%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ferrors.rs?ref=fbcd751ea15e96c293f83655be31e64a5751fa36", "patch": "@@ -530,3 +530,7 @@ pub enum AppleSdkRootError<'a> {\n pub struct ReadFileError {\n     pub message: std::io::Error,\n }\n+\n+#[derive(Diagnostic)]\n+#[diag(codegen_ssa_unsupported_link_self_contained)]\n+pub struct UnsupportedLinkSelfContained;"}, {"sha": "70ce559526c3619dbbd9fd8592610f699c8e07db", "filename": "compiler/rustc_error_messages/locales/en-US/codegen_ssa.ftl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl?ref=fbcd751ea15e96c293f83655be31e64a5751fa36", "patch": "@@ -184,3 +184,5 @@ codegen_ssa_unsupported_arch = unsupported arch `{$arch}` for os `{$os}`\n codegen_ssa_apple_sdk_error_sdk_path = failed to get {$sdk_name} SDK path: {error}\n \n codegen_ssa_read_file = failed to read file: {message}\n+\n+codegen_ssa_unsupported_link_self_contained = option `-C link-self-contained` is not supported on this target"}, {"sha": "6f0bbf0672d449d555a32beae5bad63e1b0bfe96", "filename": "compiler/rustc_target/src/spec/wasm32_wasi.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm32_wasi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm32_wasi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm32_wasi.rs?ref=fbcd751ea15e96c293f83655be31e64a5751fa36", "patch": "@@ -72,7 +72,8 @@\n //! best we can with this target. Don't start relying on too much here unless\n //! you know what you're getting in to!\n \n-use super::{crt_objects, wasm_base, Cc, LinkerFlavor, Target};\n+use super::crt_objects::{self, LinkSelfContainedDefault};\n+use super::{wasm_base, Cc, LinkerFlavor, Target};\n \n pub fn target() -> Target {\n     let mut options = wasm_base::options();\n@@ -83,6 +84,9 @@ pub fn target() -> Target {\n     options.pre_link_objects_self_contained = crt_objects::pre_wasi_self_contained();\n     options.post_link_objects_self_contained = crt_objects::post_wasi_self_contained();\n \n+    // FIXME: Figure out cases in which WASM needs to link with a native toolchain.\n+    options.link_self_contained = LinkSelfContainedDefault::True;\n+\n     // Right now this is a bit of a workaround but we're currently saying that\n     // the target by default has a static crt which we're taking as a signal\n     // for \"use the bundled crt\". If that's turned off then the system's crt"}, {"sha": "625d3b37c4f2682d67ffd785ecc8b2a9a63f5a0b", "filename": "compiler/rustc_target/src/spec/wasm_base.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbcd751ea15e96c293f83655be31e64a5751fa36/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs?ref=fbcd751ea15e96c293f83655be31e64a5751fa36", "patch": "@@ -1,4 +1,3 @@\n-use super::crt_objects::LinkSelfContainedDefault;\n use super::{cvs, Cc, LinkerFlavor, PanicStrategy, RelocModel, TargetOptions, TlsModel};\n \n pub fn options() -> TargetOptions {\n@@ -95,9 +94,6 @@ pub fn options() -> TargetOptions {\n \n         pre_link_args,\n \n-        // FIXME: Figure out cases in which WASM needs to link with a native toolchain.\n-        link_self_contained: LinkSelfContainedDefault::True,\n-\n         // This has no effect in LLVM 8 or prior, but in LLVM 9 and later when\n         // PIC code is implemented this has quite a drastic effect if it stays\n         // at the default, `pic`. In an effort to keep wasm binaries as minimal"}, {"sha": "7e355b7fccfc4485a5f11e11d10165ce8148f607", "filename": "src/doc/rustc/src/codegen-options/index.md", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fbcd751ea15e96c293f83655be31e64a5751fa36/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md", "raw_url": "https://github.com/rust-lang/rust/raw/fbcd751ea15e96c293f83655be31e64a5751fa36/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md?ref=fbcd751ea15e96c293f83655be31e64a5751fa36", "patch": "@@ -210,8 +210,8 @@ metrics.\n \n ## link-self-contained\n \n-On targets that support it this flag controls whether the linker will use libraries and objects\n-shipped with Rust instead or those in the system.\n+On `windows-gnu`, `linux-musl`, and `wasi` targets, this flag controls whether the\n+linker will use libraries and objects shipped with Rust instead or those in the system.\n It takes one of the following values:\n \n * no value: rustc will use heuristic to disable self-contained mode if system has necessary tools."}]}