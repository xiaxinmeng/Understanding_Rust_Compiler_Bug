{"sha": "a5136f14aee8447820a81141631cd6e5919631a5", "node_id": "C_kwDOAAsO6NoAKGE1MTM2ZjE0YWVlODQ0NzgyMGE4MTE0MTYzMWNkNmU1OTE5NjMxYTU", "commit": {"author": {"name": "fee1-dead", "email": "ent3rm4n@gmail.com", "date": "2023-04-16T10:55:38Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-16T10:55:38Z"}, "message": "Rollup merge of #109665 - fee1-dead-contrib:rm-remap-queries, r=oli-obk\n\nRemove `remap_env_constness` in queries\n\nThis removes some of the complexities with const traits. #88119 used to be caused by this but was fixed by `param_env = param_env.without_const()`.", "tree": {"sha": "59a0bf8048792ae3d9d4409ac99f7430b6d74d64", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59a0bf8048792ae3d9d4409ac99f7430b6d74d64"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a5136f14aee8447820a81141631cd6e5919631a5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkO9QqCRBK7hj4Ov3rIwAAKlcIAAc9N+TfDjw7CEs5adqDhsXP\npkLcu+JijGmWvLejM2uwfo8htkk9ZYK1cmDXEWjYw42o1r8y98MXCb0Z33CTsBUj\ntFcIlG2/s/MXrlCMRSag3ETLI4rkhrFFJQrcgvWh7m+fMr8uCpu9XfwN7fSfqqvi\nY/Wew0JOpyaqibYri/tbfdHSt3NpuS0K3GJftR6T7xkJ2hdCfI8G71id/Rm906Qj\nQYg34Ln2fHEeJD2f4c1NdHUcfUCxPNBu6Ty3z1hQ14LnkgTN5y2+6a06/iBzSlI8\nKCAj8k6IupjtWu/DifIHv7GsgU1fJSsB0Xh07jV2HKIlfDP4lX5IuVFl4H7tyys=\n=xrGs\n-----END PGP SIGNATURE-----\n", "payload": "tree 59a0bf8048792ae3d9d4409ac99f7430b6d74d64\nparent e6e956dade79bdc084dfe3078abab24656a1b483\nparent 886c0e638806a2541b08ffb1efb88366376aac4b\nauthor fee1-dead <ent3rm4n@gmail.com> 1681642538 +0800\ncommitter GitHub <noreply@github.com> 1681642538 +0800\n\nRollup merge of #109665 - fee1-dead-contrib:rm-remap-queries, r=oli-obk\n\nRemove `remap_env_constness` in queries\n\nThis removes some of the complexities with const traits. #88119 used to be caused by this but was fixed by `param_env = param_env.without_const()`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a5136f14aee8447820a81141631cd6e5919631a5", "html_url": "https://github.com/rust-lang/rust/commit/a5136f14aee8447820a81141631cd6e5919631a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a5136f14aee8447820a81141631cd6e5919631a5/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e6e956dade79bdc084dfe3078abab24656a1b483", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6e956dade79bdc084dfe3078abab24656a1b483", "html_url": "https://github.com/rust-lang/rust/commit/e6e956dade79bdc084dfe3078abab24656a1b483"}, {"sha": "886c0e638806a2541b08ffb1efb88366376aac4b", "url": "https://api.github.com/repos/rust-lang/rust/commits/886c0e638806a2541b08ffb1efb88366376aac4b", "html_url": "https://github.com/rust-lang/rust/commit/886c0e638806a2541b08ffb1efb88366376aac4b"}], "stats": {"total": 93, "additions": 25, "deletions": 68}, "files": [{"sha": "a8b25ff66d7881c1020449cd94b442366d1339dc", "filename": "compiler/rustc_macros/src/query.rs", "status": "modified", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_macros%2Fsrc%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_macros%2Fsrc%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fquery.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -112,9 +112,6 @@ struct QueryModifiers {\n     /// Use a separate query provider for local and extern crates\n     separate_provide_extern: Option<Ident>,\n \n-    /// Always remap the ParamEnv's constness before hashing.\n-    remap_env_constness: Option<Ident>,\n-\n     /// Generate a `feed` method to set the query's value from another query.\n     feedable: Option<Ident>,\n }\n@@ -130,7 +127,6 @@ fn parse_query_modifiers(input: ParseStream<'_>) -> Result<QueryModifiers> {\n     let mut eval_always = None;\n     let mut depth_limit = None;\n     let mut separate_provide_extern = None;\n-    let mut remap_env_constness = None;\n     let mut feedable = None;\n \n     while !input.is_empty() {\n@@ -189,8 +185,6 @@ fn parse_query_modifiers(input: ParseStream<'_>) -> Result<QueryModifiers> {\n             try_insert!(depth_limit = modifier);\n         } else if modifier == \"separate_provide_extern\" {\n             try_insert!(separate_provide_extern = modifier);\n-        } else if modifier == \"remap_env_constness\" {\n-            try_insert!(remap_env_constness = modifier);\n         } else if modifier == \"feedable\" {\n             try_insert!(feedable = modifier);\n         } else {\n@@ -211,7 +205,6 @@ fn parse_query_modifiers(input: ParseStream<'_>) -> Result<QueryModifiers> {\n         eval_always,\n         depth_limit,\n         separate_provide_extern,\n-        remap_env_constness,\n         feedable,\n     })\n }\n@@ -332,7 +325,6 @@ pub fn rustc_queries(input: TokenStream) -> TokenStream {\n             eval_always,\n             depth_limit,\n             separate_provide_extern,\n-            remap_env_constness,\n         );\n \n         if modifiers.cache.is_some() {"}, {"sha": "e63121475a15129f1d93c5f4ef208595d3dee3dc", "filename": "compiler/rustc_middle/src/infer/canonical.rs", "status": "modified", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Finfer%2Fcanonical.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Finfer%2Fcanonical.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Finfer%2Fcanonical.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -348,14 +348,6 @@ impl<'tcx, R> Canonical<'tcx, QueryResponse<'tcx, R>> {\n     }\n }\n \n-impl<'tcx, R> Canonical<'tcx, ty::ParamEnvAnd<'tcx, R>> {\n-    #[inline]\n-    pub fn without_const(mut self) -> Self {\n-        self.value = self.value.without_const();\n-        self\n-    }\n-}\n-\n impl<'tcx, V> Canonical<'tcx, V> {\n     /// Allows you to map the `value` of a canonical while keeping the\n     /// same set of bound variables."}, {"sha": "6fc9190b0905da439895ef767cd27cbb586c9235", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -1094,7 +1094,6 @@ rustc_queries! {\n         key: ty::ParamEnvAnd<'tcx, mir::ConstantKind<'tcx>>\n     ) -> Option<mir::DestructuredConstant<'tcx>> {\n         desc { \"destructuring MIR constant\"}\n-        remap_env_constness\n     }\n \n     /// Dereference a constant reference or raw pointer and turn the result into a constant\n@@ -1103,7 +1102,6 @@ rustc_queries! {\n         key: ty::ParamEnvAnd<'tcx, mir::ConstantKind<'tcx>>\n     ) -> mir::ConstantKind<'tcx> {\n         desc { \"dereferencing MIR constant\" }\n-        remap_env_constness\n     }\n \n     query const_caller_location(key: (rustc_span::Symbol, u32, u32)) -> ConstValue<'tcx> {\n@@ -1346,32 +1344,26 @@ rustc_queries! {\n     /// `ty.is_copy()`, etc, since that will prune the environment where possible.\n     query is_copy_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n         desc { \"computing whether `{}` is `Copy`\", env.value }\n-        remap_env_constness\n     }\n     /// Query backing `Ty::is_sized`.\n     query is_sized_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n         desc { \"computing whether `{}` is `Sized`\", env.value }\n-        remap_env_constness\n     }\n     /// Query backing `Ty::is_freeze`.\n     query is_freeze_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n         desc { \"computing whether `{}` is freeze\", env.value }\n-        remap_env_constness\n     }\n     /// Query backing `Ty::is_unpin`.\n     query is_unpin_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n         desc { \"computing whether `{}` is `Unpin`\", env.value }\n-        remap_env_constness\n     }\n     /// Query backing `Ty::needs_drop`.\n     query needs_drop_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n         desc { \"computing whether `{}` needs drop\", env.value }\n-        remap_env_constness\n     }\n     /// Query backing `Ty::has_significant_drop_raw`.\n     query has_significant_drop_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n         desc { \"computing whether `{}` has a significant drop\", env.value }\n-        remap_env_constness\n     }\n \n     /// Query backing `Ty::is_structural_eq_shallow`.\n@@ -1411,7 +1403,6 @@ rustc_queries! {\n     ) -> Result<ty::layout::TyAndLayout<'tcx>, ty::layout::LayoutError<'tcx>> {\n         depth_limit\n         desc { \"computing layout of `{}`\", key.value }\n-        remap_env_constness\n     }\n \n     /// Compute a `FnAbi` suitable for indirect calls, i.e. to `fn` pointers.\n@@ -1422,7 +1413,6 @@ rustc_queries! {\n         key: ty::ParamEnvAnd<'tcx, (ty::PolyFnSig<'tcx>, &'tcx ty::List<Ty<'tcx>>)>\n     ) -> Result<&'tcx abi::call::FnAbi<'tcx, Ty<'tcx>>, ty::layout::FnAbiError<'tcx>> {\n         desc { \"computing call ABI of `{}` function pointers\", key.value.0 }\n-        remap_env_constness\n     }\n \n     /// Compute a `FnAbi` suitable for declaring/defining an `fn` instance, and for\n@@ -1434,7 +1424,6 @@ rustc_queries! {\n         key: ty::ParamEnvAnd<'tcx, (ty::Instance<'tcx>, &'tcx ty::List<Ty<'tcx>>)>\n     ) -> Result<&'tcx abi::call::FnAbi<'tcx, Ty<'tcx>>, ty::layout::FnAbiError<'tcx>> {\n         desc { \"computing call ABI of `{}`\", key.value.0 }\n-        remap_env_constness\n     }\n \n     query dylib_dependency_formats(_: CrateNum)\n@@ -1937,15 +1926,13 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"normalizing `{}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: invoke `try_normalize_erasing_regions` instead.\n     query try_normalize_generic_arg_after_erasing_regions(\n         goal: ParamEnvAnd<'tcx, GenericArg<'tcx>>\n     ) -> Result<GenericArg<'tcx>, NoSolution> {\n         desc { \"normalizing `{}`\", goal.value }\n-        remap_env_constness\n     }\n \n     query implied_outlives_bounds(\n@@ -1955,7 +1942,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"computing implied outlives bounds for `{}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly:\n@@ -1967,7 +1953,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"computing dropck types for `{}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: invoke `infcx.predicate_may_hold()` or\n@@ -1995,7 +1980,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"evaluating `type_op_ascribe_user_type` `{:?}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: part of the `Eq` type-op\n@@ -2006,7 +1990,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"evaluating `type_op_eq` `{:?}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: part of the `Subtype` type-op\n@@ -2017,7 +2000,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"evaluating `type_op_subtype` `{:?}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: part of the `ProvePredicate` type-op\n@@ -2038,7 +2020,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"normalizing `{}`\", goal.value.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: part of the `Normalize` type-op\n@@ -2049,7 +2030,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"normalizing `{:?}`\", goal.value.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: part of the `Normalize` type-op\n@@ -2060,7 +2040,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"normalizing `{:?}`\", goal.value.value.value }\n-        remap_env_constness\n     }\n \n     /// Do not call this query directly: part of the `Normalize` type-op\n@@ -2071,7 +2050,6 @@ rustc_queries! {\n         NoSolution,\n     > {\n         desc { \"normalizing `{:?}`\", goal.value.value.value }\n-        remap_env_constness\n     }\n \n     query subst_and_check_impossible_predicates(key: (DefId, SubstsRef<'tcx>)) -> bool {\n@@ -2093,7 +2071,6 @@ rustc_queries! {\n         goal: CanonicalTyGoal<'tcx>\n     ) -> MethodAutoderefStepsResult<'tcx> {\n         desc { \"computing autoderef types for `{}`\", goal.value.value }\n-        remap_env_constness\n     }\n \n     query supported_target_features(_: CrateNum) -> &'tcx FxHashMap<String, Option<Symbol>> {\n@@ -2138,7 +2115,6 @@ rustc_queries! {\n         key: ty::ParamEnvAnd<'tcx, (DefId, SubstsRef<'tcx>)>\n     ) -> Result<Option<ty::Instance<'tcx>>, ErrorGuaranteed> {\n         desc { \"resolving instance `{}`\", ty::Instance::new(key.value.0, key.value.1) }\n-        remap_env_constness\n     }\n \n     query resolve_instance_of_const_arg(\n@@ -2148,7 +2124,6 @@ rustc_queries! {\n             \"resolving instance of the const argument `{}`\",\n             ty::Instance::new(key.value.0.to_def_id(), key.value.2),\n         }\n-        remap_env_constness\n     }\n \n     query reveal_opaque_types_in_bounds(key: &'tcx ty::List<ty::Predicate<'tcx>>) -> &'tcx ty::List<ty::Predicate<'tcx>> {"}, {"sha": "bc202b027bd29891efb18bbcc4fbbd9be4b6eba2", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -1850,12 +1850,6 @@ impl<'tcx, T> ParamEnvAnd<'tcx, T> {\n     pub fn into_parts(self) -> (ParamEnv<'tcx>, T) {\n         (self.param_env, self.value)\n     }\n-\n-    #[inline]\n-    pub fn without_const(mut self) -> Self {\n-        self.param_env = self.param_env.without_const();\n-        self\n-    }\n }\n \n #[derive(Copy, Clone, Debug, HashStable, Encodable, Decodable)]"}, {"sha": "97592cbc567d7825f319bbe6066f16a257bd55c1", "filename": "compiler/rustc_middle/src/ty/query.rs", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -202,16 +202,6 @@ macro_rules! separate_provide_extern_default {\n     };\n }\n \n-macro_rules! opt_remap_env_constness {\n-    ([][$name:ident]) => {};\n-    ([(remap_env_constness) $($rest:tt)*][$name:ident]) => {\n-        let $name = $name.without_const();\n-    };\n-    ([$other:tt $($modifiers:tt)*][$name:ident]) => {\n-        opt_remap_env_constness!([$($modifiers)*][$name])\n-    };\n-}\n-\n macro_rules! define_callbacks {\n     (\n      $($(#[$attr:meta])*\n@@ -353,7 +343,6 @@ macro_rules! define_callbacks {\n             #[inline(always)]\n             pub fn $name(self, key: query_helper_param_ty!($($K)*)) {\n                 let key = key.into_query_param();\n-                opt_remap_env_constness!([$($modifiers)*][key]);\n \n                 match try_get_cached(self.tcx, &self.tcx.query_system.caches.$name, &key) {\n                     Some(_) => return,\n@@ -372,7 +361,6 @@ macro_rules! define_callbacks {\n             #[inline(always)]\n             pub fn $name(self, key: query_helper_param_ty!($($K)*)) {\n                 let key = key.into_query_param();\n-                opt_remap_env_constness!([$($modifiers)*][key]);\n \n                 match try_get_cached(self.tcx, &self.tcx.query_system.caches.$name, &key) {\n                     Some(_) => return,\n@@ -402,7 +390,6 @@ macro_rules! define_callbacks {\n             pub fn $name(self, key: query_helper_param_ty!($($K)*)) -> $V\n             {\n                 let key = key.into_query_param();\n-                opt_remap_env_constness!([$($modifiers)*][key]);\n \n                 restore::<$V>(match try_get_cached(self.tcx, &self.tcx.query_system.caches.$name, &key) {\n                     Some(value) => value,\n@@ -492,7 +479,6 @@ macro_rules! define_feedable {\n             #[inline(always)]\n             pub fn $name(self, value: query_provided::$name<'tcx>) -> $V {\n                 let key = self.key().into_query_param();\n-                opt_remap_env_constness!([$($modifiers)*][key]);\n \n                 let tcx = self.tcx;\n                 let erased = query_provided_to_value::$name(tcx, value);"}, {"sha": "baa2fbb6751c3c3419b5440663237f7193af67d2", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/prove_predicate.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -32,14 +32,8 @@ impl<'tcx> super::QueryTypeOp<'tcx> for ProvePredicate<'tcx> {\n \n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n-        mut canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n+        canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n     ) -> Fallible<CanonicalQueryResponse<'tcx, ()>> {\n-        match canonicalized.value.value.predicate.kind().skip_binder() {\n-            ty::PredicateKind::Clause(ty::Clause::Trait(pred)) => {\n-                canonicalized.value.param_env.remap_constness_with(pred.constness);\n-            }\n-            _ => canonicalized.value.param_env = canonicalized.value.param_env.without_const(),\n-        }\n         tcx.type_op_prove_predicate(canonicalized)\n     }\n }"}, {"sha": "19622112f2a28d446c20ef75db87e9f2d1ce040f", "filename": "compiler/rustc_traits/src/type_op.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_traits%2Fsrc%2Ftype_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/compiler%2Frustc_traits%2Fsrc%2Ftype_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Ftype_op.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -89,6 +89,7 @@ fn relate_mir_and_user_substs<'tcx>(\n     def_id: hir::def_id::DefId,\n     user_substs: UserSubsts<'tcx>,\n ) -> Result<(), NoSolution> {\n+    let param_env = param_env.without_const();\n     let UserSubsts { user_self_ty, substs } = user_substs;\n     let tcx = ocx.infcx.tcx;\n     let cause = ObligationCause::dummy_with_span(span);"}, {"sha": "7d7cb967c66199d8fd12c0b280b922d82efddc0f", "filename": "tests/ui/rfc-2632-const-trait-impl/trait-method-ptr-in-consts-ice.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/a5136f14aee8447820a81141631cd6e5919631a5/tests%2Fui%2Frfc-2632-const-trait-impl%2Ftrait-method-ptr-in-consts-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a5136f14aee8447820a81141631cd6e5919631a5/tests%2Fui%2Frfc-2632-const-trait-impl%2Ftrait-method-ptr-in-consts-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfc-2632-const-trait-impl%2Ftrait-method-ptr-in-consts-ice.rs?ref=a5136f14aee8447820a81141631cd6e5919631a5", "patch": "@@ -0,0 +1,23 @@\n+// check-pass\n+\n+struct LazyLock<T> {\n+    data: (Option<T>, fn() -> T),\n+}\n+\n+impl<T> LazyLock<T> {\n+    pub const fn new(f: fn() -> T) -> LazyLock<T> {\n+        LazyLock { data: (None, f) }\n+    }\n+}\n+\n+struct A<T = i32>(Option<T>);\n+\n+impl<T> Default for A<T> {\n+    fn default() -> Self {\n+        A(None)\n+    }\n+}\n+\n+static EMPTY_SET: LazyLock<A<i32>> = LazyLock::new(A::default);\n+\n+fn main() {}"}]}