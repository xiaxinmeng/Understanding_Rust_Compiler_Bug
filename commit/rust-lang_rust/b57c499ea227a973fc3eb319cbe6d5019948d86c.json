{"sha": "b57c499ea227a973fc3eb319cbe6d5019948d86c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1N2M0OTllYTIyN2E5NzNmYzNlYjMxOWNiZTZkNTAxOTk0OGQ4NmM=", "commit": {"author": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2019-07-07T15:44:00Z"}, "committer": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2019-07-09T19:55:29Z"}, "message": "Translate target features for LLVM 9", "tree": {"sha": "b82644311451cd55ad6317843e528a81e8768eb0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b82644311451cd55ad6317843e528a81e8768eb0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b57c499ea227a973fc3eb319cbe6d5019948d86c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b57c499ea227a973fc3eb319cbe6d5019948d86c", "html_url": "https://github.com/rust-lang/rust/commit/b57c499ea227a973fc3eb319cbe6d5019948d86c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b57c499ea227a973fc3eb319cbe6d5019948d86c/comments", "author": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eb338220911fbcf0661e4f8802b23d0bd4e5d077", "url": "https://api.github.com/repos/rust-lang/rust/commits/eb338220911fbcf0661e4f8802b23d0bd4e5d077", "html_url": "https://github.com/rust-lang/rust/commit/eb338220911fbcf0661e4f8802b23d0bd4e5d077"}], "stats": {"total": 24, "additions": 24, "deletions": 0}, "files": [{"sha": "33b50401b22f149ac9f11d8464f949433848e2e2", "filename": "src/librustc_codegen_llvm/attributes.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b57c499ea227a973fc3eb319cbe6d5019948d86c/src%2Flibrustc_codegen_llvm%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b57c499ea227a973fc3eb319cbe6d5019948d86c/src%2Flibrustc_codegen_llvm%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fattributes.rs?ref=b57c499ea227a973fc3eb319cbe6d5019948d86c", "patch": "@@ -119,6 +119,29 @@ pub fn set_probestack(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value) {\n         const_cstr!(\"probe-stack\"), const_cstr!(\"__rust_probestack\"));\n }\n \n+fn translate_obsolete_target_features(feature: &str) -> &str {\n+    const LLVM9_FEATURE_CHANGES: &[(&str, &str)] = &[\n+        (\"+fp-only-sp\", \"-fp64\"),\n+        (\"-fp-only-sp\", \"+fp64\"),\n+        (\"+d16\", \"-d32\"),\n+        (\"-d16\", \"+d32\"),\n+    ];\n+    if llvm_util::get_major_version() >= 9 {\n+        for &(old, new) in LLVM9_FEATURE_CHANGES {\n+            if feature == old {\n+                return new;\n+            }\n+        }\n+    } else {\n+        for &(old, new) in LLVM9_FEATURE_CHANGES {\n+            if feature == new {\n+                return old;\n+            }\n+        }\n+    }\n+    feature\n+}\n+\n pub fn llvm_target_features(sess: &Session) -> impl Iterator<Item = &str> {\n     const RUSTC_SPECIFIC_FEATURES: &[&str] = &[\n         \"crt-static\",\n@@ -129,6 +152,7 @@ pub fn llvm_target_features(sess: &Session) -> impl Iterator<Item = &str> {\n     sess.target.target.options.features.split(',')\n         .chain(cmdline)\n         .filter(|l| !l.is_empty())\n+        .map(translate_obsolete_target_features)\n }\n \n pub fn apply_target_cpu_attr(cx: &CodegenCx<'ll, '_>, llfn: &'ll Value) {"}]}