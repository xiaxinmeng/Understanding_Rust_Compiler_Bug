{"sha": "f14190199cdbcd508e0ac28e8c62c61dea404230", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYxNDE5MDE5OWNkYmNkNTA4ZTBhYzI4ZThjNjJjNjFkZWE0MDQyMzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-02T05:12:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-02T05:12:51Z"}, "message": "Auto merge of #25848 - alexcrichton:fix-msvc, r=brson\n\nNow that MSVC support has landed in the most recent nightlies we can now have\r\nMSVC bootstrap itself without going through a GNU compiler first. Unfortunately,\r\nhowever, the bootstrap currently fails due to the compiler not being able to\r\nfind the llvm-ar.exe tool during the stage0 libcore compile. The compiler cannot\r\nfind this tool because it's looking inside a directory that does not exist:\r\n\r\n    $SYSROOT/rustlib/x86_64-pc-windows-gnu/bin\r\n\r\nThe `gnu` on this triple is because the bootstrap compiler's host architecture\r\nis GNU. The build system, however, only arranges for the llvm-ar.exe tool to be\r\navailable in this location:\r\n\r\n    $SYSROOT/rustlib/x86_64-pc-windows-msvc/bin\r\n\r\nTo resolve this discrepancy, the build system has been modified to understand\r\ntriples that are bootstrapped from another triple, and in this case copy the\r\nnative tools to the right location.", "tree": {"sha": "097748ed50456fb8ca87aea0295cb182655ec241", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/097748ed50456fb8ca87aea0295cb182655ec241"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f14190199cdbcd508e0ac28e8c62c61dea404230", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f14190199cdbcd508e0ac28e8c62c61dea404230", "html_url": "https://github.com/rust-lang/rust/commit/f14190199cdbcd508e0ac28e8c62c61dea404230", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f14190199cdbcd508e0ac28e8c62c61dea404230/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f813f9779722d3670bbfbd0a352b64fe4ae9ddbb", "url": "https://api.github.com/repos/rust-lang/rust/commits/f813f9779722d3670bbfbd0a352b64fe4ae9ddbb", "html_url": "https://github.com/rust-lang/rust/commit/f813f9779722d3670bbfbd0a352b64fe4ae9ddbb"}, {"sha": "b8c59211edfd9223797bfc77b6df480f242496cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8c59211edfd9223797bfc77b6df480f242496cb", "html_url": "https://github.com/rust-lang/rust/commit/b8c59211edfd9223797bfc77b6df480f242496cb"}], "stats": {"total": 44, "additions": 44, "deletions": 0}, "files": [{"sha": "1e1906a298084dce9f7efc0690efb37ace352903", "filename": "mk/cfg/x86_64-pc-windows-msvc.mk", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f14190199cdbcd508e0ac28e8c62c61dea404230/mk%2Fcfg%2Fx86_64-pc-windows-msvc.mk", "raw_url": "https://github.com/rust-lang/rust/raw/f14190199cdbcd508e0ac28e8c62c61dea404230/mk%2Fcfg%2Fx86_64-pc-windows-msvc.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fcfg%2Fx86_64-pc-windows-msvc.mk?ref=f14190199cdbcd508e0ac28e8c62c61dea404230", "patch": "@@ -80,3 +80,8 @@ CUSTOM_DEPS_rustc_llvm_T_x86_64-pc-windows-msvc += \\\n x86_64-pc-windows-msvc/rt/rustc_llvm.def: $(S)src/etc/mklldef.py \\\n \t\t\t$(S)src/librustc_llvm/lib.rs\n \t$(CFG_PYTHON) $^ $@ rustc_llvm-$(CFG_FILENAME_EXTRA)\n+\n+# All windows nightiles are currently a GNU triple, so this MSVC triple is not\n+# bootstrapping from itself. This is relevant during stage0, and other parts of\n+# the build system take this into account.\n+BOOTSTRAP_FROM_x86_64-pc-windows-msvc := x86_64-pc-windows-gnu"}, {"sha": "3c274dc4fd5f2863a4b257ef117ef89d05ffa8b1", "filename": "mk/target.mk", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/f14190199cdbcd508e0ac28e8c62c61dea404230/mk%2Ftarget.mk", "raw_url": "https://github.com/rust-lang/rust/raw/f14190199cdbcd508e0ac28e8c62c61dea404230/mk%2Ftarget.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Ftarget.mk?ref=f14190199cdbcd508e0ac28e8c62c61dea404230", "patch": "@@ -181,3 +181,42 @@ $(foreach host,$(CFG_HOST), \\\n   $(foreach stage,$(STAGES), \\\n    $(foreach tool,$(TOOLS), \\\n     $(eval $(call TARGET_TOOL,$(stage),$(target),$(host),$(tool)))))))\n+\n+# We have some triples which are bootstrapped from other triples, and this means\n+# that we need to fixup some of the native tools that a triple depends on.\n+#\n+# For example, MSVC requires the llvm-ar.exe executable to manage archives, but\n+# it bootstraps from the GNU Windows triple. This means that the compiler will\n+# add this directory to PATH when executing new processes:\n+#\n+# \t$SYSROOT/rustlib/x86_64-pc-windows-gnu/bin\n+#\n+# Unfortunately, however, the GNU triple is not known about in stage0, so the\n+# tools are actually located in:\n+#\n+# \t$SYSROOT/rustlib/x86_64-pc-windows-msvc/bin\n+#\n+# To remedy this problem, the rules below copy all native tool dependencies into\n+# the bootstrap triple's location in stage 0 so the bootstrap compiler can find\n+# the right sets of tools. Later stages (1+) will have the right host triple for\n+# the compiler, so there's no need to worry there.\n+#\n+# $(1) - stage\n+# $(2) - triple that's being used as host/target\n+# $(3) - triple snapshot is built for\n+# $(4) - crate\n+# $(5) - tool\n+define MOVE_TOOLS_TO_SNAPSHOT_HOST_DIR\n+ifneq (,$(3))\n+$$(TLIB$(1)_T_$(2)_H_$(2))/stamp.$(4): $$(HLIB$(1)_H_$(2))/rustlib/$(3)/bin/$(5)\n+\n+$$(HLIB$(1)_H_$(2))/rustlib/$(3)/bin/$(5): $$(TBIN$(1)_T_$(2)_H_$(2))/$(5)\n+\tmkdir -p $$(@D)\n+\tcp $$< $$@\n+endif\n+endef\n+\n+$(foreach target,$(CFG_TARGET), \\\n+ $(foreach crate,$(CRATES), \\\n+  $(foreach tool,$(NATIVE_TOOL_DEPS_$(crate)_T_$(target)), \\\n+   $(eval $(call MOVE_TOOLS_TO_SNAPSHOT_HOST_DIR,0,$(target),$(BOOTSTRAP_FROM_$(target)),$(crate),$(tool))))))"}]}