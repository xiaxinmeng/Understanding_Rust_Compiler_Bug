{"sha": "9328aba70619ef5d1d849e51587567a0ab7aec1d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkzMjhhYmE3MDYxOWVmNWQxZDg0OWU1MTU4NzU2N2EwYWI3YWVjMWQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-22T14:50:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-22T14:50:42Z"}, "message": "Merge #3677\n\n3677: Add support for macro in symbol_index r=kjeremy a=edwin0cheng\n\nThis PR allows macro showing up in `Open symbol` search:\r\n\r\n![show_macro](https://user-images.githubusercontent.com/11014119/77244297-548d0b80-6c4e-11ea-8613-15926cc297b3.png)\r\n\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "94fd49ee8f9a05828396b0d5a7402fac71e990c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/94fd49ee8f9a05828396b0d5a7402fac71e990c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9328aba70619ef5d1d849e51587567a0ab7aec1d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJed3tCCRBK7hj4Ov3rIwAAdHIIAKHSPrhowgifIKQJC7VSRkc1\n443wGkkrYRMuia4qWUlg2O0FQ72bgOMQOWbxfl54RKDGHoGFHBhU9/5wt+R7SNRO\naPQFlHKe7v1cEfunxDBWFk7zMCDxX4WaNDGohJIle1cvbLDp8cqvAXG6dNi1Favj\nxpSc4dplfwwrrt8OCgE7UEOyVFrfOHCoKMMCNYH1sqAkZl4+byqI+OpWwiJhaSMQ\n1cyXi1MG1fdxdQ5H0HNvmIu8HQ1o1H+tYKNDfcQ9AvvAUXlqStq1loe0wC3zBL2D\ncQ6ISbhCd7D0ij1CZooaR67W1U0+VZ53yj34tmSMObaEpRLNQ/jClGExTT0YAIM=\n=KKNy\n-----END PGP SIGNATURE-----\n", "payload": "tree 94fd49ee8f9a05828396b0d5a7402fac71e990c2\nparent 39adefc4a7a7d4de0c8b81d174619110a9399d9b\nparent bb22a4e386c13a17b518a3822d343f6dd3dc4398\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1584888642 +0000\ncommitter GitHub <noreply@github.com> 1584888642 +0000\n\nMerge #3677\n\n3677: Add support for macro in symbol_index r=kjeremy a=edwin0cheng\n\nThis PR allows macro showing up in `Open symbol` search:\r\n\r\n![show_macro](https://user-images.githubusercontent.com/11014119/77244297-548d0b80-6c4e-11ea-8613-15926cc297b3.png)\r\n\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9328aba70619ef5d1d849e51587567a0ab7aec1d", "html_url": "https://github.com/rust-lang/rust/commit/9328aba70619ef5d1d849e51587567a0ab7aec1d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9328aba70619ef5d1d849e51587567a0ab7aec1d/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39adefc4a7a7d4de0c8b81d174619110a9399d9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/39adefc4a7a7d4de0c8b81d174619110a9399d9b", "html_url": "https://github.com/rust-lang/rust/commit/39adefc4a7a7d4de0c8b81d174619110a9399d9b"}, {"sha": "bb22a4e386c13a17b518a3822d343f6dd3dc4398", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb22a4e386c13a17b518a3822d343f6dd3dc4398", "html_url": "https://github.com/rust-lang/rust/commit/bb22a4e386c13a17b518a3822d343f6dd3dc4398"}], "stats": {"total": 32, "additions": 20, "deletions": 12}, "files": [{"sha": "3cf0c66eacc185084b078657d4b4fb1284e7cea3", "filename": "crates/ra_hir_def/src/body/lower.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9328aba70619ef5d1d849e51587567a0ab7aec1d/crates%2Fra_hir_def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9328aba70619ef5d1d849e51587567a0ab7aec1d/crates%2Fra_hir_def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fbody%2Flower.rs?ref=9328aba70619ef5d1d849e51587567a0ab7aec1d", "patch": "@@ -453,7 +453,7 @@ impl ExprCollector<'_> {\n                 }\n             }\n             ast::Expr::MacroCall(e) => {\n-                if let Some(name) = is_macro_rules(&e) {\n+                if let Some(name) = e.is_macro_rules().map(|it| it.as_name()) {\n                     let mac = MacroDefId {\n                         krate: Some(self.expander.module.krate),\n                         ast_id: Some(self.expander.ast_id(&e)),\n@@ -697,16 +697,6 @@ impl ExprCollector<'_> {\n     }\n }\n \n-fn is_macro_rules(m: &ast::MacroCall) -> Option<Name> {\n-    let name = m.path()?.segment()?.name_ref()?.as_name();\n-\n-    if name == name![macro_rules] {\n-        Some(m.name()?.as_name())\n-    } else {\n-        None\n-    }\n-}\n-\n impl From<ast::BinOp> for BinaryOp {\n     fn from(ast_op: ast::BinOp) -> Self {\n         match ast_op {"}, {"sha": "0f46f93c172516ba37a6b0974f8ee3d3c934ef6f", "filename": "crates/ra_ide_db/src/symbol_index.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9328aba70619ef5d1d849e51587567a0ab7aec1d/crates%2Fra_ide_db%2Fsrc%2Fsymbol_index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9328aba70619ef5d1d849e51587567a0ab7aec1d/crates%2Fra_ide_db%2Fsrc%2Fsymbol_index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_db%2Fsrc%2Fsymbol_index.rs?ref=9328aba70619ef5d1d849e51587567a0ab7aec1d", "patch": "@@ -362,6 +362,13 @@ fn to_symbol(node: &SyntaxNode) -> Option<(SmolStr, SyntaxNodePtr, TextRange)> {\n             ast::TypeAliasDef(it) => { decl(it) },\n             ast::ConstDef(it) => { decl(it) },\n             ast::StaticDef(it) => { decl(it) },\n+            ast::MacroCall(it) => {\n+                if it.is_macro_rules().is_some() {\n+                    decl(it)\n+                } else {\n+                    None\n+                }\n+            },\n             _ => None,\n         }\n     }"}, {"sha": "392731dac2202b8dbeedf30d45fa873c547733fa", "filename": "crates/ra_syntax/src/ast/extensions.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/9328aba70619ef5d1d849e51587567a0ab7aec1d/crates%2Fra_syntax%2Fsrc%2Fast%2Fextensions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9328aba70619ef5d1d849e51587567a0ab7aec1d/crates%2Fra_syntax%2Fsrc%2Fast%2Fextensions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fextensions.rs?ref=9328aba70619ef5d1d849e51587567a0ab7aec1d", "patch": "@@ -4,7 +4,7 @@\n use itertools::Itertools;\n \n use crate::{\n-    ast::{self, child_opt, children, AstNode, AttrInput, SyntaxNode},\n+    ast::{self, child_opt, children, AstNode, AttrInput, NameOwner, SyntaxNode},\n     SmolStr, SyntaxElement,\n     SyntaxKind::*,\n     SyntaxToken, T,\n@@ -514,3 +514,14 @@ impl ast::Visibility {\n         self.syntax().children_with_tokens().any(|it| it.kind() == T![super])\n     }\n }\n+\n+impl ast::MacroCall {\n+    pub fn is_macro_rules(&self) -> Option<ast::Name> {\n+        let name_ref = self.path()?.segment()?.name_ref()?;\n+        if name_ref.text() == \"macro_rules\" {\n+            self.name()\n+        } else {\n+            None\n+        }\n+    }\n+}"}]}