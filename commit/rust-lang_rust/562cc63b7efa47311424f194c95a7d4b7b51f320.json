{"sha": "562cc63b7efa47311424f194c95a7d4b7b51f320", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU2MmNjNjNiN2VmYTQ3MzExNDI0ZjE5NGM5NWE3ZDRiN2I1MWYzMjA=", "commit": {"author": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-10-24T11:54:18Z"}, "committer": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-10-24T11:54:18Z"}, "message": "Fix lint_without_lint_pass lint", "tree": {"sha": "ff0a8266dd3df0642715932c45b1e4f95771bb7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff0a8266dd3df0642715932c45b1e4f95771bb7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/562cc63b7efa47311424f194c95a7d4b7b51f320", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZxoS6lESXlRGMHWcaTCGhp1QZjcFAl2xkOsACgkQaTCGhp1Q\nZjco0xAAsD/uQ8S0io35fsvh6jlT+52enutzxLJkcZZP8BfK6+p9QW27ngYebDfK\nD4Xo6cY/SL8BYsevBprZWILGtz04FzKaXDt5o3Kk3u9jvtyQbPvmZYsWGLEP5p1H\nO26poewhfZUgmSmHwIZB0BCZqaeJ15qxNHoulIKgL1H54gl7zw/s9YWIPBdlXN9O\nyxof3tpiPfI2hSTsy/yz8HekwznsQEeQ4Dm/nORhpjb806XrhE4DT3+BioHu4FwP\n7nh9UqVIyop9fMP88ETqDgRExrK3xcsfkBs+EouMQ5Y43NblkputA0vCZHCR8sKj\nHju2QOkcAwYEaL/NETVpSXtaa09i40uB/0vjBUuvt95feFge8ISxvNydwPyK+akN\nxTpYhgGAgoyDPEFcFq6EfmHiyKTZui/mJaPgAW1rwVein/PWagRgJEoiLPW5pkim\nuKNzZiI1yvHcEhbhnlZxj3SIo62Li29ZkCFhMik4XJDJH4jQ2CO1sIpCjlcm764G\nHIlEd3yJfEF2uMvSZ7zb0/n5Wsf8A97r+GVsnEA/P91OhZmVMBho0Ioa8u2WWQzK\nbX1aPxs5ppmWZUiKnBSQVx8dP5z8sNwkJW8F8sKw6SUaRVnZb19G/47xSWtgUH5n\nhWX8FiQo9pPMGt64s7g/xjwPTN63qXSeJK94i1r1LzrS3KKDjbs=\n=x64s\n-----END PGP SIGNATURE-----", "payload": "tree ff0a8266dd3df0642715932c45b1e4f95771bb7f\nparent 237e168b89d8e0070d05f61b67f0896b97530c34\nauthor flip1995 <hello@philkrones.com> 1571918058 +0200\ncommitter flip1995 <hello@philkrones.com> 1571918058 +0200\n\nFix lint_without_lint_pass lint\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/562cc63b7efa47311424f194c95a7d4b7b51f320", "html_url": "https://github.com/rust-lang/rust/commit/562cc63b7efa47311424f194c95a7d4b7b51f320", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/562cc63b7efa47311424f194c95a7d4b7b51f320/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "237e168b89d8e0070d05f61b67f0896b97530c34", "url": "https://api.github.com/repos/rust-lang/rust/commits/237e168b89d8e0070d05f61b67f0896b97530c34", "html_url": "https://github.com/rust-lang/rust/commit/237e168b89d8e0070d05f61b67f0896b97530c34"}], "stats": {"total": 48, "additions": 26, "deletions": 22}, "files": [{"sha": "b5cd0d17f77dba3f5335be0186ce5e840a982438", "filename": "clippy_lints/src/utils/internal_lints.rs", "status": "modified", "additions": 19, "deletions": 20, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/562cc63b7efa47311424f194c95a7d4b7b51f320/clippy_lints%2Fsrc%2Futils%2Finternal_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/562cc63b7efa47311424f194c95a7d4b7b51f320/clippy_lints%2Fsrc%2Futils%2Finternal_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Finternal_lints.rs?ref=562cc63b7efa47311424f194c95a7d4b7b51f320", "patch": "@@ -1,5 +1,6 @@\n use crate::utils::{\n-    match_def_path, match_type, method_calls, paths, span_help_and_lint, span_lint, span_lint_and_sugg, walk_ptrs_ty,\n+    is_expn_of, match_def_path, match_type, method_calls, paths, span_help_and_lint, span_lint, span_lint_and_sugg,\n+    walk_ptrs_ty,\n };\n use if_chain::if_chain;\n use rustc::hir;\n@@ -148,25 +149,23 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for LintWithoutLintPass {\n             if is_lint_ref_type(cx, ty) {\n                 self.declared_lints.insert(item.ident.name, item.span);\n             }\n-        } else if let hir::ItemKind::Impl(.., Some(ref trait_ref), _, ref impl_item_refs) = item.kind {\n-            if_chain! {\n-                if let hir::TraitRef{path, ..} = trait_ref;\n-                if let Res::Def(DefKind::Trait, def_id) = path.res;\n-                if match_def_path(cx, def_id, &paths::LINT_PASS);\n-                then {\n-                    let mut collector = LintCollector {\n-                        output: &mut self.registered_lints,\n-                        cx,\n-                    };\n-                    let body_id = cx.tcx.hir().body_owned_by(\n-                        impl_item_refs\n-                            .iter()\n-                            .find(|iiref| iiref.ident.as_str() == \"get_lints\")\n-                            .expect(\"LintPass needs to implement get_lints\")\n-                            .id.hir_id\n-                    );\n-                    collector.visit_expr(&cx.tcx.hir().body(body_id).value);\n-                }\n+        } else if is_expn_of(item.span, \"impl_lint_pass\").is_some()\n+            || is_expn_of(item.span, \"declare_lint_pass\").is_some()\n+        {\n+            if let hir::ItemKind::Impl(.., None, _, ref impl_item_refs) = item.kind {\n+                let mut collector = LintCollector {\n+                    output: &mut self.registered_lints,\n+                    cx,\n+                };\n+                let body_id = cx.tcx.hir().body_owned_by(\n+                    impl_item_refs\n+                        .iter()\n+                        .find(|iiref| iiref.ident.as_str() == \"get_lints\")\n+                        .expect(\"LintPass needs to implement get_lints\")\n+                        .id\n+                        .hir_id,\n+                );\n+                collector.visit_expr(&cx.tcx.hir().body(body_id).value);\n             }\n         }\n     }"}, {"sha": "9787517e505564092c39c343202f8e292966f164", "filename": "clippy_lints/src/utils/paths.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/562cc63b7efa47311424f194c95a7d4b7b51f320/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/562cc63b7efa47311424f194c95a7d4b7b51f320/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fpaths.rs?ref=562cc63b7efa47311424f194c95a7d4b7b51f320", "patch": "@@ -46,7 +46,6 @@ pub const ITERATOR: [&str; 5] = [\"core\", \"iter\", \"traits\", \"iterator\", \"Iterator\n pub const LATE_CONTEXT: [&str; 4] = [\"rustc\", \"lint\", \"context\", \"LateContext\"];\n pub const LINKED_LIST: [&str; 4] = [\"alloc\", \"collections\", \"linked_list\", \"LinkedList\"];\n pub const LINT: [&str; 3] = [\"rustc\", \"lint\", \"Lint\"];\n-pub const LINT_PASS: [&str; 3] = [\"rustc\", \"lint\", \"LintPass\"];\n pub const MEM_DISCRIMINANT: [&str; 3] = [\"core\", \"mem\", \"discriminant\"];\n pub const MEM_FORGET: [&str; 3] = [\"core\", \"mem\", \"forget\"];\n pub const MEM_MAYBEUNINIT: [&str; 4] = [\"core\", \"mem\", \"maybe_uninit\", \"MaybeUninit\"];"}, {"sha": "dc93bbfd75263332c5f060a1ed710f8e3adbec7e", "filename": "tests/ui/lint_without_lint_pass.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/562cc63b7efa47311424f194c95a7d4b7b51f320/tests%2Fui%2Flint_without_lint_pass.rs", "raw_url": "https://github.com/rust-lang/rust/raw/562cc63b7efa47311424f194c95a7d4b7b51f320/tests%2Fui%2Flint_without_lint_pass.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint_without_lint_pass.rs?ref=562cc63b7efa47311424f194c95a7d4b7b51f320", "patch": "@@ -20,6 +20,12 @@ declare_clippy_lint! {\n     \"\"\n }\n \n+declare_clippy_lint! {\n+    pub TEST_LINT_REGISTERED_ONLY_IMPL,\n+    correctness,\n+    \"\"\n+}\n+\n pub struct Pass;\n impl LintPass for Pass {\n     fn name(&self) -> &'static str {\n@@ -30,6 +36,6 @@ impl LintPass for Pass {\n declare_lint_pass!(Pass2 => [TEST_LINT_REGISTERED]);\n \n pub struct Pass3;\n-impl_lint_pass!(Pass3 => [TEST_LINT_REGISTERED]);\n+impl_lint_pass!(Pass3 => [TEST_LINT_REGISTERED_ONLY_IMPL]);\n \n fn main() {}"}]}