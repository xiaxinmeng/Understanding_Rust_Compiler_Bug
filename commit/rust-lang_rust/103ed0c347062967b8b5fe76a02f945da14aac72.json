{"sha": "103ed0c347062967b8b5fe76a02f945da14aac72", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwM2VkMGMzNDcwNjI5NjdiOGI1ZmU3NmEwMmY5NDVkYTE0YWFjNzI=", "commit": {"author": {"name": "gnzlbg", "email": "gonzalobg88@gmail.com", "date": "2019-02-20T17:08:21Z"}, "committer": {"name": "gnzlbg", "email": "gonzalobg88@gmail.com", "date": "2019-02-20T18:37:54Z"}, "message": "Search for target_triple.json only if builtin target not found\n\nBefore this commit, if the builtin target was found, but an error\nhappened when instantiating it (e.g. validating the target\nspecification file failed, etc.), then we ignored those errors\nand proceeded to try to find a `target_triple.json` file, and if\nthat failed, reported that as an error.\n\nWith this commit, if rustc is supposed to provide the builtin target,\nand something fails while instantiating it, that error will\nget properly propagated.", "tree": {"sha": "a892ff08d93fe13e84f11c2abc2bad77a8573ed0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a892ff08d93fe13e84f11c2abc2bad77a8573ed0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/103ed0c347062967b8b5fe76a02f945da14aac72", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/103ed0c347062967b8b5fe76a02f945da14aac72", "html_url": "https://github.com/rust-lang/rust/commit/103ed0c347062967b8b5fe76a02f945da14aac72", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/103ed0c347062967b8b5fe76a02f945da14aac72/comments", "author": {"login": "gnzlbg", "id": 904614, "node_id": "MDQ6VXNlcjkwNDYxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gnzlbg", "html_url": "https://github.com/gnzlbg", "followers_url": "https://api.github.com/users/gnzlbg/followers", "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}", "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}", "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions", "organizations_url": "https://api.github.com/users/gnzlbg/orgs", "repos_url": "https://api.github.com/users/gnzlbg/repos", "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}", "received_events_url": "https://api.github.com/users/gnzlbg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "gnzlbg", "id": 904614, "node_id": "MDQ6VXNlcjkwNDYxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gnzlbg", "html_url": "https://github.com/gnzlbg", "followers_url": "https://api.github.com/users/gnzlbg/followers", "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}", "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}", "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions", "organizations_url": "https://api.github.com/users/gnzlbg/orgs", "repos_url": "https://api.github.com/users/gnzlbg/repos", "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}", "received_events_url": "https://api.github.com/users/gnzlbg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f66e4697ae286985ddefc53c3a047614568458bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/f66e4697ae286985ddefc53c3a047614568458bb", "html_url": "https://github.com/rust-lang/rust/commit/f66e4697ae286985ddefc53c3a047614568458bb"}], "stats": {"total": 22, "additions": 16, "deletions": 6}, "files": [{"sha": "bef2afc7b6292db5530e23008ab3e45fe9597234", "filename": "src/librustc_target/spec/mod.rs", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/103ed0c347062967b8b5fe76a02f945da14aac72/src%2Flibrustc_target%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/103ed0c347062967b8b5fe76a02f945da14aac72/src%2Flibrustc_target%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fmod.rs?ref=103ed0c347062967b8b5fe76a02f945da14aac72", "patch": "@@ -259,6 +259,11 @@ impl ToJson for MergeFunctions {\n     }\n }\n \n+pub enum LoadTargetError {\n+    BuiltinTargetNotFound(String),\n+    Other(String),\n+}\n+\n pub type LinkArgs = BTreeMap<LinkerFlavor, Vec<String>>;\n pub type TargetResult = Result<Target, String>;\n \n@@ -269,21 +274,24 @@ macro_rules! supported_targets {\n         /// List of supported targets\n         const TARGETS: &[&str] = &[$($triple),*];\n \n-        fn load_specific(target: &str) -> TargetResult {\n+        fn load_specific(target: &str) -> Result<Target, LoadTargetError> {\n             match target {\n                 $(\n                     $triple => {\n-                        let mut t = $module::target()?;\n+                        let mut t = $module::target()\n+                            .map_err(LoadTargetError::Other)?;\n                         t.options.is_builtin = true;\n \n                         // round-trip through the JSON parser to ensure at\n                         // run-time that the parser works correctly\n-                        t = Target::from_json(t.to_json())?;\n+                        t = Target::from_json(t.to_json())\n+                            .map_err(LoadTargetError::Other)?;\n                         debug!(\"Got builtin target: {:?}\", t);\n                         Ok(t)\n                     },\n                 )+\n-                _ => Err(format!(\"Unable to find target: {}\", target))\n+                    _ => Err(LoadTargetError::BuiltinTargetNotFound(\n+                        format!(\"Unable to find target: {}\", target)))\n             }\n         }\n \n@@ -1176,8 +1184,10 @@ impl Target {\n         match *target_triple {\n             TargetTriple::TargetTriple(ref target_triple) => {\n                 // check if triple is in list of supported targets\n-                if let Ok(t) = load_specific(target_triple) {\n-                    return Ok(t)\n+                match load_specific(target_triple) {\n+                    Ok(t) => return Ok(t),\n+                    Err(LoadTargetError::BuiltinTargetNotFound(_)) => (),\n+                    Err(LoadTargetError::Other(e)) => return Err(e),\n                 }\n \n                 // search for a file named `target_triple`.json in RUST_TARGET_PATH"}]}