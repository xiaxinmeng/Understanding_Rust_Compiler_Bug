{"sha": "83d701e569914b9dbf7be002f62d63e790a5cb70", "node_id": "C_kwDOAAsO6NoAKDgzZDcwMWU1Njk5MTRiOWRiZjdiZTAwMmY2MmQ2M2U3OTBhNWNiNzA", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-04-27T04:09:26Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-04-27T04:37:10Z"}, "message": "Better error messages when collecting into `[T; n]`", "tree": {"sha": "20c1709a18e363bed2de5f137ca6e4bddb44916f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20c1709a18e363bed2de5f137ca6e4bddb44916f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83d701e569914b9dbf7be002f62d63e790a5cb70", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83d701e569914b9dbf7be002f62d63e790a5cb70", "html_url": "https://github.com/rust-lang/rust/commit/83d701e569914b9dbf7be002f62d63e790a5cb70", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83d701e569914b9dbf7be002f62d63e790a5cb70/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7197189cd0e3a86d1b661d1dceb8bdff021d0b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7197189cd0e3a86d1b661d1dceb8bdff021d0b8", "html_url": "https://github.com/rust-lang/rust/commit/a7197189cd0e3a86d1b661d1dceb8bdff021d0b8"}], "stats": {"total": 101, "additions": 69, "deletions": 32}, "files": [{"sha": "9e9c230aebb85b2a597cf5dad201e09aa02eda42", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/on_unimplemented.rs", "status": "modified", "additions": 31, "deletions": 11, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/83d701e569914b9dbf7be002f62d63e790a5cb70/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fon_unimplemented.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83d701e569914b9dbf7be002f62d63e790a5cb70/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fon_unimplemented.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fon_unimplemented.rs?ref=83d701e569914b9dbf7be002f62d63e790a5cb70", "patch": "@@ -217,22 +217,42 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                 flags.push((sym::_Self, Some(shortname.to_owned())));\n             }\n \n+            // Slices give us `[]`, `[{ty}]`\n+            if let ty::Slice(aty) = self_ty.kind() {\n+                flags.push((sym::_Self, Some(\"[]\".to_string())));\n+                if let Some(def) = aty.ty_adt_def() {\n+                    // We also want to be able to select the slice's type's original\n+                    // signature with no type arguments resolved\n+                    let type_string = self.tcx.type_of(def.did()).to_string();\n+                    flags.push((sym::_Self, Some(format!(\"[{type_string}]\"))));\n+                }\n+                if aty.is_integral() {\n+                    flags.push((sym::_Self, Some(\"[{integral}]\".to_string())));\n+                }\n+            }\n+\n+            // Arrays give us `[]`, `[{ty}; _]` and `[{ty}; N]`\n             if let ty::Array(aty, len) = self_ty.kind() {\n-                flags.push((sym::_Self, Some(\"[]\".to_owned())));\n-                flags.push((sym::_Self, Some(format!(\"[{}]\", aty))));\n+                flags.push((sym::_Self, Some(\"[]\".to_string())));\n+                let len = len.val().try_to_value().and_then(|v| v.try_to_machine_usize(self.tcx));\n+                flags.push((sym::_Self, Some(format!(\"[{}; _]\", aty))));\n+                if let Some(n) = len {\n+                    flags.push((sym::_Self, Some(format!(\"[{}; {}]\", aty, n))));\n+                }\n                 if let Some(def) = aty.ty_adt_def() {\n                     // We also want to be able to select the array's type's original\n                     // signature with no type arguments resolved\n                     let type_string = self.tcx.type_of(def.did()).to_string();\n-                    flags.push((sym::_Self, Some(format!(\"[{}]\", type_string))));\n-\n-                    let len =\n-                        len.val().try_to_value().and_then(|v| v.try_to_machine_usize(self.tcx));\n-                    let string = match len {\n-                        Some(n) => format!(\"[{}; {}]\", type_string, n),\n-                        None => format!(\"[{}; _]\", type_string),\n-                    };\n-                    flags.push((sym::_Self, Some(string)));\n+                    flags.push((sym::_Self, Some(format!(\"[{type_string}; _]\"))));\n+                    if let Some(n) = len {\n+                        flags.push((sym::_Self, Some(format!(\"[{type_string}; {n}]\"))));\n+                    }\n+                }\n+                if aty.is_integral() {\n+                    flags.push((sym::_Self, Some(\"[{integral}; _]\".to_string())));\n+                    if let Some(n) = len {\n+                        flags.push((sym::_Self, Some(format!(\"[{{integral}}; {n}]\"))));\n+                    }\n                 }\n             }\n             if let ty::Dynamic(traits, _) = self_ty.kind() {"}, {"sha": "12ca508bed2b93e5e49d494c9f7429e676c68d3b", "filename": "library/core/src/iter/traits/collect.rs", "status": "modified", "additions": 13, "deletions": 19, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/83d701e569914b9dbf7be002f62d63e790a5cb70/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83d701e569914b9dbf7be002f62d63e790a5cb70/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fcollect.rs?ref=83d701e569914b9dbf7be002f62d63e790a5cb70", "patch": "@@ -96,30 +96,24 @@\n #[rustc_on_unimplemented(\n     on(\n         _Self = \"[{A}]\",\n-        message = \"a value of type `{Self}` cannot be built since `{Self}` has no definite size\",\n+        message = \"a slice of type `{Self}` cannot be built since `{Self}` has no definite size\",\n         label = \"try explicitly collecting into a `Vec<{A}>`\",\n     ),\n     on(\n-        all(\n-            A = \"{integer}\",\n-            any(\n-                _Self = \"[i8]\",\n-                _Self = \"[i16]\",\n-                _Self = \"[i32]\",\n-                _Self = \"[i64]\",\n-                _Self = \"[i128]\",\n-                _Self = \"[isize]\",\n-                _Self = \"[u8]\",\n-                _Self = \"[u16]\",\n-                _Self = \"[u32]\",\n-                _Self = \"[u64]\",\n-                _Self = \"[u128]\",\n-                _Self = \"[usize]\"\n-            )\n-        ),\n-        message = \"a value of type `{Self}` cannot be built since `{Self}` has no definite size\",\n+        all(A = \"{integer}\", any(_Self = \"[{integral}]\",)),\n+        message = \"a slice of type `{Self}` cannot be built since `{Self}` has no definite size\",\n         label = \"try explicitly collecting into a `Vec<{A}>`\",\n     ),\n+    on(\n+        _Self = \"[{A}; _]\",\n+        message = \"an array of type `{Self}` cannot be built directly from an iterator\",\n+        label = \"try collecting into a `Vec<{A}>`, then using `.try_into()`\",\n+    ),\n+    on(\n+        all(A = \"{integer}\", any(_Self = \"[{integral}; _]\",)),\n+        message = \"an array of type `{Self}` cannot be built directly from an iterator\",\n+        label = \"try collecting into a `Vec<{A}>`, then using `.try_into()`\",\n+    ),\n     message = \"a value of type `{Self}` cannot be built from an iterator \\\n                over elements of type `{A}`\",\n     label = \"value of type `{Self}` cannot be built from `std::iter::Iterator<Item={A}>`\""}, {"sha": "a1144c8cb8c6ae72eef12533c75420e038c4eb51", "filename": "src/test/ui/iterators/collect-into-array.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-array.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-array.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-array.rs?ref=83d701e569914b9dbf7be002f62d63e790a5cb70", "patch": "@@ -0,0 +1,7 @@\n+fn main() {\n+    //~^ NOTE required by a bound in this\n+    let whatever: [u32; 10] = (0..10).collect();\n+    //~^ ERROR an array of type `[u32; 10]` cannot be built directly from an iterator\n+    //~| NOTE try collecting into a `Vec<{integer}>`, then using `.try_into()`\n+    //~| NOTE required by a bound in `collect`\n+}"}, {"sha": "7be53a4873bccd45d12eb78e47a3e390988d7f37", "filename": "src/test/ui/iterators/collect-into-array.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-array.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-array.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-array.stderr?ref=83d701e569914b9dbf7be002f62d63e790a5cb70", "patch": "@@ -0,0 +1,16 @@\n+error[E0277]: an array of type `[u32; 10]` cannot be built directly from an iterator\n+  --> $DIR/collect-into-array.rs:3:39\n+   |\n+LL |     let whatever: [u32; 10] = (0..10).collect();\n+   |                                       ^^^^^^^ try collecting into a `Vec<{integer}>`, then using `.try_into()`\n+   |\n+   = help: the trait `FromIterator<{integer}>` is not implemented for `[u32; 10]`\n+note: required by a bound in `collect`\n+  --> $SRC_DIR/core/src/iter/traits/iterator.rs:LL:COL\n+   |\n+LL |     fn collect<B: FromIterator<Self::Item>>(self) -> B\n+   |                   ^^^^^^^^^^^^^^^^^^^^^^^^ required by this bound in `collect`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}, {"sha": "aafa6bc8b951476245a47f487237e96baa4dc2e8", "filename": "src/test/ui/iterators/collect-into-slice.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-slice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-slice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-slice.rs?ref=83d701e569914b9dbf7be002f62d63e790a5cb70", "patch": "@@ -6,7 +6,7 @@ fn process_slice(data: &[i32]) {\n fn main() {\n     let some_generated_vec = (0..10).collect();\n     //~^ ERROR the size for values of type `[i32]` cannot be known at compilation time\n-    //~| ERROR a value of type `[i32]` cannot be built since `[i32]` has no definite size\n+    //~| ERROR a slice of type `[i32]` cannot be built since `[i32]` has no definite size\n     //~| NOTE try explicitly collecting into a `Vec<{integer}>`\n     //~| NOTE required by a bound in `collect`\n     //~| NOTE all local variables must have a statically known size"}, {"sha": "4842e65fe976b205f05726c4ea876f55e273f460", "filename": "src/test/ui/iterators/collect-into-slice.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-slice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/83d701e569914b9dbf7be002f62d63e790a5cb70/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-slice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fiterators%2Fcollect-into-slice.stderr?ref=83d701e569914b9dbf7be002f62d63e790a5cb70", "patch": "@@ -8,7 +8,7 @@ LL |     let some_generated_vec = (0..10).collect();\n    = note: all local variables must have a statically known size\n    = help: unsized locals are gated as an unstable feature\n \n-error[E0277]: a value of type `[i32]` cannot be built since `[i32]` has no definite size\n+error[E0277]: a slice of type `[i32]` cannot be built since `[i32]` has no definite size\n   --> $DIR/collect-into-slice.rs:7:38\n    |\n LL |     let some_generated_vec = (0..10).collect();"}]}