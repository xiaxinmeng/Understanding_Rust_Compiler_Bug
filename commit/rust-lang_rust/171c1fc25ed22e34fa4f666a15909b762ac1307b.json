{"sha": "171c1fc25ed22e34fa4f666a15909b762ac1307b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3MWMxZmMyNWVkMjJlMzRmYTRmNjY2YTE1OTA5Yjc2MmFjMTMwN2I=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-30T03:12:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-30T03:12:16Z"}, "message": "Auto merge of #57185 - petrochenkov:impice4, r=estebank\n\nresolve: Fix one more ICE in import validation\n\nSo if you have an unresolved import\n```rust\nmod m {\n    use foo::bar;\n}\n```\nerror recovery will insert a special item with `Def::Err` definition into module `m`, so other things depending on `bar` won't produce extra errors.\n\nThe issue was that erroneous `bar` was overwriting legitimate `bar`s coming from globs, e.g.\n```rust\nmod m {\n    use baz::*; // imports real existing `bar`\n    use foo::bar;\n}\n```\ncausing some unwanted diagnostics talking about \"unresolved items\", and producing inconsistent resolutions like https://github.com/rust-lang/rust/issues/57015.\nThis PR stops overwriting real successful resolutions with `Def::Err`s.\n\nFixes https://github.com/rust-lang/rust/issues/57015", "tree": {"sha": "cf23bc98a34c990895fa9da8f67c807bf22597f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cf23bc98a34c990895fa9da8f67c807bf22597f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/171c1fc25ed22e34fa4f666a15909b762ac1307b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/171c1fc25ed22e34fa4f666a15909b762ac1307b", "html_url": "https://github.com/rust-lang/rust/commit/171c1fc25ed22e34fa4f666a15909b762ac1307b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/171c1fc25ed22e34fa4f666a15909b762ac1307b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a35cf79fcb961d43828aa9f010e7109b60633f52", "url": "https://api.github.com/repos/rust-lang/rust/commits/a35cf79fcb961d43828aa9f010e7109b60633f52", "html_url": "https://github.com/rust-lang/rust/commit/a35cf79fcb961d43828aa9f010e7109b60633f52"}, {"sha": "ddb550a0e35921d2f4ecf023a7883b247f2ac407", "url": "https://api.github.com/repos/rust-lang/rust/commits/ddb550a0e35921d2f4ecf023a7883b247f2ac407", "html_url": "https://github.com/rust-lang/rust/commit/ddb550a0e35921d2f4ecf023a7883b247f2ac407"}], "stats": {"total": 59, "additions": 33, "deletions": 26}, "files": [{"sha": "ab440eda538a977cf36ac7cbd86bbdc24fc11e51", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=171c1fc25ed22e34fa4f666a15909b762ac1307b", "patch": "@@ -472,6 +472,10 @@ impl<'a> Resolver<'a> {\n         self.set_binding_parent_module(binding, module);\n         self.update_resolution(module, ident, ns, |this, resolution| {\n             if let Some(old_binding) = resolution.binding {\n+                if binding.def() == Def::Err {\n+                    // Do not override real bindings with `Def::Err`s from error recovery.\n+                    return Ok(());\n+                }\n                 match (old_binding.is_glob_import(), binding.is_glob_import()) {\n                     (true, true) => {\n                         if binding.def() != old_binding.def() {"}, {"sha": "d62bbf765b78708370d038c7cb69f46f0908fd59", "filename": "src/test/ui/imports/duplicate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fduplicate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fduplicate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fduplicate.rs?ref=171c1fc25ed22e34fa4f666a15909b762ac1307b", "patch": "@@ -33,7 +33,7 @@ mod g {\n fn main() {\n     e::foo();\n     f::foo(); //~ ERROR `foo` is ambiguous\n-    g::foo(); //~ ERROR `foo` is ambiguous\n+    g::foo();\n }\n \n mod ambiguous_module_errors {"}, {"sha": "acd66826fdfb7a004bb2f72949a23c21268e838c", "filename": "src/test/ui/imports/duplicate.stderr", "status": "modified", "additions": 1, "deletions": 20, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fduplicate.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fduplicate.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fduplicate.stderr?ref=171c1fc25ed22e34fa4f666a15909b762ac1307b", "patch": "@@ -50,25 +50,6 @@ LL |     pub use b::*;\n    |             ^^^^\n    = help: consider adding an explicit import of `foo` to disambiguate\n \n-error[E0659]: `foo` is ambiguous (glob import vs glob import in the same module)\n-  --> $DIR/duplicate.rs:36:8\n-   |\n-LL |     g::foo(); //~ ERROR `foo` is ambiguous\n-   |        ^^^ ambiguous name\n-   |\n-note: `foo` could refer to the function imported here\n-  --> $DIR/duplicate.rs:29:13\n-   |\n-LL |     pub use a::*;\n-   |             ^^^^\n-   = help: consider adding an explicit import of `foo` to disambiguate\n-note: `foo` could also refer to the unresolved item imported here\n-  --> $DIR/duplicate.rs:30:13\n-   |\n-LL |     pub use f::*;\n-   |             ^^^^\n-   = help: consider adding an explicit import of `foo` to disambiguate\n-\n error[E0659]: `foo` is ambiguous (glob import vs glob import in the same module)\n   --> $DIR/duplicate.rs:49:9\n    |\n@@ -88,7 +69,7 @@ LL |     use self::m2::*;\n    |         ^^^^^^^^^^^\n    = help: consider adding an explicit import of `foo` to disambiguate\n \n-error: aborting due to 5 previous errors\n+error: aborting due to 4 previous errors\n \n Some errors occurred: E0252, E0659.\n For more information about an error, try `rustc --explain E0252`."}, {"sha": "210f6a43996355c53a00a6d1a18213d257fc03fa", "filename": "src/test/ui/imports/issue-56125.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fissue-56125.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fissue-56125.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fissue-56125.stderr?ref=171c1fc25ed22e34fa4f666a15909b762ac1307b", "patch": "@@ -42,12 +42,12 @@ LL |     use issue_56125::*; //~ ERROR `issue_56125` is ambiguous\n    |\n    = note: `issue_56125` could refer to an extern crate passed with `--extern`\n    = help: use `::issue_56125` to refer to this extern crate unambiguously\n-note: `issue_56125` could also refer to the unresolved item imported here\n-  --> $DIR/issue-56125.rs:19:9\n+note: `issue_56125` could also refer to the module imported here\n+  --> $DIR/issue-56125.rs:20:9\n    |\n-LL |     use empty::issue_56125; //~ ERROR unresolved import `empty::issue_56125`\n-   |         ^^^^^^^^^^^^^^^^^^\n-   = help: use `self::issue_56125` to refer to this unresolved item unambiguously\n+LL |     use issue_56125::*; //~ ERROR `issue_56125` is ambiguous\n+   |         ^^^^^^^^^^^^^^\n+   = help: use `self::issue_56125` to refer to this module unambiguously\n \n error: aborting due to 4 previous errors\n "}, {"sha": "27688fd34f62f1bdc6393aab2b13399938f5dca4", "filename": "src/test/ui/imports/issue-57015.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fissue-57015.rs", "raw_url": "https://github.com/rust-lang/rust/raw/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fissue-57015.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fissue-57015.rs?ref=171c1fc25ed22e34fa4f666a15909b762ac1307b", "patch": "@@ -0,0 +1,13 @@\n+mod glob_ok {\n+    pub mod something {\n+        pub mod something_else {}\n+    }\n+}\n+\n+mod single_err {}\n+\n+use glob_ok::*; // glob_ok::something\n+use single_err::something; //~ ERROR unresolved import `single_err::something`\n+use something::something_else;\n+\n+fn main() {}"}, {"sha": "b0fcf5bec6a77eb96bd3b717bbffb55659d2e530", "filename": "src/test/ui/imports/issue-57015.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fissue-57015.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/171c1fc25ed22e34fa4f666a15909b762ac1307b/src%2Ftest%2Fui%2Fimports%2Fissue-57015.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fissue-57015.stderr?ref=171c1fc25ed22e34fa4f666a15909b762ac1307b", "patch": "@@ -0,0 +1,9 @@\n+error[E0432]: unresolved import `single_err::something`\n+  --> $DIR/issue-57015.rs:10:5\n+   |\n+LL | use single_err::something; //~ ERROR unresolved import `single_err::something`\n+   |     ^^^^^^^^^^^^^^^^^^^^^ no `something` in `single_err`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0432`."}]}