{"sha": "5ddfde3038749a06b0fae3a4d96d002148f9126a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVkZGZkZTMwMzg3NDlhMDZiMGZhZTNhNGQ5NmQwMDIxNDhmOTEyNmE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-02-09T14:23:35Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-02-09T14:23:35Z"}, "message": "Modernize tests", "tree": {"sha": "56d81628915c1af7cf82ecb25c268445e25c1698", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56d81628915c1af7cf82ecb25c268445e25c1698"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5ddfde3038749a06b0fae3a4d96d002148f9126a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5ddfde3038749a06b0fae3a4d96d002148f9126a", "html_url": "https://github.com/rust-lang/rust/commit/5ddfde3038749a06b0fae3a4d96d002148f9126a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5ddfde3038749a06b0fae3a4d96d002148f9126a/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "876c4519e37db3cd134efb5dda604ac5a29c3853", "url": "https://api.github.com/repos/rust-lang/rust/commits/876c4519e37db3cd134efb5dda604ac5a29c3853", "html_url": "https://github.com/rust-lang/rust/commit/876c4519e37db3cd134efb5dda604ac5a29c3853"}], "stats": {"total": 366, "additions": 169, "deletions": 197}, "files": [{"sha": "f979ba434696837da922a78e5771ea5c6977df19", "filename": "crates/ide/src/syntax_tree.rs", "status": "modified", "additions": 169, "deletions": 197, "changes": 366, "blob_url": "https://github.com/rust-lang/rust/blob/5ddfde3038749a06b0fae3a4d96d002148f9126a/crates%2Fide%2Fsrc%2Fsyntax_tree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ddfde3038749a06b0fae3a4d96d002148f9126a/crates%2Fide%2Fsrc%2Fsyntax_tree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_tree.rs?ref=5ddfde3038749a06b0fae3a4d96d002148f9126a", "patch": "@@ -100,258 +100,230 @@ fn syntax_tree_for_token(node: &SyntaxToken, text_range: TextRange) -> Option<St\n \n #[cfg(test)]\n mod tests {\n-    use test_utils::assert_eq_text;\n+    use expect_test::expect;\n \n     use crate::fixture;\n \n+    fn check(ra_fixture: &str, expect: expect_test::Expect) {\n+        let (analysis, file_id) = fixture::file(ra_fixture);\n+        let syn = analysis.syntax_tree(file_id, None).unwrap();\n+        expect.assert_eq(&syn)\n+    }\n+    fn check_range(ra_fixture: &str, expect: expect_test::Expect) {\n+        let (analysis, frange) = fixture::range(ra_fixture);\n+        let syn = analysis.syntax_tree(frange.file_id, Some(frange.range)).unwrap();\n+        expect.assert_eq(&syn)\n+    }\n+\n     #[test]\n     fn test_syntax_tree_without_range() {\n         // Basic syntax\n-        let (analysis, file_id) = fixture::file(r#\"fn foo() {}\"#);\n-        let syn = analysis.syntax_tree(file_id, None).unwrap();\n-\n-        assert_eq_text!(\n-            r#\"\n-SOURCE_FILE@0..11\n-  FN@0..11\n-    FN_KW@0..2 \"fn\"\n-    WHITESPACE@2..3 \" \"\n-    NAME@3..6\n-      IDENT@3..6 \"foo\"\n-    PARAM_LIST@6..8\n-      L_PAREN@6..7 \"(\"\n-      R_PAREN@7..8 \")\"\n-    WHITESPACE@8..9 \" \"\n-    BLOCK_EXPR@9..11\n-      L_CURLY@9..10 \"{\"\n-      R_CURLY@10..11 \"}\"\n-\"#\n-            .trim(),\n-            syn.trim()\n+        check(\n+            r#\"fn foo() {}\"#,\n+            expect![[r#\"\n+                SOURCE_FILE@0..11\n+                  FN@0..11\n+                    FN_KW@0..2 \"fn\"\n+                    WHITESPACE@2..3 \" \"\n+                    NAME@3..6\n+                      IDENT@3..6 \"foo\"\n+                    PARAM_LIST@6..8\n+                      L_PAREN@6..7 \"(\"\n+                      R_PAREN@7..8 \")\"\n+                    WHITESPACE@8..9 \" \"\n+                    BLOCK_EXPR@9..11\n+                      L_CURLY@9..10 \"{\"\n+                      R_CURLY@10..11 \"}\"\n+            \"#]],\n         );\n \n-        let (analysis, file_id) = fixture::file(\n+        check(\n             r#\"\n fn test() {\n     assert!(\"\n     fn foo() {\n     }\n     \", \"\");\n-}\"#\n-            .trim(),\n-        );\n-        let syn = analysis.syntax_tree(file_id, None).unwrap();\n-\n-        assert_eq_text!(\n-            r#\"\n-SOURCE_FILE@0..60\n-  FN@0..60\n-    FN_KW@0..2 \"fn\"\n-    WHITESPACE@2..3 \" \"\n-    NAME@3..7\n-      IDENT@3..7 \"test\"\n-    PARAM_LIST@7..9\n-      L_PAREN@7..8 \"(\"\n-      R_PAREN@8..9 \")\"\n-    WHITESPACE@9..10 \" \"\n-    BLOCK_EXPR@10..60\n-      L_CURLY@10..11 \"{\"\n-      WHITESPACE@11..16 \"\\n    \"\n-      EXPR_STMT@16..58\n-        MACRO_CALL@16..57\n-          PATH@16..22\n-            PATH_SEGMENT@16..22\n-              NAME_REF@16..22\n-                IDENT@16..22 \"assert\"\n-          BANG@22..23 \"!\"\n-          TOKEN_TREE@23..57\n-            L_PAREN@23..24 \"(\"\n-            STRING@24..52 \"\\\"\\n    fn foo() {\\n     ...\"\n-            COMMA@52..53 \",\"\n-            WHITESPACE@53..54 \" \"\n-            STRING@54..56 \"\\\"\\\"\"\n-            R_PAREN@56..57 \")\"\n-        SEMICOLON@57..58 \";\"\n-      WHITESPACE@58..59 \"\\n\"\n-      R_CURLY@59..60 \"}\"\n-\"#\n-            .trim(),\n-            syn.trim()\n-        );\n+}\"#,\n+            expect![[r#\"\n+                SOURCE_FILE@0..60\n+                  FN@0..60\n+                    FN_KW@0..2 \"fn\"\n+                    WHITESPACE@2..3 \" \"\n+                    NAME@3..7\n+                      IDENT@3..7 \"test\"\n+                    PARAM_LIST@7..9\n+                      L_PAREN@7..8 \"(\"\n+                      R_PAREN@8..9 \")\"\n+                    WHITESPACE@9..10 \" \"\n+                    BLOCK_EXPR@10..60\n+                      L_CURLY@10..11 \"{\"\n+                      WHITESPACE@11..16 \"\\n    \"\n+                      EXPR_STMT@16..58\n+                        MACRO_CALL@16..57\n+                          PATH@16..22\n+                            PATH_SEGMENT@16..22\n+                              NAME_REF@16..22\n+                                IDENT@16..22 \"assert\"\n+                          BANG@22..23 \"!\"\n+                          TOKEN_TREE@23..57\n+                            L_PAREN@23..24 \"(\"\n+                            STRING@24..52 \"\\\"\\n    fn foo() {\\n     ...\"\n+                            COMMA@52..53 \",\"\n+                            WHITESPACE@53..54 \" \"\n+                            STRING@54..56 \"\\\"\\\"\"\n+                            R_PAREN@56..57 \")\"\n+                        SEMICOLON@57..58 \";\"\n+                      WHITESPACE@58..59 \"\\n\"\n+                      R_CURLY@59..60 \"}\"\n+            \"#]],\n+        )\n     }\n \n     #[test]\n     fn test_syntax_tree_with_range() {\n-        let (analysis, range) = fixture::range(r#\"$0fn foo() {}$0\"#.trim());\n-        let syn = analysis.syntax_tree(range.file_id, Some(range.range)).unwrap();\n-\n-        assert_eq_text!(\n-            r#\"\n-FN@0..11\n-  FN_KW@0..2 \"fn\"\n-  WHITESPACE@2..3 \" \"\n-  NAME@3..6\n-    IDENT@3..6 \"foo\"\n-  PARAM_LIST@6..8\n-    L_PAREN@6..7 \"(\"\n-    R_PAREN@7..8 \")\"\n-  WHITESPACE@8..9 \" \"\n-  BLOCK_EXPR@9..11\n-    L_CURLY@9..10 \"{\"\n-    R_CURLY@10..11 \"}\"\n-\"#\n-            .trim(),\n-            syn.trim()\n+        check_range(\n+            r#\"$0fn foo() {}$0\"#,\n+            expect![[r#\"\n+                FN@0..11\n+                  FN_KW@0..2 \"fn\"\n+                  WHITESPACE@2..3 \" \"\n+                  NAME@3..6\n+                    IDENT@3..6 \"foo\"\n+                  PARAM_LIST@6..8\n+                    L_PAREN@6..7 \"(\"\n+                    R_PAREN@7..8 \")\"\n+                  WHITESPACE@8..9 \" \"\n+                  BLOCK_EXPR@9..11\n+                    L_CURLY@9..10 \"{\"\n+                    R_CURLY@10..11 \"}\"\n+            \"#]],\n         );\n \n-        let (analysis, range) = fixture::range(\n-            r#\"fn test() {\n+        check_range(\n+            r#\"\n+fn test() {\n     $0assert!(\"\n     fn foo() {\n     }\n     \", \"\");$0\n-}\"#\n-            .trim(),\n-        );\n-        let syn = analysis.syntax_tree(range.file_id, Some(range.range)).unwrap();\n-\n-        assert_eq_text!(\n-            r#\"\n-EXPR_STMT@16..58\n-  MACRO_CALL@16..57\n-    PATH@16..22\n-      PATH_SEGMENT@16..22\n-        NAME_REF@16..22\n-          IDENT@16..22 \"assert\"\n-    BANG@22..23 \"!\"\n-    TOKEN_TREE@23..57\n-      L_PAREN@23..24 \"(\"\n-      STRING@24..52 \"\\\"\\n    fn foo() {\\n     ...\"\n-      COMMA@52..53 \",\"\n-      WHITESPACE@53..54 \" \"\n-      STRING@54..56 \"\\\"\\\"\"\n-      R_PAREN@56..57 \")\"\n-  SEMICOLON@57..58 \";\"\n-\"#\n-            .trim(),\n-            syn.trim()\n+}\"#,\n+            expect![[r#\"\n+                EXPR_STMT@16..58\n+                  MACRO_CALL@16..57\n+                    PATH@16..22\n+                      PATH_SEGMENT@16..22\n+                        NAME_REF@16..22\n+                          IDENT@16..22 \"assert\"\n+                    BANG@22..23 \"!\"\n+                    TOKEN_TREE@23..57\n+                      L_PAREN@23..24 \"(\"\n+                      STRING@24..52 \"\\\"\\n    fn foo() {\\n     ...\"\n+                      COMMA@52..53 \",\"\n+                      WHITESPACE@53..54 \" \"\n+                      STRING@54..56 \"\\\"\\\"\"\n+                      R_PAREN@56..57 \")\"\n+                  SEMICOLON@57..58 \";\"\n+            \"#]],\n         );\n     }\n \n     #[test]\n     fn test_syntax_tree_inside_string() {\n-        let (analysis, range) = fixture::range(\n+        check_range(\n             r#\"fn test() {\n     assert!(\"\n $0fn foo() {\n }$0\n fn bar() {\n }\n     \", \"\");\n-}\"#\n-            .trim(),\n-        );\n-        let syn = analysis.syntax_tree(range.file_id, Some(range.range)).unwrap();\n-        assert_eq_text!(\n-            r#\"\n-SOURCE_FILE@0..12\n-  FN@0..12\n-    FN_KW@0..2 \"fn\"\n-    WHITESPACE@2..3 \" \"\n-    NAME@3..6\n-      IDENT@3..6 \"foo\"\n-    PARAM_LIST@6..8\n-      L_PAREN@6..7 \"(\"\n-      R_PAREN@7..8 \")\"\n-    WHITESPACE@8..9 \" \"\n-    BLOCK_EXPR@9..12\n-      L_CURLY@9..10 \"{\"\n-      WHITESPACE@10..11 \"\\n\"\n-      R_CURLY@11..12 \"}\"\n-\"#\n-            .trim(),\n-            syn.trim()\n+}\"#,\n+            expect![[r#\"\n+                SOURCE_FILE@0..12\n+                  FN@0..12\n+                    FN_KW@0..2 \"fn\"\n+                    WHITESPACE@2..3 \" \"\n+                    NAME@3..6\n+                      IDENT@3..6 \"foo\"\n+                    PARAM_LIST@6..8\n+                      L_PAREN@6..7 \"(\"\n+                      R_PAREN@7..8 \")\"\n+                    WHITESPACE@8..9 \" \"\n+                    BLOCK_EXPR@9..12\n+                      L_CURLY@9..10 \"{\"\n+                      WHITESPACE@10..11 \"\\n\"\n+                      R_CURLY@11..12 \"}\"\n+            \"#]],\n         );\n \n         // With a raw string\n-        let (analysis, range) = fixture::range(\n+        check_range(\n             r###\"fn test() {\n     assert!(r#\"\n $0fn foo() {\n }$0\n fn bar() {\n }\n     \"#, \"\");\n-}\"###\n-                .trim(),\n-        );\n-        let syn = analysis.syntax_tree(range.file_id, Some(range.range)).unwrap();\n-        assert_eq_text!(\n-            r#\"\n-SOURCE_FILE@0..12\n-  FN@0..12\n-    FN_KW@0..2 \"fn\"\n-    WHITESPACE@2..3 \" \"\n-    NAME@3..6\n-      IDENT@3..6 \"foo\"\n-    PARAM_LIST@6..8\n-      L_PAREN@6..7 \"(\"\n-      R_PAREN@7..8 \")\"\n-    WHITESPACE@8..9 \" \"\n-    BLOCK_EXPR@9..12\n-      L_CURLY@9..10 \"{\"\n-      WHITESPACE@10..11 \"\\n\"\n-      R_CURLY@11..12 \"}\"\n-\"#\n-            .trim(),\n-            syn.trim()\n+}\"###,\n+            expect![[r#\"\n+                SOURCE_FILE@0..12\n+                  FN@0..12\n+                    FN_KW@0..2 \"fn\"\n+                    WHITESPACE@2..3 \" \"\n+                    NAME@3..6\n+                      IDENT@3..6 \"foo\"\n+                    PARAM_LIST@6..8\n+                      L_PAREN@6..7 \"(\"\n+                      R_PAREN@7..8 \")\"\n+                    WHITESPACE@8..9 \" \"\n+                    BLOCK_EXPR@9..12\n+                      L_CURLY@9..10 \"{\"\n+                      WHITESPACE@10..11 \"\\n\"\n+                      R_CURLY@11..12 \"}\"\n+            \"#]],\n         );\n \n         // With a raw string\n-        let (analysis, range) = fixture::range(\n+        check_range(\n             r###\"fn test() {\n     assert!(r$0#\"\n fn foo() {\n }\n fn bar() {\n }\"$0#, \"\");\n-}\"###\n-                .trim(),\n-        );\n-        let syn = analysis.syntax_tree(range.file_id, Some(range.range)).unwrap();\n-        assert_eq_text!(\n-            r#\"\n-SOURCE_FILE@0..25\n-  FN@0..12\n-    FN_KW@0..2 \"fn\"\n-    WHITESPACE@2..3 \" \"\n-    NAME@3..6\n-      IDENT@3..6 \"foo\"\n-    PARAM_LIST@6..8\n-      L_PAREN@6..7 \"(\"\n-      R_PAREN@7..8 \")\"\n-    WHITESPACE@8..9 \" \"\n-    BLOCK_EXPR@9..12\n-      L_CURLY@9..10 \"{\"\n-      WHITESPACE@10..11 \"\\n\"\n-      R_CURLY@11..12 \"}\"\n-  WHITESPACE@12..13 \"\\n\"\n-  FN@13..25\n-    FN_KW@13..15 \"fn\"\n-    WHITESPACE@15..16 \" \"\n-    NAME@16..19\n-      IDENT@16..19 \"bar\"\n-    PARAM_LIST@19..21\n-      L_PAREN@19..20 \"(\"\n-      R_PAREN@20..21 \")\"\n-    WHITESPACE@21..22 \" \"\n-    BLOCK_EXPR@22..25\n-      L_CURLY@22..23 \"{\"\n-      WHITESPACE@23..24 \"\\n\"\n-      R_CURLY@24..25 \"}\"\n-\"#\n-            .trim(),\n-            syn.trim()\n+}\"###,\n+            expect![[r#\"\n+                SOURCE_FILE@0..25\n+                  FN@0..12\n+                    FN_KW@0..2 \"fn\"\n+                    WHITESPACE@2..3 \" \"\n+                    NAME@3..6\n+                      IDENT@3..6 \"foo\"\n+                    PARAM_LIST@6..8\n+                      L_PAREN@6..7 \"(\"\n+                      R_PAREN@7..8 \")\"\n+                    WHITESPACE@8..9 \" \"\n+                    BLOCK_EXPR@9..12\n+                      L_CURLY@9..10 \"{\"\n+                      WHITESPACE@10..11 \"\\n\"\n+                      R_CURLY@11..12 \"}\"\n+                  WHITESPACE@12..13 \"\\n\"\n+                  FN@13..25\n+                    FN_KW@13..15 \"fn\"\n+                    WHITESPACE@15..16 \" \"\n+                    NAME@16..19\n+                      IDENT@16..19 \"bar\"\n+                    PARAM_LIST@19..21\n+                      L_PAREN@19..20 \"(\"\n+                      R_PAREN@20..21 \")\"\n+                    WHITESPACE@21..22 \" \"\n+                    BLOCK_EXPR@22..25\n+                      L_CURLY@22..23 \"{\"\n+                      WHITESPACE@23..24 \"\\n\"\n+                      R_CURLY@24..25 \"}\"\n+            \"#]],\n         );\n     }\n }"}]}