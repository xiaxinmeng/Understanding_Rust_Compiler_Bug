{"sha": "fdb5df049ca21cd7c15eecc9c978708a4f052832", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkYjVkZjA0OWNhMjFjZDdjMTVlZWNjOWM5Nzg3MDhhNGYwNTI4MzI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-03-16T00:30:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-16T00:30:33Z"}, "message": "Rollup merge of #69964 - ollie27:ci_nodejs, r=Mark-Simulacrum,GuillaumeGomez\n\nAdd Node.js to PR CI image\n\nThis should allow the `rustdoc-js` and `rustdoc-js-std` test suites to run automatically on PRs.", "tree": {"sha": "b1ee391e0747fd25d56603f08af48c9dfa430738", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1ee391e0747fd25d56603f08af48c9dfa430738"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fdb5df049ca21cd7c15eecc9c978708a4f052832", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJebsipCRBK7hj4Ov3rIwAAdHIIAGVVSDhItNItj+4OmQLzfulw\nWKNuY6xJckSKwJd0iSPkENa73m31GfGSP/nD/79LwRHstAvTlIJIRy3YMMzL6NrR\n4Hj5yV8MkTPxMhOTmlxJDi9HFjpHAOT2MWQJKJvtknUuAau/36VgekthwFeX5Ijk\nA0nJE86l9RA8GDDf1/RfefigV0Z3DyRTsMgL3QO55rEQSvzUHPdOrQ0Nhl8rHFt0\ndyt2jy3uoqCA4DvjF2ammOEpP3f3H8meujnxxLSjGVE7deMqbOU4Rq09O/ujuPm1\nWUME3lNcE7uQB37R21KwzC1GrJdctJsOgK7b4j+JCGkLAbwpO0bY3dl5tJhYcjY=\n=nXSY\n-----END PGP SIGNATURE-----\n", "payload": "tree b1ee391e0747fd25d56603f08af48c9dfa430738\nparent bbdc871c5377e4c78a565d26f232a11516fe38f9\nparent 3f58ab6e24af34265229f701d48eb240cc06d751\nauthor Dylan DPC <dylan.dpc@gmail.com> 1584318633 +0100\ncommitter GitHub <noreply@github.com> 1584318633 +0100\n\nRollup merge of #69964 - ollie27:ci_nodejs, r=Mark-Simulacrum,GuillaumeGomez\n\nAdd Node.js to PR CI image\n\nThis should allow the `rustdoc-js` and `rustdoc-js-std` test suites to run automatically on PRs.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fdb5df049ca21cd7c15eecc9c978708a4f052832", "html_url": "https://github.com/rust-lang/rust/commit/fdb5df049ca21cd7c15eecc9c978708a4f052832", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fdb5df049ca21cd7c15eecc9c978708a4f052832/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bbdc871c5377e4c78a565d26f232a11516fe38f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/bbdc871c5377e4c78a565d26f232a11516fe38f9", "html_url": "https://github.com/rust-lang/rust/commit/bbdc871c5377e4c78a565d26f232a11516fe38f9"}, {"sha": "3f58ab6e24af34265229f701d48eb240cc06d751", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f58ab6e24af34265229f701d48eb240cc06d751", "html_url": "https://github.com/rust-lang/rust/commit/3f58ab6e24af34265229f701d48eb240cc06d751"}], "stats": {"total": 45, "additions": 23, "deletions": 22}, "files": [{"sha": "66fd2985cb4593ae3b35a33c51c1e93023467a89", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=fdb5df049ca21cd7c15eecc9c978708a4f052832", "patch": "@@ -607,7 +607,6 @@ impl Step for RustdocTheme {\n \n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n pub struct RustdocJSStd {\n-    pub host: Interned<String>,\n     pub target: Interned<String>,\n }\n \n@@ -621,13 +620,16 @@ impl Step for RustdocJSStd {\n     }\n \n     fn make_run(run: RunConfig<'_>) {\n-        run.builder.ensure(RustdocJSStd { host: run.host, target: run.target });\n+        run.builder.ensure(RustdocJSStd { target: run.target });\n     }\n \n     fn run(self, builder: &Builder<'_>) {\n         if let Some(ref nodejs) = builder.config.nodejs {\n             let mut command = Command::new(nodejs);\n-            command.args(&[\"src/tools/rustdoc-js-std/tester.js\", &*self.host]);\n+            command\n+                .arg(builder.src.join(\"src/tools/rustdoc-js-std/tester.js\"))\n+                .arg(builder.doc_out(self.target))\n+                .arg(builder.src.join(\"src/test/rustdoc-js-std\"));\n             builder.ensure(crate::doc::Std { target: self.target, stage: builder.top_stage });\n             builder.run(&mut command);\n         } else {"}, {"sha": "4cd9e164558c0213015b5530fa68565c442b61aa", "filename": "src/ci/docker/x86_64-gnu-llvm-7/Dockerfile", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-7%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-7%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-7%2FDockerfile?ref=fdb5df049ca21cd7c15eecc9c978708a4f052832", "patch": "@@ -16,7 +16,8 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   libssl-dev \\\n   pkg-config \\\n   zlib1g-dev \\\n-  xz-utils\n+  xz-utils \\\n+  nodejs\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh"}, {"sha": "b04012af515ddad35e66572dc98995bbc62c069a", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=fdb5df049ca21cd7c15eecc9c978708a4f052832", "patch": "@@ -2779,7 +2779,7 @@ impl<'test> TestCx<'test> {\n                 Command::new(&nodejs)\n                     .arg(root.join(\"src/tools/rustdoc-js/tester.js\"))\n                     .arg(out_dir.parent().expect(\"no parent\"))\n-                    .arg(&self.testpaths.file.file_stem().expect(\"couldn't get file stem\")),\n+                    .arg(self.testpaths.file.with_extension(\"js\")),\n             );\n             if !res.status.success() {\n                 self.fatal_proc_rec(\"rustdoc-js test failed!\", &res);"}, {"sha": "19cf0483b762470d02a9e5537e2884329e05a74e", "filename": "src/tools/rustdoc-js-std/tester.js", "status": "modified", "additions": 10, "deletions": 12, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Ftools%2Frustdoc-js-std%2Ftester.js", "raw_url": "https://github.com/rust-lang/rust/raw/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Ftools%2Frustdoc-js-std%2Ftester.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustdoc-js-std%2Ftester.js?ref=fdb5df049ca21cd7c15eecc9c978708a4f052832", "patch": "@@ -1,6 +1,5 @@\n const fs = require('fs');\n-\n-const TEST_FOLDER = 'src/test/rustdoc-js-std/';\n+const path = require('path');\n \n function getNextStep(content, pos, stop) {\n     while (pos < content.length && content[pos] !== stop &&\n@@ -246,17 +245,16 @@ function readFileMatching(dir, name, extension) {\n }\n \n function main(argv) {\n-    if (argv.length !== 3) {\n-        console.error(\"Expected toolchain to check as argument (for example \\\n-                       'x86_64-apple-darwin')\");\n+    if (argv.length !== 4) {\n+        console.error(\"USAGE: node tester.js STD_DOCS TEST_FOLDER\");\n         return 1;\n     }\n-    var toolchain = argv[2];\n+    var std_docs = argv[2];\n+    var test_folder = argv[3];\n \n-    var mainJs = readFileMatching(\"build/\" + toolchain + \"/doc/\", \"main\", \".js\");\n-    var ALIASES = readFileMatching(\"build/\" + toolchain + \"/doc/\", \"aliases\", \".js\");\n-    var searchIndex = readFileMatching(\"build/\" + toolchain + \"/doc/\",\n-                                       \"search-index\", \".js\").split(\"\\n\");\n+    var mainJs = readFileMatching(std_docs, \"main\", \".js\");\n+    var ALIASES = readFileMatching(std_docs, \"aliases\", \".js\");\n+    var searchIndex = readFileMatching(std_docs, \"search-index\", \".js\").split(\"\\n\");\n     if (searchIndex[searchIndex.length - 1].length === 0) {\n         searchIndex.pop();\n     }\n@@ -287,8 +285,8 @@ function main(argv) {\n \n     var errors = 0;\n \n-    fs.readdirSync(TEST_FOLDER).forEach(function(file) {\n-        var loadedFile = loadContent(readFile(TEST_FOLDER + file) +\n+    fs.readdirSync(test_folder).forEach(function(file) {\n+        var loadedFile = loadContent(readFile(path.join(test_folder, file)) +\n                                'exports.QUERY = QUERY;exports.EXPECTED = EXPECTED;');\n         const expected = loadedFile.EXPECTED;\n         const query = loadedFile.QUERY;"}, {"sha": "7174474be1c2ba936b20a8d2d5d0694446079c4d", "filename": "src/tools/rustdoc-js/tester.js", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Ftools%2Frustdoc-js%2Ftester.js", "raw_url": "https://github.com/rust-lang/rust/raw/fdb5df049ca21cd7c15eecc9c978708a4f052832/src%2Ftools%2Frustdoc-js%2Ftester.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustdoc-js%2Ftester.js?ref=fdb5df049ca21cd7c15eecc9c978708a4f052832", "patch": "@@ -1,8 +1,7 @@\n const fs = require('fs');\n+const path = require('path');\n const { spawnSync } = require('child_process');\n \n-const TEST_FOLDER = 'src/test/rustdoc-js/';\n-\n function getNextStep(content, pos, stop) {\n     while (pos < content.length && content[pos] !== stop &&\n            (content[pos] === ' ' || content[pos] === '\\t' || content[pos] === '\\n')) {\n@@ -266,10 +265,11 @@ function main(argv) {\n     var errors = 0;\n \n     for (var j = 3; j < argv.length; ++j) {\n-        const test_name = argv[j];\n+        const test_file = argv[j];\n+        const test_name = path.basename(test_file, \".js\");\n \n         process.stdout.write('Checking \"' + test_name + '\" ... ');\n-        if (!fs.existsSync(TEST_FOLDER + test_name + \".js\")) {\n+        if (!fs.existsSync(test_file)) {\n             errors += 1;\n             console.error(\"FAILED\");\n             console.error(\"==> Missing '\" + test_name + \".js' file...\");\n@@ -279,7 +279,7 @@ function main(argv) {\n         const test_out_folder = out_folder + test_name;\n \n         var [loaded, index] = load_files(test_out_folder, test_name);\n-        var loadedFile = loadContent(readFile(TEST_FOLDER + test_name + \".js\") +\n+        var loadedFile = loadContent(readFile(test_file) +\n                                'exports.QUERY = QUERY;exports.EXPECTED = EXPECTED;');\n         const expected = loadedFile.EXPECTED;\n         const query = loadedFile.QUERY;"}]}