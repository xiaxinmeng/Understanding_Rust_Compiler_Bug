{"sha": "0ec2911857eeba97358445582ee3484a6d81d19c", "node_id": "C_kwDOAAsO6NoAKDBlYzI5MTE4NTdlZWJhOTczNTg0NDU1ODJlZTM0ODRhNmQ4MWQxOWM", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-01-25T14:47:29Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2023-02-05T13:27:52Z"}, "message": "fix: consider relative offset to fake ident token in expansion for completion", "tree": {"sha": "faaf21198ed13e0b9878ee604962aac4d0cb06b3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/faaf21198ed13e0b9878ee604962aac4d0cb06b3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ec2911857eeba97358445582ee3484a6d81d19c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmPfrtgACgkQ4laYqTBY\nYXHQRhAAsBFIqJUBb/2/Z1ikFXgIj8bJ/OLErQG5yEnC0aUtqEzQtHFx5QQf5DvL\nvyaxl/SRACD5U2ELHHyRBaxC8fbW608GsCWITIISBmfmWrZ91bkystMOseWMsz95\n93zDcrYzfVxFSz0poUQHesAKs8+N9R+8vtg4VjWDAg+mRyob1iVZcMyY8+NGyk6Z\n428TNKZEbs+f4HqiVp1ziTOrO+Hu1VWiBM3oWimBiVWHWzglrNC/+QOm/YjqAmq1\ntt00DhdBsTjrUwWNBFCwJT2SSALggyLrMC0GjToId8SeLe8IDai67yYwlYWDn1hZ\n3Zt+PRvcss/2z8qgtvFsXhMPgaN74coJt7xcypnBzjPS01N/0Va0lVYqhl+XpHaH\neSz4jI+rL39dQPZJwCzWaBTeKPeKA4LoWZv6J6X6XpWv29l05s+9NRMhdLQkf2PF\nOuVq5MOfHBhHdfe0sKdTtyabzj4OZhF+gkUIhDb3JLb2qNTU8BbDNrXJGuODG82m\nYlrhxP65ikT+PbqooIuaIVrKRG0zKyJo5dK8pH/VttJl3/lR2P2aqBUbZpxasRPd\npq350xXv22/0sQOKd/mcfExRuYPZpikRJOgI47CnUXh7DZBy9BrzzHkwMF+kOCaE\neuCL0Ves62BpKQ2BC3jUz/wEh9eBIQXcTcziDmyeTtPf9ON9dT0=\n=kU7l\n-----END PGP SIGNATURE-----", "payload": "tree faaf21198ed13e0b9878ee604962aac4d0cb06b3\nparent 3bc33c7e9f041c5aef69a5c33b3d29d19a341ece\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1674658049 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1675603672 +0900\n\nfix: consider relative offset to fake ident token in expansion for completion\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ec2911857eeba97358445582ee3484a6d81d19c", "html_url": "https://github.com/rust-lang/rust/commit/0ec2911857eeba97358445582ee3484a6d81d19c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ec2911857eeba97358445582ee3484a6d81d19c/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3bc33c7e9f041c5aef69a5c33b3d29d19a341ece", "url": "https://api.github.com/repos/rust-lang/rust/commits/3bc33c7e9f041c5aef69a5c33b3d29d19a341ece", "html_url": "https://github.com/rust-lang/rust/commit/3bc33c7e9f041c5aef69a5c33b3d29d19a341ece"}], "stats": {"total": 9, "additions": 6, "deletions": 3}, "files": [{"sha": "f606d79ad20407ad6b438948b713e36a4e549165", "filename": "crates/ide-completion/src/context/analysis.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0ec2911857eeba97358445582ee3484a6d81d19c/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ec2911857eeba97358445582ee3484a6d81d19c/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs?ref=0ec2911857eeba97358445582ee3484a6d81d19c", "patch": "@@ -48,7 +48,9 @@ pub(super) fn expand_and_analyze(\n     // make the offset point to the start of the original token, as that is what the\n     // intermediate offsets calculated in expansion always points to\n     let offset = offset - relative_offset;\n-    let expansion = expand(sema, original_file, speculative_file, offset, fake_ident_token);\n+    let expansion =\n+        expand(sema, original_file, speculative_file, offset, fake_ident_token, relative_offset);\n+\n     // add the relative offset back, so that left_biased finds the proper token\n     let offset = expansion.offset + relative_offset;\n     let token = expansion.original_file.token_at_offset(offset).left_biased()?;\n@@ -67,6 +69,7 @@ fn expand(\n     mut speculative_file: SyntaxNode,\n     mut offset: TextSize,\n     mut fake_ident_token: SyntaxToken,\n+    relative_offset: TextSize,\n ) -> ExpansionResult {\n     let _p = profile::span(\"CompletionContext::expand\");\n     let mut derive_ctx = None;\n@@ -97,7 +100,7 @@ fn expand(\n                 // successful expansions\n                 (Some(actual_expansion), Some((fake_expansion, fake_mapped_token))) => {\n                     let new_offset = fake_mapped_token.text_range().start();\n-                    if new_offset > actual_expansion.text_range().end() {\n+                    if new_offset + relative_offset > actual_expansion.text_range().end() {\n                         // offset outside of bounds from the original expansion,\n                         // stop here to prevent problems from happening\n                         break 'expansion;\n@@ -176,7 +179,7 @@ fn expand(\n                 // successful expansions\n                 (Some(actual_expansion), Some((fake_expansion, fake_mapped_token))) => {\n                     let new_offset = fake_mapped_token.text_range().start();\n-                    if new_offset > actual_expansion.text_range().end() {\n+                    if new_offset + relative_offset > actual_expansion.text_range().end() {\n                         // offset outside of bounds from the original expansion,\n                         // stop here to prevent problems from happening\n                         break 'expansion;"}]}