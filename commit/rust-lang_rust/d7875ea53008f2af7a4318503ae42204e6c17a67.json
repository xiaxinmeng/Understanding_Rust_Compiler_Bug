{"sha": "d7875ea53008f2af7a4318503ae42204e6c17a67", "node_id": "C_kwDOAAsO6NoAKGQ3ODc1ZWE1MzAwOGYyYWY3YTQzMTg1MDNhZTQyMjA0ZTZjMTdhNjc", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-08-06T00:17:14Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-08-06T00:44:54Z"}, "message": "fix an ICE in nanosleep()", "tree": {"sha": "e804a1d6ed7fe02bc47fec5567a4b02f6f06e325", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e804a1d6ed7fe02bc47fec5567a4b02f6f06e325"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d7875ea53008f2af7a4318503ae42204e6c17a67", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d7875ea53008f2af7a4318503ae42204e6c17a67", "html_url": "https://github.com/rust-lang/rust/commit/d7875ea53008f2af7a4318503ae42204e6c17a67", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d7875ea53008f2af7a4318503ae42204e6c17a67/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a87926a312fca90033c03c2ece5257e960dd242", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a87926a312fca90033c03c2ece5257e960dd242", "html_url": "https://github.com/rust-lang/rust/commit/1a87926a312fca90033c03c2ece5257e960dd242"}], "stats": {"total": 24, "additions": 23, "deletions": 1}, "files": [{"sha": "d9edbe3d7bdf4ae998b8c1879440549f557f8366", "filename": "src/shims/time.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d7875ea53008f2af7a4318503ae42204e6c17a67/src%2Fshims%2Ftime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7875ea53008f2af7a4318503ae42204e6c17a67/src%2Fshims%2Ftime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Ftime.rs?ref=d7875ea53008f2af7a4318503ae42204e6c17a67", "patch": "@@ -210,7 +210,11 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 return Ok(-1);\n             }\n         };\n-        let timeout_time = Time::Monotonic(Instant::now().checked_add(duration).unwrap());\n+        // If adding the duration overflows, let's just sleep for an hour. Waking up early is always acceptable.\n+        let timeout_time = Instant::now()\n+            .checked_add(duration)\n+            .unwrap_or_else(|| Instant::now().checked_add(Duration::from_secs(3600)).unwrap());\n+        let timeout_time = Time::Monotonic(timeout_time);\n \n         let active_thread = this.get_active_thread();\n         this.block_thread(active_thread);"}, {"sha": "dd4a1843942c44dc3cd369a4b0b01164d0a4f678", "filename": "tests/pass/sleep_long.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d7875ea53008f2af7a4318503ae42204e6c17a67/tests%2Fpass%2Fsleep_long.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7875ea53008f2af7a4318503ae42204e6c17a67/tests%2Fpass%2Fsleep_long.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpass%2Fsleep_long.rs?ref=d7875ea53008f2af7a4318503ae42204e6c17a67", "patch": "@@ -0,0 +1,18 @@\n+//@ignore-target-windows: no threads nor sleep on Windows\n+//@compile-flags: -Zmiri-ignore-leaks -Zmiri-disable-isolation\n+use std::sync::{Arc, Mutex};\n+use std::thread;\n+use std::time::Duration;\n+\n+fn main() {\n+    let finished = Arc::new(Mutex::new(false));\n+    let t_finished = finished.clone();\n+    thread::spawn(move || {\n+        // Sleep very, very long.\n+        thread::sleep(Duration::new(u64::MAX, 0));\n+        *t_finished.lock().unwrap() = true;\n+    });\n+    thread::sleep(Duration::from_millis(100));\n+    assert_eq!(*finished.lock().unwrap(), false);\n+    // Stopping the main thread will also kill the sleeper.\n+}"}]}