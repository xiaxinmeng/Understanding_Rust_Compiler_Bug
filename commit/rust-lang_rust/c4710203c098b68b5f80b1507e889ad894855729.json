{"sha": "c4710203c098b68b5f80b1507e889ad894855729", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0NzEwMjAzYzA5OGI2OGI1ZjgwYjE1MDdlODg5YWQ4OTQ4NTU3Mjk=", "commit": {"author": {"name": "Luca Barbato", "email": "lu_zero@gentoo.org", "date": "2017-07-28T02:03:23Z"}, "committer": {"name": "Luca Barbato", "email": "lu_zero@gentoo.org", "date": "2017-07-28T14:30:06Z"}, "message": "Make LLVMRustHasFeature more robust\n\nThe function should accept feature strings that old LLVM might not\nsupport.\n\nSimplify the code using the same approach used by\nLLVMRustPrintTargetFeatures.\n\nDummify the function for non 4.0 LLVM and update the tests accordingly.", "tree": {"sha": "71052bd4843b612179d9dde9c167e7c1c59a01c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/71052bd4843b612179d9dde9c167e7c1c59a01c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4710203c098b68b5f80b1507e889ad894855729", "comment_count": 3, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4710203c098b68b5f80b1507e889ad894855729", "html_url": "https://github.com/rust-lang/rust/commit/c4710203c098b68b5f80b1507e889ad894855729", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4710203c098b68b5f80b1507e889ad894855729/comments", "author": {"login": "lu-zero", "id": 239012, "node_id": "MDQ6VXNlcjIzOTAxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/239012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lu-zero", "html_url": "https://github.com/lu-zero", "followers_url": "https://api.github.com/users/lu-zero/followers", "following_url": "https://api.github.com/users/lu-zero/following{/other_user}", "gists_url": "https://api.github.com/users/lu-zero/gists{/gist_id}", "starred_url": "https://api.github.com/users/lu-zero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lu-zero/subscriptions", "organizations_url": "https://api.github.com/users/lu-zero/orgs", "repos_url": "https://api.github.com/users/lu-zero/repos", "events_url": "https://api.github.com/users/lu-zero/events{/privacy}", "received_events_url": "https://api.github.com/users/lu-zero/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lu-zero", "id": 239012, "node_id": "MDQ6VXNlcjIzOTAxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/239012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lu-zero", "html_url": "https://github.com/lu-zero", "followers_url": "https://api.github.com/users/lu-zero/followers", "following_url": "https://api.github.com/users/lu-zero/following{/other_user}", "gists_url": "https://api.github.com/users/lu-zero/gists{/gist_id}", "starred_url": "https://api.github.com/users/lu-zero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lu-zero/subscriptions", "organizations_url": "https://api.github.com/users/lu-zero/orgs", "repos_url": "https://api.github.com/users/lu-zero/repos", "events_url": "https://api.github.com/users/lu-zero/events{/privacy}", "received_events_url": "https://api.github.com/users/lu-zero/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cbce0aa341c8be3f4b9253c93ed641ed454fc0a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbce0aa341c8be3f4b9253c93ed641ed454fc0a0", "html_url": "https://github.com/rust-lang/rust/commit/cbce0aa341c8be3f4b9253c93ed641ed454fc0a0"}], "stats": {"total": 23, "additions": 9, "deletions": 14}, "files": [{"sha": "57e90be27748f3e1ca24ffb557007454661b5aa9", "filename": "src/rustllvm/PassWrapper.cpp", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c4710203c098b68b5f80b1507e889ad894855729/src%2Frustllvm%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/c4710203c098b68b5f80b1507e889ad894855729/src%2Frustllvm%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FPassWrapper.cpp?ref=c4710203c098b68b5f80b1507e889ad894855729", "patch": "@@ -181,20 +181,14 @@ extern \"C\" bool LLVMRustHasFeature(LLVMTargetMachineRef TM,\n   TargetMachine *Target = unwrap(TM);\n   const MCSubtargetInfo *MCInfo = Target->getMCSubtargetInfo();\n   const FeatureBitset &Bits = MCInfo->getFeatureBits();\n-  const llvm::SubtargetFeatureKV *FeatureEntry;\n-\n-#define SUBTARGET(x)                                                           \\\n-  if (MCInfo->isCPUStringValid(x##SubTypeKV[0].Key)) {                         \\\n-    FeatureEntry = x##FeatureKV;                                               \\\n-  } else\n-\n-  GEN_SUBTARGETS { return false; }\n-#undef SUBTARGET\n-\n-  while (strcmp(Feature, FeatureEntry->Key) != 0)\n-    FeatureEntry++;\n+#if LLVM_VERSION_GE(4, 0)\n+  const ArrayRef<SubtargetFeatureKV> FeatTable = MCInfo->getFeatureTable();\n \n-  return (Bits & FeatureEntry->Value) == FeatureEntry->Value;\n+  for (auto &FeatureEntry : FeatTable)\n+    if (!strcmp(FeatureEntry.Key, Feature))\n+      return (Bits & FeatureEntry.Value) == FeatureEntry.Value;\n+#endif\n+  return false;\n }\n \n enum class LLVMRustCodeModel {"}, {"sha": "82fa3f6a3c5e03d7ea8141c0526186c762be0a20", "filename": "src/test/run-make/print-cfg/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c4710203c098b68b5f80b1507e889ad894855729/src%2Ftest%2Frun-make%2Fprint-cfg%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/c4710203c098b68b5f80b1507e889ad894855729/src%2Ftest%2Frun-make%2Fprint-cfg%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fprint-cfg%2FMakefile?ref=c4710203c098b68b5f80b1507e889ad894855729", "patch": "@@ -5,7 +5,7 @@ all: default\n \t$(RUSTC) --target x86_64-pc-windows-gnu --print cfg | grep x86_64\n \t$(RUSTC) --target i686-pc-windows-msvc --print cfg | grep msvc\n \t$(RUSTC) --target i686-apple-darwin --print cfg | grep macos\n-\t$(RUSTC) --target i686-unknown-linux-gnu --print cfg | grep sse2\n+\t$(RUSTC) --target i686-unknown-linux-gnu --print cfg | grep gnu\n \n ifdef IS_WINDOWS\n default:"}, {"sha": "c27f83011cb1b4c7f95498589e333a4851eea413", "filename": "src/test/run-pass/sse2.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c4710203c098b68b5f80b1507e889ad894855729/src%2Ftest%2Frun-pass%2Fsse2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4710203c098b68b5f80b1507e889ad894855729/src%2Ftest%2Frun-pass%2Fsse2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fsse2.rs?ref=c4710203c098b68b5f80b1507e889ad894855729", "patch": "@@ -7,6 +7,7 @@\n // <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n+// min-llvm-version 4.0\n \n #![feature(cfg_target_feature)]\n "}]}