{"sha": "fe30dab01785e047b98d89cb27aed84b8137adb2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlMzBkYWIwMTc4NWUwNDdiOThkODljYjI3YWVkODRiODEzN2FkYjI=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-02-13T09:27:54Z"}, "committer": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-02-13T10:39:37Z"}, "message": "Preserve trailing two whitespace in comments\n\nCloses #2434.", "tree": {"sha": "d0c993db3a8652a77fd0aa5b9c9c060d02813938", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0c993db3a8652a77fd0aa5b9c9c060d02813938"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe30dab01785e047b98d89cb27aed84b8137adb2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe30dab01785e047b98d89cb27aed84b8137adb2", "html_url": "https://github.com/rust-lang/rust/commit/fe30dab01785e047b98d89cb27aed84b8137adb2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe30dab01785e047b98d89cb27aed84b8137adb2/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "67d36c70199322b262479aca949871ff97ec6358", "url": "https://api.github.com/repos/rust-lang/rust/commits/67d36c70199322b262479aca949871ff97ec6358", "html_url": "https://github.com/rust-lang/rust/commit/67d36c70199322b262479aca949871ff97ec6358"}], "stats": {"total": 37, "additions": 35, "deletions": 2}, "files": [{"sha": "ccb69442ff7d830189111959be836f85bf303a7a", "filename": "rustfmt-core/src/comment.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fe30dab01785e047b98d89cb27aed84b8137adb2/rustfmt-core%2Fsrc%2Fcomment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe30dab01785e047b98d89cb27aed84b8137adb2/rustfmt-core%2Fsrc%2Fcomment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Fsrc%2Fcomment.rs?ref=fe30dab01785e047b98d89cb27aed84b8137adb2", "patch": "@@ -494,6 +494,15 @@ pub fn recover_missing_comment_in_span(\n     }\n }\n \n+/// Trim trailing whitespaces unless they consist of two whitespaces.\n+fn trim_right_unless_two_whitespaces(s: &str) -> &str {\n+    if s.ends_with(\"  \") && !s.chars().rev().nth(2).map_or(true, char::is_whitespace) {\n+        s\n+    } else {\n+        s.trim_right()\n+    }\n+}\n+\n /// Trims whitespace and aligns to indent, but otherwise does not change comments.\n fn light_rewrite_comment(orig: &str, offset: Indent, config: &Config) -> Option<String> {\n     let lines: Vec<&str> = orig.lines()\n@@ -502,15 +511,17 @@ fn light_rewrite_comment(orig: &str, offset: Indent, config: &Config) -> Option<\n             // with `*` we want to leave one space before it, so it aligns with the\n             // `*` in `/*`.\n             let first_non_whitespace = l.find(|c| !char::is_whitespace(c));\n-            if let Some(fnw) = first_non_whitespace {\n+            let left_trimmed = if let Some(fnw) = first_non_whitespace {\n                 if l.as_bytes()[fnw] == b'*' && fnw > 0 {\n                     &l[fnw - 1..]\n                 } else {\n                     &l[fnw..]\n                 }\n             } else {\n                 \"\"\n-            }.trim_right()\n+            };\n+            // Preserve markdown's double-space line break syntax.\n+            trim_right_unless_two_whitespaces(left_trimmed)\n         })\n         .collect();\n     Some(lines.join(&format!(\"\\n{}\", offset.to_string(config))))"}, {"sha": "265f97faa0f75427ec2752630d43be54e3a3d323", "filename": "rustfmt-core/tests/source/markdown-comment.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fe30dab01785e047b98d89cb27aed84b8137adb2/rustfmt-core%2Ftests%2Fsource%2Fmarkdown-comment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe30dab01785e047b98d89cb27aed84b8137adb2/rustfmt-core%2Ftests%2Fsource%2Fmarkdown-comment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Ftests%2Fsource%2Fmarkdown-comment.rs?ref=fe30dab01785e047b98d89cb27aed84b8137adb2", "patch": "@@ -0,0 +1,11 @@\n+//! hello world  \n+//! hello world \n+\n+/// hello world  \n+/// hello world \n+fn foo() {\n+    // hello world  \n+    // hello world \n+    let x = 3;\n+    println!(\"x = {}\", x);\n+}"}, {"sha": "20dc7260d2f353f8ceea17a429a052f23c9c42d9", "filename": "rustfmt-core/tests/target/markdown-comment.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fe30dab01785e047b98d89cb27aed84b8137adb2/rustfmt-core%2Ftests%2Ftarget%2Fmarkdown-comment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe30dab01785e047b98d89cb27aed84b8137adb2/rustfmt-core%2Ftests%2Ftarget%2Fmarkdown-comment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Ftests%2Ftarget%2Fmarkdown-comment.rs?ref=fe30dab01785e047b98d89cb27aed84b8137adb2", "patch": "@@ -0,0 +1,11 @@\n+//! hello world  \n+//! hello world\n+\n+/// hello world  \n+/// hello world\n+fn foo() {\n+    // hello world  \n+    // hello world\n+    let x = 3;\n+    println!(\"x = {}\", x);\n+}"}]}