{"sha": "e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0MzRhYTFjZjczN2IwNTBlZjc5YzNkN2EwYTdlY2E0OGM3ZjhlNDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-10-04T17:47:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-10-04T17:47:06Z"}, "message": "auto merge of #17760 : bkoropoff/rust/issue-17737, r=eddyb\n\nThis is a quick fix.  In the long term, the `TyVisitor` interface should be expanded to better represent closure types.\r\n\r\nCloses issue #17737", "tree": {"sha": "efaf6637b0ba8bf9a24e49c17d06192944cd7a6b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/efaf6637b0ba8bf9a24e49c17d06192944cd7a6b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "html_url": "https://github.com/rust-lang/rust/commit/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "20f4c45bade89f0a8df5297811af3d9f8b91d075", "url": "https://api.github.com/repos/rust-lang/rust/commits/20f4c45bade89f0a8df5297811af3d9f8b91d075", "html_url": "https://github.com/rust-lang/rust/commit/20f4c45bade89f0a8df5297811af3d9f8b91d075"}, {"sha": "404db68da40130b0fa45053ea3a894cd0dd74a0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/404db68da40130b0fa45053ea3a894cd0dd74a0e", "html_url": "https://github.com/rust-lang/rust/commit/404db68da40130b0fa45053ea3a894cd0dd74a0e"}], "stats": {"total": 78, "additions": 60, "deletions": 18}, "files": [{"sha": "bff1a0400a9d158ec29ebc1aeb70ec2344fa24a3", "filename": "src/librustc/middle/trans/reflect.rs", "status": "modified", "additions": 36, "deletions": 18, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49/src%2Flibrustc%2Fmiddle%2Ftrans%2Freflect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49/src%2Flibrustc%2Fmiddle%2Ftrans%2Freflect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Freflect.rs?ref=e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "patch": "@@ -127,6 +127,22 @@ impl<'a, 'blk, 'tcx> Reflector<'a, 'blk, 'tcx> {\n         self.visit(name, []);\n     }\n \n+    fn visit_closure_ty(&mut self, fty: &ty::ClosureTy, is_unboxed: bool) {\n+        let pureval = ast_fn_style_constant(fty.fn_style);\n+        let sigilval = match fty.store {\n+            ty::UniqTraitStore => 2u,\n+            ty::RegionTraitStore(..) => 4u,\n+        };\n+        let retval = if ty::type_is_bot(fty.sig.output) {0u} else {1u};\n+        let extra = vec!(self.c_uint(pureval),\n+                         self.c_uint(sigilval),\n+                         self.c_uint(fty.sig.inputs.len()),\n+                         self.c_uint(retval));\n+        self.visit(\"enter_fn\", extra.as_slice());\n+        self.visit_sig(retval, &fty.sig, is_unboxed);\n+        self.visit(\"leave_fn\", extra.as_slice());\n+    }\n+\n     // Entrypoint\n     pub fn visit_ty(&mut self, t: ty::t) {\n         let bcx = self.bcx;\n@@ -247,20 +263,8 @@ impl<'a, 'blk, 'tcx> Reflector<'a, 'blk, 'tcx> {\n \n           // FIXME (#2594): fetch constants out of intrinsic\n           // FIXME (#4809): visitor should break out bare fns from other fns\n-          ty::ty_closure(ref fty) => {\n-            let pureval = ast_fn_style_constant(fty.fn_style);\n-            let sigilval = match fty.store {\n-                ty::UniqTraitStore => 2u,\n-                ty::RegionTraitStore(..) => 4u,\n-            };\n-            let retval = if ty::type_is_bot(fty.sig.output) {0u} else {1u};\n-            let extra = vec!(self.c_uint(pureval),\n-                          self.c_uint(sigilval),\n-                          self.c_uint(fty.sig.inputs.len()),\n-                          self.c_uint(retval));\n-            self.visit(\"enter_fn\", extra.as_slice());\n-            self.visit_sig(retval, &fty.sig);\n-            self.visit(\"leave_fn\", extra.as_slice());\n+          ty::ty_closure(box ref fty) => {\n+              self.visit_closure_ty(fty, false);\n           }\n \n           // FIXME (#2594): fetch constants out of intrinsic:: for the\n@@ -274,7 +278,7 @@ impl<'a, 'blk, 'tcx> Reflector<'a, 'blk, 'tcx> {\n                           self.c_uint(fty.sig.inputs.len()),\n                           self.c_uint(retval));\n             self.visit(\"enter_fn\", extra.as_slice());\n-            self.visit_sig(retval, &fty.sig);\n+            self.visit_sig(retval, &fty.sig, false);\n             self.visit(\"leave_fn\", extra.as_slice());\n           }\n \n@@ -388,16 +392,30 @@ impl<'a, 'blk, 'tcx> Reflector<'a, 'blk, 'tcx> {\n           // Miscellaneous extra types\n           ty::ty_infer(_) => self.leaf(\"infer\"),\n           ty::ty_err => self.leaf(\"err\"),\n-          ty::ty_unboxed_closure(..) => self.leaf(\"err\"),\n+          ty::ty_unboxed_closure(ref def_id, _) => {\n+              let closure_map = tcx.unboxed_closures.borrow();\n+              let fty = &closure_map.find(def_id).unwrap().closure_type;\n+              self.visit_closure_ty(fty, true);\n+          }\n           ty::ty_param(ref p) => {\n               let extra = vec!(self.c_uint(p.idx));\n               self.visit(\"param\", extra.as_slice())\n           }\n         }\n     }\n \n-    pub fn visit_sig(&mut self, retval: uint, sig: &ty::FnSig) {\n-        for (i, arg) in sig.inputs.iter().enumerate() {\n+    pub fn visit_sig(&mut self, retval: uint, sig: &ty::FnSig, is_unboxed: bool) {\n+        let args = if is_unboxed {\n+            match ty::get(sig.inputs[0]).sty {\n+                ty::ty_tup(ref contents) => contents.iter(),\n+                ty::ty_nil => [].iter(),\n+                _ => unreachable!()\n+            }\n+        } else {\n+            sig.inputs.iter()\n+        };\n+\n+        for (i, arg) in args.enumerate() {\n             let modeval = 5u;   // \"by copy\"\n             let extra = vec!(self.c_uint(i),\n                          self.c_uint(modeval),"}, {"sha": "ec0cb488c685bf517876437c2e0f78e2754fa35e", "filename": "src/test/run-pass/issue-17737.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49/src%2Ftest%2Frun-pass%2Fissue-17737.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49/src%2Ftest%2Frun-pass%2Fissue-17737.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-17737.rs?ref=e434aa1cf737b050ef79c3d7a0a7eca48c7f8e49", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(unboxed_closures)]\n+\n+// Test generating type visitor glue for unboxed closures\n+\n+extern crate debug;\n+\n+fn main() {\n+    let expected = \"fn(); fn(uint, uint) -> uint; fn() -> !\";\n+    let result = format!(\"{:?}; {:?}; {:?}\",\n+                         |:| {},\n+                         |&: x: uint, y: uint| { x + y },\n+                         |&mut:| -> ! { fail!() });\n+    assert_eq!(expected, result.as_slice());\n+}"}]}