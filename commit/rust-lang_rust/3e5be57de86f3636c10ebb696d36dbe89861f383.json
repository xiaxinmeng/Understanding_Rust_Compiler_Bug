{"sha": "3e5be57de86f3636c10ebb696d36dbe89861f383", "node_id": "C_kwDOAAsO6NoAKDNlNWJlNTdkZTg2ZjM2MzZjMTBlYmI2OTZkMzZkYmU4OTg2MWYzODM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-29T04:34:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-29T04:34:48Z"}, "message": "Rollup merge of #101111 - saethlin:better-fnentry-spans, r=RalfJung\n\nUse the declaration's SourceInfo for FnEntry retags, not the outermost\n\nThis addresses a long-standing `// FIXME` in the pass that adds retags.\n\nThe changes to Miri's UI tests will look like this:\n```\n   --> $DIR/aliasing_mut1.rs:LL:CC\n    |\n LL | pub fn safe(_x: &mut i32, _y: &mut i32) {}\n<   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not granting access to tag <TAG> because incompatible item [Unique for <TAG>] is protected by call ID\n>   |                           ^^ not granting access to tag <TAG> because incompatible item [Unique for <TAG>] is protected by call ID\n    |\n```\n\nr? ````@RalfJung````", "tree": {"sha": "1b128ba5d912948c9a2ed970149e9d8a4009d0fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1b128ba5d912948c9a2ed970149e9d8a4009d0fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3e5be57de86f3636c10ebb696d36dbe89861f383", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjDEHoCRBK7hj4Ov3rIwAAJRMIAFOedE74sJpS/SObvoofznqw\n7CYxEstE9KOTw4kZ+OJ31e42j8PBJBH/C0PEiD0NICXeS+BPsZDvhfKtETR1Ph2i\ngNXJLONyfniJP8d3jq4dCCqOVRT/UbpN6LW7xY7R4Cu+/DYe5g6KTNRUCs+d1IEE\nors602V4YObED/gHVhdBY949zKBeo4ibVaAUELxVXVgVzpvXLXtnsWwIhrC5uFEE\np1GZvrzAggl6fzRmkuDAxcLvlAsPjQMK+2mK0zUh373cw7blNyalmBbHgVroxs8L\nljWJZR8v3GXSug5g+1k9cpoEjMD+NjY6yxxsCUyFTxDZry6fTMXLu0VwB5fjkMw=\n=z4q+\n-----END PGP SIGNATURE-----\n", "payload": "tree 1b128ba5d912948c9a2ed970149e9d8a4009d0fc\nparent 66677546941e37d49dbe9249731fadc1d1c5972a\nparent cd1a42a95d1fa9b5f67eda4b17b702c9521bf1f4\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1661747688 +0200\ncommitter GitHub <noreply@github.com> 1661747688 +0200\n\nRollup merge of #101111 - saethlin:better-fnentry-spans, r=RalfJung\n\nUse the declaration's SourceInfo for FnEntry retags, not the outermost\n\nThis addresses a long-standing `// FIXME` in the pass that adds retags.\n\nThe changes to Miri's UI tests will look like this:\n```\n   --> $DIR/aliasing_mut1.rs:LL:CC\n    |\n LL | pub fn safe(_x: &mut i32, _y: &mut i32) {}\n<   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not granting access to tag <TAG> because incompatible item [Unique for <TAG>] is protected by call ID\n>   |                           ^^ not granting access to tag <TAG> because incompatible item [Unique for <TAG>] is protected by call ID\n    |\n```\n\nr? ````@RalfJung````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3e5be57de86f3636c10ebb696d36dbe89861f383", "html_url": "https://github.com/rust-lang/rust/commit/3e5be57de86f3636c10ebb696d36dbe89861f383", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3e5be57de86f3636c10ebb696d36dbe89861f383/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "66677546941e37d49dbe9249731fadc1d1c5972a", "url": "https://api.github.com/repos/rust-lang/rust/commits/66677546941e37d49dbe9249731fadc1d1c5972a", "html_url": "https://github.com/rust-lang/rust/commit/66677546941e37d49dbe9249731fadc1d1c5972a"}, {"sha": "cd1a42a95d1fa9b5f67eda4b17b702c9521bf1f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd1a42a95d1fa9b5f67eda4b17b702c9521bf1f4", "html_url": "https://github.com/rust-lang/rust/commit/cd1a42a95d1fa9b5f67eda4b17b702c9521bf1f4"}], "stats": {"total": 35, "additions": 16, "deletions": 19}, "files": [{"sha": "036b5589849a274542145f19e7876cc252fd6cf1", "filename": "compiler/rustc_mir_transform/src/add_retag.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3e5be57de86f3636c10ebb696d36dbe89861f383/compiler%2Frustc_mir_transform%2Fsrc%2Fadd_retag.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3e5be57de86f3636c10ebb696d36dbe89861f383/compiler%2Frustc_mir_transform%2Fsrc%2Fadd_retag.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fadd_retag.rs?ref=3e5be57de86f3636c10ebb696d36dbe89861f383", "patch": "@@ -66,7 +66,6 @@ impl<'tcx> MirPass<'tcx> for AddRetag {\n         // We need an `AllCallEdges` pass before we can do any work.\n         super::add_call_guards::AllCallEdges.run_pass(tcx, body);\n \n-        let (span, arg_count) = (body.span, body.arg_count);\n         let basic_blocks = body.basic_blocks.as_mut();\n         let local_decls = &body.local_decls;\n         let needs_retag = |place: &Place<'tcx>| {\n@@ -90,20 +89,18 @@ impl<'tcx> MirPass<'tcx> for AddRetag {\n         // PART 1\n         // Retag arguments at the beginning of the start block.\n         {\n-            // FIXME: Consider using just the span covering the function\n-            // argument declaration.\n-            let source_info = SourceInfo::outermost(span);\n             // Gather all arguments, skip return value.\n-            let places = local_decls\n-                .iter_enumerated()\n-                .skip(1)\n-                .take(arg_count)\n-                .map(|(local, _)| Place::from(local))\n-                .filter(needs_retag);\n+            let places = local_decls.iter_enumerated().skip(1).take(body.arg_count).filter_map(\n+                |(local, decl)| {\n+                    let place = Place::from(local);\n+                    needs_retag(&place).then_some((place, decl.source_info))\n+                },\n+            );\n+\n             // Emit their retags.\n             basic_blocks[START_BLOCK].statements.splice(\n                 0..0,\n-                places.map(|place| Statement {\n+                places.map(|(place, source_info)| Statement {\n                     source_info,\n                     kind: StatementKind::Retag(RetagKind::FnEntry, Box::new(place)),\n                 }),"}, {"sha": "b5f98233b3d7a68de3451802fb4fb4c3f8ebf543", "filename": "src/test/mir-opt/dead-store-elimination/provenance_soundness.retags.DeadStoreElimination.diff", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fdead-store-elimination%2Fprovenance_soundness.retags.DeadStoreElimination.diff", "raw_url": "https://github.com/rust-lang/rust/raw/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fdead-store-elimination%2Fprovenance_soundness.retags.DeadStoreElimination.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fdead-store-elimination%2Fprovenance_soundness.retags.DeadStoreElimination.diff?ref=3e5be57de86f3636c10ebb696d36dbe89861f383", "patch": "@@ -6,7 +6,7 @@\n       let mut _0: ();                      // return place in scope 0 at $DIR/provenance_soundness.rs:+0:25: +0:25\n   \n       bb0: {\n-          Retag([fn entry] _1);            // scope 0 at $DIR/provenance_soundness.rs:+0:1: +0:27\n+          Retag([fn entry] _1);            // scope 0 at $DIR/provenance_soundness.rs:+0:11: +0:13\n           _0 = const ();                   // scope 0 at $DIR/provenance_soundness.rs:+0:25: +0:27\n           return;                          // scope 0 at $DIR/provenance_soundness.rs:+0:27: +0:27\n       }"}, {"sha": "d5410d3afd4a5d0168e68ca357204d211b6e84b6", "filename": "src/test/mir-opt/inline/inline_retag.bar.Inline.after.mir", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Finline%2Finline_retag.bar.Inline.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Finline%2Finline_retag.bar.Inline.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Finline%2Finline_retag.bar.Inline.after.mir?ref=3e5be57de86f3636c10ebb696d36dbe89861f383", "patch": "@@ -52,8 +52,8 @@ fn bar() -> bool {\n         Retag(_7);                       // scope 1 at $DIR/inline-retag.rs:+2:11: +2:14\n         _6 = &(*_7);                     // scope 1 at $DIR/inline-retag.rs:+2:11: +2:14\n         Retag(_6);                       // scope 1 at $DIR/inline-retag.rs:+2:11: +2:14\n-        Retag(_3);                       // scope 2 at $DIR/inline-retag.rs:16:1: 18:2\n-        Retag(_6);                       // scope 2 at $DIR/inline-retag.rs:16:1: 18:2\n+        Retag(_3);                       // scope 2 at $DIR/inline-retag.rs:16:8: 16:9\n+        Retag(_6);                       // scope 2 at $DIR/inline-retag.rs:16:17: 16:18\n         StorageLive(_11);                // scope 2 at $DIR/inline-retag.rs:17:5: 17:7\n         _11 = (*_3);                     // scope 2 at $DIR/inline-retag.rs:17:5: 17:7\n         StorageLive(_12);                // scope 2 at $DIR/inline-retag.rs:17:11: 17:13"}, {"sha": "d254a95e06bea2b2f13973e696bcd2d715253268", "filename": "src/test/mir-opt/retag.main-{closure#0}.SimplifyCfg-elaborate-drops.after.mir", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fretag.main-%7Bclosure%230%7D.SimplifyCfg-elaborate-drops.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fretag.main-%7Bclosure%230%7D.SimplifyCfg-elaborate-drops.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fretag.main-%7Bclosure%230%7D.SimplifyCfg-elaborate-drops.after.mir?ref=3e5be57de86f3636c10ebb696d36dbe89861f383", "patch": "@@ -10,7 +10,7 @@ fn main::{closure#0}(_1: &[closure@main::{closure#0}], _2: &i32) -> &i32 {\n \n     bb0: {\n         Retag([fn entry] _1);            // scope 0 at $DIR/retag.rs:+0:31: +0:48\n-        Retag([fn entry] _2);            // scope 0 at $DIR/retag.rs:+0:31: +0:48\n+        Retag([fn entry] _2);            // scope 0 at $DIR/retag.rs:+0:32: +0:33\n         StorageLive(_3);                 // scope 0 at $DIR/retag.rs:42:13: 42:15\n         _3 = _2;                         // scope 0 at $DIR/retag.rs:42:18: 42:19\n         Retag(_3);                       // scope 0 at $DIR/retag.rs:42:18: 42:19"}, {"sha": "08fd655ae29bb979f6161bc63c8886cadee45b50", "filename": "src/test/mir-opt/retag.{impl#0}-foo.SimplifyCfg-elaborate-drops.after.mir", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fretag.%7Bimpl%230%7D-foo.SimplifyCfg-elaborate-drops.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fretag.%7Bimpl%230%7D-foo.SimplifyCfg-elaborate-drops.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fretag.%7Bimpl%230%7D-foo.SimplifyCfg-elaborate-drops.after.mir?ref=3e5be57de86f3636c10ebb696d36dbe89861f383", "patch": "@@ -7,8 +7,8 @@ fn <impl at $DIR/retag.rs:12:1: 12:10>::foo(_1: &Test, _2: &mut i32) -> &mut i32\n     let mut _3: &mut i32;                // in scope 0 at $DIR/retag.rs:+1:9: +1:10\n \n     bb0: {\n-        Retag([fn entry] _1);            // scope 0 at $DIR/retag.rs:+0:5: +2:6\n-        Retag([fn entry] _2);            // scope 0 at $DIR/retag.rs:+0:5: +2:6\n+        Retag([fn entry] _1);            // scope 0 at $DIR/retag.rs:+0:16: +0:21\n+        Retag([fn entry] _2);            // scope 0 at $DIR/retag.rs:+0:23: +0:24\n         StorageLive(_3);                 // scope 0 at $DIR/retag.rs:+1:9: +1:10\n         _3 = &mut (*_2);                 // scope 0 at $DIR/retag.rs:+1:9: +1:10\n         Retag(_3);                       // scope 0 at $DIR/retag.rs:+1:9: +1:10"}, {"sha": "f32a84e4c791b9238d813cd9a62a8ece9198dd85", "filename": "src/test/mir-opt/retag.{impl#0}-foo_shr.SimplifyCfg-elaborate-drops.after.mir", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fretag.%7Bimpl%230%7D-foo_shr.SimplifyCfg-elaborate-drops.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/3e5be57de86f3636c10ebb696d36dbe89861f383/src%2Ftest%2Fmir-opt%2Fretag.%7Bimpl%230%7D-foo_shr.SimplifyCfg-elaborate-drops.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fretag.%7Bimpl%230%7D-foo_shr.SimplifyCfg-elaborate-drops.after.mir?ref=3e5be57de86f3636c10ebb696d36dbe89861f383", "patch": "@@ -6,8 +6,8 @@ fn <impl at $DIR/retag.rs:12:1: 12:10>::foo_shr(_1: &Test, _2: &i32) -> &i32 {\n     let mut _0: &i32;                    // return place in scope 0 at $DIR/retag.rs:+0:42: +0:49\n \n     bb0: {\n-        Retag([fn entry] _1);            // scope 0 at $DIR/retag.rs:+0:5: +2:6\n-        Retag([fn entry] _2);            // scope 0 at $DIR/retag.rs:+0:5: +2:6\n+        Retag([fn entry] _1);            // scope 0 at $DIR/retag.rs:+0:20: +0:25\n+        Retag([fn entry] _2);            // scope 0 at $DIR/retag.rs:+0:27: +0:28\n         _0 = _2;                         // scope 0 at $DIR/retag.rs:+1:9: +1:10\n         Retag(_0);                       // scope 0 at $DIR/retag.rs:+1:9: +1:10\n         return;                          // scope 0 at $DIR/retag.rs:+2:6: +2:6"}]}