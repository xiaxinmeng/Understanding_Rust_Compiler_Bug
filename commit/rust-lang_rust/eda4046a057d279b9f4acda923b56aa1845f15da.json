{"sha": "eda4046a057d279b9f4acda923b56aa1845f15da", "node_id": "C_kwDOAAsO6NoAKGVkYTQwNDZhMDU3ZDI3OWI5ZjRhY2RhOTIzYjU2YWExODQ1ZjE1ZGE", "commit": {"author": {"name": "Aleksei Trifonov", "email": "avrong@avrong.me", "date": "2022-04-01T17:50:27Z"}, "committer": {"name": "Aleksei Trifonov", "email": "avrong@avrong.me", "date": "2022-04-01T17:50:27Z"}, "message": "Introduce postfix item types", "tree": {"sha": "3ba6ee15868c10d16c5c4b9ccface0e00a348f89", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ba6ee15868c10d16c5c4b9ccface0e00a348f89"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eda4046a057d279b9f4acda923b56aa1845f15da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eda4046a057d279b9f4acda923b56aa1845f15da", "html_url": "https://github.com/rust-lang/rust/commit/eda4046a057d279b9f4acda923b56aa1845f15da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eda4046a057d279b9f4acda923b56aa1845f15da/comments", "author": {"login": "avrong", "id": 6342851, "node_id": "MDQ6VXNlcjYzNDI4NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/6342851?v=4", "gravatar_id": "", "url": "https://api.github.com/users/avrong", "html_url": "https://github.com/avrong", "followers_url": "https://api.github.com/users/avrong/followers", "following_url": "https://api.github.com/users/avrong/following{/other_user}", "gists_url": "https://api.github.com/users/avrong/gists{/gist_id}", "starred_url": "https://api.github.com/users/avrong/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/avrong/subscriptions", "organizations_url": "https://api.github.com/users/avrong/orgs", "repos_url": "https://api.github.com/users/avrong/repos", "events_url": "https://api.github.com/users/avrong/events{/privacy}", "received_events_url": "https://api.github.com/users/avrong/received_events", "type": "User", "site_admin": false}, "committer": {"login": "avrong", "id": 6342851, "node_id": "MDQ6VXNlcjYzNDI4NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/6342851?v=4", "gravatar_id": "", "url": "https://api.github.com/users/avrong", "html_url": "https://github.com/avrong", "followers_url": "https://api.github.com/users/avrong/followers", "following_url": "https://api.github.com/users/avrong/following{/other_user}", "gists_url": "https://api.github.com/users/avrong/gists{/gist_id}", "starred_url": "https://api.github.com/users/avrong/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/avrong/subscriptions", "organizations_url": "https://api.github.com/users/avrong/orgs", "repos_url": "https://api.github.com/users/avrong/repos", "events_url": "https://api.github.com/users/avrong/events{/privacy}", "received_events_url": "https://api.github.com/users/avrong/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41d8369d1cbd91e26a3d45164869006cb3629f79", "url": "https://api.github.com/repos/rust-lang/rust/commits/41d8369d1cbd91e26a3d45164869006cb3629f79", "html_url": "https://github.com/rust-lang/rust/commit/41d8369d1cbd91e26a3d45164869006cb3629f79"}], "stats": {"total": 83, "additions": 50, "deletions": 33}, "files": [{"sha": "302694ea7cf279c97c2eadbce19929a130134aa3", "filename": "crates/ide_completion/src/completions/postfix.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpostfix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpostfix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpostfix.rs?ref=eda4046a057d279b9f4acda923b56aa1845f15da", "patch": "@@ -12,9 +12,11 @@ use syntax::{\n use text_edit::TextEdit;\n \n use crate::{\n-    completions::postfix::format_like::add_format_like_completions, context::CompletionContext,\n-    item::Builder, patterns::ImmediateLocation, CompletionItem, CompletionItemKind,\n-    CompletionRelevance, Completions, SnippetScope,\n+    completions::postfix::format_like::add_format_like_completions,\n+    context::CompletionContext,\n+    item::{Builder, CompletionRelevancePostfixMatch},\n+    patterns::ImmediateLocation,\n+    CompletionItem, CompletionItemKind, CompletionRelevance, Completions, SnippetScope,\n };\n \n pub(crate) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n@@ -240,11 +242,12 @@ fn build_postfix_snippet_builder<'ctx>(\n             let mut item =\n                 CompletionItem::new(CompletionItemKind::Snippet, ctx.source_range(), label);\n             item.detail(detail).snippet_edit(cap, edit);\n-            let relevance = if ctx.original_token.text() == label {\n-                CompletionRelevance { exact_postfix_snippet_match: true, ..Default::default() }\n+            let postfix_match = if ctx.original_token.text() == label {\n+                Some(CompletionRelevancePostfixMatch::Exact)\n             } else {\n-                CompletionRelevance { is_postfix: true, ..Default::default() }\n+                Some(CompletionRelevancePostfixMatch::NonExact)\n             };\n+            let relevance = CompletionRelevance { postfix_match, ..Default::default() };\n             item.set_relevance(relevance);\n             item\n         }"}, {"sha": "4b8210de0b151f0dcd84375dbd3dacc271c7610f", "filename": "crates/ide_completion/src/completions/record.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Frecord.rs?ref=eda4046a057d279b9f4acda923b56aa1845f15da", "patch": "@@ -4,7 +4,7 @@ use syntax::{ast::Expr, T};\n \n use crate::{\n     patterns::ImmediateLocation, CompletionContext, CompletionItem, CompletionItemKind,\n-    CompletionRelevance, Completions,\n+    CompletionRelevance, CompletionRelevancePostfixMatch, Completions,\n };\n \n pub(crate) fn complete_record(acc: &mut Completions, ctx: &CompletionContext) -> Option<()> {\n@@ -45,7 +45,7 @@ pub(crate) fn complete_record(acc: &mut Completions, ctx: &CompletionContext) ->\n                     let completion_text =\n                         completion_text.strip_prefix(ctx.token.text()).unwrap_or(completion_text);\n                     item.insert_text(completion_text).set_relevance(CompletionRelevance {\n-                        exact_postfix_snippet_match: true,\n+                        postfix_match: Some(CompletionRelevancePostfixMatch::Exact),\n                         ..Default::default()\n                     });\n                     item.add_to(acc);"}, {"sha": "89cbddbad36b05bbd5769339411d3fc09db61b67", "filename": "crates/ide_completion/src/item.rs", "status": "modified", "additions": 27, "deletions": 16, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fitem.rs?ref=eda4046a057d279b9f4acda923b56aa1845f15da", "patch": "@@ -143,17 +143,8 @@ pub struct CompletionRelevance {\n     pub is_op_method: bool,\n     /// Set for item completions that are private but in the workspace.\n     pub is_private_editable: bool,\n-    /// This is set in cases like these:\n-    ///\n-    /// ```\n-    /// (a > b).not$0\n-    /// ```\n-    ///\n-    /// Basically, we want to guarantee that postfix snippets always takes\n-    /// precedence over everything else.\n-    pub exact_postfix_snippet_match: bool,\n-    /// Set in cases when item is postfix, but not exact\n-    pub is_postfix: bool,\n+    /// Set for postfix snippet item completions\n+    pub postfix_match: Option<CompletionRelevancePostfixMatch>,\n }\n \n #[derive(Debug, Clone, Copy, Eq, PartialEq)]\n@@ -180,6 +171,21 @@ pub enum CompletionRelevanceTypeMatch {\n     Exact,\n }\n \n+#[derive(Debug, Clone, Copy, Eq, PartialEq)]\n+pub enum CompletionRelevancePostfixMatch {\n+    /// Set in cases when item is postfix, but not exact\n+    NonExact,\n+    /// This is set in cases like these:\n+    ///\n+    /// ```\n+    /// (a > b).not$0\n+    /// ```\n+    ///\n+    /// Basically, we want to guarantee that postfix snippets always takes\n+    /// precedence over everything else.\n+    Exact,\n+}\n+\n impl CompletionRelevance {\n     const BASE_LINE: u32 = 3;\n     /// Provides a relevance score. Higher values are more relevant.\n@@ -201,7 +207,7 @@ impl CompletionRelevance {\n         if self.is_private_editable {\n             score -= 1;\n         }\n-        if self.is_postfix {\n+        if self.postfix_match.is_some() {\n             score -= 3;\n         }\n \n@@ -217,7 +223,7 @@ impl CompletionRelevance {\n         if self.is_local {\n             score += 1;\n         }\n-        if self.exact_postfix_snippet_match {\n+        if self.postfix_match == Some(CompletionRelevancePostfixMatch::Exact) {\n             score += 100;\n         }\n \n@@ -536,7 +542,9 @@ mod tests {\n     use itertools::Itertools;\n     use test_utils::assert_eq_text;\n \n-    use super::{CompletionRelevance, CompletionRelevanceTypeMatch};\n+    use super::{\n+        CompletionRelevance, CompletionRelevancePostfixMatch, CompletionRelevanceTypeMatch,\n+    };\n \n     /// Check that these are CompletionRelevance are sorted in ascending order\n     /// by their relevance score.\n@@ -579,7 +587,10 @@ mod tests {\n         // This test asserts that the relevance score for these items is ascending, and\n         // that any items in the same vec have the same score.\n         let expected_relevance_order = vec![\n-            vec![CompletionRelevance { is_postfix: true, ..CompletionRelevance::default() }],\n+            vec![CompletionRelevance {\n+                postfix_match: Some(CompletionRelevancePostfixMatch::NonExact),\n+                ..CompletionRelevance::default()\n+            }],\n             vec![CompletionRelevance {\n                 is_op_method: true,\n                 is_private_editable: true,\n@@ -619,7 +630,7 @@ mod tests {\n                 ..CompletionRelevance::default()\n             }],\n             vec![CompletionRelevance {\n-                exact_postfix_snippet_match: true,\n+                postfix_match: Some(CompletionRelevancePostfixMatch::Exact),\n                 ..CompletionRelevance::default()\n             }],\n         ];"}, {"sha": "c2880e4c672c6c0a03a01f16ca02db4350af8c80", "filename": "crates/ide_completion/src/lib.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Flib.rs?ref=eda4046a057d279b9f4acda923b56aa1845f15da", "patch": "@@ -28,7 +28,10 @@ use crate::{completions::Completions, context::CompletionContext};\n \n pub use crate::{\n     config::CompletionConfig,\n-    item::{CompletionItem, CompletionItemKind, CompletionRelevance, ImportEdit},\n+    item::{\n+        CompletionItem, CompletionItemKind, CompletionRelevance, CompletionRelevancePostfixMatch,\n+        ImportEdit,\n+    },\n     snippet::{Snippet, SnippetScope},\n };\n "}, {"sha": "a18c064960e84856f3532cddc8e3123185c726c0", "filename": "crates/ide_completion/src/render.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eda4046a057d279b9f4acda923b56aa1845f15da/crates%2Fide_completion%2Fsrc%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender.rs?ref=eda4046a057d279b9f4acda923b56aa1845f15da", "patch": "@@ -365,7 +365,7 @@ mod tests {\n     use crate::{\n         item::CompletionRelevanceTypeMatch,\n         tests::{check_edit, do_completion, get_all_items, TEST_CONFIG},\n-        CompletionItem, CompletionItemKind, CompletionRelevance,\n+        CompletionItem, CompletionItemKind, CompletionRelevance, CompletionRelevancePostfixMatch,\n     };\n \n     #[track_caller]\n@@ -432,7 +432,10 @@ mod tests {\n                 ),\n                 (relevance.exact_name_match, \"name\"),\n                 (relevance.is_local, \"local\"),\n-                (relevance.exact_postfix_snippet_match, \"snippet\"),\n+                (\n+                    relevance.postfix_match == Some(CompletionRelevancePostfixMatch::Exact),\n+                    \"snippet\",\n+                ),\n                 (relevance.is_op_method, \"op_method\"),\n             ]\n             .into_iter()\n@@ -614,8 +617,7 @@ fn main() { let _: m::Spam = S$0 }\n                             is_local: false,\n                             is_op_method: false,\n                             is_private_editable: false,\n-                            exact_postfix_snippet_match: false,\n-                            is_postfix: false,\n+                            postfix_match: None,\n                         },\n                     },\n                     CompletionItem {\n@@ -636,8 +638,7 @@ fn main() { let _: m::Spam = S$0 }\n                             is_local: false,\n                             is_op_method: false,\n                             is_private_editable: false,\n-                            exact_postfix_snippet_match: false,\n-                            is_postfix: false,\n+                            postfix_match: None,\n                         },\n                     },\n                 ]\n@@ -724,8 +725,7 @@ fn foo() { A { the$0 } }\n                             is_local: false,\n                             is_op_method: false,\n                             is_private_editable: false,\n-                            exact_postfix_snippet_match: false,\n-                            is_postfix: false,\n+                            postfix_match: None,\n                         },\n                     },\n                 ]"}]}