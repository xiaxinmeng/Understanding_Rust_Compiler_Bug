{"sha": "e4ca952be655b5b5c3426ac47d9f3cac66b0a642", "node_id": "C_kwDOAAsO6NoAKGU0Y2E5NTJiZTY1NWI1YjVjMzQyNmFjNDdkOWYzY2FjNjZiMGE2NDI", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-10-25T15:33:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-25T15:33:41Z"}, "message": "Merge #10633\n\n10633: fix: Implement most proc_macro span handling for other ABIs r=Veykril a=Veykril\n\nFollow up to #10378\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "1a8d181e20c25134d5b660dd0f5a6aa161c1fe90", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a8d181e20c25134d5b660dd0f5a6aa161c1fe90"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e4ca952be655b5b5c3426ac47d9f3cac66b0a642", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhds5VCRBK7hj4Ov3rIwAAsxkIABCLR1SpwEx86BuynRZoaOYF\n4SHjN9uJSkZ+uEIlG+0OS3uiYNZqYvN6ohFpND6n84iI33GCGJUhzuYm/1R1XSDx\nsvP4U9Cy0kQiy+3mZ74MpSR1xuCnN1E/fiOpIrN0WZO1IddcARn1mL7B5ySduRC5\n3dxK991+uyEUbzKfRyFi8vpvflWCqM8HJ6joX9G+AQ9loRzE3zdRF21W/jpbyQRG\nTcG+0ClZrdQThrfEvrK2M2m1EShJiMA3tJAp+u/ZhMbzddqkjxinJsFe9ImQdESf\nqb82gMKTOs8ZoE/5dRMEF5sjDY+lu1q7IBVTjM40NzS2w4Bw8gjCkoIpXm96ezQ=\n=Qyk5\n-----END PGP SIGNATURE-----\n", "payload": "tree 1a8d181e20c25134d5b660dd0f5a6aa161c1fe90\nparent aa04d3eb4fbde4eb21b1d921b3075c932e6930d4\nparent d2b8ca9b521af2f947fd2a7d5e803b9045b2e6c0\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1635176021 +0000\ncommitter GitHub <noreply@github.com> 1635176021 +0000\n\nMerge #10633\n\n10633: fix: Implement most proc_macro span handling for other ABIs r=Veykril a=Veykril\n\nFollow up to #10378\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e4ca952be655b5b5c3426ac47d9f3cac66b0a642", "html_url": "https://github.com/rust-lang/rust/commit/e4ca952be655b5b5c3426ac47d9f3cac66b0a642", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e4ca952be655b5b5c3426ac47d9f3cac66b0a642/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aa04d3eb4fbde4eb21b1d921b3075c932e6930d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/aa04d3eb4fbde4eb21b1d921b3075c932e6930d4", "html_url": "https://github.com/rust-lang/rust/commit/aa04d3eb4fbde4eb21b1d921b3075c932e6930d4"}, {"sha": "d2b8ca9b521af2f947fd2a7d5e803b9045b2e6c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2b8ca9b521af2f947fd2a7d5e803b9045b2e6c0", "html_url": "https://github.com/rust-lang/rust/commit/d2b8ca9b521af2f947fd2a7d5e803b9045b2e6c0"}], "stats": {"total": 82, "additions": 40, "deletions": 42}, "files": [{"sha": "d3d021d808f025435d7d37c611cbf61d13781519", "filename": "crates/proc_macro_srv/src/abis/abi_1_47/rustc_server.rs", "status": "modified", "additions": 20, "deletions": 21, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/e4ca952be655b5b5c3426ac47d9f3cac66b0a642/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fabi_1_47%2Frustc_server.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4ca952be655b5b5c3426ac47d9f3cac66b0a642/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fabi_1_47%2Frustc_server.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fabi_1_47%2Frustc_server.rs?ref=e4ca952be655b5b5c3426ac47d9f3cac66b0a642", "patch": "@@ -423,19 +423,20 @@ impl server::Group for Rustc {\n         group.delimiter.map(|it| it.id).unwrap_or_else(tt::TokenId::unspecified)\n     }\n \n-    fn set_span(&mut self, _group: &mut Self::Group, _span: Self::Span) {\n-        // FIXME handle span\n+    fn set_span(&mut self, group: &mut Self::Group, span: Self::Span) {\n+        if let Some(delim) = &mut group.delimiter {\n+            delim.id = span;\n+        }\n     }\n \n-    fn span_open(&mut self, _group: &Self::Group) -> Self::Span {\n-        // FIXME handle span\n-        // MySpan(self.span_interner.intern(&MySpanData(group.span_open())))\n-        tt::TokenId::unspecified()\n+    fn span_open(&mut self, group: &Self::Group) -> Self::Span {\n+        // FIXME we only store one `TokenId` for the delimiters\n+        group.delimiter.map(|it| it.id).unwrap_or_else(tt::TokenId::unspecified)\n     }\n \n-    fn span_close(&mut self, _group: &Self::Group) -> Self::Span {\n-        // FIXME handle span\n-        tt::TokenId::unspecified()\n+    fn span_close(&mut self, group: &Self::Group) -> Self::Span {\n+        // FIXME we only store one `TokenId` for the delimiters\n+        group.delimiter.map(|it| it.id).unwrap_or_else(tt::TokenId::unspecified)\n     }\n }\n \n@@ -453,13 +454,11 @@ impl server::Punct for Rustc {\n     fn spacing(&mut self, punct: Self::Punct) -> bridge::Spacing {\n         spacing_to_external(punct.spacing)\n     }\n-    fn span(&mut self, _punct: Self::Punct) -> Self::Span {\n-        // FIXME handle span\n-        tt::TokenId::unspecified()\n+    fn span(&mut self, punct: Self::Punct) -> Self::Span {\n+        punct.id\n     }\n-    fn with_span(&mut self, punct: Self::Punct, _span: Self::Span) -> Self::Punct {\n-        // FIXME handle span\n-        punct\n+    fn with_span(&mut self, punct: Self::Punct, span: Self::Span) -> Self::Punct {\n+        tt::Punct { id: span, ..punct }\n     }\n }\n \n@@ -473,13 +472,13 @@ impl server::Ident for Rustc {\n         )\n     }\n \n-    fn span(&mut self, _ident: Self::Ident) -> Self::Span {\n-        // FIXME handle span\n-        tt::TokenId::unspecified()\n+    fn span(&mut self, ident: Self::Ident) -> Self::Span {\n+        self.ident_interner.get(ident.0).0.id\n     }\n-    fn with_span(&mut self, ident: Self::Ident, _span: Self::Span) -> Self::Ident {\n-        // FIXME handle span\n-        ident\n+    fn with_span(&mut self, ident: Self::Ident, span: Self::Span) -> Self::Ident {\n+        let data = self.ident_interner.get(ident.0);\n+        let new = IdentData(tt::Ident { id: span, ..data.0.clone() });\n+        IdentId(self.ident_interner.intern(&new))\n     }\n }\n "}, {"sha": "f8626c5f62f3eafa7e4c0ac9ad5d37f715e09bdd", "filename": "crates/proc_macro_srv/src/abis/abi_1_55/rustc_server.rs", "status": "modified", "additions": 20, "deletions": 21, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/e4ca952be655b5b5c3426ac47d9f3cac66b0a642/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fabi_1_55%2Frustc_server.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4ca952be655b5b5c3426ac47d9f3cac66b0a642/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fabi_1_55%2Frustc_server.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fabi_1_55%2Frustc_server.rs?ref=e4ca952be655b5b5c3426ac47d9f3cac66b0a642", "patch": "@@ -423,19 +423,20 @@ impl server::Group for Rustc {\n         group.delimiter.map(|it| it.id).unwrap_or_else(tt::TokenId::unspecified)\n     }\n \n-    fn set_span(&mut self, _group: &mut Self::Group, _span: Self::Span) {\n-        // FIXME handle span\n+    fn set_span(&mut self, group: &mut Self::Group, span: Self::Span) {\n+        if let Some(delim) = &mut group.delimiter {\n+            delim.id = span;\n+        }\n     }\n \n-    fn span_open(&mut self, _group: &Self::Group) -> Self::Span {\n-        // FIXME handle span\n-        // MySpan(self.span_interner.intern(&MySpanData(group.span_open())))\n-        tt::TokenId::unspecified()\n+    fn span_open(&mut self, group: &Self::Group) -> Self::Span {\n+        // FIXME we only store one `TokenId` for the delimiters\n+        group.delimiter.map(|it| it.id).unwrap_or_else(tt::TokenId::unspecified)\n     }\n \n-    fn span_close(&mut self, _group: &Self::Group) -> Self::Span {\n-        // FIXME handle span\n-        tt::TokenId::unspecified()\n+    fn span_close(&mut self, group: &Self::Group) -> Self::Span {\n+        // FIXME we only store one `TokenId` for the delimiters\n+        group.delimiter.map(|it| it.id).unwrap_or_else(tt::TokenId::unspecified)\n     }\n }\n \n@@ -453,13 +454,11 @@ impl server::Punct for Rustc {\n     fn spacing(&mut self, punct: Self::Punct) -> bridge::Spacing {\n         spacing_to_external(punct.spacing)\n     }\n-    fn span(&mut self, _punct: Self::Punct) -> Self::Span {\n-        // FIXME handle span\n-        tt::TokenId::unspecified()\n+    fn span(&mut self, punct: Self::Punct) -> Self::Span {\n+        punct.id\n     }\n-    fn with_span(&mut self, punct: Self::Punct, _span: Self::Span) -> Self::Punct {\n-        // FIXME handle span\n-        punct\n+    fn with_span(&mut self, punct: Self::Punct, span: Self::Span) -> Self::Punct {\n+        tt::Punct { id: span, ..punct }\n     }\n }\n \n@@ -473,13 +472,13 @@ impl server::Ident for Rustc {\n         )\n     }\n \n-    fn span(&mut self, _ident: Self::Ident) -> Self::Span {\n-        // FIXME handle span\n-        tt::TokenId::unspecified()\n+    fn span(&mut self, ident: Self::Ident) -> Self::Span {\n+        self.ident_interner.get(ident.0).0.id\n     }\n-    fn with_span(&mut self, ident: Self::Ident, _span: Self::Span) -> Self::Ident {\n-        // FIXME handle span\n-        ident\n+    fn with_span(&mut self, ident: Self::Ident, span: Self::Span) -> Self::Ident {\n+        let data = self.ident_interner.get(ident.0);\n+        let new = IdentData(tt::Ident { id: span, ..data.0.clone() });\n+        IdentId(self.ident_interner.intern(&new))\n     }\n }\n "}]}