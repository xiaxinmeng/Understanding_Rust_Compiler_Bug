{"sha": "1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlNGMyYWU2MjI1NDkxMDhhNTVmY2JkYWVmZmRiZjZkNTZhY2UzYWM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2019-11-07T17:00:25Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2019-11-07T21:06:56Z"}, "message": "Update clang to build LLVM to 9.0.0\n\nThis also ensure that we're using the same clang version for all our\nmajor platforms instead of 8.0 on Linux and 7.0 on OSX/Windows.", "tree": {"sha": "cb3e9998d43d9fb59df11cf320e0fcb0f2f48d53", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb3e9998d43d9fb59df11cf320e0fcb0f2f48d53"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "html_url": "https://github.com/rust-lang/rust/commit/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "50f8aadd746ebc929a752e5ffb133936ee75c52f", "url": "https://api.github.com/repos/rust-lang/rust/commits/50f8aadd746ebc929a752e5ffb133936ee75c52f", "html_url": "https://github.com/rust-lang/rust/commit/50f8aadd746ebc929a752e5ffb133936ee75c52f"}], "stats": {"total": 50, "additions": 36, "deletions": 14}, "files": [{"sha": "ad675830b7799ce8b27fe8115fe28f0dbeca5dd4", "filename": "src/ci/docker/dist-i686-linux/Dockerfile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-i686-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-i686-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-i686-linux%2FDockerfile?ref=1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "patch": "@@ -69,7 +69,7 @@ RUN ./build-python.sh\n \n # Now build LLVM+Clang 7, afterwards configuring further compilations to use the\n # clang/clang++ compilers.\n-COPY dist-x86_64-linux/build-clang.sh /tmp/\n+COPY dist-x86_64-linux/build-clang.sh dist-x86_64-linux/llvm-project-centos.patch /tmp/\n RUN ./build-clang.sh\n ENV CC=clang CXX=clang++\n "}, {"sha": "2f2a10a0e90ae58c8c562041c290622c19699695", "filename": "src/ci/docker/dist-x86_64-linux/Dockerfile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2FDockerfile?ref=1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "patch": "@@ -69,7 +69,7 @@ RUN ./build-python.sh\n \n # Now build LLVM+Clang 7, afterwards configuring further compilations to use the\n # clang/clang++ compilers.\n-COPY dist-x86_64-linux/build-clang.sh /tmp/\n+COPY dist-x86_64-linux/build-clang.sh dist-x86_64-linux/llvm-project-centos.patch /tmp/\n RUN ./build-clang.sh\n ENV CC=clang CXX=clang++\n "}, {"sha": "518f6ef9b701dc249c0924788856f2d78905192e", "filename": "src/ci/docker/dist-x86_64-linux/build-clang.sh", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2Fbuild-clang.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2Fbuild-clang.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2Fbuild-clang.sh?ref=1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "patch": "@@ -4,14 +4,17 @@ set -ex\n \n source shared.sh\n \n-LLVM=llvmorg-8.0.0-rc2\n+LLVM=llvmorg-9.0.0\n \n mkdir llvm-project\n cd llvm-project\n \n curl -L https://github.com/llvm/llvm-project/archive/$LLVM.tar.gz | \\\n   tar xzf - --strip-components=1\n \n+yum install -y patch\n+patch -Np1 < ../llvm-project-centos.patch\n+\n mkdir clang-build\n cd clang-build\n "}, {"sha": "52650062cc4026cae473dabfdcb91c89bf90c819", "filename": "src/ci/docker/dist-x86_64-linux/llvm-project-centos.patch", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2Fllvm-project-centos.patch", "raw_url": "https://github.com/rust-lang/rust/raw/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2Fllvm-project-centos.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-x86_64-linux%2Fllvm-project-centos.patch?ref=1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "patch": "@@ -0,0 +1,18 @@\n+diff --git a/clang/lib/DirectoryWatcher/linux/DirectoryWatcher-linux.cpp b/clang/lib/DirectoryWatcher/linux/DirectoryWatcher-linux.cpp\n+index 176d6d6abf3..a6d63bf24b8 100644\n+--- a/clang/lib/DirectoryWatcher/linux/DirectoryWatcher-linux.cpp\n++++ b/clang/lib/DirectoryWatcher/linux/DirectoryWatcher-linux.cpp\n+@@ -33,6 +33,13 @@ namespace {\n+ using namespace llvm;\n+ using namespace clang;\n+ \n++#define EPOLL_CLOEXEC -1\n++#define IN_CLOEXEC -1\n++#define O_CLOEXEC -1\n++static int epoll_create1(int flags) { return -1; }\n++static int inotify_init1(int flags) { return -1; }\n++static int pipe2(int *fds, int flags) { return -1; }\n++\n+ /// Pipe for inter-thread synchronization - for epoll-ing on multiple\n+ /// conditions. It is meant for uni-directional 1:1 signalling - specifically:\n+ /// no multiple consumers, no data passing. Thread waiting for signal should"}, {"sha": "b1e9bf92ca5d2444b284c741b40aa908e595b3e9", "filename": "src/ci/scripts/install-clang.sh", "status": "modified", "additions": 12, "deletions": 11, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fscripts%2Finstall-clang.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac/src%2Fci%2Fscripts%2Finstall-clang.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Finstall-clang.sh?ref=1e4c2ae622549108a55fcbdaeffdbf6d56ace3ac", "patch": "@@ -9,10 +9,10 @@ IFS=$'\\n\\t'\n source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n \n if isMacOS; then\n-    curl -f \"${MIRRORS_BASE}/clang%2Bllvm-7.0.0-x86_64-apple-darwin.tar.xz\" | tar xJf -\n+    curl -f \"${MIRRORS_BASE}/clang%2Bllvm-9.0.0-x86_64-darwin-apple.tar.xz\" | tar xJf -\n \n-    ciCommandSetEnv CC \"$(pwd)/clang+llvm-7.0.0-x86_64-apple-darwin/bin/clang\"\n-    ciCommandSetEnv CXX \"$(pwd)/clang+llvm-7.0.0-x86_64-apple-darwin/bin/clang++\"\n+    ciCommandSetEnv CC \"$(pwd)/clang+llvm-9.0.0-x86_64-darwin-apple/bin/clang\"\n+    ciCommandSetEnv CXX \"$(pwd)/clang+llvm-9.0.0-x86_64-darwin-apple/bin/clang++\"\n \n     # Configure `AR` specifically so rustbuild doesn't try to infer it as\n     # `clang-ar` by accident.\n@@ -27,17 +27,18 @@ elif isWindows && [[ -z ${MINGW_URL+x} ]]; then\n     # Note that the LLVM installer is an NSIS installer\n     #\n     # Original downloaded here came from\n-    # http://releases.llvm.org/7.0.0/LLVM-7.0.0-win64.exe\n-    # That installer was run through `wine` on Linux and then the resulting\n-    # installation directory (found in `$HOME/.wine/drive_c/Program Files/LLVM`) was\n-    # packaged up into a tarball. We've had issues otherwise that the installer will\n-    # randomly hang, provide not a lot of useful information, pollute global state,\n-    # etc. In general the tarball is just more confined and easier to deal with when\n-    # working with various CI environments.\n+    # http://releases.llvm.org/9.0.0/LLVM-9.0.0-win64.exe\n+    # That installer was run through `wine ./installer.exe /S /NCRC` on Linux\n+    # and then the resulting installation directory (found in\n+    # `$HOME/.wine/drive_c/Program Files/LLVM`) was packaged up into a tarball.\n+    # We've had issues otherwise that the installer will randomly hang, provide\n+    # not a lot of useful information, pollute global state, etc. In general the\n+    # tarball is just more confined and easier to deal with when working with\n+    # various CI environments.\n \n     mkdir -p citools\n     cd citools\n-    curl -f \"${MIRRORS_BASE}/LLVM-7.0.0-win64.tar.gz\" | tar xzf -\n+    curl -f \"${MIRRORS_BASE}/LLVM-9.0.0-win64.tar.gz\" | tar xzf -\n     ciCommandSetEnv RUST_CONFIGURE_ARGS \\\n         \"${RUST_CONFIGURE_ARGS} --set llvm.clang-cl=$(pwd)/clang-rust/bin/clang-cl.exe\"\n fi"}]}