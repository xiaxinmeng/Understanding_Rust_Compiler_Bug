{"sha": "2496628c56415f4456803e4487f90bad96337d57", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0OTY2MjhjNTY0MTVmNDQ1NjgwM2U0NDg3ZjkwYmFkOTYzMzdkNTc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-30T15:29:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-30T15:29:05Z"}, "message": "Merge #5600\n\n5600: Finalize structs grammar r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "869f53eae0bf8b27c43ab7b8722a061d680b7d86", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/869f53eae0bf8b27c43ab7b8722a061d680b7d86"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2496628c56415f4456803e4487f90bad96337d57", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfIudBCRBK7hj4Ov3rIwAAdHIIAE1BOg4C1XXtNi/7T0BmREhw\nlCmwGjV+KXanWUvsAoznAsOziw+mHXukgqTCgqqSWZxHhymyLRAyt2nO3dyjK+LU\nj2j2xBv8HERKIscT1Xth5lvCFWKOmVW0LSaPUsRGgCZ+W1Cr5y6M6+MeTzKIpWjD\nU4w6ejaPz+yLZarudFMsvJ7ul4DyYDDpJPQL3Ps0kFbrMWtJMsVwLxZbOmgw5ruT\nD0G7ldDj3SeMs6hwYTuO03dwWcLuFEhxjlINKcnUIXcLlxRVrYZIbRjuhoT2pXJ8\navLWQBntMBm8MR8q49nzakLJ9GmY4nqgy4PuVfoyxsvUcJGDMdUquJTXTCF5SHs=\n=zUfc\n-----END PGP SIGNATURE-----\n", "payload": "tree 869f53eae0bf8b27c43ab7b8722a061d680b7d86\nparent 61d9d6caf89dd59af5435adecb5c76fe0bba42a1\nparent 8ddbf06e39a13ed3f45e57d77727b7a35cec1749\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1596122945 +0000\ncommitter GitHub <noreply@github.com> 1596122945 +0000\n\nMerge #5600\n\n5600: Finalize structs grammar r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2496628c56415f4456803e4487f90bad96337d57", "html_url": "https://github.com/rust-lang/rust/commit/2496628c56415f4456803e4487f90bad96337d57", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2496628c56415f4456803e4487f90bad96337d57/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61d9d6caf89dd59af5435adecb5c76fe0bba42a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/61d9d6caf89dd59af5435adecb5c76fe0bba42a1", "html_url": "https://github.com/rust-lang/rust/commit/61d9d6caf89dd59af5435adecb5c76fe0bba42a1"}, {"sha": "8ddbf06e39a13ed3f45e57d77727b7a35cec1749", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ddbf06e39a13ed3f45e57d77727b7a35cec1749", "html_url": "https://github.com/rust-lang/rust/commit/8ddbf06e39a13ed3f45e57d77727b7a35cec1749"}], "stats": {"total": 70, "additions": 29, "deletions": 41}, "files": [{"sha": "1776fb6e6948b38be8511a3ba029fece2f857019", "filename": "crates/ra_syntax/src/ast/generated/nodes.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2496628c56415f4456803e4487f90bad96337d57/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2496628c56415f4456803e4487f90bad96337d57/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs?ref=2496628c56415f4456803e4487f90bad96337d57", "patch": "@@ -422,7 +422,6 @@ pub struct TupleField {\n     pub(crate) syntax: SyntaxNode,\n }\n impl ast::AttrsOwner for TupleField {}\n-impl ast::NameOwner for TupleField {}\n impl ast::VisibilityOwner for TupleField {}\n impl TupleField {\n     pub fn type_ref(&self) -> Option<TypeRef> { support::child(&self.syntax) }"}, {"sha": "47e9d0c215808198c221c293b1adea0902bc2dbc", "filename": "xtask/src/ast_src.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2496628c56415f4456803e4487f90bad96337d57/xtask%2Fsrc%2Fast_src.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2496628c56415f4456803e4487f90bad96337d57/xtask%2Fsrc%2Fast_src.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fast_src.rs?ref=2496628c56415f4456803e4487f90bad96337d57", "patch": "@@ -242,11 +242,11 @@ pub(crate) struct AstNodeSrc {\n #[derive(Debug, Eq, PartialEq)]\n pub(crate) enum Field {\n     Token(String),\n-    Node { name: String, ty: String, valence: Valence },\n+    Node { name: String, ty: String, cardinality: Cardinality },\n }\n \n #[derive(Debug, Eq, PartialEq)]\n-pub(crate) enum Valence {\n+pub(crate) enum Cardinality {\n     Optional,\n     Many,\n }"}, {"sha": "84ddda5cb72712e8ad013ca8e1c459a78ed16d17", "filename": "xtask/src/codegen/gen_syntax.rs", "status": "modified", "additions": 24, "deletions": 34, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/2496628c56415f4456803e4487f90bad96337d57/xtask%2Fsrc%2Fcodegen%2Fgen_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2496628c56415f4456803e4487f90bad96337d57/xtask%2Fsrc%2Fcodegen%2Fgen_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fcodegen%2Fgen_syntax.rs?ref=2496628c56415f4456803e4487f90bad96337d57", "patch": "@@ -13,7 +13,7 @@ use quote::{format_ident, quote};\n use ungrammar::{Grammar, Rule};\n \n use crate::{\n-    ast_src::{AstEnumSrc, AstNodeSrc, AstSrc, Field, KindsSrc, Valence, KINDS_SRC},\n+    ast_src::{AstEnumSrc, AstNodeSrc, AstSrc, Cardinality, Field, KindsSrc, KINDS_SRC},\n     codegen::{self, update, Mode},\n     project_root, Result,\n };\n@@ -431,7 +431,7 @@ fn pluralize(s: &str) -> String {\n \n impl Field {\n     fn is_many(&self) -> bool {\n-        matches!(self, Field::Node { valence: Valence::Many, .. })\n+        matches!(self, Field::Node { cardinality: Cardinality::Many, .. })\n     }\n     fn token_kind(&self) -> Option<proc_macro2::TokenStream> {\n         match self {\n@@ -509,7 +509,7 @@ fn lower(grammar: &Grammar) -> AstSrc {\n             }\n             None => {\n                 let mut fields = Vec::new();\n-                lower_rule(&mut fields, grammar, rule);\n+                lower_rule(&mut fields, grammar, None, rule);\n                 res.nodes.push(AstNodeSrc { doc: Vec::new(), name, traits: Vec::new(), fields });\n             }\n         }\n@@ -537,19 +537,20 @@ fn lower_enum(grammar: &Grammar, rule: &Rule) -> Option<Vec<String>> {\n     Some(variants)\n }\n \n-fn lower_rule(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) {\n-    if lower_comma_list(acc, grammar, rule) {\n+fn lower_rule(acc: &mut Vec<Field>, grammar: &Grammar, label: Option<&String>, rule: &Rule) {\n+    if lower_comma_list(acc, grammar, label, rule) {\n         return;\n     }\n \n     match rule {\n         Rule::Node(node) => {\n             let ty = grammar[*node].name.clone();\n-            let name = to_lower_snake_case(&ty);\n-            let field = Field::Node { name, ty, valence: Valence::Optional };\n+            let name = label.cloned().unwrap_or_else(|| to_lower_snake_case(&ty));\n+            let field = Field::Node { name, ty, cardinality: Cardinality::Optional };\n             acc.push(field);\n         }\n         Rule::Token(token) => {\n+            assert!(label.is_none());\n             let mut name = grammar[*token].name.clone();\n             if name != \"int_number\" && name != \"string\" {\n                 if \"[]{}()\".contains(&name) {\n@@ -562,44 +563,33 @@ fn lower_rule(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) {\n         Rule::Rep(inner) => {\n             if let Rule::Node(node) = &**inner {\n                 let ty = grammar[*node].name.clone();\n-                let name = pluralize(&to_lower_snake_case(&ty));\n-                let field = Field::Node { name, ty, valence: Valence::Many };\n+                let name = label.cloned().unwrap_or_else(|| pluralize(&to_lower_snake_case(&ty)));\n+                let field = Field::Node { name, ty, cardinality: Cardinality::Many };\n                 acc.push(field);\n                 return;\n             }\n             todo!(\"{:?}\", rule)\n         }\n-        Rule::Labeled { label, rule } => {\n-            let node = match &**rule {\n-                Rule::Rep(inner) | Rule::Opt(inner) => match &**inner {\n-                    Rule::Node(node) => node,\n-                    _ => todo!(\"{:?}\", rule),\n-                },\n-                Rule::Node(node) => node,\n-                _ => todo!(\"{:?}\", rule),\n-            };\n-            let ty = grammar[*node].name.clone();\n-            let field = Field::Node {\n-                name: label.clone(),\n-                ty,\n-                valence: match &**rule {\n-                    Rule::Rep(_) => Valence::Many,\n-                    _ => Valence::Optional,\n-                },\n-            };\n-            acc.push(field);\n+        Rule::Labeled { label: l, rule } => {\n+            assert!(label.is_none());\n+            lower_rule(acc, grammar, Some(l), rule);\n         }\n         Rule::Seq(rules) | Rule::Alt(rules) => {\n             for rule in rules {\n-                lower_rule(acc, grammar, rule)\n+                lower_rule(acc, grammar, label, rule)\n             }\n         }\n-        Rule::Opt(rule) => lower_rule(acc, grammar, rule),\n+        Rule::Opt(rule) => lower_rule(acc, grammar, label, rule),\n     }\n }\n \n // (T (',' T)* ','?)\n-fn lower_comma_list(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) -> bool {\n+fn lower_comma_list(\n+    acc: &mut Vec<Field>,\n+    grammar: &Grammar,\n+    label: Option<&String>,\n+    rule: &Rule,\n+) -> bool {\n     let rule = match rule {\n         Rule::Seq(it) => it,\n         _ => return false,\n@@ -619,8 +609,8 @@ fn lower_comma_list(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) -> boo\n         _ => return false,\n     }\n     let ty = grammar[*node].name.clone();\n-    let name = pluralize(&to_lower_snake_case(&ty));\n-    let field = Field::Node { name, ty, valence: Valence::Many };\n+    let name = label.cloned().unwrap_or_else(|| pluralize(&to_lower_snake_case(&ty)));\n+    let field = Field::Node { name, ty, cardinality: Cardinality::Many };\n     acc.push(field);\n     true\n }\n@@ -656,7 +646,7 @@ fn extract_enums(ast: &mut AstSrc) {\n                 node.remove_field(to_remove);\n                 let ty = enm.name.clone();\n                 let name = to_lower_snake_case(&ty);\n-                node.fields.push(Field::Node { name, ty, valence: Valence::Optional });\n+                node.fields.push(Field::Node { name, ty, cardinality: Cardinality::Optional });\n             }\n         }\n     }"}, {"sha": "28b50f021ac7d5e429814e4722b5820941c26e7e", "filename": "xtask/src/codegen/rust.ungram", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2496628c56415f4456803e4487f90bad96337d57/xtask%2Fsrc%2Fcodegen%2Frust.ungram", "raw_url": "https://github.com/rust-lang/rust/raw/2496628c56415f4456803e4487f90bad96337d57/xtask%2Fsrc%2Fcodegen%2Frust.ungram", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fcodegen%2Frust.ungram?ref=2496628c56415f4456803e4487f90bad96337d57", "patch": "@@ -83,22 +83,21 @@ StructDef =\n   )\n \n RecordFieldList =\n- '{' fields:RecordField* '}'\n+ '{' fields:(RecordField (',' RecordField)* ','?)? '}'\n \n RecordField =\n   Attr* Visibility? Name ':' ascribed_type:TypeRef\n \n TupleFieldList =\n-  '(' fields:TupleField* ')'\n+  '(' fields:(TupleField (',' TupleField)* ','?)? ')'\n \n TupleField =\n-  Attr* Visibility? Name TypeRef\n+  Attr* Visibility? TypeRef\n \n FieldList =\n   RecordFieldList\n | TupleFieldList\n \n-\n UnionDef =\n   Attr* Visibility? 'union' Name GenericParamList? WhereClause?\n   RecordFieldList"}]}