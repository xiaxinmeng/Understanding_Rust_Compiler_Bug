{"sha": "46aef0e37525db778d1a31dd48a0fd3678bf2b71", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2YWVmMGUzNzUyNWRiNzc4ZDFhMzFkZDQ4YTBmZDM2NzhiZjJiNzE=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-02-12T10:32:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-12T10:32:14Z"}, "message": "Rollup merge of #81990 - matsujika:suggest-mut-reference, r=estebank\n\nMake suggestion of changing mutability of arguments broader\n\nFix #81421\n\nPreviously rustc tries to emit the suggestion of changing mutablity unless `!trait_ref.has_infer_types_or_consts() && self.predicate_can_apply(obligation.param_env, trait_ref)` and this led to some false negatives to occur.", "tree": {"sha": "bbdd30b6fd994a430e8d6bfb193f6424cdc4550e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbdd30b6fd994a430e8d6bfb193f6424cdc4550e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/46aef0e37525db778d1a31dd48a0fd3678bf2b71", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgJlkvCRBK7hj4Ov3rIwAAdHIIAKcU+GQ+rTO6G4wWq4wltCL3\npNPSuapiwll6Mhcne6H34NnjPJLCaBRyq3Ju0e9s6HUCDn/H+0RL5en3ACEOSAY5\n8cv5k0rZAvW7cldgRkXf0cLdc45AquXKl56txpB8JpdSd/OCt2+bCR4YqbojikYz\nsSOuAKOEVy5sYN/aU8WqqIWIbFPxuRX6uwdEMyexsq2VvQlOoJ/QxP5txkCqJqnJ\nacDSPZ05JU9+iS+3qgcsLa3lo5aFvfIjQza0obR++bfD8NTvdbliDn7VbhiCFCWV\nUbDCndgNqAV4CX+gk+NyZzihQUOPrhFvS3LASAO97jQPaxB2oVocNLdk00kEXAQ=\n=94x0\n-----END PGP SIGNATURE-----\n", "payload": "tree bbdd30b6fd994a430e8d6bfb193f6424cdc4550e\nparent 459dda98ebdb797c233bdb01ace54b3f30b577f8\nparent e03f09730faab8083f991827f0cd02040d171d4e\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1613125934 +0900\ncommitter GitHub <noreply@github.com> 1613125934 +0900\n\nRollup merge of #81990 - matsujika:suggest-mut-reference, r=estebank\n\nMake suggestion of changing mutability of arguments broader\n\nFix #81421\n\nPreviously rustc tries to emit the suggestion of changing mutablity unless `!trait_ref.has_infer_types_or_consts() && self.predicate_can_apply(obligation.param_env, trait_ref)` and this led to some false negatives to occur.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/46aef0e37525db778d1a31dd48a0fd3678bf2b71", "html_url": "https://github.com/rust-lang/rust/commit/46aef0e37525db778d1a31dd48a0fd3678bf2b71", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/46aef0e37525db778d1a31dd48a0fd3678bf2b71/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "459dda98ebdb797c233bdb01ace54b3f30b577f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/459dda98ebdb797c233bdb01ace54b3f30b577f8", "html_url": "https://github.com/rust-lang/rust/commit/459dda98ebdb797c233bdb01ace54b3f30b577f8"}, {"sha": "e03f09730faab8083f991827f0cd02040d171d4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e03f09730faab8083f991827f0cd02040d171d4e", "html_url": "https://github.com/rust-lang/rust/commit/e03f09730faab8083f991827f0cd02040d171d4e"}], "stats": {"total": 87, "additions": 71, "deletions": 16}, "files": [{"sha": "3233d1e048bf735631dce46d97e32926fc619877", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 15, "deletions": 16, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/46aef0e37525db778d1a31dd48a0fd3678bf2b71/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46aef0e37525db778d1a31dd48a0fd3678bf2b71/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=46aef0e37525db778d1a31dd48a0fd3678bf2b71", "patch": "@@ -468,22 +468,21 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                                 trait_ref,\n                                 obligation.cause.body_id,\n                             );\n-                        } else {\n-                            if !have_alt_message {\n-                                // Can't show anything else useful, try to find similar impls.\n-                                let impl_candidates = self.find_similar_impl_candidates(trait_ref);\n-                                self.report_similar_impl_candidates(impl_candidates, &mut err);\n-                            }\n-                            // Changing mutability doesn't make a difference to whether we have\n-                            // an `Unsize` impl (Fixes ICE in #71036)\n-                            if !is_unsize {\n-                                self.suggest_change_mut(\n-                                    &obligation,\n-                                    &mut err,\n-                                    trait_ref,\n-                                    points_at_arg,\n-                                );\n-                            }\n+                        } else if !have_alt_message {\n+                            // Can't show anything else useful, try to find similar impls.\n+                            let impl_candidates = self.find_similar_impl_candidates(trait_ref);\n+                            self.report_similar_impl_candidates(impl_candidates, &mut err);\n+                        }\n+\n+                        // Changing mutability doesn't make a difference to whether we have\n+                        // an `Unsize` impl (Fixes ICE in #71036)\n+                        if !is_unsize {\n+                            self.suggest_change_mut(\n+                                &obligation,\n+                                &mut err,\n+                                trait_ref,\n+                                points_at_arg,\n+                            );\n                         }\n \n                         // If this error is due to `!: Trait` not implemented but `(): Trait` is"}, {"sha": "8b465aae66b6e6ae771cdfa9aca07c6ec5852f04", "filename": "src/test/ui/suggestions/suggest-change-mut.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/46aef0e37525db778d1a31dd48a0fd3678bf2b71/src%2Ftest%2Fui%2Fsuggestions%2Fsuggest-change-mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46aef0e37525db778d1a31dd48a0fd3678bf2b71/src%2Ftest%2Fui%2Fsuggestions%2Fsuggest-change-mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fsuggest-change-mut.rs?ref=46aef0e37525db778d1a31dd48a0fd3678bf2b71", "patch": "@@ -0,0 +1,21 @@\n+#![allow(warnings)]\n+\n+use std::io::{BufRead, BufReader, Read, Write};\n+\n+fn issue_81421<T: Read + Write>(mut stream: T) {\n+    let initial_message = format!(\"Hello world\");\n+    let mut buffer: Vec<u8> = Vec::new();\n+    let bytes_written = stream.write_all(initial_message.as_bytes());\n+    let flush = stream.flush();\n+\n+    loop {\n+        let mut stream_reader = BufReader::new(&stream);\n+        //~^ ERROR the trait bound `&T: std::io::Read` is not satisfied [E0277]\n+        //~| HELP consider removing the leading `&`-reference\n+        //~| HELP consider changing this borrow's mutability\n+        stream_reader.read_until(b'\\n', &mut buffer).expect(\"Reading into buffer failed\");\n+        //~^ ERROR the method `read_until` exists for struct `BufReader<&T>`,\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "cb156f7c7877a0cf2c24f3172d5047fa6cb0e8ca", "filename": "src/test/ui/suggestions/suggest-change-mut.stderr", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/46aef0e37525db778d1a31dd48a0fd3678bf2b71/src%2Ftest%2Fui%2Fsuggestions%2Fsuggest-change-mut.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/46aef0e37525db778d1a31dd48a0fd3678bf2b71/src%2Ftest%2Fui%2Fsuggestions%2Fsuggest-change-mut.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fsuggest-change-mut.stderr?ref=46aef0e37525db778d1a31dd48a0fd3678bf2b71", "patch": "@@ -0,0 +1,35 @@\n+error[E0277]: the trait bound `&T: std::io::Read` is not satisfied\n+  --> $DIR/suggest-change-mut.rs:12:48\n+   |\n+LL |         let mut stream_reader = BufReader::new(&stream);\n+   |                                                ^^^^^^^ the trait `std::io::Read` is not implemented for `&T`\n+   |\n+   = note: required by `BufReader::<R>::new`\n+help: consider removing the leading `&`-reference\n+   |\n+LL |         let mut stream_reader = BufReader::new(stream);\n+   |                                               --\n+help: consider changing this borrow's mutability\n+   |\n+LL |         let mut stream_reader = BufReader::new(&mut stream);\n+   |                                                ^^^^\n+\n+error[E0599]: the method `read_until` exists for struct `BufReader<&T>`, but its trait bounds were not satisfied\n+  --> $DIR/suggest-change-mut.rs:16:23\n+   |\n+LL |         stream_reader.read_until(b'\\n', &mut buffer).expect(\"Reading into buffer failed\");\n+   |                       ^^^^^^^^^^ method cannot be called on `BufReader<&T>` due to unsatisfied trait bounds\n+   | \n+  ::: $SRC_DIR/std/src/io/buffered/bufreader.rs:LL:COL\n+   |\n+LL | pub struct BufReader<R> {\n+   | ----------------------- doesn't satisfy `BufReader<&T>: BufRead`\n+   |\n+   = note: the following trait bounds were not satisfied:\n+           `&T: std::io::Read`\n+           which is required by `BufReader<&T>: BufRead`\n+\n+error: aborting due to 2 previous errors\n+\n+Some errors have detailed explanations: E0277, E0599.\n+For more information about an error, try `rustc --explain E0277`."}]}