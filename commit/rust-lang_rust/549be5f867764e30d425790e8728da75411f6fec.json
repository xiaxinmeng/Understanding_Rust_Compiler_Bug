{"sha": "549be5f867764e30d425790e8728da75411f6fec", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0OWJlNWY4Njc3NjRlMzBkNDI1NzkwZTg3MjhkYTc1NDExZjZmZWM=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-02-28T20:38:49Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-03-01T11:30:11Z"}, "message": "Emit proper function argument attributes for closure environments", "tree": {"sha": "0998a598f1b515d78e66da1b3508d7639c673da3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0998a598f1b515d78e66da1b3508d7639c673da3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/549be5f867764e30d425790e8728da75411f6fec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/549be5f867764e30d425790e8728da75411f6fec", "html_url": "https://github.com/rust-lang/rust/commit/549be5f867764e30d425790e8728da75411f6fec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/549be5f867764e30d425790e8728da75411f6fec/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a69110c3b1122596ddc8999bb2403a5777bb8ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a69110c3b1122596ddc8999bb2403a5777bb8ed", "html_url": "https://github.com/rust-lang/rust/commit/8a69110c3b1122596ddc8999bb2403a5777bb8ed"}], "stats": {"total": 18, "additions": 11, "deletions": 7}, "files": [{"sha": "9bbaa5dca95fb479bde0728325cda3b7e4f1ff1c", "filename": "src/librustc_trans/trans/base.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/549be5f867764e30d425790e8728da75411f6fec/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/549be5f867764e30d425790e8728da75411f6fec/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fbase.rs?ref=549be5f867764e30d425790e8728da75411f6fec", "patch": "@@ -2430,21 +2430,19 @@ pub fn get_fn_llvm_attributes<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>, fn_ty: Ty<\n     use middle::ty::{BrAnon, ReLateBound};\n \n     let function_type;\n-    let (fn_sig, abi, has_env) = match fn_ty.sty {\n-        ty::ty_bare_fn(_, ref f) => (&f.sig, f.abi, false),\n+    let (fn_sig, abi, env_ty) = match fn_ty.sty {\n+        ty::ty_bare_fn(_, ref f) => (&f.sig, f.abi, None),\n         ty::ty_closure(closure_did, _, substs) => {\n             let typer = common::NormalizingClosureTyper::new(ccx.tcx());\n             function_type = typer.closure_type(closure_did, substs);\n-            (&function_type.sig, RustCall, true)\n+            let self_type = self_type_for_closure(ccx, closure_did, fn_ty);\n+            (&function_type.sig, RustCall, Some(self_type))\n         }\n         _ => ccx.sess().bug(\"expected closure or function.\")\n     };\n \n     let fn_sig = ty::erase_late_bound_regions(ccx.tcx(), fn_sig);\n \n-    // Since index 0 is the return value of the llvm func, we start\n-    // at either 1 or 2 depending on whether there's an env slot or not\n-    let mut first_arg_offset = if has_env { 2 } else { 1 };\n     let mut attrs = llvm::AttrBuilder::new();\n     let ret_ty = fn_sig.output;\n \n@@ -2455,7 +2453,11 @@ pub fn get_fn_llvm_attributes<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>, fn_ty: Ty<\n             assert!(abi == RustCall);\n \n             match fn_sig.inputs[0].sty {\n-                ty::ty_tup(ref inputs) => inputs.clone(),\n+                ty::ty_tup(ref inputs) => {\n+                    let mut full_inputs = vec![env_ty.expect(\"Missing closure environment\")];\n+                    full_inputs.push_all(inputs);\n+                    full_inputs\n+                }\n                 _ => ccx.sess().bug(\"expected tuple'd inputs\")\n             }\n         },\n@@ -2473,6 +2475,8 @@ pub fn get_fn_llvm_attributes<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>, fn_ty: Ty<\n         _ => fn_sig.inputs.clone()\n     };\n \n+    // Index 0 is the return value of the llvm func, so we start at 1\n+    let mut first_arg_offset = 1;\n     if let ty::FnConverging(ret_ty) = ret_ty {\n         // A function pointer is called without the declaration\n         // available, so we have to apply any attributes with ABI"}]}