{"sha": "e28e19034ffd49a50499e96da884be3ea9a950aa", "node_id": "C_kwDOAAsO6NoAKGUyOGUxOTAzNGZmZDQ5YTUwNDk5ZTk2ZGE4ODRiZTNlYTlhOTUwYWE", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-04-16T23:07:18Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-04-16T23:09:57Z"}, "message": "Check freeze with right param-env", "tree": {"sha": "74748d055723af2d2ce1ffccf1254083bdb8cf83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74748d055723af2d2ce1ffccf1254083bdb8cf83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e28e19034ffd49a50499e96da884be3ea9a950aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e28e19034ffd49a50499e96da884be3ea9a950aa", "html_url": "https://github.com/rust-lang/rust/commit/e28e19034ffd49a50499e96da884be3ea9a950aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e28e19034ffd49a50499e96da884be3ea9a950aa/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a778ca1e35e4a8df95c00d800100d95e63e7722", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a778ca1e35e4a8df95c00d800100d95e63e7722", "html_url": "https://github.com/rust-lang/rust/commit/8a778ca1e35e4a8df95c00d800100d95e63e7722"}], "stats": {"total": 36, "additions": 34, "deletions": 2}, "files": [{"sha": "8ee08c5be3419b085febe0ed8a4b1d4a2071a101", "filename": "compiler/rustc_mir_transform/src/deduce_param_attrs.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e28e19034ffd49a50499e96da884be3ea9a950aa/compiler%2Frustc_mir_transform%2Fsrc%2Fdeduce_param_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e28e19034ffd49a50499e96da884be3ea9a950aa/compiler%2Frustc_mir_transform%2Fsrc%2Fdeduce_param_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fdeduce_param_attrs.rs?ref=e28e19034ffd49a50499e96da884be3ea9a950aa", "patch": "@@ -9,7 +9,7 @@ use rustc_hir::def_id::LocalDefId;\n use rustc_index::bit_set::BitSet;\n use rustc_middle::mir::visit::{NonMutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::{Body, Local, Location, Operand, Terminator, TerminatorKind, RETURN_PLACE};\n-use rustc_middle::ty::{self, DeducedParamAttrs, ParamEnv, Ty, TyCtxt};\n+use rustc_middle::ty::{self, DeducedParamAttrs, Ty, TyCtxt};\n use rustc_session::config::OptLevel;\n \n /// A visitor that determines which arguments have been mutated. We can't use the mutability field\n@@ -198,11 +198,12 @@ pub fn deduced_param_attrs<'tcx>(\n     // see [1].\n     //\n     // [1]: https://github.com/rust-lang/rust/pull/103172#discussion_r999139997\n+    let param_env = tcx.param_env_reveal_all_normalized(def_id);\n     let mut deduced_param_attrs = tcx.arena.alloc_from_iter(\n         body.local_decls.iter().skip(1).take(body.arg_count).enumerate().map(\n             |(arg_index, local_decl)| DeducedParamAttrs {\n                 read_only: !deduce_read_only.mutable_args.contains(arg_index)\n-                    && local_decl.ty.is_freeze(tcx, ParamEnv::reveal_all()),\n+                    && local_decl.ty.is_freeze(tcx, param_env),\n             },\n         ),\n     );"}, {"sha": "edc79f8fd94bd61ed525f7ea23aee41941eb4226", "filename": "tests/ui/codegen/freeze-on-polymorphic-projection.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e28e19034ffd49a50499e96da884be3ea9a950aa/tests%2Fui%2Fcodegen%2Ffreeze-on-polymorphic-projection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e28e19034ffd49a50499e96da884be3ea9a950aa/tests%2Fui%2Fcodegen%2Ffreeze-on-polymorphic-projection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcodegen%2Ffreeze-on-polymorphic-projection.rs?ref=e28e19034ffd49a50499e96da884be3ea9a950aa", "patch": "@@ -0,0 +1,19 @@\n+// build-pass\n+// compile-flags: -Copt-level=1 --crate-type=lib\n+\n+#![feature(specialization)]\n+//~^ WARN the feature `specialization` is incomplete\n+\n+pub unsafe trait Storage {\n+    type Handle;\n+}\n+\n+pub unsafe trait MultipleStorage: Storage {}\n+\n+default unsafe impl<S> Storage for S where S: MultipleStorage {}\n+\n+// Make sure that we call is_freeze on `(S::Handle,)` in the param-env of `ice`,\n+// instead of in an empty, reveal-all param-env.\n+pub fn ice<S: Storage>(boxed: (S::Handle,)) -> (S::Handle,) {\n+    boxed\n+}"}, {"sha": "903cb2ff6aa9874d0e24f1637fe1939bcf3e86e9", "filename": "tests/ui/codegen/freeze-on-polymorphic-projection.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e28e19034ffd49a50499e96da884be3ea9a950aa/tests%2Fui%2Fcodegen%2Ffreeze-on-polymorphic-projection.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e28e19034ffd49a50499e96da884be3ea9a950aa/tests%2Fui%2Fcodegen%2Ffreeze-on-polymorphic-projection.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcodegen%2Ffreeze-on-polymorphic-projection.stderr?ref=e28e19034ffd49a50499e96da884be3ea9a950aa", "patch": "@@ -0,0 +1,12 @@\n+warning: the feature `specialization` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/freeze-on-polymorphic-projection.rs:4:12\n+   |\n+LL | #![feature(specialization)]\n+   |            ^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #31844 <https://github.com/rust-lang/rust/issues/31844> for more information\n+   = help: consider using `min_specialization` instead, which is more stable and complete\n+   = note: `#[warn(incomplete_features)]` on by default\n+\n+warning: 1 warning emitted\n+"}]}