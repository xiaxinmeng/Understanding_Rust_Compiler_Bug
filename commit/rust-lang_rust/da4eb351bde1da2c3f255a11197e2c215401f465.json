{"sha": "da4eb351bde1da2c3f255a11197e2c215401f465", "node_id": "C_kwDOAAsO6NoAKGRhNGViMzUxYmRlMWRhMmMzZjI1NWExMTE5N2UyYzIxNTQwMWY0NjU", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-11-17T11:00:33Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-11-17T11:12:39Z"}, "message": "update josh scripts\n- support pulling specific commit\n- make rust-version update a separate commit to avoid confusing josh\n- after pushing, check that we have a clear round-trip", "tree": {"sha": "d658a221eddad902ad457bc6fa1f82f884fe2b20", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d658a221eddad902ad457bc6fa1f82f884fe2b20"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/da4eb351bde1da2c3f255a11197e2c215401f465", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/da4eb351bde1da2c3f255a11197e2c215401f465", "html_url": "https://github.com/rust-lang/rust/commit/da4eb351bde1da2c3f255a11197e2c215401f465", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/da4eb351bde1da2c3f255a11197e2c215401f465/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3de7c2834fff87c9f8a414614011e95fc67806f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/3de7c2834fff87c9f8a414614011e95fc67806f7", "html_url": "https://github.com/rust-lang/rust/commit/3de7c2834fff87c9f8a414614011e95fc67806f7"}], "stats": {"total": 40, "additions": 25, "deletions": 15}, "files": [{"sha": "fc6b6e2f4fdfdce0c85effd810f8011e788c791d", "filename": "src/tools/miri/miri", "status": "modified", "additions": 25, "deletions": 15, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/da4eb351bde1da2c3f255a11197e2c215401f465/src%2Ftools%2Fmiri%2Fmiri", "raw_url": "https://github.com/rust-lang/rust/raw/da4eb351bde1da2c3f255a11197e2c215401f465/src%2Ftools%2Fmiri%2Fmiri", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fmiri?ref=da4eb351bde1da2c3f255a11197e2c215401f465", "patch": "@@ -48,10 +48,10 @@ Update and activate the rustup toolchain 'miri' to the commit given in the\n `rustup-toolchain-install-master` must be installed for this to work. Any extra\n flags are passed to `rustup-toolchain-install-master`.\n \n-./miri rustc-pull:\n-Pull and merge Miri changes from the rustc repo. The fetched commit is stored in\n-the `rust-version` file, so the next `./miri toolchain` will install the rustc\n-we just pulled.\n+./miri rustc-pull <commit>:\n+Pull and merge Miri changes from the rustc repo. Defaults to fetching the latest\n+rustc commit. The fetched commit is stored in the `rust-version` file, so the\n+next `./miri toolchain` will install the rustc that just got pulled.\n \n ./miri rustc-push <github user> <branch>:\n Push Miri changes back to the rustc repo. This will pull a copy of the rustc\n@@ -113,18 +113,17 @@ toolchain)\n     ;;\n rustc-pull)\n     cd \"$MIRIDIR\"\n-    FETCH_COMMIT=$(git ls-remote https://github.com/rust-lang/rust/ HEAD | cut -f 1)\n-    # We can't pull from a commit with josh\n-    # (https://github.com/josh-project/josh/issues/1034), so we just hope that\n-    # nothing gets merged into rustc *during* this pull.\n-    git fetch http://localhost:8000/rust-lang/rust.git$JOSH_FILTER.git master\n-    # Just verify that `master` didn't move.\n-    if [[ $FETCH_COMMIT != $(git ls-remote https://github.com/rust-lang/rust/ HEAD | cut -f 1) ]]; then\n-        echo \"Looks like something got merged into Rust *while we were pulling*. Aborting. Please try again.\"\n+    FETCH_COMMIT=\"$1\"\n+    if [ -z \"$FETCH_COMMIT\" ]; then\n+        FETCH_COMMIT=$(git ls-remote https://github.com/rust-lang/rust/ HEAD | cut -f 1)\n     fi\n-    echo \"$FETCH_COMMIT\" > rust-version # do this *before* merging as merging will fail in case of conflicts\n+    # Update rust-version file. As a separate commit, since making it part of\n+    # the merge has confused the heck out of josh in the past.\n+    echo \"$FETCH_COMMIT\" > rust-version\n+    git commit rust-version -m \"Preparing for merge from rustc\"\n+    # Fetch given rustc commit and note down which one that was\n+    git fetch http://localhost:8000/rust-lang/rust.git@$FETCH_COMMIT$JOSH_FILTER.git\n     git merge FETCH_HEAD --no-ff -m \"Merge from rustc\"\n-    git commit rust-version --amend -m \"Merge from rustc\"\n     exit 0\n     ;;\n rustc-push)\n@@ -157,11 +156,22 @@ rustc-push)\n     fi\n     git fetch https://github.com/rust-lang/rust $BASE\n     git push https://github.com/$USER/rust $BASE:refs/heads/$BRANCH -f\n+    echo\n     # Do the actual push.\n     cd \"$MIRIDIR\"\n     echo \"Pushing Miri changes...\"\n     git push http://localhost:8000/$USER/rust.git$JOSH_FILTER.git HEAD:$BRANCH\n-    exit 0\n+    # Do a round-trip check to make sure the push worked as expected.\n+    echo\n+    git fetch http://localhost:8000/$USER/rust.git@$JOSH_FILTER.git $BRANCH &>/dev/null\n+    if [[ $(git rev-parse HEAD) != $(git rev-parse FETCH_HEAD) ]]; then\n+        echo \"ERROR: Josh created a non-roundtrip push! Do NOT merge this into rustc!\"\n+        exit 1\n+    else\n+        echo \"Confirmed that the push round-trips back to Miri properly. Please create a rustc PR:\"\n+        echo \"    https://github.com/$USER/rust/pull/new/$BRANCH\"\n+        exit 0\n+    fi\n     ;;\n many-seeds)\n     for SEED in $({ echo obase=16; seq 0 255; } | bc); do"}]}