{"sha": "1530563bd7a3880eec14d78e4a715c1bc4e24074", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1MzA1NjNiZDdhMzg4MGVlYzE0ZDc4ZTRhNzE1YzFiYzRlMjQwNzQ=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-02T14:31:06Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-02T14:33:07Z"}, "message": "compiletest: print diff for pretty tests\n\nThis commit modifies compiletest so that a diff of actual and expected\noutput is shown for pretty tests. This makes it far easier to work out\nwhat has changed.\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "2c64ddeae9e3c4f394a9dad46882c2aa832e1299", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2c64ddeae9e3c4f394a9dad46882c2aa832e1299"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1530563bd7a3880eec14d78e4a715c1bc4e24074", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl8mzqMACgkQJZLnbIc4\nH9l2MBAAuZ50iu8aHCfaeJ5Nr9nj+2YpuHNDyD1ghZzh0GGvrorK4BQ/MACdVn2g\n5e3mHAka03r9XvavyAnFRJSVldxQCQL5DdGX8OZ2WOdkbp04C26mSZh5yssEC1cx\nadFZ5oumLauJe1DmZp8XPc+sOo2p9t9spgJmhDT3vU29wZVqNxHbBOkV4dGjDWvX\nMuBOM+97ji3yOrD375Krogcgwcyg68+3ZWD1gqaGfbI3uNdafqa7bydBZTeR+1Ah\nJsW4YXgfc68snbOwlCOhzOd3r1FTOrdpn+vyBfJhttK20I1jsuPIRY6WLXqTdBpw\njV13bj22gJwWmqAmVb5tRwUuz/ykjzsTg1i2y2mkxOe4a1drwXBL6+HGKgDnbsDw\nNaRmdNChk/B8PuZnPdJkHfv+PMNaSgYmnU7XSQWLLWgDONIu+mZxFWL7xDB7ruPg\nnupieSU4cHsZGUf+IfyBa57dmESY3TRrlnUbh/ZhdJZPcexHZF2JkKd3DgdldTl4\nqvc2XdfT+Jj5JVOWxTgvuJfBXiEm22eV/btmAwwuc9aHhoYvXh0JkxJ3N86a6fI/\nd/9DU9OAiTkKgLswXe7h/gH6cG8Z2fZIEgQm3wzmscrOzJlKEBrKzC3QgFyNaP/o\ns7pkkYIMFTfmcb9cW3H919VpUw7f6g8yvu4iFQ58T9srhYGsNSY=\n=zyIH\n-----END PGP SIGNATURE-----", "payload": "tree 2c64ddeae9e3c4f394a9dad46882c2aa832e1299\nparent c773226aba7d54fc55fdd6244fb6395a5487f656\nauthor David Wood <david@davidtw.co> 1596378666 +0100\ncommitter David Wood <david@davidtw.co> 1596378787 +0100\n\ncompiletest: print diff for pretty tests\n\nThis commit modifies compiletest so that a diff of actual and expected\noutput is shown for pretty tests. This makes it far easier to work out\nwhat has changed.\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1530563bd7a3880eec14d78e4a715c1bc4e24074", "html_url": "https://github.com/rust-lang/rust/commit/1530563bd7a3880eec14d78e4a715c1bc4e24074", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1530563bd7a3880eec14d78e4a715c1bc4e24074/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c773226aba7d54fc55fdd6244fb6395a5487f656", "url": "https://api.github.com/repos/rust-lang/rust/commits/c773226aba7d54fc55fdd6244fb6395a5487f656", "html_url": "https://github.com/rust-lang/rust/commit/c773226aba7d54fc55fdd6244fb6395a5487f656"}], "stats": {"total": 25, "additions": 16, "deletions": 9}, "files": [{"sha": "940e16720f6a98fef2a4ad503819b7245e2c81ad", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/1530563bd7a3880eec14d78e4a715c1bc4e24074/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1530563bd7a3880eec14d78e4a715c1bc4e24074/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=1530563bd7a3880eec14d78e4a715c1bc4e24074", "patch": "@@ -178,27 +178,30 @@ pub fn make_diff(expected: &str, actual: &str, context_size: usize) -> Vec<Misma\n     results\n }\n \n-fn print_diff(expected: &str, actual: &str, context_size: usize) {\n+fn write_diff(expected: &str, actual: &str, context_size: usize) -> String {\n+    use std::fmt::Write;\n+    let mut output = String::new();\n     let diff_results = make_diff(expected, actual, context_size);\n     for result in diff_results {\n         let mut line_number = result.line_number;\n         for line in result.lines {\n             match line {\n                 DiffLine::Expected(e) => {\n-                    println!(\"-\\t{}\", e);\n+                    writeln!(output, \"-\\t{}\", e).unwrap();\n                     line_number += 1;\n                 }\n                 DiffLine::Context(c) => {\n-                    println!(\"{}\\t{}\", line_number, c);\n+                    writeln!(output, \"{}\\t{}\", line_number, c).unwrap();\n                     line_number += 1;\n                 }\n                 DiffLine::Resulting(r) => {\n-                    println!(\"+\\t{}\", r);\n+                    writeln!(output, \"+\\t{}\", r).unwrap();\n                 }\n             }\n         }\n-        println!();\n+        writeln!(output, \"\").unwrap();\n     }\n+    output\n }\n \n pub fn run(config: Config, testpaths: &TestPaths, revision: Option<&str>) {\n@@ -655,8 +658,12 @@ impl<'test> TestCx<'test> {\n                  ------------------------------------------\\n\\\n                  {}\\n\\\n                  ------------------------------------------\\n\\\n-                 \\n\",\n-                expected, actual\n+                 diff:\\n\\\n+                 ------------------------------------------\\n\\\n+                 {}\\n\",\n+                expected,\n+                actual,\n+                write_diff(expected, actual, 3),\n             ));\n         }\n     }\n@@ -3227,7 +3234,7 @@ impl<'test> TestCx<'test> {\n                     }\n                     let expected_string = fs::read_to_string(&expected_file).unwrap();\n                     if dumped_string != expected_string {\n-                        print_diff(&expected_string, &dumped_string, 3);\n+                        print!(\"{}\", write_diff(&expected_string, &dumped_string, 3));\n                         panic!(\n                             \"Actual MIR output differs from expected MIR output {}\",\n                             expected_file.display()\n@@ -3452,7 +3459,7 @@ impl<'test> TestCx<'test> {\n                 println!(\"normalized {}:\\n{}\\n\", kind, actual);\n             } else {\n                 println!(\"diff of {}:\\n\", kind);\n-                print_diff(expected, actual, 3);\n+                print!(\"{}\", write_diff(expected, actual, 3));\n             }\n         }\n "}]}