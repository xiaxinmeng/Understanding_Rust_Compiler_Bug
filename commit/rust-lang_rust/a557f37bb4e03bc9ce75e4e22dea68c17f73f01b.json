{"sha": "a557f37bb4e03bc9ce75e4e22dea68c17f73f01b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1NTdmMzdiYjRlMDNiYzljZTc1ZTRlMjJkZWE2OGMxN2Y3M2YwMWI=", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-06-14T19:10:19Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-06-15T21:39:52Z"}, "message": "Improve metadata code block parsing", "tree": {"sha": "51cc96c29d546c35e1fe812bd12c5a13fb792a2d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/51cc96c29d546c35e1fe812bd12c5a13fb792a2d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a557f37bb4e03bc9ce75e4e22dea68c17f73f01b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a557f37bb4e03bc9ce75e4e22dea68c17f73f01b", "html_url": "https://github.com/rust-lang/rust/commit/a557f37bb4e03bc9ce75e4e22dea68c17f73f01b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a557f37bb4e03bc9ce75e4e22dea68c17f73f01b/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ee99d9bf54f04bd41a684d75a4536fbcb6e2663", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ee99d9bf54f04bd41a684d75a4536fbcb6e2663", "html_url": "https://github.com/rust-lang/rust/commit/1ee99d9bf54f04bd41a684d75a4536fbcb6e2663"}], "stats": {"total": 37, "additions": 27, "deletions": 10}, "files": [{"sha": "c980a0246fd2bb847713feea03902e7158ff45a4", "filename": "clippy_lints/src/utils/internal_lints/metadata_collector.rs", "status": "modified", "additions": 27, "deletions": 10, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a557f37bb4e03bc9ce75e4e22dea68c17f73f01b/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a557f37bb4e03bc9ce75e4e22dea68c17f73f01b/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs?ref=a557f37bb4e03bc9ce75e4e22dea68c17f73f01b", "patch": "@@ -9,6 +9,7 @@\n //! a simple mistake)\n \n use if_chain::if_chain;\n+use rustc_ast as ast;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_hir::{\n     self as hir, def::DefKind, intravisit, intravisit::Visitor, ExprKind, Item, ItemKind, Mutability, QPath,\n@@ -485,16 +486,32 @@ fn extract_attr_docs_or_lint(cx: &LateContext<'_>, item: &Item<'_>) -> Option<St\n ///\n /// Would result in `Hello world!\\n=^.^=\\n`\n fn extract_attr_docs(cx: &LateContext<'_>, item: &Item<'_>) -> Option<String> {\n-    cx.tcx\n-        .hir()\n-        .attrs(item.hir_id())\n-        .iter()\n-        .filter_map(|x| x.doc_str().map(|sym| sym.as_str().to_string()))\n-        .reduce(|mut acc, sym| {\n-            acc.push_str(&sym);\n-            acc.push('\\n');\n-            acc\n-        })\n+    let attrs = cx.tcx.hir().attrs(item.hir_id());\n+    let mut lines = attrs.iter().filter_map(ast::Attribute::doc_str);\n+    let mut docs = String::from(&*lines.next()?.as_str());\n+    let mut in_code_block = false;\n+    for line in lines {\n+        docs.push('\\n');\n+        let line = line.as_str();\n+        let line = &*line;\n+        if let Some(info) = line.trim_start().strip_prefix(\"```\") {\n+            in_code_block = !in_code_block;\n+            if in_code_block {\n+                let lang = info\n+                    .trim()\n+                    .split(',')\n+                    // remove rustdoc directives\n+                    .find(|&s| !matches!(s, \"\" | \"ignore\" | \"no_run\" | \"should_panic\"))\n+                    // if no language is present, fill in \"rust\"\n+                    .unwrap_or(\"rust\");\n+                docs.push_str(\"```\");\n+                docs.push_str(lang);\n+                continue;\n+            }\n+        }\n+        docs.push_str(line);\n+    }\n+    Some(docs)\n }\n \n fn get_lint_group_and_level_or_lint("}]}