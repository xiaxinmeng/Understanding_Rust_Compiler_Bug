{"sha": "c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMxYjk5ZjBiOTA1ZjNhZWMxZTQ0ZDMxMmE2OTJjNWRmNDQ0MGJjZDE=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-16T15:59:05Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-16T17:13:59Z"}, "message": "Don't warn about old rustdoc lint names (temporarily)\n\nRight now, rustdoc users have an unpleasant situation: they can either\nuse the new tool lint names (`rustdoc::non_autolinks`) or they can use\nthe old names (`non_autolinks`). If they use the tool lints, they get a\nhard error on stable compilers, because rustc rejects all tool names it\ndoesn't recognize. If they use the old name, they get a warning to\nrename the lint to the new name. The only way to compile without\nwarnings is to add `#[allow(renamed_removed_lints)]`, which defeats the\nwhole point of the change: we *want* people to switch to the new name.\n\nTo avoid people silencing the lint and never migrating to the tool lint,\nthis avoids warning about the old name, while still allowing you to use\nthe new name. Once the new `rustdoc` tool name makes it to the stable\nchannel, we can change these lints to warn again.\n\nThis adds the new lint functions `register_alias` and `register_ignored`\n- I didn't see an existing way to do this.", "tree": {"sha": "f9c08ddf321d2940a0947e81044700fbfedb5250", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f9c08ddf321d2940a0947e81044700fbfedb5250"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "html_url": "https://github.com/rust-lang/rust/commit/c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f24ce9b0140d9be5a336954e878d0c1522966bb8", "url": "https://api.github.com/repos/rust-lang/rust/commits/f24ce9b0140d9be5a336954e878d0c1522966bb8", "html_url": "https://github.com/rust-lang/rust/commit/f24ce9b0140d9be5a336954e878d0c1522966bb8"}], "stats": {"total": 80, "additions": 49, "deletions": 31}, "files": [{"sha": "3ba687124ae5800c1f95517041865dd7340907d3", "filename": "compiler/rustc_lint/src/context.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fcontext.rs?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -100,6 +100,11 @@ enum TargetLint {\n     /// Lint with this name existed previously, but has been removed/deprecated.\n     /// The string argument is the reason for removal.\n     Removed(String),\n+\n+    /// A lint name that should give no warnings and have no effect.\n+    ///\n+    /// This is used by rustc to avoid warning about old rustdoc lints before rustdoc registers them as tool lints.\n+    Ignored,\n }\n \n pub enum FindLintError {\n@@ -266,6 +271,33 @@ impl LintStore {\n         }\n     }\n \n+    /// This lint should be available with either the old or the new name.\n+    ///\n+    /// Using the old name will not give a warning.\n+    /// You must register a lint with the new name before calling this function.\n+    #[track_caller]\n+    pub fn register_alias(&mut self, old_name: &str, new_name: &str) {\n+        let target = match self.by_name.get(new_name) {\n+            Some(&Id(lint_id)) => lint_id,\n+            _ => bug!(\"cannot add alias {} for lint {} that does not exist\", old_name, new_name),\n+        };\n+        match self.by_name.insert(old_name.to_string(), Id(target)) {\n+            None | Some(Ignored) => {}\n+            Some(x) => bug!(\"duplicate specification of lint {} (was {:?})\", old_name, x),\n+        }\n+    }\n+\n+    /// This lint should give no warning and have no effect.\n+    ///\n+    /// This is used by rustc to avoid warning about old rustdoc lints before rustdoc registers them as tool lints.\n+    #[track_caller]\n+    pub fn register_ignored(&mut self, name: &str) {\n+        if self.by_name.insert(name.to_string(), Ignored).is_some() {\n+            bug!(\"duplicate specification of lint {}\", name);\n+        }\n+    }\n+\n+    /// This lint has been renamed; warn about using the new name and apply the lint.\n     #[track_caller]\n     pub fn register_renamed(&mut self, old_name: &str, new_name: &str) {\n         let target = match self.by_name.get(new_name) {\n@@ -284,6 +316,7 @@ impl LintStore {\n             Some(&Id(lint_id)) => Ok(vec![lint_id]),\n             Some(&Renamed(_, lint_id)) => Ok(vec![lint_id]),\n             Some(&Removed(_)) => Err(FindLintError::Removed),\n+            Some(&Ignored) => Ok(vec![]),\n             None => loop {\n                 return match self.lint_groups.get(lint_name) {\n                     Some(LintGroup { lint_ids, depr, .. }) => {\n@@ -427,6 +460,7 @@ impl LintStore {\n                 }\n             },\n             Some(&Id(ref id)) => CheckLintNameResult::Ok(slice::from_ref(id)),\n+            Some(&Ignored) => CheckLintNameResult::Ok(&[]),\n         }\n     }\n "}, {"sha": "4c3dbcabc88a6edd0fadd5237ae89039a81dc7db", "filename": "compiler/rustc_lint/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/compiler%2Frustc_lint%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/compiler%2Frustc_lint%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flib.rs?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -340,7 +340,7 @@ fn register_builtins(store: &mut LintStore, no_interleave_lints: bool) {\n         \"non_autolinks\",\n     ];\n     for rustdoc_lint in RUSTDOC_LINTS {\n-        store.register_removed(rustdoc_lint, &format!(\"use `rustdoc::{}` instead\", rustdoc_lint));\n+        store.register_ignored(rustdoc_lint);\n     }\n     store.register_removed(\n         \"intra_doc_link_resolution_failure\","}, {"sha": "ffa2f7a47fdd8bba652a49e6d4146e28672b2fd9", "filename": "src/librustdoc/lint.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Flibrustdoc%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Flibrustdoc%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flint.rs?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -181,7 +181,7 @@ crate fn register_lints(_sess: &Session, lint_store: &mut LintStore) {\n     );\n     for lint in &*RUSTDOC_LINTS {\n         let name = lint.name_lower();\n-        lint_store.register_renamed(&name.replace(\"rustdoc::\", \"\"), &name);\n+        lint_store.register_alias(&name.replace(\"rustdoc::\", \"\"), &name);\n     }\n     lint_store\n         .register_renamed(\"intra_doc_link_resolution_failure\", \"rustdoc::broken_intra_doc_links\");"}, {"sha": "8c61c1ccb6a6534e9ebf2a6e60c25292052ce7a1", "filename": "src/test/rustdoc-ui/renamed-lint-still-applies.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Frenamed-lint-still-applies.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Frenamed-lint-still-applies.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Frenamed-lint-still-applies.rs?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -1,5 +1,6 @@\n // compile-args: --crate-type lib\n #![deny(broken_intra_doc_links)]\n-//~^ WARNING renamed\n+// FIXME: the old names for rustdoc lints should warn by default once `rustdoc::` makes it to the\n+// stable channel.\n //! [x]\n //~^ ERROR unresolved link"}, {"sha": "8a12991558a4c0a64e124e94e7a0981c1ea76ac8", "filename": "src/test/rustdoc-ui/renamed-lint-still-applies.stderr", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Frenamed-lint-still-applies.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Frenamed-lint-still-applies.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Frenamed-lint-still-applies.stderr?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -1,13 +1,5 @@\n-warning: lint `broken_intra_doc_links` has been renamed to `rustdoc::broken_intra_doc_links`\n-  --> $DIR/renamed-lint-still-applies.rs:2:9\n-   |\n-LL | #![deny(broken_intra_doc_links)]\n-   |         ^^^^^^^^^^^^^^^^^^^^^^ help: use the new name: `rustdoc::broken_intra_doc_links`\n-   |\n-   = note: `#[warn(renamed_and_removed_lints)]` on by default\n-\n error: unresolved link to `x`\n-  --> $DIR/renamed-lint-still-applies.rs:4:6\n+  --> $DIR/renamed-lint-still-applies.rs:5:6\n    |\n LL | //! [x]\n    |      ^ no item named `x` in scope\n@@ -17,7 +9,8 @@ note: the lint level is defined here\n    |\n LL | #![deny(broken_intra_doc_links)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^\n+   = note: `#[deny(rustdoc::broken_intra_doc_links)]` implied by `#[deny(broken_intra_doc_links)]`\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n-error: aborting due to previous error; 1 warning emitted\n+error: aborting due to previous error\n "}, {"sha": "a05c0c81168b9450f8fd258c4e2e526a28892c14", "filename": "src/test/rustdoc-ui/unknown-renamed-lints.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Funknown-renamed-lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Funknown-renamed-lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Funknown-renamed-lints.rs?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -10,7 +10,8 @@\n //~^ ERROR renamed to `rustdoc::broken_intra_doc_links`\n \n #![deny(non_autolinks)]\n-//~^ ERROR renamed to `rustdoc::non_autolinks`\n+// FIXME: the old names for rustdoc lints should warn by default once `rustdoc::` makes it to the\n+// stable channel.\n \n #![deny(rustdoc)]\n //~^ ERROR removed: use `rustdoc::all` instead"}, {"sha": "98bfb83c704ae222f61672beb4be48c04af61632", "filename": "src/test/rustdoc-ui/unknown-renamed-lints.stderr", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Funknown-renamed-lints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Frustdoc-ui%2Funknown-renamed-lints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Funknown-renamed-lints.stderr?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -28,25 +28,19 @@ note: the lint level is defined here\n LL | #![deny(renamed_and_removed_lints)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: lint `non_autolinks` has been renamed to `rustdoc::non_autolinks`\n-  --> $DIR/unknown-renamed-lints.rs:12:9\n-   |\n-LL | #![deny(non_autolinks)]\n-   |         ^^^^^^^^^^^^^ help: use the new name: `rustdoc::non_autolinks`\n-\n error: lint `rustdoc` has been removed: use `rustdoc::all` instead\n-  --> $DIR/unknown-renamed-lints.rs:15:9\n+  --> $DIR/unknown-renamed-lints.rs:16:9\n    |\n LL | #![deny(rustdoc)]\n    |         ^^^^^^^\n \n error: unknown lint: `rustdoc::intra_doc_link_resolution_failure`\n-  --> $DIR/unknown-renamed-lints.rs:19:9\n+  --> $DIR/unknown-renamed-lints.rs:20:9\n    |\n LL | #![deny(rustdoc::intra_doc_link_resolution_failure)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: Compilation failed, aborting rustdoc\n \n-error: aborting due to 7 previous errors\n+error: aborting due to 6 previous errors\n "}, {"sha": "ecd6155b7690968a05421b113134d672f943da40", "filename": "src/test/ui/lint/rustdoc-renamed.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Fui%2Flint%2Frustdoc-renamed.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Fui%2Flint%2Frustdoc-renamed.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Frustdoc-renamed.rs?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -11,4 +11,5 @@\n #![deny(intra_doc_link_resolution_failure)]\n //~^ ERROR removed: use `rustdoc::broken_intra_doc_links`\n #![deny(non_autolinks)]\n-//~^ ERROR removed: use `rustdoc::non_autolinks`\n+// FIXME: the old names for rustdoc lints should warn by default once `rustdoc::` makes it to the\n+// stable channel."}, {"sha": "096e867aa16db3a0d112c69a5f3ab5bbb12e894d", "filename": "src/test/ui/lint/rustdoc-renamed.stderr", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Fui%2Flint%2Frustdoc-renamed.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1b99f0b905f3aec1e44d312a692c5df4440bcd1/src%2Ftest%2Fui%2Flint%2Frustdoc-renamed.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Frustdoc-renamed.stderr?ref=c1b99f0b905f3aec1e44d312a692c5df4440bcd1", "patch": "@@ -10,11 +10,5 @@ note: the lint level is defined here\n LL | #![deny(renamed_and_removed_lints)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: lint `non_autolinks` has been removed: use `rustdoc::non_autolinks` instead\n-  --> $DIR/rustdoc-renamed.rs:13:9\n-   |\n-LL | #![deny(non_autolinks)]\n-   |         ^^^^^^^^^^^^^\n-\n-error: aborting due to 2 previous errors\n+error: aborting due to previous error\n "}]}