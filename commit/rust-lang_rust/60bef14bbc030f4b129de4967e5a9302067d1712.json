{"sha": "60bef14bbc030f4b129de4967e5a9302067d1712", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYwYmVmMTRiYmMwMzBmNGIxMjlkZTQ5NjdlNWE5MzAyMDY3ZDE3MTI=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-01-08T23:22:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-08T23:22:05Z"}, "message": "Rollup merge of #67630 - oli-obk:extern_ptr_dangling, r=spastorino\n\nTreat extern statics just like statics in the \"const pointer to static\" representation\n\nfixes #67612\n\nr? @spastorino\n\ncc @RalfJung this does not affect runtime promotion at all. This is just about promotion within static item bodies.", "tree": {"sha": "5e991335c214dcb0f20c8c873a34940c44b5e335", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e991335c214dcb0f20c8c873a34940c44b5e335"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/60bef14bbc030f4b129de4967e5a9302067d1712", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeFmQeCRBK7hj4Ov3rIwAAdHIIAGvu7skJD5y8kd65YkwSQrtJ\nNmkffatfL5lekxzROyU2uyEdUblAavfE1A0UsiuOsqSLaw4tH+k2ZuomToZYvQoL\nFxhPBqMrH9niowC3/a3MMeqAFup5gA5YxHQR7i7gU4pOIHiAxdBC3mvKuCOkz1U4\nQjcuV0WSPEUL1ehIOYWJEw0U3JMdYTWJ6+Frd5+FpvJ8j53k9JlBclBjyW5RwRZ1\nfP37kV2O5M9wTFVZ2i3iQE5C52yu/qEgDO+nfNZNbOxr+j6xhjCvmQoLJAcZHjdb\nsxyaJtponfzuW76x0cLVwxM65ziwa9528CkNhTiq+ZCzjrkV5EzxbZqpGFfRySw=\n=9eUA\n-----END PGP SIGNATURE-----\n", "payload": "tree 5e991335c214dcb0f20c8c873a34940c44b5e335\nparent caa231d998a5e853c7ba1455d7a05b500df9d63c\nparent 097e14d19d6b74ab0a37846ae323862ace6ac259\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1578525725 +0100\ncommitter GitHub <noreply@github.com> 1578525725 +0100\n\nRollup merge of #67630 - oli-obk:extern_ptr_dangling, r=spastorino\n\nTreat extern statics just like statics in the \"const pointer to static\" representation\n\nfixes #67612\n\nr? @spastorino\n\ncc @RalfJung this does not affect runtime promotion at all. This is just about promotion within static item bodies.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/60bef14bbc030f4b129de4967e5a9302067d1712", "html_url": "https://github.com/rust-lang/rust/commit/60bef14bbc030f4b129de4967e5a9302067d1712", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/60bef14bbc030f4b129de4967e5a9302067d1712/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "caa231d998a5e853c7ba1455d7a05b500df9d63c", "url": "https://api.github.com/repos/rust-lang/rust/commits/caa231d998a5e853c7ba1455d7a05b500df9d63c", "html_url": "https://github.com/rust-lang/rust/commit/caa231d998a5e853c7ba1455d7a05b500df9d63c"}, {"sha": "097e14d19d6b74ab0a37846ae323862ace6ac259", "url": "https://api.github.com/repos/rust-lang/rust/commits/097e14d19d6b74ab0a37846ae323862ace6ac259", "html_url": "https://github.com/rust-lang/rust/commit/097e14d19d6b74ab0a37846ae323862ace6ac259"}], "stats": {"total": 73, "additions": 71, "deletions": 2}, "files": [{"sha": "ddff8258c6d8f023e690d210efbb1d9bcb6a265b", "filename": "src/librustc/ty/util.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/60bef14bbc030f4b129de4967e5a9302067d1712/src%2Flibrustc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60bef14bbc030f4b129de4967e5a9302067d1712/src%2Flibrustc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Futil.rs?ref=60bef14bbc030f4b129de4967e5a9302067d1712", "patch": "@@ -533,8 +533,6 @@ impl<'tcx> TyCtxt<'tcx> {\n \n         if self.is_mutable_static(def_id) {\n             self.mk_mut_ptr(static_ty)\n-        } else if self.is_foreign_item(def_id) {\n-            self.mk_imm_ptr(static_ty)\n         } else {\n             self.mk_imm_ref(self.lifetimes.re_erased, static_ty)\n         }"}, {"sha": "d611ec22c38ec09f4452663a47c16c88af7b91d6", "filename": "src/test/mir-opt/const-promotion-extern-static.rs", "status": "added", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/60bef14bbc030f4b129de4967e5a9302067d1712/src%2Ftest%2Fmir-opt%2Fconst-promotion-extern-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60bef14bbc030f4b129de4967e5a9302067d1712/src%2Ftest%2Fmir-opt%2Fconst-promotion-extern-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst-promotion-extern-static.rs?ref=60bef14bbc030f4b129de4967e5a9302067d1712", "patch": "@@ -0,0 +1,71 @@\n+extern \"C\" {\n+    static X: i32;\n+}\n+\n+static Y: i32 = 42;\n+\n+static mut BAR: *const &'static i32 = [&Y].as_ptr();\n+\n+static mut FOO: *const &'static i32 = [unsafe { &X }].as_ptr();\n+\n+fn main() {}\n+\n+// END RUST SOURCE\n+// START rustc.FOO.PromoteTemps.before.mir\n+// bb0: {\n+// ...\n+//     _5 = const Scalar(AllocId(1).0x0) : &i32;\n+//     _4 = &(*_5);\n+//     _3 = [move _4];\n+//     _2 = &_3;\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     StorageDead(_5);\n+//     StorageDead(_3);\n+//     return;\n+// }\n+// END rustc.FOO.PromoteTemps.before.mir\n+// START rustc.BAR.PromoteTemps.before.mir\n+// bb0: {\n+// ...\n+//     _5 = const Scalar(AllocId(0).0x0) : &i32;\n+//     _4 = &(*_5);\n+//     _3 = [move _4];\n+//     _2 = &_3;\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     StorageDead(_5);\n+//     StorageDead(_3);\n+//     return;\n+// }\n+// END rustc.BAR.PromoteTemps.before.mir\n+// START rustc.BAR.PromoteTemps.after.mir\n+// bb0: {\n+// ...\n+//     _2 = &(promoted[0]: [&'static i32; 1]);\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     return;\n+// }\n+// END rustc.BAR.PromoteTemps.after.mir\n+// START rustc.FOO.PromoteTemps.after.mir\n+// bb0: {\n+// ...\n+//     _2 = &(promoted[0]: [&'static i32; 1]);\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     return;\n+// }\n+// END rustc.FOO.PromoteTemps.after.mir"}]}