{"sha": "f84cab421ba241daa7200ec9582c93b28b8210f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4NGNhYjQyMWJhMjQxZGFhNzIwMGVjOTU4MmM5M2IyOGI4MjEwZjQ=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-03-12T16:54:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-03-12T16:54:26Z"}, "message": "Rollup merge of #48725 - humenda:master, r=nikomatsakis\n\nUpdate L4Re target specification\n\nDue to the dynamically generated linker arguments of the L4Re build system, it is not a good idea to hard-code them in Rust. This PR undoes this step. It also adds an empty implementation to retrieve the number of CPUs.", "tree": {"sha": "8ae693103850fe69a31a18ed79cb3469cdc974eb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ae693103850fe69a31a18ed79cb3469cdc974eb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f84cab421ba241daa7200ec9582c93b28b8210f4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaprDCCRBK7hj4Ov3rIwAAdHIIABU04jfhxzYJyq3vdjqmViAc\nEMDBuwn1q6QmTLuGyxM6x1+l+Ob47JvWNtJ+R/IZe2hbsMBE76kPRykaETqNg5zh\nQML1krnQPiCyFAUQhIKGieufZ0IUdO/IUC0xQ2ePwJJ2k0vcyC11Sd5YcZiUrSes\nz9+609fpR6OH6MnVPRC/F0rCDmq4Q6HGTQyugf5bjdo3dpzi8/aJymxj09QzNJJx\n4vA2aUidYx90Iwp2X9WMPPfAgJvdeNcX32GBvV4sP6G54ZylIgAjUKx5KSBoVQEI\nv0PLZEP1AyVyCvoZAl8hXxLAnZt4RIloFm1YRKZze0M5O/M2yIqUZukLc/rmBW8=\n=RuGq\n-----END PGP SIGNATURE-----\n", "payload": "tree 8ae693103850fe69a31a18ed79cb3469cdc974eb\nparent 7bd8f6ea3124b1a49677acc214131a6955f73d94\nparent 9fd941e847fd02c0a74059df78e9040b8e0ada2c\nauthor kennytm <kennytm@gmail.com> 1520873666 +0800\ncommitter GitHub <noreply@github.com> 1520873666 +0800\n\nRollup merge of #48725 - humenda:master, r=nikomatsakis\n\nUpdate L4Re target specification\n\nDue to the dynamically generated linker arguments of the L4Re build system, it is not a good idea to hard-code them in Rust. This PR undoes this step. It also adds an empty implementation to retrieve the number of CPUs.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f84cab421ba241daa7200ec9582c93b28b8210f4", "html_url": "https://github.com/rust-lang/rust/commit/f84cab421ba241daa7200ec9582c93b28b8210f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f84cab421ba241daa7200ec9582c93b28b8210f4/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7bd8f6ea3124b1a49677acc214131a6955f73d94", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bd8f6ea3124b1a49677acc214131a6955f73d94", "html_url": "https://github.com/rust-lang/rust/commit/7bd8f6ea3124b1a49677acc214131a6955f73d94"}, {"sha": "9fd941e847fd02c0a74059df78e9040b8e0ada2c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9fd941e847fd02c0a74059df78e9040b8e0ada2c", "html_url": "https://github.com/rust-lang/rust/commit/9fd941e847fd02c0a74059df78e9040b8e0ada2c"}], "stats": {"total": 79, "additions": 23, "deletions": 56}, "files": [{"sha": "3b13ef015006432fadc3f1d768d1d92351317f0c", "filename": "src/librustc_back/target/l4re_base.rs", "status": "modified", "additions": 16, "deletions": 55, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/f84cab421ba241daa7200ec9582c93b28b8210f4/src%2Flibrustc_back%2Ftarget%2Fl4re_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84cab421ba241daa7200ec9582c93b28b8210f4/src%2Flibrustc_back%2Ftarget%2Fl4re_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Ftarget%2Fl4re_base.rs?ref=f84cab421ba241daa7200ec9582c93b28b8210f4", "patch": "@@ -8,74 +8,35 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-use PanicStrategy;\n use LinkerFlavor;\n+use PanicStrategy;\n use target::{LinkArgs, TargetOptions};\n use std::default::Default;\n-use std::env;\n-use std::process::Command;\n+//use std::process::Command;\n \n // Use GCC to locate code for crt* libraries from the host, not from L4Re. Note\n // that a few files also come from L4Re, for these, the function shouldn't be\n // used. This uses GCC for the location of the file, but GCC is required for L4Re anyway.\n-fn get_path_or(filename: &str) -> String {\n-    let child = Command::new(\"gcc\")\n-        .arg(format!(\"-print-file-name={}\", filename)).output()\n-        .expect(\"Failed to execute GCC\");\n-    String::from_utf8(child.stdout)\n-        .expect(\"Couldn't read path from GCC\").trim().into()\n-}\n+//fn get_path_or(filename: &str) -> String {\n+//    let child = Command::new(\"gcc\")\n+//        .arg(format!(\"-print-file-name={}\", filename)).output()\n+//        .expect(\"Failed to execute GCC\");\n+//    String::from_utf8(child.stdout)\n+//        .expect(\"Couldn't read path from GCC\").trim().into()\n+//}\n \n-pub fn opts() -> Result<TargetOptions, String> {\n-    let l4re_lib_path = env::var_os(\"L4RE_LIBDIR\").ok_or(\"Unable to find L4Re \\\n-        library directory: L4RE_LIBDIR not set.\")?.into_string().unwrap();\n-    let mut pre_link_args = LinkArgs::new();\n-    pre_link_args.insert(LinkerFlavor::Ld, vec![\n-        format!(\"-T{}/main_stat.ld\", l4re_lib_path),\n-        \"--defsym=__executable_start=0x01000000\".to_string(),\n-        \"--defsym=__L4_KIP_ADDR__=0x6ffff000\".to_string(),\n-        format!(\"{}/crt1.o\", l4re_lib_path),\n-        format!(\"{}/crti.o\", l4re_lib_path),\n-        get_path_or(\"crtbeginT.o\"),\n-    ]);\n-    let mut post_link_args = LinkArgs::new();\n-    post_link_args.insert(LinkerFlavor::Ld, vec![\n-        format!(\"{}/l4f/libpthread.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_sig.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_sig_noop.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_socket_noop.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_fs_noop.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_sem_noop.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libl4re-vfs.o.a\", l4re_lib_path),\n-        format!(\"{}/l4f/lib4re.a\", l4re_lib_path),\n-        format!(\"{}/l4f/lib4re-util.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_support_misc.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libsupc++.a\", l4re_lib_path),\n-        format!(\"{}/l4f/lib4shmc.a\", l4re_lib_path),\n-        format!(\"{}/l4f/lib4re-c.a\", l4re_lib_path),\n-        format!(\"{}/l4f/lib4re-c-util.a\", l4re_lib_path),\n-        get_path_or(\"libgcc_eh.a\"),\n-        format!(\"{}/l4f/libdl.a\", l4re_lib_path),\n-        \"--start-group\".to_string(),\n-        format!(\"{}/l4f/libl4util.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_l4re.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libuc_c.a\", l4re_lib_path),\n-        format!(\"{}/l4f/libc_be_l4refile.a\", l4re_lib_path),\n-        \"--end-group\".to_string(),\n-        format!(\"{}/l4f/libl4sys.a\", l4re_lib_path),\n-        \"-gc-sections\".to_string(),\n-        get_path_or(\"crtend.o\"),\n-        format!(\"{}/crtn.o\", l4re_lib_path),\n-    ]);\n+pub fn opts() -> TargetOptions {\n+    let mut args = LinkArgs::new();\n+    args.insert(LinkerFlavor::Gcc, vec![]);\n \n-    Ok(TargetOptions {\n+    TargetOptions {\n         executables: true,\n         has_elf_tls: false,\n         exe_allocation_crate: None,\n         panic_strategy: PanicStrategy::Abort,\n-        pre_link_args,\n-        post_link_args,\n+        linker: Some(\"ld\".to_string()),\n+        pre_link_args: args,\n         target_family: Some(\"unix\".to_string()),\n         .. Default::default()\n-    })\n+    }\n }"}, {"sha": "821a77f52f511b203fb6ead8cc2fb5586c47e949", "filename": "src/librustc_back/target/x86_64_unknown_l4re_uclibc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f84cab421ba241daa7200ec9582c93b28b8210f4/src%2Flibrustc_back%2Ftarget%2Fx86_64_unknown_l4re_uclibc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84cab421ba241daa7200ec9582c93b28b8210f4/src%2Flibrustc_back%2Ftarget%2Fx86_64_unknown_l4re_uclibc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Ftarget%2Fx86_64_unknown_l4re_uclibc.rs?ref=f84cab421ba241daa7200ec9582c93b28b8210f4", "patch": "@@ -12,7 +12,7 @@ use LinkerFlavor;\n use target::{Target, TargetResult};\n \n pub fn target() -> TargetResult {\n-    let mut base = super::l4re_base::opts()?;\n+    let mut base = super::l4re_base::opts();\n     base.cpu = \"x86-64\".to_string();\n     base.max_atomic_width = Some(64);\n "}, {"sha": "59d701dd0fbc85fe8dcb89be2371c67c3ea4cb15", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f84cab421ba241daa7200ec9582c93b28b8210f4/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84cab421ba241daa7200ec9582c93b28b8210f4/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=f84cab421ba241daa7200ec9582c93b28b8210f4", "patch": "@@ -1294,6 +1294,12 @@ fn get_concurrency() -> usize {\n         // FIXME: implement\n         1\n     }\n+\n+    #[cfg(target_os = \"l4re\")]\n+    fn num_cpus() -> usize {\n+        // FIXME: implement\n+        1\n+    }\n }\n \n pub fn filter_tests(opts: &TestOpts, tests: Vec<TestDescAndFn>) -> Vec<TestDescAndFn> {"}]}