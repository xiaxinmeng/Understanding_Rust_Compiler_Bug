{"sha": "0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyNzljYjExZWQ5OGJkYzU4OWM2NjU3MjQ3N2ZkMjdmMWRkM2UwYWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-10T10:06:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-10T10:06:58Z"}, "message": "Auto merge of #85741 - tmiasko:ssa, r=nagisa\n\nUse preorder traversal when checking for SSA locals\n\nTraverse blocks in topological sort of dominance partial order, to ensure that\nlocal analyzer correctly identifies locals that are already in static single\nassignment form, while avoiding dependency on implicit numeric order of blocks.\n\nWhen rebuilding the standard library, this change reduces the number of locals\nthat require an alloca from 62452 to 62348.", "tree": {"sha": "b4a6de143b517dc585c2381161cc378e37d92076", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b4a6de143b517dc585c2381161cc378e37d92076"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "html_url": "https://github.com/rust-lang/rust/commit/0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0279cb11ed98bdc589c66572477fd27f1dd3e0ac/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5fbcd35a8217a17f6b63a22217ace06cf8f5f02", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5fbcd35a8217a17f6b63a22217ace06cf8f5f02", "html_url": "https://github.com/rust-lang/rust/commit/c5fbcd35a8217a17f6b63a22217ace06cf8f5f02"}, {"sha": "4237a052330ddc39fc458b42238bdc50c8584d73", "url": "https://api.github.com/repos/rust-lang/rust/commits/4237a052330ddc39fc458b42238bdc50c8584d73", "html_url": "https://github.com/rust-lang/rust/commit/4237a052330ddc39fc458b42238bdc50c8584d73"}], "stats": {"total": 5, "additions": 4, "deletions": 1}, "files": [{"sha": "49b5e8466bef2bd3d94324cad71750b785a57a31", "filename": "compiler/rustc_codegen_ssa/src/mir/analyze.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0279cb11ed98bdc589c66572477fd27f1dd3e0ac/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fanalyze.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0279cb11ed98bdc589c66572477fd27f1dd3e0ac/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fanalyze.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fanalyze.rs?ref=0279cb11ed98bdc589c66572477fd27f1dd3e0ac", "patch": "@@ -18,7 +18,10 @@ pub fn non_ssa_locals<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n     let mir = fx.mir;\n     let mut analyzer = LocalAnalyzer::new(fx);\n \n-    for (bb, data) in mir.basic_blocks().iter_enumerated() {\n+    // If there exists a local definition that dominates all uses of that local,\n+    // the definition should be visited first. Traverse blocks in preorder which\n+    // is a topological sort of dominance partial order.\n+    for (bb, data) in traversal::preorder(&mir) {\n         analyzer.visit_basic_block_data(bb, data);\n     }\n "}]}