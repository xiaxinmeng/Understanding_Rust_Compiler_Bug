{"sha": "b16a534618958d4981b62adb29b27de890862cbe", "node_id": "C_kwDOAAsO6NoAKGIxNmE1MzQ2MTg5NThkNDk4MWI2MmFkYjI5YjI3ZGU4OTA4NjJjYmU", "commit": {"author": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2022-10-30T21:15:46Z"}, "committer": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2022-10-30T21:15:46Z"}, "message": "Warn when clippy::restriction is enabled via the command line", "tree": {"sha": "9446bd714b3ccbfa507c19c314877214b64df9a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9446bd714b3ccbfa507c19c314877214b64df9a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b16a534618958d4981b62adb29b27de890862cbe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b16a534618958d4981b62adb29b27de890862cbe", "html_url": "https://github.com/rust-lang/rust/commit/b16a534618958d4981b62adb29b27de890862cbe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b16a534618958d4981b62adb29b27de890862cbe/comments", "author": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8e19251366887fe132bc7ba7593bff9358ad0291", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e19251366887fe132bc7ba7593bff9358ad0291", "html_url": "https://github.com/rust-lang/rust/commit/8e19251366887fe132bc7ba7593bff9358ad0291"}], "stats": {"total": 57, "additions": 42, "deletions": 15}, "files": [{"sha": "235ab4977ce4bffe9969b47058470555b52cddac", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 24, "deletions": 4, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/b16a534618958d4981b62adb29b27de890862cbe/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b16a534618958d4981b62adb29b27de890862cbe/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=b16a534618958d4981b62adb29b27de890862cbe", "patch": "@@ -11,14 +11,14 @@ use rustc_errors::Applicability;\n use rustc_hir::{\n     Block, Expr, ExprKind, ImplItem, ImplItemKind, Item, ItemKind, StmtKind, TraitFn, TraitItem, TraitItemKind,\n };\n-use rustc_lint::{EarlyContext, EarlyLintPass, LateContext, LateLintPass, LintContext};\n+use rustc_lint::{EarlyContext, EarlyLintPass, LateContext, LateLintPass, Level, LintContext};\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty;\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_lint_pass, declare_tool_lint, impl_lint_pass};\n use rustc_span::source_map::Span;\n-use rustc_span::sym;\n use rustc_span::symbol::Symbol;\n+use rustc_span::{sym, DUMMY_SP};\n use semver::Version;\n \n static UNIX_SYSTEMS: &[&str] = &[\n@@ -303,6 +303,26 @@ declare_lint_pass!(Attributes => [\n ]);\n \n impl<'tcx> LateLintPass<'tcx> for Attributes {\n+    fn check_crate(&mut self, cx: &LateContext<'tcx>) {\n+        for (name, level) in &cx.sess().opts.lint_opts {\n+            if name == \"clippy::restriction\" && *level > Level::Allow {\n+                span_lint_and_then(\n+                    cx,\n+                    BLANKET_CLIPPY_RESTRICTION_LINTS,\n+                    DUMMY_SP,\n+                    \"`clippy::restriction` is not meant to be enabled as a group\",\n+                    |diag| {\n+                        diag.note(format!(\n+                            \"because of the command line `--{} clippy::restriction`\",\n+                            level.as_str()\n+                        ));\n+                        diag.help(\"enable the restriction lints you need individually\");\n+                    },\n+                );\n+            }\n+        }\n+    }\n+\n     fn check_attribute(&mut self, cx: &LateContext<'tcx>, attr: &'tcx Attribute) {\n         if let Some(items) = &attr.meta_item_list() {\n             if let Some(ident) = attr.ident() {\n@@ -441,9 +461,9 @@ fn check_clippy_lint_names(cx: &LateContext<'_>, name: Symbol, items: &[NestedMe\n                     cx,\n                     BLANKET_CLIPPY_RESTRICTION_LINTS,\n                     lint.span(),\n-                    \"restriction lints are not meant to be all enabled\",\n+                    \"`clippy::restriction` is not meant to be enabled as a group\",\n                     None,\n-                    \"try enabling only the lints you really need\",\n+                    \"enable the restriction lints you need individually\",\n                 );\n             }\n         }"}, {"sha": "554745368bca4aa7f6862bcd66f37739d482ae9a", "filename": "tests/ui/blanket_clippy_restriction_lints.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b16a534618958d4981b62adb29b27de890862cbe/tests%2Fui%2Fblanket_clippy_restriction_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b16a534618958d4981b62adb29b27de890862cbe/tests%2Fui%2Fblanket_clippy_restriction_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fblanket_clippy_restriction_lints.rs?ref=b16a534618958d4981b62adb29b27de890862cbe", "patch": "@@ -1,3 +1,5 @@\n+// compile-flags: -W clippy::restriction\n+\n #![warn(clippy::blanket_clippy_restriction_lints)]\n \n //! Test that the whole restriction group is not enabled"}, {"sha": "2bf89ab69a40cdd75ed1bdc421858e722387ba9a", "filename": "tests/ui/blanket_clippy_restriction_lints.stderr", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/b16a534618958d4981b62adb29b27de890862cbe/tests%2Fui%2Fblanket_clippy_restriction_lints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b16a534618958d4981b62adb29b27de890862cbe/tests%2Fui%2Fblanket_clippy_restriction_lints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fblanket_clippy_restriction_lints.stderr?ref=b16a534618958d4981b62adb29b27de890862cbe", "patch": "@@ -1,27 +1,32 @@\n-error: restriction lints are not meant to be all enabled\n-  --> $DIR/blanket_clippy_restriction_lints.rs:4:9\n+error: `clippy::restriction` is not meant to be enabled as a group\n+   |\n+   = note: because of the command line `--warn clippy::restriction`\n+   = help: enable the restriction lints you need individually\n+   = note: `-D clippy::blanket-clippy-restriction-lints` implied by `-D warnings`\n+\n+error: `clippy::restriction` is not meant to be enabled as a group\n+  --> $DIR/blanket_clippy_restriction_lints.rs:6:9\n    |\n LL | #![warn(clippy::restriction)]\n    |         ^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: try enabling only the lints you really need\n-   = note: `-D clippy::blanket-clippy-restriction-lints` implied by `-D warnings`\n+   = help: enable the restriction lints you need individually\n \n-error: restriction lints are not meant to be all enabled\n-  --> $DIR/blanket_clippy_restriction_lints.rs:5:9\n+error: `clippy::restriction` is not meant to be enabled as a group\n+  --> $DIR/blanket_clippy_restriction_lints.rs:7:9\n    |\n LL | #![deny(clippy::restriction)]\n    |         ^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: try enabling only the lints you really need\n+   = help: enable the restriction lints you need individually\n \n-error: restriction lints are not meant to be all enabled\n-  --> $DIR/blanket_clippy_restriction_lints.rs:6:11\n+error: `clippy::restriction` is not meant to be enabled as a group\n+  --> $DIR/blanket_clippy_restriction_lints.rs:8:11\n    |\n LL | #![forbid(clippy::restriction)]\n    |           ^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: try enabling only the lints you really need\n+   = help: enable the restriction lints you need individually\n \n-error: aborting due to 3 previous errors\n+error: aborting due to 4 previous errors\n "}]}