{"sha": "f2736c969c5d820cbc058dbeaa14bba38e4bb71c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYyNzM2Yzk2OWM1ZDgyMGNiYzA1OGRiZWFhMTRiYmEzOGU0YmI3MWM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-07-21T16:00:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-21T16:00:08Z"}, "message": "Merge #9663\n\n9663: fix: Don't offer extract_variable assist when there is no surrounding block r=Veykril a=Veykril\n\nFixes #9143\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "6d6b310278a9fa51ae4ce414f861344ed88ff428", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d6b310278a9fa51ae4ce414f861344ed88ff428"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f2736c969c5d820cbc058dbeaa14bba38e4bb71c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg+ESICRBK7hj4Ov3rIwAAls0IAAhJGCcxFrzszTK9nwkmguc+\nKZDXtpnjOGDolyax00FZGmyW3RIRjvc0lsDboqd678jTQshUXT7A5CXSv0CKco1+\nsTvB6q7V7nSuUNQfO6EjN6ccczXKdgJPkF8bkDBEB0DlEughXIInxG1Ixy7TUqIV\nBcJMAi5k/Gcsct2wB9qS4vXv5nWj0jfE7/HpwVvW3L7AP7HJUy2yU91xuWk/9V99\nMUz5E8LVKwVt+iSuc3k4yIeIIdcq4W28CE8Tk8QMFsN5Lc8w2O4rF4iK3S49nWhv\nnlpjTf39cA3uVIU2UtFowKNddDdfxLqorAxjhfEdQmIvg6+D57lIUBXfskv3SdM=\n=PCSH\n-----END PGP SIGNATURE-----\n", "payload": "tree 6d6b310278a9fa51ae4ce414f861344ed88ff428\nparent 06b0cbf607f85ac05056fe2232f576c2c7dd6768\nparent 9279c1c939fa52da2be7d36efdd47f2839b23c56\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1626883208 +0000\ncommitter GitHub <noreply@github.com> 1626883208 +0000\n\nMerge #9663\n\n9663: fix: Don't offer extract_variable assist when there is no surrounding block r=Veykril a=Veykril\n\nFixes #9143\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f2736c969c5d820cbc058dbeaa14bba38e4bb71c", "html_url": "https://github.com/rust-lang/rust/commit/f2736c969c5d820cbc058dbeaa14bba38e4bb71c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f2736c969c5d820cbc058dbeaa14bba38e4bb71c/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06b0cbf607f85ac05056fe2232f576c2c7dd6768", "url": "https://api.github.com/repos/rust-lang/rust/commits/06b0cbf607f85ac05056fe2232f576c2c7dd6768", "html_url": "https://github.com/rust-lang/rust/commit/06b0cbf607f85ac05056fe2232f576c2c7dd6768"}, {"sha": "9279c1c939fa52da2be7d36efdd47f2839b23c56", "url": "https://api.github.com/repos/rust-lang/rust/commits/9279c1c939fa52da2be7d36efdd47f2839b23c56", "html_url": "https://github.com/rust-lang/rust/commit/9279c1c939fa52da2be7d36efdd47f2839b23c56"}], "stats": {"total": 71, "additions": 43, "deletions": 28}, "files": [{"sha": "176f52aa4d4130b9c31aeff9f8f8d2fda7bf40d9", "filename": "crates/ide_assists/src/handlers/extract_variable.rs", "status": "modified", "additions": 43, "deletions": 28, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/f2736c969c5d820cbc058dbeaa14bba38e4bb71c/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_variable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f2736c969c5d820cbc058dbeaa14bba38e4bb71c/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_variable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_variable.rs?ref=f2736c969c5d820cbc058dbeaa14bba38e4bb71c", "patch": "@@ -35,7 +35,10 @@ pub(crate) fn extract_variable(acc: &mut Assists, ctx: &AssistContext) -> Option\n         cov_mark::hit!(extract_var_in_comment_is_not_applicable);\n         return None;\n     }\n-    let to_extract = node.ancestors().find_map(valid_target_expr)?;\n+    let to_extract = node\n+        .ancestors()\n+        .take_while(|it| it.text_range().contains_range(ctx.frange.range))\n+        .find_map(valid_target_expr)?;\n     if let Some(ty) = ctx.sema.type_of_expr(&to_extract) {\n         if ty.is_unit() {\n             return None;\n@@ -142,41 +145,43 @@ enum Anchor {\n \n impl Anchor {\n     fn from(to_extract: &ast::Expr) -> Option<Anchor> {\n-        to_extract.syntax().ancestors().find_map(|node| {\n-            if let Some(expr) =\n-                node.parent().and_then(ast::BlockExpr::cast).and_then(|it| it.tail_expr())\n-            {\n-                if expr.syntax() == &node {\n-                    cov_mark::hit!(test_extract_var_last_expr);\n-                    return Some(Anchor::Before(node));\n+        to_extract.syntax().ancestors().take_while(|it| !ast::Item::can_cast(it.kind())).find_map(\n+            |node| {\n+                if let Some(expr) =\n+                    node.parent().and_then(ast::BlockExpr::cast).and_then(|it| it.tail_expr())\n+                {\n+                    if expr.syntax() == &node {\n+                        cov_mark::hit!(test_extract_var_last_expr);\n+                        return Some(Anchor::Before(node));\n+                    }\n                 }\n-            }\n \n-            if let Some(parent) = node.parent() {\n-                if parent.kind() == CLOSURE_EXPR {\n-                    cov_mark::hit!(test_extract_var_in_closure_no_block);\n-                    return Some(Anchor::WrapInBlock(node));\n-                }\n-                if parent.kind() == MATCH_ARM {\n-                    if node.kind() == MATCH_GUARD {\n-                        cov_mark::hit!(test_extract_var_in_match_guard);\n-                    } else {\n-                        cov_mark::hit!(test_extract_var_in_match_arm_no_block);\n+                if let Some(parent) = node.parent() {\n+                    if parent.kind() == CLOSURE_EXPR {\n+                        cov_mark::hit!(test_extract_var_in_closure_no_block);\n                         return Some(Anchor::WrapInBlock(node));\n                     }\n+                    if parent.kind() == MATCH_ARM {\n+                        if node.kind() == MATCH_GUARD {\n+                            cov_mark::hit!(test_extract_var_in_match_guard);\n+                        } else {\n+                            cov_mark::hit!(test_extract_var_in_match_arm_no_block);\n+                            return Some(Anchor::WrapInBlock(node));\n+                        }\n+                    }\n                 }\n-            }\n \n-            if let Some(stmt) = ast::Stmt::cast(node.clone()) {\n-                if let ast::Stmt::ExprStmt(stmt) = stmt {\n-                    if stmt.expr().as_ref() == Some(to_extract) {\n-                        return Some(Anchor::Replace(stmt));\n+                if let Some(stmt) = ast::Stmt::cast(node.clone()) {\n+                    if let ast::Stmt::ExprStmt(stmt) = stmt {\n+                        if stmt.expr().as_ref() == Some(to_extract) {\n+                            return Some(Anchor::Replace(stmt));\n+                        }\n                     }\n+                    return Some(Anchor::Before(node));\n                 }\n-                return Some(Anchor::Before(node));\n-            }\n-            None\n-        })\n+                None\n+            },\n+        )\n     }\n \n     fn syntax(&self) -> &SyntaxNode {\n@@ -844,4 +849,14 @@ fn main() {\n             \"2 + 2\",\n         );\n     }\n+\n+    #[test]\n+    fn extract_var_no_block_body() {\n+        check_assist_not_applicable(\n+            extract_variable,\n+            r\"\n+const X: usize = $0100$0;\n+\",\n+        );\n+    }\n }"}]}