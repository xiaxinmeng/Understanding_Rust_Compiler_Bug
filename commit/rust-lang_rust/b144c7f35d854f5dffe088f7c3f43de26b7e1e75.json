{"sha": "b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIxNDRjN2YzNWQ4NTRmNWRmZmUwODhmN2MzZjQzZGUyNmI3ZTFlNzU=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-10-31T06:48:49Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-10-31T06:48:49Z"}, "message": "Merge #3370\n\n3370: bool_comparison triggers 3 times on same code r=phansch a=mrbuzz\n\nFix #3335 \n\nCo-authored-by: Giorgio Gambino <gambnio.giorgio@gmail.com>", "tree": {"sha": "f40e9fccce4b92ea4d4bb830caec96c3d7ab5ac3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f40e9fccce4b92ea4d4bb830caec96c3d7ab5ac3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "html_url": "https://github.com/rust-lang/rust/commit/b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "2362b3a312cb9c2cdbe78dd620ecbedd785cc858", "url": "https://api.github.com/repos/rust-lang/rust/commits/2362b3a312cb9c2cdbe78dd620ecbedd785cc858", "html_url": "https://github.com/rust-lang/rust/commit/2362b3a312cb9c2cdbe78dd620ecbedd785cc858"}, {"sha": "c0c1f1f7fa1cd2d9d65d3b2cd4b3943c62106328", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0c1f1f7fa1cd2d9d65d3b2cd4b3943c62106328", "html_url": "https://github.com/rust-lang/rust/commit/c0c1f1f7fa1cd2d9d65d3b2cd4b3943c62106328"}], "stats": {"total": 124, "additions": 99, "deletions": 25}, "files": [{"sha": "e13f757adb9e69cdf314899adba874f0243c1fac", "filename": "clippy_lints/src/needless_bool.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/clippy_lints%2Fsrc%2Fneedless_bool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/clippy_lints%2Fsrc%2Fneedless_bool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneedless_bool.rs?ref=b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "patch": "@@ -17,7 +17,7 @@ use crate::rustc::{declare_tool_lint, lint_array};\n use crate::rustc::hir::*;\n use crate::syntax::ast::LitKind;\n use crate::syntax::source_map::Spanned;\n-use crate::utils::{snippet, span_lint, span_lint_and_sugg};\n+use crate::utils::{in_macro, snippet, span_lint, span_lint_and_sugg};\n use crate::utils::sugg::Sugg;\n \n /// **What it does:** Checks for expressions of the form `if c { true } else {\n@@ -133,6 +133,9 @@ impl LintPass for BoolComparison {\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for BoolComparison {\n     fn check_expr(&mut self, cx: &LateContext<'a, 'tcx>, e: &'tcx Expr) {\n+        if in_macro(e.span) {\n+            return;\n+        }\n         use self::Expression::*;\n         if let ExprKind::Binary(Spanned { node: BinOpKind::Eq, .. }, ref left_side, ref right_side) = e.node {\n             match (fetch_bool_expr(left_side), fetch_bool_expr(right_side)) {"}, {"sha": "98c2e0767d6a9464a7b2ccb210bcc5f9d822e7f4", "filename": "tests/ui/needless_bool.rs", "status": "modified", "additions": 46, "deletions": 1, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/tests%2Fui%2Fneedless_bool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/tests%2Fui%2Fneedless_bool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_bool.rs?ref=b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "patch": "@@ -8,9 +8,31 @@\n // except according to those terms.\n \n \n+#![warn(clippy::needless_bool)]\n \n+use std::cell::Cell;\n \n-#![warn(clippy::needless_bool)]\n+macro_rules! bool_comparison_trigger {\n+    ($($i:ident: $def:expr, $stb:expr );+  $(;)*) => (\n+\n+        #[derive(Clone)]\n+        pub struct Trigger {\n+            $($i: (Cell<bool>, bool, bool)),+\n+        }\n+\n+        #[allow(dead_code)]\n+        impl Trigger {\n+            pub fn trigger(&self, key: &str) -> bool {\n+                $(\n+                    if let stringify!($i) = key {\n+                        return self.$i.1 && self.$i.2 == $def;\n+                    }\n+                 )+\n+                false\n+            }\n+        }\n+    )\n+}\n \n #[allow(clippy::if_same_then_else)]\n fn main() {\n@@ -28,6 +50,9 @@ fn main() {\n     bool_ret5(x, x);\n     bool_ret4(x);\n     bool_ret6(x, x);\n+    needless_bool(x);\n+    needless_bool2(x);\n+    needless_bool3(x);\n }\n \n #[allow(clippy::if_same_then_else, clippy::needless_return)]\n@@ -59,3 +84,23 @@ fn bool_ret4(x: bool) -> bool {\n fn bool_ret6(x: bool, y: bool) -> bool {\n     if x && y { return false } else { return true };\n }\n+\n+fn needless_bool(x: bool) {\n+   if x  == true { };\n+}\n+\n+fn needless_bool2(x: bool) {\n+   if x  == false { };\n+}\n+\n+fn needless_bool3(x: bool) {\n+    \n+    bool_comparison_trigger! {\n+        test_one:   false, false;\n+        test_three: false, false;\n+        test_two:   true, true;\n+    }\n+    \n+    if x == true { };\n+    if x == false { };\n+}"}, {"sha": "638a3f56f0f288b425d83eaaa1766f981dde71ea", "filename": "tests/ui/needless_bool.stderr", "status": "modified", "additions": 49, "deletions": 23, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/tests%2Fui%2Fneedless_bool.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b144c7f35d854f5dffe088f7c3f43de26b7e1e75/tests%2Fui%2Fneedless_bool.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_bool.stderr?ref=b144c7f35d854f5dffe088f7c3f43de26b7e1e75", "patch": "@@ -1,70 +1,96 @@\n error: this if-then-else expression will always return true\n-  --> $DIR/needless_bool.rs:19:5\n+  --> $DIR/needless_bool.rs:41:5\n    |\n-19 |     if x { true } else { true };\n+41 |     if x { true } else { true };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D clippy::needless-bool` implied by `-D warnings`\n \n error: this if-then-else expression will always return false\n-  --> $DIR/needless_bool.rs:20:5\n+  --> $DIR/needless_bool.rs:42:5\n    |\n-20 |     if x { false } else { false };\n+42 |     if x { false } else { false };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:21:5\n+  --> $DIR/needless_bool.rs:43:5\n    |\n-21 |     if x { true } else { false };\n+43 |     if x { true } else { false };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:22:5\n+  --> $DIR/needless_bool.rs:44:5\n    |\n-22 |     if x { false } else { true };\n+44 |     if x { false } else { true };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `!x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:23:5\n+  --> $DIR/needless_bool.rs:45:5\n    |\n-23 |     if x && y { false } else { true };\n+45 |     if x && y { false } else { true };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `!(x && y)`\n \n error: this if-then-else expression will always return true\n-  --> $DIR/needless_bool.rs:35:5\n+  --> $DIR/needless_bool.rs:60:5\n    |\n-35 |     if x { return true } else { return true };\n+60 |     if x { return true } else { return true };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: this if-then-else expression will always return false\n-  --> $DIR/needless_bool.rs:40:5\n+  --> $DIR/needless_bool.rs:65:5\n    |\n-40 |     if x { return false } else { return false };\n+65 |     if x { return false } else { return false };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:45:5\n+  --> $DIR/needless_bool.rs:70:5\n    |\n-45 |     if x { return true } else { return false };\n+70 |     if x { return true } else { return false };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `return x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:50:5\n+  --> $DIR/needless_bool.rs:75:5\n    |\n-50 |     if x && y { return true } else { return false };\n+75 |     if x && y { return true } else { return false };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `return x && y`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:55:5\n+  --> $DIR/needless_bool.rs:80:5\n    |\n-55 |     if x { return false } else { return true };\n+80 |     if x { return false } else { return true };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `return !x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/needless_bool.rs:60:5\n+  --> $DIR/needless_bool.rs:85:5\n    |\n-60 |     if x && y { return false } else { return true };\n+85 |     if x && y { return false } else { return true };\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `return !(x && y)`\n \n-error: aborting due to 11 previous errors\n+error: equality checks against true are unnecessary\n+  --> $DIR/needless_bool.rs:89:7\n+   |\n+89 |    if x  == true { };\n+   |       ^^^^^^^^^^ help: try simplifying it as shown: `x`\n+   |\n+   = note: `-D clippy::bool-comparison` implied by `-D warnings`\n+\n+error: equality checks against false can be replaced by a negation\n+  --> $DIR/needless_bool.rs:93:7\n+   |\n+93 |    if x  == false { };\n+   |       ^^^^^^^^^^^ help: try simplifying it as shown: `!x`\n+\n+error: equality checks against true are unnecessary\n+   --> $DIR/needless_bool.rs:104:8\n+    |\n+104 |     if x == true { };\n+    |        ^^^^^^^^^ help: try simplifying it as shown: `x`\n+\n+error: equality checks against false can be replaced by a negation\n+   --> $DIR/needless_bool.rs:105:8\n+    |\n+105 |     if x == false { };\n+    |        ^^^^^^^^^^ help: try simplifying it as shown: `!x`\n+\n+error: aborting due to 15 previous errors\n "}]}