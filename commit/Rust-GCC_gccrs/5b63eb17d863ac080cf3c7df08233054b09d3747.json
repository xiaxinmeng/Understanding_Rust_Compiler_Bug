{"sha": "5b63eb17d863ac080cf3c7df08233054b09d3747", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWI2M2ViMTdkODYzYWMwODBjZjNjN2RmMDgyMzMwNTRiMDlkMzc0Nw==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-04-13T14:19:03Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-04-14T12:43:38Z"}, "message": "d: Move call to set_linkage_for_decl to declare_extern_var.\n\nThis both prevents against it being called twice for declarations that\nare defined, and fixes an issue where variables defined in the\ncompilation get one kind of linkage (weak), and the same variables\ndeclared via declare_extern_var get another (extern).\n\ngcc/d/ChangeLog:\n\n\tPR d/99914\n\t* decl.cc (DeclVisitor::visit (StructDeclaration *)): Don't set\n\tDECL_INSTANTIATED on static initializer declarations.\n\t(DeclVisitor::visit (ClassDeclaration *)): Likewise.\n\t(DeclVisitor::visit (EnumDeclaration *)): Likewise.\n\t(d_finish_decl): Move call to set_linkage_for_decl to...\n\t(declare_extern_var): ...here.", "tree": {"sha": "ab6c28abef05e7db0ae4185b7e8dbe320e9a91e4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ab6c28abef05e7db0ae4185b7e8dbe320e9a91e4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5b63eb17d863ac080cf3c7df08233054b09d3747", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5b63eb17d863ac080cf3c7df08233054b09d3747", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5b63eb17d863ac080cf3c7df08233054b09d3747", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5b63eb17d863ac080cf3c7df08233054b09d3747/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3785d2b207f1958f31a79fbbb5705b261551950d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3785d2b207f1958f31a79fbbb5705b261551950d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3785d2b207f1958f31a79fbbb5705b261551950d"}], "stats": {"total": 6, "additions": 2, "deletions": 4}, "files": [{"sha": "8948e40e9027e8fb010d10c32ebfdafa49881474", "filename": "gcc/d/decl.cc", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b63eb17d863ac080cf3c7df08233054b09d3747/gcc%2Fd%2Fdecl.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b63eb17d863ac080cf3c7df08233054b09d3747/gcc%2Fd%2Fdecl.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fdecl.cc?ref=5b63eb17d863ac080cf3c7df08233054b09d3747", "patch": "@@ -387,7 +387,6 @@ class DeclVisitor : public Visitor\n     /* Generate static initializer.  */\n     d->sinit = aggregate_initializer_decl (d);\n     DECL_INITIAL (d->sinit) = layout_struct_initializer (d);\n-    DECL_INSTANTIATED (d->sinit) = (d->isInstantiated () != NULL);\n     d_finish_decl (d->sinit);\n \n     /* Put out the members.  There might be static constructors in the members\n@@ -500,7 +499,6 @@ class DeclVisitor : public Visitor\n \n     /* Generate static initializer.  */\n     DECL_INITIAL (d->sinit) = layout_class_initializer (d);\n-    DECL_INSTANTIATED (d->sinit) = (d->isInstantiated () != NULL);\n     d_finish_decl (d->sinit);\n \n     /* Put out the TypeInfo.  */\n@@ -611,7 +609,6 @@ class DeclVisitor : public Visitor\n \t/* Generate static initializer.  */\n \td->sinit = enum_initializer_decl (d);\n \tDECL_INITIAL (d->sinit) = build_expr (tc->sym->defaultval, true);\n-\tDECL_INSTANTIATED (d->sinit) = (d->isInstantiated () != NULL);\n \td_finish_decl (d->sinit);\n       }\n \n@@ -1379,6 +1376,8 @@ declare_extern_var (tree ident, tree type)\n   /* The decl has not been defined -- yet.  */\n   DECL_EXTERNAL (decl) = 1;\n \n+  set_linkage_for_decl (decl);\n+\n   return decl;\n }\n \n@@ -1540,7 +1539,6 @@ d_finish_decl (tree decl)\n     set_decl_tls_model (decl, decl_default_tls_model (decl));\n \n   relayout_decl (decl);\n-  set_linkage_for_decl (decl);\n \n   if (flag_checking && DECL_INITIAL (decl))\n     {"}]}