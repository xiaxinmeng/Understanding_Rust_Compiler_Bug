{"sha": "4f75d60893e092cffcbe422825ce4dc092d3fb9e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NGY3NWQ2MDg5M2UwOTJjZmZjYmU0MjI4MjVjZTRkYzA5MmQzZmI5ZQ==", "commit": {"author": {"name": "Tom de Vries", "email": "tom@codesourcery.com", "date": "2015-06-30T08:35:57Z"}, "committer": {"name": "Tom de Vries", "email": "vries@gcc.gnu.org", "date": "2015-06-30T08:35:57Z"}, "message": "Use max_loop_iterations in transform_to_exit_first_loop_alt\n\n2015-06-30  Tom de Vries  <tom@codesourcery.com>\n\n\tPR tree-optimization/66652\n\t* tree-parloops.c (try_transform_to_exit_first_loop_alt): Use\n\tmax_loop_iterations to determine if nit + 1 overflows.\n\n\t* testsuite/libgomp.c/parloops-exit-first-loop-alt-3.c (f): Rewrite\n\tusing restrict pointers.\n\t(main): Add arguments to calls to f.\n\t* testsuite/libgomp.c/parloops-exit-first-loop-alt.c: Same.\n\n\t* gcc.dg/parloops-exit-first-loop-alt-pr66652.c: New test.\n\t* gcc.dg/parloops-exit-first-loop-alt-3.c (f):  Rewrite using restrict\n\tpointers.\n\t* gcc.dg/parloops-exit-first-loop-alt.c: Same.\n\nFrom-SVN: r225162", "tree": {"sha": "ca50ebb2d0d7f8b30b28938281260d4d17f52bd2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ca50ebb2d0d7f8b30b28938281260d4d17f52bd2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4f75d60893e092cffcbe422825ce4dc092d3fb9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f75d60893e092cffcbe422825ce4dc092d3fb9e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4f75d60893e092cffcbe422825ce4dc092d3fb9e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f75d60893e092cffcbe422825ce4dc092d3fb9e/comments", "author": null, "committer": null, "parents": [{"sha": "4fe651724763ce1a438b5497621510a4185e069e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4fe651724763ce1a438b5497621510a4185e069e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4fe651724763ce1a438b5497621510a4185e069e"}], "stats": {"total": 114, "additions": 97, "deletions": 17}, "files": [{"sha": "9b8c7cff39952904cf124e6133c782f89ef79746", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -1,3 +1,9 @@\n+2015-06-30  Tom de Vries  <tom@codesourcery.com>\n+\n+\tPR tree-optimization/66652\n+\t* tree-parloops.c (try_transform_to_exit_first_loop_alt): Use\n+\tmax_loop_iterations to determine if nit + 1 overflows.\n+\n 2015-06-30  Richard Biener  <rguenther@suse.de>\n \n \t* tree-vrp.c (register_edge_assert_for_2): Also register"}, {"sha": "f249a7d7ded7cefc6de69e6e0ebe71f679ebbf0f", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -1,3 +1,11 @@\n+2015-06-30  Tom de Vries  <tom@codesourcery.com>\n+\n+\tPR tree-optimization/66652\n+\t* gcc.dg/parloops-exit-first-loop-alt-pr66652.c: New test.\n+\t* gcc.dg/parloops-exit-first-loop-alt-3.c (f):  Rewrite using restrict\n+\tpointers.\n+\t* gcc.dg/parloops-exit-first-loop-alt.c: Same.\n+\n 2015-06-29  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/65977"}, {"sha": "fec53a19628acdf08fef7b8b2b152249292740eb", "filename": "gcc/testsuite/gcc.dg/parloops-exit-first-loop-alt-3.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt-3.c?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -7,7 +7,7 @@\n unsigned int *a;\n \n unsigned int\n-f (unsigned int n)\n+f (unsigned int n, unsigned int *__restrict__ a)\n {\n   int i;\n   unsigned int sum = 1;"}, {"sha": "2ea097d06f9b59a6eba9d8dd673780029a298a72", "filename": "gcc/testsuite/gcc.dg/parloops-exit-first-loop-alt-pr66652.c", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt-pr66652.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt-pr66652.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt-pr66652.c?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -0,0 +1,31 @@\n+/* { dg-do compile } */\n+/* { dg-require-effective-target pthread } */\n+/* { dg-options \"-O2 -ftree-parallelize-loops=2 -fdump-tree-parloops\" } */\n+\n+#include <stdio.h>\n+#include <stdlib.h>\n+#include <limits.h>\n+\n+unsigned int\n+f (unsigned int n, unsigned int sum)\n+{\n+  unsigned int i;\n+\n+  i = UINT_MAX;\n+  do\n+    {\n+      sum += i % 13;\n+      i++;\n+    }\n+  while (i < n - 1);\n+\n+  return sum;\n+}\n+\n+/* Four times % 13:\n+   - once in f._loopfn.0\n+   - once in the parallel\n+   - once in the low iteration count loop\n+   - once for a peeled off last iteration following the parallel.\n+   In other words, we want try_transform_to_exit_first_loop_alt to fail.  */\n+/* { dg-final { scan-tree-dump-times \"(?n)% 13\" 4 \"parloops\" } } */"}, {"sha": "e088fa110b398942b3e3871fd1dc606c453af495", "filename": "gcc/testsuite/gcc.dg/parloops-exit-first-loop-alt.c", "status": "modified", "additions": 7, "deletions": 12, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fparloops-exit-first-loop-alt.c?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -4,24 +4,19 @@\n \n /* Variable bound, vector addition.  */\n \n-#define N 1000\n-\n-unsigned int a[N];\n-unsigned int b[N];\n-unsigned int c[N];\n-\n void\n-f (unsigned int n)\n+f (unsigned int n, unsigned int *__restrict__ a, unsigned int *__restrict__ b,\n+   unsigned int *__restrict__ c)\n {\n   int i;\n \n   for (i = 0; i < n; ++i)\n     c[i] = a[i] + b[i];\n }\n \n-/* Three times three array accesses:\n-   - three in f._loopfn.0\n-   - three in the parallel\n-   - three in the low iteration count loop\n+/* Three times a store:\n+   - one in f._loopfn.0\n+   - one in the parallel\n+   - one in the low iteration count loop\n    Crucially, none for a peeled off last iteration following the parallel.  */\n-/* { dg-final { scan-tree-dump-times \"(?n)\\\\\\[i\" 9 \"parloops\" } } */\n+/* { dg-final { scan-tree-dump-times \"(?n)^  \\\\*_\\[0-9\\]*\" 3 \"parloops\" } } */"}, {"sha": "21ed17b4cafde79e04603b4cfd239bd30d06a7b2", "filename": "gcc/tree-parloops.c", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftree-parloops.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/gcc%2Ftree-parloops.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-parloops.c?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -1801,8 +1801,39 @@ try_transform_to_exit_first_loop_alt (struct loop *loop,\n \n   gcc_assert (TREE_CODE (nit) == SSA_NAME);\n \n+  /* Variable nit is the loop bound as returned by canonicalize_loop_ivs, for an\n+     iv with base 0 and step 1 that is incremented in the latch, like this:\n+\n+     <bb header>:\n+     # iv_1 = PHI <0 (preheader), iv_2 (latch)>\n+     ...\n+     if (iv_1 < nit)\n+       goto <bb latch>;\n+     else\n+       goto <bb exit>;\n+\n+     <bb latch>:\n+     iv_2 = iv_1 + 1;\n+     goto <bb header>;\n+\n+     The range of iv_1 is [0, nit].  The latch edge is taken for\n+     iv_1 == [0, nit - 1] and the exit edge is taken for iv_1 == nit.  So the\n+     number of latch executions is equal to nit.\n+\n+     The function max_loop_iterations gives us the maximum number of latch\n+     executions, so it gives us the maximum value of nit.  */\n+  widest_int nit_max;\n+  if (!max_loop_iterations (loop, &nit_max))\n+    return false;\n+\n+  /* Check if nit + 1 overflows.  */\n+  widest_int type_max = wi::to_widest (TYPE_MAXVAL (nit_type));\n+  if (!wi::lts_p (nit_max, type_max))\n+    return false;\n+\n   gimple def = SSA_NAME_DEF_STMT (nit);\n \n+  /* Try to find nit + 1, in the form of n in an assignment nit = n - 1.  */\n   if (def\n       && is_gimple_assign (def)\n       && gimple_assign_rhs_code (def) == PLUS_EXPR)"}, {"sha": "2c539b821aca606670eaae7cb0c58e1a8c463918", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -1,3 +1,11 @@\n+2015-06-30  Tom de Vries  <tom@codesourcery.com>\n+\n+\tPR tree-optimization/66652\n+\t* testsuite/libgomp.c/parloops-exit-first-loop-alt-3.c (f): Rewrite\n+\tusing restrict pointers.\n+\t(main): Add arguments to calls to f.\n+\t* testsuite/libgomp.c/parloops-exit-first-loop-alt.c: Same.\n+\n 2015-06-23  Andreas Tobler  <andreast@gcc.gnu.org>\n \n \t* configure.ac: Fix check for header <sys/sysctl.h>."}, {"sha": "7de1377cd56956f8552fa29be0571d5f5d366f88", "filename": "libgomp/testsuite/libgomp.c/parloops-exit-first-loop-alt-3.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/libgomp%2Ftestsuite%2Flibgomp.c%2Fparloops-exit-first-loop-alt-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/libgomp%2Ftestsuite%2Flibgomp.c%2Fparloops-exit-first-loop-alt-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fparloops-exit-first-loop-alt-3.c?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -10,7 +10,7 @@\n unsigned int *a;\n \n unsigned int __attribute__((noclone,noinline))\n-f (unsigned int n)\n+f (unsigned int n, unsigned int *__restrict__ a)\n {\n   int i;\n   unsigned int sum = 1;\n@@ -32,7 +32,7 @@ main (void)\n     array[i] = i % 7;\n   a = &array[0];\n \n-  res = f (N);\n+  res = f (N, a);\n   if (res != 11995)\n     abort ();\n "}, {"sha": "07468a9ab9e75a5685992b6187e462b2dafcae3a", "filename": "libgomp/testsuite/libgomp.c/parloops-exit-first-loop-alt.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f75d60893e092cffcbe422825ce4dc092d3fb9e/libgomp%2Ftestsuite%2Flibgomp.c%2Fparloops-exit-first-loop-alt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f75d60893e092cffcbe422825ce4dc092d3fb9e/libgomp%2Ftestsuite%2Flibgomp.c%2Fparloops-exit-first-loop-alt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fparloops-exit-first-loop-alt.c?ref=4f75d60893e092cffcbe422825ce4dc092d3fb9e", "patch": "@@ -13,7 +13,8 @@ unsigned int b[N];\n unsigned int c[N];\n \n void __attribute__((noclone,noinline))\n-f (unsigned int n)\n+f (unsigned int n, unsigned int *__restrict__ a, unsigned int *__restrict__ b,\n+   unsigned int *__restrict__ c)\n {\n   int i;\n \n@@ -36,7 +37,7 @@ main (void)\n \tc[k] = k * 2;\n       }\n \n-  f (N);\n+  f (N, a, b, c);\n \n   for (i = 0; i < N; i++)\n     {"}]}