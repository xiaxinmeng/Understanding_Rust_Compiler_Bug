{"sha": "c21938bee0d0a5cb3da442d3d4500d2eeb416b44", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzIxOTM4YmVlMGQwYTVjYjNkYTQ0MmQzZDQ1MDBkMmVlYjQxNmI0NA==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@adacore.com", "date": "2020-01-24T16:58:35Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-06-04T09:11:08Z"}, "message": "[Ada] Wrong walk order in Walk_Library_Items\n\n2020-06-04  Arnaud Charlet  <charlet@adacore.com>\n\ngcc/ada/\n\n\t* sem.adb (Walk_Library_Items): Defer processing of main spec\n\tafter all other specs and before processing bodies.", "tree": {"sha": "8d5d54dd0c83c1af229c5e08097b8d17e4d09ed6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8d5d54dd0c83c1af229c5e08097b8d17e4d09ed6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c21938bee0d0a5cb3da442d3d4500d2eeb416b44", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c21938bee0d0a5cb3da442d3d4500d2eeb416b44", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c21938bee0d0a5cb3da442d3d4500d2eeb416b44", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c21938bee0d0a5cb3da442d3d4500d2eeb416b44/comments", "author": {"login": "ArnaudCharlet", "id": 30291825, "node_id": "MDQ6VXNlcjMwMjkxODI1", "avatar_url": "https://avatars.githubusercontent.com/u/30291825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ArnaudCharlet", "html_url": "https://github.com/ArnaudCharlet", "followers_url": "https://api.github.com/users/ArnaudCharlet/followers", "following_url": "https://api.github.com/users/ArnaudCharlet/following{/other_user}", "gists_url": "https://api.github.com/users/ArnaudCharlet/gists{/gist_id}", "starred_url": "https://api.github.com/users/ArnaudCharlet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ArnaudCharlet/subscriptions", "organizations_url": "https://api.github.com/users/ArnaudCharlet/orgs", "repos_url": "https://api.github.com/users/ArnaudCharlet/repos", "events_url": "https://api.github.com/users/ArnaudCharlet/events{/privacy}", "received_events_url": "https://api.github.com/users/ArnaudCharlet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e01dddb44e051224239d44f6042a379cbf583ab", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1e01dddb44e051224239d44f6042a379cbf583ab", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1e01dddb44e051224239d44f6042a379cbf583ab"}], "stats": {"total": 43, "additions": 30, "deletions": 13}, "files": [{"sha": "2c5c54b77121ac248cf049f3cb67664531cea8b3", "filename": "gcc/ada/sem.adb", "status": "modified", "additions": 30, "deletions": 13, "changes": 43, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c21938bee0d0a5cb3da442d3d4500d2eeb416b44/gcc%2Fada%2Fsem.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c21938bee0d0a5cb3da442d3d4500d2eeb416b44/gcc%2Fada%2Fsem.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem.adb?ref=c21938bee0d0a5cb3da442d3d4500d2eeb416b44", "patch": "@@ -1673,6 +1673,7 @@ package body Sem is\n       pragma Pack (Unit_Number_Set);\n \n       Main_CU : constant Node_Id := Cunit (Main_Unit);\n+      Spec_CU : Node_Id := Empty;\n \n       Seen, Done : Unit_Number_Set := (others => False);\n       --  Seen (X) is True after we have seen unit X in the walk. This is used\n@@ -2146,27 +2147,43 @@ package body Sem is\n                   null;\n \n                when others =>\n-                  Par := Scope (Defining_Entity (Unit (CU)));\n-\n-                  if Is_Child_Unit (Defining_Entity (Unit (CU))) then\n-                     while Present (Par)\n-                       and then Par /= Standard_Standard\n-                       and then Par /= Cunit_Entity (Main_Unit)\n-                     loop\n-                        Par := Scope (Par);\n-                     end loop;\n-                  end if;\n \n-                  if Par /= Cunit_Entity (Main_Unit) then\n-                     Do_Unit_And_Dependents (CU, N);\n-                  end if;\n+                  --  Skip spec of main unit for now, we want to process it\n+                  --  after all other specs.\n+\n+                  if Nkind (Unit (CU)) = N_Package_Declaration\n+                    and then Library_Unit (CU) = Main_CU\n+                    and then CU /= Main_CU\n+                  then\n+                     Spec_CU := CU;\n+                  else\n+                     Par := Scope (Defining_Entity (Unit (CU)));\n+\n+                     if Is_Child_Unit (Defining_Entity (Unit (CU))) then\n+                        while Present (Par)\n+                          and then Par /= Standard_Standard\n+                          and then Par /= Cunit_Entity (Main_Unit)\n+                        loop\n+                           Par := Scope (Par);\n+                        end loop;\n+                     end if;\n \n+                     if Par /= Cunit_Entity (Main_Unit) then\n+                        Do_Unit_And_Dependents (CU, N);\n+                     end if;\n+                  end if;\n             end case;\n          end;\n \n          Next_Elmt (Cur);\n       end loop;\n \n+      --  Now process main package spec if skipped\n+\n+      if Present (Spec_CU) then\n+         Do_Unit_And_Dependents (Spec_CU, Unit (Spec_CU));\n+      end if;\n+\n       --  Now process package bodies on which main depends, followed by bodies\n       --  of parents, if present, and finally main itself.\n "}]}