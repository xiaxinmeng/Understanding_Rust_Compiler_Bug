{"sha": "bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmNhZDUwMjlhOGU0OTc3MDEzZDdmYWRjMTMzZjIyZmJkZjhkZDk5ZA==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2018-05-28T08:55:52Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-05-28T08:55:52Z"}, "message": "[Ada] Fix internal error on renaming of equality for record type\n\nThis adjusts the previous change to the cases where the array type is not\nyet frozen and, therefore, where Size_Depends_On_Discriminant is not yet\ncomputed, by doing the computation manually.\n\n2018-05-28  Eric Botcazou  <ebotcazou@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch4.adb (Expand_Composite_Equality): Compute whether the size\n\tdepends on a discriminant manually instead of using the predicate\n\tSize_Depends_On_Discriminant in the array type case.\n\ngcc/testsuite/\n\n\t* gnat.dg/renaming12.adb, gnat.dg/renaming12.ads: New testcase.\n\nFrom-SVN: r260839", "tree": {"sha": "e28ebd67d4e1632a6d6a5af6fce99c5572a2770f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e28ebd67d4e1632a6d6a5af6fce99c5572a2770f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/comments", "author": null, "committer": null, "parents": [{"sha": "4fd9587f7c4b77550b6a9a1045e2687fb5d77335", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4fd9587f7c4b77550b6a9a1045e2687fb5d77335", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4fd9587f7c4b77550b6a9a1045e2687fb5d77335"}], "stats": {"total": 66, "additions": 63, "deletions": 3}, "files": [{"sha": "79df7a63e145e2d68ddb8d73a340feed2bbdfb5a", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "patch": "@@ -1,3 +1,9 @@\n+2018-05-28  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* exp_ch4.adb (Expand_Composite_Equality): Compute whether the size\n+\tdepends on a discriminant manually instead of using the predicate\n+\tSize_Depends_On_Discriminant in the array type case.\n+\n 2018-05-28  Ed Schonberg  <schonberg@adacore.com>\n \n \t* exp_unst.adb (Check_Static_Type): For a record subtype, check"}, {"sha": "e9ed0d896261488c43f5711c47932076df273980", "filename": "gcc/ada/exp_ch4.adb", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Fada%2Fexp_ch4.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Fada%2Fexp_ch4.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch4.adb?ref=bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "patch": "@@ -2435,6 +2435,10 @@ package body Exp_Ch4 is\n          else\n             declare\n                Comp_Typ : Entity_Id;\n+               Indx     : Node_Id;\n+               Ityp     : Entity_Id;\n+               Lo       : Node_Id;\n+               Hi       : Node_Id;\n \n             begin\n                --  Do the comparison in the type (or its full view) and not in\n@@ -2450,9 +2454,25 @@ package body Exp_Ch4 is\n                --  Except for the case where the bounds of the type depend on a\n                --  discriminant, or else we would run into scoping issues.\n \n-               if Size_Depends_On_Discriminant (Comp_Typ) then\n-                  Comp_Typ := Full_Type;\n-               end if;\n+               Indx := First_Index (Comp_Typ);\n+               while Present (Indx) loop\n+                  Ityp := Etype (Indx);\n+\n+                  Lo := Type_Low_Bound (Ityp);\n+                  Hi := Type_High_Bound (Ityp);\n+\n+                  if (Nkind (Lo) = N_Identifier\n+                       and then Ekind (Entity (Lo)) = E_Discriminant)\n+                    or else\n+                     (Nkind (Hi) = N_Identifier\n+                       and then Ekind (Entity (Hi)) = E_Discriminant)\n+                  then\n+                     Comp_Typ := Full_Type;\n+                     exit;\n+                  end if;\n+\n+                  Next_Index (Indx);\n+               end loop;\n \n                return Expand_Array_Equality (Nod, Lhs, Rhs, Bodies, Comp_Typ);\n             end;"}, {"sha": "b9c30ae02e7cee896e3d6ad2044ea80b41358231", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "patch": "@@ -1,3 +1,7 @@\n+2018-05-28  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* gnat.dg/renaming12.adb, gnat.dg/renaming12.ads: New testcase.\n+\n 2018-05-28  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gnat.dg/rep_clause6.adb, gnat.dg/rep_clause6.ads: New testcase."}, {"sha": "15b15068d08d00e04c4fd769c6fb9f77a88796d9", "filename": "gcc/testsuite/gnat.dg/renaming12.adb", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Ftestsuite%2Fgnat.dg%2Frenaming12.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Ftestsuite%2Fgnat.dg%2Frenaming12.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Frenaming12.adb?ref=bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "patch": "@@ -0,0 +1,7 @@\n+--  { dg-do compile }\n+\n+package body Renaming12 is\n+\n+  procedure Dummy is null;\n+\n+end Renaming12;"}, {"sha": "9c3ad7cb818ea02fc29eb8bbe7ee24f3c17eb93c", "filename": "gcc/testsuite/gnat.dg/renaming12.ads", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Ftestsuite%2Fgnat.dg%2Frenaming12.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcad5029a8e4977013d7fadc133f22fbdf8dd99d/gcc%2Ftestsuite%2Fgnat.dg%2Frenaming12.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Frenaming12.ads?ref=bcad5029a8e4977013d7fadc133f22fbdf8dd99d", "patch": "@@ -0,0 +1,23 @@\n+package Renaming12 is\n+\n+  type Index_Type is range 0 .. 40;\n+\n+  type Rec1 is record\n+    B : Boolean;\n+  end record;\n+\n+  type Arr is array (Index_Type range <>) of Rec1;\n+\n+  type Rec2 (Count : Index_Type := 0) is record\n+    A : Arr (1 .. Count);\n+  end record;\n+\n+  package Ops is\n+\n+    function \"=\" (L : Rec2; R : Rec2) return Boolean renames Renaming12.\"=\";\n+\n+  end Ops;\n+\n+  procedure Dummy;\n+\n+end Renaming12;"}]}