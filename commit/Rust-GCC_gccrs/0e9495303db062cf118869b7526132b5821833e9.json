{"sha": "0e9495303db062cf118869b7526132b5821833e9", "node_id": "C_kwDOANBUbNoAKDBlOTQ5NTMwM2RiMDYyY2YxMTg4NjliNzUyNjEzMmI1ODIxODMzZTk", "commit": {"author": {"name": "Martin Jambor", "email": "mjambor@suse.cz", "date": "2022-12-14T18:01:11Z"}, "committer": {"name": "Martin Jambor", "email": "mjambor@suse.cz", "date": "2022-12-14T18:08:58Z"}, "message": "ipa-sra: Consider the first parameter of methods safe to dereference\n\nHonza requested this after reviewing the patch that taught IPA-SRA\nthat REFERENCE_TYPEs are always non-NULL that the pass also handles\nthe first parameters of methods, this pointers, in the same way.  So\nthis patch does that.\n\ngcc/ChangeLog:\n\n2022-12-14  Martin Jambor  <mjambor@suse.cz>\n\n\t* ipa-sra.cc (create_parameter_descriptors): Consider the first\n\tparameter of a method safe to dereference.\n\ngcc/testsuite/ChangeLog:\n\n2022-12-14  Martin Jambor  <mjambor@suse.cz>\n\n\t* g++.dg/ipa/ipa-sra-6.C: New test.", "tree": {"sha": "d3b8e817445c867426a3af1017f24bac6c744103", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d3b8e817445c867426a3af1017f24bac6c744103"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0e9495303db062cf118869b7526132b5821833e9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE5elVTFt/d09Vsoczv2PBvD+kNUAFAmOaEToACgkQv2PBvD+k\nNUDL4g//ScwhakiBQL+Qt96Qo+wRAR3T1IGNOod8mg+L5Zsed9hON2F55tjv6zX+\noH9VTnU8NoE8u7n82Or8bbUi+p85kBoHGBKi0lPS9/1BNdQTTFxg9Fy4dCsK99Nn\nGcgU7VoTYfume7cqMVI4vGsJcd8OITOSvcgoM6kvUwh287fXs7/mRRQmvOjhl0cr\nMFnMSn6jdiZGl3CIpulnRwrYVYVnPGWrZOzCBwQojYTQvtBOIlIQeSFxSfW5OJtG\no+WnFAnVD/RdkIwwcNM1/u2GXOGL92wtNtRX7RQeNWhdTSb2zDkx6lX/tMU6wdiD\nDViyurvjGPcUvtWRNWWzt+lODCxwStk4qs453JuRA9Xb1bGmPh7NzYn7JkgaMJlO\nmcrGQg8Zsk3XCsRJIu1C5beCm9TnsdgK+LTlVuGhpa4NJSw5xdqJjUu7A81yUSli\nwwNz6a+A0uT3dkOp7bFHH8xX29ONQ84y1Hy7Ee4842a17DStbwfestm5igtahYSR\nT2MRZy/E9EoFHoqefQcfAXp/3z3lLNIo29pqG2mWroilC+f0Qg3UYRfZn9uZe73P\nSlli8/764GdzJ7ovtpdi6EIfNtqt+CKydSN4wpCzoDAUpS3LUk44S+SEjXqIk1bd\nz4S1ZeyKqvpPaHAkXS3jwA6xP/+Md2jnBENDdR66rqD/s6AcihA=\n=w+kU\n-----END PGP SIGNATURE-----", "payload": "tree d3b8e817445c867426a3af1017f24bac6c744103\nparent 6539bbc14836b8e0fa08944be2c069b58bed9455\nauthor Martin Jambor <mjambor@suse.cz> 1671040871 +0100\ncommitter Martin Jambor <mjambor@suse.cz> 1671041338 +0100\n\nipa-sra: Consider the first parameter of methods safe to dereference\n\nHonza requested this after reviewing the patch that taught IPA-SRA\nthat REFERENCE_TYPEs are always non-NULL that the pass also handles\nthe first parameters of methods, this pointers, in the same way.  So\nthis patch does that.\n\ngcc/ChangeLog:\n\n2022-12-14  Martin Jambor  <mjambor@suse.cz>\n\n\t* ipa-sra.cc (create_parameter_descriptors): Consider the first\n\tparameter of a method safe to dereference.\n\ngcc/testsuite/ChangeLog:\n\n2022-12-14  Martin Jambor  <mjambor@suse.cz>\n\n\t* g++.dg/ipa/ipa-sra-6.C: New test.\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0e9495303db062cf118869b7526132b5821833e9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0e9495303db062cf118869b7526132b5821833e9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0e9495303db062cf118869b7526132b5821833e9/comments", "author": {"login": "jamborm", "id": 2180070, "node_id": "MDQ6VXNlcjIxODAwNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/2180070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamborm", "html_url": "https://github.com/jamborm", "followers_url": "https://api.github.com/users/jamborm/followers", "following_url": "https://api.github.com/users/jamborm/following{/other_user}", "gists_url": "https://api.github.com/users/jamborm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamborm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamborm/subscriptions", "organizations_url": "https://api.github.com/users/jamborm/orgs", "repos_url": "https://api.github.com/users/jamborm/repos", "events_url": "https://api.github.com/users/jamborm/events{/privacy}", "received_events_url": "https://api.github.com/users/jamborm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jamborm", "id": 2180070, "node_id": "MDQ6VXNlcjIxODAwNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/2180070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamborm", "html_url": "https://github.com/jamborm", "followers_url": "https://api.github.com/users/jamborm/followers", "following_url": "https://api.github.com/users/jamborm/following{/other_user}", "gists_url": "https://api.github.com/users/jamborm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamborm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamborm/subscriptions", "organizations_url": "https://api.github.com/users/jamborm/orgs", "repos_url": "https://api.github.com/users/jamborm/repos", "events_url": "https://api.github.com/users/jamborm/events{/privacy}", "received_events_url": "https://api.github.com/users/jamborm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6539bbc14836b8e0fa08944be2c069b58bed9455", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6539bbc14836b8e0fa08944be2c069b58bed9455", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6539bbc14836b8e0fa08944be2c069b58bed9455"}], "stats": {"total": 69, "additions": 68, "deletions": 1}, "files": [{"sha": "6fe336eeb194c1e29320c3add1843fe3ad4e4260", "filename": "gcc/ipa-sra.cc", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0e9495303db062cf118869b7526132b5821833e9/gcc%2Fipa-sra.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0e9495303db062cf118869b7526132b5821833e9/gcc%2Fipa-sra.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-sra.cc?ref=0e9495303db062cf118869b7526132b5821833e9", "patch": "@@ -1206,7 +1206,12 @@ create_parameter_descriptors (cgraph_node *node,\n       if (POINTER_TYPE_P (type))\n \t{\n \t  desc->by_ref = true;\n-\t  desc->safe_ref = (TREE_CODE (type) == REFERENCE_TYPE);\n+\t  if (TREE_CODE (type) == REFERENCE_TYPE\n+\t      || (num == 0\n+\t\t  && TREE_CODE (TREE_TYPE (node->decl)) == METHOD_TYPE))\n+\t    desc->safe_ref = true;\n+\t  else\n+\t    desc->safe_ref = false;\n \t  type = TREE_TYPE (type);\n \n \t  if (TREE_CODE (type) == FUNCTION_TYPE"}, {"sha": "d6b7822533fc2d7c86d7d4182f9af63d7daf6684", "filename": "gcc/testsuite/g++.dg/ipa/ipa-sra-6.C", "status": "added", "additions": 62, "deletions": 0, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0e9495303db062cf118869b7526132b5821833e9/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fipa-sra-6.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0e9495303db062cf118869b7526132b5821833e9/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fipa-sra-6.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fipa-sra-6.C?ref=0e9495303db062cf118869b7526132b5821833e9", "patch": "@@ -0,0 +1,62 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-ipa-sra\"  } */\n+\n+namespace {\n+\n+class C\n+{\n+\n+  int mi;\n+\n+public:\n+  C (int i)\n+    : mi(i)\n+  {}\n+\n+  void foo (int c);\n+};\n+\n+volatile int vi;\n+\n+\n+void __attribute__((noinline))\n+C::foo (int cond)\n+{\n+  int i;\n+  if (cond)\n+    i = mi;\n+  else\n+    i = 0;\n+  vi = i;\n+}\n+\n+static C c_instance(1);\n+}\n+\n+void __attribute__((noinline))\n+bar (C *p, int cond)\n+{\n+  p->foo (cond);\n+}\n+\n+\n+class C *gp;\n+\n+void something(void);\n+\n+void\n+baz (int cond)\n+{\n+  C c(vi);\n+  gp = &c;\n+  something ();\n+  bar (gp, cond);\n+}\n+\n+void\n+hoo(void)\n+{\n+  gp = &c_instance;\n+}\n+\n+/* { dg-final { scan-ipa-dump \"Will split parameter\" \"sra\" } } */"}]}