{"sha": "955379e4ed77883365cd041840bb17245810c095", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTU1Mzc5ZTRlZDc3ODgzMzY1Y2QwNDE4NDBiYjE3MjQ1ODEwYzA5NQ==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2019-12-12T10:02:55Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-12-12T10:02:55Z"}, "message": "[Ada] Fix wrong value of 'Size for slices of bit-packed arrays (2)\n\n2019-12-12  Eric Botcazou  <ebotcazou@adacore.com>\n\ngcc/ada/\n\n\t* exp_attr.adb (Expand_Size_Attribute): Look directly at the\n\tprefix to detect the bit-packed slices.  Apply the checks last\n\tin case the attribute needs to be processed by the back-end.\n\t* exp_ch4.adb (Expand_N_Slice): Do not create a temporary for\n\ta prefix of the Size attribute.\n\nFrom-SVN: r279293", "tree": {"sha": "7201b41fb940173e82ed415219cb5e03390d695b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7201b41fb940173e82ed415219cb5e03390d695b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/955379e4ed77883365cd041840bb17245810c095", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/955379e4ed77883365cd041840bb17245810c095", "html_url": "https://github.com/Rust-GCC/gccrs/commit/955379e4ed77883365cd041840bb17245810c095", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/955379e4ed77883365cd041840bb17245810c095/comments", "author": null, "committer": null, "parents": [{"sha": "16b5f07b5d210a7ae55576043855f50fa72f55db", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/16b5f07b5d210a7ae55576043855f50fa72f55db", "html_url": "https://github.com/Rust-GCC/gccrs/commit/16b5f07b5d210a7ae55576043855f50fa72f55db"}], "stats": {"total": 23, "additions": 16, "deletions": 7}, "files": [{"sha": "cf79c7d2a625a56326ca11e85be2e2b9f9170ed9", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/955379e4ed77883365cd041840bb17245810c095/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/955379e4ed77883365cd041840bb17245810c095/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=955379e4ed77883365cd041840bb17245810c095", "patch": "@@ -1,3 +1,11 @@\n+2019-12-12  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* exp_attr.adb (Expand_Size_Attribute): Look directly at the\n+\tprefix to detect the bit-packed slices.  Apply the checks last\n+\tin case the attribute needs to be processed by the back-end.\n+\t* exp_ch4.adb (Expand_N_Slice): Do not create a temporary for\n+\ta prefix of the Size attribute.\n+\n 2019-12-12  Steve Baird  <baird@adacore.com>\n \n \t* sem_ch12.adb"}, {"sha": "c7b6451430e72abd92bcf542fa7a429333e0c5ab", "filename": "gcc/ada/exp_attr.adb", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/955379e4ed77883365cd041840bb17245810c095/gcc%2Fada%2Fexp_attr.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/955379e4ed77883365cd041840bb17245810c095/gcc%2Fada%2Fexp_attr.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_attr.adb?ref=955379e4ed77883365cd041840bb17245810c095", "patch": "@@ -7455,8 +7455,6 @@ package body Exp_Attr is\n       --  All other cases are handled by the back end\n \n       else\n-         Apply_Universal_Integer_Attribute_Checks (N);\n-\n          --  If Size is applied to a formal parameter that is of a packed\n          --  array subtype, then apply Size to the actual subtype.\n \n@@ -7489,9 +7487,7 @@ package body Exp_Attr is\n          --  System.Unsigned_Types.Packed_Byte for code generation purposes so\n          --  the size is always rounded up in the back end.\n \n-         elsif Nkind (Original_Node (Pref)) = N_Slice\n-           and then Is_Bit_Packed_Array (Ptyp)\n-         then\n+         elsif Nkind (Pref) = N_Slice and then Is_Bit_Packed_Array (Ptyp) then\n             Rewrite (N,\n               Make_Op_Multiply (Loc,\n                 Make_Attribute_Reference (Loc,\n@@ -7503,6 +7499,9 @@ package body Exp_Attr is\n             Analyze_And_Resolve (N, Typ);\n          end if;\n \n+         --  Apply the required checks last, after rewriting has taken place\n+\n+         Apply_Universal_Integer_Attribute_Checks (N);\n          return;\n       end if;\n "}, {"sha": "20b3babdc3015ca85faf36bd31df96235c24bf9e", "filename": "gcc/ada/exp_ch4.adb", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/955379e4ed77883365cd041840bb17245810c095/gcc%2Fada%2Fexp_ch4.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/955379e4ed77883365cd041840bb17245810c095/gcc%2Fada%2Fexp_ch4.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch4.adb?ref=955379e4ed77883365cd041840bb17245810c095", "patch": "@@ -11013,7 +11013,8 @@ package body Exp_Ch4 is\n \n       --    5. Prefix of an address attribute (this is an error which is caught\n       --       elsewhere, and the expansion would interfere with generating the\n-      --       error message).\n+      --       error message) or of a size attribute (because 'Size may change\n+      --       when applied to the temporary instead of the slice directly).\n \n       if not Is_Packed (Typ) then\n \n@@ -11039,7 +11040,8 @@ package body Exp_Ch4 is\n          return;\n \n       elsif Nkind (Parent (N)) = N_Attribute_Reference\n-        and then Attribute_Name (Parent (N)) = Name_Address\n+        and then (Attribute_Name (Parent (N)) = Name_Address\n+                   or else Attribute_Name (Parent (N)) = Name_Size)\n       then\n          return;\n "}]}