{"sha": "1fe27030ff6424736ddda42874a018d6bc35db70", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWZlMjcwMzBmZjY0MjQ3MzZkZGRhNDI4NzRhMDE4ZDZiYzM1ZGI3MA==", "commit": {"author": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2019-02-09T17:25:23Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gcc.gnu.org", "date": "2019-02-09T17:25:23Z"}, "message": "re PR fortran/89077 (ICE using * as len specifier for character parameter)\n\n2019-02-09  Harald Anlauf  <anlauf@gmx.de>\n\n\tPR fortran/89077\n\t* resolve.c (gfc_resolve_substring_charlen): Check substring\n\tlength for constantness prior to general calculation of length.\n\n\tPR fortran/89077\n\t* gfortran.dg/substr_simplify.f90: New test.\n\nFrom-SVN: r268726", "tree": {"sha": "cd215e137ab074f7b775c4f7669e2327ff4b535d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cd215e137ab074f7b775c4f7669e2327ff4b535d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1fe27030ff6424736ddda42874a018d6bc35db70", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1fe27030ff6424736ddda42874a018d6bc35db70", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1fe27030ff6424736ddda42874a018d6bc35db70", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1fe27030ff6424736ddda42874a018d6bc35db70/comments", "author": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5585759fdb6cc1e870670970473b789b3b920961", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5585759fdb6cc1e870670970473b789b3b920961", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5585759fdb6cc1e870670970473b789b3b920961"}], "stats": {"total": 56, "additions": 51, "deletions": 5}, "files": [{"sha": "b5a4c0a2f64788d88608377769005593fe2667a3", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=1fe27030ff6424736ddda42874a018d6bc35db70", "patch": "@@ -1,3 +1,9 @@\n+2019-02-09  Harald Anlauf  <anlauf@gmx.de>\n+\n+\tPR fortran/89077\n+\t* resolve.c (gfc_resolve_substring_charlen): Check substring\n+\tlength for constantness prior to general calculation of length.\n+\n 2019-02-09  Paul Thomas  <pault@gcc.gnu.org>\n \n \tPR fortran/89200"}, {"sha": "3a8f4022df1c12d4eee6a9812c29d9039dbf322b", "filename": "gcc/fortran/resolve.c", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ffortran%2Fresolve.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ffortran%2Fresolve.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fresolve.c?ref=1fe27030ff6424736ddda42874a018d6bc35db70", "patch": "@@ -4965,6 +4965,7 @@ gfc_resolve_substring_charlen (gfc_expr *e)\n   gfc_ref *char_ref;\n   gfc_expr *start, *end;\n   gfc_typespec *ts = NULL;\n+  mpz_t diff;\n \n   for (char_ref = e->ref; char_ref; char_ref = char_ref->next)\n     {\n@@ -5016,11 +5017,25 @@ gfc_resolve_substring_charlen (gfc_expr *e)\n       return;\n     }\n \n-  /* Length = (end - start + 1).  */\n-  e->ts.u.cl->length = gfc_subtract (end, start);\n-  e->ts.u.cl->length = gfc_add (e->ts.u.cl->length,\n-\t\t\t\tgfc_get_int_expr (gfc_charlen_int_kind,\n-\t\t\t\t\t\t  NULL, 1));\n+  /* Length = (end - start + 1).\n+     Check first whether it has a constant length.  */\n+  if (gfc_dep_difference (end, start, &diff))\n+    {\n+      gfc_expr *len = gfc_get_constant_expr (BT_INTEGER, gfc_charlen_int_kind,\n+\t\t\t\t\t     &e->where);\n+\n+      mpz_add_ui (len->value.integer, diff, 1);\n+      mpz_clear (diff);\n+      e->ts.u.cl->length = len;\n+      /* The check for length < 0 is handled below */\n+    }\n+  else\n+    {\n+      e->ts.u.cl->length = gfc_subtract (end, start);\n+      e->ts.u.cl->length = gfc_add (e->ts.u.cl->length,\n+\t\t\t\t    gfc_get_int_expr (gfc_charlen_int_kind,\n+\t\t\t\t\t\t      NULL, 1));\n+    }\n \n   /* F2008, 6.4.1:  Both the starting point and the ending point shall\n      be within the range 1, 2, ..., n unless the starting point exceeds"}, {"sha": "c0af04397e469353d945d90717c2c1b5de4a0caf", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=1fe27030ff6424736ddda42874a018d6bc35db70", "patch": "@@ -1,3 +1,8 @@\n+2019-02-09  Harald Anlauf  <anlauf@gmx.de>\n+\n+\tPR fortran/89077\n+\t* gfortran.dg/substr_simplify.f90: New test.\n+\n 2019-02-09  Jan Hubicka  <hubicka@ucw.cz>\n \n \tPR ipa/88711"}, {"sha": "7e1e1c243698b508c3698ebefe565a26523802df", "filename": "gcc/testsuite/gfortran.dg/substr_simplify.f90", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ftestsuite%2Fgfortran.dg%2Fsubstr_simplify.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fe27030ff6424736ddda42874a018d6bc35db70/gcc%2Ftestsuite%2Fgfortran.dg%2Fsubstr_simplify.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fsubstr_simplify.f90?ref=1fe27030ff6424736ddda42874a018d6bc35db70", "patch": "@@ -0,0 +1,20 @@\n+! { dg-do run }\n+!\n+! Test fixes for substring simplications derived from\n+! PR fortran/89077 - ICE using * as len specifier for character parameter\n+\n+program test\n+  implicit none\n+  integer :: i\n+  character(*), parameter :: s = 'abcdef', y = 'efcdab'\n+  character(6), save      :: t = transfer ([(s(i:i),  i=1,len(s)  )], s)\n+  character(*), parameter :: u = transfer ([(s(i:i+2),i=1,len(s),3)], s)\n+  character(6), save      :: v = transfer ([(s(i:i+2),i=1,len(s),3)], s)\n+  character(*), parameter :: w = transfer ([(y(i:i+1),i=len(s)-1,1,-2)], s)\n+  character(6), save      :: x = transfer ([(y(i:i+1),i=len(s)-1,1,-2)], s)\n+  if (len (t) /= len (s) .or. t /= s) stop 1\n+  if (len (u) /= len (s) .or. u /= s) stop 2\n+  if (len (v) /= len (s) .or. v /= s) stop 3\n+  if (len (w) /= len (s) .or. w /= s) stop 4\n+  if (len (x) /= len (s) .or. x /= s) stop 5\n+end"}]}