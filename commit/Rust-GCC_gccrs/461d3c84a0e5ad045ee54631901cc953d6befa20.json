{"sha": "461d3c84a0e5ad045ee54631901cc953d6befa20", "node_id": "C_kwDOANBUbNoAKDQ2MWQzYzg0YTBlNWFkMDQ1ZWU1NDYzMTkwMWNjOTUzZDZiZWZhMjA", "commit": {"author": {"name": "Max Filippov", "email": "jcmvbkbc@gmail.com", "date": "2023-02-22T22:17:11Z"}, "committer": {"name": "Max Filippov", "email": "jcmvbkbc@gmail.com", "date": "2023-02-25T14:03:56Z"}, "message": "gcc: xtensa: fix PR target/108919\n\ngcc/\n\tPR target/108919\n\n\t* config/xtensa/xtensa-protos.h\n\t(xtensa_prepare_expand_call): Rename to xtensa_expand_call.\n\t* config/xtensa/xtensa.cc (xtensa_prepare_expand_call): Rename\n\tto xtensa_expand_call.\n\t(xtensa_expand_call): Emit the call and add a clobber expression\n\tfor the static chain to it in case of windowed ABI.\n\t* config/xtensa/xtensa.md (call, call_value, sibcall)\n\t(sibcall_value): Call xtensa_expand_call and complete expansion\n\tright after that call.\n\ngcc/testsuite/\n\t* gcc.target/xtensa/pr108919.c: New test.", "tree": {"sha": "918e7ead05ffd2e997a49ea12bf38f58645215d8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/918e7ead05ffd2e997a49ea12bf38f58645215d8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/461d3c84a0e5ad045ee54631901cc953d6befa20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/461d3c84a0e5ad045ee54631901cc953d6befa20", "html_url": "https://github.com/Rust-GCC/gccrs/commit/461d3c84a0e5ad045ee54631901cc953d6befa20", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/461d3c84a0e5ad045ee54631901cc953d6befa20/comments", "author": {"login": "jcmvbkbc", "id": 166731, "node_id": "MDQ6VXNlcjE2NjczMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jcmvbkbc", "html_url": "https://github.com/jcmvbkbc", "followers_url": "https://api.github.com/users/jcmvbkbc/followers", "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}", "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}", "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions", "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs", "repos_url": "https://api.github.com/users/jcmvbkbc/repos", "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}", "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jcmvbkbc", "id": 166731, "node_id": "MDQ6VXNlcjE2NjczMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jcmvbkbc", "html_url": "https://github.com/jcmvbkbc", "followers_url": "https://api.github.com/users/jcmvbkbc/followers", "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}", "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}", "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions", "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs", "repos_url": "https://api.github.com/users/jcmvbkbc/repos", "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}", "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d3e427f684b0cd7cedbe7b93a06f455e562c5901", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d3e427f684b0cd7cedbe7b93a06f455e562c5901", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d3e427f684b0cd7cedbe7b93a06f455e562c5901"}], "stats": {"total": 85, "additions": 79, "deletions": 6}, "files": [{"sha": "c81cf94323ac8b27858a4280c9c816b1d60a81e9", "filename": "gcc/config/xtensa/xtensa-protos.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Fconfig%2Fxtensa%2Fxtensa-protos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Fconfig%2Fxtensa%2Fxtensa-protos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa-protos.h?ref=461d3c84a0e5ad045ee54631901cc953d6befa20", "patch": "@@ -53,7 +53,7 @@ extern void xtensa_expand_atomic (enum rtx_code, rtx, rtx, rtx, bool);\n extern void xtensa_emit_loop_end (rtx_insn *, rtx *);\n extern char *xtensa_emit_branch (bool, rtx *);\n extern char *xtensa_emit_movcc (bool, bool, bool, rtx *);\n-extern void xtensa_prepare_expand_call (int, rtx *);\n+extern void xtensa_expand_call (int, rtx *);\n extern char *xtensa_emit_call (int, rtx *);\n extern char *xtensa_emit_sibcall (int, rtx *);\n extern bool xtensa_tls_referenced_p (rtx);"}, {"sha": "5044bc25c2fef46fd4f9b234dc65582aa381ee7c", "filename": "gcc/config/xtensa/xtensa.cc", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Fconfig%2Fxtensa%2Fxtensa.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Fconfig%2Fxtensa%2Fxtensa.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa.cc?ref=461d3c84a0e5ad045ee54631901cc953d6befa20", "patch": "@@ -2183,8 +2183,10 @@ xtensa_emit_movcc (bool inverted, bool isfp, bool isbool, rtx *operands)\n \n \n void\n-xtensa_prepare_expand_call (int callop, rtx *operands)\n+xtensa_expand_call (int callop, rtx *operands)\n {\n+  rtx call;\n+  rtx_insn *call_insn;\n   rtx addr = XEXP (operands[callop], 0);\n \n   if (flag_pic && SYMBOL_REF_P (addr)\n@@ -2202,6 +2204,27 @@ xtensa_prepare_expand_call (int callop, rtx *operands)\n \t\t\t\t Pmode);\n       XEXP (operands[callop], 0) = reg;\n     }\n+\n+  call = gen_rtx_CALL (VOIDmode, operands[callop], operands[callop + 1]);\n+\n+  if (callop)\n+    call = gen_rtx_SET (operands[0], call);\n+\n+  call_insn = emit_call_insn (call);\n+\n+  if (TARGET_WINDOWED_ABI)\n+    {\n+      /*\n+       * Windowed xtensa ABI specifies that static chain pointer is passed\n+       * in memory below the caller's stack pointer, which means that the\n+       * callee may clobber it if it's a non-leaf function.\n+       * Add the clobber expression for the static chain to the function call\n+       * expression list so that it is not assumed to be live across the call.\n+       */\n+      rtx clob = gen_rtx_CLOBBER (Pmode, xtensa_static_chain (NULL, false));\n+      CALL_INSN_FUNCTION_USAGE (call_insn) =\n+\tgen_rtx_EXPR_LIST (Pmode, clob, CALL_INSN_FUNCTION_USAGE (call_insn));\n+    }\n }\n \n "}, {"sha": "b60dec2447f319b6e238dc11d367b680c6619226", "filename": "gcc/config/xtensa/xtensa.md", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Fconfig%2Fxtensa%2Fxtensa.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Fconfig%2Fxtensa%2Fxtensa.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa.md?ref=461d3c84a0e5ad045ee54631901cc953d6befa20", "patch": "@@ -2333,7 +2333,8 @@\n \t (match_operand 1 \"\" \"\"))]\n   \"\"\n {\n-  xtensa_prepare_expand_call (0, operands);\n+  xtensa_expand_call (0, operands);\n+  DONE;\n })\n \n (define_insn \"call_internal\"\n@@ -2353,7 +2354,8 @@\n \t      (match_operand 2 \"\" \"\")))]\n   \"\"\n {\n-  xtensa_prepare_expand_call (1, operands);\n+  xtensa_expand_call (1, operands);\n+  DONE;\n })\n \n (define_insn \"call_value_internal\"\n@@ -2373,7 +2375,8 @@\n \t (match_operand 1 \"\" \"\"))]\n   \"!TARGET_WINDOWED_ABI\"\n {\n-  xtensa_prepare_expand_call (0, operands);\n+  xtensa_expand_call (0, operands);\n+  DONE;\n })\n \n (define_insn \"sibcall_internal\"\n@@ -2393,7 +2396,8 @@\n \t      (match_operand 2 \"\" \"\")))]\n   \"!TARGET_WINDOWED_ABI\"\n {\n-  xtensa_prepare_expand_call (1, operands);\n+  xtensa_expand_call (1, operands);\n+  DONE;\n })\n \n (define_insn \"sibcall_value_internal\""}, {"sha": "300b6fd10a9923addaccdc4074258274390b4c0a", "filename": "gcc/testsuite/gcc.target/xtensa/pr108919.c", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Ftestsuite%2Fgcc.target%2Fxtensa%2Fpr108919.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/461d3c84a0e5ad045ee54631901cc953d6befa20/gcc%2Ftestsuite%2Fgcc.target%2Fxtensa%2Fpr108919.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fxtensa%2Fpr108919.c?ref=461d3c84a0e5ad045ee54631901cc953d6befa20", "patch": "@@ -0,0 +1,46 @@\n+/* { dg-do run } */\n+/* { dg-options \"-O2\" } */\n+\n+\n+#ifdef __XTENSA_CALL0_ABI__\n+void __xtensa_libgcc_window_spill (void)\n+{\n+}\n+#else\n+void __xtensa_libgcc_window_spill (void);\n+#endif\n+\n+__attribute__((noinline)) void h (void)\n+{\n+  __xtensa_libgcc_window_spill ();\n+}\n+\n+int f (int u, int v)\n+{\n+  int a = u;\n+  int s;\n+\n+  __attribute__((noinline,pure)) int nested1 (int b)\n+  {\n+      h();\n+      return a + b;\n+  }\n+\n+  __attribute__((noinline,pure)) int nested2 (int b)\n+  {\n+      h();\n+      return a - b;\n+  }\n+\n+  s = nested1 (v);\n+  s += nested2 (v);\n+  return s;\n+}\n+\n+int main (void)\n+{\n+  int u = 0x12345678;\n+  int v = 1;\n+\n+  return f (u, v) == 2 * u ? 0 : 1;\n+}"}]}