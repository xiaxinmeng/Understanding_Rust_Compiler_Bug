{"sha": "2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmU1NzQ4ZDI4NjhkMWM4ZDI0ZDg0ZmUwYmNmOTkxNmNmMGZmYzUyNw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2010-11-14T00:06:48Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2010-11-14T00:06:48Z"}, "message": "decl.c (cp_finish_decl): Use resolve_nondeduced_context for auto.\n\n\t* decl.c (cp_finish_decl): Use resolve_nondeduced_context for auto.\n\t* init.c (build_new): Likewise.\n\t* pt.c (tsubst_decl): Likewise.\n\t(do_auto_deduction): Likewise.\n\t(resolve_nondeduced_context): Use build_offset_ref and\n\tcp_build_addr_expr.\n\nFrom-SVN: r166724", "tree": {"sha": "84b63e06c1023a70ed249614db5aad83a0de1ba7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/84b63e06c1023a70ed249614db5aad83a0de1ba7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d86216483294d8789d2f92168511d6508c80dbd1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d86216483294d8789d2f92168511d6508c80dbd1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d86216483294d8789d2f92168511d6508c80dbd1"}], "stats": {"total": 64, "additions": 56, "deletions": 8}, "files": [{"sha": "418951aaa403e87396955713f1a12cfb7779a561", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "patch": "@@ -1,3 +1,12 @@\n+2010-11-13  Jason Merrill  <jason@redhat.com>\n+\n+\t* decl.c (cp_finish_decl): Use resolve_nondeduced_context for auto.\n+\t* init.c (build_new): Likewise.\n+\t* pt.c (tsubst_decl): Likewise.\n+\t(do_auto_deduction): Likewise.\n+\t(resolve_nondeduced_context): Use build_offset_ref and\n+\tcp_build_addr_expr.\n+\n 2010-11-12  Joseph Myers  <joseph@codesourcery.com>\n \n \t* Make-lang.in (g++spec.o): Use $(OPTS_H)."}, {"sha": "714516e3336c8dd8f46ebe3822d8246187feb2bb", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "patch": "@@ -5761,6 +5761,7 @@ cp_finish_decl (tree decl, tree init, bool init_const_expr_p,\n       if (TREE_CODE (d_init) == TREE_LIST)\n \td_init = build_x_compound_expr_from_list (d_init, ELK_INIT,\n \t\t\t\t\t\t  tf_warning_or_error);\n+      d_init = resolve_nondeduced_context (d_init);\n       if (describable_type (d_init))\n \t{\n \t  type = TREE_TYPE (decl) = do_auto_deduction (type, d_init,"}, {"sha": "670c7a519043d88fce8735a12f02be068ff571b4", "filename": "gcc/cp/init.c", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.c?ref=2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "patch": "@@ -2516,8 +2516,13 @@ build_new (VEC(tree,gc) **placement, tree type, tree nelts,\n   if (nelts == NULL_TREE && VEC_length (tree, *init) == 1)\n     {\n       tree auto_node = type_uses_auto (type);\n-      if (auto_node && describable_type (VEC_index (tree, *init, 0)))\n-\ttype = do_auto_deduction (type, VEC_index (tree, *init, 0), auto_node);\n+      if (auto_node)\n+\t{\n+\t  tree d_init = VEC_index (tree, *init, 0);\n+\t  d_init = resolve_nondeduced_context (d_init);\n+\t  if (describable_type (d_init))\n+\t    type = do_auto_deduction (type, d_init, auto_node);\n+\t}\n     }\n \n   if (processing_template_decl)"}, {"sha": "3e8b62cd5216064f3d856e7f6dd529a94e45f47b", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "patch": "@@ -10035,10 +10035,14 @@ tsubst_decl (tree t, tree args, tsubst_flags_t complain)\n \t      = tsubst_expr (DECL_INITIAL (t), args, complain, in_decl,\n \t\t\t     /*constant_expression_p=*/false);\n \n-\t    if (auto_node && init && describable_type (init))\n+\t    if (auto_node && init)\n \t      {\n-\t\ttype = do_auto_deduction (type, init, auto_node);\n-\t\tTREE_TYPE (r) = type;\n+\t\tinit = resolve_nondeduced_context (init);\n+\t\tif (describable_type (init))\n+\t\t  {\n+\t\t    type = do_auto_deduction (type, init, auto_node);\n+\t\t    TREE_TYPE (r) = type;\n+\t\t  }\n \t      }\n \t  }\n \telse\n@@ -14338,10 +14342,13 @@ resolve_nondeduced_context (tree orig_expr)\n \t\t\t\t   BASELINK_ACCESS_BINFO (baselink),\n \t\t\t\t   expr, BASELINK_OPTYPE (baselink));\n \t  if (offset)\n-\t    expr = build2 (OFFSET_REF, TREE_TYPE (expr),\n-\t\t\t   TREE_OPERAND (offset, 0), expr);\n+\t    {\n+\t      tree base\n+\t\t= TYPE_MAIN_VARIANT (TREE_TYPE (TREE_OPERAND (offset, 0)));\n+\t      expr = build_offset_ref (base, expr, addr);\n+\t    }\n \t  if (addr)\n-\t    expr = build_address (expr);\n+\t    expr = cp_build_addr_expr (expr, tf_warning_or_error);\n \t  return expr;\n \t}\n       else if (good == 0 && badargs)\n@@ -18890,6 +18897,8 @@ do_auto_deduction (tree type, tree init, tree auto_node)\n   if (BRACE_ENCLOSED_INITIALIZER_P (init))\n     type = listify_autos (type, auto_node);\n \n+  init = resolve_nondeduced_context (init);\n+\n   parms = build_tree_list (NULL_TREE, type);\n   args[0] = init;\n   tparms = make_tree_vec (1);"}, {"sha": "f5456a1e9f7c6d1c256b40cda3edd1c68e0ad657", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "patch": "@@ -1,3 +1,7 @@\n+2010-11-13  Jason Merrill  <jason@redhat.com>\n+\n+\t* g++.dg/cpp0x/auto20.C: New.\n+\n 2010-11-13  Iain Sandoe  <iains@gcc.gnu.org>\n \n \t* objc.dg/fsf-nsstring-format-1.m: Adjust format messages."}, {"sha": "90f875114a0fed638f139c96067bd5d0ca03ee39", "filename": "gcc/testsuite/g++.dg/cpp0x/auto20.C", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fauto20.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fauto20.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fauto20.C?ref=2e5748d2868d1c8d24d84fe0bcf9916cf0ffc527", "patch": "@@ -0,0 +1,20 @@\n+// Test for proper non-deduced context handling of the initializer\n+// for an auto declaration/new.\n+// { dg-options -std=c++0x }\n+\n+struct with_apply\n+{\n+  template <unsigned>\n+  void apply(const double&){}\n+};\n+\n+auto p = &with_apply::apply<0>;\n+auto pp = new auto(&with_apply::apply<0>);\n+\n+template <class T>\n+void f()\n+{\n+  auto p = &T::template apply<0>;\n+}\n+\n+template void f<with_apply>();"}]}