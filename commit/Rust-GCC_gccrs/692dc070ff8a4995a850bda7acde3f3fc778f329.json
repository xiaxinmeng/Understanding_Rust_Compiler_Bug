{"sha": "692dc070ff8a4995a850bda7acde3f3fc778f329", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjkyZGMwNzBmZjhhNDk5NWE4NTBiZGE3YWNkZTNmM2ZjNzc4ZjMyOQ==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2017-11-16T10:36:04Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2017-11-16T10:36:04Z"}, "message": "cfgloopanal.c: Include sreal.h\n\n\t* cfgloopanal.c: Include sreal.h\n\t(average_num_loop_insns): Use counts and sreal for accounting.\n\nFrom-SVN: r254807", "tree": {"sha": "12edf21e1ddd62fe4273fa6cf611ae9887b3ef2f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/12edf21e1ddd62fe4273fa6cf611ae9887b3ef2f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/692dc070ff8a4995a850bda7acde3f3fc778f329", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/692dc070ff8a4995a850bda7acde3f3fc778f329", "html_url": "https://github.com/Rust-GCC/gccrs/commit/692dc070ff8a4995a850bda7acde3f3fc778f329", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/692dc070ff8a4995a850bda7acde3f3fc778f329/comments", "author": null, "committer": null, "parents": [{"sha": "e7b655e8fdf3c32e01a97588445211254c52b6c2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e7b655e8fdf3c32e01a97588445211254c52b6c2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e7b655e8fdf3c32e01a97588445211254c52b6c2"}], "stats": {"total": 26, "additions": 16, "deletions": 10}, "files": [{"sha": "e3bf8eed1f141f582fb874816fa557fe8f914fed", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/692dc070ff8a4995a850bda7acde3f3fc778f329/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/692dc070ff8a4995a850bda7acde3f3fc778f329/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=692dc070ff8a4995a850bda7acde3f3fc778f329", "patch": "@@ -1,3 +1,8 @@\n+2017-11-14  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* cfgloopanal.c: Include sreal.h\n+\t(average_num_loop_insns): Use counts and sreal for accounting.\n+\n 2017-11-14  Jan Hubicka  <hubicka@ucw.cz>\n \n \t* cfgloopmanip.c (duplicate_loop_to_header_edge): Cleanup profile"}, {"sha": "63f7eab7ef9b55c4ef29fc284e8015801643f11a", "filename": "gcc/cfgloopanal.c", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/692dc070ff8a4995a850bda7acde3f3fc778f329/gcc%2Fcfgloopanal.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/692dc070ff8a4995a850bda7acde3f3fc778f329/gcc%2Fcfgloopanal.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfgloopanal.c?ref=692dc070ff8a4995a850bda7acde3f3fc778f329", "patch": "@@ -31,6 +31,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"expr.h\"\n #include \"graphds.h\"\n #include \"params.h\"\n+#include \"sreal.h\"\n \n struct target_cfgloop default_target_cfgloop;\n #if SWITCHABLE_TARGET\n@@ -199,7 +200,8 @@ int\n average_num_loop_insns (const struct loop *loop)\n {\n   basic_block *bbs, bb;\n-  unsigned i, binsns, ninsns, ratio;\n+  unsigned i, binsns;\n+  sreal ninsns;\n   rtx_insn *insn;\n \n   ninsns = 0;\n@@ -213,19 +215,18 @@ average_num_loop_insns (const struct loop *loop)\n \tif (NONDEBUG_INSN_P (insn))\n \t  binsns++;\n \n-      ratio = loop->header->count.to_frequency (cfun) == 0\n-\t      ? BB_FREQ_MAX\n-\t      : (bb->count.to_frequency (cfun) * BB_FREQ_MAX)\n-\t\t / loop->header->count.to_frequency (cfun);\n-      ninsns += binsns * ratio;\n+      ninsns += (sreal)binsns * bb->count.to_sreal_scale (loop->header->count);\n+      /* Avoid overflows.   */\n+      if (ninsns > 1000000)\n+\treturn 100000;\n     }\n   free (bbs);\n \n-  ninsns /= BB_FREQ_MAX;\n-  if (!ninsns)\n-    ninsns = 1; /* To avoid division by zero.  */\n+  int64_t ret = ninsns.to_int ();\n+  if (!ret)\n+    ret = 1; /* To avoid division by zero.  */\n \n-  return ninsns;\n+  return ret;\n }\n \n /* Returns expected number of iterations of LOOP, according to"}]}