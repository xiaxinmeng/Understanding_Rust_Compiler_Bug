{"sha": "256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjU2ZWVmYTlhOTQ5N2ZhZThkY2M4YmI5NmM4YTI4ZGQ5YzNlNmRjOA==", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2013-08-30T07:33:06Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2013-08-30T07:33:06Z"}, "message": "lto-symtab.c (lto_cgraph_replace_node): Free decl_in_state.\n\n\t* lto-symtab.c (lto_cgraph_replace_node): Free decl_in_state.\n\t* cgraph.c (cgraph_release_function_body): Free decl_in_state.\n\t* lto-section-in.c (lto_free_function_in_decl_state): New function.\n\t(lto_free_function_in_decl_state_for_node): New function.\n\n\t* lto.c (read_cgraph_and_symbols): Remove ggc_collect;\n\tclear section node; add comment why we do not collect.\n\nFrom-SVN: r202093", "tree": {"sha": "64eb6436c13bf84949443327cd89e6ca2e8bee1c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/64eb6436c13bf84949443327cd89e6ca2e8bee1c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/comments", "author": null, "committer": null, "parents": [{"sha": "3f0fdc34ffab3a288401fd51c95851f1e8d445bf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3f0fdc34ffab3a288401fd51c95851f1e8d445bf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3f0fdc34ffab3a288401fd51c95851f1e8d445bf"}], "stats": {"total": 49, "additions": 48, "deletions": 1}, "files": [{"sha": "feb17bb0dd93cb0c3c0fecf9b441c51d5610b8fe", "filename": "gcc/cgraph.c", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Fcgraph.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Fcgraph.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.c?ref=256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "patch": "@@ -1663,6 +1663,8 @@ cgraph_release_function_body (struct cgraph_node *node)\n   if (!node->used_as_abstract_origin && DECL_INITIAL (node->symbol.decl))\n     DECL_INITIAL (node->symbol.decl) = error_mark_node;\n   release_function_body (node->symbol.decl);\n+  if (node->symbol.lto_file_data)\n+    lto_free_function_in_decl_state_for_node ((symtab_node) node);\n }\n \n /* Remove the node from cgraph.  */\n@@ -3107,10 +3109,11 @@ cgraph_get_body (struct cgraph_node *node)\n \n   gcc_assert (DECL_STRUCT_FUNCTION (decl) == NULL);\n \n-  lto_input_function_body (file_data, decl, data);\n+  lto_input_function_body (file_data, node->symbol.decl, data);\n   lto_stats.num_function_bodies++;\n   lto_free_section_data (file_data, LTO_section_function_body, name,\n \t\t\t data, len);\n+  lto_free_function_in_decl_state_for_node ((symtab_node) node);\n   return true;\n }\n "}, {"sha": "5821030d4cfb3c6599a3ae04e64b27df17e9cd7b", "filename": "gcc/lto-section-in.c", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto-section-in.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto-section-in.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-section-in.c?ref=256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "patch": "@@ -414,6 +414,41 @@ lto_get_function_in_decl_state (struct lto_file_decl_data *file_data,\n   return slot? ((struct lto_in_decl_state*) *slot) : NULL;\n }\n \n+/* Free decl_states.  */\n+\n+void\n+lto_free_function_in_decl_state (struct lto_in_decl_state *state)\n+{\n+  int i;\n+  for (i = 0; i < LTO_N_DECL_STREAMS; i++)\n+    ggc_free (state->streams[i].trees);\n+  ggc_free (state);\n+}\n+\n+/* Free decl_states associated with NODE.  This makes it possible to furhter\n+   release trees needed by the NODE's body.  */\n+\n+void\n+lto_free_function_in_decl_state_for_node (symtab_node node)\n+{\n+  struct lto_in_decl_state temp;\n+  void **slot;\n+\n+  if (!node->symbol.lto_file_data)\n+    return;\n+\n+  temp.fn_decl = node->symbol.decl;\n+  slot = htab_find_slot (node->symbol.lto_file_data->function_decl_states,\n+\t\t\t &temp, NO_INSERT);\n+  if (slot && *slot)\n+    {\n+      lto_free_function_in_decl_state ((struct lto_in_decl_state*) *slot);\n+      htab_clear_slot (node->symbol.lto_file_data->function_decl_states,\n+\t\t       slot);\n+    }\n+  node->symbol.lto_file_data = NULL;\n+}\n+\n \n /* Report read pass end of the section.  */\n "}, {"sha": "7c2add7232aad9765b0ef4450e30af16665d6b56", "filename": "gcc/lto-symtab.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto-symtab.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto-symtab.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-symtab.c?ref=256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "patch": "@@ -80,6 +80,8 @@ lto_cgraph_replace_node (struct cgraph_node *node,\n   /* Redirect incomming references.  */\n   ipa_clone_referring ((symtab_node)prevailing_node, &node->symbol.ref_list);\n \n+  lto_free_function_in_decl_state_for_node ((symtab_node)node);\n+\n   if (node->symbol.decl != prevailing_node->symbol.decl)\n     cgraph_release_function_body (node);\n "}, {"sha": "965a78ce5c80ce1ded618a6f86a53695252e66b0", "filename": "gcc/lto/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2FChangeLog?ref=256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "patch": "@@ -1,3 +1,7 @@\n+2013-08-29  Jan Hubicka  <jh@suse.cz>\n+\n+\t* lto.c (read_cgraph_and_symbols): Free decl states.\n+\n 2013-08-29  Jan Hubicka  <jh@suse.cz>\n \n \t* lto.c (compare_tree_sccs_1): Compare  DECL_FINAL_P,"}, {"sha": "cc0ed69a5f285d0fc6d4f97aeee77f21ba9b98ff", "filename": "gcc/lto/lto.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto%2Flto.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8/gcc%2Flto%2Flto.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto.c?ref=256eefa9a9497fae8dcc8bb96c8a28dd9c3e6dc8", "patch": "@@ -3502,6 +3502,9 @@ read_cgraph_and_symbols (unsigned nfiles, const char **fnames)\n       gcc_assert (all_file_decl_data[i]->symtab_node_encoder);\n       lto_symtab_encoder_delete (all_file_decl_data[i]->symtab_node_encoder);\n       all_file_decl_data[i]->symtab_node_encoder = NULL;\n+      lto_free_function_in_decl_state (all_file_decl_data[i]->global_decl_state);\n+      all_file_decl_data[i]->global_decl_state = NULL;\n+      all_file_decl_data[i]->current_decl_state = NULL; \n     }\n \n   /* Finally merge the cgraph according to the decl merging decisions.  */"}]}