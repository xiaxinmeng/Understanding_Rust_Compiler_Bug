{"sha": "a21bd3cebd6f54af70a37c18b8fbeae933fb6515", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTIxYmQzY2ViZDZmNTRhZjcwYTM3YzE4YjhmYmVhZTkzM2ZiNjUxNQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-07-27T07:59:37Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-07-27T07:59:37Z"}, "message": "gimple-fold: Fix up __builtin_clear_padding on classes with virtual inheritence [PR101586]\n\nFor the following testcase, B is 16-byte type, containing 8-byte\nvirtual pointer and 1-byte A member, and C contains two FIELD_DECLs,\none with B type and size of just 8-byte and then a field with type\nA and 1-byte size.\nThe __builtin_clear_padding code was upset about the B typed FIELD_DECL\ncontaining FIELD_DECLs beyond the field size and triggered\nassertion failure.\nThis patch makes it ignore all FIELD_DECLs that are (fully) beyond the sz\npassed from the caller (except for the flexible array member\ndiagnostics that is kept).\n\n2021-07-27  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR middle-end/101586\n\t* gimple-fold.c (clear_padding_type): Ignore FIELD_DECLs with byte\n\tpositions above or equal to sz except for diagnostics of flexible\n\tarray members.\n\n\t* g++.dg/torture/builtin-clear-padding-4.C: New test.", "tree": {"sha": "84262a34a51b1b3a9fc51ac12d9d6239bb737598", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/84262a34a51b1b3a9fc51ac12d9d6239bb737598"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a21bd3cebd6f54af70a37c18b8fbeae933fb6515", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a21bd3cebd6f54af70a37c18b8fbeae933fb6515", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a21bd3cebd6f54af70a37c18b8fbeae933fb6515", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a21bd3cebd6f54af70a37c18b8fbeae933fb6515/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5485e820cd0554886af282265198c7433c64c7b9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5485e820cd0554886af282265198c7433c64c7b9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5485e820cd0554886af282265198c7433c64c7b9"}], "stats": {"total": 48, "additions": 48, "deletions": 0}, "files": [{"sha": "b6f6054354384e4ded7ee3cc46b2e1d10e663f2d", "filename": "gcc/gimple-fold.c", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a21bd3cebd6f54af70a37c18b8fbeae933fb6515/gcc%2Fgimple-fold.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a21bd3cebd6f54af70a37c18b8fbeae933fb6515/gcc%2Fgimple-fold.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-fold.c?ref=a21bd3cebd6f54af70a37c18b8fbeae933fb6515", "patch": "@@ -4697,6 +4697,8 @@ clear_padding_type (clear_padding_struct *buf, tree type, HOST_WIDE_INT sz)\n \t\tif (fldsz == 0)\n \t\t  continue;\n \t\tHOST_WIDE_INT pos = int_byte_position (field);\n+\t\tif (pos >= sz)\n+\t\t  continue;\n \t\tHOST_WIDE_INT bpos\n \t\t  = tree_to_uhwi (DECL_FIELD_BIT_OFFSET (field));\n \t\tbpos %= BITS_PER_UNIT;\n@@ -4772,6 +4774,8 @@ clear_padding_type (clear_padding_struct *buf, tree type, HOST_WIDE_INT sz)\n \t    else\n \t      {\n \t\tHOST_WIDE_INT pos = int_byte_position (field);\n+\t\tif (pos >= sz)\n+\t\t  continue;\n \t\tHOST_WIDE_INT fldsz = tree_to_shwi (DECL_SIZE_UNIT (field));\n \t\tgcc_assert (pos >= 0 && fldsz >= 0 && pos >= cur_pos);\n \t\tclear_padding_add_padding (buf, pos - cur_pos);"}, {"sha": "5936cdf876b201d90d293f00fa9e5c5bd4bc97dc", "filename": "gcc/testsuite/g++.dg/torture/builtin-clear-padding-4.C", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a21bd3cebd6f54af70a37c18b8fbeae933fb6515/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fbuiltin-clear-padding-4.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a21bd3cebd6f54af70a37c18b8fbeae933fb6515/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fbuiltin-clear-padding-4.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fbuiltin-clear-padding-4.C?ref=a21bd3cebd6f54af70a37c18b8fbeae933fb6515", "patch": "@@ -0,0 +1,44 @@\n+// PR middle-end/101586\n+\n+struct A { char a; };\n+struct B : virtual A {};\n+struct C : B {};\n+struct D : virtual A, C {};\n+\n+__attribute__((noipa)) A *\n+baz (C *p, D *q)\n+{\n+  if (p)\n+    return dynamic_cast <A *> (p);\n+  else\n+    return dynamic_cast <A *> (q);\n+}\n+\n+void\n+foo ()\n+{ \n+  C c;\n+  c.a = 42;\n+  __builtin_clear_padding (&c);\n+  A *p = baz (&c, 0);\n+  if (c.a != 42 || p->a != 42)\n+    __builtin_abort ();\n+}\n+\n+void\n+bar ()\n+{\n+  D d;\n+  d.a = 42;\n+  __builtin_clear_padding (&d);\n+  A *p = baz (0, &d);\n+  if (d.a != 42 || p->a != 42)\n+    __builtin_abort ();\n+}\n+\n+int\n+main ()\n+{\n+  foo ();\n+  bar ();\n+}"}]}