{"sha": "179682a55cbe229442cf3886e338148be0b12a96", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTc5NjgyYTU1Y2JlMjI5NDQyY2YzODg2ZTMzODE0OGJlMGIxMmE5Ng==", "commit": {"author": {"name": "Yannick Moy", "email": "moy@adacore.com", "date": "2019-07-10T09:02:42Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-10T09:02:42Z"}, "message": "[Ada] Fix spurious messages on global variables for SPARK pointer support\n\nPointer support in GNATprove leads to spurious messages about global\nvariables, with local variables declared in local packages and protected\ncomponents. Now fixed.\n\nThere is no impact on compilation.\n\n2019-07-10  Yannick Moy  <moy@adacore.com>\n\ngcc/ada/\n\n\t* sem_aux.adb, sem_aux.ads (Is_Protected_Operation): New\n\tfunction to determine if a subprogram is protected.\n\t* sem_spark.adb (Setup_Protected_Components): New procedure to\n\tadd protected components to the environment.\n\t(Check_Callable_Body): Call the new Setup_Protected_Components.\n\t(Check_Package_Spec): Merge local environment with enclosing one\n\twhen done.\n\nFrom-SVN: r273349", "tree": {"sha": "ac0baad8dc30cdd7e9118a00eac8133d3a0839ee", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ac0baad8dc30cdd7e9118a00eac8133d3a0839ee"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/179682a55cbe229442cf3886e338148be0b12a96", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/179682a55cbe229442cf3886e338148be0b12a96", "html_url": "https://github.com/Rust-GCC/gccrs/commit/179682a55cbe229442cf3886e338148be0b12a96", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/179682a55cbe229442cf3886e338148be0b12a96/comments", "author": {"login": "yannickmoy", "id": 859440, "node_id": "MDQ6VXNlcjg1OTQ0MA==", "avatar_url": "https://avatars.githubusercontent.com/u/859440?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yannickmoy", "html_url": "https://github.com/yannickmoy", "followers_url": "https://api.github.com/users/yannickmoy/followers", "following_url": "https://api.github.com/users/yannickmoy/following{/other_user}", "gists_url": "https://api.github.com/users/yannickmoy/gists{/gist_id}", "starred_url": "https://api.github.com/users/yannickmoy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yannickmoy/subscriptions", "organizations_url": "https://api.github.com/users/yannickmoy/orgs", "repos_url": "https://api.github.com/users/yannickmoy/repos", "events_url": "https://api.github.com/users/yannickmoy/events{/privacy}", "received_events_url": "https://api.github.com/users/yannickmoy/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1bc68e0d30bc801a279da653196d66d36312831b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1bc68e0d30bc801a279da653196d66d36312831b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1bc68e0d30bc801a279da653196d66d36312831b"}], "stats": {"total": 78, "additions": 76, "deletions": 2}, "files": [{"sha": "e781181583e505c0d618ddfe7a00ae5b8724bc58", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=179682a55cbe229442cf3886e338148be0b12a96", "patch": "@@ -1,3 +1,13 @@\n+2019-07-10  Yannick Moy  <moy@adacore.com>\n+\n+\t* sem_aux.adb, sem_aux.ads (Is_Protected_Operation): New\n+\tfunction to determine if a subprogram is protected.\n+\t* sem_spark.adb (Setup_Protected_Components): New procedure to\n+\tadd protected components to the environment.\n+\t(Check_Callable_Body): Call the new Setup_Protected_Components.\n+\t(Check_Package_Spec): Merge local environment with enclosing one\n+\twhen done.\n+\n 2019-07-10  Claire Dross  <dross@adacore.com>\n \n \t* sem_spark.adb (Check_Expression): Allow digits constraints as"}, {"sha": "6a93a3970e959211b462533a00643ed3401df234", "filename": "gcc/ada/sem_aux.adb", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2Fsem_aux.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2Fsem_aux.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_aux.adb?ref=179682a55cbe229442cf3886e338148be0b12a96", "patch": "@@ -1324,6 +1324,18 @@ package body Sem_Aux is\n       end if;\n    end Is_Limited_View;\n \n+   ----------------------------\n+   -- Is_Protected_Operation --\n+   ----------------------------\n+\n+   function Is_Protected_Operation (E : Entity_Id) return Boolean is\n+   begin\n+      return Is_Entry (E)\n+        or else (Is_Subprogram (E)\n+                 and then Nkind (Parent (Unit_Declaration_Node (E))) =\n+                            N_Protected_Definition);\n+   end Is_Protected_Operation;\n+\n    ----------------------\n    -- Nearest_Ancestor --\n    ----------------------"}, {"sha": "55cfefa92a344d631fc042d241c2fe080c6916cd", "filename": "gcc/ada/sem_aux.ads", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2Fsem_aux.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2Fsem_aux.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_aux.ads?ref=179682a55cbe229442cf3886e338148be0b12a96", "patch": "@@ -357,6 +357,10 @@ package Sem_Aux is\n    --  these types). This older routine overlaps with the previous one, this\n    --  should be cleaned up???\n \n+   function Is_Protected_Operation (E : Entity_Id) return Boolean;\n+   --  Given a subprogram or entry, determines whether E is a protected entry\n+   --  or subprogram.\n+\n    function Nearest_Ancestor (Typ : Entity_Id) return Entity_Id;\n    --  Given a subtype Typ, this function finds out the nearest ancestor from\n    --  which constraints and predicates are inherited. There is no simple link"}, {"sha": "10c82fffc73cd703833b742ef0ee6f1759b19cea", "filename": "gcc/ada/sem_spark.adb", "status": "modified", "additions": 50, "deletions": 2, "changes": 52, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2Fsem_spark.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/179682a55cbe229442cf3886e338148be0b12a96/gcc%2Fada%2Fsem_spark.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_spark.adb?ref=179682a55cbe229442cf3886e338148be0b12a96", "patch": "@@ -876,6 +876,10 @@ package body Sem_SPARK is\n    --  Takes a subprogram as input, and sets up the environment by adding\n    --  formal parameters with appropriate permissions.\n \n+   procedure Setup_Protected_Components (Subp : Entity_Id);\n+   --  Takes a protected operation as input, and sets up the environment by\n+   --  adding protected components with appropriate permissions.\n+\n    ----------------------\n    -- Global Variables --\n    ----------------------\n@@ -1336,6 +1340,13 @@ package body Sem_SPARK is\n          Setup_Globals (Spec_Id);\n       end if;\n \n+      --  For protected operations, add protected components to the environment\n+      --  with adequate permissions.\n+\n+      if Is_Protected_Operation (Spec_Id) then\n+         Setup_Protected_Components (Spec_Id);\n+      end if;\n+\n       --  Analyze the body of the subprogram\n \n       Check_List (Declarations (Body_N));\n@@ -2634,9 +2645,13 @@ package body Sem_SPARK is\n             Check_List (Private_Declarations (Spec));\n          end if;\n \n-         --  Restore the saved environment and free the current one\n+         --  Restore the saved environment and free the current one. As part of\n+         --  the restoration, the environment of the package spec is merged in\n+         --  the enclosing environment, which may be an enclosing\n+         --  package/subprogram spec or body which has access to the variables\n+         --  of the package spec.\n \n-         Move_Env (Saved_Env, Current_Perm_Env);\n+         Merge_Env (Saved_Env, Current_Perm_Env);\n \n          Inside_Elaboration := Save_In_Elab;\n       end if;\n@@ -5418,4 +5433,37 @@ package body Sem_SPARK is\n       end loop;\n    end Setup_Parameters;\n \n+   --------------------------------\n+   -- Setup_Protected_Components --\n+   --------------------------------\n+\n+   procedure Setup_Protected_Components (Subp : Entity_Id) is\n+      Typ  : constant Entity_Id := Scope (Subp);\n+      Comp : Entity_Id;\n+      Kind : Formal_Kind;\n+\n+   begin\n+      Comp := First_Component_Or_Discriminant (Typ);\n+\n+      --  The protected object is an implicit input of protected functions, and\n+      --  an implicit input-output of protected procedures and entries.\n+\n+      if Ekind (Subp) = E_Function then\n+         Kind := E_In_Parameter;\n+      else\n+         Kind := E_In_Out_Parameter;\n+      end if;\n+\n+      while Present (Comp) loop\n+         Setup_Parameter_Or_Global\n+           (Id         => Comp,\n+            Typ        => Underlying_Type (Etype (Comp)),\n+            Kind       => Kind,\n+            Subp       => Subp,\n+            Global_Var => False,\n+            Expl       => Comp);\n+         Next_Component_Or_Discriminant (Comp);\n+      end loop;\n+   end Setup_Protected_Components;\n+\n end Sem_SPARK;"}]}