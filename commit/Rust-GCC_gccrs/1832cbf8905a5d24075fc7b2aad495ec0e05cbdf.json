{"sha": "1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTgzMmNiZjg5MDVhNWQyNDA3NWZjN2IyYWFkNDk1ZWMwZTA1Y2JkZg==", "commit": {"author": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2018-03-30T09:56:46Z"}, "committer": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2018-03-30T09:56:46Z"}, "message": "re PR fortran/85111 (ICE in min_max_choose, at fortran/simplify.c:4884 (and others))\n\n2017-03-30  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/85111\n\t* array.c (gfc_resolve_character_array_constructor): Early\n\texit for zero-size arrays.\n\t* simplify.c (simplify_transformation_to_array): Exit early\n\tif the result size is zero.\n\t(simplify_minmaxloc_to_array): Likewise.\n\n2017-03-30  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/85111\n\t* gfortran.dg/zero_sized_10.f90: New test.\n\nFrom-SVN: r258973", "tree": {"sha": "9d6078e8de36849ab7fc144cb5f8f8ff09b58bed", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9d6078e8de36849ab7fc144cb5f8f8ff09b58bed"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/comments", "author": null, "committer": null, "parents": [{"sha": "06be18e782b9497ffda6523786a38f13f1412e36", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/06be18e782b9497ffda6523786a38f13f1412e36", "html_url": "https://github.com/Rust-GCC/gccrs/commit/06be18e782b9497ffda6523786a38f13f1412e36"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "58d611ba4f57307d36a15dc6fdd5b6e5baa8705e", "filename": "gcc/fortran/array.c", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/gcc%2Ffortran%2Farray.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/gcc%2Ffortran%2Farray.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Farray.c?ref=1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "patch": "@@ -2003,6 +2003,20 @@ gfc_resolve_character_array_constructor (gfc_expr *expr)\n \n got_charlen:\n \n+  /* Early exit for zero size arrays. */\n+  if (expr->shape)\n+    {\n+      mpz_t size;\n+      HOST_WIDE_INT arraysize;\n+\n+      gfc_array_size (expr, &size);\n+      arraysize = mpz_get_ui (size);\n+      mpz_clear (size);\n+\n+      if (arraysize == 0)\n+\treturn true;\n+    }\n+\n   found_length = -1;\n \n   if (expr->ts.u.cl->length == NULL)"}, {"sha": "18295978e420f910fa11f9ff351cbaa5f2efe82e", "filename": "gcc/fortran/simplify.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/gcc%2Ffortran%2Fsimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/gcc%2Ffortran%2Fsimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fsimplify.c?ref=1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "patch": "@@ -627,7 +627,7 @@ simplify_transformation_to_array (gfc_expr *result, gfc_expr *array, gfc_expr *d\n       n += 1;\n     }\n \n-  done = false;\n+  done = resultsize <= 0;\n   base = arrayvec;\n   dest = resultvec;\n   while (!done)\n@@ -5304,7 +5304,7 @@ simplify_minmaxloc_to_array (gfc_expr *result, gfc_expr *array,\n       n += 1;\n     }\n \n-  done = false;\n+  done = resultsize <= 0;\n   base = arrayvec;\n   dest = resultvec;\n   while (!done)"}, {"sha": "f152b3aba63eb063725cf9a5082b0e3312889f4e", "filename": "gcc/testsuite/gfortran.dg/zero_sized_10.f90", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/gcc%2Ftestsuite%2Fgfortran.dg%2Fzero_sized_10.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1832cbf8905a5d24075fc7b2aad495ec0e05cbdf/gcc%2Ftestsuite%2Fgfortran.dg%2Fzero_sized_10.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fzero_sized_10.f90?ref=1832cbf8905a5d24075fc7b2aad495ec0e05cbdf", "patch": "@@ -0,0 +1,10 @@\n+! { dg-do compile }\n+! { PR 85111 - this used to ICE. }\n+! Original test case by Gernhard Steinmetz.\n+program p\n+   integer, parameter :: a(2,0) = reshape([1,2,3,4], shape(a))\n+   character, parameter :: ac(2,0) = reshape(['a','b','c','d'], shape(ac))\n+   integer, parameter :: b(2) = maxloc(a, dim=1) ! { dg-error \"Different shape\" }\n+   integer, parameter :: c(2) = minloc(a, dim=1) ! { dg-error \"Different shape\" }\n+   character, parameter :: d(2) = maxval(ac, dim=1) ! { dg-error \"Different shape\" }\n+ end program p"}]}