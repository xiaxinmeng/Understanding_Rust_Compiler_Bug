{"sha": "06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDZjOWViNTEzNmZlMGU3NzhjYzNhNjQzMTMxZWJhMmEzZGZiNzdhOA==", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2011-01-10T21:54:33Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2011-01-10T21:54:33Z"}, "message": "re PR lto/46083 (gcc.dg/initpri1.c FAILs with -flto/-fwhopr (attribute constructor/destructor doesn't work))\n\n\n\tPR lto/46083\n\t* lto-streamer-out.c (pack_ts_function_decl_value_fields): Store\n\tDECL_FINI_PRIORITY.\n\t* lto-streamer-in.c (unpack_ts_function_decl_value_fields):\n\tRestore DECL_FINI_PRIORITY.\n\t* gcc.dg/initpri3.c: New testcase.\n\nFrom-SVN: r168642", "tree": {"sha": "6b65373a74635a6fc6d17e3e730f07357c92cc14", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6b65373a74635a6fc6d17e3e730f07357c92cc14"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/comments", "author": null, "committer": null, "parents": [{"sha": "b88e4ef16ca4ccaee24c9399977977e349cbe0cd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b88e4ef16ca4ccaee24c9399977977e349cbe0cd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b88e4ef16ca4ccaee24c9399977977e349cbe0cd"}], "stats": {"total": 84, "additions": 84, "deletions": 0}, "files": [{"sha": "14d5066fdf03ccc9c07f16510821cc2d3ca1d1b7", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "patch": "@@ -1,3 +1,11 @@\n+2011-01-10  Jan Hubicka  <jh@suse.cz>\n+\n+\tPR lto/46083\n+\t* lto-streamer-out.c (pack_ts_function_decl_value_fields): Store\n+\tDECL_FINI_PRIORITY.\n+\t* lto-streamer-in.c (unpack_ts_function_decl_value_fields):\n+\tRestore DECL_FINI_PRIORITY.\n+\n 2011-01-10  Ralf Wildenhues  <Ralf.Wildenhues@gmx.de>\n \n \t* doc/gimple.texi: Fix quoting of multi-word return values in"}, {"sha": "ba48cbb3f60ea649b38ab3cf560dbbb467c13086", "filename": "gcc/lto-streamer-in.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Flto-streamer-in.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Flto-streamer-in.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-in.c?ref=06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "patch": "@@ -1683,6 +1683,11 @@ unpack_ts_function_decl_value_fields (struct bitpack_d *bp, tree expr)\n   DECL_DISREGARD_INLINE_LIMITS (expr) = (unsigned) bp_unpack_value (bp, 1);\n   DECL_PURE_P (expr) = (unsigned) bp_unpack_value (bp, 1);\n   DECL_LOOPING_CONST_OR_PURE_P (expr) = (unsigned) bp_unpack_value (bp, 1);\n+  if (DECL_STATIC_DESTRUCTOR (expr))\n+    {\n+       priority_type p = (priority_type) bp_unpack_value (bp, HOST_BITS_PER_SHORT);\n+       SET_DECL_FINI_PRIORITY (expr, p);\n+    }\n }\n \n "}, {"sha": "82c2f6feae51704e655ce496c5f6e085a1c5f01b", "filename": "gcc/lto-streamer-out.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Flto-streamer-out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Flto-streamer-out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-out.c?ref=06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "patch": "@@ -496,6 +496,8 @@ pack_ts_function_decl_value_fields (struct bitpack_d *bp, tree expr)\n   bp_pack_value (bp, DECL_DISREGARD_INLINE_LIMITS (expr), 1);\n   bp_pack_value (bp, DECL_PURE_P (expr), 1);\n   bp_pack_value (bp, DECL_LOOPING_CONST_OR_PURE_P (expr), 1);\n+  if (DECL_STATIC_DESTRUCTOR (expr))\n+    bp_pack_value (bp, DECL_FINI_PRIORITY (expr), HOST_BITS_PER_SHORT);\n }\n \n "}, {"sha": "6df0d8e0dd9920bd129e5517eeae4db6e6ab0dc0", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "patch": "@@ -1,3 +1,8 @@\n+2011-01-10  Jan Hubicka  <jh@suse.cz>\n+\n+\tPR lto/46083\n+\t* gcc.dg/initpri3.c: New testcase.\n+\n 2011-01-10  H.J. Lu  <hongjiu.lu@intel.com>\n \n \tPR lto/47222"}, {"sha": "1633da0141f67ce8d446c445625c5da58c8f38f9", "filename": "gcc/testsuite/gcc.dg/initpri3.c", "status": "added", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Ftestsuite%2Fgcc.dg%2Finitpri3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/06c9eb5136fe0e778cc3a643131eba2a3dfb77a8/gcc%2Ftestsuite%2Fgcc.dg%2Finitpri3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Finitpri3.c?ref=06c9eb5136fe0e778cc3a643131eba2a3dfb77a8", "patch": "@@ -0,0 +1,64 @@\n+/* { dg-do run { target init_priority } } */\n+/* { dg-require-effective-target lto } */\n+/* { dg-options \"-flto -O3\" } */\n+\n+extern void abort ();\n+\n+int i;\n+int j;\n+\n+void c1() __attribute__((constructor (500)));\n+void c2() __attribute__((constructor (700)));\n+void c3() __attribute__((constructor (600)));\n+\n+void c1() {\n+  if (i++ != 0)\n+    abort ();\n+}\n+\n+void c2() {\n+  if (i++ != 2)\n+    abort ();\n+}\n+\n+void c3() {\n+  if (i++ != 1)\n+    abort ();\n+}\n+\n+void d1() __attribute__((destructor (500)));\n+void d2() __attribute__((destructor (700)));\n+void d3() __attribute__((destructor (600)));\n+\n+void d1() {\n+  if (--i != 0)\n+    abort ();\n+}\n+\n+void d2() {\n+  if (--i != 2)\n+    abort ();\n+}\n+\n+void d3() {\n+  if (j != 2)\n+    abort ();\n+  if (--i != 1)\n+    abort ();\n+}\n+\n+void cd4() __attribute__((constructor (800), destructor (800)));\n+\n+void cd4() {\n+  if (i != 3)\n+    abort ();\n+  ++j;\n+}\n+\n+int main () {\n+  if (i != 3)\n+    return 1;\n+  if (j != 1)\n+    abort ();\n+  return 0;\n+}"}]}