{"sha": "db0f1c7a906bd8798a4016c1622f5999897e7469", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGIwZjFjN2E5MDZiZDg3OThhNDAxNmMxNjIyZjU5OTk4OTdlNzQ2OQ==", "commit": {"author": {"name": "Tom de Vries", "email": "tom@codesourcery.com", "date": "2015-12-02T15:48:45Z"}, "committer": {"name": "Tom de Vries", "email": "vries@gcc.gnu.org", "date": "2015-12-02T15:48:45Z"}, "message": "Fix oacc kernels default mapping for scalars\n\n2015-12-02  Tom de Vries  <tom@codesourcery.com>\n\n\t* gimplify.c (enum gimplify_omp_var_data): Add enum value\n\tGOVD_MAP_FORCE.\n\t(oacc_default_clause): Fix default for scalars in oacc kernels.\n\t(gimplify_adjust_omp_clauses_1): Handle GOVD_MAP_FORCE.\n\n\t* c-c++-common/goacc/kernels-default-2.c: New test.\n\t* c-c++-common/goacc/kernels-default.c: New test.\n\nFrom-SVN: r231183", "tree": {"sha": "2109ec421b66624aa21cc5439979c233fc5ae881", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2109ec421b66624aa21cc5439979c233fc5ae881"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/db0f1c7a906bd8798a4016c1622f5999897e7469", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/db0f1c7a906bd8798a4016c1622f5999897e7469", "html_url": "https://github.com/Rust-GCC/gccrs/commit/db0f1c7a906bd8798a4016c1622f5999897e7469", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/db0f1c7a906bd8798a4016c1622f5999897e7469/comments", "author": null, "committer": null, "parents": [{"sha": "86938de6f646b403fe6a2eaea3aac9f4e91224fd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/86938de6f646b403fe6a2eaea3aac9f4e91224fd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/86938de6f646b403fe6a2eaea3aac9f4e91224fd"}], "stats": {"total": 62, "additions": 57, "deletions": 5}, "files": [{"sha": "ef5fbefd7b4830ed8b9283bedd3ac3c5009c1cd9", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=db0f1c7a906bd8798a4016c1622f5999897e7469", "patch": "@@ -1,3 +1,10 @@\n+2015-12-02  Tom de Vries  <tom@codesourcery.com>\n+\n+\t* gimplify.c (enum gimplify_omp_var_data): Add enum value\n+\tGOVD_MAP_FORCE.\n+\t(oacc_default_clause): Fix default for scalars in oacc kernels.\n+\t(gimplify_adjust_omp_clauses_1): Handle GOVD_MAP_FORCE.\n+\n 2015-12-02  Tom de Vries  <tom@codesourcery.com>\n \n \t* omp-low.c (install_var_field, scan_sharing_clauses): Add and handle"}, {"sha": "7146a01a5afe0656f1fca3beb5c9a4129a1641ac", "filename": "gcc/gimplify.c", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=db0f1c7a906bd8798a4016c1622f5999897e7469", "patch": "@@ -90,6 +90,9 @@ enum gimplify_omp_var_data\n   /* Flag for shared vars that are or might be stored to in the region.  */\n   GOVD_WRITTEN = 131072,\n \n+  /* Flag for GOVD_MAP, if it is a forced mapping.  */\n+  GOVD_MAP_FORCE = 262144,\n+\n   GOVD_DATA_SHARE_CLASS = (GOVD_SHARED | GOVD_PRIVATE | GOVD_FIRSTPRIVATE\n \t\t\t   | GOVD_LASTPRIVATE | GOVD_REDUCTION | GOVD_LINEAR\n \t\t\t   | GOVD_LOCAL)\n@@ -5980,8 +5983,12 @@ oacc_default_clause (struct gimplify_omp_ctx *ctx, tree decl, unsigned flags)\n       gcc_unreachable ();\n \n     case ORT_ACC_KERNELS:\n-      /* Everything under kernels are default 'present_or_copy'.  */\n+      /* Scalars are default 'copy' under kernels, non-scalars are default\n+\t 'present_or_copy'.  */\n       flags |= GOVD_MAP;\n+      if (!AGGREGATE_TYPE_P (TREE_TYPE (decl)))\n+\tflags |= GOVD_MAP_FORCE;\n+\n       rkind = \"kernels\";\n       break;\n \n@@ -7640,10 +7647,12 @@ gimplify_adjust_omp_clauses_1 (splay_tree_node n, void *data)\n     }\n   else if (code == OMP_CLAUSE_MAP)\n     {\n-      OMP_CLAUSE_SET_MAP_KIND (clause,\n-\t\t\t       flags & GOVD_MAP_TO_ONLY\n-\t\t\t       ? GOMP_MAP_TO\n-\t\t\t       : GOMP_MAP_TOFROM);\n+      int kind = (flags & GOVD_MAP_TO_ONLY\n+\t\t  ? GOMP_MAP_TO\n+\t\t  : GOMP_MAP_TOFROM);\n+      if (flags & GOVD_MAP_FORCE)\n+\tkind |= GOMP_MAP_FLAG_FORCE;\n+      OMP_CLAUSE_SET_MAP_KIND (clause, kind);\n       if (DECL_SIZE (decl)\n \t  && TREE_CODE (DECL_SIZE (decl)) != INTEGER_CST)\n \t{"}, {"sha": "5fe26bb9aa00dd9fe9e7c0ddfe9a465e35e5c045", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=db0f1c7a906bd8798a4016c1622f5999897e7469", "patch": "@@ -1,3 +1,8 @@\n+2015-12-02  Tom de Vries  <tom@codesourcery.com>\n+\n+\t* c-c++-common/goacc/kernels-default-2.c: New test.\n+\t* c-c++-common/goacc/kernels-default.c: New test.\n+\n 2015-12-02  Tom de Vries  <tom@codesourcery.com>\n \n \t* c-c++-common/goacc/kernels-alias-2.c: New test."}, {"sha": "232b1236f387d2de41483ab18a156d9fe6e225cf", "filename": "gcc/testsuite/c-c++-common/goacc/kernels-default-2.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fkernels-default-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fkernels-default-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fkernels-default-2.c?ref=db0f1c7a906bd8798a4016c1622f5999897e7469", "patch": "@@ -0,0 +1,17 @@\n+/* { dg-additional-options \"-O2\" } */\n+/* { dg-additional-options \"-fdump-tree-gimple\" } */\n+\n+#define N 2\n+\n+void\n+foo (void)\n+{\n+  unsigned int a[N];\n+\n+#pragma acc kernels\n+  {\n+    a[0]++;\n+  }\n+}\n+\n+/* { dg-final { scan-tree-dump-times \"map\\\\(tofrom\" 1 \"gimple\" } } */"}, {"sha": "58cd5e10a5b374929f4feafd344589c68b239fee", "filename": "gcc/testsuite/c-c++-common/goacc/kernels-default.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fkernels-default.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db0f1c7a906bd8798a4016c1622f5999897e7469/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fkernels-default.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fkernels-default.c?ref=db0f1c7a906bd8798a4016c1622f5999897e7469", "patch": "@@ -0,0 +1,14 @@\n+/* { dg-additional-options \"-O2\" } */\n+/* { dg-additional-options \"-fdump-tree-gimple\" } */\n+\n+void\n+foo (void)\n+{\n+  unsigned int i;\n+#pragma acc kernels\n+  {\n+    i++;\n+  }\n+}\n+\n+/* { dg-final { scan-tree-dump-times \"map\\\\(force_tofrom\" 1 \"gimple\" } } */"}]}