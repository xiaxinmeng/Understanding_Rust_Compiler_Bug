{"sha": "938ff79ae799ad8e961c6562b31d20899c6a132b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTM4ZmY3OWFlNzk5YWQ4ZTk2MWM2NTYyYjMxZDIwODk5YzZhMTMyYg==", "commit": {"author": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2012-08-10T06:08:11Z"}, "committer": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2012-08-10T06:08:11Z"}, "message": "runtime: use sched_getaffinity for runtime.NumCPU() on Linux\n        Fixes Go issue 3921 for gccgo.\n\nFrom Shenghou Ma.\n\nFrom-SVN: r190282", "tree": {"sha": "aa24175caf108038c2ecde81b10654a851f55416", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aa24175caf108038c2ecde81b10654a851f55416"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/938ff79ae799ad8e961c6562b31d20899c6a132b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/938ff79ae799ad8e961c6562b31d20899c6a132b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/938ff79ae799ad8e961c6562b31d20899c6a132b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/938ff79ae799ad8e961c6562b31d20899c6a132b/comments", "author": null, "committer": null, "parents": [{"sha": "0d8e4dacd4781c147ad32dbc48a3382117bca9f6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0d8e4dacd4781c147ad32dbc48a3382117bca9f6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0d8e4dacd4781c147ad32dbc48a3382117bca9f6"}], "stats": {"total": 53, "additions": 21, "deletions": 32}, "files": [{"sha": "0122b77c9ffcd75302e62e8eb33354060e40f436", "filename": "libgo/runtime/getncpu-linux.c", "status": "modified", "additions": 21, "deletions": 32, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/938ff79ae799ad8e961c6562b31d20899c6a132b/libgo%2Fruntime%2Fgetncpu-linux.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/938ff79ae799ad8e961c6562b31d20899c6a132b/libgo%2Fruntime%2Fgetncpu-linux.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgo%2Fruntime%2Fgetncpu-linux.c?ref=938ff79ae799ad8e961c6562b31d20899c6a132b", "patch": "@@ -2,46 +2,35 @@\n // Use of this source code is governed by a BSD-style\n // license that can be found in the LICENSE file.\n \n-#include <string.h>\n-#include <sys/types.h>\n-#include <fcntl.h>\n-#include <unistd.h>\n+#include <features.h>\n+#include <sched.h>\n \n-#include \"runtime.h\"\n-#include \"defs.h\"\n+// CPU_COUNT is only provided by glibc 2.6 or higher\n+#if !defined(__GLIBC_PREREQ) || !__GLIBC_PREREQ(2, 6)\n+#define CPU_COUNT(set) _CPU_COUNT((unsigned int *)(set), sizeof(*(set))/sizeof(unsigned int))\n+static int _CPU_COUNT(unsigned int *set, size_t len) {\n+\tint cnt;\n \n-#ifndef O_CLOEXEC\n-#define O_CLOEXEC 0\n+\tcnt = 0;\n+\twhile (len--)\n+\t\tcnt += __builtin_popcount(*set++);\n+\treturn cnt;\n+}\n #endif\n \n+#include \"runtime.h\"\n+#include \"defs.h\"\n+\n int32\n getproccount(void)\n {\n-\tint32 fd, rd, cnt, cpustrlen;\n-\tconst char *cpustr;\n-\tconst byte *pos;\n-\tbyte *bufpos;\n-\tbyte buf[256];\n+\tcpu_set_t set;\n+\tint32 r, cnt;\n \n-\tfd = open(\"/proc/stat\", O_RDONLY|O_CLOEXEC, 0);\n-\tif(fd == -1)\n-\t\treturn 1;\n \tcnt = 0;\n-\tbufpos = buf;\n-\tcpustr = \"\\ncpu\";\n-\tcpustrlen = strlen(cpustr);\n-\tfor(;;) {\n-\t\trd = read(fd, bufpos, sizeof(buf)-cpustrlen);\n-\t\tif(rd == -1)\n-\t\t\tbreak;\n-\t\tbufpos[rd] = 0;\n-\t\tfor(pos=buf; (pos=(const byte*)strstr((const char*)pos, cpustr)) != nil; cnt++, pos++) {\n-\t\t}\n-\t\tif(rd < cpustrlen)\n-\t\t\tbreak;\n-\t\tmemmove(buf, bufpos+rd-cpustrlen+1, cpustrlen-1);\n-\t\tbufpos = buf+cpustrlen-1;\n-\t}\n-\tclose(fd);\n+\tr = sched_getaffinity(0, sizeof(set), &set);\n+\tif(r == 0)\n+\t\tcnt += CPU_COUNT(&set);\n+\n \treturn cnt ? cnt : 1;\n }"}]}