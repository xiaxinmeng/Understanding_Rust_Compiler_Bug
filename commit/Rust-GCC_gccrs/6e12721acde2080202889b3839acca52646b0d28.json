{"sha": "6e12721acde2080202889b3839acca52646b0d28", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmUxMjcyMWFjZGUyMDgwMjAyODg5YjM4MzlhY2NhNTI2NDZiMGQyOA==", "commit": {"author": {"name": "Steven G. Kargl", "email": "kargl@gcc.gnu.org", "date": "2019-08-28T20:16:57Z"}, "committer": {"name": "Steven G. Kargl", "email": "kargl@gcc.gnu.org", "date": "2019-08-28T20:16:57Z"}, "message": "re PR fortran/91565 (ICE in gfc_simplify_reshape, at fortran/simplify.c:6707 etc.)\n\n2019-08-28  Steven G. Kargl  <kargl@gcc.gnu.org>\n\n\tPR fortran/91565\n\t* simplify.c (gfc_simplify_reshape): Add additional checks of the\n\tORDER dummy argument.\n\n2019-08-28  Steven G. Kargl  <kargl@gcc.gnu.org>\n\n\tPR fortran/91565\n\t* gfortran.dg/pr91565.f90: New test.\n\nFrom-SVN: r275007", "tree": {"sha": "24096be9fb03c7794457e06d6309ef46d651d026", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/24096be9fb03c7794457e06d6309ef46d651d026"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6e12721acde2080202889b3839acca52646b0d28", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6e12721acde2080202889b3839acca52646b0d28", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6e12721acde2080202889b3839acca52646b0d28", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6e12721acde2080202889b3839acca52646b0d28/comments", "author": null, "committer": null, "parents": [{"sha": "ab0f6d4c5fa6880d5461e2b6bad1879d6a84744f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ab0f6d4c5fa6880d5461e2b6bad1879d6a84744f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ab0f6d4c5fa6880d5461e2b6bad1879d6a84744f"}], "stats": {"total": 62, "additions": 59, "deletions": 3}, "files": [{"sha": "5e3d7b9e9a42a68a50ff5ae1131420e842f5ccb7", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=6e12721acde2080202889b3839acca52646b0d28", "patch": "@@ -1,3 +1,9 @@\n+2019-08-28  Steven G. Kargl  <kargl@gcc.gnu.org>\n+\n+\tPR fortran/91565\n+\t* simplify.c (gfc_simplify_reshape): Add additional checks of the\n+\tORDER dummy argument.\n+\n 2019-08-28  Steven G. Kargl  <kargl@gcc.gnu.org>\n \n \tPR fortran/91564"}, {"sha": "7fc18d53925459588ea5bbf47b282d11acaa0863", "filename": "gcc/fortran/simplify.c", "status": "modified", "additions": 31, "deletions": 3, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ffortran%2Fsimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ffortran%2Fsimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fsimplify.c?ref=6e12721acde2080202889b3839acca52646b0d28", "patch": "@@ -6668,6 +6668,9 @@ gfc_simplify_reshape (gfc_expr *source, gfc_expr *shape_exp,\n   mpz_init (index);\n   rank = 0;\n \n+  for (i = 0; i < GFC_MAX_DIMENSIONS; i++)\n+    x[i] = 0;\n+\n   for (;;)\n     {\n       e = gfc_constructor_lookup_expr (shape_exp->value.constructor, rank);\n@@ -6692,8 +6695,28 @@ gfc_simplify_reshape (gfc_expr *source, gfc_expr *shape_exp,\n     }\n   else\n     {\n-      for (i = 0; i < rank; i++)\n-\tx[i] = 0;\n+      mpz_t size;\n+      int order_size, shape_size;\n+\n+      if (order_exp->rank != shape_exp->rank)\n+\t{\n+\t  gfc_error (\"Shapes of ORDER at %L and SHAPE at %L are different\",\n+\t\t     &order_exp->where, &shape_exp->where);\n+\t  return &gfc_bad_expr;\n+\t}\n+\n+      gfc_array_size (shape_exp, &size);\n+      shape_size = mpz_get_ui (size);\n+      mpz_clear (size);\n+      gfc_array_size (order_exp, &size);\n+      order_size = mpz_get_ui (size);\n+      mpz_clear (size);\n+      if (order_size != shape_size)\n+\t{\n+\t  gfc_error (\"Sizes of ORDER at %L and SHAPE at %L are different\",\n+\t\t     &order_exp->where, &shape_exp->where);\n+\t  return &gfc_bad_expr;\n+\t}\n \n       for (i = 0; i < rank; i++)\n \t{\n@@ -6704,7 +6727,12 @@ gfc_simplify_reshape (gfc_expr *source, gfc_expr *shape_exp,\n \n \t  gcc_assert (order[i] >= 1 && order[i] <= rank);\n \t  order[i]--;\n-\t  gcc_assert (x[order[i]] == 0);\n+\t  if (x[order[i]] != 0)\n+\t    {\n+\t      gfc_error (\"ORDER at %L is not a permutation of the size of \"\n+\t\t\t \"SHAPE at %L\", &order_exp->where, &shape_exp->where);\n+\t      return &gfc_bad_expr;\n+\t    }\n \t  x[order[i]] = 1;\n \t}\n     }"}, {"sha": "7dc95f323ec2a66499806bade5703a1682887f57", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6e12721acde2080202889b3839acca52646b0d28", "patch": "@@ -1,3 +1,8 @@\n+2019-08-28  Steven G. Kargl  <kargl@gcc.gnu.org>\n+\n+\tPR fortran/91565\n+\t* gfortran.dg/pr91565.f90: New test.\n+\n 2019-08-28  Steven G. Kargl  <kargl@gcc.gnu.org>\n \n \tPR fortran/91564"}, {"sha": "b43a57acf1357e6f187ba2a2e3524650189bd54d", "filename": "gcc/testsuite/gfortran.dg/pr91565.f90", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr91565.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e12721acde2080202889b3839acca52646b0d28/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr91565.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr91565.f90?ref=6e12721acde2080202889b3839acca52646b0d28", "patch": "@@ -0,0 +1,17 @@\n+! { dg-do compile }\n+! PR fortran/91565\n+! Contributed by Gerhard Steinmetz\n+program p\n+   integer, parameter :: a(2) = [2,2]              ! { dg-error \"\\(1\\)\" }\n+   print *, reshape([1,2,3,4,5,6], [2,3], order=a) ! { dg-error \"not a permutation\" }\n+end\n+\n+subroutine foo\n+   integer, parameter :: a(1) = 1                  ! { dg-error \"\\(1\\)\" }\n+   print *, reshape([1,2,3,4,5,6], [2,3], order=a) ! { dg-error \"are different\" }\n+end\n+\n+subroutine bar\n+   integer, parameter :: a(1,2) = 1                ! { dg-error \"\\(1\\)\" }\n+   print *, reshape([1,2,3,4,5,6], [2,3], order=a) ! { dg-error \"are different\" }\n+end"}]}