{"sha": "546ecb0054af302acf0839c7f3eb78598f8c0672", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTQ2ZWNiMDA1NGFmMzAyYWNmMDgzOWM3ZjNlYjc4NTk4ZjhjMDY3Mg==", "commit": {"author": {"name": "Xionghu Luo", "email": "luoxhu@linux.ibm.com", "date": "2021-09-07T01:22:50Z"}, "committer": {"name": "Xionghu Luo", "email": "luoxhu@linux.ibm.com", "date": "2021-09-07T01:22:50Z"}, "message": "rs6000: Expand fmod and remainder when built with fast-math [PR97142]\n\nfmod/fmodf and remainder/remainderf could be expanded instead of library\ncall when fast-math build, which is much faster.\n\nfmodf:\n     fdivs   f0,f1,f2\n     friz    f0,f0\n     fnmsubs f1,f2,f0,f1\n\nremainderf:\n     fdivs   f0,f1,f2\n     frin    f0,f0\n     fnmsubs f1,f2,f0,f1\n\nSPEC2017 Ofast P8LE: 511.povray_r +1.14%,  526.blender_r +1.72%\n\ngcc/ChangeLog:\n\n2021-09-07  Xionghu Luo  <luoxhu@linux.ibm.com>\n\n\tPR target/97142\n\t* config/rs6000/rs6000.md (fmod<mode>3): New define_expand.\n\t(remainder<mode>3): Likewise.\n\ngcc/testsuite/ChangeLog:\n\n2021-09-07  Xionghu Luo  <luoxhu@linux.ibm.com>\n\n\tPR target/97142\n\t* gcc.target/powerpc/pr97142.c: New test.", "tree": {"sha": "1ac283fa3b5267e1cbf24d90ded162587be5611d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1ac283fa3b5267e1cbf24d90ded162587be5611d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/546ecb0054af302acf0839c7f3eb78598f8c0672", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/546ecb0054af302acf0839c7f3eb78598f8c0672", "html_url": "https://github.com/Rust-GCC/gccrs/commit/546ecb0054af302acf0839c7f3eb78598f8c0672", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/546ecb0054af302acf0839c7f3eb78598f8c0672/comments", "author": {"login": "xionghul", "id": 4607154, "node_id": "MDQ6VXNlcjQ2MDcxNTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4607154?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xionghul", "html_url": "https://github.com/xionghul", "followers_url": "https://api.github.com/users/xionghul/followers", "following_url": "https://api.github.com/users/xionghul/following{/other_user}", "gists_url": "https://api.github.com/users/xionghul/gists{/gist_id}", "starred_url": "https://api.github.com/users/xionghul/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xionghul/subscriptions", "organizations_url": "https://api.github.com/users/xionghul/orgs", "repos_url": "https://api.github.com/users/xionghul/repos", "events_url": "https://api.github.com/users/xionghul/events{/privacy}", "received_events_url": "https://api.github.com/users/xionghul/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xionghul", "id": 4607154, "node_id": "MDQ6VXNlcjQ2MDcxNTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4607154?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xionghul", "html_url": "https://github.com/xionghul", "followers_url": "https://api.github.com/users/xionghul/followers", "following_url": "https://api.github.com/users/xionghul/following{/other_user}", "gists_url": "https://api.github.com/users/xionghul/gists{/gist_id}", "starred_url": "https://api.github.com/users/xionghul/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xionghul/subscriptions", "organizations_url": "https://api.github.com/users/xionghul/orgs", "repos_url": "https://api.github.com/users/xionghul/repos", "events_url": "https://api.github.com/users/xionghul/events{/privacy}", "received_events_url": "https://api.github.com/users/xionghul/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58572bbb62c9588c658fd7656ee359d27c306fb2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/58572bbb62c9588c658fd7656ee359d27c306fb2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/58572bbb62c9588c658fd7656ee359d27c306fb2"}], "stats": {"total": 71, "additions": 71, "deletions": 0}, "files": [{"sha": "6bec2bddbdee23fef7356636da0e6a1c17c21e62", "filename": "gcc/config/rs6000/rs6000.md", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/546ecb0054af302acf0839c7f3eb78598f8c0672/gcc%2Fconfig%2Frs6000%2Frs6000.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/546ecb0054af302acf0839c7f3eb78598f8c0672/gcc%2Fconfig%2Frs6000%2Frs6000.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.md?ref=546ecb0054af302acf0839c7f3eb78598f8c0672", "patch": "@@ -4986,6 +4986,42 @@\n   [(set_attr \"type\" \"fp\")\n    (set_attr \"isa\" \"*,<Fisa>\")])\n \n+(define_expand \"fmod<mode>3\"\n+  [(use (match_operand:SFDF 0 \"gpc_reg_operand\"))\n+\t(use (match_operand:SFDF 1 \"gpc_reg_operand\"))\n+\t(use (match_operand:SFDF 2 \"gpc_reg_operand\"))]\n+  \"TARGET_HARD_FLOAT\n+   && TARGET_FPRND\n+   && flag_unsafe_math_optimizations\"\n+{\n+  rtx div = gen_reg_rtx (<MODE>mode);\n+  emit_insn (gen_div<mode>3 (div, operands[1], operands[2]));\n+\n+  rtx friz = gen_reg_rtx (<MODE>mode);\n+  emit_insn (gen_btrunc<mode>2 (friz, div));\n+\n+  emit_insn (gen_nfms<mode>4 (operands[0], operands[2], friz, operands[1]));\n+  DONE;\n+ })\n+\n+(define_expand \"remainder<mode>3\"\n+  [(use (match_operand:SFDF 0 \"gpc_reg_operand\"))\n+\t(use (match_operand:SFDF 1 \"gpc_reg_operand\"))\n+\t(use (match_operand:SFDF 2 \"gpc_reg_operand\"))]\n+  \"TARGET_HARD_FLOAT\n+   && TARGET_FPRND\n+   && flag_unsafe_math_optimizations\"\n+{\n+  rtx div = gen_reg_rtx (<MODE>mode);\n+  emit_insn (gen_div<mode>3 (div, operands[1], operands[2]));\n+\n+  rtx frin = gen_reg_rtx (<MODE>mode);\n+  emit_insn (gen_round<mode>2 (frin, div));\n+\n+  emit_insn (gen_nfms<mode>4 (operands[0], operands[2], frin, operands[1]));\n+  DONE;\n+ })\n+\n (define_insn \"*rsqrt<mode>2\"\n   [(set (match_operand:SFDF 0 \"gpc_reg_operand\" \"=<Ff>,wa\")\n \t(unspec:SFDF [(match_operand:SFDF 1 \"gpc_reg_operand\" \"<Ff>,wa\")]"}, {"sha": "0e5f1c1f61bd479b862bcb6c64e583b3ebabd0f3", "filename": "gcc/testsuite/gcc.target/powerpc/pr97142.c", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/546ecb0054af302acf0839c7f3eb78598f8c0672/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fpr97142.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/546ecb0054af302acf0839c7f3eb78598f8c0672/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fpr97142.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fpr97142.c?ref=546ecb0054af302acf0839c7f3eb78598f8c0672", "patch": "@@ -0,0 +1,35 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-Ofast\" } */\n+\n+#include <math.h>\n+\n+float test1 (float x, float y)\n+{\n+  return fmodf (x, y);\n+}\n+\n+double test2 (double x, double y)\n+{\n+  return fmod (x, y);\n+}\n+\n+float test3 (float x, float y)\n+{\n+  return remainderf (x, y);\n+}\n+\n+double test4 (double x, double y)\n+{\n+  return remainder (x, y);\n+}\n+\n+/* { dg-final { scan-assembler-not {(?n)\\mb.*fmod} } } */\n+/* { dg-final { scan-assembler-not {(?n)\\mb.*fmodf} } } */\n+/* { dg-final { scan-assembler-not {(?n)\\mb.*remainder} } } */\n+/* { dg-final { scan-assembler-not {(?n)\\mb.*remainderf} } } */\n+/* { dg-final { scan-assembler-times {\\mfdiv\\M} 2 } } */\n+/* { dg-final { scan-assembler-times {\\mfdivs\\M} 2 } } */\n+/* { dg-final { scan-assembler-times {\\mfnmsub\\M} 2 } } */\n+/* { dg-final { scan-assembler-times {\\mfnmsubs\\M} 2 } } */\n+/* { dg-final { scan-assembler-times {\\mfriz\\M} 2 } } */\n+/* { dg-final { scan-assembler-times {\\mfrin\\M} 2 } } */"}]}