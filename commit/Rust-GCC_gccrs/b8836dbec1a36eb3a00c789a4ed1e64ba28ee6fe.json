{"sha": "b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Yjg4MzZkYmVjMWEzNmViM2EwMGM3ODlhNGVkMWU2NGJhMjhlZTZmZQ==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2019-04-03T20:09:17Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2019-04-03T20:09:17Z"}, "message": "PR c++/89331 - ICE with offsetof in incomplete class.\n\nWe were aborting when build_base_path returned an error because of the\nderived class not being complete yet, which wasn't considered by the assert.\nFixed by checking for complete type first.  The semantics.c change avoids\na duplicate error message.\n\n\t* semantics.c (finish_offsetof): Handle error_mark_node.\n\t* typeck.c (build_class_member_access_expr): Call\n\tcomplete_type_or_maybe_complain before converting to base.\n\nFrom-SVN: r270135", "tree": {"sha": "2d7e515d7d3bb8d8b8a27503153cb5124dc1de94", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2d7e515d7d3bb8d8b8a27503153cb5124dc1de94"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "bc53dee0baa3f3e06c89081ef01f506037acd1ff", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bc53dee0baa3f3e06c89081ef01f506037acd1ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bc53dee0baa3f3e06c89081ef01f506037acd1ff"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "a224517b566052cbf0ec98e0d92d42fa3b766cee", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "patch": "@@ -1,5 +1,10 @@\n 2019-04-03  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/89331 - ICE with offsetof in incomplete class.\n+\t* semantics.c (finish_offsetof): Handle error_mark_node.\n+\t* typeck.c (build_class_member_access_expr): Call\n+\tcomplete_type_or_maybe_complain before converting to base.\n+\n \tPR c++/89917 - ICE with lambda in variadic mem-init.\n \t* pt.c (make_pack_expansion): Change type_pack_expansion_p to false.\n "}, {"sha": "408675b80992bde555ec790592bc4d1b3411554b", "filename": "gcc/cp/semantics.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Fcp%2Fsemantics.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Fcp%2Fsemantics.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsemantics.c?ref=b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "patch": "@@ -4144,6 +4144,9 @@ finish_offsetof (tree object_ptr, tree expr, location_t loc)\n       return expr;\n     }\n \n+  if (expr == error_mark_node)\n+    return error_mark_node;\n+\n   if (TREE_CODE (expr) == PSEUDO_DTOR_EXPR)\n     {\n       error (\"cannot apply %<offsetof%> to destructor %<~%T%>\","}, {"sha": "56def144a3e14ac57ca5aaefe01c2d60dc622424", "filename": "gcc/cp/typeck.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Fcp%2Ftypeck.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Fcp%2Ftypeck.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck.c?ref=b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "patch": "@@ -2474,6 +2474,14 @@ build_class_member_access_expr (cp_expr object, tree member,\n \t  tree binfo;\n \t  base_kind kind;\n \n+\t  /* We didn't complain above about a currently open class, but now we\n+\t     must: we don't know how to refer to a base member before layout is\n+\t     complete.  But still don't complain in a template.  */\n+\t  if (!dependent_type_p (object_type)\n+\t      && !complete_type_or_maybe_complain (object_type, object,\n+\t\t\t\t\t\t   complain))\n+\t    return error_mark_node;\n+\n \t  binfo = lookup_base (access_path ? access_path : object_type,\n \t\t\t       member_scope, ba_unique, &kind, complain);\n \t  if (binfo == error_mark_node)"}, {"sha": "b30c31dbfa9977eefe56d5ab8cde036456a097b8", "filename": "gcc/testsuite/g++.dg/ext/builtin-offsetof4.C", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fbuiltin-offsetof4.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fbuiltin-offsetof4.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fbuiltin-offsetof4.C?ref=b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "patch": "@@ -0,0 +1,11 @@\n+// PR c++/89331\n+\n+class A {\n+public:\n+    char a;\n+};\n+\n+class B : public A {\n+public:\n+    static const unsigned b = __builtin_offsetof(B, a); // { dg-error \"incomplete\" }\n+};"}, {"sha": "daca70a6fe4c24ee3e075c90cf1fbde69669c605", "filename": "gcc/testsuite/g++.dg/other/offsetof8.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Foffsetof8.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Foffsetof8.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Foffsetof8.C?ref=b8836dbec1a36eb3a00c789a4ed1e64ba28ee6fe", "patch": "@@ -9,4 +9,4 @@ struct B: virtual A { };\n int a[]  = {\n   !&((B*)0)->i,    // { dg-error \"invalid access to non-static data member\" }\n   __builtin_offsetof (B, i)   // { dg-error \"invalid access to non-static\" }\n-};\t\t\t      // { dg-message \"offsetof within non-standard-layout type\" \"\" { target *-*-* } .-1 }\n+};"}]}