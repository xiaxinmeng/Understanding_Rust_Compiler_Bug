{"sha": "5a9ceba8fd21973118f1866686aca5622cc60ba2", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWE5Y2ViYThmZDIxOTczMTE4ZjE4NjY2ODZhY2E1NjIyY2M2MGJhMg==", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-01-10T16:14:26Z"}, "committer": {"name": "Philip Herron", "email": "herron.philip@googlemail.com", "date": "2021-01-11T20:00:03Z"}, "message": "Mark DECL_PUBLIC for main fn or functions with visibility.\n\nThis change will need more thought later when it comes to traits and\ngenerics etc.\n\nFixes #136", "tree": {"sha": "ff3794551b143037a6aaf8b83658e0efaf322b36", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ff3794551b143037a6aaf8b83658e0efaf322b36"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5a9ceba8fd21973118f1866686aca5622cc60ba2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a9ceba8fd21973118f1866686aca5622cc60ba2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5a9ceba8fd21973118f1866686aca5622cc60ba2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a9ceba8fd21973118f1866686aca5622cc60ba2/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9a3ad294e0af5ed45b53c340382a7806fb150bdf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9a3ad294e0af5ed45b53c340382a7806fb150bdf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9a3ad294e0af5ed45b53c340382a7806fb150bdf"}], "stats": {"total": 18, "additions": 16, "deletions": 2}, "files": [{"sha": "c5fe9a2b50c49e1660859e38a7396ce6221c5eb5", "filename": "gcc/rust/backend/rust-compile-item.h", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a9ceba8fd21973118f1866686aca5622cc60ba2/gcc%2Frust%2Fbackend%2Frust-compile-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a9ceba8fd21973118f1866686aca5622cc60ba2/gcc%2Frust%2Fbackend%2Frust-compile-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-item.h?ref=5a9ceba8fd21973118f1866686aca5622cc60ba2", "patch": "@@ -138,10 +138,24 @@ class CompileItem : public HIRCompileBase\n     // convert to the actual function type\n     auto compiled_fn_type = TyTyCompile::compile (ctx->get_backend (), fnType);\n \n+    unsigned int flags = 0;\n+    bool is_main_fn = function.function_name.compare (\"main\") == 0;\n+\n+    // if its the main fn or pub visibility mark its as DECL_PUBLIC\n+    // please see https://github.com/Rust-GCC/gccrs/pull/137\n+    if (is_main_fn || function.has_visibility ())\n+      flags |= Backend::function_is_visible;\n+\n+    std::string asm_name = function.function_name;\n+    if (!is_main_fn)\n+      {\n+\t// FIXME need name mangling\n+\tasm_name = \"__\" + function.function_name;\n+      }\n+\n     Bfunction *fndecl\n       = ctx->get_backend ()->function (compiled_fn_type, function.function_name,\n-\t\t\t\t       \"\" /* asm_name */, 0 /* flags */,\n-\t\t\t\t       function.get_locus ());\n+\t\t\t\t       asm_name, flags, function.get_locus ());\n     ctx->insert_function_decl (function.get_mappings ().get_hirid (), fndecl);\n \n     // setup the params"}]}