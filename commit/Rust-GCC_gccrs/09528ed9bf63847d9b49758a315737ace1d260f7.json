{"sha": "09528ed9bf63847d9b49758a315737ace1d260f7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDk1MjhlZDliZjYzODQ3ZDliNDk3NThhMzE1NzM3YWNlMWQyNjBmNw==", "commit": {"author": {"name": "Olivier Hainque", "email": "hainque@adacore.com", "date": "2007-09-12T10:49:56Z"}, "committer": {"name": "Olivier Hainque", "email": "hainque@gcc.gnu.org", "date": "2007-09-12T10:49:56Z"}, "message": "decl.c (gnat_to_gnu_entity): For a subtype with discriminant constraints...\n\n\t2007-09-12  Olivier Hainque  <hainque@adacore.com>\n\n\tada/\n\t* decl.c (gnat_to_gnu_entity) <E_Record_Subtype>: For a subtype\n\twith discriminant constraints, generalize the code for BIT_FIELDs\n\tto PACKED fields of constant size and propagate DECL_PACKED.\n\n\ttestsuite/\n\t* gnat.dg/packed_subtype.adb: New test.\n\nFrom-SVN: r128425", "tree": {"sha": "5543744f197541b0fb5030e363961717337de155", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5543744f197541b0fb5030e363961717337de155"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/09528ed9bf63847d9b49758a315737ace1d260f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/09528ed9bf63847d9b49758a315737ace1d260f7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/09528ed9bf63847d9b49758a315737ace1d260f7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/09528ed9bf63847d9b49758a315737ace1d260f7/comments", "author": {"login": "hainque", "id": 18735142, "node_id": "MDQ6VXNlcjE4NzM1MTQy", "avatar_url": "https://avatars.githubusercontent.com/u/18735142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hainque", "html_url": "https://github.com/hainque", "followers_url": "https://api.github.com/users/hainque/followers", "following_url": "https://api.github.com/users/hainque/following{/other_user}", "gists_url": "https://api.github.com/users/hainque/gists{/gist_id}", "starred_url": "https://api.github.com/users/hainque/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hainque/subscriptions", "organizations_url": "https://api.github.com/users/hainque/orgs", "repos_url": "https://api.github.com/users/hainque/repos", "events_url": "https://api.github.com/users/hainque/events{/privacy}", "received_events_url": "https://api.github.com/users/hainque/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7ab886543206b714b7e90e447446c0128d7638cb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7ab886543206b714b7e90e447446c0128d7638cb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7ab886543206b714b7e90e447446c0128d7638cb"}], "stats": {"total": 47, "additions": 43, "deletions": 4}, "files": [{"sha": "fca0cd0b9af5563455cf08bf564755a530ab997b", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=09528ed9bf63847d9b49758a315737ace1d260f7", "patch": "@@ -1,3 +1,9 @@\n+2007-09-12  Olivier Hainque  <hainque@adacore.com>\n+\n+\t* decl.c (gnat_to_gnu_entity) <E_Record_Subtype>: For a subtype\n+\twith discriminant constraints, generalize the code for BIT_FIELDs\n+\tto PACKED fields of constant size and propagate DECL_PACKED.\n+\n 2007-09-11  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* decl.c (array_type_has_nonaliased_component): New predicate."}, {"sha": "4b3edce40a9504119e12dcb181c5786779d4af54", "filename": "gcc/ada/decl.c", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Fada%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Fada%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fdecl.c?ref=09528ed9bf63847d9b49758a315737ace1d260f7", "patch": "@@ -2762,9 +2762,14 @@ gnat_to_gnu_entity (Entity_Id gnat_entity, tree gnu_expr, int definition)\n \t\t\tgnu_field_type = TREE_TYPE (gnu_old_field);\n \t\t      }\n \n-\t\t    /* If this was a bitfield, get the size from the old field.\n-\t\t       Also ensure the type can be placed into a bitfield.  */\n-\t\t    else if (DECL_BIT_FIELD (gnu_old_field))\n+\t\t    /* If the old field was packed and of constant size, we\n+\t\t       have to get the old size here, as it might differ from\n+\t\t       what the Etype conveys and the latter might overlap\n+\t\t       onto the following field.  Try to arrange the type for\n+\t\t       possible better packing along the way.  */\n+\t\t    else if (DECL_PACKED (gnu_old_field)\n+\t\t\t     && TREE_CODE (DECL_SIZE (gnu_old_field))\n+\t\t\t        == INTEGER_CST)\n \t\t      {\n \t\t\tgnu_size = DECL_SIZE (gnu_old_field);\n \t\t\tif (TYPE_MODE (gnu_field_type) == BLKmode\n@@ -2789,7 +2794,7 @@ gnat_to_gnu_entity (Entity_Id gnat_entity, tree gnu_expr, int definition)\n \t\t    gnu_field\n \t\t      = create_field_decl\n \t\t\t(DECL_NAME (gnu_old_field), gnu_field_type, gnu_type,\n-\t\t\t 0, gnu_size, gnu_new_pos,\n+\t\t\t DECL_PACKED (gnu_old_field), gnu_size, gnu_new_pos,\n \t\t\t !DECL_NONADDRESSABLE_P (gnu_old_field));\n \n \t\t    if (!TREE_CONSTANT (gnu_pos))"}, {"sha": "f87c6a95ff7ed23050a108cfe16ecad422d3e21b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=09528ed9bf63847d9b49758a315737ace1d260f7", "patch": "@@ -1,3 +1,7 @@\n+2007-09-12  Olivier Hainque  <hainque@adacore.com>\n+\n+\t* gnat.dg/packed_subtype.adb: New test.\n+\n 2007-09-12  Tobias Burnus  <burnus@net-b.de>\n \n \tPR fortran/33297"}, {"sha": "925440a41d85a63a72ecc6ea8684cbf5c645e5b3", "filename": "gcc/testsuite/gnat.dg/packed_subtype.adb", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Ftestsuite%2Fgnat.dg%2Fpacked_subtype.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/09528ed9bf63847d9b49758a315737ace1d260f7/gcc%2Ftestsuite%2Fgnat.dg%2Fpacked_subtype.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fpacked_subtype.adb?ref=09528ed9bf63847d9b49758a315737ace1d260f7", "patch": "@@ -0,0 +1,24 @@\n+-- { dg-do run }\n+\n+procedure Packed_Subtype is\n+\n+   subtype Ubyte is Integer range 0 .. 255;\n+   type Packet (Id : Ubyte) is record\n+      A, B : Ubyte;\n+   end record;\n+   pragma Pack (Packet);\n+\n+   subtype My_Packet is Packet (Id => 1);\n+\n+   MP : My_Packet;\n+begin\n+   MP.A := 1;\n+   MP.B := 2;\n+\n+   if MP.A /= 1 or else MP.B /= 2 then\n+      raise Program_Error;\n+   end if;\n+end;\n+\n+\n+"}]}