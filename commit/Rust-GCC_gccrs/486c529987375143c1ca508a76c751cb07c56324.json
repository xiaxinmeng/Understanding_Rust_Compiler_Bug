{"sha": "486c529987375143c1ca508a76c751cb07c56324", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDg2YzUyOTk4NzM3NTE0M2MxY2E1MDhhNzZjNzUxY2IwN2M1NjMyNA==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2018-02-14T16:31:26Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2018-02-14T16:31:26Z"}, "message": "[C++ PATCH]: instantiation via vtable marking\n\nhttps://gcc.gnu.org/ml/gcc-patches/2018-02/msg00850.html\n\tgcc/cp/\n\t* decl2.c (mark_vtable_entries): Set input_location to decl's.\n\t(c_parse_final_cleanups): Restore input_location after emitting\n\tvtables.\n\n\tgcc/testsuite/\n\t* g++.dg/template/instantiate5.C: Adjust required-from loc.\n\nFrom-SVN: r257665", "tree": {"sha": "45b312cbb62ea9007dcfee164a0a09a083e6fbbe", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/45b312cbb62ea9007dcfee164a0a09a083e6fbbe"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/486c529987375143c1ca508a76c751cb07c56324", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/486c529987375143c1ca508a76c751cb07c56324", "html_url": "https://github.com/Rust-GCC/gccrs/commit/486c529987375143c1ca508a76c751cb07c56324", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/486c529987375143c1ca508a76c751cb07c56324/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "34c58a43ecaeae30dce71abfd79c3c835fd09663", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/34c58a43ecaeae30dce71abfd79c3c835fd09663", "html_url": "https://github.com/Rust-GCC/gccrs/commit/34c58a43ecaeae30dce71abfd79c3c835fd09663"}], "stats": {"total": 27, "additions": 25, "deletions": 2}, "files": [{"sha": "673d6e32453d02653de0ee21ca56fb934308cd1b", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/486c529987375143c1ca508a76c751cb07c56324/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/486c529987375143c1ca508a76c751cb07c56324/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=486c529987375143c1ca508a76c751cb07c56324", "patch": "@@ -1,3 +1,9 @@\n+2018-02-14  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* decl2.c (mark_vtable_entries): Set input_location to decl's.\n+\t(c_parse_final_cleanups): Restore input_location after emitting\n+\tvtables.\n+\n 2018-02-14  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \t* cp-tree.h (do_auto_deduction (tree, tree, tree)): Remove."}, {"sha": "d2693ce458b6d6220df8f2c97be54e0f13475af4", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/486c529987375143c1ca508a76c751cb07c56324/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/486c529987375143c1ca508a76c751cb07c56324/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=486c529987375143c1ca508a76c751cb07c56324", "patch": "@@ -1825,6 +1825,11 @@ mark_vtable_entries (tree decl)\n \t function, so we emit the thunks there instead.  */\n       if (DECL_THUNK_P (fn))\n \tuse_thunk (fn, /*emit_p=*/0);\n+      /* Set the location, as marking the function could cause\n+         instantiation.  We do not need to preserve the incoming\n+         location, as we're called from c_parse_final_cleanups, which\n+         takes care of that.  */\n+      input_location = DECL_SOURCE_LOCATION (fn);\n       mark_used (fn);\n     }\n }\n@@ -4727,6 +4732,9 @@ c_parse_final_cleanups (void)\n \t    reconsider = true;\n \t    keyed_classes->unordered_remove (i);\n \t  }\n+      /* The input_location may have been changed during marking of\n+\t vtable entries.  */\n+      input_location = locus_at_end_of_parsing;\n \n       /* Write out needed type info variables.  We have to be careful\n \t looping through unemitted decls, because emit_tinfo_decl may"}, {"sha": "4fb11dfa0111a23e3849069db4c27ddaf7aa622e", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/486c529987375143c1ca508a76c751cb07c56324/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/486c529987375143c1ca508a76c751cb07c56324/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=486c529987375143c1ca508a76c751cb07c56324", "patch": "@@ -1,3 +1,7 @@\n+2018-02-14  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* g++.dg/template/instantiate5.C: Adjust required-from loc.\n+\n 2018-02-14  Will Schmidt  <will_schmidt@vnet.ibm.com>\n \n \t* gcc.target/powerpc/altivec-consts.c:  Update compile stanzas."}, {"sha": "d64092eb1a80c6c7509c26afb7033435852a8968", "filename": "gcc/testsuite/g++.dg/template/instantiate5.C", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/486c529987375143c1ca508a76c751cb07c56324/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftemplate%2Finstantiate5.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/486c529987375143c1ca508a76c751cb07c56324/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftemplate%2Finstantiate5.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftemplate%2Finstantiate5.C?ref=486c529987375143c1ca508a76c751cb07c56324", "patch": "@@ -18,7 +18,12 @@ struct B\n \n template <typename T> struct C\n {\n-  virtual void bar() const { T::foo(); } // { dg-error \"no matching function\" }\n+  virtual void bar() const\t// { dg-message \"required\" }\n+  {\n+    T::foo(); // { dg-error \"no matching function\" }\n+  }\n };\n \n-C<B> c;\t\t\t\t// { dg-message \"required\" }\n+C<B> c;\n+\n+int k;"}]}