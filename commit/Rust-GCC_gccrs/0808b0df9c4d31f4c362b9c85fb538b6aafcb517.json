{"sha": "0808b0df9c4d31f4c362b9c85fb538b6aafcb517", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDgwOGIwZGY5YzRkMzFmNGMzNjJiOWM4NWZiNTM4YjZhYWZjYjUxNw==", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2021-08-17T10:30:56Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2021-08-17T13:22:50Z"}, "message": "libstdc++: Optimize std::function move constructor [PR101923]\n\nPR 101923 points out that the unconditional swap in the std::function\nmove constructor makes it slower than copying an empty std::function.\nThe copy constructor has to check for the empty case before doing\nanything, and that makes it very fast for the empty case.\n\nAdding the same check to the move constructor avoids copying the\n_Any_data POD when we don't need to. We can also inline the effects of\nswap, by copying each member and then zeroing the pointer members.\n\nThis makes moving an empty object at least as fast as copying an empty\nobject.\n\nSigned-off-by: Jonathan Wakely <jwakely@redhat.com>\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/101923\n\t* include/bits/std_function.h (function(function&&)): Check for\n\tnon-empty parameter before doing any work.", "tree": {"sha": "fbf9bc63af60b82ece376b9c2d7ed612e3a08ad8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fbf9bc63af60b82ece376b9c2d7ed612e3a08ad8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0808b0df9c4d31f4c362b9c85fb538b6aafcb517", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0808b0df9c4d31f4c362b9c85fb538b6aafcb517", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0808b0df9c4d31f4c362b9c85fb538b6aafcb517", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0808b0df9c4d31f4c362b9c85fb538b6aafcb517/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3b3f2f7c265ef9f176cb811a8049b24538d954d9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b3f2f7c265ef9f176cb811a8049b24538d954d9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3b3f2f7c265ef9f176cb811a8049b24538d954d9"}], "stats": {"total": 12, "additions": 10, "deletions": 2}, "files": [{"sha": "fb86ff1c5f84ebdc487c260ad8c9fa85dd11ca83", "filename": "libstdc++-v3/include/bits/std_function.h", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0808b0df9c4d31f4c362b9c85fb538b6aafcb517/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstd_function.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0808b0df9c4d31f4c362b9c85fb538b6aafcb517/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstd_function.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstd_function.h?ref=0808b0df9c4d31f4c362b9c85fb538b6aafcb517", "patch": "@@ -389,8 +389,16 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n        *  (if it has one).\n        */\n       function(function&& __x) noexcept\n-      : _Function_base()\n-      { __x.swap(*this); }\n+      : _Function_base(), _M_invoker(__x._M_invoker)\n+      {\n+\tif (static_cast<bool>(__x))\n+\t  {\n+\t    _M_functor = __x._M_functor;\n+\t    _M_manager = __x._M_manager;\n+\t    __x._M_manager = nullptr;\n+\t    __x._M_invoker = nullptr;\n+\t  }\n+      }\n \n       /**\n        *  @brief Builds a %function that targets a copy of the incoming"}]}