{"sha": "59748b7180590360d3608d30e707a27b0b2cb476", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTk3NDhiNzE4MDU5MDM2MGQzNjA4ZDMwZTcwN2EyN2IwYjJjYjQ3Ng==", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2021-04-29T22:29:33Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2021-07-05T13:09:17Z"}, "message": "[Ada] Reject overlays in Global/Depends/Initializes contracts\n\ngcc/ada/\n\n\t* sem_prag.adb (Analyze_Depends_In_Decl_Part): Reject overlays\n\tin Depends and Refined_Depends contracts.\n\t(Analyze_Global_In_Decl_Part): Likewise for Global and\n\tRefined_Global.\n\t(Analyze_Initializes_In_Decl_Part): Likewise for Initializes\n\t(when appearing both as a single item and as a initialization\n\tclause).\n\t* sem_util.ads (Ultimate_Overlaid_Entity): New routine.\n\t* sem_util.adb (Report_Unused_Body_States): Ignore overlays.\n\t(Ultimate_Overlaid_Entity): New routine.", "tree": {"sha": "6611f2665a981cab12c0072f2c616573b0b56e30", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6611f2665a981cab12c0072f2c616573b0b56e30"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/59748b7180590360d3608d30e707a27b0b2cb476", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59748b7180590360d3608d30e707a27b0b2cb476", "html_url": "https://github.com/Rust-GCC/gccrs/commit/59748b7180590360d3608d30e707a27b0b2cb476", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59748b7180590360d3608d30e707a27b0b2cb476/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fdb5c200369c8ba56358a145e0c5c6c461ad5a45", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fdb5c200369c8ba56358a145e0c5c6c461ad5a45", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fdb5c200369c8ba56358a145e0c5c6c461ad5a45"}], "stats": {"total": 93, "additions": 93, "deletions": 0}, "files": [{"sha": "41e887d8f39f463f780f3e7d080e1ad5c4cc94cb", "filename": "gcc/ada/sem_prag.adb", "status": "modified", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59748b7180590360d3608d30e707a27b0b2cb476/gcc%2Fada%2Fsem_prag.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59748b7180590360d3608d30e707a27b0b2cb476/gcc%2Fada%2Fsem_prag.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_prag.adb?ref=59748b7180590360d3608d30e707a27b0b2cb476", "patch": "@@ -1139,6 +1139,17 @@ package body Sem_Prag is\n                              (State_Id => Item_Id,\n                               Ref      => Item);\n                         end if;\n+\n+                     elsif Ekind (Item_Id) in E_Constant | E_Variable\n+                       and then Present (Ultimate_Overlaid_Entity (Item_Id))\n+                     then\n+                        SPARK_Msg_NE\n+                          (\"overlaying object & cannot appear in Depends\",\n+                           Item, Item_Id);\n+                        SPARK_Msg_NE\n+                          (\"\\use the overlaid object & instead\",\n+                           Item, Ultimate_Overlaid_Entity (Item_Id));\n+                        return;\n                      end if;\n \n                      --  When the item renames an entire object, replace the\n@@ -2387,6 +2398,17 @@ package body Sem_Prag is\n                elsif Is_Formal_Object (Item_Id) then\n                   null;\n \n+               elsif Ekind (Item_Id) in E_Constant | E_Variable\n+                 and then Present (Ultimate_Overlaid_Entity (Item_Id))\n+               then\n+                  SPARK_Msg_NE\n+                    (\"overlaying object & cannot appear in Global\",\n+                     Item, Item_Id);\n+                  SPARK_Msg_NE\n+                    (\"\\use the overlaid object & instead\",\n+                     Item, Ultimate_Overlaid_Entity (Item_Id));\n+                  return;\n+\n                --  The only legal references are those to abstract states,\n                --  objects and various kinds of constants (SPARK RM 6.1.4(4)).\n \n@@ -2984,6 +3006,16 @@ package body Sem_Prag is\n                if Item_Id = Any_Id then\n                   null;\n \n+               elsif Ekind (Item_Id) in E_Constant | E_Variable\n+                 and then Present (Ultimate_Overlaid_Entity (Item_Id))\n+               then\n+                  SPARK_Msg_NE\n+                    (\"overlaying object & cannot appear in Initializes\",\n+                     Item, Item_Id);\n+                  SPARK_Msg_NE\n+                    (\"\\use the overlaid object & instead\",\n+                     Item, Ultimate_Overlaid_Entity (Item_Id));\n+\n                --  The state or variable must be declared in the visible\n                --  declarations of the package (SPARK RM 7.1.5(7)).\n \n@@ -3126,6 +3158,18 @@ package body Sem_Prag is\n                         end if;\n                      end if;\n \n+                     if Ekind (Input_Id) in E_Constant | E_Variable\n+                       and then Present (Ultimate_Overlaid_Entity (Input_Id))\n+                     then\n+                        SPARK_Msg_NE\n+                          (\"overlaying object & cannot appear in Initializes\",\n+                           Input, Input_Id);\n+                        SPARK_Msg_NE\n+                          (\"\\use the overlaid object & instead\",\n+                           Input, Ultimate_Overlaid_Entity (Input_Id));\n+                        return;\n+                     end if;\n+\n                      --  Detect a duplicate use of the same input item\n                      --  (SPARK RM 7.1.5(5)).\n "}, {"sha": "038c1ee686b37b4f694646fd671c92eebcd154f0", "filename": "gcc/ada/sem_util.adb", "status": "modified", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59748b7180590360d3608d30e707a27b0b2cb476/gcc%2Fada%2Fsem_util.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59748b7180590360d3608d30e707a27b0b2cb476/gcc%2Fada%2Fsem_util.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.adb?ref=59748b7180590360d3608d30e707a27b0b2cb476", "patch": "@@ -5708,6 +5708,13 @@ package body Sem_Util is\n                if Ekind (State_Id) = E_Constant then\n                   null;\n \n+               --  Overlays do not contribute to package state\n+\n+               elsif Ekind (State_Id) = E_Variable\n+                 and then Present (Ultimate_Overlaid_Entity (State_Id))\n+               then\n+                  null;\n+\n                --  Generate an error message of the form:\n \n                --    body of package ... has unused hidden states\n@@ -29312,6 +29319,39 @@ package body Sem_Util is\n       end if;\n    end Type_Without_Stream_Operation;\n \n+   ------------------------------\n+   -- Ultimate_Overlaid_Entity --\n+   ------------------------------\n+\n+   function Ultimate_Overlaid_Entity (E : Entity_Id) return Entity_Id is\n+      Address : Node_Id;\n+      Alias   : Entity_Id := E;\n+      Offset  : Boolean;\n+\n+   begin\n+      --  Currently this routine is only called for stand-alone objects that\n+      --  have been analysed, since the analysis of the Address aspect is often\n+      --  delayed.\n+\n+      pragma Assert (Ekind (E) in E_Constant | E_Variable);\n+\n+      loop\n+         Address := Address_Clause (Alias);\n+         if Present (Address) then\n+            Find_Overlaid_Entity (Address, Alias, Offset);\n+            if Present (Alias) then\n+               null;\n+            else\n+               return Empty;\n+            end if;\n+         elsif Alias = E then\n+            return Empty;\n+         else\n+            return Alias;\n+         end if;\n+      end loop;\n+   end Ultimate_Overlaid_Entity;\n+\n    ---------------------\n    -- Ultimate_Prefix --\n    ---------------------"}, {"sha": "7cacae2f9079d70ddec54ca33ee2097e7e190f49", "filename": "gcc/ada/sem_util.ads", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59748b7180590360d3608d30e707a27b0b2cb476/gcc%2Fada%2Fsem_util.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59748b7180590360d3608d30e707a27b0b2cb476/gcc%2Fada%2Fsem_util.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.ads?ref=59748b7180590360d3608d30e707a27b0b2cb476", "patch": "@@ -3275,6 +3275,15 @@ package Sem_Util is\n    --  prevents the construction of a composite stream operation. If Op is\n    --  specified we check only for the given stream operation.\n \n+   function Ultimate_Overlaid_Entity (E : Entity_Id) return Entity_Id;\n+   --  If entity E is overlaying some other entity via an Address clause (which\n+   --  possibly overlays yet another entity via its own Address clause), then\n+   --  return the ultimate overlaid entity. If entity E is not overlaying any\n+   --  other entity (or the overlaid entity cannot be determined statically),\n+   --  then return Empty.\n+   --\n+   --  Subsidiary to the analysis of object overlays in SPARK.\n+\n    function Ultimate_Prefix (N : Node_Id) return Node_Id;\n    --  Obtain the \"outermost\" prefix of arbitrary node N. Return N if no such\n    --  prefix exists."}]}