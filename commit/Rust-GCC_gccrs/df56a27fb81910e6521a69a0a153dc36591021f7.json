{"sha": "df56a27fb81910e6521a69a0a153dc36591021f7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGY1NmEyN2ZiODE5MTBlNjUyMWE2OWEwYTE1M2RjMzY1OTEwMjFmNw==", "commit": {"author": {"name": "Stan Shebs", "email": "shebs@apple.com", "date": "2001-06-08T02:28:04Z"}, "committer": {"name": "Stan Shebs", "email": "shebs@gcc.gnu.org", "date": "2001-06-08T02:28:04Z"}, "message": "darwin.h (ENCODE_SECTION_INFO): Define.\n\n        * config/darwin.h (ENCODE_SECTION_INFO): Define.\n        (REDO_SECTION_INFO_P): Ditto.\n        (STRIP_NAME_ENCODING): Ditto.\n        (ASM_DECLARE_OBJECT_NAME): Use ENCODE_SECTION_INFO.\n        (ASM_OUTPUT_ALIGNED_DECL_LOCAL): Ditto.\n        (ASM_OUTPUT_LABELREF): Use STRIP_NAME_ENCODING.\n        (GEN_LAZY_PTR_NAME_FOR_SYMBOL): Ditto.\n        * config/darwin.c: No longer include c-tree.h.\n        (machopic_classify_ident): Rewrite to use symbol encoding.\n        (lookup_name_darwin): Remove.\n        (machopic_non_lazy_ptr_name): Handle encoded symbols.\n        (machopic_stub_name): Use STRIP_NAME_ENCODING.\n        (machopic_validate_stub_or_non_lazy_ptr): Ditto.\n        (machopic_finish): Ditto, remove test of decl.\n        (update_non_lazy_ptrs): New function.\n        (darwin_encode_section_info): New function.\n        * config/darwin-protos.h: Declare it.\n        * config/rs6000/rs6000.c (machopic_output_stub): Use\n        STRIP_NAME_ENCODING.\n\nFrom-SVN: r42994", "tree": {"sha": "7f34d35e3061d6e92b30a8d6b5f8932a596e7a88", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7f34d35e3061d6e92b30a8d6b5f8932a596e7a88"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/df56a27fb81910e6521a69a0a153dc36591021f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/df56a27fb81910e6521a69a0a153dc36591021f7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/df56a27fb81910e6521a69a0a153dc36591021f7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/df56a27fb81910e6521a69a0a153dc36591021f7/comments", "author": null, "committer": null, "parents": [{"sha": "daa8df6512c63970a3aafb7415d280e7cc720bce", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/daa8df6512c63970a3aafb7415d280e7cc720bce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/daa8df6512c63970a3aafb7415d280e7cc720bce"}], "stats": {"total": 208, "additions": 162, "deletions": 46}, "files": [{"sha": "3ae51dd60379fcd3b018588dc818f043920f7c1a", "filename": "gcc/ChangeLog", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=df56a27fb81910e6521a69a0a153dc36591021f7", "patch": "@@ -1,3 +1,25 @@\n+2001-06-07  Stan Shebs  <shebs@apple.com>\n+\n+\t* config/darwin.h (ENCODE_SECTION_INFO): Define.\n+\t(REDO_SECTION_INFO_P): Ditto.\n+\t(STRIP_NAME_ENCODING): Ditto.\n+\t(ASM_DECLARE_OBJECT_NAME): Use ENCODE_SECTION_INFO.\n+\t(ASM_OUTPUT_ALIGNED_DECL_LOCAL): Ditto.\n+\t(ASM_OUTPUT_LABELREF): Use STRIP_NAME_ENCODING.\n+\t(GEN_LAZY_PTR_NAME_FOR_SYMBOL): Ditto.\n+\t* config/darwin.c: No longer include c-tree.h.\n+\t(machopic_classify_ident): Rewrite to use symbol encoding.\n+\t(lookup_name_darwin): Remove.\n+\t(machopic_non_lazy_ptr_name): Handle encoded symbols.\n+\t(machopic_stub_name): Use STRIP_NAME_ENCODING.\n+\t(machopic_validate_stub_or_non_lazy_ptr): Ditto.\n+\t(machopic_finish): Ditto, remove test of decl.\n+\t(update_non_lazy_ptrs): New function.\n+\t(darwin_encode_section_info): New function.\n+\t* config/darwin-protos.h: Declare it.\n+\t* config/rs6000/rs6000.c (machopic_output_stub): Use\n+\tSTRIP_NAME_ENCODING.\n+\t\n 2001-06-07  Mark Mitchell  <mark@codesourcery.com>\n \n \t* tree.h (DECL_SOURCE_FILE): Improve documentation."}, {"sha": "10afb9a8b1daf8c225680d1c9a9ffe7be8b23459", "filename": "gcc/config/darwin-protos.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Fdarwin-protos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Fdarwin-protos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin-protos.h?ref=df56a27fb81910e6521a69a0a153dc36591021f7", "patch": "@@ -51,6 +51,7 @@ extern void machopic_define_ident PARAMS ((tree));\n extern void machopic_define_name PARAMS ((const char*));\n extern int machopic_name_defined_p PARAMS ((const char*));\n extern int machopic_ident_defined_p PARAMS ((tree));\n+extern void darwin_encode_section_info PARAMS ((tree));\n \n #endif /* TREE_CODE */\n "}, {"sha": "509ff91262a6f7c25fda32879c5f88d898081753", "filename": "gcc/config/darwin.c", "status": "modified", "additions": 116, "deletions": 46, "changes": 162, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Fdarwin.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Fdarwin.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.c?ref=df56a27fb81910e6521a69a0a153dc36591021f7", "patch": "@@ -35,8 +35,6 @@ Boston, MA 02111-1307, USA.  */\n #include \"tree.h\"\n #include \"expr.h\"\n #include \"reload.h\"\n-/* need for IDENTIFIER_GLOBAL_VALUE and IDENTIFIER_LOCAL_VALUE */\n-#include \"c-tree.h\"\n #include \"function.h\"\n #include \"ggc.h\"\n \n@@ -46,6 +44,7 @@ extern void machopic_output_stub PARAMS ((FILE *, const char *, const char *));\n \n static int machopic_data_defined_p PARAMS ((const char *));\n static int func_name_maybe_scoped PARAMS ((const char *));\n+static void update_non_lazy_ptrs PARAMS ((const char *));\n \n /* Make everything that used to go in the text section really go there.  */\n \n@@ -85,10 +84,11 @@ machopic_classify_ident (ident)\n \t\t     && name[3] == 'J'\n \t\t     && name[4] == 'C'\n \t\t     && name[5] == '_'));\n-  tree temp, decl = lookup_name_darwin (ident);\n+  tree temp;\n \n-  if (!decl)\n+  if (name[0] != '!')\n     {\n+      /* Here if no special encoding to be found.  */\n       if (lprefix)\n \t{\n \t  const char *name = IDENTIFIER_POINTER (ident);\n@@ -114,36 +114,24 @@ machopic_classify_ident (ident)\n       return MACHOPIC_UNDEFINED;\n     }\n \n-  /* variable declarations */\n-  else if (TREE_CODE (decl) == VAR_DECL)\n-    {\n-      if ((DECL_INITIAL (decl)\n-           || TREE_STATIC (decl))\n-          && ! TREE_PUBLIC (decl))\n-\treturn MACHOPIC_DEFINED_DATA;\n-    }\n+  else if (name[1] == 'D')\n+    return MACHOPIC_DEFINED_DATA;\n \n-  /* function declarations */\n-  else if (TREE_CODE (decl) == FUNCTION_DECL\n-\t   && (!DECL_EXTERNAL (decl)))\n-    {\n-      if (TREE_STATIC (decl)\n-\t  || TREE_ASM_WRITTEN (decl))\n-\treturn MACHOPIC_DEFINED_FUNCTION;\n-    }\n+  else if (name[1] == 'T')\n+    return MACHOPIC_DEFINED_FUNCTION;\n \n   for (temp = machopic_defined_list; temp != NULL_TREE; temp = TREE_CHAIN (temp))\n     {\n       if (ident == TREE_VALUE (temp))\n \t{\n-\t  if (TREE_CODE (decl) == FUNCTION_DECL)\n+\t  if (name[1] == 'T')\n \t    return MACHOPIC_DEFINED_FUNCTION;\n \t  else\n \t    return MACHOPIC_DEFINED_DATA;\n \t}\n     }\n   \n-  if (TREE_CODE (decl) == FUNCTION_DECL)\n+  if (name[1] == 't' || name[1] == 'T')\n     {\n       if (lprefix)\n \treturn MACHOPIC_DEFINED_FUNCTION;\n@@ -218,20 +206,6 @@ machopic_define_name (name)\n   machopic_define_ident (get_identifier (name));\n }\n \n-tree\n-lookup_name_darwin (name)\n-     tree name;\n-{\n-  tree val;\n-\n-  if (!global_bindings_p()\n-      && IDENTIFIER_LOCAL_VALUE (name))\n-    val = IDENTIFIER_LOCAL_VALUE (name);\n-  else\n-    val = IDENTIFIER_GLOBAL_VALUE (name);\n-  return val;\n-}\n-\n /* This is a static to make inline functions work.  The rtx\n    representing the PIC base symbol always points to here. */\n \n@@ -279,6 +253,7 @@ char *\n machopic_non_lazy_ptr_name (name)\n      const char *name;\n {\n+  char *temp_name;\n   tree temp, ident = get_identifier (name);\n   \n   for (temp = machopic_non_lazy_pointers;\n@@ -289,6 +264,22 @@ machopic_non_lazy_ptr_name (name)\n \treturn IDENTIFIER_POINTER (TREE_PURPOSE (temp));\n     }\n \n+  STRIP_NAME_ENCODING (name, name);\n+\n+  /* Try again, but comparing names this time.  */\n+  for (temp = machopic_non_lazy_pointers;\n+       temp != NULL_TREE; \n+       temp = TREE_CHAIN (temp))\n+    {\n+      if (TREE_VALUE (temp))\n+\t{\n+\t  temp_name = IDENTIFIER_POINTER (TREE_VALUE (temp));\n+\t  STRIP_NAME_ENCODING (temp_name, temp_name);\n+\t  if (strcmp (name, temp_name) == 0)\n+\t    return IDENTIFIER_POINTER (TREE_PURPOSE (temp));\n+\t}\n+    }\n+\n   {\n     char *buffer;\n     tree ptr_name;\n@@ -345,6 +336,8 @@ machopic_stub_name (name)\n \treturn IDENTIFIER_POINTER (TREE_PURPOSE (temp));\n     }\n \n+  STRIP_NAME_ENCODING (name, name);\n+\n   {\n     char *buffer;\n     tree ptr_name;\n@@ -384,7 +377,8 @@ machopic_validate_stub_or_non_lazy_ptr (name, validate_stub)\n      const char *name;\n      int validate_stub;\n {\n-    tree temp, ident = get_identifier (name);\n+  char *real_name;\n+  tree temp, ident = get_identifier (name), id2;\n \n     for (temp = (validate_stub ? machopic_stubs : machopic_non_lazy_pointers);\n          temp != NULL_TREE;\n@@ -396,6 +390,10 @@ machopic_validate_stub_or_non_lazy_ptr (name, validate_stub)\n           TREE_USED (temp) = 1;\n \t  if (TREE_CODE (TREE_VALUE (temp)) == IDENTIFIER_NODE)\n \t    TREE_SYMBOL_REFERENCED (TREE_VALUE (temp)) = 1;\n+\t  STRIP_NAME_ENCODING (real_name, IDENTIFIER_POINTER (TREE_VALUE (temp)));\n+\t  id2 = maybe_get_identifier (real_name);\n+\t  if (id2)\n+\t    TREE_SYMBOL_REFERENCED (id2) = 1;\n \t}\n }\n \n@@ -890,19 +888,11 @@ machopic_finish (asm_out_file)\n       char *stub_name = IDENTIFIER_POINTER (TREE_PURPOSE (temp));\n       char *sym;\n       char *stub;\n-      tree decl = lookup_name_darwin (TREE_VALUE (temp));\n \n       if (! TREE_USED (temp))\n \tcontinue;\n \n-      /* Don't emit stubs for static inline functions which have not\n-         been compiled.  */\n-      if (decl\n-          && TREE_CODE (decl) == FUNCTION_DECL\n-          && DECL_INLINE (decl)\n-          && ! TREE_PUBLIC (decl)\n-          && ! TREE_ASM_WRITTEN (decl))\n-\tcontinue;\n+      STRIP_NAME_ENCODING (sym_name, sym_name);\n \n       sym = alloca (strlen (sym_name) + 2);\n       if (sym_name[0] == '*' || sym_name[0] == '&')\n@@ -1000,3 +990,83 @@ machopic_operand_p (op)\n \n   return 0;\n }\n+\n+/* This function records whether a given name corresponds to a defined\n+   or undefined function or variable, for machopic_classify_ident to\n+   use later.  */\n+\n+void\n+darwin_encode_section_info (decl)\n+     tree decl;\n+{\n+  char code = '\\0';\n+  int defined = 0;\n+\n+  if ((TREE_CODE (decl) == FUNCTION_DECL\n+       || TREE_CODE (decl) == VAR_DECL)\n+      && ((TREE_STATIC (decl)\n+\t   && (!DECL_COMMON (decl) || !TREE_PUBLIC (decl)))\n+\t  || DECL_INITIAL (decl)))\n+    defined = 1;\n+\n+  if (TREE_CODE (decl) == FUNCTION_DECL)\n+    code = (defined ? 'T' : 't');\n+  else if (TREE_CODE (decl) == VAR_DECL)\n+    code = (defined ? 'D' : 'd');\n+\n+  if (code != '\\0')\n+    {\n+      rtx sym_ref = XEXP (DECL_RTL (decl), 0);\n+\n+      if (*(XSTR (sym_ref, 0)) == '!')\n+\t{\n+\t  (XSTR(sym_ref, 0))[1] = code;\n+\t  update_non_lazy_ptrs (XSTR (sym_ref, 0));\n+\t  return;\n+\t}\n+\n+      {\n+\tsize_t len = strlen (XSTR (sym_ref, 0));\n+\tsize_t newlen = len + 4;\n+\tchar *str = alloca (newlen);\n+\n+\tstr[0] = '!';\n+\tstr[1] = code;\n+\tstr[2] = '_';\n+\tstr[3] = '_';\n+\tmemcpy (str + 4, XSTR (sym_ref, 0), len + 1);\n+\n+\tXSTR (sym_ref, 0) = ggc_alloc_string (str, newlen);\n+      }\n+    }\n+}\n+\n+/* Scan the list of non-lazy pointers and update any recorded names whose\n+   stripped name matches the argument.  */\n+\n+static void\n+update_non_lazy_ptrs (name)\n+     const char *name;\n+{\n+  char *name1, *name2;\n+  tree temp;\n+\n+  STRIP_NAME_ENCODING (name1, name);\n+\n+  for (temp = machopic_non_lazy_pointers;\n+       temp != NULL_TREE; \n+       temp = TREE_CHAIN (temp))\n+    {\n+      char *sym_name = IDENTIFIER_POINTER (TREE_VALUE (temp));\n+\n+      if (*sym_name == '!')\n+\t{\n+\t  STRIP_NAME_ENCODING (name2, sym_name);\n+\t  if (strcmp (name1, name2) == 0)\n+\t    {\n+\t      IDENTIFIER_POINTER (TREE_VALUE (temp)) = name;\n+\t      break;\n+\t    }\n+\t}\n+    }\n+}"}, {"sha": "b07678053e51105535a12b661eaad7bd17e07dc4", "filename": "gcc/config/darwin.h", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Fdarwin.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Fdarwin.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.h?ref=df56a27fb81910e6521a69a0a153dc36591021f7", "patch": "@@ -234,6 +234,10 @@ do { text_section ();\t\t\t\t\t\t\t\\\n \t && (!DECL_COMMON (DECL) || !TREE_PUBLIC (DECL)))               \\\n         || DECL_INITIAL (DECL))                                         \\\n       machopic_define_name (xname);                                     \\\n+    if ((TREE_STATIC (DECL)                                             \\\n+\t && (!DECL_COMMON (DECL) || !TREE_PUBLIC (DECL)))               \\\n+        || DECL_INITIAL (DECL))                                         \\\n+      ENCODE_SECTION_INFO (DECL);  \\\n     ASM_OUTPUT_LABEL (FILE, xname);                                     \\\n   } while (0)\n \n@@ -243,6 +247,7 @@ do { text_section ();\t\t\t\t\t\t\t\\\n #undef\tASM_OUTPUT_LABELREF\n #define ASM_OUTPUT_LABELREF(FILE,NAME)\t\\\n   do {\t\t\t\t\t\t\t\t\t\\\n+       STRIP_NAME_ENCODING (NAME, NAME);  \\\n        if (NAME[0] == '&')\t\t\t\t\t\t\\\n          {\t\t\t\t\t\t\t\t\\\n            int len = strlen (NAME);\t\t\t\t\t\\\n@@ -280,6 +285,10 @@ do { text_section ();\t\t\t\t\t\t\t\\\n     fputs (\".lcomm \", (FILE));\t\t\t\t\\\n     assemble_name ((FILE), (NAME));\t\t\t\\\n     fprintf ((FILE), \",%u,%u\\n\", (SIZE), floor_log2 ((ALIGN) / BITS_PER_UNIT)); \\\n+    if ((DECL) && ((TREE_STATIC (DECL)                                             \\\n+\t && (!DECL_COMMON (DECL) || !TREE_PUBLIC (DECL)))               \\\n+        || DECL_INITIAL (DECL)))                                         \\\n+      ENCODE_SECTION_INFO (DECL);  \\\n     if ((DECL) && ((TREE_STATIC (DECL)                                             \\\n \t && (!DECL_COMMON (DECL) || !TREE_PUBLIC (DECL)))               \\\n         || DECL_INITIAL (DECL)))                                         \\\n@@ -705,6 +714,16 @@ enum machopic_addr_class {\n #define MACHOPIC_JUST_INDIRECT (flag_pic == 1)\n #define MACHOPIC_PURE          (flag_pic == 2)\n \n+#define ENCODE_SECTION_INFO(DECL)  \\\n+  darwin_encode_section_info (DECL)\n+\n+/* Be conservative and always redo the encoding.  */\n+\n+#define REDO_SECTION_INFO_P(DECL) (1)\n+\n+#define STRIP_NAME_ENCODING(VAR,SYMBOL_NAME)  \\\n+  ((VAR) = ((SYMBOL_NAME[0] == '!') ? (SYMBOL_NAME) + 4 : (SYMBOL_NAME)))\n+\n #define GEN_BINDER_NAME_FOR_STUB(BUF,STUB,STUB_LENGTH)\t\t\\\n   do {\t\t\t\t\t\t\t\t\\\n     const char *stub_ = (STUB);\t\t\t\t\t\\\n@@ -741,6 +760,7 @@ enum machopic_addr_class {\n   do {\t\t\t\t\t\t\t\t\\\n     const char *symbol_ = (SYMBOL);\t\t\t\t\\\n     char *buffer_ = (BUF);\t\t\t\t\t\\\n+    STRIP_NAME_ENCODING (symbol_, symbol_);  \\\n     if (symbol_[0] == '\"')\t\t\t\t\t\\\n       {\t\t\t\t\t\t\t\t\\\n         strcpy (buffer_, \"\\\"L\");\t\t\t\t\t\\"}, {"sha": "3662fe8856363b32fa12041660ee265fe2d88301", "filename": "gcc/config/rs6000/rs6000.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Frs6000%2Frs6000.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/df56a27fb81910e6521a69a0a153dc36591021f7/gcc%2Fconfig%2Frs6000%2Frs6000.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.c?ref=df56a27fb81910e6521a69a0a153dc36591021f7", "patch": "@@ -8406,6 +8406,9 @@ machopic_output_stub (file, symb, stub)\n   char *local_label_0, *local_label_1, *local_label_2;\n   static int label = 0;\n \n+  /* Lose our funky encoding stuff so it doesn't contaminate the stub.  */\n+  STRIP_NAME_ENCODING (symb, symb);\n+\n   label += 1;\n \n   length = strlen (stub);"}]}