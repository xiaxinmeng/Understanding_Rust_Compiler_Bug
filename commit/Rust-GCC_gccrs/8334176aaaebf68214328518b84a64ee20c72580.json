{"sha": "8334176aaaebf68214328518b84a64ee20c72580", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODMzNDE3NmFhYWViZjY4MjE0MzI4NTE4Yjg0YTY0ZWUyMGM3MjU4MA==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2019-07-03T08:14:24Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-03T08:14:24Z"}, "message": "[Ada] Spurious error on dynamic predicate in a generic context\n\nThis patch fixes a spurious error on the conformance checking between\nthe expression for an aspect analyzed at the freeze point of the type,\nand the analysis of a copy of the expression performed at the end of the\nenclosing list of declarationss. In a generic context the first may not\nhave been analyzed yet and this must be done before the conformance\ncheck.\n\n2019-07-03  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_ch13.adb (Analyze_Attribute_Definition_Clause): No error\n\tmessage on attribute applied to a renaming when the renamed\n\tobject is an aggregate (from code reading).\n\t(Check_Aspect_At_End_Of_Declarations): In a generic context\n\twhere freeze nodes are not generated, the original expression\n\tfor an aspect may need to be analyzed to precent spurious\n\tconformance errors when compared with the expression that is\n\tanakyzed at the end of the current declarative list.\n\ngcc/testsuite/\n\n\t* gnat.dg/predicate5.adb, gnat.dg/predicate5.ads: New testcase.\n\nFrom-SVN: r272969", "tree": {"sha": "f49104fe0605603f26e2afeaa5deb0d4d11eaf34", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f49104fe0605603f26e2afeaa5deb0d4d11eaf34"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8334176aaaebf68214328518b84a64ee20c72580", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8334176aaaebf68214328518b84a64ee20c72580", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8334176aaaebf68214328518b84a64ee20c72580", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8334176aaaebf68214328518b84a64ee20c72580/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "09c9ed5bb8b8e3b65dd2f631bf18f6b796499fbd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/09c9ed5bb8b8e3b65dd2f631bf18f6b796499fbd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/09c9ed5bb8b8e3b65dd2f631bf18f6b796499fbd"}], "stats": {"total": 53, "additions": 52, "deletions": 1}, "files": [{"sha": "0af3e419feae106fca30c9bbc055156aaef18ce9", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=8334176aaaebf68214328518b84a64ee20c72580", "patch": "@@ -1,3 +1,14 @@\n+2019-07-03  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_ch13.adb (Analyze_Attribute_Definition_Clause): No error\n+\tmessage on attribute applied to a renaming when the renamed\n+\tobject is an aggregate (from code reading).\n+\t(Check_Aspect_At_End_Of_Declarations): In a generic context\n+\twhere freeze nodes are not generated, the original expression\n+\tfor an aspect may need to be analyzed to precent spurious\n+\tconformance errors when compared with the expression that is\n+\tanakyzed at the end of the current declarative list.\n+\n 2019-07-03  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* layout.adb (Layout_Type): Do not set the component size of an"}, {"sha": "ffd6f2311d4d17ea65da69771afe6c64d66ae93c", "filename": "gcc/ada/sem_ch13.adb", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Fada%2Fsem_ch13.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Fada%2Fsem_ch13.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch13.adb?ref=8334176aaaebf68214328518b84a64ee20c72580", "patch": "@@ -4934,8 +4934,12 @@ package body Sem_Ch13 is\n         and then Present (Renamed_Object (Ent))\n       then\n          --  Case of renamed object from source, this is an error\n+         --  unless the pbject is an aggregate and the renaming is\n+         --  created for an object declaration.\n \n-         if Comes_From_Source (Renamed_Object (Ent)) then\n+         if Comes_From_Source (Renamed_Object (Ent))\n+           and then Nkind (Renamed_Object (Ent)) /= N_Aggregate\n+         then\n             Get_Name_String (Chars (N));\n             Error_Msg_Strlen := Name_Len;\n             Error_Msg_String (1 .. Name_Len) := Name_Buffer (1 .. Name_Len);\n@@ -9336,6 +9340,16 @@ package body Sem_Ch13 is\n       --  All other cases\n \n       else\n+\n+         --  In a generic context freeze nodes are not always generated,\n+         --  so analyze the expression now.\n+\n+         if not Analyzed (Freeze_Expr)\n+           and then Inside_A_Generic\n+         then\n+            Preanalyze (Freeze_Expr);\n+         end if;\n+\n          --  Indicate that the expression comes from an aspect specification,\n          --  which is used in subsequent analysis even if expansion is off.\n "}, {"sha": "058b533ba773f1f9d1940b9dd448f89166953e57", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=8334176aaaebf68214328518b84a64ee20c72580", "patch": "@@ -1,3 +1,7 @@\n+2019-07-03  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/predicate5.adb, gnat.dg/predicate5.ads: New testcase.\n+\n 2019-07-03  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gnat.dg/alignment14.adb: New testcase."}, {"sha": "01acf64443e41a50b9dae1b15149659f9ef88dbb", "filename": "gcc/testsuite/gnat.dg/predicate5.adb", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Ftestsuite%2Fgnat.dg%2Fpredicate5.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Ftestsuite%2Fgnat.dg%2Fpredicate5.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fpredicate5.adb?ref=8334176aaaebf68214328518b84a64ee20c72580", "patch": "@@ -0,0 +1,5 @@\n+--  { dg-do compile }\n+\n+package body Predicate5 is\n+   procedure Foo is null;\n+end Predicate5;"}, {"sha": "4e8f9b9e1a49c64e09caaf0c5997007ae670cfad", "filename": "gcc/testsuite/gnat.dg/predicate5.ads", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Ftestsuite%2Fgnat.dg%2Fpredicate5.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8334176aaaebf68214328518b84a64ee20c72580/gcc%2Ftestsuite%2Fgnat.dg%2Fpredicate5.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fpredicate5.ads?ref=8334176aaaebf68214328518b84a64ee20c72580", "patch": "@@ -0,0 +1,17 @@\n+generic\n+   type Value_Type is private;\n+package Predicate5 is\n+   type MT (Has : Boolean := False) is record\n+      case Has is\n+         when False =>\n+            null;\n+         when True =>\n+            MX : Value_Type;\n+      end case;\n+   end record;\n+   function Foo (M : MT) return Boolean is (not M.Has);\n+   subtype LT is MT with Dynamic_Predicate => not LT.Has;\n+   function Bar (M : MT) return Boolean is (Foo (M));\n+\n+   procedure Foo;\n+end;"}]}