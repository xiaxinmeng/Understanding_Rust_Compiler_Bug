{"sha": "21619cc6136e3884e6ea3f990f3edd05c173889f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjE2MTljYzYxMzZlMzg4NGU2ZWEzZjk5MGYzZWRkMDVjMTczODg5Zg==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2008-07-31T13:31:37Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2008-07-31T13:31:37Z"}, "message": "sem_ch10.adb (Build_Unit_Name): If the unit name in a with_clause has the form A.B.C and B is a unit renaming...\n\n2008-07-31  Ed Schonberg  <schonberg@adacore.com>\n\n\t* sem_ch10.adb (Build_Unit_Name): If the unit name in a with_clause\n\thas the form A.B.C and B is a unit renaming, analyze its compilation\n\tunit and add a with_clause on A.b to the context.\n\nFrom-SVN: r138408", "tree": {"sha": "6650ee6b5af375546106eada94950d78f56e9dc6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6650ee6b5af375546106eada94950d78f56e9dc6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/21619cc6136e3884e6ea3f990f3edd05c173889f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/21619cc6136e3884e6ea3f990f3edd05c173889f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/21619cc6136e3884e6ea3f990f3edd05c173889f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/21619cc6136e3884e6ea3f990f3edd05c173889f/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "fb59381ec6d4e8967d166c1e73746d21200e4905", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fb59381ec6d4e8967d166c1e73746d21200e4905", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fb59381ec6d4e8967d166c1e73746d21200e4905"}], "stats": {"total": 33, "additions": 30, "deletions": 3}, "files": [{"sha": "626bee47c1a8924f1c741e02bd5a622e16a343a7", "filename": "gcc/ada/sem_ch10.adb", "status": "modified", "additions": 30, "deletions": 3, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/21619cc6136e3884e6ea3f990f3edd05c173889f/gcc%2Fada%2Fsem_ch10.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/21619cc6136e3884e6ea3f990f3edd05c173889f/gcc%2Fada%2Fsem_ch10.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch10.adb?ref=21619cc6136e3884e6ea3f990f3edd05c173889f", "patch": "@@ -2660,13 +2660,18 @@ package body Sem_Ch10 is\n       P     : Node_Id;\n \n       function Build_Unit_Name (Nam : Node_Id) return Node_Id;\n-      --  Comment required here ???\n+      --  Build name to be used in implicit with_clause. In most cases this\n+      --  is the source name, but if renamings are present we must make the\n+      --  original unit visible, not the one it renames. The entity in the\n+      --  use clause is the renamed unit, but the identifier is the one from\n+      --  the source, which allows us to recover the unit renaming.\n \n       ---------------------\n       -- Build_Unit_Name --\n       ---------------------\n \n       function Build_Unit_Name (Nam : Node_Id) return Node_Id is\n+         Ent      : Entity_Id;\n          Renaming : Entity_Id;\n          Result   : Node_Id;\n \n@@ -2695,12 +2700,34 @@ package body Sem_Ch10 is\n             end if;\n \n          else\n+            Ent := Entity (Nam);\n+\n+            if Present (Entity (Selector_Name (Nam)))\n+              and then Chars (Entity (Selector_Name (Nam))) /= Chars (Ent)\n+              and then\n+                Nkind (Unit_Declaration_Node (Entity (Selector_Name (Nam))))\n+                  = N_Package_Renaming_Declaration\n+            then\n+\n+               --  The name in the with_clause is of the form A.B.C, and B\n+               --  is given by a renaming declaration. In that case we may\n+               --  not have analyzed the unit for B, but replaced it directly\n+               --  in lib-load with the unit it renames. We have to make A.B\n+               --  visible, so analyze the declaration for B now, in case it\n+               --  has not been done yet.\n+\n+               Ent :=  Entity (Selector_Name (Nam));\n+               Analyze\n+                 (Parent\n+                   (Unit_Declaration_Node (Entity (Selector_Name (Nam)))));\n+            end if;\n+\n             Result :=\n               Make_Expanded_Name (Loc,\n                 Chars  => Chars (Entity (Nam)),\n                 Prefix => Build_Unit_Name (Prefix (Nam)),\n-                Selector_Name => New_Occurrence_Of (Entity (Nam), Loc));\n-            Set_Entity (Result, Entity (Nam));\n+                Selector_Name => New_Occurrence_Of (Ent, Loc));\n+            Set_Entity (Result, Ent);\n             return Result;\n          end if;\n       end Build_Unit_Name;"}]}