{"sha": "c36d21ee42349ea0e8565daa2013ba4f193d4ffe", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzM2ZDIxZWU0MjM0OWVhMGU4NTY1ZGFhMjAxM2JhNGYxOTNkNGZmZQ==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2018-08-21T14:45:04Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-08-21T14:45:04Z"}, "message": "[Ada] Fix scope computation for entry bodies and accept alternatives\n\n2018-08-21  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch9.adb (Reset_Scopes): Do not recurse into type\n\tdeclarations when resetting the scope of entities declared the\n\tprocedures generated for entry bodies and accept alternatives.\n\tUse the entity of the procedure declaration, not its body, as\n\tthe new scope.\n\nFrom-SVN: r263713", "tree": {"sha": "f5f9958a741673e51b11ab7ae28b494f84f3aa38", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f5f9958a741673e51b11ab7ae28b494f84f3aa38"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c36d21ee42349ea0e8565daa2013ba4f193d4ffe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c36d21ee42349ea0e8565daa2013ba4f193d4ffe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c36d21ee42349ea0e8565daa2013ba4f193d4ffe", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c36d21ee42349ea0e8565daa2013ba4f193d4ffe/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "3f99a611cab3ff6f5dab0e99ec2cf3a89b99cb1b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3f99a611cab3ff6f5dab0e99ec2cf3a89b99cb1b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3f99a611cab3ff6f5dab0e99ec2cf3a89b99cb1b"}], "stats": {"total": 34, "additions": 25, "deletions": 9}, "files": [{"sha": "d90f01a7c25f2d7c477b3538434c46a919c9445b", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c36d21ee42349ea0e8565daa2013ba4f193d4ffe/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c36d21ee42349ea0e8565daa2013ba4f193d4ffe/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=c36d21ee42349ea0e8565daa2013ba4f193d4ffe", "patch": "@@ -1,3 +1,11 @@\n+2018-08-21  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* exp_ch9.adb (Reset_Scopes): Do not recurse into type\n+\tdeclarations when resetting the scope of entities declared the\n+\tprocedures generated for entry bodies and accept alternatives.\n+\tUse the entity of the procedure declaration, not its body, as\n+\tthe new scope.\n+\n 2018-08-21  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* einfo.adb (Elaboration_Entity): Include entries and entry"}, {"sha": "d7e666309ab951712f73b093491c39b4b9e0d9e0", "filename": "gcc/ada/exp_ch9.adb", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c36d21ee42349ea0e8565daa2013ba4f193d4ffe/gcc%2Fada%2Fexp_ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c36d21ee42349ea0e8565daa2013ba4f193d4ffe/gcc%2Fada%2Fexp_ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch9.adb?ref=c36d21ee42349ea0e8565daa2013ba4f193d4ffe", "patch": "@@ -479,7 +479,9 @@ package body Exp_Ch9 is\n    procedure Reset_Scopes_To (Proc_Body : Node_Id; E : Entity_Id);\n    --  Reset the scope of declarations and blocks at the top level of Proc_Body\n    --  to be E. Used after expanding entry bodies into their corresponding\n-   --  procedures.\n+   --  procedures. This is needed during unnesting to determine whether a\n+   --  body geenrated for an entry or an accept alternative includes uplevel\n+   --  references.\n \n    function Trivial_Accept_OK return Boolean;\n    --  If there is no DO-END block for an accept, or if the DO-END block has\n@@ -3807,7 +3809,7 @@ package body Exp_Ch9 is\n                                New_Occurrence_Of\n                                  (RTE (RE_Get_GNAT_Exception), Loc)))))))));\n \n-         Reset_Scopes_To (Proc_Body, Bod_Id);\n+         Reset_Scopes_To (Proc_Body, Protected_Body_Subprogram (Ent));\n          return Proc_Body;\n       end if;\n    end Build_Protected_Entry;\n@@ -10703,7 +10705,7 @@ package body Exp_Ch9 is\n               Make_Defining_Identifier (Eloc,\n                 New_External_Name (Chars (Ename), 'A', Num_Accept));\n \n-            --  Link the acceptor to the original receiving entry\n+            --  Link the acceptor to the original receiving entry.\n \n             Set_Ekind           (PB_Ent, E_Procedure);\n             Set_Receiving_Entry (PB_Ent, Eent);\n@@ -14831,10 +14833,12 @@ package body Exp_Ch9 is\n    ---------------------\n \n    procedure Reset_Scopes_To (Proc_Body : Node_Id; E : Entity_Id) is\n+\n       function Reset_Scope (N : Node_Id) return Traverse_Result;\n       --  Temporaries may have been declared during expansion of the procedure\n-      --  alternative. Indicate that their scope is the new body, to prevent\n-      --  generation of spurious uplevel references for these entities.\n+      --  created for an entry body or an accept alternative. Indicate that\n+      --  their scope is the new body, to unsure proper generation of uplevel\n+      --  references where needed during unnesting.\n \n       procedure Reset_Scopes is new Traverse_Proc (Reset_Scope);\n \n@@ -14855,13 +14859,19 @@ package body Exp_Ch9 is\n             Set_Scope (Entity (Identifier (N)), E);\n             return Skip;\n \n-         elsif Nkind (N) = N_Package_Declaration then\n+         --  Ditto for a package declaration or a full type declaration, etc.\n+\n+         elsif Nkind (N) = N_Package_Declaration\n+             or else Nkind (N) in N_Declaration\n+             or else Nkind (N) in N_Renaming_Declaration\n+         then\n             Set_Scope (Defining_Entity (N), E);\n             return Skip;\n \n          elsif N = Proc_Body then\n \n-            --  Scan declarations\n+            --  Scan declarations in new body. Declarations in the statement\n+            --  part will be handled during later traversal.\n \n             Decl := First (Declarations (N));\n             while Present (Decl) loop\n@@ -14871,8 +14881,6 @@ package body Exp_Ch9 is\n \n          elsif N /= Proc_Body and then Nkind (N) in N_Proper_Body then\n             return Skip;\n-         elsif Nkind (N) = N_Defining_Identifier then\n-            Set_Scope (N, E);\n          end if;\n \n          return OK;"}]}