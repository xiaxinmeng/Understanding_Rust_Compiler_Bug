{"sha": "38990220821dc7ff88bf1a0da0da49d679141735", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Mzg5OTAyMjA4MjFkYzdmZjg4YmYxYTBkYTBkYTQ5ZDY3OTE0MTczNQ==", "commit": {"author": {"name": "Emmanuel Briot", "email": "briot@adacore.com", "date": "2009-07-28T13:41:47Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2009-07-28T13:41:47Z"}, "message": "make.adb, [...] (Project_Tree): Duplicates the global variable that also exists in makeutl.ads...\n\n2009-07-28  Emmanuel Briot  <briot@adacore.com>\n\n\t* make.adb, makeutl.adb, makeutl.ads (Project_Tree): Duplicates the\n\tglobal variable that also exists in makeutl.ads, and that some routines\n\tin that package use already.\n\t(Check): Moved part of the code to makeutl.adb for better sharing with\n\tgprbuild.\n\nFrom-SVN: r150157", "tree": {"sha": "db6086c3ae73f0706f8134c8f2c1116bf5603739", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/db6086c3ae73f0706f8134c8f2c1116bf5603739"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/38990220821dc7ff88bf1a0da0da49d679141735", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/38990220821dc7ff88bf1a0da0da49d679141735", "html_url": "https://github.com/Rust-GCC/gccrs/commit/38990220821dc7ff88bf1a0da0da49d679141735", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/38990220821dc7ff88bf1a0da0da49d679141735/comments", "author": {"login": "briot", "id": 42402, "node_id": "MDQ6VXNlcjQyNDAy", "avatar_url": "https://avatars.githubusercontent.com/u/42402?v=4", "gravatar_id": "", "url": "https://api.github.com/users/briot", "html_url": "https://github.com/briot", "followers_url": "https://api.github.com/users/briot/followers", "following_url": "https://api.github.com/users/briot/following{/other_user}", "gists_url": "https://api.github.com/users/briot/gists{/gist_id}", "starred_url": "https://api.github.com/users/briot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/briot/subscriptions", "organizations_url": "https://api.github.com/users/briot/orgs", "repos_url": "https://api.github.com/users/briot/repos", "events_url": "https://api.github.com/users/briot/events{/privacy}", "received_events_url": "https://api.github.com/users/briot/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f563194df3f79b74b96173f0957fa403596d0e79", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f563194df3f79b74b96173f0957fa403596d0e79", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f563194df3f79b74b96173f0957fa403596d0e79"}], "stats": {"total": 176, "additions": 108, "deletions": 68}, "files": [{"sha": "036e813fca2f394e303d282ea38b6711a3e63eee", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=38990220821dc7ff88bf1a0da0da49d679141735", "patch": "@@ -1,3 +1,11 @@\n+2009-07-28  Emmanuel Briot  <briot@adacore.com>\n+\n+\t* make.adb, makeutl.adb, makeutl.ads (Project_Tree): Duplicates the\n+\tglobal variable that also exists in makeutl.ads, and that some routines\n+\tin that package use already.\n+\t(Check): Moved part of the code to makeutl.adb for better sharing with\n+\tgprbuild.\n+\n 2009-07-28  Arnaud Charlet  <charlet@adacore.com>\n \n \t* gcc-interface/Make-lang.in: Update dependencies."}, {"sha": "998e1e4a2dabd3792fb98d738dc444d29d5d582f", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 4, "deletions": 68, "changes": 72, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=38990220821dc7ff88bf1a0da0da49d679141735", "patch": "@@ -343,8 +343,6 @@ package body Make is\n    Current_Verbosity : Prj.Verbosity  := Prj.Default;\n    --  Verbosity to parse the project files\n \n-   Project_Tree : constant Project_Tree_Ref := new Project_Tree_Data;\n-\n    Main_Project : Prj.Project_Id := No_Project;\n    --  The project id of the main project file, if any\n \n@@ -1804,72 +1802,10 @@ package body Make is\n \n             elsif not Read_Only and then Main_Project /= No_Project then\n \n-               --  Check if a file name does not correspond to the mapping of\n-               --  units to file names.\n-\n-               declare\n-                  SD        : Sdep_Record;\n-                  WR        : With_Record;\n-                  Unit_Name : Name_Id;\n-\n-               begin\n-                  U_Chk :\n-                  for U in ALIs.Table (ALI).First_Unit ..\n-                           ALIs.Table (ALI).Last_Unit\n-                  loop\n-                     --  Check if the file name is one of the source of the\n-                     --  unit.\n-\n-                     Get_Name_String (Units.Table (U).Uname);\n-                     Name_Len := Name_Len - 2;\n-                     Unit_Name := Name_Find;\n-\n-                     if File_Not_A_Source_Of\n-                          (Unit_Name, Units.Table (U).Sfile)\n-                     then\n-                        ALI := No_ALI_Id;\n-                        return;\n-                     end if;\n-\n-                     --  Do the same check for each of the withed units\n-\n-                     W_Check :\n-                     for W in Units.Table (U).First_With\n-                          ..\n-                        Units.Table (U).Last_With\n-                     loop\n-                        WR := Withs.Table (W);\n-\n-                        if WR.Sfile /= No_File then\n-                           Get_Name_String (WR.Uname);\n-                           Name_Len := Name_Len - 2;\n-                           Unit_Name := Name_Find;\n-\n-                           if File_Not_A_Source_Of (Unit_Name, WR.Sfile) then\n-                              ALI := No_ALI_Id;\n-                              return;\n-                           end if;\n-                        end if;\n-                     end loop W_Check;\n-                  end loop U_Chk;\n-\n-                  --  Check also the subunits\n-\n-                  D_Check :\n-                  for D in ALIs.Table (ALI).First_Sdep ..\n-                           ALIs.Table (ALI).Last_Sdep\n-                  loop\n-                     SD := Sdep.Table (D);\n-                     Unit_Name := SD.Subunit_Name;\n-\n-                     if Unit_Name /= No_Name then\n-                        if File_Not_A_Source_Of (Unit_Name, SD.Sfile) then\n-                           ALI := No_ALI_Id;\n-                           return;\n-                        end if;\n-                     end if;\n-                  end loop D_Check;\n-               end;\n+               if not Check_Source_Info_In_ALI (ALI) then\n+                  ALI := No_ALI_Id;\n+                  return;\n+               end if;\n \n                --  Check that the ALI file is in the correct object directory.\n                --  If it is in the object directory of a project that is"}, {"sha": "4bac5a72d3634ca8dd8424c5dd7e29b919d35e15", "filename": "gcc/ada/makeutl.adb", "status": "modified", "additions": 90, "deletions": 0, "changes": 90, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2Fmakeutl.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2Fmakeutl.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmakeutl.adb?ref=38990220821dc7ff88bf1a0da0da49d679141735", "patch": "@@ -23,6 +23,7 @@\n --                                                                          --\n ------------------------------------------------------------------------------\n \n+with ALI;      use ALI;\n with Debug;\n with Osint;    use Osint;\n with Output;   use Output;\n@@ -155,6 +156,95 @@ package body Makeutl is\n       end if;\n    end Add_Linker_Option;\n \n+   ------------------------------\n+   -- Check_Source_Info_In_ALI --\n+   ------------------------------\n+\n+   function Check_Source_Info_In_ALI (The_ALI : ALI_Id) return Boolean is\n+      Unit_Name : Name_Id;\n+   begin\n+      U_Chk :\n+      for U in ALIs.Table (The_ALI).First_Unit\n+        .. ALIs.Table (The_ALI).Last_Unit\n+      loop\n+         --  Check if the file name is one of the source of the unit.\n+\n+         Get_Name_String (Units.Table (U).Uname);\n+         Name_Len  := Name_Len - 2;\n+         Unit_Name := Name_Find;\n+\n+         if File_Not_A_Source_Of (Unit_Name, Units.Table (U).Sfile) then\n+            return False;\n+         end if;\n+\n+         --  Do the same check for each of the withed units\n+\n+         W_Check :\n+         for W in Units.Table (U).First_With .. Units.Table (U).Last_With loop\n+            declare\n+               WR : ALI.With_Record renames Withs.Table (W);\n+            begin\n+               if WR.Sfile /= No_File then\n+                  Get_Name_String (WR.Uname);\n+                  Name_Len  := Name_Len - 2;\n+                  Unit_Name := Name_Find;\n+\n+                  if File_Not_A_Source_Of (Unit_Name, WR.Sfile) then\n+                     return False;\n+                  end if;\n+               end if;\n+            end;\n+         end loop W_Check;\n+      end loop U_Chk;\n+\n+      --  Check also the subunits\n+\n+      D_Check :\n+      for D in ALIs.Table (The_ALI).First_Sdep\n+        .. ALIs.Table (The_ALI).Last_Sdep\n+      loop\n+         declare\n+            SD : Sdep_Record renames Sdep.Table (D);\n+         begin\n+            Unit_Name := SD.Subunit_Name;\n+\n+            if Unit_Name /= No_Name then\n+               --  For separates, the file is no longer associated with the\n+               --  unit (\"proc-sep.adb\" is not associated with unit \"proc.sep\".\n+               --  So we need to check whether the source file still exists in\n+               --  the source tree: it will if it matches the naming scheme\n+               --  (and then will be for the same unit).\n+\n+               if Find_Source\n+                 (In_Tree => Project_Tree,\n+                  Project => No_Project,\n+                  Base_Name => SD.Sfile) = No_Source\n+               then\n+                  --  If this is not a runtime file (when using -a) ? Otherwise\n+                  --  we get complaints about a-except.adb, which uses\n+                  --  separates.\n+\n+                  if not Check_Readonly_Files\n+                    or else Find_File (SD.Sfile, Osint.Source) = No_File\n+                  then\n+                     if Verbose_Mode then\n+                        Write_Line\n+                          (\"While parsing ALI file: Sdep associates \"\n+                           & Get_Name_String (SD.Sfile)\n+                           & \" with unit \" & Get_Name_String (Unit_Name)\n+                           & \" but this does not match what was found while\"\n+                           & \" parsing the project. Will recompile\");\n+                     end if;\n+                     return False;\n+                  end if;\n+               end if;\n+            end if;\n+         end;\n+      end loop D_Check;\n+\n+      return True;\n+   end Check_Source_Info_In_ALI;\n+\n    -----------------\n    -- Create_Name --\n    -----------------"}, {"sha": "09d8c2bdce6e391f109a817e26c24d7e00fccaa8", "filename": "gcc/ada/makeutl.ads", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2Fmakeutl.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/38990220821dc7ff88bf1a0da0da49d679141735/gcc%2Fada%2Fmakeutl.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmakeutl.ads?ref=38990220821dc7ff88bf1a0da0da49d679141735", "patch": "@@ -23,6 +23,7 @@\n --                                                                          --\n ------------------------------------------------------------------------------\n \n+with ALI;\n with Namet; use Namet;\n with Opt;\n with Osint;\n@@ -77,6 +78,11 @@ package Makeutl is\n    --  Returns True if the unit is in one of the project file, but the file\n    --  name is not one of its source. Returns False otherwise.\n \n+   function Check_Source_Info_In_ALI (The_ALI : ALI.ALI_Id) return Boolean;\n+   --  Check whether all file references in ALI are still valid (ie the source\n+   --  files are still associated with the same units).\n+   --  Return True if everything is still valid\n+\n    function Is_External_Assignment (Argv : String) return Boolean;\n    --  Verify that an external assignment switch is syntactically correct\n    --"}]}