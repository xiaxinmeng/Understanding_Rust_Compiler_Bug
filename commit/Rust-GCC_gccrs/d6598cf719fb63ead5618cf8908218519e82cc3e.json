{"sha": "d6598cf719fb63ead5618cf8908218519e82cc3e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDY1OThjZjcxOWZiNjNlYWQ1NjE4Y2Y4OTA4MjE4NTE5ZTgyY2MzZQ==", "commit": {"author": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2016-09-04T16:17:55Z"}, "committer": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2016-09-04T16:17:55Z"}, "message": "re PR fortran/71902 (Unneeded temporary on reallocatable character assignment)\n\n2016-09-04  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/71902\n\t* frontend-passes.c (realloc_string_callback): Also check for the\n\tlhs being deferred.  Name temporary variable \"realloc_string\".\n\n2016-09-04  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/71902\n\t* gfortran.dg/dependency_47.f90:  New test.\n\t* gfortran.dg/dependency_49.f90:  New test.\n\nFrom-SVN: r239977", "tree": {"sha": "7ba3242cce173a116ef52dac87549f58429914c0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7ba3242cce173a116ef52dac87549f58429914c0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d6598cf719fb63ead5618cf8908218519e82cc3e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d6598cf719fb63ead5618cf8908218519e82cc3e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d6598cf719fb63ead5618cf8908218519e82cc3e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d6598cf719fb63ead5618cf8908218519e82cc3e/comments", "author": null, "committer": null, "parents": [{"sha": "abb62d32a1f472ba3b1f9ae07bcdcc1d7f014699", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/abb62d32a1f472ba3b1f9ae07bcdcc1d7f014699", "html_url": "https://github.com/Rust-GCC/gccrs/commit/abb62d32a1f472ba3b1f9ae07bcdcc1d7f014699"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "cd1097910751e924f3b19f464c8c879a0ea9463d", "filename": "gcc/fortran/frontend-passes.c", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d6598cf719fb63ead5618cf8908218519e82cc3e/gcc%2Ffortran%2Ffrontend-passes.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d6598cf719fb63ead5618cf8908218519e82cc3e/gcc%2Ffortran%2Ffrontend-passes.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ffrontend-passes.c?ref=d6598cf719fb63ead5618cf8908218519e82cc3e", "patch": "@@ -164,19 +164,34 @@ realloc_string_callback (gfc_code **c, int *walk_subtrees ATTRIBUTE_UNUSED,\n   gfc_expr *expr1, *expr2;\n   gfc_code *co = *c;\n   gfc_expr *n;\n+  gfc_ref *ref;\n+  bool found_substr;\n \n   if (co->op != EXEC_ASSIGN)\n     return 0;\n \n   expr1 = co->expr1;\n   if (expr1->ts.type != BT_CHARACTER || expr1->rank != 0\n-      || !expr1->symtree->n.sym->attr.allocatable)\n+      || !gfc_expr_attr(expr1).allocatable\n+      || !expr1->ts.deferred)\n     return 0;\n \n   expr2 = gfc_discard_nops (co->expr2);\n   if (expr2->expr_type != EXPR_VARIABLE)\n     return 0;\n \n+  found_substr = false;\n+  for (ref = expr2->ref; ref; ref = ref->next)\n+    {\n+      if (ref->type == REF_SUBSTRING)\n+\t{\n+\t  found_substr = true;\n+\t  break;\n+\t}\n+    }\n+  if (!found_substr)\n+    return 0;\n+\n   if (!gfc_check_dependency (expr1, expr2, true))\n     return 0;\n \n@@ -190,7 +205,7 @@ realloc_string_callback (gfc_code **c, int *walk_subtrees ATTRIBUTE_UNUSED,\n   current_code = c;\n   inserted_block = NULL;\n   changed_statement = NULL;\n-  n = create_var (expr2, \"trim\");\n+  n = create_var (expr2, \"realloc_string\");\n   co->expr2 = n;\n   return 0;\n }"}, {"sha": "4888771c183768805893cdf754ece0008af6fa07", "filename": "gcc/testsuite/gfortran.dg/dependency_47.f90", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d6598cf719fb63ead5618cf8908218519e82cc3e/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_47.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d6598cf719fb63ead5618cf8908218519e82cc3e/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_47.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_47.f90?ref=d6598cf719fb63ead5618cf8908218519e82cc3e", "patch": "@@ -0,0 +1,14 @@\n+! { dg-do compile }\n+! Make sure there is only one instance of a temporary variable here.\n+! { dg-options \"-fdump-tree-original\" }\n+\n+SUBROUTINE prtdata(ilen)\n+  INTEGER :: ilen\n+  character(len=ilen), allocatable :: cline(:)\n+  allocate(cline(2))\n+  cline(1) = 'a'\n+  cline(1)(2:3) = cline(1)(1:2)\n+  cline(2) = cline(1)\n+  print *,c\n+END SUBROUTINE prtdata\n+! { dg-final { scan-tree-dump-not \"__var_\" \"original\" } }"}, {"sha": "73d517e8f765a4372442ec1b4f0ccf4d9f58529f", "filename": "gcc/testsuite/gfortran.dg/dependency_49.f90", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d6598cf719fb63ead5618cf8908218519e82cc3e/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_49.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d6598cf719fb63ead5618cf8908218519e82cc3e/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_49.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_49.f90?ref=d6598cf719fb63ead5618cf8908218519e82cc3e", "patch": "@@ -0,0 +1,14 @@\n+! { dg-do compile }\n+! { dg-options \"-fdump-tree-original\" }\n+! PR fortran/71902 - make sure that component references are followed\n+! for dependency analysis.\n+program main\n+  type foo\n+     character(len=:), allocatable :: x\n+  end type foo\n+  type(foo) :: a\n+  a%x = 'asdf'\n+  a%x = a%x(2:3)\n+  print *,a%x\n+end program main\n+! { dg-final { scan-tree-dump-times \"__var_1\" 4 \"original\" } }"}]}