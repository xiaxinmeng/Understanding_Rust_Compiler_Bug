{"sha": "970b03c0037549a571ecea9afa41de78eb859b3a", "node_id": "C_kwDOANBUbNoAKDk3MGIwM2MwMDM3NTQ5YTU3MWVjZWE5YWZhNDFkZTc4ZWI4NTliM2E", "commit": {"author": {"name": "yulong", "email": "shiyulong@iscas.ac.cn", "date": "2022-06-08T02:19:21Z"}, "committer": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2022-06-20T08:44:40Z"}, "message": "RISC-V: Fix a bug that is the CMO builtins are missing parameter\n\nWe changed builtins format about zicbom and zicboz subextensions and modified test cases.\n\ndiff with the previous version:\n1.We modified the FUNCTION_TYPE from RISCV_VOID_FTYPE_SI/DI to RISCV_VOID_FTYPE_VOID_PTR.\n2.We added a new RISCV_ATYPE_VOID_PTR in riscv-builtins.cc and a new DEF_RISCV_FTYPE (1, (VOID, VOID_PTR)) in riscv-ftypes.def.\n3.We deleted DEF_RISCV_FTYPE (1, (VOID, SI/DI)).\n4.We modified the input parameters of the test cases.\n\nThanks, Simon and Kito.\n\ngcc/ChangeLog:\n\n\t* config/riscv/riscv-builtins.cc (RISCV_ATYPE_VOID_PTR): New.\n\t* config/riscv/riscv-cmo.def (RISCV_BUILTIN): Changed the FUNCTION_TYPE\n\tof RISCV_BUILTIN.\n\t* config/riscv/riscv-ftypes.def (0): Remove unused.\n\t(1): New.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.target/riscv/cmo-zicbom-1.c: modified the input parameters.\n\t* gcc.target/riscv/cmo-zicbom-2.c: modified the input parameters.\n\t* gcc.target/riscv/cmo-zicboz-1.c: modified the input parameters.\n\t* gcc.target/riscv/cmo-zicboz-2.c: modified the input parameters.", "tree": {"sha": "fcb07351962f5c60a29019c87a446c8f3439b936", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fcb07351962f5c60a29019c87a446c8f3439b936"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/970b03c0037549a571ecea9afa41de78eb859b3a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/970b03c0037549a571ecea9afa41de78eb859b3a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/970b03c0037549a571ecea9afa41de78eb859b3a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/970b03c0037549a571ecea9afa41de78eb859b3a/comments", "author": {"login": "yulong-plct", "id": 94943299, "node_id": "U_kgDOBai4Qw", "avatar_url": "https://avatars.githubusercontent.com/u/94943299?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yulong-plct", "html_url": "https://github.com/yulong-plct", "followers_url": "https://api.github.com/users/yulong-plct/followers", "following_url": "https://api.github.com/users/yulong-plct/following{/other_user}", "gists_url": "https://api.github.com/users/yulong-plct/gists{/gist_id}", "starred_url": "https://api.github.com/users/yulong-plct/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yulong-plct/subscriptions", "organizations_url": "https://api.github.com/users/yulong-plct/orgs", "repos_url": "https://api.github.com/users/yulong-plct/repos", "events_url": "https://api.github.com/users/yulong-plct/events{/privacy}", "received_events_url": "https://api.github.com/users/yulong-plct/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e058dfc43fa0df112293584e8f48f6f2cfa3e72a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e058dfc43fa0df112293584e8f48f6f2cfa3e72a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e058dfc43fa0df112293584e8f48f6f2cfa3e72a"}], "stats": {"total": 92, "additions": 58, "deletions": 34}, "files": [{"sha": "1218fdfc67d0bf2de6d9d06fe1ca7255c209f239", "filename": "gcc/config/riscv/riscv-builtins.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Fconfig%2Friscv%2Friscv-builtins.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Fconfig%2Friscv%2Friscv-builtins.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-builtins.cc?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -133,6 +133,7 @@ AVAIL (prefetchi64, TARGET_ZICBOP && TARGET_64BIT)\n #define RISCV_ATYPE_USI unsigned_intSI_type_node\n #define RISCV_ATYPE_SI intSI_type_node\n #define RISCV_ATYPE_DI intDI_type_node\n+#define RISCV_ATYPE_VOID_PTR ptr_type_node\n \n /* RISCV_FTYPE_ATYPESN takes N RISCV_FTYPES-like type codes and lists\n    their associated RISCV_ATYPEs.  */"}, {"sha": "9fe5094ce1a783748e001334a0efe04caedf0612", "filename": "gcc/config/riscv/riscv-cmo.def", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Fconfig%2Friscv%2Friscv-cmo.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Fconfig%2Friscv%2Friscv-cmo.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-cmo.def?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -1,16 +1,16 @@\n // zicbom\n-RISCV_BUILTIN (clean_si, \"zicbom_cbo_clean\", RISCV_BUILTIN_DIRECT, RISCV_SI_FTYPE, clean32),\n-RISCV_BUILTIN (clean_di, \"zicbom_cbo_clean\", RISCV_BUILTIN_DIRECT, RISCV_DI_FTYPE, clean64),\n+RISCV_BUILTIN (clean_si, \"zicbom_cbo_clean\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, clean32),\n+RISCV_BUILTIN (clean_di, \"zicbom_cbo_clean\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, clean64),\n \n-RISCV_BUILTIN (flush_si, \"zicbom_cbo_flush\", RISCV_BUILTIN_DIRECT, RISCV_SI_FTYPE, flush32),\n-RISCV_BUILTIN (flush_di, \"zicbom_cbo_flush\", RISCV_BUILTIN_DIRECT, RISCV_DI_FTYPE, flush64),\n+RISCV_BUILTIN (flush_si, \"zicbom_cbo_flush\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, flush32),\n+RISCV_BUILTIN (flush_di, \"zicbom_cbo_flush\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, flush64),\n \n-RISCV_BUILTIN (inval_si, \"zicbom_cbo_inval\", RISCV_BUILTIN_DIRECT, RISCV_SI_FTYPE, inval32),\n-RISCV_BUILTIN (inval_di, \"zicbom_cbo_inval\", RISCV_BUILTIN_DIRECT, RISCV_DI_FTYPE, inval64),\n+RISCV_BUILTIN (inval_si, \"zicbom_cbo_inval\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, inval32),\n+RISCV_BUILTIN (inval_di, \"zicbom_cbo_inval\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, inval64),\n \n // zicboz\n-RISCV_BUILTIN (zero_si, \"zicboz_cbo_zero\", RISCV_BUILTIN_DIRECT, RISCV_SI_FTYPE, zero32),\n-RISCV_BUILTIN (zero_di, \"zicboz_cbo_zero\", RISCV_BUILTIN_DIRECT, RISCV_DI_FTYPE, zero64),\n+RISCV_BUILTIN (zero_si, \"zicboz_cbo_zero\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, zero32),\n+RISCV_BUILTIN (zero_di, \"zicboz_cbo_zero\", RISCV_BUILTIN_DIRECT_NO_TARGET, RISCV_VOID_FTYPE_VOID_PTR, zero64),\n \n // zicbop\n RISCV_BUILTIN (prefetchi_si, \"zicbop_cbo_prefetchi\", RISCV_BUILTIN_DIRECT, RISCV_SI_FTYPE_SI, prefetchi32),"}, {"sha": "c2b45c63ea172d2e8c1f731da9915bf6d3e5b9d0", "filename": "gcc/config/riscv/riscv-ftypes.def", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Fconfig%2Friscv%2Friscv-ftypes.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Fconfig%2Friscv%2Friscv-ftypes.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-ftypes.def?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -28,7 +28,6 @@ along with GCC; see the file COPYING3.  If not see\n \n DEF_RISCV_FTYPE (0, (USI))\n DEF_RISCV_FTYPE (1, (VOID, USI))\n-DEF_RISCV_FTYPE (0, (SI))\n-DEF_RISCV_FTYPE (0, (DI))\n+DEF_RISCV_FTYPE (1, (VOID, VOID_PTR))\n DEF_RISCV_FTYPE (1, (SI, SI))\n DEF_RISCV_FTYPE (1, (DI, DI))"}, {"sha": "6341f7874d3efe5135453932385d8fb3f304d091", "filename": "gcc/testsuite/gcc.target/riscv/cmo-zicbom-1.c", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicbom-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicbom-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicbom-1.c?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -1,21 +1,29 @@\n /* { dg-do compile } */\n /* { dg-options \"-march=rv64gc_zicbom -mabi=lp64\" } */\n \n-int foo1()\n+int var;\n+\n+void foo1()\n {\n-    return __builtin_riscv_zicbom_cbo_clean();\n+    __builtin_riscv_zicbom_cbo_clean(0);\n+    __builtin_riscv_zicbom_cbo_clean(&var);\n+    __builtin_riscv_zicbom_cbo_clean((void*)0x111);\n }\n \n-int foo2()\n+void foo2()\n {\n-    return __builtin_riscv_zicbom_cbo_flush();\n+    __builtin_riscv_zicbom_cbo_flush(0);\n+    __builtin_riscv_zicbom_cbo_flush(&var);\n+    __builtin_riscv_zicbom_cbo_flush((void*)0x111);\n }\n \n-int foo3()\n+void foo3()\n {\n-    return __builtin_riscv_zicbom_cbo_inval();\n+    __builtin_riscv_zicbom_cbo_inval(0);\n+    __builtin_riscv_zicbom_cbo_inval(&var);\n+    __builtin_riscv_zicbom_cbo_inval((void*)0x111);\n }\n \n-/* { dg-final { scan-assembler-times \"cbo.clean\" 1 } } */\n-/* { dg-final { scan-assembler-times \"cbo.flush\" 1 } } */\n-/* { dg-final { scan-assembler-times \"cbo.inval\" 1 } } */\n+/* { dg-final { scan-assembler-times \"cbo.clean\" 3 } } */\n+/* { dg-final { scan-assembler-times \"cbo.flush\" 3 } } */\n+/* { dg-final { scan-assembler-times \"cbo.inval\" 3 } } */"}, {"sha": "a04f106c8b0ebc52031e7c769dcb072bb12d44f7", "filename": "gcc/testsuite/gcc.target/riscv/cmo-zicbom-2.c", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicbom-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicbom-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicbom-2.c?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -1,21 +1,29 @@\n /* { dg-do compile } */\n /* { dg-options \"-march=rv32gc_zicbom -mabi=ilp32\" } */\n \n-int foo1()\n+int var;\n+\n+void foo1()\n {\n-    return __builtin_riscv_zicbom_cbo_clean();\n+    __builtin_riscv_zicbom_cbo_clean(0);\n+    __builtin_riscv_zicbom_cbo_clean(&var);\n+    __builtin_riscv_zicbom_cbo_clean((void*)0x111);\n }\n \n-int foo2()\n+void foo2()\n {\n-    return __builtin_riscv_zicbom_cbo_flush();\n+    __builtin_riscv_zicbom_cbo_flush(0);\n+    __builtin_riscv_zicbom_cbo_flush(&var);\n+    __builtin_riscv_zicbom_cbo_flush((void*)0x111);\n }\n \n-int foo3()\n+void foo3()\n {\n-    return __builtin_riscv_zicbom_cbo_inval();\n+    __builtin_riscv_zicbom_cbo_inval(0);\n+    __builtin_riscv_zicbom_cbo_inval(&var);\n+    __builtin_riscv_zicbom_cbo_inval((void*)0x111);\n }\n \n-/* { dg-final { scan-assembler-times \"cbo.clean\" 1 } } */\n-/* { dg-final { scan-assembler-times \"cbo.flush\" 1 } } */\n-/* { dg-final { scan-assembler-times \"cbo.inval\" 1 } } */\n+/* { dg-final { scan-assembler-times \"cbo.clean\" 3 } } */\n+/* { dg-final { scan-assembler-times \"cbo.flush\" 3 } } */\n+/* { dg-final { scan-assembler-times \"cbo.inval\" 3 } } */"}, {"sha": "5eb78ab94b5a5b21e8993c903786485b4be0c588", "filename": "gcc/testsuite/gcc.target/riscv/cmo-zicboz-1.c", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicboz-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicboz-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicboz-1.c?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -1,9 +1,13 @@\n /* { dg-do compile } */\n /* { dg-options \"-march=rv64gc_zicboz -mabi=lp64\" } */\n \n-int foo1()\n+int var;\n+\n+void foo1()\n {\n-    return __builtin_riscv_zicboz_cbo_zero();\n+    __builtin_riscv_zicboz_cbo_zero(0);\n+    __builtin_riscv_zicboz_cbo_zero(&var);\n+    __builtin_riscv_zicboz_cbo_zero((void*)0x121);\n }\n \n-/* { dg-final { scan-assembler-times \"cbo.zero\" 1 } } */ \n+/* { dg-final { scan-assembler-times \"cbo.zero\" 3 } } */ "}, {"sha": "fdc9c719669c7935eeb9b8584e99a13813c77381", "filename": "gcc/testsuite/gcc.target/riscv/cmo-zicboz-2.c", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicboz-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/970b03c0037549a571ecea9afa41de78eb859b3a/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicboz-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fcmo-zicboz-2.c?ref=970b03c0037549a571ecea9afa41de78eb859b3a", "patch": "@@ -1,9 +1,13 @@\n /* { dg-do compile } */\n /* { dg-options \"-march=rv32gc_zicboz -mabi=ilp32\" } */\n \n-int foo1()\n+int var;\n+\n+void foo1()\n {\n-    return __builtin_riscv_zicboz_cbo_zero();\n+    __builtin_riscv_zicboz_cbo_zero(0);\n+    __builtin_riscv_zicboz_cbo_zero(&var);\n+    __builtin_riscv_zicboz_cbo_zero((void*)0x121);\n }\n \n-/* { dg-final { scan-assembler-times \"cbo.zero\" 1 } } */\n+/* { dg-final { scan-assembler-times \"cbo.zero\" 3 } } */ "}]}