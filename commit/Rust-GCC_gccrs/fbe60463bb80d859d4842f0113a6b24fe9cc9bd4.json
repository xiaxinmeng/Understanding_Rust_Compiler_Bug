{"sha": "fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmJlNjA0NjNiYjgwZDg1OWQ0ODQyZjAxMTNhNmIyNGZlOWNjOWJkNA==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-03-22T12:11:10Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-03-22T12:18:39Z"}, "message": "d: Generate phony targets for content imported files (PR93038)\n\nThis is in addition to the last change which started including them in\nthe make dependency list.\n\ngcc/d/ChangeLog:\n\n2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n\n\tPR d/93038\n\t* d-lang.cc (deps_write): Generate phony targets for content imported\n\tfiles.\n\ngcc/testsuite/ChangeLog:\n\n2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n\n\tPR d/93038\n\t* gdc.dg/pr93038b.d: New test.", "tree": {"sha": "b5257a8cd6af159e841408164b8451ee113d7c3f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b5257a8cd6af159e841408164b8451ee113d7c3f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85e10e4f0fa5c6b1a9f3caf7d9cab28ef8490a83", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/85e10e4f0fa5c6b1a9f3caf7d9cab28ef8490a83", "html_url": "https://github.com/Rust-GCC/gccrs/commit/85e10e4f0fa5c6b1a9f3caf7d9cab28ef8490a83"}], "stats": {"total": 58, "additions": 37, "deletions": 21}, "files": [{"sha": "606f7f30eb04fab8b720854080eb4268c6503220", "filename": "gcc/d/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Fd%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Fd%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2FChangeLog?ref=fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "patch": "@@ -1,3 +1,9 @@\n+2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n+\n+\tPR d/93038\n+\t* d-lang.cc (deps_write): Generate phony targets for content imported\n+\tfiles.\n+\n 2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n \n \tPR d/93038"}, {"sha": "6848c5e9a1cc7a279d2ecdd129d703fa3deae8a5", "filename": "gcc/d/d-lang.cc", "status": "modified", "additions": 18, "deletions": 21, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Fd%2Fd-lang.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Fd%2Fd-lang.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-lang.cc?ref=fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "patch": "@@ -157,26 +157,21 @@ deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n   Modules modlist;\n   modlist.push (module);\n \n-  Modules phonylist;\n-\n-  const char *str;\n-  unsigned size;\n+  vec <const char *> phonylist = vNULL;\n   unsigned column = 0;\n \n   /* Write out make target module name.  */\n   if (d_option.deps_target)\n     {\n-      size = d_option.deps_target->offset;\n-      str = d_option.deps_target->extractString ();\n+      buffer->writestring (d_option.deps_target->extractString ());\n+      column = d_option.deps_target->offset;\n     }\n   else\n     {\n-      str = module->objfile->name->str;\n-      size = strlen (str);\n+      buffer->writestring (module->objfile->name->str);\n+      column = buffer->offset;\n     }\n \n-  buffer->writestring (str);\n-  column = size;\n   buffer->writestring (\":\");\n   column++;\n \n@@ -185,21 +180,25 @@ deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n     {\n       Module *depmod = modlist.pop ();\n \n-      str = depmod->srcfile->name->str;\n+      const char *modstr = depmod->srcfile->name->str;\n \n       /* Skip modules that have already been looked at.  */\n-      if (seen_modules.add (str))\n+      if (seen_modules.add (modstr))\n \tcontinue;\n \n-      dependencies.safe_push (str);\n+      dependencies.safe_push (modstr);\n \n       /* Add to list of phony targets if is not being compile.  */\n       if (d_option.deps_phony && !depmod->isRoot ())\n-\tphonylist.push (depmod);\n+\tphonylist.safe_push (modstr);\n \n       /* Add imported files to dependency list.  */\n       for (size_t i = 0; i < depmod->contentImportedFiles.dim; i++)\n-\tdependencies.safe_push (depmod->contentImportedFiles[i]);\n+\t{\n+\t  const char *impstr = depmod->contentImportedFiles[i];\n+\t  dependencies.safe_push (impstr);\n+\t  phonylist.safe_push (impstr);\n+\t}\n \n       /* Search all imports of the module.  */\n       for (size_t i = 0; i < depmod->aimports.dim; i++)\n@@ -238,8 +237,8 @@ deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n   /* Write out all make dependencies.  */\n   for (size_t i = 0; i < dependencies.length (); i++)\n     {\n-      str = dependencies[i];\n-      size = strlen (str);\n+      const char *str = dependencies[i];\n+      unsigned size = strlen (str);\n       column += size;\n \n       if (colmax && column > colmax)\n@@ -259,12 +258,10 @@ deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n   buffer->writenl ();\n \n   /* Write out all phony targets.  */\n-  for (size_t i = 0; i < phonylist.dim; i++)\n+  for (size_t i = 0; i < phonylist.length (); i++)\n     {\n-      Module *m = phonylist[i];\n-\n       buffer->writenl ();\n-      buffer->writestring (m->srcfile->name->str);\n+      buffer->writestring (phonylist[i]);\n       buffer->writestring (\":\\n\");\n     }\n }"}, {"sha": "892fcb654af7d966f8fbf1704953f35549d402a2", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "patch": "@@ -1,3 +1,8 @@\n+2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n+\n+\tPR d/93038\n+\t* gdc.dg/pr93038b.d: New test.\n+\n 2020-03-22  Iain Sandoe  <iain@sandoe.co.uk>\n \n \t* g++.dg/abi/lambda-vis.C: Amend assembler match"}, {"sha": "04177a7e01ab89140bbb5eb010ae84b3d3f0e66c", "filename": "gcc/testsuite/gdc.dg/pr93038b.d", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Ftestsuite%2Fgdc.dg%2Fpr93038b.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe60463bb80d859d4842f0113a6b24fe9cc9bd4/gcc%2Ftestsuite%2Fgdc.dg%2Fpr93038b.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fpr93038b.d?ref=fbe60463bb80d859d4842f0113a6b24fe9cc9bd4", "patch": "@@ -0,0 +1,8 @@\n+// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=93038\n+// { dg-options \"-J $srcdir/gdc.dg/fileimports -MMD -MP\" }\n+// { dg-do compile }\n+// { dg-final { scan-file pr93038b.deps \"pr93038b.o: \\[^\\n\\]*/pr93038b.d \\[ \\\\\\\\\\n\\]*\\[^\\n\\]*/fileimports/pr93038.txt\\n\\n\\[^\\n\\]*/fileimports/pr93038.txt:\" } }\n+// { dg-final { file delete pr93038b.deps } }\n+module pr93038b;\n+\n+const VERSION = import(\"pr93038.txt\");"}]}