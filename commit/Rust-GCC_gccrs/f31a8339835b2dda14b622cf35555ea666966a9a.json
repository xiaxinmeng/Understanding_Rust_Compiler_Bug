{"sha": "f31a8339835b2dda14b622cf35555ea666966a9a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjMxYTgzMzk4MzViMmRkYTE0YjYyMmNmMzU1NTVlYTY2Njk2NmE5YQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-06-13T20:05:20Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-06-13T20:05:20Z"}, "message": "re PR sanitizer/80973 (ICE with lambda and -fsanitize=undefined)\n\n\tPR c++/80973\n\t* cp-gimplify.c (cp_genericize_r): Don't instrument MEM_REF second\n\targument even if it has REFERENCE_TYPE.\n\n\t* g++.dg/ubsan/pr80973.C: New test.\n\nFrom-SVN: r249174", "tree": {"sha": "b9c27822cedec984109a2bf21ac94eb5c0961a8d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b9c27822cedec984109a2bf21ac94eb5c0961a8d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f31a8339835b2dda14b622cf35555ea666966a9a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f31a8339835b2dda14b622cf35555ea666966a9a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f31a8339835b2dda14b622cf35555ea666966a9a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f31a8339835b2dda14b622cf35555ea666966a9a/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c60dc05326dbf6960dbaa898db854fd062afeecd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c60dc05326dbf6960dbaa898db854fd062afeecd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c60dc05326dbf6960dbaa898db854fd062afeecd"}], "stats": {"total": 33, "additions": 33, "deletions": 0}, "files": [{"sha": "ca0f9b200149f97c7d474d6a6e43a10e4f0944b1", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=f31a8339835b2dda14b622cf35555ea666966a9a", "patch": "@@ -1,5 +1,9 @@\n 2017-06-13  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/80973\n+\t* cp-gimplify.c (cp_genericize_r): Don't instrument MEM_REF second\n+\targument even if it has REFERENCE_TYPE.\n+\n \tPR c++/80984\n \t* cp-gimplify.c (cp_genericize): Only look for VAR_DECLs in\n \tBLOCK_VARS (outer) chain."}, {"sha": "a0abd51440da45c3ffbf83438fc65a2356ac157a", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=f31a8339835b2dda14b622cf35555ea666966a9a", "patch": "@@ -1450,6 +1450,16 @@ cp_genericize_r (tree *stmt_p, int *walk_subtrees, void *data)\n       *stmt_p = cplus_expand_constant (stmt);\n       *walk_subtrees = 0;\n     }\n+  else if (TREE_CODE (stmt) == MEM_REF)\n+    {\n+      /* For MEM_REF, make sure not to sanitize the second operand even\n+         if it has reference type.  It is just an offset with a type\n+\t holding other information.  There is no other processing we\n+\t need to do for INTEGER_CSTs, so just ignore the second argument\n+\t unconditionally.  */\n+      cp_walk_tree (&TREE_OPERAND (stmt, 0), cp_genericize_r, data, NULL);\n+      *walk_subtrees = 0;\n+    }\n   else if (sanitize_flags_p ((SANITIZE_NULL\n \t\t\t      | SANITIZE_ALIGNMENT | SANITIZE_VPTR))\n \t   && !wtd->no_sanitize_p)"}, {"sha": "f32b8c8258680c61325196a981924a2613ebb808", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=f31a8339835b2dda14b622cf35555ea666966a9a", "patch": "@@ -1,5 +1,8 @@\n 2017-06-13  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/80973\n+\t* g++.dg/ubsan/pr80973.C: New test.\n+\n \tPR c++/80984\n \t* g++.dg/opt/nrv18.C: New test.\n "}, {"sha": "b534fdbab6f6389ef7f92df4dc5a65602518d838", "filename": "gcc/testsuite/g++.dg/ubsan/pr80973.C", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr80973.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f31a8339835b2dda14b622cf35555ea666966a9a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr80973.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr80973.C?ref=f31a8339835b2dda14b622cf35555ea666966a9a", "patch": "@@ -0,0 +1,16 @@\n+// PR c++/80973\n+// { dg-do compile }\n+// { dg-options \"-fsanitize=undefined -std=c++14\" }\n+\n+struct A {\n+  A();\n+  A(const A &);\n+};\n+struct B {\n+  B();\n+  template <typename... Args> auto g(Args &&... p1) {\n+    return [=] { f(p1...); };\n+  }\n+  void f(A, const char *);\n+};\n+B::B() { g(A(), \"\"); }"}]}