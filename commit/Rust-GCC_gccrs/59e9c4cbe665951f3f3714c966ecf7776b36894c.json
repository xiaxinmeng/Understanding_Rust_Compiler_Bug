{"sha": "59e9c4cbe665951f3f3714c966ecf7776b36894c", "node_id": "C_kwDOANBUbNoAKDU5ZTljNGNiZTY2NTk1MWYzZjM3MTRjOTY2ZWNmNzc3NmIzNjg5NGM", "commit": {"author": {"name": "liuhongt", "email": "hongtao.liu@intel.com", "date": "2020-07-10T07:22:30Z"}, "committer": {"name": "liuhongt", "email": "hongtao.liu@intel.com", "date": "2021-09-22T04:56:31Z"}, "message": "AVX512FP16: Add expander for sqrthf2.\n\ngcc/ChangeLog:\n\n\t* config/i386/i386-features.c (i386-features.c): Handle\n\tE_HFmode.\n\t* config/i386/i386.md (sqrthf2): New expander.\n\t(*sqrthf2): New define_insn.\n\t* config/i386/sse.md\n\t(*<sse>_vmsqrt<mode>2<mask_scalar_name><round_scalar_name>):\n\tExtend to VFH_128.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.target/i386/avx512fp16-builtin-sqrt-1.c: New test.\n\t* gcc.target/i386/avx512fp16vl-builtin-sqrt-1.c: New test.", "tree": {"sha": "1869eab977bc038657754b334d622b4567a92b97", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1869eab977bc038657754b334d622b4567a92b97"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/59e9c4cbe665951f3f3714c966ecf7776b36894c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59e9c4cbe665951f3f3714c966ecf7776b36894c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/59e9c4cbe665951f3f3714c966ecf7776b36894c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59e9c4cbe665951f3f3714c966ecf7776b36894c/comments", "author": {"login": "algebra84", "id": 22926165, "node_id": "MDQ6VXNlcjIyOTI2MTY1", "avatar_url": "https://avatars.githubusercontent.com/u/22926165?v=4", "gravatar_id": "", "url": "https://api.github.com/users/algebra84", "html_url": "https://github.com/algebra84", "followers_url": "https://api.github.com/users/algebra84/followers", "following_url": "https://api.github.com/users/algebra84/following{/other_user}", "gists_url": "https://api.github.com/users/algebra84/gists{/gist_id}", "starred_url": "https://api.github.com/users/algebra84/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/algebra84/subscriptions", "organizations_url": "https://api.github.com/users/algebra84/orgs", "repos_url": "https://api.github.com/users/algebra84/repos", "events_url": "https://api.github.com/users/algebra84/events{/privacy}", "received_events_url": "https://api.github.com/users/algebra84/received_events", "type": "User", "site_admin": false}, "committer": {"login": "algebra84", "id": 22926165, "node_id": "MDQ6VXNlcjIyOTI2MTY1", "avatar_url": "https://avatars.githubusercontent.com/u/22926165?v=4", "gravatar_id": "", "url": "https://api.github.com/users/algebra84", "html_url": "https://github.com/algebra84", "followers_url": "https://api.github.com/users/algebra84/followers", "following_url": "https://api.github.com/users/algebra84/following{/other_user}", "gists_url": "https://api.github.com/users/algebra84/gists{/gist_id}", "starred_url": "https://api.github.com/users/algebra84/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/algebra84/subscriptions", "organizations_url": "https://api.github.com/users/algebra84/orgs", "repos_url": "https://api.github.com/users/algebra84/repos", "events_url": "https://api.github.com/users/algebra84/events{/privacy}", "received_events_url": "https://api.github.com/users/algebra84/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a5837cfb714d6a677332ee946b02f7f3558fca4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8a5837cfb714d6a677332ee946b02f7f3558fca4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8a5837cfb714d6a677332ee946b02f7f3558fca4"}], "stats": {"total": 73, "additions": 65, "deletions": 8}, "files": [{"sha": "43bb676eb80c1f13915b2d47f0649eb4bf2bef24", "filename": "gcc/config/i386/i386-features.c", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Fconfig%2Fi386%2Fi386-features.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Fconfig%2Fi386%2Fi386-features.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386-features.c?ref=59e9c4cbe665951f3f3714c966ecf7776b36894c", "patch": "@@ -2258,15 +2258,22 @@ remove_partial_avx_dependency (void)\n \n \t  rtx zero;\n \t  machine_mode dest_vecmode;\n-\t  if (dest_mode == E_SFmode)\n+\t  switch (dest_mode)\n \t    {\n+\t    case E_HFmode:\n+\t      dest_vecmode = V8HFmode;\n+\t      zero = gen_rtx_SUBREG (V8HFmode, v4sf_const0, 0);\n+\t      break;\n+\t    case E_SFmode:\n \t      dest_vecmode = V4SFmode;\n \t      zero = v4sf_const0;\n-\t    }\n-\t  else\n-\t    {\n+\t      break;\n+\t    case E_DFmode:\n \t      dest_vecmode = V2DFmode;\n \t      zero = gen_rtx_SUBREG (V2DFmode, v4sf_const0, 0);\n+\t      break;\n+\t    default:\n+\t      gcc_unreachable ();\n \t    }\n \n \t  /* Change source to vector mode.  */"}, {"sha": "ae1a81cc9e901871e686deab113c103831dd0f30", "filename": "gcc/config/i386/i386.md", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Fconfig%2Fi386%2Fi386.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Fconfig%2Fi386%2Fi386.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.md?ref=59e9c4cbe665951f3f3714c966ecf7776b36894c", "patch": "@@ -17041,6 +17041,19 @@\n   DONE;\n })\n \n+(define_insn \"sqrthf2\"\n+  [(set (match_operand:HF 0 \"register_operand\" \"=v,v\")\n+\t(sqrt:HF\n+\t  (match_operand:HF 1 \"nonimmediate_operand\" \"v,m\")))]\n+  \"TARGET_AVX512FP16\"\n+  \"@\n+   vsqrtsh\\t{%d1, %0|%0, %d1}\n+   vsqrtsh\\t{%1, %d0|%d0, %1}\"\n+  [(set_attr \"type\" \"sse\")\n+   (set_attr \"prefix\" \"evex\")\n+   (set_attr \"avx_partial_xmm_update\" \"false,true\")\n+   (set_attr \"mode\" \"HF\")])\n+\n (define_insn \"*sqrt<mode>2_sse\"\n   [(set (match_operand:MODEF 0 \"register_operand\" \"=v,v,v\")\n \t(sqrt:MODEF"}, {"sha": "e8aef0d9d288723d6fdd9f59f3516cd35cec69d8", "filename": "gcc/config/i386/sse.md", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Fconfig%2Fi386%2Fsse.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Fconfig%2Fi386%2Fsse.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fsse.md?ref=59e9c4cbe665951f3f3714c966ecf7776b36894c", "patch": "@@ -2522,12 +2522,12 @@\n    (set_attr \"mode\" \"<ssescalarmode>\")])\n \n (define_insn \"*<sse>_vmsqrt<mode>2<mask_scalar_name><round_scalar_name>\"\n-  [(set (match_operand:VF_128 0 \"register_operand\" \"=x,v\")\n-\t(vec_merge:VF_128\n-\t  (vec_duplicate:VF_128\n+  [(set (match_operand:VFH_128 0 \"register_operand\" \"=x,v\")\n+\t(vec_merge:VFH_128\n+\t  (vec_duplicate:VFH_128\n \t    (sqrt:<ssescalarmode>\n \t      (match_operand:<ssescalarmode> 1 \"nonimmediate_operand\" \"xm,<round_scalar_constraint>\")))\n-\t  (match_operand:VF_128 2 \"register_operand\" \"0,v\")\n+\t  (match_operand:VFH_128 2 \"register_operand\" \"0,v\")\n \t  (const_int 1)))]\n   \"TARGET_SSE\"\n   \"@"}, {"sha": "b4efc844c6d37d6822006e31eb4c3de7d1fd7335", "filename": "gcc/testsuite/gcc.target/i386/avx512fp16-builtin-sqrt-1.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Favx512fp16-builtin-sqrt-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Favx512fp16-builtin-sqrt-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Favx512fp16-builtin-sqrt-1.c?ref=59e9c4cbe665951f3f3714c966ecf7776b36894c", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-Ofast -mavx512fp16 -mprefer-vector-width=512\" } */\n+\n+_Float16\n+f1 (_Float16 x)\n+{\n+  return __builtin_sqrtf16 (x);\n+}\n+\n+void\n+f2 (_Float16* __restrict psrc, _Float16* __restrict pdst)\n+{\n+  for (int i = 0; i != 32; i++)\n+    pdst[i] = __builtin_sqrtf16 (psrc[i]);\n+}\n+\n+/* { dg-final { scan-assembler-times \"vsqrtsh\\[^\\n\\r\\]*xmm\\[0-9\\]\" 1 } } */\n+/* { dg-final { scan-assembler-times \"vsqrtph\\[^\\n\\r\\]*zmm\\[0-9\\]\" 1 } } */"}, {"sha": "08deb3ea4700ef060eccea728b95454e3b47fe5d", "filename": "gcc/testsuite/gcc.target/i386/avx512fp16vl-builtin-sqrt-1.c", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Favx512fp16vl-builtin-sqrt-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59e9c4cbe665951f3f3714c966ecf7776b36894c/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Favx512fp16vl-builtin-sqrt-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Favx512fp16vl-builtin-sqrt-1.c?ref=59e9c4cbe665951f3f3714c966ecf7776b36894c", "patch": "@@ -0,0 +1,19 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-Ofast -mavx512fp16 -mavx512vl\" } */\n+\n+void\n+f1 (_Float16* __restrict psrc, _Float16* __restrict pdst)\n+{\n+  for (int i = 0; i != 8; i++)\n+    pdst[i] = __builtin_sqrtf16 (psrc[i]);\n+}\n+\n+void\n+f2 (_Float16* __restrict psrc, _Float16* __restrict pdst)\n+{\n+  for (int i = 0; i != 16; i++)\n+    pdst[i] = __builtin_sqrtf16 (psrc[i]);\n+}\n+\n+/* { dg-final { scan-assembler-times \"vsqrtph\\[^\\n\\r\\]*xmm\\[0-9\\]\" 1 } } */\n+/* { dg-final { scan-assembler-times \"vsqrtph\\[^\\n\\r\\]*ymm\\[0-9\\]\" 1 } } */"}]}