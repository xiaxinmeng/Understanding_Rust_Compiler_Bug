{"sha": "6be8b52474f98eab9b3c490169627b9d1ece43df", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmJlOGI1MjQ3NGY5OGVhYjliM2M0OTAxNjk2MjdiOWQxZWNlNDNkZg==", "commit": {"author": {"name": "Paolo Carlini", "email": "pcarlini@suse.de", "date": "2005-05-28T21:57:03Z"}, "committer": {"name": "Paolo Carlini", "email": "paolo@gcc.gnu.org", "date": "2005-05-28T21:57:03Z"}, "message": "revert: re PR libstdc++/19495 (basic_string::_M_rep() can produce an unnaturally aligned pointer to _Rep)\n\n2005-05-28  Paolo Carlini  <pcarlini@suse.de>\n\n\tRevert:\n\t2005-05-18  Paolo Carlini  <pcarlini@suse.de>\n\t\t    Nathan Myers  <ncm@cantrip.org>\n\n\tPR libstdc++/19495\n\t* include/bits/basic_string.h (_Raw_bytes_alloc): Rebind to\n\tsize_type instead of char and rename to _Raw_alloc.\n\t* include/bits/basic_string.tcc (_Rep::_M_destroy, _Rep::_S_create):\n\tUse the above.\n\t* src/bitmap_allocator.cc: Add instantiation for size_type.\n\t* src/mt_allocator.cc: Likewise.\n\t* src/pool_allocator.cc: Likewise.\n\t* include/ext/array_allocator.h: Tweak slightly, avoid assuming\n\tthe existence of an _Array::begin() and size() members.\n\t* testsuite/ext/array_allocator/2.cc: Tweak to use an allocator\n\tof size_type, instead of char, thus avoiding problems with\n\trebinds, not treated correctly by array_allocator.\n\nFrom-SVN: r100304", "tree": {"sha": "81a0d6886d0cf976642a98f38627e30489df1086", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/81a0d6886d0cf976642a98f38627e30489df1086"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6be8b52474f98eab9b3c490169627b9d1ece43df", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6be8b52474f98eab9b3c490169627b9d1ece43df", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6be8b52474f98eab9b3c490169627b9d1ece43df", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6be8b52474f98eab9b3c490169627b9d1ece43df/comments", "author": null, "committer": null, "parents": [{"sha": "76b8a7a14335e0b10318353efff63b90898ff8ce", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/76b8a7a14335e0b10318353efff63b90898ff8ce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/76b8a7a14335e0b10318353efff63b90898ff8ce"}], "stats": {"total": 69, "additions": 39, "deletions": 30}, "files": [{"sha": "a572b0bfaa5d6015010896bd99b9b5668c3530f9", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -1,3 +1,23 @@\n+2005-05-28  Paolo Carlini  <pcarlini@suse.de>\n+\n+\tRevert:\n+\t2005-05-18  Paolo Carlini  <pcarlini@suse.de>\n+\t\t    Nathan Myers  <ncm@cantrip.org>\n+\n+\tPR libstdc++/19495\n+\t* include/bits/basic_string.h (_Raw_bytes_alloc): Rebind to\n+\tsize_type instead of char and rename to _Raw_alloc.\n+\t* include/bits/basic_string.tcc (_Rep::_M_destroy, _Rep::_S_create):\n+\tUse the above.\n+\t* src/bitmap_allocator.cc: Add instantiation for size_type.\n+\t* src/mt_allocator.cc: Likewise.\n+\t* src/pool_allocator.cc: Likewise.\n+\t* include/ext/array_allocator.h: Tweak slightly, avoid assuming\n+\tthe existence of an _Array::begin() and size() members.\n+\t* testsuite/ext/array_allocator/2.cc: Tweak to use an allocator\n+\tof size_type, instead of char, thus avoiding problems with\n+\trebinds, not treated correctly by array_allocator.\n+\n 2005-05-27  Paolo Carlini  <pcarlini@suse.de>\n \n \t* docs/html/abi.html: Mention 3.4.0 as the current baseline; add"}, {"sha": "c889ce64b371d8a3558b53e1baf76e089fb86a03", "filename": "libstdc++-v3/include/bits/basic_string.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fbasic_string.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fbasic_string.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fbasic_string.h?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -151,7 +151,7 @@ namespace std\n       struct _Rep : _Rep_base\n       {\n \t// Types:\n-\ttypedef typename _Alloc::template rebind<size_type>::other _Raw_alloc;\n+\ttypedef typename _Alloc::template rebind<char>::other _Raw_bytes_alloc;\n \n \t// (Public) Data members:\n "}, {"sha": "41db0dff438402135a6796d2aa03b09bdbe2353f", "filename": "libstdc++-v3/include/bits/basic_string.tcc", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fbasic_string.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fbasic_string.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fbasic_string.tcc?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -425,10 +425,9 @@ namespace std\n     basic_string<_CharT, _Traits, _Alloc>::_Rep::\n     _M_destroy(const _Alloc& __a) throw ()\n     {\n-      const size_type __size = ((this->_M_capacity + 1) * sizeof(_CharT)\n-\t\t\t\t+ sizeof(_Rep_base) + sizeof(size_type) - 1);\n-      _Raw_alloc(__a).deallocate(reinterpret_cast<size_type*>(this), __size\n-\t\t\t\t / sizeof(size_type));\n+      const size_type __size = sizeof(_Rep_base) +\n+\t                       (this->_M_capacity + 1) * sizeof(_CharT);\n+      _Raw_bytes_alloc(__a).deallocate(reinterpret_cast<char*>(this), __size);\n     }\n \n   template<typename _CharT, typename _Traits, typename _Alloc>\n@@ -569,12 +568,9 @@ namespace std\n \t__capacity = 2 * __old_capacity;\n \n       // NB: Need an array of char_type[__capacity], plus a terminating\n-      // null char_type() element, plus enough for the _Rep data structure,\n-      // plus sizeof(size_type) - 1 to upper round to a size multiple\n-      // of sizeof(size_type).\n+      // null char_type() element, plus enough for the _Rep data structure.\n       // Whew. Seemingly so needy, yet so elemental.\n-      size_type __size = ((__capacity + 1) * sizeof(_CharT) + sizeof(_Rep)\n-\t\t\t  + sizeof(size_type) - 1);\n+      size_type __size = (__capacity + 1) * sizeof(_CharT) + sizeof(_Rep);\n \n       const size_type __adj_size = __size + __malloc_header_size;\n       if (__adj_size > __pagesize && __capacity > __old_capacity)\n@@ -584,14 +580,12 @@ namespace std\n \t  // Never allocate a string bigger than _S_max_size.\n \t  if (__capacity > _S_max_size)\n \t    __capacity = _S_max_size;\n-\t  __size = ((__capacity + 1) * sizeof(_CharT) + sizeof(_Rep)\n-\t\t    + sizeof(size_type) - 1);\n+\t  __size = (__capacity + 1) * sizeof(_CharT) + sizeof(_Rep);\n \t}\n \n       // NB: Might throw, but no worries about a leak, mate: _Rep()\n       // does not throw.\n-      void* __place = _Raw_alloc(__alloc).allocate(__size\n-\t\t\t\t\t\t   / sizeof(size_type));\n+      void* __place = _Raw_bytes_alloc(__alloc).allocate(__size);\n       _Rep *__p = new (__place) _Rep;\n       __p->_M_capacity = __capacity;\n       return __p;"}, {"sha": "8689d9da26a6cafc5b840ac0888a2a15b2e4f530", "filename": "libstdc++-v3/include/ext/array_allocator.h", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Finclude%2Fext%2Farray_allocator.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Finclude%2Fext%2Farray_allocator.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fext%2Farray_allocator.h?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -121,10 +121,9 @@ namespace __gnu_cxx\n       allocate(size_type __n, const void* = 0)\n       {\n \tstatic size_type __array_used;\n-\tif (_M_array == 0\n-\t    || __array_used + __n > sizeof(*_M_array) / sizeof(_Tp))\n+\tif (_M_array == 0 || __array_used + __n > _M_array->size())\n \t  std::__throw_bad_alloc();\n-\tpointer __ret = reinterpret_cast<_Tp*>(_M_array) + __array_used;\n+\tpointer __ret = _M_array->begin() + __array_used;\n \t__array_used += __n;\n \treturn __ret;\n       }"}, {"sha": "c8d94af21579177ae33749845765be6e251d43b5", "filename": "libstdc++-v3/src/bitmap_allocator.cc", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Fsrc%2Fbitmap_allocator.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Fsrc%2Fbitmap_allocator.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Fbitmap_allocator.cc?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -41,10 +41,6 @@ namespace __gnu_cxx\n     <bitmap_allocator<wchar_t>::_Alloc_block*, \n      bitmap_allocator<wchar_t>::_Alloc_block*> >;\n \n-    template class __mini_vector<std::pair\n-    <bitmap_allocator<size_t>::_Alloc_block*, \n-     bitmap_allocator<size_t>::_Alloc_block*> >;\n-\n     template class __mini_vector<size_t*>;\n \n     template size_t** __lower_bound"}, {"sha": "bb6ab899cafe5d910b97803bb414007025f9ac77", "filename": "libstdc++-v3/src/mt_allocator.cc", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Fsrc%2Fmt_allocator.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Fsrc%2Fmt_allocator.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Fmt_allocator.cc?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -1,8 +1,8 @@\n // Allocator details.\n \n-// Copyright (C) 2004, 2005 Free Software Foundation, Inc.\n+// Copyright (C) 2004 Free Software Foundation, Inc.\n //\n-// This file is part of the GNU ISO C++ Library.  This library is free\n+// This file is part of the GNU ISO C++ Librarbooly.  This library is free\n // software; you can redistribute it and/or modify it under the\n // terms of the GNU General Public License as published by the\n // Free Software Foundation; either version 2, or (at your option)\n@@ -552,5 +552,4 @@ namespace __gnu_cxx\n   // Instantiations.\n   template class __mt_alloc<char>;\n   template class __mt_alloc<wchar_t>;\n-  template class __mt_alloc<size_t>;  \n } // namespace __gnu_cxx"}, {"sha": "731cfffa0ea40110a3d42a306d3e0932bd6f6a2a", "filename": "libstdc++-v3/src/pool_allocator.cc", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Fsrc%2Fpool_allocator.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Fsrc%2Fpool_allocator.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Fpool_allocator.cc?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -170,5 +170,4 @@ namespace __gnu_cxx\n   // Instantiations.\n   template class __pool_alloc<char>;\n   template class __pool_alloc<wchar_t>;\n-  template class __pool_alloc<size_t>;  \n } // namespace __gnu_cxx"}, {"sha": "f580ea250b7bd09da94a7c8f84e32d4558011098", "filename": "libstdc++-v3/testsuite/ext/array_allocator/2.cc", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Farray_allocator%2F2.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be8b52474f98eab9b3c490169627b9d1ece43df/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Farray_allocator%2F2.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Farray_allocator%2F2.cc?ref=6be8b52474f98eab9b3c490169627b9d1ece43df", "patch": "@@ -1,4 +1,7 @@\n-// Copyright (C) 2004, 2005 Free Software Foundation, Inc.\n+// Expected execution error for PR19495.\n+// { dg-do run { xfail powerpc*-*-linux* } }\n+\n+// Copyright (C) 2004 Free Software Foundation, Inc.\n //\n // This file is part of the GNU ISO C++ Library.  This library is free\n // software; you can redistribute it and/or modify it under the\n@@ -32,10 +35,7 @@\n \n typedef char char_type;\n typedef std::char_traits<char_type> traits_type;\n-// NB: Array_allocator doesn't properly support rebinding, used by\n-// basic_string. See libstdc++/21609 for details.\n-typedef std::tr1::array<size_t, 16> array_type;\n-typedef __gnu_cxx::array_allocator<size_t, array_type> allocator_type;\n+typedef std::tr1::array<char_type, 32> array_type;\n \n array_type extern_array;\n \n@@ -44,8 +44,10 @@ void test01()\n   bool test __attribute__((unused)) = true;\n \n   using std::basic_string;\n+  typedef __gnu_cxx::array_allocator<char_type, array_type> allocator_type;\n   typedef basic_string<char_type, traits_type, allocator_type> string_type;\n \n+  size_t index = array_type::_S_index;\n   allocator_type a(&extern_array);\n   string_type s(a);\n     "}]}