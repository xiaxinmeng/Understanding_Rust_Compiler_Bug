{"sha": "b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjM4NWM4NDEyZThkNGM2ZTI1NzEzNGU1YmI3NTU5ZWUwNmNkMGMyMA==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@yorick.cygnus.com", "date": "1998-05-21T05:42:51Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "1998-05-21T05:42:51Z"}, "message": "decl2.c (maybe_make_one_only): New fn.\n\n\t* decl2.c (maybe_make_one_only): New fn.\n\t(import_export_vtable): Use it.\n\t(import_export_decl): Likewise.\n\t* pt.c (mark_decl_instantiated): Likewise.\n\nFrom-SVN: r19921", "tree": {"sha": "783a6297084b0ebb1575531cfadf2772c291d78a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/783a6297084b0ebb1575531cfadf2772c291d78a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/comments", "author": null, "committer": null, "parents": [{"sha": "cb96daa2dcb181abb218017a4de32838285094fa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb96daa2dcb181abb218017a4de32838285094fa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cb96daa2dcb181abb218017a4de32838285094fa"}], "stats": {"total": 45, "additions": 37, "deletions": 8}, "files": [{"sha": "b0607c0b592d500140d8b95e26ab2154d1df0b40", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "patch": "@@ -1,3 +1,10 @@\n+1998-05-21  Jason Merrill  <jason@yorick.cygnus.com>\n+\n+\t* decl2.c (maybe_make_one_only): New fn.\n+\t(import_export_vtable): Use it.\n+\t(import_export_decl): Likewise.\n+\t* pt.c (mark_decl_instantiated): Likewise.\n+\n 1998-05-21  Mark Mitchell  <mmitchell@usa.net>\n \n \t* decl2.c (find_representative_member): Rename to ..."}, {"sha": "31903411922885749948ed1f74d027886e7e604e", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 28, "deletions": 6, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "patch": "@@ -2451,6 +2451,30 @@ comdat_linkage (decl)\n     DECL_COMDAT (decl) = 1;\n }\n \n+/* For win32 we also want to put explicit instantiations in\n+   linkonce sections, so that they will be merged with implicit\n+   instantiations; otherwise we get duplicate symbol errors.  */\n+\n+void\n+maybe_make_one_only (decl)\n+     tree decl;\n+{\n+  /* This is not necessary on targets that support weak symbols, because\n+     the implicit instantiations will defer to the explicit one.  */     \n+  if (! supports_one_only () || SUPPORTS_WEAK)\n+    return;\n+\n+  /* We can't set DECL_COMDAT on functions, or finish_file will think\n+     we can get away with not emitting them if they aren't used.\n+     We can't use make_decl_one_only for variables, because their\n+     DECL_INITIAL may not have been set properly yet.  */\n+\n+  if (TREE_CODE (decl) == FUNCTION_DECL)\n+    make_decl_one_only (decl);\n+  else\n+    comdat_linkage (decl);\n+}\n+\n /* Set TREE_PUBLIC and/or DECL_EXTERN on the vtable DECL,\n    based on TYPE and other static flags.\n \n@@ -2481,9 +2505,8 @@ import_export_vtable (decl, type, final)\n \n       /* For WIN32 we also want to put explicit instantiations in\n \t linkonce sections.  */\n-      if (CLASSTYPE_EXPLICIT_INSTANTIATION (type)\n-\t  && supports_one_only () && ! SUPPORTS_WEAK)\n-\tmake_decl_one_only (decl);\n+      if (CLASSTYPE_EXPLICIT_INSTANTIATION (type))\n+\tmaybe_make_one_only (decl);\n     }\n   else\n     {\n@@ -2769,9 +2792,8 @@ import_export_decl (decl)\n \n \t  /* For WIN32 we also want to put explicit instantiations in\n \t     linkonce sections.  */\n-\t  if (CLASSTYPE_EXPLICIT_INSTANTIATION (ctype)\n-\t      && supports_one_only () && ! SUPPORTS_WEAK)\n-\t    make_decl_one_only (decl);\n+\t  if (CLASSTYPE_EXPLICIT_INSTANTIATION (ctype))\n+\t    maybe_make_one_only (decl);\n \t}\n       else if (TYPE_BUILT_IN (ctype) && ctype == TYPE_MAIN_VARIANT (ctype))\n \tDECL_NOT_REALLY_EXTERN (decl) = 0;"}, {"sha": "2e50cf981097bd0d48a1573eb1bc156310856e95", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b385c8412e8d4c6e257134e5bb7559ee06cd0c20/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=b385c8412e8d4c6e257134e5bb7559ee06cd0c20", "patch": "@@ -6444,8 +6444,8 @@ mark_decl_instantiated (result, extern_p)\n \n       /* For WIN32 we also want to put explicit instantiations in\n \t linkonce sections.  */\n-      if (supports_one_only () && ! SUPPORTS_WEAK && TREE_PUBLIC (result))\n-\tmake_decl_one_only (result);\n+      if (TREE_PUBLIC (result))\n+\tmaybe_make_one_only (result);\n     }\n   else if (TREE_CODE (result) == FUNCTION_DECL)\n     mark_inline_for_output (result);"}]}