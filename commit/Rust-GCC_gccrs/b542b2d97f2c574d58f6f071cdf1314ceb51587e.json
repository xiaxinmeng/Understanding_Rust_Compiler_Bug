{"sha": "b542b2d97f2c574d58f6f071cdf1314ceb51587e", "node_id": "C_kwDOANBUbNoAKGI1NDJiMmQ5N2YyYzU3NGQ1OGY2ZjA3MWNkZjEzMTRjZWI1MTU4N2U", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2021-12-09T12:34:09Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-01-06T17:11:39Z"}, "message": "[Ada] Fix regression in freezing code for instantiations\n\ngcc/ada/\n\n\t* sem_ch12.adb (Insert_Freeze_Node_For_Instance): When going to\n\tthe outer level, do not jump over following instantiations in\n\tthe list.", "tree": {"sha": "34f844fb3c46de41f1fb3e3eb9a157a254af9039", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/34f844fb3c46de41f1fb3e3eb9a157a254af9039"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b542b2d97f2c574d58f6f071cdf1314ceb51587e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b542b2d97f2c574d58f6f071cdf1314ceb51587e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b542b2d97f2c574d58f6f071cdf1314ceb51587e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b542b2d97f2c574d58f6f071cdf1314ceb51587e/comments", "author": null, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "00a66280cdafe17ad76944baac6fb7d0ae83e802", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/00a66280cdafe17ad76944baac6fb7d0ae83e802", "html_url": "https://github.com/Rust-GCC/gccrs/commit/00a66280cdafe17ad76944baac6fb7d0ae83e802"}], "stats": {"total": 30, "additions": 19, "deletions": 11}, "files": [{"sha": "fe55c5c20b138b10519174bd00b5ecff97c572c3", "filename": "gcc/ada/sem_ch12.adb", "status": "modified", "additions": 19, "deletions": 11, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b542b2d97f2c574d58f6f071cdf1314ceb51587e/gcc%2Fada%2Fsem_ch12.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b542b2d97f2c574d58f6f071cdf1314ceb51587e/gcc%2Fada%2Fsem_ch12.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch12.adb?ref=b542b2d97f2c574d58f6f071cdf1314ceb51587e", "patch": "@@ -9703,6 +9703,7 @@ package body Sem_Ch12 is\n       Decl     : Node_Id;\n       Decls    : List_Id;\n       Inst     : Entity_Id;\n+      Origin   : Entity_Id;\n       Par_Inst : Node_Id;\n       Par_N    : Node_Id;\n \n@@ -9793,9 +9794,10 @@ package body Sem_Ch12 is\n          end;\n       end if;\n \n-      Decl  := N;\n-      Decls := List_Containing (N);\n-      Par_N := Parent (Decls);\n+      Decl   := N;\n+      Decls  := List_Containing (N);\n+      Par_N  := Parent (Decls);\n+      Origin := Empty;\n \n       --  Determine the proper freeze point of an instantiation\n \n@@ -9824,10 +9826,13 @@ package body Sem_Ch12 is\n                 not In_Same_Source_Unit (Generic_Parent (Par_Inst), Inst)\n             then\n                while Present (Decl) loop\n-                  if (Nkind (Decl) in N_Unit_Body\n+                  if ((Nkind (Decl) in N_Unit_Body\n                         or else\n-                      Nkind (Decl) in N_Body_Stub)\n-                    and then Comes_From_Source (Decl)\n+                       Nkind (Decl) in N_Body_Stub)\n+                      and then Comes_From_Source (Decl))\n+                    or else (Present (Origin)\n+                              and then Nkind (Decl) in N_Generic_Instantiation\n+                              and then Instance_Spec (Decl) /= Origin)\n                   then\n                      Set_Sloc (F_Node, Sloc (Decl));\n                      Insert_Before (Decl, F_Node);\n@@ -9851,16 +9856,19 @@ package body Sem_Ch12 is\n                return;\n \n             --  When the instantiation occurs in a package spec and there is\n-            --  no source body which follows, not even of the package itself\n-            --  then insert into the declaration list of the outer level.\n+            --  no source body which follows, not even of the package itself,\n+            --  then insert into the declaration list of the outer level, but\n+            --  do not jump over following instantiations in this list because\n+            --  they may have a body that has not materialized yet, see above.\n \n             elsif Nkind (Par_N) = N_Package_Specification\n               and then No (Corresponding_Body (Parent (Par_N)))\n               and then Is_List_Member (Parent (Par_N))\n             then\n-               Decl  := Parent (Par_N);\n-               Decls := List_Containing (Decl);\n-               Par_N := Parent (Decls);\n+               Decl   := Parent (Par_N);\n+               Decls  := List_Containing (Decl);\n+               Par_N  := Parent (Decls);\n+               Origin := Decl;\n \n             --  In a package declaration, or if no source body which follows\n             --  and at library level, then insert at end of list."}]}