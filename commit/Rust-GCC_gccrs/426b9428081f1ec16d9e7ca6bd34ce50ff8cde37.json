{"sha": "426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDI2Yjk0MjgwODFmMWVjMTZkOWU3Y2E2YmQzNGNlNTBmZjhjZGUzNw==", "commit": {"author": {"name": "Patrick Palka", "email": "ppalka@gcc.gnu.org", "date": "2016-03-23T21:08:32Z"}, "committer": {"name": "Patrick Palka", "email": "ppalka@gcc.gnu.org", "date": "2016-03-23T21:08:32Z"}, "message": "Fix PR c++/70347 (default member initializer not picked up by union)\n\ngcc/cp/ChangeLog:\n\n\tPR c++/70347\n\t* typeck.c (process_init_constructor_union): If the initializer\n\tis empty, use the union's NSDMI if it has one.\n\ngcc/testsuite/ChangeLog:\n\n\tPR c++/70347\n\t* g++.dg/cpp1y/nsdmi-union1.C: New test.\n\nFrom-SVN: r234443", "tree": {"sha": "c5c84c33aec21b6c26ab9ee3f47e1793de17494c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c5c84c33aec21b6c26ab9ee3f47e1793de17494c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "html_url": "https://github.com/Rust-GCC/gccrs/commit/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/comments", "author": null, "committer": null, "parents": [{"sha": "cd1588c4d60162730a103b6ca3a30139d88a57e3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cd1588c4d60162730a103b6ca3a30139d88a57e3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cd1588c4d60162730a103b6ca3a30139d88a57e3"}], "stats": {"total": 63, "additions": 61, "deletions": 2}, "files": [{"sha": "b32c72dac83862b1d8ec2f152ed6be243a69b917", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "patch": "@@ -1,3 +1,9 @@\n+2016-03-23  Patrick Palka  <ppalka@gcc.gnu.org>\n+\n+\tPR c++/70347\n+\t* typeck.c (process_init_constructor_union): If the initializer\n+\tis empty, use the union's NSDMI if it has one.\n+\n 2016-03-23  Patrick Palka  <ppalka@gcc.gnu.org>\n \n \tPR c++/70332"}, {"sha": "4ab77cda387cb12cf33fa2952ad4a07693cd3e3b", "filename": "gcc/cp/typeck2.c", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Fcp%2Ftypeck2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Fcp%2Ftypeck2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck2.c?ref=426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "patch": "@@ -1499,9 +1499,24 @@ process_init_constructor_union (tree type, tree init,\n   constructor_elt *ce;\n   int len;\n \n-  /* If the initializer was empty, use default zero initialization.  */\n+  /* If the initializer was empty, use the union's NSDMI if it has one.\n+     Otherwise use default zero initialization.  */\n   if (vec_safe_is_empty (CONSTRUCTOR_ELTS (init)))\n-    return 0;\n+    {\n+      for (tree field = TYPE_FIELDS (type); field; field = TREE_CHAIN (field))\n+\t{\n+\t  if (DECL_INITIAL (field))\n+\t    {\n+\t      CONSTRUCTOR_APPEND_ELT (CONSTRUCTOR_ELTS (init),\n+\t\t\t\t      field,\n+\t\t\t\t      get_nsdmi (field, /*in_ctor=*/false));\n+\t      break;\n+\t    }\n+\t}\n+\n+      if (vec_safe_is_empty (CONSTRUCTOR_ELTS (init)))\n+\treturn 0;\n+    }\n \n   len = CONSTRUCTOR_ELTS (init)->length ();\n   if (len > 1)"}, {"sha": "3a5cf65c2ab66cc8f27a28a949155e2ea6f6ab30", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "patch": "@@ -1,3 +1,8 @@\n+2016-03-23  Patrick Palka  <ppalka@gcc.gnu.org>\n+\n+\tPR c++/70347\n+\t* g++.dg/cpp1y/nsdmi-union1.C: New test.\n+\n 2016-03-23  Patrick Palka  <ppalka@gcc.gnu.org>\n \n \tPR c++/70332"}, {"sha": "d9dd0bfcc91e605a4af08a398657c60a2b95757d", "filename": "gcc/testsuite/g++.dg/cpp1y/nsdmi-union1.C", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fnsdmi-union1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426b9428081f1ec16d9e7ca6bd34ce50ff8cde37/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fnsdmi-union1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fnsdmi-union1.C?ref=426b9428081f1ec16d9e7ca6bd34ce50ff8cde37", "patch": "@@ -0,0 +1,33 @@\n+// PR c++/70347\n+// { dg-do run { target c++14 } }\n+\n+union A {\n+  char a;\n+  long b = -42;\n+};\n+\n+struct B {\n+  union {\n+    char a = 10;\n+    long b;\n+  };\n+};\n+\n+A c1{};\n+A c2{4};\n+B c3{};\n+B c4{{9}};\n+\n+int main() {\n+  if (c1.b != -42)\n+    __builtin_abort ();\n+\n+  if (c2.a != 4)\n+    __builtin_abort ();\n+\n+  if (c3.a != 10)\n+    __builtin_abort ();\n+\n+  if (c4.a != 9)\n+    __builtin_abort ();\n+}"}]}