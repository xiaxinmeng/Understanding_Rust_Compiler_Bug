{"sha": "4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NGEwMWY3YjFlNzNlOThhODY1MjBkOGE4MjVkZGQzNzc3ZmFhN2MzMw==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-03-21T23:10:17Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-03-21T23:10:37Z"}, "message": "d: Fix missing dependencies in depfile for imported files (PR93038)\n\nA new field for tracking imported files was added to the front-end, this\nmakes use of it by writing all such files in the make dependency list.\n\ngcc/d/ChangeLog:\n\n2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n\n\tPR d/93038\n\t* d-lang.cc (deps_write): Add content imported files to the make\n\tdependency list.\n\ngcc/testsuite/ChangeLog:\n\n2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n\n\tPR d/93038\n\t* gdc.dg/fileimports/pr93038.txt: New test.\n\t* gdc.dg/pr93038.d: New test.", "tree": {"sha": "1c5ea14af83ff31a1c8490f3b001c54a80029944", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1c5ea14af83ff31a1c8490f3b001c54a80029944"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "424e39081f9ce716ad4b6306803c2784caba732a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/424e39081f9ce716ad4b6306803c2784caba732a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/424e39081f9ce716ad4b6306803c2784caba732a"}], "stats": {"total": 73, "additions": 53, "deletions": 20}, "files": [{"sha": "916319f6bf773adc11a843db2c520e46141dc301", "filename": "gcc/d/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Fd%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Fd%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2FChangeLog?ref=4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "patch": "@@ -1,3 +1,9 @@\n+2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n+\n+\tPR d/93038\n+\t* d-lang.cc (deps_write): Add content imported files to the make\n+\tdependency list.\n+\n 2020-03-21  Iain Buclaw  <ibuclaw@gdcproject.org>\n \n \tPR d/94240"}, {"sha": "514799d8e895dcd80260a6c02e4ab4c25963ae70", "filename": "gcc/d/d-lang.cc", "status": "modified", "additions": 32, "deletions": 20, "changes": 52, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Fd%2Fd-lang.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Fd%2Fd-lang.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-lang.cc?ref=4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "patch": "@@ -151,7 +151,8 @@ deps_add_target (const char *target, bool quoted)\n static void\n deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n {\n-  hash_set <const char *> dependencies;\n+  hash_set <const char *> seen_modules;\n+  vec <const char *> dependencies = vNULL;\n \n   Modules modlist;\n   modlist.push (module);\n@@ -179,38 +180,28 @@ deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n   buffer->writestring (\":\");\n   column++;\n \n-  /* Write out all make dependencies.  */\n+  /* Search all modules for file dependencies.  */\n   while (modlist.dim > 0)\n     {\n       Module *depmod = modlist.pop ();\n \n       str = depmod->srcfile->name->str;\n-      size = strlen (str);\n \n-      /* Skip dependencies that have already been written.  */\n-      if (dependencies.add (str))\n+      /* Skip modules that have already been looked at.  */\n+      if (seen_modules.add (str))\n \tcontinue;\n \n-      column += size;\n-\n-      if (colmax && column > colmax)\n-\t{\n-\t  buffer->writestring (\" \\\\\\n \");\n-\t  column = size + 1;\n-\t}\n-      else\n-\t{\n-\t  buffer->writestring (\" \");\n-\t  column++;\n-\t}\n-\n-      buffer->writestring (str);\n+      dependencies.safe_push (str);\n \n       /* Add to list of phony targets if is not being compile.  */\n       if (d_option.deps_phony && !depmod->isRoot ())\n \tphonylist.push (depmod);\n \n-      /* Search all imports of the written dependency.  */\n+      /* Add imported files to dependency list.  */\n+      for (size_t i = 0; i < depmod->contentImportedFiles.dim; i++)\n+\tdependencies.safe_push (depmod->contentImportedFiles[i]);\n+\n+      /* Search all imports of the module.  */\n       for (size_t i = 0; i < depmod->aimports.dim; i++)\n \t{\n \t  Module *m = depmod->aimports[i];\n@@ -244,6 +235,27 @@ deps_write (Module *module, OutBuffer *buffer, unsigned colmax = 72)\n \t}\n     }\n \n+  /* Write out all make dependencies.  */\n+  for (size_t i = 0; i < dependencies.length (); i++)\n+    {\n+      str = dependencies[i];\n+      size = strlen (str);\n+      column += size;\n+\n+      if (colmax && column > colmax)\n+\t{\n+\t  buffer->writestring (\" \\\\\\n \");\n+\t  column = size + 1;\n+\t}\n+      else\n+\t{\n+\t  buffer->writestring (\" \");\n+\t  column++;\n+\t}\n+\n+      buffer->writestring (str);\n+    }\n+\n   buffer->writenl ();\n \n   /* Write out all phony targets.  */"}, {"sha": "c8701caaf6f097b8aad7c5990312613637ce9a83", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "patch": "@@ -1,3 +1,9 @@\n+2020-03-22  Iain Buclaw  <ibuclaw@gdcproject.org>\n+\n+\tPR d/93038\n+\t* gdc.dg/fileimports/pr93038.txt: New test.\n+\t* gdc.dg/pr93038.d: New test.\n+\n 2020-03-21  Patrick Palka  <ppalka@redhat.com>\n \n \tPR c++/94066"}, {"sha": "9d1dc810c951b34eb654eb4ded79b52400542104", "filename": "gcc/testsuite/gdc.dg/fileimports/pr93038.txt", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Ftestsuite%2Fgdc.dg%2Ffileimports%2Fpr93038.txt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Ftestsuite%2Fgdc.dg%2Ffileimports%2Fpr93038.txt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Ffileimports%2Fpr93038.txt?ref=4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "patch": "@@ -0,0 +1 @@\n+v2.091.0"}, {"sha": "4e09690a4736f990e190cf8123c95581291a99ff", "filename": "gcc/testsuite/gdc.dg/pr93038.d", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Ftestsuite%2Fgdc.dg%2Fpr93038.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a01f7b1e73e98a86520d8a825ddd3777faa7c33/gcc%2Ftestsuite%2Fgdc.dg%2Fpr93038.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fpr93038.d?ref=4a01f7b1e73e98a86520d8a825ddd3777faa7c33", "patch": "@@ -0,0 +1,8 @@\n+// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=93038\n+// { dg-options \"-J $srcdir/gdc.dg/fileimports -MMD\" }\n+// { dg-do compile }\n+// { dg-final { scan-file pr93038.deps \"pr93038.o: \\[^\\n\\]*/pr93038.d \\[ \\\\\\\\\\n\\]*\\[^\\n\\]*/fileimports/pr93038.txt\" } }\n+// { dg-final { file delete pr93038.deps } }\n+module pr93038;\n+\n+const VERSION = import(\"pr93038.txt\");"}]}