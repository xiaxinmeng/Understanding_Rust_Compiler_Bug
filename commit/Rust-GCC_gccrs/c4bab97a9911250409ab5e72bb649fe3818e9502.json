{"sha": "c4bab97a9911250409ab5e72bb649fe3818e9502", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzRiYWI5N2E5OTExMjUwNDA5YWI1ZTcyYmI2NDlmZTM4MThlOTUwMg==", "commit": {"author": {"name": "Mark Wielaard", "email": "mark@klomp.org", "date": "2021-08-15T21:54:54Z"}, "committer": {"name": "Mark Wielaard", "email": "mark@klomp.org", "date": "2021-08-15T21:56:25Z"}, "message": "Use default type_for_size langhook\n\nThe gcc constant folding code uses the type_for_size langhook. Use the\ndefault implementation instead of crashing when the langhook is\ncalled. Add a new testcase \"prims_struct_eq.rs\" that creates trees\nthat triggers the constant folding.\n\nAlso remove the write_globals langhook which was removed when early\ndebug was integrated into gcc.", "tree": {"sha": "0e68db2761b9389e4ea8081e7f2a61f56fd21f38", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0e68db2761b9389e4ea8081e7f2a61f56fd21f38"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c4bab97a9911250409ab5e72bb649fe3818e9502", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4bab97a9911250409ab5e72bb649fe3818e9502", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c4bab97a9911250409ab5e72bb649fe3818e9502", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4bab97a9911250409ab5e72bb649fe3818e9502/comments", "author": null, "committer": null, "parents": [{"sha": "52c1cdc9c63baeb090680daf6762c02362f2c6cd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/52c1cdc9c63baeb090680daf6762c02362f2c6cd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/52c1cdc9c63baeb090680daf6762c02362f2c6cd"}], "stats": {"total": 108, "additions": 91, "deletions": 17}, "files": [{"sha": "b4f8cbe783043831748c405a484f2d253125f395", "filename": "gcc/rust/rust-lang.cc", "status": "modified", "additions": 0, "deletions": 17, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4bab97a9911250409ab5e72bb649fe3818e9502/gcc%2Frust%2Frust-lang.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4bab97a9911250409ab5e72bb649fe3818e9502/gcc%2Frust%2Frust-lang.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Frust-lang.cc?ref=c4bab97a9911250409ab5e72bb649fe3818e9502", "patch": "@@ -224,20 +224,6 @@ grs_langhook_type_for_mode (machine_mode mode, int unsignedp)\n   return NULL;\n }\n \n-/* This appears to be used for creating different types for different bit sizes\n- * (e.g. int and long). Also, the Go frontend calls this from type_for_mode to\n- * determine the type from a specific bitsize for integer types.\n- * FIXME: change this when working on AST-GENERIC conversion to allow the full\n- * range of Rust type sizes. */\n-static tree\n-grs_langhook_type_for_size (unsigned int bits ATTRIBUTE_UNUSED,\n-\t\t\t    int unsignedp ATTRIBUTE_UNUSED)\n-{\n-  gcc_unreachable ();\n-  return NULL_TREE;\n-  // nothing at the moment, but change later\n-}\n-\n // Record a builtin function. We just ignore builtin functions.\n static tree\n grs_langhook_builtin_function (tree decl ATTRIBUTE_UNUSED)\n@@ -420,7 +406,6 @@ rust_localize_identifier (const char *ident)\n #undef LANG_HOOKS_POST_OPTIONS\n #undef LANG_HOOKS_PARSE_FILE\n #undef LANG_HOOKS_TYPE_FOR_MODE\n-#undef LANG_HOOKS_TYPE_FOR_SIZE\n #undef LANG_HOOKS_BUILTIN_FUNCTION\n #undef LANG_HOOKS_GLOBAL_BINDINGS_P\n #undef LANG_HOOKS_PUSHDECL\n@@ -442,12 +427,10 @@ rust_localize_identifier (const char *ident)\n  */\n #define LANG_HOOKS_PARSE_FILE grs_langhook_parse_file\n #define LANG_HOOKS_TYPE_FOR_MODE grs_langhook_type_for_mode\n-#define LANG_HOOKS_TYPE_FOR_SIZE grs_langhook_type_for_size\n #define LANG_HOOKS_BUILTIN_FUNCTION grs_langhook_builtin_function\n #define LANG_HOOKS_GLOBAL_BINDINGS_P grs_langhook_global_bindings_p\n #define LANG_HOOKS_PUSHDECL grs_langhook_pushdecl\n #define LANG_HOOKS_GETDECLS grs_langhook_getdecls\n-#define LANG_HOOKS_WRITE_GLOBALS grs_langhook_write_globals\n #define LANG_HOOKS_GIMPLIFY_EXPR grs_langhook_gimplify_expr\n #define LANG_HOOKS_EH_PERSONALITY grs_langhook_eh_personality\n "}, {"sha": "81ab7424627261a8488fc0e7440f9ae6e99e2222", "filename": "gcc/testsuite/rust/compile/torture/prims_struct_eq.rs", "status": "added", "additions": 91, "deletions": 0, "changes": 91, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4bab97a9911250409ab5e72bb649fe3818e9502/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fprims_struct_eq.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4bab97a9911250409ab5e72bb649fe3818e9502/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fprims_struct_eq.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fprims_struct_eq.rs?ref=c4bab97a9911250409ab5e72bb649fe3818e9502", "patch": "@@ -0,0 +1,91 @@\n+extern \"C\"\n+{\n+  fn abort ();\n+}\n+\n+struct Prims\n+{\n+  b1: bool,\n+  b2: bool,\n+  b3: bool,\n+  b4: bool,\n+  c1: char,\n+  c2: char,\n+  u81: u8,\n+  u82: u8,\n+  u83: u8,\n+  u84: u8,\n+  i81: i8,\n+  i82: i8,\n+  i83: i8,\n+  i84: i8,\n+  u161: u16,\n+  u162: u16,\n+  i161: i16,\n+  i162: i16,\n+  u321: u32,\n+  u322: u32,\n+  i321: i32,\n+  i322: i32,\n+  u641: u64,\n+  i641: i64,\n+  u1281: u128,\n+  i1281: i128,\n+  usize1: usize,\n+  isize1: isize,\n+}\n+\n+fn prims_eq (p1: Prims, p2: Prims) -> bool\n+{\n+  return p1.b1 == p2.b1\n+         && p1.b2 == p2.b2\n+         && p1.b3 == p2.b3\n+         && p1.b4 == p2.b4\n+         && p1.c1 == p2.c1\n+         && p1.c2 == p2.c2\n+         && p1.u81 == p2.u81\n+         && p1.u82 == p2.u82\n+         && p1.u83 == p2.u83\n+         && p1.u84 == p2.u84\n+         && p1.i81 == p2.i81\n+         && p1.i82 == p2.i82\n+         && p1.i83 == p2.i83\n+         && p1.i84 == p2.i84\n+         && p1.u161 == p2.u161\n+         && p1.u162 == p2.u162\n+         && p1.i161 == p2.i161\n+         && p1.i162 == p2.i162\n+         && p1.u321 == p2.u321\n+         && p1.u322 == p2.u322\n+         && p1.i321 == p2.i321\n+         && p1.i322 == p2.i322\n+         && p1.u641 == p2.u641\n+         && p1.i641 == p2.i641\n+         && p1.u1281 == p2.u1281\n+         && p1.i1281 == p2.i1281\n+         && p1.usize1 == p2.usize1\n+         && p1.isize1 == p2.isize1;\n+}\n+\n+pub fn main ()\n+{\n+  let p1 = Prims { b1: true, b2: false, b3: false, b4: true,\n+                   c1: 'a', c2: 'b',\n+                   u81: 1, u82: 2, u83: 3, u84: 4,\n+                   i81: -1, i82: -2, i83: -3, i84: -4,\n+                   u161: 1, u162: 2,\n+                   i161: -1, i162: -2,\n+                   u321: 1, u322: 2,\n+                   i321: -1, i322: -2,\n+                   u641: 1,\n+                   i641: -1,\n+                   u1281: 1,\n+                   i1281: -1,\n+                   usize1: 1,\n+                   isize1: -1 };\n+  let p2 = Prims { usize1: 1, .. p1 };\n+  let p3 = Prims { u1281: 0, .. p2 };\n+  let p4 = Prims { i1281: 0, .. p3 };\n+  if !prims_eq (p1, p2) { unsafe { abort (); } }\n+  if prims_eq (p3, p4) { unsafe { abort (); } }\n+}"}]}