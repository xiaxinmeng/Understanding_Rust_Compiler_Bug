{"sha": "10fa280a98a0e0b2f3f155262a0886de314f46fc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTBmYTI4MGE5OGEwZTBiMmYzZjE1NTI2MmEwODg2ZGUzMTRmNDZmYw==", "commit": {"author": {"name": "Tobias Burnus", "email": "burnus@net-b.de", "date": "2010-03-29T06:17:19Z"}, "committer": {"name": "Tobias Burnus", "email": "burnus@gcc.gnu.org", "date": "2010-03-29T06:17:19Z"}, "message": "re PR libfortran/43551 (Buffered direct I/O reads wrong record)\n\n2010-03-29  Tobias Burnus  <burnus@net-b.de>\n\n        PR fortran/43551\n        * io/unix.c (buf_write): Set physical_offset after lseek.\n\n2010-03-29  Tobias Burnus  <burnus@net-b.de>\n\n        PR fortran/43551\n        * gfortran.dg/direct_io_12.f90: New test.\n\nFrom-SVN: r157792", "tree": {"sha": "0fa226acca58f291807801694e83907d2a7de3c8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0fa226acca58f291807801694e83907d2a7de3c8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/10fa280a98a0e0b2f3f155262a0886de314f46fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/10fa280a98a0e0b2f3f155262a0886de314f46fc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/10fa280a98a0e0b2f3f155262a0886de314f46fc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/10fa280a98a0e0b2f3f155262a0886de314f46fc/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "090f6087fee1dacd55c489f85000d894d8f4f010", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/090f6087fee1dacd55c489f85000d894d8f4f010", "html_url": "https://github.com/Rust-GCC/gccrs/commit/090f6087fee1dacd55c489f85000d894d8f4f010"}], "stats": {"total": 61, "additions": 54, "deletions": 7}, "files": [{"sha": "b23124664e3c6118076671a445aff25ad847a607", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/10fa280a98a0e0b2f3f155262a0886de314f46fc/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/10fa280a98a0e0b2f3f155262a0886de314f46fc/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=10fa280a98a0e0b2f3f155262a0886de314f46fc", "patch": "@@ -1,3 +1,8 @@\n+2010-03-29  Tobias Burnus  <burnus@net-b.de>\n+\n+\tPR fortran/43551\n+\t* gfortran.dg/direct_io_12.f90: New test.\n+\n 2010-03-28  Jan Hubicka  <jh@suse.cz>\n \n \tPR tree-optimization/43505"}, {"sha": "53367027242e93c253ea413458ac7157e86a2980", "filename": "gcc/testsuite/gfortran.dg/direct_io_12.f90", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/10fa280a98a0e0b2f3f155262a0886de314f46fc/gcc%2Ftestsuite%2Fgfortran.dg%2Fdirect_io_12.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/10fa280a98a0e0b2f3f155262a0886de314f46fc/gcc%2Ftestsuite%2Fgfortran.dg%2Fdirect_io_12.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fdirect_io_12.f90?ref=10fa280a98a0e0b2f3f155262a0886de314f46fc", "patch": "@@ -0,0 +1,33 @@\n+! { dg-do run }\n+! \n+! PR fortran/43551\n+!\n+! Writes a 672000 byte file with buffering. The writing failed because\n+! of a missing lseek.\n+\n+implicit none\n+integer, parameter :: size = 2800 ! << needs to be large enough\n+real(8) :: vec1(size,30), dummy(size)\n+integer i\n+\n+CALL RANDOM_NUMBER(vec1)\n+\n+open(99, file='test.dat', form='unformatted', access='direct', recl=size*8)\n+do i = 1, 10\n+  write(99,rec=i) vec1(:,i)\n+  write(99,rec=i+10) vec1(:,i+10)\n+  write(99,rec=i+20) vec1(:,i+20) ! << rec = 30 was written to rec = 21\n+end do\n+\n+do i = 1, 10\n+  read(99,rec=i) dummy\n+  if (any (dummy /= vec1(:,i))) call abort()\n+  read(99,rec=i+10) dummy\n+  if (any (dummy /= vec1(:,i+10))) call abort()\n+  read(99,rec=i+20) dummy\n+  if (any (dummy /= vec1(:,i+20))) call abort() ! << aborted here for rec = 21\n+end do\n+\n+close(99, status='delete')\n+end\n+"}, {"sha": "4958831010e8cb96ed75423716ae0e7121682121", "filename": "libgfortran/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/10fa280a98a0e0b2f3f155262a0886de314f46fc/libgfortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/10fa280a98a0e0b2f3f155262a0886de314f46fc/libgfortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2FChangeLog?ref=10fa280a98a0e0b2f3f155262a0886de314f46fc", "patch": "@@ -1,3 +1,8 @@\n+2010-03-29  Tobias Burnus  <burnus@net-b.de>\n+\n+\tPR fortran/43551\n+\t* io/unix.c (buf_write): Set physical_offset after lseek.\n+\n 2010-03-25  Jerry DeLisle  <jvdelisle@gcc.gnu.org>\n \n \tPR libfortran/43517"}, {"sha": "ea3b8bc4b400c9d836217f015c49768fb91c19d2", "filename": "libgfortran/io/unix.c", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/10fa280a98a0e0b2f3f155262a0886de314f46fc/libgfortran%2Fio%2Funix.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/10fa280a98a0e0b2f3f155262a0886de314f46fc/libgfortran%2Fio%2Funix.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fio%2Funix.c?ref=10fa280a98a0e0b2f3f155262a0886de314f46fc", "patch": "@@ -496,13 +496,17 @@ buf_write (unix_stream * s, const void * buf, ssize_t nbyte)\n           s->ndirty += nbyte;\n         }\n       else\n-        {\n-          if (s->file_length != -1 && s->physical_offset != s->logical_offset\n-              && lseek (s->fd, s->logical_offset, SEEK_SET) < 0)\n-            return -1;\n-          nbyte = raw_write (s, buf, nbyte);\n-          s->physical_offset += nbyte;\n-        }\n+\t{\n+\t  if (s->file_length != -1 && s->physical_offset != s->logical_offset)\n+\t    {\n+\t      if (lseek (s->fd, s->logical_offset, SEEK_SET) < 0)\n+\t\treturn -1;\n+\t      s->physical_offset = s->logical_offset;\n+\t    }\n+\n+\t  nbyte = raw_write (s, buf, nbyte);\n+\t  s->physical_offset += nbyte;\n+\t}\n     }\n   s->logical_offset += nbyte;\n   /* Don't increment file_length if the file is non-seekable.  */"}]}