{"sha": "174e79bf73331b41b7a14dffd45ed8293487f0e0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTc0ZTc5YmY3MzMzMWI0MWI3YTE0ZGZmZDQ1ZWQ4MjkzNDg3ZjBlMA==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-07-14T10:55:53Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-07-14T10:55:53Z"}, "message": "[Fortran, OpenMP] Fix allocatable-components check (PR67311)\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/67311\n\t* trans-openmp.c (gfc_has_alloc_comps): Return false also for\n\tpointers to arrays.\n\nlibgomp/ChangeLog:\n\n\tPR fortran/67311\n\t* testsuite/libgomp.fortran/target-map-1.f90: New test.", "tree": {"sha": "f07e667a6df8fd524a8a44089519d655faacf644", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f07e667a6df8fd524a8a44089519d655faacf644"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/174e79bf73331b41b7a14dffd45ed8293487f0e0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/174e79bf73331b41b7a14dffd45ed8293487f0e0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/174e79bf73331b41b7a14dffd45ed8293487f0e0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/174e79bf73331b41b7a14dffd45ed8293487f0e0/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f418bd4b92a03ee0ec0fe4cfcd896e86e11ac2cf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f418bd4b92a03ee0ec0fe4cfcd896e86e11ac2cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f418bd4b92a03ee0ec0fe4cfcd896e86e11ac2cf"}], "stats": {"total": 46, "additions": 46, "deletions": 0}, "files": [{"sha": "b2645e723d510fcaf5fc29e3df36ffa4749ef2d8", "filename": "gcc/fortran/trans-openmp.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/174e79bf73331b41b7a14dffd45ed8293487f0e0/gcc%2Ffortran%2Ftrans-openmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/174e79bf73331b41b7a14dffd45ed8293487f0e0/gcc%2Ffortran%2Ftrans-openmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-openmp.c?ref=174e79bf73331b41b7a14dffd45ed8293487f0e0", "patch": "@@ -330,6 +330,11 @@ gfc_has_alloc_comps (tree type, tree decl)\n \treturn false;\n     }\n \n+  if (GFC_DESCRIPTOR_TYPE_P (type)\n+      && (GFC_TYPE_ARRAY_AKIND (type) == GFC_ARRAY_POINTER\n+\t  || GFC_TYPE_ARRAY_AKIND (type) == GFC_ARRAY_POINTER_CONT))\n+    return false;\n+\n   if (GFC_DESCRIPTOR_TYPE_P (type) || GFC_ARRAY_TYPE_P (type))\n     type = gfc_get_element_type (type);\n "}, {"sha": "6107530d292fedc3cfae5b1b7d55dbe2f90c7020", "filename": "libgomp/testsuite/libgomp.fortran/target-map-1.f90", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/174e79bf73331b41b7a14dffd45ed8293487f0e0/libgomp%2Ftestsuite%2Flibgomp.fortran%2Ftarget-map-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/174e79bf73331b41b7a14dffd45ed8293487f0e0/libgomp%2Ftestsuite%2Flibgomp.fortran%2Ftarget-map-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Ftarget-map-1.f90?ref=174e79bf73331b41b7a14dffd45ed8293487f0e0", "patch": "@@ -0,0 +1,41 @@\n+! PR fortran/67311\n+\n+implicit none\n+  TYPE myType\n+    integer :: A\n+    TYPE(myType), DIMENSION(:), POINTER :: x\n+    TYPE(myType), DIMENSION(:), contiguous, POINTER :: y\n+    integer :: B\n+  END TYPE myType\n+  call openmp_sub\n+contains\n+  subroutine openmp_sub\n+    type(myType) :: argument\n+\n+    !$OMP PARALLEL DEFAULT(NONE) PRIVATE(argument)\n+      argument%a = 5\n+      argument%b = 7\n+      call foo(argument)\n+      if (.not.associated(argument%x) .or. size(argument%x) /= 2) stop 2\n+      if (argument%a /= 8 .or. argument%b /= 9 &\n+          .or. any(argument%x(:)%a /= [2, 3]) &\n+          .or. any(argument%x(:)%b /= [9, 1])) stop 3\n+      if (.not.associated(argument%y) .or. size(argument%y) /= 3) stop 4\n+      if (any(argument%y(:)%a /= [11, 22, 33]) &\n+          .or. any(argument%y(:)%b /= [44, 55, 66])) stop 5\n+      deallocate (argument%x, argument%y)\n+    !$OMP END PARALLEL\n+  end subroutine openmp_sub\n+  subroutine foo(x)\n+    type(myType), intent(inout) :: x\n+    !$omp declare target\n+    if (x%a /= 5 .or. x%b /= 7) stop 1\n+    x%a = 8; x%b = 9\n+    allocate (x%x(2))\n+    x%x(:)%a = [2, 3]\n+    x%x(:)%b = [9, 1]\n+    allocate (x%y(3))\n+    x%y(:)%a = [11, 22, 33]\n+    x%y(:)%b = [44, 55, 66]\n+  end subroutine\n+end"}]}