{"sha": "d010efbfb89721bc9ca9e657e980ff0d8e6187af", "node_id": "C_kwDOANBUbNoAKGQwMTBlZmJmYjg5NzIxYmM5Y2E5ZTY1N2U5ODBmZjBkOGU2MTg3YWY", "commit": {"author": {"name": "Florian Weimer", "email": "fweimer@redhat.com", "date": "2023-01-03T15:47:31Z"}, "committer": {"name": "Florian Weimer", "email": "fweimer@redhat.com", "date": "2023-01-03T15:47:31Z"}, "message": "Revert \"Define __LIBGCC_DWARF_REG_SIZES_CONSTANT__ if DWARF register size is constant\"\n\nThis reverts commit 97bbdb726aba76ead550e25061029cf0aa78671b.", "tree": {"sha": "dd4120fdd100912a15f98dafd9688b3660f1ab05", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/dd4120fdd100912a15f98dafd9688b3660f1ab05"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d010efbfb89721bc9ca9e657e980ff0d8e6187af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d010efbfb89721bc9ca9e657e980ff0d8e6187af", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d010efbfb89721bc9ca9e657e980ff0d8e6187af", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d010efbfb89721bc9ca9e657e980ff0d8e6187af/comments", "author": {"login": "fweimer-rh", "id": 75532728, "node_id": "MDQ6VXNlcjc1NTMyNzI4", "avatar_url": "https://avatars.githubusercontent.com/u/75532728?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fweimer-rh", "html_url": "https://github.com/fweimer-rh", "followers_url": "https://api.github.com/users/fweimer-rh/followers", "following_url": "https://api.github.com/users/fweimer-rh/following{/other_user}", "gists_url": "https://api.github.com/users/fweimer-rh/gists{/gist_id}", "starred_url": "https://api.github.com/users/fweimer-rh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fweimer-rh/subscriptions", "organizations_url": "https://api.github.com/users/fweimer-rh/orgs", "repos_url": "https://api.github.com/users/fweimer-rh/repos", "events_url": "https://api.github.com/users/fweimer-rh/events{/privacy}", "received_events_url": "https://api.github.com/users/fweimer-rh/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fweimer-rh", "id": 75532728, "node_id": "MDQ6VXNlcjc1NTMyNzI4", "avatar_url": "https://avatars.githubusercontent.com/u/75532728?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fweimer-rh", "html_url": "https://github.com/fweimer-rh", "followers_url": "https://api.github.com/users/fweimer-rh/followers", "following_url": "https://api.github.com/users/fweimer-rh/following{/other_user}", "gists_url": "https://api.github.com/users/fweimer-rh/gists{/gist_id}", "starred_url": "https://api.github.com/users/fweimer-rh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fweimer-rh/subscriptions", "organizations_url": "https://api.github.com/users/fweimer-rh/orgs", "repos_url": "https://api.github.com/users/fweimer-rh/repos", "events_url": "https://api.github.com/users/fweimer-rh/events{/privacy}", "received_events_url": "https://api.github.com/users/fweimer-rh/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96127a4100e8a62c3dc009b5f06199bf24275bf3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/96127a4100e8a62c3dc009b5f06199bf24275bf3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/96127a4100e8a62c3dc009b5f06199bf24275bf3"}], "stats": {"total": 72, "additions": 12, "deletions": 60}, "files": [{"sha": "333f3e138d611cff55610a952e21405617a237ed", "filename": "gcc/c-family/c-cppbuiltin.cc", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d010efbfb89721bc9ca9e657e980ff0d8e6187af/gcc%2Fc-family%2Fc-cppbuiltin.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d010efbfb89721bc9ca9e657e980ff0d8e6187af/gcc%2Fc-family%2Fc-cppbuiltin.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-cppbuiltin.cc?ref=d010efbfb89721bc9ca9e657e980ff0d8e6187af", "patch": "@@ -1521,12 +1521,6 @@ c_cpp_builtins (cpp_reader *pfile)\n #endif\n       builtin_define_with_int_value (\"__LIBGCC_DWARF_FRAME_REGISTERS__\",\n \t\t\t\t     DWARF_FRAME_REGISTERS);\n-      {\n-\tint value = dwarf_reg_sizes_constant ();\n-\tif (value > 0)\n-\t  builtin_define_with_int_value (\"__LIBGCC_DWARF_REG_SIZES_CONSTANT__\",\n-\t\t\t\t\t value);\n-      }\n #ifdef EH_RETURN_STACKADJ_RTX\n       cpp_define (pfile, \"__LIBGCC_EH_RETURN_STACKADJ_RTX__\");\n #endif"}, {"sha": "799d5e316a263c5e435b0f09b0b96a020ed6cafd", "filename": "gcc/debug.h", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d010efbfb89721bc9ca9e657e980ff0d8e6187af/gcc%2Fdebug.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d010efbfb89721bc9ca9e657e980ff0d8e6187af/gcc%2Fdebug.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdebug.h?ref=d010efbfb89721bc9ca9e657e980ff0d8e6187af", "patch": "@@ -245,8 +245,6 @@ extern const struct gcc_debug_hooks vmsdbg_debug_hooks;\n \n /* Dwarf2 frame information.  */\n \n-extern int dwarf_reg_sizes_constant ();\n-\n extern void dwarf2out_begin_prologue (unsigned int, unsigned int,\n \t\t\t\t      const char *);\n extern void dwarf2out_vms_end_prologue (unsigned int, const char *);"}, {"sha": "4d2bd869a4b9e094e474543fcaa256a687edd696", "filename": "gcc/dwarf2cfi.cc", "status": "modified", "additions": 0, "deletions": 23, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d010efbfb89721bc9ca9e657e980ff0d8e6187af/gcc%2Fdwarf2cfi.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d010efbfb89721bc9ca9e657e980ff0d8e6187af/gcc%2Fdwarf2cfi.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdwarf2cfi.cc?ref=d010efbfb89721bc9ca9e657e980ff0d8e6187af", "patch": "@@ -334,29 +334,6 @@ generate_dwarf_reg_sizes (poly_uint16 *sizes)\n     targetm.init_dwarf_reg_sizes_extra (sizes);\n }\n \n-/* Return 0 if the DWARF register sizes are not constant, otherwise\n-   return the size constant.  */\n-\n-int\n-dwarf_reg_sizes_constant ()\n-{\n-  poly_uint16 *sizes = XALLOCAVEC (poly_uint16, DWARF_FRAME_REGISTERS);\n-  generate_dwarf_reg_sizes (sizes);\n-\n-  int result;\n-  for (unsigned int i = 0; i < DWARF_FRAME_REGISTERS; i++)\n-    {\n-      unsigned short value;\n-      if (!sizes[i].is_constant (&value))\n-\treturn 0;\n-      if (i == 0)\n-\tresult = value;\n-      else if (result != value)\n-\treturn 0;\n-    }\n-  return result;\n-}\n-\n /* Generate code to initialize the dwarf register size table located\n    at the provided ADDRESS.  */\n "}, {"sha": "eaceace20298b9b13344aff9d1fe9ee5f9c7bd73", "filename": "libgcc/unwind-dw2.c", "status": "modified", "additions": 12, "deletions": 29, "changes": 41, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d010efbfb89721bc9ca9e657e980ff0d8e6187af/libgcc%2Funwind-dw2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d010efbfb89721bc9ca9e657e980ff0d8e6187af/libgcc%2Funwind-dw2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Funwind-dw2.c?ref=d010efbfb89721bc9ca9e657e980ff0d8e6187af", "patch": "@@ -148,25 +148,9 @@ struct _Unwind_Context\n   char by_value[__LIBGCC_DWARF_FRAME_REGISTERS__+1];\n };\n \n-#ifdef __LIBGCC_DWARF_REG_SIZES_CONSTANT__\n-static inline unsigned char\n-dwarf_reg_size (int index __attribute__ ((__unused__)))\n-{\n-  return __LIBGCC_DWARF_REG_SIZES_CONSTANT__;\n-}\n-#else\n /* Byte size of every register managed by these routines.  */\n static unsigned char dwarf_reg_size_table[__LIBGCC_DWARF_FRAME_REGISTERS__+1];\n \n-\n-static inline unsigned char\n-dwarf_reg_size (unsigned index)\n-{\n-  gcc_assert (index < sizeof (dwarf_reg_size_table));\n-  return dwarf_reg_size_table[index];\n-}\n-#endif\n-\n \f\n /* Read unaligned data from the instruction buffer.  */\n \n@@ -248,7 +232,8 @@ _Unwind_GetGR (struct _Unwind_Context *context, int regno)\n #endif\n \n   index = DWARF_REG_TO_UNWIND_COLUMN (regno);\n-  size = dwarf_reg_size (index);\n+  gcc_assert (index < (int) sizeof(dwarf_reg_size_table));\n+  size = dwarf_reg_size_table[index];\n   val = context->reg[index];\n \n   if (_Unwind_IsExtendedContext (context) && context->by_value[index])\n@@ -295,7 +280,8 @@ _Unwind_SetGR (struct _Unwind_Context *context, int index, _Unwind_Word val)\n   void *ptr;\n \n   index = DWARF_REG_TO_UNWIND_COLUMN (index);\n-  size = dwarf_reg_size (index);\n+  gcc_assert (index < (int) sizeof(dwarf_reg_size_table));\n+  size = dwarf_reg_size_table[index];\n \n   if (_Unwind_IsExtendedContext (context) && context->by_value[index])\n     {\n@@ -343,8 +329,9 @@ _Unwind_SetGRValue (struct _Unwind_Context *context, int index,\n \t\t    _Unwind_Word val)\n {\n   index = DWARF_REG_TO_UNWIND_COLUMN (index);\n+  gcc_assert (index < (int) sizeof(dwarf_reg_size_table));\n   /* Return column size may be smaller than _Unwind_Context_Reg_Val.  */\n-  gcc_assert (dwarf_reg_size (index) <= sizeof (_Unwind_Context_Reg_Val));\n+  gcc_assert (dwarf_reg_size_table[index] <= sizeof (_Unwind_Context_Reg_Val));\n \n   context->by_value[index] = 1;\n   context->reg[index] = _Unwind_Get_Unwind_Context_Reg_Val (val);\n@@ -1400,7 +1387,7 @@ static inline void\n _Unwind_SetSpColumn (struct _Unwind_Context *context, void *cfa,\n \t\t     _Unwind_SpTmp *tmp_sp)\n {\n-  int size = dwarf_reg_size (__builtin_dwarf_sp_column ());\n+  int size = dwarf_reg_size_table[__builtin_dwarf_sp_column ()];\n \n   if (size == sizeof(_Unwind_Ptr))\n     tmp_sp->ptr = (_Unwind_Ptr) cfa;\n@@ -1586,13 +1573,11 @@ uw_advance_context (struct _Unwind_Context *context, _Unwind_FrameState *fs)\n     }\t\t\t\t\t\t\t\t\t   \\\n   while (0)\n \n-#ifndef __LIBGCC_DWARF_REG_SIZES_CONSTANT__\n static inline void\n init_dwarf_reg_size_table (void)\n {\n   __builtin_init_dwarf_reg_size_table (dwarf_reg_size_table);\n }\n-#endif\n \n static void __attribute__((noinline))\n uw_init_context_1 (struct _Unwind_Context *context,\n@@ -1611,18 +1596,16 @@ uw_init_context_1 (struct _Unwind_Context *context,\n   code = uw_frame_state_for (context, &fs);\n   gcc_assert (code == _URC_NO_REASON);\n \n-#ifndef __LIBGCC_DWARF_REG_SIZES_CONSTANT__\n-# if __GTHREADS\n+#if __GTHREADS\n   {\n     static __gthread_once_t once_regsizes = __GTHREAD_ONCE_INIT;\n     if (__gthread_once (&once_regsizes, init_dwarf_reg_size_table) != 0\n \t&& dwarf_reg_size_table[0] == 0)\n       init_dwarf_reg_size_table ();\n   }\n-# else\n+#else\n   if (dwarf_reg_size_table[0] == 0)\n     init_dwarf_reg_size_table ();\n-# endif\n #endif\n \n   /* Force the frame state to use the known cfa value.  */\n@@ -1699,20 +1682,20 @@ uw_install_context_1 (struct _Unwind_Context *current,\n \t{\n \t  _Unwind_Word w;\n \t  _Unwind_Ptr p;\n-\t  if (dwarf_reg_size (i) == sizeof (_Unwind_Word))\n+\t  if (dwarf_reg_size_table[i] == sizeof (_Unwind_Word))\n \t    {\n \t      w = (_Unwind_Internal_Ptr) t;\n \t      memcpy (c, &w, sizeof (_Unwind_Word));\n \t    }\n \t  else\n \t    {\n-\t      gcc_assert (dwarf_reg_size (i) == sizeof (_Unwind_Ptr));\n+\t      gcc_assert (dwarf_reg_size_table[i] == sizeof (_Unwind_Ptr));\n \t      p = (_Unwind_Internal_Ptr) t;\n \t      memcpy (c, &p, sizeof (_Unwind_Ptr));\n \t    }\n \t}\n       else if (t && c && t != c)\n-\tmemcpy (c, t, dwarf_reg_size (i));\n+\tmemcpy (c, t, dwarf_reg_size_table[i]);\n     }\n \n   /* If the current frame doesn't have a saved stack pointer, then we"}]}