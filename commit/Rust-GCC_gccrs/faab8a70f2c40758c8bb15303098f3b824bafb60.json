{"sha": "faab8a70f2c40758c8bb15303098f3b824bafb60", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmFhYjhhNzBmMmM0MDc1OGM4YmIxNTMwMzA5OGYzYjgyNGJhZmI2MA==", "commit": {"author": {"name": "Roman Zhuykov", "email": "zhroma@ispras.ru", "date": "2019-12-13T17:33:38Z"}, "committer": {"name": "Roman Zhuykov", "email": "zhroma@gcc.gnu.org", "date": "2019-12-13T17:33:38Z"}, "message": "modulo-sched: fix branch rescheduling issue (PR92591)\n\n\tPR rtl-optimization/92591\n\t* modulo-sched.c (ps_add_node_check_conflicts): Improve checking\n\tfor history > 0 case.\n\ntestsuite:\n\n\tPR rtl-optimization/92591\n\t* gcc.dg/pr92951-1.c: New test.\n\t* gcc.dg/pr92951-2.c: New test.\n\nFrom-SVN: r279377", "tree": {"sha": "38e16ed2a5fd5e9cd6d0de66e5197250d562efa3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/38e16ed2a5fd5e9cd6d0de66e5197250d562efa3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/faab8a70f2c40758c8bb15303098f3b824bafb60", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/faab8a70f2c40758c8bb15303098f3b824bafb60", "html_url": "https://github.com/Rust-GCC/gccrs/commit/faab8a70f2c40758c8bb15303098f3b824bafb60", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/faab8a70f2c40758c8bb15303098f3b824bafb60/comments", "author": {"login": "zhroma", "id": 23097573, "node_id": "MDQ6VXNlcjIzMDk3NTcz", "avatar_url": "https://avatars.githubusercontent.com/u/23097573?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zhroma", "html_url": "https://github.com/zhroma", "followers_url": "https://api.github.com/users/zhroma/followers", "following_url": "https://api.github.com/users/zhroma/following{/other_user}", "gists_url": "https://api.github.com/users/zhroma/gists{/gist_id}", "starred_url": "https://api.github.com/users/zhroma/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zhroma/subscriptions", "organizations_url": "https://api.github.com/users/zhroma/orgs", "repos_url": "https://api.github.com/users/zhroma/repos", "events_url": "https://api.github.com/users/zhroma/events{/privacy}", "received_events_url": "https://api.github.com/users/zhroma/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c420be8b3c5fd9e9d80dd583e790f0c2a7c4954b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c420be8b3c5fd9e9d80dd583e790f0c2a7c4954b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c420be8b3c5fd9e9d80dd583e790f0c2a7c4954b"}], "stats": {"total": 68, "additions": 53, "deletions": 15}, "files": [{"sha": "f8a56a4c289427c9ba3d582c84124151d1bf785d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=faab8a70f2c40758c8bb15303098f3b824bafb60", "patch": "@@ -1,3 +1,9 @@\n+2019-12-13  Roman Zhuykov  <zhroma@ispras.ru>\n+\n+\tPR rtl-optimization/92591\n+\t* modulo-sched.c (ps_add_node_check_conflicts): Improve checking\n+\tfor history > 0 case.\n+\n 2019-12-13  Roman Zhuykov  <zhroma@ispras.ru>\n \n \t* modulo-sched.c (sms_schedule): Use param_sms_max_ii_factor\n@@ -8,6 +14,7 @@\n \n 2019-12-13  Roman Zhuykov  <zhroma@ispras.ru>\n \n+\tPR rtl-optimization/90001\n \t* ddg.c (create_ddg): Init max_dist array for each node.\n \t(free_ddg): Free max_dist array.\n \t(create_ddg_edge): Use bool field instead of aux union."}, {"sha": "ddc2874fc7d815a11210276c3339fbd97601c49d", "filename": "gcc/modulo-sched.c", "status": "modified", "additions": 24, "deletions": 15, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Fmodulo-sched.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Fmodulo-sched.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fmodulo-sched.c?ref=faab8a70f2c40758c8bb15303098f3b824bafb60", "patch": "@@ -3197,31 +3197,40 @@ ps_add_node_check_conflicts (partial_schedule_ptr ps, int n,\n    \t\t\t     int c, sbitmap must_precede,\n \t\t\t     sbitmap must_follow)\n {\n-  int has_conflicts = 0;\n+  int i, first, amount, has_conflicts = 0;\n   ps_insn_ptr ps_i;\n \n   /* First add the node to the PS, if this succeeds check for\n      conflicts, trying different issue slots in the same row.  */\n   if (! (ps_i = add_node_to_ps (ps, n, c, must_precede, must_follow)))\n     return NULL; /* Failed to insert the node at the given cycle.  */\n \n-  has_conflicts = ps_has_conflicts (ps, c, c)\n-\t\t  || (ps->history > 0\n-\t\t      && ps_has_conflicts (ps,\n-\t\t\t\t\t   c - ps->history,\n-\t\t\t\t\t   c + ps->history));\n-\n-  /* Try different issue slots to find one that the given node can be\n-     scheduled in without conflicts.  */\n-  while (has_conflicts)\n+  while (1)\n     {\n+      has_conflicts = ps_has_conflicts (ps, c, c);\n+      if (ps->history > 0 && !has_conflicts)\n+\t{\n+\t  /* Check all 2h+1 intervals, starting from c-2h..c up to c..2h,\n+\t     but not more than ii intervals.  */\n+\t  first = c - ps->history;\n+\t  amount = 2 * ps->history + 1;\n+\t  if (amount > ps->ii)\n+\t    amount = ps->ii;\n+\t  for (i = first; i < first + amount; i++)\n+\t    {\n+\t      has_conflicts = ps_has_conflicts (ps,\n+\t\t\t\t\t\ti - ps->history,\n+\t\t\t\t\t\ti + ps->history);\n+\t      if (has_conflicts)\n+\t\tbreak;\n+\t    }\n+\t}\n+      if (!has_conflicts)\n+\tbreak;\n+      /* Try different issue slots to find one that the given node can be\n+\t scheduled in without conflicts.  */\n       if (! ps_insn_advance_column (ps, ps_i, must_follow))\n \tbreak;\n-      has_conflicts = ps_has_conflicts (ps, c, c)\n-\t\t      || (ps->history > 0\n-\t\t\t  && ps_has_conflicts (ps,\n-\t\t\t\t\t       c - ps->history,\n-\t\t\t\t\t       c + ps->history));\n     }\n \n   if (has_conflicts)"}, {"sha": "2a4d9a09b491fa4e0093b1f40715f0425279a75f", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=faab8a70f2c40758c8bb15303098f3b824bafb60", "patch": "@@ -1,3 +1,9 @@\n+2019-12-13  Roman Zhuykov  <zhroma@ispras.ru>\n+\n+\tPR rtl-optimization/92591\n+\t* gcc.dg/pr92951-1.c: New test.\n+\t* gcc.dg/pr92951-2.c: New test.\n+\n 2019-12-13  Dennis Zhang  <dennis.zhang@arm.com>\n \n \t* gcc.target/aarch64/pragma_cpp_predefs_2.c: Add tests for i8mm"}, {"sha": "0f9365d06e5f1e1515e3b54da0f976624513395a", "filename": "gcc/testsuite/gcc.dg/pr92951-1.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Ftestsuite%2Fgcc.dg%2Fpr92951-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Ftestsuite%2Fgcc.dg%2Fpr92951-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr92951-1.c?ref=faab8a70f2c40758c8bb15303098f3b824bafb60", "patch": "@@ -0,0 +1,11 @@\n+/* PR rtl-optimization/92591 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fmodulo-sched -fweb -fno-dce -fno-ivopts -fno-sched-pressure -fno-tree-loop-distribute-patterns --param sms-dfa-history=1\" } */\n+/* { dg-additional-options \"-mcpu=e500mc\" { target { powerpc-*-* } } } */\n+\n+void\n+wf (char *mr, int tc)\n+{\n+  while (tc-- > 0)\n+    *mr++ = 0;\n+}"}, {"sha": "04a80924650bc480b0acf88683b33d189bfd5ccc", "filename": "gcc/testsuite/gcc.dg/pr92951-2.c", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Ftestsuite%2Fgcc.dg%2Fpr92951-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/faab8a70f2c40758c8bb15303098f3b824bafb60/gcc%2Ftestsuite%2Fgcc.dg%2Fpr92951-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr92951-2.c?ref=faab8a70f2c40758c8bb15303098f3b824bafb60", "patch": "@@ -0,0 +1,5 @@\n+/* PR rtl-optimization/92591 */\n+/* { dg-do compile } */\n+/* { dg-options \"-Os -fmodulo-sched -fmodulo-sched-allow-regmoves --param sms-dfa-history=8\" } */\n+\n+#include \"../gcc.c-torture/execute/pr61682.c\""}]}