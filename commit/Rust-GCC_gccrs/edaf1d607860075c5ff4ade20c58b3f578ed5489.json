{"sha": "edaf1d607860075c5ff4ade20c58b3f578ed5489", "node_id": "C_kwDOANBUbNoAKGVkYWYxZDYwNzg2MDA3NWM1ZmY0YWRlMjBjNThiM2Y1NzhlZDU0ODk", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2023-02-15T10:20:32Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2023-02-15T10:21:11Z"}, "message": "libgomp: Fix reverse-offload for GOMP_MAP_TO_PSET\n\nlibgomp/\n\t* target.c (gomp_target_rev): Dereference ptr\n\tto get device address.\n\t* testsuite/libgomp.fortran/reverse-offload-5.f90: Add test\n\tfor unallocated allocatable.", "tree": {"sha": "0cf7e54a07af25ca400d326d5a6487b11d980afd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0cf7e54a07af25ca400d326d5a6487b11d980afd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/edaf1d607860075c5ff4ade20c58b3f578ed5489", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/edaf1d607860075c5ff4ade20c58b3f578ed5489", "html_url": "https://github.com/Rust-GCC/gccrs/commit/edaf1d607860075c5ff4ade20c58b3f578ed5489", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/edaf1d607860075c5ff4ade20c58b3f578ed5489/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7a9655be60cb4f224d1e5906bfe8ae227b5a3a0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c7a9655be60cb4f224d1e5906bfe8ae227b5a3a0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c7a9655be60cb4f224d1e5906bfe8ae227b5a3a0"}], "stats": {"total": 14, "additions": 11, "deletions": 3}, "files": [{"sha": "483851c95ac64a08f7c91551c6513a8c133ebec3", "filename": "libgomp/target.c", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/edaf1d607860075c5ff4ade20c58b3f578ed5489/libgomp%2Ftarget.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/edaf1d607860075c5ff4ade20c58b3f578ed5489/libgomp%2Ftarget.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftarget.c?ref=edaf1d607860075c5ff4ade20c58b3f578ed5489", "patch": "@@ -3580,8 +3580,14 @@ gomp_target_rev (uint64_t fn_ptr, uint64_t mapnum, uint64_t devaddrs_ptr,\n \t\t      }\n \t\t    int k;\n \t\t    n2 = NULL;\n-\t\t    cdata[i].present = true;\n+\t\t    /* Dereference devaddrs[j] to get the device addr.  */\n+\t\t    assert (devaddrs[j] - sizes[j] == cdata[i].devaddr);\n+\t\t    devaddrs[j] = *(uint64_t *) (uintptr_t) (devaddrs[i]\n+\t\t\t\t\t\t\t     + sizes[j]);\n+\t\t    cdata[j].present = true;\n \t\t    cdata[j].devaddr = devaddrs[j];\n+\t\t    if (devaddrs[j] == 0)\n+\t\t      continue;\n \t\t    k = gomp_map_cdata_lookup (cdata, devaddrs, kinds, sizes, j,\n \t\t\t\t\t       devaddrs[j],\n \t\t\t\t\t       devaddrs[j] + sizeof (void*),"}, {"sha": "16810eb47deb091dcf43e6260eb6630da51289cb", "filename": "libgomp/testsuite/libgomp.fortran/reverse-offload-5.f90", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/edaf1d607860075c5ff4ade20c58b3f578ed5489/libgomp%2Ftestsuite%2Flibgomp.fortran%2Freverse-offload-5.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/edaf1d607860075c5ff4ade20c58b3f578ed5489/libgomp%2Ftestsuite%2Flibgomp.fortran%2Freverse-offload-5.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Freverse-offload-5.f90?ref=edaf1d607860075c5ff4ade20c58b3f578ed5489", "patch": "@@ -24,7 +24,7 @@\n \n !$omp target map(to: A, A2, s1, s2)\n block\n-  integer, allocatable :: ai(:), ai2(:), si1, si2\n+  integer, allocatable :: ai(:), ai2(:), ai3(:), si1, si2, si3\n \n   a = a * 2\n   a2 = a2 * 3\n@@ -38,7 +38,7 @@\n \n   !$omp target device (ancestor:1)  &\n   !$omp&       map(to: A, s1, ai, si1) map(always, to: a2, s2)  &\n-  !$omp&       map(tofrom: ai2, si2)\n+  !$omp&       map(tofrom: ai2, si2, ai3, si3)\n     if (shared_mem) then\n       if (any (a  /= 2 * [1,2,3,4])) stop 1\n       if (s1 /= 4 * 532) stop 2\n@@ -52,6 +52,7 @@\n     if (any (ai2 /= [8,4,7,1])) stop 8\n     if (si1 /= 64) stop 9\n     if (si2 /= 765) stop 10\n+    if (allocated (ai3) .or. allocated(si3)) stop 26\n \n     a = a*3\n     a2 = a2*7\n@@ -80,6 +81,7 @@\n   endif\n   if (any (ai2 /= 21 * [8,4,7,1])) stop 24\n   if (si2 /= 31 * 765) stop 25\n+  if (allocated (ai3) .or. allocated(si3)) stop 27\n \n   deallocate (ai, ai2, si1, si2)\n end block"}]}