{"sha": "5bb1c2be88b8f99e050df8ec9052771b122b769f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWJiMWMyYmU4OGI4Zjk5ZTA1MGRmOGVjOTA1Mjc3MWIxMjJiNzY5Zg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2018-01-26T20:47:32Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2018-01-26T20:47:32Z"}, "message": "PR c++/83956 - wrong dtor error with anonymous union\n\n\t* method.c (walk_field_subobs): Variant members only affect\n\tdeletedness.\n\t(maybe_explain_implicit_delete): Pass &deleted_p for diagnostic.\n\nFrom-SVN: r257107", "tree": {"sha": "35108788c8a893b1a10902ad6cddbc1c02e047c8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/35108788c8a893b1a10902ad6cddbc1c02e047c8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5bb1c2be88b8f99e050df8ec9052771b122b769f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5bb1c2be88b8f99e050df8ec9052771b122b769f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5bb1c2be88b8f99e050df8ec9052771b122b769f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5bb1c2be88b8f99e050df8ec9052771b122b769f/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f8862a1b2afad9d107ad505de2bf554705ebdb38", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f8862a1b2afad9d107ad505de2bf554705ebdb38", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f8862a1b2afad9d107ad505de2bf554705ebdb38"}], "stats": {"total": 28, "additions": 27, "deletions": 1}, "files": [{"sha": "c526645e380d3e5d53813dd2174e7755dc41fd22", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5bb1c2be88b8f99e050df8ec9052771b122b769f/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5bb1c2be88b8f99e050df8ec9052771b122b769f/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=5bb1c2be88b8f99e050df8ec9052771b122b769f", "patch": "@@ -1,5 +1,10 @@\n 2018-01-26  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/83956 - wrong dtor error with anonymous union\n+\t* method.c (walk_field_subobs): Variant members only affect\n+\tdeletedness.\n+\t(maybe_explain_implicit_delete): Pass &deleted_p for diagnostic.\n+\n \tPR c++/84036 - ICE with variadic capture.\n \tPR c++/82249\n \t* pt.c (tsubst_pack_expansion): When optimizing a simple"}, {"sha": "33029d7967e6e658df3e5319b23d020838f4c562", "filename": "gcc/cp/method.c", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5bb1c2be88b8f99e050df8ec9052771b122b769f/gcc%2Fcp%2Fmethod.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5bb1c2be88b8f99e050df8ec9052771b122b769f/gcc%2Fcp%2Fmethod.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fmethod.c?ref=5bb1c2be88b8f99e050df8ec9052771b122b769f", "patch": "@@ -1305,6 +1305,15 @@ walk_field_subobs (tree fields, tree fnname, special_function_kind sfk,\n \t  || DECL_ARTIFICIAL (field))\n \tcontinue;\n \n+      /* Variant members only affect deletedness.  In particular, they don't\n+\t affect the exception-specification of a user-provided destructor,\n+\t which we're figuring out via get_defaulted_eh_spec.  So if we aren't\n+\t asking if this is deleted, don't even look up the function; we don't\n+\t want an error about a deleted function we aren't actually calling.  */\n+      if (sfk == sfk_destructor && deleted_p == NULL\n+\t  && TREE_CODE (DECL_CONTEXT (field)) == UNION_TYPE)\n+\tbreak;\n+\n       mem_type = strip_array_types (TREE_TYPE (field));\n       if (assign_p)\n \t{\n@@ -1850,7 +1859,7 @@ maybe_explain_implicit_delete (tree decl)\n \t\t      \"%q#D is implicitly deleted because the default \"\n \t\t      \"definition would be ill-formed:\", decl);\n \t      synthesized_method_walk (ctype, sfk, const_p,\n-\t\t\t\t       NULL, NULL, NULL, NULL, true,\n+\t\t\t\t       NULL, NULL, &deleted_p, NULL, true,\n \t\t\t\t       &inh, parms);\n \t    }\n \t  else if (!comp_except_specs"}, {"sha": "38c91f41a5c952ec32adc9dfda5e4ad99e1a94b8", "filename": "gcc/testsuite/g++.dg/cpp0x/anon-union2.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5bb1c2be88b8f99e050df8ec9052771b122b769f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fanon-union2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5bb1c2be88b8f99e050df8ec9052771b122b769f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fanon-union2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fanon-union2.C?ref=5bb1c2be88b8f99e050df8ec9052771b122b769f", "patch": "@@ -0,0 +1,12 @@\n+// PR c++/83956\n+// { dg-do compile { target c++11 } }\n+\n+struct a {\n+  ~a() = delete;\n+};\n+struct b {\n+  ~b() {}\n+  union {\n+    a c;\n+  };\n+};"}]}