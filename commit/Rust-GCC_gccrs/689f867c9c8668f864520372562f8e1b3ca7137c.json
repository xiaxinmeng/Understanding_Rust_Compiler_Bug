{"sha": "689f867c9c8668f864520372562f8e1b3ca7137c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njg5Zjg2N2M5Yzg2NjhmODY0NTIwMzcyNTYyZjhlMWIzY2E3MTM3Yw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2017-01-20T04:43:13Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2017-01-20T04:43:13Z"}, "message": "US 19 - deduction guides and constructors\n\n\t* call.c (joust): Prefer deduction guides to constructors.\n\t* pt.c (build_deduction_guide): Set DECL_ARTIFICIAL.\n\t(deduction_guide_p): Check DECL_P.\n\nFrom-SVN: r244681", "tree": {"sha": "1c8ef26acf7c7f2e37d0cd34a5c207a850688c04", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1c8ef26acf7c7f2e37d0cd34a5c207a850688c04"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/689f867c9c8668f864520372562f8e1b3ca7137c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/689f867c9c8668f864520372562f8e1b3ca7137c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/689f867c9c8668f864520372562f8e1b3ca7137c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/689f867c9c8668f864520372562f8e1b3ca7137c/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "a3a1620bb840d62dbde06ce0290e8e5cfcbbf18b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a3a1620bb840d62dbde06ce0290e8e5cfcbbf18b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a3a1620bb840d62dbde06ce0290e8e5cfcbbf18b"}], "stats": {"total": 48, "additions": 46, "deletions": 2}, "files": [{"sha": "e16853971fb30f906c5282e6d3dfca60f297c9f0", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=689f867c9c8668f864520372562f8e1b3ca7137c", "patch": "@@ -1,5 +1,10 @@\n 2017-01-19  Jason Merrill  <jason@redhat.com>\n \n+\tUS 19 - deduction guides and constructors\n+\t* call.c (joust): Prefer deduction guides to constructors.\n+\t* pt.c (build_deduction_guide): Set DECL_ARTIFICIAL.\n+\t(deduction_guide_p): Check DECL_P.\n+\n \t* decl.c (check_initializer): Always use build_aggr_init for array\n \tdecomposition.\n "}, {"sha": "0059a395ae4474d370b86e1209f8e6e1e61bdba7", "filename": "gcc/cp/call.c", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Fcp%2Fcall.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Fcp%2Fcall.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcall.c?ref=689f867c9c8668f864520372562f8e1b3ca7137c", "patch": "@@ -9633,6 +9633,18 @@ joust (struct z_candidate *cand1, struct z_candidate *cand2, bool warn,\n \treturn winner;\n     }\n \n+  /* F1 is generated from a deduction-guide (13.3.1.8) and F2 is not */\n+  if (deduction_guide_p (cand1->fn))\n+    {\n+      gcc_assert (deduction_guide_p (cand2->fn));\n+      /* We distinguish between candidates from an explicit deduction guide and\n+\t candidates built from a constructor based on DECL_ARTIFICIAL.  */\n+      int art1 = DECL_ARTIFICIAL (cand1->fn);\n+      int art2 = DECL_ARTIFICIAL (cand2->fn);\n+      if (art1 != art2)\n+\treturn art2 - art1;\n+    }\n+\n   /* or, if not that,\n      F1 is a non-template function and F2 is a template function\n      specialization.  */"}, {"sha": "f683727e9775ecc0db4d6ad2f344d069333a7294", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=689f867c9c8668f864520372562f8e1b3ca7137c", "patch": "@@ -24776,8 +24776,9 @@ dguide_name_p (tree name)\n bool\n deduction_guide_p (tree fn)\n {\n-  if (tree name = DECL_NAME (fn))\n-    return dguide_name_p (name);\n+  if (DECL_P (fn))\n+    if (tree name = DECL_NAME (fn))\n+      return dguide_name_p (name);\n   return false;\n }\n \n@@ -24981,7 +24982,9 @@ build_deduction_guide (tree ctor, tree outer_args, tsubst_flags_t complain)\n \t\t\t\t     FUNCTION_DECL,\n \t\t\t\t     dguide_name (type), fntype);\n   DECL_ARGUMENTS (ded_fn) = fargs;\n+  DECL_ARTIFICIAL (ded_fn) = true;\n   tree ded_tmpl = build_template_decl (ded_fn, tparms, /*member*/false);\n+  DECL_ARTIFICIAL (ded_tmpl) = true;\n   DECL_TEMPLATE_RESULT (ded_tmpl) = ded_fn;\n   TREE_TYPE (ded_tmpl) = TREE_TYPE (ded_fn);\n   DECL_TEMPLATE_INFO (ded_fn) = build_template_info (ded_tmpl, targs);"}, {"sha": "07ab5f5738cf47c2b4d72c4e7fed03e172d13d0b", "filename": "gcc/testsuite/g++.dg/cpp1z/class-deduction25.C", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1z%2Fclass-deduction25.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689f867c9c8668f864520372562f8e1b3ca7137c/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1z%2Fclass-deduction25.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1z%2Fclass-deduction25.C?ref=689f867c9c8668f864520372562f8e1b3ca7137c", "patch": "@@ -0,0 +1,24 @@\n+// Testcase from P0512R0 for C++17 NB comment US 19\n+// { dg-options -std=c++1z }\n+\n+template<typename> struct remove_ref;\n+template<typename _Tp> struct remove_ref { typedef _Tp type; };\n+template<typename _Tp> struct remove_ref<_Tp&> { typedef _Tp type; };\n+template<typename _Tp> struct remove_ref<_Tp&&> { typedef _Tp type; };\n+template<typename _Tp> using remove_ref_t = typename remove_ref<_Tp>::type;\n+\n+template<class T> struct A {\n+ A(T, int*); // #1\n+ A(A<T>&, int*); // #2\n+ enum { value };\n+};\n+template<class T, int N = remove_ref_t<T>::value> A(T&&, int*) -> A<T>; //#3\n+\n+A a{1,0}; // uses #1 to deduce A<int> and initializes with #1\n+A b{a,0}; // uses #3 (not #2) to deduce A<A<int>&> and initializes with #1\n+\n+template <class,class> struct same;\n+template <class T> struct same<T,T> {};\n+\n+same<decltype(a),A<int>> s1;\n+same<decltype(b),A<A<int>&>> s2;"}]}