{"sha": "480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDgwYzY5NmJiMGYzMjUzYzlhNTNkOWMyYmUyZTI5ZTFlNWRmZmRjNg==", "commit": {"author": {"name": "Torvald Riegel", "email": "triegel@redhat.com", "date": "2013-06-20T16:40:54Z"}, "committer": {"name": "Torvald Riegel", "email": "torvald@gcc.gnu.org", "date": "2013-06-20T16:40:54Z"}, "message": "libitm: Handle HTM fastpath in status query functions.\n\n\t* query.cc (_ITM_inTransaction): Abort when using the HTM fastpath.\n\t(_ITM_getTransactionId): Same.\n\t* config/x86/target.h (htm_transaction_active): New.\n\nFrom-SVN: r200251", "tree": {"sha": "f73b28638776b1747b490781d1297b42620eb10e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f73b28638776b1747b490781d1297b42620eb10e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/comments", "author": {"login": "triegelrh", "id": 62400967, "node_id": "MDQ6VXNlcjYyNDAwOTY3", "avatar_url": "https://avatars.githubusercontent.com/u/62400967?v=4", "gravatar_id": "", "url": "https://api.github.com/users/triegelrh", "html_url": "https://github.com/triegelrh", "followers_url": "https://api.github.com/users/triegelrh/followers", "following_url": "https://api.github.com/users/triegelrh/following{/other_user}", "gists_url": "https://api.github.com/users/triegelrh/gists{/gist_id}", "starred_url": "https://api.github.com/users/triegelrh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/triegelrh/subscriptions", "organizations_url": "https://api.github.com/users/triegelrh/orgs", "repos_url": "https://api.github.com/users/triegelrh/repos", "events_url": "https://api.github.com/users/triegelrh/events{/privacy}", "received_events_url": "https://api.github.com/users/triegelrh/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "b1db457bf9ac2c086273c8863b94b3bf814a6dd9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b1db457bf9ac2c086273c8863b94b3bf814a6dd9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b1db457bf9ac2c086273c8863b94b3bf814a6dd9"}], "stats": {"total": 27, "additions": 27, "deletions": 0}, "files": [{"sha": "81e5b6f447ba7ab90954fd36b287c2a79ffd8339", "filename": "libitm/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/libitm%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/libitm%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libitm%2FChangeLog?ref=480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "patch": "@@ -1,3 +1,9 @@\n+2013-06-20  Torvald Riegel  <triegel@redhat.com>\n+\n+\t* query.cc (_ITM_inTransaction): Abort when using the HTM fastpath.\n+\t(_ITM_getTransactionId): Same.\n+\t* config/x86/target.h (htm_transaction_active): New.\n+\n 2013-06-20  Torvald Riegel  <triegel@redhat.com>\n \n \tPR libitm/57643"}, {"sha": "063c09ed974292e8c59635398d547b334c11624e", "filename": "libitm/config/x86/target.h", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/libitm%2Fconfig%2Fx86%2Ftarget.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/libitm%2Fconfig%2Fx86%2Ftarget.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libitm%2Fconfig%2Fx86%2Ftarget.h?ref=480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "patch": "@@ -125,6 +125,13 @@ htm_abort_should_retry (uint32_t begin_ret)\n {\n   return begin_ret & _XABORT_RETRY;\n }\n+\n+/* Returns true iff a hardware transaction is currently being executed.  */\n+static inline bool\n+htm_transaction_active ()\n+{\n+  return _xtest() != 0;\n+}\n #endif\n \n "}, {"sha": "39a35b3e3b9492132779abc6fd4e702e345b08a6", "filename": "libitm/query.cc", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/libitm%2Fquery.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6/libitm%2Fquery.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libitm%2Fquery.cc?ref=480c696bb0f3253c9a53d9c2be2e29e1e5dffdc6", "patch": "@@ -43,6 +43,15 @@ _ITM_libraryVersion (void)\n _ITM_howExecuting ITM_REGPARM\n _ITM_inTransaction (void)\n {\n+#if defined(USE_HTM_FASTPATH)\n+  // If we use the HTM fastpath, we cannot reliably detect whether we are\n+  // in a transaction because this function can be called outside of\n+  // a transaction and thus we can't deduce this by looking at just the serial\n+  // lock.  This function isn't used in practice currently, so the easiest\n+  // way to handle it is to just abort.\n+  if (htm_fastpath && htm_transaction_active())\n+    htm_abort();\n+#endif\n   struct gtm_thread *tx = gtm_thr();\n   if (tx && (tx->nesting > 0))\n     {\n@@ -58,6 +67,11 @@ _ITM_inTransaction (void)\n _ITM_transactionId_t ITM_REGPARM\n _ITM_getTransactionId (void)\n {\n+#if defined(USE_HTM_FASTPATH)\n+  // See ITM_inTransaction.\n+  if (htm_fastpath && htm_transaction_active())\n+    htm_abort();\n+#endif\n   struct gtm_thread *tx = gtm_thr();\n   return (tx && (tx->nesting > 0)) ? tx->id : _ITM_noTransactionId;\n }"}]}