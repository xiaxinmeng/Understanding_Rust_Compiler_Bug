{"sha": "2d3c477599b02b06e338acd5f5098ee7a3fe6176", "node_id": "C_kwDOANBUbNoAKDJkM2M0Nzc1OTliMDJiMDZlMzM4YWNkNWY1MDk4ZWU3YTNmZTYxNzY", "commit": {"author": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2022-02-09T14:21:08Z"}, "committer": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2022-02-09T14:23:17Z"}, "message": "[PATCH] PR tree-optimization/104420: Fix checks for constant folding X*0.0\n\nThis patch resolves PR tree-optimization/104420, which is a P1 regression\nwhere, as observed by Jakub Jelinek, the conditions for constant folding\nx*0.0 are incorrect (following my patch for PR tree-optimization/96392).\nThe multiplication x*0.0 may yield a negative zero result, -0.0, if X is\nnegative (not just if x may be negative zero).  Hence (without -ffast-math)\n(int)x*0.0 can't be optimized to 0.0, but (unsigned)x*0.0 can be constant\nfolded.  This adds a bunch of test cases to confirm the desired behaviour,\nand removes an incorrect test from gcc.dg/pr96392.c which checked for the\nwrong behaviour.\n\n2022-02-09  Roger Sayle  <roger@nextmovesoftware.com>\n\ngcc/ChangeLog\n\tPR tree-optimization/104420\n\t* match.pd (mult @0 real_zerop): Tweak conditions for constant\n\tfolding X*0.0 (or X*-0.0) to HONOR_SIGNED_ZEROS when appropriate.\n\ngcc/testsuite/ChangeLog\n\tPR tree-optimization/104420\n\t* gcc.dg/pr104420-1.c: New test case.\n\t* gcc.dg/pr104420-2.c: New test case.\n\t* gcc.dg/pr104420-3.c: New test case.\n\t* gcc.dg/pr104420-4.c: New test case.\n\t* gcc.dg/pr96392.c: Remove incorrect test.", "tree": {"sha": "8b4b47886d584fd019a8e03583e4ce58ed66f84b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8b4b47886d584fd019a8e03583e4ce58ed66f84b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2d3c477599b02b06e338acd5f5098ee7a3fe6176", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d3c477599b02b06e338acd5f5098ee7a3fe6176", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2d3c477599b02b06e338acd5f5098ee7a3fe6176", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d3c477599b02b06e338acd5f5098ee7a3fe6176/comments", "author": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "be9cd0ca8a5f13cfee6a39b217d439a25c53553a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/be9cd0ca8a5f13cfee6a39b217d439a25c53553a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/be9cd0ca8a5f13cfee6a39b217d439a25c53553a"}], "stats": {"total": 49, "additions": 41, "deletions": 8}, "files": [{"sha": "4fe590983f3dfdb037f241f3e9dc21c648905416", "filename": "gcc/match.pd", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Fmatch.pd", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Fmatch.pd", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fmatch.pd?ref=2d3c477599b02b06e338acd5f5098ee7a3fe6176", "patch": "@@ -262,8 +262,7 @@ DEFINE_INT_AND_FLOAT_ROUND_FN (RINT)\n  (mult @0 real_zerop@1)\n  (if (!tree_expr_maybe_nan_p (@0)\n       && (!HONOR_NANS (type) || !tree_expr_maybe_infinite_p (@0))\n-      && !tree_expr_maybe_real_minus_zero_p (@0)\n-      && !tree_expr_maybe_real_minus_zero_p (@1))\n+      && (!HONOR_SIGNED_ZEROS (type) || tree_expr_nonnegative_p (@0)))\n   @1))\n \n /* In IEEE floating point, x*1 is not equivalent to x for snans."}, {"sha": "48385fae0ba353c9d35b50b7ee320d83f379a339", "filename": "gcc/testsuite/gcc.dg/pr104420-1.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-1.c?ref=2d3c477599b02b06e338acd5f5098ee7a3fe6176", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-optimized\" } */\n+/* { dg-add-options ieee } */\n+\n+double f(int a)\n+{\n+  return a * 0.0;\n+}\n+\n+/* { dg-final { scan-tree-dump \" \\\\\\* 0.0\" \"optimized\" } } */"}, {"sha": "49d0189672252b5e693d2e75a12e66e2a2191119", "filename": "gcc/testsuite/gcc.dg/pr104420-2.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-2.c?ref=2d3c477599b02b06e338acd5f5098ee7a3fe6176", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-optimized\" } */\n+/* { dg-add-options ieee } */\n+\n+double f(int a)\n+{\n+  return a * -0.0;\n+}\n+\n+/* { dg-final { scan-tree-dump \" \\\\\\* -0.0\" \"optimized\" } } */"}, {"sha": "962dfff9cd4898b4e49236968774fcfe0848b45e", "filename": "gcc/testsuite/gcc.dg/pr104420-3.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-3.c?ref=2d3c477599b02b06e338acd5f5098ee7a3fe6176", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-optimized\" } */\n+/* { dg-add-options ieee } */\n+\n+double f(unsigned int a)\n+{\n+  return a * 0.0;\n+}\n+\n+/* { dg-final { scan-tree-dump \"return 0.0\" \"optimized\" } } */"}, {"sha": "95ed0cc18dcf762aa93e028f90178147159aa575", "filename": "gcc/testsuite/gcc.dg/pr104420-4.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104420-4.c?ref=2d3c477599b02b06e338acd5f5098ee7a3fe6176", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-optimized\" } */\n+/* { dg-add-options ieee } */\n+\n+double f(unsigned int a)\n+{\n+  return a * -0.0;\n+}\n+\n+/* { dg-final { scan-tree-dump \"return -0.0\" \"optimized\" } } */"}, {"sha": "fb7de217f966b7152656e3ab2a6c65c783835ca6", "filename": "gcc/testsuite/gcc.dg/pr96392.c", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr96392.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d3c477599b02b06e338acd5f5098ee7a3fe6176/gcc%2Ftestsuite%2Fgcc.dg%2Fpr96392.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr96392.c?ref=2d3c477599b02b06e338acd5f5098ee7a3fe6176", "patch": "@@ -12,11 +12,6 @@ double sub0(int x)\n   return x - 0.0;\n }\n \n-double mult0(int x)\n-{\n-  return 0.0 * x;\n-}\n-\n double negate(int x)\n {\n   return 0.0 - x;\n@@ -29,5 +24,4 @@ double subtract(int x)\n \n /* { dg-final { scan-tree-dump-not \" \\\\+ \" \"optimized\" } } */\n /* { dg-final { scan-tree-dump-not \" \\\\- \" \"optimized\" } } */\n-/* { dg-final { scan-tree-dump-not \" \\\\* \" \"optimized\" } } */\n "}]}