{"sha": "0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MGNhZjQwMGE4NjVjYjc3MWY3NmJmMTAyNWNmYzJhODNlOGVmMDBlZA==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-11-03T08:55:58Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-11-03T08:55:58Z"}, "message": "Fortran: Add !GCC$ attributes DEPRECATED\n\ngcc/fortran/ChangeLog:\n\n\t* decl.c (ext_attr_list): Add EXT_ATTR_DEPRECATED.\n\t* gfortran.h (ext_attr_id_t): Ditto.\n\t* gfortran.texi (GCC$ ATTRIBUTES): Document it.\n\t* resolve.c (resolve_variable, resolve_function,\n\tresolve_call, resolve_values): Show -Wdeprecated-declarations warning.\n\t* trans-decl.c (add_attributes_to_decl): Skip those\n\twith no middle_end_name.\n\ngcc/testsuite/ChangeLog:\n\n\t* gfortran.dg/attr_deprecated.f90: New test.", "tree": {"sha": "259379fab27182a6be222d90c4f7ff3ca0778481", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/259379fab27182a6be222d90c4f7ff3ca0778481"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "682ed7ad230f6177aadc060788e6f4a0780d8860", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/682ed7ad230f6177aadc060788e6f4a0780d8860", "html_url": "https://github.com/Rust-GCC/gccrs/commit/682ed7ad230f6177aadc060788e6f4a0780d8860"}], "stats": {"total": 57, "additions": 56, "deletions": 1}, "files": [{"sha": "93a155c5f75f01355c51e1ce73bd04fac2202523", "filename": "gcc/fortran/decl.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fdecl.c?ref=0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "patch": "@@ -11585,6 +11585,7 @@ const ext_attr_t ext_attr_list[] = {\n   { \"stdcall\",      EXT_ATTR_STDCALL,      \"stdcall\"   },\n   { \"fastcall\",     EXT_ATTR_FASTCALL,     \"fastcall\"  },\n   { \"no_arg_check\", EXT_ATTR_NO_ARG_CHECK, NULL        },\n+  { \"deprecated\",   EXT_ATTR_DEPRECATED,   NULL\t       },\n   { NULL,           EXT_ATTR_LAST,         NULL        }\n };\n "}, {"sha": "dfd7796cce0b3e3c872c1c359d18302acb241cc5", "filename": "gcc/fortran/gfortran.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.h?ref=0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "patch": "@@ -770,6 +770,7 @@ typedef enum\n   EXT_ATTR_CDECL,\n   EXT_ATTR_FASTCALL,\n   EXT_ATTR_NO_ARG_CHECK,\n+  EXT_ATTR_DEPRECATED,\n   EXT_ATTR_LAST, EXT_ATTR_NUM = EXT_ATTR_LAST\n }\n ext_attr_id_t;"}, {"sha": "453b30f7c614389dc9db93f69cdbcc842328fa45", "filename": "gcc/fortran/gfortran.texi", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fgfortran.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fgfortran.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.texi?ref=0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "patch": "@@ -3639,6 +3639,9 @@ requires an explicit interface.\n \n @itemize\n @item @code{NO_ARG_CHECK} -- disable the type, kind and rank checking\n+@item @code{DEPRECATED} -- print a warning when using a such-tagged\n+deprecated procedure, variable or parameter; the warning can be suppressed\n+with @option{-Wno-deprecated-declarations}.\n @end itemize\n \n "}, {"sha": "1641eb6ca105072df18c0cf794ed25fe6b86a9be", "filename": "gcc/fortran/resolve.c", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fresolve.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Fresolve.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fresolve.c?ref=0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "patch": "@@ -3404,6 +3404,11 @@ resolve_function (gfc_expr *expr)\n     /* typebound procedure: Assume the worst.  */\n     gfc_current_ns->proc_name->attr.array_outer_dependency = 1;\n \n+  if (expr->value.function.esym\n+      && expr->value.function.esym->attr.ext_attr & (1 << EXT_ATTR_DEPRECATED))\n+    gfc_warning (OPT_Wdeprecated_declarations,\n+\t\t \"Using function %qs at %L is deprecated\",\n+\t\t sym->name, &expr->where);\n   return t;\n }\n \n@@ -3747,6 +3752,12 @@ resolve_call (gfc_code *c)\n     /* Typebound procedure: Assume the worst.  */\n     gfc_current_ns->proc_name->attr.array_outer_dependency = 1;\n \n+  if (c->resolved_sym\n+      && c->resolved_sym->attr.ext_attr & (1 << EXT_ATTR_DEPRECATED))\n+    gfc_warning (OPT_Wdeprecated_declarations,\n+\t\t \"Using subroutine %qs at %L is deprecated\",\n+\t\t c->resolved_sym->name, &c->loc);\n+\n   return t;\n }\n \n@@ -5917,6 +5928,10 @@ resolve_variable (gfc_expr *e)\n   if (t && flag_coarray == GFC_FCOARRAY_LIB && gfc_is_coindexed (e))\n     add_caf_get_intrinsic (e);\n \n+  if (sym->attr.ext_attr & (1 << EXT_ATTR_DEPRECATED) && sym != sym->result)\n+    gfc_warning (OPT_Wdeprecated_declarations,\n+\t\t \"Using variable %qs at %L is deprecated\",\n+\t\t sym->name, &e->where);\n   /* Simplify cases where access to a parameter array results in a\n      single constant.  Suppress errors since those will have been\n      issued before, as warnings.  */\n@@ -12232,6 +12247,11 @@ resolve_values (gfc_symbol *sym)\n   if (sym->value == NULL)\n     return;\n \n+  if (sym->attr.ext_attr & (1 << EXT_ATTR_DEPRECATED))\n+    gfc_warning (OPT_Wdeprecated_declarations,\n+\t\t \"Using parameter %qs declared at %L is deprecated\",\n+\t\t sym->name, &sym->declared_at);\n+\n   if (sym->value->expr_type == EXPR_STRUCTURE)\n     t= resolve_structure_cons (sym->value, 1);\n   else"}, {"sha": "cdef753ea8dff0e7e9d1b16dfaa9e0babf3cb11a", "filename": "gcc/fortran/trans-decl.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Ftrans-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ffortran%2Ftrans-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.c?ref=0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "patch": "@@ -1427,7 +1427,7 @@ add_attributes_to_decl (symbol_attribute sym_attr, tree list)\n   tree attr;\n \n   for (id = 0; id < EXT_ATTR_NUM; id++)\n-    if (sym_attr.ext_attr & (1 << id))\n+    if (sym_attr.ext_attr & (1 << id) && ext_attr_list[id].middle_end_name)\n       {\n \tattr = build_tree_list (\n \t\t get_identifier (ext_attr_list[id].middle_end_name),"}, {"sha": "aa3f5138a6c905d4e46c0e3a5de998807b46247e", "filename": "gcc/testsuite/gfortran.dg/attr_deprecated.f90", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ftestsuite%2Fgfortran.dg%2Fattr_deprecated.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0caf400a865cb771f76bf1025cfc2a83e8ef00ed/gcc%2Ftestsuite%2Fgfortran.dg%2Fattr_deprecated.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fattr_deprecated.f90?ref=0caf400a865cb771f76bf1025cfc2a83e8ef00ed", "patch": "@@ -0,0 +1,30 @@\n+! { dg-do compile }\n+\n+module m\n+  implicit none\n+  integer :: A\n+  integer, parameter :: PARM = 5  ! { dg-warning \"Using parameter 'parm' declared at .1. is deprecated\" }\n+!GCC$ ATTRIBUTES  DEPRECATED :: A, foo, func, parm\n+contains\n+subroutine foo\n+end\n+integer function func()\n+  func = 42\n+end\n+subroutine bar\n+  integer :: i\n+  call foo    ! { dg-warning \"Using subroutine 'foo' at .1. is deprecated\" }\n+  print *, A  ! { dg-warning \"Using variable 'a' at .1. is deprecated\" }\n+  i = func()  ! { dg-warning \"Using function 'func' at .1. is deprecated\" }\n+  print *, PARM\n+end\n+  \n+end module m\n+\n+use m  ! { dg-warning \"Using parameter 'parm' declared at .1. is deprecated\" }\n+  integer :: i\n+  call foo  ! { dg-warning \"Using subroutine 'foo' at .1. is deprecated\" }\n+  print *, A  ! { dg-warning \"Using variable 'a' at .1. is deprecated\" }\n+  i = func()  ! { dg-warning \"Using function 'func' at .1. is deprecated\" }\n+  print *, PARM\n+end"}]}