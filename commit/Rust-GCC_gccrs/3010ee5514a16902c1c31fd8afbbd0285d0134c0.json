{"sha": "3010ee5514a16902c1c31fd8afbbd0285d0134c0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzAxMGVlNTUxNGExNjkwMmMxYzMxZmQ4YWZiYmQwMjg1ZDAxMzRjMA==", "commit": {"author": {"name": "Olivier Hainque", "email": "hainque@adacore.com", "date": "2019-08-13T11:04:52Z"}, "committer": {"name": "Olivier Hainque", "email": "hainque@gcc.gnu.org", "date": "2019-08-13T11:04:52Z"}, "message": "Handle casesi dispatch tablejumps in create_trace_edges (as well)\n\n\t* rtlanal.c (tablejump_casesi_pattern): New function, to\n\tdetermine if a tablejump insn is a casesi dispatcher. Extracted\n\tfrom patch_jump_insn.\n\t* rtl.h (tablejump_casesi_pattern): Declare.\n\t* cfgrtl.c (patch_jump_insn): Use it.\n\t* dwarf2cfi.c (create_trace_edges): Use it.\n\ntestsuite/\n\n\t* gnat.dg/casesi.ad[bs], test_casesi.adb: New test.\n\nFrom-SVN: r274377", "tree": {"sha": "a86ebb4ea1de27932e3f5b6d6b3446334d6e4f1e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a86ebb4ea1de27932e3f5b6d6b3446334d6e4f1e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3010ee5514a16902c1c31fd8afbbd0285d0134c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3010ee5514a16902c1c31fd8afbbd0285d0134c0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3010ee5514a16902c1c31fd8afbbd0285d0134c0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3010ee5514a16902c1c31fd8afbbd0285d0134c0/comments", "author": {"login": "hainque", "id": 18735142, "node_id": "MDQ6VXNlcjE4NzM1MTQy", "avatar_url": "https://avatars.githubusercontent.com/u/18735142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hainque", "html_url": "https://github.com/hainque", "followers_url": "https://api.github.com/users/hainque/followers", "following_url": "https://api.github.com/users/hainque/following{/other_user}", "gists_url": "https://api.github.com/users/hainque/gists{/gist_id}", "starred_url": "https://api.github.com/users/hainque/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hainque/subscriptions", "organizations_url": "https://api.github.com/users/hainque/orgs", "repos_url": "https://api.github.com/users/hainque/repos", "events_url": "https://api.github.com/users/hainque/events{/privacy}", "received_events_url": "https://api.github.com/users/hainque/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "fb802d91461a2d65e9618abb6298c6ca7d39e7d7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fb802d91461a2d65e9618abb6298c6ca7d39e7d7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fb802d91461a2d65e9618abb6298c6ca7d39e7d7"}], "stats": {"total": 87, "additions": 83, "deletions": 4}, "files": [{"sha": "aa036ca8c52f0c194c29976a206a63509fd6b4a6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -1,3 +1,12 @@\n+2019-08-13  Olivier Hainque  <hainque@adacore.com>\n+\n+\t* rtlanal.c (tablejump_casesi_pattern): New function, to\n+\tdetermine if a tablejump insn is a casesi dispatcher. Extracted\n+\tfrom patch_jump_insn.\n+\t* rtl.h (tablejump_casesi_pattern): Declare.\n+\t* cfgrtl.c (patch_jump_insn): Use it.\n+\t* dwarf2cfi.c (create_trace_edges): Use it.\n+\n 2019-08-13  Wilco Dijkstra  <wdijkstr@arm.com>  \n \n \tPR target/81800"}, {"sha": "39fc7aa36bf4e2752f22fd5a527c6efd8e58cd7c", "filename": "gcc/cfgrtl.c", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Fcfgrtl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Fcfgrtl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfgrtl.c?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -1214,10 +1214,7 @@ patch_jump_insn (rtx_insn *insn, rtx_insn *old_label, basic_block new_bb)\n \t  }\n \n       /* Handle casesi dispatch insns.  */\n-      if ((tmp = single_set (insn)) != NULL\n-\t  && SET_DEST (tmp) == pc_rtx\n-\t  && GET_CODE (SET_SRC (tmp)) == IF_THEN_ELSE\n-\t  && GET_CODE (XEXP (SET_SRC (tmp), 2)) == LABEL_REF\n+      if ((tmp = tablejump_casesi_pattern (insn)) != NULL_RTX\n \t  && label_ref_label (XEXP (SET_SRC (tmp), 2)) == old_label)\n \t{\n \t  XEXP (SET_SRC (tmp), 2) = gen_rtx_LABEL_REF (Pmode,"}, {"sha": "95ba0f71026408f74634f640de7dc17f15fee987", "filename": "gcc/dwarf2cfi.c", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Fdwarf2cfi.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Fdwarf2cfi.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdwarf2cfi.c?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -2445,6 +2445,13 @@ create_trace_edges (rtx_insn *insn)\n \t      rtx_insn *lab = as_a <rtx_insn *> (XEXP (RTVEC_ELT (vec, i), 0));\n \t      maybe_record_trace_start (lab, insn);\n \t    }\n+\n+\t  /* Handle casesi dispatch insns.  */\n+\t  if ((tmp = tablejump_casesi_pattern (insn)) != NULL_RTX)\n+\t    {\n+\t      rtx_insn * lab = label_ref_label (XEXP (SET_SRC (tmp), 2));\n+\t      maybe_record_trace_start (lab, insn);\n+\t    }\n \t}\n       else if (computed_jump_p (insn))\n \t{"}, {"sha": "bb67a133142edaf04b8326a0606be2bc59e2040f", "filename": "gcc/rtl.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Frtl.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Frtl.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frtl.h?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -2945,6 +2945,7 @@ extern rtvec shallow_copy_rtvec (rtvec);\n extern bool shared_const_p (const_rtx);\n extern rtx copy_rtx (rtx);\n extern enum rtx_code classify_insn (rtx);\n+extern rtx tablejump_casesi_pattern (const rtx_insn *insn);\n extern void dump_rtx_statistics (void);\n \n /* In emit-rtl.c */"}, {"sha": "3c5a64e076189ce4da6266a4201aaaaa6b8697ab", "filename": "gcc/rtlanal.c", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Frtlanal.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Frtlanal.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frtlanal.c?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -3272,6 +3272,23 @@ tablejump_p (const rtx_insn *insn, rtx_insn **labelp,\n   return true;\n }\n \n+/* For INSN known to satisfy tablejump_p, determine if it actually is a\n+   CASESI.  Return the insn pattern if so, NULL_RTX otherwise.  */\n+\n+rtx\n+tablejump_casesi_pattern (const rtx_insn *insn)\n+{\n+  rtx tmp;\n+\n+  if ((tmp = single_set (insn)) != NULL\n+      && SET_DEST (tmp) == pc_rtx\n+      && GET_CODE (SET_SRC (tmp)) == IF_THEN_ELSE\n+      && GET_CODE (XEXP (SET_SRC (tmp), 2)) == LABEL_REF)\n+    return tmp;\n+\n+  return NULL_RTX;\n+}\n+\n /* A subroutine of computed_jump_p, return 1 if X contains a REG or MEM or\n    constant that is not in the constant pool and not in the condition\n    of an IF_THEN_ELSE.  */"}, {"sha": "a24386608a44ed45be7abd39ee6c6d8553dae2ad", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -1,3 +1,7 @@\n+2019-08-13  Olivier Hainque  <hainque@adacore.com>\n+\n+\t* gnat.dg/casesi.ad[bs], test_casesi.adb: New test.\n+\n 2019-08-13  Wilco Dijkstra  <wdijkstr@arm.com>  \n \n \tPR target/81800"}, {"sha": "388489873a42f14bd2b6d1afd855ae0f7babcf1d", "filename": "gcc/testsuite/gnat.dg/casesi.adb", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2Fgnat.dg%2Fcasesi.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2Fgnat.dg%2Fcasesi.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fcasesi.adb?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -0,0 +1,28 @@\n+with Ada.Assertions;\n+package body Casesi is\n+\n+  function Process (X : Natural) return String is\n+  begin\n+     case X is\n+        when 0 => raise Ada.Assertions.Assertion_Error;\n+        when 1 => raise Ada.Assertions.Assertion_Error;\n+        when 2 => return (1 .. 4 => 'T');\n+        when 3 => return (2 .. 8 => 'T');\n+        when 4 => return \"hello\";\n+        when others => return (1 .. 0 => <>);\n+     end case;\n+  end;\n+\n+  procedure Try (X : Natural) is\n+  begin\n+     declare\n+        Code : String := Process (X);\n+     begin\n+        if X < 2 then\n+           raise Program_Error;\n+        end if;\n+     end;\n+  exception\n+     when Ada.Assertions.Assertion_Error => null;\n+  end;\n+end;"}, {"sha": "665fa11486a4fb1db1394d7a3421d4eaa0cf0b68", "filename": "gcc/testsuite/gnat.dg/casesi.ads", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2Fgnat.dg%2Fcasesi.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2Fgnat.dg%2Fcasesi.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fcasesi.ads?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -0,0 +1,4 @@\n+\n+package Casesi is\n+  procedure Try (X : Natural);\n+end;"}, {"sha": "a4318c9df061fc6c40a1c0eb265128ad33d287ae", "filename": "gcc/testsuite/gnat.dg/test_casesi.adb", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2Fgnat.dg%2Ftest_casesi.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3010ee5514a16902c1c31fd8afbbd0285d0134c0/gcc%2Ftestsuite%2Fgnat.dg%2Ftest_casesi.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Ftest_casesi.adb?ref=3010ee5514a16902c1c31fd8afbbd0285d0134c0", "patch": "@@ -0,0 +1,12 @@\n+-- { dg-do run }\n+-- { dg-options \"-O2\" }\n+\n+with Casesi;\n+procedure Test_Casesi is\n+begin\n+  Casesi.Try (1);\n+  Casesi.Try (2);\n+  Casesi.Try (3);\n+end;\n+\n+"}]}