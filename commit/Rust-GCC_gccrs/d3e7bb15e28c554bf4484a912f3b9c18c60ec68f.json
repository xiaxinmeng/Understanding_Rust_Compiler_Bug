{"sha": "d3e7bb15e28c554bf4484a912f3b9c18c60ec68f", "node_id": "C_kwDOANBUbNoAKGQzZTdiYjE1ZTI4YzU1NGJmNDQ4NGE5MTJmM2I5YzE4YzYwZWM2OGY", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-09-29T08:17:52Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-09-29T08:17:52Z"}, "message": "openmp: Disallow reduction with var private in containing parallel even on scope [PR102504]\n\nThe standard has a restriction:\n\"A list item that appears in a reduction clause of a scope construct must be\nshared in the parallel region to which a corresponding scope region binds.\"\nsimilar to the restriction for worksharing constructs, but we were checking\nit only on worksharing constructs and not for scope and ICEd later on during\nomp expansion.\n\n2021-09-29  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR middle-end/102504\n\t* gimplify.c (gimplify_scan_omp_clauses): Use omp_check_private even\n\tin OMP_SCOPE clauses, not just on worksharing construct clauses.\n\n\t* c-c++-common/gomp/scope-4.c: New test.", "tree": {"sha": "acd316deacea106ab416e5a17d9f58802371f11a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/acd316deacea106ab416e5a17d9f58802371f11a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c6dbe7a56dfb511101ddea98844a7be0027d30a6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c6dbe7a56dfb511101ddea98844a7be0027d30a6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c6dbe7a56dfb511101ddea98844a7be0027d30a6"}], "stats": {"total": 13, "additions": 12, "deletions": 1}, "files": [{"sha": "f4bc649632eca1b1cc55274db7909a4a8de2258d", "filename": "gcc/gimplify.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=d3e7bb15e28c554bf4484a912f3b9c18c60ec68f", "patch": "@@ -10195,7 +10195,7 @@ gimplify_scan_omp_clauses (tree *list_p, gimple_seq *pre_p,\n \t  if (outer_ctx)\n \t    omp_notice_variable (outer_ctx, decl, true);\n \t  if (check_non_private\n-\t      && region_type == ORT_WORKSHARE\n+\t      && (region_type == ORT_WORKSHARE || code == OMP_SCOPE)\n \t      && (OMP_CLAUSE_CODE (c) != OMP_CLAUSE_REDUCTION\n \t\t  || decl == OMP_CLAUSE_DECL (c)\n \t\t  || (TREE_CODE (OMP_CLAUSE_DECL (c)) == MEM_REF"}, {"sha": "924ae9cbb24ffba78f3484ef4a8423a4c98d00d1", "filename": "gcc/testsuite/c-c++-common/gomp/scope-4.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fscope-4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d3e7bb15e28c554bf4484a912f3b9c18c60ec68f/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fscope-4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fscope-4.c?ref=d3e7bb15e28c554bf4484a912f3b9c18c60ec68f", "patch": "@@ -0,0 +1,11 @@\n+/* PR middle-end/102504 */\n+/* { dg-do compile } */\n+\n+int\n+foo ()\n+{\n+  int r = 0;\n+  #pragma omp scope reduction(+:r)\t/* { dg-error \"reduction variable 'r' is private in outer context\" } */\n+  r++;\n+  return r;\n+}"}]}