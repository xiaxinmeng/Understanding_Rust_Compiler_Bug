{"sha": "d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDJmZjM1YzA5MTM1MzlhMzE3ODJmYmMwNWJiNmQ0YzJjZTc0ZjJjZQ==", "commit": {"author": {"name": "Luis Machado", "email": "luis.machado@linaro.org", "date": "2018-05-23T16:23:11Z"}, "committer": {"name": "Luis Machado", "email": "luisgpm@gcc.gnu.org", "date": "2018-05-23T16:23:11Z"}, "message": "[Patch 02/02] Introduce prefetch-dynamic-strides option\n\nThe following patch adds an option to control software prefetching of memory\nreferences with non-constant/unknown strides.\n\nCurrently we prefetch these references if the pass thinks there is benefit to\ndoing so. But, since this is all based on heuristics, it's not always the case\nthat we end up with better performance.\n\nFor Falkor there is also the problem of conflicts with the hardware prefetcher,\nso we need to be more conservative in terms of what we issue software prefetch\nhints for.\n\nThis also aligns GCC with what LLVM does for Falkor.\n\nSimilarly to the previous patch, the defaults guarantee no change in behavior\nfor other targets and architectures.\n\ngcc/ChangeLog:\n\n2018-05-23  Luis Machado  <luis.machado@linaro.org>\n\n\t* config/aarch64/aarch64-protos.h (cpu_prefetch_tune)\n\t<prefetch_dynamic_strides>: New const bool field.\n\t* config/aarch64/aarch64.c (generic_prefetch_tune): Update to include\n\tprefetch_dynamic_strides.\n\t(exynosm1_prefetch_tune): Likewise.\n\t(thunderxt88_prefetch_tune): Likewise.\n\t(thunderx_prefetch_tune): Likewise.\n\t(thunderx2t99_prefetch_tune): Likewise.\n\t(qdf24xx_prefetch_tune): Likewise. Set prefetch_dynamic_strides to\n\tfalse.\n\t(aarch64_override_options_internal): Update to set\n\tPARAM_PREFETCH_DYNAMIC_STRIDES.\n\t* doc/invoke.texi (prefetch-dynamic-strides): Document new option.\n\t* params.def (PARAM_PREFETCH_DYNAMIC_STRIDES): New.\n\t* params.h (PARAM_PREFETCH_DYNAMIC_STRIDES): Define.\n\t* tree-ssa-loop-prefetch.c (should_issue_prefetch_p): Account for\n\tprefetch-dynamic-strides setting.\n\nFrom-SVN: r260618", "tree": {"sha": "36f27cdd1a5fcc65a32d45f16e798bdd393b5cb3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/36f27cdd1a5fcc65a32d45f16e798bdd393b5cb3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/comments", "author": {"login": "luislinaro", "id": 53092780, "node_id": "MDQ6VXNlcjUzMDkyNzgw", "avatar_url": "https://avatars.githubusercontent.com/u/53092780?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luislinaro", "html_url": "https://github.com/luislinaro", "followers_url": "https://api.github.com/users/luislinaro/followers", "following_url": "https://api.github.com/users/luislinaro/following{/other_user}", "gists_url": "https://api.github.com/users/luislinaro/gists{/gist_id}", "starred_url": "https://api.github.com/users/luislinaro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luislinaro/subscriptions", "organizations_url": "https://api.github.com/users/luislinaro/orgs", "repos_url": "https://api.github.com/users/luislinaro/repos", "events_url": "https://api.github.com/users/luislinaro/events{/privacy}", "received_events_url": "https://api.github.com/users/luislinaro/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "59100dfc42bbe92caff61bca1560da4a30f99906", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59100dfc42bbe92caff61bca1560da4a30f99906", "html_url": "https://github.com/Rust-GCC/gccrs/commit/59100dfc42bbe92caff61bca1560da4a30f99906"}], "stats": {"total": 65, "additions": 65, "deletions": 0}, "files": [{"sha": "38b26b1ad01d497244ebf1775822e9a21b9cae55", "filename": "gcc/ChangeLog", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -1,3 +1,23 @@\n+2018-05-23  Luis Machado  <luis.machado@linaro.org>\n+\n+\t* config/aarch64/aarch64-protos.h (cpu_prefetch_tune)\n+\t<prefetch_dynamic_strides>: New const bool field.\n+\t* config/aarch64/aarch64.c (generic_prefetch_tune): Update to include\n+\tprefetch_dynamic_strides.\n+\t(exynosm1_prefetch_tune): Likewise.\n+\t(thunderxt88_prefetch_tune): Likewise.\n+\t(thunderx_prefetch_tune): Likewise.\n+\t(thunderx2t99_prefetch_tune): Likewise.\n+\t(qdf24xx_prefetch_tune): Likewise. Set prefetch_dynamic_strides to\n+\tfalse.\n+\t(aarch64_override_options_internal): Update to set\n+\tPARAM_PREFETCH_DYNAMIC_STRIDES.\n+\t* doc/invoke.texi (prefetch-dynamic-strides): Document new option.\n+\t* params.def (PARAM_PREFETCH_DYNAMIC_STRIDES): New.\n+\t* params.h (PARAM_PREFETCH_DYNAMIC_STRIDES): Define.\n+\t* tree-ssa-loop-prefetch.c (should_issue_prefetch_p): Account for\n+\tprefetch-dynamic-strides setting.\n+\n 2018-05-23  Luis Machado  <luis.machado@linaro.org>\n \n \t* config/aarch64/aarch64-protos.h (cpu_prefetch_tune)"}, {"sha": "eec86428741ab08b71a62db63d2073c130418ed4", "filename": "gcc/config/aarch64/aarch64-protos.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fconfig%2Faarch64%2Faarch64-protos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fconfig%2Faarch64%2Faarch64-protos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Faarch64%2Faarch64-protos.h?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -230,6 +230,9 @@ struct cpu_prefetch_tune\n   const int l1_cache_size;\n   const int l1_cache_line_size;\n   const int l2_cache_size;\n+  /* Whether software prefetch hints should be issued for non-constant\n+     strides.  */\n+  const bool prefetch_dynamic_strides;\n   /* The minimum constant stride beyond which we should use prefetch\n      hints for.  */\n   const int minimum_stride;"}, {"sha": "9e385e090355951ee6026be950a6602941eb64e3", "filename": "gcc/config/aarch64/aarch64.c", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fconfig%2Faarch64%2Faarch64.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fconfig%2Faarch64%2Faarch64.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Faarch64%2Faarch64.c?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -550,6 +550,7 @@ static const cpu_prefetch_tune generic_prefetch_tune =\n   -1,\t\t\t/* l1_cache_size  */\n   -1,\t\t\t/* l1_cache_line_size  */\n   -1,\t\t\t/* l2_cache_size  */\n+  true,\t\t\t/* prefetch_dynamic_strides */\n   -1,\t\t\t/* minimum_stride */\n   -1\t\t\t/* default_opt_level  */\n };\n@@ -560,6 +561,7 @@ static const cpu_prefetch_tune exynosm1_prefetch_tune =\n   -1,\t\t\t/* l1_cache_size  */\n   64,\t\t\t/* l1_cache_line_size  */\n   -1,\t\t\t/* l2_cache_size  */\n+  true,\t\t\t/* prefetch_dynamic_strides */\n   -1,\t\t\t/* minimum_stride */\n   -1\t\t\t/* default_opt_level  */\n };\n@@ -570,6 +572,7 @@ static const cpu_prefetch_tune qdf24xx_prefetch_tune =\n   32,\t\t\t/* l1_cache_size  */\n   64,\t\t\t/* l1_cache_line_size  */\n   512,\t\t\t/* l2_cache_size  */\n+  false,\t\t/* prefetch_dynamic_strides */\n   2048,\t\t\t/* minimum_stride */\n   3\t\t\t/* default_opt_level  */\n };\n@@ -580,6 +583,7 @@ static const cpu_prefetch_tune thunderxt88_prefetch_tune =\n   32,\t\t\t/* l1_cache_size  */\n   128,\t\t\t/* l1_cache_line_size  */\n   16*1024,\t\t/* l2_cache_size  */\n+  true,\t\t\t/* prefetch_dynamic_strides */\n   -1,\t\t\t/* minimum_stride */\n   3\t\t\t/* default_opt_level  */\n };\n@@ -590,6 +594,7 @@ static const cpu_prefetch_tune thunderx_prefetch_tune =\n   32,\t\t\t/* l1_cache_size  */\n   128,\t\t\t/* l1_cache_line_size  */\n   -1,\t\t\t/* l2_cache_size  */\n+  true,\t\t\t/* prefetch_dynamic_strides */\n   -1,\t\t\t/* minimum_stride */\n   -1\t\t\t/* default_opt_level  */\n };\n@@ -600,6 +605,7 @@ static const cpu_prefetch_tune thunderx2t99_prefetch_tune =\n   32,\t\t\t/* l1_cache_size  */\n   64,\t\t\t/* l1_cache_line_size  */\n   256,\t\t\t/* l2_cache_size  */\n+  true,\t\t\t/* prefetch_dynamic_strides */\n   -1,\t\t\t/* minimum_stride */\n   -1\t\t\t/* default_opt_level  */\n };\n@@ -10635,6 +10641,11 @@ aarch64_override_options_internal (struct gcc_options *opts)\n \t\t\t   aarch64_tune_params.prefetch->l2_cache_size,\n \t\t\t   opts->x_param_values,\n \t\t\t   global_options_set.x_param_values);\n+  if (!aarch64_tune_params.prefetch->prefetch_dynamic_strides)\n+    maybe_set_param_value (PARAM_PREFETCH_DYNAMIC_STRIDES,\n+\t\t\t   0,\n+\t\t\t   opts->x_param_values,\n+\t\t\t   global_options_set.x_param_values);\n   if (aarch64_tune_params.prefetch->minimum_stride >= 0)\n     maybe_set_param_value (PARAM_PREFETCH_MINIMUM_STRIDE,\n \t\t\t   aarch64_tune_params.prefetch->minimum_stride,"}, {"sha": "65f32d6764014aa35f293cc67d67f4548aa6d6aa", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -10734,6 +10734,16 @@ The size of L1 cache, in kilobytes.\n @item l2-cache-size\n The size of L2 cache, in kilobytes.\n \n+@item prefetch-dynamic-strides\n+Whether the loop array prefetch pass should issue software prefetch hints\n+for strides that are non-constant.  In some cases this may be\n+beneficial, though the fact the stride is non-constant may make it\n+hard to predict when there is clear benefit to issuing these hints.\n+\n+Set to 1, the default, if the prefetch hints should be issued for non-constant\n+strides.  Set to 0 if prefetch hints should be issued only for strides that\n+are known to be constant and below @option{prefetch-minimum-stride}.\n+\n @item prefetch-minimum-stride\n Minimum constant stride, in bytes, to start using prefetch hints for.  If\n the stride is less than this threshold, prefetch hints will not be issued."}, {"sha": "6b955a5deec310eacc2fae288e086375da8b692d", "filename": "gcc/params.def", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fparams.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fparams.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fparams.def?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -795,6 +795,15 @@ DEFPARAM (PARAM_L2_CACHE_SIZE,\n \t  \"The size of L2 cache.\",\n \t  512, 0, 0)\n \n+/* Whether software prefetch hints should be issued for non-constant\n+   strides.  */\n+\n+DEFPARAM (PARAM_PREFETCH_DYNAMIC_STRIDES,\n+\t  \"prefetch-dynamic-strides\",\n+\t  \"Whether software prefetch hints should be issued for non-constant \"\n+\t  \"strides.\",\n+\t  1, 0, 1)\n+\n /* The minimum constant stride beyond which we should use prefetch hints\n    for.  */\n "}, {"sha": "8aa960a904ee7f7ce239aa1323ab25e6043ae7ba", "filename": "gcc/params.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fparams.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Fparams.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fparams.h?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -196,6 +196,8 @@ extern void init_param_values (int *params);\n   PARAM_VALUE (PARAM_L1_CACHE_LINE_SIZE)\n #define L2_CACHE_SIZE \\\n   PARAM_VALUE (PARAM_L2_CACHE_SIZE)\n+#define PREFETCH_DYNAMIC_STRIDES \\\n+  PARAM_VALUE (PARAM_PREFETCH_DYNAMIC_STRIDES)\n #define PREFETCH_MINIMUM_STRIDE \\\n   PARAM_VALUE (PARAM_PREFETCH_MINIMUM_STRIDE)\n #define USE_CANONICAL_TYPES \\"}, {"sha": "c3e7fd1e5294a4b8a9f597052ffdebcf71ed8d15", "filename": "gcc/tree-ssa-loop-prefetch.c", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Ftree-ssa-loop-prefetch.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce/gcc%2Ftree-ssa-loop-prefetch.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-loop-prefetch.c?ref=d2ff35c0913539a31782fbc05bb6d4c2ce74f2ce", "patch": "@@ -992,6 +992,16 @@ prune_by_reuse (struct mem_ref_group *groups)\n static bool\n should_issue_prefetch_p (struct mem_ref *ref)\n {\n+  /* Do we want to issue prefetches for non-constant strides?  */\n+  if (!cst_and_fits_in_hwi (ref->group->step) && PREFETCH_DYNAMIC_STRIDES == 0)\n+    {\n+      if (dump_file && (dump_flags & TDF_DETAILS))\n+\tfprintf (dump_file,\n+\t\t \"Skipping non-constant step for reference %u:%u\\n\",\n+\t\t ref->group->uid, ref->uid);\n+      return false;\n+    }\n+\n   /* Some processors may have a hardware prefetcher that may conflict with\n      prefetch hints for a range of strides.  Make sure we don't issue\n      prefetches for such cases if the stride is within this particular"}]}