{"sha": "4663b943c6eec1006f160dbec0729511bc5d1838", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDY2M2I5NDNjNmVlYzEwMDZmMTYwZGJlYzA3Mjk1MTFiYzVkMTgzOA==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2018-08-07T17:22:19Z"}, "committer": {"name": "Richard Sandiford", "email": "rsandifo@gcc.gnu.org", "date": "2018-08-07T17:22:19Z"}, "message": "[AArch64] Fix -mlow-precision-div (PR 86838)\n\nThe \"@\" handling broke -mlow-precision-div, because the scalar forms of\nthe instruction were provided by a pattern that also provided FRECPX\n(and so were parameterised on an unspec code as well as a mode),\nwhile the SIMD versions had a dedicated FRECPE pattern.  This patch\nmoves the scalar FRECPE handling to the SIMD pattern too (as for FRECPS)\nand uses a separate pattern for FRECPX.\n\nThe convention in aarch64-simd-builtins.def seemed to be to add\ncomments only if the mapping wasn't obvious (i.e. not just sticking\n\"aarch64_\" on the beginning and \"<mode>\" on the end), so the patch\ndeletes the reference to the combined pattern instead of rewording it.\n\nThere didn't seem to be any coverage of -mlow-precision-div in the\ntestsuite, so the patch adds some tests for it.\n\n2018-08-07  Richard Sandiford  <richard.sandiford@arm.com>\n\ngcc/\n\tPR target/86838\n\t* config/aarch64/iterators.md (FRECP, frecp_suffix): Delete.\n\t* config/aarch64/aarch64-simd.md\n\t(aarch64_frecp<FRECP:frecp_suffix><mode>): Fold FRECPE into...\n\t(@aarch64_frecpe<mode>): ...here and the move FRECPX to...\n\t(aarch64_frecpx<mode>): ...this new pattern.\n\t* config/aarch64/aarch64-simd-builtins.def: Remove comment\n\tabout aarch64_frecp<FRECP:frecp_suffix><mode>.\n\ngcc/testsuite/\n\tPR target/86838\n\t* gcc.target/aarch64/frecpe_1.c: New test.\n\t* gcc.target/aarch64/frecpe_2.c: Likewise.\n\nFrom-SVN: r263362", "tree": {"sha": "7bf1dd45f59b39d51ab2d531b7717097f2d5e936", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7bf1dd45f59b39d51ab2d531b7717097f2d5e936"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4663b943c6eec1006f160dbec0729511bc5d1838", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4663b943c6eec1006f160dbec0729511bc5d1838", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4663b943c6eec1006f160dbec0729511bc5d1838", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4663b943c6eec1006f160dbec0729511bc5d1838/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6429b8e0f1ecb9fe2993a66623df1936b0886bfa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6429b8e0f1ecb9fe2993a66623df1936b0886bfa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6429b8e0f1ecb9fe2993a66623df1936b0886bfa"}], "stats": {"total": 74, "additions": 61, "deletions": 13}, "files": [{"sha": "15baa0ce53d704ed981085ff4478bcb010edbd0d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -1,3 +1,14 @@\n+2018-08-07  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\tPR target/86838\n+\t* config/aarch64/iterators.md (FRECP, frecp_suffix): Delete.\n+\t* config/aarch64/aarch64-simd.md\n+\t(aarch64_frecp<FRECP:frecp_suffix><mode>): Fold FRECPE into...\n+\t(@aarch64_frecpe<mode>): ...here and the move FRECPX to...\n+\t(aarch64_frecpx<mode>): ...this new pattern.\n+\t* config/aarch64/aarch64-simd-builtins.def: Remove comment\n+\tabout aarch64_frecp<FRECP:frecp_suffix><mode>.\n+\n 2018-08-07  Martin Liska  <mliska@suse.cz>\n \n         PR middle-end/83023"}, {"sha": "980c90351b36630d7bcf6b8f5c0ff11d081665e7", "filename": "gcc/config/aarch64/aarch64-simd-builtins.def", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Fconfig%2Faarch64%2Faarch64-simd-builtins.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Fconfig%2Faarch64%2Faarch64-simd-builtins.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Faarch64%2Faarch64-simd-builtins.def?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -413,8 +413,6 @@\n   BUILTIN_VALL (BINOP, trn1, 0)\n   BUILTIN_VALL (BINOP, trn2, 0)\n \n-  /* Implemented by\n-     aarch64_frecp<FRECP:frecp_suffix><mode>.  */\n   BUILTIN_GPF_F16 (UNOP, frecpe, 0)\n   BUILTIN_GPF_F16 (UNOP, frecpx, 0)\n "}, {"sha": "33fb9da1614e3d591745b9862ba2afd5d977ce64", "filename": "gcc/config/aarch64/aarch64-simd.md", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Fconfig%2Faarch64%2Faarch64-simd.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Fconfig%2Faarch64%2Faarch64-simd.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Faarch64%2Faarch64-simd.md?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -5879,21 +5879,22 @@\n \n \n (define_insn \"@aarch64_frecpe<mode>\"\n-  [(set (match_operand:VHSDF 0 \"register_operand\" \"=w\")\n-\t(unspec:VHSDF [(match_operand:VHSDF 1 \"register_operand\" \"w\")]\n+  [(set (match_operand:VHSDF_HSDF 0 \"register_operand\" \"=w\")\n+\t(unspec:VHSDF_HSDF\n+\t [(match_operand:VHSDF_HSDF 1 \"register_operand\" \"w\")]\n \t UNSPEC_FRECPE))]\n   \"TARGET_SIMD\"\n-  \"frecpe\\\\t%0.<Vtype>, %1.<Vtype>\"\n+  \"frecpe\\t%<v>0<Vmtype>, %<v>1<Vmtype>\"\n   [(set_attr \"type\" \"neon_fp_recpe_<stype><q>\")]\n )\n \n-(define_insn \"aarch64_frecp<FRECP:frecp_suffix><mode>\"\n+(define_insn \"aarch64_frecpx<mode>\"\n   [(set (match_operand:GPF_F16 0 \"register_operand\" \"=w\")\n \t(unspec:GPF_F16 [(match_operand:GPF_F16 1 \"register_operand\" \"w\")]\n-\t FRECP))]\n+\t UNSPEC_FRECPX))]\n   \"TARGET_SIMD\"\n-  \"frecp<FRECP:frecp_suffix>\\\\t%<s>0, %<s>1\"\n-  [(set_attr \"type\" \"neon_fp_recp<FRECP:frecp_suffix>_<GPF_F16:stype>\")]\n+  \"frecpx\\t%<s>0, %<s>1\"\n+  [(set_attr \"type\" \"neon_fp_recpx_<GPF_F16:stype>\")]\n )\n \n (define_insn \"@aarch64_frecps<mode>\""}, {"sha": "a43956054e82aaf651fb45d0ff254b248c02c644", "filename": "gcc/config/aarch64/iterators.md", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Fconfig%2Faarch64%2Fiterators.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Fconfig%2Faarch64%2Fiterators.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Faarch64%2Fiterators.md?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -1537,8 +1537,6 @@\n (define_int_iterator FCVT_F2FIXED [UNSPEC_FCVTZS UNSPEC_FCVTZU])\n (define_int_iterator FCVT_FIXED2F [UNSPEC_SCVTF UNSPEC_UCVTF])\n \n-(define_int_iterator FRECP [UNSPEC_FRECPE UNSPEC_FRECPX])\n-\n (define_int_iterator CRC [UNSPEC_CRC32B UNSPEC_CRC32H UNSPEC_CRC32W\n                           UNSPEC_CRC32X UNSPEC_CRC32CB UNSPEC_CRC32CH\n                           UNSPEC_CRC32CW UNSPEC_CRC32CX])\n@@ -1788,8 +1786,6 @@\n \t\t\t\t (UNSPEC_UNPACKSLO \"BYTES_BIG_ENDIAN\")\n \t\t\t\t (UNSPEC_UNPACKULO \"BYTES_BIG_ENDIAN\")])\n \n-(define_int_attr frecp_suffix  [(UNSPEC_FRECPE \"e\") (UNSPEC_FRECPX \"x\")])\n-\n (define_int_attr crc_variant [(UNSPEC_CRC32B \"crc32b\") (UNSPEC_CRC32H \"crc32h\")\n                         (UNSPEC_CRC32W \"crc32w\") (UNSPEC_CRC32X \"crc32x\")\n                         (UNSPEC_CRC32CB \"crc32cb\") (UNSPEC_CRC32CH \"crc32ch\")"}, {"sha": "c4aaa448fa1394b88a98b5c6e8682fb5a3953b4b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -1,3 +1,9 @@\n+2018-08-07  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\tPR target/86838\n+\t* gcc.target/aarch64/frecpe_1.c: New test.\n+\t* gcc.target/aarch64/frecpe_2.c: Likewise.\n+\n 2018-08-07  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/59480, DR 136"}, {"sha": "e79f80d3ead5dbfb52d5c04c06a9e2f26a0e265f", "filename": "gcc/testsuite/gcc.target/aarch64/frecpe_1.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Ffrecpe_1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Ffrecpe_1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Ffrecpe_1.c?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-options \"-Ofast -mlow-precision-div\" } */\n+/* { dg-do compile } */\n+\n+float\n+f1 (float x)\n+{\n+  return 1 / x;\n+}\n+\n+/* { dg-final { scan-assembler {\\tfrecpe\\t(s[0-9]+), s0\\n\\tfrecps\\t(s[0-9]+), \\1, s0\\n\\tfmul\\ts0, \\1, \\2\\n} } } */\n+\n+double\n+f2 (double x)\n+{\n+  return 1 / x;\n+}\n+\n+/* { dg-final { scan-assembler {\\tfrecpe\\t(d[0-9]+), d0\\n\\tfrecps\\t(d[0-9]+), \\1, d0\\n\\tfmul\\t\\1, \\1, \\2\\n\\tfrecps\\t\\2, \\1, d0\\n\\tfmul\\td0, \\1, \\2\\n} } } */"}, {"sha": "233817c26b26df6335f9cebd7f91c239de427768", "filename": "gcc/testsuite/gcc.target/aarch64/frecpe_2.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Ffrecpe_2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4663b943c6eec1006f160dbec0729511bc5d1838/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Ffrecpe_2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Ffrecpe_2.c?ref=4663b943c6eec1006f160dbec0729511bc5d1838", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-options \"-Ofast -mlow-precision-div\" } */\n+/* { dg-do compile } */\n+\n+float\n+f1 (float x, float y)\n+{\n+  return y / x;\n+}\n+\n+/* { dg-final { scan-assembler {\\tfrecpe\\t(s[0-9]+), s0\\n\\tfrecps\\t(s[0-9]+), \\1, s0\\n\\tfmul\\t\\1, \\1, s1\\n\\tfmul\\ts0, \\1, \\2\\n} } } */\n+\n+double\n+f2 (double x, double y)\n+{\n+  return y / x;\n+}\n+\n+/* { dg-final { scan-assembler {\\tfrecpe\\t(d[0-9]+), d0\\n\\tfrecps\\t(d[0-9]+), \\1, d0\\n\\tfmul\\t\\1, \\1, \\2\\n\\tfrecps\\t\\2, \\1, d0\\n\\tfmul\\t\\1, \\1, d1\\n\\tfmul\\td0, \\1, \\2\\n} } } */"}]}