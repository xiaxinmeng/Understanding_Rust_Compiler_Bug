{"sha": "af7a5758bf250decdba7b366068af186f32a52b5", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWY3YTU3NThiZjI1MGRlY2RiYTdiMzY2MDY4YWYxODZmMzJhNTJiNQ==", "commit": {"author": {"name": "H.J. Lu", "email": "hongjiu.lu@intel.com", "date": "2018-04-16T11:31:22Z"}, "committer": {"name": "H.J. Lu", "email": "hjl@gcc.gnu.org", "date": "2018-04-16T11:31:22Z"}, "message": "i386: Check error_mark_node in multiversioning\n\nSince CET is applied to the whole program, it is correct to disallow\n-fcf-protection=full without -mcet.  But compiler shouldn't crash.\n\ngcc/\n\n\tPR target/85403\n\t* config/i386/i386.c (get_builtin_code_for_version): Check\n\terror_mark_node.\n\ngcc/testsuite/\n\n\tPR target/85403\n\t* gcc.target/i386/pr85403.c: New test.\n---\n gcc/config/i386/i386.c                            |  2 ++\n gcc/testsuite/g++.dg/ext/mv1.C                    |  2 +-\n gcc/testsuite/g++.dg/ext/mv14.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv15.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv16.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv17.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv18.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv19.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv20.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv21.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv22.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv23.C                   |  2 +-\n gcc/testsuite/g++.dg/ext/mv26.C                   |  1 +\n gcc/testsuite/g++.dg/ext/mv6.C                    |  2 +-\n gcc/testsuite/g++.dg/ext/mvc1.C                   |  1 +\n gcc/testsuite/gcc.target/i386/cet-notrack-icf-1.c |  2 +-\n gcc/testsuite/gcc.target/i386/cet-notrack-icf-3.c |  2 +-\n gcc/testsuite/gcc.target/i386/cet-property-2.c    |  2 +-\n gcc/testsuite/gcc.target/i386/mvc1.c              |  1 +\n gcc/testsuite/gcc.target/i386/mvc10.c             |  1 +\n gcc/testsuite/gcc.target/i386/mvc11.c             |  2 +-\n gcc/testsuite/gcc.target/i386/mvc6.c              |  2 +-\n gcc/testsuite/gcc.target/i386/mvc7.c              |  1 +\n gcc/testsuite/gcc.target/i386/mvc8.c              |  2 +-\n gcc/testsuite/gcc.target/i386/mvc9.c              |  2 +-\n gcc/testsuite/gcc.target/i386/pr81213.c           |  1 +\n gcc/testsuite/gcc.target/i386/pr81214.c           |  1 +\n gcc/testsuite/gcc.target/i386/pr85403.c           | 10 ++++++++++\n gcc/testsuite/gcc.target/i386/sse-26.c            |  2 +-\n 29 files changed, 39 insertions(+), 20 deletions(-)\n create mode 100644 gcc/testsuite/gcc.target/i386/pr85403.c\n\ndiff --git a/gcc/config/i386/i386.c b/gcc/config/i386/i386.c\nindex 6fa5b0add02..8a73fc0d316 100644\n--- a/gcc/config/i386/i386.c\n+++ b/gcc/config/i386/i386.c\n@@ -32344,6 +32344,8 @@ get_builtin_code_for_version (tree decl, tree *predicate_list)\n \t\t\t\t\t\t      &global_options_set);\n     \n       gcc_assert (target_node);\n+      if (target_node == error_mark_node)\n+\treturn 0;\n       new_target = TREE_TARGET_OPTION (target_node);\n       gcc_assert (new_target);\n       \ndiff --git a/gcc/testsuite/gcc.target/i386/pr85403.c b/gcc/testsuite/gcc.target/i386/pr85403.c\nnew file mode 100644\nindex 00000000000..f4fb12dd4e2\n--- /dev/null\n+++ b/gcc/testsuite/gcc.target/i386/pr85403.c\n@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-fcf-protection -mcet\" } */\n+/* { dg-require-ifunc \"\" } */\n+\n+__attribute__((target_clones(\"avx\",\"arch=slm\",\"arch=core-avx2\",\"default\")))\n+int\n+foo ()\n+{\n+  return -2;\n+} /* { dg-error \"requires Intel CET support\" } */\n\nFrom-SVN: r259400", "tree": {"sha": "93dd1086d487e6f86467d2d4ddbd3cca15d1de26", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/93dd1086d487e6f86467d2d4ddbd3cca15d1de26"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/af7a5758bf250decdba7b366068af186f32a52b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/af7a5758bf250decdba7b366068af186f32a52b5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/af7a5758bf250decdba7b366068af186f32a52b5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/af7a5758bf250decdba7b366068af186f32a52b5/comments", "author": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "176a3386885f99654139a2222144b57471a2aee6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/176a3386885f99654139a2222144b57471a2aee6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/176a3386885f99654139a2222144b57471a2aee6"}], "stats": {"total": 23, "additions": 23, "deletions": 0}, "files": [{"sha": "b53fda60c3c505cfe2c63d6d7de608a35cc472cd", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=af7a5758bf250decdba7b366068af186f32a52b5", "patch": "@@ -1,3 +1,9 @@\n+2018-04-16  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR target/85403\n+\t* config/i386/i386.c (get_builtin_code_for_version): Check\n+\terror_mark_node.\n+\n 2018-04-16  Olga Makhotina  <olga.makhotina@intel.com>\n \n \tPR target/84331"}, {"sha": "9074526b8a1ae0f7e68a78ac170b93dc3d889b41", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=af7a5758bf250decdba7b366068af186f32a52b5", "patch": "@@ -32337,6 +32337,8 @@ get_builtin_code_for_version (tree decl, tree *predicate_list)\n \t\t\t\t\t\t      &global_options_set);\n     \n       gcc_assert (target_node);\n+      if (target_node == error_mark_node)\n+\treturn 0;\n       new_target = TREE_TARGET_OPTION (target_node);\n       gcc_assert (new_target);\n       "}, {"sha": "415994e6091cac9cdd5da54cc7397c98312f297f", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=af7a5758bf250decdba7b366068af186f32a52b5", "patch": "@@ -1,3 +1,8 @@\n+2018-04-16  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR target/85403\n+\t* gcc.target/i386/pr85403.c: New test.\n+\n 2018-04-16  Olga Makhotina  <olga.makhotina@intel.com>\n \n \tPR target/84331"}, {"sha": "f4fb12dd4e21909f7840dc5c9899ace759c7940b", "filename": "gcc/testsuite/gcc.target/i386/pr85403.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr85403.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af7a5758bf250decdba7b366068af186f32a52b5/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr85403.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr85403.c?ref=af7a5758bf250decdba7b366068af186f32a52b5", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-fcf-protection -mcet\" } */\n+/* { dg-require-ifunc \"\" } */\n+\n+__attribute__((target_clones(\"avx\",\"arch=slm\",\"arch=core-avx2\",\"default\")))\n+int\n+foo ()\n+{\n+  return -2;\n+} /* { dg-error \"requires Intel CET support\" } */"}]}