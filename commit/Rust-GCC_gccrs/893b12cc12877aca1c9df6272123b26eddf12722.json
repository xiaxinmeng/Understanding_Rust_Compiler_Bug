{"sha": "893b12cc12877aca1c9df6272123b26eddf12722", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODkzYjEyY2MxMjg3N2FjYTFjOWRmNjI3MjEyM2IyNmVkZGYxMjcyMg==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2021-07-21T23:19:31Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2021-07-21T23:19:31Z"}, "message": "analyzer: bulletproof -Wanalyzer-file-leak [PR101547]\n\ngcc/analyzer/ChangeLog:\n\tPR analyzer/101547\n\t* sm-file.cc (file_leak::emit): Handle m_arg being NULL.\n\t(file_leak::describe_final_event): Handle ev.m_expr being NULL.\n\ngcc/testsuite/ChangeLog:\n\tPR analyzer/101547\n\t* gcc.dg/analyzer/pr101547.c: New test.\n\nSigned-off-by: David Malcolm <dmalcolm@redhat.com>", "tree": {"sha": "f3b93e8f957753d35dc1fa1f0fa827ad108c2bfc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f3b93e8f957753d35dc1fa1f0fa827ad108c2bfc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/893b12cc12877aca1c9df6272123b26eddf12722", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/893b12cc12877aca1c9df6272123b26eddf12722", "html_url": "https://github.com/Rust-GCC/gccrs/commit/893b12cc12877aca1c9df6272123b26eddf12722", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/893b12cc12877aca1c9df6272123b26eddf12722/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87bd75cd49aac68e90bd9b6b5e14582d6e0ccafa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87bd75cd49aac68e90bd9b6b5e14582d6e0ccafa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/87bd75cd49aac68e90bd9b6b5e14582d6e0ccafa"}], "stats": {"total": 38, "additions": 32, "deletions": 6}, "files": [{"sha": "6a17019448e41d640f5874a5bec6e5ffd7c7ab5a", "filename": "gcc/analyzer/sm-file.cc", "status": "modified", "additions": 21, "deletions": 6, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/893b12cc12877aca1c9df6272123b26eddf12722/gcc%2Fanalyzer%2Fsm-file.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/893b12cc12877aca1c9df6272123b26eddf12722/gcc%2Fanalyzer%2Fsm-file.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fanalyzer%2Fsm-file.cc?ref=893b12cc12877aca1c9df6272123b26eddf12722", "patch": "@@ -193,9 +193,13 @@ class file_leak : public file_diagnostic\n     /* CWE-775: \"Missing Release of File Descriptor or Handle after\n        Effective Lifetime\". */\n     m.add_cwe (775);\n-    return warning_meta (rich_loc, m, OPT_Wanalyzer_file_leak,\n-\t\t\t \"leak of FILE %qE\",\n-\t\t\t m_arg);\n+    if (m_arg)\n+      return warning_meta (rich_loc, m, OPT_Wanalyzer_file_leak,\n+\t\t\t   \"leak of FILE %qE\",\n+\t\t\t   m_arg);\n+    else\n+      return warning_meta (rich_loc, m, OPT_Wanalyzer_file_leak,\n+\t\t\t   \"leak of FILE\");\n   }\n \n   label_text describe_state_change (const evdesc::state_change &change)\n@@ -212,10 +216,21 @@ class file_leak : public file_diagnostic\n   label_text describe_final_event (const evdesc::final_event &ev) FINAL OVERRIDE\n   {\n     if (m_fopen_event.known_p ())\n-      return ev.formatted_print (\"%qE leaks here; was opened at %@\",\n-\t\t\t\t ev.m_expr, &m_fopen_event);\n+      {\n+\tif (ev.m_expr)\n+\t  return ev.formatted_print (\"%qE leaks here; was opened at %@\",\n+\t\t\t\t     ev.m_expr, &m_fopen_event);\n+\telse\n+\t  return ev.formatted_print (\"leaks here; was opened at %@\",\n+\t\t\t\t     &m_fopen_event);\n+      }\n     else\n-      return ev.formatted_print (\"%qE leaks here\", ev.m_expr);\n+      {\n+\tif (ev.m_expr)\n+\t  return ev.formatted_print (\"%qE leaks here\", ev.m_expr);\n+\telse\n+\t  return ev.formatted_print (\"leaks here\");\n+      }\n   }\n \n private:"}, {"sha": "8791cffa2b6348e87ecb50f0ff5c5933e5d7b699", "filename": "gcc/testsuite/gcc.dg/analyzer/pr101547.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/893b12cc12877aca1c9df6272123b26eddf12722/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fpr101547.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/893b12cc12877aca1c9df6272123b26eddf12722/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fpr101547.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fpr101547.c?ref=893b12cc12877aca1c9df6272123b26eddf12722", "patch": "@@ -0,0 +1,11 @@\n+char *\n+fopen (const char *restrict, const char *restrict);\n+\n+void\n+k2 (void)\n+{\n+  char *setfiles[1];\n+  int i;\n+\n+  setfiles[i] = fopen (\"\", \"\"); /* { dg-warning \"use of uninitialized value 'i'\" } */\n+} /* { dg-warning \"leak of FILE\" } */"}]}