{"sha": "09c5f835e7ca90b344a6471acbe360fc33b77fa7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDljNWY4MzVlN2NhOTBiMzQ0YTY0NzFhY2JlMzYwZmMzM2I3N2ZhNw==", "commit": {"author": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2015-05-09T03:28:40Z"}, "committer": {"name": "Aldy Hernandez", "email": "aldyh@gcc.gnu.org", "date": "2015-05-09T03:28:40Z"}, "message": "decl2.c (collect_candidates_for_java_method_aliases): Remove.\n\n\t* decl2.c (collect_candidates_for_java_method_aliases): Remove.\n\t(build_java_method_aliases): Adapt to use create_same_body_alias\n\tinstead of assemble_alias.  Move variable declarations to\n\tdefinition and tidy up.\n\t(cp_write_global_declarations): Call build_java_method_aliases\n\tinstead of collecting candidates first.\n\nFrom-SVN: r222933", "tree": {"sha": "d21d028ef26baf53318c2bc396a637777bf3427e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d21d028ef26baf53318c2bc396a637777bf3427e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/09c5f835e7ca90b344a6471acbe360fc33b77fa7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/09c5f835e7ca90b344a6471acbe360fc33b77fa7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/09c5f835e7ca90b344a6471acbe360fc33b77fa7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/09c5f835e7ca90b344a6471acbe360fc33b77fa7/comments", "author": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "9c330d029c2a6a58de6bf37851e4f650ef9d40a1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9c330d029c2a6a58de6bf37851e4f650ef9d40a1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9c330d029c2a6a58de6bf37851e4f650ef9d40a1"}], "stats": {"total": 83, "additions": 22, "deletions": 61}, "files": [{"sha": "1fbf7655343ca71e107f62d49437c4a93425503e", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/09c5f835e7ca90b344a6471acbe360fc33b77fa7/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/09c5f835e7ca90b344a6471acbe360fc33b77fa7/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=09c5f835e7ca90b344a6471acbe360fc33b77fa7", "patch": "@@ -1,3 +1,12 @@\n+2015-05-08  Aldy Hernandez  <aldyh@redhat.com>\n+\n+\t* decl2.c (collect_candidates_for_java_method_aliases): Remove.\n+\t(build_java_method_aliases): Adapt to use create_same_body_alias\n+\tinstead of assemble_alias.  Move variable declarations to\n+\tdefinition and tidy up.\n+\t(cp_write_global_declarations): Call build_java_method_aliases\n+\tinstead of collecting candidates first.\n+\n 2015-05-07  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/59012"}, {"sha": "dcc5e1f10152b9d196b409d8d6220503e1c65941", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 13, "deletions": 61, "changes": 74, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/09c5f835e7ca90b344a6471acbe360fc33b77fa7/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/09c5f835e7ca90b344a6471acbe360fc33b77fa7/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=09c5f835e7ca90b344a6471acbe360fc33b77fa7", "patch": "@@ -3996,77 +3996,37 @@ generate_ctor_and_dtor_functions_for_priority (splay_tree_node n, void * data)\n }\n \n /* Java requires that we be able to reference a local address for a\n-   method, and not be confused by PLT entries.  If hidden aliases are\n-   supported, collect and return all the functions for which we should\n-   emit a hidden alias.  */\n+   method, and not be confused by PLT entries.  If supported, create a\n+   hidden alias for all such methods.  */\n \n-static hash_set<tree> *\n-collect_candidates_for_java_method_aliases (void)\n+static void\n+build_java_method_aliases (void)\n {\n-  struct cgraph_node *node;\n-  hash_set<tree> *candidates = NULL;\n-\n #ifndef HAVE_GAS_HIDDEN\n-  return candidates;\n+  return;\n #endif\n \n+  struct cgraph_node *node;\n   FOR_EACH_FUNCTION (node)\n     {\n       tree fndecl = node->decl;\n \n       if (DECL_CLASS_SCOPE_P (fndecl)\n \t  && TYPE_FOR_JAVA (DECL_CONTEXT (fndecl))\n \t  && TARGET_USE_LOCAL_THUNK_ALIAS_P (fndecl))\n-\t{\n-\t  if (candidates == NULL)\n-\t    candidates = new hash_set<tree>;\n-\t  candidates->add (fndecl);\n-\t}\n-    }\n-\n-  return candidates;\n-}\n-\n-\n-/* Java requires that we be able to reference a local address for a\n-   method, and not be confused by PLT entries.  If hidden aliases are\n-   supported, emit one for each java function that we've emitted.\n-   CANDIDATES is the set of FUNCTION_DECLs that were gathered\n-   by collect_candidates_for_java_method_aliases.  */\n-\n-static void\n-build_java_method_aliases (hash_set<tree> *candidates)\n-{\n-  struct cgraph_node *node;\n-\n-#ifndef HAVE_GAS_HIDDEN\n-  return;\n-#endif\n-\n-  FOR_EACH_FUNCTION (node)\n-    {\n-      tree fndecl = node->decl;\n-\n-      if (TREE_ASM_WRITTEN (fndecl)\n-\t  && candidates->contains (fndecl))\n \t{\n \t  /* Mangle the name in a predictable way; we need to reference\n \t     this from a java compiled object file.  */\n-\t  tree oid, nid, alias;\n-\t  const char *oname;\n-\t  char *nname;\n-\n-\t  oid = DECL_ASSEMBLER_NAME (fndecl);\n-\t  oname = IDENTIFIER_POINTER (oid);\n+\t  tree oid = DECL_ASSEMBLER_NAME (fndecl);\n+\t  const char *oname = IDENTIFIER_POINTER (oid);\n \t  gcc_assert (oname[0] == '_' && oname[1] == 'Z');\n-\t  nname = ACONCAT ((\"_ZGA\", oname+2, NULL));\n-\t  nid = get_identifier (nname);\n+\t  char *nname = ACONCAT ((\"_ZGA\", oname + 2, NULL));\n \n-\t  alias = make_alias_for (fndecl, nid);\n+\t  tree alias = make_alias_for (fndecl, get_identifier (nname));\n \t  TREE_PUBLIC (alias) = 1;\n \t  DECL_VISIBILITY (alias) = VISIBILITY_HIDDEN;\n \n-\t  assemble_alias (alias, oid);\n+\t  cgraph_node::create_same_body_alias (alias, fndecl);\n \t}\n     }\n }\n@@ -4399,7 +4359,6 @@ cp_write_global_declarations (void)\n   unsigned ssdf_count = 0;\n   int retries = 0;\n   tree decl;\n-  hash_set<tree> *candidates;\n \n   locus = input_location;\n   at_eof = 1;\n@@ -4750,8 +4709,8 @@ cp_write_global_declarations (void)\n      linkage now.  */\n   pop_lang_context ();\n \n-  /* Collect candidates for Java hidden aliases.  */\n-  candidates = collect_candidates_for_java_method_aliases ();\n+  /* Generate Java hidden aliases.  */\n+  build_java_method_aliases ();\n \n   timevar_stop (TV_PHASE_DEFERRED);\n   timevar_start (TV_PHASE_OPT_GEN);\n@@ -4791,13 +4750,6 @@ cp_write_global_declarations (void)\n \n   perform_deferred_noexcept_checks ();\n \n-  /* Generate hidden aliases for Java.  */\n-  if (candidates)\n-    {\n-      build_java_method_aliases (candidates);\n-      delete candidates;\n-    }\n-\n   finish_repo ();\n \n   /* The entire file is now complete.  If requested, dump everything"}]}