{"sha": "d8552eaddc40b72461158e56b5db8709f2eb21ed", "node_id": "C_kwDOANBUbNoAKGQ4NTUyZWFkZGM0MGI3MjQ2MTE1OGU1NmI1ZGI4NzA5ZjJlYjIxZWQ", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2022-08-04T09:55:15Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2022-08-04T13:01:38Z"}, "message": "tree-optimization/106521 - unroll-and-jam LC SSA rewrite\n\nThe LC SSA rewrite performs SSA verification at start but the VN\nrun performed on the unrolled-and-jammed body can leave us with\ninvalid SSA form until CFG cleanup is run.  So make sure we do that\nbefore rewriting into LC SSA.\n\n\tPR tree-optimization/106521\n\t* gimple-loop-jam.cc (tree_loop_unroll_and_jam): Perform\n\tCFG cleanup manually before rewriting into LC SSA.\n\n\t* gcc.dg/torture/pr106521.c: New testcase.", "tree": {"sha": "67182b106d8fde0d150858dac0bb1ad0fd1d9dac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/67182b106d8fde0d150858dac0bb1ad0fd1d9dac"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d8552eaddc40b72461158e56b5db8709f2eb21ed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d8552eaddc40b72461158e56b5db8709f2eb21ed", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d8552eaddc40b72461158e56b5db8709f2eb21ed", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d8552eaddc40b72461158e56b5db8709f2eb21ed/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d86d81a449c03641e079f23a2b3e1b2279a162fe", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d86d81a449c03641e079f23a2b3e1b2279a162fe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d86d81a449c03641e079f23a2b3e1b2279a162fe"}], "stats": {"total": 27, "additions": 26, "deletions": 1}, "files": [{"sha": "a8a57d3d3840c7fc77b392e9408583309255c8f0", "filename": "gcc/gimple-loop-jam.cc", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8552eaddc40b72461158e56b5db8709f2eb21ed/gcc%2Fgimple-loop-jam.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8552eaddc40b72461158e56b5db8709f2eb21ed/gcc%2Fgimple-loop-jam.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-loop-jam.cc?ref=d8552eaddc40b72461158e56b5db8709f2eb21ed", "patch": "@@ -39,6 +39,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"tree-ssa-loop-ivopts.h\"\n #include \"tree-vectorizer.h\"\n #include \"tree-ssa-sccvn.h\"\n+#include \"tree-cfgcleanup.h\"\n \n /* Unroll and Jam transformation\n    \n@@ -609,9 +610,16 @@ tree_loop_unroll_and_jam (void)\n \n   if (todo)\n     {\n+      free_dominance_info (CDI_DOMINATORS);\n+      /* We need to cleanup the CFG first since otherwise SSA form can\n+\t be not up-to-date from the VN run.  */\n+      if (todo & TODO_cleanup_cfg)\n+\t{\n+\t  cleanup_tree_cfg ();\n+\t  todo &= ~TODO_cleanup_cfg;\n+\t}\n       rewrite_into_loop_closed_ssa (NULL, 0);\n       scev_reset ();\n-      free_dominance_info (CDI_DOMINATORS);\n     }\n   return todo;\n }"}, {"sha": "05c8ce54d0b588328b621c8c1c6cfeef5cc31977", "filename": "gcc/testsuite/gcc.dg/torture/pr106521.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8552eaddc40b72461158e56b5db8709f2eb21ed/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr106521.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8552eaddc40b72461158e56b5db8709f2eb21ed/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr106521.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr106521.c?ref=d8552eaddc40b72461158e56b5db8709f2eb21ed", "patch": "@@ -0,0 +1,17 @@\n+/* { dg-do compile } */\n+/* { dg-additional-options \"-floop-unroll-and-jam --param unroll-jam-min-percent=0\" } */\n+\n+short a, b, e;\n+volatile long c;\n+long d;\n+int main() {\n+  for (; d; d++) {\n+    long g = a = 1;\n+    for (; a; a++) {\n+      g++;\n+      c;\n+    }\n+    g && (b = e);\n+  }\n+  return 0;\n+}"}]}