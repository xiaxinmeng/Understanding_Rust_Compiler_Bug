{"sha": "9a089d8b0620133f2111a2fd2fc5064166ed02a6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWEwODlkOGIwNjIwMTMzZjIxMTFhMmZkMmZjNTA2NDE2NmVkMDJhNg==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2008-04-18T10:10:15Z"}, "committer": {"name": "Eric Botcazou", "email": "ebotcazou@gcc.gnu.org", "date": "2008-04-18T10:10:15Z"}, "message": "decl.c (gnat_to_gnu_entity): Use the return by target pointer mechanism as soon as the size is not constant.\n\n\t* decl.c (gnat_to_gnu_entity) <E_Subprogram_Type>: Use the return by\n\ttarget pointer mechanism as soon as the size is not constant.\n\nFrom-SVN: r134433", "tree": {"sha": "4b6d57388b539f7e98896fb9a76334f75b1cfae3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4b6d57388b539f7e98896fb9a76334f75b1cfae3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9a089d8b0620133f2111a2fd2fc5064166ed02a6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9a089d8b0620133f2111a2fd2fc5064166ed02a6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9a089d8b0620133f2111a2fd2fc5064166ed02a6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9a089d8b0620133f2111a2fd2fc5064166ed02a6/comments", "author": null, "committer": null, "parents": [{"sha": "c6b196de6c8b35acca8309f9e7fec67932c4e9d7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c6b196de6c8b35acca8309f9e7fec67932c4e9d7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c6b196de6c8b35acca8309f9e7fec67932c4e9d7"}], "stats": {"total": 101, "additions": 96, "deletions": 5}, "files": [{"sha": "3f23e2f5d8d407d0cc83b3f857759a18327da117", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -1,3 +1,8 @@\n+2008-04-18  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* decl.c (gnat_to_gnu_entity) <E_Subprogram_Type>: Use the return by\n+\ttarget pointer mechanism as soon as the size is not constant.\n+\n 2008-04-18  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gigi.h (create_var_decl_1): Declare."}, {"sha": "254b70a272227974e9732460a52705966b3efd0e", "filename": "gcc/ada/decl.c", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Fada%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Fada%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fdecl.c?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -3725,11 +3725,13 @@ gnat_to_gnu_entity (Entity_Id gnat_entity, tree gnu_expr, int definition)\n \t\t     || Has_Foreign_Convention (gnat_entity)))\n \t  gnu_return_type = TREE_TYPE (TYPE_FIELDS (gnu_return_type));\n \n-\t/* If the return type is unconstrained, that means it must have a\n-\t   maximum size.  We convert the function into a procedure and its\n-\t   caller will pass a pointer to an object of that maximum size as the\n-\t   first parameter when we call the function.  */\n-\tif (CONTAINS_PLACEHOLDER_P (TYPE_SIZE (gnu_return_type)))\n+\t/* If the return type has a non-constant size, we convert the function\n+\t   into a procedure and its caller will pass a pointer to an object as\n+\t   the first parameter when we call the function.  This can happen for\n+\t   an unconstrained type with a maximum size or a constrained type with\n+\t   a size not known at compile time.  */\n+\tif (TYPE_SIZE_UNIT (gnu_return_type)\n+\t    && !TREE_CONSTANT (TYPE_SIZE_UNIT (gnu_return_type)))\n \t  {\n \t    returns_by_target_ptr = true;\n \t    gnu_param_list"}, {"sha": "339ac3adee6a5eecc1b12fe7c4c1b2adbfc32af2", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -1,3 +1,9 @@\n+2008-04-18  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* gnat.dg/specs/varsize_return.ads: New test.\n+\t* gnat.dg/specs/varsize_return_pkg1.ad[sb]: New helper.\n+\t* gnat.dg/specs/varsize_return_pkg2.ad[sb]: Likewise.\n+\n 2008-04-17  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/35773"}, {"sha": "b6c55ed635eb6e52f5724741c9d485c7d361a64c", "filename": "gcc/testsuite/gnat.dg/specs/varsize_return.ads", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return.ads?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -0,0 +1,10 @@\n+-- { dg-do compile }\n+-- { dg-options \"-gnatws\" }\n+\n+with Varsize_Return_Pkg1;\n+\n+package Varsize_Return is\n+\n+  package P is new Varsize_Return_Pkg1 (Id_T => Natural);\n+\n+end Varsize_Return;"}, {"sha": "59b283c2bb2886701f2729b8c05277e5c38e8ebe", "filename": "gcc/testsuite/gnat.dg/specs/varsize_return_pkg1.adb", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg1.adb?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -0,0 +1,24 @@\n+package body Varsize_Return_Pkg1 is\n+  \n+  function Is_Fixed return Boolean is\n+  begin\n+    return True;\n+  end Is_Fixed;\n+\n+  function Do_Item (I : Natural) return Variable_Data_Fixed_T is\n+    It : Variable_Data_Fixed_T;\n+  begin\n+    return It;\n+  end Do_Item;\n+\n+  My_Db : Db.T;\n+\n+  procedure Run is\n+    Kitem : Variable_Data_Fixed_T;\n+    I : Natural;\n+  begin\n+    Kitem := Db.Get (My_Db);\n+    Kitem := Do_Item (I);\n+  end Run;\n+\n+end Varsize_Return_Pkg1;"}, {"sha": "792b7a5ce2c92387433a983d5109461b53a71151", "filename": "gcc/testsuite/gnat.dg/specs/varsize_return_pkg1.ads", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg1.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg1.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg1.ads?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -0,0 +1,26 @@\n+-- { dg-excess-errors \"no code generated\" }\n+\n+with Varsize_Return_Pkg2;\n+\n+generic\n+  type Id_T is range <>;\n+package Varsize_Return_Pkg1 is\n+  \n+  type Variable_Data_T (Fixed : Boolean := False) is\n+    record\n+      case Fixed is\n+        when True =>\n+          Length : Natural;\n+        when False =>\n+          null;\n+      end case;\n+    end record;\n+  \n+  function Is_Fixed return Boolean;\n+\n+  type Variable_Data_Fixed_T is new Variable_Data_T (Is_Fixed);\n+  \n+  package Db is new Varsize_Return_Pkg2 (Id_T => Id_T,\n+                                         Data_T => Variable_Data_Fixed_T);\n+\n+end Varsize_Return_Pkg1;"}, {"sha": "d89255285120d4b552f872de8a86e6e1de3c62d5", "filename": "gcc/testsuite/gnat.dg/specs/varsize_return_pkg2.adb", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg2.adb?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -0,0 +1,7 @@\n+package body Varsize_Return_Pkg2 is\n+  function Get (X : T) return Data_T is\n+    Result : Data_T;\n+  begin\n+    return Result;\n+  end;\n+end Varsize_Return_Pkg2;"}, {"sha": "9d1abb96cd785c853a305b5870d499b3b6c44658", "filename": "gcc/testsuite/gnat.dg/specs/varsize_return_pkg2.ads", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg2.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9a089d8b0620133f2111a2fd2fc5064166ed02a6/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg2.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fspecs%2Fvarsize_return_pkg2.ads?ref=9a089d8b0620133f2111a2fd2fc5064166ed02a6", "patch": "@@ -0,0 +1,11 @@\n+-- { dg-excess-errors \"no code generated\" }\n+\n+generic\n+  type Id_T is private;\n+  type Data_T is private;\n+package Varsize_Return_Pkg2 is\n+  type T is private;\n+  function Get (X : T) return Data_T;\n+private\n+  type T is null record;\n+end Varsize_Return_Pkg2;"}]}