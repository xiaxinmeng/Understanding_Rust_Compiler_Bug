{"sha": "4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NGY5NWRlZmFhOWM5ZTYwZjNlMDdmNjI5YmRlODE4OWZiNmFmMTljZg==", "commit": {"author": {"name": "Hristian Kirtchev", "email": "kirtchev@adacore.com", "date": "2018-09-26T09:18:23Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-09-26T09:18:23Z"}, "message": "[Ada] Pair miscount in Dynamic_HTable.Put\n\nThis patch corrects the logic of GNAT.Dynamic_HTables.Dynamic_HTable.Put to\nupdate the number of key-value pairs in the hash table only when the put is\nadding a new pair, rather than updating the value of an existing pair.\n\n2018-09-26  Hristian Kirtchev  <kirtchev@adacore.com>\n\ngcc/ada/\n\n\t* libgnat/g-dynhta.adb (Prepend_Or_Replace): Update the number\n\tof key-value pairs in the hash table only when adding a brand\n\tnew pair.\n\ngcc/testsuite/\n\n\t* gnat.dg/dynhash1.adb: New testcase.\n\nFrom-SVN: r264623", "tree": {"sha": "5240b291614aa754bc7f6ef295f95a3c8258f4ab", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5240b291614aa754bc7f6ef295f95a3c8258f4ab"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/comments", "author": {"login": "kirtchev-adacore", "id": 60669983, "node_id": "MDQ6VXNlcjYwNjY5OTgz", "avatar_url": "https://avatars.githubusercontent.com/u/60669983?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kirtchev-adacore", "html_url": "https://github.com/kirtchev-adacore", "followers_url": "https://api.github.com/users/kirtchev-adacore/followers", "following_url": "https://api.github.com/users/kirtchev-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/kirtchev-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/kirtchev-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kirtchev-adacore/subscriptions", "organizations_url": "https://api.github.com/users/kirtchev-adacore/orgs", "repos_url": "https://api.github.com/users/kirtchev-adacore/repos", "events_url": "https://api.github.com/users/kirtchev-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/kirtchev-adacore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "3e4ade66c6749652de644017de696f9c1e60f3ae", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3e4ade66c6749652de644017de696f9c1e60f3ae", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3e4ade66c6749652de644017de696f9c1e60f3ae"}], "stats": {"total": 73, "additions": 71, "deletions": 2}, "files": [{"sha": "b9187b6338ebc81e0eefec6dea5ed3d3adf2ced2", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "patch": "@@ -1,3 +1,9 @@\n+2018-09-26  Hristian Kirtchev  <kirtchev@adacore.com>\n+\n+\t* libgnat/g-dynhta.adb (Prepend_Or_Replace): Update the number\n+\tof key-value pairs in the hash table only when adding a brand\n+\tnew pair.\n+\n 2018-09-26  Sergey Rybin  <rybin@adacore.com>\n \n \t* doc/gnat_ugn/gnat_utility_programs.rst: Add note about"}, {"sha": "e442514f3b2ac17d1f5c3df76af616c0e8410c73", "filename": "gcc/ada/libgnat/g-dynhta.adb", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Fada%2Flibgnat%2Fg-dynhta.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Fada%2Flibgnat%2Fg-dynhta.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-dynhta.adb?ref=4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "patch": "@@ -544,6 +544,9 @@ package body GNAT.Dynamic_HTables is\n             Detach (Nod);\n             Free   (Nod);\n \n+            --  The number of key-value pairs is updated when the hash table\n+            --  contains a valid node which represents the pair.\n+\n             T.Pairs := T.Pairs - 1;\n \n             --  Compress the hash table if the load factor drops below\n@@ -1121,6 +1124,11 @@ package body GNAT.Dynamic_HTables is\n             Nod := new Node'(Key, Value, null, null);\n \n             Prepend (Nod, Head);\n+\n+            --  The number of key-value pairs must be updated for a prepend,\n+            --  never for a replace.\n+\n+            T.Pairs := T.Pairs + 1;\n          end Prepend_Or_Replace;\n \n          --  Local variables\n@@ -1148,8 +1156,6 @@ package body GNAT.Dynamic_HTables is\n \n          Prepend_Or_Replace (Head);\n \n-         T.Pairs := T.Pairs + 1;\n-\n          --  Expand the hash table if the ratio of pairs to buckets goes over\n          --  Expansion_Threshold.\n "}, {"sha": "6cb08cdafbb66bcdc377978ead89874d2dc2f4b8", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "patch": "@@ -1,3 +1,7 @@\n+2018-09-26  Hristian Kirtchev  <kirtchev@adacore.com>\n+\n+\t* gnat.dg/dynhash1.adb: New testcase.\n+\n 2018-09-26  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* gnat.dg/sets1.adb: New testcase."}, {"sha": "cbe241a4c7c873801467f98173f10fcaafed3046", "filename": "gcc/testsuite/gnat.dg/dynhash1.adb", "status": "added", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Ftestsuite%2Fgnat.dg%2Fdynhash1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f95defaa9c9e60f3e07f629bde8189fb6af19cf/gcc%2Ftestsuite%2Fgnat.dg%2Fdynhash1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fdynhash1.adb?ref=4f95defaa9c9e60f3e07f629bde8189fb6af19cf", "patch": "@@ -0,0 +1,53 @@\n+with Ada.Text_IO;          use Ada.Text_IO;\n+with GNAT;                 use GNAT;\n+with GNAT.Dynamic_HTables; use GNAT.Dynamic_HTables;\n+\n+procedure Dynhash1 is\n+   function Hash (Key : Integer) return Bucket_Range_Type is\n+   begin\n+      return Bucket_Range_Type (Key);\n+   end Hash;\n+\n+   package Integer_Hash_Tables is new Dynamic_HTable\n+     (Key_Type              => Integer,\n+      Value_Type            => Integer,\n+      No_Value              => 0,\n+      Expansion_Threshold   => 1.3,\n+      Expansion_Factor      => 2,\n+      Compression_Threshold => 0.3,\n+      Compression_Factor    => 2,\n+      \"=\"                   => \"=\",\n+      Hash                  => Hash);\n+   use Integer_Hash_Tables;\n+\n+   Siz : Natural;\n+   T   : Instance;\n+\n+begin\n+   T := Create (8);\n+\n+   Put (T, 1, 1);\n+   Put (T, 1, 2);\n+   Put (T, 1, 3);\n+\n+   Siz := Size (T);\n+\n+   if Siz /= 1 then\n+      Put_Line (\"ERROR: Put: wrong size\");\n+      Put_Line (\"expected: 1\");\n+      Put_Line (\"got     :\" & Siz'Img);\n+   end if;\n+\n+   Delete (T, 1);\n+   Delete (T, 1);\n+\n+   Siz := Size (T);\n+\n+   if Siz /= 0 then\n+      Put_Line (\"ERROR: Delete: wrong size\");\n+      Put_Line (\"expected: 0\");\n+      Put_Line (\"got     :\" & Siz'Img);\n+   end if;\n+\n+   Destroy (T);\n+end Dynhash1;"}]}