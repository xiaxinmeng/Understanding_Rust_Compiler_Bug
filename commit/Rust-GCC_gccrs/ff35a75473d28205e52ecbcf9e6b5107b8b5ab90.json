{"sha": "ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "node_id": "C_kwDOANBUbNoAKGZmMzVhNzU0NzNkMjgyMDVlNTJlY2JjZjllNmI1MTA3YjhiNWFiOTA", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2022-06-03T13:52:22Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2022-06-03T13:54:02Z"}, "message": "OpenMP/Fortran: Add support for firstprivate and allocate clauses on scope construct\n\nFortran commit to C/C++/backend commit\nr13-862-gf38b20d68fade5a922b9f68c4c3841e653d1b83c\n\ngcc/fortran/ChangeLog:\n\n\t* openmp.cc (OMP_SCOPE_CLAUSES): Add firstprivate and allocate.\n\nlibgomp/ChangeLog:\n\n\t* libgomp.texi (OpenMP 5.2): Mark scope w/ firstprivate/allocate as Y.\n\t* testsuite/libgomp.fortran/scope-2.f90: New test.\n\ngcc/testsuite/ChangeLog:\n\n\t* gfortran.dg/gomp/scope-5.f90: New test.\n\t* gfortran.dg/gomp/scope-6.f90: New test.", "tree": {"sha": "fabbe2b84e5a22ae4936faa6a0455fa3dab3713e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fabbe2b84e5a22ae4936faa6a0455fa3dab3713e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "43c013df02fdb07f9b7a5e7e6669e6d69769d451", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/43c013df02fdb07f9b7a5e7e6669e6d69769d451", "html_url": "https://github.com/Rust-GCC/gccrs/commit/43c013df02fdb07f9b7a5e7e6669e6d69769d451"}], "stats": {"total": 94, "additions": 92, "deletions": 2}, "files": [{"sha": "d12cec43d64ebe9f07f9ae0db3f8be5eb256d5fd", "filename": "gcc/fortran/openmp.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/gcc%2Ffortran%2Fopenmp.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/gcc%2Ffortran%2Fopenmp.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.cc?ref=ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "patch": "@@ -3682,7 +3682,8 @@ gfc_match_oacc_routine (void)\n    | OMP_CLAUSE_PRIVATE | OMP_CLAUSE_LASTPRIVATE | OMP_CLAUSE_REDUCTION)\n \n #define OMP_SCOPE_CLAUSES \\\n-  (omp_mask (OMP_CLAUSE_PRIVATE) | OMP_CLAUSE_REDUCTION)\n+  (omp_mask (OMP_CLAUSE_PRIVATE) |OMP_CLAUSE_FIRSTPRIVATE\t\t\\\n+   | OMP_CLAUSE_REDUCTION | OMP_CLAUSE_ALLOCATE)\n #define OMP_SECTIONS_CLAUSES \\\n   (omp_mask (OMP_CLAUSE_PRIVATE) | OMP_CLAUSE_FIRSTPRIVATE\t\t\\\n    | OMP_CLAUSE_LASTPRIVATE | OMP_CLAUSE_REDUCTION | OMP_CLAUSE_ALLOCATE)"}, {"sha": "baddae51b421eaefe0c26d0298d16661eb23c243", "filename": "gcc/testsuite/gfortran.dg/gomp/scope-5.f90", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fscope-5.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fscope-5.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fscope-5.f90?ref=ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "patch": "@@ -0,0 +1,9 @@\n+! { dg-do compile }\n+\n+subroutine foo ()\n+  integer f\n+  f = 0;\n+  !$omp scope firstprivate(f)\t! { dg-error \"firstprivate variable 'f' is private in outer context\" }\n+    f = f + 1\n+  !$omp end scope\n+end"}, {"sha": "9c595b1e1173485ba76f38a2b6ca2fd6be93cb3d", "filename": "gcc/testsuite/gfortran.dg/gomp/scope-6.f90", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fscope-6.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fscope-6.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fscope-6.f90?ref=ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "patch": "@@ -0,0 +1,23 @@\n+! { dg-additional-options \"-fdump-tree-original\" }\n+\n+module m\n+  use iso_c_binding\n+  !use omp_lib, only: omp_allocator_handle_kind\n+  implicit none\n+  integer, parameter :: omp_allocator_handle_kind = c_intptr_t\n+  integer :: a = 0, b = 42, c = 0\n+\n+contains\n+  subroutine foo (h)\n+  integer(omp_allocator_handle_kind), value :: h \n+  !$omp scope private (a) firstprivate (b) reduction (+: c) allocate ( h : a , b , c)\n+    if (b /= 42) &\n+      error stop\n+    a = 36\n+    b = 15\n+    c = c + 1\n+  !$omp end scope\n+  end\n+end\n+\n+! { dg-final { scan-tree-dump \"omp scope private\\\\(a\\\\) firstprivate\\\\(b\\\\) reduction\\\\(\\\\+:c\\\\) allocate\\\\(allocator\\\\(D\\\\.\\[0-9\\]+\\\\):a) allocate\\\\(allocator\\\\(D\\\\.\\[0-9\\]+\\\\):b) allocate\\\\(allocator\\\\(D\\\\.\\[0-9\\]+\\\\):c)\" \"original\" } }"}, {"sha": "11613bf7599c526c9bce7949f870a7a40d3d326a", "filename": "libgomp/libgomp.texi", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/libgomp%2Flibgomp.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/libgomp%2Flibgomp.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Flibgomp.texi?ref=ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "patch": "@@ -386,7 +386,7 @@ The OpenMP 4.5 specification is fully supported.\n @item Deprecation of delimited form of @code{declare target} @tab N @tab\n @item Reproducible semantics changed for @code{order(concurrent)} @tab N @tab\n @item @code{allocate} and @code{firstprivate} clauses on @code{scope}\n-      @tab N @tab\n+      @tab Y @tab\n @item @code{ompt_callback_work} @tab N @tab\n @item Default map-type for @code{map} clause in @code{target enter/exit data}\n       @tab N @tab"}, {"sha": "f2e1593403ead34d8417f1de26ae7f231e4ca6db", "filename": "libgomp/testsuite/libgomp.fortran/scope-2.f90", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fscope-2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ff35a75473d28205e52ecbcf9e6b5107b8b5ab90/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fscope-2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fscope-2.f90?ref=ff35a75473d28205e52ecbcf9e6b5107b8b5ab90", "patch": "@@ -0,0 +1,57 @@\n+program main\n+  implicit none\n+  integer a(0:63)\n+  integer r, r2, i, n\n+  a = 0\n+  r = 0\n+  r2 = 0\n+  n = 64\n+  !$omp parallel\n+    !$omp scope\n+     !$omp scope firstprivate (n)\n+      !$omp do\n+      do i = 0, 63\n+       a(i) = a(i) + 1\n+      end do\n+     !$omp end scope nowait\n+    !$omp end scope nowait\n+\n+    !$omp scope reduction(+: r) firstprivate (n)\n+      !$omp do\n+      do i = 0, 63\n+        r = r + i\n+        if (a(i) /= 1) &\n+          error stop\n+      end do\n+      !$omp end do nowait\n+      !$omp barrier\n+      if (n /= 64) then\n+        error stop\n+      else\n+        n = 128\n+      end if\n+    !$omp end scope nowait\n+\n+    !$omp barrier\n+    if (r /= 64 * 63 / 2) &\n+      error stop\n+    !$omp scope private (i)\n+     !$omp scope reduction(+: r2)\n+      !$omp do\n+      do i = 0, 63\n+          r2 = r2 + 2 * i\n+          a(i) = a(i) + i\n+      end do\n+      !$omp end do nowait\n+     !$omp end scope\n+    !$omp end scope nowait\n+    if (r2 /= 64 * 63) &\n+      error stop\n+    !$omp do\n+    do i = 0, 63\n+      if (a(i) /= i + 1) &\n+        error stop\n+    end do\n+    !$omp end do nowait\n+  !$omp end parallel\n+end program"}]}