{"sha": "ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZWEwNGE5ZmYxZDBlZDYwMzMyMjk4ZWUwN2Q5NGMxYzczMzg0YjIxZg==", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-07-15T12:47:24Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-07-15T12:49:30Z"}, "message": "Add DefId mappings to TyTy::FnType\n\nThis adds the def id to trait items and nested items, this will help with\noptional trait item compilation.", "tree": {"sha": "d18a4bc9c72eb9c357d3bf842c5e5e57c414d070", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d18a4bc9c72eb9c357d3bf842c5e5e57c414d070"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "73ac7c5a1eca2db1c95ae5b7c3ee9f206ce9aa9d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/73ac7c5a1eca2db1c95ae5b7c3ee9f206ce9aa9d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/73ac7c5a1eca2db1c95ae5b7c3ee9f206ce9aa9d"}], "stats": {"total": 38, "additions": 26, "deletions": 12}, "files": [{"sha": "6e4c0b183aa1ced46eea1d4660e143bff5e7e488", "filename": "gcc/rust/hir/rust-ast-lower-implitem.h", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Fhir%2Frust-ast-lower-implitem.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Fhir%2Frust-ast-lower-implitem.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-implitem.h?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -362,7 +362,7 @@ class ASTLowerTraitItem : public ASTLoweringBase\n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, func.get_node_id (),\n \t\t\t\t   mappings->get_next_hir_id (crate_num),\n-\t\t\t\t   UNKNOWN_LOCAL_DEFID);\n+\t\t\t\t   mappings->get_next_localdef_id (crate_num));\n \n     translated\n       = new HIR::TraitItemFunc (mapping, std::move (decl),\n@@ -426,7 +426,7 @@ class ASTLowerTraitItem : public ASTLoweringBase\n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, method.get_node_id (),\n \t\t\t\t   mappings->get_next_hir_id (crate_num),\n-\t\t\t\t   UNKNOWN_LOCAL_DEFID);\n+\t\t\t\t   mappings->get_next_localdef_id (crate_num));\n \n     translated\n       = new HIR::TraitItemFunc (mapping, std::move (decl),\n@@ -445,7 +445,7 @@ class ASTLowerTraitItem : public ASTLoweringBase\n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, constant.get_node_id (),\n \t\t\t\t   mappings->get_next_hir_id (crate_num),\n-\t\t\t\t   UNKNOWN_LOCAL_DEFID);\n+\t\t\t\t   mappings->get_next_localdef_id (crate_num));\n \n     translated = new HIR::TraitItemConst (mapping, constant.get_identifier (),\n \t\t\t\t\t  std::unique_ptr<HIR::Type> (type),\n@@ -461,7 +461,7 @@ class ASTLowerTraitItem : public ASTLoweringBase\n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, type.get_node_id (),\n \t\t\t\t   mappings->get_next_hir_id (crate_num),\n-\t\t\t\t   UNKNOWN_LOCAL_DEFID);\n+\t\t\t\t   mappings->get_next_localdef_id (crate_num));\n \n     translated\n       = new HIR::TraitItemType (mapping, type.get_identifier (),"}, {"sha": "9df6b746bb7737c601ce0dbe7e3cb46df363472b", "filename": "gcc/rust/hir/rust-ast-lower-stmt.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Fhir%2Frust-ast-lower-stmt.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Fhir%2Frust-ast-lower-stmt.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-stmt.h?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -283,7 +283,7 @@ class ASTLoweringStmt : public ASTLoweringBase\n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, function.get_node_id (),\n \t\t\t\t   mappings->get_next_hir_id (crate_num),\n-\t\t\t\t   UNKNOWN_LOCAL_DEFID);\n+\t\t\t\t   mappings->get_next_localdef_id (crate_num));\n \n     mappings->insert_location (crate_num,\n \t\t\t       function_body->get_mappings ().get_hirid (),"}, {"sha": "5f6fcd99cdc55c02b355b1ab5fa1d6fc53660861", "filename": "gcc/rust/typecheck/rust-hir-type-check-implitem.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-implitem.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-implitem.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-implitem.h?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -135,6 +135,7 @@ class TypeCheckTopLevelImplItem : public TypeCheckBase\n       }\n \n     auto fnType = new TyTy::FnType (function.get_mappings ().get_hirid (),\n+\t\t\t\t    function.get_mappings ().get_defid (),\n \t\t\t\t    function.get_function_name (),\n \t\t\t\t    function.is_method (), std::move (params),\n \t\t\t\t    ret_type, std::move (substitutions));"}, {"sha": "ba821ca82aa5148ce5ba764e7a20cb1acd40b15f", "filename": "gcc/rust/typecheck/rust-hir-type-check-stmt.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-stmt.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-stmt.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-stmt.h?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -276,6 +276,7 @@ class TypeCheckStmt : public TypeCheckBase\n       }\n \n     auto fnType = new TyTy::FnType (function.get_mappings ().get_hirid (),\n+\t\t\t\t    function.get_mappings ().get_defid (),\n \t\t\t\t    function.get_function_name (), false,\n \t\t\t\t    std::move (params), ret_type,\n \t\t\t\t    std::move (substitutions));"}, {"sha": "dd3dd751ad6cd3ff3e9e846f500f3fcdadd0614b", "filename": "gcc/rust/typecheck/rust-hir-type-check-toplevel.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-toplevel.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-toplevel.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-toplevel.h?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -229,6 +229,7 @@ class TypeCheckTopLevel : public TypeCheckBase\n       }\n \n     auto fnType = new TyTy::FnType (function.get_mappings ().get_hirid (),\n+\t\t\t\t    function.get_mappings ().get_defid (),\n \t\t\t\t    function.get_function_name (), false,\n \t\t\t\t    std::move (params), ret_type,\n \t\t\t\t    std::move (substitutions));"}, {"sha": "cb2896c0bb496b02f8e2cac045261293bb67a688", "filename": "gcc/rust/typecheck/rust-hir-type-check.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check.cc?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -498,6 +498,7 @@ TraitItemReference::get_type_from_fn (/*const*/ HIR::TraitItemFunc &fn) const\n     }\n \n   return new TyTy::FnType (fn.get_mappings ().get_hirid (),\n+\t\t\t   fn.get_mappings ().get_defid (),\n \t\t\t   function.get_function_name (), function.is_method (),\n \t\t\t   std::move (params), ret_type, substitutions);\n }"}, {"sha": "ab473100d1e7579f1dfd627f9399368255c454a2", "filename": "gcc/rust/typecheck/rust-tyty.cc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -715,7 +715,7 @@ FnType::clone ()\n     cloned_params.push_back (\n       std::pair<HIR::Pattern *, BaseType *> (p.first, p.second->clone ()));\n \n-  return new FnType (get_ref (), get_ty_ref (), get_identifier (),\n+  return new FnType (get_ref (), get_ty_ref (), get_id (), get_identifier (),\n \t\t     is_method_flag, std::move (cloned_params),\n \t\t     get_return_type ()->clone (), clone_substs (),\n \t\t     get_combined_refs ());"}, {"sha": "e2f15956dcdc071a674d7ae28b828327d5d44c0a", "filename": "gcc/rust/typecheck/rust-tyty.h", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea04a9ff1d0ed60332298ee07d94c1c73384b21f/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.h?ref=ea04a9ff1d0ed60332298ee07d94c1c73384b21f", "patch": "@@ -929,27 +929,34 @@ class ADTType : public BaseType, public SubstitutionRef\n class FnType : public BaseType, public SubstitutionRef\n {\n public:\n-  FnType (HirId ref, std::string identifier, bool is_method,\n+  FnType (HirId ref, DefId id, std::string identifier, bool is_method,\n \t  std::vector<std::pair<HIR::Pattern *, BaseType *> > params,\n \t  BaseType *type, std::vector<SubstitutionParamMapping> subst_refs,\n \t  std::set<HirId> refs = std::set<HirId> ())\n     : BaseType (ref, ref, TypeKind::FNDEF, refs),\n       SubstitutionRef (std::move (subst_refs),\n \t\t       SubstitutionArgumentMappings::error ()),\n       params (std::move (params)), type (type), is_method_flag (is_method),\n-      identifier (identifier)\n-  {}\n+      identifier (identifier), id (id)\n+  {\n+    LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+    rust_assert (local_def_id != UNKNOWN_LOCAL_DEFID);\n+  }\n \n-  FnType (HirId ref, HirId ty_ref, std::string identifier, bool is_method,\n+  FnType (HirId ref, HirId ty_ref, DefId id, std::string identifier,\n+\t  bool is_method,\n \t  std::vector<std::pair<HIR::Pattern *, BaseType *> > params,\n \t  BaseType *type, std::vector<SubstitutionParamMapping> subst_refs,\n \t  std::set<HirId> refs = std::set<HirId> ())\n     : BaseType (ref, ty_ref, TypeKind::FNDEF, refs),\n       SubstitutionRef (std::move (subst_refs),\n \t\t       SubstitutionArgumentMappings::error ()),\n       params (params), type (type), is_method_flag (is_method),\n-      identifier (identifier)\n-  {}\n+      identifier (identifier), id (id)\n+  {\n+    LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+    rust_assert (local_def_id != UNKNOWN_LOCAL_DEFID);\n+  }\n \n   void accept_vis (TyVisitor &vis) override;\n \n@@ -974,6 +981,8 @@ class FnType : public BaseType, public SubstitutionRef\n     return is_method_flag;\n   }\n \n+  DefId get_id () const { return id; }\n+\n   // get the Self type for the method\n   BaseType *get_self_type () const\n   {\n@@ -1026,6 +1035,7 @@ class FnType : public BaseType, public SubstitutionRef\n   BaseType *type;\n   bool is_method_flag;\n   std::string identifier;\n+  DefId id;\n };\n \n class FnPtr : public BaseType"}]}