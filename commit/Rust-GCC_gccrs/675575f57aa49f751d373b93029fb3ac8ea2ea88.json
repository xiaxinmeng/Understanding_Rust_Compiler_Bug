{"sha": "675575f57aa49f751d373b93029fb3ac8ea2ea88", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njc1NTc1ZjU3YWE0OWY3NTFkMzczYjkzMDI5ZmIzYWM4ZWEyZWE4OA==", "commit": {"author": {"name": "DJ Delorie", "email": "dj@redhat.com", "date": "2007-12-12T01:38:10Z"}, "committer": {"name": "DJ Delorie", "email": "dj@gcc.gnu.org", "date": "2007-12-12T01:38:10Z"}, "message": "charset.c (convert_using_iconv): Close out any shift states, returning to the initial state.\n\n* charset.c (convert_using_iconv): Close out any shift states,\nreturning to the initial state.\n\nFrom-SVN: r130785", "tree": {"sha": "0b62ddc2f572ce42be0b6c205799d426377b9049", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0b62ddc2f572ce42be0b6c205799d426377b9049"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/675575f57aa49f751d373b93029fb3ac8ea2ea88", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/675575f57aa49f751d373b93029fb3ac8ea2ea88", "html_url": "https://github.com/Rust-GCC/gccrs/commit/675575f57aa49f751d373b93029fb3ac8ea2ea88", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/675575f57aa49f751d373b93029fb3ac8ea2ea88/comments", "author": null, "committer": null, "parents": [{"sha": "a2b677873b49b23724eb0fdd1725e490b91d8da6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a2b677873b49b23724eb0fdd1725e490b91d8da6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a2b677873b49b23724eb0fdd1725e490b91d8da6"}], "stats": {"total": 30, "additions": 26, "deletions": 4}, "files": [{"sha": "217294af56342d2b9d66a0028220130762bd5b4c", "filename": "libcpp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/675575f57aa49f751d373b93029fb3ac8ea2ea88/libcpp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/675575f57aa49f751d373b93029fb3ac8ea2ea88/libcpp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2FChangeLog?ref=675575f57aa49f751d373b93029fb3ac8ea2ea88", "patch": "@@ -1,3 +1,8 @@\n+2007-12-11  DJ Delorie  <dj@redhat.com>\n+\n+\t* charset.c (convert_using_iconv): Close out any shift states,\n+\treturning to the initial state.\n+\n 2007-12-06  Tom Tromey  <tromey@redhat.com>\n \n \tPR c/29172:"}, {"sha": "5db8fc134303039a0f0cdb0b87ec3a117c626a9a", "filename": "libcpp/charset.c", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/675575f57aa49f751d373b93029fb3ac8ea2ea88/libcpp%2Fcharset.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/675575f57aa49f751d373b93029fb3ac8ea2ea88/libcpp%2Fcharset.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2Fcharset.c?ref=675575f57aa49f751d373b93029fb3ac8ea2ea88", "patch": "@@ -548,6 +548,15 @@ convert_no_conversion (iconv_t cd ATTRIBUTE_UNUSED,\n /* And this one uses the system iconv primitive.  It's a little\n    different, since iconv's interface is a little different.  */\n #if HAVE_ICONV\n+\n+#define CONVERT_ICONV_GROW_BUFFER \\\n+  do { \\\n+      outbytesleft += OUTBUF_BLOCK_SIZE; \\\n+      to->asize += OUTBUF_BLOCK_SIZE; \\\n+      to->text = XRESIZEVEC (uchar, to->text, to->asize); \\\n+      outbuf = (char *)to->text + to->asize - outbytesleft; \\\n+  } while (0)\n+\n static bool\n convert_using_iconv (iconv_t cd, const uchar *from, size_t flen,\n \t\t     struct _cpp_strbuf *to)\n@@ -570,16 +579,24 @@ convert_using_iconv (iconv_t cd, const uchar *from, size_t flen,\n       iconv (cd, &inbuf, &inbytesleft, &outbuf, &outbytesleft);\n       if (__builtin_expect (inbytesleft == 0, 1))\n \t{\n+\t  /* Close out any shift states, returning to the initial state.  */\n+\t  if (iconv (cd, 0, 0, &outbuf, &outbytesleft) == (size_t)-1)\n+\t    {\n+\t      if (errno != E2BIG)\n+\t\treturn false;\n+\n+\t      CONVERT_ICONV_GROW_BUFFER;\n+\t      if (iconv (cd, 0, 0, &outbuf, &outbytesleft) == (size_t)-1)\n+\t\treturn false;\n+\t    }\n+\n \t  to->len = to->asize - outbytesleft;\n \t  return true;\n \t}\n       if (errno != E2BIG)\n \treturn false;\n \n-      outbytesleft += OUTBUF_BLOCK_SIZE;\n-      to->asize += OUTBUF_BLOCK_SIZE;\n-      to->text = XRESIZEVEC (uchar, to->text, to->asize);\n-      outbuf = (char *)to->text + to->asize - outbytesleft;\n+      CONVERT_ICONV_GROW_BUFFER;\n     }\n }\n #else"}]}