{"sha": "799478b8914c438f7a33eb319efbae69c81f2111", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Nzk5NDc4Yjg5MTRjNDM4ZjdhMzNlYjMxOWVmYmFlNjljODFmMjExMQ==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2021-02-16T16:39:49Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2021-02-16T16:39:49Z"}, "message": "Fortran: %re/%im fixes for OpenMP/OpenACC + gfc_is_simplify_contiguous\n\ngcc/fortran/ChangeLog:\n\n\t* expr.c (gfc_is_simplify_contiguous): Handle REF_INQUIRY, i.e.\n\t%im and %re which are EXPR_VARIABLE.\n\t* openmp.c (resolve_omp_clauses): Diagnose %re/%im explicitly.\n\ngcc/testsuite/ChangeLog:\n\n\t* gfortran.dg/goacc/ref_inquiry.f90: New test.\n\t* gfortran.dg/gomp/ref_inquiry.f90: New test.", "tree": {"sha": "4a6c9bceb761178477d37e7429587d4af16528f8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4a6c9bceb761178477d37e7429587d4af16528f8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/799478b8914c438f7a33eb319efbae69c81f2111", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/799478b8914c438f7a33eb319efbae69c81f2111", "html_url": "https://github.com/Rust-GCC/gccrs/commit/799478b8914c438f7a33eb319efbae69c81f2111", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/799478b8914c438f7a33eb319efbae69c81f2111/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "72d78655a91bb2f89ac4432cfd6374380d6f9987", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/72d78655a91bb2f89ac4432cfd6374380d6f9987", "html_url": "https://github.com/Rust-GCC/gccrs/commit/72d78655a91bb2f89ac4432cfd6374380d6f9987"}], "stats": {"total": 105, "additions": 105, "deletions": 0}, "files": [{"sha": "92a6700568d6aee4e7fd493a690d7220f3d38639", "filename": "gcc/fortran/expr.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ffortran%2Fexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ffortran%2Fexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fexpr.c?ref=799478b8914c438f7a33eb319efbae69c81f2111", "patch": "@@ -5854,6 +5854,8 @@ gfc_is_simply_contiguous (gfc_expr *expr, bool strict, bool permit_element)\n \tpart_ref  = ref;\n       else if (ref->type == REF_SUBSTRING)\n \treturn false;\n+      else if (ref->type == REF_INQUIRY)\n+\treturn false;\n       else if (ref->u.ar.type != AR_ELEMENT)\n \tar = &ref->u.ar;\n     }"}, {"sha": "1e541ebdafae665b69ea84725fc54d35a5c8364b", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=799478b8914c438f7a33eb319efbae69c81f2111", "patch": "@@ -5218,6 +5218,14 @@ resolve_omp_clauses (gfc_code *code, gfc_omp_clauses *omp_clauses,\n \t\t\t\t&& array_ref->next->type == REF_SUBSTRING)))\n \t\t      gfc_error (\"Unexpected substring reference in %s clause \"\n \t\t\t\t \"at %L\", name, &n->where);\n+\t\t    else if (array_ref && array_ref->type == REF_INQUIRY)\n+\t\t      {\n+\t\t\tgcc_assert (array_ref->u.i == INQUIRY_RE\n+\t\t\t\t    || array_ref->u.i == INQUIRY_IM);\n+\t\t\tgfc_error (\"Unexpected complex-parts designator \"\n+\t\t\t\t   \"reference in %s clause at %L\",\n+\t\t\t\t   name, &n->where);\n+\t\t      }\n \t\t    else if (!resolved\n \t\t\t|| n->expr->expr_type != EXPR_VARIABLE\n \t\t\t|| array_ref->next"}, {"sha": "69dd38e5197430bbbb4ddfdb25122458c832bf10", "filename": "gcc/testsuite/gfortran.dg/goacc/ref_inquiry.f90", "status": "added", "additions": 56, "deletions": 0, "changes": 56, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fref_inquiry.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fref_inquiry.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fref_inquiry.f90?ref=799478b8914c438f7a33eb319efbae69c81f2111", "patch": "@@ -0,0 +1,56 @@\n+! Check for <var>%re, ...%im, ...%kind, ...%len\n+! Cf. also OpenMP's ../gomp/ref_inquiry.f90\n+! Cf. OpenACC spec issue 346\n+! \n+implicit none\n+type t\n+  integer :: i\n+  character :: c\n+  complex :: z\n+  complex :: zz(5)\n+end type t\n+\n+integer :: i\n+character(kind=4, len=5) :: c\n+complex :: z, zz(5)\n+type(t) :: x\n+\n+print *, is_contiguous(zz(:)%re)\n+\n+! inquiry function; expr_type != EXPR_VARIABLE:\n+!$acc enter data copyin(i%kind, c%len)     ! { dg-error \"not a proper array section\" }\n+!$acc enter data copyin(x%i%kind)          ! { dg-error \"not a proper array section\" }\n+!$acc enter data copyin(x%c%len)           ! { dg-error \"not a proper array section\" }\n+!$acc update self(i%kind, c%len)           ! { dg-error \"not a proper array section\" }\n+!$acc update self(x%i%kind)                ! { dg-error \"not a proper array section\" }\n+!$acc update self(x%c%len)                 ! { dg-error \"not a proper array section\" }\n+\n+! EXPR_VARIABLE\n+!$acc enter data copyin(z%re)    ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc enter data copyin(z%im)    ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc enter data copyin(zz%re)   ! { dg-error \"not a proper array section\" }\n+                                 ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+!$acc enter data copyin(zz%im)   ! { dg-error \"not a proper array section\" }\n+                                 ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+\n+!$acc enter data copyin(x%z%re)  ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc enter data copyin(x%z%im)  ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc enter data copyin(x%zz%re) ! { dg-error \"not a proper array section\" }\n+                                 ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+!$acc enter data copyin(x%zz%im) ! { dg-error \"not a proper array section\" }\n+                                 ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+\n+!$acc update self(z%re)         ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc update self(z%im)         ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc update self(zz%re)        ! { dg-error \"not a proper array section\" }\n+                                ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+!$acc update self(zz%im)        ! { dg-error \"not a proper array section\" }\n+                                ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+\n+!$acc update self(x%z%re)       ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc update self(x%z%im)       ! { dg-error \"Unexpected complex-parts designator\" }\n+!$acc update self(x%zz%re)      ! { dg-error \"is not a proper array section\" }\n+                                ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+!$acc update self(x%zz%im)      ! { dg-error \"is not a proper array section\" }\n+                                ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+end"}, {"sha": "374610405601e4549b055d66ff2d415765f67696", "filename": "gcc/testsuite/gfortran.dg/gomp/ref_inquiry.f90", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fref_inquiry.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/799478b8914c438f7a33eb319efbae69c81f2111/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fref_inquiry.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fref_inquiry.f90?ref=799478b8914c438f7a33eb319efbae69c81f2111", "patch": "@@ -0,0 +1,39 @@\n+! Check for <var>%re, ...%im, ...%kind, ...%len\n+! Cf. also OpenACC's ../goacc/ref_inquiry.f90\n+! Cf. also OpenMP spec issue 2661\n+implicit none\n+type t\n+  integer :: i\n+  character :: c\n+  complex :: z\n+  complex :: zz(5)\n+end type t\n+\n+integer :: i\n+character(kind=4, len=5) :: c\n+complex :: z, zz(5)\n+type(t) :: x\n+\n+print *, is_contiguous(zz(:)%re)\n+\n+! inquiry function; expr_type != EXPR_VARIABLE:\n+!$omp target enter data map(to: i%kind, c%len)     ! { dg-error \"not a proper array section\" }\n+!$omp target enter data map(to: x%i%kind)          ! { dg-error \"not a proper array section\" }\n+!$omp target enter data map(to: x%c%len)           ! { dg-error \"not a proper array section\" }\n+\n+! EXPR_VARIABLE\n+!$omp target enter data map(to: z%re)    ! { dg-error \"Unexpected complex-parts designator\" }\n+!$omp target enter data map(to: z%im)    ! { dg-error \"Unexpected complex-parts designator\" }\n+!$omp target enter data map(to: zz%re)   ! { dg-error \"not a proper array section\" }\n+                                         ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+!$omp target enter data map(to: zz%im)   ! { dg-error \"not a proper array section\" }\n+                                         ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+\n+!$omp target enter data map(to: x%z%re)  ! { dg-error \"Unexpected complex-parts designator\" }\n+!$omp target enter data map(to: x%z%im)  ! { dg-error \"Unexpected complex-parts designator\" }\n+!$omp target enter data map(to: x%zz%re) ! { dg-error \"not a proper array section\" }\n+                                         ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+!$omp target enter data map(to: x%zz%im) ! { dg-error \"not a proper array section\" }\n+                                         ! { dg-error \"Array is not contiguous\" \"\" { target *-*-* } .-1 }\n+\n+end"}]}