{"sha": "0712f356374c2cf26015cccfa3141537e42cbb12", "node_id": "C_kwDOANBUbNoAKDA3MTJmMzU2Mzc0YzJjZjI2MDE1Y2NjZmEzMTQxNTM3ZTQyY2JiMTI", "commit": {"author": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2022-03-27T19:35:15Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2022-03-29T18:30:56Z"}, "message": "Fortran: character length of pointer assignments in structure constructors\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/50549\n\t* resolve.cc (resolve_structure_cons): Reject pointer assignments\n\tof character with different lengths in structure constructor.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/50549\n\t* gfortran.dg/char_pointer_assign_7.f90: New test.", "tree": {"sha": "4ec7eedb4089f2bae57143ee671c3f40a46149dd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4ec7eedb4089f2bae57143ee671c3f40a46149dd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0712f356374c2cf26015cccfa3141537e42cbb12", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0712f356374c2cf26015cccfa3141537e42cbb12", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0712f356374c2cf26015cccfa3141537e42cbb12", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0712f356374c2cf26015cccfa3141537e42cbb12/comments", "author": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d886a5248e66ab911391af18bf955beb87ee8461", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d886a5248e66ab911391af18bf955beb87ee8461", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d886a5248e66ab911391af18bf955beb87ee8461"}], "stats": {"total": 51, "additions": 50, "deletions": 1}, "files": [{"sha": "290767723d857056bd928c1cf3686ffc494786b7", "filename": "gcc/fortran/resolve.cc", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0712f356374c2cf26015cccfa3141537e42cbb12/gcc%2Ffortran%2Fresolve.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0712f356374c2cf26015cccfa3141537e42cbb12/gcc%2Ffortran%2Fresolve.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fresolve.cc?ref=0712f356374c2cf26015cccfa3141537e42cbb12", "patch": "@@ -1375,11 +1375,22 @@ resolve_structure_cons (gfc_expr *expr, int init)\n \t  && comp->ts.u.cl->length->expr_type == EXPR_CONSTANT\n \t  && cons->expr->ts.u.cl && cons->expr->ts.u.cl->length\n \t  && cons->expr->ts.u.cl->length->expr_type == EXPR_CONSTANT\n-\t  && cons->expr->rank != 0\n \t  && mpz_cmp (cons->expr->ts.u.cl->length->value.integer,\n \t\t      comp->ts.u.cl->length->value.integer) != 0)\n \t{\n+\t  if (comp->attr.pointer)\n+\t    {\n+\t      HOST_WIDE_INT la, lb;\n+\t      la = gfc_mpz_get_hwi (comp->ts.u.cl->length->value.integer);\n+\t      lb = gfc_mpz_get_hwi (cons->expr->ts.u.cl->length->value.integer);\n+\t      gfc_error (\"Unequal character lengths (%wd/%wd) for pointer \"\n+\t\t\t \"component %qs in constructor at %L\",\n+\t\t\t la, lb, comp->name, &cons->expr->where);\n+\t      t = false;\n+\t    }\n+\n \t  if (cons->expr->expr_type == EXPR_VARIABLE\n+\t      && cons->expr->rank != 0\n \t      && cons->expr->symtree->n.sym->attr.flavor == FL_PARAMETER)\n \t    {\n \t      /* Wrap the parameter in an array constructor (EXPR_ARRAY)"}, {"sha": "08bdf176d8b42df9961e90d59c31d56816b0601e", "filename": "gcc/testsuite/gfortran.dg/char_pointer_assign_7.f90", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0712f356374c2cf26015cccfa3141537e42cbb12/gcc%2Ftestsuite%2Fgfortran.dg%2Fchar_pointer_assign_7.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0712f356374c2cf26015cccfa3141537e42cbb12/gcc%2Ftestsuite%2Fgfortran.dg%2Fchar_pointer_assign_7.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fchar_pointer_assign_7.f90?ref=0712f356374c2cf26015cccfa3141537e42cbb12", "patch": "@@ -0,0 +1,38 @@\n+! { dg-do compile }\n+! PR fortran/50549 - should reject pointer assignments of different lengths\n+! in structure constructors\n+\n+program test\n+  implicit none\n+  type t\n+     character(2), pointer ::  p2\n+  end type t\n+  type t2\n+     character(2), pointer ::  p(:)\n+  end type t2\n+  type td\n+     character(:), pointer ::  pd\n+  end type td\n+  interface\n+     function f1 ()\n+       character(1), pointer :: f1\n+     end function f1\n+     function f2 ()\n+       character(2), pointer :: f2\n+     end function f2\n+  end interface\n+\n+  character(1),    target  ::  p1\n+  character(1),    pointer ::  q1(:)\n+  character(2),    pointer ::  q2(:)\n+  type(t)  :: u\n+  type(t2) :: u2\n+  type(td) :: v\n+  u  = t(p1)    ! { dg-error \"Unequal character lengths\" }\n+  u  = t(f1())  ! { dg-error \"Unequal character lengths\" }\n+  u  = t(f2())  ! OK\n+  u2 = t2(q1)   ! { dg-error \"Unequal character lengths\" }\n+  u2 = t2(q2)   ! OK\n+  v  = td(p1)   ! OK\n+  v  = td(f1()) ! OK\n+end"}]}