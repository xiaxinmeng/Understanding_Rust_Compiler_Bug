{"sha": "c84df34aec3bb845b22384c7e85f0449ca00dd99", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Yzg0ZGYzNGFlYzNiYjg0NWIyMjM4NGM3ZTg1ZjA0NDljYTAwZGQ5OQ==", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2020-11-16T13:26:20Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2020-11-16T14:21:25Z"}, "message": "Delay SLP instance loads gathering\n\nThis delays filling SLP_INSTANCE_LOADS.\n\n2020-11-16  Richard Biener  <rguenther@suse.de>\n\n\t* tree-vectorizer.h (vect_gather_slp_loads): Declare.\n\t* tree-vect-loop.c (vect_analyze_loop_2): Call\n\tvect_gather_slp_loads.\n\t* tree-vect-slp.c (vect_build_slp_instance): Do not gather\n\tSLP loads here.\n\t(vect_gather_slp_loads): Remove wrapper, new function.\n\t(vect_slp_analyze_bb_1): Call it.", "tree": {"sha": "d20af3436e7286e5f93606651a4007e2d17f06aa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d20af3436e7286e5f93606651a4007e2d17f06aa"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c84df34aec3bb845b22384c7e85f0449ca00dd99", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c84df34aec3bb845b22384c7e85f0449ca00dd99", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c84df34aec3bb845b22384c7e85f0449ca00dd99", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c84df34aec3bb845b22384c7e85f0449ca00dd99/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d1746388db6481d87f5a801d79b17566fc6888da", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d1746388db6481d87f5a801d79b17566fc6888da", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d1746388db6481d87f5a801d79b17566fc6888da"}], "stats": {"total": 30, "additions": 22, "deletions": 8}, "files": [{"sha": "ecaaf0116d3022c9709e11cacd7f2ffa07a77708", "filename": "gcc/tree-vect-loop.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c84df34aec3bb845b22384c7e85f0449ca00dd99/gcc%2Ftree-vect-loop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c84df34aec3bb845b22384c7e85f0449ca00dd99/gcc%2Ftree-vect-loop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-loop.c?ref=c84df34aec3bb845b22384c7e85f0449ca00dd99", "patch": "@@ -2298,6 +2298,9 @@ vect_analyze_loop_2 (loop_vec_info loop_vinfo, bool &fatal, unsigned *n_stmts)\n \n       /* Optimize the SLP graph with the vectorization factor fixed.  */\n       vect_optimize_slp (loop_vinfo);\n+\n+      /* Gather the loads reachable from the SLP graph entries.  */\n+      vect_gather_slp_loads (loop_vinfo);\n     }\n \n   bool saved_can_use_partial_vectors_p"}, {"sha": "d2f2407ac92f23724387e893a24c6661b514dafb", "filename": "gcc/tree-vect-slp.c", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c84df34aec3bb845b22384c7e85f0449ca00dd99/gcc%2Ftree-vect-slp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c84df34aec3bb845b22384c7e85f0449ca00dd99/gcc%2Ftree-vect-slp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-slp.c?ref=c84df34aec3bb845b22384c7e85f0449ca00dd99", "patch": "@@ -2071,13 +2071,6 @@ vect_gather_slp_loads (vec<slp_tree> &loads, slp_tree node,\n     }\n }\n \n-static void\n-vect_gather_slp_loads (slp_instance inst, slp_tree node)\n-{\n-  hash_set<slp_tree> visited;\n-  vect_gather_slp_loads (SLP_INSTANCE_LOADS (inst), node, visited);\n-}\n-\n \n /* Find the last store in SLP INSTANCE.  */\n \n@@ -2252,7 +2245,6 @@ vect_build_slp_instance (vec_info *vinfo,\n \t  new_instance->cost_vec = vNULL;\n \t  new_instance->subgraph_entries = vNULL;\n \n-\t  vect_gather_slp_loads (new_instance, node);\n \t  if (dump_enabled_p ())\n \t    dump_printf_loc (MSG_NOTE, vect_location,\n \t\t\t     \"SLP size %u vs. limit %u.\\n\",\n@@ -3071,6 +3063,21 @@ vect_optimize_slp (vec_info *vinfo)\n     }\n }\n \n+/* Gather loads reachable from the individual SLP graph entries.  */\n+\n+void\n+vect_gather_slp_loads (vec_info *vinfo)\n+{\n+  unsigned i;\n+  slp_instance instance;\n+  FOR_EACH_VEC_ELT (vinfo->slp_instances, i, instance)\n+    {\n+      hash_set<slp_tree> visited;\n+      vect_gather_slp_loads (SLP_INSTANCE_LOADS (instance),\n+\t\t\t     SLP_INSTANCE_TREE (instance), visited);\n+    }\n+}\n+\n \n /* For each possible SLP instance decide whether to SLP it and calculate overall\n    unrolling factor needed to SLP the loop.  Return TRUE if decided to SLP at\n@@ -4152,6 +4159,9 @@ vect_slp_analyze_bb_1 (bb_vec_info bb_vinfo, int n_stmts, bool &fatal,\n   /* Optimize permutations.  */\n   vect_optimize_slp (bb_vinfo);\n \n+  /* Gather the loads reachable from the SLP graph entries.  */\n+  vect_gather_slp_loads (bb_vinfo);\n+\n   vect_record_base_alignments (bb_vinfo);\n \n   /* Analyze and verify the alignment of data references and the"}, {"sha": "0ee4ef32eb2dbe2242327a6ed61c1245a0f59ce6", "filename": "gcc/tree-vectorizer.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c84df34aec3bb845b22384c7e85f0449ca00dd99/gcc%2Ftree-vectorizer.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c84df34aec3bb845b22384c7e85f0449ca00dd99/gcc%2Ftree-vectorizer.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vectorizer.h?ref=c84df34aec3bb845b22384c7e85f0449ca00dd99", "patch": "@@ -1974,6 +1974,7 @@ extern opt_result vect_analyze_slp (vec_info *, unsigned);\n extern bool vect_make_slp_decision (loop_vec_info);\n extern void vect_detect_hybrid_slp (loop_vec_info);\n extern void vect_optimize_slp (vec_info *);\n+extern void vect_gather_slp_loads (vec_info *);\n extern void vect_get_slp_defs (slp_tree, vec<tree> *);\n extern void vect_get_slp_defs (vec_info *, slp_tree, vec<vec<tree> > *,\n \t\t\t       unsigned n = -1U);"}]}