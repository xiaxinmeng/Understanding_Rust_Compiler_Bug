{"sha": "44e13e607f63ef73c75cd64b041f24b0eeafd992", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDRlMTNlNjA3ZjYzZWY3M2M3NWNkNjRiMDQxZjI0YjBlZWFmZDk5Mg==", "commit": {"author": {"name": "Pat Haugen", "email": "pthaugen@us.ibm.com", "date": "2017-09-14T18:29:44Z"}, "committer": {"name": "Pat Haugen", "email": "pthaugen@gcc.gnu.org", "date": "2017-09-14T18:29:44Z"}, "message": "rs6000.c (rs6000_set_up_by_prologue): Make sure the TOC reg (r2) isn't in the set of registers defined in the prologue.\n\n\t* config/rs6000/rs6000.c (rs6000_set_up_by_prologue): Make sure the TOC\n\treg (r2) isn't in the set of registers defined in the prologue.\n\n\t* gcc.target/powerpc/r2_shrink-wrap.c: New.\n\nFrom-SVN: r252768", "tree": {"sha": "19b2d65af1c02d3ff136cf98414c82940da1f8b1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/19b2d65af1c02d3ff136cf98414c82940da1f8b1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/44e13e607f63ef73c75cd64b041f24b0eeafd992", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/44e13e607f63ef73c75cd64b041f24b0eeafd992", "html_url": "https://github.com/Rust-GCC/gccrs/commit/44e13e607f63ef73c75cd64b041f24b0eeafd992", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/44e13e607f63ef73c75cd64b041f24b0eeafd992/comments", "author": null, "committer": null, "parents": [{"sha": "bc998d034f45d1828a8663b2eed928faf22a7d01", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bc998d034f45d1828a8663b2eed928faf22a7d01", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bc998d034f45d1828a8663b2eed928faf22a7d01"}], "stats": {"total": 31, "additions": 31, "deletions": 0}, "files": [{"sha": "b66faebbc15189269c0c1863d914cfbd20955eec", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=44e13e607f63ef73c75cd64b041f24b0eeafd992", "patch": "@@ -1,3 +1,8 @@\n+2017-09-14  Pat Haugen  <pthaugen@us.ibm.com>\n+\n+\t* config/rs6000/rs6000.c (rs6000_set_up_by_prologue): Make sure the TOC\n+\treg (r2) isn't in the set of registers defined in the prologue.\n+\n 2017-09-14  Richard Sandiford  <richard.sandiford@linaro.org>\n \t    Alan Hayward  <alan.hayward@arm.com>\n \t    David Sherwood  <david.sherwood@arm.com>"}, {"sha": "6dd726e4de4b585ec293317729f4a529994292d3", "filename": "gcc/config/rs6000/rs6000.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2Fconfig%2Frs6000%2Frs6000.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2Fconfig%2Frs6000%2Frs6000.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.c?ref=44e13e607f63ef73c75cd64b041f24b0eeafd992", "patch": "@@ -37804,6 +37804,11 @@ rs6000_set_up_by_prologue (struct hard_reg_set_container *set)\n     add_to_hard_reg_set (&set->set, Pmode, RS6000_PIC_OFFSET_TABLE_REGNUM);\n   if (cfun->machine->split_stack_argp_used)\n     add_to_hard_reg_set (&set->set, Pmode, 12);\n+\n+  /* Make sure the hard reg set doesn't include r2, which was possibly added\n+     via PIC_OFFSET_TABLE_REGNUM.  */\n+  if (TARGET_TOC)\n+    remove_from_hard_reg_set (&set->set, Pmode, TOC_REGNUM);\n }\n \n \f"}, {"sha": "005c0b9882c4625d5dd736200dc58e9df6a9275c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=44e13e607f63ef73c75cd64b041f24b0eeafd992", "patch": "@@ -1,3 +1,7 @@\n+2017-09-14  Pat Haugen  <pthaugen@us.ibm.com>\n+\n+\t* gcc.target/powerpc/r2_shrink-wrap.c: New.\n+\n 2017-09-14  Will Schmidt  <will_schmidt@vnet.ibm.com>\n \n \t* gcc.target/powerpc/fold-vec-ld-longlong.c: Add"}, {"sha": "b81b9b1c2ee0a51afdc909ab02e58bd2771d1a30", "filename": "gcc/testsuite/gcc.target/powerpc/r2_shrink-wrap.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fr2_shrink-wrap.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/44e13e607f63ef73c75cd64b041f24b0eeafd992/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fr2_shrink-wrap.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fr2_shrink-wrap.c?ref=44e13e607f63ef73c75cd64b041f24b0eeafd992", "patch": "@@ -0,0 +1,17 @@\n+/* { dg-do compile { target lp64 } } */\n+/* { dg-options \"-O2 -fdump-rtl-pro_and_epilogue\" } */\n+\n+/* Verify we move the prologue past the TOC reference of 'j' and shrink-wrap\n+   the function. */\n+void bar();\n+int j;\n+void foo(int i)\n+{\n+  j = i;\n+  if (i > 0)\n+    {\n+      bar();\n+    }\n+}\n+\n+/* { dg-final { scan-rtl-dump-times \"Performing shrink-wrapping\" 1 \"pro_and_epilogue\" } } */"}]}