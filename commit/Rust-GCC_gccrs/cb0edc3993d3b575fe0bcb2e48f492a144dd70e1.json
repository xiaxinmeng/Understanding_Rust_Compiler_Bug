{"sha": "cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Y2IwZWRjMzk5M2QzYjU3NWZlMGJjYjJlNDhmNDkyYTE0NGRkNzBlMQ==", "commit": {"author": {"name": "Dominik Vogt", "email": "vogt@linux.vnet.ibm.com", "date": "2015-06-01T11:38:44Z"}, "committer": {"name": "Andreas Krebbel", "email": "krebbel@gcc.gnu.org", "date": "2015-06-01T11:38:44Z"}, "message": "S390: Support -mtune=native and -march=native.\n\ngcc/ChangeLog\n\n2015-06-01  Dominik Vogt  <vogt@linux.vnet.ibm.com>\n\n\t    * config/s390/driver-native.c: New file.\n\t    * config/s390/x-native: New file.\n\t    * config.host: Add new files for s390.\n\t    * config/s390/s390.h (DRIVER_SELF_SPECS): Add support for -mtune=native\n\t    and -march=native\n\t    * config.gcc: Likewise.\n\t    * config/s390/s390.opt (march): Likewise; add PROCESSOR_NATIVE\n\t    * config/s390/s390-opts.h (enum processor_type): Ditto.\n\t    * config/s390/s390.c (s390_option_override): Catch unhandled\n\t    PROCESSOR_NATIVE\n\nFrom-SVN: r223934", "tree": {"sha": "cc7f08983662d64218a0f37a8aa58b7418282263", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cc7f08983662d64218a0f37a8aa58b7418282263"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/comments", "author": {"login": "vogtd", "id": 9690100, "node_id": "MDQ6VXNlcjk2OTAxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/9690100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vogtd", "html_url": "https://github.com/vogtd", "followers_url": "https://api.github.com/users/vogtd/followers", "following_url": "https://api.github.com/users/vogtd/following{/other_user}", "gists_url": "https://api.github.com/users/vogtd/gists{/gist_id}", "starred_url": "https://api.github.com/users/vogtd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vogtd/subscriptions", "organizations_url": "https://api.github.com/users/vogtd/orgs", "repos_url": "https://api.github.com/users/vogtd/repos", "events_url": "https://api.github.com/users/vogtd/events{/privacy}", "received_events_url": "https://api.github.com/users/vogtd/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "a48b05f9112a14754da22a25dcc36ee442436455", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a48b05f9112a14754da22a25dcc36ee442436455", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a48b05f9112a14754da22a25dcc36ee442436455"}], "stats": {"total": 133, "additions": 130, "deletions": 3}, "files": [{"sha": "72ef1e45d5c24e00b1a03d76fe2e8180f5b8ffa9", "filename": "gcc/ChangeLog", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -1,3 +1,16 @@\n+2015-06-01  Dominik Vogt  <vogt@linux.vnet.ibm.com>\n+\n+\t* config/s390/driver-native.c: New file.\n+\t* config/s390/x-native: New file.\n+\t* config.host: Add new files for s390.\n+\t* config/s390/s390.h (DRIVER_SELF_SPECS): Add support for -mtune=native\n+\tand -march=native\n+\t* config.gcc: Likewise.\n+\t* config/s390/s390.opt (march): Likewise; add PROCESSOR_NATIVE\n+\t* config/s390/s390-opts.h (enum processor_type): Ditto.\n+\t* config/s390/s390.c (s390_option_override): Catch unhandled\n+\tPROCESSOR_NATIVE\n+\n 2015-06-01  Ilya Enkovich  <ilya.enkovich@intel.com>\n \n \tPR target/65527"}, {"sha": "e23a34c2528911d9be6a4ee5cedfad08f38e28d3", "filename": "gcc/config.gcc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig.gcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig.gcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig.gcc?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -4099,7 +4099,7 @@ case \"${target}\" in\n \t\tfor which in arch tune; do\n \t\t\teval \"val=\\$with_$which\"\n \t\t\tcase ${val} in\n-\t\t\t\"\" | g5 | g6 | z900 | z990 | z9-109 | z9-ec | z10 | z196 | zEC12 | z13)\n+\t\t\t\"\" | native | g5 | g6 | z900 | z990 | z9-109 | z9-ec | z10 | z196 | zEC12 | z13)\n \t\t\t\t# OK\n \t\t\t\t;;\n \t\t\t*)"}, {"sha": "4e456a1b5390ad451d298e0c758925b133725490", "filename": "gcc/config.host", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig.host", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig.host", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig.host?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -172,6 +172,10 @@ case ${host} in\n \t;;\n     esac\n     ;;\n+  s390-*-* | s390x-*-*)\n+    host_extra_gcc_objs=\"driver-native.o\"\n+    host_xmake_file=\"${host_xmake_file} s390/x-native\"\n+    ;;\n   sparc*-*-solaris2*)\n     case ${target} in\n       sparc*-*-solaris2*)"}, {"sha": "88c76bd0dd8f39faef9296f0996c3dec2d7c502a", "filename": "gcc/config/s390/driver-native.c", "status": "added", "additions": 91, "deletions": 0, "changes": 91, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fdriver-native.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fdriver-native.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fdriver-native.c?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -0,0 +1,91 @@\n+/* Subroutines for the gcc driver.\n+   Copyright (C) 2015 Free Software Foundation, Inc.\n+\n+This file is part of GCC.\n+\n+GCC is free software; you can redistribute it and/or modify\n+it under the terms of the GNU General Public License as published by\n+the Free Software Foundation; either version 3, or (at your option)\n+any later version.\n+\n+GCC is distributed in the hope that it will be useful,\n+but WITHOUT ANY WARRANTY; without even the implied warranty of\n+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+GNU General Public License for more details.\n+\n+You should have received a copy of the GNU General Public License\n+along with GCC; see the file COPYING3.  If not see\n+<http://www.gnu.org/licenses/>.  */\n+\n+#include \"config.h\"\n+#include \"system.h\"\n+#include \"coretypes.h\"\n+#include \"tm.h\"\n+\n+/* This will be called by the spec parser in gcc.c when it sees\n+   a %:local_cpu_detect(args) construct.  Currently it will be called\n+   with either \"arch\" or \"tune\" as argument depending on if -march=native\n+   or -mtune=native is to be substituted.\n+\n+   It returns a string containing new command line parameters to be\n+   put at the place of the above two options, depending on what CPU\n+   this is executed.  E.g. \"-march=zEC12\" on a zEC12 for -march=native.\n+   If the routine can't detect a known processor, the -march or -mtune\n+   option is discarded.\n+\n+   ARGC and ARGV are set depending on the actual arguments given\n+   in the spec.  */\n+const char *\n+s390_host_detect_local_cpu (int argc, const char **argv)\n+{\n+  const char *cpu = NULL;\n+  char buf[256];\n+  FILE *f;\n+  bool arch;\n+\n+  if (argc < 1)\n+    return NULL;\n+\n+  arch = strcmp (argv[0], \"arch\") == 0;\n+  if (!arch && strcmp (argv[0], \"tune\"))\n+    return NULL;\n+\n+  f = fopen (\"/proc/cpuinfo\", \"r\");\n+  if (f == NULL)\n+    return NULL;\n+\n+  while (fgets (buf, sizeof (buf), f) != NULL)\n+    if (strncmp (buf, \"processor\", sizeof (\"processor\") - 1) == 0)\n+      {\n+\tif (strstr (buf, \"machine = 9672\") != NULL)\n+\t  cpu = \"g5\";\n+\telse if (strstr (buf, \"machine = 2064\") != NULL\n+\t\t || strstr (buf, \"machine = 2066\") != NULL)\n+\t  cpu = \"z900\";\n+\telse if (strstr (buf, \"machine = 2084\") != NULL\n+\t\t || strstr (buf, \"machine = 2086\") != NULL)\n+\t  cpu = \"z990\";\n+\telse if (strstr (buf, \"machine = 2094\") != NULL\n+\t\t || strstr (buf, \"machine = 2096\") != NULL)\n+\t  cpu = \"z9-109\";\n+\telse if (strstr (buf, \"machine = 2097\") != NULL\n+\t\t || strstr (buf, \"machine = 2098\") != NULL)\n+\t  cpu = \"z10\";\n+\telse if (strstr (buf, \"machine = 2817\") != NULL\n+\t\t || strstr (buf, \"machine = 2818\") != NULL)\n+\t  cpu = \"z196\";\n+\telse if (strstr (buf, \"machine = 2827\") != NULL\n+\t\t || strstr (buf, \"machine = 2828\") != NULL)\n+\t  cpu = \"zEC12\";\n+\telse if (strstr (buf, \"machine = 2964\") != NULL)\n+\t  cpu = \"z13\";\n+\tbreak;\n+      }\n+\n+  fclose (f);\n+\n+  if (cpu == NULL)\n+    return NULL;\n+\n+  return concat (\"-m\", argv[0], \"=\", cpu, NULL);\n+}"}, {"sha": "f0ea532df2ca5a1491cf1f2a3918ca603c397a48", "filename": "gcc/config/s390/s390-opts.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390-opts.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390-opts.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fs390-opts.h?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -36,6 +36,7 @@ enum processor_type\n   PROCESSOR_2817_Z196,\n   PROCESSOR_2827_ZEC12,\n   PROCESSOR_2964_Z13,\n+  PROCESSOR_NATIVE,\n   PROCESSOR_max\n };\n "}, {"sha": "47cb9e76eb25a4c311ef6c032e70ad1299fbd832", "filename": "gcc/config/s390/s390.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fs390.c?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -13345,6 +13345,8 @@ s390_option_override (void)\n     }\n \n   /* Sanity checks.  */\n+  if (s390_arch == PROCESSOR_NATIVE || s390_tune == PROCESSOR_NATIVE)\n+    gcc_unreachable ();\n   if (TARGET_ZARCH && !TARGET_CPU_ZARCH)\n     error (\"z/Architecture mode not supported on %s\", s390_arch_string);\n   if (TARGET_64BIT && !TARGET_ZARCH)"}, {"sha": "85a0d1af65a2363e8eb2f9b7f3d9feea5cd00619", "filename": "gcc/config/s390/s390.h", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fs390.h?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -126,17 +126,27 @@ enum processor_flags\n   { \"arch\", \"%{!march=*:-march=%(VALUE)}\" },\t\t\t\\\n   { \"tune\", \"%{!mtune=*:-mtune=%(VALUE)}\" }\n \n+extern const char *s390_host_detect_local_cpu (int argc, const char **argv);\n+# define EXTRA_SPEC_FUNCTIONS \\\n+  { \"local_cpu_detect\", s390_host_detect_local_cpu },\n+\n+# define MARCH_MTUNE_NATIVE_SPECS\t\t\t\t\\\n+  \" %{march=native:%<march=native %:local_cpu_detect(arch)}\"\t\\\n+  \" %{mtune=native:%<mtune=native %:local_cpu_detect(tune)}\"\n+\n /* Defaulting rules.  */\n #ifdef DEFAULT_TARGET_64BIT\n #define DRIVER_SELF_SPECS\t\t\t\t\t\\\n   \"%{!m31:%{!m64:-m64}}\",\t\t\t\t\t\\\n   \"%{!mesa:%{!mzarch:%{m31:-mesa}%{m64:-mzarch}}}\",\t\t\\\n-  \"%{!march=*:%{mesa:-march=g5}%{mzarch:-march=z900}}\"\n+  \"%{!march=*:%{mesa:-march=g5}%{mzarch:-march=z900}}\",\t\t\\\n+  MARCH_MTUNE_NATIVE_SPECS\n #else\n #define DRIVER_SELF_SPECS\t\t\t\t\t\\\n   \"%{!m31:%{!m64:-m31}}\",\t\t\t\t\t\\\n   \"%{!mesa:%{!mzarch:%{m31:-mesa}%{m64:-mzarch}}}\",\t\t\\\n-  \"%{!march=*:%{mesa:-march=g5}%{mzarch:-march=z900}}\"\n+  \"%{!march=*:%{mesa:-march=g5}%{mzarch:-march=z900}}\",\t\t\\\n+  MARCH_MTUNE_NATIVE_SPECS\n #endif\n \n /* Constants needed to control the TEST DATA CLASS (TDC) instruction.  */"}, {"sha": "b21dc365d334b7f5ac41ab056e2668a5778c9bb0", "filename": "gcc/config/s390/s390.opt", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fs390.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fs390.opt?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -79,6 +79,9 @@ Enum(processor_type) String(zEC12) Value(PROCESSOR_2827_ZEC12)\n EnumValue\n Enum(processor_type) String(z13) Value(PROCESSOR_2964_Z13)\n \n+EnumValue\n+Enum(processor_type) String(native) Value(PROCESSOR_NATIVE) DriverOnly\n+\n mbackchain\n Target Report Mask(BACKCHAIN)\n Maintain backchain pointer"}, {"sha": "b33c8b6fa2fd6ccdefa69a43855d57630be4a00d", "filename": "gcc/config/s390/x-native", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fx-native", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb0edc3993d3b575fe0bcb2e48f492a144dd70e1/gcc%2Fconfig%2Fs390%2Fx-native", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fx-native?ref=cb0edc3993d3b575fe0bcb2e48f492a144dd70e1", "patch": "@@ -0,0 +1,3 @@\n+driver-native.o : $(srcdir)/config/s390/driver-native.c \\\n+  $(CONFIG_H) $(SYSTEM_H)\n+\t$(COMPILER) -c $(ALL_COMPILERFLAGS) $(ALL_CPPFLAGS) $(INCLUDES) $<"}]}