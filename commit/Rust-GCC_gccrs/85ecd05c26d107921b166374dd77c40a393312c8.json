{"sha": "85ecd05c26d107921b166374dd77c40a393312c8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODVlY2QwNWMyNmQxMDc5MjFiMTY2Mzc0ZGQ3N2M0MGEzOTMzMTJjOA==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2016-06-13T21:20:10Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2016-06-13T21:20:10Z"}, "message": "PR bootstrap/71481: fix input.c selftest\n\ngcc/ChangeLog:\n\tPR bootstrap/71481\n\t* input.c (selftest::test_reading_source_line): Avoid reading from\n\t__FILE__ by creating a tempfile with known content and reading\n\tfrom that instead.\n\nFrom-SVN: r237414", "tree": {"sha": "ec6ac4583e4ad411cd6740d0f46ca084d3289c30", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ec6ac4583e4ad411cd6740d0f46ca084d3289c30"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/85ecd05c26d107921b166374dd77c40a393312c8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/85ecd05c26d107921b166374dd77c40a393312c8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/85ecd05c26d107921b166374dd77c40a393312c8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/85ecd05c26d107921b166374dd77c40a393312c8/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "2fe00b1fba78d3e9fb26754e9cbf3d05ab7e1506", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2fe00b1fba78d3e9fb26754e9cbf3d05ab7e1506", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2fe00b1fba78d3e9fb26754e9cbf3d05ab7e1506"}], "stats": {"total": 38, "additions": 28, "deletions": 10}, "files": [{"sha": "7486c3245d4c306764d80f14f721c722f044d6e4", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/85ecd05c26d107921b166374dd77c40a393312c8/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/85ecd05c26d107921b166374dd77c40a393312c8/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=85ecd05c26d107921b166374dd77c40a393312c8", "patch": "@@ -1,3 +1,10 @@\n+2016-06-13  David Malcolm  <dmalcolm@redhat.com>\n+\n+\tPR bootstrap/71481\n+\t* input.c (selftest::test_reading_source_line): Avoid reading from\n+\t__FILE__ by creating a tempfile with known content and reading\n+\tfrom that instead.\n+\n 2016-06-13  David Malcolm  <dmalcolm@redhat.com>\n \n \t* pretty-print.c (assert_pp_format_colored): Skip the test if"}, {"sha": "3fb4a2586b0ee8543602533489df1f804db12f91", "filename": "gcc/input.c", "status": "modified", "additions": 21, "deletions": 10, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/85ecd05c26d107921b166374dd77c40a393312c8/gcc%2Finput.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/85ecd05c26d107921b166374dd77c40a393312c8/gcc%2Finput.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Finput.c?ref=85ecd05c26d107921b166374dd77c40a393312c8", "patch": "@@ -1219,23 +1219,34 @@ test_builtins ()\n static void\n test_reading_source_line ()\n {\n-  /* We will read *this* source file, using __FILE__.\n-     Here is some specific text to read and test for:\n-     The quick brown fox jumps over the lazy dog.  */\n-  const int linenum_after_test_message = __LINE__;\n-  const int linenum = linenum_after_test_message - 1;\n-\n+  /* Create a tempfile and write some text to it.  */\n+  char *filename = make_temp_file (\".txt\");\n+  ASSERT_NE (filename, NULL);\n+  FILE *out = fopen (filename, \"w\");\n+  if (!out)\n+    ::selftest::fail_formatted (SELFTEST_LOCATION,\n+\t\t\t\t\"unable to open tempfile: %s\", filename);\n+  fprintf (out,\n+\t   \"01234567890123456789\\n\"\n+\t   \"This is the test text\\n\"\n+\t   \"This is the 3rd line\\n\");\n+  fclose (out);\n+\n+  /* Read back a specific line from the tempfile.  */\n   int line_size;\n-  const char *source_line = location_get_source_line (__FILE__, linenum, &line_size);\n+  const char *source_line = location_get_source_line (filename, 2, &line_size);\n   ASSERT_TRUE (source_line != NULL);\n-  ASSERT_EQ (53, line_size);\n-  if (!strncmp (\"     The quick brown fox jumps over the lazy dog.  */\",\n-\t       source_line, line_size))\n+  ASSERT_EQ (21, line_size);\n+  if (!strncmp (\"This is the test text\",\n+\t\tsource_line, line_size))\n     ::selftest::pass (SELFTEST_LOCATION,\n \t\t      \"source_line matched expected value\");\n   else\n     ::selftest::fail (SELFTEST_LOCATION,\n \t\t      \"source_line did not match expected value\");\n+\n+  unlink (filename);\n+  free (filename);\n }\n \n /* Run all of the selftests within this file.  */"}]}