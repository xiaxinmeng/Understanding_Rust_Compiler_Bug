{"sha": "a2f59f14ceace0b8e614f972beacd45acfb284c7", "node_id": "C_kwDOANBUbNoAKGEyZjU5ZjE0Y2VhY2UwYjhlNjE0Zjk3MmJlYWNkNDVhY2ZiMjg0Yzc", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-11-24T22:52:28Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-11-25T13:32:49Z"}, "message": "Bug fix mutability checks in can_eq for autoderef\n\nRust is permissive about mutablity in type checking for example, if we have\na function:\n\n  fn foo(a:&bar) { ... }\n\n  fn caller() {\n    let a:&mut bar = ...;\n    foo(a);\n  }\n\nThis is valid since the mutable reference to bar is valid to be turned into\nan immutable reference without any conversion. Like in C a non-const\npointer is valid to be passed to a const pointer inferface.", "tree": {"sha": "cef0f5c313734f997a2a60539c1824ee0bd26c24", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cef0f5c313734f997a2a60539c1824ee0bd26c24"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a2f59f14ceace0b8e614f972beacd45acfb284c7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a2f59f14ceace0b8e614f972beacd45acfb284c7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a2f59f14ceace0b8e614f972beacd45acfb284c7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a2f59f14ceace0b8e614f972beacd45acfb284c7/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "717b6da459b26ace9a3c303cfa5e485ff8935709", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/717b6da459b26ace9a3c303cfa5e485ff8935709", "html_url": "https://github.com/Rust-GCC/gccrs/commit/717b6da459b26ace9a3c303cfa5e485ff8935709"}], "stats": {"total": 60, "additions": 48, "deletions": 12}, "files": [{"sha": "067ae2c0d9ed0e26b600fd92d25c223e7daff4e5", "filename": "gcc/rust/typecheck/rust-hir-dot-operator.h", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-hir-dot-operator.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-hir-dot-operator.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-dot-operator.h?ref=a2f59f14ceace0b8e614f972beacd45acfb284c7", "patch": "@@ -115,7 +115,7 @@ class MethodResolution\n \t    if (fn->is_method ())\n \t      {\n \t\tTyTy::BaseType *fn_self = fn->get_self_type ();\n-\t\tif (receiver->can_eq (fn_self, false, true))\n+\t\tif (fn_self->can_eq (receiver, false, true))\n \t\t  {\n \t\t    return &c;\n \t\t  }\n@@ -143,7 +143,7 @@ class MethodResolution\n \t    if (fn->is_method ())\n \t      {\n \t\tTyTy::BaseType *fn_self = fn->get_self_type ();\n-\t\tif (receiver->can_eq (fn_self, false, true))\n+\t\tif (fn_self->can_eq (receiver, false, true))\n \t\t  {\n \t\t    return &c;\n \t\t  }\n@@ -165,7 +165,7 @@ class MethodResolution\n \t    if (fn->is_method ())\n \t      {\n \t\tTyTy::BaseType *fn_self = fn->get_self_type ();\n-\t\tif (receiver->can_eq (fn_self, false, true))\n+\t\tif (fn_self->can_eq (receiver, false, true))\n \t\t  {\n \t\t    return &c;\n \t\t  }"}, {"sha": "a23855ed7de6d0694ce51d27b59bf25b92ca2226", "filename": "gcc/rust/typecheck/rust-tyty-cmp.h", "status": "modified", "additions": 36, "deletions": 6, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-tyty-cmp.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-tyty-cmp.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty-cmp.h?ref=a2f59f14ceace0b8e614f972beacd45acfb284c7", "patch": "@@ -1169,9 +1169,23 @@ class ReferenceCmp : public BaseCmp\n     auto base_type = base->get_base ();\n     auto other_base_type = type.get_base ();\n \n-    ok = base_type->can_eq (other_base_type, emit_error_flag,\n-\t\t\t    autoderef_mode_flag)\n-\t && (base->is_mutable () == type.is_mutable ());\n+    // rust is permissive about mutablity here you can always go from mutable to\n+    // immutable but not the otherway round\n+    bool mutability_ok = base->is_mutable () ? type.is_mutable () : true;\n+    if (!mutability_ok)\n+      {\n+\tBaseCmp::visit (type);\n+\treturn;\n+      }\n+\n+    if (!base_type->can_eq (other_base_type, emit_error_flag,\n+\t\t\t    autoderef_mode_flag))\n+      {\n+\tBaseCmp::visit (type);\n+\treturn;\n+      }\n+\n+    ok = true;\n   }\n \n private:\n@@ -1193,9 +1207,23 @@ class PointerCmp : public BaseCmp\n     auto base_type = base->get_base ();\n     auto other_base_type = type.get_base ();\n \n-    ok = base_type->can_eq (other_base_type, emit_error_flag,\n-\t\t\t    autoderef_mode_flag)\n-\t && (base->is_mutable () == type.is_mutable ());\n+    // rust is permissive about mutablity here you can always go from mutable to\n+    // immutable but not the otherway round\n+    bool mutability_ok = base->is_mutable () ? type.is_mutable () : true;\n+    if (!mutability_ok)\n+      {\n+\tBaseCmp::visit (type);\n+\treturn;\n+      }\n+\n+    if (!base_type->can_eq (other_base_type, emit_error_flag,\n+\t\t\t    autoderef_mode_flag))\n+      {\n+\tBaseCmp::visit (type);\n+\treturn;\n+      }\n+\n+    ok = true;\n   }\n \n private:\n@@ -1276,6 +1304,8 @@ class ParamCmp : public BaseCmp\n \n   void visit (const NeverType &) override { ok = true; }\n \n+  void visit (const DynamicObjectType &) override { ok = true; }\n+\n   void visit (const PlaceholderType &type) override\n   {\n     ok = base->get_symbol ().compare (type.get_symbol ()) == 0;"}, {"sha": "f044d0e8ebc83117da728d15c072f4206b53530d", "filename": "gcc/rust/typecheck/rust-tyty-rules.h", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-tyty-rules.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-tyty-rules.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty-rules.h?ref=a2f59f14ceace0b8e614f972beacd45acfb284c7", "patch": "@@ -1209,7 +1209,10 @@ class ReferenceRules : public BaseRules\n \treturn;\n       }\n \n-    if (base->is_mutable () != type.is_mutable ())\n+    // rust is permissive about mutablity here you can always go from mutable to\n+    // immutable but not the otherway round\n+    bool mutability_ok = base->is_mutable () ? type.is_mutable () : true;\n+    if (!mutability_ok)\n       {\n \tBaseRules::visit (type);\n \treturn;\n@@ -1246,7 +1249,10 @@ class PointerRules : public BaseRules\n \treturn;\n       }\n \n-    if (base->is_mutable () != type.is_mutable ())\n+    // rust is permissive about mutablity here you can always go from mutable to\n+    // immutable but not the otherway round\n+    bool mutability_ok = base->is_mutable () ? type.is_mutable () : true;\n+    if (!mutability_ok)\n       {\n \tBaseRules::visit (type);\n \treturn;"}, {"sha": "25fdfa9db79d8a5a8348fd624c39e723a4d21183", "filename": "gcc/rust/typecheck/rust-tyty.cc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2f59f14ceace0b8e614f972beacd45acfb284c7/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc?ref=a2f59f14ceace0b8e614f972beacd45acfb284c7", "patch": "@@ -2786,7 +2786,7 @@ TypeCheckCallExpr::visit (FnPtr &type)\n void\n TypeCheckMethodCallExpr::visit (FnType &type)\n {\n-  adjusted_self->unify (type.get_self_type ());\n+  type.get_self_type ()->unify (adjusted_self);\n \n   // +1 for the receiver self\n   size_t num_args_to_call = call.num_params () + 1;"}]}