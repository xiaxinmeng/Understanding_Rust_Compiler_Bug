{"sha": "022f6ee3ad67ee30f62c8c2aeeb4156494f3284e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDIyZjZlZTNhZDY3ZWUzMGY2MmM4YzJhZWViNDE1NjQ5NGYzMjg0ZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-04-21T10:31:45Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-04-21T10:31:45Z"}, "message": "cprop: Fix -fcompare-debug bug in constprop_register [PR100148]\n\nThe following testcase shows different behavior between -g and -g0\nin constprop_register, if a flags register setter is separated\nfrom a conditional jump using those flags with -g by a DEBUG_INSN.\nAs it uses just NEXT_INSN, for -g it will look at the DEBUG_INSN which is\nnot a conditional jump, while otherwise it would look at the conditional\njump and call cprop_jump.\n\n2021-04-21  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR rtl-optimization/100148\n\t* cprop.c (constprop_register): Use next_nondebug_insn instead of\n\tNEXT_INSN.\n\n\t* g++.dg/opt/pr100148.C: New test.", "tree": {"sha": "72c8a4621724009714cea62bfcdc505f82f1b0b3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/72c8a4621724009714cea62bfcdc505f82f1b0b3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "021607e12cb9c40d0859b78490f44bb3f7da5812", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/021607e12cb9c40d0859b78490f44bb3f7da5812", "html_url": "https://github.com/Rust-GCC/gccrs/commit/021607e12cb9c40d0859b78490f44bb3f7da5812"}], "stats": {"total": 35, "additions": 32, "deletions": 3}, "files": [{"sha": "6f34f6b2418b9f9415845f4381931daf06aacae1", "filename": "gcc/cprop.c", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e/gcc%2Fcprop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e/gcc%2Fcprop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcprop.c?ref=022f6ee3ad67ee30f62c8c2aeeb4156494f3284e", "patch": "@@ -1007,16 +1007,18 @@ static int\n constprop_register (rtx from, rtx src, rtx_insn *insn)\n {\n   rtx sset;\n+  rtx_insn *next_insn;\n \n   /* Check for reg or cc0 setting instructions followed by\n      conditional branch instructions first.  */\n   if ((sset = single_set (insn)) != NULL\n-      && NEXT_INSN (insn)\n-      && any_condjump_p (NEXT_INSN (insn)) && onlyjump_p (NEXT_INSN (insn)))\n+      && (next_insn = next_nondebug_insn (insn)) != NULL\n+      && any_condjump_p (next_insn)\n+      && onlyjump_p (next_insn))\n     {\n       rtx dest = SET_DEST (sset);\n       if ((REG_P (dest) || CC0_P (dest))\n-\t  && cprop_jump (BLOCK_FOR_INSN (insn), insn, NEXT_INSN (insn),\n+\t  && cprop_jump (BLOCK_FOR_INSN (insn), insn, next_insn,\n \t\t\t from, src))\n \treturn 1;\n     }"}, {"sha": "d038879b6b847aa1174b15b21943b0f7e89ac0e8", "filename": "gcc/testsuite/g++.dg/opt/pr100148.C", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fpr100148.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/022f6ee3ad67ee30f62c8c2aeeb4156494f3284e/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fpr100148.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fpr100148.C?ref=022f6ee3ad67ee30f62c8c2aeeb4156494f3284e", "patch": "@@ -0,0 +1,27 @@\n+// PR rtl-optimization/100148\n+// { dg-do compile }\n+// { dg-options \"-O2 -fno-dce -fno-tree-dce -fno-tree-dominator-opts -fno-tree-sink -fcompare-debug\" }\n+\n+int i;\n+enum E { } e, ee;\n+\n+bool\n+baz (int)\n+{\n+  return ee;\n+}\n+\n+bool bar ();\n+bool a, b;\n+\n+void\n+foo ()\n+{\n+  switch (ee)\n+    {\n+    case 0:\n+      e = E (a ? : i);\n+    case 1:\n+      !(b || baz (0) && bar ());\n+    }\n+}"}]}