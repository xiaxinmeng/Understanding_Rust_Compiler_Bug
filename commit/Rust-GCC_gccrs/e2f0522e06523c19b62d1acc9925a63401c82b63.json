{"sha": "e2f0522e06523c19b62d1acc9925a63401c82b63", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTJmMDUyMmUwNjUyM2MxOWI2MmQxYWNjOTkyNWE2MzQwMWM4MmI2Mw==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2016-02-17T09:21:58Z"}, "committer": {"name": "Eric Botcazou", "email": "ebotcazou@gcc.gnu.org", "date": "2016-02-17T09:21:58Z"}, "message": "exp_ch4.adb (Expand_N_Indexed_Component): Active synchronization if the prefix denotes an entity which Has_Atomic_Components.\n\n\t* exp_ch4.adb (Expand_N_Indexed_Component): Active synchronization if\n\tthe prefix denotes an entity which Has_Atomic_Components.\n\t* gcc-interface/trans.c (node_is_atomic): Return true if the prefix\n\tdenotes an entity which Has_Atomic_Components.\n\nFrom-SVN: r233485", "tree": {"sha": "862c4536dcd6f54e1fa80604d57c816ab0b1ed03", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/862c4536dcd6f54e1fa80604d57c816ab0b1ed03"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e2f0522e06523c19b62d1acc9925a63401c82b63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e2f0522e06523c19b62d1acc9925a63401c82b63", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e2f0522e06523c19b62d1acc9925a63401c82b63", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e2f0522e06523c19b62d1acc9925a63401c82b63/comments", "author": null, "committer": null, "parents": [{"sha": "bf17fe3f736580a65427cc9e0e814e3ffe6e7fe5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bf17fe3f736580a65427cc9e0e814e3ffe6e7fe5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bf17fe3f736580a65427cc9e0e814e3ffe6e7fe5"}], "stats": {"total": 52, "additions": 51, "deletions": 1}, "files": [{"sha": "4868cae34a2fd1e9443d96d8f533a68d149868ad", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=e2f0522e06523c19b62d1acc9925a63401c82b63", "patch": "@@ -1,3 +1,10 @@\n+2016-02-17  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* exp_ch4.adb (Expand_N_Indexed_Component): Active synchronization if\n+\tthe prefix denotes an entity which Has_Atomic_Components.\n+\t* gcc-interface/trans.c (node_is_atomic): Return true if the prefix\n+\tdenotes an entity which Has_Atomic_Components.\n+\n 2016-02-17  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gcc-interface/utils2.c (gnat_protect_expr): Make a SAVE_EXPR only"}, {"sha": "eff75c25ab0260eb3b5d317503bb1442dc31c3d3", "filename": "gcc/ada/exp_ch4.adb", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Fada%2Fexp_ch4.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Fada%2Fexp_ch4.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch4.adb?ref=e2f0522e06523c19b62d1acc9925a63401c82b63", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 1992-2015, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2016, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -6269,6 +6269,9 @@ package body Exp_Ch4 is\n            and then not Atomic_Synchronization_Disabled (Atp))\n         or else (Is_Atomic (Typ)\n                   and then not Atomic_Synchronization_Disabled (Typ))\n+        or else (Is_Entity_Name (P)\n+                  and then Has_Atomic_Components (Entity (P))\n+                  and then not Atomic_Synchronization_Disabled (Entity (P)))\n       then\n          Activate_Atomic_Synchronization (N);\n       end if;"}, {"sha": "fce3f0e2633b7afc8626f23eb89ba0986fae5028", "filename": "gcc/ada/gcc-interface/trans.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Fada%2Fgcc-interface%2Ftrans.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Fada%2Fgcc-interface%2Ftrans.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgcc-interface%2Ftrans.c?ref=e2f0522e06523c19b62d1acc9925a63401c82b63", "patch": "@@ -4028,6 +4028,9 @@ node_is_atomic (Node_Id gnat_node)\n     case N_Indexed_Component:\n       if (Has_Atomic_Components (Etype (Prefix (gnat_node))))\n \treturn true;\n+      if (Is_Entity_Name (Prefix (gnat_node))\n+\t  && Has_Atomic_Components (Entity (Prefix (gnat_node))))\n+\treturn true;\n \n       /* ... fall through ... */\n "}, {"sha": "59ce25469f4f8568163b1b4b3c5bad53576a8ca9", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e2f0522e06523c19b62d1acc9925a63401c82b63", "patch": "@@ -1,3 +1,7 @@\n+2016-02-17  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* gnat.dg/atomic8.adb: New test.\n+\n 2016-02-17  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gnat.dg/discr46.ad[sb]: New test."}, {"sha": "76a110d72c551ceb1b176d90af02344bc09c8127", "filename": "gcc/testsuite/gnat.dg/atomic8.adb", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Ftestsuite%2Fgnat.dg%2Fatomic8.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2f0522e06523c19b62d1acc9925a63401c82b63/gcc%2Ftestsuite%2Fgnat.dg%2Fatomic8.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fatomic8.adb?ref=e2f0522e06523c19b62d1acc9925a63401c82b63", "patch": "@@ -0,0 +1,33 @@\n+-- { dg-do run }\n+\n+procedure Atomic8 is\n+\n+   V : array (1 .. 2) of Natural := (0,0) with Atomic_Components;\n+\n+   task type TT1;\n+   task body TT1 is\n+   begin\n+      while V (1) + V (2) < 1_000_000 loop\n+         V (1) := V (1) + 1;\n+      end loop;\n+   end TT1;\n+\n+   task type TT2;\n+   task body TT2 is\n+   begin\n+      while V (1) + V (2) < 1_000_000 loop\n+         V (2) := V (2) + 1;\n+      end loop;\n+   end TT2;\n+\n+begin\n+   declare\n+      T1 : TT1;\n+      T2 : TT2;\n+   begin\n+      null;\n+   end;\n+   if V (1) + V (2) not in 1_000_000 | 1_000_001 then\n+      raise Program_Error;\n+   end if;\n+end;"}]}