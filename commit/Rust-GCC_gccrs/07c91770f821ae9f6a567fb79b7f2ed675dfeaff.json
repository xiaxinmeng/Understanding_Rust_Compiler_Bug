{"sha": "07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDdjOTE3NzBmODIxYWU5ZjZhNTY3ZmI3OWI3ZjJlZDY3NWRmZWFmZg==", "commit": {"author": {"name": "Javier Miranda", "email": "miranda@adacore.com", "date": "2019-07-04T08:07:24Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-04T08:07:24Z"}, "message": "[Ada] Spurious error on non-default C++ constructor\n\nThe frontend reports spurious errors on C++ non-default constructors\nthat have formals whose type is an access to subprogram.\n\n2019-07-04  Javier Miranda  <miranda@adacore.com>\n\ngcc/ada/\n\n\t* exp_tss.adb (Init_Proc): Adding missing support for access to\n\tsubprograms and access to protected subprograms of non-default\n\tC++ constructors.\n\ngcc/testsuite/\n\n\t* gnat.dg/cpp_constructor.adb, gnat.dg/cpp_constructor_fp.ads,\n\tgnat.dg/cpp_constructor_useit.ads: New testcase.\n\nFrom-SVN: r273072", "tree": {"sha": "2197c7386bf341a7fae35a274dc1ff78ba5aa6bf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2197c7386bf341a7fae35a274dc1ff78ba5aa6bf"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/comments", "author": {"login": "miranda-adacore", "id": 54413934, "node_id": "MDQ6VXNlcjU0NDEzOTM0", "avatar_url": "https://avatars.githubusercontent.com/u/54413934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miranda-adacore", "html_url": "https://github.com/miranda-adacore", "followers_url": "https://api.github.com/users/miranda-adacore/followers", "following_url": "https://api.github.com/users/miranda-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/miranda-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/miranda-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miranda-adacore/subscriptions", "organizations_url": "https://api.github.com/users/miranda-adacore/orgs", "repos_url": "https://api.github.com/users/miranda-adacore/repos", "events_url": "https://api.github.com/users/miranda-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/miranda-adacore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7cbe60de258f6d09561d4fe32dac8892b52520fe", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7cbe60de258f6d09561d4fe32dac8892b52520fe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7cbe60de258f6d09561d4fe32dac8892b52520fe"}], "stats": {"total": 57, "additions": 55, "deletions": 2}, "files": [{"sha": "45c5f39cb8784ebd46d8b394d5a19883bc24ea5a", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "patch": "@@ -1,3 +1,9 @@\n+2019-07-04  Javier Miranda  <miranda@adacore.com>\n+\n+\t* exp_tss.adb (Init_Proc): Adding missing support for access to\n+\tsubprograms and access to protected subprograms of non-default\n+\tC++ constructors.\n+\n 2019-07-04  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gnat1drv.adb (Adjust_Global_Switches): Use proper interface to"}, {"sha": "8ef05e23d3ed8cfe24ba65996ac00ac2e59951e7", "filename": "gcc/ada/exp_tss.adb", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Fada%2Fexp_tss.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Fada%2Fexp_tss.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_tss.adb?ref=07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "patch": "@@ -32,6 +32,7 @@ with Lib;      use Lib;\n with Restrict; use Restrict;\n with Rident;   use Rident;\n with Sem_Aux;  use Sem_Aux;\n+with Sem_Ch6;  use Sem_Ch6;\n with Sem_Util; use Sem_Util;\n with Sinfo;    use Sinfo;\n \n@@ -275,8 +276,8 @@ package body Exp_Tss is\n                   then\n                      exit;\n \n-                  elsif Ekind (Etype (E1)) /= E_Anonymous_Access_Type\n-                    and then Ekind (Etype (E2)) /= E_Anonymous_Access_Type\n+                  elsif not Is_Anonymous_Access_Type (Etype (E1))\n+                    and then not Is_Anonymous_Access_Type (Etype (E2))\n                     and then Etype (E1) /= Etype (E2)\n                   then\n                      exit;\n@@ -287,6 +288,17 @@ package body Exp_Tss is\n                                /= Directly_Designated_Type (Etype (E2))\n                   then\n                      exit;\n+\n+                  elsif Ekind_In (Etype (E1),\n+                          E_Anonymous_Access_Subprogram_Type,\n+                          E_Anonymous_Access_Protected_Subprogram_Type)\n+                    and then Ekind_In (Etype (E2),\n+                               E_Anonymous_Access_Subprogram_Type,\n+                               E_Anonymous_Access_Protected_Subprogram_Type)\n+                    and then not Conforming_Types\n+                                   (Etype (E1), Etype (E2), Fully_Conformant)\n+                  then\n+                     exit;\n                   end if;\n \n                   E1 := Next_Formal (E1);"}, {"sha": "89601758400fbc80af9536086f66f6ec5a328a5a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "patch": "@@ -1,3 +1,8 @@\n+2019-07-04  Javier Miranda  <miranda@adacore.com>\n+\n+\t* gnat.dg/cpp_constructor.adb, gnat.dg/cpp_constructor_fp.ads,\n+\tgnat.dg/cpp_constructor_useit.ads: New testcase.\n+\n 2019-07-04  Gary Dismukes  <dismukes@adacore.com>\n \n \t* gnat.dg/ghost5.adb, gnat.dg/ghost5.ads,"}, {"sha": "1ecae1b792f6873b1f86505c7a4fa441e65264b6", "filename": "gcc/testsuite/gnat.dg/cpp_constructor.adb", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor.adb?ref=07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "patch": "@@ -0,0 +1,12 @@\n+--  { dg-do compile }\n+\n+with Interfaces.C; use Interfaces.C;\n+with Cpp_Constructor_FP;\n+with Cpp_Constructor_Useit;\n+\n+procedure Cpp_Constructor is\n+   F : Cpp_Constructor_FP.Class :=\n+     Cpp_Constructor_FP.Constructor (Cpp_Constructor_Useit.My_Fn'Access);\n+begin\n+   null;\n+end Cpp_Constructor;"}, {"sha": "3ee4b3eed849cb686dca8f3a71d8877e0d1fca91", "filename": "gcc/testsuite/gnat.dg/cpp_constructor_fp.ads", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor_fp.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor_fp.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor_fp.ads?ref=07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "patch": "@@ -0,0 +1,10 @@\n+with Interfaces.C; use Interfaces.C;\n+\n+package Cpp_Constructor_FP is\n+   type Class is limited record null; end record\n+   with Convention => Cpp, Import;\n+\n+   function Constructor\n+     (Fn : access function (Val : int) return int) return Class;\n+   pragma Cpp_Constructor (Constructor, External_Name => \"foo\");\n+end Cpp_Constructor_FP;"}, {"sha": "1f3046450a1d4b8755fab3b602cec9cda287f620", "filename": "gcc/testsuite/gnat.dg/cpp_constructor_useit.ads", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor_useit.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07c91770f821ae9f6a567fb79b7f2ed675dfeaff/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor_useit.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fcpp_constructor_useit.ads?ref=07c91770f821ae9f6a567fb79b7f2ed675dfeaff", "patch": "@@ -0,0 +1,8 @@\n+with Interfaces.C; use Interfaces.C;\n+\n+package Cpp_Constructor_Useit is\n+   function My_Fn (Val : int) return int\n+   with Convention => Cpp;\n+\n+   function My_Fn (Val : int) return int is (Val + 1);\n+end Cpp_Constructor_Useit;"}]}