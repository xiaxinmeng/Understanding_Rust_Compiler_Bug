{"sha": "a229f9b3737062c6e853879be6683f3f3e4a6661", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTIyOWY5YjM3MzcwNjJjNmU4NTM4NzliZTY2ODNmM2YzZTRhNjY2MQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-05-08T08:03:56Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-05-08T08:03:56Z"}, "message": "ix86: Add peephole2 for *add<mode>3_cc_overflow_1 followed by matching memory store [PR94857]\n\nThe following peephole2 changes:\n-\taddl\t(%rdi), %esi\n+\txorl\t%eax, %eax\n+\taddl\t%esi, (%rdi)\n \tsetc\t%al\n-\tmovl\t%esi, (%rdi)\n-\tmovzbl\t%al, %eax\n \tret\non the testcase.  *add<mode>3_cc_overflow_1, being an add{l,q} insn, is\ncommutative, so if TARGET_READ_MODIFY_WRITE we can replace\naddl (%rdi), %esi; movl %esi, (%rdi)\nwith\naddl %esi, (%rdi)\nif %esi is dead after those two insns.\n\n2020-05-08  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR target/94857\n\t* config/i386/i386.md (peephole2 after *add<mode>3_cc_overflow_1): New\n\tdefine_peephole2.\n\n\t* gcc.target/i386/pr94857.c: New test.", "tree": {"sha": "31fa0f21442170ed14bc6e3f755c2f0a08010653", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/31fa0f21442170ed14bc6e3f755c2f0a08010653"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a229f9b3737062c6e853879be6683f3f3e4a6661", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a229f9b3737062c6e853879be6683f3f3e4a6661", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a229f9b3737062c6e853879be6683f3f3e4a6661", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a229f9b3737062c6e853879be6683f3f3e4a6661/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a139bc2b492de8a761890a5d299951dede3d8f7b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a139bc2b492de8a761890a5d299951dede3d8f7b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a139bc2b492de8a761890a5d299951dede3d8f7b"}], "stats": {"total": 37, "additions": 37, "deletions": 0}, "files": [{"sha": "9a380a5505c7795beb9c7b65405e55abe71ba8e5", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a229f9b3737062c6e853879be6683f3f3e4a6661", "patch": "@@ -1,5 +1,9 @@\n 2020-05-08  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR target/94857\n+\t* config/i386/i386.md (peephole2 after *add<mode>3_cc_overflow_1): New\n+\tdefine_peephole2.\n+\n \tPR middle-end/94724\n \t* tree.c (get_narrower): Reuse the op temporary instead of\n \tshadowing it."}, {"sha": "8bfc9cb0b7180c07d4202f7ff23c8b500fe2bded", "filename": "gcc/config/i386/i386.md", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2Fconfig%2Fi386%2Fi386.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2Fconfig%2Fi386%2Fi386.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.md?ref=a229f9b3737062c6e853879be6683f3f3e4a6661", "patch": "@@ -6992,6 +6992,23 @@\n   [(set_attr \"type\" \"alu\")\n    (set_attr \"mode\" \"<MODE>\")])\n \n+(define_peephole2\n+  [(parallel [(set (reg:CCC FLAGS_REG)\n+\t\t   (compare:CCC\n+\t\t     (plus:SWI (match_operand:SWI 0 \"general_reg_operand\")\n+\t\t\t       (match_operand:SWI 1 \"memory_operand\"))\n+\t\t     (match_dup 0)))\n+\t      (set (match_dup 0) (plus:SWI (match_dup 0) (match_dup 1)))])\n+   (set (match_dup 1) (match_dup 0))]\n+  \"(TARGET_READ_MODIFY_WRITE || optimize_insn_for_size_p ())\n+   && peep2_reg_dead_p (2, operands[0])\n+   && !reg_overlap_mentioned_p (operands[0], operands[1])\"\n+  [(parallel [(set (reg:CCC FLAGS_REG)\n+\t\t   (compare:CCC\n+\t\t     (plus:SWI (match_dup 1) (match_dup 0))\n+\t\t     (match_dup 1)))\n+\t      (set (match_dup 1) (plus:SWI (match_dup 1) (match_dup 0)))])])\n+\n (define_insn \"*addsi3_zext_cc_overflow_1\"\n   [(set (reg:CCC FLAGS_REG)\n \t(compare:CCC"}, {"sha": "db0a837829f1146aa4ac20915427d3888abb0f5e", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a229f9b3737062c6e853879be6683f3f3e4a6661", "patch": "@@ -1,5 +1,8 @@\n 2020-05-08  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR target/94857\n+\t* gcc.target/i386/pr94857.c: New test.\n+\n \tPR tree-optimization/94783\n \t* gcc.dg/tree-ssa/pr94783.c: New test.\n "}, {"sha": "f84ee22b9227241be6232c640049e6867a638622", "filename": "gcc/testsuite/gcc.target/i386/pr94857.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr94857.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a229f9b3737062c6e853879be6683f3f3e4a6661/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr94857.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr94857.c?ref=a229f9b3737062c6e853879be6683f3f3e4a6661", "patch": "@@ -0,0 +1,13 @@\n+/* PR target/94857 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -mtune=skylake -masm=att\" } */\n+/* { dg-additional-options \"-mregparm=2\" { target ia32 } } */\n+/* { dg-final { scan-assembler \"\\taddl\\t%\\[a-z0-9]\\*, \\\\\\(\" } } */\n+\n+int\n+foo (unsigned *p, unsigned x)\n+{\n+  unsigned u = *p;\n+  *p += x;\n+  return u > *p;\n+}"}]}