{"sha": "c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb", "node_id": "C_kwDOANBUbNoAKGMzMGU1YWIwMjdhNTlhMmZmY2Y3ZmIyZDA5M2NlMmI2NGRlNzEyZWI", "commit": {"author": {"name": "Javier Miranda", "email": "miranda@adacore.com", "date": "2022-03-18T19:28:52Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-05-17T08:25:41Z"}, "message": "[Ada] Spurious error on subprogram with class-wide preconditions\n\ngcc/ada/\n\n\t* freeze.adb (Build_DTW_Spec): Do not inherit the not-overriding\n\tindicator because the DTW wrapper overrides its wrapped\n\tsubprogram.\n\t* contracts.ads (Make_Class_Precondition_Subps): Adding\n\tdocumentation.", "tree": {"sha": "538497cb00998337b189efcfa00a810dbda7b7b1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/538497cb00998337b189efcfa00a810dbda7b7b1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb/comments", "author": {"login": "miranda-adacore", "id": 54413934, "node_id": "MDQ6VXNlcjU0NDEzOTM0", "avatar_url": "https://avatars.githubusercontent.com/u/54413934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miranda-adacore", "html_url": "https://github.com/miranda-adacore", "followers_url": "https://api.github.com/users/miranda-adacore/followers", "following_url": "https://api.github.com/users/miranda-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/miranda-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/miranda-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miranda-adacore/subscriptions", "organizations_url": "https://api.github.com/users/miranda-adacore/orgs", "repos_url": "https://api.github.com/users/miranda-adacore/repos", "events_url": "https://api.github.com/users/miranda-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/miranda-adacore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4090614041c7803373a5064dfb82fdf6017971d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d4090614041c7803373a5064dfb82fdf6017971d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d4090614041c7803373a5064dfb82fdf6017971d"}], "stats": {"total": 40, "additions": 40, "deletions": 0}, "files": [{"sha": "5178373bff39278bd688566d42e356b35ec09c22", "filename": "gcc/ada/contracts.ads", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb/gcc%2Fada%2Fcontracts.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb/gcc%2Fada%2Fcontracts.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fcontracts.ads?ref=c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb", "patch": "@@ -226,6 +226,39 @@ package Contracts is\n    --  overrides an inherited class-wide precondition (see AI12-0195-1).\n    --  Late_Overriding enables special handling required for late-overriding\n    --  subprograms.\n+   --\n+   --  For example, if we have a subprogram with the following profile:\n+   --\n+   --     procedure Prim (Obj : TagTyp; <additional formals>)\n+   --       with Pre'Class => F1 (Obj) and F2(Obj)\n+   --\n+   --  We build the following helper that evaluates statically the class-wide\n+   --  precondition:\n+   --\n+   --    function PrimSP (Obj : TagTyp) return Boolean is\n+   --    begin\n+   --       return F1 (Obj) and F2(Obj);\n+   --    end PrimSP;\n+   --\n+   --   ... and the following helper that evaluates dynamically the class-wide\n+   --   precondition:\n+   --\n+   --    function PrimDP (Obj : TagTyp'Class; ...) return Boolean is\n+   --    begin\n+   --       return F1 (Obj) and F2(Obj);\n+   --    end PrimSP;\n+   --\n+   --   ... and the following indirect-call wrapper (ICW) that is used by the\n+   --   code generated by the compiler for indirect calls:\n+   --\n+   --    procedure PrimICW (Obj : TagTyp; <additional formals> is\n+   --    begin\n+   --       if not PrimSP (Obj) then\n+   --          $raise_assert_failure (\"failed precondition in call at ...\");\n+   --       end if;\n+   --\n+   --       Prim (Obj, ...);\n+   --    end Prim;\n \n    procedure Merge_Class_Conditions (Spec_Id : Entity_Id);\n    --  Merge and preanalyze all class-wide conditions of Spec_Id (class-wide"}, {"sha": "ca0ffe39c25284a829f6f36c7a7b5f87d28d9128", "filename": "gcc/ada/freeze.adb", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb/gcc%2Fada%2Ffreeze.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb/gcc%2Fada%2Ffreeze.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Ffreeze.adb?ref=c30e5ab027a59a2ffcf7fb2d093ce2b64de712eb", "patch": "@@ -1619,6 +1619,13 @@ package body Freeze is\n          DTW_Spec := Build_Overriding_Spec (Par_Prim, R);\n          DTW_Id   := Defining_Entity (DTW_Spec);\n \n+         --  Clear the not-overriding indicator since the DTW wrapper overrides\n+         --  its wrapped subprogram; required because if present in the parent\n+         --  primitive, given that Build_Overriding_Spec inherits it, we report\n+         --  spurious errors.\n+\n+         Set_Must_Not_Override (DTW_Spec, False);\n+\n          --  Add minimal decoration of fields\n \n          Mutate_Ekind (DTW_Id, Ekind (Par_Prim));"}]}