{"sha": "e1a74058b784c845e84a0cf1997b54b984df483d", "node_id": "C_kwDOANBUbNoAKGUxYTc0MDU4Yjc4NGM4NDVlODRhMGNmMTk5N2I1NGI5ODRkZjQ4M2Q", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-04-03T19:50:43Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-04-03T19:50:43Z"}, "message": "i386: Fix up ix86_expand_vector_init_general [PR105123]\n\nThe following testcase is miscompiled on ia32.\nThe problem is that at -O0 we end up with:\n  vector(4) short unsigned int _1;\n  short unsigned int u.0_3;\n...\n  _1 = {u.0_3, u.0_3, u.0_3, u.0_3};\nstatement (dead) which is wrongly expanded.\nelt is (subreg:HI (reg:SI 83 [ u.0_3 ]) 0), tmp_mode SImode,\nso after convert_mode we start with word (reg:SI 83 [ u.0_3 ]).\nThe intent is to manually broadcast that value to 2 SImode parts,\nbut because we pass word as target to expand_simple_binop, it will\noverwrite (reg:SI 83 [ u.0_3 ]) and we end up with 0:\n   10: {r83:SI=r83:SI<<0x10;clobber flags:CC;}\n   11: {r83:SI=r83:SI|r83:SI;clobber flags:CC;}\n   12: {r83:SI=r83:SI<<0x10;clobber flags:CC;}\n   13: {r83:SI=r83:SI|r83:SI;clobber flags:CC;}\n   14: clobber r110:V4HI\n   15: r110:V4HI#0=r83:SI\n   16: r110:V4HI#4=r83:SI\nas the two ors do nothing and two shifts each by 16 left shift it all\naway.\nThe following patch fixes that by using NULL_RTX target, so we expand it as\n   10: {r110:SI=r83:SI<<0x10;clobber flags:CC;}\n   11: {r111:SI=r110:SI|r83:SI;clobber flags:CC;}\n   12: {r112:SI=r83:SI<<0x10;clobber flags:CC;}\n   13: {r113:SI=r112:SI|r83:SI;clobber flags:CC;}\n   14: clobber r114:V4HI\n   15: r114:V4HI#0=r111:SI\n   16: r114:V4HI#4=r113:SI\ninstead.\n\nAnother possibility would be to pass NULL_RTX only when word == elt\nand word otherwise, where word would necessarily be a pseudo from the first\nshift after passing NULL_RTX there once or pass NULL_RTX for the shift and\nword for ior.\n\n2022-04-03  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR target/105123\n\t* config/i386/i386-expand.cc (ix86_expand_vector_init_general): Avoid\n\tusing word as target for expand_simple_binop when doing ASHIFT and\n\tIOR.\n\n\t* gcc.target/i386/pr105123.c: New test.", "tree": {"sha": "69ecbabb03cf79eaea1ca86833ca5be92fd60aa6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/69ecbabb03cf79eaea1ca86833ca5be92fd60aa6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e1a74058b784c845e84a0cf1997b54b984df483d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e1a74058b784c845e84a0cf1997b54b984df483d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e1a74058b784c845e84a0cf1997b54b984df483d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e1a74058b784c845e84a0cf1997b54b984df483d/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "243e649dcbb2262f2ed6116b14a78bfa82900bd2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/243e649dcbb2262f2ed6116b14a78bfa82900bd2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/243e649dcbb2262f2ed6116b14a78bfa82900bd2"}], "stats": {"total": 26, "additions": 24, "deletions": 2}, "files": [{"sha": "794315ee2f7870f92b2de6e78d1eb491a1614a52", "filename": "gcc/config/i386/i386-expand.cc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1a74058b784c845e84a0cf1997b54b984df483d/gcc%2Fconfig%2Fi386%2Fi386-expand.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1a74058b784c845e84a0cf1997b54b984df483d/gcc%2Fconfig%2Fi386%2Fi386-expand.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386-expand.cc?ref=e1a74058b784c845e84a0cf1997b54b984df483d", "patch": "@@ -15830,9 +15830,9 @@ ix86_expand_vector_init_general (bool mmx_ok, machine_mode mode,\n \t      else\n \t\t{\n \t\t  word = expand_simple_binop (tmp_mode, ASHIFT, word, shift,\n-\t\t\t\t\t      word, 1, OPTAB_LIB_WIDEN);\n+\t\t\t\t\t      NULL_RTX, 1, OPTAB_LIB_WIDEN);\n \t\t  word = expand_simple_binop (tmp_mode, IOR, word, elt,\n-\t\t\t\t\t      word, 1, OPTAB_LIB_WIDEN);\n+\t\t\t\t\t      NULL_RTX, 1, OPTAB_LIB_WIDEN);\n \t\t}\n \t    }\n "}, {"sha": "f00d98881a73f9b1a9ac54f812e66f918f7eaf1d", "filename": "gcc/testsuite/gcc.target/i386/pr105123.c", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1a74058b784c845e84a0cf1997b54b984df483d/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr105123.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1a74058b784c845e84a0cf1997b54b984df483d/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr105123.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr105123.c?ref=e1a74058b784c845e84a0cf1997b54b984df483d", "patch": "@@ -0,0 +1,22 @@\n+/* PR target/105123 */\n+/* { dg-do run { target sse2_runtime } } */\n+/* { dg-options \"-msse2\" } */\n+/* { dg-additional-options \"-mtune=i686\" { target ia32 } } */\n+\n+typedef unsigned short __attribute__((__vector_size__ (4 * sizeof (unsigned short)))) V;\n+\n+V\n+foo (unsigned short u, V v)\n+{\n+  return __builtin_shuffle (u * v, v);\n+}\n+\n+int\n+main ()\n+{\n+  V x = foo (1, (V) { 0, 1, 2, 3 });\n+  for (unsigned i = 0; i < 4; i++)\n+    if (x[i] != i)\n+      __builtin_abort ();\n+  return 0;\n+}"}]}