{"sha": "fcef060c9b321edcb24a56616588e712c22029ba", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmNlZjA2MGM5YjMyMWVkY2IyNGE1NjYxNjU4OGU3MTJjMjIwMjliYQ==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2019-08-19T08:37:18Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-08-19T08:37:18Z"}, "message": "[Ada] Crash on object initialization that is call to expression function\n\nThis patch fixes a compiler abort on an object declaration for a\nclass-wide type whose expression is a call to an expression function\nthat returns type extension.\n\n2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_res.adb (Resolve_Call): A call to an expression function\n\tfreezes when expander is active, unless the call appears within\n\tthe body of another expression function,\n\ngcc/testsuite/\n\n\t* gnat.dg/expr_func9.adb: New testcase.\n\nFrom-SVN: r274662", "tree": {"sha": "fa2ac7b8b70693305f9e74b04b5dac7f11a2c259", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fa2ac7b8b70693305f9e74b04b5dac7f11a2c259"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fcef060c9b321edcb24a56616588e712c22029ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fcef060c9b321edcb24a56616588e712c22029ba", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fcef060c9b321edcb24a56616588e712c22029ba", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fcef060c9b321edcb24a56616588e712c22029ba/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c70220382300ae326ad63fe54c5a32da202d1f13", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c70220382300ae326ad63fe54c5a32da202d1f13", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c70220382300ae326ad63fe54c5a32da202d1f13"}], "stats": {"total": 38, "additions": 37, "deletions": 1}, "files": [{"sha": "1f490b3efe13a5d76087f22c04c8c551eecc2fde", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=fcef060c9b321edcb24a56616588e712c22029ba", "patch": "@@ -1,3 +1,9 @@\n+2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_res.adb (Resolve_Call): A call to an expression function\n+\tfreezes when expander is active, unless the call appears within\n+\tthe body of another expression function,\n+\n 2019-08-19  Dmitriy Anisimkov  <anisimko@adacore.com>\n \n \t* libgnat/s-os_lib.ads, libgnat/s-os_lib.adb (To_Ada, To_C): New"}, {"sha": "7a52b90c98fabc13078a6bd374e4fd0dda896ad0", "filename": "gcc/ada/sem_res.adb", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Fada%2Fsem_res.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Fada%2Fsem_res.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_res.adb?ref=fcef060c9b321edcb24a56616588e712c22029ba", "patch": "@@ -6314,13 +6314,15 @@ package body Sem_Res is\n       --  an expression function may appear when it is part of a default\n       --  expression in a call to an initialization procedure, and must be\n       --  frozen now, even if the body is inserted at a later point.\n+      --  Otherwise, the call freezes the expression if expander is active,\n+      --  for example as part of an object declaration.\n \n       if Is_Entity_Name (Subp)\n         and then not In_Spec_Expression\n         and then not Is_Expression_Function_Or_Completion (Current_Scope)\n         and then\n           (not Is_Expression_Function_Or_Completion (Entity (Subp))\n-            or else Scope (Entity (Subp)) = Current_Scope)\n+            or else Expander_Active)\n       then\n          if Is_Expression_Function (Entity (Subp)) then\n "}, {"sha": "2dd707d36c665c85930d62c12449c2c46753201e", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=fcef060c9b321edcb24a56616588e712c22029ba", "patch": "@@ -1,3 +1,7 @@\n+2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/expr_func9.adb: New testcase.\n+\n 2019-08-19  Bob Duff  <duff@adacore.com>\n \n \t* gnat.dg/valid_scalars2.adb: New testcase."}, {"sha": "4bfa21dc647eb37eecf035fff0e99e1c65d8795c", "filename": "gcc/testsuite/gnat.dg/expr_func9.adb", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Ftestsuite%2Fgnat.dg%2Fexpr_func9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fcef060c9b321edcb24a56616588e712c22029ba/gcc%2Ftestsuite%2Fgnat.dg%2Fexpr_func9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fexpr_func9.adb?ref=fcef060c9b321edcb24a56616588e712c22029ba", "patch": "@@ -0,0 +1,24 @@\n+--  { dg-do compile }\n+--  { dg-options \"-gnatws\" }\n+\n+procedure Expr_Func9 is\n+\n+   type Root is interface;\n+\n+   type Child1 is new Root with null record;\n+\n+   type Child2 is new Root with record\n+      I2 : Integer;\n+   end record;\n+\n+   function Create (I : Integer) return Child2 is (I2 => I);\n+\n+   I : Root'Class :=\n+         (if False\n+          then Child1'(null record)\n+          else\n+           Create (1));\n+\n+begin\n+   null;\n+end Expr_Func9;"}]}