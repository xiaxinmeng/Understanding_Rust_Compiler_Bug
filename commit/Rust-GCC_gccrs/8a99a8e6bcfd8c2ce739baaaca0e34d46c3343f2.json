{"sha": "8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2", "node_id": "C_kwDOANBUbNoAKDhhOTlhOGU2YmNmZDhjMmNlNzM5YmFhYWNhMGUzNGQ0NmMzMzQzZjI", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2022-08-12T09:33:20Z"}, "committer": {"name": "Marc Poulhi\u00e8s", "email": "poulhies@adacore.com", "date": "2022-09-06T07:14:22Z"}, "message": "[Ada] Retain Has_Private_View flag for actuals of inlined subprograms\n\nWhen instantiating a body to inline (either because frontend inlining is\nenabled with switch -gnatN or because of inlining-for-proof in GNATprove\nmode) we rewrite occurrences of formal parameters into the corresponding\nactual parameters. Then we switch type views, so that if the formal had\na full view in the body to inline then the corresponding actual will\nhave a full view in the particular inlined body.\n\nHowever, when rewriting occurrences of the formal parameter we were\nlosing information about whether the formal had a private view.\n\ngcc/ada/\n\n\t* inline.adb (Process_Formals): Preserve Has_Private_View flag while\n\trewriting formal into actual parameters.", "tree": {"sha": "a42a4a8154321d68c5cb8a2d84bd3b291e188cf2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a42a4a8154321d68c5cb8a2d84bd3b291e188cf2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dkm", "id": 87603, "node_id": "MDQ6VXNlcjg3NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/87603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dkm", "html_url": "https://github.com/dkm", "followers_url": "https://api.github.com/users/dkm/followers", "following_url": "https://api.github.com/users/dkm/following{/other_user}", "gists_url": "https://api.github.com/users/dkm/gists{/gist_id}", "starred_url": "https://api.github.com/users/dkm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dkm/subscriptions", "organizations_url": "https://api.github.com/users/dkm/orgs", "repos_url": "https://api.github.com/users/dkm/repos", "events_url": "https://api.github.com/users/dkm/events{/privacy}", "received_events_url": "https://api.github.com/users/dkm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "51abc0cc8691daecd7cec8372e4988e9f3f1913c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/51abc0cc8691daecd7cec8372e4988e9f3f1913c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/51abc0cc8691daecd7cec8372e4988e9f3f1913c"}], "stats": {"total": 10, "additions": 10, "deletions": 0}, "files": [{"sha": "91e8f45bf056d4b58b26fc12d86372b83cbb2f1e", "filename": "gcc/ada/inline.adb", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2/gcc%2Fada%2Finline.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2/gcc%2Fada%2Finline.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Finline.adb?ref=8a99a8e6bcfd8c2ce739baaaca0e34d46c3343f2", "patch": "@@ -3367,6 +3367,8 @@ package body Inline is\n          E   : Entity_Id;\n          Ret : Node_Id;\n \n+         Had_Private_View : Boolean;\n+\n       begin\n          if Is_Entity_Name (N) and then Present (Entity (N)) then\n             E := Entity (N);\n@@ -3380,13 +3382,21 @@ package body Inline is\n                --  subtype is private at the call point but its full view is\n                --  visible to the body, then the inlined tree here must be\n                --  analyzed with the full view).\n+               --\n+               --  The Has_Private_View flag is cleared by rewriting, so it\n+               --  must be explicitly saved and restored, just like when\n+               --  instantiating the body to inline.\n \n                if Is_Entity_Name (A) then\n+                  Had_Private_View := Has_Private_View (N);\n                   Rewrite (N, New_Occurrence_Of (Entity (A), Sloc (N)));\n+                  Set_Has_Private_View (N, Had_Private_View);\n                   Check_Private_View (N);\n \n                elsif Nkind (A) = N_Defining_Identifier then\n+                  Had_Private_View := Has_Private_View (N);\n                   Rewrite (N, New_Occurrence_Of (A, Sloc (N)));\n+                  Set_Has_Private_View (N, Had_Private_View);\n                   Check_Private_View (N);\n \n                --  Numeric literal"}]}