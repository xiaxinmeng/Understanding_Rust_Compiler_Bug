{"sha": "3a90596517a785aa7832198a9f400f519d3420da", "node_id": "C_kwDOANBUbNoAKDNhOTA1OTY1MTdhNzg1YWE3ODMyMTk4YTlmNDAwZjUxOWQzNDIwZGE", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-03-24T15:58:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-03-24T15:58:07Z"}, "message": "Merge #1054\n\n1054: Fix overzealous follow set ambiguity r=CohenArthur a=CohenArthur\n\nWhen checking if a follow-up is valid, we previously always returned\r\nfalse when comparing with MacroMatchRepetitions. This is however\r\ninvalid, as we should be comparing with the first match of the\r\nrepetition to be sure.\r\n\r\nCloses #1053 \r\nAddresses #947 \n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>", "tree": {"sha": "c59410d587bc2d9226b3bab9b3d8e50df076b319", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c59410d587bc2d9226b3bab9b3d8e50df076b319"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3a90596517a785aa7832198a9f400f519d3420da", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiPJUPCRBK7hj4Ov3rIwAAWEUIACDU2HtlU1aHO+pwrJSM0ICm\nV0vKSRZiAhLPL35HstEpCkNJSht2SAmLZYitpxFNu3qCOsOlqpeOHQWItZtENpJu\nc9SV19iQDAJYxjwcaFOKt8qsXh5yhN4tHRP6dpK8u+Wneep967bSqT288Hf/FB/Y\n2jk6vHaSPx6aCYk6+7QrBDs1geCDblcO6AmxAsV789AQCP+A/FOsv4VjwN2vNh3+\nLCewDbMxjaAfLY759ZJ7uTHC6wEigzS0EW0tj4fA7aWnM8LvJAgLbB8WPyDaY61i\nKXx+Fs6c2H98yi38Eu9ODKRajRT5xRB3Pau82NrHtUF00/6wg3xnNPLJindQug0=\n=UyZn\n-----END PGP SIGNATURE-----\n", "payload": "tree c59410d587bc2d9226b3bab9b3d8e50df076b319\nparent 8283724bc24efc0c11960947f2d4e99bc20b3765\nparent d859ab0146cd0002afc640d406997efb12a50d98\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1648137487 +0000\ncommitter GitHub <noreply@github.com> 1648137487 +0000\n\nMerge #1054\n\n1054: Fix overzealous follow set ambiguity r=CohenArthur a=CohenArthur\n\nWhen checking if a follow-up is valid, we previously always returned\r\nfalse when comparing with MacroMatchRepetitions. This is however\r\ninvalid, as we should be comparing with the first match of the\r\nrepetition to be sure.\r\n\r\nCloses #1053 \r\nAddresses #947 \n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a90596517a785aa7832198a9f400f519d3420da", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3a90596517a785aa7832198a9f400f519d3420da", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a90596517a785aa7832198a9f400f519d3420da/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8283724bc24efc0c11960947f2d4e99bc20b3765", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8283724bc24efc0c11960947f2d4e99bc20b3765", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8283724bc24efc0c11960947f2d4e99bc20b3765"}, {"sha": "d859ab0146cd0002afc640d406997efb12a50d98", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d859ab0146cd0002afc640d406997efb12a50d98", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d859ab0146cd0002afc640d406997efb12a50d98"}], "stats": {"total": 63, "additions": 36, "deletions": 27}, "files": [{"sha": "50d2efe4fc692b93f5f6bd3163ff66052522d902", "filename": "gcc/rust/parse/rust-parse.cc", "status": "modified", "additions": 27, "deletions": 26, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Frust%2Fparse%2Frust-parse.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Frust%2Fparse%2Frust-parse.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fparse%2Frust-parse.cc?ref=3a90596517a785aa7832198a9f400f519d3420da", "patch": "@@ -100,6 +100,30 @@ contains (std::vector<T> &vec, T elm)\n   return std::find (vec.begin (), vec.end (), elm) != vec.end ();\n }\n \n+/**\n+ * Avoid UB by calling .front() and .back() on empty containers...\n+ */\n+\n+template <typename T>\n+static T *\n+get_back_ptr (std::vector<std::unique_ptr<T>> &values)\n+{\n+  if (values.empty ())\n+    return nullptr;\n+\n+  return values.back ().get ();\n+}\n+\n+template <typename T>\n+static T *\n+get_front_ptr (std::vector<std::unique_ptr<T>> &values)\n+{\n+  if (values.empty ())\n+    return nullptr;\n+\n+  return values.front ().get ();\n+}\n+\n static bool\n peculiar_fragment_match_compatible_fragment (\n   const AST::MacroFragSpec &last_spec, const AST::MacroFragSpec &spec,\n@@ -196,8 +220,9 @@ peculiar_fragment_match_compatible (AST::MacroMatchFragment &last_match,\n       case AST::MacroMatch::Repetition: {\n \tauto repetition = static_cast<AST::MacroMatchRepetition *> (&match);\n \tauto &matches = repetition->get_matches ();\n-\tif (!matches.empty ())\n-\t  error_locus = matches.front ()->get_match_locus ();\n+\tauto first_frag = get_front_ptr (matches);\n+\tif (first_frag)\n+\t  return peculiar_fragment_match_compatible (last_match, *first_frag);\n \tbreak;\n       }\n       case AST::MacroMatch::Matcher: {\n@@ -231,30 +256,6 @@ peculiar_fragment_match_compatible (AST::MacroMatchFragment &last_match,\n   return false;\n }\n \n-/**\n- * Avoid UB by calling .front() and .back() on empty containers...\n- */\n-\n-template <typename T>\n-static T *\n-get_back_ptr (std::vector<std::unique_ptr<T>> &values)\n-{\n-  if (values.empty ())\n-    return nullptr;\n-\n-  return values.back ().get ();\n-}\n-\n-template <typename T>\n-static T *\n-get_front_ptr (std::vector<std::unique_ptr<T>> &values)\n-{\n-  if (values.empty ())\n-    return nullptr;\n-\n-  return values.front ().get ();\n-}\n-\n bool\n is_match_compatible (AST::MacroMatch &last_match, AST::MacroMatch &match)\n {"}, {"sha": "31459907c08f9888a1fee9ba3d4234fcf57820a0", "filename": "gcc/testsuite/rust/compile/macro-issue1053-2.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro-issue1053-2.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro-issue1053-2.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro-issue1053-2.rs?ref=3a90596517a785aa7832198a9f400f519d3420da", "patch": "@@ -0,0 +1,5 @@\n+macro_rules! m {\n+    ($e:expr $(forbidden)*) => {{}}; // { dg-error \"token .identifier. is not allowed after .expr. fragment\" }\n+                                     // { dg-error \"required first macro rule in macro rules definition could not be parsed\" \"\" { target *-*-* } .-1 }\n+                                     // { dg-error \"failed to parse item in crate\" \"\" { target *-*-* } .-2 }\n+}"}, {"sha": "1e968496e0ce3d2f247aaa487aa12b14bdc3d58d", "filename": "gcc/testsuite/rust/compile/macro-issue1053.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro-issue1053.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro-issue1053.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro-issue1053.rs?ref=3a90596517a785aa7832198a9f400f519d3420da", "patch": "@@ -0,0 +1,3 @@\n+macro_rules! m {\n+    ($e:expr $(,)*) => {{}};\n+}"}, {"sha": "8002f284ecfff9ecaf69ffe58c529a0b34a7d91b", "filename": "gcc/testsuite/rust/compile/macro28.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro28.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a90596517a785aa7832198a9f400f519d3420da/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro28.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmacro28.rs?ref=3a90596517a785aa7832198a9f400f519d3420da", "patch": "@@ -1,6 +1,6 @@\n macro_rules! m {\n     ($a:expr $(tok $es:expr)*) => {\n-        // { dg-error \"fragment is not allowed after .expr. fragment\" \"\" { target *-*-* } .-1 }\n+        // { dg-error \"token .identifier. is not allowed after .expr. fragment\" \"\" { target *-*-* } .-1 }\n         // { dg-error \"required first macro rule in macro rules definition could not be parsed\" \"\" { target *-*-* } .-2 }\n         // { dg-error \"failed to parse item in crate\" \"\" { target *-*-* } .-3 }\n         $a"}]}