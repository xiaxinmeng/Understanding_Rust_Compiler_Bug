{"sha": "45281f120da85e0513cb5daa793112a37157ee70", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDUyODFmMTIwZGE4NWUwNTEzY2I1ZGFhNzkzMTEyYTM3MTU3ZWU3MA==", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2020-11-25T14:05:41Z"}, "committer": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2020-11-25T14:05:41Z"}, "message": "Free more of CFG\n\n\t* cfg.c (free_block): New function.\n\t(clear_edges): Rename to ....\n\t(free_cfg): ... this one; also free BBs and vectors.\n\t(expunge_block): Update comment.\n\t* cfg.h (clear_edges): Rename to ...\n\t(free_cfg): ... this one.\n\t* cgraph.c (release_function_body): Use free_cfg.", "tree": {"sha": "f0bf8486919c0838124452269034eed4916b71ce", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f0bf8486919c0838124452269034eed4916b71ce"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/45281f120da85e0513cb5daa793112a37157ee70", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/45281f120da85e0513cb5daa793112a37157ee70", "html_url": "https://github.com/Rust-GCC/gccrs/commit/45281f120da85e0513cb5daa793112a37157ee70", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/45281f120da85e0513cb5daa793112a37157ee70/comments", "author": null, "committer": null, "parents": [{"sha": "fddc7f0080f1f056c4d145451608ebd3e807422a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fddc7f0080f1f056c4d145451608ebd3e807422a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fddc7f0080f1f056c4d145451608ebd3e807422a"}], "stats": {"total": 49, "additions": 32, "deletions": 17}, "files": [{"sha": "529b6ed2105acc77ce572dcb60e1abf4f80a0177", "filename": "gcc/cfg.c", "status": "modified", "additions": 30, "deletions": 15, "changes": 45, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/45281f120da85e0513cb5daa793112a37157ee70/gcc%2Fcfg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/45281f120da85e0513cb5daa793112a37157ee70/gcc%2Fcfg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfg.c?ref=45281f120da85e0513cb5daa793112a37157ee70", "patch": "@@ -25,7 +25,7 @@ along with GCC; see the file COPYING3.  If not see\n \n    Available functionality:\n      - Initialization/deallocation\n-\t init_flow, clear_edges\n+\t init_flow, free_cfg\n      - Low level basic block manipulation\n \t alloc_block, expunge_block\n      - Edge manipulation\n@@ -83,7 +83,7 @@ init_flow (struct function *the_fun)\n   the_fun->cfg->bb_flags_allocated = BB_ALL_FLAGS;\n }\n \f\n-/* Helper function for remove_edge and clear_edges.  Frees edge structure\n+/* Helper function for remove_edge and free_cffg.  Frees edge structure\n    without actually removing it from the pred/succ arrays.  */\n \n static void\n@@ -93,29 +93,44 @@ free_edge (function *fn, edge e)\n   ggc_free (e);\n }\n \n-/* Free the memory associated with the edge structures.  */\n+/* Free basic block BB.  */\n+\n+static void\n+free_block (basic_block bb)\n+{\n+   vec_free (bb->succs);\n+   bb->succs = NULL;\n+   vec_free (bb->preds);\n+   bb->preds = NULL;\n+   /* Do not free BB itself yet since we leak pointers to dead statements\n+      that points to dead basic blocks.  */\n+}\n+\n+/* Free the memory associated with the CFG in FN.  */\n \n void\n-clear_edges (struct function *fn)\n+free_cfg (struct function *fn)\n {\n-  basic_block bb;\n   edge e;\n   edge_iterator ei;\n+  basic_block next;\n \n-  FOR_EACH_BB_FN (bb, fn)\n+  for (basic_block bb = ENTRY_BLOCK_PTR_FOR_FN (fn); bb; bb = next)\n     {\n+      next = bb->next_bb;\n       FOR_EACH_EDGE (e, ei, bb->succs)\n \tfree_edge (fn, e);\n-      vec_safe_truncate (bb->succs, 0);\n-      vec_safe_truncate (bb->preds, 0);\n+      free_block (bb);\n     }\n \n-  FOR_EACH_EDGE (e, ei, ENTRY_BLOCK_PTR_FOR_FN (fn)->succs)\n-    free_edge (fn, e);\n-  vec_safe_truncate (EXIT_BLOCK_PTR_FOR_FN (fn)->preds, 0);\n-  vec_safe_truncate (ENTRY_BLOCK_PTR_FOR_FN (fn)->succs, 0);\n-\n   gcc_assert (!n_edges_for_fn (fn));\n+  /* Sanity check that dominance tree is freed.  */\n+  gcc_assert (!fn->cfg->x_dom_computed[0] && !fn->cfg->x_dom_computed[1]);\n+  \n+  vec_free (fn->cfg->x_label_to_block_map);\n+  vec_free (basic_block_info_for_fn (fn));\n+  ggc_free (fn->cfg);\n+  fn->cfg = NULL;\n }\n \f\n /* Allocate memory for basic_block.  */\n@@ -190,8 +205,8 @@ expunge_block (basic_block b)\n   /* We should be able to ggc_free here, but we are not.\n      The dead SSA_NAMES are left pointing to dead statements that are pointing\n      to dead basic blocks making garbage collector to die.\n-     We should be able to release all dead SSA_NAMES and at the same time we should\n-     clear out BB pointer of dead statements consistently.  */\n+     We should be able to release all dead SSA_NAMES and at the same time we\n+     should clear out BB pointer of dead statements consistently.  */\n }\n \f\n /* Connect E to E->src.  */"}, {"sha": "a9c8300f173a1cd67cdc9a35aa217f3e34bd11e1", "filename": "gcc/cfg.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/45281f120da85e0513cb5daa793112a37157ee70/gcc%2Fcfg.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/45281f120da85e0513cb5daa793112a37157ee70/gcc%2Fcfg.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfg.h?ref=45281f120da85e0513cb5daa793112a37157ee70", "patch": "@@ -82,7 +82,7 @@ struct GTY(()) control_flow_graph {\n \n \n extern void init_flow (function *);\n-extern void clear_edges (function *);\n+extern void free_cfg (function *);\n extern basic_block alloc_block (void);\n extern void link_block (basic_block, basic_block);\n extern void unlink_block (basic_block);"}, {"sha": "dbde8aaaba12a6120c36c4a96f00bc19b9886612", "filename": "gcc/cgraph.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/45281f120da85e0513cb5daa793112a37157ee70/gcc%2Fcgraph.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/45281f120da85e0513cb5daa793112a37157ee70/gcc%2Fcgraph.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.c?ref=45281f120da85e0513cb5daa793112a37157ee70", "patch": "@@ -1811,7 +1811,7 @@ release_function_body (tree decl)\n \t  gcc_assert (!dom_info_available_p (fn, CDI_DOMINATORS));\n \t  gcc_assert (!dom_info_available_p (fn, CDI_POST_DOMINATORS));\n \t  delete_tree_cfg_annotations (fn);\n-\t  clear_edges (fn);\n+\t  free_cfg (fn);\n \t  fn->cfg = NULL;\n \t}\n       if (fn->value_histograms)"}]}