{"sha": "215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "node_id": "C_kwDOANBUbNoAKDIxNWM4YzU4MjZjNjg4ZWFlYmNlNGQ5Y2QwZDUyZTlkYTdiYzIwOGY", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-04-01T09:09:53Z"}, "committer": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-04-01T09:33:57Z"}, "message": "[nvptx, testsuite] Fix gcc.target/nvptx/alias-*.c on sm_80\n\nWhen running test-cases gcc.target/nvptx/alias-*.c on target board\nnvptx-none-run/-misa=sm_80 we run into fails because the test-cases add\n-mptx=6.3, which doesn't support sm_80.\n\nFix this by only adding -mptx=6.3 if necessary, and simplify the test-cases by\nusing ptx_alias feature abstractions:\n...\n/* { dg-do run { target runtime_ptx_alias } } */\n/* { dg-add-options ptx_alias } */\n...\n\nTested on nvptx.\n\ngcc/testsuite/ChangeLog:\n\n2022-04-01  Tom de Vries  <tdevries@suse.de>\n\n\t* gcc.target/nvptx/nvptx.exp\n\t(check_effective_target_runtime_ptx_isa_version_6_3): Rename and\n\tgeneralize to ...\n\t(check_effective_target_runtime_ptx_isa_version_at_least): .. this.\n\t(check_effective_target_default_ptx_isa_version_at_least)\n\t(check_effective_target_runtime_ptx_alias, add_options_for_ptx_alias):\n\tNew proc.\n\t* gcc.target/nvptx/alias-1.c: Use \"target runtime_ptx_alias\" and\n\t\"dg-add-options ptx_alias\".\n\t* gcc.target/nvptx/alias-2.c: Same.\n\t* gcc.target/nvptx/alias-3.c: Same.\n\t* gcc.target/nvptx/alias-4.c: Same.", "tree": {"sha": "f1a96f215b32bc93fd047e772f823ea3cf92763a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f1a96f215b32bc93fd047e772f823ea3cf92763a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15d683d4f0b390b27c54a7c92c6e4f33195bdc93", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/15d683d4f0b390b27c54a7c92c6e4f33195bdc93", "html_url": "https://github.com/Rust-GCC/gccrs/commit/15d683d4f0b390b27c54a7c92c6e4f33195bdc93"}], "stats": {"total": 82, "additions": 70, "deletions": 12}, "files": [{"sha": "d251eee6e423e22affeb36455474e92cb595f9dc", "filename": "gcc/testsuite/gcc.target/nvptx/alias-1.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-1.c?ref=215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "patch": "@@ -1,6 +1,7 @@\n /* { dg-do link } */\n-/* { dg-do run { target runtime_ptx_isa_version_6_3 } } */\n-/* { dg-options \"-save-temps -malias -mptx=6.3\" } */\n+/* { dg-do run { target runtime_ptx_alias } } */\n+/* { dg-options \"-save-temps\" } */\n+/* { dg-add-options ptx_alias } */\n \n int v;\n "}, {"sha": "96cb7e2c1ef9d7715d1b186e868489971bf41544", "filename": "gcc/testsuite/gcc.target/nvptx/alias-2.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-2.c?ref=215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "patch": "@@ -1,6 +1,7 @@\n /* { dg-do link } */\n-/* { dg-do run { target runtime_ptx_isa_version_6_3 } } */\n-/* { dg-options \"-save-temps -malias -mptx=6.3 -O2\" } */\n+/* { dg-do run { target runtime_ptx_alias } } */\n+/* { dg-options \"-save-temps -O2\" } */\n+/* { dg-add-options ptx_alias } */\n \n #include \"alias-1.c\"\n "}, {"sha": "39649e30b91d1c114fd8ee87b0b3f0e048ab7926", "filename": "gcc/testsuite/gcc.target/nvptx/alias-3.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-3.c?ref=215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "patch": "@@ -1,6 +1,7 @@\n /* { dg-do link } */\n-/* { dg-do run { target runtime_ptx_isa_version_6_3 } } */\n-/* { dg-options \"-save-temps -malias -mptx=6.3\" } */\n+/* { dg-do run { target runtime_ptx_alias } } */\n+/* { dg-options \"-save-temps\" } */\n+/* { dg-add-options ptx_alias } */\n \n /* Copy of alias-1.c, with static __f and f.  */\n "}, {"sha": "28163c0faa0ccde43476a29b7328af4a591c5428", "filename": "gcc/testsuite/gcc.target/nvptx/alias-4.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Falias-4.c?ref=215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "patch": "@@ -1,6 +1,7 @@\n /* { dg-do link } */\n-/* { dg-do run { target runtime_ptx_isa_version_6_3 } } */\n-/* { dg-options \"-save-temps -malias -mptx=6.3 -O2\" } */\n+/* { dg-do run { target runtime_ptx_alias } } */\n+/* { dg-options \"-save-temps -O2\" } */\n+/* { dg-add-options ptx_alias } */\n \n #include \"alias-3.c\"\n "}, {"sha": "e9622ae7aaa8d5a550fb20981ef2b763a92af735", "filename": "gcc/testsuite/gcc.target/nvptx/nvptx.exp", "status": "modified", "additions": 58, "deletions": 4, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fnvptx.exp", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/215c8c5826c688eaebce4d9cd0d52e9da7bc208f/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fnvptx.exp", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fnvptx.exp?ref=215c8c5826c688eaebce4d9cd0d52e9da7bc208f", "patch": "@@ -25,11 +25,65 @@ if ![istarget nvptx*-*-*] then {\n # Load support procs.\n load_lib gcc-dg.exp\n \n-# Return 1 if code with -mptx=6.3 can be run.\n-proc check_effective_target_runtime_ptx_isa_version_6_3 { args } {\n-    return [check_runtime run_ptx_isa_6_3 {\n+# Return 1 if code by default compiles for at least PTX ISA version\n+# major.minor.\n+proc check_effective_target_default_ptx_isa_version_at_least { major minor } {\n+    set name default_ptx_isa_version_at_least_${major}_${minor}\n+\n+    set supported_p \\\n+\t[concat \\\n+\t     \"((__PTX_ISA_VERSION_MAJOR__ == $major\" \\\n+\t     \"  && __PTX_ISA_VERSION_MINOR__ >= $minor)\" \\\n+\t     \" || (__PTX_ISA_VERSION_MAJOR__ > $major))\"]\n+\n+    set src \\\n+\t[list \\\n+\t     \"#if $supported_p\" \\\n+\t     \"#else\" \\\n+\t     \"#error unsupported\" \\\n+\t     \"#endif\"]\n+    set src [join $src \"\\n\"]\n+    \n+    set res [check_no_compiler_messages $name assembly $src \"\"]\n+\n+    return $res\n+}\n+\n+# Return 1 if code with PTX ISA version major.minor or higher can be run.\n+proc check_effective_target_runtime_ptx_isa_version_at_least { major minor } {\n+    set name runtime_ptx_isa_version_${major}_${minor}\n+\n+    set default \\\n+\t[check_effective_target_default_ptx_isa_version_at_least \\\n+\t     ${major} ${minor}]\n+\n+    if { $default } {\n+\tset flag \"\"\n+    } else {\n+\tset flag \"-mptx=$major.$minor\"\n+    }\n+\n+    set res [check_runtime $name {\n \tint main (void) { return 0; }\n-    } \"-mptx=6.3\"]\n+    } $flag]\n+\n+    return $res\n+}\n+\n+# Return 1 if runtime environment support the PTX ISA directive .alias.\n+proc check_effective_target_runtime_ptx_alias { } {\n+    return [check_effective_target_runtime_ptx_isa_version_at_least 6 3]\n+}\n+\n+# Add options to enable using PTX ISA directive .alias.\n+proc add_options_for_ptx_alias { flags } {\n+    append flags \" -malias\"\n+\n+    if { ![check_effective_target_default_ptx_isa_version_at_least 6 3] } {\n+\tappend flags \" -mptx=6.3\"\n+    }\n+\n+    return $flags\n }\n \n # If a testcase doesn't have special options, use these."}]}