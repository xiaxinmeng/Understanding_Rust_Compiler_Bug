{"sha": "54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "node_id": "C_kwDOANBUbNoAKDU0ZmE1NTY3YTI3ZWI3ZWU3MmNkMjMyMWQwMjkxYzhhOWI0MzZjZTk", "commit": {"author": {"name": "Martin Sebor", "email": "msebor@redhat.com", "date": "2021-10-13T16:31:37Z"}, "committer": {"name": "Martin Sebor", "email": "msebor@redhat.com", "date": "2021-10-13T16:31:37Z"}, "message": "Check to see if null pointer is dereferenceable [PR102630].\n\nResolves:\nPR middle-end/102630 - Spurious -Warray-bounds with named address space\n\ngcc/ChangeLog:\n\n\tPR middle-end/102630\n\t* pointer-query.cc (compute_objsize_r): Handle named address spaces.\n\ngcc/testsuite/ChangeLog:\n\n\tPR middle-end/102630\n\t* gcc.target/i386/addr-space-2.c: Add -Wall.\n\t* gcc.target/i386/addr-space-3.c: New test.", "tree": {"sha": "2bfac9e3baedfd42699bb4d29b954eb0c9216d6b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2bfac9e3baedfd42699bb4d29b954eb0c9216d6b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/comments", "author": {"login": "msebor", "id": 381149, "node_id": "MDQ6VXNlcjM4MTE0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/381149?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msebor", "html_url": "https://github.com/msebor", "followers_url": "https://api.github.com/users/msebor/followers", "following_url": "https://api.github.com/users/msebor/following{/other_user}", "gists_url": "https://api.github.com/users/msebor/gists{/gist_id}", "starred_url": "https://api.github.com/users/msebor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msebor/subscriptions", "organizations_url": "https://api.github.com/users/msebor/orgs", "repos_url": "https://api.github.com/users/msebor/repos", "events_url": "https://api.github.com/users/msebor/events{/privacy}", "received_events_url": "https://api.github.com/users/msebor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "msebor", "id": 381149, "node_id": "MDQ6VXNlcjM4MTE0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/381149?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msebor", "html_url": "https://github.com/msebor", "followers_url": "https://api.github.com/users/msebor/followers", "following_url": "https://api.github.com/users/msebor/following{/other_user}", "gists_url": "https://api.github.com/users/msebor/gists{/gist_id}", "starred_url": "https://api.github.com/users/msebor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msebor/subscriptions", "organizations_url": "https://api.github.com/users/msebor/orgs", "repos_url": "https://api.github.com/users/msebor/repos", "events_url": "https://api.github.com/users/msebor/events{/privacy}", "received_events_url": "https://api.github.com/users/msebor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "43ae43f654749d291d871ca6ef7c96ea16580fad", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/43ae43f654749d291d871ca6ef7c96ea16580fad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/43ae43f654749d291d871ca6ef7c96ea16580fad"}], "stats": {"total": 38, "additions": 34, "deletions": 4}, "files": [{"sha": "910f452868ef786a01427e6e77cf6113e6b85975", "filename": "gcc/pointer-query.cc", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/gcc%2Fpointer-query.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/gcc%2Fpointer-query.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fpointer-query.cc?ref=54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "patch": "@@ -41,6 +41,7 @@\n #include \"pointer-query.h\"\n #include \"tree-pretty-print.h\"\n #include \"tree-ssanames.h\"\n+#include \"target.h\"\n \n static bool compute_objsize_r (tree, int, access_ref *, ssa_name_limit_t &,\n \t\t\t       pointer_query *);\n@@ -1869,13 +1870,24 @@ compute_objsize_r (tree ptr, int ostype, access_ref *pref,\n   if (code == INTEGER_CST)\n     {\n       /* Pointer constants other than null are most likely the result\n-\t of erroneous null pointer addition/subtraction.  Set size to\n-\t zero.  For null pointers, set size to the maximum for now\n-\t since those may be the result of jump threading.  */\n+\t of erroneous null pointer addition/subtraction.  Unless zero\n+\t is a valid address set size to zero.  For null pointers, set\n+\t size to the maximum for now since those may be the result of\n+\t jump threading.  */\n       if (integer_zerop (ptr))\n \tpref->set_max_size_range ();\n+      else if (POINTER_TYPE_P (TREE_TYPE (ptr)))\n+\t{\n+\t  tree deref_type = TREE_TYPE (TREE_TYPE (ptr));\n+\t  addr_space_t as = TYPE_ADDR_SPACE (deref_type);\n+\t  if (targetm.addr_space.zero_address_valid (as))\n+\t    pref->set_max_size_range ();\n+\t  else\n+\t    pref->sizrng[0] = pref->sizrng[1] = 0;\n+\t}\n       else\n \tpref->sizrng[0] = pref->sizrng[1] = 0;\n+\n       pref->ref = ptr;\n \n       return true;"}, {"sha": "974436855372e4431289627956fda5732ee365d5", "filename": "gcc/testsuite/gcc.target/i386/addr-space-2.c", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Faddr-space-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Faddr-space-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Faddr-space-2.c?ref=54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "patch": "@@ -1,10 +1,11 @@\n /* { dg-do compile } */\n-/* { dg-options \"-O\" } */\n+/* { dg-options \"-O -Wall\" } */\n /* { dg-final { scan-assembler \"fs:16\" } } */\n /* { dg-final { scan-assembler \"gs:16\" } } */\n \n int test(void)\n {\n+  /* Also verify the accesses don't trigger warnings.  */\n   int __seg_fs *f = (int __seg_fs *)16;\n   int __seg_gs *g = (int __seg_gs *)16;\n   return *f + *g;"}, {"sha": "cf0f400de4d0082de439cbcc6d1bcaa0bdb10e67", "filename": "gcc/testsuite/gcc.target/i386/addr-space-3.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Faddr-space-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/54fa5567a27eb7ee72cd2321d0291c8a9b436ce9/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Faddr-space-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Faddr-space-3.c?ref=54fa5567a27eb7ee72cd2321d0291c8a9b436ce9", "patch": "@@ -0,0 +1,17 @@\n+/* PR middle-end/102630 - Spurious -Warray-bounds with named address space\n+  { dg-do compile }\n+  { dg-options \"-O -Wall\" }\n+  { dg-final { scan-assembler \"fs:0\" } }\n+  { dg-final { scan-assembler \"gs:0\" } } */\n+\n+void test_fs_null_store (void)\n+{\n+  int __seg_fs *fs = (int __seg_fs *)0;\n+  *fs = 1;\n+}\n+\n+void test_gs_null_store (void)\n+{\n+  int __seg_gs *gs = (int __seg_gs *)0;\n+  *gs = 2;\n+}"}]}