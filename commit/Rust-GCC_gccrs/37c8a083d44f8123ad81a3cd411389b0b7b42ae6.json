{"sha": "37c8a083d44f8123ad81a3cd411389b0b7b42ae6", "node_id": "C_kwDOANBUbNoAKDM3YzhhMDgzZDQ0ZjgxMjNhZDgxYTNjZDQxMTM4OWIwYjdiNDJhZTY", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2023-03-10T11:06:25Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2023-03-10T11:10:23Z"}, "message": "libstdc++: Fix GDB Xmethod for std::shared_ptr::use_count() [PR109064]\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/109064\n\t* python/libstdcxx/v6/xmethods.py (SharedPtrUseCountWorker):\n\tRemove self-recursion in __init__. Add missing _supports.\n\t* testsuite/libstdc++-xmethods/shared_ptr.cc: Check use_count()\n\tand unique().", "tree": {"sha": "74531885153f7d9be4324849f6bcc7b5c89e5ec5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/74531885153f7d9be4324849f6bcc7b5c89e5ec5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/37c8a083d44f8123ad81a3cd411389b0b7b42ae6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37c8a083d44f8123ad81a3cd411389b0b7b42ae6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/37c8a083d44f8123ad81a3cd411389b0b7b42ae6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37c8a083d44f8123ad81a3cd411389b0b7b42ae6/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e3f8dfcd885d19d322b10fb4e36d50b60da2576b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e3f8dfcd885d19d322b10fb4e36d50b60da2576b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e3f8dfcd885d19d322b10fb4e36d50b60da2576b"}], "stats": {"total": 12, "additions": 11, "deletions": 1}, "files": [{"sha": "18a165f425e420073e07fac54588770ccd9bf000", "filename": "libstdc++-v3/python/libstdcxx/v6/xmethods.py", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37c8a083d44f8123ad81a3cd411389b0b7b42ae6/libstdc%2B%2B-v3%2Fpython%2Flibstdcxx%2Fv6%2Fxmethods.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37c8a083d44f8123ad81a3cd411389b0b7b42ae6/libstdc%2B%2B-v3%2Fpython%2Flibstdcxx%2Fv6%2Fxmethods.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fpython%2Flibstdcxx%2Fv6%2Fxmethods.py?ref=37c8a083d44f8123ad81a3cd411389b0b7b42ae6", "patch": "@@ -730,14 +730,17 @@ class SharedPtrUseCountWorker(gdb.xmethod.XMethodWorker):\n     \"Implements std::shared_ptr<T>::use_count()\"\n \n     def __init__(self, elem_type):\n-        SharedPtrUseCountWorker.__init__(self, elem_type)\n+        pass\n \n     def get_arg_types(self):\n         return None\n \n     def get_result_type(self, obj):\n         return gdb.lookup_type('long')\n \n+    def _supports(self, method_name):\n+        return True\n+\n     def __call__(self, obj):\n         refcounts = obj['_M_refcount']['_M_pi']\n         return refcounts['_M_use_count'] if refcounts else 0"}, {"sha": "c228d3ad26cb1f648fa03521a6c6a46835b4a934", "filename": "libstdc++-v3/testsuite/libstdc++-xmethods/shared_ptr.cc", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37c8a083d44f8123ad81a3cd411389b0b7b42ae6/libstdc%2B%2B-v3%2Ftestsuite%2Flibstdc%2B%2B-xmethods%2Fshared_ptr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37c8a083d44f8123ad81a3cd411389b0b7b42ae6/libstdc%2B%2B-v3%2Ftestsuite%2Flibstdc%2B%2B-xmethods%2Fshared_ptr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Flibstdc%2B%2B-xmethods%2Fshared_ptr.cc?ref=37c8a083d44f8123ad81a3cd411389b0b7b42ae6", "patch": "@@ -37,6 +37,8 @@ main ()\n \n   std::shared_ptr<x_struct[3]> s(new x_struct[2]{ {92}, {115} });\n \n+  auto qq = q;\n+\n // { dg-final { note-test *p 10 } }\n // { dg-final { regexp-test p.get() 0x.* } }\n \n@@ -67,6 +69,11 @@ main ()\n // { dg-final { whatis-test s.get() \"x_struct \\*\" } }\n // { dg-final { whatis-test s\\[1].y int } }\n \n+// { dg-final { note-test p.use_count() 1 } }\n+// { dg-final { note-test p.unique() true } }\n+// { dg-final { note-test q.use_count() 2 } }\n+// { dg-final { note-test q.unique() false } }\n+\n   return 0;  // Mark SPOT\n }\n "}]}