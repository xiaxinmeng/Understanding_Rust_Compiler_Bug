{"sha": "25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjVkNjI0ODBjODlkNmRiOTBhNjZiYTY5ZjZkYmFhODIwYTFhYzkwYg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-01-28T20:15:20Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-01-28T21:45:22Z"}, "message": "c++: Fix guard variable and attribute weak.\n\nMy patch for PR 91476 worked for decls that are implicitly comdat/weak due\nto C++ linkage rules, but broke variables explicitly marked weak.\n\n\tPR c++/93477\n\tPR c++/91476\n\t* decl2.c (copy_linkage): Do copy DECL_ONE_ONLY and DECL_WEAK.", "tree": {"sha": "13bf87eef5349bef8f54b786ede4feab866a2026", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/13bf87eef5349bef8f54b786ede4feab866a2026"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99eb1a824a69eb390bc104a1b91f901773866dd4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/99eb1a824a69eb390bc104a1b91f901773866dd4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/99eb1a824a69eb390bc104a1b91f901773866dd4"}], "stats": {"total": 23, "additions": 21, "deletions": 2}, "files": [{"sha": "0a959bbd49d0f30c896d127b9ea446f5035fc526", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "patch": "@@ -1,5 +1,9 @@\n 2020-01-28  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/93477\n+\tPR c++/91476\n+\t* decl2.c (copy_linkage): Do copy DECL_ONE_ONLY and DECL_WEAK.\n+\n \tPR c++/90546\n \t* call.c (build_user_type_conversion_1): Allow a template conversion\n \treturning an rvalue reference to bind directly to an lvalue."}, {"sha": "98d8e6a6b53f998a66e6352d58d5529cfc98b28e", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "patch": "@@ -3228,8 +3228,12 @@ copy_linkage (tree guard, tree decl)\n     {\n       CP_DECL_THREAD_LOCAL_P (guard) = CP_DECL_THREAD_LOCAL_P (decl);\n       set_decl_tls_model (guard, DECL_TLS_MODEL (decl));\n-      /* We can't rely on DECL_WEAK (decl) or DECL_ONE_ONLY (decl) here, as\n-\t they may not be set until import_export_decl at EOF.  */\n+      if (DECL_ONE_ONLY (decl))\n+\tmake_decl_one_only (guard, cxx_comdat_group (guard));\n+      if (TREE_PUBLIC (decl))\n+\tDECL_WEAK (guard) = DECL_WEAK (decl);\n+      /* Also check vague_linkage_p, as DECL_WEAK and DECL_ONE_ONLY might not\n+\t be set until import_export_decl at EOF.  */\n       if (vague_linkage_p (decl))\n \tcomdat_linkage (guard);\n       DECL_VISIBILITY (guard) = DECL_VISIBILITY (decl);"}, {"sha": "537c90524f3c55bf39faeb8b1a648d64b364c584", "filename": "gcc/testsuite/g++.dg/abi/guard4.C", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fguard4.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/25d62480c89d6db90a66ba69f6dbaa820a1ac90b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fguard4.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fguard4.C?ref=25d62480c89d6db90a66ba69f6dbaa820a1ac90b", "patch": "@@ -0,0 +1,11 @@\n+// PR c++/93477\n+// { dg-require-weak }\n+\n+namespace x {\n+  struct s {\n+    s() {}\n+    static int a;\n+  };\n+  // { dg-final { scan-assembler {.weak[^\\n]*_ZGVN1x1bE} } }\n+  struct s __attribute__((weak)) b = s();\n+}"}]}