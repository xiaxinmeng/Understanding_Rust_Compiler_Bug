{"sha": "07fee63db7b06207917849410e12de750bdb646f", "node_id": "C_kwDOANBUbNoAKDA3ZmVlNjNkYjdiMDYyMDc5MTc4NDk0MTBlMTJkZTc1MGJkYjY0NmY", "commit": {"author": {"name": "CohenArthur", "email": "arthur.cohen@epita.fr", "date": "2021-11-08T21:44:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-08T21:44:02Z"}, "message": "Merge pull request #792 from npate012/defid_to_struct\n\nChange DefId type from uint64_t to be struct", "tree": {"sha": "1bbb8b1cc483cd37180cc3197cc1780fc9824935", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1bbb8b1cc483cd37180cc3197cc1780fc9824935"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/07fee63db7b06207917849410e12de750bdb646f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhiZoiCRBK7hj4Ov3rIwAAtNoIAHF0vKKsucBSAmuUU5CQc6Ej\nMn8BGcWmGHTjTAoLg2VfshdeNQ59XspjryEhCuqEvTJM3GqSqRIgy+6tFN4gG/56\nx9w3TlOYaz9C0Idm9SpcviyNlNcEiDepaSswcLiPkY8MjPo0kAjzdl2KnZRZEVUC\nMbiiLXB/rNISsX8i/tviMjARAUKS0k1hz5/WjwsQoUXXcOANLVdQZNOEc1NzaMF9\nuXkUERhzmLDtQqVeTScQM7y1A83pB4yqHg8Rur+be2wqxKaF3m0N0BT3NMjEqQ83\nB96lJJLTExPu2yRjEXOATk7avXEzHh+NgZBDmBiBWnpSE7BnKbKam5BKzskq3Cc=\n=K1+C\n-----END PGP SIGNATURE-----\n", "payload": "tree 1bbb8b1cc483cd37180cc3197cc1780fc9824935\nparent d11a50eca3773fb29430db6d3ea3ccc2bb4335fa\nparent a7c31383def5c499864d61c5d00a1575d1cbff81\nauthor CohenArthur <arthur.cohen@epita.fr> 1636407842 +0100\ncommitter GitHub <noreply@github.com> 1636407842 +0100\n\nMerge pull request #792 from npate012/defid_to_struct\n\nChange DefId type from uint64_t to be struct"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07fee63db7b06207917849410e12de750bdb646f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/07fee63db7b06207917849410e12de750bdb646f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07fee63db7b06207917849410e12de750bdb646f/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d11a50eca3773fb29430db6d3ea3ccc2bb4335fa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d11a50eca3773fb29430db6d3ea3ccc2bb4335fa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d11a50eca3773fb29430db6d3ea3ccc2bb4335fa"}, {"sha": "a7c31383def5c499864d61c5d00a1575d1cbff81", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a7c31383def5c499864d61c5d00a1575d1cbff81", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a7c31383def5c499864d61c5d00a1575d1cbff81"}], "stats": {"total": 39, "additions": 27, "deletions": 12}, "files": [{"sha": "4472eeec38b5f1e05259348660434c50119f87ab", "filename": "gcc/rust/typecheck/rust-tyty.h", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07fee63db7b06207917849410e12de750bdb646f/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07fee63db7b06207917849410e12de750bdb646f/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.h?ref=07fee63db7b06207917849410e12de750bdb646f", "patch": "@@ -1324,7 +1324,7 @@ class FnType : public BaseType, public SubstitutionRef\n       params (std::move (params)), type (type), flags (flags),\n       identifier (identifier), id (id), abi (abi)\n   {\n-    LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+    LocalDefId local_def_id = id.localDefId;\n     rust_assert (local_def_id != UNKNOWN_LOCAL_DEFID);\n   }\n \n@@ -1339,7 +1339,7 @@ class FnType : public BaseType, public SubstitutionRef\n       params (params), type (type), flags (flags), identifier (identifier),\n       id (id), abi (abi)\n   {\n-    LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+    LocalDefId local_def_id = id.localDefId;\n     rust_assert (local_def_id != UNKNOWN_LOCAL_DEFID);\n   }\n \n@@ -1519,7 +1519,7 @@ class ClosureType : public BaseType, public SubstitutionRef\n       parameter_types (std::move (parameter_types)),\n       result_type (std::move (result_type)), id (id)\n   {\n-    LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+    LocalDefId local_def_id = id.localDefId;\n     rust_assert (local_def_id != UNKNOWN_LOCAL_DEFID);\n   }\n \n@@ -1533,7 +1533,7 @@ class ClosureType : public BaseType, public SubstitutionRef\n       parameter_types (std::move (parameter_types)),\n       result_type (std::move (result_type)), id (id)\n   {\n-    LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+    LocalDefId local_def_id = id.localDefId;\n     rust_assert (local_def_id != UNKNOWN_LOCAL_DEFID);\n   }\n "}, {"sha": "9e5b50951780e0cb3fa9c55ba25024780522e622", "filename": "gcc/rust/util/rust-hir-map.cc", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07fee63db7b06207917849410e12de750bdb646f/gcc%2Frust%2Futil%2Frust-hir-map.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07fee63db7b06207917849410e12de750bdb646f/gcc%2Frust%2Futil%2Frust-hir-map.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Futil%2Frust-hir-map.cc?ref=07fee63db7b06207917849410e12de750bdb646f", "patch": "@@ -63,7 +63,7 @@ NodeMapping::get_defid () const\n DefId\n NodeMapping::get_defid (CrateNum crate_num, LocalDefId local_defid)\n {\n-  return ((uint64_t) crate_num << 32) | local_defid;\n+  return DefId{crate_num, local_defid};\n }\n \n std::string\n@@ -209,8 +209,8 @@ Mappings::insert_hir_crate (HIR::Crate *crate)\n void\n Mappings::insert_defid_mapping (DefId id, HIR::Item *item)\n {\n-  CrateNum crate_num = (id & DEF_ID_CRATE_MASK) >> 32;\n-  LocalDefId local_def_id = id & DEF_ID_LOCAL_DEF_MASK;\n+  CrateNum crate_num = id.crateNum;\n+  LocalDefId local_def_id = id.localDefId;\n \n   rust_assert (lookup_defid (id) == nullptr);\n   rust_assert (lookup_local_defid (crate_num, local_def_id) == nullptr);"}, {"sha": "066577961813dd389a45e9156f2cdf64a6c1b7dc", "filename": "gcc/rust/util/rust-mapping-common.h", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07fee63db7b06207917849410e12de750bdb646f/gcc%2Frust%2Futil%2Frust-mapping-common.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07fee63db7b06207917849410e12de750bdb646f/gcc%2Frust%2Futil%2Frust-mapping-common.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Futil%2Frust-mapping-common.h?ref=07fee63db7b06207917849410e12de750bdb646f", "patch": "@@ -31,17 +31,32 @@ typedef uint32_t NodeId;\n typedef uint32_t HirId;\n // refers to any top-level decl in HIR\n typedef uint32_t LocalDefId;\n-// refers to <Crate><DefId>\n-typedef uint64_t DefId;\n \n-#define DEF_ID_CRATE_MASK 0xFFFFFFFF00000000\n-#define DEF_ID_LOCAL_DEF_MASK 0x00000000FFFFFFFF\n+struct DefId\n+{\n+  CrateNum crateNum;\n+  LocalDefId localDefId;\n+\n+  bool operator== (const DefId &other) const\n+  {\n+    return this->crateNum == other.crateNum\n+\t   && this->localDefId == other.localDefId;\n+  }\n+\n+  bool operator!= (const DefId &other) const { return !(*this == other); }\n+\n+  bool operator< (const DefId &other) const\n+  {\n+    return ((uint64_t) this->crateNum << 32 | this->localDefId)\n+\t   < ((uint64_t) other.crateNum << 32 | other.localDefId);\n+  }\n+};\n \n #define UNKNOWN_CREATENUM ((uint32_t) (0))\n #define UNKNOWN_NODEID ((uint32_t) (0))\n #define UNKNOWN_HIRID ((uint32_t) (0))\n #define UNKNOWN_LOCAL_DEFID ((uint32_t) (0))\n-#define UNKNOWN_DEFID ((uint64_t) (0))\n+#define UNKNOWN_DEFID (DefId{0, 0})\n \n } // namespace Rust\n "}]}