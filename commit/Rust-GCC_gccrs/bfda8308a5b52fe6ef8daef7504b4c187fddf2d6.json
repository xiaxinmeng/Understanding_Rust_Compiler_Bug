{"sha": "bfda8308a5b52fe6ef8daef7504b4c187fddf2d6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmZkYTgzMDhhNWI1MmZlNmVmOGRhZWY3NTA0YjRjMTg3ZmRkZjJkNg==", "commit": {"author": {"name": "Andrew John Hughes", "email": "gnu_andrew@member.fsf.org", "date": "2004-11-07T11:29:03Z"}, "committer": {"name": "Mark Wielaard", "email": "mark@gcc.gnu.org", "date": "2004-11-07T11:29:03Z"}, "message": "2004-11-07  Andrew John Hughes <gnu_andrew@member.fsf.org>\n\n       * java/util/Currency.java\n       Documented variables and methods more fully.\n       Caches the currency instances, so that a request\n       for a locale, l, only ever returns the same\n       instance (i.e. successive calls to getInstance(l)\n       are reference equivalent (==)).\n\nFrom-SVN: r90226", "tree": {"sha": "a88e6d0223eacf6970a21306d87eb610309a59c0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a88e6d0223eacf6970a21306d87eb610309a59c0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6/comments", "author": {"login": "gnu-andrew", "id": 962817, "node_id": "MDQ6VXNlcjk2MjgxNw==", "avatar_url": "https://avatars.githubusercontent.com/u/962817?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gnu-andrew", "html_url": "https://github.com/gnu-andrew", "followers_url": "https://api.github.com/users/gnu-andrew/followers", "following_url": "https://api.github.com/users/gnu-andrew/following{/other_user}", "gists_url": "https://api.github.com/users/gnu-andrew/gists{/gist_id}", "starred_url": "https://api.github.com/users/gnu-andrew/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gnu-andrew/subscriptions", "organizations_url": "https://api.github.com/users/gnu-andrew/orgs", "repos_url": "https://api.github.com/users/gnu-andrew/repos", "events_url": "https://api.github.com/users/gnu-andrew/events{/privacy}", "received_events_url": "https://api.github.com/users/gnu-andrew/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6dd70904fb23072438aa91e022cca7ec14e827d8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6dd70904fb23072438aa91e022cca7ec14e827d8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6dd70904fb23072438aa91e022cca7ec14e827d8"}], "stats": {"total": 254, "additions": 214, "deletions": 40}, "files": [{"sha": "8a5a54cf3f855dc1aaad350db5f3af7b998a72b8", "filename": "libjava/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6/libjava%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6/libjava%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2FChangeLog?ref=bfda8308a5b52fe6ef8daef7504b4c187fddf2d6", "patch": "@@ -1,3 +1,12 @@\n+2004-11-07  Andrew John Hughes <gnu_andrew@member.fsf.org>\n+\n+\t* java/util/Currency.java\n+\tDocumented variables and methods more fully.\n+\tCaches the currency instances, so that a request\n+\tfor a locale, l, only ever returns the same\n+\tinstance (i.e. successive calls to getInstance(l)\n+\tare reference equivalent (==)).\n+\n 2004-11-07  Andrew John Hughes  <gnu_andrew@member.fsf.org>\n \n \t* java/util/Date.java"}, {"sha": "ed141e589f78332d3bf09cb05480ac255b6d0712", "filename": "libjava/java/util/Currency.java", "status": "modified", "additions": 205, "deletions": 40, "changes": 245, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6/libjava%2Fjava%2Futil%2FCurrency.java", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfda8308a5b52fe6ef8daef7504b4c187fddf2d6/libjava%2Fjava%2Futil%2FCurrency.java", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fjava%2Futil%2FCurrency.java?ref=bfda8308a5b52fe6ef8daef7504b4c187fddf2d6", "patch": "@@ -34,28 +34,114 @@\n this exception to your version of the library, but you are not\n obligated to do so.  If you do not wish to do so, delete this\n exception statement from your version. */\n+\n package java.util;\n \n+import java.io.ObjectStreamException;\n import java.io.Serializable;\n import java.text.NumberFormat;\n \n-public final class Currency implements Serializable\n+/**\n+ * Representation of a currency for a particular locale.  Each currency\n+ * is identified by its ISO 4217 code, and only one instance of this\n+ * class exists per currency.  As a result, instances are created\n+ * via the <code>getInstance()</code> methods rather than by using\n+ * a constructor.\n+ *\n+ * @see java.util.Locale\n+ * @author Guilhem Lavaux  <guilhem.lavaux@free.fr>\n+ * @author Dalibor Topic <robilad@kaffe.org>\n+ * @author Bryce McKinlay <mckinlay@redhat.com>\n+ * @author Andrew John Hughes <gnu_andrew@member.fsf.org>\n+ * @since 1.4\n+ */\n+public final class Currency \n+  implements Serializable\n {\n+  /**\n+   * For compatability with Sun's JDK\n+   */\n   static final long serialVersionUID = -158308464356906721L;\n \n-  private Locale locale;\n-  private ResourceBundle res;\n+  /**\n+   * The locale associated with this currency.\n+   *\n+   * @see #Currency(java.util.Locale)\n+   * @see #getInstance(java.util.Locale)\n+   * @see #getSymbol(java.util.Locale)\n+   * @serial ignored.\n+   */\n+  private transient Locale locale;\n+\n+  /**\n+   * The resource bundle which maps the currency to\n+   * a ISO 4217 currency code.\n+   *\n+   * @see #getCurrencyCode()\n+   * @serial ignored.\n+   */\n+  private transient ResourceBundle res;\n+\n+  /**\n+   * The ISO 4217 currency code associated with this\n+   * particular instance.\n+   *\n+   * @see #getCurrencyCode()\n+   * @serial the ISO 4217 currency code\n+   */\n+  private String currencyCode;\n \n-  // For deserialization\n+  /**\n+   * A cache of <code>Currency</code> instances to\n+   * ensure the singleton nature of this class.  The key\n+   * is the locale of the currency.\n+   *\n+   * @see #getInstance(java.util.Locale)\n+   * @see #readResolve()\n+   * @serial ignored.\n+   */\n+  private transient static Map cache;\n+\n+  /**\n+   * Instantiates the cache.\n+   */\n+  static\n+  {\n+    cache = new HashMap();\n+  }\n+\n+  /**\n+   * Default constructor for deserialization\n+   */\n   private Currency ()\n   {\n   }\n \n+  /**\n+   * Constructor to create a <code>Currency</code> object\n+   * for a particular <code>Locale</code>.\n+   * All components of the given locale, other than the\n+   * country code, are ignored.  The results of calling this\n+   * method may vary over time, as the currency associated with\n+   * a particular country changes.  For countries without\n+   * a given currency (e.g. Antarctica), the result is null. \n+   *\n+   * @param loc the locale for the new currency.\n+   */\n   private Currency (Locale loc)\n   {\n     this.locale = loc;\n     this.res = ResourceBundle.getBundle (\"gnu.java.locale.LocaleInformation\", \n       locale, ClassLoader.getSystemClassLoader());\n+    /* Retrieve the ISO4217 currency code */\n+    try\n+      {\n+\tcurrencyCode = res.getString (\"intlCurrencySymbol\");\n+      }\n+    catch (Exception _)\n+      {\n+\tcurrencyCode = null;\n+      }\n   }\n \n   /**\n@@ -65,18 +151,20 @@ private Currency (Locale loc)\n    */\n   public String getCurrencyCode ()\n   {\n-    try\n-      {\n-\treturn res.getString (\"intlCurrencySymbol\");\n-      }\n-    catch (Exception _)\n-      {\n-\treturn null;\n-      }\n+    return currencyCode;\n   }\n \n   /**\n-   * @return number of digits after decimal separator for this currency.\n+   * Returns the number of digits which occur after the decimal point\n+   * for this particular currency.  For example, currencies such\n+   * as the U.S. dollar, the Euro and the Great British pound have two\n+   * digits following the decimal point to indicate the value which exists\n+   * in the associated lower-valued coinage (cents in the case of the first\n+   * two, pennies in the latter).  Some currencies such as the Japanese\n+   * Yen have no digits after the decimal point.  In the case of pseudo\n+   * currencies, such as IMF Special Drawing Rights, -1 is returned.\n+   *\n+   * @return the number of digits after the decimal separator for this currency.\n    */   \n   public int getDefaultFractionDigits ()\n   {\n@@ -87,48 +175,87 @@ public int getDefaultFractionDigits ()\n     \n   /**\n    * Builds a new currency instance for this locale.\n+   * All components of the given locale, other than the\n+   * country code, are ignored.  The results of calling this\n+   * method may vary over time, as the currency associated with\n+   * a particular country changes.  For countries without\n+   * a given currency (e.g. Antarctica), the result is null. \n    *\n    * @param locale a <code>Locale</code> instance.\n-   * \n    * @return a new <code>Currency</code> instance.\n+   * @throws NullPointerException if the locale or its\n+   *         country code is null.\n+   * @throws IllegalArgumentException if the country of\n+   *         the given locale is not a supported ISO3166 code.\n    */ \n   public static Currency getInstance (Locale locale)\n   {\n-    return new Currency (locale);\n+    /**\n+     * The new instance must be the only available instance\n+     * for the currency it supports.  We ensure this happens,\n+     * while maintaining a suitable performance level, by\n+     * creating the appropriate object on the first call to\n+     * this method, and returning the cached instance on\n+     * later calls.\n+     */\n+    Currency newCurrency;\n+\n+    /* Attempt to get the currency from the cache */\n+    newCurrency = (Currency) cache.get(locale);\n+    if (newCurrency == null)\n+      {\n+        /* Create the currency for this locale */\n+        newCurrency = new Currency (locale);\n+        /* Cache it */\n+        cache.put(locale, newCurrency);\n+      }\n+    /* Return the instance */\n+    return newCurrency;\n   }\n \n   /**\n    * Builds the currency corresponding to the specified currency code.\n    *\n    * @param currencyCode a string representing a currency code.\n-   *\n    * @return a new <code>Currency</code> instance.\n+   * @throws NullPointerException if currencyCode is null.\n+   * @throws IllegalArgumentException if the supplied currency code\n+   *         is not a supported ISO 4217 code.\n    */\n   public static Currency getInstance (String currencyCode)\n   {\n-    Locale[] all_locales = Locale.getAvailableLocales ();\n+    Locale[] allLocales = Locale.getAvailableLocales ();\n     \n-    for (int i=0;i<all_locales.length;i++)\n+    for (int i = 0;i < allLocales.length; i++)\n       {\n-\tCurrency test_currency = getInstance (all_locales[i]);\n+\tCurrency testCurrency = getInstance (allLocales[i]);\n \t\n-\tif (test_currency.getCurrencyCode() != null &&\n-\t    test_currency.getCurrencyCode().equals(currencyCode))\n-\t  return test_currency;\n+\tif (testCurrency.getCurrencyCode() != null &&\n+\t    testCurrency.getCurrencyCode().equals(currencyCode))\n+\t  return testCurrency;\n       }\n-    \n-    return null;\n+    /* \n+     * If we get this far, the code is not supported by any of\n+     * our locales.\n+     */\n+    throw new IllegalArgumentException(\"The currency code, \" + currencyCode +\n+                                       \", is not supported.\");\n   }\n \n   /**\n-   * This method returns the currency symbol.\n+   * This method returns the symbol which precedes or follows a\n+   * value in this particular currency.  In cases where there is no\n+   * such symbol for the currency, the ISO 4217 currency\n+   * code is returned.\n    *\n-   * @return the currency symbol.\n+   * @return the currency symbol, or the ISO 4217 currency code if\n+   *         one doesn't exist.\n    */\n   public String getSymbol()\n   {\n     try\n       {\n+        /* What does this return if there is no mapping? */\n \treturn res.getString (\"currencySymbol\");\n       }\n     catch (Exception _)\n@@ -138,25 +265,51 @@ public String getSymbol()\n   }\n \n   /**\n-   * This methods returns the currency symbol expressed in the specified locale.\n+   * <p>\n+   * This method returns the symbol which precedes or follows a\n+   * value in this particular currency.  The returned value is\n+   * the symbol used to denote the currency in the specified locale.\n+   * </p>\n+   * <p>\n+   * For example, a supplied locale may specify a different symbol\n+   * for the currency, due to conflicts with its own currency.\n+   * This would be the case with the American currency, the dollar.\n+   * Locales that also use a dollar-based currency (e.g. Canada, Australia)\n+   * need to differentiate the American dollar using 'US$' rather than '$'.\n+   * So, supplying one of these locales to <code>getSymbol()</code> would\n+   * return this value, rather than the standard '$'.\n+   * </p>\n+   * <p>\n+   * In cases where there is no such symbol for a particular currency,\n+   * the ISO 4217 currency code is returned.\n+   * </p>\n    *\n    * @param locale the locale to express the symbol in.\n-   * @return the currency symbol.\n+   * @return the currency symbol, or the ISO 4217 currency code if\n+   *         one doesn't exist.\n+   * @throws NullPointerException if the locale is null.\n    */\n   public String getSymbol(Locale locale)\n   {\n     // TODO. The behaviour is unclear if locale != this.locale.\n     // First we need to implement fully LocaleInformation*.java\n+\n+    /* \n+     * FIXME: My reading of how this method works has this implementation\n+     * as wrong.  It should return a value relating to how the specified\n+     * locale handles the symbol for this currency.  This implementation\n+     * seems to just do a variation of getInstance(locale).\n+     */\n     try\n       {\n-\tResourceBundle res = \n+\tResourceBundle localeResource = \n \t  ResourceBundle.getBundle (\"gnu.java.locale.LocaleInformation\", \n \t\t\t\t    locale, Currency.class.getClassLoader());\n \n-\tif (res.equals(this.res))\n-\t  return res.getString (\"currencySymbol\");\n+\tif (localeResource.equals(res))\n+\t  return localeResource.getString (\"currencySymbol\");\n \telse\n-\t  return res.getString (\"intlCurrencySymbol\");\n+\t  return localeResource.getString (\"intlCurrencySymbol\");\n       }\n     catch (Exception e1)\n       {\n@@ -178,13 +331,25 @@ public String getSymbol(Locale locale)\n    */\n   public String toString()\n   {\n-    try\n-      {\n-\treturn res.getString (\"intlCurrencySymbol\");\n-      }\n-    catch (Exception _)\n-      {\n-\treturn \"(unknown currency)\";\n-      }\n+    return getCurrencyCode();\n   }\n+\n+  /**\n+   * Resolves the deserialized object to the singleton instance for its\n+   * particular currency.  The currency code of the deserialized instance\n+   * is used to return the correct instance.\n+   *\n+   * @return the singleton instance for the currency specified by the\n+   *         currency code of the deserialized object.  This replaces\n+   *         the deserialized object as the returned object from\n+   *         deserialization.\n+   * @throws ObjectStreamException if a problem occurs with deserializing\n+   *         the object.\n+   */\n+  private Object readResolve()\n+    throws ObjectStreamException\n+  {\n+    return getInstance(currencyCode);\n+  }\n+\n }"}]}