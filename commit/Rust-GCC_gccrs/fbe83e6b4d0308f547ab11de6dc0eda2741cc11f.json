{"sha": "fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmJlODNlNmI0ZDAzMDhmNTQ3YWIxMWRlNmRjMGVkYTI3NDFjYzExZg==", "commit": {"author": {"name": "Joseph Myers", "email": "joseph@codesourcery.com", "date": "2019-02-06T01:51:29Z"}, "committer": {"name": "Joseph Myers", "email": "jsm28@gcc.gnu.org", "date": "2019-02-06T01:51:29Z"}, "message": "Fix type of extern array declared in inner scope with outer initialization shadowed (PR c/88584).\n\nAs reported in bug 88584, if you have a file-scope array with external\nlinkage, initialized at file scope, and that array is shadowed at\nblock scope, and is declared again with external linkage and an\nincomplete type in an inner scope, it is wrongly given a complete type\nin that inner scope when the correct C semantics give it an incomplete\ntype (only the visible declarations contribute to the type in a given\nscope).\n\nIn general, issues with the types of external linkage declarations\nbeing different in different scopes were addressed by my fixes for bug\n13801, for GCC 4.0.  In this case, however, the code in pushdecl\ndealing with giving declarations the right type in each scope works\nfine, and the type is subsequently modified by complete_array_type\ncalled from finish_decl: finish_decl is trying to complete an array\ntype based on an initializer, but that's only correct for the original\ninitialization at file scope, not for such a declaration in an inner\nscope (it's harmless but unnecessary in the case where the original\ndeclaration is still visible in the inner scope).  Thus, this patch\nchanges finish_decl to stop this logic applying for such an external\ndeclaration in an inner scope.  (An erroneous attempt to include an\ninitializer for an extern variable in an inner scope is diagnosed\nelsewhere.)\n\nThis is a regression from GCC 3.4, which properly rejected the code in\nquestion (quite likely by accident).\n\nBootstrapped with no regressions on x86_64-pc-linux-gnu.\n\ngcc/c:\n\tPR c/88584\n\t* c-decl.c (finish_decl): Do not complete array types for arrays\n\twith external linkage not at file scope.\n\ngcc/testsuite:\n\tPR c/88584\n\t* gcc.dg/redecl-18.c: New test.\n\nFrom-SVN: r268571", "tree": {"sha": "7aeeee4d2b0346b478fb60c80c4ce2c67f2e0e10", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7aeeee4d2b0346b478fb60c80c4ce2c67f2e0e10"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/comments", "author": {"login": "jsm28", "id": 10537793, "node_id": "MDQ6VXNlcjEwNTM3Nzkz", "avatar_url": "https://avatars.githubusercontent.com/u/10537793?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsm28", "html_url": "https://github.com/jsm28", "followers_url": "https://api.github.com/users/jsm28/followers", "following_url": "https://api.github.com/users/jsm28/following{/other_user}", "gists_url": "https://api.github.com/users/jsm28/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsm28/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsm28/subscriptions", "organizations_url": "https://api.github.com/users/jsm28/orgs", "repos_url": "https://api.github.com/users/jsm28/repos", "events_url": "https://api.github.com/users/jsm28/events{/privacy}", "received_events_url": "https://api.github.com/users/jsm28/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsm28", "id": 10537793, "node_id": "MDQ6VXNlcjEwNTM3Nzkz", "avatar_url": "https://avatars.githubusercontent.com/u/10537793?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsm28", "html_url": "https://github.com/jsm28", "followers_url": "https://api.github.com/users/jsm28/followers", "following_url": "https://api.github.com/users/jsm28/following{/other_user}", "gists_url": "https://api.github.com/users/jsm28/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsm28/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsm28/subscriptions", "organizations_url": "https://api.github.com/users/jsm28/orgs", "repos_url": "https://api.github.com/users/jsm28/repos", "events_url": "https://api.github.com/users/jsm28/events{/privacy}", "received_events_url": "https://api.github.com/users/jsm28/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9f061bd28eb2de30d150011a9dbd91a2fc58cf9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e9f061bd28eb2de30d150011a9dbd91a2fc58cf9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e9f061bd28eb2de30d150011a9dbd91a2fc58cf9"}], "stats": {"total": 37, "additions": 35, "deletions": 2}, "files": [{"sha": "9bb8351cc2ce88a65fdab6a974341e479404eb50", "filename": "gcc/c/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Fc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Fc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2FChangeLog?ref=fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "patch": "@@ -1,3 +1,9 @@\n+2019-02-06  Joseph Myers  <joseph@codesourcery.com>\n+\n+\tPR c/88584\n+\t* c-decl.c (finish_decl): Do not complete array types for arrays\n+\twith external linkage not at file scope.\n+\n 2019-02-05  Richard Biener  <rguenther@suse.de>\n \n \tPR c/88606"}, {"sha": "b658eb155bf1eb6b50ddf9b5b41d18a6d29279a1", "filename": "gcc/c/c-decl.c", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Fc%2Fc-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Fc%2Fc-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2Fc-decl.c?ref=fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "patch": "@@ -5099,10 +5099,15 @@ finish_decl (tree decl, location_t init_loc, tree init,\n \n   type = TREE_TYPE (decl);\n \n-  /* Deduce size of array from initialization, if not already known.  */\n+  /* Deduce size of array from initialization, if not already known.\n+     This is only needed for an initialization in the current scope;\n+     it must not be done for a file-scope initialization of a\n+     declaration with external linkage, redeclared in an inner scope\n+     with the outer declaration shadowed in an intermediate scope.  */\n   if (TREE_CODE (type) == ARRAY_TYPE\n       && TYPE_DOMAIN (type) == NULL_TREE\n-      && TREE_CODE (decl) != TYPE_DECL)\n+      && TREE_CODE (decl) != TYPE_DECL\n+      && !(TREE_PUBLIC (decl) && current_scope != file_scope))\n     {\n       bool do_default\n \t= (TREE_STATIC (decl)"}, {"sha": "2c6d0e47b5c7789e28b1255ad54a59dc6494b94d", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "patch": "@@ -1,3 +1,8 @@\n+2019-02-06  Joseph Myers  <joseph@codesourcery.com>\n+\n+\tPR c/88584\n+\t* gcc.dg/redecl-18.c: New test.\n+\n 2019-02-05  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/89187"}, {"sha": "f96bbe750f9f100413a495f0cb290def779613c6", "filename": "gcc/testsuite/gcc.dg/redecl-18.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Ftestsuite%2Fgcc.dg%2Fredecl-18.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fbe83e6b4d0308f547ab11de6dc0eda2741cc11f/gcc%2Ftestsuite%2Fgcc.dg%2Fredecl-18.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fredecl-18.c?ref=fbe83e6b4d0308f547ab11de6dc0eda2741cc11f", "patch": "@@ -0,0 +1,17 @@\n+/* Test redeclaration in an inner scope, with an incomplete type, of a\n+   file-scope initialized array shadowed in an intermediate scope (bug\n+   88584).  */\n+/* { dg-do compile } */\n+/* { dg-options \"\" } */\n+\n+int a[1] = { 0 };\n+\n+void\n+f (void)\n+{\n+  int a;\n+  {\n+    extern int a[];\n+    sizeof (a); /* { dg-error \"incomplete\" } */\n+  }\n+}"}]}