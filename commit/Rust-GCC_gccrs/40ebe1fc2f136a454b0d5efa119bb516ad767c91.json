{"sha": "40ebe1fc2f136a454b0d5efa119bb516ad767c91", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDBlYmUxZmMyZjEzNmE0NTRiMGQ1ZWZhMTE5YmI1MTZhZDc2N2M5MQ==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2019-12-19T10:03:48Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2019-12-19T10:03:48Z"}, "message": "Fix symver attribute with LTO\n\n\t* cgraph.c (cgraph_node_cannot_be_local_p_1): Prevent targets of\n\tsymver attributes to be localized.\n\t* ipa-visibility.c (cgraph_externally_visible_p,\n\tvarpool_node::externally_visible_p): Likewise.\n\t* symtab.c (symtab_node::verify_base): Check visibility of symbol\n\tversions.\n\n\t* lto-common.c (read_cgraph_and_symbols): Work around binutils\n\tPR25424\n\n\nCo-Authored-By: Xi Ruoyao <xry111@mengyan1223.wang>\n\nFrom-SVN: r279566", "tree": {"sha": "302cab4062b9e251794530c40e2009eb19eb7509", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/302cab4062b9e251794530c40e2009eb19eb7509"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/40ebe1fc2f136a454b0d5efa119bb516ad767c91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/40ebe1fc2f136a454b0d5efa119bb516ad767c91", "html_url": "https://github.com/Rust-GCC/gccrs/commit/40ebe1fc2f136a454b0d5efa119bb516ad767c91", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/40ebe1fc2f136a454b0d5efa119bb516ad767c91/comments", "author": null, "committer": null, "parents": [{"sha": "44fca83228acc96c19c51e52b5c0448e09329170", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/44fca83228acc96c19c51e52b5c0448e09329170", "html_url": "https://github.com/Rust-GCC/gccrs/commit/44fca83228acc96c19c51e52b5c0448e09329170"}], "stats": {"total": 61, "additions": 54, "deletions": 7}, "files": [{"sha": "5d938ae09d393748f2b57716d1f35787b281d6a2", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=40ebe1fc2f136a454b0d5efa119bb516ad767c91", "patch": "@@ -1,3 +1,13 @@\n+2019-12-19  Jan Hubicka  <hubicka@ucw.cz>\n+\t    Xi Ruoyao  <xry111@mengyan1223.wang>\n+\n+\t* cgraph.c (cgraph_node_cannot_be_local_p_1): Prevent targets of\n+\tsymver attributes to be localized.\n+\t* ipa-visibility.c (cgraph_externally_visible_p,\n+\tvarpool_node::externally_visible_p): Likewise.\n+\t* symtab.c (symtab_node::verify_base): Check visibility of symbol\n+\tversions.\n+\n 2019-12-19  Jan Hubicka  <hubicka@ucw.cz>\n \t    Luo Xiong Hu  <luoxhu@linux.ibm.com\n "}, {"sha": "5ba33a5a0cc2beded1c59aadc41dce8cef565a36", "filename": "gcc/cgraph.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Fcgraph.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Fcgraph.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.c?ref=40ebe1fc2f136a454b0d5efa119bb516ad767c91", "patch": "@@ -2226,6 +2226,9 @@ cgraph_node_cannot_be_local_p_1 (cgraph_node *node, void *)\n {\n   return !(!node->force_output\n \t   && !node->ifunc_resolver\n+\t   /* Limitation of gas requires us to output targets of symver aliases\n+\t      as global symbols.  This is binutils PR 25295.  */\n+\t   && !node->symver\n \t   && ((DECL_COMDAT (node->decl)\n \t\t&& !node->forced_by_abi\n \t\t&& !node->used_from_object_file_p ()"}, {"sha": "d216a54a7abc8bb25a06bb1ffee66d60e677f9aa", "filename": "gcc/ipa-visibility.c", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Fipa-visibility.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Fipa-visibility.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-visibility.c?ref=40ebe1fc2f136a454b0d5efa119bb516ad767c91", "patch": "@@ -220,6 +220,14 @@ cgraph_externally_visible_p (struct cgraph_node *node,\n       && lookup_attribute (\"dllexport\",\n \t\t\t   DECL_ATTRIBUTES (node->decl)))\n     return true;\n+\n+  /* Limitation of gas requires us to output targets of symver aliases as\n+     global symbols.  This is binutils PR 25295.  */\n+  ipa_ref *ref;\n+  FOR_EACH_ALIAS (node, ref)\n+    if (ref->referring->symver)\n+      return true;\n+\n   if (node->resolution == LDPR_PREVAILING_DEF_IRONLY)\n     return false;\n   /* When doing LTO or whole program, we can bring COMDAT functoins static.\n@@ -284,14 +292,13 @@ varpool_node::externally_visible_p (void)\n \t\t\t   DECL_ATTRIBUTES (decl)))\n     return true;\n \n-  /* See if we have linker information about symbol not being used or\n-     if we need to make guess based on the declaration.\n+  /* Limitation of gas requires us to output targets of symver aliases as\n+     global symbols.  This is binutils PR 25295.  */\n+  ipa_ref *ref;\n+  FOR_EACH_ALIAS (this, ref)\n+    if (ref->referring->symver)\n+      return true;\n \n-     Even if the linker clams the symbol is unused, never bring internal\n-     symbols that are declared by user as used or externally visible.\n-     This is needed for i.e. references from asm statements.   */\n-  if (used_from_object_file_p ())\n-    return true;\n   if (resolution == LDPR_PREVAILING_DEF_IRONLY)\n     return false;\n "}, {"sha": "d0b1dba740e93aadd6b31736a56f382e39cc6036", "filename": "gcc/lto/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Flto%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Flto%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2FChangeLog?ref=40ebe1fc2f136a454b0d5efa119bb516ad767c91", "patch": "@@ -1,3 +1,9 @@\n+2019-12-19  Jan Hubicka  <hubicka@ucw.cz>\n+\t    Xi Ruoyao  <xry111@mengyan1223.wang>\n+\n+\t* lto-common.c (read_cgraph_and_symbols): Work around binutils\n+\tPR25424\n+\n 2019-12-07  Jan Hubicka  <hubicka@ucw.cz>\n \n \t* lto-partition.c (lto_balanced_map): Fix printing of tp_first_run."}, {"sha": "ee07730a27d31dee8eedbc6d7e388d1ee96c3bbb", "filename": "gcc/lto/lto-common.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Flto%2Flto-common.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Flto%2Flto-common.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto-common.c?ref=40ebe1fc2f136a454b0d5efa119bb516ad767c91", "patch": "@@ -2818,6 +2818,11 @@ read_cgraph_and_symbols (unsigned nfiles, const char **fnames)\n \t\t\t   IDENTIFIER_POINTER\n \t\t\t     (DECL_ASSEMBLER_NAME (snode->decl)));\n \t  }\n+\t/* Symbol versions are always used externally, but linker does not\n+\t   report that correctly.\n+\t   This is binutils PR25924.  */\n+\telse if (snode->symver && *res == LDPR_PREVAILING_DEF_IRONLY)\n+\t  snode->resolution = LDPR_PREVAILING_DEF_IRONLY_EXP;\n \telse\n \t  snode->resolution = *res;\n       }"}, {"sha": "9c52192fced826f3ff02ff3e4d1f20ec30bdffbc", "filename": "gcc/symtab.c", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Fsymtab.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/40ebe1fc2f136a454b0d5efa119bb516ad767c91/gcc%2Fsymtab.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fsymtab.c?ref=40ebe1fc2f136a454b0d5efa119bb516ad767c91", "patch": "@@ -1156,6 +1156,22 @@ symtab_node::verify_base (void)\n       error (\"node is symver but not alias\");\n       error_found = true;\n     }\n+  /* Limitation of gas requires us to output targets of symver aliases as\n+     global symbols.  This is binutils PR 25295.  */\n+  if (symver\n+      && (!TREE_PUBLIC (get_alias_target ()->decl)\n+\t  || DECL_VISIBILITY (get_alias_target ()->decl) != VISIBILITY_DEFAULT))\n+    {\n+      error (\"symver target is not exported with default visibility\");\n+      error_found = true;\n+    }\n+  if (symver\n+      && (!TREE_PUBLIC (decl)\n+\t  || DECL_VISIBILITY (decl) != VISIBILITY_DEFAULT))\n+    {\n+      error (\"symver is not exported with default visibility\");\n+      error_found = true;\n+    }\n   if (same_comdat_group)\n     {\n       symtab_node *n = same_comdat_group;"}]}