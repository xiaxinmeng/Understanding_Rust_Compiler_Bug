{"sha": "0b210c43bbb6eddac8ba550d9c45bf679d4328c5", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MGIyMTBjNDNiYmI2ZWRkYWM4YmE1NTBkOWM0NWJmNjc5ZDQzMjhjNQ==", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2018-07-30T08:17:16Z"}, "committer": {"name": "Tom de Vries", "email": "vries@gcc.gnu.org", "date": "2018-07-30T08:17:16Z"}, "message": "[libgomp, nvptx] Calculate default dims per device\n\nThe default dimensions are calculated using per-device properties, but\ninitialized once and used on all devices.\n\nThis patch fixes this problem by introducing per-device default dimensions.\n\n2018-07-30  Tom de Vries  <tdevries@suse.de>\n\n\t* plugin/plugin-nvptx.c (struct ptx_device): Add default_dims field.\n\t(nvptx_open_device): Init default_dims for device.\n\t(nvptx_exec): Use default_dims from device.\n\nFrom-SVN: r263061", "tree": {"sha": "e1bcd506790a08b90ee41cf71f48bb7da3c969ab", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e1bcd506790a08b90ee41cf71f48bb7da3c969ab"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0b210c43bbb6eddac8ba550d9c45bf679d4328c5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0b210c43bbb6eddac8ba550d9c45bf679d4328c5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0b210c43bbb6eddac8ba550d9c45bf679d4328c5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0b210c43bbb6eddac8ba550d9c45bf679d4328c5/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "605219e7c74bc8039a994847729fb948230d66d3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/605219e7c74bc8039a994847729fb948230d66d3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/605219e7c74bc8039a994847729fb948230d66d3"}], "stats": {"total": 34, "additions": 27, "deletions": 7}, "files": [{"sha": "1d218f4be6c07e916e1f1547604c231be30e1e4a", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0b210c43bbb6eddac8ba550d9c45bf679d4328c5/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0b210c43bbb6eddac8ba550d9c45bf679d4328c5/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=0b210c43bbb6eddac8ba550d9c45bf679d4328c5", "patch": "@@ -1,3 +1,9 @@\n+2018-07-30  Tom de Vries  <tdevries@suse.de>\n+\n+\t* plugin/plugin-nvptx.c (struct ptx_device): Add default_dims field.\n+\t(nvptx_open_device): Init default_dims for device.\n+\t(nvptx_exec): Use default_dims from device.\n+\n 2018-07-26  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR testsuite/86660"}, {"sha": "5c522aaf2819279adb811a7b479238669a6f0682", "filename": "libgomp/plugin/plugin-nvptx.c", "status": "modified", "additions": 21, "deletions": 7, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0b210c43bbb6eddac8ba550d9c45bf679d4328c5/libgomp%2Fplugin%2Fplugin-nvptx.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0b210c43bbb6eddac8ba550d9c45bf679d4328c5/libgomp%2Fplugin%2Fplugin-nvptx.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fplugin%2Fplugin-nvptx.c?ref=0b210c43bbb6eddac8ba550d9c45bf679d4328c5", "patch": "@@ -417,6 +417,7 @@ struct ptx_device\n   int warp_size;\n   int max_threads_per_block;\n   int max_threads_per_multiprocessor;\n+  int default_dims[GOMP_DIM_MAX];\n \n   struct ptx_image_data *images;  /* Images loaded on device.  */\n   pthread_mutex_t image_lock;     /* Lock for above list.  */\n@@ -818,6 +819,9 @@ nvptx_open_device (int n)\n   if (r != CUDA_SUCCESS)\n     async_engines = 1;\n \n+  for (int i = 0; i != GOMP_DIM_MAX; i++)\n+    ptx_dev->default_dims[i] = 0;\n+\n   ptx_dev->images = NULL;\n   pthread_mutex_init (&ptx_dev->image_lock, NULL);\n \n@@ -1152,15 +1156,22 @@ nvptx_exec (void (*fn), size_t mapnum, void **hostaddrs, void **devaddrs,\n \n   if (seen_zero)\n     {\n-      /* See if the user provided GOMP_OPENACC_DIM environment\n-\t variable to specify runtime defaults. */\n-      static int default_dims[GOMP_DIM_MAX];\n-\n       pthread_mutex_lock (&ptx_dev_lock);\n-      if (!default_dims[0])\n+\n+      static int gomp_openacc_dims[GOMP_DIM_MAX];\n+      if (!gomp_openacc_dims[0])\n+\t{\n+\t  /* See if the user provided GOMP_OPENACC_DIM environment\n+\t     variable to specify runtime defaults.  */\n+\t  for (int i = 0; i < GOMP_DIM_MAX; ++i)\n+\t    gomp_openacc_dims[i] = GOMP_PLUGIN_acc_default_dim (i);\n+\t}\n+\n+      if (!nvthd->ptx_dev->default_dims[0])\n \t{\n+\t  int default_dims[GOMP_DIM_MAX];\n \t  for (int i = 0; i < GOMP_DIM_MAX; ++i)\n-\t    default_dims[i] = GOMP_PLUGIN_acc_default_dim (i);\n+\t    default_dims[i] = gomp_openacc_dims[i];\n \n \t  int gang, worker, vector;\n \t  {\n@@ -1196,12 +1207,15 @@ nvptx_exec (void (*fn), size_t mapnum, void **hostaddrs, void **devaddrs,\n \t\t\t     default_dims[GOMP_DIM_GANG],\n \t\t\t     default_dims[GOMP_DIM_WORKER],\n \t\t\t     default_dims[GOMP_DIM_VECTOR]);\n+\n+\t  for (i = 0; i != GOMP_DIM_MAX; i++)\n+\t    nvthd->ptx_dev->default_dims[i] = default_dims[i];\n \t}\n       pthread_mutex_unlock (&ptx_dev_lock);\n \n       for (i = 0; i != GOMP_DIM_MAX; i++)\n \tif (!dims[i])\n-\t  dims[i] = default_dims[i];\n+\t  dims[i] = nvthd->ptx_dev->default_dims[i];\n     }\n \n   /* Check if the accelerator has sufficient hardware resources to"}]}