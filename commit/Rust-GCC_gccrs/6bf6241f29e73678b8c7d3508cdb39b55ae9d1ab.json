{"sha": "6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab", "node_id": "C_kwDOANBUbNoAKDZiZjYyNDFmMjllNzM2NzhiOGM3ZDM1MDhjZGIzOWI1NWFlOWQxYWI", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-07-08T14:13:57Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-07-15T10:59:38Z"}, "message": "External Items with Rust ABI need to mangle the full path\n\nWhen compiling external rust abi item requires the fully qualified\ncanonical path to be mangled in order to link correctly.", "tree": {"sha": "11bfbd4b50e747d310ed1d596032c49b3cd6b710", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/11bfbd4b50e747d310ed1d596032c49b3cd6b710"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f51284b598863eb0cbeb2984fd1499a672f2191d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f51284b598863eb0cbeb2984fd1499a672f2191d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f51284b598863eb0cbeb2984fd1499a672f2191d"}], "stats": {"total": 17, "additions": 17, "deletions": 0}, "files": [{"sha": "ddad350eaa95bbdee348a50240393ad7d01a01c7", "filename": "gcc/rust/backend/rust-compile-extern.h", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab/gcc%2Frust%2Fbackend%2Frust-compile-extern.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab/gcc%2Frust%2Fbackend%2Frust-compile-extern.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-extern.h?ref=6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab", "patch": "@@ -130,6 +130,17 @@ class CompileExternItem : public HIRCompileBase,\n     tree compiled_fn_type = TyTyResolveCompile::compile (ctx, fntype);\n     std::string ir_symbol_name = function.get_item_name ();\n     std::string asm_name = function.get_item_name ();\n+    if (fntype->get_abi () == ABI::RUST)\n+      {\n+\t// then we need to get the canonical path of it and mangle it\n+\tconst Resolver::CanonicalPath *canonical_path = nullptr;\n+\tbool ok = ctx->get_mappings ()->lookup_canonical_path (\n+\t  function.get_mappings ().get_nodeid (), &canonical_path);\n+\trust_assert (ok);\n+\n+\tir_symbol_name = canonical_path->get () + fntype->subst_as_string ();\n+\tasm_name = ctx->mangle_item (fntype, *canonical_path);\n+      }\n \n     const unsigned int flags = Backend::function_is_declaration;\n     tree fndecl"}, {"sha": "75bd2e10b1c2cfb39247659946f1cfefc115b903", "filename": "gcc/rust/resolve/rust-ast-resolve-item.cc", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.cc?ref=6bf6241f29e73678b8c7d3508cdb39b55ae9d1ab", "patch": "@@ -1027,6 +1027,12 @@ void\n ResolveExternItem::visit (AST::ExternalFunctionItem &function)\n {\n   NodeId scope_node_id = function.get_node_id ();\n+  auto decl = CanonicalPath::new_seg (function.get_node_id (),\n+\t\t\t\t      function.get_identifier ());\n+  auto path = prefix.append (decl);\n+  auto cpath = canonical_prefix.append (decl);\n+\n+  mappings->insert_canonical_path (function.get_node_id (), cpath);\n \n   resolve_visibility (function.get_visibility ());\n "}]}