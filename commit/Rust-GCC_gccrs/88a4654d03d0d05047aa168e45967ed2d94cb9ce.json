{"sha": "88a4654d03d0d05047aa168e45967ed2d94cb9ce", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODhhNDY1NGQwM2QwZDA1MDQ3YWExNjhlNDU5NjdlZDJkOTRjYjljZQ==", "commit": {"author": {"name": "Cesar Philippidis", "email": "cesar@codesourcery.com", "date": "2018-07-26T11:42:29Z"}, "committer": {"name": "Tom de Vries", "email": "vries@gcc.gnu.org", "date": "2018-07-26T11:42:29Z"}, "message": "[libgomp, nvptx] Add error with recompilation hint for launch failure\n\nCurrently, when a kernel is lauched with too many workers, it results in a cuda\nlaunch failure.  This is triggered f.i. for parallel-loop-1.c at -O0 on a Quadro\nM1200.\n\nThis patch detects this situation, and errors out with a hint on how to fix it.\n\nBuild and reg-tested on x86_64 with nvptx accelerator.\n\n2018-07-26  Cesar Philippidis  <cesar@codesourcery.com>\n\t    Tom de Vries  <tdevries@suse.de>\n\n\t* plugin/plugin-nvptx.c (nvptx_exec): Error if the hardware doesn't have\n\tsufficient resources to launch a kernel, and give a hint on how to fix\n\tit.\n\nCo-Authored-By: Tom de Vries <tdevries@suse.de>\n\nFrom-SVN: r262997", "tree": {"sha": "228f30ad516a6c3e25c474b2b38e70afb930256c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/228f30ad516a6c3e25c474b2b38e70afb930256c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/88a4654d03d0d05047aa168e45967ed2d94cb9ce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/88a4654d03d0d05047aa168e45967ed2d94cb9ce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/88a4654d03d0d05047aa168e45967ed2d94cb9ce", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/88a4654d03d0d05047aa168e45967ed2d94cb9ce/comments", "author": {"login": "cesarjp", "id": 4576177, "node_id": "MDQ6VXNlcjQ1NzYxNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/4576177?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cesarjp", "html_url": "https://github.com/cesarjp", "followers_url": "https://api.github.com/users/cesarjp/followers", "following_url": "https://api.github.com/users/cesarjp/following{/other_user}", "gists_url": "https://api.github.com/users/cesarjp/gists{/gist_id}", "starred_url": "https://api.github.com/users/cesarjp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cesarjp/subscriptions", "organizations_url": "https://api.github.com/users/cesarjp/orgs", "repos_url": "https://api.github.com/users/cesarjp/repos", "events_url": "https://api.github.com/users/cesarjp/events{/privacy}", "received_events_url": "https://api.github.com/users/cesarjp/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "0c6c2f5fc239121f70334a587e371aab2c7a60a4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0c6c2f5fc239121f70334a587e371aab2c7a60a4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0c6c2f5fc239121f70334a587e371aab2c7a60a4"}], "stats": {"total": 22, "additions": 22, "deletions": 0}, "files": [{"sha": "27ff705e90997df6c2eb0993cf56c30403edaaa8", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/88a4654d03d0d05047aa168e45967ed2d94cb9ce/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/88a4654d03d0d05047aa168e45967ed2d94cb9ce/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=88a4654d03d0d05047aa168e45967ed2d94cb9ce", "patch": "@@ -1,3 +1,10 @@\n+2018-07-26  Cesar Philippidis  <cesar@codesourcery.com>\n+\t    Tom de Vries  <tdevries@suse.de>\n+\n+\t* plugin/plugin-nvptx.c (nvptx_exec): Error if the hardware doesn't have\n+\tsufficient resources to launch a kernel, and give a hint on how to fix\n+\tit.\n+\n 2018-07-26  Cesar Philippidis  <cesar@codesourcery.com>\n \t    Tom de Vries  <tdevries@suse.de>\n "}, {"sha": "3a4077a131522ec5e6d29c363904839e42abc31b", "filename": "libgomp/plugin/plugin-nvptx.c", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/88a4654d03d0d05047aa168e45967ed2d94cb9ce/libgomp%2Fplugin%2Fplugin-nvptx.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/88a4654d03d0d05047aa168e45967ed2d94cb9ce/libgomp%2Fplugin%2Fplugin-nvptx.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fplugin%2Fplugin-nvptx.c?ref=88a4654d03d0d05047aa168e45967ed2d94cb9ce", "patch": "@@ -1204,6 +1204,21 @@ nvptx_exec (void (*fn), size_t mapnum, void **hostaddrs, void **devaddrs,\n \t  dims[i] = default_dims[i];\n     }\n \n+  /* Check if the accelerator has sufficient hardware resources to\n+     launch the offloaded kernel.  */\n+  if (dims[GOMP_DIM_WORKER] * dims[GOMP_DIM_VECTOR]\n+      > targ_fn->max_threads_per_block)\n+    {\n+      int suggest_workers\n+\t= targ_fn->max_threads_per_block / dims[GOMP_DIM_VECTOR];\n+      GOMP_PLUGIN_fatal (\"The Nvidia accelerator has insufficient resources to\"\n+\t\t\t \" launch '%s' with num_workers = %d; recompile the\"\n+\t\t\t \" program with 'num_workers = %d' on that offloaded\"\n+\t\t\t \" region or '-fopenacc-dim=:%d'\",\n+\t\t\t targ_fn->launch->fn, dims[GOMP_DIM_WORKER],\n+\t\t\t suggest_workers, suggest_workers);\n+    }\n+\n   /* This reserves a chunk of a pre-allocated page of memory mapped on both\n      the host and the device. HP is a host pointer to the new chunk, and DP is\n      the corresponding device pointer.  */"}]}