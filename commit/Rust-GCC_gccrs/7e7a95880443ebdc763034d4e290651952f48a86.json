{"sha": "7e7a95880443ebdc763034d4e290651952f48a86", "node_id": "C_kwDOANBUbNoAKDdlN2E5NTg4MDQ0M2ViZGM3NjMwMzRkNGUyOTA2NTE5NTJmNDhhODY", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-09-27T08:50:06Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-02-21T11:36:31Z"}, "message": "gccrs: Fix missing dead code analysis ICE on local enum definition\n\nWhen resolving local enum's within a Block the name resolution info is\nnot at the top of the stack so this patch introduces a new mappings class\nfor miscellaneous name resolutions which can be used during path analaysis.\n\nFixes #1272\n\ngcc/rust/ChangeLog:\n\n\t* resolve/rust-name-resolver.h: Add miscellenaous item mappings.\n\t* resolve/rust-name-resolver.cc (Resolver::insert_resolved_misc): Use\n\tnew mappings.\n\t(Resolver::lookup_resolved_misc): Likewise.\n\t* typecheck/rust-hir-type-check-path.cc (TypeCheckExpr::resolve_segments):\n\tAdapt function to insert into miscelleanous mappings.\n\t* checks/lints/rust-lint-marklive.cc (MarkLive::find_ref_node_id):\n\tAllow lookup in miscelleanous mappings in mark-live phase.\n\ngcc/testsuite/ChangeLog:\n\n\t* rust/compile/issue-1272.rs: New test.", "tree": {"sha": "a28d9088cf656fa718b8d7fe3be0019861167ba0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a28d9088cf656fa718b8d7fe3be0019861167ba0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7e7a95880443ebdc763034d4e290651952f48a86", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e7a95880443ebdc763034d4e290651952f48a86", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7e7a95880443ebdc763034d4e290651952f48a86", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e7a95880443ebdc763034d4e290651952f48a86/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ecc863e85efe259c799515de0c38c2297b0e3bd7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ecc863e85efe259c799515de0c38c2297b0e3bd7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ecc863e85efe259c799515de0c38c2297b0e3bd7"}], "stats": {"total": 46, "additions": 44, "deletions": 2}, "files": [{"sha": "c914b549257008ff5997f3c39133d4113a718681", "filename": "gcc/rust/checks/lints/rust-lint-marklive.cc", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Fchecks%2Flints%2Frust-lint-marklive.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Fchecks%2Flints%2Frust-lint-marklive.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fchecks%2Flints%2Frust-lint-marklive.cc?ref=7e7a95880443ebdc763034d4e290651952f48a86", "patch": "@@ -273,8 +273,11 @@ MarkLive::find_ref_node_id (NodeId ast_node_id, NodeId &ref_node_id)\n {\n   if (!resolver->lookup_resolved_name (ast_node_id, &ref_node_id))\n     {\n-      bool ok = resolver->lookup_resolved_type (ast_node_id, &ref_node_id);\n-      rust_assert (ok);\n+      if (!resolver->lookup_resolved_type (ast_node_id, &ref_node_id))\n+\t{\n+\t  bool ok = resolver->lookup_resolved_misc (ast_node_id, &ref_node_id);\n+\t  rust_assert (ok);\n+\t}\n     }\n }\n "}, {"sha": "b94713d3c30f7a10f886efe89ace62a1fb921d8c", "filename": "gcc/rust/resolve/rust-name-resolver.cc", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Fresolve%2Frust-name-resolver.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Fresolve%2Frust-name-resolver.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-name-resolver.cc?ref=7e7a95880443ebdc763034d4e290651952f48a86", "patch": "@@ -499,5 +499,25 @@ Resolver::lookup_resolved_macro (NodeId refId, NodeId *defId)\n   return true;\n }\n \n+void\n+Resolver::insert_resolved_misc (NodeId refId, NodeId defId)\n+{\n+  auto it = misc_resolved_items.find (refId);\n+  rust_assert (it == misc_resolved_items.end ());\n+\n+  misc_resolved_items[refId] = defId;\n+}\n+\n+bool\n+Resolver::lookup_resolved_misc (NodeId refId, NodeId *defId)\n+{\n+  auto it = misc_resolved_items.find (refId);\n+  if (it == misc_resolved_items.end ())\n+    return false;\n+\n+  *defId = it->second;\n+  return true;\n+}\n+\n } // namespace Resolver\n } // namespace Rust"}, {"sha": "302b0de15ccec1e8d58bd276d3bd5f203241929f", "filename": "gcc/rust/resolve/rust-name-resolver.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Fresolve%2Frust-name-resolver.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Fresolve%2Frust-name-resolver.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-name-resolver.h?ref=7e7a95880443ebdc763034d4e290651952f48a86", "patch": "@@ -126,6 +126,9 @@ class Resolver\n   void insert_resolved_macro (NodeId refId, NodeId defId);\n   bool lookup_resolved_macro (NodeId refId, NodeId *defId);\n \n+  void insert_resolved_misc (NodeId refId, NodeId defId);\n+  bool lookup_resolved_misc (NodeId refId, NodeId *defId);\n+\n   // proxy for scoping\n   Scope &get_name_scope () { return name_scope; }\n   Scope &get_type_scope () { return type_scope; }\n@@ -202,6 +205,9 @@ class Resolver\n   std::map<NodeId, NodeId> resolved_labels;\n   std::map<NodeId, NodeId> resolved_macros;\n \n+  // misc\n+  std::map<NodeId, NodeId> misc_resolved_items;\n+\n   // keep track of the current module scope ids\n   std::vector<NodeId> current_module_stack;\n };"}, {"sha": "305d73f76f97e188a2a79d2050fc5cb1179a85ad", "filename": "gcc/rust/typecheck/rust-hir-type-check-path.cc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-path.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-path.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-path.cc?ref=7e7a95880443ebdc763034d4e290651952f48a86", "patch": "@@ -462,6 +462,11 @@ TypeCheckExpr::resolve_segments (NodeId root_resolved_node_id,\n       resolver->insert_resolved_type (expr_mappings.get_nodeid (),\n \t\t\t\t      resolved_node_id);\n     }\n+  else\n+    {\n+      resolver->insert_resolved_misc (expr_mappings.get_nodeid (),\n+\t\t\t\t      resolved_node_id);\n+    }\n \n   infered = tyseg;\n }"}, {"sha": "08adaaf944b55903d277519db173d4fe6ec293cf", "filename": "gcc/testsuite/rust/compile/issue-1272.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1272.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7e7a95880443ebdc763034d4e290651952f48a86/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1272.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1272.rs?ref=7e7a95880443ebdc763034d4e290651952f48a86", "patch": "@@ -0,0 +1,8 @@\n+fn main() -> i32 {\n+    enum E {\n+        X(u8),\n+    }\n+    let _v = E::X(4);\n+\n+    0\n+}"}]}