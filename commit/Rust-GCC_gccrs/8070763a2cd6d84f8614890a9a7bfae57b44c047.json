{"sha": "8070763a2cd6d84f8614890a9a7bfae57b44c047", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODA3MDc2M2EyY2Q2ZDg0Zjg2MTQ4OTBhOWE3YmZhZTU3YjQ0YzA0Nw==", "commit": {"author": {"name": "Andi Kleen", "email": "ak@linux.intel.com", "date": "2016-07-06T02:38:49Z"}, "committer": {"name": "Andi Kleen", "email": "ak@gcc.gnu.org", "date": "2016-07-06T02:38:49Z"}, "message": "Fix MPX tests on systems with MPX disabled\n\nI have a Skylake system with MPX in the CPU, but MPX is disabled\nin the kernel configuration.\n\nThis makes all the MPX tests fail because they assume if MPX\nis in CPUID it works\n\nCheck the output of XGETBV too to detect non MPX kernels.\n\ngcc/testsuite/:\n\n2016-07-05  Andi Kleen  <ak@linux.intel.com>\n\n\t* gcc.target/i386/mpx/mpx-check.h: Check XGETBV output\n\tif kernel supports MPX.\n\nFrom-SVN: r238031", "tree": {"sha": "c126d32aab7e0abd395b031752d1798dceeb508e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c126d32aab7e0abd395b031752d1798dceeb508e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8070763a2cd6d84f8614890a9a7bfae57b44c047", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8070763a2cd6d84f8614890a9a7bfae57b44c047", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8070763a2cd6d84f8614890a9a7bfae57b44c047", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8070763a2cd6d84f8614890a9a7bfae57b44c047/comments", "author": null, "committer": null, "parents": [{"sha": "8217ad204feff459bdf3f0eb1e99a02ab6fba9a3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8217ad204feff459bdf3f0eb1e99a02ab6fba9a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8217ad204feff459bdf3f0eb1e99a02ab6fba9a3"}], "stats": {"total": 17, "additions": 16, "deletions": 1}, "files": [{"sha": "15231dc82b2ee1c5d000855e31068408b0304d3c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8070763a2cd6d84f8614890a9a7bfae57b44c047/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8070763a2cd6d84f8614890a9a7bfae57b44c047/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=8070763a2cd6d84f8614890a9a7bfae57b44c047", "patch": "@@ -1,3 +1,8 @@\n+2016-07-05  Andi Kleen  <ak@linux.intel.com>\n+\n+\t* gcc.target/i386/mpx/mpx-check.h: Check XGETBV output\n+\tif kernel supports MPX.\n+\n 2016-07-05  Kito Cheng <kito.cheng@gmail.com>\n \n \t* gcc.c-torture/compile/pr69102.c: Require fpic support."}, {"sha": "73aa01f2565bb168208cdec618e89b5a1d0de7a5", "filename": "gcc/testsuite/gcc.target/i386/mpx/mpx-check.h", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8070763a2cd6d84f8614890a9a7bfae57b44c047/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmpx%2Fmpx-check.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8070763a2cd6d84f8614890a9a7bfae57b44c047/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmpx%2Fmpx-check.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmpx%2Fmpx-check.h?ref=8070763a2cd6d84f8614890a9a7bfae57b44c047", "patch": "@@ -16,6 +16,16 @@ mpx_test (int, const char **);\n \n #define DEBUG\n \n+#define XSTATE_BNDREGS (1 << 3)\n+\n+/* This should be an intrinsic, but isn't.  */\n+static int xgetbv (unsigned x)\n+{\n+   unsigned eax, edx;\n+   asm (\"xgetbv\" : \"=a\" (eax), \"=d\" (edx) : \"c\" (x)); \n+   return eax;\n+}\n+\n int\n main (int argc, const char **argv)\n {\n@@ -27,7 +37,7 @@ main (int argc, const char **argv)\n   __cpuid_count (7, 0, eax, ebx, ecx, edx);\n \n   /* Run MPX test only if host has MPX support.  */\n-  if (ebx & bit_MPX)\n+  if ((ebx & bit_MPX) && (xgetbv (0) & XSTATE_BNDREGS))\n     mpx_test (argc, argv);\n   else\n     {"}]}