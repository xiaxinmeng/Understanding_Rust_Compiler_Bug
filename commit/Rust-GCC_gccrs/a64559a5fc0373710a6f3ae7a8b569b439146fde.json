{"sha": "a64559a5fc0373710a6f3ae7a8b569b439146fde", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTY0NTU5YTVmYzAzNzM3MTBhNmYzYWU3YThiNTY5YjQzOTE0NmZkZQ==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2017-07-17T16:52:31Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2017-07-17T16:52:31Z"}, "message": "class.c (maybe_warn_about_overly_private_class): Ignore public copy ctors.\n\n\t* class.c (maybe_warn_about_overly_private_class): Ignore public\n\tcopy ctors.\n\n\t* g++.dg/warn/ctor-dtor-privacy-3.C: New.\n\nFrom-SVN: r250281", "tree": {"sha": "f2f6029ec1f6a6fa4444abe933f6e90714369116", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f2f6029ec1f6a6fa4444abe933f6e90714369116"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a64559a5fc0373710a6f3ae7a8b569b439146fde", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a64559a5fc0373710a6f3ae7a8b569b439146fde", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a64559a5fc0373710a6f3ae7a8b569b439146fde", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a64559a5fc0373710a6f3ae7a8b569b439146fde/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "619018d4b9c3458e2d4aadfa42d30f5cd429f155", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/619018d4b9c3458e2d4aadfa42d30f5cd429f155", "html_url": "https://github.com/Rust-GCC/gccrs/commit/619018d4b9c3458e2d4aadfa42d30f5cd429f155"}], "stats": {"total": 51, "additions": 42, "deletions": 9}, "files": [{"sha": "fef4c21871d8e39548684d4f50f4141167eae97b", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=a64559a5fc0373710a6f3ae7a8b569b439146fde", "patch": "@@ -1,5 +1,8 @@\n 2017-07-17  Nathan Sidwell  <nathan@acm.org>\n \n+\t* class.c (maybe_warn_about_overly_private_class): Ignore public\n+\tcopy ctors.\n+\n \t* class.c (type_has_user_declared_move_constructor,\n \ttype_has_user_declared_move_assign): Combine into ...\n \t(classtype_has_user_move_assign_or_move_ctor_p): ... this new function."}, {"sha": "0336ae5f143622f908b52c147bdc739163b06d43", "filename": "gcc/cp/class.c", "status": "modified", "additions": 15, "deletions": 9, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=a64559a5fc0373710a6f3ae7a8b569b439146fde", "patch": "@@ -2240,10 +2240,10 @@ maybe_warn_about_overly_private_class (tree t)\n   /* Warn about classes that have private constructors and no friends.  */\n   if (TYPE_HAS_USER_CONSTRUCTOR (t)\n       /* Implicitly generated constructors are always public.  */\n-      && (!CLASSTYPE_LAZY_DEFAULT_CTOR (t)\n-\t  || !CLASSTYPE_LAZY_COPY_CTOR (t)))\n+      && !CLASSTYPE_LAZY_DEFAULT_CTOR (t))\n     {\n       bool nonprivate_ctor = false;\n+      tree copy_or_move = NULL_TREE;\n \n       /* If a non-template class does not define a copy\n \t constructor, one is defined for it, enabling it to avoid\n@@ -2260,20 +2260,26 @@ maybe_warn_about_overly_private_class (tree t)\n       else\n \tfor (ovl_iterator iter (CLASSTYPE_CONSTRUCTORS (t));\n \t     !nonprivate_ctor && iter; ++iter)\n-\t  /* Ideally, we wouldn't count copy constructors (or, in\n-\t     fact, any constructor that takes an argument of the class\n-\t     type as a parameter) because such things cannot be used\n-\t     to construct an instance of the class unless you already\n-\t     have one.  But, for now at least, we're more\n-\t     generous.  */\n-\t  if (! TREE_PRIVATE (*iter))\n+\t  if (TREE_PRIVATE (*iter))\n+\t    continue;\n+\t  else if (copy_fn_p (*iter) || move_fn_p (*iter))\n+\t    /* Ideally, we wouldn't count any constructor that takes\n+\t       an argument of the class type as a parameter, because\n+\t       such things cannot be used to construct an instance of\n+\t       the class unless you already have one.  */\n+\t    copy_or_move = *iter;\n+\t  else\n \t    nonprivate_ctor = true;\n \n       if (!nonprivate_ctor)\n \t{\n \t  warning (OPT_Wctor_dtor_privacy,\n \t\t   \"%q#T only defines private constructors and has no friends\",\n \t\t   t);\n+\t  if (copy_or_move)\n+\t    inform (DECL_SOURCE_LOCATION (copy_or_move),\n+\t\t    \"%q#D is public, but requires an existing %q#T object\",\n+\t\t    copy_or_move, t);\n \t  return;\n \t}\n     }"}, {"sha": "a0ca514315517b1015a4b1b5c81f90b3642d8da2", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a64559a5fc0373710a6f3ae7a8b569b439146fde", "patch": "@@ -1,3 +1,7 @@\n+2017-07-17  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* g++.dg/warn/ctor-dtor-privacy-3.C: New.\n+\n 2017-07-17  Bernd Edlinger  <bernd.edlinger@hotmail.de>\n \n \t* lib/gcc-dg.exp: Increase expect's match buffer size."}, {"sha": "93a42eac08dbf7e03167c95938447905864bce68", "filename": "gcc/testsuite/g++.dg/warn/ctor-dtor-privacy-3.C", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fctor-dtor-privacy-3.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a64559a5fc0373710a6f3ae7a8b569b439146fde/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fctor-dtor-privacy-3.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fctor-dtor-privacy-3.C?ref=a64559a5fc0373710a6f3ae7a8b569b439146fde", "patch": "@@ -0,0 +1,20 @@\n+// { dg-do compile { target c++11 } }\n+// { dg-additional-options \"-Wctor-dtor-privacy\" } \n+\n+class X // { dg-message \"only defines private\" }\n+{\n+public:\n+  X (X const &); // { dg-message \"requires an existing\" }\n+};\n+\n+class Y // { dg-message \"only defines private\" }\n+{\n+public:\n+  Y (Y &&);  // { dg-message \"requires an existing\" }\n+};\n+\n+class Z\n+{\n+public:\n+  Z (int);\n+};"}]}