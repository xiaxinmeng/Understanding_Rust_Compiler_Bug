{"sha": "6443c7c0e5e1b348ff5841463e3c3828b3036e30", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjQ0M2M3YzBlNWUxYjM0OGZmNTg0MTQ2M2UzYzM4MjhiMzAzNmUzMA==", "commit": {"author": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2017-03-09T16:36:37Z"}, "committer": {"name": "Marek Polacek", "email": "mpolacek@gcc.gnu.org", "date": "2017-03-09T16:36:37Z"}, "message": "re PR c++/79687 (Wrong code with pointer-to-member)\n\n\tPR c++/79687\n\t* init.c (constant_value_1): Break if the variable has a dynamic\n\tinitializer.\n\n\t* g++.dg/expr/ptrmem8.C: New test.\n\t* g++.dg/expr/ptrmem9.C: New test.\n\nFrom-SVN: r246008", "tree": {"sha": "22baa88c105d2a2309c26e858445dfc6186a00fd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/22baa88c105d2a2309c26e858445dfc6186a00fd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6443c7c0e5e1b348ff5841463e3c3828b3036e30", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6443c7c0e5e1b348ff5841463e3c3828b3036e30", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6443c7c0e5e1b348ff5841463e3c3828b3036e30", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6443c7c0e5e1b348ff5841463e3c3828b3036e30/comments", "author": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d721dc3c4bb4a29f6c2cee5be88710a1b107e2f2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d721dc3c4bb4a29f6c2cee5be88710a1b107e2f2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d721dc3c4bb4a29f6c2cee5be88710a1b107e2f2"}], "stats": {"total": 51, "additions": 51, "deletions": 0}, "files": [{"sha": "4f4691a0393a20155dade6c862070b44cff3e640", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=6443c7c0e5e1b348ff5841463e3c3828b3036e30", "patch": "@@ -4,6 +4,10 @@\n \t* tree.c (strip_typedefs): Skip the attribute handling if T is\n \ta variant type which hasn't been updated yet.\n \n+\tPR c++/79687 - wrong code with pointer-to-member\n+\t* init.c (constant_value_1): Break if the variable has a dynamic\n+\tinitializer.\n+\n 2017-03-08  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/79797 - ICE with self-reference in array DMI."}, {"sha": "18043e8c57fcbca42050301f3e73acf0df39a5b3", "filename": "gcc/cp/init.c", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Fcp%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Fcp%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.c?ref=6443c7c0e5e1b348ff5841463e3c3828b3036e30", "patch": "@@ -2203,6 +2203,13 @@ constant_value_1 (tree decl, bool strict_p, bool return_aggregate_cst_ok_p)\n       if (TREE_CODE (init) == CONSTRUCTOR\n \t  && !DECL_INITIALIZED_BY_CONSTANT_EXPRESSION_P (decl))\n \tbreak;\n+      /* If the variable has a dynamic initializer, don't use its\n+\t DECL_INITIAL which doesn't reflect the real value.  */\n+      if (VAR_P (decl)\n+\t  && TREE_STATIC (decl)\n+\t  && !DECL_INITIALIZED_BY_CONSTANT_EXPRESSION_P (decl)\n+\t  && DECL_NONTRIVIALLY_INITIALIZED_P (decl))\n+\tbreak;\n       decl = unshare_expr (init);\n     }\n   return decl;"}, {"sha": "cad76f21eed079e21a1a8eaf42f18e2c5890556e", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6443c7c0e5e1b348ff5841463e3c3828b3036e30", "patch": "@@ -1,3 +1,9 @@\n+2017-03-09  Marek Polacek  <polacek@redhat.com>\n+\n+\tPR c++/79687\n+\t* g++.dg/expr/ptrmem8.C: New test.\n+\t* g++.dg/expr/ptrmem9.C: New test.\n+\n 2017-03-09  Richard Biener  <rguenther@suse.de>\n \n \tPR tree-optimization/79977"}, {"sha": "c5a766aa5b53bd84ccc5108fb3b0d4c2060ae755", "filename": "gcc/testsuite/g++.dg/expr/ptrmem8.C", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fexpr%2Fptrmem8.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fexpr%2Fptrmem8.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fexpr%2Fptrmem8.C?ref=6443c7c0e5e1b348ff5841463e3c3828b3036e30", "patch": "@@ -0,0 +1,15 @@\n+// PR c++/79687\n+// { dg-do run }\n+\n+struct A\n+{\n+  char c;\n+};\n+\n+int main()\n+{\n+  char A::* p = &A::c;\n+  static char A::* const q = p;\n+  A a;\n+  return &(a.*q) - &a.c;\n+}"}, {"sha": "32ce777aeb8906c0c67ef9126a4528c8ea9aab79", "filename": "gcc/testsuite/g++.dg/expr/ptrmem9.C", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fexpr%2Fptrmem9.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6443c7c0e5e1b348ff5841463e3c3828b3036e30/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fexpr%2Fptrmem9.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fexpr%2Fptrmem9.C?ref=6443c7c0e5e1b348ff5841463e3c3828b3036e30", "patch": "@@ -0,0 +1,19 @@\n+// PR c++/79687\n+// { dg-do run }\n+\n+struct A\n+{\n+  char c;\n+};\n+\n+int main()\n+{\n+  static char A::* p1 = &A::c;\n+  char A::* const q1 = p1;\n+\n+  char A::* p2 = &A::c;\n+  static char A::* const q2 = p2;\n+\n+  A a;\n+  return (&(a.*q1) - &a.c) || (&(a.*q2) - &a.c);\n+}"}]}