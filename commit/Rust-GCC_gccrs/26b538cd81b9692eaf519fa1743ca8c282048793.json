{"sha": "26b538cd81b9692eaf519fa1743ca8c282048793", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjZiNTM4Y2Q4MWI5NjkyZWFmNTE5ZmExNzQzY2E4YzI4MjA0ODc5Mw==", "commit": {"author": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2020-07-03T08:57:39Z"}, "committer": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2020-07-03T08:57:39Z"}, "message": "nvptx: Fix ICE in nvptx_vector_alignment on gcc.dg/attr-vector_size.c\n\nThis patch addresses the ICE in gcc.dg/attr-vector_size.c during\nmake -k check on nvptx-none.  The actual ICE looks like:\n\ntestsuite/gcc.dg/attr-vector_size.c:29:1: internal compiler error: \\\n  in tree_to_shwi, at tree.c:7321\n0xf53bf2 tree_to_shwi(tree_node const*)\n../../gcc/gcc/tree.c:7321\n0xff1969 nvptx_vector_alignment\n../../gcc/gcc/config/nvptx/nvptx.c:5105^M\n\nThe problem is that the caller has ensured that TYPE_SIZE(type) is\nrepresentable as an unsigned HOST_WIDE_INT, but nvptx_vector_alignment is\naccessing it as a signed HOST_WIDE_INT which overflows in pathological\nconditions.  Amongst those pathological conditions is that a TYPE_SIZE of\nzero can sometimes reach this function, prior to an error being emitted.\nMaking sure the result is not less than the mode's alignment and not greater\nthan BIGGEST_ALIGNMENT fixes the ICEs, and generates the expected\ncompile-time error messages.\n\nTested on --target=nvptx-none, with a \"make\" and \"make check\" which results\nin four fewer unexpected failures and three more expected passes.\n\n2020-07-03  Roger Sayle  <roger@nextmovesoftware.com>\n\t    Tom de Vries  <tdevries@suse.de>\n\ngcc/ChangeLog:\n\n\tPR target/90932\n\t* config/nvptx/nvptx.c (nvptx_vector_alignment): Use tree_to_uhwi\n\tto access TYPE_SIZE (type).  Return at least the mode's alignment.", "tree": {"sha": "36a78c0e5b6c29c027d714873433b45aa1284ab3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/36a78c0e5b6c29c027d714873433b45aa1284ab3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/26b538cd81b9692eaf519fa1743ca8c282048793", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/26b538cd81b9692eaf519fa1743ca8c282048793", "html_url": "https://github.com/Rust-GCC/gccrs/commit/26b538cd81b9692eaf519fa1743ca8c282048793", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/26b538cd81b9692eaf519fa1743ca8c282048793/comments", "author": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a63e1915e9ef12fea06fc4676c3e5fce58f26e0a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a63e1915e9ef12fea06fc4676c3e5fce58f26e0a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a63e1915e9ef12fea06fc4676c3e5fce58f26e0a"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "d2f321fcbcc975ab91b557abea4192b80d9c935b", "filename": "gcc/config/nvptx/nvptx.c", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/26b538cd81b9692eaf519fa1743ca8c282048793/gcc%2Fconfig%2Fnvptx%2Fnvptx.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/26b538cd81b9692eaf519fa1743ca8c282048793/gcc%2Fconfig%2Fnvptx%2Fnvptx.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx.c?ref=26b538cd81b9692eaf519fa1743ca8c282048793", "patch": "@@ -5102,9 +5102,22 @@ static const struct attribute_spec nvptx_attribute_table[] =\n static HOST_WIDE_INT\n nvptx_vector_alignment (const_tree type)\n {\n-  HOST_WIDE_INT align = tree_to_shwi (TYPE_SIZE (type));\n+  unsigned HOST_WIDE_INT align;\n+  tree size = TYPE_SIZE (type);\n+\n+  /* Ensure align is not bigger than BIGGEST_ALIGNMENT.  */\n+  if (tree_fits_uhwi_p (size))\n+    {\n+      align = tree_to_uhwi (size);\n+      align = MIN (align, BIGGEST_ALIGNMENT);\n+    }\n+  else\n+    align = BIGGEST_ALIGNMENT;\n+\n+  /* Ensure align is not smaller than mode alignment.  */\n+  align = MAX (align, GET_MODE_ALIGNMENT (TYPE_MODE (type)));\n \n-  return MIN (align, BIGGEST_ALIGNMENT);\n+  return align;\n }\n \n /* Indicate that INSN cannot be duplicated.   */"}]}