{"sha": "56f71478487174d7bacbe51a9c35d23257db905e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTZmNzE0Nzg0ODcxNzRkN2JhY2JlNTFhOWMzNWQyMzI1N2RiOTA1ZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-02-09T14:01:44Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-02-09T14:01:44Z"}, "message": "re PR c/79431 (ICE in get, at cgraph.h:397)\n\n\tPR c/79431\n\t* gimplify.c (gimplify_adjust_omp_clauses): Ignore\n\t\"omp declare target link\" attribute unless is_global_var.\n\t* omp-offload.c (find_link_var_op): Likewise.\nc/\n\t* c-parser.c (c_parser_omp_declare_target): Don't invoke\n\tsymtab_node::get on automatic variables.\ncp/\n\t* parser.c (cp_parser_oacc_declare): Formatting fix.\n\t(cp_parser_omp_declare_target): Don't invoke symtab_node::get on\n\tautomatic variables.\ntestsuite/\n\t* c-c++-common/gomp/pr79431.c: New test.\n\nFrom-SVN: r245302", "tree": {"sha": "ba5ea5a312dcc3928e3e794b521fe4484cde12e0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ba5ea5a312dcc3928e3e794b521fe4484cde12e0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/56f71478487174d7bacbe51a9c35d23257db905e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/56f71478487174d7bacbe51a9c35d23257db905e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/56f71478487174d7bacbe51a9c35d23257db905e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/56f71478487174d7bacbe51a9c35d23257db905e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1bbe0d8f47f2007fcb70d69a0952347ece474ac7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1bbe0d8f47f2007fcb70d69a0952347ece474ac7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1bbe0d8f47f2007fcb70d69a0952347ece474ac7"}], "stats": {"total": 54, "additions": 48, "deletions": 6}, "files": [{"sha": "184e7d1b48ec33681140a6fc36e4bbce5b05e251", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -1,3 +1,10 @@\n+2017-02-09  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/79431\n+\t* gimplify.c (gimplify_adjust_omp_clauses): Ignore\n+\t\"omp declare target link\" attribute unless is_global_var.\n+\t* omp-offload.c (find_link_var_op): Likewise.\n+\n 2017-02-09  Nathan Sidwell  <nathan@codesourcery.com>\n \t    Chung-Lin Tang  <cltang@codesourcery.com>\n "}, {"sha": "98f7c4ce48986a88b22cebbd0bbeeb59289f350b", "filename": "gcc/c/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2FChangeLog?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -1,3 +1,9 @@\n+2017-02-09  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/79431\n+\t* c-parser.c (c_parser_omp_declare_target): Don't invoke\n+\tsymtab_node::get on automatic variables.\n+\n 2016-02-09  Nathan Sidwell  <nathan@codesourcery.com>\n \t    Chung-Lin Tang  <cltang@codesourcery.com>\n "}, {"sha": "8f4f569bd4a365d1b6a52ead22dad1f54769130d", "filename": "gcc/c/c-parser.c", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fc%2Fc-parser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fc%2Fc-parser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2Fc-parser.c?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -16849,8 +16849,11 @@ c_parser_omp_declare_target (c_parser *parser)\n \t}\n       if (!at1)\n \t{\n-\t  symtab_node *node = symtab_node::get (t);\n \t  DECL_ATTRIBUTES (t) = tree_cons (id, NULL_TREE, DECL_ATTRIBUTES (t));\n+\t  if (TREE_CODE (t) != FUNCTION_DECL && !is_global_var (t))\n+\t    continue;\n+\n+\t  symtab_node *node = symtab_node::get (t);\n \t  if (node != NULL)\n \t    {\n \t      node->offloadable = 1;"}, {"sha": "a71cca1d20bf8fc08c2467194f6d3762f82eaed5", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -1,3 +1,10 @@\n+2017-02-09  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/79431\n+\t* parser.c (cp_parser_oacc_declare): Formatting fix.\n+\t(cp_parser_omp_declare_target): Don't invoke symtab_node::get on\n+\tautomatic variables.\n+\n 2016-02-09  Nathan Sidwell  <nathan@codesourcery.com>\n \t    Chung-Lin Tang  <cltang@codesourcery.com>\n "}, {"sha": "b46ee7c9454947c9b66d8fbe4110fae1602d242c", "filename": "gcc/cp/parser.c", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fcp%2Fparser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fcp%2Fparser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fparser.c?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -36230,7 +36230,7 @@ cp_parser_oacc_declare (cp_parser *parser, cp_token *pragma_tok)\n \t    id = get_identifier (\"omp declare target\");\n \n \t  DECL_ATTRIBUTES (decl)\n-\t\t\t   = tree_cons (id, NULL_TREE, DECL_ATTRIBUTES (decl));\n+\t    = tree_cons (id, NULL_TREE, DECL_ATTRIBUTES (decl));\n \t  if (global_bindings_p ())\n \t    {\n \t      symtab_node *node = symtab_node::get (decl);\n@@ -36770,8 +36770,11 @@ cp_parser_omp_declare_target (cp_parser *parser, cp_token *pragma_tok)\n \t}\n       if (!at1)\n \t{\n-\t  symtab_node *node = symtab_node::get (t);\n \t  DECL_ATTRIBUTES (t) = tree_cons (id, NULL_TREE, DECL_ATTRIBUTES (t));\n+\t  if (TREE_CODE (t) != FUNCTION_DECL && !is_global_var (t))\n+\t    continue;\n+\n+\t  symtab_node *node = symtab_node::get (t);\n \t  if (node != NULL)\n \t    {\n \t      node->offloadable = 1;"}, {"sha": "1b9c8d23f1ac38fe8473e0e2240e1a342083ba08", "filename": "gcc/gimplify.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -8938,8 +8938,9 @@ gimplify_adjust_omp_clauses (gimple_seq *pre_p, gimple_seq body, tree *list_p,\n \t  if ((ctx->region_type & ORT_TARGET) != 0\n \t      && !(n->value & GOVD_SEEN)\n \t      && GOMP_MAP_ALWAYS_P (OMP_CLAUSE_MAP_KIND (c)) == 0\n-\t      && !lookup_attribute (\"omp declare target link\",\n-\t\t\t\t    DECL_ATTRIBUTES (decl)))\n+\t      && (!is_global_var (decl)\n+\t\t  || !lookup_attribute (\"omp declare target link\",\n+\t\t\t\t\tDECL_ATTRIBUTES (decl))))\n \t    {\n \t      remove = true;\n \t      /* For struct element mapping, if struct is never referenced"}, {"sha": "6fbe4ff753a173d55686941a15173a05b9e0efa8", "filename": "gcc/omp-offload.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fomp-offload.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Fomp-offload.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-offload.c?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -1819,7 +1819,9 @@ find_link_var_op (tree *tp, int *walk_subtrees, void *)\n {\n   tree t = *tp;\n \n-  if (VAR_P (t) && DECL_HAS_VALUE_EXPR_P (t)\n+  if (VAR_P (t)\n+      && DECL_HAS_VALUE_EXPR_P (t)\n+      && is_global_var (t)\n       && lookup_attribute (\"omp declare target link\", DECL_ATTRIBUTES (t)))\n     {\n       *walk_subtrees = 0;"}, {"sha": "18a7a08d2c82b2c005d8a6a68b62dff8fcf7c4f8", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -1,3 +1,8 @@\n+2017-02-09  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/79431\n+\t* c-c++-common/gomp/pr79431.c: New test.\n+\n 2017-02-09  Nathan Sidwell  <nathan@codesourcery.com>\n \t    Cesar Philippidis  <cesar@codesourcery.com>\n \t    Joseph Myers  <joseph@codesourcery.com>"}, {"sha": "62f7a059a749d622e3b4499ea261598ab64242af", "filename": "gcc/testsuite/c-c++-common/gomp/pr79431.c", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr79431.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56f71478487174d7bacbe51a9c35d23257db905e/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr79431.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr79431.c?ref=56f71478487174d7bacbe51a9c35d23257db905e", "patch": "@@ -0,0 +1,8 @@\n+/* PR c/79431 */\n+\n+void\n+foo (void)\n+{\n+  int a;\n+  #pragma omp declare target (a)\n+}"}]}