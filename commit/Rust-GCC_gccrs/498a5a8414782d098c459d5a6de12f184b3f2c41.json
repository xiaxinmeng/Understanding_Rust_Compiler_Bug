{"sha": "498a5a8414782d098c459d5a6de12f184b3f2c41", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDk4YTVhODQxNDc4MmQwOThjNDU5ZDVhNmRlMTJmMTg0YjNmMmM0MQ==", "commit": {"author": {"name": "Bob Duff", "email": "duff@adacore.com", "date": "2006-10-31T17:48:46Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2006-10-31T17:48:46Z"}, "message": "a-filico.adb (Finalize(List_Controller)): Mark the finalization list as finalization-started...\n\n2006-10-31  Bob Duff  <duff@adacore.com>\n\n\t* a-filico.adb (Finalize(List_Controller)): Mark the finalization list\n\tas finalization-started, so we can raise Program_Error on 'new'.\n\n\t* s-finimp.adb: Raise Program_Error on 'new' if finalization of the\n\tcollection has already started.\n\n\t* s-finimp.ads (Collection_Finalization_Started): Added new special\n\tflag value for indicating that a collection's finalization has started.\n\n\t* s-tassta.adb (Create_Task): Raise Program_Error on an attempt to\n\tcreate a task whose master has already waited for dependent tasks.\n\nFrom-SVN: r118241", "tree": {"sha": "37928a22f575da602c9aae71b599087c658ace97", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/37928a22f575da602c9aae71b599087c658ace97"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/498a5a8414782d098c459d5a6de12f184b3f2c41", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/498a5a8414782d098c459d5a6de12f184b3f2c41", "html_url": "https://github.com/Rust-GCC/gccrs/commit/498a5a8414782d098c459d5a6de12f184b3f2c41", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/498a5a8414782d098c459d5a6de12f184b3f2c41/comments", "author": {"login": "bobduff", "id": 29099567, "node_id": "MDQ6VXNlcjI5MDk5NTY3", "avatar_url": "https://avatars.githubusercontent.com/u/29099567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bobduff", "html_url": "https://github.com/bobduff", "followers_url": "https://api.github.com/users/bobduff/followers", "following_url": "https://api.github.com/users/bobduff/following{/other_user}", "gists_url": "https://api.github.com/users/bobduff/gists{/gist_id}", "starred_url": "https://api.github.com/users/bobduff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bobduff/subscriptions", "organizations_url": "https://api.github.com/users/bobduff/orgs", "repos_url": "https://api.github.com/users/bobduff/repos", "events_url": "https://api.github.com/users/bobduff/events{/privacy}", "received_events_url": "https://api.github.com/users/bobduff/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "18f2228492d64fae05e14707919e62b6a8f535b5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/18f2228492d64fae05e14707919e62b6a8f535b5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/18f2228492d64fae05e14707919e62b6a8f535b5"}], "stats": {"total": 53, "additions": 49, "deletions": 4}, "files": [{"sha": "c18f852500b32160836d49627e6a43f42818fe2d", "filename": "gcc/ada/a-filico.adb", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fa-filico.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fa-filico.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fa-filico.adb?ref=498a5a8414782d098c459d5a6de12f184b3f2c41", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                B o d y                                   --\n --                                                                          --\n---          Copyright (C) 1992-2004 Free Software Foundation, Inc.          --\n+--          Copyright (C) 1992-2006, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -46,6 +46,17 @@ package body Ada.Finalization.List_Controller is\n       Last_Ptr : constant SFR.Finalizable_Ptr := Object.Last'Unchecked_Access;\n \n    begin\n+      --  First take note of the fact that finalization of this collection has\n+      --  started.\n+\n+      Object.F := SFI.Collection_Finalization_Started;\n+\n+      --  Then finalize all the objects. Note that finalization can call\n+      --  Unchecked_Deallocation on other objects in the same collection,\n+      --  which will cause them to be removed from the list if we have not\n+      --  gotten to them yet. However, allocation in the collection will raise\n+      --  Program_Error, due to the above Collection_Finalization_Started.\n+\n       while Object.First.Next /= Last_Ptr loop\n          SFI.Finalize_One (Object.First.Next.all);\n       end loop;"}, {"sha": "518c998490038a9ebf921ee831e01ff178c0ab8c", "filename": "gcc/ada/s-finimp.adb", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fs-finimp.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fs-finimp.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-finimp.adb?ref=498a5a8414782d098c459d5a6de12f184b3f2c41", "patch": "@@ -34,7 +34,6 @@\n with Ada.Exceptions;\n with Ada.Tags;\n \n-with System.Storage_Elements;\n with System.Soft_Links;\n \n with Unchecked_Conversion;\n@@ -47,7 +46,6 @@ package body System.Finalization_Implementation is\n \n    package SSL renames System.Soft_Links;\n \n-   package SSE renames System.Storage_Elements;\n    use type SSE.Storage_Offset;\n \n    -----------------------\n@@ -183,6 +181,14 @@ package body System.Finalization_Implementation is\n \n       elsif Nb_Link = 2 then\n \n+         --  Raise Program_Error if we're trying to allocate an object in a\n+         --  collection whose finalization has already started.\n+\n+         if L = Collection_Finalization_Started then\n+            raise Program_Error with\n+              \"allocation after collection finalization started\";\n+         end if;\n+\n          Locked_Processing : begin\n             SSL.Lock_Task.all;\n             Obj.Next    := L.Next;"}, {"sha": "8366e956c99130a0e1a1a2ba6b426e1586506f6d", "filename": "gcc/ada/s-finimp.ads", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fs-finimp.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fs-finimp.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-finimp.ads?ref=498a5a8414782d098c459d5a6de12f184b3f2c41", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 1992-2005 Free Software Foundation, Inc.          --\n+--          Copyright (C) 1992-2006 Free Software Foundation, Inc.          --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -31,17 +31,36 @@\n --                                                                          --\n ------------------------------------------------------------------------------\n \n+with Ada.Unchecked_Conversion;\n+\n+with System.Storage_Elements;\n with System.Finalization_Root;\n \n package System.Finalization_Implementation is\n    pragma Elaborate_Body;\n \n+   package SSE renames System.Storage_Elements;\n    package SFR renames System.Finalization_Root;\n \n    ------------------------------------------------\n    -- Finalization Management Abstract Interface --\n    ------------------------------------------------\n \n+   function To_Finalizable_Ptr is new Ada.Unchecked_Conversion\n+     (Source => System.Address, Target => SFR.Finalizable_Ptr);\n+\n+   Collection_Finalization_Started : constant SFR.Finalizable_Ptr :=\n+                                       To_Finalizable_Ptr (SSE.To_Address (1));\n+   --  This is used to implement the rule in RM-4.8(10.2/2) that requires an\n+   --  allocator to raise Program_Error if the collection finalization has\n+   --  already started. See also Ada.Finalization.List_Controller. Finalize on\n+   --  List_Controller first sets the list to Collection_Finalization_Started,\n+   --  to indicate that finalization has started. An allocator will call\n+   --  Attach_To_Final_List, which checks for the special value and raises\n+   --  Program_Error if appropriate. The value of\n+   --  Collection_Finalization_Started must be different from 'Access of any\n+   --  finalizable object, and different from null. See AI-280.\n+\n    Global_Final_List : SFR.Finalizable_Ptr;\n    --  This list stores the controlled objects defined in library-level\n    --  packages. They will be finalized after the main program completion."}, {"sha": "e0a6c9463481798ae2477d53a71e1e0f8b727a0a", "filename": "gcc/ada/s-tassta.adb", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fs-tassta.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/498a5a8414782d098c459d5a6de12f184b3f2c41/gcc%2Fada%2Fs-tassta.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-tassta.adb?ref=498a5a8414782d098c459d5a6de12f184b3f2c41", "patch": "@@ -518,6 +518,15 @@ package body System.Tasking.Stages is\n       Len           : Natural;\n \n    begin\n+      --  If Master is greater than the current master, it means that Master\n+      --  has already awaited its dependent tasks. This raises Program_Error,\n+      --  by 4.8(10.3/2). See AI-280.\n+\n+      if Master > Self_ID.Master_Within then\n+         raise Program_Error with\n+           \"create task after awaiting termination\";\n+      end if;\n+\n       --  If pragma Detect_Blocking is active must be checked whether\n       --  this potentially blocking operation is called from a\n       --  protected action."}]}