{"sha": "67913890b257aff260c35b2f3bfc24d6547484ad", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njc5MTM4OTBiMjU3YWZmMjYwYzM1YjJmM2JmYzI0ZDY1NDc0ODRhZA==", "commit": {"author": {"name": "Tom Tromey", "email": "tromey@gcc.gnu.org", "date": "2006-04-04T14:06:20Z"}, "committer": {"name": "Tom Tromey", "email": "tromey@gcc.gnu.org", "date": "2006-04-04T14:06:20Z"}, "message": "[multiple changes]\n\n2006-04-04  Mark Wielaard  <mark@klomp.org>\n\n\t* lib/gen-classlist.sh.in: Use classes.tmp, not classes.2\n\tas temporary file name.\n\n2006-04-04  Tom Tromey  <tromey@redhat.com>\n\n\t* lib/split-for-gcj.sh: Updated for multi-field format.\n\t* lib/Makefile.am (CLEANFILES): Added classes.2.\n\t* lib/gen-classlist.sh.in (GCJ): Removed.  Create classes.1 and\n\tclasses.2 using multiple fields.\n\nFrom-SVN: r112664", "tree": {"sha": "50be06d9130dbc63382841c22d459fa680f8846d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/50be06d9130dbc63382841c22d459fa680f8846d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/67913890b257aff260c35b2f3bfc24d6547484ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/67913890b257aff260c35b2f3bfc24d6547484ad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/67913890b257aff260c35b2f3bfc24d6547484ad", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/67913890b257aff260c35b2f3bfc24d6547484ad/comments", "author": null, "committer": null, "parents": [{"sha": "687b17d43d7459423ed7389512ed2226917ac8e9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/687b17d43d7459423ed7389512ed2226917ac8e9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/687b17d43d7459423ed7389512ed2226917ac8e9"}], "stats": {"total": 116, "additions": 77, "deletions": 39}, "files": [{"sha": "691c3c536af4e41de15cfe0f5e3ccb491a6e67f8", "filename": "libjava/classpath/ChangeLog.gcj", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2FChangeLog.gcj", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2FChangeLog.gcj", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fclasspath%2FChangeLog.gcj?ref=67913890b257aff260c35b2f3bfc24d6547484ad", "patch": "@@ -1,3 +1,15 @@\n+2006-04-04  Mark Wielaard  <mark@klomp.org>\n+\n+\t* lib/gen-classlist.sh.in: Use classes.tmp, not classes.2\n+\tas temporary file name.\n+\n+2006-04-04  Tom Tromey  <tromey@redhat.com>\n+\n+\t* lib/split-for-gcj.sh: Updated for multi-field format.\n+\t* lib/Makefile.am (CLEANFILES): Added classes.2.\n+\t* lib/gen-classlist.sh.in (GCJ): Removed.  Create classes.1 and\n+\tclasses.2 using multiple fields.\n+\n 2006-03-29  Tom Tromey  <tromey@redhat.com>\n \n \tPR gcc/26901:"}, {"sha": "c9e00191eb708a67dcffd6e1672ab3360de7e705", "filename": "libjava/classpath/lib/Makefile.am", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2FMakefile.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2FMakefile.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fclasspath%2Flib%2FMakefile.am?ref=67913890b257aff260c35b2f3bfc24d6547484ad", "patch": "@@ -159,7 +159,7 @@ endif\n \n EXTRA_DIST = standard.omit mkcollections.pl.in Makefile.gcj split-for-gcj.sh\n CLEANFILES = compile-classes resources classes \\\n-\tglibj.zip classes.1 \\\n+\tglibj.zip classes.1 classes.2 \\\n \t$(top_builddir)/java/util/LocaleData.java \\\n \t$(JAVA_DEPEND)\n "}, {"sha": "de14acf55993b97c7b9e25d3b3ed537292956099", "filename": "libjava/classpath/lib/Makefile.in", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fclasspath%2Flib%2FMakefile.in?ref=67913890b257aff260c35b2f3bfc24d6547484ad", "patch": "@@ -42,9 +42,11 @@ DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \\\n \t$(srcdir)/copy-vmresources.sh.in $(srcdir)/gen-classlist.sh.in \\\n \t$(srcdir)/mkcollections.pl.in\n ACLOCAL_M4 = $(top_srcdir)/aclocal.m4\n-am__aclocal_m4_deps = $(top_srcdir)/../../libtool.m4 \\\n-\t$(top_srcdir)/m4/acattribute.m4 $(top_srcdir)/m4/accross.m4 \\\n-\t$(top_srcdir)/m4/acinclude.m4 \\\n+am__aclocal_m4_deps = $(top_srcdir)/../../config/depstand.m4 \\\n+\t$(top_srcdir)/../../config/lead-dot.m4 \\\n+\t$(top_srcdir)/../../config/no-executables.m4 \\\n+\t$(top_srcdir)/../../libtool.m4 $(top_srcdir)/m4/acattribute.m4 \\\n+\t$(top_srcdir)/m4/accross.m4 $(top_srcdir)/m4/acinclude.m4 \\\n \t$(top_srcdir)/m4/ax_create_stdint_h.m4 \\\n \t$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/lib-ld.m4 \\\n \t$(top_srcdir)/m4/lib-link.m4 $(top_srcdir)/m4/lib-prefix.m4 \\\n@@ -276,7 +278,7 @@ JAVAH = $(USER_JAVAH) -jni -classpath .:$(USER_CLASSLIB)\n @BUILD_CLASS_FILES_TRUE@noinst_DATA = genclasses compile-classes resources\n EXTRA_DIST = standard.omit mkcollections.pl.in Makefile.gcj split-for-gcj.sh\n CLEANFILES = compile-classes resources classes \\\n-\tglibj.zip classes.1 \\\n+\tglibj.zip classes.1 classes.2 \\\n \t$(top_builddir)/java/util/LocaleData.java \\\n \t$(JAVA_DEPEND)\n "}, {"sha": "4e57ceb8e2b3c6f9dc12476287426c4ecca4896c", "filename": "libjava/classpath/lib/gen-classlist.sh.in", "status": "modified", "additions": 43, "deletions": 21, "changes": 64, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2Fgen-classlist.sh.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2Fgen-classlist.sh.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fclasspath%2Flib%2Fgen-classlist.sh.in?ref=67913890b257aff260c35b2f3bfc24d6547484ad", "patch": "@@ -7,16 +7,34 @@\n LC_ALL=C; export LC_ALL\n LANG=C; export LANG\n \n-# We use this to decide whether we need to invoke the split script.\n-GCJ=\"@GCJ@\"\n-\n echo \"Adding java source files from srcdir '@top_srcdir@'.\"\n-@FIND@ @top_srcdir@/java @top_srcdir@/javax @top_srcdir@/gnu \\\n-       @top_srcdir@/org \\\n-       @top_srcdir@/external/w3c_dom @top_srcdir@/external/sax \\\n-       @top_srcdir@/external/relaxngDatatype \\\n-       -follow -type f -print | sort -r | grep '\\.java$' \\\n-       > ${top_builddir}/lib/classes.1\n+# We construct 'classes.1' as a series of lines.  Each line\n+# has three fields, which are separated by spaces.  The first\n+# field is the package of this class (separated by \"/\"s).\n+# The second field is the name of the top-level directory for\n+# this file, relative to the build directory.  E.g., it might\n+# look like \"../../classpath/vm/reference\".\n+# The third field is the file name, like \"java/lang/Object.java\".\n+# We do this because it makes splitting for the gcj build much\n+# cheaper.\n+(cd @top_srcdir@\n+ @FIND@ java javax gnu org -follow -name '*.java' -print |\n+ sort -r | sed -e 's,/\\([^/]*\\)$, \\1,' |\n+ while read pkg file; do\n+    echo $pkg @top_srcdir@ $pkg/$file\n+ done) > ${top_builddir}/lib/classes.1\n+\n+# The same, but for the external code.\n+# Right now all external code is in org/.\n+for dir in @top_srcdir@/external/w3c_dom \\\n+   @top_srcdir@/external/sax @top_srcdir@/external/relaxngDatatype; do\n+  (cd $dir\n+  @FIND@ org -follow -name '*.java' -print |\n+  sort -r | sed -e 's,/\\([^/]*\\)$, \\1,' |\n+  while read pkg file; do\n+     echo $pkg $dir $pkg/$file\n+  done)\n+done >> ${top_builddir}/lib/classes.1\n \n # Generate files for the VM classes.\n : > vm.omit\n@@ -29,18 +47,19 @@ for dir in $vm_dirlist; do\n       if test -d $subdir; then\n \t @FIND@ $subdir -name '*.java' -print\n       fi\n-   done) |\n-   while read f; do\n-      echo $dir/$f >> vm.add\n-      echo $f >> vm.omit\n+   done) | sed -e 's,/\\([^/]*\\)$, \\1,' |\n+   while read pkg file; do\n+      echo $pkg $dir $pkg/$file >> vm.add\n+      echo $pkg/$file >> vm.omit\n    done\n done\n \n # Only include generated files once.\n if test ! \"${top_builddir}\" -ef \"@top_srcdir@\"; then\n   echo \"Adding generated files in builddir '${top_builddir}'.\"\n-  @FIND@ ${top_builddir}/gnu ${top_builddir}/java -follow -type f -print \\\n-  | sort | grep '\\.java$' >> ${top_builddir}/lib/classes.1\n+  # Currently the only generated files are in gnu.*.\n+  @FIND@ ${top_builddir}/gnu -follow -name '*.java' -print \\\n+  | sort >> ${top_builddir}/lib/classes.1\n fi\n \n \n@@ -51,9 +70,10 @@ for dir in $vm_dirlist; do\n    fi\n done\n \n+# FIXME: could be more efficient by constructing a series of greps.\n for filexp in `cat tmp.omit`; do\n-   grep -v ${filexp} < ${top_builddir}/lib/classes.1 > ${top_builddir}/lib/classes.2\n-   mv ${top_builddir}/lib/classes.2 ${top_builddir}/lib/classes.1\n+   grep -v ${filexp} < ${top_builddir}/lib/classes.1 > ${top_builddir}/lib/classes.tmp\n+   mv ${top_builddir}/lib/classes.tmp ${top_builddir}/lib/classes.1\n done\n \n \n@@ -72,18 +92,20 @@ rm vm.add\n rm tmp.omit\n \n new=\n-if test -e ${top_builddir}/lib/classes; then\n-  p=`diff ${top_builddir}/lib/classes ${top_builddir}/lib/classes.1`\n+if test -e ${top_builddir}/lib/classes.2; then\n+  p=`diff ${top_builddir}/lib/classes.2 ${top_builddir}/lib/classes.1`\n   if test \"$p\" != \"\"; then\n     new=\"true\"\n-    cp ${top_builddir}/lib/classes.1 ${top_builddir}/lib/classes\n   fi\n else\n   new=\"true\"\n-  cp ${top_builddir}/lib/classes.1 ${top_builddir}/lib/classes\n fi\n \n if test \"$new\" = \"true\"; then\n+  cp ${top_builddir}/lib/classes.1 ${top_builddir}/lib/classes.2\n+  # Strip the package part.\n+  sed -e 's/^[^ ]* //' -e 's, ,/,' < ${top_builddir}/lib/classes.1 \\\n+     > ${top_builddir}/lib/classes\n   echo \"JAVA_SRCS = \\\\\" > ${top_builddir}/lib/java.dep\n   for i in `cat ${top_builddir}/lib/classes` ; do\n     echo $i \"\\\\\" >> ${top_builddir}/lib/java.dep"}, {"sha": "4130d56648a07a3e38610d26a28fd16b1103fefd", "filename": "libjava/classpath/lib/split-for-gcj.sh", "status": "modified", "additions": 15, "deletions": 13, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2Fsplit-for-gcj.sh", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/67913890b257aff260c35b2f3bfc24d6547484ad/libjava%2Fclasspath%2Flib%2Fsplit-for-gcj.sh", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fclasspath%2Flib%2Fsplit-for-gcj.sh?ref=67913890b257aff260c35b2f3bfc24d6547484ad", "patch": "@@ -22,22 +22,24 @@\n # java/awt/BitwiseXORComposite.class: lists/java-awt.stamp\n # lists/java-awt.list: /home/aph/gcc/gcc/libjava/classpath/gnu/java/awt/BitwiseXORComposite.java\n \n-# This uses a somewhat hacky procedure for finding the package of a\n-# given file.\n-\n echo \"Splitting for gcj\"\n rm -f Makefile.dtmp > /dev/null 2>&1\n test -d lists || mkdir lists\n-for dir in java javax gnu org; do\n-   fgrep /$dir/ classes | while read file; do\n-      pkg=`echo \"$file \" | sed -n -e \"s,^.*/\\($dir/.*\\)/[^/]*$,\\1,p\"`\n-      list=lists/`echo $pkg | sed -e 's,/,-,g' | cut -f1-3 -d-`\n-      echo \"$file\" >> ${list}.list.1\n-      f2=`echo \"$file\" | sed -n -e \"s,^.*/\\($dir/.*\\)$,\\1,p\"`\n-      f2=`echo \"$f2\" | sed -e 's/.java$//'`.class\n-      echo \"$f2: ${list}.stamp\" >> Makefile.dtmp\n-      echo \"${list}.list: $file\" >> Makefile.dtmp\n-   done\n+# Much more efficient to do processing outside the loop...\n+# The first expression computes the .class file name.\n+# We only want the first three package components, and\n+# we want them separated by '-'; this is the remaining expressions.\n+sed -e 's, \\(.*\\)[.]java$, \\1.java \\1.class,' \\\n+   -e 's,^\\([^/ ]*\\)/\\([^/ ]*\\) ,\\1-\\2 ,' \\\n+   -e 's,^\\([^/ ]*\\)/\\([^/ ]*\\)/\\([^/ ]*\\) ,\\1-\\2-\\3 ,' \\\n+   -e 's,^\\([^/ ]*\\)/\\([^/ ]*\\)/\\([^/ ]*\\)/[^ ]* ,\\1-\\2-\\3 ,' \\\n+   classes.2 |\n+while read pkg dir file f2; do\n+   list=lists/$pkg\n+   echo \"$dir/$file\" >> ${list}.list.1\n+\n+   echo \"$f2: ${list}.stamp\" >> Makefile.dtmp\n+   echo \"${list}.list: $dir/$file\" >> Makefile.dtmp\n done\n \n # Only update a .list file if it changed."}]}