{"sha": "bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmJhY2I5OThjOGYyNjVmYjZkNTE3MTZlYjcwN2M3M2IwN2Q5Y2NkZg==", "commit": {"author": {"name": "Paolo Carlini", "email": "pcarlini@unitus.it", "date": "2003-03-28T18:28:47Z"}, "committer": {"name": "Paolo Carlini", "email": "paolo@gcc.gnu.org", "date": "2003-03-28T18:28:47Z"}, "message": "re PR libstdc++/9533 (Can't read from tty with ifstream)\n\n2003-03-28  Paolo Carlini  <pcarlini@unitus.it>\n\t    Nathan Myers  <ncm@cantrip.org>\n\n\tPR libstdc++/9533\n\t* include/bits/fstream.tcc (basic_filebuf<>::open): Don't\n\tcall underflow().\n\t(basic_filebuf<>::showmanyc): Use the information provided\n\tby codecvt and __basic_file<>::showmanyc_helper to implement\n\ta non-trivial showmanyc.\n\t* config/io/basic_file_stdio.h\n\t(__basic_file<>::showmanyc_helper): New, declare.\n\t* config/io/basic_file_stdio.cc\n\t(__basic_file<>::showmanyc_helper): Define.\n\t(__basic_file<>::_M_open_mode): Don't set O_NONBLOCK.\n\t(__basic_file<char>::open): Don't call fcntl().\n\t* acinclude.m4 (GLIBCPP_CHECK_S_ISREG_OR_S_IFREG,\n\tGLIBCPP_CHECK_POLL): New macros.\n\t* configure.in: Call here.\n\t* acconfig.h: Add #undefs for the corresponding symbols.\n\t* aclocal.m4: Regenerate.\n\t* configure: Regenerate.\n\t* config.h.in: Regenerate.\n\nCo-Authored-By: Nathan Myers <ncm@cantrip.org>\n\nFrom-SVN: r64978", "tree": {"sha": "87d4905b8b4194c68ef7eadde4923aafabeee4eb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/87d4905b8b4194c68ef7eadde4923aafabeee4eb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/comments", "author": null, "committer": null, "parents": [{"sha": "d18ad19175a1a54aa79cdfad88c65019cbc0f4ae", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d18ad19175a1a54aa79cdfad88c65019cbc0f4ae", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d18ad19175a1a54aa79cdfad88c65019cbc0f4ae"}], "stats": {"total": 460, "additions": 394, "deletions": 66}, "files": [{"sha": "c038ba07ee90e55e894929f6be8724d41695b665", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -1,3 +1,26 @@\n+2003-03-28  Paolo Carlini  <pcarlini@unitus.it>\n+            Nathan Myers  <ncm@cantrip.org>\n+\n+\tPR libstdc++/9533\n+\t* include/bits/fstream.tcc (basic_filebuf<>::open): Don't\n+\tcall underflow().\n+\t(basic_filebuf<>::showmanyc): Use the information provided\n+\tby codecvt and __basic_file<>::showmanyc_helper to implement\n+\ta non-trivial showmanyc.\n+\t* config/io/basic_file_stdio.h\n+\t(__basic_file<>::showmanyc_helper): New, declare.\n+\t* config/io/basic_file_stdio.cc\n+\t(__basic_file<>::showmanyc_helper): Define.\n+\t(__basic_file<>::_M_open_mode): Don't set O_NONBLOCK.\n+\t(__basic_file<char>::open): Don't call fcntl().\n+\t* acinclude.m4 (GLIBCPP_CHECK_S_ISREG_OR_S_IFREG,\n+\tGLIBCPP_CHECK_POLL): New macros.\n+\t* configure.in: Call here.\n+\t* acconfig.h: Add #undefs for the corresponding symbols.\n+\t* aclocal.m4: Regenerate.\n+\t* configure: Regenerate.\n+\t* config.h.in: Regenerate.\n+\n 2003-03-24  Benjamin Kosnik  <bkoz@redhat.com>\n \n \t* config/linker-map.gnu: Remove string export restrictions."}, {"sha": "91af8fa31aeccfe7ba72b0162a37d73e480e7b7a", "filename": "libstdc++-v3/acconfig.h", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Facconfig.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Facconfig.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Facconfig.h?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -135,6 +135,15 @@\n // Define if the compiler/host combination has __builtin_sqrtl\n #undef HAVE___BUILTIN_SQRTL\n \n+// Define if poll is available in <poll.h>.\n+#undef HAVE_POLL\n+\n+// Define if S_ISREG (Posix) is available in <sys/stat.h>.\n+#undef HAVE_S_ISREG\n+\n+// Define if S_IFREG is available in <sys/stat.h>.\n+#undef HAVE_S_IFREG\n+\n // Define if LC_MESSAGES is available in <locale.h>.\n #undef HAVE_LC_MESSAGES\n "}, {"sha": "4f72efaf8cda452a924621f3536a0fa01402cac8", "filename": "libstdc++-v3/acinclude.m4", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Facinclude.m4", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Facinclude.m4", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Facinclude.m4?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -2106,6 +2106,45 @@ AC_DEFUN([AC_LIBTOOL_DLOPEN])\n AC_DEFUN([AC_PROG_LD])\n ])\n \n+dnl\n+dnl Check whether S_ISREG (Posix) or S_IFREG is available in <sys/stat.h>.\n+dnl\n+\n+AC_DEFUN(GLIBCPP_CHECK_S_ISREG_OR_S_IFREG, [\n+  AC_CACHE_VAL(glibcpp_cv_S_ISREG, [\n+    AC_TRY_LINK([#include <sys/stat.h>],\n+                [struct stat buffer; fstat(0, &buffer); S_ISREG(buffer.st_mode); ],\n+                [glibcpp_cv_S_ISREG=yes],\n+                [glibcpp_cv_S_ISREG=no])\n+  ])\n+  AC_CACHE_VAL(glibcpp_cv_S_IFREG, [\n+    AC_TRY_LINK([#include <sys/stat.h>],\n+                [struct stat buffer; fstat(0, &buffer); S_IFREG & buffer.st_mode; ],\n+                [glibcpp_cv_S_IFREG=yes],\n+                [glibcpp_cv_S_IFREG=no])\n+  ])\n+  if test x$glibcpp_cv_S_ISREG = xyes; then\n+    AC_DEFINE(HAVE_S_ISREG)\n+  elif test x$glibcpp_cv_S_IFREG = xyes; then\n+    AC_DEFINE(HAVE_S_IFREG)\n+  fi\n+])\n+\n+dnl\n+dnl Check whether poll is available in <poll.h>.\n+dnl\n+\n+AC_DEFUN(GLIBCPP_CHECK_POLL, [\n+  AC_CACHE_VAL(glibcpp_cv_POLL, [\n+    AC_TRY_COMPILE([#include <poll.h>],\n+                [struct pollfd pfd[1]; pfd[0].events = POLLIN; poll(pfd, 1, 0); ],\n+                [glibcpp_cv_POLL=yes],\n+                [glibcpp_cv_POLL=no])\n+  ])\n+  if test x$glibcpp_cv_POLL = xyes; then\n+    AC_DEFINE(HAVE_POLL)\n+  fi\n+])\n \n # Check whether LC_MESSAGES is available in <locale.h>.\n # Ulrich Drepper <drepper@cygnus.com>, 1995."}, {"sha": "167212ce6755d143e261090885feb157ad1a8133", "filename": "libstdc++-v3/aclocal.m4", "status": "modified", "additions": 44, "deletions": 1, "changes": 45, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Faclocal.m4", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Faclocal.m4", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Faclocal.m4?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -1932,7 +1932,11 @@ if test x\"$glibcpp_toolexecdir\" = x\"no\"; then\n     glibcpp_toolexecdir='$(libdir)/gcc-lib/$(target_alias)'\n     glibcpp_toolexeclibdir='$(libdir)'\n   fi\n-  glibcpp_toolexeclibdir=$glibcpp_toolexeclibdir/`$CC -print-multi-os-directory`\n+  multi_os_directory=`$CC -print-multi-os-directory`\n+  case $multi_os_directory in\n+  .) ;; # Avoid trailing /.\n+  *) glibcpp_toolexeclibdir=$glibcpp_toolexeclibdir/$multi_os_directory ;;\n+  esac\n fi\n \n AC_MSG_CHECKING([for install location])\n@@ -2114,6 +2118,45 @@ AC_DEFUN([AC_LIBTOOL_DLOPEN])\n AC_DEFUN([AC_PROG_LD])\n ])\n \n+dnl\n+dnl Check whether S_ISREG (Posix) or S_IFREG is available in <sys/stat.h>.\n+dnl\n+\n+AC_DEFUN(GLIBCPP_CHECK_S_ISREG_OR_S_IFREG, [\n+  AC_CACHE_VAL(glibcpp_cv_S_ISREG, [\n+    AC_TRY_LINK([#include <sys/stat.h>],\n+                [struct stat buffer; fstat(0, &buffer); S_ISREG(buffer.st_mode); ],\n+                [glibcpp_cv_S_ISREG=yes],\n+                [glibcpp_cv_S_ISREG=no])\n+  ])\n+  AC_CACHE_VAL(glibcpp_cv_S_IFREG, [\n+    AC_TRY_LINK([#include <sys/stat.h>],\n+                [struct stat buffer; fstat(0, &buffer); S_IFREG & buffer.st_mode; ],\n+                [glibcpp_cv_S_IFREG=yes],\n+                [glibcpp_cv_S_IFREG=no])\n+  ])\n+  if test x$glibcpp_cv_S_ISREG = xyes; then\n+    AC_DEFINE(HAVE_S_ISREG)\n+  elif test x$glibcpp_cv_S_IFREG = xyes; then\n+    AC_DEFINE(HAVE_S_IFREG)\n+  fi\n+])\n+\n+dnl\n+dnl Check whether poll is available in <poll.h>.\n+dnl\n+\n+AC_DEFUN(GLIBCPP_CHECK_POLL, [\n+  AC_CACHE_VAL(glibcpp_cv_POLL, [\n+    AC_TRY_COMPILE([#include <poll.h>],\n+                [struct pollfd pfd[1]; pfd[0].events = POLLIN; poll(pfd, 1, 0); ],\n+                [glibcpp_cv_POLL=yes],\n+                [glibcpp_cv_POLL=no])\n+  ])\n+  if test x$glibcpp_cv_POLL = xyes; then\n+    AC_DEFINE(HAVE_POLL)\n+  fi\n+])\n \n # Check whether LC_MESSAGES is available in <locale.h>.\n # Ulrich Drepper <drepper@cygnus.com>, 1995."}, {"sha": "f0b34c82a17a6f796468a5fbcbfe4b87c88bd61f", "filename": "libstdc++-v3/config.h.in", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfig.h.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfig.h.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfig.h.in?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -113,6 +113,15 @@\n // Define if the compiler/host combination has __builtin_sqrtl\n #undef HAVE___BUILTIN_SQRTL\n \n+// Define if poll is available in <poll.h>.\n+#undef HAVE_POLL\n+\n+// Define if S_ISREG (Posix) is available in <sys/stat.h>.\n+#undef HAVE_S_ISREG\n+\n+// Define if S_IFREG is available in <sys/stat.h>.\n+#undef HAVE_S_IFREG\n+\n // Define if LC_MESSAGES is available in <locale.h>.\n #undef HAVE_LC_MESSAGES\n \n@@ -740,6 +749,12 @@\n /* Define if you have the <string.h> header file.  */\n #undef HAVE_STRING_H\n \n+/* Define if you have the <sys/filio.h> header file.  */\n+#undef HAVE_SYS_FILIO_H\n+\n+/* Define if you have the <sys/ioctl.h> header file.  */\n+#undef HAVE_SYS_IOCTL_H\n+\n /* Define if you have the <sys/isa_defs.h> header file.  */\n #undef HAVE_SYS_ISA_DEFS_H\n "}, {"sha": "b2287b24f7f890e335b8a1809c781a97d5169f96", "filename": "libstdc++-v3/config/io/basic_file_stdio.cc", "status": "modified", "additions": 57, "deletions": 11, "changes": 68, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fbasic_file_stdio.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fbasic_file_stdio.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fbasic_file_stdio.cc?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -36,6 +36,29 @@\n #include <unistd.h>\n #include <errno.h>\n \n+#ifdef _GLIBCPP_HAVE_SYS_IOCTL_H\n+#define BSD_COMP /* Get FIONREAD on Solaris2. */\n+#include <sys/ioctl.h>\n+#endif\n+\n+// Pick up FIONREAD on Solaris 2.5.\n+#ifdef _GLIBCPP_HAVE_SYS_FILIO_H\n+#include <sys/filio.h>\n+#endif\n+\n+#ifdef _GLIBCPP_HAVE_POLL\n+#include <poll.h>\n+#endif\n+\n+#if defined(_GLIBCPP_HAVE_S_ISREG) || defined(_GLIBCPP_HAVE_S_IFREG)\n+# include <sys/stat.h>\n+# ifdef _GLIBCPP_HAVE_S_ISREG\n+#  define _GLIBCPP_ISREG(x) S_ISREG(x)\n+# else\n+#  define _GLIBCPP_ISREG(x) (((x) & S_IFMT) == S_IFREG)\n+# endif\n+#endif\n+\n namespace std \n {\n   // Definitions for __basic_file<char>.\n@@ -76,11 +99,7 @@ namespace std\n     if (__testi && !__testo && !__testt && !__testa)\n       {\n \tstrcpy(__c_mode, \"r\");\n-#if defined (O_NONBLOCK)\n-\t__p_mode |=  O_RDONLY | O_NONBLOCK;\n-#else\n \t__p_mode |=  O_RDONLY;\n-#endif\n       }\n     if (__testi && __testo && !__testt && !__testa)\n       {\n@@ -156,13 +175,6 @@ namespace std\n \tif ((_M_cfile = fopen(__name, __c_mode)))\n \t  {\n \t    _M_cfile_created = true;\n-\n-#if defined (F_SETFL) && defined (O_NONBLOCK)\n-\t    // Set input to nonblocking for fifos.\n-\t    if (__mode & ios_base::in)\n-\t      fcntl(this->fd(), F_SETFL, O_NONBLOCK);\n-#endif\n-\n \t    __ret = this;\n \t  }\n       }\n@@ -261,4 +273,38 @@ namespace std\n   int \n   __basic_file<char>::sync() \n   { return fflush(_M_cfile); }\n+\n+  streamsize\n+  __basic_file<char>::showmanyc_helper(bool __stdio)\n+  {\n+#ifdef FIONREAD\n+    // Pipes and sockets.    \n+    int __num = 0;\n+    int __r = ioctl(this->fd(), FIONREAD, &__num);\n+    if (!__r && __num >= 0)\n+      return __num; \n+#endif    \n+\n+#ifdef _GLIBCPP_HAVE_POLL\n+    // Cheap test.\n+    struct pollfd __pfd[1];\n+    __pfd[0].fd = this->fd();\n+    __pfd[0].events = POLLIN;\n+    if (poll(__pfd, 1, 0) <= 0)\n+      return 0;\n+#endif   \n+\n+#if defined(_GLIBCPP_HAVE_S_ISREG) || defined(_GLIBCPP_HAVE_S_IFREG)\n+    // Regular files.\n+    struct stat __buffer;\n+    int __ret = fstat(this->fd(), &__buffer);\n+    if (!__ret && _GLIBCPP_ISREG(__buffer.st_mode))\n+      if (__stdio)\n+\treturn __buffer.st_size - ftell(_M_cfile);\n+      else\n+\treturn __buffer.st_size - lseek(this->fd(), 0, ios_base::cur);\n+#endif\n+    return 0;\n+  }\n+\n }  // namespace std"}, {"sha": "b6a05697612a1fa1cac54a6e9bd171cc7be3a912", "filename": "libstdc++-v3/config/io/basic_file_stdio.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fbasic_file_stdio.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fbasic_file_stdio.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fbasic_file_stdio.h?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -108,6 +108,9 @@ namespace std\n \n       int \n       sync();\n+\n+      streamsize\n+      showmanyc_helper(bool __stdio);\n     };\n }  // namespace std\n "}, {"sha": "c4722cfadb6592d099687a7a3a189cdd9f44883c", "filename": "libstdc++-v3/configure", "status": "modified", "additions": 185, "deletions": 46, "changes": 231, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfigure", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfigure", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfigure?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -22739,20 +22739,159 @@ done\n \n   CXXFLAGS=\"$ac_save_CXXFLAGS\"\n \n+\n+  # For showmanyc_helper().\n+  for ac_hdr in sys/ioctl.h sys/filio.h\n+do\n+ac_safe=`echo \"$ac_hdr\" | sed 'y%./+-%__p_%'`\n+echo $ac_n \"checking for $ac_hdr\"\"... $ac_c\" 1>&6\n+echo \"configure:22749: checking for $ac_hdr\" >&5\n+if eval \"test \\\"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\\\" = set\"; then\n+  echo $ac_n \"(cached) $ac_c\" 1>&6\n+else\n+  cat > conftest.$ac_ext <<EOF\n+#line 22754 \"configure\"\n+#include \"confdefs.h\"\n+#include <$ac_hdr>\n+EOF\n+ac_try=\"$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out\"\n+{ (eval echo configure:22759: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n+ac_err=`grep -v '^ *+' conftest.out | grep -v \"^conftest.${ac_ext}\\$\"`\n+if test -z \"$ac_err\"; then\n+  rm -rf conftest*\n+  eval \"ac_cv_header_$ac_safe=yes\"\n+else\n+  echo \"$ac_err\" >&5\n+  echo \"configure: failed program was:\" >&5\n+  cat conftest.$ac_ext >&5\n+  rm -rf conftest*\n+  eval \"ac_cv_header_$ac_safe=no\"\n+fi\n+rm -f conftest*\n+fi\n+if eval \"test \\\"`echo '$ac_cv_header_'$ac_safe`\\\" = yes\"; then\n+  echo \"$ac_t\"\"yes\" 1>&6\n+    ac_tr_hdr=HAVE_`echo $ac_hdr | sed 'y%abcdefghijklmnopqrstuvwxyz./-%ABCDEFGHIJKLMNOPQRSTUVWXYZ___%'`\n+  cat >> confdefs.h <<EOF\n+#define $ac_tr_hdr 1\n+EOF\n+ \n+else\n+  echo \"$ac_t\"\"no\" 1>&6\n+fi\n+done\n+\n+  \n+  if eval \"test \\\"`echo '$''{'glibcpp_cv_POLL'+set}'`\\\" = set\"; then\n+  echo $ac_n \"(cached) $ac_c\" 1>&6\n+else\n+  \n+    cat > conftest.$ac_ext <<EOF\n+#line 22791 \"configure\"\n+#include \"confdefs.h\"\n+#include <poll.h>\n+int main() {\n+struct pollfd pfd[1]; pfd[0].events = POLLIN; poll(pfd, 1, 0); \n+; return 0; }\n+EOF\n+if { (eval echo configure:22798: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+  rm -rf conftest*\n+  glibcpp_cv_POLL=yes\n+else\n+  echo \"configure: failed program was:\" >&5\n+  cat conftest.$ac_ext >&5\n+  rm -rf conftest*\n+  glibcpp_cv_POLL=no\n+fi\n+rm -f conftest*\n+  \n+fi\n+\n+  if test x$glibcpp_cv_POLL = xyes; then\n+    cat >> confdefs.h <<\\EOF\n+#define HAVE_POLL 1\n+EOF\n+\n+  fi\n+\n+  \n+  if eval \"test \\\"`echo '$''{'glibcpp_cv_S_ISREG'+set}'`\\\" = set\"; then\n+  echo $ac_n \"(cached) $ac_c\" 1>&6\n+else\n+  \n+    cat > conftest.$ac_ext <<EOF\n+#line 22824 \"configure\"\n+#include \"confdefs.h\"\n+#include <sys/stat.h>\n+int main() {\n+struct stat buffer; fstat(0, &buffer); S_ISREG(buffer.st_mode); \n+; return 0; }\n+EOF\n+if { (eval echo configure:22831: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+  rm -rf conftest*\n+  glibcpp_cv_S_ISREG=yes\n+else\n+  echo \"configure: failed program was:\" >&5\n+  cat conftest.$ac_ext >&5\n+  rm -rf conftest*\n+  glibcpp_cv_S_ISREG=no\n+fi\n+rm -f conftest*\n+  \n+fi\n+\n+  if eval \"test \\\"`echo '$''{'glibcpp_cv_S_IFREG'+set}'`\\\" = set\"; then\n+  echo $ac_n \"(cached) $ac_c\" 1>&6\n+else\n+  \n+    cat > conftest.$ac_ext <<EOF\n+#line 22849 \"configure\"\n+#include \"confdefs.h\"\n+#include <sys/stat.h>\n+int main() {\n+struct stat buffer; fstat(0, &buffer); S_IFREG & buffer.st_mode; \n+; return 0; }\n+EOF\n+if { (eval echo configure:22856: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+  rm -rf conftest*\n+  glibcpp_cv_S_IFREG=yes\n+else\n+  echo \"configure: failed program was:\" >&5\n+  cat conftest.$ac_ext >&5\n+  rm -rf conftest*\n+  glibcpp_cv_S_IFREG=no\n+fi\n+rm -f conftest*\n+  \n+fi\n+\n+  if test x$glibcpp_cv_S_ISREG = xyes; then\n+    cat >> confdefs.h <<\\EOF\n+#define HAVE_S_ISREG 1\n+EOF\n+\n+  elif test x$glibcpp_cv_S_IFREG = xyes; then\n+    cat >> confdefs.h <<\\EOF\n+#define HAVE_S_IFREG 1\n+EOF\n+\n+  fi\n+\n+\n   \n   ac_safe=`echo \"locale.h\" | sed 'y%./+-%__p_%'`\n echo $ac_n \"checking for locale.h\"\"... $ac_c\" 1>&6\n-echo \"configure:22746: checking for locale.h\" >&5\n+echo \"configure:22885: checking for locale.h\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 22751 \"configure\"\n+#line 22890 \"configure\"\n #include \"confdefs.h\"\n #include <locale.h>\n EOF\n ac_try=\"$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out\"\n-{ (eval echo configure:22756: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n+{ (eval echo configure:22895: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n ac_err=`grep -v '^ *+' conftest.out | grep -v \"^conftest.${ac_ext}\\$\"`\n if test -z \"$ac_err\"; then\n   rm -rf conftest*\n@@ -22770,19 +22909,19 @@ if eval \"test \\\"`echo '$ac_cv_header_'$ac_safe`\\\" = yes\"; then\n   echo \"$ac_t\"\"yes\" 1>&6\n   \n     echo $ac_n \"checking for LC_MESSAGES\"\"... $ac_c\" 1>&6\n-echo \"configure:22774: checking for LC_MESSAGES\" >&5\n+echo \"configure:22913: checking for LC_MESSAGES\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_val_LC_MESSAGES'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 22779 \"configure\"\n+#line 22918 \"configure\"\n #include \"confdefs.h\"\n #include <locale.h>\n int main() {\n return LC_MESSAGES\n ; return 0; }\n EOF\n-if { (eval echo configure:22786: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+if { (eval echo configure:22925: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n   rm -rf conftest*\n   ac_cv_val_LC_MESSAGES=yes\n else\n@@ -22809,7 +22948,7 @@ fi\n \n \n   cat > conftest.$ac_ext <<EOF\n-#line 22813 \"configure\"\n+#line 22952 \"configure\"\n #include \"confdefs.h\"\n \n   #include <setjmp.h>\n@@ -22818,7 +22957,7 @@ int main() {\n sigjmp_buf env; while (! sigsetjmp (env, 1)) siglongjmp (env, 1);\n ; return 0; }\n EOF\n-if { (eval echo configure:22822: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:22961: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   cat >> confdefs.h <<\\EOF\n #define HAVE_SIGSETJMP 1\n@@ -22835,17 +22974,17 @@ rm -f conftest*\n do\n ac_safe=`echo \"$ac_hdr\" | sed 'y%./+-%__p_%'`\n echo $ac_n \"checking for $ac_hdr\"\"... $ac_c\" 1>&6\n-echo \"configure:22839: checking for $ac_hdr\" >&5\n+echo \"configure:22978: checking for $ac_hdr\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 22844 \"configure\"\n+#line 22983 \"configure\"\n #include \"confdefs.h\"\n #include <$ac_hdr>\n EOF\n ac_try=\"$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out\"\n-{ (eval echo configure:22849: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n+{ (eval echo configure:22988: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n ac_err=`grep -v '^ *+' conftest.out | grep -v \"^conftest.${ac_ext}\\$\"`\n if test -z \"$ac_err\"; then\n   rm -rf conftest*\n@@ -22874,12 +23013,12 @@ done\n for ac_func in getpagesize\n do\n echo $ac_n \"checking for $ac_func\"\"... $ac_c\" 1>&6\n-echo \"configure:22878: checking for $ac_func\" >&5\n+echo \"configure:23017: checking for $ac_func\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_func_$ac_func'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 22883 \"configure\"\n+#line 23022 \"configure\"\n #include \"confdefs.h\"\n /* System header to define __stub macros and hopefully few prototypes,\n     which can conflict with char $ac_func(); below.  */\n@@ -22902,7 +23041,7 @@ $ac_func();\n \n ; return 0; }\n EOF\n-if { (eval echo configure:22906: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+if { (eval echo configure:23045: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n   rm -rf conftest*\n   eval \"ac_cv_func_$ac_func=yes\"\n else\n@@ -22927,15 +23066,15 @@ fi\n done\n \n echo $ac_n \"checking for working mmap\"\"... $ac_c\" 1>&6\n-echo \"configure:22931: checking for working mmap\" >&5\n+echo \"configure:23070: checking for working mmap\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_func_mmap_fixed_mapped'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   if test \"$cross_compiling\" = yes; then\n   ac_cv_func_mmap_fixed_mapped=no\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 22939 \"configure\"\n+#line 23078 \"configure\"\n #include \"confdefs.h\"\n \n /* Thanks to Mike Haertel and Jim Avera for this test.\n@@ -23075,7 +23214,7 @@ main()\n }\n \n EOF\n-if { (eval echo configure:23079: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null\n+if { (eval echo configure:23218: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null\n then\n   ac_cv_func_mmap_fixed_mapped=yes\n else\n@@ -23106,17 +23245,17 @@ fi\n do\n ac_safe=`echo \"$ac_hdr\" | sed 'y%./+-%__p_%'`\n echo $ac_n \"checking for $ac_hdr\"\"... $ac_c\" 1>&6\n-echo \"configure:23110: checking for $ac_hdr\" >&5\n+echo \"configure:23249: checking for $ac_hdr\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 23115 \"configure\"\n+#line 23254 \"configure\"\n #include \"confdefs.h\"\n #include <$ac_hdr>\n EOF\n ac_try=\"$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out\"\n-{ (eval echo configure:23120: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n+{ (eval echo configure:23259: \\\"$ac_try\\\") 1>&5; (eval $ac_try) 2>&5; }\n ac_err=`grep -v '^ *+' conftest.out | grep -v \"^conftest.${ac_ext}\\$\"`\n if test -z \"$ac_err\"; then\n   rm -rf conftest*\n@@ -23149,7 +23288,7 @@ done\n     # Can't do these in a loop, else the resulting syntax is wrong.\n     \n   cat > conftest.$ac_ext <<EOF\n-#line 23153 \"configure\"\n+#line 23292 \"configure\"\n #include \"confdefs.h\"\n #include <unistd.h>\n                   #include <sys/time.h>\n@@ -23159,7 +23298,7 @@ int main() {\n  int f = RLIMIT_DATA ; \n ; return 0; }\n EOF\n-if { (eval echo configure:23163: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:23302: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   glibcpp_mresult=1\n else\n@@ -23176,7 +23315,7 @@ EOF\n \n     \n   cat > conftest.$ac_ext <<EOF\n-#line 23180 \"configure\"\n+#line 23319 \"configure\"\n #include \"confdefs.h\"\n #include <unistd.h>\n                   #include <sys/time.h>\n@@ -23186,7 +23325,7 @@ int main() {\n  int f = RLIMIT_RSS ; \n ; return 0; }\n EOF\n-if { (eval echo configure:23190: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:23329: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   glibcpp_mresult=1\n else\n@@ -23203,7 +23342,7 @@ EOF\n \n     \n   cat > conftest.$ac_ext <<EOF\n-#line 23207 \"configure\"\n+#line 23346 \"configure\"\n #include \"confdefs.h\"\n #include <unistd.h>\n                   #include <sys/time.h>\n@@ -23213,7 +23352,7 @@ int main() {\n  int f = RLIMIT_VMEM ; \n ; return 0; }\n EOF\n-if { (eval echo configure:23217: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:23356: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   glibcpp_mresult=1\n else\n@@ -23230,7 +23369,7 @@ EOF\n \n     \n   cat > conftest.$ac_ext <<EOF\n-#line 23234 \"configure\"\n+#line 23373 \"configure\"\n #include \"confdefs.h\"\n #include <unistd.h>\n                   #include <sys/time.h>\n@@ -23240,7 +23379,7 @@ int main() {\n  int f = RLIMIT_AS ; \n ; return 0; }\n EOF\n-if { (eval echo configure:23244: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:23383: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   glibcpp_mresult=1\n else\n@@ -23262,7 +23401,7 @@ EOF\n else\n   \n       cat > conftest.$ac_ext <<EOF\n-#line 23266 \"configure\"\n+#line 23405 \"configure\"\n #include \"confdefs.h\"\n #include <unistd.h>\n                   #include <sys/time.h>\n@@ -23272,7 +23411,7 @@ int main() {\n  struct rlimit r; setrlimit(0, &r);\n ; return 0; }\n EOF\n-if { (eval echo configure:23276: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:23415: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   ac_setrlimit=yes\n else\n@@ -23288,7 +23427,7 @@ fi\n   fi\n \n   echo $ac_n \"checking for testsuite memory limit support\"\"... $ac_c\" 1>&6\n-echo \"configure:23292: checking for testsuite memory limit support\" >&5\n+echo \"configure:23431: checking for testsuite memory limit support\" >&5\n   if test $setrlimit_have_headers = yes && test $ac_setrlimit = yes; then\n     ac_mem_limits=yes\n     cat >> confdefs.h <<\\EOF\n@@ -23304,7 +23443,7 @@ EOF\n   # Look for setenv, so that extended locale tests can be performed.\n   \n   echo $ac_n \"checking for setenv declaration\"\"... $ac_c\" 1>&6\n-echo \"configure:23308: checking for setenv declaration\" >&5\n+echo \"configure:23447: checking for setenv declaration\" >&5\n   if test x${glibcpp_cv_func_setenv_use+set} != xset; then\n     if eval \"test \\\"`echo '$''{'glibcpp_cv_func_setenv_use'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n@@ -23319,14 +23458,14 @@ ac_link='${CXX-g++} -o conftest${ac_exeext} $CXXFLAGS $CPPFLAGS $LDFLAGS conftes\n cross_compiling=$ac_cv_prog_cxx_cross\n \n       cat > conftest.$ac_ext <<EOF\n-#line 23323 \"configure\"\n+#line 23462 \"configure\"\n #include \"confdefs.h\"\n #include <stdlib.h>\n int main() {\n  setenv(0, 0, 0);\n ; return 0; }\n EOF\n-if { (eval echo configure:23330: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n+if { (eval echo configure:23469: \\\"$ac_compile\\\") 1>&5; (eval $ac_compile) 2>&5; }; then\n   rm -rf conftest*\n   glibcpp_cv_func_setenv_use=yes\n else\n@@ -23352,12 +23491,12 @@ fi\n     for ac_func in setenv\n do\n echo $ac_n \"checking for $ac_func\"\"... $ac_c\" 1>&6\n-echo \"configure:23356: checking for $ac_func\" >&5\n+echo \"configure:23495: checking for $ac_func\" >&5\n if eval \"test \\\"`echo '$''{'ac_cv_func_$ac_func'+set}'`\\\" = set\"; then\n   echo $ac_n \"(cached) $ac_c\" 1>&6\n else\n   cat > conftest.$ac_ext <<EOF\n-#line 23361 \"configure\"\n+#line 23500 \"configure\"\n #include \"confdefs.h\"\n /* System header to define __stub macros and hopefully few prototypes,\n     which can conflict with char $ac_func(); below.  */\n@@ -23380,7 +23519,7 @@ $ac_func();\n \n ; return 0; }\n EOF\n-if { (eval echo configure:23384: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+if { (eval echo configure:23523: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n   rm -rf conftest*\n   eval \"ac_cv_func_$ac_func=yes\"\n else\n@@ -23457,18 +23596,18 @@ fi\n # Check to see if libgcc_s exists, indicating that shared libgcc is possible.\n if test $enable_symvers != no; then\n   echo $ac_n \"checking for shared libgcc\"\"... $ac_c\" 1>&6\n-echo \"configure:23461: checking for shared libgcc\" >&5\n+echo \"configure:23600: checking for shared libgcc\" >&5\n   ac_save_CFLAGS=\"$CFLAGS\"\n   CFLAGS=' -lgcc_s'\n   cat > conftest.$ac_ext <<EOF\n-#line 23465 \"configure\"\n+#line 23604 \"configure\"\n #include \"confdefs.h\"\n \n int main() {\n return 0\n ; return 0; }\n EOF\n-if { (eval echo configure:23472: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+if { (eval echo configure:23611: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n   rm -rf conftest*\n   glibcpp_shared_libgcc=yes\n else\n@@ -23503,14 +23642,14 @@ if test $enable_symvers = yes ; then\n       echo 'FOO { global: f[a-z]o; local: *; };' > conftest.map\n       \n       cat > conftest.$ac_ext <<EOF\n-#line 23507 \"configure\"\n+#line 23646 \"configure\"\n #include \"confdefs.h\"\n int foo;\n int main() {\n \n ; return 0; }\n EOF\n-if { (eval echo configure:23514: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n+if { (eval echo configure:23653: \\\"$ac_link\\\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then\n   rm -rf conftest*\n   enable_symvers=gnu\n else\n@@ -23556,7 +23695,7 @@ else\n   GLIBCPP_BUILD_VERSIONED_SHLIB_FALSE=\n fi\n echo $ac_n \"checking versioning on shared library symbols\"\"... $ac_c\" 1>&6\n-echo \"configure:23560: checking versioning on shared library symbols\" >&5\n+echo \"configure:23699: checking versioning on shared library symbols\" >&5\n echo \"$ac_t\"\"$enable_symvers\" 1>&6\n \n \n@@ -23643,7 +23782,7 @@ glibcpp_prefixdir=${prefix}\n \n # Process the option --with-gxx-include-dir=<path to include-files directory>\n echo $ac_n \"checking for --with-gxx-include-dir\"\"... $ac_c\" 1>&6\n-echo \"configure:23647: checking for --with-gxx-include-dir\" >&5\n+echo \"configure:23786: checking for --with-gxx-include-dir\" >&5\n # Check whether --with-gxx-include-dir or --without-gxx-include-dir was given.\n if test \"${with_gxx_include_dir+set}\" = set; then\n   withval=\"$with_gxx_include_dir\"\n@@ -23667,7 +23806,7 @@ echo \"$ac_t\"\"$gxx_include_dir\" 1>&6\n \n # Process the option \"--enable-version-specific-runtime-libs\"\n echo $ac_n \"checking for --enable-version-specific-runtime-libs\"\"... $ac_c\" 1>&6\n-echo \"configure:23671: checking for --enable-version-specific-runtime-libs\" >&5\n+echo \"configure:23810: checking for --enable-version-specific-runtime-libs\" >&5\n # Check whether --enable-version-specific-runtime-libs or --disable-version-specific-runtime-libs was given.\n if test \"${enable_version_specific_runtime_libs+set}\" = set; then\n   enableval=\"$enable_version_specific_runtime_libs\"\n@@ -23718,7 +23857,7 @@ if test x\"$glibcpp_toolexecdir\" = x\"no\"; then\n fi\n \n echo $ac_n \"checking for install location\"\"... $ac_c\" 1>&6\n-echo \"configure:23722: checking for install location\" >&5\n+echo \"configure:23861: checking for install location\" >&5\n echo \"$ac_t\"\"$gxx_include_dir\" 1>&6\n \n "}, {"sha": "b9da74a2c403836ba5edd529142c14a1162112ac", "filename": "libstdc++-v3/configure.in", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfigure.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Fconfigure.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfigure.in?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -411,6 +411,12 @@ else\n   GLIBCPP_CHECK_COMPLEX_MATH_SUPPORT\n   GLIBCPP_CHECK_WCHAR_T_SUPPORT\n   GLIBCPP_CHECK_STDLIB_SUPPORT\n+\n+  # For showmanyc_helper().\n+  AC_CHECK_HEADERS(sys/ioctl.h sys/filio.h)\n+  GLIBCPP_CHECK_POLL\n+  GLIBCPP_CHECK_S_ISREG_OR_S_IFREG\n+\n   AC_LC_MESSAGES\n \n   AC_TRY_COMPILE(["}, {"sha": "b5529de35ef3381800e9f5dd74d64436b367126e", "filename": "libstdc++-v3/include/bits/fstream.tcc", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Finclude%2Fbits%2Ffstream.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bbacb998c8f265fb6d51716eb707c73b07d9ccdf/libstdc%2B%2B-v3%2Finclude%2Fbits%2Ffstream.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Ffstream.tcc?ref=bbacb998c8f265fb6d51716eb707c73b07d9ccdf", "patch": "@@ -96,13 +96,6 @@ namespace std\n \t      // Setup initial position of buffer.\n \t      _M_set_indeterminate();\n \n-\t      // Set input buffer to something real.\n-\t      // NB: Must open in non-blocking way to do this, or must\n-\t      // set the initial position in a different manner than\n-\t      // using underflow.\n- \t      if (__mode & ios_base::in && _M_buf_allocated)\n- \t\tthis->underflow();\n-\n \t      if ((__mode & ios_base::ate)\n \t\t  && this->seekoff(0, ios_base::end, __mode) < 0)\n \t\t{\n@@ -164,9 +157,21 @@ namespace std\n     {\n       streamsize __ret = -1;\n       bool __testin = this->_M_mode & ios_base::in;\n+      const locale __loc = this->getloc();\n+      const __codecvt_type& __cvt = use_facet<__codecvt_type>(__loc);\n+      // Sync with stdio.\n+      bool __sync = this->_M_buf_size == 1;\n \n       if (__testin && this->is_open())\n-\t__ret = this->_M_in_end - this->_M_in_cur;\n+\t{\n+\t  __ret = this->_M_in_end - this->_M_in_cur;\n+\n+\t  // For a stateful encoding (-1) the pending sequence might be just\n+\t  // shift and unshift prefixes with no actual character.\n+\t  if (__cvt.encoding() >= 0)\n+\t    __ret += _M_file.showmanyc_helper(__sync) / __cvt.max_length();\n+\t}\n+\n       _M_last_overflowed = false;\t\n       return __ret;\n     }"}]}