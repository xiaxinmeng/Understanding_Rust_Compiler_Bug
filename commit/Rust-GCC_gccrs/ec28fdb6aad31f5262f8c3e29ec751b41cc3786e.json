{"sha": "ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "node_id": "C_kwDOANBUbNoAKGVjMjhmZGI2YWFkMzFmNTI2MmY4YzNlMjllYzc1MWI0MWNjMzc4NmU", "commit": {"author": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2022-09-27T14:24:59Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-02-21T11:36:36Z"}, "message": "gccrs: dump: Dump macro rules definition\n\ngcc/rust/ChangeLog:\n\n\t* ast/rust-ast-dump.cc (Dump::visit): Add missing visitors for macro definition dumping.\n\t(get_delimiters): New function.\n\t* ast/rust-ast-dump.h: Declare `get_delimiters` and add documentation.\n\t* ast/rust-macro.h: Add `get_token_tree` method.", "tree": {"sha": "53fd1e2a16344f0e2d28445ea9ac07fdc970f314", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/53fd1e2a16344f0e2d28445ea9ac07fdc970f314"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e535b7b3e385edbc4cb830328f11fa5492df5d77", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e535b7b3e385edbc4cb830328f11fa5492df5d77", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e535b7b3e385edbc4cb830328f11fa5492df5d77"}], "stats": {"total": 143, "additions": 131, "deletions": 12}, "files": [{"sha": "4817962f76781ac997b6162d126afcf7dc39f0f7", "filename": "gcc/rust/ast/rust-ast-dump.cc", "status": "modified", "additions": 118, "deletions": 8, "changes": 126, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/gcc%2Frust%2Fast%2Frust-ast-dump.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/gcc%2Frust%2Fast%2Frust-ast-dump.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-ast-dump.cc?ref=ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "patch": "@@ -175,11 +175,27 @@ Dump::format_struct_field (StructField &field)\n \n void\n Dump::visit (Token &tok)\n-{}\n+{\n+  stream << tok.as_string ();\n+}\n \n void\n Dump::visit (DelimTokenTree &delim_tok_tree)\n-{}\n+{\n+  auto tokens = delim_tok_tree.to_token_stream ();\n+\n+  indentation.increment ();\n+  stream << '\\n' << indentation;\n+\n+  for (const auto &tok : tokens)\n+    {\n+      stream << ' ';\n+      tok->accept_vis (*this);\n+    }\n+\n+  indentation.decrement ();\n+  stream << '\\n' << indentation;\n+}\n \n void\n Dump::visit (AttrInputMetaItemContainer &input)\n@@ -1308,22 +1324,116 @@ Dump::visit (ExternBlock &block)\n   stream << \"\\n\" << indentation << \"}\\n\";\n }\n \n-// rust-macro.h\n+static std::pair<char, char>\n+get_delimiters (DelimType delim)\n+{\n+  auto start_delim = '\\0';\n+  auto end_delim = '\\0';\n+\n+  switch (delim)\n+    {\n+    case PARENS:\n+      start_delim = '(';\n+      end_delim = ')';\n+      break;\n+    case SQUARE:\n+      start_delim = '[';\n+      end_delim = ']';\n+      break;\n+    case CURLY:\n+      start_delim = '{';\n+      end_delim = '}';\n+      break;\n+    }\n+\n+  return {start_delim, end_delim};\n+}\n+\n void\n Dump::visit (MacroMatchFragment &match)\n-{}\n+{\n+  stream << '$' << match.get_ident () << ':'\n+\t << match.get_frag_spec ().as_string ();\n+}\n \n void\n-Dump::visit (MacroMatchRepetition &match)\n-{}\n+Dump::visit (MacroMatchRepetition &repetition)\n+{\n+  stream << \"$(\";\n+\n+  for (auto &match : repetition.get_matches ())\n+    {\n+      match->accept_vis (*this);\n+      stream << ' ';\n+    }\n+\n+  auto op_char = '\\0';\n+  switch (repetition.get_op ())\n+    {\n+    case MacroMatchRepetition::ANY:\n+      op_char = '*';\n+      break;\n+    case MacroMatchRepetition::ONE_OR_MORE:\n+      op_char = '+';\n+      break;\n+    case MacroMatchRepetition::ZERO_OR_ONE:\n+      op_char = '?';\n+      break;\n+    case MacroMatchRepetition::NONE:\n+      break;\n+    }\n+\n+  stream << ')';\n+\n+  if (repetition.has_sep ())\n+    stream << repetition.get_sep ()->as_string ();\n+\n+  stream << op_char;\n+}\n \n void\n Dump::visit (MacroMatcher &matcher)\n-{}\n+{\n+  auto delimiters = get_delimiters (matcher.get_delim_type ());\n+\n+  stream << delimiters.first;\n+\n+  for (auto &match : matcher.get_matches ())\n+    {\n+      match->accept_vis (*this);\n+      stream << ' ';\n+    }\n+\n+  stream << delimiters.second;\n+}\n \n void\n Dump::visit (MacroRulesDefinition &rules_def)\n-{}\n+{\n+  for (auto &outer_attr : rules_def.get_outer_attrs ())\n+    emit_attrib (outer_attr);\n+\n+  stream << \"macro_rules! \" << rules_def.get_rule_name () << \" {\\n\";\n+\n+  indentation.increment ();\n+\n+  for (auto &rule : rules_def.get_rules ())\n+    {\n+      stream << indentation;\n+\n+      rule.get_matcher ().accept_vis (*this);\n+\n+      stream << \" => \";\n+\n+      rule.get_transcriber ().get_token_tree ().accept_vis (*this);\n+\n+      stream << \";\\n\";\n+    }\n+\n+  indentation.decrement ();\n+\n+  stream << \"}\\n\";\n+}\n \n void\n Dump::visit (MacroInvocation &macro_invoc)"}, {"sha": "9fe8ee954937b0c3ae5fb657763fb87c417ab6de", "filename": "gcc/rust/ast/rust-ast-dump.h", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/gcc%2Frust%2Fast%2Frust-ast-dump.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/gcc%2Frust%2Fast%2Frust-ast-dump.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-ast-dump.h?ref=ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "patch": "@@ -72,7 +72,9 @@ class Dump : public ASTVisitor\n   std::ostream &stream;\n   Indent indentation;\n \n-  // Format together common items of functions: Parameters, return type, block\n+  /**\n+   * Format together common items of functions: Parameters, return type, block\n+   */\n   void format_function_common (std::unique_ptr<Type> &return_type,\n \t\t\t       std::unique_ptr<BlockExpr> &block);\n \n@@ -97,13 +99,19 @@ class Dump : public ASTVisitor\n   std::ostream &emit_indented_string (const std::string &value,\n \t\t\t\t      const std::string &comment = \"\");\n \n-  // Emit formatted string for generic parameters.\n+  /**\n+   * Emit formatted string for generic parameters\n+   */\n   void emit_generic_params (std::vector<std::unique_ptr<GenericParam>> &params);\n \n-  // Format a single field of a tuple.\n+  /**\n+   * Format a single field of a tuple\n+   */\n   void format_tuple_field (TupleField &field);\n \n-  // Format a single field of a struct.\n+  /**\n+   * Format a single field of a struct\n+   */\n   void format_struct_field (StructField &field);\n \n   // rust-ast.h"}, {"sha": "798bc974fbb93c6962a14a7abd1cd29c25034d75", "filename": "gcc/rust/ast/rust-macro.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/gcc%2Frust%2Fast%2Frust-macro.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec28fdb6aad31f5262f8c3e29ec751b41cc3786e/gcc%2Frust%2Fast%2Frust-macro.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-macro.h?ref=ec28fdb6aad31f5262f8c3e29ec751b41cc3786e", "patch": "@@ -407,6 +407,7 @@ struct MacroTranscriber\n   Location get_locus () const { return locus; }\n \n   DelimTokenTree &get_token_tree () { return token_tree; }\n+  const DelimTokenTree &get_token_tree () const { return token_tree; }\n };\n \n // A macro rule? Matcher and transcriber pair?"}]}