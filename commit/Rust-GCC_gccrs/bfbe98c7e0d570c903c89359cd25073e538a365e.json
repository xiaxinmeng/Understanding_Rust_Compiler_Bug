{"sha": "bfbe98c7e0d570c903c89359cd25073e538a365e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmZiZTk4YzdlMGQ1NzBjOTAzYzg5MzU5Y2QyNTA3M2U1MzhhMzY1ZQ==", "commit": {"author": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2019-12-07T17:35:54Z"}, "committer": {"name": "Marek Polacek", "email": "mpolacek@gcc.gnu.org", "date": "2019-12-07T17:35:54Z"}, "message": "PR c++/91678 - wrong error with decltype and location wrapper.\n\nCompiling this testcase results in a bogus \"invalid cast\" error; this occurs\nsince the introduction of location wrappers in finish_id_expression.\n\nHere we are parsing the decltype expression via cp_parser_decltype_expr which\ncan lead to calling various fold_* and c-family routines.  They use\nnon_lvalue_loc, but that won't create a NON_LVALUE_EXPR wrapper around a location\nwrapper.\n\nSo before the location wrappers addition cp_parser_decltype_expr would return\nNON_LVALUE_EXPR <c>.  Now it returns VIEW_CONVERT_EXPR<float *>(c), but the\nSTRIP_ANY_LOCATION_WRAPPER immediately following it strips the location wrapper,\nand suddenly we don't know whether we have an lvalue anymore.  And that's sad\nbecause then decltype produces the wrong type, causing nonsense errors.\n\n\t* fold-const.c (maybe_lvalue_p): Handle VIEW_CONVERT_EXPR.\n\n\t* g++.dg/cpp0x/decltype73.C: New test.\n\nFrom-SVN: r279077", "tree": {"sha": "0ceaef0721dd5c5812bccb95688416b27a8f1adb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0ceaef0721dd5c5812bccb95688416b27a8f1adb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bfbe98c7e0d570c903c89359cd25073e538a365e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bfbe98c7e0d570c903c89359cd25073e538a365e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bfbe98c7e0d570c903c89359cd25073e538a365e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bfbe98c7e0d570c903c89359cd25073e538a365e/comments", "author": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "ea37206decb6b4df127e65af206c58e6fc3ae60a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ea37206decb6b4df127e65af206c58e6fc3ae60a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ea37206decb6b4df127e65af206c58e6fc3ae60a"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "0994815f4a1c454e2622d4417831f14df1210bd6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=bfbe98c7e0d570c903c89359cd25073e538a365e", "patch": "@@ -1,3 +1,8 @@\n+2019-12-07  Marek Polacek  <polacek@redhat.com>\n+\n+\tPR c++/91678 - wrong error with decltype and location wrapper.\n+\t* fold-const.c (maybe_lvalue_p): Handle VIEW_CONVERT_EXPR.\n+\n 2019-12-07  Eric Botcazou  <ebotcazou@adacore.com>\n \n \tPR middle-end/90840"}, {"sha": "8e9e299926a126eade0f9865c5e1d52764c7899b", "filename": "gcc/fold-const.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2Ffold-const.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2Ffold-const.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffold-const.c?ref=bfbe98c7e0d570c903c89359cd25073e538a365e", "patch": "@@ -2598,6 +2598,7 @@ maybe_lvalue_p (const_tree x)\n   case TARGET_EXPR:\n   case COND_EXPR:\n   case BIND_EXPR:\n+  case VIEW_CONVERT_EXPR:\n     break;\n \n   default:"}, {"sha": "2d14412c7a75a88887af043cc9fdd0b003c7d1d4", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=bfbe98c7e0d570c903c89359cd25073e538a365e", "patch": "@@ -1,3 +1,8 @@\n+2019-12-07  Marek Polacek  <polacek@redhat.com>\n+\n+\tPR c++/91678 - wrong error with decltype and location wrapper.\n+\t* g++.dg/cpp0x/decltype73.C: New test.\n+\n 2019-12-07  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/92831"}, {"sha": "cbe94a898e34771d9548a3d512f9f7ee0871368d", "filename": "gcc/testsuite/g++.dg/cpp0x/decltype73.C", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdecltype73.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfbe98c7e0d570c903c89359cd25073e538a365e/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdecltype73.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdecltype73.C?ref=bfbe98c7e0d570c903c89359cd25073e538a365e", "patch": "@@ -0,0 +1,4 @@\n+// PR c++/91678 - wrong error with decltype and location wrapper.\n+// { dg-do compile { target c++11 } }\n+\n+float* test(float* c) { return (decltype(c + 0))(float*)c; }"}]}