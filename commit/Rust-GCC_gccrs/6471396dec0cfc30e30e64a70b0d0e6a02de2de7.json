{"sha": "6471396dec0cfc30e30e64a70b0d0e6a02de2de7", "node_id": "C_kwDOANBUbNoAKDY0NzEzOTZkZWMwY2ZjMzBlMzBlNjRhNzBiMGQwZTZhMDJkZTJkZTc", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2021-11-13T23:48:32Z"}, "committer": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2021-11-13T23:48:32Z"}, "message": "Fix bug in ipa-pure-const and add debug counters\n\ngcc/ChangeLog:\n\n\tPR lto/103211\n\t* dbgcnt.def (ipa_attr): New counters.\n\t* ipa-pure-const.c: Include dbgcnt.c\n\t(ipa_make_function_const): Use debug counter.\n\t(ipa_make_function_pure): Likewise.\n\t(propagate_pure_const): Fix bug in my previous change.", "tree": {"sha": "15c02f61efe82810881574e39856a0b6c5274fc8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/15c02f61efe82810881574e39856a0b6c5274fc8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6471396dec0cfc30e30e64a70b0d0e6a02de2de7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6471396dec0cfc30e30e64a70b0d0e6a02de2de7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6471396dec0cfc30e30e64a70b0d0e6a02de2de7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6471396dec0cfc30e30e64a70b0d0e6a02de2de7/comments", "author": null, "committer": null, "parents": [{"sha": "e30bf330443da67fe56bea021b9d70c0f76deedb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e30bf330443da67fe56bea021b9d70c0f76deedb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e30bf330443da67fe56bea021b9d70c0f76deedb"}], "stats": {"total": 14, "additions": 10, "deletions": 4}, "files": [{"sha": "f8a15f3d1d14aa33bf7189d4239d82d0225e16b5", "filename": "gcc/dbgcnt.def", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6471396dec0cfc30e30e64a70b0d0e6a02de2de7/gcc%2Fdbgcnt.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6471396dec0cfc30e30e64a70b0d0e6a02de2de7/gcc%2Fdbgcnt.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdbgcnt.def?ref=6471396dec0cfc30e30e64a70b0d0e6a02de2de7", "patch": "@@ -175,6 +175,7 @@ DEBUG_COUNTER (if_after_reload)\n DEBUG_COUNTER (if_conversion)\n DEBUG_COUNTER (if_conversion_tree)\n DEBUG_COUNTER (if_to_switch)\n+DEBUG_COUNTER (ipa_attr)\n DEBUG_COUNTER (ipa_cp_bits)\n DEBUG_COUNTER (ipa_cp_values)\n DEBUG_COUNTER (ipa_cp_vr)"}, {"sha": "a332940b55ded7a58a386d513cf7c6660e3e751c", "filename": "gcc/ipa-pure-const.c", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6471396dec0cfc30e30e64a70b0d0e6a02de2de7/gcc%2Fipa-pure-const.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6471396dec0cfc30e30e64a70b0d0e6a02de2de7/gcc%2Fipa-pure-const.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-pure-const.c?ref=6471396dec0cfc30e30e64a70b0d0e6a02de2de7", "patch": "@@ -62,6 +62,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"ipa-prop.h\"\n #include \"ipa-fnsummary.h\"\n #include \"symtab-thunks.h\"\n+#include \"dbgcnt.h\"\n \n /* Lattice values for const and pure functions.  Everything starts out\n    being const, then may drop to pure and then neither depending on\n@@ -1476,8 +1477,10 @@ ipa_make_function_const (struct cgraph_node *node, bool looping, bool local)\n     fprintf (dump_file, \"Function found to be %sconst: %s\\n\",\n \t     looping ? \"looping \" : \"\",\n \t     node->dump_name ());\n-  if (!local)\n+  if (!local && !looping)\n     cdtor = node->call_for_symbol_and_aliases (cdtor_p, NULL, true);\n+  if (!dbg_cnt (ipa_attr))\n+    return false;\n   if (node->set_const_flag (true, looping))\n     {\n       if (dump_file)\n@@ -1511,8 +1514,10 @@ ipa_make_function_pure (struct cgraph_node *node, bool looping, bool local)\n     fprintf (dump_file, \"Function found to be %spure: %s\\n\",\n \t     looping ? \"looping \" : \"\",\n \t     node->dump_name ());\n-  if (!local)\n+  if (!local && !looping)\n     cdtor = node->call_for_symbol_and_aliases (cdtor_p, NULL, true);\n+  if (!dbg_cnt (ipa_attr))\n+    return false;\n   if (node->set_pure_flag (true, looping))\n     {\n       if (dump_file)\n@@ -1797,11 +1802,11 @@ propagate_pure_const (void)\n \t    switch (this_state)\n \t      {\n \t      case IPA_CONST:\n-\t\tremove_p |= ipa_make_function_const (node, this_looping, false);\n+\t\tremove_p |= ipa_make_function_const (w, this_looping, false);\n \t\tbreak;\n \n \t      case IPA_PURE:\n-\t\tremove_p |= ipa_make_function_pure (node, this_looping, false);\n+\t\tremove_p |= ipa_make_function_pure (w, this_looping, false);\n \t\tbreak;\n \n \t      default:"}]}