{"sha": "5d4e573b28a74218ea9db6b00f50f5e323899e6d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWQ0ZTU3M2IyOGE3NDIxOGVhOWRiNmIwMGY1MGY1ZTMyMzg5OWU2ZA==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2017-08-29T19:51:30Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2017-08-29T19:51:30Z"}, "message": "PR c++/80935 - wrong C++17 error with lambda\n\n\t* decl.c (check_for_uninitialized_const_var): Check\n\tis_instantiation_of_constexpr.\n\t* constexpr.c (ensure_literal_type_for_constexpr_object): Check\n\tis_instantiation_of_constexpr.\n\t(potential_constant_expression_1): Check var_in_maybe_constexpr_fn.\n\nFrom-SVN: r251429", "tree": {"sha": "8d60fba745a9b87bc0bf687a4dca57ccb6d2fd9a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8d60fba745a9b87bc0bf687a4dca57ccb6d2fd9a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5d4e573b28a74218ea9db6b00f50f5e323899e6d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5d4e573b28a74218ea9db6b00f50f5e323899e6d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5d4e573b28a74218ea9db6b00f50f5e323899e6d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5d4e573b28a74218ea9db6b00f50f5e323899e6d/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "11399477539ec605bd904543163c9e9137395943", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/11399477539ec605bd904543163c9e9137395943", "html_url": "https://github.com/Rust-GCC/gccrs/commit/11399477539ec605bd904543163c9e9137395943"}], "stats": {"total": 37, "additions": 31, "deletions": 6}, "files": [{"sha": "4d6df428efd4ca23db5fe5c3a4df70263bb27f29", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=5d4e573b28a74218ea9db6b00f50f5e323899e6d", "patch": "@@ -1,3 +1,12 @@\n+2017-08-28  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/80935 - wrong C++17 error with lambda\n+\t* decl.c (check_for_uninitialized_const_var): Check\n+\tis_instantiation_of_constexpr.\n+\t* constexpr.c (ensure_literal_type_for_constexpr_object): Check\n+\tis_instantiation_of_constexpr.\n+\t(potential_constant_expression_1): Check var_in_maybe_constexpr_fn.\n+\n 2017-08-23  Jason Merrill  <jason@redhat.com>\n \n \t* lambda.c (build_lambda_object): Check for error_mark_node."}, {"sha": "f3e868cff022b7599feee833ddccf32909108d92", "filename": "gcc/cp/constexpr.c", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Fcp%2Fconstexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Fcp%2Fconstexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fconstexpr.c?ref=5d4e573b28a74218ea9db6b00f50f5e323899e6d", "patch": "@@ -100,7 +100,7 @@ ensure_literal_type_for_constexpr_object (tree decl)\n \t    }\n \t  else\n \t    {\n-\t      if (!DECL_TEMPLATE_INSTANTIATION (current_function_decl))\n+\t      if (!is_instantiation_of_constexpr (current_function_decl))\n \t\t{\n \t\t  error (\"variable %qD of non-literal type %qT in %<constexpr%> \"\n \t\t\t \"function\", decl, type);\n@@ -5335,8 +5335,7 @@ potential_constant_expression_1 (tree t, bool want_rval, bool strict, bool now,\n         STRIP_NOPS (x);\n         if (is_this_parameter (x) && !is_capture_proxy (x))\n \t  {\n-\t    if (DECL_CONTEXT (x)\n-\t\t&& !DECL_DECLARED_CONSTEXPR_P (DECL_CONTEXT (x)))\n+\t    if (!var_in_maybe_constexpr_fn (x))\n \t      {\n \t\tif (flags & tf_error)\n \t\t  error_at (loc, \"use of %<this%> in a constant expression\");"}, {"sha": "23829b0f18e2968cb9089d7e1fba0202ed71db43", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=5d4e573b28a74218ea9db6b00f50f5e323899e6d", "patch": "@@ -5525,9 +5525,10 @@ check_for_uninitialized_const_var (tree decl)\n \t\t   \"uninitialized const %qD\", decl);\n       else\n \t{\n-\t  error_at (DECL_SOURCE_LOCATION (decl),\n-\t\t    \"uninitialized variable %qD in %<constexpr%> function\",\n-\t\t    decl);\n+\t  if (!is_instantiation_of_constexpr (current_function_decl))\n+\t    error_at (DECL_SOURCE_LOCATION (decl),\n+\t\t      \"uninitialized variable %qD in %<constexpr%> function\",\n+\t\t      decl);\n \t  cp_function_chain->invalid_constexpr = true;\n \t}\n "}, {"sha": "ad5d885427cb8767f531e267e6b4e0399f0b3d82", "filename": "gcc/testsuite/g++.dg/cpp1z/constexpr-lambda16.C", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1z%2Fconstexpr-lambda16.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5d4e573b28a74218ea9db6b00f50f5e323899e6d/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1z%2Fconstexpr-lambda16.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1z%2Fconstexpr-lambda16.C?ref=5d4e573b28a74218ea9db6b00f50f5e323899e6d", "patch": "@@ -0,0 +1,16 @@\n+// PR c++/80642\n+// { dg-do compile { target c++14 } }\n+\n+int main()\n+{\n+  [](auto i)\n+    {\n+      if (i)\n+        {\n+\t  int j;\n+\t  static int k;\n+\t  return i + j;\n+        }\n+      return i;\n+    }(0);\n+}"}]}