{"sha": "e4cdb24c468b8a848980f7138767fbe093471c5b", "node_id": "C_kwDOANBUbNoAKGU0Y2RiMjRjNDY4YjhhODQ4OTgwZjcxMzg3NjdmYmUwOTM0NzFjNWI", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-07-17T19:52:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-17T19:52:16Z"}, "message": "Merge #1391\n\n1391: Fix ICE on duplicate compilation of ExternBlock items r=philberty a=philberty\n\nWhen we declare an extern block after where it is used the query\r\ncompilation system in the backend code-gen pass will resolve this and\r\ncompile as required. But when the iteration of the crate as part of the\r\npipeline we end up compiling this function again. The check we used to stop\r\nthis was copy paste from the other function items but in this case the\r\ncheck for function_completed is not valid as this is a prototype for an\r\nextern item so we dont add this to the translation unit as an fndecl which\r\nmeant we hit the ICE where we compile and add it again.\r\n\r\nFixes #1323\r\n\n\nCo-authored-by: Philip Herron <philip.herron@embecosm.com>", "tree": {"sha": "0fb6789a85aa49e4044679b8a6b10d26e953dc25", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0fb6789a85aa49e4044679b8a6b10d26e953dc25"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e4cdb24c468b8a848980f7138767fbe093471c5b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi1GhwCRBK7hj4Ov3rIwAAGQsIABwYotbF5obqWsysobsTo7m3\n476qKxLGoitcbVgbQoHuplzHQXLoNBV9FOeYT3a9WtMaDpWK4VGHPZrkrUjBsBXH\n9e0RYFFqQ3+wOx5BqKAO8lxTXt9loQSU7lwLrCTqy7HbZpOCok1lneCajyQ5X5Gv\n3iV77kagv6Uc47gkvNOhof1PIIbvZu5Urxu2KqnsUDSdprfhbyq++s2T3K8XOq+B\nePbx0amkWog/qAONdy8sD3rx5e0FIhO56dwGdAv4yhU0CeWSIcl7IEZTWWA2zCQi\nkDm8sR6881178gdnZRHbClvJZD8YZJRGtc7pmiOnrD9ZUpL6PMlg9YfSNzMsmMo=\n=cR/q\n-----END PGP SIGNATURE-----\n", "payload": "tree 0fb6789a85aa49e4044679b8a6b10d26e953dc25\nparent fd2bd659e44e5b7fea92bc34a4864f057f387490\nparent 9c7a580aa13707a18c53bc772c3d9301dd9bfb2c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1658087536 +0000\ncommitter GitHub <noreply@github.com> 1658087536 +0000\n\nMerge #1391\n\n1391: Fix ICE on duplicate compilation of ExternBlock items r=philberty a=philberty\n\nWhen we declare an extern block after where it is used the query\r\ncompilation system in the backend code-gen pass will resolve this and\r\ncompile as required. But when the iteration of the crate as part of the\r\npipeline we end up compiling this function again. The check we used to stop\r\nthis was copy paste from the other function items but in this case the\r\ncheck for function_completed is not valid as this is a prototype for an\r\nextern item so we dont add this to the translation unit as an fndecl which\r\nmeant we hit the ICE where we compile and add it again.\r\n\r\nFixes #1323\r\n\n\nCo-authored-by: Philip Herron <philip.herron@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e4cdb24c468b8a848980f7138767fbe093471c5b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e4cdb24c468b8a848980f7138767fbe093471c5b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e4cdb24c468b8a848980f7138767fbe093471c5b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fd2bd659e44e5b7fea92bc34a4864f057f387490", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd2bd659e44e5b7fea92bc34a4864f057f387490", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fd2bd659e44e5b7fea92bc34a4864f057f387490"}, {"sha": "9c7a580aa13707a18c53bc772c3d9301dd9bfb2c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9c7a580aa13707a18c53bc772c3d9301dd9bfb2c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9c7a580aa13707a18c53bc772c3d9301dd9bfb2c"}], "stats": {"total": 54, "additions": 46, "deletions": 8}, "files": [{"sha": "4355e4ad522fb03c9de6e437a54a70e003f2096a", "filename": "gcc/rust/backend/rust-compile-extern.h", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e4cdb24c468b8a848980f7138767fbe093471c5b/gcc%2Frust%2Fbackend%2Frust-compile-extern.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e4cdb24c468b8a848980f7138767fbe093471c5b/gcc%2Frust%2Fbackend%2Frust-compile-extern.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-extern.h?ref=e4cdb24c468b8a848980f7138767fbe093471c5b", "patch": "@@ -46,6 +46,14 @@ class CompileExternItem : public HIRCompileBase,\n \n   void visit (HIR::ExternalStaticItem &item) override\n   {\n+    // check if its already been compiled\n+    Bvariable *lookup = ctx->get_backend ()->error_variable ();\n+    if (ctx->lookup_var_decl (item.get_mappings ().get_hirid (), &lookup))\n+      {\n+\treference = ctx->get_backend ()->var_expression (lookup, ref_locus);\n+\treturn;\n+      }\n+\n     TyTy::BaseType *resolved_type = nullptr;\n     bool ok = ctx->get_tyctx ()->lookup_type (item.get_mappings ().get_hirid (),\n \t\t\t\t\t      &resolved_type);\n@@ -102,15 +110,11 @@ class CompileExternItem : public HIRCompileBase,\n     if (ctx->lookup_function_decl (fntype->get_ty_ref (), &lookup,\n \t\t\t\t   fntype->get_id (), fntype))\n       {\n-\t// has this been added to the list then it must be finished\n-\tif (ctx->function_completed (lookup))\n-\t  {\n-\t    tree dummy = NULL_TREE;\n-\t    if (!ctx->lookup_function_decl (fntype->get_ty_ref (), &dummy))\n-\t      ctx->insert_function_decl (fntype, lookup);\n+\treference\n+\t  = address_expression (lookup, build_pointer_type (TREE_TYPE (lookup)),\n+\t\t\t\tref_locus);\n \n-\t    return;\n-\t  }\n+\treturn;\n       }\n \n     if (fntype->has_subsititions_defined ())"}, {"sha": "a6174253a21357435ed9b3ade4aa8d33ea6e8f25", "filename": "gcc/testsuite/rust/compile/issue-1323-1.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e4cdb24c468b8a848980f7138767fbe093471c5b/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1323-1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e4cdb24c468b8a848980f7138767fbe093471c5b/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1323-1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1323-1.rs?ref=e4cdb24c468b8a848980f7138767fbe093471c5b", "patch": "@@ -0,0 +1,18 @@\n+fn main() {\n+    let mut x = [1, 2, 3];\n+    let y: i32 = x[0];\n+    print_int(y);\n+}\n+\n+extern \"C\" {\n+    fn printf(s: *const i8, ...);\n+}\n+\n+fn print_int(value: i32) {\n+    let s = \"%d\\n\\0\";\n+    let s_p = s as *const str;\n+    let c_p = s_p as *const i8;\n+    unsafe {\n+        printf(c_p, value as isize);\n+    }\n+}"}, {"sha": "45168b22fa729f56c0fe737e3ffba2b6c25ffd24", "filename": "gcc/testsuite/rust/compile/issue-1323-2.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e4cdb24c468b8a848980f7138767fbe093471c5b/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1323-2.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e4cdb24c468b8a848980f7138767fbe093471c5b/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1323-2.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1323-2.rs?ref=e4cdb24c468b8a848980f7138767fbe093471c5b", "patch": "@@ -0,0 +1,16 @@\n+fn print_int(value: i32) {\n+    let s = \"%d\\n\\0\";\n+    let s_p = s as *const str;\n+    let c_p = s_p as *const i8;\n+    unsafe {\n+        printf(c_p, value as isize);\n+    }\n+}\n+\n+fn main() {\n+    print_int(5);\n+}\n+\n+extern \"C\" {\n+    fn printf(s: *const i8, ...);\n+}"}]}