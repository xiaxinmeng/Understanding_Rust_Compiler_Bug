{"sha": "8a25be517f8de8c060705da13db283a268cf6d12", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OGEyNWJlNTE3ZjhkZThjMDYwNzA1ZGExM2RiMjgzYTI2OGNmNmQxMg==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2021-01-05T11:04:15Z"}, "committer": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2021-01-05T11:04:15Z"}, "message": "rtl-ssa: Fix updates to call clobbers [PR98403]\n\nIn the PR, fwprop was changing a call instruction and tripped\nan assert when trying to update a list of call clobbers.\nThere are two ways we could handle this: remove the call clobber\nand then add it back, or assume that the clobber will stay in its\ncurrent place.\n\nAt the moment we don't have enough information to safely move\ncalls around, so the second approach seems simpler and more\nefficient.\n\ngcc/\n\tPR rtl-optimization/98403\n\t* rtl-ssa/changes.cc (function_info::finalize_new_accesses): Explain\n\twhy we don't remove call clobbers.\n\t(function_info::apply_changes_to_insn): Don't attempt to add\n\tcall clobbers here.\n\ngcc/testsuite/\n\tPR rtl-optimization/98403\n\t* g++.dg/opt/pr98403.C: New test.", "tree": {"sha": "828037944a89e09662b156b3490b2be83af98eb0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/828037944a89e09662b156b3490b2be83af98eb0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8a25be517f8de8c060705da13db283a268cf6d12", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8a25be517f8de8c060705da13db283a268cf6d12", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8a25be517f8de8c060705da13db283a268cf6d12", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8a25be517f8de8c060705da13db283a268cf6d12/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "01be45eccee42d0cc6c900f43e2363186517f7ed", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/01be45eccee42d0cc6c900f43e2363186517f7ed", "html_url": "https://github.com/Rust-GCC/gccrs/commit/01be45eccee42d0cc6c900f43e2363186517f7ed"}], "stats": {"total": 204, "additions": 200, "deletions": 4}, "files": [{"sha": "2a3cc2b229220ac8d90a84543f6907dd1eab61f5", "filename": "gcc/rtl-ssa/changes.cc", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8a25be517f8de8c060705da13db283a268cf6d12/gcc%2Frtl-ssa%2Fchanges.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8a25be517f8de8c060705da13db283a268cf6d12/gcc%2Frtl-ssa%2Fchanges.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frtl-ssa%2Fchanges.cc?ref=8a25be517f8de8c060705da13db283a268cf6d12", "patch": "@@ -423,7 +423,8 @@ function_info::finalize_new_accesses (insn_change &change)\n       }\n \n   // Also keep any explicitly-recorded call clobbers, which are deliberately\n-  // excluded from the vec_rtx_properties.\n+  // excluded from the vec_rtx_properties.  Calls shouldn't move, so we can\n+  // keep the definitions in their current position.\n   for (def_info *def : change.new_defs)\n     if (def->m_has_been_superceded && def->is_call_clobber ())\n       {\n@@ -533,10 +534,10 @@ function_info::apply_changes_to_insn (insn_change &change)\n   // Copy the cost.\n   insn->set_cost (change.new_cost);\n \n-  // Add all clobbers.  Sets never moved relative to other definitions,\n-  // so are OK as-is.\n+  // Add all clobbers.  Sets and call clobbers never move relative to\n+  // other definitions, so are OK as-is.\n   for (def_info *def : change.new_defs)\n-    if (is_a<clobber_info *> (def))\n+    if (is_a<clobber_info *> (def) && !def->is_call_clobber ())\n       add_def (def);\n \n   // Add all uses, now that their position is final."}, {"sha": "25522958112b7a5bcdd73064bfb8501def2f1065", "filename": "gcc/testsuite/g++.dg/opt/pr98403.C", "status": "added", "additions": 195, "deletions": 0, "changes": 195, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8a25be517f8de8c060705da13db283a268cf6d12/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fpr98403.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8a25be517f8de8c060705da13db283a268cf6d12/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fpr98403.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fpr98403.C?ref=8a25be517f8de8c060705da13db283a268cf6d12", "patch": "@@ -0,0 +1,195 @@\n+// { dg-options \"-Og -fcse-follow-jumps -fipa-ra\" }\n+// { dg-require-effective-target c++11 }\n+// { dg-additional-options \"-march=goldmont -fPIC -mforce-indirect-call\" { target { { i?86-*-* x86_64-*-* } && fpic } } }\n+\n+enum WindowClass { WC_NONE, WC_AI_SETTINGS, WC_AI_LIST };\n+enum { AWV_DECREASE, AWV_INCREASE };\n+enum WidgetType {\n+  WWT_PANEL,\n+  WWT_TEXT,\n+  WWT_MATRIX,\n+  WWT_FRAME,\n+  WWT_CAPTION,\n+  WWT_DEFSIZEBOX,\n+  WWT_RESIZEBOX,\n+  WWT_CLOSEBOX,\n+  NWID_HORIZONTAL,\n+  NWID_VERTICAL,\n+  NWID_SPACER,\n+  NWID_VSCROLLBAR,\n+  WWT_PUSHTXTBTN,\n+  WWT_PUSHARROWBTN\n+};\n+enum NWidContainerFlags { NC_NONE };\n+struct NWidgetPartPIP {\n+  char prepost;\n+};\n+struct NWidgetPart {\n+  NWidgetPartPIP pip;\n+} __trans_tmp_1;\n+static NWidgetPart SetResize(short, short) {\n+  NWidgetPart part;\n+  return part;\n+}\n+NWidgetPart SetMinimalSize(short, short);\n+static NWidgetPart SetFill(int, int) {\n+  NWidgetPart part;\n+  return part;\n+}\n+static NWidgetPart EndContainer() {\n+  NWidgetPart part;\n+  return part;\n+}\n+static NWidgetPart SetDataTip(int, int) {\n+  NWidgetPart part;\n+  return part;\n+}\n+static NWidgetPart SetMatrixDataTip(char, char, int) { return __trans_tmp_1; }\n+NWidgetPart SetPadding();\n+NWidgetPart SetScrollbar(int);\n+NWidgetPart NWidget(WidgetType, NWidContainerFlags = NC_NONE);\n+struct WindowDesc {\n+  WindowDesc(const char *, short, short, WindowClass, WindowClass, int,\n+             const NWidgetPart *, short, int * = nullptr);\n+  ~WindowDesc();\n+};\n+class CommandCost {\n+public:\n+  CommandCost(int);\n+} const CMD_ERROR(5);\n+enum { WID_AIC_SCROLLBAR };\n+const NWidgetPart _nested_ai_list_widgets[]{NWidget(NWID_HORIZONTAL),\n+                                            NWidget(WWT_CLOSEBOX),\n+                                            NWidget(WWT_CAPTION),\n+                                            SetDataTip(8, 4),\n+                                            NWidget(WWT_DEFSIZEBOX),\n+                                            NWidget(NWID_HORIZONTAL),\n+                                            NWidget(WWT_MATRIX),\n+                                            SetMinimalSize(8, 2),\n+                                            SetFill(1, 1),\n+                                            SetResize(1, 1),\n+                                            SetMatrixDataTip(1, 0, 1),\n+                                            EndContainer(),\n+                                            NWidget(WWT_PANEL),\n+                                            EndContainer(),\n+                                            NWidget(NWID_HORIZONTAL),\n+                                            NWidget(NWID_HORIZONTAL),\n+                                            NWidget(WWT_PUSHTXTBTN),\n+                                            SetResize(1, 0),\n+                                            SetFill(1, 0),\n+                                            SetDataTip(5, 0),\n+                                            NWidget(WWT_PUSHTXTBTN),\n+                                            SetResize(1, 0),\n+                                            SetFill(1, 0),\n+                                            SetDataTip(1, 2),\n+                                            EndContainer(),\n+                                            NWidget(WWT_RESIZEBOX),\n+                                            EndContainer()};\n+static WindowDesc _ai_list_desc(\"\", 0, 4, WC_AI_LIST, WC_NONE, 0,\n+                                _nested_ai_list_widgets, 0);\n+const NWidgetPart _nested_ai_settings_widgets[]{NWidget(NWID_HORIZONTAL),\n+                                                NWidget(WWT_CLOSEBOX),\n+                                                NWidget(WWT_CAPTION),\n+                                                SetDataTip(0, 4),\n+                                                NWidget(WWT_DEFSIZEBOX),\n+                                                EndContainer(),\n+                                                NWidget(NWID_HORIZONTAL),\n+                                                NWidget(WWT_MATRIX),\n+                                                SetMinimalSize(8, 2),\n+                                                SetResize(1, 1),\n+                                                SetFill(1, 0),\n+                                                SetMatrixDataTip(1, 0, 0),\n+                                                EndContainer(),\n+                                                NWidget(NWID_HORIZONTAL),\n+                                                NWidget(NWID_HORIZONTAL),\n+                                                NWidget(WWT_PUSHTXTBTN),\n+                                                SetResize(1, 0),\n+                                                SetDataTip(3, 0),\n+                                                NWidget(WWT_PUSHTXTBTN),\n+                                                SetResize(1, 0),\n+                                                SetDataTip(4, 0),\n+                                                EndContainer(),\n+                                                NWidget(WWT_RESIZEBOX),\n+                                                EndContainer()};\n+static WindowDesc _ai_settings_desc(\"\", 0, 208, WC_AI_SETTINGS, WC_NONE, 0,\n+                                    _nested_ai_settings_widgets, 0);\n+NWidgetPart _nested_ai_config_widgets[]{NWidget(NWID_HORIZONTAL),\n+                                        NWidget(WWT_CLOSEBOX),\n+                                        NWidget(WWT_CAPTION),\n+                                        SetDataTip(5, 4),\n+                                        EndContainer(),\n+                                        NWidget(WWT_PANEL),\n+                                        NWidget(NWID_VERTICAL),\n+                                        SetPadding(),\n+                                        NWidget(NWID_HORIZONTAL),\n+                                        SetPadding(),\n+                                        NWidget(WWT_PUSHARROWBTN),\n+                                        SetFill(0, 1),\n+                                        SetDataTip(AWV_DECREASE, 0),\n+                                        NWidget(WWT_PUSHARROWBTN),\n+                                        SetFill(0, 1),\n+                                        SetDataTip(AWV_INCREASE, 0),\n+                                        NWidget(NWID_SPACER),\n+                                        SetMinimalSize(6, 0),\n+                                        NWidget(WWT_TEXT),\n+                                        SetDataTip(3, 0),\n+                                        SetFill(1, 0),\n+                                        SetPadding(),\n+                                        EndContainer(),\n+                                        NWidget(NWID_HORIZONTAL),\n+                                        SetPadding(),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetResize(1, 0),\n+                                        SetFill(1, 0),\n+                                        SetDataTip(1, 2),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetResize(1, 0),\n+                                        SetFill(1, 0),\n+                                        SetDataTip(3, 4),\n+                                        EndContainer(),\n+                                        EndContainer(),\n+                                        SetPadding(),\n+                                        NWidget(NWID_HORIZONTAL),\n+                                        NWidget(WWT_MATRIX),\n+                                        SetMinimalSize(1, 0),\n+                                        SetMatrixDataTip(1, 8, 7),\n+                                        SetScrollbar(WID_AIC_SCROLLBAR),\n+                                        NWidget(NWID_VSCROLLBAR),\n+                                        EndContainer(),\n+                                        EndContainer(),\n+                                        NWidget(NWID_SPACER),\n+                                        SetMinimalSize(0, 9),\n+                                        NWidget(WWT_FRAME),\n+                                        SetDataTip(5, 0),\n+                                        SetPadding(),\n+                                        NWidget(WWT_MATRIX),\n+                                        SetMinimalSize(1, 0),\n+                                        SetMatrixDataTip(1, 1, 6),\n+                                        EndContainer(),\n+                                        NWidget(NWID_HORIZONTAL),\n+                                        SetPadding(),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetFill(1, 0),\n+                                        SetMinimalSize(3, 2),\n+                                        SetDataTip(1, 5),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetFill(1, 0),\n+                                        SetMinimalSize(3, 2),\n+                                        SetDataTip(6, 7),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetFill(1, 0),\n+                                        SetMinimalSize(3, 2),\n+                                        SetDataTip(3, 0),\n+                                        EndContainer(),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetFill(1, 0),\n+                                        SetResize(1, 0),\n+                                        SetDataTip(6, 0),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetFill(1, 0),\n+                                        SetResize(1, 0),\n+                                        SetDataTip(7, 0),\n+                                        NWidget(WWT_PUSHTXTBTN),\n+                                        SetFill(1, 0),\n+                                        SetResize(1, 0),\n+                                        SetDataTip(2, 3)};"}]}