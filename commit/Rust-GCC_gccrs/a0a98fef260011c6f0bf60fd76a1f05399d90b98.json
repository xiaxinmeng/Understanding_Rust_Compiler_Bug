{"sha": "a0a98fef260011c6f0bf60fd76a1f05399d90b98", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTBhOThmZWYyNjAwMTFjNmYwYmY2MGZkNzZhMWYwNTM5OWQ5MGI5OA==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2014-02-07T23:49:18Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2014-02-07T23:49:18Z"}, "message": "varpool.c: Include pointer-set.h.\n\n\t* varpool.c: Include pointer-set.h.\n\t(varpool_remove_unreferenced_decls): Variables in other partitions\n\twill not be output; be however careful to not lose information\n\tabout partitioning.\n\nFrom-SVN: r207620", "tree": {"sha": "177658eb2280a3859578dfbd41da251be089a034", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/177658eb2280a3859578dfbd41da251be089a034"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a0a98fef260011c6f0bf60fd76a1f05399d90b98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a0a98fef260011c6f0bf60fd76a1f05399d90b98", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a0a98fef260011c6f0bf60fd76a1f05399d90b98", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a0a98fef260011c6f0bf60fd76a1f05399d90b98/comments", "author": null, "committer": null, "parents": [{"sha": "b7e85694cf4baa17e0b9c43a640f4e0ca9870c46", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b7e85694cf4baa17e0b9c43a640f4e0ca9870c46", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b7e85694cf4baa17e0b9c43a640f4e0ca9870c46"}], "stats": {"total": 22, "additions": 19, "deletions": 3}, "files": [{"sha": "b69091eec05344d07ee317f4f4fb791ee19e11d0", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a0a98fef260011c6f0bf60fd76a1f05399d90b98/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a0a98fef260011c6f0bf60fd76a1f05399d90b98/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a0a98fef260011c6f0bf60fd76a1f05399d90b98", "patch": "@@ -1,3 +1,10 @@\n+2014-02-07  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* varpool.c: Include pointer-set.h.\n+\t(varpool_remove_unreferenced_decls): Variables in other partitions\n+\twill not be output; be however careful to not lose information\n+\tabout partitioning.\n+\n 2014-02-07  Jan Hubicka  <hubicka@ucw.cz>\n \n \t* gimple-fold.c (gimple_get_virt_method_for_vtable): Do O(1)"}, {"sha": "acb522100ea96a9a4819a43c66014d49e84c1d6f", "filename": "gcc/varpool.c", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a0a98fef260011c6f0bf60fd76a1f05399d90b98/gcc%2Fvarpool.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a0a98fef260011c6f0bf60fd76a1f05399d90b98/gcc%2Fvarpool.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvarpool.c?ref=a0a98fef260011c6f0bf60fd76a1f05399d90b98", "patch": "@@ -34,6 +34,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"output.h\"\n #include \"gimple-expr.h\"\n #include \"flags.h\"\n+#include \"pointer-set.h\"\n \n /* List of hooks triggered on varpool_node events.  */\n struct varpool_node_hook_list {\n@@ -262,7 +263,7 @@ ctor_for_folding (tree decl)\n     return error_mark_node;\n \n   /* Do not care about automatic variables.  Those are never initialized\n-     anyway, because gimplifier exapnds the code*/\n+     anyway, because gimplifier exapnds the code.  */\n   if (!TREE_STATIC (decl) && !DECL_EXTERNAL (decl))\n     {\n       gcc_assert (!TREE_PUBLIC (decl));\n@@ -486,6 +487,7 @@ varpool_remove_unreferenced_decls (void)\n   varpool_node *first = (varpool_node *)(void *)1;\n   int i;\n   struct ipa_ref *ref;\n+  struct pointer_set_t *referenced = pointer_set_create ();\n \n   if (seen_error ())\n     return;\n@@ -518,18 +520,21 @@ varpool_remove_unreferenced_decls (void)\n \t       next = next->same_comdat_group)\n \t    {\n \t      varpool_node *vnext = dyn_cast <varpool_node> (next);\n-\t      if (vnext && vnext->analyzed)\n+\t      if (vnext && vnext->analyzed && !symtab_comdat_local_p (next))\n \t\tenqueue_node (vnext, &first);\n \t    }\n \t}\n       for (i = 0; ipa_ref_list_reference_iterate (&node->ref_list, i, ref); i++)\n \t{\n \t  varpool_node *vnode = dyn_cast <varpool_node> (ref->referred);\n \t  if (vnode\n+\t      && !vnode->in_other_partition\n \t      && (!DECL_EXTERNAL (ref->referred->decl)\n \t\t  || vnode->alias)\n \t      && vnode->analyzed)\n \t    enqueue_node (vnode, &first);\n+\t  else\n+\t    pointer_set_insert (referenced, node);\n \t}\n     }\n   if (cgraph_dump_file)\n@@ -541,9 +546,13 @@ varpool_remove_unreferenced_decls (void)\n \t{\n           if (cgraph_dump_file)\n \t    fprintf (cgraph_dump_file, \" %s\", node->asm_name ());\n-\t  varpool_remove_node (node);\n+\t  if (pointer_set_contains (referenced, node))\n+\t    varpool_remove_initializer (node);\n+\t  else\n+\t    varpool_remove_node (node);\n \t}\n     }\n+  pointer_set_destroy (referenced);\n   if (cgraph_dump_file)\n     fprintf (cgraph_dump_file, \"\\n\");\n }"}]}