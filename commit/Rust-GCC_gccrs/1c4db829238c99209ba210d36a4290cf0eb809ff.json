{"sha": "1c4db829238c99209ba210d36a4290cf0eb809ff", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWM0ZGI4MjkyMzhjOTkyMDliYTIxMGQzNmE0MjkwY2YwZWI4MDlmZg==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2015-03-12T00:14:19Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2015-03-12T00:14:19Z"}, "message": "cgraph.c (cgraph_node::release_body): Free function_in_decl_state.\n\n\n\t* cgraph.c (cgraph_node::release_body): Free function_in_decl_state.\n\t(cgraph_node::remove): Likewise.\n\t(cgraph_node::get_untransformed_body): Likewise.\n\t* varpool.c (varpool_node::remove): Likewise.\n\t(varpool_node::get_constructor): Add sanity check.\n\t* lto.c (read_cgraph_and_symbols): Do not do merging\n\tat ltrans stage.\n\nFrom-SVN: r221366", "tree": {"sha": "9f5abb5d1ef41104ac985a833791fcc67420ed66", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9f5abb5d1ef41104ac985a833791fcc67420ed66"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1c4db829238c99209ba210d36a4290cf0eb809ff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1c4db829238c99209ba210d36a4290cf0eb809ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1c4db829238c99209ba210d36a4290cf0eb809ff", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1c4db829238c99209ba210d36a4290cf0eb809ff/comments", "author": null, "committer": null, "parents": [{"sha": "8648c55f3b703a0a824ae0815485dbebe4e01478", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8648c55f3b703a0a824ae0815485dbebe4e01478", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8648c55f3b703a0a824ae0815485dbebe4e01478"}], "stats": {"total": 50, "additions": 43, "deletions": 7}, "files": [{"sha": "53f582b5e967af98329d1587a266b7b21865750c", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=1c4db829238c99209ba210d36a4290cf0eb809ff", "patch": "@@ -1,3 +1,11 @@\n+2015-03-10  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* cgraph.c (cgraph_node::release_body): Free function_in_decl_state.\n+\t(cgraph_node::remove): Likewise.\n+\t(cgraph_node::get_untransformed_body): Likewise.\n+\t* varpool.c (varpool_node::remove): Likewise.\n+\t(varpool_node::get_constructor): Add sanity check.\n+\n 2015-03-11  Sandra Loosemore  <sandra@codesourcery.com>\n \n \t* doc/invoke.texi (-fgnu89-inline): Remove discussion about "}, {"sha": "ede58bf5aaf8f4e71b2f3e7bf6da5e9981edb86b", "filename": "gcc/cgraph.c", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Fcgraph.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Fcgraph.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.c?ref=1c4db829238c99209ba210d36a4290cf0eb809ff", "patch": "@@ -1721,7 +1721,10 @@ cgraph_node::release_body (bool keep_arguments)\n     DECL_INITIAL (decl) = error_mark_node;\n   release_function_body (decl);\n   if (lto_file_data)\n-    lto_free_function_in_decl_state_for_node (this);\n+    {\n+      lto_free_function_in_decl_state_for_node (this);\n+      lto_file_data = NULL;\n+    }\n }\n \n /* Remove function from symbol table.  */\n@@ -1799,13 +1802,18 @@ cgraph_node::remove (void)\n       n = cgraph_node::get (decl);\n       if (!n\n \t  || (!n->clones && !n->clone_of && !n->global.inlined_to\n-\t      && (symtab->global_info_ready\n+\t      && ((symtab->global_info_ready || in_lto_p)\n \t\t  && (TREE_ASM_WRITTEN (n->decl)\n \t\t      || DECL_EXTERNAL (n->decl)\n \t\t      || !n->analyzed\n \t\t      || (!flag_wpa && n->in_other_partition)))))\n \trelease_body ();\n     }\n+  else\n+    {\n+      lto_free_function_in_decl_state_for_node (this);\n+      lto_file_data = NULL;\n+    }\n \n   decl = NULL;\n   if (call_site_hash)\n@@ -3218,6 +3226,8 @@ cgraph_node::get_untransformed_body (void)\n   lto_free_section_data (file_data, LTO_section_function_body, name,\n \t\t\t data, len);\n   lto_free_function_in_decl_state_for_node (this);\n+  /* Keep lto file data so ipa-inline-analysis knows about cross module\n+     inlining.  */\n \n   timevar_pop (TV_IPA_LTO_GIMPLE_IN);\n "}, {"sha": "ae379ebb4f96a6d9f90787a20201130775e4c52f", "filename": "gcc/lto/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Flto%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Flto%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2FChangeLog?ref=1c4db829238c99209ba210d36a4290cf0eb809ff", "patch": "@@ -1,3 +1,8 @@\n+2015-03-10  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* lto.c (read_cgraph_and_symbols): Do not do merging\n+\tat ltrans stage.\n+\n 2015-02-26  Jakub Jelinek  <jakub@redhat.com>\n \n \t* lto.c (lto_mode_identity_table): New variable."}, {"sha": "760975fdf258874af044c1ba00f5170d8869c6f1", "filename": "gcc/lto/lto.c", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Flto%2Flto.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Flto%2Flto.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto.c?ref=1c4db829238c99209ba210d36a4290cf0eb809ff", "patch": "@@ -3118,13 +3118,20 @@ read_cgraph_and_symbols (unsigned nfiles, const char **fnames)\n       fprintf (symtab->dump_file, \"Before merging:\\n\");\n       symtab_node::dump_table (symtab->dump_file);\n     }\n-  lto_symtab_merge_symbols ();\n-  /* Removal of unreachable symbols is needed to make verify_symtab to pass;\n-     we are still having duplicated comdat groups containing local statics.\n-     We could also just remove them while merging.  */\n-  symtab->remove_unreachable_nodes (dump_file);\n+  if (!flag_ltrans)\n+    {\n+      lto_symtab_merge_symbols ();\n+      /* Removal of unreachable symbols is needed to make verify_symtab to pass;\n+\t we are still having duplicated comdat groups containing local statics.\n+\t We could also just remove them while merging.  */\n+      symtab->remove_unreachable_nodes (dump_file);\n+    }\n   ggc_collect ();\n   symtab->state = IPA_SSA;\n+  /* FIXME: Technically all node removals happening here are useless, because\n+     WPA should not stream them.  */\n+  if (flag_ltrans)\n+    symtab->remove_unreachable_nodes (dump_file);\n \n   timevar_pop (TV_IPA_LTO_CGRAPH_MERGE);\n "}, {"sha": "b5836934d72526edb2fbd15bf3dcded912fb7743", "filename": "gcc/varpool.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Fvarpool.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c4db829238c99209ba210d36a4290cf0eb809ff/gcc%2Fvarpool.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvarpool.c?ref=1c4db829238c99209ba210d36a4290cf0eb809ff", "patch": "@@ -195,6 +195,11 @@ void\n varpool_node::remove (void)\n {\n   symtab->call_varpool_removal_hooks (this);\n+  if (lto_file_data)\n+    {\n+      lto_free_function_in_decl_state_for_node (this);\n+      lto_file_data = NULL;\n+    }\n \n   /* When streaming we can have multiple nodes associated with decl.  */\n   if (symtab->state == LTO_STREAMING)\n@@ -323,6 +328,7 @@ varpool_node::get_constructor (void)\n \t\t name);\n \n   lto_input_variable_constructor (file_data, this, data);\n+  gcc_assert (DECL_INITIAL (decl) != error_mark_node);\n   lto_stats.num_function_bodies++;\n   lto_free_section_data (file_data, LTO_section_function_body, name,\n \t\t\t data, len);"}]}