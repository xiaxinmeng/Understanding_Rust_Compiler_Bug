{"sha": "6be763897bcabab90eeae0dfda963531802a4ae9", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmJlNzYzODk3YmNhYmFiOTBlZWFlMGRmZGE5NjM1MzE4MDJhNGFlOQ==", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2020-04-08T21:38:51Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-06-17T08:13:58Z"}, "message": "[Ada] Fix expansion of \"for X of Y loop\" in GNATprove\n\n2020-06-17  Piotr Trojanek  <trojanek@adacore.com>\n\ngcc/ada/\n\n\t* sem_ch5.adb (Analyze_Iterator_Specification): Enable expansion\n\tthat creates a renaming that removes side effects from the\n\titerated object in the GNATprove mode; then analyze reference to\n\tthis renaming (it is required for GNATprove and harmless for\n\tGNAT).", "tree": {"sha": "e8c528e0082e2ccbd0e945ca96dc1eacc3ea3106", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e8c528e0082e2ccbd0e945ca96dc1eacc3ea3106"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6be763897bcabab90eeae0dfda963531802a4ae9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6be763897bcabab90eeae0dfda963531802a4ae9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6be763897bcabab90eeae0dfda963531802a4ae9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6be763897bcabab90eeae0dfda963531802a4ae9/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7199fb6e694d1a0964351200648c24c3ee97973", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c7199fb6e694d1a0964351200648c24c3ee97973", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c7199fb6e694d1a0964351200648c24c3ee97973"}], "stats": {"total": 10, "additions": 6, "deletions": 4}, "files": [{"sha": "01f0b50e6327be06745d3d75f7c46198780bcc85", "filename": "gcc/ada/sem_ch5.adb", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6be763897bcabab90eeae0dfda963531802a4ae9/gcc%2Fada%2Fsem_ch5.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6be763897bcabab90eeae0dfda963531802a4ae9/gcc%2Fada%2Fsem_ch5.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch5.adb?ref=6be763897bcabab90eeae0dfda963531802a4ae9", "patch": "@@ -2214,8 +2214,8 @@ package body Sem_Ch5 is\n \n       --  If the domain of iteration is an expression, create a declaration for\n       --  it, so that finalization actions are introduced outside of the loop.\n-      --  The declaration must be a renaming because the body of the loop may\n-      --  assign to elements.\n+      --  The declaration must be a renaming (both in GNAT and GNATprove\n+      --  modes), because the body of the loop may assign to elements.\n \n       if not Is_Entity_Name (Iter_Name)\n \n@@ -2224,14 +2224,15 @@ package body Sem_Ch5 is\n         --  doing expansion.\n \n         and then (Nkind (Parent (N)) /= N_Quantified_Expression\n-                   or else Operating_Mode = Check_Semantics)\n+                   or else (Operating_Mode = Check_Semantics\n+                            and then not GNATprove_Mode))\n \n         --  Do not perform this expansion when expansion is disabled, where the\n         --  temporary may hide the transformation of a selected component into\n         --  a prefixed function call, and references need to see the original\n         --  expression.\n \n-        and then Expander_Active\n+        and then (Expander_Active or GNATprove_Mode)\n       then\n          declare\n             Id    : constant Entity_Id := Make_Temporary (Loc, 'R', Iter_Name);\n@@ -2319,6 +2320,7 @@ package body Sem_Ch5 is\n \n             Insert_Actions (Parent (Parent (N)), New_List (Decl));\n             Rewrite (Name (N), New_Occurrence_Of (Id, Loc));\n+            Analyze (Name (N));\n             Set_Etype (Id, Typ);\n             Set_Etype (Name (N), Typ);\n          end;"}]}