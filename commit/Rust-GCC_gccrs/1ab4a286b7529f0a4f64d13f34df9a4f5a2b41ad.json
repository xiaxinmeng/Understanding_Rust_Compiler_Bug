{"sha": "1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWFiNGEyODZiNzUyOWYwYTRmNjRkMTNmMzRkZjlhNGY1YTJiNDFhZA==", "commit": {"author": {"name": "Emmanuel Briot", "email": "briot@adacore.com", "date": "2011-08-04T13:21:16Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2011-08-04T13:21:16Z"}, "message": "make.adb, [...] (Check_Mains): rebuild the list of files on the command line after processing it through...\n\n2011-08-04  Emmanuel Briot  <briot@adacore.com>\n\n\t* make.adb, makeutl.adb, osint.adb, osint.ads (Check_Mains): rebuild\n\tthe list of files on the command line after processing it through\n\tComplete_Mains.\n\nFrom-SVN: r177380", "tree": {"sha": "07b391adefd81f9e597c3fb5aaf888aeb8d9b32f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/07b391adefd81f9e597c3fb5aaf888aeb8d9b32f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/comments", "author": {"login": "briot", "id": 42402, "node_id": "MDQ6VXNlcjQyNDAy", "avatar_url": "https://avatars.githubusercontent.com/u/42402?v=4", "gravatar_id": "", "url": "https://api.github.com/users/briot", "html_url": "https://github.com/briot", "followers_url": "https://api.github.com/users/briot/followers", "following_url": "https://api.github.com/users/briot/following{/other_user}", "gists_url": "https://api.github.com/users/briot/gists{/gist_id}", "starred_url": "https://api.github.com/users/briot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/briot/subscriptions", "organizations_url": "https://api.github.com/users/briot/orgs", "repos_url": "https://api.github.com/users/briot/repos", "events_url": "https://api.github.com/users/briot/events{/privacy}", "received_events_url": "https://api.github.com/users/briot/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7ae0d98c02dda4cbf0d3c9cac19a7358f8b53071", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7ae0d98c02dda4cbf0d3c9cac19a7358f8b53071", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7ae0d98c02dda4cbf0d3c9cac19a7358f8b53071"}], "stats": {"total": 79, "additions": 76, "deletions": 3}, "files": [{"sha": "12e4b0d54b36292ef6354631b27aa1fe6cc8b196", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "patch": "@@ -1,3 +1,9 @@\n+2011-08-04  Emmanuel Briot  <briot@adacore.com>\n+\n+\t* make.adb, makeutl.adb, osint.adb, osint.ads (Check_Mains): rebuild\n+\tthe list of files on the command line after processing it through\n+\tComplete_Mains.\n+\n 2011-08-04  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* exp_ch7.adb (Build_Raise_Statement): Remove the specialized"}, {"sha": "41e787d319297c5aa426828b9fd133eeb631ddd7", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 55, "deletions": 1, "changes": 56, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "patch": "@@ -5464,6 +5464,9 @@ package body Make is\n       Current_Main_Index : Int := 0;\n       --  If not zero, the index of the current main unit in its source file\n \n+      Is_First_Main : Boolean;\n+      --  Whether we are processing the first main\n+\n       Stand_Alone_Libraries : Boolean := False;\n       --  Set to True when there are Stand-Alone Libraries, so that gnatbind\n       --  is invoked with the -F switch to force checking of elaboration flags.\n@@ -5526,6 +5529,30 @@ package body Make is\n \n             Debug_Output (\"After checking mains, main project is\",\n                           Main_Project.Name);\n+\n+         else\n+            --  For all mains on the command line, make sure they were in\n+            --  osint. In particular, if the user has specified a multi-unit\n+            --  source file, the call to Complete_Mains will have expanded\n+            --  the list of mains to all its units, and we must now put them\n+            --  back on the command line.\n+            --  ??? This will not be necessary when gnatmake shares the same\n+            --  queue as gprbuild and processes the file directly on the queue.\n+\n+            Mains.Reset;\n+            --  Osint.Reset_Command_Line_Files;\n+            Debug_Output (\"Reseting list of mains on the command line\");\n+\n+            loop\n+               Info := Mains.Next_Main;\n+               exit when Info = No_Main_Info;\n+\n+               if Info.Index /= 0 then\n+                  Debug_Output (\"Add to command line index=\"\n+                                & Info.Index'Img, Name_Id (Info.File));\n+                  Osint.Add_File (Get_Name_String (Info.File), Info.Index);\n+               end if;\n+            end loop;\n          end if;\n       end Check_Mains;\n \n@@ -6056,21 +6083,48 @@ package body Make is\n       Queue.Initialize\n         (Main_Project /= No_Project and then One_Compilation_Per_Obj_Dir);\n \n+      Is_First_Main := True;\n+\n       Multiple_Main_Loop : for N_File in 1 .. Osint.Number_Of_Files loop\n          if Current_File_Index /= No_Index then\n             Main_Index := Current_File_Index;\n          end if;\n \n          Current_Main_Index := Main_Index;\n \n+         if Current_Main_Index = 0\n+           and then Unique_Compile\n+             and then Main_Project /= No_Project\n+         then\n+            --  If this is a multi-unit source, do not compile it as is (ie\n+            --  without specifying which unit to compile)\n+            --  Insert_Project_Sources has added each of the unit separately.\n+\n+            declare\n+               Source : constant Prj.Source_Id := Find_Source\n+                 (In_Tree   => Project_Tree,\n+                  Project   => Main_Project,\n+                  Base_Name => Main_Source_File,\n+                  Index     => Current_Main_Index,\n+                  In_Imported_Only => True);\n+            begin\n+               if Source /= No_Source\n+                 and then Source.Index /= 0\n+               then\n+                  goto Next_Main;\n+               end if;\n+            end;\n+         end if;\n+\n          Compute_Switches_For_Main\n            (Main_Source_File,\n             Main_Index,\n             Project_Node_Tree,\n             Root_Environment,\n-            Compute_Builder  => N_File = 1,\n+            Compute_Builder  => Is_First_Main,\n             Current_Work_Dir => Current_Work_Dir.all);\n \n+         Is_First_Main := False;\n          Executable_Obsolete := False;\n \n          Compute_Executable"}, {"sha": "0be182e74139163ea4db2ae1dd2a7e8774e43286", "filename": "gcc/ada/makeutl.adb", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fmakeutl.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fmakeutl.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmakeutl.adb?ref=1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "patch": "@@ -1529,6 +1529,7 @@ package body Makeutl is\n                            end if;\n \n                            Names.Table (J).Source  := Source;\n+                           Names.Table (J).Index   := Source.Index;\n \n                         elsif File.Location /= No_Location then\n "}, {"sha": "408384ca88bf8b1d5ee57226a629919e1450ac2b", "filename": "gcc/ada/osint.adb", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fosint.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fosint.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.adb?ref=1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 1992-2010, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2011, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -2749,6 +2749,15 @@ package body Osint is\n       return new String'(Path);\n    end Relocate_Path;\n \n+   ------------------------------\n+   -- Reset_Command_Line_Files --\n+   ------------------------------\n+\n+   procedure Reset_Command_Line_Files is\n+   begin\n+      Number_File_Names := 0;\n+   end Reset_Command_Line_Files;\n+\n    -----------------\n    -- Set_Program --\n    -----------------"}, {"sha": "9fccd33085900e673e92b174f685945f553ab527", "filename": "gcc/ada/osint.ads", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fosint.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad/gcc%2Fada%2Fosint.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.ads?ref=1ab4a286b7529f0a4f64d13f34df9a4f5a2b41ad", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 1992-2010, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2011, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -114,6 +114,9 @@ package Osint is\n    function Number_Of_Files return Int;\n    --  Gives the total number of filenames found on the command line\n \n+   procedure Reset_Command_Line_Files;\n+   --  Reset the list of files specified on the command line to empty.\n+\n    No_Index : constant := -1;\n    --  Value used in Add_File to indicate no index is specified for main\n "}]}