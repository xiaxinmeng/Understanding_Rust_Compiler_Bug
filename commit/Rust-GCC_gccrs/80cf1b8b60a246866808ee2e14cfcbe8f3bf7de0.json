{"sha": "80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODBjZjFiOGI2MGEyNDY4NjY4MDhlZTJlMTRjZmNiZThmM2JmN2RlMA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2016-11-28T17:31:37Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2016-11-28T17:31:37Z"}, "message": "re PR fortran/78298 (ICE in lookup_decl_in_outer_ctx, bei omp-low.c:4115)\n\n\tPR fortran/78298\n\t* tree-nested.c (convert_local_reference_stmt): After adding\n\tshared (FRAME.NN) clause to omp parallel, task or target,\n\tadd it also to all outer omp parallel, task or target constructs.\n\n\t* gfortran.dg/gomp/pr78298.f90: New test.\n\nFrom-SVN: r242926", "tree": {"sha": "c657706f30cec0d18f187de4c8d29f2368a6d538", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c657706f30cec0d18f187de4c8d29f2368a6d538"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "bf9e8b6b50952b31d04179bae1ebb4c09ffdc1cf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bf9e8b6b50952b31d04179bae1ebb4c09ffdc1cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bf9e8b6b50952b31d04179bae1ebb4c09ffdc1cf"}], "stats": {"total": 84, "additions": 79, "deletions": 5}, "files": [{"sha": "ded59707617b044e0dc977566057b915e1410f19", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "patch": "@@ -1,3 +1,10 @@\n+2016-11-28  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/78298\n+\t* tree-nested.c (convert_local_reference_stmt): After adding\n+\tshared (FRAME.NN) clause to omp parallel, task or target,\n+\tadd it also to all outer omp parallel, task or target constructs.\n+\n 2016-11-28  Uros Bizjak  <ubizjak@gmail.com>\n \n \t* config/i386/i386.md (UNSPEC_KMASKOP): New."}, {"sha": "48ccdd969bbc98e96f036edd6b01342024c14bfa", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "patch": "@@ -1,3 +1,8 @@\n+2016-11-28  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/78298\n+\t* gfortran.dg/gomp/pr78298.f90: New test.\n+\n 2016-11-28  Uros Bizjak  <ubizjak@gmail.com>\n \n \t* gcc.target/i386/bmi-andn-1a.c (dg-final): Update scan string."}, {"sha": "85955c2015341893a406fd1a77f28d8bf3a1c20d", "filename": "gcc/testsuite/gfortran.dg/gomp/pr78298.f90", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr78298.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr78298.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr78298.f90?ref=80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "patch": "@@ -0,0 +1,28 @@\n+! PR fortran/78298\n+! { dg-do compile }\n+! { dg-additional-options \"-O2\" }\n+\n+program pr78298\n+  integer :: i, j, n\n+  n = 2\n+  !$omp parallel\n+  !$omp do\n+  do i = 1, n\n+    !$omp parallel\n+    !$omp do\n+    do j = 1, n\n+      call sub(i)\n+    end do\n+    !$omp end parallel\n+  end do\n+  !$omp end parallel\n+  !call unused()\n+contains\n+  subroutine sub(x)\n+    integer :: x\n+  end\n+  subroutine unused()\n+    i = 0\n+    j = 0\n+  end\n+end"}, {"sha": "0c8bc6478e45b9095334deba51c990ed279f4658", "filename": "gcc/tree-nested.c", "status": "modified", "additions": 39, "deletions": 5, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2Ftree-nested.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0/gcc%2Ftree-nested.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-nested.c?ref=80cf1b8b60a246866808ee2e14cfcbe8f3bf7de0", "patch": "@@ -2083,36 +2083,53 @@ convert_local_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n   struct nesting_info *info = (struct nesting_info *) wi->info;\n   tree save_local_var_chain;\n   bitmap save_suppress;\n+  char save_static_chain_added;\n+  bool frame_decl_added;\n   gimple *stmt = gsi_stmt (*gsi);\n \n   switch (gimple_code (stmt))\n     {\n     case GIMPLE_OMP_PARALLEL:\n     case GIMPLE_OMP_TASK:\n       save_suppress = info->suppress_expansion;\n+      frame_decl_added = false;\n       if (convert_local_omp_clauses (gimple_omp_taskreg_clauses_ptr (stmt),\n \t                             wi))\n \t{\n-\t  tree c;\n+\t  tree c = build_omp_clause (gimple_location (stmt),\n+\t\t\t\t     OMP_CLAUSE_SHARED);\n \t  (void) get_frame_type (info);\n-\t  c = build_omp_clause (gimple_location (stmt),\n-\t\t\t\tOMP_CLAUSE_SHARED);\n \t  OMP_CLAUSE_DECL (c) = info->frame_decl;\n \t  OMP_CLAUSE_CHAIN (c) = gimple_omp_taskreg_clauses (stmt);\n \t  gimple_omp_taskreg_set_clauses (stmt, c);\n+\t  info->static_chain_added |= 4;\n+\t  frame_decl_added = true;\n \t}\n \n       save_local_var_chain = info->new_local_var_chain;\n+      save_static_chain_added = info->static_chain_added;\n       info->new_local_var_chain = NULL;\n+      info->static_chain_added = 0;\n \n       walk_body (convert_local_reference_stmt, convert_local_reference_op, info,\n \t         gimple_omp_body_ptr (stmt));\n \n+      if ((info->static_chain_added & 4) != 0 && !frame_decl_added)\n+\t{\n+\t  tree c = build_omp_clause (gimple_location (stmt),\n+\t\t\t\t     OMP_CLAUSE_SHARED);\n+\t  (void) get_frame_type (info);\n+\t  OMP_CLAUSE_DECL (c) = info->frame_decl;\n+\t  OMP_CLAUSE_CHAIN (c) = gimple_omp_taskreg_clauses (stmt);\n+\t  info->static_chain_added |= 4;\n+\t  gimple_omp_taskreg_set_clauses (stmt, c);\n+\t}\n       if (info->new_local_var_chain)\n \tdeclare_vars (info->new_local_var_chain,\n \t\t      gimple_seq_first_stmt (gimple_omp_body (stmt)), false);\n       info->new_local_var_chain = save_local_var_chain;\n       info->suppress_expansion = save_suppress;\n+      info->static_chain_added |= save_static_chain_added;\n       break;\n \n     case GIMPLE_OMP_FOR:\n@@ -2153,29 +2170,46 @@ convert_local_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n \t  break;\n \t}\n       save_suppress = info->suppress_expansion;\n+      frame_decl_added = false;\n       if (convert_local_omp_clauses (gimple_omp_target_clauses_ptr (stmt), wi))\n \t{\n-\t  tree c;\n+\t  tree c = build_omp_clause (gimple_location (stmt), OMP_CLAUSE_MAP);\n \t  (void) get_frame_type (info);\n-\t  c = build_omp_clause (gimple_location (stmt), OMP_CLAUSE_MAP);\n \t  OMP_CLAUSE_DECL (c) = info->frame_decl;\n \t  OMP_CLAUSE_SET_MAP_KIND (c, GOMP_MAP_TOFROM);\n \t  OMP_CLAUSE_SIZE (c) = DECL_SIZE_UNIT (info->frame_decl);\n \t  OMP_CLAUSE_CHAIN (c) = gimple_omp_target_clauses (stmt);\n \t  gimple_omp_target_set_clauses (as_a <gomp_target *> (stmt), c);\n+\t  info->static_chain_added |= 4;\n+\t  frame_decl_added = true;\n \t}\n \n       save_local_var_chain = info->new_local_var_chain;\n+      save_static_chain_added = info->static_chain_added;\n       info->new_local_var_chain = NULL;\n+      info->static_chain_added = 0;\n \n       walk_body (convert_local_reference_stmt, convert_local_reference_op, info,\n \t\t gimple_omp_body_ptr (stmt));\n \n+      if ((info->static_chain_added & 4) != 0 && !frame_decl_added)\n+\t{\n+\t  tree c = build_omp_clause (gimple_location (stmt), OMP_CLAUSE_MAP);\n+\t  (void) get_frame_type (info);\n+\t  OMP_CLAUSE_DECL (c) = info->frame_decl;\n+\t  OMP_CLAUSE_SET_MAP_KIND (c, GOMP_MAP_TOFROM);\n+\t  OMP_CLAUSE_SIZE (c) = DECL_SIZE_UNIT (info->frame_decl);\n+\t  OMP_CLAUSE_CHAIN (c) = gimple_omp_target_clauses (stmt);\n+\t  gimple_omp_target_set_clauses (as_a <gomp_target *> (stmt), c);\n+\t  info->static_chain_added |= 4;\n+\t}\n+\n       if (info->new_local_var_chain)\n \tdeclare_vars (info->new_local_var_chain,\n \t\t      gimple_seq_first_stmt (gimple_omp_body (stmt)), false);\n       info->new_local_var_chain = save_local_var_chain;\n       info->suppress_expansion = save_suppress;\n+      info->static_chain_added |= save_static_chain_added;\n       break;\n \n     case GIMPLE_OMP_TEAMS:"}]}