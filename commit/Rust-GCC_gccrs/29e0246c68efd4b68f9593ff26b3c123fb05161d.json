{"sha": "29e0246c68efd4b68f9593ff26b3c123fb05161d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjllMDI0NmM2OGVmZDRiNjhmOTU5M2ZmMjZiM2MxMjNmYjA1MTYxZA==", "commit": {"author": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-03-22T13:59:02Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-03-22T13:59:02Z"}, "message": "[Ada] GNAT.Sockets: fix recent regressions\n\nThe support for IPv6 that was added since last release triggered\nregressions on various platforms. The size of structures passed to low\nlevel routines was not correct anymore: it should depend on the address\nfamily, now.\n\n2019-03-22  Dmitriy Anisimkov  <anisimko@adacore.com>\n\ngcc/ada/\n\n\tPR ada/89583\n\t* libgnat/g-socket.adb (Bind_Socket, Connect_Socket,\n\tSend_Socket): Fix the computation of structure lengths passed to\n\tlow level routines.\n\t(Is_IPv6_Address): Fix the number of expected colons.\n\n2019-03-22  Simon Wright  <simon@pushface.org>\n\ngcc/testsuite/\n\n\tPR ada/89583\n\t* gnat.dg/socket2.adb: New.\n\nFrom-SVN: r269873", "tree": {"sha": "d8fc70816991d4f49a5255aa5fe952ed585e5ff1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d8fc70816991d4f49a5255aa5fe952ed585e5ff1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/29e0246c68efd4b68f9593ff26b3c123fb05161d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/29e0246c68efd4b68f9593ff26b3c123fb05161d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/29e0246c68efd4b68f9593ff26b3c123fb05161d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/29e0246c68efd4b68f9593ff26b3c123fb05161d/comments", "author": null, "committer": null, "parents": [{"sha": "b6c5f9f3dd489efa345175c8ac1352fa2849d32c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b6c5f9f3dd489efa345175c8ac1352fa2849d32c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b6c5f9f3dd489efa345175c8ac1352fa2849d32c"}], "stats": {"total": 42, "additions": 35, "deletions": 7}, "files": [{"sha": "81b5db972c4239d60f38e2eb5c1c691816afc317", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=29e0246c68efd4b68f9593ff26b3c123fb05161d", "patch": "@@ -1,3 +1,11 @@\n+2019-03-22  Dmitriy Anisimkov  <anisimko@adacore.com>\n+\n+\tPR ada/89583\n+\t* libgnat/g-socket.adb (Bind_Socket, Connect_Socket,\n+\tSend_Socket): Fix the computation of structure lengths passed to\n+\tlow level routines.\n+\t(Is_IPv6_Address): Fix the number of expected colons.\n+\n 2019-03-11  Martin Liska  <mliska@suse.cz>\n \n \t* gcc-interface/misc.c (gnat_post_options): Wrap option name in string"}, {"sha": "476a213b038e2db6d7509dc43807bfd928d79a12", "filename": "gcc/ada/libgnat/g-socket.adb", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Fada%2Flibgnat%2Fg-socket.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Fada%2Flibgnat%2Fg-socket.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-socket.adb?ref=29e0246c68efd4b68f9593ff26b3c123fb05161d", "patch": "@@ -461,12 +461,12 @@ package body GNAT.Sockets is\n    is\n       Res : C.int;\n       Sin : aliased Sockaddr;\n-      Len : constant C.int := Sin'Size / 8;\n \n    begin\n       Set_Address (Sin'Unchecked_Access, Address);\n \n-      Res := C_Bind (C.int (Socket), Sin'Address, Len);\n+      Res := C_Bind\n+        (C.int (Socket), Sin'Address, C.int (Lengths (Address.Family)));\n \n       if Res = Failure then\n          Raise_Socket_Error (Socket_Errno);\n@@ -666,12 +666,11 @@ package body GNAT.Sockets is\n       Server : Sock_Addr_Type) return C.int\n    is\n       Sin : aliased Sockaddr;\n-      Len : constant C.int := Sin'Size / 8;\n-\n    begin\n       Set_Address (Sin'Unchecked_Access, Server);\n \n-      return C_Connect (C.int (Socket), Sin'Address, Len);\n+      return C_Connect\n+        (C.int (Socket), Sin'Address, C.int (Lengths (Server.Family)));\n    end Connect_Socket;\n \n    procedure Connect_Socket\n@@ -1794,7 +1793,7 @@ package body GNAT.Sockets is\n          end if;\n       end loop;\n \n-      return Colons <= 7;\n+      return Colons <= 8;\n    end Is_IPv6_Address;\n \n    ---------------------\n@@ -2403,7 +2402,7 @@ package body GNAT.Sockets is\n       if To /= null then\n          Set_Address (Sin'Unchecked_Access, To.all);\n          C_To := Sin'Address;\n-         Len := Sin'Size / 8;\n+         Len := C.int (Thin_Common.Lengths (To.Family));\n \n       else\n          C_To := System.Null_Address;"}, {"sha": "2fee0da53866d7cc26a97fa47476d6071a7ba696", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=29e0246c68efd4b68f9593ff26b3c123fb05161d", "patch": "@@ -1,3 +1,8 @@\n+2019-03-22  Simon Wright  <simon@pushface.org>\n+\n+\tPR ada/89583\n+\t* gnat.dg/socket2.adb: New.\n+\n 2019-03-22  Bill Schmidt  <wschmidt@linux.ibm.com>\n \n \t* gcc.target/powerpc/mmx-psubd-2.c: Test _m_psubd."}, {"sha": "2ca5288fb7774c7312cae3e5f1daf6e90786ecc5", "filename": "gcc/testsuite/gnat.dg/socket2.adb", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Ftestsuite%2Fgnat.dg%2Fsocket2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/29e0246c68efd4b68f9593ff26b3c123fb05161d/gcc%2Ftestsuite%2Fgnat.dg%2Fsocket2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fsocket2.adb?ref=29e0246c68efd4b68f9593ff26b3c123fb05161d", "patch": "@@ -0,0 +1,16 @@\n+-- { dg-do run }\n+with GNAT.Sockets;\n+procedure Socket2 is\n+   Address : GNAT.Sockets.Sock_Addr_Type;\n+   Server_Socket : GNAT.Sockets.Socket_Type;\n+begin\n+   Address.Addr := GNAT.Sockets.Any_Inet_Addr;\n+   Address.Port := 16#1234#;\n+   GNAT.Sockets.Create_Socket (Server_Socket);\n+   GNAT.Sockets.Set_Socket_Option\n+     (Server_Socket,\n+      GNAT.Sockets.Socket_Level,\n+      (GNAT.Sockets.Reuse_Address, True));\n+   GNAT.Sockets.Bind_Socket (Server_Socket, Address);\n+   GNAT.Sockets.Close_Socket (Server_Socket);\n+end Socket2;"}]}