{"sha": "916c7a201a9a1dc94f2c056a773826a26d1daca9", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTE2YzdhMjAxYTlhMWRjOTRmMmMwNTZhNzczODI2YTI2ZDFkYWNhOQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-08-05T08:40:10Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-08-05T08:40:10Z"}, "message": "openmp: Handle reduction clauses on host teams construct [PR96459]\n\nAs the new testcase shows, we weren't actually performing reductions on\nhost teams construct.  And fixing that revealed a flaw in the for-14.c testcase.\nThe problem is that the tests perform also initialization and checking around the\ncalls to the functions with the OpenMP constructs.  In that testcase, all the\ntests have been spawned from a teams construct but only the tested loops were\ndistribute, which means the initialization and checking has been performed\nredundantly and racily in each team.  Fixed by performing the initialization\nand checking outside of host teams and only do the calls to functions with\nthe tested constructs inside of host teams.\n\n2020-08-05  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR middle-end/96459\n\t* omp-low.c (lower_omp_taskreg): Call lower_reduction_clauses even in\n\tfor host teams.\n\n\t* testsuite/libgomp.c/teams-3.c: New test.\n\t* testsuite/libgomp.c-c++-common/for-2.h (OMPTEAMS): Define to nothing\n\tif not defined yet.\n\t(N(test)): Use it before all N(f*) calls.\n\t* testsuite/libgomp.c-c++-common/for-14.c (DO_PRAGMA, OMPTEAMS): Define.\n\t(main): Don't call all test_* functions from within\n\t#pragma omp teams reduction(|:err), call them directly.", "tree": {"sha": "3af4b82309abf7bb69f3987109b08d07b1d657f3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3af4b82309abf7bb69f3987109b08d07b1d657f3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/916c7a201a9a1dc94f2c056a773826a26d1daca9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/916c7a201a9a1dc94f2c056a773826a26d1daca9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/916c7a201a9a1dc94f2c056a773826a26d1daca9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/916c7a201a9a1dc94f2c056a773826a26d1daca9/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "325714b4968050c927fe72f4a4ba860da2bf4ee2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/325714b4968050c927fe72f4a4ba860da2bf4ee2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/325714b4968050c927fe72f4a4ba860da2bf4ee2"}], "stats": {"total": 111, "additions": 83, "deletions": 28}, "files": [{"sha": "53efe5f750c42ec5fb301604e4b6234ec29fb50b", "filename": "gcc/omp-low.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/916c7a201a9a1dc94f2c056a773826a26d1daca9/gcc%2Fomp-low.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/916c7a201a9a1dc94f2c056a773826a26d1daca9/gcc%2Fomp-low.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.c?ref=916c7a201a9a1dc94f2c056a773826a26d1daca9", "patch": "@@ -11236,7 +11236,7 @@ lower_omp_taskreg (gimple_stmt_iterator *gsi_p, omp_context *ctx)\n   gimple_seq par_rlist = NULL;\n   lower_rec_input_clauses (clauses, &par_ilist, &par_olist, ctx, NULL);\n   lower_omp (&par_body, ctx);\n-  if (gimple_code (stmt) == GIMPLE_OMP_PARALLEL)\n+  if (gimple_code (stmt) != GIMPLE_OMP_TASK)\n     lower_reduction_clauses (clauses, &par_rlist, NULL, ctx);\n \n   /* Declare all the variables created by mapping and the variables"}, {"sha": "d2e3be82b092318cd726d6f65d2074c048ac64cf", "filename": "libgomp/testsuite/libgomp.c-c++-common/for-14.c", "status": "modified", "additions": 26, "deletions": 27, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/916c7a201a9a1dc94f2c056a773826a26d1daca9/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Ffor-14.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/916c7a201a9a1dc94f2c056a773826a26d1daca9/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Ffor-14.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Ffor-14.c?ref=916c7a201a9a1dc94f2c056a773826a26d1daca9", "patch": "@@ -6,6 +6,8 @@ extern\n #endif\n void abort ();\n \n+#define DO_PRAGMA(x) _Pragma (#x)\n+#define OMPTEAMS DO_PRAGMA (omp teams)\n #define M(x, y, z) O(x, y, z)\n #define O(x, y, z) x ## _ ## y ## _ ## z\n \n@@ -77,33 +79,30 @@ int\n main ()\n {\n   int err = 0;\n-  #pragma omp teams reduction(|:err)\n-    {\n-      err |= test_d_normal ();\n-      err |= test_d_ds128_normal ();\n-      err |= test_ds_normal ();\n-      err |= test_ds_ds128_normal ();\n-      err |= test_dpf_static ();\n-      err |= test_dpf_static32 ();\n-      err |= test_dpf_auto ();\n-      err |= test_dpf_guided32 ();\n-      err |= test_dpf_runtime ();\n-      err |= test_dpf_ds128_static ();\n-      err |= test_dpf_ds128_static32 ();\n-      err |= test_dpf_ds128_auto ();\n-      err |= test_dpf_ds128_guided32 ();\n-      err |= test_dpf_ds128_runtime ();\n-      err |= test_dpfs_static ();\n-      err |= test_dpfs_static32 ();\n-      err |= test_dpfs_auto ();\n-      err |= test_dpfs_guided32 ();\n-      err |= test_dpfs_runtime ();\n-      err |= test_dpfs_ds128_static ();\n-      err |= test_dpfs_ds128_static32 ();\n-      err |= test_dpfs_ds128_auto ();\n-      err |= test_dpfs_ds128_guided32 ();\n-      err |= test_dpfs_ds128_runtime ();\n-    }\n+  err |= test_d_normal ();\n+  err |= test_d_ds128_normal ();\n+  err |= test_ds_normal ();\n+  err |= test_ds_ds128_normal ();\n+  err |= test_dpf_static ();\n+  err |= test_dpf_static32 ();\n+  err |= test_dpf_auto ();\n+  err |= test_dpf_guided32 ();\n+  err |= test_dpf_runtime ();\n+  err |= test_dpf_ds128_static ();\n+  err |= test_dpf_ds128_static32 ();\n+  err |= test_dpf_ds128_auto ();\n+  err |= test_dpf_ds128_guided32 ();\n+  err |= test_dpf_ds128_runtime ();\n+  err |= test_dpfs_static ();\n+  err |= test_dpfs_static32 ();\n+  err |= test_dpfs_auto ();\n+  err |= test_dpfs_guided32 ();\n+  err |= test_dpfs_runtime ();\n+  err |= test_dpfs_ds128_static ();\n+  err |= test_dpfs_ds128_static32 ();\n+  err |= test_dpfs_ds128_auto ();\n+  err |= test_dpfs_ds128_guided32 ();\n+  err |= test_dpfs_ds128_runtime ();\n   if (err)\n     abort ();\n   return 0;"}, {"sha": "f637fd3d760cc2b539765de10a67941fa0dd1071", "filename": "libgomp/testsuite/libgomp.c-c++-common/for-2.h", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/916c7a201a9a1dc94f2c056a773826a26d1daca9/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Ffor-2.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/916c7a201a9a1dc94f2c056a773826a26d1daca9/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Ffor-2.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Ffor-2.h?ref=916c7a201a9a1dc94f2c056a773826a26d1daca9", "patch": "@@ -14,6 +14,9 @@ noreturn (void)\n #ifndef OMPTGT\n #define OMPTGT\n #endif\n+#ifndef OMPTEAMS\n+#define OMPTEAMS\n+#endif\n #ifndef OMPTO\n #define OMPTO(v) do {} while (0)\n #endif\n@@ -214,31 +217,37 @@ N(test) (void)\n   for (i = 0; i < 1500; i++)\n     a[i] = i - 25;\n   OMPTO (a);\n+  OMPTEAMS\n   N(f0) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 23)\n       return 1;\n+  OMPTEAMS\n   N(f1) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 25)\n       return 1;\n+  OMPTEAMS\n   N(f2) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 29)\n       return 1;\n+  OMPTEAMS\n   N(f3) (1500LL - 1 - 23 - 48, -1LL + 25 - 48, 1LL);\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 22)\n       return 1;\n+  OMPTEAMS\n   N(f3) (1500LL - 1 - 23 - 48, 1500LL - 1, 7LL);\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 22)\n       return 1;\n+  OMPTEAMS\n   N(f4) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n@@ -249,44 +258,53 @@ N(test) (void)\n       for (k = 0; k < 10; k++)\n \tb[i][j][k] = i - 2.5 + 1.5 * j - 1.5 * k;\n   OMPTO (b);\n+  OMPTEAMS\n   N(f5) (0, 10, 0, 15, 0, 10, 1, 1, 1);\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f5) (0, 10, 30, 15, 0, 10, 4, 5, 6);\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f6) (9, -1, 29, 0, 9, -1, -1, -2, -1);\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i - 4.5 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f7) ();\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.0 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f8) ();\t  \n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.0 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f9) ();\n+  OMPTEAMS\n   N(f10) ();\n+  OMPTEAMS\n   N(f11) (10);\n+  OMPTEAMS\n   N(f12) (12);\n   OMPFROM (a);\n   OMPFROM (b);\n@@ -298,7 +316,9 @@ N(test) (void)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.0 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f13) ();\n+  OMPTEAMS\n   N(f14) ();\n   OMPFROM (a);\n   OMPFROM (b);\n@@ -507,26 +527,31 @@ N(test) (void)\n   for (i = 0; i < 1500; i++)\n     a[i] = i - 25;\n   OMPTO (a);\n+  OMPTEAMS\n   N(f20) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 23)\n       return 1;\n+  OMPTEAMS\n   N(f21) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 25)\n       return 1;\n+  OMPTEAMS\n   N(f22) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 29)\n       return 1;\n+  OMPTEAMS\n   N(f23) (1500LL - 1 - 23 - 48, -1LL + 25 - 48);\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n     if (a[i] != i - 22)\n       return 1;\n+  OMPTEAMS\n   N(f24) ();\n   OMPFROM (a);\n   for (i = 0; i < 1500; i++)\n@@ -537,44 +562,53 @@ N(test) (void)\n       for (k = 0; k < 10; k++)\n \tb[i][j][k] = i - 2.5 + 1.5 * j - 1.5 * k;\n   OMPTO (b);\n+  OMPTEAMS\n   N(f25) (0, 10, 0, 15, 0, 10, 1);\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f25) (0, 10, 30, 15, 0, 10, 5);\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f26) (9, -1, 29, 0, 9, -1, -2);\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i - 4.5 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f27) ();\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.0 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f28) ();\n   OMPFROM (b);\n   for (i = 0; i < 10; i++)\n     for (j = 0; j < 15; j++)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.0 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f29) ();\n+  OMPTEAMS\n   N(f30) ();\n+  OMPTEAMS\n   N(f31) (20);\n+  OMPTEAMS\n   N(f32) (12);\n   OMPFROM (a);\n   OMPFROM (b);\n@@ -586,7 +620,9 @@ N(test) (void)\n       for (k = 0; k < 10; k++)\n \tif (b[i][j][k] != i + 1.0 + 1.5 * j - 1.5 * k)\n \t  return 1;\n+  OMPTEAMS\n   N(f33) ();\n+  OMPTEAMS\n   N(f34) ();\n   OMPFROM (a);\n   OMPFROM (b);"}, {"sha": "34a9aa00ff72e35d8a018d00d31710575fca9cdd", "filename": "libgomp/testsuite/libgomp.c/teams-3.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/916c7a201a9a1dc94f2c056a773826a26d1daca9/libgomp%2Ftestsuite%2Flibgomp.c%2Fteams-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/916c7a201a9a1dc94f2c056a773826a26d1daca9/libgomp%2Ftestsuite%2Flibgomp.c%2Fteams-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fteams-3.c?ref=916c7a201a9a1dc94f2c056a773826a26d1daca9", "patch": "@@ -0,0 +1,20 @@\n+/* PR middle-end/96459 */\n+\n+#include <stdlib.h>\n+\n+int\n+main ()\n+{\n+  int niters = 0, i, j, k;\n+  #pragma omp teams reduction(+:niters)\n+  {\n+    #pragma omp distribute collapse(3)\n+    for (i = 0; i < 3; i++)\n+      for (j = 0; j < 8; j += 2)\n+\tfor (k = 0; k < 25; k += 3)\n+\t  niters++;\n+  }\n+  if (niters != 108)\n+    abort ();\n+  return 0;\n+}"}]}