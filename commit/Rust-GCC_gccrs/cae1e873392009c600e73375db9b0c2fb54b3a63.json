{"sha": "cae1e873392009c600e73375db9b0c2fb54b3a63", "node_id": "C_kwDOANBUbNoAKGNhZTFlODczMzkyMDA5YzYwMGU3MzM3NWRiOWIwYzJmYjU0YjNhNjM", "commit": {"author": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2022-04-22T10:15:52Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2022-04-22T10:31:58Z"}, "message": "privacy: visibility: Handle modules properly", "tree": {"sha": "4699739f860846f17bb7c2edb0f647c81408e869", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4699739f860846f17bb7c2edb0f647c81408e869"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/cae1e873392009c600e73375db9b0c2fb54b3a63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cae1e873392009c600e73375db9b0c2fb54b3a63", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cae1e873392009c600e73375db9b0c2fb54b3a63", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cae1e873392009c600e73375db9b0c2fb54b3a63/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7be856f7b6f39694f05c7c3453653046e48b3a52", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7be856f7b6f39694f05c7c3453653046e48b3a52", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7be856f7b6f39694f05c7c3453653046e48b3a52"}], "stats": {"total": 24, "additions": 19, "deletions": 5}, "files": [{"sha": "336d4d60da261e6b313c430422d1be145ddb3162", "filename": "gcc/rust/privacy/rust-visibility-resolver.cc", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cae1e873392009c600e73375db9b0c2fb54b3a63/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cae1e873392009c600e73375db9b0c2fb54b3a63/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.cc?ref=cae1e873392009c600e73375db9b0c2fb54b3a63", "patch": "@@ -25,14 +25,15 @@ namespace Privacy {\n \n VisibilityResolver::VisibilityResolver (Analysis::Mappings &mappings)\n   : mappings (mappings)\n-{\n-  // FIXME: Insert a top module (crate) inside the module_stack\n-  // FIXME: Insert the visibility of the crate in the mappings maybe?\n-}\n+{}\n \n void\n VisibilityResolver::go (HIR::Crate &crate)\n {\n+  module_stack.push_back (crate.get_mappings ().get_defid ());\n+  mappings.insert_visibility (crate.get_mappings ().get_defid (),\n+\t\t\t      ModuleVisibility::create_public ());\n+\n   for (auto &item : crate.items)\n     {\n       if (item->get_hir_kind () == HIR::Node::VIS_ITEM)\n@@ -74,7 +75,20 @@ VisibilityResolver::peek_module ()\n \n void\n VisibilityResolver::visit (HIR::Module &mod)\n-{}\n+{\n+  module_stack.push_back (mod.get_mappings ().get_defid ());\n+\n+  for (auto &item : mod.get_items ())\n+    {\n+      if (item->get_hir_kind () == HIR::Node::VIS_ITEM)\n+\t{\n+\t  auto vis_item = static_cast<HIR::VisItem *> (item.get ());\n+\t  vis_item->accept_vis (*this);\n+\t}\n+    }\n+\n+  module_stack.pop_back ();\n+}\n \n void\n VisibilityResolver::visit (HIR::ExternCrate &crate)"}]}