{"sha": "6b6a0f02ab7012daebd62726066b827fbdfa62f9", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmI2YTBmMDJhYjcwMTJkYWViZDYyNzI2MDY2YjgyN2ZiZGZhNjJmOQ==", "commit": {"author": {"name": "Dmitriy Anisimkov", "email": "anisimko@adacore.com", "date": "2018-12-11T11:10:53Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-12-11T11:10:53Z"}, "message": "[Ada] GNAT.Sockets: fix timeout computations for sockets\n\n2018-12-11  Dmitriy Anisimkov  <anisimko@adacore.com>\n\ngcc/ada/\n\n\t* libgnat/g-socket.ads, libgnat/g-socket.adb: Fix duration\n\tcomputations to be compatible with the type for socket timeouts\n\ton Windows.\n\nFrom-SVN: r266998", "tree": {"sha": "a57a2a3cec6991917ae670b0235aa504f2f1fd13", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a57a2a3cec6991917ae670b0235aa504f2f1fd13"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6b6a0f02ab7012daebd62726066b827fbdfa62f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6b6a0f02ab7012daebd62726066b827fbdfa62f9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6b6a0f02ab7012daebd62726066b827fbdfa62f9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6b6a0f02ab7012daebd62726066b827fbdfa62f9/comments", "author": {"login": "anisimkov", "id": 15864134, "node_id": "MDQ6VXNlcjE1ODY0MTM0", "avatar_url": "https://avatars.githubusercontent.com/u/15864134?v=4", "gravatar_id": "", "url": "https://api.github.com/users/anisimkov", "html_url": "https://github.com/anisimkov", "followers_url": "https://api.github.com/users/anisimkov/followers", "following_url": "https://api.github.com/users/anisimkov/following{/other_user}", "gists_url": "https://api.github.com/users/anisimkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/anisimkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/anisimkov/subscriptions", "organizations_url": "https://api.github.com/users/anisimkov/orgs", "repos_url": "https://api.github.com/users/anisimkov/repos", "events_url": "https://api.github.com/users/anisimkov/events{/privacy}", "received_events_url": "https://api.github.com/users/anisimkov/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "371e21cf9020cd4278e98bfeee17086dc39e2723", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/371e21cf9020cd4278e98bfeee17086dc39e2723", "html_url": "https://github.com/Rust-GCC/gccrs/commit/371e21cf9020cd4278e98bfeee17086dc39e2723"}], "stats": {"total": 68, "additions": 52, "deletions": 16}, "files": [{"sha": "34c3a2fad4a3994d4b8153a9064817f867db7620", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6b6a0f02ab7012daebd62726066b827fbdfa62f9/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6b6a0f02ab7012daebd62726066b827fbdfa62f9/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=6b6a0f02ab7012daebd62726066b827fbdfa62f9", "patch": "@@ -1,3 +1,9 @@\n+2018-12-11  Dmitriy Anisimkov  <anisimko@adacore.com>\n+\n+\t* libgnat/g-socket.ads, libgnat/g-socket.adb: Fix duration\n+\tcomputations to be compatible with the type for socket timeouts\n+\ton Windows.\n+\n 2018-12-11  Gary Dismukes  <dismukes@adacore.com>\n \n \t* exp_util.ads: Use preferred U.S. spelling of \"honored\"."}, {"sha": "2a5047d399c3dfd898b18ad4f0a685693a40367d", "filename": "gcc/ada/libgnat/g-socket.adb", "status": "modified", "additions": 39, "deletions": 14, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6b6a0f02ab7012daebd62726066b827fbdfa62f9/gcc%2Fada%2Flibgnat%2Fg-socket.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6b6a0f02ab7012daebd62726066b827fbdfa62f9/gcc%2Fada%2Flibgnat%2Fg-socket.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-socket.adb?ref=6b6a0f02ab7012daebd62726066b827fbdfa62f9", "patch": "@@ -1154,10 +1154,12 @@ package body GNAT.Sockets is\n       Optname : Interfaces.C.int := -1) return Option_Type\n    is\n       use SOSC;\n+      use type C.unsigned;\n       use type C.unsigned_char;\n \n       V8  : aliased Two_Ints;\n       V4  : aliased C.int;\n+      U4  : aliased C.unsigned;\n       V1  : aliased C.unsigned_char;\n       VT  : aliased Timeval;\n       Len : aliased C.int;\n@@ -1207,8 +1209,8 @@ package body GNAT.Sockets is\n             --  a DWORD.\n \n             if Target_OS = Windows then\n-               Len := V4'Size / 8;\n-               Add := V4'Address;\n+               Len := U4'Size / 8;\n+               Add := U4'Address;\n \n             else\n                Len := VT'Size / 8;\n@@ -1286,10 +1288,10 @@ package body GNAT.Sockets is\n                --  Timeout is in milliseconds, actual value is 500 ms +\n                --  returned value (unless it is 0).\n \n-               if V4 = 0 then\n+               if U4 = 0 then\n                   Opt.Timeout := 0.0;\n                else\n-                  Opt.Timeout := Natural (V4) * 0.001 + 0.500;\n+                  Opt.Timeout :=  Duration (U4) / 1000 + 0.500;\n                end if;\n \n             else\n@@ -2293,9 +2295,11 @@ package body GNAT.Sockets is\n       Option : Option_Type)\n    is\n       use SOSC;\n+      use type C.unsigned;\n \n       V8  : aliased Two_Ints;\n       V4  : aliased C.int;\n+      U4  : aliased C.unsigned;\n       V1  : aliased C.unsigned_char;\n       VT  : aliased Timeval;\n       Len : C.int;\n@@ -2376,17 +2380,17 @@ package body GNAT.Sockets is\n                --  the actual timeout is 500 ms + the given value (unless it\n                --  is 0).\n \n-               V4 := C.int (Option.Timeout / 0.001);\n+               U4 := C.unsigned (Option.Timeout / 0.001);\n \n-               if V4 > 500 then\n-                  V4 := V4 - 500;\n+               if U4 > 500 then\n+                  U4 := U4 - 500;\n \n-               elsif V4 > 0 then\n-                  V4 := 1;\n+               elsif U4 > 0 then\n+                  U4 := 1;\n                end if;\n \n-               Len := V4'Size / 8;\n-               Add := V4'Address;\n+               Len := U4'Size / 8;\n+               Add := U4'Address;\n \n             else\n                VT  := To_Timeval (Option.Timeout);\n@@ -2509,8 +2513,24 @@ package body GNAT.Sockets is\n    -----------------\n \n    function To_Duration (Val : Timeval) return Timeval_Duration is\n-   begin\n-      return Natural (Val.Tv_Sec) * 1.0 + Natural (Val.Tv_Usec) * 1.0E-6;\n+      Max_D : constant Long_Long_Integer := Long_Long_Integer (Forever - 0.5);\n+      Tv_sec_64 : constant Boolean := SOSC.SIZEOF_tv_sec = 8;\n+      --  Need to separate this condition into the constant declaration to\n+      --  avoid GNAT warning about \"always true\" or \"always false\".\n+   begin\n+      if Tv_sec_64 then\n+         --  Check for possible Duration overflow when Tv_Sec field is 64 bit\n+         --  integer.\n+\n+         if Val.Tv_Sec > time_t (Max_D) or else\n+            (Val.Tv_Sec = time_t (Max_D) and then\n+             Val.Tv_Usec > suseconds_t ((Forever - Duration (Max_D)) * 1E6))\n+         then\n+            return Forever;\n+         end if;\n+      end if;\n+\n+      return Duration (Val.Tv_Sec) + Duration (Val.Tv_Usec) * 1.0E-6;\n    end To_Duration;\n \n    -------------------\n@@ -2701,7 +2721,12 @@ package body GNAT.Sockets is\n \n       else\n          S  := time_t (Val - 0.5);\n-         uS := suseconds_t (1_000_000 * (Val - Selector_Duration (S)));\n+         uS := suseconds_t (1_000_000 * (Val - Selector_Duration (S)) - 0.5);\n+\n+         if uS = -1 then\n+            --  It happen on integer duration\n+            uS := 0;\n+         end if;\n       end if;\n \n       return (S, uS);"}, {"sha": "964a180d9813c5721de420d529b65a8ab6bf71b3", "filename": "gcc/ada/libgnat/g-socket.ads", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6b6a0f02ab7012daebd62726066b827fbdfa62f9/gcc%2Fada%2Flibgnat%2Fg-socket.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6b6a0f02ab7012daebd62726066b827fbdfa62f9/gcc%2Fada%2Flibgnat%2Fg-socket.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-socket.ads?ref=6b6a0f02ab7012daebd62726066b827fbdfa62f9", "patch": "@@ -433,8 +433,13 @@ package GNAT.Sockets is\n    Immediate : constant Duration := 0.0;\n \n    Forever : constant Duration :=\n-               Duration'Min (Duration'Last, 1.0 * SOSC.MAX_tv_sec);\n-   --  Largest possible Duration that is also a valid value for struct timeval\n+               Duration'Min\n+                 (Duration'Last,\n+                  (if SOSC.\"=\" (SOSC.Target_OS, SOSC.Windows)\n+                   then Duration (2 ** 32 / 1000)\n+                   else 1.0 * SOSC.MAX_tv_sec));\n+   --  Largest possible Duration that is also a valid value for the OS type\n+   --  used for socket timeout.\n \n    subtype Timeval_Duration is Duration range Immediate .. Forever;\n "}]}