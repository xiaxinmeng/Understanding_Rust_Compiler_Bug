{"sha": "3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2E4MTczNWMxYzhjZWE0MzIzZGNiOTEyYjdhODg3OWI1NGFhM2JjMA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-05-25T09:07:01Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-05-25T09:07:01Z"}, "message": "openmp: Fix reduction clause handling on teams distribute simd [PR99928]\n\nWhen a directive isn't combined with worksharing-loop, it takes much\nsimpler clause splitting path for reduction, and that one was missing\nhandling of teams when combined with simd.\n\n2021-05-25  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR middle-end/99928\ngcc/c-family/\n\t* c-omp.c (c_omp_split_clauses): Copy reduction to teams when teams is\n\tcombined with simd and not with taskloop or for.\ngcc/testsuite/\n\t* c-c++-common/gomp/pr99928-8.c: Remove xfails from omp teams r21 and\n\tr28 checks.\n\t* c-c++-common/gomp/pr99928-9.c: Likewise.\n\t* c-c++-common/gomp/pr99928-10.c: Likewise.\nlibgomp/\n\t* testsuite/libgomp.c-c++-common/reduction-17.c: New test.", "tree": {"sha": "ccc0b37c2911dbc11dde0df1f06666332e66eee2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ccc0b37c2911dbc11dde0df1f06666332e66eee2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9aecba04f4da35bd2bc7c2de76892e88cc7421ac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9aecba04f4da35bd2bc7c2de76892e88cc7421ac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9aecba04f4da35bd2bc7c2de76892e88cc7421ac"}], "stats": {"total": 45, "additions": 39, "deletions": 6}, "files": [{"sha": "1b4a1124c2507d62d215a99cbadf6ad165e7b4f7", "filename": "gcc/c-family/c-omp.c", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Fc-family%2Fc-omp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Fc-family%2Fc-omp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-omp.c?ref=3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "patch": "@@ -2059,6 +2059,23 @@ c_omp_split_clauses (location_t loc, enum tree_code code,\n \t\t  OMP_CLAUSE_CHAIN (c) = cclauses[C_OMP_CLAUSE_SPLIT_TASKLOOP];\n \t\t  cclauses[C_OMP_CLAUSE_SPLIT_TASKLOOP] = c;\n \t\t}\n+\t      else if ((mask & (OMP_CLAUSE_MASK_1\n+\t\t\t\t<< PRAGMA_OMP_CLAUSE_NUM_TEAMS)) != 0)\n+\t\t{\n+\t\t  c = build_omp_clause (OMP_CLAUSE_LOCATION (clauses),\n+\t\t\t\t\tOMP_CLAUSE_REDUCTION);\n+\t\t  OMP_CLAUSE_DECL (c) = OMP_CLAUSE_DECL (clauses);\n+\t\t  OMP_CLAUSE_REDUCTION_CODE (c)\n+\t\t    = OMP_CLAUSE_REDUCTION_CODE (clauses);\n+\t\t  OMP_CLAUSE_REDUCTION_PLACEHOLDER (c)\n+\t\t    = OMP_CLAUSE_REDUCTION_PLACEHOLDER (clauses);\n+\t\t  OMP_CLAUSE_REDUCTION_DECL_PLACEHOLDER (c)\n+\t\t    = OMP_CLAUSE_REDUCTION_DECL_PLACEHOLDER (clauses);\n+\t\t  OMP_CLAUSE_REDUCTION_INSCAN (c)\n+\t\t    = OMP_CLAUSE_REDUCTION_INSCAN (clauses);\n+\t\t  OMP_CLAUSE_CHAIN (c) = cclauses[C_OMP_CLAUSE_SPLIT_TEAMS];\n+\t\t  cclauses[C_OMP_CLAUSE_SPLIT_TEAMS] = c;\n+\t\t}\n \t      s = C_OMP_CLAUSE_SPLIT_SIMD;\n \t    }\n \t  else"}, {"sha": "d2987a1d9b46915494f1543466c0ad3972019449", "filename": "gcc/testsuite/c-c++-common/gomp/pr99928-10.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-10.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-10.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-10.c?ref=3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "patch": "@@ -165,7 +165,7 @@ bar (void)\n   /* { dg-final { scan-tree-dump \"omp target\\[^\\n\\r]*map\\\\(tofrom:\\\\\\*_\\[0-9]* \\\\\\[len: 92\\\\\\]\" \"gimple\" { xfail *-*-* } } } */\n   /* { dg-final { scan-tree-dump \"omp target\\[^\\n\\r]*map\\\\(firstprivate:r21 \\\\\\[pointer assign, bias: 4\\\\\\]\\\\)\" \"gimple\" { xfail *-*-* } } } */\n   /* { dg-final { scan-tree-dump-not \"omp target\\[^\\n\\r]*firstprivate\\\\(r21\\\\)\" \"gimple\" } } */\n-  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r21 \\\\+ 4\" \"gimple\" { xfail *-*-* } } } */\n+  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r21 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump-not \"omp distribute\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r21 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump \"omp simd\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r21 \\\\+ 4\" \"gimple\" } } */\n   #pragma omp target teams distribute simd reduction(+:r21[1:23])\n@@ -214,7 +214,7 @@ bar (void)\n   #pragma omp teams distribute parallel for simd reduction(+:r27[1:29])\n   for (int i = 0; i < 64; i++)\n     r27[1]++;\n-  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r28 \\\\+ 4\" \"gimple\" { xfail *-*-* } } } */\n+  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r28 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump-not \"omp distribute\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r28 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump \"omp simd\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*\\\\)r28 \\\\+ 4\" \"gimple\" } } */\n   #pragma omp teams distribute simd reduction(+:r28[1:30])"}, {"sha": "fc57573eaf5dd4c778ccbd97a9fa74b4a6e543ef", "filename": "gcc/testsuite/c-c++-common/gomp/pr99928-8.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-8.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-8.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-8.c?ref=3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "patch": "@@ -155,7 +155,7 @@ bar (void)\n     r20++;\n   /* { dg-final { scan-tree-dump \"omp target\\[^\\n\\r]*map\\\\(tofrom:r21\" \"gimple\" { xfail *-*-* } } } */\n   /* { dg-final { scan-tree-dump-not \"omp target\\[^\\n\\r]*firstprivate\\\\(r21\\\\)\" \"gimple\" { xfail *-*-* } } } */\n-  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:r21\\\\)\" \"gimple\" { xfail *-*-* } } } */\n+  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:r21\\\\)\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump-not \"omp distribute\\[^\\n\\r]*reduction\\\\(\\\\+:r21\\\\)\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump \"omp simd\\[^\\n\\r]*reduction\\\\(\\\\+:r21\\\\)\" \"gimple\" } } */\n   #pragma omp target teams distribute simd reduction(+:r21)\n@@ -202,7 +202,7 @@ bar (void)\n   #pragma omp teams distribute parallel for simd reduction(+:r27)\n   for (int i = 0; i < 64; i++)\n     r27++;\n-  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:r28\\\\)\" \"gimple\" { xfail *-*-* } } } */\n+  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:r28\\\\)\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump-not \"omp distribute\\[^\\n\\r]*reduction\\\\(\\\\+:r28\\\\)\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump \"omp simd\\[^\\n\\r]*reduction\\\\(\\\\+:r28\\\\)\" \"gimple\" } } */\n   #pragma omp teams distribute simd reduction(+:r28)"}, {"sha": "c049bb0d2575a8c25a0addeb9d21171f961d3a22", "filename": "gcc/testsuite/c-c++-common/gomp/pr99928-9.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-9.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-9.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99928-9.c?ref=3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "patch": "@@ -155,7 +155,7 @@ bar (void)\n     r20[1]++;\n   /* { dg-final { scan-tree-dump \"omp target\\[^\\n\\r]*map\\\\(tofrom:r21\\\\\\[1\\\\\\] \\\\\\[len: 8\\\\\\]\" \"gimple\" { xfail *-*-* } } } */\n   /* { dg-final { scan-tree-dump-not \"omp target\\[^\\n\\r]*firstprivate\\\\(r21\\\\)\" \"gimple\" } } */\n-  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r21 \\\\+ 4\" \"gimple\" { xfail *-*-* } } } */\n+  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r21 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump-not \"omp distribute\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r21 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump \"omp simd\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r21 \\\\+ 4\" \"gimple\" } } */\n   #pragma omp target teams distribute simd reduction(+:r21[1:2])\n@@ -202,7 +202,7 @@ bar (void)\n   #pragma omp teams distribute parallel for simd reduction(+:r27[1:2])\n   for (int i = 0; i < 64; i++)\n     r27[1]++;\n-  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r28 \\\\+ 4\" \"gimple\" { xfail *-*-* } } } */\n+  /* { dg-final { scan-tree-dump \"omp teams\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r28 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump-not \"omp distribute\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r28 \\\\+ 4\" \"gimple\" } } */\n   /* { dg-final { scan-tree-dump \"omp simd\\[^\\n\\r]*reduction\\\\(\\\\+:MEM\\[^\\n\\r]*&r28 \\\\+ 4\" \"gimple\" } } */\n   #pragma omp teams distribute simd reduction(+:r28[1:2])"}, {"sha": "5e680d69cfa6337ebb86e98f7ea8241ee419a628", "filename": "libgomp/testsuite/libgomp.c-c++-common/reduction-17.c", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Freduction-17.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a81735c1c8cea4323dcb912b7a8879b54aa3bc0/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Freduction-17.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c-c%2B%2B-common%2Freduction-17.c?ref=3a81735c1c8cea4323dcb912b7a8879b54aa3bc0", "patch": "@@ -0,0 +1,16 @@\n+/* PR middle-end/99928 */\n+/* { dg-do run } */\n+\n+#define N 64\n+\n+int\n+main ()\n+{\n+  int r = 0, i;\n+  #pragma omp teams distribute simd reduction(+:r)\n+  for (i = 0; i < N; i++)\n+    r += i;\n+  if (r != N * (N - 1) / 2)\n+    __builtin_abort ();\n+  return 0;\n+}"}]}