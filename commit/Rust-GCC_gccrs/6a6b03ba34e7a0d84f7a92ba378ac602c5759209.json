{"sha": "6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmE2YjAzYmEzNGU3YTBkODRmN2E5MmJhMzc4YWM2MDJjNTc1OTIwOQ==", "commit": {"author": {"name": "Christian Bruel", "email": "christian.bruel@st.com", "date": "2015-01-06T11:59:09Z"}, "committer": {"name": "Christian Bruel", "email": "chrbr@gcc.gnu.org", "date": "2015-01-06T11:59:09Z"}, "message": "re PR target/64507 (SH inlined builtin strncmp doesn't return 0 for 0 length)\n\nPR target/64507\n* config/sh/sh-mem.cc (sh_expand_cmpnstr): Check 0 length.\n\nFrom-SVN: r219257", "tree": {"sha": "c3bd3725766aa1b76d30e5723876482626311803", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c3bd3725766aa1b76d30e5723876482626311803"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/comments", "author": null, "committer": null, "parents": [{"sha": "e4a5735015888eaea5ec6964a3d879a1e61ea75a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e4a5735015888eaea5ec6964a3d879a1e61ea75a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e4a5735015888eaea5ec6964a3d879a1e61ea75a"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "7423db3589b96d46c85d88f99c00c8635500cdd1", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "patch": "@@ -1,3 +1,8 @@\n+2015-01-08  Christian Bruel  <christian.bruel@st.com>\n+\n+\tPR target/64507\n+\t* config/sh/sh-mem.cc (sh_expand_cmpnstr): Check 0 length.\n+\n 2015-01-06  Thomas Preud'homme  <thomas.preudhomme@arm.com>\n \n \tPR tree-optimization/63259"}, {"sha": "3d61c2adc81790e892bd70ae4acba9c4c00832f3", "filename": "gcc/config/sh/sh-mem.cc", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2Fconfig%2Fsh%2Fsh-mem.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2Fconfig%2Fsh%2Fsh-mem.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fsh%2Fsh-mem.cc?ref=6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "patch": "@@ -421,6 +421,7 @@ sh_expand_cmpnstr (rtx *operands)\n \t  /* end loop.  Reached max iterations.  */\n \t  if (sbytes == 0)\n \t    {\n+\t      emit_insn (gen_subsi3 (operands[0], tmp1, tmp2));\n \t      jump = emit_jump_insn (gen_jump_compact (L_return));\n \t      emit_barrier_after (jump);\n \t    }\n@@ -496,6 +497,13 @@ sh_expand_cmpnstr (rtx *operands)\n       jump = emit_jump_insn (gen_jump_compact( L_end_loop_byte));\n       emit_barrier_after (jump);\n     }\n+  else\n+    {\n+      emit_insn (gen_cmpeqsi_t (len, const0_rtx));\n+      emit_move_insn (operands[0], const0_rtx);\n+      jump = emit_jump_insn (gen_branch_true (L_return));\n+      add_int_reg_note (jump, REG_BR_PROB, prob_unlikely);\n+    }\n \n   addr1 = adjust_automodify_address (addr1, QImode, s1_addr, 0);\n   addr2 = adjust_automodify_address (addr2, QImode, s2_addr, 0);\n@@ -536,10 +544,10 @@ sh_expand_cmpnstr (rtx *operands)\n     emit_insn (gen_zero_extendqisi2 (tmp2, gen_lowpart (QImode, tmp2)));\n   emit_insn (gen_zero_extendqisi2 (tmp1, gen_lowpart (QImode, tmp1)));\n \n-  emit_label (L_return);\n-\n   emit_insn (gen_subsi3 (operands[0], tmp1, tmp2));\n \n+  emit_label (L_return);\n+\n   return true;\n }\n "}, {"sha": "63eeda9cec2a7b3028a62814e244fdbac066d6a1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "patch": "@@ -1,3 +1,8 @@\n+2015-01-08  Christian Bruel  <christian.bruel@st.com>\n+\n+\tPR target/64507\n+\t* gcc.target/sh/pr64507.c: New test.\n+\n 2015-01-06  Arnaud Charlet  <charlet@adacore.com>\n \n \t* gnat.db/fixce.adb, gnat.db/specs/delta_small.ads: Kill warnings."}, {"sha": "d3d93849bd3744271133166e1d9770369d4fc7fd", "filename": "gcc/testsuite/gcc.target/sh/pr64507.c", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2Ftestsuite%2Fgcc.target%2Fsh%2Fpr64507.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a6b03ba34e7a0d84f7a92ba378ac602c5759209/gcc%2Ftestsuite%2Fgcc.target%2Fsh%2Fpr64507.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fsh%2Fpr64507.c?ref=6a6b03ba34e7a0d84f7a92ba378ac602c5759209", "patch": "@@ -0,0 +1,25 @@\n+/* Check that the __builtin_strnlen returns 0 with with \n+   non-constant 0 length.  */\n+/* { dg-do run } */\n+/* { dg-options \"-O2\" } */\n+\n+extern int snprintf(char *, int, const char *, ...);\n+extern void abort (void);\n+\n+int main()\n+ {\n+   int i;\n+   int cmp = 0;\n+   char buffer[1024];\n+   const char* s = \"the string\";\n+\n+   snprintf(buffer, 4, \"%s\", s);\n+\n+   for (i = 1; i < 4; i++)\n+     cmp += __builtin_strncmp(buffer, s, i - 1);\n+\n+  if (cmp)\n+    abort();\n+\n+  return 0;\n+}"}]}