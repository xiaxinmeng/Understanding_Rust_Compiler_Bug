{"sha": "686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njg2ZGNhNzYxMmE4YWI1ZWJlYmFkMmZjMTNiZDllYTc3OTNhN2U0MA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2018-07-31T14:19:26Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2018-07-31T14:19:26Z"}, "message": "P1008R1 - prohibit aggregates with user-declared constructors\n\n\tP1008R1 - prohibit aggregates with user-declared constructors\n\t* class.c (check_bases_and_members): For C++2a set\n\tCLASSTYPE_NON_AGGREGATE based on TYPE_HAS_USER_CONSTRUCTOR rather than\n\ttype_has_user_provided_or_explicit_constructor.\n\n\t* g++.dg/ext/is_aggregate.C: Add tests with deleted or defaulted ctor.\n\t* g++.dg/cpp0x/defaulted1.C (main): Ifdef out for C++2a B b = {1};.\n\t* g++.dg/cpp0x/deleted2.C: Expect error for C++2a.\n\t* g++.dg/cpp2a/aggr1.C: New test.\n\t* g++.dg/cpp2a/aggr2.C: New test.\n\nFrom-SVN: r263115", "tree": {"sha": "219af350267ed3b842757bed1fbe2a10d182b37a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/219af350267ed3b842757bed1fbe2a10d182b37a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "html_url": "https://github.com/Rust-GCC/gccrs/commit/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "8810325ff666643de80110c5c6b4ce1cef921e1b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8810325ff666643de80110c5c6b4ce1cef921e1b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8810325ff666643de80110c5c6b4ce1cef921e1b"}], "stats": {"total": 75, "additions": 73, "deletions": 2}, "files": [{"sha": "bf6ce9761acb410de173674edaa2223391c8a321", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -1,3 +1,10 @@\n+2018-07-31  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tP1008R1 - prohibit aggregates with user-declared constructors\n+\t* class.c (check_bases_and_members): For C++2a set\n+\tCLASSTYPE_NON_AGGREGATE based on TYPE_HAS_USER_CONSTRUCTOR rather than\n+\ttype_has_user_provided_or_explicit_constructor.\n+\n 2018-07-31  Martin Liska  <mliska@suse.cz>\n \n         PR c++/86653"}, {"sha": "c03a82b44f89661b80aed7c15713048512cc4abe", "filename": "gcc/cp/class.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -5571,7 +5571,9 @@ check_bases_and_members (tree t)\n      Again, other conditions for being an aggregate are checked\n      elsewhere.  */\n   CLASSTYPE_NON_AGGREGATE (t)\n-    |= (type_has_user_provided_or_explicit_constructor (t)\n+    |= ((cxx_dialect < cxx2a\n+\t ? type_has_user_provided_or_explicit_constructor (t)\n+\t : TYPE_HAS_USER_CONSTRUCTOR (t))\n \t|| TYPE_POLYMORPHIC_P (t));\n   /* This is the C++98/03 definition of POD; it changed in C++0x, but we\n      retain the old definition internally for ABI reasons.  */"}, {"sha": "90fb9c19a40d950bff85946b568cc2029136edd8", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -1,3 +1,12 @@\n+2018-07-31  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tP1008R1 - prohibit aggregates with user-declared constructors\n+\t* g++.dg/ext/is_aggregate.C: Add tests with deleted or defaulted ctor.\n+\t* g++.dg/cpp0x/defaulted1.C (main): Ifdef out for C++2a B b = {1};.\n+\t* g++.dg/cpp0x/deleted2.C: Expect error for C++2a.\n+\t* g++.dg/cpp2a/aggr1.C: New test.\n+\t* g++.dg/cpp2a/aggr2.C: New test.\n+\n 2018-07-31  Segher Boessenkool  <segher@kernel.crashing.org>\n \n \tPR target/86640"}, {"sha": "0ed81fb26a9e076abdc057d877cffed9cc5dc7b1", "filename": "gcc/testsuite/g++.dg/cpp0x/defaulted1.C", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdefaulted1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdefaulted1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdefaulted1.C?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -23,7 +23,9 @@ struct B\n int main()\n {\n   A a1, a2;\n+#if __cplusplus <= 201703L\n   B b = {1};\n+#endif\n   a1 = a2;\n }\n "}, {"sha": "5576be33bef819b092d2b0b3526d770a219e1f6f", "filename": "gcc/testsuite/g++.dg/cpp0x/deleted2.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdeleted2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdeleted2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fdeleted2.C?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -6,4 +6,4 @@ struct A {\n  A() = delete;\n };\n \n-A a = {1};\n+A a = {1};\t// { dg-error \"could not convert\" \"\" { target c++2a } }"}, {"sha": "73a257cead9dd400fb10e6d456ccd9c4431d732d", "filename": "gcc/testsuite/g++.dg/cpp2a/aggr1.C", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Faggr1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Faggr1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Faggr1.C?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -0,0 +1,15 @@\n+// { dg-do compile { target c++11 } }\n+struct A {\n+  A () = delete;\t// { dg-message \"declared here\" \"\" { target c++2a } }\n+};\n+struct B {\n+  B () = default;\n+  int b = 0;\n+};\n+struct C {\n+  C (C&&) = default;\t// { dg-message \"candidate\" \"\" { target c++2a } }\n+  int c, d;\n+};\n+A a {};\t\t\t// { dg-error \"use of deleted function\" \"\" { target c++2a } }\n+B b = {1};\t\t// { dg-error \"could not convert\" \"\" { target { c++11_only || c++2a } } }\n+C *c = new C {2, 3};\t// { dg-error \"no matching function for call to\" \"\" { target c++2a } }"}, {"sha": "e774be7ec2fb899a4868549acb7b6ba6af5b914e", "filename": "gcc/testsuite/g++.dg/cpp2a/aggr2.C", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Faggr2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Faggr2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Faggr2.C?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -0,0 +1,25 @@\n+// { dg-do run { target c++11 } }\n+\n+struct A;\n+struct B { operator A (); };\n+struct A { A (const A &) = default; A () = default; B a; };\n+A a {B {}};\n+bool seen;\n+\n+B::operator A ()\n+{\n+  seen = true;\n+  return A ();\n+}\n+\n+int\n+main ()\n+{\n+#if __cplusplus > 201703L\n+  if (!seen)\n+    __builtin_abort ();\n+#else\n+  if (seen)\n+    __builtin_abort ();\n+#endif\n+}"}, {"sha": "bdcc70fa7c228092e4d86998fcbbb4fd3f8c07d0", "filename": "gcc/testsuite/g++.dg/ext/is_aggregate.C", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fis_aggregate.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/686dca7612a8ab5ebebad2fc13bd9ea7793a7e40/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fis_aggregate.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fis_aggregate.C?ref=686dca7612a8ab5ebebad2fc13bd9ea7793a7e40", "patch": "@@ -61,6 +61,8 @@ struct K { int a, b; virtual void foo (); };\n struct L : virtual public A { int d, e; };\n struct M : protected A { int d, e; };\n struct N : private A { int d, e; };\n+struct O { O () = delete; int a, b, c; };\n+struct P { P () = default; int a, b, c; };\n typedef int T;\n typedef float U;\n typedef int V __attribute__((vector_size (4 * sizeof (int))));\n@@ -94,6 +96,13 @@ main ()\n   assert (NTEST (L));\n   assert (NTEST (M));\n   assert (NTEST (N));\n+#if __cplusplus > 201703L\n+  assert (NTEST (O));\n+  assert (NTEST (P));\n+#else\n+  assert (PTEST (O));\n+  assert (PTEST (P));\n+#endif\n   assert (PTEST (int[]));\n   assert (PTEST (double[]));\n   assert (PTEST (T[2]));\n@@ -114,4 +123,6 @@ main ()\n   assert (PTEST (L[]));\n   assert (PTEST (M[6]));\n   assert (PTEST (N[]));\n+  assert (PTEST (O[]));\n+  assert (PTEST (P[]));\n }"}]}