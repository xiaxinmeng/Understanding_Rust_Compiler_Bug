{"sha": "d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDQwMTUwY2MzYzFlODVhOWNiYmFlYmIyNjc5YjZiYWM3YTYyZWNiYw==", "commit": {"author": {"name": "Jerry DeLisle", "email": "jvdelisle@gcc.gnu.org", "date": "2007-07-15T05:29:29Z"}, "committer": {"name": "Jerry DeLisle", "email": "jvdelisle@gcc.gnu.org", "date": "2007-07-15T05:29:29Z"}, "message": "re PR libfortran/32752 (Segfault on WRITE with modified unix_stream structure)\n\n2007-07-14  Jerry DeLisle  <jvdelisle@gcc.gnu.org>\n\n\tPR libgfortran/32752\n\t* io/unix.c (unix_stream): Move buffer pointer adjacent to small_buffer.\n\t* io/transfer.c (formatted_transfer_scalar): If stream I/O, set\n\tbytes_used to zero. Fix off by one error in calculation of pos and\n\tskips. Eliminate duplicate pending_spaces check.\n\nFrom-SVN: r126652", "tree": {"sha": "df8dbebd175229f5dd9969678dbf00c011fd21d9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/df8dbebd175229f5dd9969678dbf00c011fd21d9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/comments", "author": null, "committer": null, "parents": [{"sha": "6816e2e17db97a384cac3f66247a4acb37c4432a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6816e2e17db97a384cac3f66247a4acb37c4432a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6816e2e17db97a384cac3f66247a4acb37c4432a"}], "stats": {"total": 25, "additions": 17, "deletions": 8}, "files": [{"sha": "25bb24bfb1951a6d91c1ab3fb527b319232e7bb8", "filename": "libgfortran/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/libgfortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/libgfortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2FChangeLog?ref=d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "patch": "@@ -1,3 +1,11 @@\n+2007-07-14  Jerry DeLisle  <jvdelisle@gcc.gnu.org>\n+\n+\tPR libgfortran/32752\n+\t* io/unix.c (unix_stream): Move buffer pointer adjacent to small_buffer.\n+\t* io/transfer.c (formatted_transfer_scalar): If stream I/O, set\n+\tbytes_used to zero. Fix off by one error in calculation of pos and\n+\tskips. Eliminate duplicate pending_spaces check.\n+\n 2007-07-15  Francois-Xavier Coudert  <fxcoudert@gcc.gnu.org>\n \n \tPR fortran/32357"}, {"sha": "067a065f9cfcb37045c5b36205aef0dda4272e9f", "filename": "libgfortran/io/transfer.c", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/libgfortran%2Fio%2Ftransfer.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/libgfortran%2Fio%2Ftransfer.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fio%2Ftransfer.c?ref=d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "patch": "@@ -949,7 +949,10 @@ formatted_transfer_scalar (st_parameter_dt *dtp, bt type, void *p, int len,\n \t}\n \n       bytes_used = (int)(dtp->u.p.current_unit->recl\n-\t\t\t - dtp->u.p.current_unit->bytes_left);\n+\t\t   - dtp->u.p.current_unit->bytes_left);\n+\n+      if (is_stream_io(dtp))\n+\tbytes_used = 0;\n \n       switch (t)\n \t{\n@@ -1156,9 +1159,9 @@ formatted_transfer_scalar (st_parameter_dt *dtp, bt type, void *p, int len,\n \tcase FMT_TR:\n \t  consume_data_flag = 0;\n \n-\t  pos = bytes_used + f->u.n + dtp->u.p.skips;\n-\t  dtp->u.p.skips = f->u.n + dtp->u.p.skips;\n-\t  dtp->u.p.pending_spaces = pos - dtp->u.p.max_pos;\n+\t  dtp->u.p.skips += f->u.n;\n+\t  pos = bytes_used + dtp->u.p.skips - 1;\n+\t  dtp->u.p.pending_spaces = pos - dtp->u.p.max_pos + 1;\n \n \t  /* Writes occur just before the switch on f->format, above, so\n \t     that trailing blanks are suppressed, unless we are doing a\n@@ -1188,8 +1191,6 @@ formatted_transfer_scalar (st_parameter_dt *dtp, bt type, void *p, int len,\n \t      if (bytes_used == 0)\n \t\t{\n \t\t  dtp->u.p.pending_spaces -= f->u.n;\n-\t\t  dtp->u.p.pending_spaces = dtp->u.p.pending_spaces < 0 ? 0\n-\t\t\t\t\t    : dtp->u.p.pending_spaces;\n \t\t  dtp->u.p.skips -= f->u.n;\n \t\t  dtp->u.p.skips = dtp->u.p.skips < 0 ? 0 : dtp->u.p.skips;\n \t\t}"}, {"sha": "ded0d053d9ce5ed4f95bcaddfdd28e6ed973a260", "filename": "libgfortran/io/unix.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/libgfortran%2Fio%2Funix.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc/libgfortran%2Fio%2Funix.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fio%2Funix.c?ref=d40150cc3c1e85a9cbbaebb2679b6bac7a62ecbc", "patch": "@@ -97,7 +97,6 @@ typedef struct\n   gfc_offset dirty_offset;\t/* Start of modified bytes in buffer */\n   gfc_offset file_length;\t/* Length of the file, -1 if not seekable. */\n \n-  char *buffer;\n   int len;\t\t\t/* Physical length of the current buffer */\n   int active;\t\t\t/* Length of valid bytes in the buffer */\n \n@@ -108,6 +107,7 @@ typedef struct\n \n   int unbuffered;               /* =1 if the stream is not buffered */\n \n+  char *buffer;\n   char small_buffer[BUFFER_SIZE];\n }\n unix_stream;\n@@ -587,7 +587,7 @@ fd_alloc_w_at (unix_stream * s, int *len, gfc_offset where)\n         s->ndirty = where + *len - start;  \n       else    \n         s->ndirty = s->dirty_offset + s->ndirty - start;  \n-        s->dirty_offset = start;\n+      s->dirty_offset = start;\n     }\n \n   s->logical_offset = where + *len;"}]}