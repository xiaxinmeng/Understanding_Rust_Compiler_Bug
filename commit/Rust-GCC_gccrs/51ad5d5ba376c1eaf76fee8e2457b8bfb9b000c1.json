{"sha": "51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTFhZDVkNWJhMzc2YzFlYWY3NmZlZThlMjQ1N2I4YmZiOWIwMDBjMQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-01-03T07:23:11Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-01-03T07:23:11Z"}, "message": "re PR tree-optimization/78965 (Invalid -fprintf-return-value optimization)\n\n\tPR tree-optimization/78965\n\t* gimple-ssa-sprintf.c (pass_sprintf_length::compute_format_length):\n\tChange first argument from const call_info & to call_info &.  For %n\n\tset info.nowrite to false.\n\n\t* gcc.dg/pr78965.c: New test.\n\nFrom-SVN: r244014", "tree": {"sha": "92fdd2f4310da70779ccbcbc42c0affad3c6ab51", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/92fdd2f4310da70779ccbcbc42c0affad3c6ab51"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "cd123354c511316c020bf7ff7e4527989b440223", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cd123354c511316c020bf7ff7e4527989b440223", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cd123354c511316c020bf7ff7e4527989b440223"}], "stats": {"total": 32, "additions": 29, "deletions": 3}, "files": [{"sha": "af5185a7e652f7a56b66a6e314f90b56dec0c046", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "patch": "@@ -1,5 +1,10 @@\n 2017-01-03  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR tree-optimization/78965\n+\t* gimple-ssa-sprintf.c (pass_sprintf_length::compute_format_length):\n+\tChange first argument from const call_info & to call_info &.  For %n\n+\tset info.nowrite to false.\n+\n \tPR middle-end/78901\n \t* gimple-ssa-sprintf.c (try_substitute_return_value): Don't change\n \tpossibly throwing calls."}, {"sha": "5bf0215cf1ec1cfd38803763c885c21095b8e4f8", "filename": "gcc/gimple-ssa-sprintf.c", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2Fgimple-ssa-sprintf.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2Fgimple-ssa-sprintf.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-ssa-sprintf.c?ref=51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "patch": "@@ -131,7 +131,7 @@ class pass_sprintf_length : public gimple_opt_pass\n   void handle_gimple_call (gimple_stmt_iterator*);\n \n   struct call_info;\n-  bool compute_format_length (const call_info &, format_result *);\n+  bool compute_format_length (call_info &, format_result *);\n };\n \n bool\n@@ -710,7 +710,8 @@ struct pass_sprintf_length::call_info\n \n   /* True for bounded functions like snprintf that specify a zero-size\n      buffer as a request to compute the size of output without actually\n-     writing any.  */\n+     writing any.  NOWRITE is cleared in response to the %n directive\n+     which has side-effects similar to writing output.  */\n   bool nowrite;\n };\n \n@@ -2357,7 +2358,7 @@ add_bytes (const pass_sprintf_length::call_info &info,\n    that caused the processing to be terminated early).  */\n \n bool\n-pass_sprintf_length::compute_format_length (const call_info &info,\n+pass_sprintf_length::compute_format_length (call_info &info,\n \t\t\t\t\t    format_result *res)\n {\n   /* The variadic argument counter.  */\n@@ -2624,6 +2625,9 @@ pass_sprintf_length::compute_format_length (const call_info &info,\n \t  return false;\n \n \tcase 'n':\n+\t  /* %n has side-effects even when nothing is actually printed to\n+\t     any buffer.  */\n+\t  info.nowrite = false;\n \t  break;\n \n \tcase 'c':"}, {"sha": "abed28d091847b0f14e2da63d9aeb534b81abea0", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "patch": "@@ -1,5 +1,8 @@\n 2017-01-03  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR tree-optimization/78965\n+\t* gcc.dg/pr78965.c: New test.\n+\n \tPR middle-end/78901\n \t* g++.dg/opt/pr78901.C: New test.\n "}, {"sha": "9ae1ad4a56c60db1636c436440ac2a65ee186f9b", "filename": "gcc/testsuite/gcc.dg/pr78965.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2Ftestsuite%2Fgcc.dg%2Fpr78965.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1/gcc%2Ftestsuite%2Fgcc.dg%2Fpr78965.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr78965.c?ref=51ad5d5ba376c1eaf76fee8e2457b8bfb9b000c1", "patch": "@@ -0,0 +1,14 @@\n+/* PR tree-optimization/78965 */\n+/* { dg-do run { target c99_runtime } } */\n+/* { dg-options \"-O2\" } */\n+/* { dg-add-options c99_runtime } */\n+\n+int\n+main ()\n+{\n+  int a = 5, b = 6;\n+  int c = __builtin_snprintf (0, 0, \"a%nb%nc\", &a, &b);\n+  if (a + b + c != 6)\n+    __builtin_abort ();\n+  return 0;\n+}"}]}