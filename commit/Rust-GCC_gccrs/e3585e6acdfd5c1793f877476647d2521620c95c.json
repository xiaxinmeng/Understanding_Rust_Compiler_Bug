{"sha": "e3585e6acdfd5c1793f877476647d2521620c95c", "node_id": "C_kwDOANBUbNoAKGUzNTg1ZTZhY2RmZDVjMTc5M2Y4Nzc0NzY2NDdkMjUyMTYyMGM5NWM", "commit": {"author": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2023-01-19T22:12:34Z"}, "committer": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2023-01-23T21:41:48Z"}, "message": "c++: Quash bogus -Wunused-value with new [PR107797]\n\nWe shouldn't emit \"right operand of comma operator has no effect\"\nwhen that comma operator was created by the compiler for \"new int{}\".\nconvert_to_void/COMPOUND_EXPR already checks warning_suppressed_p so\nwe can just suppress -Wunused-value.\n\n\tPR c++/107797\n\ngcc/cp/ChangeLog:\n\n\t* cvt.cc (ocp_convert): copy_warning when creating a new\n\tCOMPOUND_EXPR.\n\t* init.cc (build_new_1): Suppress -Wunused-value on\n\tcompiler-generated COMPOUND_EXPRs.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/warn/Wunused-value-1.C: New test.", "tree": {"sha": "be03840369b1fc4e087b3b97fed693bce71e861d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/be03840369b1fc4e087b3b97fed693bce71e861d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e3585e6acdfd5c1793f877476647d2521620c95c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e3585e6acdfd5c1793f877476647d2521620c95c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e3585e6acdfd5c1793f877476647d2521620c95c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e3585e6acdfd5c1793f877476647d2521620c95c/comments", "author": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "72e46b3c7ad5e3d2c69868a510c00707c356106a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/72e46b3c7ad5e3d2c69868a510c00707c356106a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/72e46b3c7ad5e3d2c69868a510c00707c356106a"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "17827d06a4a6693e27710394c889756e8765a288", "filename": "gcc/cp/cvt.cc", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e3585e6acdfd5c1793f877476647d2521620c95c/gcc%2Fcp%2Fcvt.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e3585e6acdfd5c1793f877476647d2521620c95c/gcc%2Fcp%2Fcvt.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcvt.cc?ref=e3585e6acdfd5c1793f877476647d2521620c95c", "patch": "@@ -711,8 +711,10 @@ ocp_convert (tree type, tree expr, int convtype, int flags,\n \treturn error_mark_node;\n       if (e == TREE_OPERAND (expr, 1))\n \treturn expr;\n-      return build2_loc (EXPR_LOCATION (expr), COMPOUND_EXPR, TREE_TYPE (e),\n-\t\t\t TREE_OPERAND (expr, 0), e);\n+      e = build2_loc (EXPR_LOCATION (expr), COMPOUND_EXPR, TREE_TYPE (e),\n+\t\t      TREE_OPERAND (expr, 0), e);\n+      copy_warning (e, expr);\n+      return e;\n     }\n \n   complete_type (type);"}, {"sha": "52e96fbe59088f7e8043e76a5969612a7c75309a", "filename": "gcc/cp/init.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e3585e6acdfd5c1793f877476647d2521620c95c/gcc%2Fcp%2Finit.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e3585e6acdfd5c1793f877476647d2521620c95c/gcc%2Fcp%2Finit.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.cc?ref=e3585e6acdfd5c1793f877476647d2521620c95c", "patch": "@@ -3800,6 +3800,8 @@ build_new_1 (vec<tree, va_gc> **placement, tree type, tree nelts,\n   if (cookie_expr)\n     rval = build2 (COMPOUND_EXPR, TREE_TYPE (rval), cookie_expr, rval);\n \n+  suppress_warning (rval, OPT_Wunused_value);\n+\n   if (rval == data_addr && TREE_CODE (alloc_expr) == TARGET_EXPR)\n     /* If we don't have an initializer or a cookie, strip the TARGET_EXPR\n        and return the call (which doesn't need to be adjusted).  */"}, {"sha": "2ba5587fce04db599cb632c692878211ba17c59a", "filename": "gcc/testsuite/g++.dg/warn/Wunused-value-1.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e3585e6acdfd5c1793f877476647d2521620c95c/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWunused-value-1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e3585e6acdfd5c1793f877476647d2521620c95c/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWunused-value-1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWunused-value-1.C?ref=e3585e6acdfd5c1793f877476647d2521620c95c", "patch": "@@ -0,0 +1,12 @@\n+// PR c++/107797\n+// { dg-do compile { target c++11 } }\n+// { dg-options \"-Wunused\" }\n+\n+void\n+g ()\n+{\n+  (long) new int{};\n+  long(new int{});\n+  (long) new int();\n+  long(new int());\n+}"}]}