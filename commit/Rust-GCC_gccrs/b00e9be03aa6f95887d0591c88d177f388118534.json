{"sha": "b00e9be03aa6f95887d0591c88d177f388118534", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjAwZTliZTAzYWE2Zjk1ODg3ZDA1OTFjODhkMTc3ZjM4ODExODUzNA==", "commit": {"author": {"name": "Alexandre Oliva", "email": "aoliva@redhat.com", "date": "2019-01-17T07:32:29Z"}, "committer": {"name": "Alexandre Oliva", "email": "aoliva@gcc.gnu.org", "date": "2019-01-17T07:32:29Z"}, "message": "[PR87768] reset location wrapper suppression when reentering top level\n\nConcepts-checking and other kinds of early tsubsting may often take\nplace while location wrappers are suppressed, e.g. because we've\ntriggered template instantiation within template parameter lists.\n\nWith that, exprs that are usually wrapped by VIEW_CONVERT_EXPRs\nlocation wrappers may end up wrapped by NON_LVALUE_EXPRs that are not\nmarked as location wrappers.  If such NON_LVALUE_EXPRs tsubsted exprs\nundergo another round of tsubsting, say for constraint checking, or\neven for another round of specialization, they will be rejected by\ntsubst_copy_and_build.\n\nThis patch arranges for suppress_location_wrappers to be saved and\nreset when pushing to the top level, and restored when popping from\nit.\n\n\nfor  gcc/cp/ChangeLog\n\n\tPR c++/87768\n\t* cp-tree.h (saved_scope): Add suppress_location_wrappers.\n\t* name-lookup.c (do_push_to_top_level): Save and reset it.\n\t(do_pop_from_top_level): Restore it.\n\nfor  gcc/testsuite/ChangeLog\n\n\tPR c++/87768\n\t* g++.dg/concepts/pr87768.C: New.\n\nFrom-SVN: r268006", "tree": {"sha": "ff492ea98b26e8aec3dfef2b01d53f27608732d3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ff492ea98b26e8aec3dfef2b01d53f27608732d3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b00e9be03aa6f95887d0591c88d177f388118534", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b00e9be03aa6f95887d0591c88d177f388118534", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b00e9be03aa6f95887d0591c88d177f388118534", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b00e9be03aa6f95887d0591c88d177f388118534/comments", "author": null, "committer": null, "parents": [{"sha": "33f746e5585fb4da99cded09a44efd49ef2f22c7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/33f746e5585fb4da99cded09a44efd49ef2f22c7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/33f746e5585fb4da99cded09a44efd49ef2f22c7"}], "stats": {"total": 26, "additions": 26, "deletions": 0}, "files": [{"sha": "524fbd366c030b769cec1baebad2c7fb034beb4e", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=b00e9be03aa6f95887d0591c88d177f388118534", "patch": "@@ -1,5 +1,10 @@\n 2019-01-17  Alexandre Oliva <aoliva@redhat.com>\n \n+\tPR c++/87768\n+\t* cp-tree.h (saved_scope): Add suppress_location_wrappers.\n+\t* name-lookup.c (do_push_to_top_level): Save and reset it.\n+\t(do_pop_from_top_level): Restore it.\n+\n \tPR c++/86648\n \t* pt.c (make_template_placeholder): Use auto_identifier.\n \t(is_auto): Drop CLASS_PLACEHOLDER_TEMPLATE test."}, {"sha": "5cc8f88d52228ae57f0b7fe8f6e5f1d08f52bf6a", "filename": "gcc/cp/cp-tree.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Fcp%2Fcp-tree.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Fcp%2Fcp-tree.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-tree.h?ref=b00e9be03aa6f95887d0591c88d177f388118534", "patch": "@@ -1626,6 +1626,7 @@ struct GTY(()) saved_scope {\n \n   int x_processing_template_decl;\n   int x_processing_specialization;\n+  int suppress_location_wrappers;\n   BOOL_BITFIELD x_processing_explicit_instantiation : 1;\n   BOOL_BITFIELD need_pop_function_context : 1;\n "}, {"sha": "d7b9029b0a3a5c33609713c51dac7977f303db59", "filename": "gcc/cp/name-lookup.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Fcp%2Fname-lookup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Fcp%2Fname-lookup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.c?ref=b00e9be03aa6f95887d0591c88d177f388118534", "patch": "@@ -7133,6 +7133,7 @@ do_push_to_top_level (void)\n   s->function_decl = current_function_decl;\n   s->unevaluated_operand = cp_unevaluated_operand;\n   s->inhibit_evaluation_warnings = c_inhibit_evaluation_warnings;\n+  s->suppress_location_wrappers = suppress_location_wrappers;\n   s->x_stmt_tree.stmts_are_full_exprs_p = true;\n \n   scope_chain = s;\n@@ -7143,6 +7144,7 @@ do_push_to_top_level (void)\n   push_class_stack ();\n   cp_unevaluated_operand = 0;\n   c_inhibit_evaluation_warnings = 0;\n+  suppress_location_wrappers = 0;\n }\n \n static void\n@@ -7175,6 +7177,7 @@ do_pop_from_top_level (void)\n   current_function_decl = s->function_decl;\n   cp_unevaluated_operand = s->unevaluated_operand;\n   c_inhibit_evaluation_warnings = s->inhibit_evaluation_warnings;\n+  suppress_location_wrappers = s->suppress_location_wrappers;\n \n   /* Make this saved_scope structure available for reuse by\n      push_to_top_level.  */"}, {"sha": "15cdb1ed432060bb46a7b4c932689c33b7afcbc1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b00e9be03aa6f95887d0591c88d177f388118534", "patch": "@@ -1,5 +1,8 @@\n 2019-01-17  Alexandre Oliva <aoliva@redhat.com>\n \n+\tPR c++/87768\n+\t* g++.dg/concepts/pr87768.C: New.\n+\n \tPR c++/86648\n \t* gcc.dg/cpp1z/pr86648.C: New.\n "}, {"sha": "de436e5d9edd86be39045b7237ea88d7cae43866", "filename": "gcc/testsuite/g++.dg/concepts/pr87768.C", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fconcepts%2Fpr87768.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b00e9be03aa6f95887d0591c88d177f388118534/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fconcepts%2Fpr87768.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fconcepts%2Fpr87768.C?ref=b00e9be03aa6f95887d0591c88d177f388118534", "patch": "@@ -0,0 +1,14 @@\n+// { dg-do compile { target c++17 } }\n+// { dg-options \"-fconcepts\" }\n+\n+struct a {};\n+template <bool> using b = a;\n+\n+template <typename> struct c;\n+template <typename d>\n+  requires requires(d e) { e[0]; }\n+struct c<d> {\n+  static constexpr bool f = [] { return false; }();\n+};\n+\n+struct g : b<c<unsigned[]>::f> {};"}]}