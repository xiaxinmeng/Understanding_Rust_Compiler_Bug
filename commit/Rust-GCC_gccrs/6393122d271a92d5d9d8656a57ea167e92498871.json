{"sha": "6393122d271a92d5d9d8656a57ea167e92498871", "node_id": "C_kwDOANBUbNoAKDYzOTMxMjJkMjcxYTkyZDVkOWQ4NjU2YTU3ZWExNjdlOTI0OTg4NzE", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2022-03-18T13:50:36Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2022-03-18T13:50:36Z"}, "message": "Fortran/OpenMP: Improve associate-name diagnostic [PR103039]\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/103039\n\t* openmp.cc (resolve_omp_clauses): Improve associate-name diagnostic\n\tfor select type/rank.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/103039\n\t* gfortran.dg/gomp/associate1.f90: Update dg-error.\n\t* gfortran.dg/gomp/associate2.f90: New test.", "tree": {"sha": "c10042ed3e467daa11a04b65a014ac28ccc71292", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c10042ed3e467daa11a04b65a014ac28ccc71292"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6393122d271a92d5d9d8656a57ea167e92498871", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6393122d271a92d5d9d8656a57ea167e92498871", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6393122d271a92d5d9d8656a57ea167e92498871", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6393122d271a92d5d9d8656a57ea167e92498871/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1f5c0e67393e8f67d66150eba8c64edfeb14e11b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1f5c0e67393e8f67d66150eba8c64edfeb14e11b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1f5c0e67393e8f67d66150eba8c64edfeb14e11b"}], "stats": {"total": 128, "additions": 104, "deletions": 24}, "files": [{"sha": "714148138c22468d10acb303aaeb2c9d374cc640", "filename": "gcc/fortran/openmp.cc", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6393122d271a92d5d9d8656a57ea167e92498871/gcc%2Ffortran%2Fopenmp.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6393122d271a92d5d9d8656a57ea167e92498871/gcc%2Ffortran%2Fopenmp.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.cc?ref=6393122d271a92d5d9d8656a57ea167e92498871", "patch": "@@ -6782,8 +6782,10 @@ resolve_omp_clauses (gfc_code *code, gfc_omp_clauses *omp_clauses,\n \t\t  gfc_error (\"Cray pointee %qs in SHARED clause at %L\",\n \t\t\t    n->sym->name, &n->where);\n \t\tif (n->sym->attr.associate_var)\n-\t\t  gfc_error (\"ASSOCIATE name %qs in SHARED clause at %L\",\n-\t\t\t     n->sym->name, &n->where);\n+\t\t  gfc_error (\"Associate name %qs in SHARED clause at %L\",\n+\t\t\t     n->sym->attr.select_type_temporary\n+\t\t\t     ? n->sym->assoc->target->symtree->n.sym->name\n+\t\t\t     : n->sym->name, &n->where);\n \t\tif (omp_clauses->detach\n \t\t    && n->sym == omp_clauses->detach->symtree->n.sym)\n \t\t  gfc_error (\"DETACH event handle %qs in SHARED clause at %L\",\n@@ -7163,8 +7165,10 @@ resolve_omp_clauses (gfc_code *code, gfc_omp_clauses *omp_clauses,\n \t\t  gfc_error (\"Cray pointee %qs in %s clause at %L\",\n \t\t\t    n->sym->name, name, &n->where);\n \t\tif (n->sym->attr.associate_var)\n-\t\t  gfc_error (\"ASSOCIATE name %qs in %s clause at %L\",\n-\t\t\t     n->sym->name, name, &n->where);\n+\t\t  gfc_error (\"Associate name %qs in %s clause at %L\",\n+\t\t\t     n->sym->attr.select_type_temporary\n+\t\t\t     ? n->sym->assoc->target->symtree->n.sym->name\n+\t\t\t     : n->sym->name, name, &n->where);\n \t\tif (list != OMP_LIST_PRIVATE && is_reduction)\n \t\t  {\n \t\t    if (n->sym->attr.proc_pointer)"}, {"sha": "a44099e005f5d773117abacf208ae7246b0be06e", "filename": "gcc/testsuite/gfortran.dg/gomp/associate1.f90", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6393122d271a92d5d9d8656a57ea167e92498871/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fassociate1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6393122d271a92d5d9d8656a57ea167e92498871/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fassociate1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fassociate1.f90?ref=6393122d271a92d5d9d8656a57ea167e92498871", "patch": "@@ -16,65 +16,65 @@ program associate1\n   j = 2\n   associate(k => v, l => a(i, j), m => a(i, :))\n   associate(n => b(j)%c(:, :)%i, o => a, p => b)\n-!$omp parallel shared (l)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel shared (l)\t! { dg-error \"Associate name\" }\n !$omp end parallel\n-!$omp parallel firstprivate (m)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel firstprivate (m)\t! { dg-error \"Associate name\" }\n !$omp end parallel\n-!$omp parallel reduction (+: k)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel reduction (+: k)\t! { dg-error \"Associate name\" }\n !$omp end parallel\n-!$omp parallel do firstprivate (k)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel do firstprivate (k)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n-!$omp parallel do lastprivate (n)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel do lastprivate (n)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n-!$omp parallel do private (o)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel do private (o)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n-!$omp parallel do shared (p)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel do shared (p)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n-!$omp task private (k)\t\t! { dg-error \"ASSOCIATE name\" }\n+!$omp task private (k)\t\t! { dg-error \"Associate name\" }\n !$omp end task\n-!$omp task shared (l)\t\t! { dg-error \"ASSOCIATE name\" }\n+!$omp task shared (l)\t\t! { dg-error \"Associate name\" }\n !$omp end task\n-!$omp task firstprivate (m)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp task firstprivate (m)\t! { dg-error \"Associate name\" }\n !$omp end task\n-!$omp do private (l)\t\t! { dg-error \"ASSOCIATE name\" }\n+!$omp do private (l)\t\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n-!$omp do reduction (*: k)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp do reduction (*: k)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n-!$omp sections private(o)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp sections private(o)\t! { dg-error \"Associate name\" }\n !$omp section\n !$omp section\n !$omp end sections\n-!$omp parallel sections firstprivate(p)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallel sections firstprivate(p)\t! { dg-error \"Associate name\" }\n !$omp section\n !$omp section\n !$omp endparallelsections\n-!$omp parallelsections lastprivate(m)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp parallelsections lastprivate(m)\t! { dg-error \"Associate name\" }\n !$omp section\n !$omp section\n !$omp endparallelsections\n-!$omp sections reduction(+:k)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp sections reduction(+:k)\t! { dg-error \"Associate name\" }\n !$omp section\n !$omp section\n !$omp end sections\n-!$omp simd private (l)\t\t! { dg-error \"ASSOCIATE name\" }\n+!$omp simd private (l)\t\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n   k = 1\n-!$omp simd lastprivate (m)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp simd lastprivate (m)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n   k = 1\n-!$omp simd reduction (+: k)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp simd reduction (+: k)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n   end do\n   k = 1\n-!$omp simd linear (k : 2)\t! { dg-error \"ASSOCIATE name\" }\n+!$omp simd linear (k : 2)\t! { dg-error \"Associate name\" }\n   do i = 1, 10\n     k = k + 2\n   end do"}, {"sha": "d4e97cb0ed25d7b1ddea50b36780e3f15f1410ba", "filename": "gcc/testsuite/gfortran.dg/gomp/associate2.f90", "status": "added", "additions": 76, "deletions": 0, "changes": 76, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6393122d271a92d5d9d8656a57ea167e92498871/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fassociate2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6393122d271a92d5d9d8656a57ea167e92498871/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fassociate2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fassociate2.f90?ref=6393122d271a92d5d9d8656a57ea167e92498871", "patch": "@@ -0,0 +1,76 @@\n+! { dg-do compile }\n+!\n+! PR fortran/103039\n+!\n+\n+subroutine shared_test(cc, ar)\n+implicit none\n+class(*) :: cc\n+integer :: ar(..)\n+\n+associate(aa => cc)\n+  !$omp parallel shared(aa)  ! { dg-error \"Associate name 'aa' in SHARED clause\" }\n+  !$omp end parallel\n+end associate\n+\n+select type(tt => cc)\n+  type is (integer)\n+  !$omp parallel shared(tt) ! { dg-error \"Associate name 'tt' in SHARED clause\" }\n+  !$omp end parallel\n+end select\n+\n+select type(cc)\n+  type is (integer)\n+  !$omp parallel shared(cc) ! { dg-error \"Associate name 'cc' in SHARED clause\" }\n+  !$omp end parallel\n+end select\n+\n+select rank(rr => ar)\n+  rank(1)\n+  !$omp parallel shared(rr) ! { dg-error \"Associate name 'rr' in SHARED clause\" }\n+  !$omp end parallel\n+end select\n+\n+select rank(ar)\n+  rank(1)\n+  !$omp parallel shared(ar) ! { dg-error \"Associate name 'ar' in SHARED clause\" }\n+  !$omp end parallel\n+end select\n+end\n+\n+\n+\n+subroutine firstprivate_test(cc, ar)\n+implicit none\n+class(*) :: cc\n+integer :: ar(..)\n+\n+associate(aa => cc)\n+  !$omp parallel firstprivate(aa)  ! { dg-error \"Associate name 'aa' in FIRSTPRIVATE clause\" }\n+  !$omp end parallel\n+end associate\n+\n+select type(tt => cc)\n+  type is (integer)\n+  !$omp parallel firstprivate(tt) ! { dg-error \"Associate name 'tt' in FIRSTPRIVATE clause\" }\n+  !$omp end parallel\n+end select\n+\n+select type(cc)\n+  type is (integer)\n+  !$omp parallel firstprivate(cc) ! { dg-error \"Associate name 'cc' in FIRSTPRIVATE clause\" }\n+  !$omp end parallel\n+end select\n+\n+select rank(rr => ar)\n+  rank(1)\n+  !$omp parallel firstprivate(rr) ! { dg-error \"Associate name 'rr' in FIRSTPRIVATE clause\" }\n+  !$omp end parallel\n+end select\n+\n+select rank(ar)\n+  rank(1)\n+  !$omp parallel firstprivate(ar) ! { dg-error \"Associate name 'ar' in FIRSTPRIVATE clause\" }\n+  !$omp end parallel\n+end select\n+end"}]}