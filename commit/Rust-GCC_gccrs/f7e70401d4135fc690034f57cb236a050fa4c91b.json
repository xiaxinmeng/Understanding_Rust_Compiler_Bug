{"sha": "f7e70401d4135fc690034f57cb236a050fa4c91b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjdlNzA0MDFkNDEzNWZjNjkwMDM0ZjU3Y2IyMzZhMDUwZmE0YzkxYg==", "commit": {"author": {"name": "Paolo Carlini", "email": "pcarlini@unitus.it", "date": "2003-03-17T23:50:40Z"}, "committer": {"name": "Paolo Carlini", "email": "paolo@gcc.gnu.org", "date": "2003-03-17T23:50:40Z"}, "message": "re PR libstdc++/10097 (filebuf::underflow drops characters.)\n\n2003-03-17  Paolo Carlini  <pcarlini@unitus.it>\n\t    Petur Runolfsson  <peturr02@ru.is>\n\n\tPR libstdc++/10097\n\t* src/fstream.cc (basic_filebuf<char>::_M_underflow_common,\n\tbasic_filebuf<wchar_t>::_M_underflow_common):\n\tif (gptr() < egptr()) return *gptr().\n\t* testsuite/27_io/filebuf_virtuals.cc (test16): Add.\n\n\t* testsuite/27_io/filebuf_members.cc (test_04): Minor\n\tchanges: unlink fifo before making it, fix spelling error.\n\nCo-Authored-By: Petur Runolfsson <peturr02@ru.is>\n\nFrom-SVN: r64509", "tree": {"sha": "8b6fb9d753bf7f28130ed78ea76ae7e8a940bdf8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8b6fb9d753bf7f28130ed78ea76ae7e8a940bdf8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f7e70401d4135fc690034f57cb236a050fa4c91b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7e70401d4135fc690034f57cb236a050fa4c91b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f7e70401d4135fc690034f57cb236a050fa4c91b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7e70401d4135fc690034f57cb236a050fa4c91b/comments", "author": null, "committer": null, "parents": [{"sha": "d41c4351fecd21f7602c66ac78c594557b87f5c4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d41c4351fecd21f7602c66ac78c594557b87f5c4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d41c4351fecd21f7602c66ac78c594557b87f5c4"}], "stats": {"total": 118, "additions": 100, "deletions": 18}, "files": [{"sha": "1209342de9822f49e4c1bf572311b418d7c2c3b8", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=f7e70401d4135fc690034f57cb236a050fa4c91b", "patch": "@@ -1,3 +1,15 @@\n+2003-03-17  Paolo Carlini  <pcarlini@unitus.it>\n+            Petur Runolfsson  <peturr02@ru.is>\n+\n+\tPR libstdc++/10097\n+\t* src/fstream.cc (basic_filebuf<char>::_M_underflow_common,\n+\tbasic_filebuf<wchar_t>::_M_underflow_common):\n+\tif (gptr() < egptr()) return *gptr().\n+\t* testsuite/27_io/filebuf_virtuals.cc (test16): Add.\n+\n+\t* testsuite/27_io/filebuf_members.cc (test_04): Minor\n+\tchanges: unlink fifo before making it, fix spelling error.\n+\n 2003-03-17  Benjamin Kosnik  <bkoz@redhat.com>\n \n \t* testsuite/Makefile.am (CLEANFILES): Add tmp*."}, {"sha": "8280a662b70f0fe7a1195929191a319b788e3e45", "filename": "libstdc++-v3/src/fstream.cc", "status": "modified", "additions": 15, "deletions": 17, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2Fsrc%2Ffstream.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2Fsrc%2Ffstream.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Ffstream.cc?ref=f7e70401d4135fc690034f57cb236a050fa4c91b", "patch": "@@ -1,6 +1,6 @@\n // File based streams -*- C++ -*-\n \n-// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002\n+// Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003\n // Free Software Foundation, Inc.\n //\n // This file is part of the GNU ISO C++ Library.  This library is free\n@@ -52,15 +52,14 @@ namespace std\n \t  // normal buffers and jet outta here before expensive\n \t  // fileops happen...\n \t  if (_M_pback_init)\n+\t    _M_pback_destroy();\n+\n+\t  if (_M_in_cur && _M_in_cur < _M_in_end)\n \t    {\n-\t      _M_pback_destroy();\n-\t      if (_M_in_cur < _M_in_end)\n-\t\t{\n-\t\t  __ret = traits_type::to_int_type(*_M_in_cur);\n-\t\t  if (__bump)\n-\t\t    _M_in_cur_move(1);\n-\t\t  return __ret;\n-\t\t}\n+\t      __ret = traits_type::to_int_type(*_M_in_cur);\n+\t      if (__bump)\n+\t\t_M_in_cur_move(1);\n+\t      return __ret;\n \t    }\n \n \t  // Sync internal and external buffers.\n@@ -135,15 +134,14 @@ namespace std\n \t  // normal buffers and jet outta here before expensive\n \t  // fileops happen...\n \t  if (_M_pback_init)\n+\t    _M_pback_destroy();\n+\n+\t  if (_M_in_cur && _M_in_cur < _M_in_end)\n \t    {\n-\t      _M_pback_destroy();\n-\t      if (_M_in_cur < _M_in_end)\n-\t\t{\n-\t\t  __ret = traits_type::to_int_type(*_M_in_cur);\n-\t\t  if (__bump)\n-\t\t    _M_in_cur_move(1);\n-\t  \t  return __ret;\n-\t\t}\n+\t      __ret = traits_type::to_int_type(*_M_in_cur);\n+\t      if (__bump)\n+\t\t_M_in_cur_move(1);\n+\t      return __ret;\n \t    }\n \n \t  // Sync internal and external buffers."}, {"sha": "79dfa251570369710c3fda979e4618339b75eea5", "filename": "libstdc++-v3/testsuite/27_io/filebuf_members.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_members.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_members.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_members.cc?ref=f7e70401d4135fc690034f57cb236a050fa4c91b", "patch": "@@ -133,9 +133,10 @@ test_04()\n   const char* name = \"tmp_fifo1\";\n   signal(SIGPIPE, SIG_IGN);\n   \n+  unlink(name);\n   if (0 != mkfifo(name, S_IRWXU))\n     {\n-      std::cerr << \"failed to creat fifo\" << std::endl;\n+      std::cerr << \"failed to create fifo\" << std::endl;\n       exit(-1);\n     }\n   "}, {"sha": "6699d80af30fa78328ee2619d7449d15b56fd0c2", "filename": "libstdc++-v3/testsuite/27_io/filebuf_virtuals.cc", "status": "modified", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_virtuals.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7e70401d4135fc690034f57cb236a050fa4c91b/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_virtuals.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_virtuals.cc?ref=f7e70401d4135fc690034f57cb236a050fa4c91b", "patch": "@@ -21,6 +21,11 @@\n // 27.8.1.4 Overridden virtual functions\n \n #include <fstream>\n+#include <unistd.h>\n+#include <signal.h>\n+#include <fcntl.h>\n+#include <sys/types.h>\n+#include <sys/stat.h>\n #include <locale>\n #include <testsuite_hooks.h>\n \n@@ -798,6 +803,71 @@ void test15()\n   fbin.close();\n }\n \n+class UnderBuf : public std::filebuf\n+{\n+public:\n+  int_type\n+  pub_underflow()\n+  { return underflow(); }\n+\n+  std::streamsize\n+  pub_showmanyc()\n+  { return showmanyc(); }\n+};\n+\n+// libstdc++/10097\n+void test16()\n+{\n+  using namespace std;\n+  bool test = true;\n+\n+  const char* name = \"tmp_fifo1\";\n+  \n+  signal(SIGPIPE, SIG_IGN);\n+  unlink(name);\n+  \n+  if (0 != mkfifo(name, S_IRWXU))\n+    {\n+      VERIFY( false );\n+    }\n+  \n+  int fval = fork();\n+  if (fval == -1)\n+    {\n+      unlink(name);\n+      VERIFY( false );\n+    }\n+  else if (fval == 0)\n+    {\n+      filebuf fbout;\n+      fbout.open(name, ios_base::out);\n+      fbout.sputn(\"0123456789\", 10);\n+      fbout.pubsync();\n+      sleep(2);\n+      fbout.close();\n+      exit(0);\n+    }\n+\n+  UnderBuf fb;\n+  fb.open(name, ios_base::in);\n+  sleep(1);\n+  \n+  fb.sgetc();\n+  streamsize n = fb.pub_showmanyc();\n+\n+  while (n > 0)\n+    {\n+      --n;\n+      \n+      UnderBuf::int_type c = fb.pub_underflow();\n+      VERIFY( c != UnderBuf::traits_type::eof() );\n+      \n+      fb.sbumpc();\n+    }\n+\n+  fb.close();\n+}\n+\n main() \n {\n   test01();\n@@ -817,5 +887,6 @@ main()\n   test13();\n   test14();\n   test15();\n+  test16();\n   return 0;\n }"}]}