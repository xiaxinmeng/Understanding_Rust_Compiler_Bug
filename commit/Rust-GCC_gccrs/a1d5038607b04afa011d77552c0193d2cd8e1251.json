{"sha": "a1d5038607b04afa011d77552c0193d2cd8e1251", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTFkNTAzODYwN2IwNGFmYTAxMWQ3NzU1MmMwMTkzZDJjZDhlMTI1MQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2013-10-10T16:29:50Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2013-10-10T16:29:50Z"}, "message": "re PR middle-end/58670 (asm goto miscompilation)\n\n\tPR middle-end/58670\n\t* stmt.c (expand_asm_operands): Add FALLTHRU_BB argument,\n\tif any labels are in FALLTHRU_BB, use a special label emitted\n\timmediately after the asm goto insn rather than label_rtx\n\tof the LABEL_DECL.\n\t(expand_asm_stmt): Adjust caller.\n\t* cfgrtl.c (commit_one_edge_insertion): Force splitting of\n\tedge if the last insn in predecessor is a jump with single successor,\n\tbut it isn't simplejump_p.\n\n\t* gcc.dg/torture/pr58670.c: New test.\n\nFrom-SVN: r203383", "tree": {"sha": "8c578f08248bdbe39d7433a888f50d829017121e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8c578f08248bdbe39d7433a888f50d829017121e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a1d5038607b04afa011d77552c0193d2cd8e1251", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a1d5038607b04afa011d77552c0193d2cd8e1251", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a1d5038607b04afa011d77552c0193d2cd8e1251", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a1d5038607b04afa011d77552c0193d2cd8e1251/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "e2c2fde2105b83ec8c4fcc664969df2437467c36", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e2c2fde2105b83ec8c4fcc664969df2437467c36", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e2c2fde2105b83ec8c4fcc664969df2437467c36"}], "stats": {"total": 112, "additions": 106, "deletions": 6}, "files": [{"sha": "e91562fdd902ff6bc65f0bb232f8b4b5ab2d92b5", "filename": "gcc/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a1d5038607b04afa011d77552c0193d2cd8e1251", "patch": "@@ -1,3 +1,15 @@\n+2013-10-10  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR middle-end/58670\n+\t* stmt.c (expand_asm_operands): Add FALLTHRU_BB argument,\n+\tif any labels are in FALLTHRU_BB, use a special label emitted\n+\timmediately after the asm goto insn rather than label_rtx\n+\tof the LABEL_DECL.\n+\t(expand_asm_stmt): Adjust caller.\n+\t* cfgrtl.c (commit_one_edge_insertion): Force splitting of\n+\tedge if the last insn in predecessor is a jump with single successor,\n+\tbut it isn't simplejump_p.\n+\n 2013-10-10  Richard Biener  <rguenther@suse.de>\n \n \tPR tree-optimization/58656"}, {"sha": "d6733a2af31e781377b8376e8387d4f9c17ed484", "filename": "gcc/cfgrtl.c", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Fcfgrtl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Fcfgrtl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfgrtl.c?ref=a1d5038607b04afa011d77552c0193d2cd8e1251", "patch": "@@ -1959,10 +1959,18 @@ commit_one_edge_insertion (edge e)\n     }\n \n   /* If the source has one successor and the edge is not abnormal,\n-     insert there.  Except for the entry block.  */\n+     insert there.  Except for the entry block.\n+     Don't do this if the predecessor ends in a jump other than\n+     unconditional simple jump.  E.g. for asm goto that points all\n+     its labels at the fallthru basic block, we can't insert instructions\n+     before the asm goto, as the asm goto can have various of side effects,\n+     and can't emit instructions after the asm goto, as it must end\n+     the basic block.  */\n   else if ((e->flags & EDGE_ABNORMAL) == 0\n \t   && single_succ_p (e->src)\n-\t   && e->src != ENTRY_BLOCK_PTR)\n+\t   && e->src != ENTRY_BLOCK_PTR\n+\t   && (!JUMP_P (BB_END (e->src))\n+\t       || simplejump_p (BB_END (e->src))))\n     {\n       bb = e->src;\n "}, {"sha": "b3fd25510abe7509ff07ef00f4f8dc47582233ca", "filename": "gcc/stmt.c", "status": "modified", "additions": 32, "deletions": 4, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Fstmt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Fstmt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fstmt.c?ref=a1d5038607b04afa011d77552c0193d2cd8e1251", "patch": "@@ -612,6 +612,9 @@ tree_conflicts_with_clobbers_p (tree t, HARD_REG_SET *clobbered_regs)\n    CLOBBERS is a list of STRING_CST nodes each naming a hard register\n    that is clobbered by this insn.\n \n+   LABELS is a list of labels, and if LABELS is non-NULL, FALLTHRU_BB\n+   should be the fallthru basic block of the asm goto.\n+\n    Not all kinds of lvalue that may appear in OUTPUTS can be stored directly.\n    Some elements of OUTPUTS may be replaced with trees representing temporary\n    values.  The caller should copy those temporary values to the originally\n@@ -621,7 +624,8 @@ tree_conflicts_with_clobbers_p (tree t, HARD_REG_SET *clobbered_regs)\n \n static void\n expand_asm_operands (tree string, tree outputs, tree inputs,\n-\t\t     tree clobbers, tree labels, int vol, location_t locus)\n+\t\t     tree clobbers, tree labels, basic_block fallthru_bb,\n+\t\t     int vol, location_t locus)\n {\n   rtvec argvec, constraintvec, labelvec;\n   rtx body;\n@@ -642,6 +646,7 @@ expand_asm_operands (tree string, tree outputs, tree inputs,\n   enum machine_mode *inout_mode = XALLOCAVEC (enum machine_mode, noutputs);\n   const char **constraints = XALLOCAVEC (const char *, noutputs + ninputs);\n   int old_generating_concat_p = generating_concat_p;\n+  rtx fallthru_label = NULL_RTX;\n \n   /* An ASM with no outputs needs to be treated as volatile, for now.  */\n   if (noutputs == 0)\n@@ -942,8 +947,24 @@ expand_asm_operands (tree string, tree outputs, tree inputs,\n \n   /* Copy labels to the vector.  */\n   for (i = 0, tail = labels; i < nlabels; ++i, tail = TREE_CHAIN (tail))\n-    ASM_OPERANDS_LABEL (body, i)\n-      = gen_rtx_LABEL_REF (Pmode, label_rtx (TREE_VALUE (tail)));\n+    {\n+      rtx r;\n+      /* If asm goto has any labels in the fallthru basic block, use\n+\t a label that we emit immediately after the asm goto.  Expansion\n+\t may insert further instructions into the same basic block after\n+\t asm goto and if we don't do this, insertion of instructions on\n+\t the fallthru edge might misbehave.  See PR58670.  */\n+      if (fallthru_bb\n+\t  && label_to_block_fn (cfun, TREE_VALUE (tail)) == fallthru_bb)\n+\t{\n+\t  if (fallthru_label == NULL_RTX)\n+\t    fallthru_label = gen_label_rtx ();\n+\t  r = fallthru_label;\n+\t}\n+      else\n+\tr = label_rtx (TREE_VALUE (tail));\n+      ASM_OPERANDS_LABEL (body, i) = gen_rtx_LABEL_REF (Pmode, r);\n+    }\n \n   generating_concat_p = old_generating_concat_p;\n \n@@ -1067,6 +1088,9 @@ expand_asm_operands (tree string, tree outputs, tree inputs,\n \temit_insn (body);\n     }\n \n+  if (fallthru_label)\n+    emit_label (fallthru_label);\n+\n   /* For any outputs that needed reloading into registers, spill them\n      back to where they belong.  */\n   for (i = 0; i < noutputs; ++i)\n@@ -1087,6 +1111,7 @@ expand_asm_stmt (gimple stmt)\n   const char *s;\n   tree str, out, in, cl, labels;\n   location_t locus = gimple_location (stmt);\n+  basic_block fallthru_bb = NULL;\n \n   /* Meh... convert the gimple asm operands into real tree lists.\n      Eventually we should make all routines work on the vectors instead\n@@ -1122,6 +1147,9 @@ expand_asm_stmt (gimple stmt)\n   n = gimple_asm_nlabels (stmt);\n   if (n > 0)\n     {\n+      edge fallthru = find_fallthru_edge (gimple_bb (stmt)->succs);\n+      if (fallthru)\n+\tfallthru_bb = fallthru->dest;\n       t = labels = gimple_asm_label_op (stmt, 0);\n       for (i = 1; i < n; i++)\n \tt = TREE_CHAIN (t) = gimple_asm_label_op (stmt, i);\n@@ -1147,7 +1175,7 @@ expand_asm_stmt (gimple stmt)\n \n   /* Generate the ASM_OPERANDS insn; store into the TREE_VALUEs of\n      OUTPUTS some trees for where the values were actually stored.  */\n-  expand_asm_operands (str, outputs, in, cl, labels,\n+  expand_asm_operands (str, outputs, in, cl, labels, fallthru_bb,\n \t\t       gimple_asm_volatile_p (stmt), locus);\n \n   /* Copy all the intermediate outputs into the specified outputs.  */"}, {"sha": "5e4882a2430e66358e2f660560f81a93e6d6a952", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a1d5038607b04afa011d77552c0193d2cd8e1251", "patch": "@@ -1,3 +1,8 @@\n+2013-10-10  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR middle-end/58670\n+\t* gcc.dg/torture/pr58670.c: New test.\n+\n 2013-10-09  Zhenqiang Chen  <zhenqiang.chen@arm.com>\n \n \t* gcc.dg/tree-ssa/phi-opt-11.c: New test."}, {"sha": "e4536cc330f874198baf92c27779d7d4006c8f36", "filename": "gcc/testsuite/gcc.dg/torture/pr58670.c", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr58670.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a1d5038607b04afa011d77552c0193d2cd8e1251/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr58670.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr58670.c?ref=a1d5038607b04afa011d77552c0193d2cd8e1251", "patch": "@@ -0,0 +1,47 @@\n+/* PR middle-end/58670 */\n+/* { dg-do run { target i?86-*-* x86_64-*-* } } */\n+\n+#if defined (__i386__) || defined (__x86_64__)\n+#define ASM_STR \"bts $1, %0; jc %l[lab]\"\n+#endif\n+\n+__attribute__((noinline, noclone)) int\n+foo (int a, int b)\n+{\n+  if (a)\n+    return -3;\n+#ifdef ASM_STR\n+  asm volatile goto (ASM_STR : : \"m\" (b) : \"memory\" : lab);\n+  return 0;\n+lab:\n+#endif\n+  return 0;\n+}\n+\n+int\n+bar (int a, int b)\n+{\n+  if (a)\n+    return -3;\n+#ifdef ASM_STR\n+  asm volatile goto (ASM_STR : : \"m\" (b) : \"memory\" : lab);\n+  return 0;\n+lab:\n+#endif\n+  return 0;\n+}\n+\n+int\n+main ()\n+{\n+  if (foo (1, 0) != -3\n+      || foo (0, 3) != 0\n+      || foo (1, 0) != -3\n+      || foo (0, 0) != 0\n+      || bar (1, 0) != -3\n+      || bar (0, 3) != 0\n+      || bar (1, 0) != -3\n+      || bar (0, 0) != 0)\n+    __builtin_abort ();\n+  return 0;\n+}"}]}