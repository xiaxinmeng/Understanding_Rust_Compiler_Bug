{"sha": "caaf5345bbdad6db838640bc77ddc7a7aeb87df4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Y2FhZjUzNDViYmRhZDZkYjgzODY0MGJjNzdkZGM3YTdhZWI4N2RmNA==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@codesourcery.com", "date": "2007-03-20T14:13:30Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2007-03-20T14:13:30Z"}, "message": "* config/vxlib.c (tls_delete_hook): Use TCB for kernel tasks.\n\nFrom-SVN: r123086", "tree": {"sha": "117bfa4cc79cc13167d4ec4a7b129035d6397070", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/117bfa4cc79cc13167d4ec4a7b129035d6397070"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/caaf5345bbdad6db838640bc77ddc7a7aeb87df4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/caaf5345bbdad6db838640bc77ddc7a7aeb87df4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/caaf5345bbdad6db838640bc77ddc7a7aeb87df4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/caaf5345bbdad6db838640bc77ddc7a7aeb87df4/comments", "author": null, "committer": null, "parents": [{"sha": "2b31200511efd45e241cb8fc6b92149605e71302", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2b31200511efd45e241cb8fc6b92149605e71302", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2b31200511efd45e241cb8fc6b92149605e71302"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "b395834b6bd14e373c06abc845419e0ccc23bd05", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/caaf5345bbdad6db838640bc77ddc7a7aeb87df4/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/caaf5345bbdad6db838640bc77ddc7a7aeb87df4/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=caaf5345bbdad6db838640bc77ddc7a7aeb87df4", "patch": "@@ -1,3 +1,7 @@\n+2007-03-20  Nathan Sidwell  <nathan@codesourcery.com>\n+\n+\t* config/vxlib.c (tls_delete_hook): Use TCB for kernel tasks.\n+\n 2007-03-19  Andrew Haley  <aph@redhat.com>\n \n \tPR tree-optimization/31264"}, {"sha": "e98355591f8079bd4834f5672dd639a962fafb1b", "filename": "gcc/config/vxlib-tls.c", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/caaf5345bbdad6db838640bc77ddc7a7aeb87df4/gcc%2Fconfig%2Fvxlib-tls.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/caaf5345bbdad6db838640bc77ddc7a7aeb87df4/gcc%2Fconfig%2Fvxlib-tls.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fvxlib-tls.c?ref=caaf5345bbdad6db838640bc77ddc7a7aeb87df4", "patch": "@@ -155,9 +155,18 @@ static __gthread_once_t tls_init_guard = __GTHREAD_ONCE_INIT;\n static void\n tls_delete_hook (void *tcb ATTRIBUTE_UNUSED)\n {\n-  struct tls_data *data = __gthread_get_tls_data ();\n+  struct tls_data *data;\n   __gthread_key_t key;\n \n+#ifdef __RTP__\n+  data = __gthread_get_tls_data ();\n+#else\n+  /* In kernel mode, we can be called in the context of the thread\n+     doing the killing, so must use the TCB to determine the data of\n+     the thread being killed.  */\n+  data = __gthread_get_tsd_data (tcb);\n+#endif\n+  \n   if (data && data->owner == &self_owner)\n     {\n       __gthread_enter_tls_dtor_context ();\n@@ -182,8 +191,11 @@ tls_delete_hook (void *tcb ATTRIBUTE_UNUSED)\n \t    taskDeleteHookDelete ((FUNCPTR)tls_delete_hook);\n \t  __gthread_mutex_unlock (&tls_lock);\n \t}\n-\n+#ifdef __RTP__\n       __gthread_set_tls_data (0);\n+#else\n+      __gthread_set_tsd_data (tcb, 0);\n+#endif\n       __gthread_leave_tls_dtor_context ();\n     }\n } "}]}