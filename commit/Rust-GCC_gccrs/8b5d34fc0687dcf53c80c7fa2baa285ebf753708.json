{"sha": "8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OGI1ZDM0ZmMwNjg3ZGNmNTNjODBjN2ZhMmJhYTI4NWViZjc1MzcwOA==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-01-03T22:10:56Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2020-01-03T22:10:56Z"}, "message": "PR c++/93033 - incorrect tree node sharing with array init.\n\nThe split_nonconstant_init piece is the only one necessary to fix the\ntestcase, but it occurred to me that we might as well not split when\n-fno-exceptions.\n\n\t* typeck2.c (split_nonconstant_init): Unshare non-decl.\n\t* cp-gimplify.c (cp_gimplify_init_expr): Only split if -fexceptions.\n\nFrom-SVN: r279871", "tree": {"sha": "df4d4e3be118895b7402e47c1672c49f6a4402b5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/df4d4e3be118895b7402e47c1672c49f6a4402b5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "657fea973b000000350c99de9e67bff0438d1503", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/657fea973b000000350c99de9e67bff0438d1503", "html_url": "https://github.com/Rust-GCC/gccrs/commit/657fea973b000000350c99de9e67bff0438d1503"}], "stats": {"total": 31, "additions": 30, "deletions": 1}, "files": [{"sha": "421048b79d0fced18629b1e57ec7cf46abd710d1", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "patch": "@@ -1,3 +1,9 @@\n+2020-01-03  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/93033 - incorrect tree node sharing with array init.\n+\t* typeck2.c (split_nonconstant_init): Unshare non-decl.\n+\t* cp-gimplify.c (cp_gimplify_init_expr): Only split if -fexceptions.\n+\n 2020-01-02  Jason Merrill  <jason@redhat.com>\n \n \t* pt.c (invalid_nontype_parm_type_p): Reject class placeholder in"}, {"sha": "eb552767f61bb7ed535ef86c84d7d0d4e945d216", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "patch": "@@ -529,6 +529,7 @@ cp_gimplify_init_expr (tree *expr_p, gimple_seq *pre_p)\n   /* If we might need to clean up a partially constructed object, break down\n      the CONSTRUCTOR with split_nonconstant_init.  */\n   if (TREE_CODE (from) == CONSTRUCTOR\n+      && flag_exceptions\n       && TREE_SIDE_EFFECTS (from)\n       && TYPE_HAS_NONTRIVIAL_DESTRUCTOR (TREE_TYPE (to)))\n     {"}, {"sha": "955669727c354bca56c6457388788c312f7427cc", "filename": "gcc/cp/typeck2.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Fcp%2Ftypeck2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Fcp%2Ftypeck2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck2.c?ref=8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "patch": "@@ -34,6 +34,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"intl.h\"\n #include \"gcc-rich-location.h\"\n #include \"target.h\"\n+#include \"gimplify.h\"\n \n static tree\n process_init_constructor (tree type, tree init, int nested, int flags,\n@@ -791,7 +792,8 @@ split_nonconstant_init (tree dest, tree init)\n \t}\n       else if (init)\n \t{\n-\t  tree ie = build2 (INIT_EXPR, void_type_node, dest, init);\n+\t  tree ie = build2 (INIT_EXPR, void_type_node,\n+\t\t\t    unshare_expr (dest), init);\n \t  code = add_stmt_to_compound (ie, code);\n \t}\n     }"}, {"sha": "4a5d74f6166dfbe03bb02a23a7d7e53431f12012", "filename": "gcc/testsuite/g++.dg/cpp0x/initlist-array9.C", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Finitlist-array9.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8b5d34fc0687dcf53c80c7fa2baa285ebf753708/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Finitlist-array9.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Finitlist-array9.C?ref=8b5d34fc0687dcf53c80c7fa2baa285ebf753708", "patch": "@@ -0,0 +1,20 @@\n+// PR c++/93033\n+// { dg-do compile { target c++11 } }\n+\n+struct A {\n+  A ();\n+  ~A ();\n+};\n+\n+A f();\n+\n+struct B {\n+  A a;\n+  bool b;\n+};\n+\n+void\n+foo ()\n+{\n+  B i[] { f() };\n+}"}]}