{"sha": "bd0e37f68a3aed944df4eb739a0734bb87153749", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmQwZTM3ZjY4YTNhZWQ5NDRkZjRlYjczOWEwNzM0YmI4NzE1Mzc0OQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-02-10T09:34:58Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-02-10T09:42:35Z"}, "message": "openmp: Temporarily disable into_ssa when gimplifying OpenMP reduction clauses [PR99007]\n\ngimplify_scan_omp_clauses was already calling gimplify_expr with false as\nlast argument to make sure it is not an SSA_NAME, but as the testcases show,\nthat is not enough, SSA_NAME temporaries created during that gimplification\ncan be reused too and we can't allow SSA_NAMEs to be used across OpenMP\nregion boundaries, as we can only firstprivatize decls.\n\nFixed by temporarily disabling into_ssa.\n\n2021-02-10  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR middle-end/99007\n\t* gimplify.c (gimplify_scan_omp_clauses): For MEM_REF on reductions,\n\ttemporarily disable gimplify_ctxp->into_ssa around gimplify_expr\n\tcalls.\n\n\t* g++.dg/gomp/pr99007.C: New test.\n\t* gcc.dg/gomp/pr99007-1.c: New test.\n\t* gcc.dg/gomp/pr99007-2.c: New test.\n\t* gcc.dg/gomp/pr99007-3.c: New test.", "tree": {"sha": "48e335eed9475af51da6a5e81b8c2c989d9ab346", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/48e335eed9475af51da6a5e81b8c2c989d9ab346"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bd0e37f68a3aed944df4eb739a0734bb87153749", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bd0e37f68a3aed944df4eb739a0734bb87153749", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bd0e37f68a3aed944df4eb739a0734bb87153749", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bd0e37f68a3aed944df4eb739a0734bb87153749/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9eb7669cc040882992dee3621ebacf4f0311e8a0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9eb7669cc040882992dee3621ebacf4f0311e8a0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9eb7669cc040882992dee3621ebacf4f0311e8a0"}], "stats": {"total": 69, "additions": 69, "deletions": 0}, "files": [{"sha": "d28fa19c4e8966058396f0beee34f50a2d9f664e", "filename": "gcc/gimplify.c", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=bd0e37f68a3aed944df4eb739a0734bb87153749", "patch": "@@ -8781,13 +8781,17 @@ gimplify_scan_omp_clauses (tree *list_p, gimple_seq *pre_p,\n \t  if (TREE_CODE (decl) == MEM_REF)\n \t    {\n \t      tree type = TREE_TYPE (decl);\n+\t      bool saved_into_ssa = gimplify_ctxp->into_ssa;\n+\t      gimplify_ctxp->into_ssa = false;\n \t      if (gimplify_expr (&TYPE_MAX_VALUE (TYPE_DOMAIN (type)), pre_p,\n \t\t\t\t NULL, is_gimple_val, fb_rvalue, false)\n \t\t  == GS_ERROR)\n \t\t{\n+\t\t  gimplify_ctxp->into_ssa = saved_into_ssa;\n \t\t  remove = true;\n \t\t  break;\n \t\t}\n+\t      gimplify_ctxp->into_ssa = saved_into_ssa;\n \t      tree v = TYPE_MAX_VALUE (TYPE_DOMAIN (type));\n \t      if (DECL_P (v))\n \t\t{\n@@ -8797,13 +8801,16 @@ gimplify_scan_omp_clauses (tree *list_p, gimple_seq *pre_p,\n \t      decl = TREE_OPERAND (decl, 0);\n \t      if (TREE_CODE (decl) == POINTER_PLUS_EXPR)\n \t\t{\n+\t\t  gimplify_ctxp->into_ssa = false;\n \t\t  if (gimplify_expr (&TREE_OPERAND (decl, 1), pre_p,\n \t\t\t\t     NULL, is_gimple_val, fb_rvalue, false)\n \t\t      == GS_ERROR)\n \t\t    {\n+\t\t      gimplify_ctxp->into_ssa = saved_into_ssa;\n \t\t      remove = true;\n \t\t      break;\n \t\t    }\n+\t\t  gimplify_ctxp->into_ssa = saved_into_ssa;\n \t\t  v = TREE_OPERAND (decl, 1);\n \t\t  if (DECL_P (v))\n \t\t    {"}, {"sha": "889bfab5081e378b00f84235c488bfff9f2e859a", "filename": "gcc/testsuite/g++.dg/gomp/pr99007.C", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr99007.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr99007.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr99007.C?ref=bd0e37f68a3aed944df4eb739a0734bb87153749", "patch": "@@ -0,0 +1,18 @@\n+// PR middle-end/99007\n+// { dg-additional-options \"-Wno-div-by-zero\" }\n+\n+template <typename T>\n+void\n+bar (T *)\n+{\n+  T s[0/0];\n+  #pragma omp teams distribute parallel for reduction(+:s) allocate(s)\n+  for (int i = 0; i < 8; i++)\n+    ;\n+}\n+\n+void\n+foo (long *a)\n+{\n+  bar (a);\n+}"}, {"sha": "d46957ba16dde08c37c55fa16628b67bf08a2688", "filename": "gcc/testsuite/gcc.dg/gomp/pr99007-1.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-1.c?ref=bd0e37f68a3aed944df4eb739a0734bb87153749", "patch": "@@ -0,0 +1,13 @@\n+/* PR middle-end/99007 */\n+\n+void\n+bar (int n)\n+{\n+  int i;\n+  long s[n];\n+  for (i = 0; i < n; i++)\n+    s[i] = 0;\n+  #pragma omp teams distribute parallel for reduction(+:s) allocate(s)\n+  for (i = 0; i < 8; i++)\n+    s[3]++;\n+}"}, {"sha": "39099311e40d546083b7f02da0ef8256ce809b0b", "filename": "gcc/testsuite/gcc.dg/gomp/pr99007-2.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-2.c?ref=bd0e37f68a3aed944df4eb739a0734bb87153749", "patch": "@@ -0,0 +1,15 @@\n+/* PR middle-end/99007 */\n+\n+int\n+bar (int n)\n+{\n+  int s[n];\n+  int i, j;\n+  for (i = 0; i < n; i++)\n+    s[i] = 0;\n+  #pragma omp teams distribute parallel for reduction(+:s) private (j)\n+  for (i = 0; i < 8; i++)\n+    for (j = 0; j < n; j++)\n+      s[j] += i;\n+  return s[0] + s[n - 1];\n+}"}, {"sha": "c6db941a2771b9b3c6a984c4be0a9ac73448b099", "filename": "gcc/testsuite/gcc.dg/gomp/pr99007-3.c", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd0e37f68a3aed944df4eb739a0734bb87153749/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr99007-3.c?ref=bd0e37f68a3aed944df4eb739a0734bb87153749", "patch": "@@ -0,0 +1,16 @@\n+/* PR middle-end/99007 */\n+\n+int\n+bar (int n)\n+{\n+  int s[n];\n+  int i, j;\n+  for (i = 0; i < n; i++)\n+    s[i] = 0;\n+  #pragma omp parallel reduction(+:s) num_threads(2)\n+  #pragma omp parallel for reduction(+:s) private (j)\n+  for (i = 0; i < 8; i++)\n+    for (j = 0; j < n; j++)\n+      s[j] += i;\n+  return s[0] + s[n - 1];\n+}"}]}