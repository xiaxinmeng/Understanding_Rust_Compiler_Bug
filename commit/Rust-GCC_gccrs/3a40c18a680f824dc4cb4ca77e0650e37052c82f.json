{"sha": "3a40c18a680f824dc4cb4ca77e0650e37052c82f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2E0MGMxOGE2ODBmODI0ZGM0Y2I0Y2E3N2UwNjUwZTM3MDUyYzgyZg==", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2007-01-04T11:30:10Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2007-01-04T11:30:10Z"}, "message": "cgraph.c (cgraph_release_function_body): New function.\n\n\t* cgraph.c (cgraph_release_function_body): New function.\n\t(cgraph_remove_node): Use it.\n\t* cgraph.h (cgraph_release_function_body): Declare.\n\t* cgraphunit.c (cgraph_expand_function): Use it.\n\t* ipa.c (cgraph_remove_unreahchable_nodes): Use it.\n\t* tree-ssa.c (delete_tree_ssa): Allow to be called before aliasing\n\tis initialized and while compilation of other function is running.\n\t* tree-optimize.c (execute_free_cfg_annotations): Move code to clear\n\tstatement CFG annotations from here to ...\n\t* tree-cfg.c (delete_tree_cfg_annotations): ... here.\n\nFrom-SVN: r120437", "tree": {"sha": "58cae202af2ebee37934e16f8848037db54c9be9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/58cae202af2ebee37934e16f8848037db54c9be9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3a40c18a680f824dc4cb4ca77e0650e37052c82f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a40c18a680f824dc4cb4ca77e0650e37052c82f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3a40c18a680f824dc4cb4ca77e0650e37052c82f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a40c18a680f824dc4cb4ca77e0650e37052c82f/comments", "author": null, "committer": null, "parents": [{"sha": "b06e8639fa88b579c1ea48123d4af902c2d7b101", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b06e8639fa88b579c1ea48123d4af902c2d7b101", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b06e8639fa88b579c1ea48123d4af902c2d7b101"}], "stats": {"total": 79, "additions": 54, "deletions": 25}, "files": [{"sha": "602f2e7e328ac78bc3ab07415955fe3c1d21c99d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -1,3 +1,16 @@\n+2007-01-04  Jan Hubicka  <jh@suse.cz>\n+\n+\t* cgraph.c (cgraph_release_function_body): New function.\n+\t(cgraph_remove_node): Use it.\n+\t* cgraph.h (cgraph_release_function_body): Declare.\n+\t* cgraphunit.c (cgraph_expand_function): Use it.\n+\t* ipa.c (cgraph_remove_unreahchable_nodes): Use it.\n+\t* tree-ssa.c (delete_tree_ssa): Allow to be called before aliasing\n+\tis initialized and while compilation of other function is running.\n+\t* tree-optimize.c (execute_free_cfg_annotations): Move code to clear\n+\tstatement CFG annotations from here to ...\n+\t* tree-cfg.c (delete_tree_cfg_annotations): ... here.\n+\n 2007-01-04  Zdenek Dvorak <dvorakz@suse.cz>\n \n \t* cfgloop.h (enum li_flags): Make the constants powers of two."}, {"sha": "8914569b39511894f092349fa1835bb3cdae0330", "filename": "gcc/cgraph.c", "status": "modified", "additions": 22, "deletions": 5, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fcgraph.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fcgraph.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.c?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -468,6 +468,27 @@ cgraph_node_remove_callers (struct cgraph_node *node)\n   node->callers = NULL;\n }\n \n+/* Release memory used to represent body of function NODE.  */\n+\n+void\n+cgraph_release_function_body (struct cgraph_node *node)\n+{\n+  if (DECL_STRUCT_FUNCTION (node->decl)\n+      && DECL_STRUCT_FUNCTION (node->decl)->gimple_df)\n+    {\n+      tree old_decl = current_function_decl;\n+      push_cfun (DECL_STRUCT_FUNCTION (node->decl));\n+      current_function_decl = node->decl;\n+      delete_tree_ssa ();\n+      delete_tree_cfg_annotations ();\n+      current_function_decl = old_decl;\n+      pop_cfun();\n+    }\n+  DECL_SAVED_TREE (node->decl) = NULL;\n+  DECL_STRUCT_FUNCTION (node->decl) = NULL;\n+  DECL_INITIAL (node->decl) = error_mark_node;\n+}\n+\n /* Remove the node from cgraph.  */\n \n void\n@@ -541,11 +562,7 @@ cgraph_remove_node (struct cgraph_node *node)\n     }\n \n   if (kill_body && flag_unit_at_a_time)\n-    {\n-      DECL_SAVED_TREE (node->decl) = NULL;\n-      DECL_STRUCT_FUNCTION (node->decl) = NULL;\n-      DECL_INITIAL (node->decl) = error_mark_node;\n-    }\n+    cgraph_release_function_body (node);\n   node->decl = NULL;\n   if (node->call_site_hash)\n     {"}, {"sha": "4a33d5d45cbbc5e94c6258ab31445aac06a1fc88", "filename": "gcc/cgraph.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fcgraph.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fcgraph.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.h?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -281,6 +281,7 @@ void dump_cgraph_node (FILE *, struct cgraph_node *);\n void cgraph_insert_node_to_hashtable (struct cgraph_node *node);\n void cgraph_remove_edge (struct cgraph_edge *);\n void cgraph_remove_node (struct cgraph_node *);\n+void cgraph_release_function_body (struct cgraph_node *);\n void cgraph_node_remove_callees (struct cgraph_node *node);\n struct cgraph_edge *cgraph_create_edge (struct cgraph_node *,\n \t\t\t\t\tstruct cgraph_node *,"}, {"sha": "b1c5c8b461f18dd9120091d93f671842895516cc", "filename": "gcc/cgraphunit.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fcgraphunit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fcgraphunit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraphunit.c?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -1179,9 +1179,7 @@ cgraph_expand_function (struct cgraph_node *node)\n   current_function_decl = NULL;\n   if (!cgraph_preserve_function_body_p (node->decl))\n     {\n-      DECL_SAVED_TREE (node->decl) = NULL;\n-      DECL_STRUCT_FUNCTION (node->decl) = NULL;\n-      DECL_INITIAL (node->decl) = error_mark_node;\n+      cgraph_release_function_body (node);\n       /* Eliminate all call edges.  This is important so the call_expr no longer\n \t points to the dead function body.  */\n       cgraph_node_remove_callees (node);"}, {"sha": "f45c0583876d33ea68e76115b4d293f97012e340", "filename": "gcc/ipa.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fipa.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Fipa.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa.c?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -186,9 +186,7 @@ cgraph_remove_unreachable_nodes (bool before_inlining_p, FILE *file)\n \t\t      break;\n \t\t  if (!clone)\n \t\t    {\n-\t\t      DECL_SAVED_TREE (node->decl) = NULL;\n-\t\t      DECL_STRUCT_FUNCTION (node->decl) = NULL;\n-\t\t      DECL_INITIAL (node->decl) = error_mark_node;\n+\t\t      cgraph_release_function_body (node);\n \t\t      node->analyzed = false;\n \t\t    }\n \t\t  cgraph_node_remove_callees (node);"}, {"sha": "69b4b4bb0a597d8ec1b75940cfcfdb0f7de755ae", "filename": "gcc/tree-cfg.c", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Ftree-cfg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Ftree-cfg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-cfg.c?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -2651,6 +2651,17 @@ disband_implicit_edges (void)\n void\n delete_tree_cfg_annotations (void)\n {\n+  basic_block bb;\n+  block_stmt_iterator bsi;\n+\n+  /* Remove annotations from every tree in the function.  */\n+  FOR_EACH_BB (bb)\n+    for (bsi = bsi_start (bb); !bsi_end_p (bsi); bsi_next (&bsi))\n+      {\n+\ttree stmt = bsi_stmt (bsi);\n+\tggc_free (stmt->base.ann);\n+\tstmt->base.ann = NULL;\n+      }\n   label_to_block_map = NULL;\n }\n "}, {"sha": "75df4cc54e6fe8281bc5ea11e6de8d060f053e18", "filename": "gcc/tree-optimize.c", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Ftree-optimize.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Ftree-optimize.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-optimize.c?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -241,21 +241,9 @@ struct tree_opt_pass pass_free_datastructures =\n static unsigned int\n execute_free_cfg_annotations (void)\n {\n-  basic_block bb;\n-  block_stmt_iterator bsi;\n-\n   /* Emit gotos for implicit jumps.  */\n   disband_implicit_edges ();\n \n-  /* Remove annotations from every tree in the function.  */\n-  FOR_EACH_BB (bb)\n-    for (bsi = bsi_start (bb); !bsi_end_p (bsi); bsi_next (&bsi))\n-      {\n-\ttree stmt = bsi_stmt (bsi);\n-\tggc_free (stmt->base.ann);\n-\tstmt->base.ann = NULL;\n-      }\n-\n   /* And get rid of annotations we no longer need.  */\n   delete_tree_cfg_annotations ();\n "}, {"sha": "a4231083d019ae7751ddb3943a4d3c34b3899a74", "filename": "gcc/tree-ssa.c", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Ftree-ssa.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a40c18a680f824dc4cb4ca77e0650e37052c82f/gcc%2Ftree-ssa.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa.c?ref=3a40c18a680f824dc4cb4ca77e0650e37052c82f", "patch": "@@ -846,10 +846,13 @@ delete_tree_ssa (void)\n   cfun->gimple_df->call_clobbered_vars = NULL;\n   cfun->gimple_df->addressable_vars = NULL;\n   cfun->gimple_df->modified_noreturn_calls = NULL;\n+  if (gimple_aliases_computed_p (cfun))\n+    {\n+      delete_alias_heapvars ();\n+      gcc_assert (!need_ssa_update_p ());\n+    }\n   cfun->gimple_df->aliases_computed_p = false;\n \n-  delete_alias_heapvars ();\n-  gcc_assert (!need_ssa_update_p ());\n   cfun->gimple_df = NULL;\n }\n "}]}