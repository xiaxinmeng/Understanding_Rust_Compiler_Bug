{"sha": "ed0eca5e631a1652c42a7f91b6c557aea887e1ce", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZWQwZWNhNWU2MzFhMTY1MmM0MmE3ZjkxYjZjNTU3YWVhODg3ZTFjZQ==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2019-12-19T13:21:54Z"}, "committer": {"name": "Richard Sandiford", "email": "rsandifo@gcc.gnu.org", "date": "2019-12-19T13:21:54Z"}, "message": "Don't mangle attributes that have a space in their name\n\nThe SVE port needs to maintain a different type identity for\nGNU vectors and \"SVE vectors\" even during LTO, since the types\nuse different ABIs.  The easiest way of doing that seemed to be\nto use type attributes.  However, these type attributes shouldn't\nbe user-facing; they're just a convenient way of representing the\ntypes internally in GCC.\n\nThere are already several internal-only attributes, such as \"fn spec\"\nand \"omp declare simd\".  They're distinguished from normal user-facing\nattributes by having a space in their name, which means that it isn't\npossible to write them directly in C or C++.\n\nTaking the same approach mostly works well for SVE.  The only snag\nI've hit so far is that the new attribute needs to (and only exists to)\naffect type identity.  This means that it would normally get included\nin mangled names, to distinguish it from types without the attribute.\n\nHowever, the SVE ABI specifies a separate mangling for SVE vector types,\nrather than using an attribute mangling + a normal vector mangling.\nSo we need some way of suppressing the attribute mangling for this case.\n\nThere are currently no other target-independent or target-specific\ninternal-only attributes that affect type identity, so this patch goes\nfor the simplest fix of skipping mangling for attributes whose names\ncontain a space.  Other options I thought about were:\n\n(1) Also make sure that targetm.mangled_type returns nonnull.\n\n(2) Check directly for the target-specific name.\n\n(3) Add a new target hook.\n\n(4) Add new information to attribute_spec.  This would be very invasive\n    at this stage, but maybe we should consider replacing all the boolean\n    fields with flags?  That should make the tables slightly easier to\n    read and would make adding new flags much simpler in future.\n\n2019-12-19  Richard Sandiford  <richard.sandiford@arm.com>\n\ngcc/cp/\n\t* mangle.c (write_CV_qualifiers_for_type): Don't mangle attributes\n\tthat contain a space.\n\nFrom-SVN: r279569", "tree": {"sha": "aab209c8848544cce48c84fc45396d3cc35a2b19", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aab209c8848544cce48c84fc45396d3cc35a2b19"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ed0eca5e631a1652c42a7f91b6c557aea887e1ce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ed0eca5e631a1652c42a7f91b6c557aea887e1ce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ed0eca5e631a1652c42a7f91b6c557aea887e1ce", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ed0eca5e631a1652c42a7f91b6c557aea887e1ce/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "23cdc1e9b73d2074624799a025d7030145979b92", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/23cdc1e9b73d2074624799a025d7030145979b92", "html_url": "https://github.com/Rust-GCC/gccrs/commit/23cdc1e9b73d2074624799a025d7030145979b92"}], "stats": {"total": 10, "additions": 10, "deletions": 0}, "files": [{"sha": "e66f1e0776a8e59c4fff06f0a1fa533bc8007583", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ed0eca5e631a1652c42a7f91b6c557aea887e1ce/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ed0eca5e631a1652c42a7f91b6c557aea887e1ce/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=ed0eca5e631a1652c42a7f91b6c557aea887e1ce", "patch": "@@ -1,3 +1,8 @@\n+2019-12-19  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\t* mangle.c (write_CV_qualifiers_for_type): Don't mangle attributes\n+\tthat contain a space.\n+\n 2019-12-18  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/91165 follow-on tweak"}, {"sha": "b13af39b2e72c79c9c3e22b395c803a9f1aa58f4", "filename": "gcc/cp/mangle.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ed0eca5e631a1652c42a7f91b6c557aea887e1ce/gcc%2Fcp%2Fmangle.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ed0eca5e631a1652c42a7f91b6c557aea887e1ce/gcc%2Fcp%2Fmangle.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fmangle.c?ref=ed0eca5e631a1652c42a7f91b6c557aea887e1ce", "patch": "@@ -2377,6 +2377,11 @@ write_CV_qualifiers_for_type (const tree type)\n \t  tree name = get_attribute_name (a);\n \t  const attribute_spec *as = lookup_attribute_spec (name);\n \t  if (as && as->affects_type_identity\n+\t      /* Skip internal-only attributes, which are distinguished from\n+\t\t others by having a space.  At present, all internal-only\n+\t\t attributes that affect type identity are target-specific\n+\t\t and are handled by targetm.mangle_type instead.  */\n+\t      && !strchr (IDENTIFIER_POINTER (name), ' ')\n \t      && !is_attribute_p (\"transaction_safe\", name)\n \t      && !is_attribute_p (\"abi_tag\", name))\n \t    vec.safe_push (a);"}]}