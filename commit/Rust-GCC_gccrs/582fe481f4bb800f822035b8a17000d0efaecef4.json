{"sha": "582fe481f4bb800f822035b8a17000d0efaecef4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTgyZmU0ODFmNGJiODAwZjgyMjAzNWI4YTE3MDAwZDBlZmFlY2VmNA==", "commit": {"author": {"name": "Andreas Krebbel", "email": "krebbel@linux.ibm.com", "date": "2020-04-20T18:06:53Z"}, "committer": {"name": "Andreas Krebbel", "email": "krebbel@linux.ibm.com", "date": "2020-04-20T18:06:53Z"}, "message": "S/390: Fix PR94666\n\nThe vector popcount expanders use a hardcoded subreg.  This might lead\nto double subregs being generated which then fail to match.  With this\npatch simplify_gen_subreg is used instead to fold the subregs.\n\ngcc/ChangeLog:\n\n2020-04-20  Andreas Krebbel  <krebbel@linux.ibm.com>\n\n\t* config/s390/vector.md (\"popcountv8hi2_vx\", \"popcountv4si2_vx\")\n\t(\"popcountv2di2_vx\"): Use simplify_gen_subreg.\n\ngcc/testsuite/ChangeLog:\n\n2020-04-20  Andreas Krebbel  <krebbel@linux.ibm.com>\n\n\t* g++.dg/pr94666.C: New test.", "tree": {"sha": "1e3354fa3fb9bc9fd41685b8ec6b252e89c95e50", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1e3354fa3fb9bc9fd41685b8ec6b252e89c95e50"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/582fe481f4bb800f822035b8a17000d0efaecef4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/582fe481f4bb800f822035b8a17000d0efaecef4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/582fe481f4bb800f822035b8a17000d0efaecef4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/582fe481f4bb800f822035b8a17000d0efaecef4/comments", "author": {"login": "Andreas-Krebbel", "id": 38103320, "node_id": "MDQ6VXNlcjM4MTAzMzIw", "avatar_url": "https://avatars.githubusercontent.com/u/38103320?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Andreas-Krebbel", "html_url": "https://github.com/Andreas-Krebbel", "followers_url": "https://api.github.com/users/Andreas-Krebbel/followers", "following_url": "https://api.github.com/users/Andreas-Krebbel/following{/other_user}", "gists_url": "https://api.github.com/users/Andreas-Krebbel/gists{/gist_id}", "starred_url": "https://api.github.com/users/Andreas-Krebbel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Andreas-Krebbel/subscriptions", "organizations_url": "https://api.github.com/users/Andreas-Krebbel/orgs", "repos_url": "https://api.github.com/users/Andreas-Krebbel/repos", "events_url": "https://api.github.com/users/Andreas-Krebbel/events{/privacy}", "received_events_url": "https://api.github.com/users/Andreas-Krebbel/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Andreas-Krebbel", "id": 38103320, "node_id": "MDQ6VXNlcjM4MTAzMzIw", "avatar_url": "https://avatars.githubusercontent.com/u/38103320?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Andreas-Krebbel", "html_url": "https://github.com/Andreas-Krebbel", "followers_url": "https://api.github.com/users/Andreas-Krebbel/followers", "following_url": "https://api.github.com/users/Andreas-Krebbel/following{/other_user}", "gists_url": "https://api.github.com/users/Andreas-Krebbel/gists{/gist_id}", "starred_url": "https://api.github.com/users/Andreas-Krebbel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Andreas-Krebbel/subscriptions", "organizations_url": "https://api.github.com/users/Andreas-Krebbel/orgs", "repos_url": "https://api.github.com/users/Andreas-Krebbel/repos", "events_url": "https://api.github.com/users/Andreas-Krebbel/events{/privacy}", "received_events_url": "https://api.github.com/users/Andreas-Krebbel/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2930bb321794c241d8df5591a5bf447bf89c6e82", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2930bb321794c241d8df5591a5bf447bf89c6e82", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2930bb321794c241d8df5591a5bf447bf89c6e82"}], "stats": {"total": 39, "additions": 36, "deletions": 3}, "files": [{"sha": "721928d931d229c780652cc10d8e00f0518b9c08", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=582fe481f4bb800f822035b8a17000d0efaecef4", "patch": "@@ -1,3 +1,8 @@\n+2020-04-20  Andreas Krebbel  <krebbel@linux.ibm.com>\n+\n+\t* config/s390/vector.md (\"popcountv8hi2_vx\", \"popcountv4si2_vx\")\n+\t(\"popcountv2di2_vx\"): Use simplify_gen_subreg.\n+\n 2020-04-20  Andreas Krebbel  <krebbel@linux.ibm.com>\n \n \tPR target/94613"}, {"sha": "08f2d4cbda69ab9089c074e31eee385e9e3c4126", "filename": "gcc/config/s390/vector.md", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2Fconfig%2Fs390%2Fvector.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2Fconfig%2Fs390%2Fvector.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fvector.md?ref=582fe481f4bb800f822035b8a17000d0efaecef4", "patch": "@@ -871,7 +871,7 @@\n \n (define_expand \"popcountv8hi2_vx\"\n   [(set (match_dup 2)\n-\t(unspec:V16QI [(subreg:V16QI (match_operand:V8HI 1 \"register_operand\" \"v\") 0)]\n+\t(unspec:V16QI [(match_operand:V8HI 1 \"register_operand\" \"v\")]\n \t\t      UNSPEC_POPCNT))\n    ; Make a copy of the result\n    (set (match_dup 3) (match_dup 2))\n@@ -903,6 +903,8 @@\n ]\n   \"TARGET_VX && !TARGET_VXE\"\n {\n+  operands[1] = simplify_gen_subreg (V16QImode, operands[1],\n+\t\t\t\t     V8HImode, 0);\n   operands[2] = gen_reg_rtx (V16QImode);\n   operands[3] = gen_reg_rtx (V16QImode);\n   operands[4] = gen_reg_rtx (V16QImode);\n@@ -911,20 +913,21 @@\n \n (define_expand \"popcountv4si2_vx\"\n   [(set (match_dup 2)\n-\t(unspec:V16QI [(subreg:V16QI (match_operand:V4SI 1 \"register_operand\" \"v\") 0)]\n+\t(unspec:V16QI [(match_operand:V4SI 1 \"register_operand\" \"v\")]\n \t\t      UNSPEC_POPCNT))\n    (set (match_operand:V4SI 0 \"register_operand\" \"=v\")\n \t(unspec:V4SI [(match_dup 2) (match_dup 3)]\n \t\t     UNSPEC_VEC_VSUM))]\n   \"TARGET_VX && !TARGET_VXE\"\n {\n+  operands[1] = simplify_gen_subreg (V16QImode, operands[1], V4SImode, 0);\n   operands[2] = gen_reg_rtx (V16QImode);\n   operands[3] = force_reg (V16QImode, CONST0_RTX (V16QImode));\n })\n \n (define_expand \"popcountv2di2_vx\"\n   [(set (match_dup 2)\n-\t(unspec:V16QI [(subreg:V16QI (match_operand:V2DI 1 \"register_operand\" \"v\") 0)]\n+\t(unspec:V16QI [(match_operand:V2DI 1 \"register_operand\" \"v\")]\n \t\t      UNSPEC_POPCNT))\n    (set (match_dup 3)\n \t(unspec:V4SI [(match_dup 2) (match_dup 4)]\n@@ -934,6 +937,7 @@\n \t\t     UNSPEC_VEC_VSUMG))]\n   \"TARGET_VX && !TARGET_VXE\"\n {\n+  operands[1] = simplify_gen_subreg (V16QImode, operands[1], V2DImode, 0);\n   operands[2] = gen_reg_rtx (V16QImode);\n   operands[3] = gen_reg_rtx (V4SImode);\n   operands[4] = force_reg (V16QImode, CONST0_RTX (V16QImode));"}, {"sha": "ce31ed0cd448dff98fc8f03d6ab2990ba08edc7b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=582fe481f4bb800f822035b8a17000d0efaecef4", "patch": "@@ -1,3 +1,7 @@\n+2020-04-20  Andreas Krebbel  <krebbel@linux.ibm.com>\n+\n+\t* g++.dg/pr94666.C: New test.\n+\n 2020-04-20  Andreas Krebbel  <krebbel@linux.ibm.com>\n \n \tPR target/94613"}, {"sha": "a9bfb24f79527a642daf707bc81f1f2358fd1667", "filename": "gcc/testsuite/g++.dg/pr94666.C", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr94666.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/582fe481f4bb800f822035b8a17000d0efaecef4/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr94666.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr94666.C?ref=582fe481f4bb800f822035b8a17000d0efaecef4", "patch": "@@ -0,0 +1,20 @@\n+// { dg-do compile }\n+// { dg-options \"-O3\" }\n+// { dg-additional-options \"-march=z13\" { target s390*-*-* } }\n+\n+int a, c;\n+struct A {\n+  int e() {\n+    int f;\n+    for (int b = 0; b < 4; b++) {\n+      a = __builtin_popcountl(d[b]);\n+      f += a;\n+    }\n+    return f;\n+  }\n+  long d[4];\n+} * g;\n+void h() {\n+  for (int b; b; b++)\n+    c += g[b].e();\n+}"}]}