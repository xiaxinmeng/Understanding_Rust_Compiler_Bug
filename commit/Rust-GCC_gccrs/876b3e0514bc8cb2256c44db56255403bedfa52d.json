{"sha": "876b3e0514bc8cb2256c44db56255403bedfa52d", "node_id": "C_kwDOANBUbNoAKDg3NmIzZTA1MTRiYzhjYjIyNTZjNDRkYjU2MjU1NDAzYmVkZmE1MmQ", "commit": {"author": {"name": "Andrew Pinski", "email": "apinski@marvell.com", "date": "2023-01-28T18:27:08Z"}, "committer": {"name": "Andrew Pinski", "email": "apinski@marvell.com", "date": "2023-01-30T12:45:35Z"}, "message": "Fix PR 108582: ICE due to PHI-OPT removing a still in use ssa_name.\n\nThis patch adds a check in match_simplify_replacement to make sure the middlebb\ndoes not have any phi-nodes as we don't currently move those.\nThis was just a thinko from before.\n\nOk? Bootstrapped and tested on x86_64-linux-gnu with no regressions?\n\n\tPR tree-optimization/108582\n\ngcc/ChangeLog:\n\n\t* tree-ssa-phiopt.cc (match_simplify_replacement): Add check\n\tfor middlebb to have no phi nodes.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.dg/pr108582-1.c: New test.", "tree": {"sha": "3b00ac71475e3b05c1cf524b90bf203c641e3c08", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3b00ac71475e3b05c1cf524b90bf203c641e3c08"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/876b3e0514bc8cb2256c44db56255403bedfa52d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/876b3e0514bc8cb2256c44db56255403bedfa52d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/876b3e0514bc8cb2256c44db56255403bedfa52d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/876b3e0514bc8cb2256c44db56255403bedfa52d/comments", "author": {"login": "apinski-cavium", "id": 6335315, "node_id": "MDQ6VXNlcjYzMzUzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/6335315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apinski-cavium", "html_url": "https://github.com/apinski-cavium", "followers_url": "https://api.github.com/users/apinski-cavium/followers", "following_url": "https://api.github.com/users/apinski-cavium/following{/other_user}", "gists_url": "https://api.github.com/users/apinski-cavium/gists{/gist_id}", "starred_url": "https://api.github.com/users/apinski-cavium/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apinski-cavium/subscriptions", "organizations_url": "https://api.github.com/users/apinski-cavium/orgs", "repos_url": "https://api.github.com/users/apinski-cavium/repos", "events_url": "https://api.github.com/users/apinski-cavium/events{/privacy}", "received_events_url": "https://api.github.com/users/apinski-cavium/received_events", "type": "User", "site_admin": false}, "committer": {"login": "apinski-cavium", "id": 6335315, "node_id": "MDQ6VXNlcjYzMzUzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/6335315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/apinski-cavium", "html_url": "https://github.com/apinski-cavium", "followers_url": "https://api.github.com/users/apinski-cavium/followers", "following_url": "https://api.github.com/users/apinski-cavium/following{/other_user}", "gists_url": "https://api.github.com/users/apinski-cavium/gists{/gist_id}", "starred_url": "https://api.github.com/users/apinski-cavium/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/apinski-cavium/subscriptions", "organizations_url": "https://api.github.com/users/apinski-cavium/orgs", "repos_url": "https://api.github.com/users/apinski-cavium/repos", "events_url": "https://api.github.com/users/apinski-cavium/events{/privacy}", "received_events_url": "https://api.github.com/users/apinski-cavium/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ac3e69e311351b70407d7f87a0169c4d463e57b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7ac3e69e311351b70407d7f87a0169c4d463e57b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7ac3e69e311351b70407d7f87a0169c4d463e57b"}], "stats": {"total": 63, "additions": 63, "deletions": 0}, "files": [{"sha": "88c2de369ad9c73e046cf195d652c6f90ee90185", "filename": "gcc/testsuite/gcc.dg/pr108582-1.c", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/876b3e0514bc8cb2256c44db56255403bedfa52d/gcc%2Ftestsuite%2Fgcc.dg%2Fpr108582-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/876b3e0514bc8cb2256c44db56255403bedfa52d/gcc%2Ftestsuite%2Fgcc.dg%2Fpr108582-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr108582-1.c?ref=876b3e0514bc8cb2256c44db56255403bedfa52d", "patch": "@@ -0,0 +1,58 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O3 -fno-tree-ccp -fno-tree-dce\" } */\n+\n+/*\n+  PHI-OPT via match_simplify_replacement used to transform:\n+  if (_25 != 0)\n+    goto <bb 8>; [25.00%]\n+  else\n+    goto <bb 9>; [75.00%]\n+\n+  <bb 8> [local count: 11649864]:\n+  # iftmp.5_13 = PHI <2(7)>\n+  k_22 = k_11 | iftmp.5_13;\n+\n+  <bb 9> [local count: 105655256]:\n+  # g_9 = PHI <1(2), 0(8), g_8(7)>\n+  # k_12 = PHI <k_20(D)(2), k_22(8), k_11(7)>\n+\n+into:\n+\n+  _15 = (int) _25;\n+  _28 = -_15;\n+  _4 = _13 & _28;\n+  _6 = _4 | k_11;\n+\n+  <bb 8> [local count: 105655256]:\n+  # g_9 = PHI <1(2), g_8(7)>\n+  # k_12 = PHI <k_20(D)(2), _6(7)>\n+\n+Removing the phi-node/assignment of _13.\n+\n+ */\n+\n+int a, c, d, e, f;\n+char b;\n+int main() {\n+  int g = 1;\n+  char h[1] = {0};\n+  while (a) {\n+    if (f) {\n+      b = 0;\n+      if (d)\n+        continue;\n+    }\n+    if (a < 1) {\n+      g = 0;\n+      goto L;\n+    }\n+  }\n+  while (c) {\n+    char *j = h;\n+    int k;\n+  L:\n+    if (e && !g)\n+      k |= 2 | (*j < 0);\n+  }\n+  return 0;\n+}"}, {"sha": "a7ab6ce4ad90b4088b942ea6ad6430beb0c5dcd9", "filename": "gcc/tree-ssa-phiopt.cc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/876b3e0514bc8cb2256c44db56255403bedfa52d/gcc%2Ftree-ssa-phiopt.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/876b3e0514bc8cb2256c44db56255403bedfa52d/gcc%2Ftree-ssa-phiopt.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-phiopt.cc?ref=876b3e0514bc8cb2256c44db56255403bedfa52d", "patch": "@@ -1002,6 +1002,11 @@ match_simplify_replacement (basic_block cond_bb, basic_block middle_bb,\n       if (!single_pred_p (middle_bb))\n \treturn false;\n \n+      /* The middle bb cannot have phi nodes as we don't\n+\t move those assignments yet. */\n+      if (!gimple_seq_empty_p (phi_nodes (middle_bb)))\n+\treturn false;\n+\n       stmt_to_move = last_and_only_stmt (middle_bb);\n       if (!stmt_to_move)\n \treturn false;"}]}