{"sha": "82f72146967e71693f2d4f6646f35c3c00780602", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODJmNzIxNDY5NjdlNzE2OTNmMmQ0ZjY2NDZmMzVjM2MwMDc4MDYwMg==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2016-08-19T00:18:18Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2016-08-19T00:18:18Z"}, "message": "Add source information to -fverbose-asm\n\ngcc/ChangeLog:\n\t* doc/invoke.texi (fverbose-asm): Note that source code lines\n\tare emitted, and provide an example.\n\t* final.c (asm_show_source): New function.\n\t(final_scan_insn): Call asm_show_source.\n\nFrom-SVN: r239604", "tree": {"sha": "5faef7399b046f2419d8c84d6f16545f6f1e97cc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5faef7399b046f2419d8c84d6f16545f6f1e97cc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/82f72146967e71693f2d4f6646f35c3c00780602", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82f72146967e71693f2d4f6646f35c3c00780602", "html_url": "https://github.com/Rust-GCC/gccrs/commit/82f72146967e71693f2d4f6646f35c3c00780602", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82f72146967e71693f2d4f6646f35c3c00780602/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f4e46e34a2c517e1c6c3d0802aba82a9637d677d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f4e46e34a2c517e1c6c3d0802aba82a9637d677d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f4e46e34a2c517e1c6c3d0802aba82a9637d677d"}], "stats": {"total": 137, "additions": 135, "deletions": 2}, "files": [{"sha": "65efe1e5513d8d771e36bf30de12ad6661dab043", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=82f72146967e71693f2d4f6646f35c3c00780602", "patch": "@@ -1,3 +1,10 @@\n+2016-08-18  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* doc/invoke.texi (fverbose-asm): Note that source code lines\n+\tare emitted, and provide an example.\n+\t* final.c (asm_show_source): New function.\n+\t(final_scan_insn): Call asm_show_source.\n+\n 2016-08-18  David Malcolm  <dmalcolm@redhat.com>\n \n \t* diagnostic-show-locus.c (colorizer::colorizer): Replace diagnostic"}, {"sha": "1f0450135490325f717da947eaefb86560bf07dc", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 83, "deletions": 0, "changes": 83, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=82f72146967e71693f2d4f6646f35c3c00780602", "patch": "@@ -11426,6 +11426,89 @@ debugging the compiler itself).\n extra information to be omitted and is useful when comparing two assembler\n files.\n \n+The added comments include:\n+\n+@itemize @bullet\n+\n+@item\n+information on the compiler version and command-line options,\n+\n+@item\n+the source code lines associated with the assembly instructions,\n+in the form FILENAME:LINENUMBER:CONTENT OF LINE,\n+\n+@item\n+hints on which high-level expressions correspond to\n+the various assembly instruction operands.\n+\n+@end itemize\n+\n+For example, given this C source file:\n+\n+@smallexample\n+int test (int n)\n+@{\n+  int i;\n+  int total = 0;\n+\n+  for (i = 0; i < n; i++)\n+    total += i * i;\n+\n+  return total;\n+@}\n+@end smallexample\n+\n+compiling to (x86_64) assembly via @option{-S} and emitting the result\n+direct to stdout via @option{-o} @option{-}\n+\n+@smallexample\n+gcc -S test.c -fverbose-asm -Os -o -\n+@end smallexample\n+\n+gives output similar to this:\n+\n+@smallexample\n+\t.file\t\"test.c\"\n+# GNU C11 (GCC) version 7.0.0 20160809 (experimental) (x86_64-pc-linux-gnu)\n+  [...snip...]\n+# options passed:\n+  [...snip...]\n+\n+\t.text\n+\t.globl\ttest\n+\t.type\ttest, @@function\n+test:\n+.LFB0:\n+\t.cfi_startproc\n+# test.c:4:   int total = 0;\n+\txorl\t%eax, %eax\t# <retval>\n+# test.c:6:   for (i = 0; i < n; i++)\n+\txorl\t%edx, %edx\t# i\n+.L2:\n+# test.c:6:   for (i = 0; i < n; i++)\n+\tcmpl\t%edi, %edx\t# n, i\n+\tjge\t.L5\t#,\n+# test.c:7:     total += i * i;\n+\tmovl\t%edx, %ecx\t# i, tmp92\n+\timull\t%edx, %ecx\t# i, tmp92\n+# test.c:6:   for (i = 0; i < n; i++)\n+\tincl\t%edx\t# i\n+# test.c:7:     total += i * i;\n+\taddl\t%ecx, %eax\t# tmp92, <retval>\n+\tjmp\t.L2\t#\n+.L5:\n+# test.c:10: @}\n+\tret\n+\t.cfi_endproc\n+.LFE0:\n+\t.size\ttest, .-test\n+\t.ident\t\"GCC: (GNU) 7.0.0 20160809 (experimental)\"\n+\t.section\t.note.GNU-stack,\"\",@@progbits\n+@end smallexample\n+\n+The comments are intended for humans rather than machines and hence the\n+precise format of the comments is subject to change.\n+\n @item -frecord-gcc-switches\n @opindex frecord-gcc-switches\n This switch causes the command line used to invoke the"}, {"sha": "eccc3d817101936b84c62504ceda0bc1dec8eeb5", "filename": "gcc/final.c", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Ffinal.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Ffinal.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffinal.c?ref=82f72146967e71693f2d4f6646f35c3c00780602", "patch": "@@ -2140,6 +2140,26 @@ call_from_call_insn (rtx_call_insn *insn)\n   return x;\n }\n \n+/* Print a comment into the asm showing FILENAME, LINENUM, and the\n+   corresponding source line, if available.  */\n+\n+static void\n+asm_show_source (const char *filename, int linenum)\n+{\n+  if (!filename)\n+    return;\n+\n+  int line_size;\n+  const char *line = location_get_source_line (filename, linenum, &line_size);\n+  if (!line)\n+    return;\n+\n+  fprintf (asm_out_file, \"%s %s:%i: \", ASM_COMMENT_START, filename, linenum);\n+  /* \"line\" is not 0-terminated, so we must use line_size.  */\n+  fwrite (line, 1, line_size, asm_out_file);\n+  fputc ('\\n', asm_out_file);\n+}\n+\n /* The final scan for one insn, INSN.\n    Args are same as in `final', except that INSN\n    is the insn being scanned.\n@@ -2563,8 +2583,12 @@ final_scan_insn (rtx_insn *insn, FILE *file, int optimize_p ATTRIBUTE_UNUSED,\n \t   note in a row.  */\n \tif (!DECL_IGNORED_P (current_function_decl)\n \t    && notice_source_line (insn, &is_stmt))\n-\t  (*debug_hooks->source_line) (last_linenum, last_filename,\n-\t\t\t\t       last_discriminator, is_stmt);\n+\t  {\n+\t    if (flag_verbose_asm)\n+\t      asm_show_source (last_filename, last_linenum);\n+\t    (*debug_hooks->source_line) (last_linenum, last_filename,\n+\t\t\t\t\t last_discriminator, is_stmt);\n+\t  }\n \n \tif (GET_CODE (body) == PARALLEL\n \t    && GET_CODE (XVECEXP (body, 0, 0)) == ASM_INPUT)"}, {"sha": "dd893ca414ab79f284011f748c765a5067b628ab", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=82f72146967e71693f2d4f6646f35c3c00780602", "patch": "@@ -1,3 +1,7 @@\n+2016-08-18  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* gcc.dg/verbose-asm-2.c: New test case.\n+\n 2016-08-18  David Malcolm  <dmalcolm@redhat.com>\n \n \t* gcc.dg/plugin/diagnostic_plugin_test_show_locus.c"}, {"sha": "747bff1875e21672b8ce83b28ab818720708e1d5", "filename": "gcc/testsuite/gcc.dg/verbose-asm-2.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Ftestsuite%2Fgcc.dg%2Fverbose-asm-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82f72146967e71693f2d4f6646f35c3c00780602/gcc%2Ftestsuite%2Fgcc.dg%2Fverbose-asm-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fverbose-asm-2.c?ref=82f72146967e71693f2d4f6646f35c3c00780602", "patch": "@@ -0,0 +1,15 @@\n+/* Ensure that the -fverbose-asm leads to source code information in the generated asm.  */\n+/* { dg-options \"-fverbose-asm\" } */\n+\n+int test (int n)\n+{\n+  int i;\n+  int total = 0;\n+\n+  for (i = 0; i < n; i++)\n+    total += i * i;\n+\n+  return total;\n+}\n+\n+/* { dg-final { scan-assembler \"total = 0\" } } */"}]}