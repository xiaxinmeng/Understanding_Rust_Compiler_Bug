{"sha": "a596d94005f783cb6b0f274b2e17c2454b912277", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTU5NmQ5NDAwNWY3ODNjYjZiMGYyNzRiMmUxN2MyNDU0YjkxMjI3Nw==", "commit": {"author": {"name": "Balaji V. Iyer", "email": "balaji.v.iyer@intel.com", "date": "2014-02-10T16:56:54Z"}, "committer": {"name": "Balaji V. Iyer", "email": "bviyer@gcc.gnu.org", "date": "2014-02-10T16:56:54Z"}, "message": "re PR target/59691 (cilk-plus run failures on non-sse processors)\n\nFix for PR target/59691.\n+2014-02-10  Balaji V. Iyer  <balaji.v.iyer@intel.com>\n+\n+       PR target/59691\n+       * runtime/config/x86/os-unix-sysdep.c (__builtin_cpu_supports): New\n+       function.\n+       (restore_x86_fp_state): Added a check if the cpu supports the\n+       instruction before emitting it.\n+       (sysdep_save_fp_ctrl_state): Likewise.\n+\n\nFrom-SVN: r207664", "tree": {"sha": "e72aa114ed935ee1da85f67fcdc32d306953ae92", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e72aa114ed935ee1da85f67fcdc32d306953ae92"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a596d94005f783cb6b0f274b2e17c2454b912277", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a596d94005f783cb6b0f274b2e17c2454b912277", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a596d94005f783cb6b0f274b2e17c2454b912277", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a596d94005f783cb6b0f274b2e17c2454b912277/comments", "author": null, "committer": null, "parents": [{"sha": "2607ef8a7a92f75fe4d87ffd8a9ec9b367f9b1ec", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2607ef8a7a92f75fe4d87ffd8a9ec9b367f9b1ec", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2607ef8a7a92f75fe4d87ffd8a9ec9b367f9b1ec"}], "stats": {"total": 48, "additions": 38, "deletions": 10}, "files": [{"sha": "c340785992d45e9b4a31f6b4418f519eadb5592c", "filename": "libcilkrts/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a596d94005f783cb6b0f274b2e17c2454b912277/libcilkrts%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a596d94005f783cb6b0f274b2e17c2454b912277/libcilkrts%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcilkrts%2FChangeLog?ref=a596d94005f783cb6b0f274b2e17c2454b912277", "patch": "@@ -1,3 +1,12 @@\n+2014-02-10  Balaji V. Iyer  <balaji.v.iyer@intel.com>\n+\n+\tPR target/59691\n+\t* runtime/config/x86/os-unix-sysdep.c (__builtin_cpu_supports): New\n+\tfunction.\n+\t(restore_x86_fp_state): Added a check if the cpu supports the\n+\tinstruction before emitting it.\n+\t(sysdep_save_fp_ctrl_state): Likewise.\n+\n 2014-01-20  Balaji V. Iyer  <balaji.v.iyer@intel.com>\n \n \tPR other/58996"}, {"sha": "b505ddfb96f74a1b84f07d7367c71613757a851f", "filename": "libcilkrts/runtime/config/x86/os-unix-sysdep.c", "status": "modified", "additions": 29, "deletions": 10, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a596d94005f783cb6b0f274b2e17c2454b912277/libcilkrts%2Fruntime%2Fconfig%2Fx86%2Fos-unix-sysdep.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a596d94005f783cb6b0f274b2e17c2454b912277/libcilkrts%2Fruntime%2Fconfig%2Fx86%2Fos-unix-sysdep.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcilkrts%2Fruntime%2Fconfig%2Fx86%2Fos-unix-sysdep.c?ref=a596d94005f783cb6b0f274b2e17c2454b912277", "patch": "@@ -2,11 +2,9 @@\n  *\n  *************************************************************************\n  *\n- *  @copyright\n- *  Copyright (C) 2009-2013, Intel Corporation\n+ *  Copyright (C) 2009-2014, Intel Corporation\n  *  All rights reserved.\n  *  \n- *  @copyright\n  *  Redistribution and use in source and binary forms, with or without\n  *  modification, are permitted provided that the following conditions\n  *  are met:\n@@ -21,7 +19,6 @@\n  *      contributors may be used to endorse or promote products derived\n  *      from this software without specific prior written permission.\n  *  \n- *  @copyright\n  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n  *  \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n  *  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n@@ -91,6 +88,20 @@ COMMON_SYSDEP int __cilkrts_xchg(volatile int *ptr, int x)\n     return x;\n }\n \n+/*\n+ * The Intel compiler distribution assumes newer CPUs and doesn't yet support\n+ * the __builtin_cpu_supports intrinsic added by GCC 4.8, so just return 1 in\n+ * that environment.\n+ *\n+ * This declaration should generate an error when the Intel compiler adds\n+ * supprt for the intrinsic.\n+ */\n+#ifdef __INTEL_COMPILER\n+static inline int __builtin_cpu_supports(const char *feature)\n+{\n+    return 1;\n+}\n+#endif\n \n /*\n  * Restore the floating point state that is stored in a stack frame at each\n@@ -100,11 +111,16 @@ COMMON_SYSDEP int __cilkrts_xchg(volatile int *ptr, int x)\n  */\n void restore_x86_fp_state (__cilkrts_stack_frame *sf) {\n #ifdef RESTORE_X86_FP_STATE\n-    __asm__ ( \"ldmxcsr %0\\n\\t\"\n-              \"fnclex\\n\\t\"\n-              \"fldcw %1\"\n-              :\n-              : \"m\" (sf->mxcsr), \"m\" (sf->fpcsr));\n+    if (__builtin_cpu_supports(\"sse\"))\n+    {\n+        __asm__ (\"ldmxcsr %0\"\n+                 :\n+                 : \"m\" (sf->mxcsr));\n+    }\n+    __asm__ (\"fnclex\\n\\t\"\n+             \"fldcw %0\"\n+             :\n+             : \"m\" (sf->fpcsr));\n #endif\n }\n \n@@ -115,7 +131,10 @@ void sysdep_save_fp_ctrl_state(__cilkrts_stack_frame *sf)\n #ifdef RESTORE_X86_FP_STATE\n     if (CILK_FRAME_VERSION_VALUE(sf->flags) >= 1)\n     {\n-        __asm__ (\"stmxcsr %0\" : \"=m\" (sf->mxcsr));\n+        if (__builtin_cpu_supports(\"sse\"))\n+        {\n+            __asm__ (\"stmxcsr %0\" : \"=m\" (sf->mxcsr));\n+        }\n         __asm__ (\"fnstsw %0\" : \"=m\" (sf->fpcsr));\n     }\n #endif"}]}