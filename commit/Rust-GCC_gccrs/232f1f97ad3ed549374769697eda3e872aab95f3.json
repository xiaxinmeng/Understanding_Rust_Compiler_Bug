{"sha": "232f1f97ad3ed549374769697eda3e872aab95f3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjMyZjFmOTdhZDNlZDU0OTM3NDc2OTY5N2VkYTNlODcyYWFiOTVmMw==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2015-04-27T10:29:07Z"}, "committer": {"name": "Eric Botcazou", "email": "ebotcazou@gcc.gnu.org", "date": "2015-04-27T10:29:07Z"}, "message": "stor-layout.c (self_referential_component_ref_p): New predicate.\n\n\t* stor-layout.c (self_referential_component_ref_p): New predicate.\n\t(copy_self_referential_tree_r): Use it.\n\t(self_referential_size): Punt for simple operations directly involving\n\tself-referential component references.\n\t* tree-cfg.c (dump_function_to_file): Add missing final curly bracket.\n\nFrom-SVN: r222456", "tree": {"sha": "a2c95407a69e695e95bc79c88324215c682d8408", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a2c95407a69e695e95bc79c88324215c682d8408"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/232f1f97ad3ed549374769697eda3e872aab95f3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/232f1f97ad3ed549374769697eda3e872aab95f3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/232f1f97ad3ed549374769697eda3e872aab95f3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/232f1f97ad3ed549374769697eda3e872aab95f3/comments", "author": null, "committer": null, "parents": [{"sha": "e5115cf9bcfb46f6cc0df6486fee510cbf246640", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e5115cf9bcfb46f6cc0df6486fee510cbf246640", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e5115cf9bcfb46f6cc0df6486fee510cbf246640"}], "stats": {"total": 45, "additions": 31, "deletions": 14}, "files": [{"sha": "3688fb459b117c3144de4c47c63c3f3ab21df1f6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/232f1f97ad3ed549374769697eda3e872aab95f3/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/232f1f97ad3ed549374769697eda3e872aab95f3/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=232f1f97ad3ed549374769697eda3e872aab95f3", "patch": "@@ -1,3 +1,11 @@\n+2015-04-27  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* stor-layout.c (self_referential_component_ref_p): New predicate.\n+\t(copy_self_referential_tree_r): Use it.\n+\t(self_referential_size): Punt for simple operations directly involving\n+\tself-referential component references.\n+\t* tree-cfg.c (dump_function_to_file): Add missing final curly bracket.\n+\n 2015-04-27  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* ipa-icf.c (icf_handled_component_p): Remove redundant tests."}, {"sha": "54bbde67d820d92e303f40cbb26da6ff3f9f2ab2", "filename": "gcc/stor-layout.c", "status": "modified", "additions": 18, "deletions": 13, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/232f1f97ad3ed549374769697eda3e872aab95f3/gcc%2Fstor-layout.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/232f1f97ad3ed549374769697eda3e872aab95f3/gcc%2Fstor-layout.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fstor-layout.c?ref=232f1f97ad3ed549374769697eda3e872aab95f3", "patch": "@@ -127,6 +127,20 @@ variable_size (tree size)\n /* An array of functions used for self-referential size computation.  */\n static GTY(()) vec<tree, va_gc> *size_functions;\n \n+/* Return true if T is a self-referential component reference.  */\n+\n+static bool\n+self_referential_component_ref_p (tree t)\n+{\n+  if (TREE_CODE (t) != COMPONENT_REF)\n+    return false;\n+\n+  while (REFERENCE_CLASS_P (t))\n+    t = TREE_OPERAND (t, 0);\n+\n+  return (TREE_CODE (t) == PLACEHOLDER_EXPR);\n+}\n+\n /* Similar to copy_tree_r but do not copy component references involving\n    PLACEHOLDER_EXPRs.  These nodes are spotted in find_placeholder_in_expr\n    and substituted in substitute_in_expr.  */\n@@ -154,19 +168,10 @@ copy_self_referential_tree_r (tree *tp, int *walk_subtrees, void *data)\n     }\n \n   /* Default case: the component reference.  */\n-  else if (code == COMPONENT_REF)\n+  else if (self_referential_component_ref_p (*tp))\n     {\n-      tree inner;\n-      for (inner = TREE_OPERAND (*tp, 0);\n-\t   REFERENCE_CLASS_P (inner);\n-\t   inner = TREE_OPERAND (inner, 0))\n-\t;\n-\n-      if (TREE_CODE (inner) == PLACEHOLDER_EXPR)\n-\t{\n-\t  *walk_subtrees = 0;\n-\t  return NULL_TREE;\n-\t}\n+      *walk_subtrees = 0;\n+      return NULL_TREE;\n     }\n \n   /* We're not supposed to have them in self-referential size trees\n@@ -199,7 +204,7 @@ self_referential_size (tree size)\n \n   /* Do not factor out simple operations.  */\n   t = skip_simple_constant_arithmetic (size);\n-  if (TREE_CODE (t) == CALL_EXPR)\n+  if (TREE_CODE (t) == CALL_EXPR || self_referential_component_ref_p (t))\n     return size;\n \n   /* Collect the list of self-references in the expression.  */"}, {"sha": "99b27c7dc97d979fb883cf9dce3e2d3231b8749d", "filename": "gcc/tree-cfg.c", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/232f1f97ad3ed549374769697eda3e872aab95f3/gcc%2Ftree-cfg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/232f1f97ad3ed549374769697eda3e872aab95f3/gcc%2Ftree-cfg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-cfg.c?ref=232f1f97ad3ed549374769697eda3e872aab95f3", "patch": "@@ -7441,7 +7441,11 @@ dump_function_to_file (tree fndecl, FILE *file, int flags)\n       else\n \t{\n \t  if (!ignore_topmost_bind)\n-\t    fprintf (file, \"{\\n\");\n+\t    {\n+\t      fprintf (file, \"{\\n\");\n+\t      /* No topmost bind, pretend it's ignored for later.  */\n+\t      ignore_topmost_bind = true;\n+\t    }\n \t  indent = 2;\n \t}\n "}]}