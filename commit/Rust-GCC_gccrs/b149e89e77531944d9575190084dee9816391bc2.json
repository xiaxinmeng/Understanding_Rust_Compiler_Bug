{"sha": "b149e89e77531944d9575190084dee9816391bc2", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjE0OWU4OWU3NzUzMTk0NGQ5NTc1MTkwMDg0ZGVlOTgxNjM5MWJjMg==", "commit": {"author": {"name": "Tom Tromey", "email": "tromey@redhat.com", "date": "2006-05-04T15:29:22Z"}, "committer": {"name": "Tom Tromey", "email": "tromey@gcc.gnu.org", "date": "2006-05-04T15:29:22Z"}, "message": "Class.h (JV_STATE_LOADING): Added comment.\n\n\t* java/lang/Class.h (JV_STATE_LOADING): Added comment.\n\t* Makefile.in: Rebuilt.\n\t* Makefile.am (nat_source_files): Added natSystemClassLoader.cc.\n\t* gnu/gcj/runtime/natSystemClassLoader.cc: New file.\n\t* gnu/gcj/runtime/SystemClassLoader.java (nativeClasses):\n\tNew field.\n\t(loadedClasses): Removed.\n\t(findClass): Declare.\n\t(addClass): Add to nativeClasses, not loadedClasses.\n\nFrom-SVN: r113530", "tree": {"sha": "1e7ea10ce538133713a486e931169337b691095b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1e7ea10ce538133713a486e931169337b691095b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b149e89e77531944d9575190084dee9816391bc2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b149e89e77531944d9575190084dee9816391bc2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b149e89e77531944d9575190084dee9816391bc2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b149e89e77531944d9575190084dee9816391bc2/comments", "author": null, "committer": null, "parents": [{"sha": "5eedb0ce4e6a6d96af8f9ba956dcf0c88796e26f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5eedb0ce4e6a6d96af8f9ba956dcf0c88796e26f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5eedb0ce4e6a6d96af8f9ba956dcf0c88796e26f"}], "stats": {"total": 83, "additions": 67, "deletions": 16}, "files": [{"sha": "88468d4b625bd62aee320ae0fbbbe2bec05ff0dc", "filename": "libjava/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b149e89e77531944d9575190084dee9816391bc2/libjava%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b149e89e77531944d9575190084dee9816391bc2/libjava%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2FChangeLog?ref=b149e89e77531944d9575190084dee9816391bc2", "patch": "@@ -1,3 +1,15 @@\n+2006-05-04  Tom Tromey  <tromey@redhat.com>\n+\n+\t* java/lang/Class.h (JV_STATE_LOADING): Added comment.\n+\t* Makefile.in: Rebuilt.\n+\t* Makefile.am (nat_source_files): Added natSystemClassLoader.cc.\n+\t* gnu/gcj/runtime/natSystemClassLoader.cc: New file.\n+\t* gnu/gcj/runtime/SystemClassLoader.java (nativeClasses):\n+\tNew field.\n+\t(loadedClasses): Removed.\n+\t(findClass): Declare.\n+\t(addClass): Add to nativeClasses, not loadedClasses.\n+\n 2006-05-04  Andrew Haley  <aph@redhat.com>\n \n \tPR java/26858"}, {"sha": "520b18f00d0f6d0d55c807b0dd35ebfec75e37e0", "filename": "libjava/Makefile.am", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b149e89e77531944d9575190084dee9816391bc2/libjava%2FMakefile.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b149e89e77531944d9575190084dee9816391bc2/libjava%2FMakefile.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2FMakefile.am?ref=b149e89e77531944d9575190084dee9816391bc2", "patch": "@@ -783,6 +783,7 @@ gnu/gcj/io/natSimpleSHSStream.cc \\\n gnu/gcj/io/shs.cc \\\n gnu/gcj/runtime/natFinalizerThread.cc \\\n gnu/gcj/runtime/natSharedLibLoader.cc \\\n+gnu/gcj/runtime/natSystemClassLoader.cc \\\n gnu/gcj/runtime/natStringBuffer.cc \\\n gnu/gcj/util/natDebug.cc \\\n gnu/java/lang/natMainThread.cc \\"}, {"sha": "eb4af80a55f4300a13ea45cfda0e7055d823b2ee", "filename": "libjava/Makefile.in", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b149e89e77531944d9575190084dee9816391bc2/libjava%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b149e89e77531944d9575190084dee9816391bc2/libjava%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2FMakefile.in?ref=b149e89e77531944d9575190084dee9816391bc2", "patch": "@@ -254,6 +254,7 @@ am__libgcj_la_SOURCES_DIST = prims.cc jni.cc exception.cc \\\n \tgnu/gcj/io/natSimpleSHSStream.cc gnu/gcj/io/shs.cc \\\n \tgnu/gcj/runtime/natFinalizerThread.cc \\\n \tgnu/gcj/runtime/natSharedLibLoader.cc \\\n+\tgnu/gcj/runtime/natSystemClassLoader.cc \\\n \tgnu/gcj/runtime/natStringBuffer.cc gnu/gcj/util/natDebug.cc \\\n \tgnu/java/lang/natMainThread.cc \\\n \tgnu/java/net/natPlainDatagramSocketImpl.cc \\\n@@ -294,6 +295,7 @@ am__objects_2 = gnu/classpath/natSystemProperties.lo \\\n \tgnu/gcj/io/natSimpleSHSStream.lo gnu/gcj/io/shs.lo \\\n \tgnu/gcj/runtime/natFinalizerThread.lo \\\n \tgnu/gcj/runtime/natSharedLibLoader.lo \\\n+\tgnu/gcj/runtime/natSystemClassLoader.lo \\\n \tgnu/gcj/runtime/natStringBuffer.lo gnu/gcj/util/natDebug.lo \\\n \tgnu/java/lang/natMainThread.lo \\\n \tgnu/java/net/natPlainDatagramSocketImpl.lo \\\n@@ -6749,6 +6751,7 @@ gnu/gcj/io/natSimpleSHSStream.cc \\\n gnu/gcj/io/shs.cc \\\n gnu/gcj/runtime/natFinalizerThread.cc \\\n gnu/gcj/runtime/natSharedLibLoader.cc \\\n+gnu/gcj/runtime/natSystemClassLoader.cc \\\n gnu/gcj/runtime/natStringBuffer.cc \\\n gnu/gcj/util/natDebug.cc \\\n gnu/java/lang/natMainThread.cc \\\n@@ -7084,6 +7087,9 @@ gnu/gcj/runtime/natFinalizerThread.lo:  \\\n gnu/gcj/runtime/natSharedLibLoader.lo:  \\\n \tgnu/gcj/runtime/$(am__dirstamp) \\\n \tgnu/gcj/runtime/$(DEPDIR)/$(am__dirstamp)\n+gnu/gcj/runtime/natSystemClassLoader.lo:  \\\n+\tgnu/gcj/runtime/$(am__dirstamp) \\\n+\tgnu/gcj/runtime/$(DEPDIR)/$(am__dirstamp)\n gnu/gcj/runtime/natStringBuffer.lo: gnu/gcj/runtime/$(am__dirstamp) \\\n \tgnu/gcj/runtime/$(DEPDIR)/$(am__dirstamp)\n gnu/gcj/util/$(am__dirstamp):\n@@ -7415,6 +7421,8 @@ mostlyclean-compile:\n \t-rm -f gnu/gcj/runtime/natSharedLibLoader.lo\n \t-rm -f gnu/gcj/runtime/natStringBuffer.$(OBJEXT)\n \t-rm -f gnu/gcj/runtime/natStringBuffer.lo\n+\t-rm -f gnu/gcj/runtime/natSystemClassLoader.$(OBJEXT)\n+\t-rm -f gnu/gcj/runtime/natSystemClassLoader.lo\n \t-rm -f gnu/gcj/tools/gcj_dbtool/Main.$(OBJEXT)\n \t-rm -f gnu/gcj/tools/gcj_dbtool/natMain.$(OBJEXT)\n \t-rm -f gnu/gcj/util/natDebug.$(OBJEXT)\n@@ -7588,6 +7596,7 @@ distclean-compile:\n @AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/runtime/$(DEPDIR)/natFinalizerThread.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/runtime/$(DEPDIR)/natSharedLibLoader.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/runtime/$(DEPDIR)/natStringBuffer.Plo@am__quote@\n+@AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/runtime/$(DEPDIR)/natSystemClassLoader.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/tools/gcj_dbtool/$(DEPDIR)/Main.Po@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/tools/gcj_dbtool/$(DEPDIR)/natMain.Po@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@gnu/gcj/util/$(DEPDIR)/natDebug.Plo@am__quote@"}, {"sha": "7470542cb7c96c3ad8bf2ef157bb5de55d94c3e0", "filename": "libjava/gnu/gcj/runtime/SystemClassLoader.java", "status": "modified", "additions": 6, "deletions": 16, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b149e89e77531944d9575190084dee9816391bc2/libjava%2Fgnu%2Fgcj%2Fruntime%2FSystemClassLoader.java", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b149e89e77531944d9575190084dee9816391bc2/libjava%2Fgnu%2Fgcj%2Fruntime%2FSystemClassLoader.java", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fgnu%2Fgcj%2Fruntime%2FSystemClassLoader.java?ref=b149e89e77531944d9575190084dee9816391bc2", "patch": "@@ -22,7 +22,9 @@ public final class SystemClassLoader extends URLClassLoader\n     super(new URL[0], parent);\n   }\n \n-  private HashMap loadedClasses;\n+  // This holds all the \"native\" classes linked into the executable\n+  // and registered with this loader.\n+  private HashMap nativeClasses = new HashMap();\n \n   // This is called to register a native class which was linked into\n   // the application but which is registered with the system class\n@@ -42,23 +44,11 @@ void addClass(Class klass)\n       }\n       \n     // Use reflection to access the package-private \"loadedClasses\" field.\n-    if (this.loadedClasses == null)\n-      {\n-\ttry\n-\t{\n-\t  Class cl = java.lang.ClassLoader.class;\n-\t  Field lcField = cl.getDeclaredField(\"loadedClasses\");\n-\t  lcField.setAccessible(true);\n-\t  this.loadedClasses = (HashMap) lcField.get(this);\n-\t}\n-\tcatch (Exception x)\n-\t{\n-\t  throw new RuntimeException(x);\n-\t}      \n-      }\n-    this.loadedClasses.put(className, klass);\n+    nativeClasses.put(className, klass);\n   }\n \n+  protected native Class findClass(String name);\n+\n   // We add the URLs to the system class loader late.  The reason for\n   // this is that during bootstrap we don't want to parse URLs or\n   // create URL connections, since that will result in circularities"}, {"sha": "7052bc8e800fa45e74301e7dbf266c2f65642be1", "filename": "libjava/gnu/gcj/runtime/natSystemClassLoader.cc", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b149e89e77531944d9575190084dee9816391bc2/libjava%2Fgnu%2Fgcj%2Fruntime%2FnatSystemClassLoader.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b149e89e77531944d9575190084dee9816391bc2/libjava%2Fgnu%2Fgcj%2Fruntime%2FnatSystemClassLoader.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fgnu%2Fgcj%2Fruntime%2FnatSystemClassLoader.cc?ref=b149e89e77531944d9575190084dee9816391bc2", "patch": "@@ -0,0 +1,31 @@\n+// natSystemClassLoader.cc - native code for system class loader\n+\n+/* Copyright (C) Free Software Foundation\n+\n+   This file is part of libgcj.\n+\n+This software is copyrighted work licensed under the terms of the\n+Libgcj License.  Please consult the file \"LIBGCJ_LICENSE\" for\n+details.  */\n+\n+#include <config.h>\n+#include <platform.h>\n+\n+#include <gcj/cni.h>\n+#include <jvm.h>\n+#include <execution.h>\n+\n+#include <gnu/gcj/runtime/SystemClassLoader.h>\n+#include <java/lang/ClassNotFoundException.h>\n+#include <java/util/HashMap.h>\n+\n+jclass\n+gnu::gcj::runtime::SystemClassLoader::findClass (jstring name)\n+{\n+  jclass result = (jclass) nativeClasses->get(name);\n+  if (! result)\n+    return URLClassLoader::findClass(name);\n+  // Never return a class whose supers are not installed.\n+  _Jv_Linker::wait_for_state (result, JV_STATE_LOADING);\n+  return result;\n+}"}, {"sha": "722129498aae38ce379a2b12752b76c333d4d3b8", "filename": "libjava/java/lang/Class.h", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b149e89e77531944d9575190084dee9816391bc2/libjava%2Fjava%2Flang%2FClass.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b149e89e77531944d9575190084dee9816391bc2/libjava%2Fjava%2Flang%2FClass.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fjava%2Flang%2FClass.h?ref=b149e89e77531944d9575190084dee9816391bc2", "patch": "@@ -59,6 +59,14 @@ enum\n   JV_STATE_NOTHING = 0,\t\t// Set by compiler.\n \n   JV_STATE_PRELOADING = 1,\t// Can do _Jv_FindClass.\n+\n+  // There is an invariant through libgcj that a class will always be\n+  // at a state greater than or equal to JV_STATE_LOADING when it is\n+  // returned by a class loader to user code.  Hence, defineclass.cc\n+  // installs supers before returning a class, C++-ABI-compiled\n+  // classes are created with supers installed, and BC-ABI-compiled\n+  // classes are linked to this state before being returned by their\n+  // class loader.\n   JV_STATE_LOADING = 3,\t\t// Has super installed.\n   JV_STATE_READ = 4,\t\t// Has been completely defined.\n   JV_STATE_LOADED = 5,\t\t// Has Miranda methods defined."}]}