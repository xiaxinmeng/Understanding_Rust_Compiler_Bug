{"sha": "17412a74c531a21595311df5428f26552e82dfa8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTc0MTJhNzRjNTMxYTIxNTk1MzExZGY1NDI4ZjI2NTUyZTgyZGZhOA==", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2020-06-12T09:22:05Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2020-06-12T09:31:07Z"}, "message": "libstdc++: Make std::atomic_flag::test members const\n\nAlso fix the tests so they run without an explicit -std=gnu++2a in the\nRUNTESTFLAGS, and test the new function on const-qualified objects.\n\n\t* include/bits/atomic_base.h (atomic_flag::test): Add missing\n\tconst qualifiers.\n\t* testsuite/29_atomics/atomic_flag/test/explicit.cc: Add\n\tdg-options and verify results of test function.\n\t* testsuite/29_atomics/atomic_flag/test/implicit.cc: Likewise.", "tree": {"sha": "2617ccc1d5ae629d58dd10285bf1ed817a215680", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2617ccc1d5ae629d58dd10285bf1ed817a215680"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/17412a74c531a21595311df5428f26552e82dfa8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/17412a74c531a21595311df5428f26552e82dfa8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/17412a74c531a21595311df5428f26552e82dfa8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/17412a74c531a21595311df5428f26552e82dfa8/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6db99a61a86814241b66a17a65633338d86cc17", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a6db99a61a86814241b66a17a65633338d86cc17", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a6db99a61a86814241b66a17a65633338d86cc17"}], "stats": {"total": 36, "additions": 26, "deletions": 10}, "files": [{"sha": "ebcfeb4d51a4da1b6698795ea03d8feb00065291", "filename": "libstdc++-v3/include/bits/atomic_base.h", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17412a74c531a21595311df5428f26552e82dfa8/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fatomic_base.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17412a74c531a21595311df5428f26552e82dfa8/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fatomic_base.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fatomic_base.h?ref=17412a74c531a21595311df5428f26552e82dfa8", "patch": "@@ -212,15 +212,15 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n #define __cpp_lib_atomic_flag_test 201907L\n \n     _GLIBCXX_ALWAYS_INLINE bool\n-    test(memory_order __m = memory_order_seq_cst) noexcept\n+    test(memory_order __m = memory_order_seq_cst) const noexcept\n     {\n       __atomic_flag_data_type __v;\n       __atomic_load(&_M_i, &__v, int(__m));\n       return __v == __GCC_ATOMIC_TEST_AND_SET_TRUEVAL;\n     }\n \n     _GLIBCXX_ALWAYS_INLINE bool\n-    test(memory_order __m = memory_order_seq_cst) volatile noexcept\n+    test(memory_order __m = memory_order_seq_cst) const volatile noexcept\n     {\n       __atomic_flag_data_type __v;\n       __atomic_load(&_M_i, &__v, int(__m));"}, {"sha": "4f2a10d6d40fb91d74030f952ee3eee3b56a96ec", "filename": "libstdc++-v3/testsuite/29_atomics/atomic_flag/test/explicit.cc", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17412a74c531a21595311df5428f26552e82dfa8/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fatomic_flag%2Ftest%2Fexplicit.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17412a74c531a21595311df5428f26552e82dfa8/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fatomic_flag%2Ftest%2Fexplicit.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fatomic_flag%2Ftest%2Fexplicit.cc?ref=17412a74c531a21595311df5428f26552e82dfa8", "patch": "@@ -1,3 +1,4 @@\n+// { dg-options \"-std=gnu++2a\" }\n // { dg-do run { target c++2a } }\n // { dg-require-thread-fence \"\" }\n \n@@ -19,14 +20,21 @@\n // <http://www.gnu.org/licenses/>.\n \n #include <atomic>\n+#include <testsuite_hooks.h>\n \n int main()\n {\n   using namespace std;\n-  atomic_flag af = ATOMIC_FLAG_INIT;\n \n-  if (af.test(memory_order_acquire))\n-    af.clear(memory_order_release);\n+  atomic_flag af0 = ATOMIC_FLAG_INIT;\n+  VERIFY( ! af0.test(memory_order_acquire) );\n \n-  return 0;\n+  atomic_flag af{true};\n+  const atomic_flag& caf = af;\n+\n+  VERIFY( af.test(memory_order_acquire) );\n+  VERIFY( caf.test(memory_order_acquire) );\n+  af.clear(memory_order_release);\n+  VERIFY( ! af.test(memory_order_acquire) );\n+  VERIFY( ! caf.test(memory_order_acquire) );\n }"}, {"sha": "3889f32b98aab200b8b94c0983a8f768db01ce83", "filename": "libstdc++-v3/testsuite/29_atomics/atomic_flag/test/implicit.cc", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17412a74c531a21595311df5428f26552e82dfa8/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fatomic_flag%2Ftest%2Fimplicit.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17412a74c531a21595311df5428f26552e82dfa8/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fatomic_flag%2Ftest%2Fimplicit.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fatomic_flag%2Ftest%2Fimplicit.cc?ref=17412a74c531a21595311df5428f26552e82dfa8", "patch": "@@ -1,3 +1,4 @@\n+// { dg-options \"-std=gnu++2a\" }\n // { dg-do run { target c++2a } }\n // { dg-require-thread-fence \"\" }\n \n@@ -19,14 +20,21 @@\n // <http://www.gnu.org/licenses/>.\n \n #include <atomic>\n+#include <testsuite_hooks.h>\n \n int main()\n {\n   using namespace std;\n-  atomic_flag af = ATOMIC_FLAG_INIT;\n \n-  if (af.test())\n-    af.clear();\n+  atomic_flag af0 = ATOMIC_FLAG_INIT;\n+  VERIFY( ! af0.test(memory_order_acquire) );\n \n-  return 0;\n+  atomic_flag af{true};\n+  const atomic_flag& caf = af;\n+\n+  VERIFY( af.test() );\n+  VERIFY( caf.test() );\n+  af.clear();\n+  VERIFY( ! af.test() );\n+  VERIFY( ! caf.test() );\n }"}]}