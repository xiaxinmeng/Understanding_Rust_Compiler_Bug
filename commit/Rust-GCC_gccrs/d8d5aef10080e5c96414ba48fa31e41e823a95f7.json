{"sha": "d8d5aef10080e5c96414ba48fa31e41e823a95f7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDhkNWFlZjEwMDgwZTVjOTY0MTRiYTQ4ZmEzMWU0MWU4MjNhOTVmNw==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2015-01-12T09:24:18Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2015-01-12T09:24:18Z"}, "message": "re PR ipa/63470 (internal compiler error: in estimate_edge_growth, at ipa-inline.h:308)\n\n\n\n\tPR ipa/63470\n\t* ipa-inline-analysis.c (inline_edge_duplication_hook): Adjust\n\tcost when edge becomes direct.\n\t* ipa-prop.c (make_edge_direct): Do not adjust when speculation\n\tis resolved or when introducing new speculation.\n\t* testsuite/g++.dg/ipa/pr63470.C: New testcase.\n\nFrom-SVN: r219451", "tree": {"sha": "993913a7158e643f48bf7e882b92891566a2049e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/993913a7158e643f48bf7e882b92891566a2049e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d8d5aef10080e5c96414ba48fa31e41e823a95f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d8d5aef10080e5c96414ba48fa31e41e823a95f7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d8d5aef10080e5c96414ba48fa31e41e823a95f7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d8d5aef10080e5c96414ba48fa31e41e823a95f7/comments", "author": null, "committer": null, "parents": [{"sha": "0d2dd460fe627cf460536b80b99f56682775fe78", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0d2dd460fe627cf460536b80b99f56682775fe78", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0d2dd460fe627cf460536b80b99f56682775fe78"}], "stats": {"total": 95, "additions": 89, "deletions": 6}, "files": [{"sha": "29dab900e8c5119cc71e263825004fdead766c0d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=d8d5aef10080e5c96414ba48fa31e41e823a95f7", "patch": "@@ -1,3 +1,11 @@\n+2015-01-12  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\tPR ipa/63470\n+\t* ipa-inline-analysis.c (inline_edge_duplication_hook): Adjust\n+\tcost when edge becomes direct.\n+\t* ipa-prop.c (make_edge_direct): Do not adjust when speculation\n+\tis resolved or when introducing new speculation.\n+\n 2015-01-12  Chen Gang  <gang.chen.5i5j@gmail.com>\n \n \tPR ipa/64551"}, {"sha": "ec91d8ec9af1fb8b7d55244072f54a809b3708ab", "filename": "gcc/ipa-inline-analysis.c", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Fipa-inline-analysis.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Fipa-inline-analysis.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-inline-analysis.c?ref=d8d5aef10080e5c96414ba48fa31e41e823a95f7", "patch": "@@ -1312,6 +1312,13 @@ inline_edge_duplication_hook (struct cgraph_edge *src,\n   info->predicate = NULL;\n   edge_set_predicate (dst, srcinfo->predicate);\n   info->param = srcinfo->param.copy ();\n+  if (!dst->indirect_unknown_callee && src->indirect_unknown_callee)\n+    {\n+      info->call_stmt_size -= (eni_size_weights.indirect_call_cost\n+\t\t\t       - eni_size_weights.call_cost);\n+      info->call_stmt_time -= (eni_time_weights.indirect_call_cost\n+\t\t\t       - eni_time_weights.call_cost);\n+    }\n }\n \n "}, {"sha": "01f4111b097970906b27e468083e8d21cf25e7fe", "filename": "gcc/ipa-prop.c", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Fipa-prop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Fipa-prop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-prop.c?ref=d8d5aef10080e5c96414ba48fa31e41e823a95f7", "patch": "@@ -2737,7 +2737,20 @@ ipa_make_edge_direct_to_target (struct cgraph_edge *ie, tree target,\n \t\t       ie->caller->name (), callee->name ());\n     }\n   if (!speculative)\n-    ie = ie->make_direct (callee);\n+    {\n+      struct cgraph_edge *orig = ie;\n+      ie = ie->make_direct (callee);\n+      /* If we resolved speculative edge the cost is already up to date\n+\t for direct call (adjusted by inline_edge_duplication_hook).  */\n+      if (ie == orig)\n+\t{\n+\t  es = inline_edge_summary (ie);\n+\t  es->call_stmt_size -= (eni_size_weights.indirect_call_cost\n+\t\t\t\t - eni_size_weights.call_cost);\n+\t  es->call_stmt_time -= (eni_time_weights.indirect_call_cost\n+\t\t\t\t - eni_time_weights.call_cost);\n+\t}\n+    }\n   else\n     {\n       if (!callee->can_be_discarded_p ())\n@@ -2747,14 +2760,10 @@ ipa_make_edge_direct_to_target (struct cgraph_edge *ie, tree target,\n \t  if (alias)\n \t    callee = alias;\n \t}\n+      /* make_speculative will update ie's cost to direct call cost. */\n       ie = ie->make_speculative\n \t     (callee, ie->count * 8 / 10, ie->frequency * 8 / 10);\n     }\n-  es = inline_edge_summary (ie);\n-  es->call_stmt_size -= (eni_size_weights.indirect_call_cost\n-\t\t\t - eni_size_weights.call_cost);\n-  es->call_stmt_time -= (eni_time_weights.indirect_call_cost\n-\t\t\t - eni_time_weights.call_cost);\n \n   return ie;\n }"}, {"sha": "937826612e76aa51f610a00ae61f897024cf460f", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=d8d5aef10080e5c96414ba48fa31e41e823a95f7", "patch": "@@ -1,3 +1,8 @@\n+2015-01-12  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\tPR ipa/63470\n+\t* testsuite/g++.dg/ipa/pr63470.C: New testcase.\n+\n 2015-01-11  Janus Weil  <janus@gcc.gnu.org>\n \n \tPR fortran/63733"}, {"sha": "e6fa73bcd4c71c048d4757d6c23a54b804270be4", "filename": "gcc/testsuite/g++.dg/ipa/pr63470.C", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr63470.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8d5aef10080e5c96414ba48fa31e41e823a95f7/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr63470.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr63470.C?ref=d8d5aef10080e5c96414ba48fa31e41e823a95f7", "patch": "@@ -0,0 +1,54 @@\n+/* PR ipa/63470.C */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -finline-functions\" } */\n+\n+class A\n+{\n+public:\n+  virtual bool m_fn1 ();\n+  virtual const char **m_fn2 (int);\n+  virtual int m_fn3 ();\n+};\n+class FTjackSupport : A\n+{\n+  ~FTjackSupport ();\n+  bool m_fn1 ();\n+  bool m_fn4 ();\n+  const char **\n+  m_fn2 (int)\n+  {\n+  }\n+  int _inited;\n+  int *_jackClient;\n+  int _activePathCount;\n+}\n+\n+* a;\n+void fn1 (...);\n+void fn2 (void *);\n+int fn3 (int *);\n+FTjackSupport::~FTjackSupport () { m_fn4 (); }\n+\n+bool\n+FTjackSupport::m_fn1 ()\n+{\n+  if (!_jackClient)\n+    return 0;\n+  for (int i=0; _activePathCount; ++i)\n+    if (m_fn2 (i))\n+      fn2 (a);\n+  if (m_fn3 ())\n+    fn2 (a);\n+  if (fn3 (_jackClient))\n+    fn1 (0);\n+}\n+\n+bool\n+FTjackSupport::m_fn4 ()\n+{\n+  if (_inited && _jackClient)\n+    {\n+      m_fn1 ();\n+      return 0;\n+    }\n+}"}]}