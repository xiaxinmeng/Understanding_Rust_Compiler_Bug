{"sha": "c7d3bb7623a428af85bd04c7f225ed54241c29bd", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzdkM2JiNzYyM2E0MjhhZjg1YmQwNGM3ZjIyNWVkNTQyNDFjMjliZA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2011-01-17T22:26:42Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2011-01-17T22:26:42Z"}, "message": "re PR fortran/47331 (ICE in make_decl_rtl, at varasm.c:1133 (with -fopenmp))\n\n\tPR fortran/47331\n\t* gfortran.h (struct gfc_omp_saved_state): New type.\n\t(gfc_omp_save_and_clear_state, gfc_omp_restore_state): New prototypes.\n\t* resolve.c (resolve_global_procedure): Call it around gfc_resolve\n\tcall.\n\t* openmp.c (gfc_omp_save_and_clear_state, gfc_omp_restore_state): New\n\tfunctions.\n\n\t* gfortran.dg/gomp/pr47331.f90: New test.\n\nFrom-SVN: r168935", "tree": {"sha": "aa50e1a8b8b10ba96d0ffb0526298e3164516071", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aa50e1a8b8b10ba96d0ffb0526298e3164516071"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c7d3bb7623a428af85bd04c7f225ed54241c29bd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c7d3bb7623a428af85bd04c7f225ed54241c29bd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c7d3bb7623a428af85bd04c7f225ed54241c29bd", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c7d3bb7623a428af85bd04c7f225ed54241c29bd/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f0fc7be52568981d377ec6910013e75b39263276", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f0fc7be52568981d377ec6910013e75b39263276", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f0fc7be52568981d377ec6910013e75b39263276"}], "stats": {"total": 72, "additions": 72, "deletions": 0}, "files": [{"sha": "50492ccbef8f305f0c16b4becd65a270a397b522", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=c7d3bb7623a428af85bd04c7f225ed54241c29bd", "patch": "@@ -1,3 +1,13 @@\n+2011-01-17  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/47331\n+\t* gfortran.h (struct gfc_omp_saved_state): New type.\n+\t(gfc_omp_save_and_clear_state, gfc_omp_restore_state): New prototypes.\n+\t* resolve.c (resolve_global_procedure): Call it around gfc_resolve\n+\tcall.\n+\t* openmp.c (gfc_omp_save_and_clear_state, gfc_omp_restore_state): New\n+\tfunctions.\n+\n 2011-01-17  Tobias Burnus  <burnus@net-b.de>\n \n \tPR fortran/47327"}, {"sha": "ebba2a814fb48cc0c4b8c1d453137835ec4f28fc", "filename": "gcc/fortran/gfortran.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2Fgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2Fgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.h?ref=c7d3bb7623a428af85bd04c7f225ed54241c29bd", "patch": "@@ -2651,11 +2651,14 @@ void gfc_free_case_list (gfc_case *);\n gfc_expr *gfc_get_parentheses (gfc_expr *);\n \n /* openmp.c */\n+struct gfc_omp_saved_state { void *ptrs[2]; int ints[1]; };\n void gfc_free_omp_clauses (gfc_omp_clauses *);\n void gfc_resolve_omp_directive (gfc_code *, gfc_namespace *);\n void gfc_resolve_do_iterator (gfc_code *, gfc_symbol *);\n void gfc_resolve_omp_parallel_blocks (gfc_code *, gfc_namespace *);\n void gfc_resolve_omp_do_blocks (gfc_code *, gfc_namespace *);\n+void gfc_omp_save_and_clear_state (struct gfc_omp_saved_state *);\n+void gfc_omp_restore_state (struct gfc_omp_saved_state *);\n \n /* expr.c */\n void gfc_free_actual_arglist (gfc_actual_arglist *);"}, {"sha": "24e32eb5d044879046f31131d35b0cf3bf55e377", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=c7d3bb7623a428af85bd04c7f225ed54241c29bd", "patch": "@@ -1390,6 +1390,31 @@ gfc_resolve_omp_parallel_blocks (gfc_code *code, gfc_namespace *ns)\n }\n \n \n+/* Save and clear openmp.c private state.  */\n+\n+void\n+gfc_omp_save_and_clear_state (struct gfc_omp_saved_state *state)\n+{\n+  state->ptrs[0] = omp_current_ctx;\n+  state->ptrs[1] = omp_current_do_code;\n+  state->ints[0] = omp_current_do_collapse;\n+  omp_current_ctx = NULL;\n+  omp_current_do_code = NULL;\n+  omp_current_do_collapse = 0;\n+}\n+\n+\n+/* Restore openmp.c private state from the saved state.  */\n+\n+void\n+gfc_omp_restore_state (struct gfc_omp_saved_state *state)\n+{\n+  omp_current_ctx = (struct omp_context *) state->ptrs[0];\n+  omp_current_do_code = (gfc_code *) state->ptrs[1];\n+  omp_current_do_collapse = state->ints[0];\n+}\n+\n+\n /* Note a DO iterator variable.  This is special in !$omp parallel\n    construct, where they are predetermined private.  */\n "}, {"sha": "ed39e78d9b58e12920c7229959a47a228c7420e4", "filename": "gcc/fortran/resolve.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2Fresolve.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ffortran%2Fresolve.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fresolve.c?ref=c7d3bb7623a428af85bd04c7f225ed54241c29bd", "patch": "@@ -2011,11 +2011,14 @@ resolve_global_procedure (gfc_symbol *sym, locus *where,\n       if (!gsym->ns->resolved)\n \t{\n \t  gfc_dt_list *old_dt_list;\n+\t  struct gfc_omp_saved_state old_omp_state;\n \n \t  /* Stash away derived types so that the backend_decls do not\n \t     get mixed up.  */\n \t  old_dt_list = gfc_derived_types;\n \t  gfc_derived_types = NULL;\n+\t  /* And stash away openmp state.  */\n+\t  gfc_omp_save_and_clear_state (&old_omp_state);\n \n \t  gfc_resolve (gsym->ns);\n \n@@ -2025,6 +2028,8 @@ resolve_global_procedure (gfc_symbol *sym, locus *where,\n \n \t  /* Restore the derived types of this namespace.  */\n \t  gfc_derived_types = old_dt_list;\n+\t  /* And openmp state.  */\n+\t  gfc_omp_restore_state (&old_omp_state);\n \t}\n \n       /* Make sure that translation for the gsymbol occurs before"}, {"sha": "33b7c549a3b55273fb6b1ffcc9f77ba3a89d3dc1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c7d3bb7623a428af85bd04c7f225ed54241c29bd", "patch": "@@ -1,3 +1,8 @@\n+2011-01-17  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/47331\n+\t* gfortran.dg/gomp/pr47331.f90: New test.\n+\n 2011-01-17  Nicola Pero  <nicola.pero@meta-innovation.com>\n \n \tPR objc/47314"}, {"sha": "71713e02233fa42909aafe90569e3e6319d04eed", "filename": "gcc/testsuite/gfortran.dg/gomp/pr47331.f90", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr47331.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7d3bb7623a428af85bd04c7f225ed54241c29bd/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr47331.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr47331.f90?ref=c7d3bb7623a428af85bd04c7f225ed54241c29bd", "patch": "@@ -0,0 +1,24 @@\n+! PR fortran/47331\n+! { dg-do compile }\n+! { dg-options \"-fopenmp -fwhole-file\" }\n+\n+subroutine foo\n+  !$omp parallel\n+    call bar ()\n+  !$omp end parallel\n+end subroutine foo\n+\n+subroutine bar\n+  integer :: k\n+  do k=1,5\n+    call baz (k)\n+  end do\n+end subroutine bar\n+\n+subroutine baz (k)\n+  integer :: k\n+end subroutine\n+\n+program pr47331\n+  call foo\n+end program pr47331"}]}