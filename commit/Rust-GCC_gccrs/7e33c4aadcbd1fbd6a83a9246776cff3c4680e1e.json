{"sha": "7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6N2UzM2M0YWFkY2JkMWZiZDZhODNhOTI0Njc3NmNmZjNjNDY4MGUxZQ==", "commit": {"author": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2011-01-22T00:12:00Z"}, "committer": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2011-01-22T00:12:00Z"}, "message": "Avoid deadlock creating new thread.\n\nFrom-SVN: r169114", "tree": {"sha": "9c293c211f8d55d058e950363b288392bf35ea66", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9c293c211f8d55d058e950363b288392bf35ea66"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e/comments", "author": null, "committer": null, "parents": [{"sha": "cf606aeb06898a190a219f51b2a627eddc8f0a70", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cf606aeb06898a190a219f51b2a627eddc8f0a70", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cf606aeb06898a190a219f51b2a627eddc8f0a70"}], "stats": {"total": 8, "additions": 8, "deletions": 0}, "files": [{"sha": "d826d479f5c68da01cbe249031cbbd33ce440ca2", "filename": "libgo/runtime/malloc.goc", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e/libgo%2Fruntime%2Fmalloc.goc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e/libgo%2Fruntime%2Fmalloc.goc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgo%2Fruntime%2Fmalloc.goc?ref=7e33c4aadcbd1fbd6a83a9246776cff3c4680e1e", "patch": "@@ -255,6 +255,9 @@ runtime_allocmcache(void)\n {\n \tMCache *c;\n \n+\tif(!__sync_bool_compare_and_swap(&m->mallocing, 0, 1))\n+\t\truntime_throw(\"allocmcache - deadlock\");\n+\n \truntime_lock(&runtime_mheap);\n \tc = runtime_FixAlloc_Alloc(&runtime_mheap.cachealloc);\n \n@@ -264,6 +267,11 @@ runtime_allocmcache(void)\n \tmstats.mcache_inuse = runtime_mheap.cachealloc.inuse;\n \tmstats.mcache_sys = runtime_mheap.cachealloc.sys;\n \truntime_unlock(&runtime_mheap);\n+\n+\t__sync_bool_compare_and_swap(&m->mallocing, 1, 0);\n+\tif(__sync_bool_compare_and_swap(&m->gcing, 1, 0))\n+\t\t__go_run_goroutine_gc(2);\n+\n \treturn c;\n }\n "}]}