{"sha": "543ba35905b948a6cd0cf39832a020597068570d", "node_id": "C_kwDOANBUbNoAKDU0M2JhMzU5MDViOTQ4YTZjZDBjZjM5ODMyYTAyMDU5NzA2ODU3MGQ", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-09-30T12:41:09Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-02-21T11:36:31Z"}, "message": "gccrs: Add catch for recusive type queries\n\nWhen we have a type query where by generic substitution occurs we can hit\nthe case where we need to Probe the bounds of the substited item to\ndetermine whether the the bounds are compatible this can cause us to\nend up querying the same type recursively.\n\nFixes #1550\n\ngcc/rust/ChangeLog:\n\n\t* typecheck/rust-hir-type-check-base.cc (TypeCheckBase::query_type):\n\tCheck for recursive queries.\n\t* typecheck/rust-hir-type-check.h: New functions: `query_completed`,\n\t`query_in_progress`, `insert_query`.\n\t* typecheck/rust-tyty-bounds.cc (TypeBoundsProbe::scan): Use `query_type` API.", "tree": {"sha": "b68b7b8997d8a65511c7120ba73630eb34f49dbd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b68b7b8997d8a65511c7120ba73630eb34f49dbd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/543ba35905b948a6cd0cf39832a020597068570d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/543ba35905b948a6cd0cf39832a020597068570d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/543ba35905b948a6cd0cf39832a020597068570d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/543ba35905b948a6cd0cf39832a020597068570d/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e8eb102200902e12c1b00e867e338be0a92c292", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1e8eb102200902e12c1b00e867e338be0a92c292", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1e8eb102200902e12c1b00e867e338be0a92c292"}], "stats": {"total": 27, "additions": 25, "deletions": 2}, "files": [{"sha": "85826aec8fe955336f41984973f1ab2c2ce9ef23", "filename": "gcc/rust/typecheck/rust-hir-type-check-base.cc", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/543ba35905b948a6cd0cf39832a020597068570d/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-base.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/543ba35905b948a6cd0cf39832a020597068570d/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-base.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-base.cc?ref=543ba35905b948a6cd0cf39832a020597068570d", "patch": "@@ -495,14 +495,20 @@ TypeCheckBase::resolve_generic_params (\n bool\n TypeCheckBase::query_type (HirId reference, TyTy::BaseType **result)\n {\n+  if (context->query_in_progress (reference))\n+    return false;\n+\n   if (context->lookup_type (reference, result))\n     return true;\n \n+  context->insert_query (reference);\n+\n   HIR::Item *item = mappings->lookup_hir_item (reference);\n   if (item != nullptr)\n     {\n       rust_debug_loc (item->get_locus (), \"resolved item {%u} to\", reference);\n       *result = TypeCheckItem::Resolve (*item);\n+      context->query_completed (reference);\n       return true;\n     }\n \n@@ -520,6 +526,7 @@ TypeCheckBase::query_type (HirId reference, TyTy::BaseType **result)\n \t\t      reference);\n \n       *result = TypeCheckItem::ResolveImplItem (*impl_block, *impl_item);\n+      context->query_completed (reference);\n       return true;\n     }\n \n@@ -530,6 +537,7 @@ TypeCheckBase::query_type (HirId reference, TyTy::BaseType **result)\n   if (found_impl_block_type)\n     {\n       *result = TypeCheckItem::ResolveImplBlockSelf (*impl_block_by_type);\n+      context->query_completed (reference);\n       return true;\n     }\n \n@@ -544,13 +552,15 @@ TypeCheckBase::query_type (HirId reference, TyTy::BaseType **result)\n       rust_assert (block != nullptr);\n \n       *result = TypeCheckTopLevelExternItem::Resolve (extern_item, *block);\n+      context->query_completed (reference);\n       return true;\n     }\n \n   // more?\n   Location possible_locus = mappings->lookup_location (reference);\n   rust_debug_loc (possible_locus, \"query system failed to resolve: [%u]\",\n \t\t  reference);\n+  context->query_completed (reference);\n \n   return false;\n }"}, {"sha": "a1dd8052246ff3169c9c75d4e82156922e09aa46", "filename": "gcc/rust/typecheck/rust-hir-type-check.h", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/543ba35905b948a6cd0cf39832a020597068570d/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/543ba35905b948a6cd0cf39832a020597068570d/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check.h?ref=543ba35905b948a6cd0cf39832a020597068570d", "patch": "@@ -372,6 +372,15 @@ class TypeCheckContext\n     return true;\n   }\n \n+  void insert_query (HirId id) { querys_in_progress.insert (id); }\n+\n+  void query_completed (HirId id) { querys_in_progress.erase (id); }\n+\n+  bool query_in_progress (HirId id) const\n+  {\n+    return querys_in_progress.find (id) != querys_in_progress.end ();\n+  }\n+\n private:\n   TypeCheckContext ();\n \n@@ -406,6 +415,9 @@ class TypeCheckContext\n \n   // predicates\n   std::map<HirId, TyTy::TypeBoundPredicate> predicates;\n+\n+  // query context lookups\n+  std::set<HirId> querys_in_progress;\n };\n \n class TypeResolution"}, {"sha": "1a2ed3b7422ad7349ffd323af1320020d1fe03cc", "filename": "gcc/rust/typecheck/rust-tyty-bounds.cc", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/543ba35905b948a6cd0cf39832a020597068570d/gcc%2Frust%2Ftypecheck%2Frust-tyty-bounds.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/543ba35905b948a6cd0cf39832a020597068570d/gcc%2Frust%2Ftypecheck%2Frust-tyty-bounds.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty-bounds.cc?ref=543ba35905b948a6cd0cf39832a020597068570d", "patch": "@@ -34,8 +34,9 @@ TypeBoundsProbe::scan ()\n       if (!impl->has_trait_ref ())\n \treturn true;\n \n-      TyTy::BaseType *impl_type = TypeCheckItem::ResolveImplBlockSelf (*impl);\n-      if (impl_type->get_kind () == TyTy::TypeKind::ERROR)\n+      HirId impl_ty_id = impl->get_type ()->get_mappings ().get_hirid ();\n+      TyTy::BaseType *impl_type = nullptr;\n+      if (!query_type (impl_ty_id, &impl_type))\n \treturn true;\n \n       if (!receiver->can_eq (impl_type, false))"}]}