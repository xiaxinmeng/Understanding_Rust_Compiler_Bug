{"sha": "75c9fa318e31b5ead027eb5e8523d9879bc286ff", "node_id": "C_kwDOANBUbNoAKDc1YzlmYTMxOGUzMWI1ZWFkMDI3ZWI1ZTg1MjNkOTg3OWJjMjg2ZmY", "commit": {"author": {"name": "Bernhard Reutner-Fischer", "email": "aldot@gcc.gnu.org", "date": "2018-10-21T13:55:40Z"}, "committer": {"name": "Bernhard Reutner-Fischer", "email": "aldot@gcc.gnu.org", "date": "2021-10-30T16:45:11Z"}, "message": "Fix memory leak of gsymbol\n\nWe did not free global symbols. For a simplified abstract_type_3.f90\nvalgrind reports:\n\n96 bytes in 1 blocks are still reachable in loss record 461 of 602\n   at 0x48377D5: calloc (vg_replace_malloc.c:711)\n   by 0x21257C3: xcalloc (xmalloc.c:162)\n   by 0x98611B: gfc_get_gsymbol(char const*) (symbol.c:4341)\n   by 0x932C58: parse_module() (parse.c:5912)\n   by 0x9336F8: gfc_parse_file() (parse.c:6236)\n   by 0x991449: gfc_be_parse_file() (f95-lang.c:204)\n   by 0x11D8EDE: compile_file() (toplev.c:455)\n   by 0x11DB9C3: do_compile() (toplev.c:2170)\n   by 0x11DBCAF: toplev::main(int, char**) (toplev.c:2305)\n   by 0x2045D37: main (main.c:39)\n\nThis patch reduces this to\n\n LEAK SUMMARY:\n    definitely lost: 344 bytes in 1 blocks\n    indirectly lost: 3,024 bytes in 4 blocks\n      possibly lost: 0 bytes in 0 blocks\n-   still reachable: 1,576,174 bytes in 2,277 blocks\n+   still reachable: 1,576,078 bytes in 2,276 blocks\n         suppressed: 0 bytes in 0 blocks\n\ngcc/fortran/ChangeLog:\n\n2018-10-21  Bernhard Reutner-Fischer  <aldot@gcc.gnu.org>\n\n\t* parse.c (clean_up_modules): Free gsym.", "tree": {"sha": "dde25869f605bd4d0484554367566eaece7428f9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/dde25869f605bd4d0484554367566eaece7428f9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/75c9fa318e31b5ead027eb5e8523d9879bc286ff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/75c9fa318e31b5ead027eb5e8523d9879bc286ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/75c9fa318e31b5ead027eb5e8523d9879bc286ff", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/75c9fa318e31b5ead027eb5e8523d9879bc286ff/comments", "author": null, "committer": null, "parents": [{"sha": "db3f6783bde503ab1e361dda47343f0644df7515", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/db3f6783bde503ab1e361dda47343f0644df7515", "html_url": "https://github.com/Rust-GCC/gccrs/commit/db3f6783bde503ab1e361dda47343f0644df7515"}], "stats": {"total": 18, "additions": 11, "deletions": 7}, "files": [{"sha": "12aa80ec45ca91c7a2e4cc01edf244c765ac26e2", "filename": "gcc/fortran/parse.c", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/75c9fa318e31b5ead027eb5e8523d9879bc286ff/gcc%2Ffortran%2Fparse.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/75c9fa318e31b5ead027eb5e8523d9879bc286ff/gcc%2Ffortran%2Fparse.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fparse.c?ref=75c9fa318e31b5ead027eb5e8523d9879bc286ff", "patch": "@@ -6569,22 +6569,26 @@ resolve_all_program_units (gfc_namespace *gfc_global_ns_list)\n \n \n static void\n-clean_up_modules (gfc_gsymbol *gsym)\n+clean_up_modules (gfc_gsymbol *&gsym)\n {\n   if (gsym == NULL)\n     return;\n \n   clean_up_modules (gsym->left);\n   clean_up_modules (gsym->right);\n \n-  if (gsym->type != GSYM_MODULE || !gsym->ns)\n+  if (gsym->type != GSYM_MODULE)\n     return;\n \n-  gfc_current_ns = gsym->ns;\n-  gfc_derived_types = gfc_current_ns->derived_types;\n-  gfc_done_2 ();\n-  gsym->ns = NULL;\n-  return;\n+  if (gsym->ns)\n+    {\n+      gfc_current_ns = gsym->ns;\n+      gfc_derived_types = gfc_current_ns->derived_types;\n+      gfc_done_2 ();\n+      gsym->ns = NULL;\n+    }\n+  free (gsym);\n+  gsym = NULL;\n }\n \n "}]}