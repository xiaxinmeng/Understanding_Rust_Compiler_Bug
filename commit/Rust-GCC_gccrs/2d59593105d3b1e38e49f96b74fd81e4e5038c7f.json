{"sha": "2d59593105d3b1e38e49f96b74fd81e4e5038c7f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmQ1OTU5MzEwNWQzYjFlMzhlNDlmOTZiNzRmZDgxZTRlNTAzOGM3Zg==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-11-10T09:31:33Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-11-10T09:31:33Z"}, "message": "Fortran: Fix function decl's location [PR95847]\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/95847\n\t* trans-decl.c (gfc_get_symbol_decl): Do not (re)set the location\n\tof an external procedure.\n\t(build_entry_thunks, generate_coarray_init, create_main_function,\n\tgfc_generate_function_code): Use fndecl's location in BIND_EXPR.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/95847\n\t* gfortran.dg/coverage.f90: New test.", "tree": {"sha": "85d8bed022301a62f158bfc62c4f954a96b1aba6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/85d8bed022301a62f158bfc62c4f954a96b1aba6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2d59593105d3b1e38e49f96b74fd81e4e5038c7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d59593105d3b1e38e49f96b74fd81e4e5038c7f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2d59593105d3b1e38e49f96b74fd81e4e5038c7f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d59593105d3b1e38e49f96b74fd81e4e5038c7f/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2686de5617bfb572343933be2883e8274c9735b5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2686de5617bfb572343933be2883e8274c9735b5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2686de5617bfb572343933be2883e8274c9735b5"}], "stats": {"total": 36, "additions": 27, "deletions": 9}, "files": [{"sha": "71d5c670e55d4941f20bd7816cae7c2f490d8a8d", "filename": "gcc/fortran/trans-decl.c", "status": "modified", "additions": 10, "deletions": 9, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d59593105d3b1e38e49f96b74fd81e4e5038c7f/gcc%2Ffortran%2Ftrans-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d59593105d3b1e38e49f96b74fd81e4e5038c7f/gcc%2Ffortran%2Ftrans-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.c?ref=2d59593105d3b1e38e49f96b74fd81e4e5038c7f", "patch": "@@ -1749,7 +1749,6 @@ gfc_get_symbol_decl (gfc_symbol * sym)\n \t  || sym->attr.if_source != IFSRC_DECL)\n \t{\n \t  decl = gfc_get_extern_function_decl (sym);\n-\t  gfc_set_decl_location (decl, &sym->declared_at);\n \t}\n       else\n \t{\n@@ -3021,8 +3020,9 @@ build_entry_thunks (gfc_namespace * ns, bool global)\n       poplevel (1, 1);\n       BLOCK_SUPERCONTEXT (DECL_INITIAL (thunk_fndecl)) = thunk_fndecl;\n       DECL_SAVED_TREE (thunk_fndecl)\n-\t= build3_v (BIND_EXPR, tmp, DECL_SAVED_TREE (thunk_fndecl),\n-\t\t    DECL_INITIAL (thunk_fndecl));\n+\t= fold_build3_loc (DECL_SOURCE_LOCATION (thunk_fndecl), BIND_EXPR,\n+\t\t\t   void_type_node, tmp, DECL_SAVED_TREE (thunk_fndecl),\n+\t\t\t   DECL_INITIAL (thunk_fndecl));\n \n       /* Output the GENERIC tree.  */\n       dump_function (TDI_original, thunk_fndecl);\n@@ -5786,8 +5786,8 @@ generate_coarray_init (gfc_namespace * ns __attribute((unused)))\n   BLOCK_SUPERCONTEXT (DECL_INITIAL (fndecl)) = fndecl;\n \n   DECL_SAVED_TREE (fndecl)\n-    = build3_v (BIND_EXPR, decl, DECL_SAVED_TREE (fndecl),\n-                DECL_INITIAL (fndecl));\n+    = fold_build3_loc (DECL_SOURCE_LOCATION (fndecl), BIND_EXPR, void_type_node,\n+\t\t       decl, DECL_SAVED_TREE (fndecl), DECL_INITIAL (fndecl));\n   dump_function (TDI_original, fndecl);\n \n   cfun->function_end_locus = input_location;\n@@ -6512,8 +6512,9 @@ create_main_function (tree fndecl)\n   BLOCK_SUPERCONTEXT (DECL_INITIAL (ftn_main)) = ftn_main;\n \n   DECL_SAVED_TREE (ftn_main)\n-    = build3_v (BIND_EXPR, decl, DECL_SAVED_TREE (ftn_main),\n-\t\tDECL_INITIAL (ftn_main));\n+    = fold_build3_loc (DECL_SOURCE_LOCATION (ftn_main), BIND_EXPR,\n+\t\t       void_type_node, decl, DECL_SAVED_TREE (ftn_main),\n+\t\t       DECL_INITIAL (ftn_main));\n \n   /* Output the GENERIC tree.  */\n   dump_function (TDI_original, ftn_main);\n@@ -7004,8 +7005,8 @@ gfc_generate_function_code (gfc_namespace * ns)\n   BLOCK_SUPERCONTEXT (DECL_INITIAL (fndecl)) = fndecl;\n \n   DECL_SAVED_TREE (fndecl)\n-    = build3_v (BIND_EXPR, decl, DECL_SAVED_TREE (fndecl),\n-\t\tDECL_INITIAL (fndecl));\n+    = fold_build3_loc (DECL_SOURCE_LOCATION (fndecl), BIND_EXPR, void_type_node,\n+\t\t       decl, DECL_SAVED_TREE (fndecl), DECL_INITIAL (fndecl));\n \n   /* Output the GENERIC tree.  */\n   dump_function (TDI_original, fndecl);"}, {"sha": "e0800f869c17ee1731372903bcc30ef1c0a475fa", "filename": "gcc/testsuite/gfortran.dg/coverage.f90", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d59593105d3b1e38e49f96b74fd81e4e5038c7f/gcc%2Ftestsuite%2Fgfortran.dg%2Fcoverage.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d59593105d3b1e38e49f96b74fd81e4e5038c7f/gcc%2Ftestsuite%2Fgfortran.dg%2Fcoverage.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fcoverage.f90?ref=2d59593105d3b1e38e49f96b74fd81e4e5038c7f", "patch": "@@ -0,0 +1,17 @@\n+! { dg-do compile }\n+! { dg-additional-options \"-fprofile-arcs -ftest-coverage\" }\n+!\n+! PR fortran/95847\n+!\n+module foo\n+contains\n+    subroutine sbr()\n+    end subroutine sbr\n+end module foo\n+\n+function foo_suite() result(suite)\n+   use foo\n+   integer :: bar\n+   integer :: res\n+   res = bar(sbr)\n+end function foo_suite"}]}