{"sha": "d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDkzMzhjNjcyNjg3ZDFlZWExYWFmMWE5NTkzYmE0NGYwY2ExNGNhZA==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2008-06-27T09:16:45Z"}, "committer": {"name": "Eric Botcazou", "email": "ebotcazou@gcc.gnu.org", "date": "2008-06-27T09:16:45Z"}, "message": "utils.c (convert): When converting it to a packable version of its type...\n\n\t* utils.c (convert) <CONSTRUCTOR>: When converting it to a packable\n\tversion of its type, attempt to first convert its elements.\n\nFrom-SVN: r137173", "tree": {"sha": "20850ce6ad49a6f73566862cf73cc69563654f3c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/20850ce6ad49a6f73566862cf73cc69563654f3c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/comments", "author": null, "committer": null, "parents": [{"sha": "b7d565dd0098c3f2dbf7a4040ce188a99acbfe04", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b7d565dd0098c3f2dbf7a4040ce188a99acbfe04", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b7d565dd0098c3f2dbf7a4040ce188a99acbfe04"}], "stats": {"total": 88, "additions": 82, "deletions": 6}, "files": [{"sha": "8b4389ae121527d40de9c01a71b1b8e6c52ed233", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "patch": "@@ -1,3 +1,8 @@\n+2008-06-27  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* utils.c (convert) <CONSTRUCTOR>: When converting it to a packable\n+\tversion of its type, attempt to first convert its elements.\n+\n 2008-06-26  Chris Proctor  <chrisp_42@bigpond.com>\n \n \t* Makefile.in: Fix *86 kfreebsd target specific pairs."}, {"sha": "92e83487b80eae9b9159d86bd09a1c0ee4b0a736", "filename": "gcc/ada/utils.c", "status": "modified", "additions": 36, "deletions": 6, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Fada%2Futils.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Fada%2Futils.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Futils.c?ref=d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "patch": "@@ -3579,17 +3579,47 @@ convert (tree type, tree expr)\n \n     case CONSTRUCTOR:\n       /* If we are converting a CONSTRUCTOR to a mere variant type, just make\n-\t a new one in the proper type.  Likewise for a conversion between\n-\t original and packable version.  */\n-      if (code == ecode\n-\t  && (gnat_types_compatible_p (type, etype)\n-\t      || (code == RECORD_TYPE\n-\t\t  && TYPE_NAME (type) == TYPE_NAME (etype))))\n+\t a new one in the proper type.  */\n+      if (code == ecode && gnat_types_compatible_p (type, etype))\n \t{\n \t  expr = copy_node (expr);\n \t  TREE_TYPE (expr) = type;\n \t  return expr;\n \t}\n+\n+      /* Likewise for a conversion between original and packable version, but\n+\t we have to work harder in order to preserve type consistency.  */\n+      if (code == ecode\n+\t  && code == RECORD_TYPE\n+\t  && TYPE_NAME (type) == TYPE_NAME (etype))\n+\t{\n+\t  VEC(constructor_elt,gc) *e = CONSTRUCTOR_ELTS (expr);\n+\t  unsigned HOST_WIDE_INT len = VEC_length (constructor_elt, e);\n+\t  VEC(constructor_elt,gc) *v = VEC_alloc (constructor_elt, gc, len);\n+\t  tree efield = TYPE_FIELDS (etype), field = TYPE_FIELDS (type);\n+\t  unsigned HOST_WIDE_INT idx;\n+\t  tree index, value;\n+\n+\t  FOR_EACH_CONSTRUCTOR_ELT(e, idx, index, value)\n+\t    {\n+\t      constructor_elt *elt = VEC_quick_push (constructor_elt, v, NULL);\n+\t      /* We expect only simple constructors.  Otherwise, punt.  */\n+\t      if (!(index == efield || index == DECL_ORIGINAL_FIELD (efield)))\n+\t\tbreak;\n+\t      elt->index = field;\n+\t      elt->value = convert (TREE_TYPE (field), value);\n+\t      efield = TREE_CHAIN (efield);\n+\t      field = TREE_CHAIN (field);\n+\t    }\n+\n+\t  if (idx == len)\n+\t    {\n+\t      expr = copy_node (expr);\n+\t      TREE_TYPE (expr) = type;\n+\t      CONSTRUCTOR_ELTS (expr) = v;\n+\t      return expr;\n+\t    }\n+\t}\n       break;\n \n     case UNCONSTRAINED_ARRAY_REF:"}, {"sha": "64384d5621afc09d634310b992d02cb429af3e4c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "patch": "@@ -1,3 +1,8 @@\n+2008-06-27  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* gnat.dg/aggr9.ad[sb]: New test.\n+\t* gnat.dg/aggr9_pkg.ads: New helper.\n+\n 2008-06-27  Olivier Hainque  <hainque@adacore.com>\n \n \t* gnat.dg/aligned_vla.adb: New test."}, {"sha": "70d026fdd286b3749a378dfbe1ef5f9afc87e5f0", "filename": "gcc/testsuite/gnat.dg/aggr9.adb", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9.adb?ref=d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "patch": "@@ -0,0 +1,12 @@\n+-- { dg-do compile }\n+-- { dg-options \"-O\" }\n+\n+package body Aggr9 is\n+\n+  procedure Proc (X : R1) is\n+    M : R2 := (F => X);\n+  begin\n+    Send (M);\n+  end;\n+\n+end Aggr9;"}, {"sha": "cb5757b64afb1c66afc355e98691eb4b1ac96323", "filename": "gcc/testsuite/gnat.dg/aggr9.ads", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9.ads?ref=d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "patch": "@@ -0,0 +1,7 @@\n+with Aggr9_Pkg; use Aggr9_Pkg;\n+\n+package Aggr9 is\n+\n+  procedure Proc (X : R1);\n+\n+end Aggr9;"}, {"sha": "c7c7b9e10b8a292994f3e5d7fb9452ef46388b7b", "filename": "gcc/testsuite/gnat.dg/aggr9_pkg.ads", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9_pkg.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d9338c672687d1eea1aaf1a9593ba44f0ca14cad/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9_pkg.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Faggr9_pkg.ads?ref=d9338c672687d1eea1aaf1a9593ba44f0ca14cad", "patch": "@@ -0,0 +1,17 @@\n+package Aggr9_Pkg is\n+\n+  type Byte is range 0 .. 255;\n+\n+  type R1 is\n+    record\n+      A,B : Byte;                    \n+    end record;\n+\n+  type R2 is\n+    record\n+      F : R1;\n+    end record;\n+\n+  procedure Send (M : R2);\n+\n+end Aggr9_Pkg;"}]}