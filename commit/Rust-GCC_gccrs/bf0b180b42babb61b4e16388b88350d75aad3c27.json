{"sha": "bf0b180b42babb61b4e16388b88350d75aad3c27", "node_id": "C_kwDOANBUbNoAKGJmMGIxODBiNDJiYWJiNjFiNGUxNjM4OGI4ODM1MGQ3NWFhZDNjMjc", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2022-04-14T15:31:44Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-05-19T14:05:31Z"}, "message": "[Ada] Fix spurious violations of No_Secondary_Stack restriction\n\nNow that finalization and return on the secondary stack are decoupled, the\ntransient scopes created because of the former need not necessarily manage\nthe secondary stack and trigger a violation of the associated restriction.\n\ngcc/ada/\n\n\t* exp_ch7.adb (Wrap_Transient_Declaration): Propagate Uses_Sec_Stack\n\tto enclosing function if it does not return on the secondary stack.\n\t* exp_ch6.adb (Expand_Call_Helper): Call Establish_Transient_Scope\n\twith Manage_Sec_Stack set to True only when necessary.\n\t* sem_res.adb (Resolve_Call): Likewise.\n\t(Resolve_Entry_Call): Likewise.", "tree": {"sha": "ce885fdfa478182d1bf1512e675abc1d29bc0264", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ce885fdfa478182d1bf1512e675abc1d29bc0264"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bf0b180b42babb61b4e16388b88350d75aad3c27", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bf0b180b42babb61b4e16388b88350d75aad3c27", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bf0b180b42babb61b4e16388b88350d75aad3c27", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bf0b180b42babb61b4e16388b88350d75aad3c27/comments", "author": null, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e478e16e8a8a256c8c117f0bbe54a3078c086bc2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e478e16e8a8a256c8c117f0bbe54a3078c086bc2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e478e16e8a8a256c8c117f0bbe54a3078c086bc2"}], "stats": {"total": 15, "additions": 9, "deletions": 6}, "files": [{"sha": "44d198798c64b77f74d559e075bfdd8e0d890e45", "filename": "gcc/ada/exp_ch6.adb", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bf0b180b42babb61b4e16388b88350d75aad3c27/gcc%2Fada%2Fexp_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bf0b180b42babb61b4e16388b88350d75aad3c27/gcc%2Fada%2Fexp_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch6.adb?ref=bf0b180b42babb61b4e16388b88350d75aad3c27", "patch": "@@ -4927,10 +4927,11 @@ package body Exp_Ch6 is\n            and then\n              (Ekind (Current_Scope) /= E_Loop\n                or else Nkind (Parent (Call_Node)) /= N_Function_Call\n-               or else not Is_Build_In_Place_Function_Call\n-                             (Parent (Call_Node)))\n+               or else not\n+                 Is_Build_In_Place_Function_Call (Parent (Call_Node)))\n          then\n-            Establish_Transient_Scope (Call_Node, Manage_Sec_Stack => True);\n+            Establish_Transient_Scope\n+              (Call_Node, Returns_On_Secondary_Stack (Etype (Subp)));\n          end if;\n       end if;\n    end Expand_Call_Helper;"}, {"sha": "bb6712d823d964e4ad0f855980bb71730efca00f", "filename": "gcc/ada/exp_ch7.adb", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bf0b180b42babb61b4e16388b88350d75aad3c27/gcc%2Fada%2Fexp_ch7.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bf0b180b42babb61b4e16388b88350d75aad3c27/gcc%2Fada%2Fexp_ch7.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch7.adb?ref=bf0b180b42babb61b4e16388b88350d75aad3c27", "patch": "@@ -10336,7 +10336,7 @@ package body Exp_Ch7 is\n          --  reclamation is done by the caller.\n \n          if Ekind (Curr_S) = E_Function\n-           and then Requires_Transient_Scope (Etype (Curr_S))\n+           and then Returns_On_Secondary_Stack (Etype (Curr_S))\n          then\n             null;\n "}, {"sha": "930980eafedfef800e267690cdde39b00072e005", "filename": "gcc/ada/sem_res.adb", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bf0b180b42babb61b4e16388b88350d75aad3c27/gcc%2Fada%2Fsem_res.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bf0b180b42babb61b4e16388b88350d75aad3c27/gcc%2Fada%2Fsem_res.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_res.adb?ref=bf0b180b42babb61b4e16388b88350d75aad3c27", "patch": "@@ -6955,7 +6955,8 @@ package body Sem_Res is\n         and then Requires_Transient_Scope (Etype (Nam))\n         and then not Is_Ignored_Ghost_Entity (Nam)\n       then\n-         Establish_Transient_Scope (N, Manage_Sec_Stack => True);\n+         Establish_Transient_Scope\n+           (N, Returns_On_Secondary_Stack (Etype (Nam)));\n \n          --  If the call appears within the bounds of a loop, it will be\n          --  rewritten and reanalyzed, nothing left to do here.\n@@ -8535,7 +8536,8 @@ package body Sem_Res is\n       elsif Expander_Active\n         and then Requires_Transient_Scope (Etype (Nam))\n       then\n-         Establish_Transient_Scope (N, Manage_Sec_Stack => True);\n+         Establish_Transient_Scope\n+           (N, Returns_On_Secondary_Stack (Etype (Nam)));\n       end if;\n \n       --  Now we know that this is not a call to a function that returns an"}]}