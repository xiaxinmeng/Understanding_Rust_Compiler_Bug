{"sha": "71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1", "node_id": "C_kwDOANBUbNoAKDcxZTYzNTNlMWIwMzAyMWJjOGJiY2Y0YmQ2N2E1ZjE0ZDA5YjVmYjE", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-02-08T19:17:55Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-02-08T19:17:55Z"}, "message": "c++: Don't emit repeated -Wshadow warnings for templates/ctors [PR104379]\n\nThe following patch suppresses extraneous -Wshadow warnings.\nOn the testcase without the patch we emit 14 -Wshadow warnings,\nwith the patch just 4.  It is enough to warn once e.g. during parsing of the\ntemplate or the abstract ctor, while previously we'd warn also on the clones\nof the ctors and on instantiation.\nIn GCC 8 and earlier we didn't warn because check_local_shadow did\n  /* Inline decls shadow nothing.  */\n  if (DECL_FROM_INLINE (decl))\n    return;\n\n2022-02-08  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR c++/104379\n\t* name-lookup.cc (check_local_shadow): When diagnosing shadowing\n\tof a member or global declaration, add warning suppression for\n\tthe decl and don't warn again on it.\n\n\t* g++.dg/warn/Wshadow-18.C: New test.", "tree": {"sha": "61a6e031d2366ecaca9bd0493fb53ecea0e40ebf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/61a6e031d2366ecaca9bd0493fb53ecea0e40ebf"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1755141a9ea0dddabb52776cddc4c9325eed27c6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1755141a9ea0dddabb52776cddc4c9325eed27c6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1755141a9ea0dddabb52776cddc4c9325eed27c6"}], "stats": {"total": 46, "additions": 38, "deletions": 8}, "files": [{"sha": "93c4eb7193b31f9dd2e1ba9f4e636ec631c8908f", "filename": "gcc/cp/name-lookup.cc", "status": "modified", "additions": 16, "deletions": 8, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1/gcc%2Fcp%2Fname-lookup.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1/gcc%2Fcp%2Fname-lookup.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.cc?ref=71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1", "patch": "@@ -3296,18 +3296,22 @@ check_local_shadow (tree decl)\n \n \t/* Warn if a variable shadows a non-function, or the variable\n \t   is a function or a pointer-to-function.  */\n-\tif (!OVL_P (member)\n-\t    || TREE_CODE (decl) == FUNCTION_DECL\n-\t    || (TREE_TYPE (decl)\n-\t\t&& (TYPE_PTRFN_P (TREE_TYPE (decl))\n-\t\t    || TYPE_PTRMEMFUNC_P (TREE_TYPE (decl)))))\n+\tif ((!OVL_P (member)\n+\t     || TREE_CODE (decl) == FUNCTION_DECL\n+\t     || (TREE_TYPE (decl)\n+\t\t && (TYPE_PTRFN_P (TREE_TYPE (decl))\n+\t\t     || TYPE_PTRMEMFUNC_P (TREE_TYPE (decl)))))\n+\t    && !warning_suppressed_p (decl, OPT_Wshadow))\n \t  {\n \t    auto_diagnostic_group d;\n \t    if (warning_at (DECL_SOURCE_LOCATION (decl), OPT_Wshadow,\n \t\t\t    \"declaration of %qD shadows a member of %qT\",\n \t\t\t    decl, current_nonlambda_class_type ())\n \t\t&& DECL_P (member))\n-\t      inform_shadowed (member);\n+\t      {\n+\t\tinform_shadowed (member);\n+\t\tsuppress_warning (decl, OPT_Wshadow);\n+\t      }\n \t  }\n \treturn;\n       }\n@@ -3319,14 +3323,18 @@ check_local_shadow (tree decl)\n \t  || (TREE_CODE (old) == TYPE_DECL\n \t      && (!DECL_ARTIFICIAL (old)\n \t\t  || TREE_CODE (decl) == TYPE_DECL)))\n-      && !instantiating_current_function_p ())\n+      && !instantiating_current_function_p ()\n+      && !warning_suppressed_p (decl, OPT_Wshadow))\n     /* XXX shadow warnings in outer-more namespaces */\n     {\n       auto_diagnostic_group d;\n       if (warning_at (DECL_SOURCE_LOCATION (decl), OPT_Wshadow,\n \t\t      \"declaration of %qD shadows a global declaration\",\n \t\t      decl))\n-\tinform_shadowed (old);\n+\t{\n+\t  inform_shadowed (old);\n+\t  suppress_warning (decl, OPT_Wshadow);\n+\t}\n       return;\n     }\n "}, {"sha": "fcc1b3c3aca7a414f408042000cf533561677552", "filename": "gcc/testsuite/g++.dg/warn/Wshadow-18.C", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWshadow-18.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWshadow-18.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWshadow-18.C?ref=71e6353e1b03021bc8bbcf4bd67a5f14d09b5fb1", "patch": "@@ -0,0 +1,22 @@\n+// PR c++/104379\n+// { dg-do compile }\n+// { dg-options \"-Wshadow\" }\n+\n+int x;\n+\n+template<typename T>\n+struct S\n+{\n+  int i;\n+  S(int i) { (void) i; }\t\t\t// { dg-warning \"declaration of 'i' shadows a member of 'S<T>'\" }\n+  S(float x) { (void) x; }\t\t\t// { dg-warning \"declaration of 'x' shadows a global declaration\" }\n+  S(int *p) { int a = 1; (void) p; (void) a;\n+\t      { int a = 2; (void) a; } }\t// { dg-warning \"declaration of 'a' shadows a previous local\" }\n+};\n+\n+S<int> i(1);\n+S<long> j(1);\n+S<int> k(1.0f);\n+S<long> l(1.0f);\n+S<int> m(&x);\n+S<int> n(&x);"}]}