{"sha": "a9241df96e1950c630550ada9371c0b4a03496cf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTkyNDFkZjk2ZTE5NTBjNjMwNTUwYWRhOTM3MWMwYjRhMDM0OTZjZg==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2021-07-15T19:01:57Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2021-07-15T19:01:57Z"}, "message": "analyzer: handle self-referential phis\n\ngcc/analyzer/ChangeLog:\n\t* state-purge.cc (self_referential_phi_p): New.\n\t(state_purge_per_ssa_name::process_point): Don't purge an SSA name\n\tat its def-stmt if the def-stmt is self-referential.\n\ngcc/testsuite/ChangeLog:\n\t* gcc.dg/analyzer/phi-1.c: New test.\n\nSigned-off-by: David Malcolm <dmalcolm@redhat.com>", "tree": {"sha": "8223a597e534cc582599264829b4c0bb2e7f7ac6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8223a597e534cc582599264829b4c0bb2e7f7ac6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a9241df96e1950c630550ada9371c0b4a03496cf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a9241df96e1950c630550ada9371c0b4a03496cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a9241df96e1950c630550ada9371c0b4a03496cf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a9241df96e1950c630550ada9371c0b4a03496cf/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "797358f42fab5ee58a893b68ed18f6ea05eff634", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/797358f42fab5ee58a893b68ed18f6ea05eff634", "html_url": "https://github.com/Rust-GCC/gccrs/commit/797358f42fab5ee58a893b68ed18f6ea05eff634"}], "stats": {"total": 61, "additions": 58, "deletions": 3}, "files": [{"sha": "e82ea87e735157b4121571d00d2f888a94132b45", "filename": "gcc/analyzer/state-purge.cc", "status": "modified", "additions": 34, "deletions": 3, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a9241df96e1950c630550ada9371c0b4a03496cf/gcc%2Fanalyzer%2Fstate-purge.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a9241df96e1950c630550ada9371c0b4a03496cf/gcc%2Fanalyzer%2Fstate-purge.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fanalyzer%2Fstate-purge.cc?ref=a9241df96e1950c630550ada9371c0b4a03496cf", "patch": "@@ -288,6 +288,20 @@ state_purge_per_ssa_name::add_to_worklist (const function_point &point,\n     }\n }\n \n+/* Does this phi depend on itself?\n+   e.g. in:\n+     added_2 = PHI <added_6(2), added_2(3), added_11(4)>\n+   the middle defn (from edge 3) requires added_2 itself.  */\n+\n+static bool\n+self_referential_phi_p (const gphi *phi)\n+{\n+  for (unsigned i = 0; i < gimple_phi_num_args (phi); i++)\n+    if (gimple_phi_arg_def (phi, i) == gimple_phi_result (phi))\n+      return true;\n+  return false;\n+}\n+\n /* Process POINT, popped from WORKLIST.\n    Iterate over predecessors of POINT, adding to WORKLIST.  */\n \n@@ -326,11 +340,28 @@ state_purge_per_ssa_name::process_point (const function_point &point,\n \t     !gsi_end_p (gpi); gsi_next (&gpi))\n \t  {\n \t    gphi *phi = gpi.phi ();\n+\t    /* Are we at the def-stmt for m_name?  */\n \t    if (phi == def_stmt)\n \t      {\n-\t\tif (logger)\n-\t\t  logger->log (\"def stmt within phis; terminating\");\n-\t\treturn;\n+\t\t/* Does this phi depend on itself?\n+\t\t   e.g. in:\n+\t\t     added_2 = PHI <added_6(2), added_2(3), added_11(4)>\n+\t\t   the middle defn (from edge 3) requires added_2 itself\n+\t\t   so we can't purge it here.  */\n+\t\tif (self_referential_phi_p (phi))\n+\t\t  {\n+\t\t    if (logger)\n+\t\t      logger->log (\"self-referential def stmt within phis;\"\n+\t\t\t\t   \" continuing\");\n+\t\t  }\n+\t\telse\n+\t\t  {\n+\t\t    /* Otherwise, we can stop here, so that m_name\n+\t\t       can be purged.  */\n+\t\t    if (logger)\n+\t\t      logger->log (\"def stmt within phis; terminating\");\n+\t\t    return;\n+\t\t  }\n \t      }\n \t  }\n "}, {"sha": "09260033fef6bdcfa1714ffe7efab92b85d0437e", "filename": "gcc/testsuite/gcc.dg/analyzer/phi-1.c", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a9241df96e1950c630550ada9371c0b4a03496cf/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fphi-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a9241df96e1950c630550ada9371c0b4a03496cf/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fphi-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fphi-1.c?ref=a9241df96e1950c630550ada9371c0b4a03496cf", "patch": "@@ -0,0 +1,24 @@\n+/* { dg-do \"compile\" } */\n+\n+typedef __SIZE_TYPE__ size_t;\n+#define NULL ((void *) 0)\n+\n+extern const char *foo (void);\n+extern size_t bar (void);\n+\n+void\n+_nl_expand_alias (const char *locale_alias_path)\n+{\n+  size_t added;\n+  do\n+    {\n+      added = 0;\n+      while (added == 0 && locale_alias_path[0] != '\\0')\n+\t{\n+\t  const char *start = foo ();\n+\t  if (start < locale_alias_path)\n+\t    added = bar ();\n+\t}\n+    }\n+  while (added != 0);\n+}"}]}