{"sha": "7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6N2Q2YmFmNjhmZTIyYjZlZjViMWQ2ZmFiYmVmOTdjMGUxYjRkN2FiZg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-06-24T01:25:21Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-06-24T19:59:20Z"}, "message": "c++: Fix ICE with using and virtual function. [PR95719]\n\nconversion_path points to the base where we found the using-declaration, not\nwhere the function is actually a member; look up the actual base.  And then\nmaybe look back to the derived class if the base is primary.\n\ngcc/cp/ChangeLog:\n\n\tPR c++/95719\n\t* call.c (build_over_call): Look up the overrider in base_binfo.\n\t* class.c (lookup_vfn_in_binfo): Look through BINFO_PRIMARY_P.\n\ngcc/testsuite/ChangeLog:\n\n\tPR c++/95719\n\t* g++.dg/tree-ssa/final4.C: New test.", "tree": {"sha": "676456440a072d575814e75d8b37421aeeb30565", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/676456440a072d575814e75d8b37421aeeb30565"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0c586913e61021681e3221e8760cd87b24142aea", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0c586913e61021681e3221e8760cd87b24142aea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0c586913e61021681e3221e8760cd87b24142aea"}], "stats": {"total": 22, "additions": 21, "deletions": 1}, "files": [{"sha": "fe68fda1364f589cdf4368ccaf65148d8b37dcfa", "filename": "gcc/cp/call.c", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/gcc%2Fcp%2Fcall.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/gcc%2Fcp%2Fcall.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcall.c?ref=7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "patch": "@@ -8694,7 +8694,11 @@ build_over_call (struct z_candidate *cand, int flags, tsubst_flags_t complain)\n       if (DECL_VINDEX (fn) && (flags & LOOKUP_NONVIRTUAL) == 0\n \t  && resolves_to_fixed_type_p (arg))\n \t{\n-\t  fn = lookup_vfn_in_binfo (DECL_VINDEX (fn), cand->conversion_path);\n+\t  tree binfo = cand->conversion_path;\n+\t  if (BINFO_TYPE (binfo) != DECL_CONTEXT (fn))\n+\t    binfo = lookup_base (binfo, DECL_CONTEXT (fn), ba_unique,\n+\t\t\t\t NULL, complain);\n+\t  fn = lookup_vfn_in_binfo (DECL_VINDEX (fn), binfo);\n \t  flags |= LOOKUP_NONVIRTUAL;\n \t}\n "}, {"sha": "94a95854e25ddee80af86e215a6f5365b4f21a9d", "filename": "gcc/cp/class.c", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "patch": "@@ -2455,6 +2455,10 @@ lookup_vfn_in_binfo (tree idx, tree binfo)\n   int ix = tree_to_shwi (idx);\n   if (TARGET_VTABLE_USES_DESCRIPTORS)\n     ix /= MAX (TARGET_VTABLE_USES_DESCRIPTORS, 1);\n+  while (BINFO_PRIMARY_P (binfo))\n+    /* BINFO_VIRTUALS in a primary base isn't accurate, find the derived\n+       class that actually owns the vtable.  */\n+    binfo = BINFO_INHERITANCE_CHAIN (binfo);\n   tree virtuals = BINFO_VIRTUALS (binfo);\n   return TREE_VALUE (chain_index (ix, virtuals));\n }"}, {"sha": "387d4bb26c2cde60f47e00d9910533ae16fcd78e", "filename": "gcc/testsuite/g++.dg/tree-ssa/final4.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftree-ssa%2Ffinal4.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftree-ssa%2Ffinal4.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftree-ssa%2Ffinal4.C?ref=7d6baf68fe22b6ef5b1d6fabbef97c0e1b4d7abf", "patch": "@@ -0,0 +1,12 @@\n+// PR c++/95719\n+// { dg-do compile { target c++11 } }\n+// { dg-additional-options -fdump-tree-gimple }\n+// { dg-final { scan-tree-dump \"S2::f\" \"gimple\" } }\n+\n+struct S1 { virtual ~S1(); };\n+struct S2 {\n+    virtual ~S2();\n+    virtual void f();\n+};\n+struct S3 final: S1, S2 { using S2::f; };\n+void g(S3 & s) { s.f(); }"}]}