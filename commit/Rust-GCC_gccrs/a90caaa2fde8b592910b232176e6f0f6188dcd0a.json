{"sha": "a90caaa2fde8b592910b232176e6f0f6188dcd0a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTkwY2FhYTJmZGU4YjU5MjkxMGIyMzIxNzZlNmYwZjYxODhkY2QwYQ==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2011-03-29T13:27:25Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2011-03-29T13:27:25Z"}, "message": "re PR c++/48296 ([C++0x] constexpr member function cannot use the class type it belongs as parameter type or return type)\n\n\tPR c++/48296\n\t* decl.c (cp_finish_decl): Defer validation of constexpr member\n\tfunctions.\n\t* class.c (finalize_literal_type_property): Validate them here.\n\t* semantics.c (is_valid_constexpr_fn): Don't check completeness.\n\nFrom-SVN: r171661", "tree": {"sha": "7b08622bab7763a062b742650b2f7d04fb7c3a28", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7b08622bab7763a062b742650b2f7d04fb7c3a28"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a90caaa2fde8b592910b232176e6f0f6188dcd0a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a90caaa2fde8b592910b232176e6f0f6188dcd0a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a90caaa2fde8b592910b232176e6f0f6188dcd0a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a90caaa2fde8b592910b232176e6f0f6188dcd0a/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "915829ccf1a380e5af8d7f59f53a9fe75bc778b1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/915829ccf1a380e5af8d7f59f53a9fe75bc778b1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/915829ccf1a380e5af8d7f59f53a9fe75bc778b1"}], "stats": {"total": 52, "additions": 37, "deletions": 15}, "files": [{"sha": "1ffe70b3933bf8914aca1bd7b94e01f3cbaabd9f", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=a90caaa2fde8b592910b232176e6f0f6188dcd0a", "patch": "@@ -1,5 +1,11 @@\n 2011-03-29  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/48296\n+\t* decl.c (cp_finish_decl): Defer validation of constexpr member\n+\tfunctions.\n+\t* class.c (finalize_literal_type_property): Validate them here.\n+\t* semantics.c (is_valid_constexpr_fn): Don't check completeness.\n+\n \t* semantics.c (is_valid_constexpr_fn): Specify input location.\n \n 2011-03-28  Jason Merrill  <jason@redhat.com>"}, {"sha": "24b8a31a44787c8ba3e08d0787f19fea71c4ea7b", "filename": "gcc/cp/class.c", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=a90caaa2fde8b592910b232176e6f0f6188dcd0a", "patch": "@@ -4549,6 +4549,8 @@ type_requires_array_cookie (tree type)\n static void\n finalize_literal_type_property (tree t)\n {\n+  tree fn;\n+\n   if (cxx_dialect < cxx0x\n       || TYPE_HAS_NONTRIVIAL_DESTRUCTOR (t)\n       /* FIXME These constraints seem unnecessary; remove from standard.\n@@ -4559,18 +4561,10 @@ finalize_literal_type_property (tree t)\n \t   && !TYPE_HAS_CONSTEXPR_CTOR (t))\n     CLASSTYPE_LITERAL_P (t) = false;\n \n-  if (!CLASSTYPE_LITERAL_P (t) && !CLASSTYPE_TEMPLATE_INSTANTIATION (t))\n-    {\n-      tree fn;\n-      for (fn = TYPE_METHODS (t); fn; fn = DECL_CHAIN (fn))\n-\tif (DECL_DECLARED_CONSTEXPR_P (fn)\n-\t    && DECL_NONSTATIC_MEMBER_FUNCTION_P (fn)\n-\t    && !DECL_CONSTRUCTOR_P (fn))\n-\t  {\n-\t    error (\"enclosing class of %q+D is not a literal type\", fn);\n-\t    DECL_DECLARED_CONSTEXPR_P (fn) = false;\n-\t  }\n-    }\n+  for (fn = TYPE_METHODS (t); fn; fn = DECL_CHAIN (fn))\n+    if (DECL_DECLARED_CONSTEXPR_P (fn)\n+\t&& TREE_CODE (fn) != TEMPLATE_DECL)\n+      validate_constexpr_fundecl (fn);\n }\n \n /* Check the validity of the bases and members declared in T.  Add any"}, {"sha": "16ccfaf5b69b43f77f3281b1136e492c8f82e5a1", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=a90caaa2fde8b592910b232176e6f0f6188dcd0a", "patch": "@@ -5794,7 +5794,10 @@ cp_finish_decl (tree decl, tree init, bool init_const_expr_p,\n \t}\n     }\n \n-  if (TREE_CODE (decl) == FUNCTION_DECL)\n+  if (TREE_CODE (decl) == FUNCTION_DECL\n+      /* For members, defer until finalize_literal_type_property.  */\n+      && (!DECL_CLASS_SCOPE_P (decl)\n+\t  || !TYPE_BEING_DEFINED (DECL_CONTEXT (decl))))\n     validate_constexpr_fundecl (decl);\n \n   else if (!ensure_literal_type_for_constexpr_object (decl))"}, {"sha": "f1c3d9af3000120fa9d2090269eafc83db3a2d47", "filename": "gcc/cp/semantics.c", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2Fsemantics.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Fcp%2Fsemantics.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsemantics.c?ref=a90caaa2fde8b592910b232176e6f0f6188dcd0a", "patch": "@@ -5354,8 +5354,7 @@ is_valid_constexpr_fn (tree fun, bool complain)\n \t}\n \n       if (DECL_NONSTATIC_MEMBER_FUNCTION_P (fun)\n-\t  && COMPLETE_TYPE_P (DECL_CONTEXT (fun))\n-\t  && !valid_type_in_constexpr_fundecl_p (DECL_CONTEXT (fun)))\n+\t  && !CLASSTYPE_LITERAL_P (DECL_CONTEXT (fun)))\n \t{\n \t  ret = false;\n \t  if (complain)"}, {"sha": "5cb4f4e2cb63c3ed70dce39d8fbb4ad08801b128", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a90caaa2fde8b592910b232176e6f0f6188dcd0a", "patch": "@@ -1,5 +1,7 @@\n 2011-03-29  Jason Merrill  <jason@redhat.com>\n \n+\t* g++.dg/cpp0x/constexpr-memfn1.C: New.\n+\n \t* g++.dg/cpp0x/constexpr-diag1.C: Adjust error locations.\n \n 2011-03-29  Janus Weil  <janus@gcc.gnu.org>"}, {"sha": "4646f82b90439967d471d02b973356577f884f5e", "filename": "gcc/testsuite/g++.dg/cpp0x/constexpr-memfn1.C", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-memfn1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a90caaa2fde8b592910b232176e6f0f6188dcd0a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-memfn1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-memfn1.C?ref=a90caaa2fde8b592910b232176e6f0f6188dcd0a", "patch": "@@ -0,0 +1,18 @@\n+// PR c++/48296\n+// { dg-options -std=c++0x }\n+\n+struct X\n+{\n+  constexpr X() { }\n+  constexpr X f(X x) { return x; }\n+  constexpr X g(X x);\n+};\n+\n+constexpr X X::g(X x) { return x; }\n+\n+struct Y\n+{\n+  Y() { }\n+  constexpr Y f(Y y);\t\t// { dg-error \"constexpr\" }\n+  static constexpr Y g(Y y);\t// { dg-error \"constexpr\" }\n+};"}]}