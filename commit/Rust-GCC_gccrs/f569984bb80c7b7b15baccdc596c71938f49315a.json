{"sha": "f569984bb80c7b7b15baccdc596c71938f49315a", "node_id": "C_kwDOANBUbNoAKGY1Njk5ODRiYjgwYzdiN2IxNWJhY2NkYzU5NmM3MTkzOGY0OTMxNWE", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2021-10-28T19:36:34Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2021-10-29T22:11:25Z"}, "message": "No side effects in 'assert' expressions\n\nUsually, if 'assert'ions are disabled, 'assert' expressions are not evaluated,\nso in that case won't effect any side effects.\n\nVia spurious ICEs/test suite FAILs, this may be observed in GCC/Rust, for\nexample, if configuring with '--enable-checking=no' and disabling a \"more\nforgiving\" 'gcc/system.h:gcc_assert' definition, so that '0 && (EXPR)' gets\nused:\n\n     /* Use gcc_assert(EXPR) to test invariants.  */\n     #if ENABLE_ASSERT_CHECKING\n     #define gcc_assert(EXPR)                                               \\\n        ((void)(!(EXPR) ? fancy_abort (__FILE__, __LINE__, __FUNCTION__), 0 : 0))\n    -#elif (GCC_VERSION >= 4005)\n    +#elif (0) //GCC_VERSION >= 4005)\n     #define gcc_assert(EXPR)                                               \\\n       ((void)(__builtin_expect (!(EXPR), 0) ? __builtin_unreachable (), 0 : 0))\n     #else\n     /* Include EXPR, so that unused variable warnings do not occur.  */\n     #define gcc_assert(EXPR) ((void)(0 && (EXPR)))\n     #endif\n\nAs that one does cause some issues in GCC proper (that I shall fix separately),\nmay use this change to 'gcc/rust/rust-system.h:rust_assert' instead:\n\n    +#if 0\n     #define rust_assert(EXPR) gcc_assert (EXPR)\n    +#else\n    +#define rust_assert(EXPR) ((void) (0 && (EXPR)))\n    +#endif\n\nTo fix these, use the same pattern as is already used in a lot of existing\nGCC/Rust code:\n\n    bool ok = [expression with side effects];\n    rust_assert (ok);\n\nI've only done a quick manual review; maybe there is a tool for doing this?", "tree": {"sha": "323a35da20d509a7a76fda78d2dc8f979a4c6e0b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/323a35da20d509a7a76fda78d2dc8f979a4c6e0b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f569984bb80c7b7b15baccdc596c71938f49315a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f569984bb80c7b7b15baccdc596c71938f49315a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f569984bb80c7b7b15baccdc596c71938f49315a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f569984bb80c7b7b15baccdc596c71938f49315a/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cba61d8dcbe1ac0fb23a96b2974541b201292465", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cba61d8dcbe1ac0fb23a96b2974541b201292465", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cba61d8dcbe1ac0fb23a96b2974541b201292465"}], "stats": {"total": 53, "additions": 31, "deletions": 22}, "files": [{"sha": "2b2018f1c2cc97db10088113a08f6803a61a7b6d", "filename": "gcc/rust/backend/rust-compile-context.h", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-context.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-context.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-context.h?ref=f569984bb80c7b7b15baccdc596c71938f49315a", "patch": "@@ -53,11 +53,12 @@ class Context\n     for (auto it = builtins.begin (); it != builtins.end (); it++)\n       {\n \tHirId ref;\n-\trust_assert (\n-\t  tyctx->lookup_type_by_node_id ((*it)->get_node_id (), &ref));\n+\tbool ok = tyctx->lookup_type_by_node_id ((*it)->get_node_id (), &ref);\n+\trust_assert (ok);\n \n \tTyTy::BaseType *lookup;\n-\trust_assert (tyctx->lookup_type (ref, &lookup));\n+\tok = tyctx->lookup_type (ref, &lookup);\n+\trust_assert (ok);\n \n \tBtype *compiled = TyTyCompile::compile (backend, lookup);\n \tcompiled_type_map.insert (std::pair<HirId, Btype *> (ref, compiled));"}, {"sha": "a78cf197358730c29d9d9038eed25cecb8566baa", "filename": "gcc/rust/backend/rust-compile-implitem.h", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-implitem.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-implitem.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-implitem.h?ref=f569984bb80c7b7b15baccdc596c71938f49315a", "patch": "@@ -67,9 +67,10 @@ class CompileInherentImplItem : public HIRCompileBase\n     Bexpression *value = CompileExpr::Compile (constant.get_expr (), ctx);\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    ok = ctx->get_mappings ()->lookup_canonical_path (\n       constant.get_mappings ().get_crate_num (),\n-      constant.get_mappings ().get_nodeid (), &canonical_path));\n+      constant.get_mappings ().get_nodeid (), &canonical_path);\n+    rust_assert (ok);\n \n     std::string ident = canonical_path->get ();\n     Bexpression *const_expr = ctx->get_backend ()->named_constant_expression (\n@@ -148,9 +149,10 @@ class CompileInherentImplItem : public HIRCompileBase\n       flags |= Backend::function_is_visible;\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    bool ok = ctx->get_mappings ()->lookup_canonical_path (\n       function.get_mappings ().get_crate_num (),\n-      function.get_mappings ().get_nodeid (), &canonical_path));\n+      function.get_mappings ().get_nodeid (), &canonical_path);\n+    rust_assert (ok);\n \n     std::string ir_symbol_name\n       = canonical_path->get () + fntype->subst_as_string ();\n@@ -260,7 +262,7 @@ class CompileInherentImplItem : public HIRCompileBase\n       }\n \n     std::vector<Bvariable *> locals;\n-    bool ok = compile_locals_for_block (*rib, fndecl, locals);\n+    ok = compile_locals_for_block (*rib, fndecl, locals);\n     rust_assert (ok);\n \n     Bblock *enclosing_scope = NULL;\n@@ -358,9 +360,10 @@ class CompileTraitItem : public HIRCompileBase\n       = CompileExpr::Compile (constant.get_expr ().get (), ctx);\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    bool ok = ctx->get_mappings ()->lookup_canonical_path (\n       constant.get_mappings ().get_crate_num (),\n-      constant.get_mappings ().get_nodeid (), &canonical_path));\n+      constant.get_mappings ().get_nodeid (), &canonical_path);\n+    rust_assert (ok);\n \n     std::string ident = canonical_path->get ();\n     Bexpression *const_expr = ctx->get_backend ()->named_constant_expression (\n@@ -413,9 +416,10 @@ class CompileTraitItem : public HIRCompileBase\n     unsigned int flags = 0;\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    bool ok = ctx->get_mappings ()->lookup_canonical_path (\n       func.get_mappings ().get_crate_num (), func.get_mappings ().get_nodeid (),\n-      &canonical_path));\n+      &canonical_path);\n+    rust_assert (ok);\n \n     std::string fn_identifier = canonical_path->get ();\n     std::string asm_name = ctx->mangle_item (fntype, *canonical_path);\n@@ -522,7 +526,7 @@ class CompileTraitItem : public HIRCompileBase\n       }\n \n     std::vector<Bvariable *> locals;\n-    bool ok = compile_locals_for_block (*rib, fndecl, locals);\n+    ok = compile_locals_for_block (*rib, fndecl, locals);\n     rust_assert (ok);\n \n     Bblock *enclosing_scope = NULL;"}, {"sha": "b64f6f0ed92283c7149e4e88ff8c69e90845ddea", "filename": "gcc/rust/backend/rust-compile-item.h", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-item.h?ref=f569984bb80c7b7b15baccdc596c71938f49315a", "patch": "@@ -68,9 +68,10 @@ class CompileItem : public HIRCompileBase\n     Bexpression *value = CompileExpr::Compile (var.get_expr (), ctx);\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    ok = ctx->get_mappings ()->lookup_canonical_path (\n       var.get_mappings ().get_crate_num (), var.get_mappings ().get_nodeid (),\n-      &canonical_path));\n+      &canonical_path);\n+    rust_assert (ok);\n \n     std::string name = canonical_path->get ();\n     std::string asm_name = ctx->mangle_item (resolved_type, *canonical_path);\n@@ -103,9 +104,10 @@ class CompileItem : public HIRCompileBase\n     Bexpression *value = CompileExpr::Compile (constant.get_expr (), ctx);\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    ok = ctx->get_mappings ()->lookup_canonical_path (\n       constant.get_mappings ().get_crate_num (),\n-      constant.get_mappings ().get_nodeid (), &canonical_path));\n+      constant.get_mappings ().get_nodeid (), &canonical_path);\n+    rust_assert (ok);\n \n     std::string ident = canonical_path->get ();\n     Bexpression *const_expr\n@@ -186,9 +188,10 @@ class CompileItem : public HIRCompileBase\n       flags |= Backend::function_is_visible;\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    bool ok = ctx->get_mappings ()->lookup_canonical_path (\n       function.get_mappings ().get_crate_num (),\n-      function.get_mappings ().get_nodeid (), &canonical_path));\n+      function.get_mappings ().get_nodeid (), &canonical_path);\n+    rust_assert (ok);\n \n     std::string ir_symbol_name\n       = canonical_path->get () + fntype->subst_as_string ();\n@@ -259,7 +262,7 @@ class CompileItem : public HIRCompileBase\n       }\n \n     std::vector<Bvariable *> locals;\n-    bool ok = compile_locals_for_block (*rib, fndecl, locals);\n+    ok = compile_locals_for_block (*rib, fndecl, locals);\n     rust_assert (ok);\n \n     Bblock *enclosing_scope = NULL;"}, {"sha": "754c5d25126ee2e7c7c396f5f1e60e698a867652", "filename": "gcc/rust/backend/rust-compile-stmt.h", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-stmt.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f569984bb80c7b7b15baccdc596c71938f49315a/gcc%2Frust%2Fbackend%2Frust-compile-stmt.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-stmt.h?ref=f569984bb80c7b7b15baccdc596c71938f49315a", "patch": "@@ -60,9 +60,10 @@ class CompileStmt : public HIRCompileBase\n     Bexpression *value = CompileExpr::Compile (constant.get_expr (), ctx);\n \n     const Resolver::CanonicalPath *canonical_path = nullptr;\n-    rust_assert (ctx->get_mappings ()->lookup_canonical_path (\n+    ok = ctx->get_mappings ()->lookup_canonical_path (\n       constant.get_mappings ().get_crate_num (),\n-      constant.get_mappings ().get_nodeid (), &canonical_path));\n+      constant.get_mappings ().get_nodeid (), &canonical_path);\n+    rust_assert (ok);\n \n     std::string ident = canonical_path->get ();\n     Bexpression *const_expr"}]}