{"sha": "c163647ffbc9a20c8feb6e079dbecccfe016c82e", "node_id": "C_kwDOANBUbNoAKGMxNjM2NDdmZmJjOWEyMGM4ZmViNmUwNzlkYmVjY2NmZTAxNmM4MmU", "commit": {"author": {"name": "S\u00f6ren Tempel", "email": "soeren@soeren-tempel.net", "date": "2022-01-21T19:22:46Z"}, "committer": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2022-01-21T19:22:46Z"}, "message": "Disable -fsplit-stack support on non-glibc targets\n\nThe -fsplit-stack option requires the pthread_t TCB definition in the\nlibc to provide certain struct fields at specific hardcoded offsets. As\nfar as I know, only glibc provides these fields at the required offsets.\nMost notably, musl libc does not have these fields. However, since gcc\naccesses the fields using a fixed offset, this does not cause a\ncompile-time error, but instead results in a silent memory corruption at\nrun-time with musl libc. For example, on s390x libgcc's\n__stack_split_initialize CTOR will overwrite the cancel field in the\npthread_t TCB on musl.\n\nThe -fsplit-stack option is used within the gcc code base itself by\ngcc-go (if available). On musl-based systems with split-stack support\n(i.e. s390x or x86) this causes Go programs compiled with gcc-go to\nmisbehave at run-time.\n\nThis patch fixes gcc-go on musl by disabling -fsplit-stack in gcc itself\nsince it is not supported on non-glibc targets anyhow. This is achieved\nby checking if gcc targets a glibc-based system. This check has been\nadded for x86 and s390x, the rs6000 config already checks for\nTARGET_GLIBC_MAJOR. Other architectures do not have split-stack\nsupport. With this patch applied, the gcc-go configure script will\ndetect that -fsplit-stack support is not available and will not use it.\n\nSee https://www.openwall.com/lists/musl/2012/10/16/12\n\nThis patch was written under the assumption that glibc is the only libc\nimplementation which supports the required fields at the required\noffsets in the pthread_t TCB. The patch has been tested on Alpine Linux\nEdge on the s390x and x86 architectures by bootstrapping Google's Go\nimplementation with gcc-go.\n\nSigned-off-by: S\u00f6ren Tempel <soeren@soeren-tempel.net>\n\ngcc/ChangeLog:\n\n\t* common/config/s390/s390-common.cc (s390_supports_split_stack):\n\tOnly support split-stack on glibc targets.\n\t* config/i386/gnu-user-common.h (STACK_CHECK_STATIC_BUILTIN): Ditto.\n\t* config/i386/gnu.h (defined): Ditto.", "tree": {"sha": "c690fbf0f1c2c425ab0d533eb7db6df6d954ba1d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c690fbf0f1c2c425ab0d533eb7db6df6d954ba1d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c163647ffbc9a20c8feb6e079dbecccfe016c82e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c163647ffbc9a20c8feb6e079dbecccfe016c82e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c163647ffbc9a20c8feb6e079dbecccfe016c82e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c163647ffbc9a20c8feb6e079dbecccfe016c82e/comments", "author": null, "committer": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "afe91e2566f47a6041f45095a48fc255625cb468", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/afe91e2566f47a6041f45095a48fc255625cb468", "html_url": "https://github.com/Rust-GCC/gccrs/commit/afe91e2566f47a6041f45095a48fc255625cb468"}], "stats": {"total": 24, "additions": 17, "deletions": 7}, "files": [{"sha": "547b0826f939b5641227007a4cb3e46c7a91ae42", "filename": "gcc/common/config/s390/s390-common.cc", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c163647ffbc9a20c8feb6e079dbecccfe016c82e/gcc%2Fcommon%2Fconfig%2Fs390%2Fs390-common.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c163647ffbc9a20c8feb6e079dbecccfe016c82e/gcc%2Fcommon%2Fconfig%2Fs390%2Fs390-common.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcommon%2Fconfig%2Fs390%2Fs390-common.cc?ref=c163647ffbc9a20c8feb6e079dbecccfe016c82e", "patch": "@@ -116,13 +116,19 @@ s390_handle_option (struct gcc_options *opts ATTRIBUTE_UNUSED,\n \n /* -fsplit-stack uses a field in the TCB, available with glibc-2.23.\n    We don't verify it, since earlier versions just have padding at\n-   its place, which works just as well.  */\n+   its place, which works just as well.  For other libc implementations\n+   we disable the feature entirely to avoid corrupting the TCB.  */\n \n static bool\n-s390_supports_split_stack (bool report ATTRIBUTE_UNUSED,\n-\t\t\t   struct gcc_options *opts ATTRIBUTE_UNUSED)\n+s390_supports_split_stack (bool report,\n+\t\t\t   struct gcc_options *opts)\n {\n-  return true;\n+  if (opts->x_linux_libc == LIBC_GLIBC)\n+    return true;\n+\n+  if (report)\n+    error (\"%<-fsplit-stack%> currently only supported on GNU/Linux\");\n+  return false;\n }\n \n #undef TARGET_DEFAULT_TARGET_FLAGS"}, {"sha": "7525f788a9c05c3876e6d2d510155f5bb59e9669", "filename": "gcc/config/i386/gnu-user-common.h", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c163647ffbc9a20c8feb6e079dbecccfe016c82e/gcc%2Fconfig%2Fi386%2Fgnu-user-common.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c163647ffbc9a20c8feb6e079dbecccfe016c82e/gcc%2Fconfig%2Fi386%2Fgnu-user-common.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fgnu-user-common.h?ref=c163647ffbc9a20c8feb6e079dbecccfe016c82e", "patch": "@@ -66,7 +66,8 @@ along with GCC; see the file COPYING3.  If not see\n #define STACK_CHECK_STATIC_BUILTIN 1\n \n /* We only build the -fsplit-stack support in libgcc if the\n-   assembler has full support for the CFI directives.  */\n-#if HAVE_GAS_CFI_PERSONALITY_DIRECTIVE\n+   assembler has full support for the CFI directives and\n+   targets glibc.  */\n+#if HAVE_GAS_CFI_PERSONALITY_DIRECTIVE && OPTION_GLIBC\n #define TARGET_CAN_SPLIT_STACK\n #endif"}, {"sha": "daa505a5d4503b7eebb08ddcdf27a574bda44701", "filename": "gcc/config/i386/gnu.h", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c163647ffbc9a20c8feb6e079dbecccfe016c82e/gcc%2Fconfig%2Fi386%2Fgnu.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c163647ffbc9a20c8feb6e079dbecccfe016c82e/gcc%2Fconfig%2Fi386%2Fgnu.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fgnu.h?ref=c163647ffbc9a20c8feb6e079dbecccfe016c82e", "patch": "@@ -35,7 +35,10 @@ along with GCC.  If not, see <http://www.gnu.org/licenses/>.\n    crti.o%s %{static:crtbeginT.o%s;shared|pie:crtbeginS.o%s;:crtbegin.o%s}\"\n #endif\n \n-#ifdef TARGET_LIBC_PROVIDES_SSP\n+/* -fsplit-stack uses a field in the TCB at a fixed offset. This\n+   field is only available for glibc.  Disable -fsplit-stack for\n+   other libc implementations to avoid silent TCB corruptions.  */\n+#if defined (TARGET_LIBC_PROVIDES_SSP) && OPTION_GLIBC\n \n /* i386 glibc provides __stack_chk_guard in %gs:0x14.  */\n #define TARGET_THREAD_SSP_OFFSET        0x14"}]}