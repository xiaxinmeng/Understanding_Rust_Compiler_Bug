{"sha": "54f397919ae47f9c2433be93fcc14288899beb8c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTRmMzk3OTE5YWU0N2Y5YzI0MzNiZTkzZmNjMTQyODg4OTliZWI4Yw==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2018-12-09T19:55:54Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gcc.gnu.org", "date": "2018-12-09T19:55:54Z"}, "message": "Generate and scan documentation output in Ddoc tests.\n\nThe tests in gdc.test/compilable/ddoc*.d don't require the module to be\ncompiled all the way down to object code.  Instead, only compile the\ntest sources with -fdoc, and scan the generated html content.\n\ngcc/testsuite/ChangeLog:\n\n\tPR d/88039\n\t* gdc.test/gdc-test.exp (gdc-convert-args): Handle -D.\n\t(dmd2dg): Check generated html in ddoc tests.\n\t(gdc-do-test): Set dg-do-what-default to compile for ddoc tests.\n\nFrom-SVN: r266933", "tree": {"sha": "dd018089cc652dc3988c715c571821c88940ca3e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/dd018089cc652dc3988c715c571821c88940ca3e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/54f397919ae47f9c2433be93fcc14288899beb8c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/54f397919ae47f9c2433be93fcc14288899beb8c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/54f397919ae47f9c2433be93fcc14288899beb8c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/54f397919ae47f9c2433be93fcc14288899beb8c/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "b8559e810f5912bba9fba39c005f3fe2c1de09d9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b8559e810f5912bba9fba39c005f3fe2c1de09d9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b8559e810f5912bba9fba39c005f3fe2c1de09d9"}], "stats": {"total": 33, "additions": 29, "deletions": 4}, "files": [{"sha": "043c5ea2ef289b45ca0df46a7bbb1bf62225d8b4", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/54f397919ae47f9c2433be93fcc14288899beb8c/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/54f397919ae47f9c2433be93fcc14288899beb8c/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=54f397919ae47f9c2433be93fcc14288899beb8c", "patch": "@@ -1,3 +1,10 @@\n+2018-12-09  Iain Buclaw  <ibuclaw@gdcproject.org>\n+\n+\tPR d/88039\n+\t* gdc.test/gdc-test.exp (gdc-convert-args): Handle -D.\n+\t(dmd2dg): Check generated html in ddoc tests.\n+\t(gdc-do-test): Set dg-do-what-default to compile for ddoc tests.\n+\n 2018-12-09  Steven G. Kargl  <kargl@gcc.gnu.org>\n \n \tPR fortran/88206"}, {"sha": "7dd97d393ea0911e9666d3d338004f7773efaff1", "filename": "gcc/testsuite/gdc.test/gdc-test.exp", "status": "modified", "additions": 22, "deletions": 4, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/54f397919ae47f9c2433be93fcc14288899beb8c/gcc%2Ftestsuite%2Fgdc.test%2Fgdc-test.exp", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/54f397919ae47f9c2433be93fcc14288899beb8c/gcc%2Ftestsuite%2Fgdc.test%2Fgdc-test.exp", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.test%2Fgdc-test.exp?ref=54f397919ae47f9c2433be93fcc14288899beb8c", "patch": "@@ -27,7 +27,10 @@ proc gdc-convert-args { args } {\n \n     foreach arg [split [lindex $args 0] \" \"] {\n         # List of switches kept in ASCII collated order.\n-        if { [regexp -- {^-I([\\w+/-]+)} $arg pattern path] } {\n+        if [string match \"-D\" $arg] {\n+            lappend out \"-fdoc\"\n+\n+        } elseif { [regexp -- {^-I([\\w+/-]+)} $arg pattern path] } {\n             lappend out \"-I$path\"\n \n         } elseif { [regexp -- {^-J([\\w+/-]+)} $arg pattern path] } {\n@@ -183,6 +186,7 @@ proc dmd2dg { base test } {\n \n     # Split base, folder/file.\n     set type [file dirname $test]\n+    set name [file tail $test]\n \n     # print \"Filename: $base - $test\"\n \n@@ -279,7 +283,7 @@ proc dmd2dg { base test } {\n     # Compilable files are successful if an output is generated.\n     # Fail compilable are successful if an output is not generated.\n     # Runnable must compile, link, and return 0 to be successful by default.\n-    switch [file dirname $test] {\n+    switch $type {\n         runnable {\n             if ![isnative] {\n                 set out_line \"// { dg-final { output-exists } }\"\n@@ -290,6 +294,16 @@ proc dmd2dg { base test } {\n         compilable {\n             set out_line \"// { dg-final { output-exists } }\"\n             puts $fdout $out_line\n+\n+            # Check that Ddoc tests also generate a html file.\n+            if [regexp -- \"ddoc.*\" $name] {\n+                set ddocfile \"[file rootname $name].html\"\n+                set out_line \"// { dg-final { scan-file $ddocfile \\\"Generated by Ddoc from $test\\\" } }\"\n+                puts $fdout $out_line\n+                # Cleanup extra generated files.\n+                set out_line \"// { dg-final { file delete $ddocfile } }\"\n+                puts $fdout $out_line\n+            }\n         }\n \n         fail_compilation {\n@@ -389,8 +403,12 @@ proc gdc-do-test { } {\n             compilable {\n                 for { set i 0 } { $i<[llength $options] } { incr i } {\n                     set flags [lindex $options $i]\n-                    #set dg-do-what-default \"compile\"\n-                    set dg-do-what-default \"assemble\"\n+                    # Compilable test may require checking another kind of output file.\n+                    if [regexp -- \"ddoc.*\" $name] {\n+                        set dg-do-what-default \"compile\"\n+                    } else {\n+                        set dg-do-what-default \"assemble\"\n+                    }\n                     gdc-dg-runtest $filename $flags $imports\n                 }\n             }"}]}