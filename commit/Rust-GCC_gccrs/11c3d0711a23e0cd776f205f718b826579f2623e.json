{"sha": "11c3d0711a23e0cd776f205f718b826579f2623e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTFjM2QwNzExYTIzZTBjZDc3NmYyMDVmNzE4YjgyNjU3OWYyNjIzZQ==", "commit": {"author": {"name": "Caroline Tice", "email": "cmtice@google.com", "date": "2015-04-30T17:49:02Z"}, "committer": {"name": "Caroline Tice", "email": "ctice@gcc.gnu.org", "date": "2015-04-30T17:49:02Z"}, "message": "Define & use special macros to record the name & size of cold partitions.\n\nDefine & use special macros to record the name & size of cold\npartitions.  (Fix PR 65929).\n\ngcc/ChangeLog\n\nPR 65929\n* config/elfos.h (ASM_DECLARE_COLD_FUNCTION_NAME): New macro definition.\n(ASM_DECLARE_COLD_FUNCTION_SIZE): New macro definition.\n* doc/tm.texi.in (ASM_DECLARE_COLD_FUNCTION_NAME): Document new macro.\n(ASM_DECLARE_COLD_FUNCTION_SIZE): Document new macro.\n* final.c (final_scan_insn):  Use ASM_DECLARE_COLD_FUNCTION_NAME\ninstead of ASM_DECLARE_FUNCTION_NAME for cold partition name.\n* varasm.c (assemble_end_function):  Use ASM_DECLARE_COLD_FUNCTION_SIZE\ninstead of ASM_DECLARE_FUNCTION_SIZE for cold partition size.\n\ngcc/testsuite/ChangeLog:\n\nPR  65929\n* gcc.dg/tree-prof/cold_partition_label.c:  Only check for cold\npartition size on certain targets.\n\nFrom-SVN: r222643", "tree": {"sha": "759784a887a9d386af425979450e9cb8697c4e43", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/759784a887a9d386af425979450e9cb8697c4e43"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/11c3d0711a23e0cd776f205f718b826579f2623e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/11c3d0711a23e0cd776f205f718b826579f2623e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/11c3d0711a23e0cd776f205f718b826579f2623e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/11c3d0711a23e0cd776f205f718b826579f2623e/comments", "author": {"login": "cmtice", "id": 5561162, "node_id": "MDQ6VXNlcjU1NjExNjI=", "avatar_url": "https://avatars.githubusercontent.com/u/5561162?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cmtice", "html_url": "https://github.com/cmtice", "followers_url": "https://api.github.com/users/cmtice/followers", "following_url": "https://api.github.com/users/cmtice/following{/other_user}", "gists_url": "https://api.github.com/users/cmtice/gists{/gist_id}", "starred_url": "https://api.github.com/users/cmtice/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cmtice/subscriptions", "organizations_url": "https://api.github.com/users/cmtice/orgs", "repos_url": "https://api.github.com/users/cmtice/repos", "events_url": "https://api.github.com/users/cmtice/events{/privacy}", "received_events_url": "https://api.github.com/users/cmtice/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "ae9af49bd4d4f247eb5a1d179e207da899d101a6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ae9af49bd4d4f247eb5a1d179e207da899d101a6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ae9af49bd4d4f247eb5a1d179e207da899d101a6"}], "stats": {"total": 94, "additions": 84, "deletions": 10}, "files": [{"sha": "24ca2c2da2bf254ea820a0ebfd82585dcd6c758c", "filename": "gcc/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -1,3 +1,15 @@\n+2015-04-30  Caroline Tice  <cmtice@google.com>\n+\n+        PR 65929\n+\t* config/elfos.h (ASM_DECLARE_COLD_FUNCTION_NAME): New macro definition.\n+\t(ASM_DECLARE_COLD_FUNCTION_SIZE): New macro definition.\n+\t* doc/tm.texi.in (ASM_DECLARE_COLD_FUNCTION_NAME): Document new macro.\n+\t(ASM_DECLARE_COLD_FUNCTION_SIZE): Document new macro.\n+\t* final.c (final_scan_insn):  Use ASM_DECLARE_COLD_FUNCTION_NAME\n+\tinstead of ASM_DECLARE_FUNCTION_NAME for cold partition name.\n+\t* varasm.c (assemble_end_function):  Use ASM_DECLARE_COLD_FUNCTION_SIZE\n+\tinstead of ASM_DECLARE_FUNCTION_SIZE for cold partition size.\n+\n 2015-04-30  Marek Polacek  <polacek@redhat.com>\n \n \t* varasm.c (handle_cache_entry): Fix logic."}, {"sha": "2224961705c737f0401223c71ec03a9fc68edac1", "filename": "gcc/config/elfos.h", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Fconfig%2Felfos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Fconfig%2Felfos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Felfos.h?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -284,6 +284,22 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n   while (0)\n #endif\n \n+/* Write the extra assembler code needed to declare the name of a\n+   cold function partition properly. Some svr4 assemblers need to also\n+   have something extra said about the function's return value.  We\n+   allow for that here.  */\n+\n+#ifndef ASM_DECLARE_COLD_FUNCTION_NAME\n+#define ASM_DECLARE_COLD_FUNCTION_NAME(FILE, NAME, DECL)\t\\\n+  do\t\t\t\t\t\t\t\t\\\n+    {\t\t\t\t\t\t\t\t\\\n+      ASM_OUTPUT_TYPE_DIRECTIVE (FILE, NAME, \"function\");\t\\\n+      ASM_DECLARE_RESULT (FILE, DECL_RESULT (DECL));\t\t\\\n+      ASM_OUTPUT_FUNCTION_LABEL (FILE, NAME, DECL);\t\t\\\n+    }\t\t\t\t\t\t\t\t\\\n+  while (0)\n+#endif\n+\n /* Write the extra assembler code needed to declare an object properly.  */\n \n #ifdef HAVE_GAS_GNU_UNIQUE_OBJECT\n@@ -358,6 +374,17 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n   while (0)\n #endif\n \n+/* This is how to declare the size of a cold function partition.  */\n+#ifndef ASM_DECLARE_COLD_FUNCTION_SIZE\n+#define ASM_DECLARE_COLD_FUNCTION_SIZE(FILE, FNAME, DECL)\t\\\n+  do\t\t\t\t\t\t\t\t\\\n+    {\t\t\t\t\t\t\t\t\\\n+      if (!flag_inhibit_size_directive)\t\t\t\t\\\n+\tASM_OUTPUT_MEASURED_SIZE (FILE, FNAME);\t\t\t\\\n+    }\t\t\t\t\t\t\t\t\\\n+  while (0)\n+#endif\n+\n /* A table of bytes codes used by the ASM_OUTPUT_ASCII and\n    ASM_OUTPUT_LIMITED_STRING macros.  Each byte in the table\n    corresponds to a particular byte value [0..255].  For any"}, {"sha": "86809676b39f23e2aaea5f123ded2a7d2dc19f7a", "filename": "gcc/doc/tm.texi.in", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Fdoc%2Ftm.texi.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Fdoc%2Ftm.texi.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Ftm.texi.in?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -5574,6 +5574,34 @@ You may wish to use @code{ASM_OUTPUT_MEASURED_SIZE} in the definition\n of this macro.\n @end defmac\n \n+@defmac ASM_DECLARE_COLD_FUNCTION_NAME (@var{stream}, @var{name}, @var{decl})\n+A C statement (sans semicolon) to output to the stdio stream\n+@var{stream} any text necessary for declaring the name @var{name} of a\n+cold function partition which is being defined.  This macro is responsible\n+for outputting the label definition (perhaps using\n+@code{ASM_OUTPUT_FUNCTION_LABEL}).  The argument @var{decl} is the\n+@code{FUNCTION_DECL} tree node representing the function.\n+\n+If this macro is not defined, then the cold partition name is defined in the\n+usual manner as a label (by means of @code{ASM_OUTPUT_LABEL}).\n+\n+You may wish to use @code{ASM_OUTPUT_TYPE_DIRECTIVE} in the definition\n+of this macro.\n+@end defmac\n+\n+@defmac ASM_DECLARE_COLD_FUNCTION_SIZE (@var{stream}, @var{name}, @var{decl})\n+A C statement (sans semicolon) to output to the stdio stream\n+@var{stream} any text necessary for declaring the size of a cold function\n+partition which is being defined.  The argument @var{name} is the name of the\n+cold partition of the function.  The argument @var{decl} is the\n+@code{FUNCTION_DECL} tree node representing the function.\n+\n+If this macro is not defined, then the partition size is not defined.\n+\n+You may wish to use @code{ASM_OUTPUT_MEASURED_SIZE} in the definition\n+of this macro.\n+@end defmac\n+\n @defmac ASM_DECLARE_OBJECT_NAME (@var{stream}, @var{name}, @var{decl})\n A C statement (sans semicolon) to output to the stdio stream\n @var{stream} any text necessary for declaring the name @var{name} of an"}, {"sha": "2b9846e881e4b6e34b15e4d29fe184214716756b", "filename": "gcc/final.c", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Ffinal.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Ffinal.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffinal.c?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -2235,10 +2235,11 @@ final_scan_insn (rtx_insn *insn, FILE *file, int optimize_p ATTRIBUTE_UNUSED,\n \t    {\n \t      cold_function_name\n \t\t= clone_function_name (current_function_decl, \"cold\");\n-#ifdef ASM_DECLARE_FUNCTION_NAME\n-\t      ASM_DECLARE_FUNCTION_NAME (asm_out_file,\n-\t\t\t\t\t IDENTIFIER_POINTER (cold_function_name),\n-\t\t\t\t\t current_function_decl);\n+#ifdef ASM_DECLARE_COLD_FUNCTION_NAME\n+\t      ASM_DECLARE_COLD_FUNCTION_NAME (asm_out_file,\n+\t\t\t\t\t      IDENTIFIER_POINTER\n+\t\t\t\t\t          (cold_function_name),\n+\t\t\t\t\t      current_function_decl);\n #else\n \t      ASM_OUTPUT_LABEL (asm_out_file,\n \t\t\t\tIDENTIFIER_POINTER (cold_function_name));"}, {"sha": "00af2c428333767e008dfeb7d8dc9fbe0722f313", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -1,3 +1,9 @@\n+2015-04-30  Caroline Tice  <cmtice@google.com>\n+\n+\tPR  65929\n+\t* gcc.dg/tree-prof/cold_partition_label.c:  Only check for cold\n+\tpartition size on certain targets.\n+\n 2015-04-30  Renlin Li  <renlin.li@arm.com>\n \n \t* gcc.target/aarch64/vect-reduc-or_1.c: New."}, {"sha": "42a19abafe768927dc7b0d336ffd8873900fa002", "filename": "gcc/testsuite/gcc.dg/tree-prof/cold_partition_label.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-prof%2Fcold_partition_label.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-prof%2Fcold_partition_label.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-prof%2Fcold_partition_label.c?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -35,6 +35,6 @@ main (int argc, char *argv[])\n   return 0;\n }\n \n-/* { dg-final-use { scan-assembler \"foo\\[._\\]+cold\\[\\._\\]+0\" } } */\n-/* { dg-final-use { scan-assembler \"size\\[ \\ta-zA-Z0-0\\]+foo\\[._\\]+cold\\[\\._\\]+0\" } } */\n+/* { dg-final-use { scan-assembler \"foo\\[._\\]+cold\\[\\._\\]+0\" { target *-*-linux* *-*-gnu* } } } */\n+/* { dg-final-use { scan-assembler \"size\\[ \\ta-zA-Z0-0\\]+foo\\[._\\]+cold\\[\\._\\]+0\" { target *-*-linux* *-*-gnu* } } } */\n /* { dg-final-use { cleanup-saved-temps } } */"}, {"sha": "62d516303c21dc0359f5bafb05b06015c7f6285b", "filename": "gcc/varasm.c", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Fvarasm.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11c3d0711a23e0cd776f205f718b826579f2623e/gcc%2Fvarasm.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvarasm.c?ref=11c3d0711a23e0cd776f205f718b826579f2623e", "patch": "@@ -1864,11 +1864,11 @@ assemble_end_function (tree decl, const char *fnname ATTRIBUTE_UNUSED)\n \n       save_text_section = in_section;\n       switch_to_section (unlikely_text_section ());\n-#ifdef ASM_DECLARE_FUNCTION_SIZE\n+#ifdef ASM_DECLARE_COLD_FUNCTION_SIZE\n       if (cold_function_name != NULL_TREE)\n-\tASM_DECLARE_FUNCTION_SIZE (asm_out_file,\n-\t\t\t\t   IDENTIFIER_POINTER (cold_function_name),\n-\t\t\t\t   decl);\n+\tASM_DECLARE_COLD_FUNCTION_SIZE (asm_out_file,\n+\t\t\t\t\tIDENTIFIER_POINTER (cold_function_name),\n+\t\t\t\t\tdecl);\n #endif\n       ASM_OUTPUT_LABEL (asm_out_file, crtl->subsections.cold_section_end_label);\n       if (first_function_block_is_cold)"}]}