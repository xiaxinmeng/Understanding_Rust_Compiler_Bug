{"sha": "a169f35890152e8a31ef9bdc0d28a2e0a62e866e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTE2OWYzNTg5MDE1MmU4YTMxZWY5YmRjMGQyOGEyZTBhNjJlODY2ZQ==", "commit": {"author": {"name": "Jim Wilson", "email": "jimw@sifive.com", "date": "2019-08-30T23:32:52Z"}, "committer": {"name": "Jim Wilson", "email": "wilson@gcc.gnu.org", "date": "2019-08-30T23:32:52Z"}, "message": "RISC-V: Disable -msave-restore for shared libraries.\n\nThis was noticed while trying to test -msave-restore support.  The\nsave/restore routines use the alternate return register t0/x5 which is\nclobbered by the PLT header, so we can't use them in shared libraries.\nThis patch disables -msave-restore when -fpic (and -mplt), and emits a\nwarning if the user explicitly turned on -msave-restore.\n\n\tgcc/\n\t* config/riscv/riscv.c (riscv_option_override): If -msave-restore\n\tand -fpic and -mplt then disable -msave-restore and warn.\n\nFrom-SVN: r275231", "tree": {"sha": "65cc8352d4cfbbf79ce8d3e14f69b6f8196876f7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/65cc8352d4cfbbf79ce8d3e14f69b6f8196876f7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a169f35890152e8a31ef9bdc0d28a2e0a62e866e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a169f35890152e8a31ef9bdc0d28a2e0a62e866e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a169f35890152e8a31ef9bdc0d28a2e0a62e866e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a169f35890152e8a31ef9bdc0d28a2e0a62e866e/comments", "author": null, "committer": null, "parents": [{"sha": "4a140826453da37a134d792e0224f4e37343e68a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4a140826453da37a134d792e0224f4e37343e68a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4a140826453da37a134d792e0224f4e37343e68a"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "04e773a196ae3473c6c87bf08ba495657a4d3687", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a169f35890152e8a31ef9bdc0d28a2e0a62e866e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a169f35890152e8a31ef9bdc0d28a2e0a62e866e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a169f35890152e8a31ef9bdc0d28a2e0a62e866e", "patch": "@@ -1,3 +1,8 @@\n+2019-08-30  Jim Wilson  <jimw@sifive.com>\n+\n+\t* config/riscv/riscv.c (riscv_option_override): If -msave-restore\n+\tand -fpic and -mplt then disable -msave-restore and warn.\n+\n 2019-08-30  Martin Sebor  <msebor@redhat.com>\n \n \tPR middle-end/91599"}, {"sha": "1e7528f1cb993601a07448ff7fb36434bf61d589", "filename": "gcc/config/riscv/riscv.c", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a169f35890152e8a31ef9bdc0d28a2e0a62e866e/gcc%2Fconfig%2Friscv%2Friscv.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a169f35890152e8a31ef9bdc0d28a2e0a62e866e/gcc%2Fconfig%2Friscv%2Friscv.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv.c?ref=a169f35890152e8a31ef9bdc0d28a2e0a62e866e", "patch": "@@ -4636,6 +4636,16 @@ riscv_option_override (void)\n     error (\"%<-mriscv-attribute%> RISC-V ELF attribute requires GNU as 2.32\"\n \t   \" [%<-mriscv-attribute%>]\");\n #endif\n+\n+  /* The save-restore routines use t0 which is clobbered by the plt header,\n+     so we can't use them when building shared libraries.  */\n+  if (TARGET_SAVE_RESTORE && flag_pic && TARGET_PLT)\n+    {\n+      target_flags &= ~MASK_SAVE_RESTORE;\n+      if (target_flags_explicit & MASK_SAVE_RESTORE)\n+\twarning (0, \"%<-msave-restore%> disabled; not supported with PLT \"\n+\t\t \"based shared libraries\");\n+    }\n }\n \n /* Implement TARGET_CONDITIONAL_REGISTER_USAGE.  */"}]}