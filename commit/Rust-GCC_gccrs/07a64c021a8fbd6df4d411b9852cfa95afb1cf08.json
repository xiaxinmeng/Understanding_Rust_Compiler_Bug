{"sha": "07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDdhNjRjMDIxYThmYmQ2ZGY0ZDQxMWI5ODUyY2ZhOTVhZmIxY2YwOA==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2015-02-20T09:08:30Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2015-02-20T09:08:30Z"}, "message": "[multiple changes]\n\n2015-02-20  Robert Dewar  <dewar@adacore.com>\n\n\t* sem_res.adb: Minor reformatting.\n\t* exp_ch9.adb (Build_Protected_Spec): Copy Aliased setting when\n\tbuilding spec.\n\t* sem_ch13.adb (Analyze_Aspect_Specifications): Exclude Boolean\n\taspects from circuitry setting delay required to false if the\n\targument is an integer literal.\n\n2015-02-20  Ed Schonberg  <schonberg@adacore.com>\n\n\t* einfo.ads. einfo.adb (Partial_View_Has_Unknown_Discr):  New flag\n\ton type entities, to enforce AI12-0133: default initialization\n\tof types whose partial view has unknown discriminants does not\n\tget an invariant check, because clients of the unit can never\n\tdeclare objects of such types.\n\t* sem_ch3.adb (Find_Type_Name); Set new flag\n\tPartial_View_Has_Unknown_Discr when needed.\n\t* exp_ch3.adb (Expand_N_Object_Declaration): Use flag to suppress\n\tgeneration of invariant call on default-initialized object.\n\nFrom-SVN: r220836", "tree": {"sha": "004a9fe35a9f9bd2e48653c6dd78f6166ff6c825", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/004a9fe35a9f9bd2e48653c6dd78f6166ff6c825"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "html_url": "https://github.com/Rust-GCC/gccrs/commit/07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/comments", "author": null, "committer": null, "parents": [{"sha": "283b768c860d632cb50af82a459a9f4c985f3cbf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/283b768c860d632cb50af82a459a9f4c985f3cbf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/283b768c860d632cb50af82a459a9f4c985f3cbf"}], "stats": {"total": 100, "additions": 82, "deletions": 18}, "files": [{"sha": "bcc6d85aca84a31be3f660814d47202829f8b9ab", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -1,3 +1,24 @@\n+2015-02-20  Robert Dewar  <dewar@adacore.com>\n+\n+\t* sem_res.adb: Minor reformatting.\n+\t* exp_ch9.adb (Build_Protected_Spec): Copy Aliased setting when\n+\tbuilding spec.\n+\t* sem_ch13.adb (Analyze_Aspect_Specifications): Exclude Boolean\n+\taspects from circuitry setting delay required to false if the\n+\targument is an integer literal.\n+\n+2015-02-20  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* einfo.ads. einfo.adb (Partial_View_Has_Unknown_Discr):  New flag\n+\ton type entities, to enforce AI12-0133: default initialization\n+\tof types whose partial view has unknown discriminants does not\n+\tget an invariant check, because clients of the unit can never\n+\tdeclare objects of such types.\n+\t* sem_ch3.adb (Find_Type_Name); Set new flag\n+\tPartial_View_Has_Unknown_Discr when needed.\n+\t* exp_ch3.adb (Expand_N_Object_Declaration): Use flag to suppress\n+\tgeneration of invariant call on default-initialized object.\n+\n 2015-02-08  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* gcc-interface/decl.c (gnat_to_gnu_param): Do not strip the padding"}, {"sha": "35c8c9fbba853d82c6f6839c90854ffbabcd130e", "filename": "gcc/ada/einfo.adb", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Feinfo.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Feinfo.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Feinfo.adb?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -576,8 +576,7 @@ package body Einfo is\n    --    Is_Checked_Ghost_Entity         Flag277\n    --    Is_Ignored_Ghost_Entity         Flag278\n    --    Contains_Ignored_Ghost_Code     Flag279\n-\n-   --    (unused)                        Flag280\n+   --    Partial_View_Has_Unknown_Discr  Flag280\n \n    --    (unused)                        Flag281\n    --    (unused)                        Flag282\n@@ -2739,6 +2738,12 @@ package body Einfo is\n       return Elist9 (Id);\n    end Part_Of_Constituents;\n \n+   function Partial_View_Has_Unknown_Discr (Id : E) return B is\n+   begin\n+      pragma Assert (Is_Type (Id));\n+      return Flag280 (Id);\n+   end Partial_View_Has_Unknown_Discr;\n+\n    function Pending_Access_Types (Id : E) return L is\n    begin\n       pragma Assert (Is_Type (Id));\n@@ -5632,6 +5637,12 @@ package body Einfo is\n       Set_Elist9 (Id, V);\n    end Set_Part_Of_Constituents;\n \n+   procedure Set_Partial_View_Has_Unknown_Discr (Id : E; V : B := True) is\n+   begin\n+      pragma Assert (Is_Type (Id));\n+      Set_Flag280 (Id, V);\n+   end Set_Partial_View_Has_Unknown_Discr;\n+\n    procedure Set_Pending_Access_Types (Id : E; V : L) is\n    begin\n       pragma Assert (Is_Type (Id));"}, {"sha": "85a7931325bdfda4d1fb5bd13782666f187023a7", "filename": "gcc/ada/einfo.ads", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Feinfo.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Feinfo.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Feinfo.ads?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -3578,6 +3578,11 @@ package Einfo is\n --       Present in abstract state entities. Contains all constituents that are\n --       subject to indicator Part_Of (both aspect and option variants).\n \n+--    Partial_View_Has_Unknown_Discr (Flag280)\n+--       Present on types entities. Indicates that the partial view of a type\n+--       has unknown discriminants. A default initialization of an object of\n+--       the type does not require an invariant check (AI12-0133).\n+\n --    Pending_Access_Types (Elist15)\n --       Defined in all types. Set for incomplete, private, Taft-amendment\n --       types, and their corresponding full views. This list contains all\n@@ -5358,6 +5363,7 @@ package Einfo is\n    --    Must_Have_Preelab_Init              (Flag208)\n    --    Optimize_Alignment_Space            (Flag241)\n    --    Optimize_Alignment_Time             (Flag242)\n+   --    Partial_View_Has_Unknown_Discr      (Flag280)\n    --    Size_Depends_On_Discriminant        (Flag177)\n    --    Size_Known_At_Compile_Time          (Flag92)\n    --    Strict_Alignment                    (Flag145)  (base type only)\n@@ -6877,6 +6883,7 @@ package Einfo is\n    function Packed_Array_Impl_Type              (Id : E) return E;\n    function Parent_Subtype                      (Id : E) return E;\n    function Part_Of_Constituents                (Id : E) return L;\n+   function Partial_View_Has_Unknown_Discr      (Id : E) return B;\n    function Pending_Access_Types                (Id : E) return L;\n    function Postcondition_Proc                  (Id : E) return E;\n    function Prival                              (Id : E) return E;\n@@ -7524,6 +7531,7 @@ package Einfo is\n    procedure Set_Packed_Array_Impl_Type          (Id : E; V : E);\n    procedure Set_Parent_Subtype                  (Id : E; V : E);\n    procedure Set_Part_Of_Constituents            (Id : E; V : L);\n+   procedure Set_Partial_View_Has_Unknown_Discr  (Id : E; V : B := True);\n    procedure Set_Pending_Access_Types            (Id : E; V : L);\n    procedure Set_Postcondition_Proc              (Id : E; V : E);\n    procedure Set_Prival                          (Id : E; V : E);\n@@ -8323,6 +8331,7 @@ package Einfo is\n    pragma Inline (Parameter_Mode);\n    pragma Inline (Parent_Subtype);\n    pragma Inline (Part_Of_Constituents);\n+   pragma Inline (Partial_View_Has_Unknown_Discr);\n    pragma Inline (Pending_Access_Types);\n    pragma Inline (Postcondition_Proc);\n    pragma Inline (Prival);\n@@ -8769,6 +8778,7 @@ package Einfo is\n    pragma Inline (Set_Packed_Array_Impl_Type);\n    pragma Inline (Set_Parent_Subtype);\n    pragma Inline (Set_Part_Of_Constituents);\n+   pragma Inline (Partial_View_Has_Unknown_Discr);\n    pragma Inline (Set_Pending_Access_Types);\n    pragma Inline (Set_Postcondition_Proc);\n    pragma Inline (Set_Prival);"}, {"sha": "095e23368b38583f640e2a15e425e337e5c8214b", "filename": "gcc/ada/exp_ch3.adb", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fexp_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fexp_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch3.adb?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -5503,10 +5503,13 @@ package body Exp_Ch3 is\n                Ensure_Freeze_Node (Def_Id);\n                Set_Has_Delayed_Freeze (Def_Id);\n                Set_Is_Frozen (Def_Id, False);\n-               Append_Freeze_Action (Def_Id,\n-                 Make_Invariant_Call (New_Occurrence_Of (Def_Id, Loc)));\n \n-            else\n+               if not Partial_View_Has_Unknown_Discr (Typ) then\n+                  Append_Freeze_Action (Def_Id,\n+                    Make_Invariant_Call (New_Occurrence_Of (Def_Id, Loc)));\n+               end if;\n+\n+            elsif not Partial_View_Has_Unknown_Discr (Typ) then\n                Insert_After (N,\n                  Make_Invariant_Call (New_Occurrence_Of (Def_Id, Loc)));\n             end if;"}, {"sha": "361952ba9fc2a99541c29627c68c2f05b9ed23bd", "filename": "gcc/ada/exp_ch9.adb", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fexp_ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fexp_ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch9.adb?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -4032,8 +4032,9 @@ package body Exp_Ch9 is\n            Make_Parameter_Specification (Loc,\n              Defining_Identifier =>\n                Make_Defining_Identifier (Sloc (Formal), Chars (Formal)),\n-             In_Present          => In_Present (Parent (Formal)),\n-             Out_Present         => Out_Present (Parent (Formal)),\n+             Aliased_Present     => Aliased_Present (Parent (Formal)),\n+             In_Present          => In_Present      (Parent (Formal)),\n+             Out_Present         => Out_Present     (Parent (Formal)),\n              Parameter_Type      => New_Occurrence_Of (Etype (Formal), Loc));\n \n          if Unprotected then"}, {"sha": "56aee5a5cac41e5718ff1e5aceedc2c6e948fb8d", "filename": "gcc/ada/sem_ch13.adb", "status": "modified", "additions": 19, "deletions": 8, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fsem_ch13.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fsem_ch13.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch13.adb?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -1621,14 +1621,25 @@ package body Sem_Ch13 is\n                   --  do not delay, since we know the value cannot change.\n                   --  This optimization catches most rep clause cases.\n \n-               if (Present (Expr) and then Nkind (Expr) = N_Integer_Literal)\n-                 or else (A_Id in Boolean_Aspects and then No (Expr))\n-               then\n-                  Delay_Required := False;\n-               else\n-                  Delay_Required := True;\n-                  Set_Has_Delayed_Rep_Aspects (E);\n-               end if;\n+                  --  For Boolean aspects, don't delay if no expression\n+\n+                  if A_Id in Boolean_Aspects and then No (Expr) then\n+                     Delay_Required := False;\n+\n+                  --  For non-Boolean aspects, don't delay if integer literal\n+\n+                  elsif A_Id not in Boolean_Aspects\n+                    and then Present (Expr)\n+                    and then Nkind (Expr) = N_Integer_Literal\n+                  then\n+                     Delay_Required := False;\n+\n+                  --  All other cases are delayed\n+\n+                  else\n+                     Delay_Required := True;\n+                     Set_Has_Delayed_Rep_Aspects (E);\n+                  end if;\n             end case;\n \n             --  Processing based on specific aspect"}, {"sha": "a017734438f67364f736f3939ccf6dd90d915637", "filename": "gcc/ada/sem_ch3.adb", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fsem_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fsem_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch3.adb?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -16459,6 +16459,13 @@ package body Sem_Ch3 is\n             Set_Has_Private_Declaration (Prev);\n             Set_Has_Private_Declaration (Id);\n \n+            --  AI12-0133 : indicate whether we have a partial view with\n+            --  unknown discriminants, in which case initialization of objects\n+            --  of the type do not receive an invariant check.\n+\n+            Set_Partial_View_Has_Unknown_Discr\n+              (Prev, Has_Unknown_Discriminants (Id));\n+\n             --  Preserve aspect and iterator flags that may have been set on\n             --  the partial view.\n "}, {"sha": "851e0a6608dace0ecd59acadc1ca6df5a7245cc3", "filename": "gcc/ada/sem_res.adb", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fsem_res.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07a64c021a8fbd6df4d411b9852cfa95afb1cf08/gcc%2Fada%2Fsem_res.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_res.adb?ref=07a64c021a8fbd6df4d411b9852cfa95afb1cf08", "patch": "@@ -3091,9 +3091,9 @@ package body Sem_Res is\n       --  This must be determined before the actual is resolved and expanded\n       --  because if needed the transient scope must be introduced earlier.\n \n-      ------------------------------\n-      --  Check_Aliased_Parameter --\n-      ------------------------------\n+      -----------------------------\n+      -- Check_Aliased_Parameter --\n+      -----------------------------\n \n       procedure Check_Aliased_Parameter is\n          Nominal_Subt : Entity_Id;"}]}