{"sha": "353e51f8e5da990ea163d43b6ce6c828848f4891", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzUzZTUxZjhlNWRhOTkwZWExNjNkNDNiNmNlNmM4Mjg4NDhmNDg5MQ==", "commit": {"author": {"name": "Stan Shebs", "email": "shebs@apple.com", "date": "2001-06-11T18:59:42Z"}, "committer": {"name": "Stan Shebs", "email": "shebs@gcc.gnu.org", "date": "2001-06-11T18:59:42Z"}, "message": "darwin.c (darwin_encode_section_info): Rewrite to simplify and fix coding mistakes.\n\n        * darwin.c (darwin_encode_section_info):  Rewrite to simplify\n        and fix coding mistakes.\n\nFrom-SVN: r43200", "tree": {"sha": "a156ad6f58e7cde9a778abfc8c47a4b0604b9243", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a156ad6f58e7cde9a778abfc8c47a4b0604b9243"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/353e51f8e5da990ea163d43b6ce6c828848f4891", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/353e51f8e5da990ea163d43b6ce6c828848f4891", "html_url": "https://github.com/Rust-GCC/gccrs/commit/353e51f8e5da990ea163d43b6ce6c828848f4891", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/353e51f8e5da990ea163d43b6ce6c828848f4891/comments", "author": null, "committer": null, "parents": [{"sha": "16f104b32ce13a42aa288b39694a714ad256917a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/16f104b32ce13a42aa288b39694a714ad256917a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/16f104b32ce13a42aa288b39694a714ad256917a"}], "stats": {"total": 60, "additions": 38, "deletions": 22}, "files": [{"sha": "15effda2d708d4342e9daba79d9a004288521788", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/353e51f8e5da990ea163d43b6ce6c828848f4891/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/353e51f8e5da990ea163d43b6ce6c828848f4891/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=353e51f8e5da990ea163d43b6ce6c828848f4891", "patch": "@@ -1,3 +1,8 @@\n+2001-06-11  Stan Shebs  <shebs@apple.com>\n+\n+\t* darwin.c (darwin_encode_section_info):  Rewrite to simplify\n+\tand fix coding mistakes.\n+\n 2001-06-11  Nick Clifton  <nickc@cambridge.redhat.com>\n \n \t* config/m32r/m32r.md (movstrsi_internal): Do not expect a"}, {"sha": "37715796cb0df1c6d6798bcbc57cc0877dd463be", "filename": "gcc/config/darwin.c", "status": "modified", "additions": 33, "deletions": 22, "changes": 55, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/353e51f8e5da990ea163d43b6ce6c828848f4891/gcc%2Fconfig%2Fdarwin.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/353e51f8e5da990ea163d43b6ce6c828848f4891/gcc%2Fconfig%2Fdarwin.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.c?ref=353e51f8e5da990ea163d43b6ce6c828848f4891", "patch": "@@ -1001,6 +1001,9 @@ darwin_encode_section_info (decl)\n {\n   char code = '\\0';\n   int defined = 0;\n+  rtx sym_ref;\n+  char *orig_str, *new_str;\n+  size_t len, new_len;\n \n   if ((TREE_CODE (decl) == FUNCTION_DECL\n        || TREE_CODE (decl) == VAR_DECL)\n@@ -1014,30 +1017,38 @@ darwin_encode_section_info (decl)\n   else if (TREE_CODE (decl) == VAR_DECL)\n     code = (defined ? 'D' : 'd');\n \n-  if (code != '\\0')\n-    {\n-      rtx sym_ref = XEXP (DECL_RTL (decl), 0);\n-\n-      if (*(XSTR (sym_ref, 0)) == '!')\n-\t{\n-\t  (XSTR(sym_ref, 0))[1] = code;\n-\t  update_non_lazy_ptrs (XSTR (sym_ref, 0));\n-\t  return;\n-\t}\n-\n-      {\n-\tsize_t len = strlen (XSTR (sym_ref, 0));\n-\tsize_t newlen = len + 4;\n-\tchar *str = alloca (newlen);\n+  if (code == '\\0')\n+    return;\n \n-\tstr[0] = '!';\n-\tstr[1] = code;\n-\tstr[2] = '_';\n-\tstr[3] = '_';\n-\tmemcpy (str + 4, XSTR (sym_ref, 0), len + 1);\n+  sym_ref = XEXP (DECL_RTL (decl), 0);\n+  orig_str = XSTR (sym_ref, 0);\n+  len = strlen (orig_str) + 1;\n \n-\tXSTR (sym_ref, 0) = ggc_alloc_string (str, newlen);\n-      }\n+  if (orig_str[0] == '!')\n+    {\n+      /* Already encoded; see if we need to change it.  */\n+      if (code == orig_str[1])\n+\treturn;\n+      /* Yes, tweak a copy of the name and put it in a new string.  */\n+      new_str = alloca (len);\n+      memcpy (new_str, orig_str, len);\n+      new_str[1] = code;\n+      XSTR (sym_ref, 0) = ggc_alloc_string (new_str, len);\n+      /* The non-lazy pointer list may have captured references to the\n+\t old encoded name, change them.  */\n+      update_non_lazy_ptrs (XSTR (sym_ref, 0));\n+    }\n+  else\n+    {\n+      /* Add the encoding.  */\n+      new_len = len + 4;\n+      new_str = alloca (new_len);\n+      new_str[0] = '!';\n+      new_str[1] = code;\n+      new_str[2] = '_';\n+      new_str[3] = '_';\n+      memcpy (new_str + 4, orig_str, len);\n+      XSTR (sym_ref, 0) = ggc_alloc_string (new_str, new_len);\n     }\n }\n "}]}