{"sha": "946069f506afba2ac03b00ad8244f1f42e0c03f1", "node_id": "C_kwDOANBUbNoAKDk0NjA2OWY1MDZhZmJhMmFjMDNiMDBhZDgyNDRmMWY0MmUwYzAzZjE", "commit": {"author": {"name": "David Faust", "email": "david.faust@oracle.com", "date": "2021-12-13T21:20:02Z"}, "committer": {"name": "David Faust", "email": "david.faust@oracle.com", "date": "2021-12-13T22:45:44Z"}, "message": "Get rid of lambdas within AST::TupleStruct\n\nThese constructs make working with the IR needlessly complicated for\nstatic analysis. Replace with simple for loops, and delete the old\nTupleStruct::iterate () method.\n\nFixes: #715", "tree": {"sha": "0abcb908640348e6128499e0ad99715c12258f93", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0abcb908640348e6128499e0ad99715c12258f93"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/946069f506afba2ac03b00ad8244f1f42e0c03f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/946069f506afba2ac03b00ad8244f1f42e0c03f1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/946069f506afba2ac03b00ad8244f1f42e0c03f1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/946069f506afba2ac03b00ad8244f1f42e0c03f1/comments", "author": {"login": "dafaust", "id": 4460334, "node_id": "MDQ6VXNlcjQ0NjAzMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4460334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dafaust", "html_url": "https://github.com/dafaust", "followers_url": "https://api.github.com/users/dafaust/followers", "following_url": "https://api.github.com/users/dafaust/following{/other_user}", "gists_url": "https://api.github.com/users/dafaust/gists{/gist_id}", "starred_url": "https://api.github.com/users/dafaust/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dafaust/subscriptions", "organizations_url": "https://api.github.com/users/dafaust/orgs", "repos_url": "https://api.github.com/users/dafaust/repos", "events_url": "https://api.github.com/users/dafaust/events{/privacy}", "received_events_url": "https://api.github.com/users/dafaust/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dafaust", "id": 4460334, "node_id": "MDQ6VXNlcjQ0NjAzMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4460334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dafaust", "html_url": "https://github.com/dafaust", "followers_url": "https://api.github.com/users/dafaust/followers", "following_url": "https://api.github.com/users/dafaust/following{/other_user}", "gists_url": "https://api.github.com/users/dafaust/gists{/gist_id}", "starred_url": "https://api.github.com/users/dafaust/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dafaust/subscriptions", "organizations_url": "https://api.github.com/users/dafaust/orgs", "repos_url": "https://api.github.com/users/dafaust/repos", "events_url": "https://api.github.com/users/dafaust/events{/privacy}", "received_events_url": "https://api.github.com/users/dafaust/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e43a784dc89030941b0cc43309541970c59a723c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e43a784dc89030941b0cc43309541970c59a723c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e43a784dc89030941b0cc43309541970c59a723c"}], "stats": {"total": 85, "additions": 36, "deletions": 49}, "files": [{"sha": "e319d743794f7ca6ce4a8cd705dc9b4890f27446", "filename": "gcc/rust/ast/rust-item.h", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fast%2Frust-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fast%2Frust-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-item.h?ref=946069f506afba2ac03b00ad8244f1f42e0c03f1", "patch": "@@ -2110,15 +2110,6 @@ class TupleStruct : public Struct\n   std::vector<TupleField> &get_fields () { return fields; }\n   const std::vector<TupleField> &get_fields () const { return fields; }\n \n-  void iterate (std::function<bool (TupleField &)> cb)\n-  {\n-    for (auto &field : fields)\n-      {\n-\tif (!cb (field))\n-\t  return;\n-      }\n-  }\n-\n protected:\n   /* Use covariance to implement clone function as returning this object\n    * rather than base */"}, {"sha": "d4c0306f34333ce75374b453cf1cc51bf07dee20", "filename": "gcc/rust/hir/rust-ast-lower-item.h", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h?ref=946069f506afba2ac03b00ad8244f1f42e0c03f1", "patch": "@@ -154,24 +154,24 @@ class ASTLoweringItem : public ASTLoweringBase\n     HIR::Visibility vis = HIR::Visibility::create_public ();\n \n     std::vector<HIR::TupleField> fields;\n-    struct_decl.iterate ([&] (AST::TupleField &field) mutable -> bool {\n-      HIR::Visibility vis = HIR::Visibility::create_public ();\n-      HIR::Type *type\n-\t= ASTLoweringType::translate (field.get_field_type ().get ());\n-\n-      auto crate_num = mappings->get_current_crate ();\n-      Analysis::NodeMapping mapping (crate_num, field.get_node_id (),\n-\t\t\t\t     mappings->get_next_hir_id (crate_num),\n-\t\t\t\t     mappings->get_next_localdef_id (\n-\t\t\t\t       crate_num));\n+    for (AST::TupleField &field : struct_decl.get_fields ())\n+      {\n+\tHIR::Visibility vis = HIR::Visibility::create_public ();\n+\tHIR::Type *type\n+\t  = ASTLoweringType::translate (field.get_field_type ().get ());\n \n-      HIR::TupleField translated_field (mapping,\n-\t\t\t\t\tstd::unique_ptr<HIR::Type> (type), vis,\n-\t\t\t\t\tfield.get_locus (),\n-\t\t\t\t\tfield.get_outer_attrs ());\n-      fields.push_back (std::move (translated_field));\n-      return true;\n-    });\n+\tauto crate_num = mappings->get_current_crate ();\n+\tAnalysis::NodeMapping mapping (crate_num, field.get_node_id (),\n+\t\t\t\t       mappings->get_next_hir_id (crate_num),\n+\t\t\t\t       mappings->get_next_localdef_id (\n+\t\t\t\t\t crate_num));\n+\n+\tHIR::TupleField translated_field (mapping,\n+\t\t\t\t\t  std::unique_ptr<HIR::Type> (type),\n+\t\t\t\t\t  vis, field.get_locus (),\n+\t\t\t\t\t  field.get_outer_attrs ());\n+\tfields.push_back (std::move (translated_field));\n+      }\n \n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, struct_decl.get_node_id (),"}, {"sha": "b617991d9281729300b37b6db73ad4c9d374c47c", "filename": "gcc/rust/hir/rust-ast-lower-stmt.h", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fhir%2Frust-ast-lower-stmt.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fhir%2Frust-ast-lower-stmt.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-stmt.h?ref=946069f506afba2ac03b00ad8244f1f42e0c03f1", "patch": "@@ -151,24 +151,24 @@ class ASTLoweringStmt : public ASTLoweringBase\n     HIR::Visibility vis = HIR::Visibility::create_public ();\n \n     std::vector<HIR::TupleField> fields;\n-    struct_decl.iterate ([&] (AST::TupleField &field) mutable -> bool {\n-      HIR::Visibility vis = HIR::Visibility::create_public ();\n-      HIR::Type *type\n-\t= ASTLoweringType::translate (field.get_field_type ().get ());\n-\n-      auto crate_num = mappings->get_current_crate ();\n-      Analysis::NodeMapping mapping (crate_num, field.get_node_id (),\n-\t\t\t\t     mappings->get_next_hir_id (crate_num),\n-\t\t\t\t     mappings->get_next_localdef_id (\n-\t\t\t\t       crate_num));\n+    for (AST::TupleField &field : struct_decl.get_fields ())\n+      {\n+\tHIR::Visibility vis = HIR::Visibility::create_public ();\n+\tHIR::Type *type\n+\t  = ASTLoweringType::translate (field.get_field_type ().get ());\n \n-      HIR::TupleField translated_field (mapping,\n-\t\t\t\t\tstd::unique_ptr<HIR::Type> (type), vis,\n-\t\t\t\t\tfield.get_locus (),\n-\t\t\t\t\tfield.get_outer_attrs ());\n-      fields.push_back (std::move (translated_field));\n-      return true;\n-    });\n+\tauto crate_num = mappings->get_current_crate ();\n+\tAnalysis::NodeMapping mapping (crate_num, field.get_node_id (),\n+\t\t\t\t       mappings->get_next_hir_id (crate_num),\n+\t\t\t\t       mappings->get_next_localdef_id (\n+\t\t\t\t\t crate_num));\n+\n+\tHIR::TupleField translated_field (mapping,\n+\t\t\t\t\t  std::unique_ptr<HIR::Type> (type),\n+\t\t\t\t\t  vis, field.get_locus (),\n+\t\t\t\t\t  field.get_outer_attrs ());\n+\tfields.push_back (std::move (translated_field));\n+      }\n \n     auto crate_num = mappings->get_current_crate ();\n     Analysis::NodeMapping mapping (crate_num, struct_decl.get_node_id (),"}, {"sha": "e697f1c53b4cb078fcbb5fc956b7795036ff765e", "filename": "gcc/rust/resolve/rust-ast-resolve-item.h", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.h?ref=946069f506afba2ac03b00ad8244f1f42e0c03f1", "patch": "@@ -245,11 +245,9 @@ class ResolveItem : public ResolverBase\n     if (struct_decl.has_where_clause ())\n       ResolveWhereClause::Resolve (struct_decl.get_where_clause ());\n \n-    struct_decl.iterate ([&] (AST::TupleField &field) mutable -> bool {\n+    for (AST::TupleField &field : struct_decl.get_fields ())\n       ResolveType::go (field.get_field_type ().get (),\n \t\t       struct_decl.get_node_id ());\n-      return true;\n-    });\n \n     resolver->get_type_scope ().pop ();\n   }"}, {"sha": "a40436564411c60fa171e224be73a71d0201aea9", "filename": "gcc/rust/resolve/rust-ast-resolve-stmt.h", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fresolve%2Frust-ast-resolve-stmt.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/946069f506afba2ac03b00ad8244f1f42e0c03f1/gcc%2Frust%2Fresolve%2Frust-ast-resolve-stmt.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-ast-resolve-stmt.h?ref=946069f506afba2ac03b00ad8244f1f42e0c03f1", "patch": "@@ -115,11 +115,9 @@ class ResolveStmt : public ResolverBase\n \t  }\n       }\n \n-    struct_decl.iterate ([&] (AST::TupleField &field) mutable -> bool {\n+    for (AST::TupleField &field : struct_decl.get_fields ())\n       ResolveType::go (field.get_field_type ().get (),\n \t\t       struct_decl.get_node_id ());\n-      return true;\n-    });\n \n     resolver->get_type_scope ().pop ();\n   }"}]}