{"sha": "98af369b9489b0e8080d603239ef441051529dce", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OThhZjM2OWI5NDg5YjBlODA4MGQ2MDMyMzllZjQ0MTA1MTUyOWRjZQ==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@adacore.com", "date": "2020-05-29T08:41:00Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-07-10T09:16:22Z"}, "message": "[Ada] Preserve casing of output files\n\ngcc/ada/\n\n\t* osint-c.adb (Set_File_Name): Preserve casing of file.\n\t* osint.adb (File_Names_Equal): New.\n\t(Executable_Name): Use File_Equal instead of\n\tCanonical_Case_File_Name.", "tree": {"sha": "2377dcc44b5eb573b8ae3807845030c39b9e9a79", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2377dcc44b5eb573b8ae3807845030c39b9e9a79"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/98af369b9489b0e8080d603239ef441051529dce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/98af369b9489b0e8080d603239ef441051529dce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/98af369b9489b0e8080d603239ef441051529dce", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/98af369b9489b0e8080d603239ef441051529dce/comments", "author": {"login": "ArnaudCharlet", "id": 30291825, "node_id": "MDQ6VXNlcjMwMjkxODI1", "avatar_url": "https://avatars.githubusercontent.com/u/30291825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ArnaudCharlet", "html_url": "https://github.com/ArnaudCharlet", "followers_url": "https://api.github.com/users/ArnaudCharlet/followers", "following_url": "https://api.github.com/users/ArnaudCharlet/following{/other_user}", "gists_url": "https://api.github.com/users/ArnaudCharlet/gists{/gist_id}", "starred_url": "https://api.github.com/users/ArnaudCharlet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ArnaudCharlet/subscriptions", "organizations_url": "https://api.github.com/users/ArnaudCharlet/orgs", "repos_url": "https://api.github.com/users/ArnaudCharlet/repos", "events_url": "https://api.github.com/users/ArnaudCharlet/events{/privacy}", "received_events_url": "https://api.github.com/users/ArnaudCharlet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "002f8329d208e3c3f032bf2ce914a70cfe02ef9f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/002f8329d208e3c3f032bf2ce914a70cfe02ef9f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/002f8329d208e3c3f032bf2ce914a70cfe02ef9f"}], "stats": {"total": 92, "additions": 51, "deletions": 41}, "files": [{"sha": "0010a8deec18ebf413c66247777a9b1700e165b0", "filename": "gcc/ada/osint-c.adb", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/98af369b9489b0e8080d603239ef441051529dce/gcc%2Fada%2Fosint-c.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/98af369b9489b0e8080d603239ef441051529dce/gcc%2Fada%2Fosint-c.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint-c.adb?ref=98af369b9489b0e8080d603239ef441051529dce", "patch": "@@ -412,22 +412,23 @@ package body Osint.C is\n          --  Remove extension preparing to replace it\n \n          declare\n-            Name  : String  := Name_Buffer (1 .. Dot_Index);\n-            First : Positive;\n+            Name   : String  := Name_Buffer (1 .. Dot_Index);\n+            Output : String  := Output_Object_File_Name.all;\n+            First  : Positive;\n \n          begin\n-            Name_Buffer (1 .. Output_Object_File_Name'Length) :=\n-              Output_Object_File_Name.all;\n+            Name_Buffer (1 .. Output_Object_File_Name'Length) := Output;\n \n             --  Put two names in canonical case, to allow object file names\n             --  with upper-case letters on Windows.\n+            --  Do it with a copy (Output) and keep Name_Buffer as is since we\n+            --  want to preserve the original casing.\n \n             Canonical_Case_File_Name (Name);\n-            Canonical_Case_File_Name\n-              (Name_Buffer (1 .. Output_Object_File_Name'Length));\n+            Canonical_Case_File_Name (Output);\n \n             Dot_Index := 0;\n-            for J in reverse Output_Object_File_Name'Range loop\n+            for J in reverse Output'Range loop\n                if Name_Buffer (J) = '.' then\n                   Dot_Index := J;\n                   exit;\n@@ -451,7 +452,7 @@ package body Osint.C is\n \n             --  Check name of object file is what we expect\n \n-            if Name /= Name_Buffer (First .. Dot_Index) then\n+            if Name /= Output (First .. Dot_Index) then\n                Fail (\"incorrect object file name\");\n             end if;\n          end;"}, {"sha": "3ae76cf9a5a0f6c72ccdcf9120f3bc2a3a1b7353", "filename": "gcc/ada/osint.adb", "status": "modified", "additions": 42, "deletions": 33, "changes": 75, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/98af369b9489b0e8080d603239ef441051529dce/gcc%2Fada%2Fosint.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/98af369b9489b0e8080d603239ef441051529dce/gcc%2Fada%2Fosint.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.adb?ref=98af369b9489b0e8080d603239ef441051529dce", "patch": "@@ -100,6 +100,10 @@ package body Osint is\n    --  executable is stored in directory \"/foo/bar/bin\", this routine returns\n    --  \"/foo/bar/\". Return \"\" if location is not recognized as described above.\n \n+   function File_Names_Equal (File1, File2 : String) return Boolean;\n+   --  Compare File1 and File2 taking into account the case insensitivity\n+   --  of the OS.\n+\n    function Update_Path (Path : String_Ptr) return String_Ptr;\n    --  Update the specified path to replace the prefix with the location where\n    --  GNAT is installed. See the file prefix.c in GCC for details.\n@@ -852,30 +856,22 @@ package body Osint is\n          end if;\n \n          if Add_Suffix then\n-            declare\n-               Buffer : String := Name_Buffer (1 .. Name_Len);\n-\n-            begin\n-               --  Get the file name in canonical case to accept as is. Names\n-               --  end with \".EXE\" on Windows.\n-\n-               Canonical_Case_File_Name (Buffer);\n-\n-               --  If Executable doesn't end with the executable suffix, add it\n-\n-               if Buffer'Length <= Exec_Suffix'Length\n-                 or else\n-                   Buffer (Buffer'Last - Exec_Suffix'Length + 1 .. Buffer'Last)\n-                     /= Exec_Suffix.all\n-               then\n-                  Name_Buffer\n-                    (Name_Len + 1 .. Name_Len + Exec_Suffix'Length) :=\n-                      Exec_Suffix.all;\n-                  Name_Len := Name_Len + Exec_Suffix'Length;\n-                  Free (Exec_Suffix);\n-                  return Name_Find;\n-               end if;\n-            end;\n+            --  If Executable doesn't end with the executable suffix, add it\n+\n+            if Name_Len <= Exec_Suffix'Length\n+              or else not\n+                File_Names_Equal\n+                  (Name_Buffer\n+                    (Name_Len - Exec_Suffix'Length + 1 .. Name_Len),\n+                   Exec_Suffix.all)\n+            then\n+               Name_Buffer\n+                 (Name_Len + 1 .. Name_Len + Exec_Suffix'Length) :=\n+                   Exec_Suffix.all;\n+               Name_Len := Name_Len + Exec_Suffix'Length;\n+               Free (Exec_Suffix);\n+               return Name_Find;\n+            end if;\n          end if;\n       end if;\n \n@@ -889,7 +885,6 @@ package body Osint is\n    is\n       Exec_Suffix    : String_Access;\n       Add_Suffix     : Boolean;\n-      Canonical_Name : String := Name;\n \n    begin\n       if Executable_Extension_On_Target = No_Name then\n@@ -909,25 +904,26 @@ package body Osint is\n \n          begin\n             Free (Exec_Suffix);\n-            Canonical_Case_File_Name (Canonical_Name);\n-\n             Add_Suffix := True;\n+\n             if Only_If_No_Suffix then\n-               for J in reverse Canonical_Name'Range loop\n-                  if Canonical_Name (J) = '.' then\n+               for J in reverse Name'Range loop\n+                  if Name (J) = '.' then\n                      Add_Suffix := False;\n                      exit;\n \n-                  elsif Is_Directory_Separator (Canonical_Name (J)) then\n+                  elsif Is_Directory_Separator (Name (J)) then\n                      exit;\n                   end if;\n                end loop;\n             end if;\n \n             if Add_Suffix and then\n-              (Canonical_Name'Length <= Suffix'Length\n-               or else Canonical_Name (Canonical_Name'Last - Suffix'Length + 1\n-                                       .. Canonical_Name'Last) /= Suffix)\n+              (Name'Length <= Suffix'Length\n+               or else not\n+                 File_Names_Equal\n+                   (Name (Name'Last - Suffix'Length + 1 .. Name'Last),\n+                    Suffix))\n             then\n                declare\n                   Result : String (1 .. Name'Length + Suffix'Length);\n@@ -1057,6 +1053,19 @@ package body Osint is\n       Exit_Program (E_Fatal);\n    end Fail;\n \n+   ----------------------\n+   -- File_Names_Equal --\n+   ----------------------\n+\n+   function File_Names_Equal (File1, File2 : String) return Boolean is\n+   begin\n+      if File_Names_Case_Sensitive then\n+         return File1 = File2;\n+      else\n+         return To_Lower (File1) = To_Lower (File2);\n+      end if;\n+   end File_Names_Equal;\n+\n    ---------------\n    -- File_Hash --\n    ---------------"}]}