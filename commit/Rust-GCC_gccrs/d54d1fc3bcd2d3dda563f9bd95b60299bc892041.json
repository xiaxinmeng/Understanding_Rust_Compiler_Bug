{"sha": "d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDU0ZDFmYzNiY2QyZDNkZGE1NjNmOWJkOTViNjAyOTliYzg5MjA0MQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-06-21T10:58:00Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-06-21T10:58:00Z"}, "message": "re PR c++/81130 (ICE OpenMP shared clause in gimplify_var_or_parm_decl, at gimplify.c:2584)\n\n\tPR c++/81130\n\t* gimplify.c (omp_add_variable): Don't force GOVD_SEEN for types\n\twith ctors/dtors if GOVD_SHARED is set.\n\n\t* testsuite/libgomp.c++/pr81130.C: New test.\n\nFrom-SVN: r249445", "tree": {"sha": "a1bba68984c40a32b45cc159beb1301d2f80d6f7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a1bba68984c40a32b45cc159beb1301d2f80d6f7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "9fe9816bcd72e5ae5fe374d7483e4b5b0c618b22", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9fe9816bcd72e5ae5fe374d7483e4b5b0c618b22", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9fe9816bcd72e5ae5fe374d7483e4b5b0c618b22"}], "stats": {"total": 60, "additions": 57, "deletions": 3}, "files": [{"sha": "a40820ba10e0b799bf35fe5f96c0404d50b06952", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "patch": "@@ -1,3 +1,9 @@\n+2017-06-21  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c++/81130\n+\t* gimplify.c (omp_add_variable): Don't force GOVD_SEEN for types\n+\twith ctors/dtors if GOVD_SHARED is set.\n+\n 2017-06-21  Wilco Dijkstra  <wdijkstr@arm.com>\n \n \t* config/aarch64/aarch64.md (movti_aarch64):"}, {"sha": "13760c0f20a6de677f7a771d0d5784e824ad1027", "filename": "gcc/gimplify.c", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "patch": "@@ -6634,9 +6634,11 @@ omp_add_variable (struct gimplify_omp_ctx *ctx, tree decl, unsigned int flags)\n     return;\n \n   /* Never elide decls whose type has TREE_ADDRESSABLE set.  This means\n-     there are constructors involved somewhere.  */\n-  if (TREE_ADDRESSABLE (TREE_TYPE (decl))\n-      || TYPE_NEEDS_CONSTRUCTING (TREE_TYPE (decl)))\n+     there are constructors involved somewhere.  Exception is a shared clause,\n+     there is nothing privatized in that case.  */\n+  if ((flags & GOVD_SHARED) == 0\n+      && (TREE_ADDRESSABLE (TREE_TYPE (decl))\n+\t  || TYPE_NEEDS_CONSTRUCTING (TREE_TYPE (decl))))\n     flags |= GOVD_SEEN;\n \n   n = splay_tree_lookup (ctx->variables, (splay_tree_key)decl);"}, {"sha": "da9946fed949d06b8037ad3a54607f1af3cd5ee1", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "patch": "@@ -1,3 +1,8 @@\n+2017-06-21  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c++/81130\n+\t* testsuite/libgomp.c++/pr81130.C: New test.\n+\n 2017-06-17  Rainer Orth  <ro@CeBiTec.Uni-Bielefeld.DE>\n \n \t* testsuite/libgomp.fortran/strassen.f90: Remove dg-skip-if"}, {"sha": "f2cb571294d4c8ebacf9c93257cfe12412e97f4b", "filename": "libgomp/testsuite/libgomp.c++/pr81130.C", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/libgomp%2Ftestsuite%2Flibgomp.c%2B%2B%2Fpr81130.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d54d1fc3bcd2d3dda563f9bd95b60299bc892041/libgomp%2Ftestsuite%2Flibgomp.c%2B%2B%2Fpr81130.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2B%2B%2Fpr81130.C?ref=d54d1fc3bcd2d3dda563f9bd95b60299bc892041", "patch": "@@ -0,0 +1,41 @@\n+// PR c++/81130\n+// { dg-do run }\n+\n+struct A\n+{\n+  A ();\n+  ~A ();\n+  int a;\n+};\n+\n+A::A ()\n+{\n+  a = 0;\n+}\n+\n+A::~A ()\n+{\n+}\n+\n+struct B\n+{\n+  A b;\n+  int c;\n+  B () : c (1)\n+  {\n+#pragma omp parallel shared (b, c) num_threads (2)\n+#pragma omp master\n+    {\n+      b.a++;\n+      c += 2;\n+    }\n+  }\n+};\n+\n+int\n+main ()\n+{\n+  B v;\n+  if (v.b.a != 1 || v.c != 3)\n+    __builtin_abort ();\n+}"}]}