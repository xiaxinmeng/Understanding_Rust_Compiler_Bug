{"sha": "125db6a1c6aca542c14b326facdcaf9a1fca8b52", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTI1ZGI2YTFjNmFjYTU0MmMxNGIzMjZmYWNkY2FmOWExZmNhOGI1Mg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2017-04-11T21:07:32Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2017-04-11T21:07:32Z"}, "message": "PR c++/80294 - ICE with constexpr and inheritance.\n\n\t* constexpr.c (reduced_constant_expression_p):\n\tA null constructor element is non-constant.\n\t(cxx_eval_indirect_ref): Don't VERIFY_CONSTANT before\n\treturning an empty base.\n\nFrom-SVN: r246858", "tree": {"sha": "737c35ff0e78500dbf67f19bb9e11d828257f0c7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/737c35ff0e78500dbf67f19bb9e11d828257f0c7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/125db6a1c6aca542c14b326facdcaf9a1fca8b52", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/125db6a1c6aca542c14b326facdcaf9a1fca8b52", "html_url": "https://github.com/Rust-GCC/gccrs/commit/125db6a1c6aca542c14b326facdcaf9a1fca8b52", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/125db6a1c6aca542c14b326facdcaf9a1fca8b52/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "347e1f77696d8d69db2c9e66bba6e48662de8343", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/347e1f77696d8d69db2c9e66bba6e48662de8343", "html_url": "https://github.com/Rust-GCC/gccrs/commit/347e1f77696d8d69db2c9e66bba6e48662de8343"}], "stats": {"total": 35, "additions": 30, "deletions": 5}, "files": [{"sha": "80247bf684518b8ac265462cdd7e255b22006409", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/125db6a1c6aca542c14b326facdcaf9a1fca8b52/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/125db6a1c6aca542c14b326facdcaf9a1fca8b52/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=125db6a1c6aca542c14b326facdcaf9a1fca8b52", "patch": "@@ -1,3 +1,11 @@\n+2017-04-11  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/80294 - ICE with constexpr and inheritance.\n+\t* constexpr.c (reduced_constant_expression_p):\n+\tA null constructor element is non-constant.\n+\t(cxx_eval_indirect_ref): Don't VERIFY_CONSTANT before\n+\treturning an empty base.\n+\n 2017-04-11  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/80370"}, {"sha": "9dde4a4122a68134643b418da30d8317190aafae", "filename": "gcc/cp/constexpr.c", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/125db6a1c6aca542c14b326facdcaf9a1fca8b52/gcc%2Fcp%2Fconstexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/125db6a1c6aca542c14b326facdcaf9a1fca8b52/gcc%2Fcp%2Fconstexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fconstexpr.c?ref=125db6a1c6aca542c14b326facdcaf9a1fca8b52", "patch": "@@ -1716,8 +1716,13 @@ reduced_constant_expression_p (tree t)\n       /* And we need to handle PTRMEM_CST wrapped in a CONSTRUCTOR.  */\n       tree elt; unsigned HOST_WIDE_INT idx;\n       FOR_EACH_CONSTRUCTOR_VALUE (CONSTRUCTOR_ELTS (t), idx, elt)\n-\tif (!reduced_constant_expression_p (elt))\n-\t  return false;\n+\t{\n+\t  if (!elt)\n+\t    /* We're in the middle of initializing this element.  */\n+\t    return false;\n+\t  if (!reduced_constant_expression_p (elt))\n+\t    return false;\n+\t}\n       return true;\n \n     default:\n@@ -3153,12 +3158,10 @@ cxx_eval_indirect_ref (const constexpr_ctx *ctx, tree t,\n   if (*non_constant_p)\n     return t;\n \n-  /* If we're pulling out the value of an empty base, make sure\n-     that the whole object is constant and then return an empty\n+  /* If we're pulling out the value of an empty base, just return an empty\n      CONSTRUCTOR.  */\n   if (empty_base && !lval)\n     {\n-      VERIFY_CONSTANT (r);\n       r = build_constructor (TREE_TYPE (t), NULL);\n       TREE_CONSTANT (r) = true;\n     }"}, {"sha": "37e4a53a7a9b220ed2e92f2b249f8cdcce0390ea", "filename": "gcc/testsuite/g++.dg/cpp1y/constexpr-empty3.C", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/125db6a1c6aca542c14b326facdcaf9a1fca8b52/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fconstexpr-empty3.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/125db6a1c6aca542c14b326facdcaf9a1fca8b52/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fconstexpr-empty3.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fconstexpr-empty3.C?ref=125db6a1c6aca542c14b326facdcaf9a1fca8b52", "patch": "@@ -0,0 +1,14 @@\n+// PR c++/80294\n+// { dg-do compile { target c++14 } }\n+// { dg-final { scan-assembler-not \"static_init\" } }\n+\n+struct A {\n+  constexpr int f() { A a = *this; return 42; }\n+};\n+struct B: A\n+{\n+  int i;\n+  constexpr B(): i(f()) {}\n+};\n+\n+B b;"}]}