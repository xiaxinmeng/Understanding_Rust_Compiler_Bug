{"sha": "87121696fb2ddbec5f33daa359234850f7fd306d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODcxMjE2OTZmYjJkZGJlYzVmMzNkYWEzNTkyMzQ4NTBmN2ZkMzA2ZA==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2019-10-22T08:43:01Z"}, "committer": {"name": "Richard Sandiford", "email": "rsandifo@gcc.gnu.org", "date": "2019-10-22T08:43:01Z"}, "message": "Fix use after free in vector_size change\n\nr277235 was a bit too mechanical and ended up introducing use\nafter free bugs in both loop and SLP vectorisation.\n\n2019-10-22  Richard Sandiford  <richard.sandiford@arm.com>\n\ngcc/\n\t* tree-vect-slp.c (vect_slp_bb_region): Check whether\n\tautodetected_vector_size rather than vector_size is zero.\n\t* tree-vect-loop.c (vect_analyze_loop): Likewise.\n\tSet autodetected_vector_size immediately after calling\n\tvect_analyze_loop_2.  Check for a fatal error before advancing\n\tnext_size.\n\nFrom-SVN: r277282", "tree": {"sha": "cc0355da7614212e8c7c186339e97cd127f5ba87", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cc0355da7614212e8c7c186339e97cd127f5ba87"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/87121696fb2ddbec5f33daa359234850f7fd306d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87121696fb2ddbec5f33daa359234850f7fd306d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/87121696fb2ddbec5f33daa359234850f7fd306d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87121696fb2ddbec5f33daa359234850f7fd306d/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "10bce48f104de56503b17954ed79f019df3252e3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/10bce48f104de56503b17954ed79f019df3252e3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/10bce48f104de56503b17954ed79f019df3252e3"}], "stats": {"total": 27, "additions": 18, "deletions": 9}, "files": [{"sha": "65baf0c21643e99f5f077b80a439b81f357ed240", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87121696fb2ddbec5f33daa359234850f7fd306d/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87121696fb2ddbec5f33daa359234850f7fd306d/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=87121696fb2ddbec5f33daa359234850f7fd306d", "patch": "@@ -1,3 +1,12 @@\n+2019-10-22  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\t* tree-vect-slp.c (vect_slp_bb_region): Check whether\n+\tautodetected_vector_size rather than vector_size is zero.\n+\t* tree-vect-loop.c (vect_analyze_loop): Likewise.\n+\tSet autodetected_vector_size immediately after calling\n+\tvect_analyze_loop_2.  Check for a fatal error before advancing\n+\tnext_size.\n+\n 2019-10-21  Jason Merrill  <jason@redhat.com>\n \n \t* lock-and-run.sh: Check for process existence rather than timeout."}, {"sha": "07ddc2ecb3e7b4a90ff6d20831245f57e23ff49f", "filename": "gcc/tree-vect-loop.c", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87121696fb2ddbec5f33daa359234850f7fd306d/gcc%2Ftree-vect-loop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87121696fb2ddbec5f33daa359234850f7fd306d/gcc%2Ftree-vect-loop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-loop.c?ref=87121696fb2ddbec5f33daa359234850f7fd306d", "patch": "@@ -2365,6 +2365,9 @@ vect_analyze_loop (class loop *loop, loop_vec_info orig_loop_vinfo,\n \tLOOP_VINFO_ORIG_LOOP_INFO (loop_vinfo) = orig_loop_vinfo;\n \n       opt_result res = vect_analyze_loop_2 (loop_vinfo, fatal, &n_stmts);\n+      if (next_size == 0)\n+\tautodetected_vector_size = loop_vinfo->vector_size;\n+\n       if (res)\n \t{\n \t  LOOP_VINFO_VECTORIZABLE_P (loop_vinfo) = 1;\n@@ -2390,21 +2393,18 @@ vect_analyze_loop (class loop *loop, loop_vec_info orig_loop_vinfo,\n       else\n \tdelete loop_vinfo;\n \n-      if (next_size == 0)\n-\tautodetected_vector_size = loop_vinfo->vector_size;\n-\n-      if (next_size < vector_sizes.length ()\n-\t  && known_eq (vector_sizes[next_size], autodetected_vector_size))\n-\tnext_size += 1;\n-\n       if (fatal)\n \t{\n \t  gcc_checking_assert (first_loop_vinfo == NULL);\n \t  return opt_loop_vec_info::propagate_failure (res);\n \t}\n \n+      if (next_size < vector_sizes.length ()\n+\t  && known_eq (vector_sizes[next_size], autodetected_vector_size))\n+\tnext_size += 1;\n+\n       if (next_size == vector_sizes.length ()\n-\t  || known_eq (loop_vinfo->vector_size, 0U))\n+\t  || known_eq (autodetected_vector_size, 0U))\n \t{\n \t  if (first_loop_vinfo)\n \t    {"}, {"sha": "20ea1059a2d1ae177795ede8870ba64017749e44", "filename": "gcc/tree-vect-slp.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87121696fb2ddbec5f33daa359234850f7fd306d/gcc%2Ftree-vect-slp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87121696fb2ddbec5f33daa359234850f7fd306d/gcc%2Ftree-vect-slp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-slp.c?ref=87121696fb2ddbec5f33daa359234850f7fd306d", "patch": "@@ -3102,7 +3102,7 @@ vect_slp_bb_region (gimple_stmt_iterator region_begin,\n \n       if (vectorized\n \t  || next_size == vector_sizes.length ()\n-\t  || known_eq (bb_vinfo->vector_size, 0U)\n+\t  || known_eq (autodetected_vector_size, 0U)\n \t  /* If vect_slp_analyze_bb_1 signaled that analysis for all\n \t     vector sizes will fail do not bother iterating.  */\n \t  || fatal)"}]}