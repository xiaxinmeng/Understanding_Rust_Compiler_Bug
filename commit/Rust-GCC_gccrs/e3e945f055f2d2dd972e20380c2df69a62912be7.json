{"sha": "e3e945f055f2d2dd972e20380c2df69a62912be7", "node_id": "C_kwDOANBUbNoAKGUzZTk0NWYwNTVmMmQyZGQ5NzJlMjAzODBjMmRmNjlhNjI5MTJiZTc", "commit": {"author": {"name": "Dave Evans", "email": "dave@dmetwo.org", "date": "2023-06-09T00:18:42Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2023-06-13T08:16:21Z"}, "message": "Fix ICE for reference patterns in match statements\n\ngcc/rust/ChangeLog:\n\n\t* backend/rust-compile-expr.cc (check_match_scrutinee): Add REF type to rust_assert.\n\t(CompileExpr::visit): Add REF type for scrutinee_kind in MatchExpr visitor.\n\ngcc/testsuite/ChangeLog:\n\n\t* rust/compile/issue-1813.rs: New test.\n\nSigned-off-by: Dave Evans <dave@dmetwo.org>", "tree": {"sha": "f80a19cb9c2825edb90124d2aceb44eeabc0d8f6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f80a19cb9c2825edb90124d2aceb44eeabc0d8f6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e3e945f055f2d2dd972e20380c2df69a62912be7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e3e945f055f2d2dd972e20380c2df69a62912be7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e3e945f055f2d2dd972e20380c2df69a62912be7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e3e945f055f2d2dd972e20380c2df69a62912be7/comments", "author": {"login": "dme2", "id": 22139936, "node_id": "MDQ6VXNlcjIyMTM5OTM2", "avatar_url": "https://avatars.githubusercontent.com/u/22139936?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dme2", "html_url": "https://github.com/dme2", "followers_url": "https://api.github.com/users/dme2/followers", "following_url": "https://api.github.com/users/dme2/following{/other_user}", "gists_url": "https://api.github.com/users/dme2/gists{/gist_id}", "starred_url": "https://api.github.com/users/dme2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dme2/subscriptions", "organizations_url": "https://api.github.com/users/dme2/orgs", "repos_url": "https://api.github.com/users/dme2/repos", "events_url": "https://api.github.com/users/dme2/events{/privacy}", "received_events_url": "https://api.github.com/users/dme2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "533e1ef3ca481b03b68b3e7c6bcc7ce0d14131bb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/533e1ef3ca481b03b68b3e7c6bcc7ce0d14131bb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/533e1ef3ca481b03b68b3e7c6bcc7ce0d14131bb"}], "stats": {"total": 18, "additions": 17, "deletions": 1}, "files": [{"sha": "7b8182f073d6a7053ddc6348ce63b4679b6cf3f5", "filename": "gcc/rust/backend/rust-compile-expr.cc", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e3e945f055f2d2dd972e20380c2df69a62912be7/gcc%2Frust%2Fbackend%2Frust-compile-expr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e3e945f055f2d2dd972e20380c2df69a62912be7/gcc%2Frust%2Fbackend%2Frust-compile-expr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-expr.cc?ref=e3e945f055f2d2dd972e20380c2df69a62912be7", "patch": "@@ -1274,7 +1274,8 @@ check_match_scrutinee (HIR::MatchExpr &expr, Context *ctx)\n   rust_assert ((TyTy::is_primitive_type_kind (scrutinee_kind)\n \t\t&& scrutinee_kind != TyTy::TypeKind::NEVER)\n \t       || scrutinee_kind == TyTy::TypeKind::ADT\n-\t       || scrutinee_kind == TyTy::TypeKind::TUPLE);\n+\t       || scrutinee_kind == TyTy::TypeKind::TUPLE\n+\t       || scrutinee_kind == TyTy::TypeKind::REF);\n \n   if (scrutinee_kind == TyTy::TypeKind::ADT)\n     {\n@@ -1362,6 +1363,12 @@ CompileExpr::visit (HIR::MatchExpr &expr)\n \t  scrutinee_first_record_expr, 0,\n \t  expr.get_scrutinee_expr ()->get_locus ());\n     }\n+  else if (scrutinee_kind == TyTy::TypeKind::REF)\n+    {\n+      tree indirect\n+\t= indirect_expression (match_scrutinee_expr, expr.get_locus ());\n+      match_scrutinee_expr_qualifier_expr = indirect;\n+    }\n   else if (scrutinee_kind == TyTy::TypeKind::TUPLE)\n     {\n       // match on tuple becomes a series of nested switches, with one level"}, {"sha": "6d35d45b170be04c89a9b0246034bdae9a07f007", "filename": "gcc/testsuite/rust/compile/issue-1813.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e3e945f055f2d2dd972e20380c2df69a62912be7/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1813.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e3e945f055f2d2dd972e20380c2df69a62912be7/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1813.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-1813.rs?ref=e3e945f055f2d2dd972e20380c2df69a62912be7", "patch": "@@ -0,0 +1,9 @@\n+fn main() {\n+    let a = 15u8;\n+    let a = &a;\n+    match a {\n+        &15 => {}\n+        &14 => {}\n+        _ => {}\n+    }\n+}"}]}