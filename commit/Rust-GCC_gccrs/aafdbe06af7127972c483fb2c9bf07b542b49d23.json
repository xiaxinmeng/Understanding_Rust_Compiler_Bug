{"sha": "aafdbe06af7127972c483fb2c9bf07b542b49d23", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWFmZGJlMDZhZjcxMjc5NzJjNDgzZmIyYzliZjA3YjU0MmI0OWQyMw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2018-03-16T12:38:42Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2018-03-16T12:38:42Z"}, "message": "PR c++/83911 - ICE with multiversioned constructor.\n\n\t* cp-gimplify.c (cp_genericize_r): Replace versioned function with\n\tdispatchere here.\n\t* call.c (build_over_call): Not here.\n\tPR c++/83911 - ICE with multiversioned constructor.\n\nFrom-SVN: r258592", "tree": {"sha": "1cbe31ec81992446813373623fb8fe08fe1e5de3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1cbe31ec81992446813373623fb8fe08fe1e5de3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/aafdbe06af7127972c483fb2c9bf07b542b49d23", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aafdbe06af7127972c483fb2c9bf07b542b49d23", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aafdbe06af7127972c483fb2c9bf07b542b49d23", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aafdbe06af7127972c483fb2c9bf07b542b49d23/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "a1295eec4e21ad46774b829e2b54b04d8f0e5e35", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a1295eec4e21ad46774b829e2b54b04d8f0e5e35", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a1295eec4e21ad46774b829e2b54b04d8f0e5e35"}], "stats": {"total": 65, "additions": 48, "deletions": 17}, "files": [{"sha": "a5808604b9a548a5fdbb6440fb35431b2ddfe31e", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=aafdbe06af7127972c483fb2c9bf07b542b49d23", "patch": "@@ -1,3 +1,10 @@\n+2018-03-16  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/83911 - ICE with multiversioned constructor.\n+\t* cp-gimplify.c (cp_genericize_r): Replace versioned function with\n+\tdispatchere here.\n+\t* call.c (build_over_call): Not here.\n+\n 2018-03-16  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/84874"}, {"sha": "67438ff2e94b2ab05f01fc023fc3e1a1c82d51a2", "filename": "gcc/cp/call.c", "status": "modified", "additions": 0, "deletions": 17, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Fcp%2Fcall.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Fcp%2Fcall.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcall.c?ref=aafdbe06af7127972c483fb2c9bf07b542b49d23", "patch": "@@ -8204,23 +8204,6 @@ build_over_call (struct z_candidate *cand, int flags, tsubst_flags_t complain)\n \t}\n     }\n \n-  /* For calls to a multi-versioned function, overload resolution\n-     returns the function with the highest target priority, that is,\n-     the version that will checked for dispatching first.  If this\n-     version is inlinable, a direct call to this version can be made\n-     otherwise the call should go through the dispatcher.  */\n-\n-  if (DECL_FUNCTION_VERSIONED (fn)\n-      && (current_function_decl == NULL\n-\t  || !targetm.target_option.can_inline_p (current_function_decl, fn)))\n-    {\n-      fn = get_function_version_dispatcher (fn);\n-      if (fn == NULL)\n-\treturn NULL;\n-      if (!already_used)\n-\tmark_versions_used (fn);\n-    }\n-\n   if (!already_used\n       && !mark_used (fn, complain))\n     return error_mark_node;"}, {"sha": "653d1dcee264755c6e95206944737a256a152059", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=aafdbe06af7127972c483fb2c9bf07b542b49d23", "patch": "@@ -1513,6 +1513,29 @@ cp_genericize_r (tree *stmt_p, int *walk_subtrees, void *data)\n \t\t       == REFERENCE_TYPE))\n \t    *walk_subtrees = 0;\n \t}\n+      /* Fall through.  */\n+    case AGGR_INIT_EXPR:\n+      /* For calls to a multi-versioned function, overload resolution\n+\t returns the function with the highest target priority, that is,\n+\t the version that will checked for dispatching first.  If this\n+\t version is inlinable, a direct call to this version can be made\n+\t otherwise the call should go through the dispatcher.  */\n+      {\n+\ttree fn = cp_get_callee_fndecl (stmt);\n+\tif (fn && DECL_FUNCTION_VERSIONED (fn)\n+\t    && (current_function_decl == NULL\n+\t\t|| !targetm.target_option.can_inline_p (current_function_decl,\n+\t\t\t\t\t\t\tfn)))\n+\t  if (tree dis = get_function_version_dispatcher (fn))\n+\t    {\n+\t      mark_versions_used (dis);\n+\t      dis = build_address (dis);\n+\t      if (TREE_CODE (stmt) == CALL_EXPR)\n+\t\tCALL_EXPR_FN (stmt) = dis;\n+\t      else\n+\t\tAGGR_INIT_EXPR_FN (stmt) = dis;\n+\t    }\n+      }\n       break;\n \n     default:"}, {"sha": "443a54be7651d60768552ebca82c6b5374121abe", "filename": "gcc/testsuite/g++.dg/ext/mv27.C", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fmv27.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aafdbe06af7127972c483fb2c9bf07b542b49d23/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fmv27.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fmv27.C?ref=aafdbe06af7127972c483fb2c9bf07b542b49d23", "patch": "@@ -0,0 +1,18 @@\n+// PR c++/83911\n+// { dg-do compile { target i?86-*-* x86_64-*-* } }\n+// { dg-require-ifunc \"\" }\n+\n+class SimdFloat\n+{\n+public:\n+    __attribute__ ((target (\"default\")))\n+    SimdFloat(float x) {}\n+\n+    __attribute__ ((target (\"avx2\")))\n+    SimdFloat(float x) {}\n+};\n+\n+SimdFloat foo()\n+{\n+    return 1;\n+}"}]}