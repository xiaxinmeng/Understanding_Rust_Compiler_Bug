{"sha": "13556413e3841460d88c7a63c8a3049399f6b28e", "node_id": "C_kwDOANBUbNoAKDEzNTU2NDEzZTM4NDE0NjBkODhjN2E2M2M4YTMwNDkzOTlmNmIyOGU", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-10-06T13:46:17Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-02-21T11:36:33Z"}, "message": "gccrs: Support type resolution on super traits on dyn objects\n\nWhen checking if specified bounds satisfy other bounds we must lookup the\nsuper traits. To finish the support for super traits we need to redo the\ncomputation of method addresses to support super traits.\n\nAddresses #914\n\ngcc/rust/ChangeLog:\n\n\t* backend/rust-compile.cc: Add note about missing support for super\n\ttraits.\n\t* typecheck/rust-tyty.cc (BaseType::satisfies_bound): New function.\n\t(BaseType::bounds_compatible): New function.\n\t(DynamicObjectType::get_object_items): New function.\n\t* typecheck/rust-hir-trait-ref.h: Use new API to perform type resolution\n\ton dyn objects.", "tree": {"sha": "469f314c188b78f915cf1d508dd64ed9632d125c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/469f314c188b78f915cf1d508dd64ed9632d125c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/13556413e3841460d88c7a63c8a3049399f6b28e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/13556413e3841460d88c7a63c8a3049399f6b28e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/13556413e3841460d88c7a63c8a3049399f6b28e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/13556413e3841460d88c7a63c8a3049399f6b28e/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "522197469179e786e59202a40f2adf9dd95c8ddd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/522197469179e786e59202a40f2adf9dd95c8ddd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/522197469179e786e59202a40f2adf9dd95c8ddd"}], "stats": {"total": 61, "additions": 37, "deletions": 24}, "files": [{"sha": "db08b3d595b4bf604621eaf01f14cc0bc5056a20", "filename": "gcc/rust/backend/rust-compile.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/13556413e3841460d88c7a63c8a3049399f6b28e/gcc%2Frust%2Fbackend%2Frust-compile.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/13556413e3841460d88c7a63c8a3049399f6b28e/gcc%2Frust%2Fbackend%2Frust-compile.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile.cc?ref=13556413e3841460d88c7a63c8a3049399f6b28e", "patch": "@@ -247,6 +247,8 @@ HIRCompileBase::compute_address_for_trait_item (\n   // Algo:\n   // check if there is an impl-item for this trait-item-ref first\n   // else assert that the trait-item-ref has an implementation\n+  //\n+  // FIXME this does not support super traits\n \n   TyTy::TypeBoundPredicateItem predicate_item\n     = predicate->lookup_associated_item (ref->get_identifier ());"}, {"sha": "0df35265959b65578a529b6798dd6bdf3d7cef78", "filename": "gcc/rust/typecheck/rust-hir-trait-ref.h", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/13556413e3841460d88c7a63c8a3049399f6b28e/gcc%2Frust%2Ftypecheck%2Frust-hir-trait-ref.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/13556413e3841460d88c7a63c8a3049399f6b28e/gcc%2Frust%2Ftypecheck%2Frust-hir-trait-ref.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-trait-ref.h?ref=13556413e3841460d88c7a63c8a3049399f6b28e", "patch": "@@ -380,6 +380,16 @@ class TraitReference\n     return item_refs;\n   }\n \n+  void get_trait_items_and_supers (\n+    std::vector<const TraitItemReference *> &result) const\n+  {\n+    for (const auto &item : item_refs)\n+      result.push_back (&item);\n+\n+    for (const auto &super_trait : super_traits)\n+      super_trait->get_trait_items_and_supers (result);\n+  }\n+\n   void on_resolved ()\n   {\n     for (auto &item : item_refs)\n@@ -451,6 +461,20 @@ class TraitReference\n     return trait_substs;\n   }\n \n+  bool satisfies_bound (const TraitReference &reference) const\n+  {\n+    if (is_equal (reference))\n+      return true;\n+\n+    for (const auto &super_trait : super_traits)\n+      {\n+\tif (super_trait->satisfies_bound (reference))\n+\t  return true;\n+      }\n+\n+    return false;\n+  }\n+\n private:\n   const HIR::Trait *hir_trait_ref;\n   std::vector<TraitItemReference> item_refs;"}, {"sha": "e2f79971337f34fb43db9c7d5213b2176bc24aa6", "filename": "gcc/rust/typecheck/rust-tyty.cc", "status": "modified", "additions": 11, "deletions": 24, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/13556413e3841460d88c7a63c8a3049399f6b28e/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/13556413e3841460d88c7a63c8a3049399f6b28e/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc?ref=13556413e3841460d88c7a63c8a3049399f6b28e", "patch": "@@ -136,22 +136,18 @@ bool\n BaseType::satisfies_bound (const TypeBoundPredicate &predicate) const\n {\n   const Resolver::TraitReference *query = predicate.get ();\n-  for (auto &bound : specified_bounds)\n+  for (const auto &bound : specified_bounds)\n     {\n       const Resolver::TraitReference *item = bound.get ();\n-      bool found = item->get_mappings ().get_defid ()\n-\t\t   == query->get_mappings ().get_defid ();\n-      if (found)\n+      if (item->satisfies_bound (*query))\n \treturn true;\n     }\n \n   auto probed = Resolver::TypeBoundsProbe::Probe (this);\n-  for (auto &b : probed)\n+  for (const auto &b : probed)\n     {\n       const Resolver::TraitReference *bound = b.first;\n-      bool found = bound->get_mappings ().get_defid ()\n-\t\t   == query->get_mappings ().get_defid ();\n-      if (found)\n+      if (bound->satisfies_bound (*query))\n \treturn true;\n     }\n \n@@ -191,7 +187,6 @@ BaseType::bounds_compatible (const BaseType &other, Location locus,\n \t  rust_error_at (r,\n \t\t\t \"bounds not satisfied for %s %<%s%> is not satisfied\",\n \t\t\t other.get_name ().c_str (), missing_preds.c_str ());\n-\t  // rust_assert (!emit_error);\n \t}\n     }\n \n@@ -2956,23 +2951,15 @@ DynamicObjectType::get_object_items () const\n   for (auto &bound : get_specified_bounds ())\n     {\n       const Resolver::TraitReference *trait = bound.get ();\n-      for (auto &item : trait->get_trait_items ())\n-\t{\n-\t  if (item.get_trait_item_type ()\n-\t\t== Resolver::TraitItemReference::TraitItemType::FN\n-\t      && item.is_object_safe ())\n-\t    items.push_back ({&item, &bound});\n-\t}\n+      std::vector<const Resolver::TraitItemReference *> trait_items;\n+      trait->get_trait_items_and_supers (trait_items);\n \n-      for (auto &super_trait : trait->get_super_traits ())\n+      for (auto &item : trait_items)\n \t{\n-\t  for (auto &item : super_trait->get_trait_items ())\n-\t    {\n-\t      if (item.get_trait_item_type ()\n-\t\t    == Resolver::TraitItemReference::TraitItemType::FN\n-\t\t  && item.is_object_safe ())\n-\t\titems.push_back ({&item, &bound});\n-\t    }\n+\t  if (item->get_trait_item_type ()\n+\t\t== Resolver::TraitItemReference::TraitItemType::FN\n+\t      && item->is_object_safe ())\n+\t    items.push_back ({item, &bound});\n \t}\n     }\n   return items;"}]}