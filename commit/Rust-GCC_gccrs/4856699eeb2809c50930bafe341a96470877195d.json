{"sha": "4856699eeb2809c50930bafe341a96470877195d", "node_id": "C_kwDOANBUbNoAKDQ4NTY2OTllZWIyODA5YzUwOTMwYmFmZTM0MWE5NjQ3MDg3NzE5NWQ", "commit": {"author": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2021-11-05T21:25:19Z"}, "committer": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2021-11-06T15:33:03Z"}, "message": "path oracle: Do not look at root oracle for killed defs.\n\nThe problem here is that we are incorrectly threading 41->20->21 here:\n\n  <bb 35> [local count: 56063504182]:\n  _134 = M.10_120 + 1;\n  if (_71 <= _134)\n    goto <bb 19>; [11.00%]\n  else\n    goto <bb 41>; [89.00%]\n...\n...\n...\n  <bb 41> [local count: 49896518755]:\n\n  <bb 20> [local count: 56063503181]:\n  # lb_75 = PHI <_134(41), 1(18)>\n  _117 = mstep_49 + lb_75;\n  _118 = _117 + -1;\n  _119 = mstep_49 + _118;\n  M.10_120 = MIN_EXPR <_119, _71>;\n  if (lb_75 > M.10_120)\n    goto <bb 21>; [11.00%]\n  else\n    goto <bb 22>; [89.00%]\n\nFirst, lb_17 == _134 because of the PHI.\nSecond, _134 > M.10_120 because of _134 = M.10_120 + 1.\n\nWe then assume that lb_75 > M.10_120, but this is incorrect because\nM.10_120 was killed along the path.\n\nThis incorrect thread causes the miscompilation in 527.cam4_r.\n\nTested on x86-64 and ppc64le Linux.\n\ngcc/ChangeLog:\n\n\tPR tree-optimization/103061\n\t* value-relation.cc (path_oracle::path_oracle): Initialize\n\tm_killed_defs.\n\t(path_oracle::killing_def): Set m_killed_defs.\n\t(path_oracle::query_relation): Do not look at the root oracle for\n\tkilled defs.\n\t* value-relation.h (class path_oracle): Add m_killed_defs.", "tree": {"sha": "3a6b172b9b36a80f92186d8dee955dfe324111f6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3a6b172b9b36a80f92186d8dee955dfe324111f6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4856699eeb2809c50930bafe341a96470877195d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4856699eeb2809c50930bafe341a96470877195d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4856699eeb2809c50930bafe341a96470877195d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4856699eeb2809c50930bafe341a96470877195d/comments", "author": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "committer": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b3a38d18351788004121e469a8b25504e4a98763", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b3a38d18351788004121e469a8b25504e4a98763", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b3a38d18351788004121e469a8b25504e4a98763"}], "stats": {"total": 10, "additions": 10, "deletions": 0}, "files": [{"sha": "a0105481466a5f38ef153172afd1637c0adb9134", "filename": "gcc/value-relation.cc", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4856699eeb2809c50930bafe341a96470877195d/gcc%2Fvalue-relation.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4856699eeb2809c50930bafe341a96470877195d/gcc%2Fvalue-relation.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvalue-relation.cc?ref=4856699eeb2809c50930bafe341a96470877195d", "patch": "@@ -1235,6 +1235,7 @@ path_oracle::path_oracle (relation_oracle *oracle)\n   m_equiv.m_next = NULL;\n   m_relations.m_names = BITMAP_ALLOC (&m_bitmaps);\n   m_relations.m_head = NULL;\n+  m_killed_defs = BITMAP_ALLOC (&m_bitmaps);\n }\n \n path_oracle::~path_oracle ()\n@@ -1305,6 +1306,8 @@ path_oracle::killing_def (tree ssa)\n \n   unsigned v = SSA_NAME_VERSION (ssa);\n \n+  bitmap_set_bit (m_killed_defs, v);\n+\n   // Walk the equivalency list and remove SSA from any equivalencies.\n   if (bitmap_bit_p (m_equiv.m_names, v))\n     {\n@@ -1389,6 +1392,12 @@ path_oracle::query_relation (basic_block bb, const_bitmap b1, const_bitmap b2)\n \n   relation_kind k = m_relations.find_relation (b1, b2);\n \n+  // Do not look at the root oracle for names that have been killed\n+  // along the path.\n+  if (bitmap_intersect_p (m_killed_defs, b1)\n+      || bitmap_intersect_p (m_killed_defs, b2))\n+    return k;\n+\n   if (k == VREL_NONE && m_root)\n     k = m_root->query_relation (bb, b1, b2);\n "}, {"sha": "8086f5552b5fc3a5c9e2787772fe593af7e70231", "filename": "gcc/value-relation.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4856699eeb2809c50930bafe341a96470877195d/gcc%2Fvalue-relation.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4856699eeb2809c50930bafe341a96470877195d/gcc%2Fvalue-relation.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvalue-relation.h?ref=4856699eeb2809c50930bafe341a96470877195d", "patch": "@@ -233,6 +233,7 @@ class path_oracle : public relation_oracle\n   equiv_chain m_equiv;\n   relation_chain_head m_relations;\n   relation_oracle *m_root;\n+  bitmap m_killed_defs;\n \n   bitmap_obstack m_bitmaps;\n   struct obstack m_chain_obstack;"}]}