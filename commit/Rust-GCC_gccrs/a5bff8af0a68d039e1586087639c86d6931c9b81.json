{"sha": "a5bff8af0a68d039e1586087639c86d6931c9b81", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTViZmY4YWYwYTY4ZDAzOWUxNTg2MDg3NjM5Yzg2ZDY5MzFjOWI4MQ==", "commit": {"author": {"name": "Matthew Malcomson", "email": "matthew.malcomson@arm.com", "date": "2020-04-28T14:38:43Z"}, "committer": {"name": "Matthew Malcomson", "email": "matthew.malcomson@arm.com", "date": "2020-04-28T14:38:43Z"}, "message": "[Arm] Account for C++17 artificial field determining Homogeneous Aggregates\n\nIn C++14, an empty class deriving from an empty base is not an\naggregate, while in C++17 it is.  In order to implement this, GCC adds\nan artificial field to such classes.\n\nThis artificial field has no mapping to Fundamental Data Types in the\nArm PCS ABI and hence should not count towards determining whether an\nobject can be passed using the vector registers as per section\n\"7.1.2 Procedure Calling\" in the arm PCS\nhttps://developer.arm.com/docs/ihi0042/latest?_ga=2.60211309.1506853196.1533541889-405231439.1528186050\n\nThis patch avoids counting this artificial field in\naapcs_vfp_sub_candidate, and hence calculates whether such objects\nshould be passed in vector registers in the same manner as C++14 (where\nthe artificial field does not exist).\n\nBefore this change, the test below would pass the arguments to `f` in\ngeneral registers.  After this change, the test passes the arguments to\n`f` using the vector registers.\n\nThe new behaviour matches the behaviour of `armclang`, and also matches\nthe GCC behaviour when run with `-std=gnu++14`.\n\n> gcc -std=gnu++17 -march=armv8-a+simd -mfloat-abi=hard test.cpp\n\n``` test.cpp\nstruct base {};\n\nstruct pair : base\n{\n  float first;\n  float second;\n  pair (float f, float s) : first(f), second(s) {}\n};\n\nvoid f (pair);\nint main()\n{\n  f({3.14, 666});\n  return 1;\n}\n```\n\nWe add a `-Wpsabi` warning to catch cases where this fix has changed the ABI for\nsome functions.  Unfortunately this warning is not emitted twice for multiple\ncalls to the same function, but I feel this is not much of a problem and can be\nfixed later if needs be.\n\n(i.e. if `main` called `f` twice in a row we only emit a diagnostic for the\nfirst).\n\nTesting:\n    Bootstrapped and regression tested on arm-linux.\n    This change fixes the struct-layout-1 tests Jakub added\n    https://gcc.gnu.org/pipermail/gcc-patches/2020-April/544204.html\n    Regression tested on arm-none-eabi.\n\ngcc/ChangeLog:\n\n2020-04-28  Matthew Malcomson  <matthew.malcomson@arm.com>\n\t    Jakub Jelinek  <jakub@redhat.com>\n\n\tPR target/94711\n\t* config/arm/arm.c (aapcs_vfp_sub_candidate): Account for C++17 empty\n\tbase class artificial fields.\n\t(aapcs_vfp_is_call_or_return_candidate): Warn when PCS ABI\n\tdecision is different after this fix.", "tree": {"sha": "05633d885061238bf9f251109e08850c67b377ea", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/05633d885061238bf9f251109e08850c67b377ea"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a5bff8af0a68d039e1586087639c86d6931c9b81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a5bff8af0a68d039e1586087639c86d6931c9b81", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a5bff8af0a68d039e1586087639c86d6931c9b81", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a5bff8af0a68d039e1586087639c86d6931c9b81/comments", "author": {"login": "mmalcomson", "id": 57484298, "node_id": "MDQ6VXNlcjU3NDg0Mjk4", "avatar_url": "https://avatars.githubusercontent.com/u/57484298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mmalcomson", "html_url": "https://github.com/mmalcomson", "followers_url": "https://api.github.com/users/mmalcomson/followers", "following_url": "https://api.github.com/users/mmalcomson/following{/other_user}", "gists_url": "https://api.github.com/users/mmalcomson/gists{/gist_id}", "starred_url": "https://api.github.com/users/mmalcomson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mmalcomson/subscriptions", "organizations_url": "https://api.github.com/users/mmalcomson/orgs", "repos_url": "https://api.github.com/users/mmalcomson/repos", "events_url": "https://api.github.com/users/mmalcomson/events{/privacy}", "received_events_url": "https://api.github.com/users/mmalcomson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mmalcomson", "id": 57484298, "node_id": "MDQ6VXNlcjU3NDg0Mjk4", "avatar_url": "https://avatars.githubusercontent.com/u/57484298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mmalcomson", "html_url": "https://github.com/mmalcomson", "followers_url": "https://api.github.com/users/mmalcomson/followers", "following_url": "https://api.github.com/users/mmalcomson/following{/other_user}", "gists_url": "https://api.github.com/users/mmalcomson/gists{/gist_id}", "starred_url": "https://api.github.com/users/mmalcomson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mmalcomson/subscriptions", "organizations_url": "https://api.github.com/users/mmalcomson/orgs", "repos_url": "https://api.github.com/users/mmalcomson/repos", "events_url": "https://api.github.com/users/mmalcomson/events{/privacy}", "received_events_url": "https://api.github.com/users/mmalcomson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78b9783774bfd3540f38f5b1e3c7fc9f719653d7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/78b9783774bfd3540f38f5b1e3c7fc9f719653d7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/78b9783774bfd3540f38f5b1e3c7fc9f719653d7"}], "stats": {"total": 67, "additions": 59, "deletions": 8}, "files": [{"sha": "4c298b8c645d9dd3802b2bed0a31a63a0f7e118a", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a5bff8af0a68d039e1586087639c86d6931c9b81/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a5bff8af0a68d039e1586087639c86d6931c9b81/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a5bff8af0a68d039e1586087639c86d6931c9b81", "patch": "@@ -1,3 +1,12 @@\n+2020-04-28  Matthew Malcomson  <matthew.malcomson@arm.com>\n+\t    Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/94711\n+\t* config/arm/arm.c (aapcs_vfp_sub_candidate): Account for C++17 empty\n+\tbase class artificial fields.\n+\t(aapcs_vfp_is_call_or_return_candidate): Warn when PCS ABI\n+\tdecision is different after this fix.\n+\n 2020-04-28  David Malcolm  <dmalcolm@redhat.com>\n \n \tPR analyzer/94447"}, {"sha": "30a2a3aeb0eec2d2c598f68a2f37cf9119edb765", "filename": "gcc/config/arm/arm.c", "status": "modified", "additions": 50, "deletions": 8, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a5bff8af0a68d039e1586087639c86d6931c9b81/gcc%2Fconfig%2Farm%2Farm.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a5bff8af0a68d039e1586087639c86d6931c9b81/gcc%2Fconfig%2Farm%2Farm.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Farm%2Farm.c?ref=a5bff8af0a68d039e1586087639c86d6931c9b81", "patch": "@@ -6139,9 +6139,19 @@ aapcs_vfp_cum_init (CUMULATIVE_ARGS *pcum  ATTRIBUTE_UNUSED,\n    If *MODEP is VOIDmode, then set it to the first valid floating point\n    type.  If a non-floating point type is found, or if a floating point\n    type that doesn't match a non-VOIDmode *MODEP is found, then return -1,\n-   otherwise return the count in the sub-tree.  */\n+   otherwise return the count in the sub-tree.\n+\n+   The AVOID_CXX17_EMPTY_BASE argument is to allow the caller to check whether\n+   this function has changed its behavior after the fix for PR94384 -- this fix\n+   is to avoid artificial fields in empty base classes.\n+   When called with this argument as a NULL pointer this function does not\n+   avoid the artificial fields -- this is useful to check whether the function\n+   returns something different after the fix.\n+   When called pointing at a value, this function avoids such artificial fields\n+   and sets the value to TRUE when one of these fields has been set.  */\n static int\n-aapcs_vfp_sub_candidate (const_tree type, machine_mode *modep)\n+aapcs_vfp_sub_candidate (const_tree type, machine_mode *modep,\n+\t\t\t bool *avoid_cxx17_empty_base)\n {\n   machine_mode mode;\n   HOST_WIDE_INT size;\n@@ -6213,7 +6223,8 @@ aapcs_vfp_sub_candidate (const_tree type, machine_mode *modep)\n \t    || TREE_CODE (TYPE_SIZE (type)) != INTEGER_CST)\n \t  return -1;\n \n-\tcount = aapcs_vfp_sub_candidate (TREE_TYPE (type), modep);\n+\tcount = aapcs_vfp_sub_candidate (TREE_TYPE (type), modep,\n+\t\t\t\t\t avoid_cxx17_empty_base);\n \tif (count == -1\n \t    || !index\n \t    || !TYPE_MAX_VALUE (index)\n@@ -6251,7 +6262,20 @@ aapcs_vfp_sub_candidate (const_tree type, machine_mode *modep)\n \t    if (TREE_CODE (field) != FIELD_DECL)\n \t      continue;\n \n-\t    sub_count = aapcs_vfp_sub_candidate (TREE_TYPE (field), modep);\n+\t    /* Ignore C++17 empty base fields, while their type indicates they\n+\t       contain padding, this is only sometimes contributed to the derived\n+\t       class.\n+\t       When the padding is contributed to the derived class that's\n+\t       caught by the general test for padding below.  */\n+\t    if (cxx17_empty_base_field_p (field)\n+\t\t&& avoid_cxx17_empty_base)\n+\t      {\n+\t\t*avoid_cxx17_empty_base = true;\n+\t\tcontinue;\n+\t      }\n+\n+\t    sub_count = aapcs_vfp_sub_candidate (TREE_TYPE (field), modep,\n+\t\t\t\t\t\t avoid_cxx17_empty_base);\n \t    if (sub_count < 0)\n \t      return -1;\n \t    count += sub_count;\n@@ -6284,7 +6308,8 @@ aapcs_vfp_sub_candidate (const_tree type, machine_mode *modep)\n \t    if (TREE_CODE (field) != FIELD_DECL)\n \t      continue;\n \n-\t    sub_count = aapcs_vfp_sub_candidate (TREE_TYPE (field), modep);\n+\t    sub_count = aapcs_vfp_sub_candidate (TREE_TYPE (field), modep,\n+\t\t\t\t\t\t avoid_cxx17_empty_base);\n \t    if (sub_count < 0)\n \t      return -1;\n \t    count = count > sub_count ? count : sub_count;\n@@ -6346,10 +6371,27 @@ aapcs_vfp_is_call_or_return_candidate (enum arm_pcs pcs_variant,\n      out from the mode.  */\n   if (type)\n     {\n-      int ag_count = aapcs_vfp_sub_candidate (type, &new_mode);\n-\n+      bool avoided = false;\n+      int ag_count = aapcs_vfp_sub_candidate (type, &new_mode, &avoided);\n       if (ag_count > 0 && ag_count <= 4)\n-\t*count = ag_count;\n+\t{\n+\t  static unsigned last_reported_type_uid;\n+\t  unsigned uid = TYPE_UID (TYPE_MAIN_VARIANT (type));\n+\t  int alt;\n+\t  if (warn_psabi\n+\t      && avoided\n+\t      && uid != last_reported_type_uid\n+\t      && ((alt = aapcs_vfp_sub_candidate (type, &new_mode, NULL))\n+\t\t  != ag_count))\n+\t    {\n+\t      gcc_assert (alt == -1);\n+\t      last_reported_type_uid = uid;\n+\t      inform (input_location, \"parameter passing for argument of type \"\n+\t\t      \"%qT when C++17 is enabled changed to match C++14 \"\n+\t\t      \"in GCC 10.1\", type);\n+\t    }\n+\t  *count = ag_count;\n+\t}\n       else\n \treturn false;\n     }"}]}