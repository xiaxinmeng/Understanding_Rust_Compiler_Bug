{"sha": "be9dd15c70d45088a48e6f5d3e0967798ade096e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmU5ZGQxNWM3MGQ0NTA4OGE0OGU2ZjVkM2UwOTY3Nzk4YWRlMDk2ZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2018-03-14T08:50:23Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2018-03-14T08:50:23Z"}, "message": "re PR sanitizer/83392 (FAIL: c-c++-common/ubsan/ptr-overflow-sanitization-1.c  scan-tree-dump-times)\n\n\tPR sanitizer/83392\n\t* sanopt.c (maybe_optimize_ubsan_ptr_ifn): Handle also\n\tINTEGER_CST offset, add it together with bitpos / 8 and\n\tsign extend based on POINTER_SIZE.\n\n\t* c-c++-common/ubsan/ptr-overflow-sanitization-1.c: Adjust expected\n\tcheck count from 17 to 14.\n\nFrom-SVN: r258516", "tree": {"sha": "f4f3711ee363640386969022eb05acdb40fd2237", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f4f3711ee363640386969022eb05acdb40fd2237"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/be9dd15c70d45088a48e6f5d3e0967798ade096e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/be9dd15c70d45088a48e6f5d3e0967798ade096e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/be9dd15c70d45088a48e6f5d3e0967798ade096e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/be9dd15c70d45088a48e6f5d3e0967798ade096e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "2062c40cb5deeea3ef964c7f5bb8a48b3d38831e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2062c40cb5deeea3ef964c7f5bb8a48b3d38831e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2062c40cb5deeea3ef964c7f5bb8a48b3d38831e"}], "stats": {"total": 30, "additions": 22, "deletions": 8}, "files": [{"sha": "0bfc201813054c4c62e4f4860b6cdd0663b05955", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=be9dd15c70d45088a48e6f5d3e0967798ade096e", "patch": "@@ -1,5 +1,10 @@\n 2018-03-14  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR sanitizer/83392\n+\t* sanopt.c (maybe_optimize_ubsan_ptr_ifn): Handle also\n+\tINTEGER_CST offset, add it together with bitpos / 8 and\n+\tsign extend based on POINTER_SIZE.\n+\n \tPR target/84844\n \tRevert\n \t2017-04-20  Uros Bizjak  <ubizjak@gmail.com>"}, {"sha": "116bc380f826d9dfa1c39df9cb0fa5c013784691", "filename": "gcc/sanopt.c", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2Fsanopt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2Fsanopt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fsanopt.c?ref=be9dd15c70d45088a48e6f5d3e0967798ade096e", "patch": "@@ -486,12 +486,17 @@ maybe_optimize_ubsan_ptr_ifn (sanopt_ctx *ctx, gimple *stmt)\n       HOST_WIDE_INT bitpos;\n       base = get_inner_reference (base, &bitsize, &pbitpos, &offset, &mode,\n \t\t\t\t  &unsignedp, &reversep, &volatilep);\n-      if (offset == NULL_TREE\n+      if ((offset == NULL_TREE || TREE_CODE (offset) == INTEGER_CST)\n \t  && DECL_P (base)\n \t  && pbitpos.is_constant (&bitpos))\n \t{\n \t  gcc_assert (!DECL_REGISTER (base));\n-\t  offset_int expr_offset = bitpos / BITS_PER_UNIT;\n+\t  offset_int expr_offset;\n+\t  if (offset)\n+\t    expr_offset = wi::to_offset (offset) + bitpos / BITS_PER_UNIT;\n+\t  else\n+\t    expr_offset = bitpos / BITS_PER_UNIT;\n+\t  expr_offset = wi::sext (expr_offset, POINTER_SIZE);\n \t  offset_int total_offset = expr_offset + cur_offset;\n \t  if (total_offset != wi::sext (total_offset, POINTER_SIZE))\n \t    {\n@@ -511,7 +516,7 @@ maybe_optimize_ubsan_ptr_ifn (sanopt_ctx *ctx, gimple *stmt)\n \t      && (!is_global_var (base) || decl_binds_to_current_def_p (base)))\n \t    {\n \t      offset_int base_size = wi::to_offset (DECL_SIZE_UNIT (base));\n-\t      if (bitpos >= 0\n+\t      if (!wi::neg_p (expr_offset)\n \t\t  && wi::les_p (total_offset, base_size))\n \t\t{\n \t\t  if (!wi::neg_p (total_offset)\n@@ -532,7 +537,7 @@ maybe_optimize_ubsan_ptr_ifn (sanopt_ctx *ctx, gimple *stmt)\n \t     */\n \n \t  bool sign_cur_offset = !wi::neg_p (cur_offset);\n-\t  bool sign_expr_offset = bitpos >= 0;\n+\t  bool sign_expr_offset = !wi::neg_p (expr_offset);\n \n \t  tree base_addr\n \t    = build1 (ADDR_EXPR, build_pointer_type (TREE_TYPE (base)), base);"}, {"sha": "a86d8ccf14b36dc99c8baca75ff3f9671d85154d", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=be9dd15c70d45088a48e6f5d3e0967798ade096e", "patch": "@@ -1,5 +1,9 @@\n 2018-03-14  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR sanitizer/83392\n+\t* c-c++-common/ubsan/ptr-overflow-sanitization-1.c: Adjust expected\n+\tcheck count from 17 to 14.\n+\n \tPR target/84844\n \t* gcc.target/i386/pr84844.c: New test.\n "}, {"sha": "14569d5a5c6106101a45fddb362b64da1b167b21", "filename": "gcc/testsuite/c-c++-common/ubsan/ptr-overflow-sanitization-1.c", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fubsan%2Fptr-overflow-sanitization-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/be9dd15c70d45088a48e6f5d3e0967798ade096e/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fubsan%2Fptr-overflow-sanitization-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fubsan%2Fptr-overflow-sanitization-1.c?ref=be9dd15c70d45088a48e6f5d3e0967798ade096e", "patch": "@@ -25,9 +25,9 @@ void foo(void)\n   p2 = p + 2;\n \n   p = b - SMAX; /* pointer overflow check is needed */\n-  p2 = p + (SMAX - 2); /* b - 2: pointer overflow check is needed */\n-  p2 = p + (SMAX - 1); /* b - 1: pointer overflow check is needed */\n-  p2 = p + SMAX; /* b: pointer overflow check is needed */\n+  p2 = p + (SMAX - 2); /* b - 2: no need to check this  */\n+  p2 = p + (SMAX - 1); /* b - 1: no need to check this */\n+  p2 = p + SMAX; /* b: no need to check this */\n   p2++; /* b + 1 */\n \n   p = c;\n@@ -75,4 +75,4 @@ void negative_to_negative (char *ptr)\n   p2 += 5;\n }\n \n-/* { dg-final { scan-tree-dump-times \"__ubsan_handle_pointer_overflow\" 17 \"optimized\" } } */\n+/* { dg-final { scan-tree-dump-times \"__ubsan_handle_pointer_overflow\" 14 \"optimized\" } } */"}]}