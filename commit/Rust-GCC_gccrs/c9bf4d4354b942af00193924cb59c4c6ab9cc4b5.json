{"sha": "c9bf4d4354b942af00193924cb59c4c6ab9cc4b5", "node_id": "C_kwDOANBUbNoAKGM5YmY0ZDQzNTRiOTQyYWYwMDE5MzkyNGNiNTljNGM2YWI5Y2M0YjU", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2021-10-21T21:32:23Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2021-10-26T17:16:31Z"}, "message": "c++tools: Fix memory leak\n\nThe allocated memory is not freed when returning early due to an error.\n\nc++tools/ChangeLog:\n\n\t* resolver.cc (module_resolver::read_tuple_file): Use unique_ptr\n\tto ensure memory is freed before returning.", "tree": {"sha": "1a7a061fe92252fd71adea9385e9ee07749185f0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1a7a061fe92252fd71adea9385e9ee07749185f0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c9bf4d4354b942af00193924cb59c4c6ab9cc4b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c9bf4d4354b942af00193924cb59c4c6ab9cc4b5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c9bf4d4354b942af00193924cb59c4c6ab9cc4b5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c9bf4d4354b942af00193924cb59c4c6ab9cc4b5/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d37abedf58d664ccb9c06272303a10021ee36a7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7d37abedf58d664ccb9c06272303a10021ee36a7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7d37abedf58d664ccb9c06272303a10021ee36a7"}], "stats": {"total": 14, "additions": 8, "deletions": 6}, "files": [{"sha": "a1837b3ee108384e0f603dd66a2be2b46042864a", "filename": "c++tools/resolver.cc", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c9bf4d4354b942af00193924cb59c4c6ab9cc4b5/c%2B%2Btools%2Fresolver.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c9bf4d4354b942af00193924cb59c4c6ab9cc4b5/c%2B%2Btools%2Fresolver.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/c%2B%2Btools%2Fresolver.cc?ref=c9bf4d4354b942af00193924cb59c4c6ab9cc4b5", "patch": "@@ -23,6 +23,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"resolver.h\"\n // C++\n #include <algorithm>\n+#include <memory>\n // C\n #include <cstring>\n // OS\n@@ -114,10 +115,17 @@ module_resolver::read_tuple_file (int fd, char const *prefix, bool force)\n   buffer = mmap (nullptr, stat.st_size, PROT_READ, MAP_PRIVATE, fd, 0);\n   if (buffer == MAP_FAILED)\n     return -errno;\n+  struct Deleter {\n+    void operator()(void* p) const { munmap(p, size); }\n+    size_t size;\n+  };\n+  std::unique_ptr<void, Deleter> guard(buffer, Deleter{(size_t)stat.st_size});\n #else\n   buffer = xmalloc (stat.st_size);\n   if (!buffer)\n     return -errno;\n+  struct Deleter { void operator()(void* p) const { free(p); } };\n+  std::unique_ptr<void, Deleter> guard(buffer);\n   if (read (fd, buffer, stat.st_size) != stat.st_size)\n     return -errno;\n #endif\n@@ -179,12 +187,6 @@ module_resolver::read_tuple_file (int fd, char const *prefix, bool force)\n \t}\n     }\n \n-#if MAPPED_READING\n-  munmap (buffer, stat.st_size);\n-#else\n-  free (buffer);\n-#endif\n-\n   return 0;\n }\n "}]}