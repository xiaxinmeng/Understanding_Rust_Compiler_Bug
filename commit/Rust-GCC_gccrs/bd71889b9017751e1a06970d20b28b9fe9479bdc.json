{"sha": "bd71889b9017751e1a06970d20b28b9fe9479bdc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmQ3MTg4OWI5MDE3NzUxZTFhMDY5NzBkMjBiMjhiOWZlOTQ3OWJkYw==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2021-03-23T19:23:30Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2021-03-23T19:29:14Z"}, "message": "c++: Note duplicates in symbol table [PR 99283]\n\nI ran into this reducing 99283, we were failing to mark binding\nvectors when the current TU declares a duplicate decl (as opposed to\nan import introduces a duplicate).\n\n\tPR c++/99283\n\tgcc/cp/\n\t* name-lookup.c (check_module_override): Set global or partition\n\tDUP on the binding vector.\n\tgcc/testsuite/\n\t* g++.dg/modules/pr99283-1_a.H: New.\n\t* g++.dg/modules/pr99283-1_b.H: New.", "tree": {"sha": "b5e5818717b8f8f1542e8489ce7e4e6b3bab4e1b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b5e5818717b8f8f1542e8489ce7e4e6b3bab4e1b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bd71889b9017751e1a06970d20b28b9fe9479bdc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bd71889b9017751e1a06970d20b28b9fe9479bdc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bd71889b9017751e1a06970d20b28b9fe9479bdc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bd71889b9017751e1a06970d20b28b9fe9479bdc/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b61461ac7f9bdd0e98145be79423d19b933afaa0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b61461ac7f9bdd0e98145be79423d19b933afaa0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b61461ac7f9bdd0e98145be79423d19b933afaa0"}], "stats": {"total": 49, "additions": 40, "deletions": 9}, "files": [{"sha": "f4263f15f6203ce7016acf8e26ae6f292df6b95f", "filename": "gcc/cp/name-lookup.c", "status": "modified", "additions": 24, "deletions": 9, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd71889b9017751e1a06970d20b28b9fe9479bdc/gcc%2Fcp%2Fname-lookup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd71889b9017751e1a06970d20b28b9fe9479bdc/gcc%2Fcp%2Fname-lookup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.c?ref=bd71889b9017751e1a06970d20b28b9fe9479bdc", "patch": "@@ -3528,6 +3528,7 @@ static tree\n check_module_override (tree decl, tree mvec, bool hiding,\n \t\t       tree scope, tree name)\n {\n+  tree match = NULL_TREE;\n   bitmap imports = get_import_bitmap ();\n   binding_cluster *cluster = BINDING_VECTOR_CLUSTER_BASE (mvec);\n   unsigned ix = BINDING_VECTOR_NUM_CLUSTERS (mvec);\n@@ -3566,13 +3567,15 @@ check_module_override (tree decl, tree mvec, bool hiding,\n \t  bind = STAT_VISIBLE (bind);\n \n \tfor (ovl_iterator iter (bind); iter; ++iter)\n-\t  if (iter.using_p ())\n-\t    ;\n-\t  else if (tree match = duplicate_decls (decl, *iter, hiding))\n-\t    return match;\n+\t  if (!iter.using_p ())\n+\t    {\n+\t      match = duplicate_decls (decl, *iter, hiding);\n+\t      if (match)\n+\t\tgoto matched;\n+\t    }\n       }\n \n-  if (TREE_PUBLIC (scope) && TREE_PUBLIC (decl) && !not_module_p ()\n+  if (TREE_PUBLIC (scope) && TREE_PUBLIC (STRIP_TEMPLATE (decl))\n       /* Namespaces are dealt with specially in\n \t make_namespace_finish.  */\n       && !(TREE_CODE (decl) == NAMESPACE_DECL && !DECL_NAMESPACE_ALIAS (decl)))\n@@ -3588,14 +3591,26 @@ check_module_override (tree decl, tree mvec, bool hiding,\n \n       for (ovl_iterator iter (mergeable); iter; ++iter)\n \t{\n-\t  tree match = *iter;\n-\t  \n-\t  if (duplicate_decls (decl, match, hiding))\n-\t    return match;\n+\t  match = duplicate_decls (decl, *iter, hiding);\n+\t  if (match)\n+\t    goto matched;\n \t}\n     }\n \n   return NULL_TREE;\n+\n+ matched:\n+  if (match != error_mark_node)\n+    {\n+      if (named_module_p ())\n+\tBINDING_VECTOR_PARTITION_DUPS_P (mvec) = true;\n+      else\n+\tBINDING_VECTOR_GLOBAL_DUPS_P (mvec) = true;\n+    }\n+\n+  return match;\n+\n+  \n }\n \n /* Record DECL as belonging to the current lexical scope.  Check for"}, {"sha": "95c8c06bec6da92cc8dfaf59e1efdf45cdcd3a48", "filename": "gcc/testsuite/g++.dg/modules/pr99283-1_a.H", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd71889b9017751e1a06970d20b28b9fe9479bdc/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99283-1_a.H", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd71889b9017751e1a06970d20b28b9fe9479bdc/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99283-1_a.H", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99283-1_a.H?ref=bd71889b9017751e1a06970d20b28b9fe9479bdc", "patch": "@@ -0,0 +1,6 @@\n+// PR 99283 part 1 ICE on specialization\n+// { dg-additional-options -fmodule-header }\n+// { dg-module-cmi {} }\n+\n+template<typename _Facet>\n+_Facet &use_facet ();"}, {"sha": "cd15a1b1e0cae9b656a60e2684b353ea191478ad", "filename": "gcc/testsuite/g++.dg/modules/pr99283-1_b.H", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bd71889b9017751e1a06970d20b28b9fe9479bdc/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99283-1_b.H", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bd71889b9017751e1a06970d20b28b9fe9479bdc/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99283-1_b.H", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99283-1_b.H?ref=bd71889b9017751e1a06970d20b28b9fe9479bdc", "patch": "@@ -0,0 +1,10 @@\n+// { dg-additional-options -fmodule-header }\n+// { dg-module-cmi {} }\n+\n+import  \"pr99283-1_a.H\";\n+\n+template<typename _Facet>\n+_Facet &use_facet ();\n+\n+extern template\n+char &use_facet<char> ();"}]}