{"sha": "3bcdbd50ba73bc366027844bcb44ef1afac6e766", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2JjZGJkNTBiYTczYmMzNjYwMjc4NDRiY2I0NGVmMWFmYWM2ZTc2Ng==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2014-01-03T12:22:17Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2014-01-03T12:22:17Z"}, "message": "re PR target/59625 (asm goto and TARGET_FOUR_JUMP_LIMIT)\n\n\tPR target/59625\n\t* config/i386/i386.c (ix86_avoid_jump_mispredicts): Don't consider\n\tasm goto as jump.\n\n\t* gcc.target/i386/pr59625.c: New test.\n\nFrom-SVN: r206314", "tree": {"sha": "89abdbf02f19fba4de444c6faa612bc26c475a90", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/89abdbf02f19fba4de444c6faa612bc26c475a90"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3bcdbd50ba73bc366027844bcb44ef1afac6e766", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3bcdbd50ba73bc366027844bcb44ef1afac6e766", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3bcdbd50ba73bc366027844bcb44ef1afac6e766", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3bcdbd50ba73bc366027844bcb44ef1afac6e766/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "cdc23b1b205ad460a71983b41c67a6f34f18b368", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cdc23b1b205ad460a71983b41c67a6f34f18b368", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cdc23b1b205ad460a71983b41c67a6f34f18b368"}], "stats": {"total": 59, "additions": 55, "deletions": 4}, "files": [{"sha": "09639d3cd56643b2afc46c7113d3900ef3f7fe74", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=3bcdbd50ba73bc366027844bcb44ef1afac6e766", "patch": "@@ -1,5 +1,9 @@\n 2014-01-03  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR target/59625\n+\t* config/i386/i386.c (ix86_avoid_jump_mispredicts): Don't consider\n+\tasm goto as jump.\n+\n \t* config/i386/i386.md (MODE_SIZE): New mode attribute.\n \t(push splitter): Use <P:MODE_SIZE> instead of\n \tGET_MODE_SIZE (<P:MODE>mode)."}, {"sha": "d2f5b6e9fda70a9f984284b06be6aa96da08cc0a", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=3bcdbd50ba73bc366027844bcb44ef1afac6e766", "patch": "@@ -38825,7 +38825,10 @@ ix86_avoid_jump_mispredicts (void)\n      The smallest offset in the page INSN can start is the case where START\n      ends on the offset 0.  Offset of INSN is then NBYTES - sizeof (INSN).\n      We add p2align to 16byte window with maxskip 15 - NBYTES + sizeof (INSN).\n-     */\n+\n+     Don't consider asm goto as jump, while it can contain a jump, it doesn't\n+     have to, control transfer to label(s) can be performed through other\n+     means, and also we estimate minimum length of all asm stmts as 0.  */\n   for (insn = start; insn; insn = NEXT_INSN (insn))\n     {\n       int min_size;\n@@ -38852,7 +38855,8 @@ ix86_avoid_jump_mispredicts (void)\n \t      while (nbytes + max_skip >= 16)\n \t\t{\n \t\t  start = NEXT_INSN (start);\n-\t\t  if (JUMP_P (start) || CALL_P (start))\n+\t\t  if ((JUMP_P (start) && asm_noperands (PATTERN (start)) < 0)\n+\t\t      || CALL_P (start))\n \t\t    njumps--, isjump = 1;\n \t\t  else\n \t\t    isjump = 0;\n@@ -38867,15 +38871,17 @@ ix86_avoid_jump_mispredicts (void)\n       if (dump_file)\n \tfprintf (dump_file, \"Insn %i estimated to %i bytes\\n\",\n \t\t INSN_UID (insn), min_size);\n-      if (JUMP_P (insn) || CALL_P (insn))\n+      if ((JUMP_P (insn) && asm_noperands (PATTERN (insn)) < 0)\n+\t  || CALL_P (insn))\n \tnjumps++;\n       else\n \tcontinue;\n \n       while (njumps > 3)\n \t{\n \t  start = NEXT_INSN (start);\n-\t  if (JUMP_P (start) || CALL_P (start))\n+\t  if ((JUMP_P (start) && asm_noperands (PATTERN (start)) < 0)\n+\t      || CALL_P (start))\n \t    njumps--, isjump = 1;\n \t  else\n \t    isjump = 0;"}, {"sha": "49b55f8b49ec5910d00fdb1b34c7b26e0fcf02ec", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=3bcdbd50ba73bc366027844bcb44ef1afac6e766", "patch": "@@ -1,3 +1,8 @@\n+2014-01-03  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/59625\n+\t* gcc.target/i386/pr59625.c: New test.\n+\n 2014-01-03  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tCore DR 1442"}, {"sha": "8e1a7794bc487783c7a5339d39305a250de36753", "filename": "gcc/testsuite/gcc.target/i386/pr59625.c", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr59625.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3bcdbd50ba73bc366027844bcb44ef1afac6e766/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr59625.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr59625.c?ref=3bcdbd50ba73bc366027844bcb44ef1afac6e766", "patch": "@@ -0,0 +1,36 @@\n+/* PR target/59625 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -mtune=atom\" } */\n+\n+int\n+foo (void)\n+{\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  asm goto (\"\" : : : : lab);\n+  return 0;\n+lab:\n+  return 1;\n+}\n+\n+/* Verify we don't consider asm goto as a jump for four jumps limit\n+   optimization.  asm goto doesn't have to contain a jump at all,\n+   the branching to labels can happen through different means.  */\n+/* { dg-final { scan-assembler-not \"(p2align\\[^\\n\\r\\]*\\[\\n\\r]*\\[^\\n\\r\\]*){8}p2align\" } } */"}]}