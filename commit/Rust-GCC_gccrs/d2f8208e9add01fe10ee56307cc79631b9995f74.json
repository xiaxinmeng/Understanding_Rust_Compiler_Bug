{"sha": "d2f8208e9add01fe10ee56307cc79631b9995f74", "node_id": "C_kwDOANBUbNoAKGQyZjgyMDhlOWFkZDAxZmUxMGVlNTYzMDdjYzc5NjMxYjk5OTVmNzQ", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-04-14T09:28:03Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-04-14T10:02:37Z"}, "message": "libstdc++: Fix missing and incorrect feature test macros [PR105269]\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/105269\n\t* include/bits/stl_vector.h (__cpp_lib_constexpr_vector):\n\tDefine.\n\t* include/c_compatibility/stdatomic.h (__cpp_lib_stdatomic_h):\n\tDefine.\n\t* include/std/optional (__cpp_lib_optional): Define new value\n\tfor C++23.\n\t(__cpp_lib_monadic_optional): Remove.\n\t* include/std/version (__cpp_lib_constexpr_vector): Define.\n\t(__cpp_lib_stdatomic_h): Define.\n\t(__cpp_lib_optional): Define new value for C++23.\n\t(__cpp_lib_monadic_optional): Remove.\n\t* testsuite/20_util/optional/monadic/and_then.cc: Adjust.\n\t* testsuite/20_util/optional/requirements.cc: Adjust for C++23.\n\t* testsuite/20_util/optional/version.cc: Likewise.\n\t* testsuite/23_containers/vector/cons/constexpr.cc: Check\n\tfeature test macro.\n\t* testsuite/29_atomics/headers/stdatomic.h/c_compat.cc:\n\tLikewise.\n\t* testsuite/20_util/optional/monadic/version.cc: Removed.\n\t* testsuite/23_containers/vector/requirements/version.cc: New test.\n\t* testsuite/29_atomics/headers/stdatomic.h/version.cc: New test.", "tree": {"sha": "f7dfdca479701c951d7b5ed395ee389565ce51c8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f7dfdca479701c951d7b5ed395ee389565ce51c8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d2f8208e9add01fe10ee56307cc79631b9995f74", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d2f8208e9add01fe10ee56307cc79631b9995f74", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d2f8208e9add01fe10ee56307cc79631b9995f74", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d2f8208e9add01fe10ee56307cc79631b9995f74/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8369b4e4c6433535981d377edc1d4abb799c9225", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8369b4e4c6433535981d377edc1d4abb799c9225", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8369b4e4c6433535981d377edc1d4abb799c9225"}], "stats": {"total": 77, "additions": 54, "deletions": 23}, "files": [{"sha": "b4ff3989a5dd5555949a212b236ed54be7e670fb", "filename": "libstdc++-v3/include/bits/stl_vector.h", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstl_vector.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstl_vector.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstl_vector.h?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -62,8 +62,9 @@\n #if __cplusplus >= 201103L\n #include <initializer_list>\n #endif\n-#if __cplusplus > 201703L\n+#if __cplusplus >= 202002L\n # include <compare>\n+#define __cpp_lib_constexpr_vector 201907L\n #endif\n \n #include <debug/assertions.h>"}, {"sha": "a51a84c2054781903b4985ee5230e81dbe8df9b5", "filename": "libstdc++-v3/include/c_compatibility/stdatomic.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fc_compatibility%2Fstdatomic.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fc_compatibility%2Fstdatomic.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fc_compatibility%2Fstdatomic.h?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -32,6 +32,8 @@\n #if __cplusplus > 202002L\n #include <atomic>\n \n+#define __cpp_lib_stdatomic_h 202011L\n+\n #define _Atomic(_Tp) std::atomic<_Tp>\n \n using std::memory_order;"}, {"sha": "791ef6f1994b25e72d65b21a7175bf9f2dae1e18", "filename": "libstdc++-v3/include/std/optional", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fstd%2Foptional", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fstd%2Foptional", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fstd%2Foptional?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -60,10 +60,12 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n    *  @{\n    */\n \n-#if __cplusplus == 201703L\n-# define __cpp_lib_optional 201606L\n-#else\n+#if __cplusplus > 202002L && __cpp_lib_concepts\n+# define __cpp_lib_optional 202110L\n+#elif __cplusplus >= 202002L\n # define __cpp_lib_optional 202106L\n+#else\n+# define __cpp_lib_optional 201606L\n #endif\n \n   template<typename _Tp>\n@@ -1043,9 +1045,7 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \t    return static_cast<_Tp>(std::forward<_Up>(__u));\n \t}\n \n-#if __cplusplus > 202002L && __cpp_lib_concepts\n-#define __cpp_lib_monadic_optional 202110L\n-\n+#if __cpp_lib_optional >= 202110L\n       // [optional.monadic]\n \n       template<typename _Fn>"}, {"sha": "d8ec658484fbf0c8b93af570f7e2e77e114852b8", "filename": "libstdc++-v3/include/std/version", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fversion", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fversion", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fversion?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -257,6 +257,7 @@\n #define __cpp_lib_constexpr_string_view 201811L\n #define __cpp_lib_constexpr_tuple 201811L\n #define __cpp_lib_constexpr_utility 201811L\n+#define __cpp_lib_constexpr_vector 201907L\n #define __cpp_lib_erase_if 202002L\n #define __cpp_lib_generic_unordered_lookup 201811L\n #define __cpp_lib_interpolate 201902L\n@@ -312,7 +313,8 @@\n #define __cpp_lib_invoke_r 202106L\n #define __cpp_lib_ios_noreplace 202200L\n #if __cpp_lib_concepts\n-# define __cpp_lib_monadic_optional 202110L\n+# undef __cpp_lib_optional\n+# define __cpp_lib_optional 202110L\n #endif\n #define __cpp_lib_move_only_function 202110L\n #if __cpp_lib_span\n@@ -321,6 +323,7 @@\n #if _GLIBCXX_HAVE_STACKTRACE\n # define __cpp_lib_stacktrace 202011L\n #endif\n+#define __cpp_lib_stdatomic_h 202011L\n #define __cpp_lib_string_contains 202011L\n #if _GLIBCXX_USE_CXX11_ABI // Only supported with cxx11-abi\n # define __cpp_lib_string_resize_and_overwrite 202110L"}, {"sha": "c7e54efafeef01d6ca8af6b57410463903dde0ee", "filename": "libstdc++-v3/testsuite/20_util/optional/monadic/and_then.cc", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fmonadic%2Fand_then.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fmonadic%2Fand_then.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fmonadic%2Fand_then.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -3,9 +3,7 @@\n \n #include <optional>\n \n-#ifndef __cpp_lib_monadic_optional\n-# error \"Feature test macro for monadic optional is missing in <optional>\"\n-#elif __cpp_lib_monadic_optional < 202110L\n+#if __cpp_lib_optional < 202110L\n # error \"Feature test macro for monadic optional has wrong value in <optional>\"\n #endif\n "}, {"sha": "90b2a90a5df2268138ae21e5dfefd2b1e6cf42e6", "filename": "libstdc++-v3/testsuite/20_util/optional/monadic/version.cc", "status": "removed", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8369b4e4c6433535981d377edc1d4abb799c9225/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fmonadic%2Fversion.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8369b4e4c6433535981d377edc1d4abb799c9225/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fmonadic%2Fversion.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fmonadic%2Fversion.cc?ref=8369b4e4c6433535981d377edc1d4abb799c9225", "patch": "@@ -1,10 +0,0 @@\n-// { dg-options \"-std=gnu++23\" }\n-// { dg-do preprocess { target c++23 } }\n-\n-#include <version>\n-\n-#ifndef __cpp_lib_monadic_optional\n-# error \"Feature test macro for monadic optional is missing in <version>\"\n-#elif __cpp_lib_monadic_optional < 202110L\n-# error \"Feature test macro for monadic optional has wrong value in <version>\"\n-#endif"}, {"sha": "a56680a6fb1a7acfa66d2c7049d811c7c986fd46", "filename": "libstdc++-v3/testsuite/20_util/optional/requirements.cc", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Frequirements.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Frequirements.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Frequirements.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -23,8 +23,10 @@\n # error \"Feature test macro for optional is missing in <optional>\"\n #elif __cpp_lib_optional < 201606L\n # error \"Feature test macro for optional has wrong value in <optional>\"\n-#elif __cplusplus >= 202002L && __cpp_lib_optional < 202106L\n+#elif __cplusplus == 202002L && __cpp_lib_optional != 202106L\n # error \"Feature test macro for optional has wrong value for C++20 in <optional>\"\n+#elif __cplusplus > 202002L && __cpp_lib_optional != 202110L\n+# error \"Feature test macro for optional has wrong value for C++23 in <version>\"\n #endif\n \n #include <testsuite_hooks.h>"}, {"sha": "2fd52f7c19446daa3af498439bf42674c3c31467", "filename": "libstdc++-v3/testsuite/20_util/optional/version.cc", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fversion.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fversion.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Foptional%2Fversion.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -6,6 +6,8 @@\n # error \"Feature test macro for optional is missing in <version>\"\n #elif __cplusplus == 201703L && __cpp_lib_optional != 201606L\n # error \"Feature test macro for optional has wrong value for C++17 in <version>\"\n-#elif __cplusplus >= 202002L && __cpp_lib_optional < 202106L\n+#elif __cplusplus == 202002L && __cpp_lib_optional != 202106L\n # error \"Feature test macro for optional has wrong value for C++20 in <version>\"\n+#elif __cplusplus > 202002L && __cpp_lib_optional != 202110L\n+# error \"Feature test macro for optional has wrong value for C++23 in <version>\"\n #endif"}, {"sha": "e6324ad4a0a4c859586cf54450edf2179d429dbf", "filename": "libstdc++-v3/testsuite/23_containers/vector/cons/constexpr.cc", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fvector%2Fcons%2Fconstexpr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fvector%2Fcons%2Fconstexpr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fvector%2Fcons%2Fconstexpr.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -3,6 +3,13 @@\n // { dg-xfail-if \"not supported\" { debug_mode } }\n \n #include <vector>\n+\n+#ifndef __cpp_lib_constexpr_vector\n+# error \"Feature test macro for constexpr vector is missing in <vector>\"\n+#elif __cpp_lib_constexpr_vector != 201907L\n+# error \"Feature test macro for constexpr vector has wrong value in <vector>\"\n+#endif\n+\n #include <testsuite_hooks.h>\n #include <testsuite_iterators.h>\n "}, {"sha": "c85e060f0481ad4392b908b1f107e694fc75c34a", "filename": "libstdc++-v3/testsuite/23_containers/vector/requirements/version.cc", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fvector%2Frequirements%2Fversion.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fvector%2Frequirements%2Fversion.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fvector%2Frequirements%2Fversion.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -0,0 +1,10 @@\n+// { dg-options \"-std=gnu++20\" }\n+// { dg-do preprocess { target c++20 } }\n+\n+#include <version>\n+\n+#ifndef __cpp_lib_constexpr_vector\n+# error \"Feature test macro for constexpr vector is missing in <version>\"\n+#elif __cpp_lib_constexpr_vector != 201907L\n+# error \"Feature test macro for constexpr vector has wrong value in <version>\"\n+#endif"}, {"sha": "edf19960cbb4a396aed20fc504a44329767796d1", "filename": "libstdc++-v3/testsuite/29_atomics/headers/stdatomic.h/c_compat.cc", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fheaders%2Fstdatomic.h%2Fc_compat.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fheaders%2Fstdatomic.h%2Fc_compat.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fheaders%2Fstdatomic.h%2Fc_compat.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -3,6 +3,12 @@\n \n #include <stdatomic.h>\n \n+#ifndef __cpp_lib_stdatomic_h\n+# error \"Feature test macro for stdatomic.h is missing in <stdatomic.h>\"\n+#elif __cpp_lib_stdatomic_h != 202011L\n+# error \"Feature test macro for stdatomic.h has wrong value in <stdatomic.h>\"\n+#endif\n+\n #ifndef ATOMIC_BOOL_LOCK_FREE\n #error ATOMIC_BOOL_LOCK_FREE is not defined in <stdatomic.h>\n #endif"}, {"sha": "dbaf6bc59d3ea64c1e71ec7b6082e92d4defc70d", "filename": "libstdc++-v3/testsuite/29_atomics/headers/stdatomic.h/version.cc", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fheaders%2Fstdatomic.h%2Fversion.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d2f8208e9add01fe10ee56307cc79631b9995f74/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fheaders%2Fstdatomic.h%2Fversion.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F29_atomics%2Fheaders%2Fstdatomic.h%2Fversion.cc?ref=d2f8208e9add01fe10ee56307cc79631b9995f74", "patch": "@@ -0,0 +1,10 @@\n+// { dg-options \"-std=gnu++23\" }\n+// { dg-do preprocess { target c++23 } }\n+\n+#include <version>\n+\n+#ifndef __cpp_lib_stdatomic_h\n+# error \"Feature test macro for stdatomic.h is missing in <version>\"\n+#elif __cpp_lib_stdatomic_h != 202011L\n+# error \"Feature test macro for stdatomic.h has wrong value in <version>\"\n+#endif"}]}