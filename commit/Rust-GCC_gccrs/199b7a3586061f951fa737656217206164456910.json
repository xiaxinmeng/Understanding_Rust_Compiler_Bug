{"sha": "199b7a3586061f951fa737656217206164456910", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTk5YjdhMzU4NjA2MWY5NTFmYTczNzY1NjIxNzIwNjE2NDQ1NjkxMA==", "commit": {"author": {"name": "Momchil Velikov", "email": "momchil.velikov@gmail.com", "date": "2015-01-15T21:02:15Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2015-01-15T21:02:15Z"}, "message": "re PR c++/59366 (A friend function template defined in a class is found without ADL)\n\n\tPR c++/59366\n\t* name-lookup.c (pushdecl_maybe_friend_1): Hide friend functions\n\tand function templates, declared only in the class.\n\t* decl.c (duplicate_decls): Reveal hidden friend functions or\n\tfunction templates, if they are redeclared outside the class.\n\nFrom-SVN: r219689", "tree": {"sha": "b986595b92e98bfac8ddd733fa895f37db151c48", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b986595b92e98bfac8ddd733fa895f37db151c48"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/199b7a3586061f951fa737656217206164456910", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/199b7a3586061f951fa737656217206164456910", "html_url": "https://github.com/Rust-GCC/gccrs/commit/199b7a3586061f951fa737656217206164456910", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/199b7a3586061f951fa737656217206164456910/comments", "author": {"login": "momchil-velikov", "id": 5541560, "node_id": "MDQ6VXNlcjU1NDE1NjA=", "avatar_url": "https://avatars.githubusercontent.com/u/5541560?v=4", "gravatar_id": "", "url": "https://api.github.com/users/momchil-velikov", "html_url": "https://github.com/momchil-velikov", "followers_url": "https://api.github.com/users/momchil-velikov/followers", "following_url": "https://api.github.com/users/momchil-velikov/following{/other_user}", "gists_url": "https://api.github.com/users/momchil-velikov/gists{/gist_id}", "starred_url": "https://api.github.com/users/momchil-velikov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/momchil-velikov/subscriptions", "organizations_url": "https://api.github.com/users/momchil-velikov/orgs", "repos_url": "https://api.github.com/users/momchil-velikov/repos", "events_url": "https://api.github.com/users/momchil-velikov/events{/privacy}", "received_events_url": "https://api.github.com/users/momchil-velikov/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "58b59d5ee7ac732d67736bc3654b6dc6c9af9e44", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/58b59d5ee7ac732d67736bc3654b6dc6c9af9e44", "html_url": "https://github.com/Rust-GCC/gccrs/commit/58b59d5ee7ac732d67736bc3654b6dc6c9af9e44"}], "stats": {"total": 71, "additions": 55, "deletions": 16}, "files": [{"sha": "9120e07eaf97688a12dfdb1f3e49bad376d79998", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/199b7a3586061f951fa737656217206164456910/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/199b7a3586061f951fa737656217206164456910/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=199b7a3586061f951fa737656217206164456910", "patch": "@@ -1,3 +1,11 @@\n+2015-01-15  Momchil Velikov  <momchil.velikov@gmail.com>\n+\n+\tPR c++/59366\n+\t* name-lookup.c (pushdecl_maybe_friend_1): Hide friend functions\n+\tand function templates, declared only in the class.\n+\t* decl.c (duplicate_decls): Reveal hidden friend functions or\n+\tfunction templates, if they are redeclared outside the class.\n+\n 2015-01-15  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/64356"}, {"sha": "35f483363d8dce96c186e13f7ac8a5682b089302", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/199b7a3586061f951fa737656217206164456910/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/199b7a3586061f951fa737656217206164456910/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=199b7a3586061f951fa737656217206164456910", "patch": "@@ -1871,6 +1871,19 @@ duplicate_decls (tree newdecl, tree olddecl, bool newdecl_is_friend)\n   DECL_ATTRIBUTES (newdecl)\n     = (*targetm.merge_decl_attributes) (olddecl, newdecl);\n \n+  if (DECL_DECLARES_FUNCTION_P (olddecl) && DECL_DECLARES_FUNCTION_P (newdecl))\n+    {\n+      olddecl_friend = DECL_FRIEND_P (olddecl);\n+      hidden_friend = (DECL_ANTICIPATED (olddecl)\n+\t\t       && DECL_HIDDEN_FRIEND_P (olddecl)\n+\t\t       && newdecl_is_friend);\n+      if (!hidden_friend)\n+\t{\n+\t  DECL_ANTICIPATED (olddecl) = 0;\n+\t  DECL_HIDDEN_FRIEND_P (olddecl) = 0;\n+\t}\n+    }\n+\n   if (TREE_CODE (newdecl) == TEMPLATE_DECL)\n     {\n       tree old_result;\n@@ -2153,10 +2166,6 @@ duplicate_decls (tree newdecl, tree olddecl, bool newdecl_is_friend)\n       if (DECL_DECLARES_FUNCTION_P (newdecl))\n \t{\n \t  DECL_NONCONVERTING_P (newdecl) = DECL_NONCONVERTING_P (olddecl);\n-\t  olddecl_friend = DECL_FRIEND_P (olddecl);\n-\t  hidden_friend = (DECL_ANTICIPATED (olddecl)\n-\t\t\t   && DECL_HIDDEN_FRIEND_P (olddecl)\n-\t\t\t   && newdecl_is_friend);\n \t  DECL_BEFRIENDING_CLASSES (newdecl)\n \t    = chainon (DECL_BEFRIENDING_CLASSES (newdecl),\n \t\t       DECL_BEFRIENDING_CLASSES (olddecl));"}, {"sha": "ba16befa74d9d5499a4ab724d91d757ed34bf948", "filename": "gcc/cp/name-lookup.c", "status": "modified", "additions": 12, "deletions": 11, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/199b7a3586061f951fa737656217206164456910/gcc%2Fcp%2Fname-lookup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/199b7a3586061f951fa737656217206164456910/gcc%2Fcp%2Fname-lookup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.c?ref=199b7a3586061f951fa737656217206164456910", "patch": "@@ -933,7 +933,18 @@ pushdecl_maybe_friend_1 (tree x, bool is_friend)\n \t}\n \n       if (DECL_DECLARES_FUNCTION_P (t))\n-\tcheck_default_args (t);\n+\t{\n+\t  check_default_args (t);\n+\n+\t  if (is_friend && t == x && !flag_friend_injection)\n+\t    {\n+\t      /* This is a new friend declaration of a function or a\n+\t\t function template, so hide it from ordinary function\n+\t\t lookup.  */\n+\t      DECL_ANTICIPATED (t) = 1;\n+\t      DECL_HIDDEN_FRIEND_P (t) = 1;\n+\t    }\n+\t}\n \n       if (t != x || DECL_FUNCTION_TEMPLATE_P (t))\n \treturn t;\n@@ -995,16 +1006,6 @@ pushdecl_maybe_friend_1 (tree x, bool is_friend)\n \t    }\n \t}\n \n-      if (TREE_CODE (x) == FUNCTION_DECL\n-\t  && is_friend\n-\t  && !flag_friend_injection)\n-\t{\n-\t  /* This is a new declaration of a friend function, so hide\n-\t     it from ordinary function lookup.  */\n-\t  DECL_ANTICIPATED (x) = 1;\n-\t  DECL_HIDDEN_FRIEND_P (x) = 1;\n-\t}\n-\n       /* This name is new in its binding level.\n \t Install the new declaration and return it.  */\n       if (namespace_bindings_p ())"}, {"sha": "7077d5e53cb810058a72693796e8eba6262274ec", "filename": "gcc/testsuite/g++.dg/template/friend57.C", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/199b7a3586061f951fa737656217206164456910/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftemplate%2Ffriend57.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/199b7a3586061f951fa737656217206164456910/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftemplate%2Ffriend57.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftemplate%2Ffriend57.C?ref=199b7a3586061f951fa737656217206164456910", "patch": "@@ -0,0 +1,21 @@\n+// PR c++/59366\n+// { dg-do compile }\n+template<typename T> void f(T);\n+\n+struct S\n+{\n+  template<typename T> friend void f(T) {}\n+  template<typename T> friend void g(T) {}\n+  template<typename T> friend void h(T) {}\n+};\n+\n+template<typename T> void h(T);\n+\n+int\n+main ()\n+{\n+  f(1);\n+  g(1); // { dg-error \"'g' was not declared in this scope\" }\n+  g(S());\n+  h(1);\n+}"}, {"sha": "edb9d62335914d21da815469583a87d60b2baaa2", "filename": "gcc/testsuite/g++.old-deja/g++.pt/friend5.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/199b7a3586061f951fa737656217206164456910/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.pt%2Ffriend5.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/199b7a3586061f951fa737656217206164456910/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.pt%2Ffriend5.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.pt%2Ffriend5.C?ref=199b7a3586061f951fa737656217206164456910", "patch": "@@ -14,5 +14,5 @@ class C\n \n int main()\n {\n-  f(7);\n+  f(C());\n }"}]}