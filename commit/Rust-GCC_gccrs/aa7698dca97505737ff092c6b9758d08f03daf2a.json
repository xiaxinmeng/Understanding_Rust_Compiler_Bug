{"sha": "aa7698dca97505737ff092c6b9758d08f03daf2a", "node_id": "C_kwDOANBUbNoAKGFhNzY5OGRjYTk3NTA1NzM3ZmYwOTJjNmI5NzU4ZDA4ZjAzZGFmMmE", "commit": {"author": {"name": "Prajwal S N", "email": "prajwalnadig21@gmail.com", "date": "2022-12-31T07:19:02Z"}, "committer": {"name": "Prajwal S N", "email": "prajwalnadig21@gmail.com", "date": "2023-01-02T11:22:21Z"}, "message": "unsafe: check use of `target_feature` attribute\n\nThe `target_feature` attribute is for conditional compilation and may or\nmay not compile on all platforms. Using it requires an unsafe function\nor block.\n\nSigned-off-by: Prajwal S N <prajwalnadig21@gmail.com>", "tree": {"sha": "557a45ec64fa0280d34f19bc04921bedf8173792", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/557a45ec64fa0280d34f19bc04921bedf8173792"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/aa7698dca97505737ff092c6b9758d08f03daf2a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEsgjTbJBLpIP3LU620P7O4kW8JpUFAmOyvm0ACgkQ0P7O4kW8\nJpVS2RAAl8zOApopSrHfEXPDHIuteWwLeHWPQJW8iTLmb62T4hel+9dN7/3NRxnY\nN3bfuFlPcpSYDdjzMrEIBM6CAfEuMX7fnXf0Goe3jf3ZHuif453xebE2bO/tJIal\njfHeOqt3qmiKSJ9Ijcvb4+f1qX24Ej0re/tXBYViZDe7OzS9n+uNS3Vh+SzPWg3v\n0cByMaDCUnztCGVvwZ8xjVj7h1AJmYYJyByHQZuBfMeQBbp1+kzecrMTkljO2Hj2\n50dTr6dwP7SxTYdha6JKbosYc5JJ5nj8az90gAk7HIPcVv2Y85xY+hEfYpjM+cNB\nkw4AFrjI7fs7tTz07XBYre6ZVeMQ7TRyL4RJR8DcDv4Ifl669DA9V9WwXPqLSabZ\n3pPVsHvj0NtkBoUpADu7PmNdSETNJpU59jhs5Ax6ppHUNem5WoV6EU8gP/JKkkBu\nwGRWsfvXqCXf24MlkFn0O+SqOIq4n5iA3vnLwNtpYew3E8brRpQUu48YQH8WigoS\n1pJIGCGnTo+R3i5OWi1WhGwxRkEz99j3OBFzKiCYuDJ7+kIcyaH/SiQO+s0Ir+d3\nLZONAPt/ItmvASWAdtt4ejMV19UScy6eOYZd7o4oGt2cZ0wwEuIoR98w0OtXdC/9\npOyiZHTE+K/kdOsbKoEKKp0buuPCo4faON1y55Ag1R7YZRRoWnM=\n=ttqu\n-----END PGP SIGNATURE-----", "payload": "tree 557a45ec64fa0280d34f19bc04921bedf8173792\nparent 0152926ab36ba52153f3f457f6f3bb02bb274073\nauthor Prajwal S N <prajwalnadig21@gmail.com> 1672471142 +0530\ncommitter Prajwal S N <prajwalnadig21@gmail.com> 1672658541 +0530\n\nunsafe: check use of `target_feature` attribute\n\nThe `target_feature` attribute is for conditional compilation and may or\nmay not compile on all platforms. Using it requires an unsafe function\nor block.\n\nSigned-off-by: Prajwal S N <prajwalnadig21@gmail.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aa7698dca97505737ff092c6b9758d08f03daf2a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aa7698dca97505737ff092c6b9758d08f03daf2a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aa7698dca97505737ff092c6b9758d08f03daf2a/comments", "author": {"login": "snprajwal", "id": 71701859, "node_id": "MDQ6VXNlcjcxNzAxODU5", "avatar_url": "https://avatars.githubusercontent.com/u/71701859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/snprajwal", "html_url": "https://github.com/snprajwal", "followers_url": "https://api.github.com/users/snprajwal/followers", "following_url": "https://api.github.com/users/snprajwal/following{/other_user}", "gists_url": "https://api.github.com/users/snprajwal/gists{/gist_id}", "starred_url": "https://api.github.com/users/snprajwal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/snprajwal/subscriptions", "organizations_url": "https://api.github.com/users/snprajwal/orgs", "repos_url": "https://api.github.com/users/snprajwal/repos", "events_url": "https://api.github.com/users/snprajwal/events{/privacy}", "received_events_url": "https://api.github.com/users/snprajwal/received_events", "type": "User", "site_admin": false}, "committer": {"login": "snprajwal", "id": 71701859, "node_id": "MDQ6VXNlcjcxNzAxODU5", "avatar_url": "https://avatars.githubusercontent.com/u/71701859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/snprajwal", "html_url": "https://github.com/snprajwal", "followers_url": "https://api.github.com/users/snprajwal/followers", "following_url": "https://api.github.com/users/snprajwal/following{/other_user}", "gists_url": "https://api.github.com/users/snprajwal/gists{/gist_id}", "starred_url": "https://api.github.com/users/snprajwal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/snprajwal/subscriptions", "organizations_url": "https://api.github.com/users/snprajwal/orgs", "repos_url": "https://api.github.com/users/snprajwal/repos", "events_url": "https://api.github.com/users/snprajwal/events{/privacy}", "received_events_url": "https://api.github.com/users/snprajwal/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0152926ab36ba52153f3f457f6f3bb02bb274073", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0152926ab36ba52153f3f457f6f3bb02bb274073", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0152926ab36ba52153f3f457f6f3bb02bb274073"}], "stats": {"total": 45, "additions": 44, "deletions": 1}, "files": [{"sha": "f68243020b1053be669740c40f59be8bd40b5527", "filename": "gcc/rust/checks/errors/rust-unsafe-checker.cc", "status": "modified", "additions": 28, "deletions": 1, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.cc?ref=aa7698dca97505737ff092c6b9758d08f03daf2a", "patch": "@@ -179,6 +179,31 @@ UnsafeChecker::check_function_call (HirId node_id, Location locus)\n \t\t       locus);\n }\n \n+static void\n+check_target_attr (HIR::Function *fn, Location locus)\n+{\n+  if (std::any_of (fn->get_outer_attrs ().begin (),\n+\t\t   fn->get_outer_attrs ().end (),\n+\t\t   [] (const AST::Attribute &attr) {\n+\t\t     return attr.get_path ().as_string () == \"target_feature\";\n+\t\t   }))\n+    rust_error_at (locus,\n+\t\t   \"call to function with %<#[target_feature]%> requires \"\n+\t\t   \"unsafe function or block\");\n+}\n+\n+void\n+UnsafeChecker::check_function_attr (HirId node_id, Location locus)\n+{\n+  if (unsafe_context.is_in_context ())\n+    return;\n+\n+  auto maybe_fn = mappings.lookup_hir_item (node_id);\n+\n+  if (maybe_fn && maybe_fn->get_item_kind () == Item::ItemKind::Function)\n+    check_target_attr (static_cast<Function *> (maybe_fn), locus);\n+}\n+\n void\n UnsafeChecker::visit (Lifetime &)\n {}\n@@ -398,11 +423,13 @@ UnsafeChecker::visit (CallExpr &expr)\n \n   rust_assert (mappings.lookup_node_to_hir (ref_node_id, &definition_id));\n \n-  // At this point we have the function's HIR Id. There are two checks we\n+  // At this point we have the function's HIR Id. There are three checks we\n   // must perform:\n   //     1. The function is an unsafe one\n   //     2. The function is an extern one\n+  //     3. The function is marked with a target_feature attribute\n   check_function_call (definition_id, expr.get_locus ());\n+  check_function_attr (definition_id, expr.get_locus ());\n \n   if (expr.has_params ())\n     for (auto &arg : expr.get_arguments ())"}, {"sha": "540e5c33f6d51aaf57cf28c899c369b7fcd97e9b", "filename": "gcc/rust/checks/errors/rust-unsafe-checker.h", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.h?ref=aa7698dca97505737ff092c6b9758d08f03daf2a", "patch": "@@ -46,6 +46,11 @@ class UnsafeChecker : public HIRFullVisitor\n    */\n   void check_function_call (HirId node_id, Location locus);\n \n+  /**\n+   * Check if any unsafe attributes are present on a function\n+   */\n+  void check_function_attr (HirId node_id, Location locus);\n+\n   StackedContexts<HirId> unsafe_context;\n \n   Resolver::TypeCheckContext &context;"}, {"sha": "9de86db7cc10a77e4c7487ce8a4b77ad38104060", "filename": "gcc/rust/util/rust-attributes.cc", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Frust%2Futil%2Frust-attributes.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Frust%2Futil%2Frust-attributes.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Futil%2Frust-attributes.cc?ref=aa7698dca97505737ff092c6b9758d08f03daf2a", "patch": "@@ -41,6 +41,9 @@ static const BuiltinAttrDefinition __definitions[]\n      {\"repr\", CODE_GENERATION},\n      {\"path\", EXPANSION},\n      {\"macro_use\", NAME_RESOLUTION},\n+     // FIXME: This is not implemented yet, see\n+     // https://github.com/Rust-GCC/gccrs/issues/1475\n+     {\"target_feature\", CODE_GENERATION},\n      // From now on, these are reserved by the compiler and gated through\n      // #![feature(rustc_attrs)]\n      {\"rustc_inherit_overflow_checks\", CODE_GENERATION}};"}, {"sha": "c87902fcd5f169e2d23881cd72a8030671a830dd", "filename": "gcc/testsuite/rust/compile/unsafe11.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Ftestsuite%2Frust%2Fcompile%2Funsafe11.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa7698dca97505737ff092c6b9758d08f03daf2a/gcc%2Ftestsuite%2Frust%2Fcompile%2Funsafe11.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Funsafe11.rs?ref=aa7698dca97505737ff092c6b9758d08f03daf2a", "patch": "@@ -0,0 +1,8 @@\n+#[target_feature(sse)]\n+fn foo() {\n+    let a: usize = 0;\n+}\n+\n+fn main() {\n+    foo() // { dg-error \"requires unsafe function or block\" }\n+}"}]}