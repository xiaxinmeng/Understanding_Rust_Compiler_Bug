{"sha": "a634157de1e83536123412b02aae184a9d590751", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTYzNDE1N2RlMWU4MzUzNjEyMzQxMmIwMmFhZTE4NGE5ZDU5MDc1MQ==", "commit": {"author": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-05-27T13:25:18Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-05-28T09:14:44Z"}, "message": "gcc-changelog: enhance handling of renamings\n\nSo far, we expect from a commit that renames a file to contain a\nchangelog entry only for the new name. For example, after the following\ncommit:\n\n   $ git move foo bar\n   $ git commit\n\nWe expect the following changelog:\n\n   * bar: Renamed from foo.\n\nGit does not keep track of renamings, only file deletions and additions.\nThe display of patches then uses heuristics (with config-dependent\nparameters) to try to match deleted and added files in the same commit.\nIt is thus brittle to rely on this information.\n\nThis commit modifies changelog processing so that renames are considered\nas a deletion of a file plus an addition of another file. The following\nchangelog is now expected for the above example:\n\n   * foo: Move...\n   * bar: Here.\n\ncontrib/\n\n\t* gcc-changelog/git_email.py (GitEmail.__init__): Interpret file\n\trenamings as a file deletion plus a file addition.\n\t* gcc-changelog/git_repository.py (parse_git_revisions):\n\tLikewise.\n\t* gcc-changelog/test_email.py: New testcase.\n\t* gcc-changelog/test_patches.txt: New testcase.", "tree": {"sha": "83dacc81f1e29dd65201200026944480c3917813", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/83dacc81f1e29dd65201200026944480c3917813"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a634157de1e83536123412b02aae184a9d590751", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a634157de1e83536123412b02aae184a9d590751", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a634157de1e83536123412b02aae184a9d590751", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a634157de1e83536123412b02aae184a9d590751/comments", "author": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "48e872db11b27604f4993f9be8f67f40b1a40468", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/48e872db11b27604f4993f9be8f67f40b1a40468", "html_url": "https://github.com/Rust-GCC/gccrs/commit/48e872db11b27604f4993f9be8f67f40b1a40468"}], "stats": {"total": 179, "additions": 178, "deletions": 1}, "files": [{"sha": "367cf76d8ee74f8361199cf2a00a51a1581d83b9", "filename": "contrib/gcc-changelog/git_email.py", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Fgit_email.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Fgit_email.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Fgit_email.py?ref=a634157de1e83536123412b02aae184a9d590751", "patch": "@@ -50,13 +50,22 @@ def __init__(self, filename, strict=False):\n \n         modified_files = []\n         for f in diff:\n+            # Strip \"a/\" and \"b/\" prefixes\n+            source = f.source_file[2:]\n+            target = f.target_file[2:]\n+\n             if f.is_added_file:\n                 t = 'A'\n             elif f.is_removed_file:\n                 t = 'D'\n+            elif f.is_rename:\n+                # Consider that renamed files are two operations: the deletion\n+                # of the original name and the addition of the new one.\n+                modified_files.append((source, 'D'))\n+                t = 'A'\n             else:\n                 t = 'M'\n-            modified_files.append((f.path, t))\n+            modified_files.append((target, t))\n         super().__init__(None, date, author, body, modified_files,\n                          strict=strict)\n "}, {"sha": "e3b6c4d7a388eb80d59002e2d76d13e83a19ce82", "filename": "contrib/gcc-changelog/git_repository.py", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Fgit_repository.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Fgit_repository.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Fgit_repository.py?ref=a634157de1e83536123412b02aae184a9d590751", "patch": "@@ -47,6 +47,11 @@ def parse_git_revisions(repo_path, revisions, strict=False):\n                 t = 'A'\n             elif file.deleted_file:\n                 t = 'D'\n+            elif file.renamed_file:\n+                # Consider that renamed files are two operations: the deletion\n+                # of the original name and the addition of the new one.\n+                modified_files.append((file.a_path, 'D'))\n+                t = 'A'\n             else:\n                 t = 'M'\n             modified_files.append((file.b_path, t))"}, {"sha": "23372f082a09eb9de93d78662fd30d969af1e14f", "filename": "contrib/gcc-changelog/test_email.py", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Ftest_email.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Ftest_email.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Ftest_email.py?ref=a634157de1e83536123412b02aae184a9d590751", "patch": "@@ -18,13 +18,16 @@\n \n import os\n import tempfile\n+import unidiff\n import unittest\n \n from git_email import GitEmail\n \n \n script_path = os.path.dirname(os.path.realpath(__file__))\n \n+unidiff_supports_renaming = hasattr(unidiff.PatchedFile(), 'is_rename')\n+\n \n class TestGccChangelog(unittest.TestCase):\n     def setUp(self):\n@@ -295,3 +298,10 @@ def test_multiline_file_list(self):\n                     'sem_ch12.adb', 'sem_ch4.adb', 'sem_ch7.adb',\n                     'sem_ch8.adb', 'sem_elab.adb', 'sem_type.adb',\n                     'sem_util.adb'])\n+\n+    @unittest.skipIf(not unidiff_supports_renaming,\n+                     'Newer version of unidiff is needed (0.6.0+)')\n+    def test_renamed_file(self):\n+        email = self.from_patch_glob(\n+            '0001-Ada-Add-support-for-XDR-streaming-in-the-default-run.patch')\n+        assert not email.errors"}, {"sha": "cc81fcd32b864d4f581bdc48ec3270d6ecb86137", "filename": "contrib/gcc-changelog/test_patches.txt", "status": "modified", "additions": 153, "deletions": 0, "changes": 153, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Ftest_patches.txt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a634157de1e83536123412b02aae184a9d590751/contrib%2Fgcc-changelog%2Ftest_patches.txt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Ftest_patches.txt?ref=a634157de1e83536123412b02aae184a9d590751", "patch": "@@ -2741,3 +2741,156 @@ index b980b4c..c1b1d9e 100644\n -- \n 2.1.4\n \n+=== 0001-Ada-Add-support-for-XDR-streaming-in-the-default-run.patch ===\n+From ed248d9bc3b72b6888a1b9cd84a8ef26809249f0 Mon Sep 17 00:00:00 2001\n+From: Arnaud Charlet <charlet@adacore.com>\n+Date: Thu, 23 Apr 2020 05:46:29 -0400\n+Subject: [PATCH] [Ada] Add support for XDR streaming in the default runtime\n+\n+--!# FROM: /homes/derodat/tron/gnat2fsf/gnat\n+--!# COMMIT: 5ad4cabb9f70114eb61c025e91406d4fba253f95\n+--!# Change-Id: I21f92cad27933747495cdfa544a048f62f944cbd\n+--!# TN: T423-014\n+\n+Currently we provide a separate implementation of Stream_Attributes via\n+s-stratt__xdr.adb which needs to be recompiled manually.\n+\n+This change introduces instead a new binder switch to choose at bind\n+time which stream implementation to use and replaces s-stratt__xdr.adb\n+by a new unit System.Stream_Attributes.XDR.\n+\n+2020-05-04  Arnaud Charlet  <charlet@adacore.com>\n+\n+gcc/ada/\n+\n+\t* Makefile.rtl: Add s-statxd.o.\n+\t* bindgen.adb (Gen_Adainit): Add support for XDR_Stream.\n+\t* bindusg.adb (Display): Add mention of -xdr.\n+\t* gnatbind.adb: Process -xdr switch.\n+\t* init.c (__gl_xdr_stream): New.\n+\t* opt.ads (XDR_Stream): New.\n+\t* libgnat/s-stratt__xdr.adb: Rename to...\n+\t* libgnat/s-statxd.adb: this and adjust.\n+\t* libgnat/s-statxd.ads: New.\n+\t* libgnat/s-stratt.ads, libgnat/s-stratt.adb: Choose between\n+\tdefault and XDR implementation at runtime.\n+\t* libgnat/s-ststop.ads: Update comments.\n+\t* doc/gnat_rm/implementation_advice.rst: Update doc on XDR\n+\tstreaming.\n+\t* gnat_rm.texi: Regenerate.\n+---\n+ gcc/ada/Makefile.rtl                          |   1 +\n+ gcc/ada/bindgen.adb                           |  29 +-\n+ gcc/ada/bindusg.adb                           |   5 +\n+ gcc/ada/doc/gnat_rm/implementation_advice.rst |  35 +--\n+ gcc/ada/gnat_rm.texi                          |  36 +--\n+ gcc/ada/gnatbind.adb                          |   5 +\n+ gcc/ada/init.c                                |   1 +\n+ .../{s-stratt__xdr.adb => s-statxd.adb}       |  63 ++--\n+ gcc/ada/libgnat/s-statxd.ads                  | 117 +++++++\n+ gcc/ada/libgnat/s-stratt.adb                  | 286 +++++++++++++++---\n+ gcc/ada/libgnat/s-stratt.ads                  |   7 +-\n+ gcc/ada/libgnat/s-ststop.ads                  |   4 +-\n+ gcc/ada/opt.ads                               |   6 +-\n+ 13 files changed, 428 insertions(+), 167 deletions(-)\n+ rename gcc/ada/libgnat/{s-stratt__xdr.adb => s-statxd.adb} (96%)\n+ create mode 100644 gcc/ada/libgnat/s-statxd.ads\n+\n+diff --git a/gcc/ada/Makefile.rtl b/gcc/ada/Makefile.rtl\n+index b340a9ef919..15e4f68ccdb 100644\n+--- a/gcc/ada/Makefile.rtl\n++++ b/gcc/ada/Makefile.rtl\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/bindgen.adb b/gcc/ada/bindgen.adb\n+index 99ad3009d13..91b4cb38486 100644\n+--- a/gcc/ada/bindgen.adb\n++++ b/gcc/ada/bindgen.adb\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/bindusg.adb b/gcc/ada/bindusg.adb\n+index 45215d2ebea..6fd55ee8721 100644\n+--- a/gcc/ada/bindusg.adb\n++++ b/gcc/ada/bindusg.adb\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/doc/gnat_rm/implementation_advice.rst b/gcc/ada/doc/gnat_rm/implementation_advice.rst\n+index 31376d92461..998d0c597df 100644\n+--- a/gcc/ada/doc/gnat_rm/implementation_advice.rst\n++++ b/gcc/ada/doc/gnat_rm/implementation_advice.rst\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/gnat_rm.texi b/gcc/ada/gnat_rm.texi\n+index c174073d508..d72f905a2df 100644\n+--- a/gcc/ada/gnat_rm.texi\n++++ b/gcc/ada/gnat_rm.texi\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/gnatbind.adb b/gcc/ada/gnatbind.adb\n+index 4907082a42c..4372152b439 100644\n+--- a/gcc/ada/gnatbind.adb\n++++ b/gcc/ada/gnatbind.adb\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/init.c b/gcc/ada/init.c\n+index f9f627ebcff..e76aa79c5a8 100644\n+--- a/gcc/ada/init.c\n++++ b/gcc/ada/init.c\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/libgnat/s-stratt__xdr.adb b/gcc/ada/libgnat/s-statxd.adb\n+similarity index 96%\n+rename from gcc/ada/libgnat/s-stratt__xdr.adb\n+rename to gcc/ada/libgnat/s-statxd.adb\n+index 7e32fcf9b91..fcefae7e6f2 100644\n+--- a/gcc/ada/libgnat/s-stratt__xdr.adb\n++++ b/gcc/ada/libgnat/s-statxd.adb\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/libgnat/s-statxd.ads b/gcc/ada/libgnat/s-statxd.ads\n+new file mode 100644\n+index 00000000000..cca5e5471bd\n+--- /dev/null\n++++ b/gcc/ada/libgnat/s-statxd.ads\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/libgnat/s-stratt.adb b/gcc/ada/libgnat/s-stratt.adb\n+index 64f3f040081..366dabdc7b6 100644\n+--- a/gcc/ada/libgnat/s-stratt.adb\n++++ b/gcc/ada/libgnat/s-stratt.adb\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/libgnat/s-stratt.ads b/gcc/ada/libgnat/s-stratt.ads\n+index 73369490146..c8c453aad2a 100644\n+--- a/gcc/ada/libgnat/s-stratt.ads\n++++ b/gcc/ada/libgnat/s-stratt.ads\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/libgnat/s-ststop.ads b/gcc/ada/libgnat/s-ststop.ads\n+index d0da0609d9d..321460b89d8 100644\n+--- a/gcc/ada/libgnat/s-ststop.ads\n++++ b/gcc/ada/libgnat/s-ststop.ads\n+@@ -1 +1,2 @@\n+ \n++\n+diff --git a/gcc/ada/opt.ads b/gcc/ada/opt.ads\n+index 9e0263b431d..37f3d030e3f 100644\n+--- a/gcc/ada/opt.ads\n++++ b/gcc/ada/opt.ads\n+@@ -1 +1,2 @@\n+ \n++\n+-- \n+2.20.1\n+"}]}