{"sha": "6651c93e42d125b151a4a2631fbb912c8d5a986a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjY1MWM5M2U0MmQxMjViMTUxYTRhMjYzMWZiYjkxMmM4ZDVhOTg2YQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2016-03-16T07:02:30Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2016-03-16T07:02:30Z"}, "message": "re PR sanitizer/70147 (testcase from hana testsuite gets miscompiled with -fsanitize=undefined)\n\n\tPR c++/70147\n\t* cp-ubsan.c (cp_ubsan_dfs_initialize_vtbl_ptrs): Conditionalize\n\tBINFO_VIRTUAL_P vtable clearing on current_in_charge_parm.\n\n\t* g++.dg/ubsan/pr70147-2.C (C::C): Initialize A base with invalid\n\tmethod call to i () as argument.  Adjust expected output.\n\nFrom-SVN: r234249", "tree": {"sha": "c8ac5eee044e0fcaef9172effa14564e7f342f24", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c8ac5eee044e0fcaef9172effa14564e7f342f24"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6651c93e42d125b151a4a2631fbb912c8d5a986a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6651c93e42d125b151a4a2631fbb912c8d5a986a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6651c93e42d125b151a4a2631fbb912c8d5a986a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6651c93e42d125b151a4a2631fbb912c8d5a986a/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1935f2506e9d4ad4ae4aedb691e5bbd26202ba25", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1935f2506e9d4ad4ae4aedb691e5bbd26202ba25", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1935f2506e9d4ad4ae4aedb691e5bbd26202ba25"}], "stats": {"total": 36, "additions": 22, "deletions": 14}, "files": [{"sha": "b1424136a08f96995794ac7de59d4c16eeae47a0", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=6651c93e42d125b151a4a2631fbb912c8d5a986a", "patch": "@@ -1,5 +1,9 @@\n 2016-03-16  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/70147\n+\t* cp-ubsan.c (cp_ubsan_dfs_initialize_vtbl_ptrs): Conditionalize\n+\tBINFO_VIRTUAL_P vtable clearing on current_in_charge_parm.\n+\n \tPR c++/70147\n \t* cp-ubsan.c (cp_ubsan_maybe_initialize_vtbl_ptrs): Temporarily\n \tset in_base_initializer."}, {"sha": "75aeeb83e35b03eac80e1bdce18e717905171fa1", "filename": "gcc/cp/cp-ubsan.c", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Fcp%2Fcp-ubsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Fcp%2Fcp-ubsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-ubsan.c?ref=6651c93e42d125b151a4a2631fbb912c8d5a986a", "patch": "@@ -299,8 +299,14 @@ cp_ubsan_dfs_initialize_vtbl_ptrs (tree binfo, void *data)\n \n       /* Assign NULL to the vptr.  */\n       tree vtbl = build_zero_cst (TREE_TYPE (vtbl_ptr));\n-      finish_expr_stmt (cp_build_modify_expr (vtbl_ptr, NOP_EXPR, vtbl,\n-\t\t\t\t\t      tf_warning_or_error));\n+      tree stmt = cp_build_modify_expr (vtbl_ptr, NOP_EXPR, vtbl,\n+\t\t\t\t\ttf_warning_or_error);\n+      if (BINFO_VIRTUAL_P (binfo))\n+\tstmt = build3 (COND_EXPR, void_type_node,\n+\t\t       build2 (NE_EXPR, boolean_type_node,\n+\t\t\t       current_in_charge_parm, integer_zero_node),\n+\t\t       stmt, void_node);\n+      finish_expr_stmt (stmt);\n     }\n \n   return NULL_TREE;"}, {"sha": "52994ccf3317a9489633b6ae3330c3ed50cf65b0", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6651c93e42d125b151a4a2631fbb912c8d5a986a", "patch": "@@ -1,5 +1,9 @@\n 2016-03-16  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/70147\n+\t* g++.dg/ubsan/pr70147-2.C (C::C): Initialize A base with invalid\n+\tmethod call to i () as argument.  Adjust expected output.\n+\n \tPR c++/70147\n \t* g++.dg/ubsan/pr70147-1.C: New test.\n \t* g++.dg/ubsan/pr70147-2.C: New test."}, {"sha": "4e858a52d5a2fc9e74bc5262d21275d51b460cb7", "filename": "gcc/testsuite/g++.dg/ubsan/pr70147-2.C", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr70147-2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6651c93e42d125b151a4a2631fbb912c8d5a986a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr70147-2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr70147-2.C?ref=6651c93e42d125b151a4a2631fbb912c8d5a986a", "patch": "@@ -46,7 +46,7 @@ struct B : virtual A, public E, public F\n };\n struct C : B, virtual A\n {\n-  C () {}\n+  C () : A (i ()) {}\n };\n \n int\n@@ -55,28 +55,22 @@ main ()\n   C c;\n }\n \n-// { dg-output \"\\[^\\n\\r]*pr70147-2.C:33:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'E'(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"0x\\[0-9a-fA-F]*: note: object has invalid vptr(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"  ?.. .. .. ..  ?.. .. .. ..  ?.. .. .. .. \\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"              ?\\\\^~~~~~~~~~~\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"              ?invalid vptr(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"\\[^\\n\\r]*pr70147-2.C:34:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'F'(\\n|\\r\\n|\\r)\" }\n+// { dg-output \"\\[^\\n\\r]*pr70147-2.C:49:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'A'(\\n|\\r\\n|\\r)\" }\n // { dg-output \"0x\\[0-9a-fA-F]*: note: object has invalid vptr(\\n|\\r\\n|\\r)\" }\n // { dg-output \"  ?.. .. .. ..  ?.. .. .. ..  ?.. .. .. .. \\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n // { dg-output \"              ?\\\\^~~~~~~~~~~\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n // { dg-output \"              ?invalid vptr\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"\\[^\\n\\r]*pr70147-2.C:35:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'A'(\\n|\\r\\n|\\r)\" }\n+// { dg-output \"\\[^\\n\\r]*pr70147-2.C:33:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'E'(\\n|\\r\\n|\\r)\" }\n // { dg-output \"0x\\[0-9a-fA-F]*: note: object has invalid vptr(\\n|\\r\\n|\\r)\" }\n // { dg-output \"  ?.. .. .. ..  ?.. .. .. ..  ?.. .. .. .. \\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n // { dg-output \"              ?\\\\^~~~~~~~~~~\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"              ?invalid vptr\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n-// Note we don't catch the UB of calling g () on line 36.\n-// { dg-output \"\\[^\\n\\r]*pr70147-2.C:38:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'F'(\\n|\\r\\n|\\r)\" }\n+// { dg-output \"              ?invalid vptr(\\n|\\r\\n|\\r)\" }\n+// { dg-output \"\\[^\\n\\r]*pr70147-2.C:34:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'F'(\\n|\\r\\n|\\r)\" }\n // { dg-output \"0x\\[0-9a-fA-F]*: note: object has invalid vptr(\\n|\\r\\n|\\r)\" }\n // { dg-output \"  ?.. .. .. ..  ?.. .. .. ..  ?.. .. .. .. \\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n // { dg-output \"              ?\\\\^~~~~~~~~~~\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n // { dg-output \"              ?invalid vptr\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n-// { dg-output \"\\[^\\n\\r]*pr70147-2.C:39:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'A'(\\n|\\r\\n|\\r)\" }\n+// { dg-output \"\\[^\\n\\r]*pr70147-2.C:38:\\[0-9]*: runtime error: member call on address 0x\\[0-9a-fA-F]* which does not point to an object of type 'F'(\\n|\\r\\n|\\r)\" }\n // { dg-output \"0x\\[0-9a-fA-F]*: note: object has invalid vptr(\\n|\\r\\n|\\r)\" }\n // { dg-output \"  ?.. .. .. ..  ?.. .. .. ..  ?.. .. .. .. \\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }\n // { dg-output \"              ?\\\\^~~~~~~~~~~\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" }"}]}