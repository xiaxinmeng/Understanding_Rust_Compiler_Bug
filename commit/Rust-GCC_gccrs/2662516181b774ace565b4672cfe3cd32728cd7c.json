{"sha": "2662516181b774ace565b4672cfe3cd32728cd7c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjY2MjUxNjE4MWI3NzRhY2U1NjViNDY3MmNmZTNjZDMyNzI4Y2Q3Yw==", "commit": {"author": {"name": "Ilya Enkovich", "email": "ilya.enkovich@intel.com", "date": "2015-05-15T09:48:13Z"}, "committer": {"name": "Ilya Enkovich", "email": "ienkovich@gcc.gnu.org", "date": "2015-05-15T09:48:13Z"}, "message": "ipa-chkp.h (chkp_wrap_function): New.\n\ngcc/\n\n\t* ipa-chkp.h (chkp_wrap_function): New.\n\t* ipa-chkp.c (chkp_wrap_function): Remove 'static'.\n\t(chkp_wrap_function_name): New.\n\t(chkp_build_instrumented_fndecl): Use chkp_wrap_function_name\n\tto get wrapper name.\n\t* lto-cgraph.c: Include ipa-chkp.h.\n\t(input_cgraph_1): Avoid alias chain for wrappers.\n\ngcc/testsuite/\n\n\t* gcc.dg/lto/chkp-wrap-asm-name_0.c: New.\n\nFrom-SVN: r223216", "tree": {"sha": "d72c875913b9711c25ff4f0e8c52dae658108ccc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d72c875913b9711c25ff4f0e8c52dae658108ccc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2662516181b774ace565b4672cfe3cd32728cd7c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2662516181b774ace565b4672cfe3cd32728cd7c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2662516181b774ace565b4672cfe3cd32728cd7c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2662516181b774ace565b4672cfe3cd32728cd7c/comments", "author": {"login": "ienkovich", "id": 18308708, "node_id": "MDQ6VXNlcjE4MzA4NzA4", "avatar_url": "https://avatars.githubusercontent.com/u/18308708?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ienkovich", "html_url": "https://github.com/ienkovich", "followers_url": "https://api.github.com/users/ienkovich/followers", "following_url": "https://api.github.com/users/ienkovich/following{/other_user}", "gists_url": "https://api.github.com/users/ienkovich/gists{/gist_id}", "starred_url": "https://api.github.com/users/ienkovich/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ienkovich/subscriptions", "organizations_url": "https://api.github.com/users/ienkovich/orgs", "repos_url": "https://api.github.com/users/ienkovich/repos", "events_url": "https://api.github.com/users/ienkovich/events{/privacy}", "received_events_url": "https://api.github.com/users/ienkovich/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "2c1f37b57aa599b80d3be5feb8be12db1f6441c6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2c1f37b57aa599b80d3be5feb8be12db1f6441c6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2c1f37b57aa599b80d3be5feb8be12db1f6441c6"}], "stats": {"total": 99, "additions": 91, "deletions": 8}, "files": [{"sha": "c757522646c47969939815cef1a4e494df276fa0", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=2662516181b774ace565b4672cfe3cd32728cd7c", "patch": "@@ -1,3 +1,13 @@\n+2015-05-15  Ilya Enkovich  <ilya.enkovich@intel.com>\n+\n+\t* ipa-chkp.h (chkp_wrap_function): New.\n+\t* ipa-chkp.c (chkp_wrap_function): Remove 'static'.\n+\t(chkp_wrap_function_name): New.\n+\t(chkp_build_instrumented_fndecl): Use chkp_wrap_function_name\n+\tto get wrapper name.\n+\t* lto-cgraph.c: Include ipa-chkp.h.\n+\t(input_cgraph_1): Avoid alias chain for wrappers.\n+\n 2015-05-15  Ilya Enkovich  <enkovich.gnu@gmail.com>\n \n \tPR middle-end/66134"}, {"sha": "ac5eb358a9545fa2ba94d3d45b80956a111fdccd", "filename": "gcc/ipa-chkp.c", "status": "modified", "additions": 48, "deletions": 4, "changes": 52, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Fipa-chkp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Fipa-chkp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-chkp.c?ref=2662516181b774ace565b4672cfe3cd32728cd7c", "patch": "@@ -104,7 +104,7 @@ along with GCC; see the file COPYING3.  If not see\n \n /* Return 1 calls to FNDECL should be replaced with\n    a call to wrapper function.  */\n-static bool\n+bool\n chkp_wrap_function (tree fndecl)\n {\n   if (!flag_chkp_use_wrappers)\n@@ -139,6 +139,51 @@ chkp_wrap_function (tree fndecl)\n   return false;\n }\n \n+static const char *\n+chkp_wrap_function_name (tree fndecl)\n+{\n+  gcc_assert (DECL_BUILT_IN_CLASS (fndecl) == BUILT_IN_NORMAL);\n+\n+  switch (DECL_FUNCTION_CODE (fndecl))\n+    {\n+    case BUILT_IN_STRLEN:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"strlen\";\n+    case BUILT_IN_STRCPY:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"strcpy\";\n+    case BUILT_IN_STRNCPY:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"strncpy\";\n+    case BUILT_IN_STPCPY:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"stpcpy\";\n+    case BUILT_IN_STPNCPY:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"stpncpy\";\n+    case BUILT_IN_STRCAT:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"strcat\";\n+    case BUILT_IN_STRNCAT:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"strncat\";\n+    case BUILT_IN_MEMCPY:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"memcpy\";\n+    case BUILT_IN_MEMPCPY:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"mempcpy\";\n+    case BUILT_IN_MEMSET:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"memset\";\n+    case BUILT_IN_MEMMOVE:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"memmove\";\n+    case BUILT_IN_BZERO:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"bzero\";\n+    case BUILT_IN_MALLOC:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"malloc\";\n+    case BUILT_IN_CALLOC:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"calloc\";\n+    case BUILT_IN_REALLOC:\n+      return CHKP_WRAPPER_SYMBOL_PREFIX \"realloc\";\n+\n+    default:\n+      gcc_unreachable ();\n+    }\n+\n+  return \"\";\n+}\n+\n /* Build a clone of FNDECL with a modified name.  */\n \n static tree\n@@ -164,9 +209,8 @@ chkp_build_instrumented_fndecl (tree fndecl)\n      instrumented version.  */\n   if (chkp_wrap_function(fndecl))\n     {\n-      s = CHKP_WRAPPER_SYMBOL_PREFIX;\n-      s += IDENTIFIER_POINTER (DECL_ASSEMBLER_NAME (fndecl));\n-      new_name = get_identifier (s.c_str ());\n+      new_name = get_identifier (chkp_wrap_function_name (fndecl));\n+      DECL_VISIBILITY (new_decl) = VISIBILITY_DEFAULT;\n     }\n   else\n     {"}, {"sha": "547487ea6bc27cde71856a33727d152231f16097", "filename": "gcc/ipa-chkp.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Fipa-chkp.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Fipa-chkp.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-chkp.h?ref=2662516181b774ace565b4672cfe3cd32728cd7c", "patch": "@@ -24,5 +24,6 @@ extern tree chkp_copy_function_type_adding_bounds (tree orig_type);\n extern tree chkp_maybe_clone_builtin_fndecl (tree fndecl);\n extern cgraph_node *chkp_maybe_create_clone (tree fndecl);\n extern bool chkp_instrumentable_p (tree fndecl);\n+extern bool chkp_wrap_function (tree fndecl);\n \n #endif /* GCC_IPA_CHKP_H */"}, {"sha": "b306c28d37bdcdfb51bf561471fd99777e7e42d5", "filename": "gcc/lto-cgraph.c", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Flto-cgraph.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Flto-cgraph.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-cgraph.c?ref=2662516181b774ace565b4672cfe3cd32728cd7c", "patch": "@@ -80,6 +80,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"pass_manager.h\"\n #include \"ipa-utils.h\"\n #include \"omp-low.h\"\n+#include \"ipa-chkp.h\"\n \n /* True when asm nodes has been output.  */\n bool asm_nodes_output = false;\n@@ -1616,10 +1617,13 @@ input_cgraph_1 (struct lto_file_decl_data *file_data,\n \t\t    cnode->instrumented_version->instrumented_version = cnode;\n \t\t}\n \n-\t      /* Restore decl names reference.  */\n-\t      IDENTIFIER_TRANSPARENT_ALIAS (DECL_ASSEMBLER_NAME (cnode->decl)) = 1;\n-\t      TREE_CHAIN (DECL_ASSEMBLER_NAME (cnode->decl))\n-\t\t  = DECL_ASSEMBLER_NAME (cnode->orig_decl);\n+\t      /* Restore decl names reference except for wrapper functions.  */\n+\t      if (!chkp_wrap_function (cnode->orig_decl))\n+\t\t{\n+\t\t  tree name = DECL_ASSEMBLER_NAME (cnode->decl);\n+\t\t  IDENTIFIER_TRANSPARENT_ALIAS (name) = 1;\n+\t\t  TREE_CHAIN (name) = DECL_ASSEMBLER_NAME (cnode->orig_decl);\n+\t\t}\n \t    }\n \t}\n "}, {"sha": "a9361067c5ad3e9442645fe135e891c8678f75a3", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=2662516181b774ace565b4672cfe3cd32728cd7c", "patch": "@@ -1,3 +1,7 @@\n+2015-05-15  Ilya Enkovich  <ilya.enkovich@intel.com>\n+\n+\t* gcc.dg/lto/chkp-wrap-asm-name_0.c: New.\n+\n 2015-05-15  Ilya Enkovich  <enkovich.gnu@gmail.com>\n \n \tPR middle-end/66134"}, {"sha": "6611bdb825c2180c28288fb8809e77530091b6d1", "filename": "gcc/testsuite/gcc.dg/lto/chkp-wrap-asm-name_0.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Ftestsuite%2Fgcc.dg%2Flto%2Fchkp-wrap-asm-name_0.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2662516181b774ace565b4672cfe3cd32728cd7c/gcc%2Ftestsuite%2Fgcc.dg%2Flto%2Fchkp-wrap-asm-name_0.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Flto%2Fchkp-wrap-asm-name_0.c?ref=2662516181b774ace565b4672cfe3cd32728cd7c", "patch": "@@ -0,0 +1,20 @@\n+/* { dg-lto-do link } */\n+/* { dg-require-effective-target mpx } */\n+/* { dg-lto-options { { -O2 -flto -fcheck-pointer-bounds -mmpx } } } */\n+\n+typedef long unsigned int size_t;\n+\n+extern size_t strlen (const char *);\n+extern __typeof (strlen) strlen __asm__ (\"\" \"__hidden_strlen\") __attribute__ ((visibility (\"hidden\")));\n+\n+size_t\n+test1 (const char *p) { return strlen (p); }\n+\n+size_t\n+test2 (const char *p) { return __builtin_strlen (p); }\n+\n+int\n+main (int argc, const char **argv)\n+{\n+  return test1 (argv[0]) - test2 (argv[0]);\n+}"}]}