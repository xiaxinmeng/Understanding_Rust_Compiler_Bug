{"sha": "9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWIzZGQwMDFkNTI0MjFiNjhhYWY1ODEwMThmZjJiZGY1YjVhYzVlMA==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2014-10-26T10:41:22Z"}, "committer": {"name": "Richard Sandiford", "email": "rsandifo@gcc.gnu.org", "date": "2014-10-26T10:41:22Z"}, "message": "mips.c (mips16_rewrite_pool_refs_info): Delete.\n\ngcc/\n\t* config/mips/mips.c (mips16_rewrite_pool_refs_info): Delete.\n\t(mips16_rewrite_pool_refs): Take the insn and constant pool as\n\tparameters.  Iterate over the instruction's pattern and return void.\n\t(mips16_lay_out_constants): Update accordingly.\n\nFrom-SVN: r216710", "tree": {"sha": "83a59f0239f76c15a1294f95206d250390db55fd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/83a59f0239f76c15a1294f95206d250390db55fd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "eacbf7bd8c60a2a5c8021b9e9687d5c829eaa6e8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eacbf7bd8c60a2a5c8021b9e9687d5c829eaa6e8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/eacbf7bd8c60a2a5c8021b9e9687d5c829eaa6e8"}], "stats": {"total": 75, "additions": 36, "deletions": 39}, "files": [{"sha": "a903abf060c37092868219c30f7f56ec8a42f6e1", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0", "patch": "@@ -1,3 +1,10 @@\n+2014-10-26  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\t* config/mips/mips.c (mips16_rewrite_pool_refs_info): Delete.\n+\t(mips16_rewrite_pool_refs): Take the insn and constant pool as\n+\tparameters.  Iterate over the instruction's pattern and return void.\n+\t(mips16_lay_out_constants): Update accordingly.\n+\n 2014-10-26  Richard Sandiford  <richard.sandiford@arm.com>\n \n \t* config/mips/mips.c (mips_kernel_reg_p): Replace with..."}, {"sha": "c3a981fb5c1e29aa88036986a6d66115f6f6b3c4", "filename": "gcc/config/mips/mips.c", "status": "modified", "additions": 29, "deletions": 39, "changes": 68, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0/gcc%2Fconfig%2Fmips%2Fmips.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0/gcc%2Fconfig%2Fmips%2Fmips.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fmips%2Fmips.c?ref=9b3dd001d52421b68aaf581018ff2bdf5b5ac5e0", "patch": "@@ -14778,44 +14778,39 @@ mips16_rewrite_pool_constant (struct mips16_constant_pool *pool, rtx *x)\n     }\n }\n \n-/* This structure is used to communicate with mips16_rewrite_pool_refs.\n-   INSN is the instruction we're rewriting and POOL points to the current\n-   constant pool.  */\n-struct mips16_rewrite_pool_refs_info {\n-  rtx_insn *insn;\n-  struct mips16_constant_pool *pool;\n-};\n+/* Rewrite INSN so that constant pool references refer to the constant's\n+   label instead.  */\n \n-/* Rewrite *X so that constant pool references refer to the constant's\n-   label instead.  DATA points to a mips16_rewrite_pool_refs_info\n-   structure.  */\n-\n-static int\n-mips16_rewrite_pool_refs (rtx *x, void *data)\n+static void\n+mips16_rewrite_pool_refs (rtx_insn *insn, struct mips16_constant_pool *pool)\n {\n-  struct mips16_rewrite_pool_refs_info *info =\n-    (struct mips16_rewrite_pool_refs_info *) data;\n-\n-  if (force_to_mem_operand (*x, Pmode))\n-    {\n-      rtx mem = force_const_mem (GET_MODE (*x), *x);\n-      validate_change (info->insn, x, mem, false);\n-    }\n-\n-  if (MEM_P (*x))\n+  subrtx_ptr_iterator::array_type array;\n+  FOR_EACH_SUBRTX_PTR (iter, array, &PATTERN (insn), ALL)\n     {\n-      mips16_rewrite_pool_constant (info->pool, &XEXP (*x, 0));\n-      return -1;\n-    }\n-\n-  /* Don't rewrite the __mips16_rdwr symbol.  */\n-  if (GET_CODE (*x) == UNSPEC && XINT (*x, 1) == UNSPEC_TLS_GET_TP)\n-    return -1;\n+      rtx *loc = *iter;\n \n-  if (TARGET_MIPS16_TEXT_LOADS)\n-    mips16_rewrite_pool_constant (info->pool, x);\n+      if (force_to_mem_operand (*loc, Pmode))\n+\t{\n+\t  rtx mem = force_const_mem (GET_MODE (*loc), *loc);\n+\t  validate_change (insn, loc, mem, false);\n+\t}\n \n-  return GET_CODE (*x) == CONST ? -1 : 0;\n+      if (MEM_P (*loc))\n+\t{\n+\t  mips16_rewrite_pool_constant (pool, &XEXP (*loc, 0));\n+\t  iter.skip_subrtxes ();\n+\t}\n+      else\n+\t{\n+\t  if (TARGET_MIPS16_TEXT_LOADS)\n+\t    mips16_rewrite_pool_constant (pool, loc);\n+\t  if (GET_CODE (*loc) == CONST\n+\t      /* Don't rewrite the __mips16_rdwr symbol.  */\n+\t      || (GET_CODE (*loc) == UNSPEC\n+\t\t  && XINT (*loc, 1) == UNSPEC_TLS_GET_TP))\n+\t    iter.skip_subrtxes ();\n+\t}\n+    }\n }\n \n /* Return whether CFG is used in mips_reorg.  */\n@@ -14834,7 +14829,6 @@ static void\n mips16_lay_out_constants (bool split_p)\n {\n   struct mips16_constant_pool pool;\n-  struct mips16_rewrite_pool_refs_info info;\n   rtx_insn *insn, *barrier;\n \n   if (!TARGET_MIPS16_PCREL_LOADS)\n@@ -14853,11 +14847,7 @@ mips16_lay_out_constants (bool split_p)\n     {\n       /* Rewrite constant pool references in INSN.  */\n       if (USEFUL_INSN_P (insn))\n-\t{\n-\t  info.insn = insn;\n-\t  info.pool = &pool;\n-\t  for_each_rtx (&PATTERN (insn), mips16_rewrite_pool_refs, &info);\n-\t}\n+\tmips16_rewrite_pool_refs (insn, &pool);\n \n       pool.insn_address += mips16_insn_length (insn);\n "}]}