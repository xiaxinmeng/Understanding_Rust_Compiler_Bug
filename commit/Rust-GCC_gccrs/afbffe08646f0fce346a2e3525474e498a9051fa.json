{"sha": "afbffe08646f0fce346a2e3525474e498a9051fa", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWZiZmZlMDg2NDZmMGZjZTM0NmEyZTM1MjU0NzRlNDk4YTkwNTFmYQ==", "commit": {"author": {"name": "Alexandre Oliva", "email": "oliva@adacore.com", "date": "2020-02-21T01:09:03Z"}, "committer": {"name": "Alexandre Oliva", "email": "oliva@gnu.org", "date": "2020-02-21T01:09:03Z"}, "message": "Allow CONFIG_SHELL to override build-time shell in mkheaders\n\nmkheaders.in uses substitutions of @SHELL@ to run fixinc.sh and\nmkinstalldirs.  Problem is, SHELL comes from CONFIG_SHELL for the\nbuild system, and it needs not match whatever is available at an\nunrelated host system after installation, when mkheaders is supposed\nto be run.\n\nI considered ditching the hardcoding altogether, but decided to retain\nit, but allowing CONFIG_SHELL and SHELL to override it, if any of them\ncan successfully run mkinstalldirs, and if those and the substituted\n@SHELL@ fail, fallback to /bin/sh and to plain execution of the\nscript, which appears to enable at least one shell on a system that\ndoesn't typicall have a shell to recognize a script by #!/bin/sh and\nreinvoke itself to run it.\n\nIf all of these fail, we fail, but only after telling the user to\nretry after setting CONFIG_SHELL, that fixincl itself also uses.\n\n\nfor  fixincludes/ChangeLog\n\n\t* mkheaders.in: Don't require build-time shell on host.", "tree": {"sha": "adb195723823f4b6962d44e06fe6175c4aca54f5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/adb195723823f4b6962d44e06fe6175c4aca54f5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/afbffe08646f0fce346a2e3525474e498a9051fa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/afbffe08646f0fce346a2e3525474e498a9051fa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/afbffe08646f0fce346a2e3525474e498a9051fa", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/afbffe08646f0fce346a2e3525474e498a9051fa/comments", "author": null, "committer": null, "parents": [{"sha": "33fe984aca4d12013bbd5921eee393c66dc1cfaa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/33fe984aca4d12013bbd5921eee393c66dc1cfaa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/33fe984aca4d12013bbd5921eee393c66dc1cfaa"}], "stats": {"total": 26, "additions": 24, "deletions": 2}, "files": [{"sha": "3f93053e121a5d268b338ca4ed677fe73ace41cc", "filename": "fixincludes/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/afbffe08646f0fce346a2e3525474e498a9051fa/fixincludes%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/afbffe08646f0fce346a2e3525474e498a9051fa/fixincludes%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/fixincludes%2FChangeLog?ref=afbffe08646f0fce346a2e3525474e498a9051fa", "patch": "@@ -1,3 +1,7 @@\n+2020-02-20  Alexandre Oliva <oliva@adacore.com>\n+\n+\t* mkheaders.in: Don't require build-time shell on host.\n+\n 2020-02-13  Matheus Castanho  <msc@linux.ibm.com>\n \n \t* fixinc.in: Skip machine_name fix on powerpc*-*-linux*."}, {"sha": "4109dc633dde5a03d541c9bd6d9eb619d6186c5f", "filename": "fixincludes/mkheaders.in", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/afbffe08646f0fce346a2e3525474e498a9051fa/fixincludes%2Fmkheaders.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/afbffe08646f0fce346a2e3525474e498a9051fa/fixincludes%2Fmkheaders.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/fixincludes%2Fmkheaders.in?ref=afbffe08646f0fce346a2e3525474e498a9051fa", "patch": "@@ -77,11 +77,29 @@ libexecsubdir=${libexecdir}/gcc/${target_noncanonical}/${version}\n itoolsdir=${libexecsubdir}/install-tools\n itoolsdatadir=${libsubdir}/install-tools\n incdir=${libsubdir}/include-fixed\n-mkinstalldirs=\"@SHELL@ ${itoolsdir}/mkinstalldirs\"\n+mkinstalldirs=\"${itoolsdir}/mkinstalldirs\"\n \n cd ${itoolsdir}\n rm -rf ${incdir}/*\n \n+for shell in $CONFIG_SHELL $SHELL @SHELL@ /bin/sh \"\"; do\n+  if { test -x $shell || test -x $shell.exe; } \\\n+  && $shell $mkinstalldirs > /dev/null 2>&1; then\n+    mkinstalldirs=\"$shell $mkinstalldirs\"\n+    break\n+  elif test x$shell = x; then\n+    if $mkinstalldirs > /dev/null 2>&1; then\n+      break\n+    elif test ! -f $mkinstalldirs; then\n+      echo mkheaders: could not find $mkinstalldirs >&2\n+      exit 1\n+    else\n+      echo mkheaders: please rerun with CONFIG_SHELL set to a working Bourne shell >&2\n+      exit 1\n+    fi\n+  fi\n+done\n+\n for ml in `cat ${itoolsdatadir}/fixinc_list`; do\n   sysroot_headers_suffix=`echo ${ml} | sed -e 's/;.*$//'`\n   multi_dir=`echo ${ml} | sed -e 's/^[^;]*;//'`\n@@ -91,7 +109,7 @@ for ml in `cat ${itoolsdatadir}/fixinc_list`; do\n   if [ x${STMP_FIXINC} != x ] ; then\n \tTARGET_MACHINE=\"${target}\" target_canonical=\"${target}\" \\\n \t    MACRO_LIST=\"${itoolsdatadir}/macro_list\" \\\n-\t    @SHELL@ ./fixinc.sh ${subincdir} \\\n+\t    $shell ./fixinc.sh ${subincdir} \\\n \t    ${isysroot}${SYSTEM_HEADER_DIR} ${OTHER_FIXINCLUDES_DIRS}\n \trm -f ${subincdir}/syslimits.h\n \tif [ -f ${subincdir}/limits.h ]; then"}]}