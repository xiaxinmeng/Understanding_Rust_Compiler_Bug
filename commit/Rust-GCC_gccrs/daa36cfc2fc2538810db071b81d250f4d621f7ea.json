{"sha": "daa36cfc2fc2538810db071b81d250f4d621f7ea", "node_id": "C_kwDOANBUbNoAKGRhYTM2Y2ZjMmZjMjUzODgxMGRiMDcxYjgxZDI1MGY0ZDYyMWY3ZWE", "commit": {"author": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-07-19T15:04:30Z"}, "committer": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-07-20T13:12:34Z"}, "message": "Avoid registering __builtin_setjmp_receiver label twice [PR101347]\n\nThe testcase in the PR demonstrates how it is possible for one\n__builtin_setjmp_receiver label to appear in\nnonlocal_goto_handler_labels list twice (after the block with\n__builtin_setjmp_setup referring to it was duplicated).\n\nremove_node_from_insn_list did not account for this possibility and\nremoved only the first copy from the list. Add an assert verifying that\nduplicates are not present.\n\nTo avoid adding a label to the list twice, move registration of the\nlabel from __builtin_setjmp_setup handling to __builtin_setjmp_receiver.\n\ngcc/ChangeLog:\n\n\tPR rtl-optimization/101347\n\t* builtins.cc (expand_builtin) [BUILT_IN_SETJMP_SETUP]: Move\n\tpopulation of nonlocal_goto_handler_labels from here ...\n\t(expand_builtin) [BUILT_IN_SETJMP_RECEIVER]: ... to here.\n\t* rtlanal.cc (remove_node_from_insn_list): Verify that a\n\tduplicate is not present in the remainder of the list.", "tree": {"sha": "a78721af7760c9278ccf5993944f08ed0b22ee07", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a78721af7760c9278ccf5993944f08ed0b22ee07"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/daa36cfc2fc2538810db071b81d250f4d621f7ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/daa36cfc2fc2538810db071b81d250f4d621f7ea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/daa36cfc2fc2538810db071b81d250f4d621f7ea", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/daa36cfc2fc2538810db071b81d250f4d621f7ea/comments", "author": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8694390e2b6ae3af3212f1c829e62fb086cf7707", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8694390e2b6ae3af3212f1c829e62fb086cf7707", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8694390e2b6ae3af3212f1c829e62fb086cf7707"}], "stats": {"total": 16, "additions": 8, "deletions": 8}, "files": [{"sha": "b08b4365da36ba34fbceca2b94d99b2bb58c9e32", "filename": "gcc/builtins.cc", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/daa36cfc2fc2538810db071b81d250f4d621f7ea/gcc%2Fbuiltins.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/daa36cfc2fc2538810db071b81d250f4d621f7ea/gcc%2Fbuiltins.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fbuiltins.cc?ref=daa36cfc2fc2538810db071b81d250f4d621f7ea", "patch": "@@ -7472,15 +7472,7 @@ expand_builtin (tree exp, rtx target, rtx subtarget, machine_mode mode,\n \t  tree label = TREE_OPERAND (CALL_EXPR_ARG (exp, 1), 0);\n \t  rtx_insn *label_r = label_rtx (label);\n \n-\t  /* This is copied from the handling of non-local gotos.  */\n \t  expand_builtin_setjmp_setup (buf_addr, label_r);\n-\t  nonlocal_goto_handler_labels\n-\t    = gen_rtx_INSN_LIST (VOIDmode, label_r,\n-\t\t\t\t nonlocal_goto_handler_labels);\n-\t  /* ??? Do not let expand_label treat us as such since we would\n-\t     not want to be both on the list of non-local labels and on\n-\t     the list of forced labels.  */\n-\t  FORCED_LABEL (label) = 0;\n \t  return const0_rtx;\n \t}\n       break;\n@@ -7493,6 +7485,13 @@ expand_builtin (tree exp, rtx target, rtx subtarget, machine_mode mode,\n \t  rtx_insn *label_r = label_rtx (label);\n \n \t  expand_builtin_setjmp_receiver (label_r);\n+\t  nonlocal_goto_handler_labels\n+\t    = gen_rtx_INSN_LIST (VOIDmode, label_r,\n+\t\t\t\t nonlocal_goto_handler_labels);\n+\t  /* ??? Do not let expand_label treat us as such since we would\n+\t     not want to be both on the list of non-local labels and on\n+\t     the list of forced labels.  */\n+\t  FORCED_LABEL (label) = 0;\n \t  return const0_rtx;\n \t}\n       break;"}, {"sha": "56da7435a283682359580a4d822183937a0205d7", "filename": "gcc/rtlanal.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/daa36cfc2fc2538810db071b81d250f4d621f7ea/gcc%2Frtlanal.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/daa36cfc2fc2538810db071b81d250f4d621f7ea/gcc%2Frtlanal.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frtlanal.cc?ref=daa36cfc2fc2538810db071b81d250f4d621f7ea", "patch": "@@ -2899,6 +2899,7 @@ remove_node_from_insn_list (const rtx_insn *node, rtx_insn_list **listp)\n \t  else\n \t    *listp = temp->next ();\n \n+\t  gcc_checking_assert (!in_insn_list_p (temp->next (), node));\n \t  return;\n \t}\n "}]}