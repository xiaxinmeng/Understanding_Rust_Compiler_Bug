{"sha": "80d6ca01843d2119c913e3adf27d20204846072f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODBkNmNhMDE4NDNkMjExOWM5MTNlM2FkZjI3ZDIwMjA0ODQ2MDcyZg==", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2019-02-28T20:31:36Z"}, "committer": {"name": "Thomas Schwinge", "email": "tschwinge@gcc.gnu.org", "date": "2019-02-28T20:31:36Z"}, "message": "[PR72741, PR89433] Repeated use of the Fortran OpenACC 'routine' directive\n\n\tgcc/fortran/\n\tPR fortran/72741\n\tPR fortran/89433\n\t* openmp.c (gfc_match_oacc_routine): Handle repeated use of the\n\tFortran OpenACC 'routine' directive.\n\tgcc/testsuite/\n\tPR fortran/72741\n\tPR fortran/89433\n\t* gfortran.dg/goacc/routine-multiple-directives-1.f90: New file.\n\t* gfortran.dg/goacc/routine-multiple-directives-2.f90: Likewise.\n\nCo-Authored-By: Cesar Philippidis <cesar@codesourcery.com>\n\nFrom-SVN: r269287", "tree": {"sha": "c1472e54a6fb1e359f39c9dfb1aa8c53d2fdfa2a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c1472e54a6fb1e359f39c9dfb1aa8c53d2fdfa2a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/80d6ca01843d2119c913e3adf27d20204846072f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/80d6ca01843d2119c913e3adf27d20204846072f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/80d6ca01843d2119c913e3adf27d20204846072f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/80d6ca01843d2119c913e3adf27d20204846072f/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "e5fd6684b9577e822997ceedabfeaa7d61722fe2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e5fd6684b9577e822997ceedabfeaa7d61722fe2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e5fd6684b9577e822997ceedabfeaa7d61722fe2"}], "stats": {"total": 193, "additions": 185, "deletions": 8}, "files": [{"sha": "6adb90aa4c0183211aeb0ba2b16755cb098ae3ea", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=80d6ca01843d2119c913e3adf27d20204846072f", "patch": "@@ -1,6 +1,11 @@\n 2019-02-28  Thomas Schwinge  <thomas@codesourcery.com>\n \t    Cesar Philippidis  <cesar@codesourcery.com>\n \n+\tPR fortran/72741\n+\tPR fortran/89433\n+\t* openmp.c (gfc_match_oacc_routine): Handle repeated use of the\n+\tFortran OpenACC 'routine' directive.\n+\n \tPR fortran/72741\n \t* gfortran.h (enum oacc_routine_lop): Add OACC_ROUTINE_LOP_ERROR.\n \t* openmp.c (gfc_oacc_routine_lop, gfc_match_oacc_routine): Use it."}, {"sha": "7a06eb58f5cf5e030b2f9f6792eff62cf27284f7", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 35, "deletions": 8, "changes": 43, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=80d6ca01843d2119c913e3adf27d20204846072f", "patch": "@@ -2374,17 +2374,44 @@ gfc_match_oacc_routine (void)\n     }\n   else if (sym != NULL)\n     {\n-      n = gfc_get_oacc_routine_name ();\n-      n->sym = sym;\n-      n->clauses = NULL;\n-      n->next = NULL;\n-      if (gfc_current_ns->oacc_routine_names != NULL)\n-\tn->next = gfc_current_ns->oacc_routine_names;\n-\n-      gfc_current_ns->oacc_routine_names = n;\n+      bool add = true;\n+\n+      /* For a repeated OpenACC 'routine' directive, diagnose if it doesn't\n+\t match the first one.  */\n+      for (gfc_oacc_routine_name *n_p = gfc_current_ns->oacc_routine_names;\n+\t   n_p;\n+\t   n_p = n_p->next)\n+\tif (n_p->sym == sym)\n+\t  {\n+\t    add = false;\n+\t    if (lop != gfc_oacc_routine_lop (n_p->clauses))\n+\t      {\n+\t\tgfc_error (\"!$ACC ROUTINE already applied at %C\");\n+\t\tgoto cleanup;\n+\t      }\n+\t  }\n+\n+      if (add)\n+\t{\n+\t  n = gfc_get_oacc_routine_name ();\n+\t  n->sym = sym;\n+\t  n->clauses = c;\n+\t  n->next = gfc_current_ns->oacc_routine_names;\n+\t  gfc_current_ns->oacc_routine_names = n;\n+\t}\n     }\n   else if (gfc_current_ns->proc_name)\n     {\n+      /* For a repeated OpenACC 'routine' directive, diagnose if it doesn't\n+\t match the first one.  */\n+      oacc_routine_lop lop_p = gfc_current_ns->proc_name->attr.oacc_routine_lop;\n+      if (lop_p != OACC_ROUTINE_LOP_NONE\n+\t  && lop != lop_p)\n+\t{\n+\t  gfc_error (\"!$ACC ROUTINE already applied at %C\");\n+\t  goto cleanup;\n+\t}\n+\n       if (!gfc_add_omp_declare_target (&gfc_current_ns->proc_name->attr,\n \t\t\t\t       gfc_current_ns->proc_name->name,\n \t\t\t\t       &old_loc))"}, {"sha": "8a36b1f802e14208ac8851602d8c20009086d7dc", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=80d6ca01843d2119c913e3adf27d20204846072f", "patch": "@@ -1,6 +1,11 @@\n 2019-02-28  Thomas Schwinge  <thomas@codesourcery.com>\n \t    Cesar Philippidis  <cesar@codesourcery.com>\n \n+\tPR fortran/72741\n+\tPR fortran/89433\n+\t* gfortran.dg/goacc/routine-multiple-directives-1.f90: New file.\n+\t* gfortran.dg/goacc/routine-multiple-directives-2.f90: Likewise.\n+\n \tPR fortran/72741\n \t* gfortran.dg/goacc/routine-multiple-lop-clauses-1.f90: New file.\n "}, {"sha": "6e12ee92155c658d6a107d3790036276bc27dec2", "filename": "gcc/testsuite/gfortran.dg/goacc/routine-multiple-directives-1.f90", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-directives-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-directives-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-directives-1.f90?ref=80d6ca01843d2119c913e3adf27d20204846072f", "patch": "@@ -0,0 +1,58 @@\n+! Check for valid cases of multiple OpenACC 'routine' directives.\n+\n+      SUBROUTINE s_1\n+!$ACC ROUTINE(s_1)\n+!$ACC ROUTINE(s_1) SEQ\n+!$ACC ROUTINE SEQ\n+      END SUBROUTINE s_1\n+\n+      SUBROUTINE s_2\n+!$ACC ROUTINE\n+!$ACC ROUTINE SEQ\n+!$ACC ROUTINE(s_2)\n+      END SUBROUTINE s_2\n+\n+      SUBROUTINE v_1\n+!$ACC ROUTINE VECTOR\n+!$ACC ROUTINE VECTOR\n+!$ACC ROUTINE(v_1) VECTOR\n+!$ACC ROUTINE VECTOR\n+      END SUBROUTINE v_1\n+\n+      SUBROUTINE v_2\n+!$ACC ROUTINE(v_2) VECTOR\n+!$ACC ROUTINE VECTOR\n+!$ACC ROUTINE(v_2) VECTOR\n+      END SUBROUTINE v_2\n+\n+      SUBROUTINE sub_1\n+      IMPLICIT NONE\n+      EXTERNAL :: g_1\n+!$ACC ROUTINE (g_1) GANG\n+!$ACC ROUTINE (g_1) GANG\n+!$ACC ROUTINE (g_1) GANG\n+\n+      CALL s_1\n+      CALL s_2\n+      CALL v_1\n+      CALL v_2\n+      CALL g_1\n+      CALL ABORT\n+      END SUBROUTINE sub_1\n+\n+      MODULE m_w_1\n+      IMPLICIT NONE\n+      EXTERNAL :: w_1\n+!$ACC ROUTINE (w_1) WORKER\n+!$ACC ROUTINE (w_1) WORKER\n+\n+      CONTAINS\n+      SUBROUTINE sub_2\n+      CALL s_1\n+      CALL s_2\n+      CALL v_1\n+      CALL v_2\n+      CALL w_1\n+      CALL ABORT\n+      END SUBROUTINE sub_2\n+      END MODULE m_w_1"}, {"sha": "54365ae3f4eb1e5d2c4dc3ca904645f97ab573c0", "filename": "gcc/testsuite/gfortran.dg/goacc/routine-multiple-directives-2.f90", "status": "added", "additions": 82, "deletions": 0, "changes": 82, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-directives-2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80d6ca01843d2119c913e3adf27d20204846072f/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-directives-2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-directives-2.f90?ref=80d6ca01843d2119c913e3adf27d20204846072f", "patch": "@@ -0,0 +1,82 @@\n+! Check for invalid (and some valid) cases of multiple OpenACC 'routine'\n+! directives.\n+\n+      SUBROUTINE s_1\n+!$ACC ROUTINE VECTOR WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+!$ACC ROUTINE(s_1)\n+!$ACC ROUTINE GANG ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE(s_1) SEQ\n+!$ACC ROUTINE\n+!$ACC ROUTINE(s_1) WORKER ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE GANG VECTOR ! { dg-error \"Multiple loop axes specified for routine\" }\n+      END SUBROUTINE s_1\n+\n+      SUBROUTINE s_2\n+!$ACC ROUTINE(s_2) VECTOR WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+!$ACC ROUTINE\n+!$ACC ROUTINE(s_2) GANG ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE SEQ\n+!$ACC ROUTINE(s_2)\n+!$ACC ROUTINE WORKER ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE(s_2) GANG VECTOR ! { dg-error \"Multiple loop axes specified for routine\" }\n+      END SUBROUTINE s_2\n+\n+      SUBROUTINE v_1\n+!$ACC ROUTINE VECTOR WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+!$ACC ROUTINE VECTOR\n+!$ACC ROUTINE GANG ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE SEQ ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE(v_1) VECTOR\n+!$ACC ROUTINE WORKER ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE GANG VECTOR ! { dg-error \"Multiple loop axes specified for routine\" }\n+      END SUBROUTINE v_1\n+\n+      SUBROUTINE v_2\n+!$ACC ROUTINE(v_2) VECTOR\n+!$ACC ROUTINE(v_2) VECTOR WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+!$ACC ROUTINE(v_2) ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE VECTOR\n+!$ACC ROUTINE(v_2) GANG VECTOR ! { dg-error \"Multiple loop axes specified for routine\" }\n+      END SUBROUTINE v_2\n+\n+      SUBROUTINE sub_1\n+      IMPLICIT NONE\n+      EXTERNAL :: g_1\n+!$ACC ROUTINE (g_1) GANG\n+!$ACC ROUTINE (g_1) GANG WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+!$ACC ROUTINE (g_1) VECTOR ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE (g_1) SEQ ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE (g_1) ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE (g_1) GANG\n+!$ACC ROUTINE (g_1) ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+\n+      CALL s_1\n+      CALL s_2\n+      CALL v_1\n+      CALL v_2\n+      CALL g_1\n+      CALL ABORT\n+      END SUBROUTINE sub_1\n+\n+      MODULE m_w_1\n+      IMPLICIT NONE\n+      EXTERNAL :: w_1\n+!$ACC ROUTINE (w_1) WORKER\n+!$ACC ROUTINE (w_1) WORKER SEQ ! { dg-error \"Multiple loop axes specified for routine\" }\n+!$ACC ROUTINE (w_1) ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE (w_1) WORKER\n+!$ACC ROUTINE (w_1) SEQ ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE (w_1) ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+!$ACC ROUTINE (w_1) VECTOR ! { dg-error \"\\\\!\\\\\\$ACC ROUTINE already applied\" }\n+\n+      CONTAINS\n+      SUBROUTINE sub_2\n+      CALL s_1\n+      CALL s_2\n+      CALL v_1\n+      CALL v_2\n+      CALL w_1\n+      CALL ABORT\n+      END SUBROUTINE sub_2\n+      END MODULE m_w_1"}]}