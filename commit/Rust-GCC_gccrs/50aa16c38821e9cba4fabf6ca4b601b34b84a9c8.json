{"sha": "50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTBhYTE2YzM4ODIxZTljYmE0ZmFiZjZjYTRiNjAxYjM0Yjg0YTljOA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-08-10T00:33:20Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-08-10T00:33:20Z"}, "message": "re PR c/81687 (Compiler drops label in OpenMP region)\n\n\tPR c/81687\n\t* omp-low.c (omp_copy_decl): Don't remap FORCED_LABEL or DECL_NONLOCAL\n\tLABEL_DECLs.\n\t* tree-cfg.c (move_stmt_op): Don't adjust DECL_CONTEXT of FORCED_LABEL\n\tor DECL_NONLOCAL labels.\n\t(move_stmt_r) <case GIMPLE_LABEL>: Adjust DECL_CONTEXT of FORCED_LABEL\n\tor DECL_NONLOCAL labels here.\n\n\t* testsuite/libgomp.c/pr81687-1.c: New test.\n\t* testsuite/libgomp.c/pr81687-2.c: New test.\n\nFrom-SVN: r251019", "tree": {"sha": "63f1d98ac39aa578be9ea5c5e5147588e4859ed5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/63f1d98ac39aa578be9ea5c5e5147588e4859ed5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "47ee1b7c10f2aa90645b0d2a94926fa2a674450c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47ee1b7c10f2aa90645b0d2a94926fa2a674450c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/47ee1b7c10f2aa90645b0d2a94926fa2a674450c"}], "stats": {"total": 93, "additions": 92, "deletions": 1}, "files": [{"sha": "1b0292567755ae0a5549d51418a40d2f0e67d14b", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "patch": "@@ -1,3 +1,13 @@\n+2017-08-09  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/81687\n+\t* omp-low.c (omp_copy_decl): Don't remap FORCED_LABEL or DECL_NONLOCAL\n+\tLABEL_DECLs.\n+\t* tree-cfg.c (move_stmt_op): Don't adjust DECL_CONTEXT of FORCED_LABEL\n+\tor DECL_NONLOCAL labels.\n+\t(move_stmt_r) <case GIMPLE_LABEL>: Adjust DECL_CONTEXT of FORCED_LABEL\n+\tor DECL_NONLOCAL labels here.\n+\n 2017-08-09  Will Schmidt  <will_schmidt@vnet.ibm.com>\n \n \t* config/rs6000/rs6000.c (rs6000_option_override_internal): Add blurb"}, {"sha": "dffdb7704ad6e801995df4fccae13609e78e8919", "filename": "gcc/omp-low.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/gcc%2Fomp-low.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/gcc%2Fomp-low.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.c?ref=50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "patch": "@@ -798,6 +798,8 @@ omp_copy_decl (tree var, copy_body_data *cb)\n \n   if (TREE_CODE (var) == LABEL_DECL)\n     {\n+      if (FORCED_LABEL (var) || DECL_NONLOCAL (var))\n+\treturn var;\n       new_var = create_artificial_label (DECL_SOURCE_LOCATION (var));\n       DECL_CONTEXT (new_var) = current_function_decl;\n       insert_decl_map (&ctx->cb, var, new_var);"}, {"sha": "f26b12ff30dce7e9d672f0129798132c2ee33fff", "filename": "gcc/tree-cfg.c", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/gcc%2Ftree-cfg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/gcc%2Ftree-cfg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-cfg.c?ref=50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "patch": "@@ -6718,7 +6718,15 @@ move_stmt_op (tree *tp, int *walk_subtrees, void *data)\n \t\t*tp = t = out->to;\n \t    }\n \n-\t  DECL_CONTEXT (t) = p->to_context;\n+\t  /* For FORCED_LABELs we can end up with references from other\n+\t     functions if some SESE regions are outlined.  It is UB to\n+\t     jump in between them, but they could be used just for printing\n+\t     addresses etc.  In that case, DECL_CONTEXT on the label should\n+\t     be the function containing the glabel stmt with that LABEL_DECL,\n+\t     rather than whatever function a reference to the label was seen\n+\t     last time.  */\n+\t  if (!FORCED_LABEL (t) && !DECL_NONLOCAL (t))\n+\t    DECL_CONTEXT (t) = p->to_context;\n \t}\n       else if (p->remap_decls_p)\n \t{\n@@ -6836,6 +6844,21 @@ move_stmt_r (gimple_stmt_iterator *gsi_p, bool *handled_ops_p,\n     case GIMPLE_OMP_RETURN:\n     case GIMPLE_OMP_CONTINUE:\n       break;\n+\n+    case GIMPLE_LABEL:\n+      {\n+\t/* For FORCED_LABEL, move_stmt_op doesn't adjust DECL_CONTEXT,\n+\t   so that such labels can be referenced from other regions.\n+\t   Make sure to update it when seeing a GIMPLE_LABEL though,\n+\t   that is the owner of the label.  */\n+\twalk_gimple_op (stmt, move_stmt_op, wi);\n+\t*handled_ops_p = true;\n+\ttree label = gimple_label_label (as_a <glabel *> (stmt));\n+\tif (FORCED_LABEL (label) || DECL_NONLOCAL (label))\n+\t  DECL_CONTEXT (label) = p->to_context;\n+      }\n+      break;\n+\n     default:\n       if (is_gimple_omp (stmt))\n \t{"}, {"sha": "434cca71f9dc1983115fc4e930de37af80ea409b", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "patch": "@@ -1,3 +1,9 @@\n+2017-08-09  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/81687\n+\t* testsuite/libgomp.c/pr81687-1.c: New test.\n+\t* testsuite/libgomp.c/pr81687-2.c: New test.\n+\n 2017-08-07  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c/69389"}, {"sha": "768ec4484d463aa08ebd1eaf7dde9831d6b2975d", "filename": "libgomp/testsuite/libgomp.c/pr81687-1.c", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr81687-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr81687-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr81687-1.c?ref=50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "patch": "@@ -0,0 +1,23 @@\n+/* PR c/81687 */\n+/* { dg-do link } */\n+/* { dg-additional-options \"-O2\" } */\n+\n+extern int printf (const char *, ...);\n+\n+int\n+main ()\n+{\n+  #pragma omp parallel\n+  {\n+   lab1:\n+    printf (\"lab1=%p\\n\", (void *)(&&lab1));\n+  }\n+ lab2:\n+  #pragma omp parallel\n+  {\n+   lab3:\n+    printf (\"lab2=%p\\n\", (void *)(&&lab2));\n+  }\n+  printf (\"lab3=%p\\n\", (void *)(&&lab3));\n+  return 0;\n+}"}, {"sha": "e819f7620320369e9c8f9de6cd5e042d4cd39ef1", "filename": "libgomp/testsuite/libgomp.c/pr81687-2.c", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr81687-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/50aa16c38821e9cba4fabf6ca4b601b34b84a9c8/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr81687-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr81687-2.c?ref=50aa16c38821e9cba4fabf6ca4b601b34b84a9c8", "patch": "@@ -0,0 +1,27 @@\n+/* PR c/81687 */\n+/* { dg-do link } */\n+/* { dg-additional-options \"-O2\" } */\n+\n+int\n+main ()\n+{\n+  __label__ lab4, lab5, lab6;\n+  volatile int l = 0;\n+  int m = l;\n+  void foo (int x) { if (x == 1) goto lab4; }\n+  void bar (int x) { if (x == 2) goto lab5; }\n+  void baz (int x) { if (x == 3) goto lab6; }\n+  #pragma omp parallel\n+  {\n+    foo (m + 1);\n+   lab4:;\n+  }\n+  #pragma omp task\n+  {\n+    bar (m + 2);\n+   lab5:;\n+  }\n+  baz (m + 3);\n+ lab6:;\n+  return 0;\n+}"}]}