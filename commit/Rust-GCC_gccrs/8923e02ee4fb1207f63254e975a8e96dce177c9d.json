{"sha": "8923e02ee4fb1207f63254e975a8e96dce177c9d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODkyM2UwMmVlNGZiMTIwN2Y2MzI1NGU5NzVhOGU5NmRjZTE3N2M5ZA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2015-12-02T19:39:11Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2015-12-02T19:39:11Z"}, "message": "re PR target/68647 (__builtin_popcountll doesn't generate popcnt instructions when targeting -mpopcnt on x86_32)\n\n\tPR target/68647\n\t* optabs.c (expand_doubleword_popcount, expand_doubleword_parity):\n\tNew functions.\n\t(expand_unop): Use them.\n\n\t* gcc.target/i386/pr68647.c: New test.\n\nFrom-SVN: r231201", "tree": {"sha": "5faa7185f3b52ad277e029b66f51d1cb7eabb27d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5faa7185f3b52ad277e029b66f51d1cb7eabb27d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8923e02ee4fb1207f63254e975a8e96dce177c9d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8923e02ee4fb1207f63254e975a8e96dce177c9d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8923e02ee4fb1207f63254e975a8e96dce177c9d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8923e02ee4fb1207f63254e975a8e96dce177c9d/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d6221ad4589004958d05d4ac3cb7104881dfe896", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d6221ad4589004958d05d4ac3cb7104881dfe896", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d6221ad4589004958d05d4ac3cb7104881dfe896"}], "stats": {"total": 105, "additions": 104, "deletions": 1}, "files": [{"sha": "c90a062dd022071a76ad798d0bee6fb85a0bfc25", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=8923e02ee4fb1207f63254e975a8e96dce177c9d", "patch": "@@ -1,3 +1,10 @@\n+2015-12-02  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/68647\n+\t* optabs.c (expand_doubleword_popcount, expand_doubleword_parity):\n+\tNew functions.\n+\t(expand_unop): Use them.\n+\n 2015-12-02  Marek Polacek  <polacek@redhat.com>\n \n \tPR c++/68653"}, {"sha": "8cc4802f339f9d0cb6f51c018cfa539623f7556e", "filename": "gcc/optabs.c", "status": "modified", "additions": 74, "deletions": 1, "changes": 75, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2Foptabs.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2Foptabs.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Foptabs.c?ref=8923e02ee4fb1207f63254e975a8e96dce177c9d", "patch": "@@ -2223,6 +2223,58 @@ expand_doubleword_clz (machine_mode mode, rtx op0, rtx target)\n   return 0;\n }\n \n+/* Try calculating popcount of a double-word quantity as two popcount's of\n+   word-sized quantities and summing up the results.  */\n+static rtx\n+expand_doubleword_popcount (machine_mode mode, rtx op0, rtx target)\n+{\n+  rtx t0, t1, t;\n+  rtx_insn *seq;\n+\n+  start_sequence ();\n+\n+  t0 = expand_unop_direct (word_mode, popcount_optab,\n+\t\t\t   operand_subword_force (op0, 0, mode), NULL_RTX,\n+\t\t\t   true);\n+  t1 = expand_unop_direct (word_mode, popcount_optab,\n+\t\t\t   operand_subword_force (op0, 1, mode), NULL_RTX,\n+\t\t\t   true);\n+  if (!t0 || !t1)\n+    {\n+      end_sequence ();\n+      return NULL_RTX;\n+    }\n+\n+  /* If we were not given a target, use a word_mode register, not a\n+     'mode' register.  The result will fit, and nobody is expecting\n+     anything bigger (the return type of __builtin_popcount* is int).  */\n+  if (!target)\n+    target = gen_reg_rtx (word_mode);\n+\n+  t = expand_binop (word_mode, add_optab, t0, t1, target, 0, OPTAB_DIRECT);\n+\n+  seq = get_insns ();\n+  end_sequence ();\n+\n+  add_equal_note (seq, t, POPCOUNT, op0, 0);\n+  emit_insn (seq);\n+  return t;\n+}\n+\n+/* Try calculating\n+\t(parity:wide x)\n+   as\n+\t(parity:narrow (low (x) ^ high (x))) */\n+static rtx\n+expand_doubleword_parity (machine_mode mode, rtx op0, rtx target)\n+{\n+  rtx t = expand_binop (word_mode, xor_optab,\n+\t\t\toperand_subword_force (op0, 0, mode),\n+\t\t\toperand_subword_force (op0, 1, mode),\n+\t\t\tNULL_RTX, 0, OPTAB_DIRECT);\n+  return expand_unop (word_mode, parity_optab, t, target, true);\n+}\n+\n /* Try calculating\n \t(bswap:narrow x)\n    as\n@@ -2582,7 +2634,7 @@ expand_absneg_bit (enum rtx_code code, machine_mode mode,\n    different mode or with a libcall.  */\n static rtx\n expand_unop_direct (machine_mode mode, optab unoptab, rtx op0, rtx target,\n-\t     int unsignedp)\n+\t\t    int unsignedp)\n {\n   if (optab_handler (unoptab, mode) != CODE_FOR_nothing)\n     {\n@@ -2665,6 +2717,27 @@ expand_unop (machine_mode mode, optab unoptab, rtx op0, rtx target,\n       goto try_libcall;\n     }\n \n+  if (unoptab == popcount_optab\n+      && GET_MODE_SIZE (mode) == 2 * UNITS_PER_WORD\n+      && optab_handler (unoptab, word_mode) != CODE_FOR_nothing\n+      && optimize_insn_for_speed_p ())\n+    {\n+      temp = expand_doubleword_popcount (mode, op0, target);\n+      if (temp)\n+\treturn temp;\n+    }\n+\n+  if (unoptab == parity_optab\n+      && GET_MODE_SIZE (mode) == 2 * UNITS_PER_WORD\n+      && (optab_handler (unoptab, word_mode) != CODE_FOR_nothing\n+\t  || optab_handler (popcount_optab, word_mode) != CODE_FOR_nothing)\n+      && optimize_insn_for_speed_p ())\n+    {\n+      temp = expand_doubleword_parity (mode, op0, target);\n+      if (temp)\n+\treturn temp;\n+    }\n+\n   /* Widening (or narrowing) bswap needs special treatment.  */\n   if (unoptab == bswap_optab)\n     {"}, {"sha": "0400e172802cdef2fcf79594e6e0ecc8c183a27a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=8923e02ee4fb1207f63254e975a8e96dce177c9d", "patch": "@@ -1,3 +1,8 @@\n+2015-12-02  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/68647\n+\t* gcc.target/i386/pr68647.c: New test.\n+\n 2015-12-02  Marek Polacek  <polacek@redhat.com>\n \n \tPR c++/68653"}, {"sha": "70549318e87734cb16a2a267828bc86778c21439", "filename": "gcc/testsuite/gcc.target/i386/pr68647.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr68647.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8923e02ee4fb1207f63254e975a8e96dce177c9d/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr68647.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr68647.c?ref=8923e02ee4fb1207f63254e975a8e96dce177c9d", "patch": "@@ -0,0 +1,18 @@\n+/* PR target/68647 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -mpopcnt\" } */\n+\n+int\n+f1 (unsigned long long a)\n+{\n+  return __builtin_popcountll (a);\n+}\n+\n+int\n+f2 (unsigned long long a)\n+{\n+  return __builtin_parityll (a);\n+}\n+\n+/* { dg-final { scan-assembler-not \"__popcountdi2\" } } */\n+/* { dg-final { scan-assembler-not \"__paritydi2\" } } */"}]}