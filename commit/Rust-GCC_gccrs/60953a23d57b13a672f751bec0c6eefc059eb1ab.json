{"sha": "60953a23d57b13a672f751bec0c6eefc059eb1ab", "node_id": "C_kwDOANBUbNoAKDYwOTUzYTIzZDU3YjEzYTY3MmY3NTFiZWMwYzZlZWZjMDU5ZWIxYWI", "commit": {"author": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2022-01-21T21:24:00Z"}, "committer": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2022-01-21T22:36:02Z"}, "message": "x86: Properly disable -fsplit-stack support on non-glibc targets\n\nRevert x86 changes in\n\ncommit c163647ffbc9a20c8feb6e079dbecccfe016c82e\nAuthor: Soren Tempel <soeren@soeren-tempel.net>\nDate:   Fri Jan 21 19:22:46 2022 +0000\n\n    Disable -fsplit-stack support on non-glibc targets\n\nand change ix86_supports_split_stack to return true only on glibc.\n\n\tPR bootstrap/104170\n\t* common/config/i386/i386-common.cc (ix86_supports_split_stack):\n\tReturn true only on glibc.\n\t* config/i386/gnu-user-common.h (STACK_CHECK_STATIC_BUILTIN):\n\tRevert commit c163647ffbc.\n\t* config/i386/gnu.h (TARGET_LIBC_PROVIDES_SSP): Likewise.", "tree": {"sha": "43740b618f6644672350784b252291128ef78fb8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/43740b618f6644672350784b252291128ef78fb8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/60953a23d57b13a672f751bec0c6eefc059eb1ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/60953a23d57b13a672f751bec0c6eefc059eb1ab", "html_url": "https://github.com/Rust-GCC/gccrs/commit/60953a23d57b13a672f751bec0c6eefc059eb1ab", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/60953a23d57b13a672f751bec0c6eefc059eb1ab/comments", "author": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f36efe71bef8ddf72306aca313d28759434cf97a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f36efe71bef8ddf72306aca313d28759434cf97a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f36efe71bef8ddf72306aca313d28759434cf97a"}], "stats": {"total": 27, "additions": 14, "deletions": 13}, "files": [{"sha": "7496d1798921e51cd7aeb9c765f284ed5a3a9642", "filename": "gcc/common/config/i386/i386-common.cc", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/60953a23d57b13a672f751bec0c6eefc059eb1ab/gcc%2Fcommon%2Fconfig%2Fi386%2Fi386-common.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/60953a23d57b13a672f751bec0c6eefc059eb1ab/gcc%2Fcommon%2Fconfig%2Fi386%2Fi386-common.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcommon%2Fconfig%2Fi386%2Fi386-common.cc?ref=60953a23d57b13a672f751bec0c6eefc059eb1ab", "patch": "@@ -1714,16 +1714,21 @@ ix86_option_init_struct (struct gcc_options *opts)\n    field in the TCB, so they cannot be used together.  */\n \n static bool\n-ix86_supports_split_stack (bool report ATTRIBUTE_UNUSED,\n+ix86_supports_split_stack (bool report,\n \t\t\t   struct gcc_options *opts ATTRIBUTE_UNUSED)\n {\n+#ifdef TARGET_THREAD_SPLIT_STACK_OFFSET\n+  if (opts->x_linux_libc != LIBC_GLIBC)\n+#endif\n+    {\n+      if (report)\n+\terror (\"%<-fsplit-stack%> currently only supported on GNU/Linux\");\n+      return false;\n+    }\n+\n   bool ret = true;\n \n-#ifndef TARGET_THREAD_SPLIT_STACK_OFFSET\n-  if (report)\n-    error (\"%<-fsplit-stack%> currently only supported on GNU/Linux\");\n-  ret = false;\n-#else\n+#ifdef TARGET_THREAD_SPLIT_STACK_OFFSET\n   if (!HAVE_GAS_CFI_PERSONALITY_DIRECTIVE)\n     {\n       if (report)"}, {"sha": "23b54c5be52510feb7d9383441b4073450b8b4aa", "filename": "gcc/config/i386/gnu-user-common.h", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/60953a23d57b13a672f751bec0c6eefc059eb1ab/gcc%2Fconfig%2Fi386%2Fgnu-user-common.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/60953a23d57b13a672f751bec0c6eefc059eb1ab/gcc%2Fconfig%2Fi386%2Fgnu-user-common.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fgnu-user-common.h?ref=60953a23d57b13a672f751bec0c6eefc059eb1ab", "patch": "@@ -66,8 +66,7 @@ along with GCC; see the file COPYING3.  If not see\n #define STACK_CHECK_STATIC_BUILTIN 1\n \n /* We only build the -fsplit-stack support in libgcc if the\n-   assembler has full support for the CFI directives and\n-   targets glibc.  */\n-#if HAVE_GAS_CFI_PERSONALITY_DIRECTIVE && OPTION_GLIBC\n+   assembler has full support for the CFI directives.  */\n+#if HAVE_GAS_CFI_PERSONALITY_DIRECTIVE\n #define TARGET_CAN_SPLIT_STACK\n #endif"}, {"sha": "401e60c9a0256661f398fbfa41a08699bdbf7f51", "filename": "gcc/config/i386/gnu.h", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/60953a23d57b13a672f751bec0c6eefc059eb1ab/gcc%2Fconfig%2Fi386%2Fgnu.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/60953a23d57b13a672f751bec0c6eefc059eb1ab/gcc%2Fconfig%2Fi386%2Fgnu.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fgnu.h?ref=60953a23d57b13a672f751bec0c6eefc059eb1ab", "patch": "@@ -35,10 +35,7 @@ along with GCC.  If not, see <http://www.gnu.org/licenses/>.\n    crti.o%s %{static:crtbeginT.o%s;shared|pie:crtbeginS.o%s;:crtbegin.o%s}\"\n #endif\n \n-/* -fsplit-stack uses a field in the TCB at a fixed offset. This\n-   field is only available for glibc.  Disable -fsplit-stack for\n-   other libc implementations to avoid silent TCB corruptions.  */\n-#if defined (TARGET_LIBC_PROVIDES_SSP) && OPTION_GLIBC\n+#ifdef TARGET_LIBC_PROVIDES_SSP\n \n /* i386 glibc provides __stack_chk_guard in %gs:0x14.  */\n #define TARGET_THREAD_SSP_OFFSET        0x14"}]}