{"sha": "e80944753d325ef009acf58a5b3188936997d22b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTgwOTQ0NzUzZDMyNWVmMDA5YWNmNThhNWIzMTg4OTM2OTk3ZDIyYg==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2018-12-02T12:39:26Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2018-12-02T12:39:26Z"}, "message": "re PR sanitizer/88291 (asan ICE in asan_clear_shadow)\n\n\tPR sanitizer/88291\n\t* asan.c (asan_clear_shadow): Move assert that len is multiple of 4\n\tto the start of the function.\n\t(asan_emit_stack_protection): When emitting clearing sequence for\n\tepilogue, align offset down to ASAN_RED_ZONE_SIZE granularity,\n\tadd last_size_aligned which is last_size padded to multiples of\n\tASAN_RED_ZONE_SIZE and emit asan_clear_shadow always on 4 byte\n\tboundaries.\n\n\t* c-c++-common/asan/pr88291.c: New test.\n\nFrom-SVN: r266721", "tree": {"sha": "60c300b077aa69323c05bd819f079de56fc173cd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/60c300b077aa69323c05bd819f079de56fc173cd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e80944753d325ef009acf58a5b3188936997d22b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e80944753d325ef009acf58a5b3188936997d22b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e80944753d325ef009acf58a5b3188936997d22b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e80944753d325ef009acf58a5b3188936997d22b/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "faa867f5a8b74b5eaef3066debc015dc888237cb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/faa867f5a8b74b5eaef3066debc015dc888237cb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/faa867f5a8b74b5eaef3066debc015dc888237cb"}], "stats": {"total": 48, "additions": 41, "deletions": 7}, "files": [{"sha": "e80e1ddd1ac40c023e746cba94dddfbe5f22813d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e80944753d325ef009acf58a5b3188936997d22b/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e80944753d325ef009acf58a5b3188936997d22b/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=e80944753d325ef009acf58a5b3188936997d22b", "patch": "@@ -1,3 +1,14 @@\n+2018-12-02  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR sanitizer/88291\n+\t* asan.c (asan_clear_shadow): Move assert that len is multiple of 4\n+\tto the start of the function.\n+\t(asan_emit_stack_protection): When emitting clearing sequence for\n+\tepilogue, align offset down to ASAN_RED_ZONE_SIZE granularity,\n+\tadd last_size_aligned which is last_size padded to multiples of\n+\tASAN_RED_ZONE_SIZE and emit asan_clear_shadow always on 4 byte\n+\tboundaries.\n+\n 2018-12-01  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR sanitizer/88289"}, {"sha": "98a42721f8f6dbccb7a2e7c056874164c5d3a331", "filename": "gcc/asan.c", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e80944753d325ef009acf58a5b3188936997d22b/gcc%2Fasan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e80944753d325ef009acf58a5b3188936997d22b/gcc%2Fasan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fasan.c?ref=e80944753d325ef009acf58a5b3188936997d22b", "patch": "@@ -1165,6 +1165,7 @@ asan_clear_shadow (rtx shadow_mem, HOST_WIDE_INT len)\n   rtx_code_label *top_label;\n   rtx end, addr, tmp;\n \n+  gcc_assert ((len & 3) == 0);\n   start_sequence ();\n   clear_storage (shadow_mem, GEN_INT (len), BLOCK_OP_NORMAL);\n   insns = get_insns ();\n@@ -1178,7 +1179,6 @@ asan_clear_shadow (rtx shadow_mem, HOST_WIDE_INT len)\n       return;\n     }\n \n-  gcc_assert ((len & 3) == 0);\n   top_label = gen_label_rtx ();\n   addr = copy_to_mode_reg (Pmode, XEXP (shadow_mem, 0));\n   shadow_mem = adjust_automodify_address (shadow_mem, SImode, addr, 0);\n@@ -1375,7 +1375,7 @@ asan_emit_stack_protection (rtx base, rtx pbase, unsigned int alignb,\n   HOST_WIDE_INT base_offset = offsets[length - 1];\n   HOST_WIDE_INT base_align_bias = 0, offset, prev_offset;\n   HOST_WIDE_INT asan_frame_size = offsets[0] - base_offset;\n-  HOST_WIDE_INT last_offset, last_size;\n+  HOST_WIDE_INT last_offset, last_size, last_size_aligned;\n   int l;\n   unsigned char cur_shadow_byte = ASAN_STACK_MAGIC_LEFT;\n   tree str_cst, decl, id;\n@@ -1628,20 +1628,23 @@ asan_emit_stack_protection (rtx base, rtx pbase, unsigned int alignb,\n   prev_offset = base_offset;\n   last_offset = base_offset;\n   last_size = 0;\n+  last_size_aligned = 0;\n   for (l = length; l; l -= 2)\n     {\n       offset = base_offset + ((offsets[l - 1] - base_offset)\n-\t\t\t     & ~(ASAN_MIN_RED_ZONE_SIZE - HOST_WIDE_INT_1));\n-      if (last_offset + last_size != offset)\n+\t\t\t      & ~(ASAN_RED_ZONE_SIZE - HOST_WIDE_INT_1));\n+      if (last_offset + last_size_aligned < offset)\n \t{\n \t  shadow_mem = adjust_address (shadow_mem, VOIDmode,\n \t\t\t\t       (last_offset - prev_offset)\n \t\t\t\t       >> ASAN_SHADOW_SHIFT);\n \t  prev_offset = last_offset;\n-\t  asan_clear_shadow (shadow_mem, last_size >> ASAN_SHADOW_SHIFT);\n+\t  asan_clear_shadow (shadow_mem, last_size_aligned >> ASAN_SHADOW_SHIFT);\n \t  last_offset = offset;\n \t  last_size = 0;\n \t}\n+      else\n+\tlast_size = offset - last_offset;\n       last_size += base_offset + ((offsets[l - 2] - base_offset)\n \t\t\t\t  & ~(ASAN_MIN_RED_ZONE_SIZE - HOST_WIDE_INT_1))\n \t\t   - offset;\n@@ -1667,13 +1670,16 @@ asan_emit_stack_protection (rtx base, rtx pbase, unsigned int alignb,\n \t\tlast_size += size & ~(ASAN_MIN_RED_ZONE_SIZE - HOST_WIDE_INT_1);\n \t    }\n \t}\n+      last_size_aligned\n+\t= ((last_size + (ASAN_RED_ZONE_SIZE - HOST_WIDE_INT_1))\n+\t   & ~(ASAN_RED_ZONE_SIZE - HOST_WIDE_INT_1));\n     }\n-  if (last_size)\n+  if (last_size_aligned)\n     {\n       shadow_mem = adjust_address (shadow_mem, VOIDmode,\n \t\t\t\t   (last_offset - prev_offset)\n \t\t\t\t   >> ASAN_SHADOW_SHIFT);\n-      asan_clear_shadow (shadow_mem, last_size >> ASAN_SHADOW_SHIFT);\n+      asan_clear_shadow (shadow_mem, last_size_aligned >> ASAN_SHADOW_SHIFT);\n     }\n \n   /* Clean-up set with instrumented stack variables.  */"}, {"sha": "916cb5579c7e9e8b2fe22311f34f8245f06da317", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e80944753d325ef009acf58a5b3188936997d22b/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e80944753d325ef009acf58a5b3188936997d22b/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e80944753d325ef009acf58a5b3188936997d22b", "patch": "@@ -1,5 +1,8 @@\n 2018-12-02  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR sanitizer/88291\n+\t* c-c++-common/asan/pr88291.c: New test.\n+\n \tPR c++/88258\n \t* g++.dg/gomp/pr88258.C: New test.\n "}, {"sha": "e86526671d60b06699e28bcc28a0bc99b2d2a63d", "filename": "gcc/testsuite/c-c++-common/asan/pr88291.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e80944753d325ef009acf58a5b3188936997d22b/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpr88291.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e80944753d325ef009acf58a5b3188936997d22b/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpr88291.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpr88291.c?ref=e80944753d325ef009acf58a5b3188936997d22b", "patch": "@@ -0,0 +1,14 @@\n+/* PR sanitizer/88291 */\n+/* { dg-do compile } */\n+/* { dg-options \"-fsanitize=address -Os\" } */\n+/* { dg-additional-options \"-mstringop-strategy=libcall\" { target i?86-*-* x86_64-*-* } } */\n+\n+void bar (void *, void *);\n+\n+void\n+foo (void)\n+{\n+  int b;\n+  char __attribute__((aligned(16))) a[(1 << 20) + 1];\n+  bar (&a, &b);\n+}"}]}