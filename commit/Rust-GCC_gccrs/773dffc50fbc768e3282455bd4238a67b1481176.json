{"sha": "773dffc50fbc768e3282455bd4238a67b1481176", "node_id": "C_kwDOANBUbNoAKDc3M2RmZmM1MGZiYzc2OGUzMjgyNDU1YmQ0MjM4YTY3YjE0ODExNzY", "commit": {"author": {"name": "Takayuki 'January June' Suwa", "email": "jjsuwa_sys3175@yahoo.co.jp", "date": "2022-06-26T13:28:30Z"}, "committer": {"name": "Max Filippov", "email": "jcmvbkbc@gmail.com", "date": "2022-06-27T03:40:42Z"}, "message": "xtensa: Optimize integer constant addition that is between -32896 and 32639\n\nSuch constants are often subject to the constant synthesis:\n\n    int test(int a) {\n      return a - 31999;\n    }\n\n    test:\n\tmovi\ta3, 1\n\taddmi\ta3, a3, -0x7d00\n\tadd\ta2, a2, a3\n\tret\n\nThis patch optimizes such case as follows:\n\n    test:\n\taddi\ta2, a2, 1\n\taddmi\ta2, a2, -0x7d00\n\tret\n\ngcc/ChangeLog:\n\n\t* config/xtensa/xtensa.md:\n\tSuppress unnecessary emitting nop insn in the split patterns for\n\tinteger/FP constant synthesis, and add new peephole2 pattern that\n\tfolds such synthesized additions.", "tree": {"sha": "489e0309a96021900b7465c71b6a1bd619298d0c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/489e0309a96021900b7465c71b6a1bd619298d0c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/773dffc50fbc768e3282455bd4238a67b1481176", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/773dffc50fbc768e3282455bd4238a67b1481176", "html_url": "https://github.com/Rust-GCC/gccrs/commit/773dffc50fbc768e3282455bd4238a67b1481176", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/773dffc50fbc768e3282455bd4238a67b1481176/comments", "author": {"login": "jjsuwa-sys3175", "id": 73290592, "node_id": "MDQ6VXNlcjczMjkwNTky", "avatar_url": "https://avatars.githubusercontent.com/u/73290592?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jjsuwa-sys3175", "html_url": "https://github.com/jjsuwa-sys3175", "followers_url": "https://api.github.com/users/jjsuwa-sys3175/followers", "following_url": "https://api.github.com/users/jjsuwa-sys3175/following{/other_user}", "gists_url": "https://api.github.com/users/jjsuwa-sys3175/gists{/gist_id}", "starred_url": "https://api.github.com/users/jjsuwa-sys3175/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jjsuwa-sys3175/subscriptions", "organizations_url": "https://api.github.com/users/jjsuwa-sys3175/orgs", "repos_url": "https://api.github.com/users/jjsuwa-sys3175/repos", "events_url": "https://api.github.com/users/jjsuwa-sys3175/events{/privacy}", "received_events_url": "https://api.github.com/users/jjsuwa-sys3175/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jcmvbkbc", "id": 166731, "node_id": "MDQ6VXNlcjE2NjczMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jcmvbkbc", "html_url": "https://github.com/jcmvbkbc", "followers_url": "https://api.github.com/users/jcmvbkbc/followers", "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}", "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}", "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions", "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs", "repos_url": "https://api.github.com/users/jcmvbkbc/repos", "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}", "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2b72757b229fe97cc5320a14a6e61008bc56882", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b2b72757b229fe97cc5320a14a6e61008bc56882", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b2b72757b229fe97cc5320a14a6e61008bc56882"}], "stats": {"total": 35, "additions": 35, "deletions": 0}, "files": [{"sha": "9d998589631eca3782ebb8258a7ab003fea5aa0d", "filename": "gcc/config/xtensa/xtensa.md", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/773dffc50fbc768e3282455bd4238a67b1481176/gcc%2Fconfig%2Fxtensa%2Fxtensa.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/773dffc50fbc768e3282455bd4238a67b1481176/gcc%2Fconfig%2Fxtensa%2Fxtensa.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa.md?ref=773dffc50fbc768e3282455bd4238a67b1481176", "patch": "@@ -1033,6 +1033,7 @@\n     FAIL;\n   if (! xtensa_constantsynth (operands[0], INTVAL (x)))\n     emit_move_insn (operands[0], x);\n+  DONE;\n })\n \n ;; 16-bit Integer moves\n@@ -1272,6 +1273,7 @@\n   x = gen_rtx_REG (SImode, REGNO (operands[0]));\n   if (! xtensa_constantsynth (x, l[i]))\n     emit_move_insn (x, GEN_INT (l[i]));\n+  DONE;\n })\n \n ;; 64-bit floating point moves\n@@ -2808,3 +2810,36 @@\n \t && REGNO (x) == regno + REG_NREGS (operands[0]) / 2))\n     FAIL;\n })\n+\n+(define_peephole2\n+  [(set (match_operand:SI 0 \"register_operand\")\n+\t(match_operand:SI 1 \"const_int_operand\"))\n+   (set (match_dup 0)\n+\t(plus:SI (match_dup 0)\n+\t\t (match_operand:SI 2 \"const_int_operand\")))\n+   (set (match_operand:SI 3 \"register_operand\")\n+\t(plus:SI (match_operand:SI 4 \"register_operand\")\n+\t\t (match_dup 0)))]\n+  \"IN_RANGE (INTVAL (operands[1]) + INTVAL (operands[2]),\n+\t     (-128 - 32768), (127 + 32512))\n+   && REGNO (operands[0]) != REGNO (operands[3])\n+   && REGNO (operands[0]) != REGNO (operands[4])\n+   && peep2_reg_dead_p (3, operands[0])\"\n+  [(set (match_dup 3)\n+\t(plus:SI (match_dup 4)\n+\t\t (match_dup 1)))\n+   (set (match_dup 3)\n+\t(plus:SI (match_dup 3)\n+\t\t (match_dup 2)))]\n+{\n+  HOST_WIDE_INT value = INTVAL (operands[1]) + INTVAL (operands[2]);\n+  int imm0, imm1;\n+  value += 128;\n+  if (value > 32512)\n+    imm1 = 32512;\n+  else\n+    imm1 = value & ~255;\n+  imm0 = value - imm1 - 128;\n+  operands[1] = GEN_INT (imm0);\n+  operands[2] = GEN_INT (imm1);\n+})"}]}