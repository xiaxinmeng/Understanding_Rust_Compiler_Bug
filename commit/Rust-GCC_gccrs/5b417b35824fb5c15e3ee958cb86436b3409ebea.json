{"sha": "5b417b35824fb5c15e3ee958cb86436b3409ebea", "node_id": "C_kwDOANBUbNoAKDViNDE3YjM1ODI0ZmI1YzE1ZTNlZTk1OGNiODY0MzZiMzQwOWViZWE", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-01-10T17:28:19Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-01-11T13:22:35Z"}, "message": "libstdc++: Make std::variant work with Clang in C++20 mode [PR103891]\n\nClang has some bugs with destructors that use constraints to be\nconditionally trivial, so disable the P2231R1 constexpr changes to\nstd::variant unless the compiler is GCC 12 or later.\n\nIf/when P2493R0 gets accepted and implemented by G++ we can remove the\n__GNUC__ check and use __cpp_concepts >= 202002 instead.\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/103891\n\t* include/bits/c++config (_GLIBCXX_HAVE_COND_TRIVIAL_SPECIAL_MEMBERS):\n\tDefine.\n\t* include/std/variant (__cpp_lib_variant): Only define C++20\n\tvalue when the compiler is known to support conditionally\n\ttrivial destructors.\n\t* include/std/version (__cpp_lib_variant): Likewise.", "tree": {"sha": "200cfb1337a68b8be3cc6c976272aece4f0ec425", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/200cfb1337a68b8be3cc6c976272aece4f0ec425"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5b417b35824fb5c15e3ee958cb86436b3409ebea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5b417b35824fb5c15e3ee958cb86436b3409ebea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5b417b35824fb5c15e3ee958cb86436b3409ebea", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5b417b35824fb5c15e3ee958cb86436b3409ebea/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11d3e8f4364b05e2746689c6d0f573594f6ddb74", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/11d3e8f4364b05e2746689c6d0f573594f6ddb74", "html_url": "https://github.com/Rust-GCC/gccrs/commit/11d3e8f4364b05e2746689c6d0f573594f6ddb74"}], "stats": {"total": 17, "additions": 12, "deletions": 5}, "files": [{"sha": "b197349f9769e1d8f229665ccffd05c15c3565a9", "filename": "libstdc++-v3/include/bits/c++config", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b417b35824fb5c15e3ee958cb86436b3409ebea/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fc%2B%2Bconfig", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b417b35824fb5c15e3ee958cb86436b3409ebea/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fc%2B%2Bconfig", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fc%2B%2Bconfig?ref=5b417b35824fb5c15e3ee958cb86436b3409ebea", "patch": "@@ -810,6 +810,11 @@ namespace std\n \n #undef _GLIBCXX_HAS_BUILTIN\n \n+#if __cplusplus >= 202002L && __cpp_concepts && __GNUC__ >= 12\n+// XXX workaround for missing feature test macro for P0848R3 (see P2493R0).\n+# define _GLIBCXX_HAVE_COND_TRIVIAL_SPECIAL_MEMBERS 1\n+#endif\n+\n // PSTL configuration\n \n #if __cplusplus >= 201703L"}, {"sha": "c41f9f27e000f595545bbe8f97606ade768b92dd", "filename": "libstdc++-v3/include/std/variant", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b417b35824fb5c15e3ee958cb86436b3409ebea/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fvariant", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b417b35824fb5c15e3ee958cb86436b3409ebea/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fvariant", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fvariant?ref=5b417b35824fb5c15e3ee958cb86436b3409ebea", "patch": "@@ -44,17 +44,18 @@\n #include <bits/stl_iterator_base_funcs.h>\n #include <bits/stl_construct.h>\n #include <bits/utility.h> // in_place_index_t\n-#if __cplusplus == 201703L\n+#ifndef _GLIBCXX_HAVE_COND_TRIVIAL_SPECIAL_MEMBERS\n # include <ext/aligned_buffer.h>\n-#else\n+#endif\n+#if __cplusplus >= 202002L\n # include <compare>\n #endif\n \n namespace std _GLIBCXX_VISIBILITY(default)\n {\n _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \n-#if __cplusplus >= 202002L && __cpp_concepts\n+#ifdef _GLIBCXX_HAVE_COND_TRIVIAL_SPECIAL_MEMBERS\n // P2231R1 constexpr needs constexpr unions and constrained destructors.\n # define __cpp_lib_variant 202106L\n #else"}, {"sha": "012d78e3b6baac6bea814238f79380d5b1666be7", "filename": "libstdc++-v3/include/std/version", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b417b35824fb5c15e3ee958cb86436b3409ebea/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fversion", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b417b35824fb5c15e3ee958cb86436b3409ebea/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fversion", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fversion?ref=5b417b35824fb5c15e3ee958cb86436b3409ebea", "patch": "@@ -173,7 +173,8 @@\n # define __cpp_lib_to_chars 201611L\n #endif\n #define __cpp_lib_unordered_map_try_emplace 201411\n-#if __cplusplus == 201703L || ! __cpp_concepts // N.B. updated value in C++20\n+#ifndef _GLIBCXX_HAVE_COND_TRIVIAL_SPECIAL_MEMBERS\n+// N.B. updated value in C++20\n # define __cpp_lib_variant 202102L\n #endif\n #endif\n@@ -286,7 +287,7 @@\n # endif\n #define __cpp_lib_to_address 201711L\n #define __cpp_lib_to_array 201907L\n-#if __cpp_concepts\n+#ifdef _GLIBCXX_HAVE_COND_TRIVIAL_SPECIAL_MEMBERS\n # define __cpp_lib_variant 202106L\n #endif\n #endif"}]}