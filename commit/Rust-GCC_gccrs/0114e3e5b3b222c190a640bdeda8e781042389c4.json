{"sha": "0114e3e5b3b222c190a640bdeda8e781042389c4", "node_id": "C_kwDOANBUbNoAKDAxMTRlM2U1YjNiMjIyYzE5MGE2NDBiZGVkYThlNzgxMDQyMzg5YzQ", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-10-28T10:07:13Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-10-28T10:07:13Z"}, "message": "Add constant folding to ArrayIndexExpr\n\nThis ensures that constexpr is enforced for array-index-exprs resulting in\ngimple like this:\n\n```rust\nfn main() {\n    const A: [i32; 3] = [1, 2, 3];\n    const B: i32 = A[1];\n    const C: usize = 42;\n    const D: i32 = 7;\n\n    let _a = C;\n    let _b: [i32; C] = [0; C];\n    let _c = B + D;\n}\n```\n\n```c\nvoid main ()\n{\n  const usize _a;\n  i32 _b[42];\n  const i32 _c;\n\n  try\n    {\n      _a = 42;\n      _b = {};\n      _1 = 2;\n      _c = _1 + 7;\n    }\n  finally\n    {\n      _b = {CLOBBER};\n    }\n}\n```", "tree": {"sha": "4afc284f874d636b620e233f08050d607faecc59", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4afc284f874d636b620e233f08050d607faecc59"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0114e3e5b3b222c190a640bdeda8e781042389c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0114e3e5b3b222c190a640bdeda8e781042389c4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0114e3e5b3b222c190a640bdeda8e781042389c4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0114e3e5b3b222c190a640bdeda8e781042389c4/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "657a9735339f6e5b0723bc24f74ad55d78daae8e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/657a9735339f6e5b0723bc24f74ad55d78daae8e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/657a9735339f6e5b0723bc24f74ad55d78daae8e"}], "stats": {"total": 19, "additions": 19, "deletions": 0}, "files": [{"sha": "2bf0f2cb59b7924318840838d6a61e1843b16270", "filename": "gcc/rust/typecheck/rust-hir-const-fold.h", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0114e3e5b3b222c190a640bdeda8e781042389c4/gcc%2Frust%2Ftypecheck%2Frust-hir-const-fold.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0114e3e5b3b222c190a640bdeda8e781042389c4/gcc%2Frust%2Ftypecheck%2Frust-hir-const-fold.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-const-fold.h?ref=0114e3e5b3b222c190a640bdeda8e781042389c4", "patch": "@@ -427,6 +427,15 @@ class ConstFoldExpr : public ConstFoldBase\n       = ctx->get_backend ()->negation_expression (op, negated_expr, location);\n   }\n \n+  void visit (HIR::ArrayIndexExpr &expr) override\n+  {\n+    Bexpression *array = ConstFoldExpr::fold (expr.get_array_expr ());\n+    Bexpression *index = ConstFoldExpr::fold (expr.get_index_expr ());\n+\n+    folded = ctx->get_backend ()->array_index_expression (array, index,\n+\t\t\t\t\t\t\t  expr.get_locus ());\n+  }\n+\n private:\n   ConstFoldExpr ()\n     : ConstFoldBase (), folded (ctx->get_backend ()->error_expression ())"}, {"sha": "d2f1dd5b6db6471ee24ff074d7b2934d56a0fae9", "filename": "gcc/testsuite/rust/compile/torture/constant3.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0114e3e5b3b222c190a640bdeda8e781042389c4/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fconstant3.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0114e3e5b3b222c190a640bdeda8e781042389c4/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fconstant3.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fconstant3.rs?ref=0114e3e5b3b222c190a640bdeda8e781042389c4", "patch": "@@ -0,0 +1,10 @@\n+fn main() {\n+    const A: [i32; 3] = [1, 2, 3];\n+    const B: i32 = A[1];\n+    const C: usize = 42;\n+    const D: i32 = 7;\n+\n+    let _a = C;\n+    let _b: [i32; C] = [0; C];\n+    let _c = B + D;\n+}"}]}