{"sha": "5219955ccd44eaca6fd12b39acafc24c04602e97", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTIxOTk1NWNjZDQ0ZWFjYTZmZDEyYjM5YWNhZmMyNGMwNDYwMmU5Nw==", "commit": {"author": {"name": "Iain Sandoe", "email": "iain@sandoe.co.uk", "date": "2019-05-18T08:27:24Z"}, "committer": {"name": "Iain Sandoe", "email": "iains@gcc.gnu.org", "date": "2019-05-18T08:27:24Z"}, "message": "objective-c - add instancetype.\n\nThe instancetype has been added as a typedef alias to id\nin order to allow diagnosis of cases where a class is used\nor returned where an instance is expected.\n\nThis adds the typedef, and tests that we can parse it.\nIt doesn't alter the diagnostics yet.\n\ngcc/objc/\n\n2019-05-18  Iain Sandoe  <iain@sandoe.co.uk>\n\n\t* objc/objc-act.h (OCTI_INSTANCE_TYPE, OCTI_INSTANCETYPE_NAME): New.\n\t(objc_global_trees): Add instance type and name.\n\t(INSTANCE_TYPEDEF_NAME): New.\n\t* objc/objc-act.c (synth_module_prologue): Build decls for\n\tobjc_instancetype_type and objc_instancetype_name.\n\ngcc/testsuite/\n\n2019-05-18  Iain Sandoe  <iain@sandoe.co.uk>\n\n\t* objc.dg/instancetype-0.m: New.\n\nFrom-SVN: r271370", "tree": {"sha": "3377ebdc1bfccee1b67415ffb232730595a1937b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3377ebdc1bfccee1b67415ffb232730595a1937b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5219955ccd44eaca6fd12b39acafc24c04602e97", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5219955ccd44eaca6fd12b39acafc24c04602e97", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5219955ccd44eaca6fd12b39acafc24c04602e97", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5219955ccd44eaca6fd12b39acafc24c04602e97/comments", "author": {"login": "iains", "id": 4039407, "node_id": "MDQ6VXNlcjQwMzk0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/4039407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iains", "html_url": "https://github.com/iains", "followers_url": "https://api.github.com/users/iains/followers", "following_url": "https://api.github.com/users/iains/following{/other_user}", "gists_url": "https://api.github.com/users/iains/gists{/gist_id}", "starred_url": "https://api.github.com/users/iains/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iains/subscriptions", "organizations_url": "https://api.github.com/users/iains/orgs", "repos_url": "https://api.github.com/users/iains/repos", "events_url": "https://api.github.com/users/iains/events{/privacy}", "received_events_url": "https://api.github.com/users/iains/received_events", "type": "User", "site_admin": false}, "committer": {"login": "iains", "id": 4039407, "node_id": "MDQ6VXNlcjQwMzk0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/4039407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iains", "html_url": "https://github.com/iains", "followers_url": "https://api.github.com/users/iains/followers", "following_url": "https://api.github.com/users/iains/following{/other_user}", "gists_url": "https://api.github.com/users/iains/gists{/gist_id}", "starred_url": "https://api.github.com/users/iains/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iains/subscriptions", "organizations_url": "https://api.github.com/users/iains/orgs", "repos_url": "https://api.github.com/users/iains/repos", "events_url": "https://api.github.com/users/iains/events{/privacy}", "received_events_url": "https://api.github.com/users/iains/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c141668376b558228712f643ec643c94765c5e6c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c141668376b558228712f643ec643c94765c5e6c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c141668376b558228712f643ec643c94765c5e6c"}], "stats": {"total": 59, "additions": 57, "deletions": 2}, "files": [{"sha": "be06df7c339eeecef9721549bf1f6734f02db577", "filename": "gcc/objc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Fobjc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Fobjc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fobjc%2FChangeLog?ref=5219955ccd44eaca6fd12b39acafc24c04602e97", "patch": "@@ -1,3 +1,11 @@\n+2019-05-18  Iain Sandoe  <iain@sandoe.co.uk>\n+\n+\t* objc/objc-act.h (OCTI_INSTANCE_TYPE, OCTI_INSTANCETYPE_NAME): New.\n+\t(objc_global_trees): Add instance type and name.\n+\t(INSTANCE_TYPEDEF_NAME): New.\n+\t* objc/objc-act.c (synth_module_prologue): Build decls for\n+\tobjc_instancetype_type and objc_instancetype_name.\n+\n 2019-05-16  Martin Sebor  <msebor@redhat.com>\n \n         * objc-act.c (objc_begin_catch_clause): Quote keywords and options"}, {"sha": "2173092ae2647398c066ec735de11e4f854d5003", "filename": "gcc/objc/objc-act.c", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Fobjc%2Fobjc-act.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Fobjc%2Fobjc-act.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fobjc%2Fobjc-act.c?ref=5219955ccd44eaca6fd12b39acafc24c04602e97", "patch": "@@ -2950,18 +2950,26 @@ synth_module_prologue (void)\n   objc_class_reference = xref_tag (RECORD_TYPE, objc_class_id);\n \n   objc_object_type = build_pointer_type (objc_object_reference);\n+  objc_instancetype_type = build_pointer_type (objc_object_reference);\n   objc_class_type = build_pointer_type (objc_class_reference);\n \n   objc_object_name = get_identifier (OBJECT_TYPEDEF_NAME);\n+  objc_instancetype_name = get_identifier (INSTANCE_TYPEDEF_NAME);\n   objc_class_name = get_identifier (CLASS_TYPEDEF_NAME);\n \n-  /* Declare the 'id' and 'Class' typedefs.  */\n+  /* Declare the 'id', 'instancetype' and 'Class' typedefs.  */\n   type = lang_hooks.decls.pushdecl (build_decl (input_location,\n \t\t\t\t\t\tTYPE_DECL,\n \t\t\t\t\t\tobjc_object_name,\n \t\t\t\t\t\tobjc_object_type));\n   TREE_NO_WARNING (type) = 1;\n \n+  type = lang_hooks.decls.pushdecl (build_decl (input_location,\n+\t\t\t\t\t\tTYPE_DECL,\n+\t\t\t\t\t\tobjc_instancetype_name,\n+\t\t\t\t\t\tobjc_instancetype_type));\n+  TREE_NO_WARNING (type) = 1;\n+\n   type = lang_hooks.decls.pushdecl (build_decl (input_location,\n \t\t\t\t\t\tTYPE_DECL,\n \t\t\t\t\t\tobjc_class_name,"}, {"sha": "3b690432544a2328cbc6f149e76cdbca3b428979", "filename": "gcc/objc/objc-act.h", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Fobjc%2Fobjc-act.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Fobjc%2Fobjc-act.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fobjc%2Fobjc-act.h?ref=5219955ccd44eaca6fd12b39acafc24c04602e97", "patch": "@@ -313,6 +313,7 @@ enum objc_tree_index\n     OCTI_SUPER_TYPE,\n     OCTI_SEL_TYPE,\n     OCTI_ID_TYPE,\n+    OCTI_INSTANCE_TYPE,\n     OCTI_CLS_TYPE,\n     OCTI_NST_TYPE,\n     OCTI_PROTO_TYPE,\n@@ -368,6 +369,7 @@ enum objc_tree_index\n     OCTI_OBJ_ID,\n     OCTI_CLS_ID,\n     OCTI_ID_NAME,\n+    OCTI_INSTANCETYPE_NAME,\n     OCTI_CLASS_NAME,\n     OCTI_CNST_STR_ID,\n     OCTI_CNST_STR_TYPE,\n@@ -443,6 +445,7 @@ extern GTY(()) tree objc_global_trees[OCTI_MAX];\n #define objc_super_type\t\tobjc_global_trees[OCTI_SUPER_TYPE]\n #define objc_selector_type\t\tobjc_global_trees[OCTI_SEL_TYPE]\n #define objc_object_type\tobjc_global_trees[OCTI_ID_TYPE]\n+#define objc_instancetype_type\tobjc_global_trees[OCTI_INSTANCE_TYPE]\n #define objc_class_type\t\tobjc_global_trees[OCTI_CLS_TYPE]\n #define objc_instance_type\tobjc_global_trees[OCTI_NST_TYPE]\n #define objc_protocol_type\tobjc_global_trees[OCTI_PROTO_TYPE]\n@@ -570,7 +573,8 @@ extern GTY(()) tree objc_global_trees[OCTI_MAX];\n \n #define objc_object_id\t\tobjc_global_trees[OCTI_OBJ_ID]\n #define objc_class_id\t\tobjc_global_trees[OCTI_CLS_ID]\n-#define objc_object_name\t\tobjc_global_trees[OCTI_ID_NAME]\n+#define objc_object_name        objc_global_trees[OCTI_ID_NAME]\n+#define objc_instancetype_name\tobjc_global_trees[OCTI_INSTANCETYPE_NAME]\n #define objc_class_name\t\tobjc_global_trees[OCTI_CLASS_NAME]\n \n /* Constant string classes.  */\n@@ -608,6 +612,7 @@ extern GTY(()) tree objc_global_trees[OCTI_MAX];\n /* Reserved tag definitions.  */\n \n #define OBJECT_TYPEDEF_NAME\t\t\"id\"\n+#define INSTANCE_TYPEDEF_NAME\t\t\"instancetype\"\n #define CLASS_TYPEDEF_NAME\t\t\"Class\"\n \n #define TAG_OBJECT\t\t\t\"objc_object\""}, {"sha": "5eb765000e9d32e6600184dd17ee91830581931c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=5219955ccd44eaca6fd12b39acafc24c04602e97", "patch": "@@ -1,3 +1,7 @@\n+2019-05-18  Iain Sandoe  <iain@sandoe.co.uk>\n+\n+\t* objc.dg/instancetype-0.m: New.\n+\n 2019-05-17  Martin Sebor  <msebor@redhat.com>\n \n \t* gcc.dg/gcc_diag-11.c: Remove accidentally committed test."}, {"sha": "32cafdf314c328e58e6560c8d615b8714eabbb68", "filename": "gcc/testsuite/objc.dg/instancetype-0.m", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Ftestsuite%2Fobjc.dg%2Finstancetype-0.m", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5219955ccd44eaca6fd12b39acafc24c04602e97/gcc%2Ftestsuite%2Fobjc.dg%2Finstancetype-0.m", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fobjc.dg%2Finstancetype-0.m?ref=5219955ccd44eaca6fd12b39acafc24c04602e97", "patch": "@@ -0,0 +1,30 @@\n+/* Contributed by Iain Sandoe <iain@sandoe.co.uk>, May 2019.  */\n+/* { dg-do compile } */\n+\n+/* Basic check of parsing instancetype.  */\n+\n+extern id class_createInstance (id, int);\n+extern id class_getSuperclass (id);\n+\n+@interface MyObject\n+{\n+  Class isa;\n+}\n++ (instancetype)alloc;\n+- (instancetype)init;\n++ (instancetype)initialize;\n++ (instancetype)factoryMethodA;\n++ (id)factoryMethodB;\n++ (Class) class;\n++ (Class) superclass;\n+@end\n+\n+@implementation MyObject\n++ (instancetype)alloc { return class_createInstance (self, 0); }\n+- (instancetype)init  { return self; }\n++ (instancetype)initialize { return self; }\n++ (instancetype)factoryMethodA { return [[[self class] alloc] init]; }\n++ (id)factoryMethodB { return [[[self class] alloc] init]; }\n++ (Class) class { return self; }\n++ (Class) superclass { return class_getSuperclass (self); }\n+@end"}]}