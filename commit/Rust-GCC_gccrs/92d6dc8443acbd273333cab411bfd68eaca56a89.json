{"sha": "92d6dc8443acbd273333cab411bfd68eaca56a89", "node_id": "C_kwDOANBUbNoAKDkyZDZkYzg0NDNhY2JkMjczMzMzY2FiNDExYmZkNjhlYWNhNTZhODk", "commit": {"author": {"name": "Owen Avery", "email": "powerboat9.gamer@gmail.com", "date": "2023-01-08T22:19:12Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2023-02-14T22:00:59Z"}, "message": "Implemented UTF-8 checking for include_str!()\n\ngcc/rust/ChangeLog:\n\n\t* expand/rust-macro-builtins.cc\n\t(MacroBuiltin::include_str_handler): Add check for valid UTF-8.\n\ngcc/testsuite/ChangeLog:\n\n\t* rust/compile/builtin_macro_include_str.rs:\n\tInclude test of invalid UTF-8.\n\t* rust/compile/invalid_utf8: File with invalid UTF-8.\n\nSigned-off-by: Owen Avery <powerboat9.gamer@gmail.com>", "tree": {"sha": "a490a24c931e81646fb7c7e0e22ba3e887b0f2d5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a490a24c931e81646fb7c7e0e22ba3e887b0f2d5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/92d6dc8443acbd273333cab411bfd68eaca56a89", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/92d6dc8443acbd273333cab411bfd68eaca56a89", "html_url": "https://github.com/Rust-GCC/gccrs/commit/92d6dc8443acbd273333cab411bfd68eaca56a89", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/92d6dc8443acbd273333cab411bfd68eaca56a89/comments", "author": {"login": "powerboat9", "id": 7397652, "node_id": "MDQ6VXNlcjczOTc2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/7397652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/powerboat9", "html_url": "https://github.com/powerboat9", "followers_url": "https://api.github.com/users/powerboat9/followers", "following_url": "https://api.github.com/users/powerboat9/following{/other_user}", "gists_url": "https://api.github.com/users/powerboat9/gists{/gist_id}", "starred_url": "https://api.github.com/users/powerboat9/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/powerboat9/subscriptions", "organizations_url": "https://api.github.com/users/powerboat9/orgs", "repos_url": "https://api.github.com/users/powerboat9/repos", "events_url": "https://api.github.com/users/powerboat9/events{/privacy}", "received_events_url": "https://api.github.com/users/powerboat9/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "665e53cc3e244c9b9fd1e919d7f75576d4198be0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/665e53cc3e244c9b9fd1e919d7f75576d4198be0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/665e53cc3e244c9b9fd1e919d7f75576d4198be0"}], "stats": {"total": 53, "additions": 51, "deletions": 2}, "files": [{"sha": "3b6f69bbd6968db0a78a2f3acff9e0870e05cfe7", "filename": "gcc/rust/expand/rust-macro-builtins.cc", "status": "modified", "additions": 49, "deletions": 2, "changes": 51, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/92d6dc8443acbd273333cab411bfd68eaca56a89/gcc%2Frust%2Fexpand%2Frust-macro-builtins.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/92d6dc8443acbd273333cab411bfd68eaca56a89/gcc%2Frust%2Fexpand%2Frust-macro-builtins.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fexpand%2Frust-macro-builtins.cc?ref=92d6dc8443acbd273333cab411bfd68eaca56a89", "patch": "@@ -389,8 +389,55 @@ MacroBuiltin::include_str_handler (Location invoc_locus,\n \n   std::vector<uint8_t> bytes = load_file_bytes (target_filename.c_str ());\n \n-  /* FIXME: Enforce that the file contents are valid UTF-8.  */\n-  std::string str ((const char *) &bytes[0], bytes.size ());\n+  /* FIXME: reuse lexer */\n+  int expect_single = 0;\n+  for (uint8_t b : bytes)\n+    {\n+      if (expect_single)\n+\t{\n+\t  if ((b & 0xC0) != 0x80)\n+\t    /* character was truncated, exit with expect_single != 0 */\n+\t    break;\n+\t  expect_single--;\n+\t}\n+      else if (b & 0x80)\n+\t{\n+\t  if (b >= 0xF8)\n+\t    {\n+\t      /* more than 4 leading 1s */\n+\t      expect_single = 1;\n+\t      break;\n+\t    }\n+\t  else if (b >= 0xF0)\n+\t    {\n+\t      /* 4 leading 1s */\n+\t      expect_single = 3;\n+\t    }\n+\t  else if (b >= 0xE0)\n+\t    {\n+\t      /* 3 leading 1s */\n+\t      expect_single = 2;\n+\t    }\n+\t  else if (b >= 0xC0)\n+\t    {\n+\t      /* 2 leading 1s */\n+\t      expect_single = 1;\n+\t    }\n+\t  else\n+\t    {\n+\t      /* only 1 leading 1 */\n+\t      expect_single = 1;\n+\t      break;\n+\t    }\n+\t}\n+    }\n+\n+  std::string str;\n+  if (expect_single)\n+    rust_error_at (invoc_locus, \"%s was not a valid utf-8 file\",\n+\t\t   target_filename.c_str ());\n+  else\n+    str = std::string ((const char *) &bytes[0], bytes.size ());\n \n   auto node = AST::SingleASTNode (make_string (invoc_locus, str));\n   auto str_tok = make_token (Token::make_string (invoc_locus, std::move (str)));"}, {"sha": "8092193195d9dd7e689f66d35b371ce36255ad6d", "filename": "gcc/testsuite/rust/compile/builtin_macro_include_str.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/92d6dc8443acbd273333cab411bfd68eaca56a89/gcc%2Ftestsuite%2Frust%2Fcompile%2Fbuiltin_macro_include_str.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/92d6dc8443acbd273333cab411bfd68eaca56a89/gcc%2Ftestsuite%2Frust%2Fcompile%2Fbuiltin_macro_include_str.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fbuiltin_macro_include_str.rs?ref=92d6dc8443acbd273333cab411bfd68eaca56a89", "patch": "@@ -10,4 +10,5 @@ fn main () {\n   include_str! (\"foo.txt\", \"bar.txt\"); // { dg-error \"macro takes 1 argument\" \"\" }\n   include_str! (\"builtin_macro_include_str.rs\"); // ok\n   include_str! (\"builtin_macro_include_str.rs\",); // trailing comma ok\n+  include_str! (\"invalid_utf8\"); // { dg-error \"invalid_utf8 was not a valid utf-8 file\" \"\" }\n }"}, {"sha": "29e181ebb88626236ef10f2af5bc94781c8061f1", "filename": "gcc/testsuite/rust/compile/invalid_utf8", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/92d6dc8443acbd273333cab411bfd68eaca56a89/gcc%2Ftestsuite%2Frust%2Fcompile%2Finvalid_utf8", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/92d6dc8443acbd273333cab411bfd68eaca56a89/gcc%2Ftestsuite%2Frust%2Fcompile%2Finvalid_utf8", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Finvalid_utf8?ref=92d6dc8443acbd273333cab411bfd68eaca56a89", "patch": "@@ -0,0 +1 @@\n+\ufffd"}]}