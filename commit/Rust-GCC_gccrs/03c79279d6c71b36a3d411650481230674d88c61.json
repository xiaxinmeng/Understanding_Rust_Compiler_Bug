{"sha": "03c79279d6c71b36a3d411650481230674d88c61", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDNjNzkyNzlkNmM3MWIzNmEzZDQxMTY1MDQ4MTIzMDY3NGQ4OGM2MQ==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonber@gnat.com", "date": "2004-10-27T13:40:55Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2004-10-27T13:40:55Z"}, "message": "sem_ch12.adb (In_Main_Context): Predicate to determine whether the current instance appears within a unit that...\n\n2004-10-26  Ed Schonberg  <schonberg@gnat.com>\n\t    Javier Miranda  <miranda@gnat.com>\n\n\t* sem_ch12.adb (In_Main_Context): Predicate to determine whether the\n\tcurrent instance appears within a unit that is directly in the context\n\tof the main unit.\n\tUsed to determine whether the body of the instance should be analyzed\n\timmediately after its spec, to make its subprogram bodies available\n\tfor front-end inlining.\n\t(Analyze_Formal_Array_Type): Cleanup condition that checks that range\n\tconstraint is not allowed on the component type (AARM 12.5.3(3))\n\nFrom-SVN: r89667", "tree": {"sha": "c3b03b1a46d0310adb9a61c2e63e813d71ab7548", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c3b03b1a46d0310adb9a61c2e63e813d71ab7548"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/03c79279d6c71b36a3d411650481230674d88c61", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/03c79279d6c71b36a3d411650481230674d88c61", "html_url": "https://github.com/Rust-GCC/gccrs/commit/03c79279d6c71b36a3d411650481230674d88c61", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/03c79279d6c71b36a3d411650481230674d88c61/comments", "author": null, "committer": null, "parents": [{"sha": "10b6063358b80caf65dbab1ac0dd3844a3b9a8ac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/10b6063358b80caf65dbab1ac0dd3844a3b9a8ac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/10b6063358b80caf65dbab1ac0dd3844a3b9a8ac"}], "stats": {"total": 64, "additions": 60, "deletions": 4}, "files": [{"sha": "b1779e118f86a72c24a96cc2bc866a79084f4c09", "filename": "gcc/ada/sem_ch12.adb", "status": "modified", "additions": 60, "deletions": 4, "changes": 64, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/03c79279d6c71b36a3d411650481230674d88c61/gcc%2Fada%2Fsem_ch12.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/03c79279d6c71b36a3d411650481230674d88c61/gcc%2Fada%2Fsem_ch12.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch12.adb?ref=03c79279d6c71b36a3d411650481230674d88c61", "patch": "@@ -400,6 +400,11 @@ package body Sem_Ch12 is\n    --  of the instance can be placed after the freeze node of the parent,\n    --  which it itself an instance.\n \n+   function In_Main_Context (E : Entity_Id) return Boolean;\n+   --  Check whether an instantiation is in the context of the main unit.\n+   --  Used to determine whether its body should be elaborated to allow\n+   --  front-end inlining.\n+\n    procedure Set_Instance_Env\n      (Gen_Unit : Entity_Id;\n       Act_Unit : Entity_Id);\n@@ -1207,14 +1212,19 @@ package body Sem_Ch12 is\n       then\n          Error_Msg_N (\"premature usage of incomplete type\", Def);\n \n+      --  Check that range constraint is not allowed on the component type\n+      --  of a generic formal array type (AARM 12.5.3(3))\n+\n       elsif Is_Internal (Component_Type (T))\n+        and then Present (Subtype_Indication (Component_Definition (Def)))\n         and then Nkind (Original_Node\n                         (Subtype_Indication (Component_Definition (Def))))\n-          /= N_Attribute_Reference\n+          = N_Subtype_Indication\n       then\n          Error_Msg_N\n-           (\"only a subtype mark is allowed in a formal\",\n-              Subtype_Indication (Component_Definition (Def)));\n+           (\"in a formal, a subtype indication can only be \"\n+             & \"a subtype mark ('R'M 12.5.3(3))\",\n+             Subtype_Indication (Component_Definition (Def)));\n       end if;\n \n    end Analyze_Formal_Array_Type;\n@@ -2563,7 +2573,8 @@ package body Sem_Ch12 is\n               and then Expander_Active\n               and then (not Is_Child_Unit (Gen_Unit)\n                          or else not Is_Generic_Unit (Scope (Gen_Unit)))\n-              and then Is_In_Main_Unit (N)\n+              and then (Is_In_Main_Unit (N)\n+                          or else In_Main_Context (Current_Scope))\n               and then Nkind (Parent (N)) /= N_Compilation_Unit\n               and then Might_Inline_Subp\n               and then not Is_Actual_Pack\n@@ -5772,6 +5783,51 @@ package body Sem_Ch12 is\n       return False;\n    end In_Same_Declarative_Part;\n \n+   ---------------------\n+   -- In_Main_Context --\n+   ---------------------\n+\n+   function In_Main_Context (E : Entity_Id) return Boolean is\n+      Context : List_Id;\n+      Clause  : Node_Id;\n+      Nam     : Node_Id;\n+\n+   begin\n+      if not Is_Compilation_Unit (E)\n+        or else Ekind (E) /= E_Package\n+        or else In_Private_Part (E)\n+      then\n+         return False;\n+      end if;\n+\n+      Context := Context_Items (Cunit (Main_Unit));\n+\n+      Clause  := First (Context);\n+      while Present (Clause) loop\n+         if Nkind (Clause) = N_With_Clause then\n+            Nam := Name (Clause);\n+\n+            --  If the current scope is part of the context of the main unit,\n+            --  analysis of the corresponding with_clause is not complete, and\n+            --  the entity is not set. We use the Chars field directly, which\n+            --  might produce false positives in rare cases, but guarantees\n+            --  that we produce all the instance bodies we will need.\n+\n+            if (Nkind (Nam) = N_Identifier\n+                 and then Chars (Nam) = Chars (E))\n+              or else (Nkind (Nam) = N_Selected_Component\n+                        and then Chars (Selector_Name (Nam)) = Chars (E))\n+            then\n+               return True;\n+            end if;\n+         end if;\n+\n+         Next (Clause);\n+      end loop;\n+\n+      return False;\n+   end In_Main_Context;\n+\n    ---------------------\n    -- Inherit_Context --\n    ---------------------"}]}