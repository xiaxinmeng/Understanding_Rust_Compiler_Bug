{"sha": "9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "node_id": "C_kwDOANBUbNoAKDljYmQyNzA2MzJiZDBjYjZiNGZjMDRmZGJjOTNiMTcwNjY5ZmExNTk", "commit": {"author": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-02-01T10:40:13Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-04-06T08:47:18Z"}, "message": "gccrs: parser: Allow parsing multiple reference types\n\nThe parser now recursively tries to parse a reference type after seeing\na `&` or `&&` token.\n\ngcc/rust/ChangeLog:\n\n\t* parse/rust-parse-impl.h (Parser::parse_type): Handle double ampersan\n\tproperly\n\t(Parser::parse_reference_type): Call into `parse_reference_type_inner`\n\tand wrap double reference types in another `AST::ReferenceType` node\n\t(Parser::parse_reference_type_inner): Add parsing implementation\n\twhich does not care about the leading token (& or  &&)\n\t(Parser::parse_type_no_bounds): Handle double ampersand properly\n\t* parse/rust-parse.h: Declare `parse_reference_type_inner`\n\ngcc/testsuite/ChangeLog:\n\n\t* rust/compile/multi_reference_type.rs: New test.", "tree": {"sha": "ddd03d90a202bb328fac8c6b445dd54c2b5ae694", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ddd03d90a202bb328fac8c6b445dd54c2b5ae694"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad9d75f50804a983a06e2fdf69772188432359ae", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ad9d75f50804a983a06e2fdf69772188432359ae", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ad9d75f50804a983a06e2fdf69772188432359ae"}], "stats": {"total": 47, "additions": 41, "deletions": 6}, "files": [{"sha": "23b033fb26e6708db19805c74a2a1cfc1352c648", "filename": "gcc/rust/parse/rust-parse-impl.h", "status": "modified", "additions": 27, "deletions": 6, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/gcc%2Frust%2Fparse%2Frust-parse-impl.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/gcc%2Frust%2Fparse%2Frust-parse-impl.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fparse%2Frust-parse-impl.h?ref=9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "patch": "@@ -9237,6 +9237,7 @@ Parser<ManagedTokenSource>::parse_type (bool save_errors)\n       // raw pointer type\n       return parse_raw_pointer_type ();\n     case AMP: // does this also include AMP_AMP?\n+    case LOGICAL_AND:\n       // reference type\n       return parse_reference_type ();\n       case LIFETIME: {\n@@ -9886,14 +9887,10 @@ Parser<ManagedTokenSource>::parse_bare_function_type (\n \t\t\t       std::move (return_type), best_try_locus));\n }\n \n-// Parses a reference type (mutable or immutable, with given lifetime).\n template <typename ManagedTokenSource>\n std::unique_ptr<AST::ReferenceType>\n-Parser<ManagedTokenSource>::parse_reference_type ()\n+Parser<ManagedTokenSource>::parse_reference_type_inner (Location locus)\n {\n-  Location locus = lexer.peek_token ()->get_locus ();\n-  skip_token (AMP);\n-\n   // parse optional lifetime\n   AST::Lifetime lifetime = AST::Lifetime::error ();\n   if (lexer.peek_token ()->get_id () == LIFETIME)\n@@ -9932,6 +9929,29 @@ Parser<ManagedTokenSource>::parse_reference_type ()\n \t\t\t    std::move (lifetime)));\n }\n \n+// Parses a reference type (mutable or immutable, with given lifetime).\n+template <typename ManagedTokenSource>\n+std::unique_ptr<AST::ReferenceType>\n+Parser<ManagedTokenSource>::parse_reference_type ()\n+{\n+  auto t = lexer.peek_token ();\n+  auto locus = t->get_locus ();\n+\n+  switch (t->get_id ())\n+    {\n+    case AMP:\n+      skip_token (AMP);\n+      return parse_reference_type_inner (locus);\n+    case LOGICAL_AND:\n+      skip_token (LOGICAL_AND);\n+      return std::unique_ptr<AST::ReferenceType> (\n+\tnew AST::ReferenceType (false, parse_reference_type_inner (locus),\n+\t\t\t\tlocus));\n+    default:\n+      gcc_unreachable ();\n+    }\n+}\n+\n // Parses a raw (unsafe) pointer type.\n template <typename ManagedTokenSource>\n std::unique_ptr<AST::RawPointerType>\n@@ -10079,7 +10099,8 @@ Parser<ManagedTokenSource>::parse_type_no_bounds ()\n     case ASTERISK:\n       // raw pointer type\n       return parse_raw_pointer_type ();\n-    case AMP: // does this also include AMP_AMP?\n+    case AMP: // does this also include AMP_AMP? Yes! Which is... LOGICAL_AND?\n+    case LOGICAL_AND:\n       // reference type\n       return parse_reference_type ();\n     case LIFETIME:"}, {"sha": "2f767bb2a53aea6db0bea03f8e084129790e8a8d", "filename": "gcc/rust/parse/rust-parse.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/gcc%2Frust%2Fparse%2Frust-parse.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/gcc%2Frust%2Fparse%2Frust-parse.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fparse%2Frust-parse.h?ref=9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "patch": "@@ -604,6 +604,8 @@ template <typename ManagedTokenSource> class Parser\n   std::unique_ptr<AST::TypeNoBounds> parse_type_no_bounds ();\n   std::unique_ptr<AST::TypeNoBounds> parse_slice_or_array_type ();\n   std::unique_ptr<AST::RawPointerType> parse_raw_pointer_type ();\n+  std::unique_ptr<AST::ReferenceType>\n+  parse_reference_type_inner (Location locus);\n   std::unique_ptr<AST::ReferenceType> parse_reference_type ();\n   std::unique_ptr<AST::BareFunctionType>\n   parse_bare_function_type (std::vector<AST::LifetimeParam> for_lifetimes);"}, {"sha": "5ad7d84adbc20fb85b328bb66ad4e33803269dc5", "filename": "gcc/testsuite/rust/compile/multi_reference_type.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmulti_reference_type.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9cbd270632bd0cb6b4fc04fdbc93b170669fa159/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmulti_reference_type.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fmulti_reference_type.rs?ref=9cbd270632bd0cb6b4fc04fdbc93b170669fa159", "patch": "@@ -0,0 +1,12 @@\n+fn main() {\n+    let a = 15u8;\n+    let a: &u8 = &a;\n+    let a: &&u8 = &a;\n+    let a: &&&u8 = &a;\n+    let _: &&&&u8 = &a;\n+\n+    let _: &&u8;\n+    let _: &mut &u8;\n+    let _: &&mut u8;\n+    let _: &mut &mut &u8;\n+}"}]}