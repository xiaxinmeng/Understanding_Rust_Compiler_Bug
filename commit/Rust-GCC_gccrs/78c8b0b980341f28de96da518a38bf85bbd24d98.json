{"sha": "78c8b0b980341f28de96da518a38bf85bbd24d98", "node_id": "C_kwDOANBUbNoAKDc4YzhiMGI5ODAzNDFmMjhkZTk2ZGE1MThhMzhiZjg1YmJkMjRkOTg", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2022-05-09T11:51:32Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2022-05-12T10:44:59Z"}, "message": "c++: Support module language-decl semantics\n\nIn modules purview, one can attach a declaration to the global module\n(i.e. not the named module in whence the declaration appears), using a\nlanguage declaration:\n\n  export module Foo;\n  extern \"C++\" void *operator new (std::size_t);\n\nThis implements those semantics.\n\n\tgcc/cp/\n\t* parser.cc (cp_parser_linkage_specification): Implement\n\tglobal module attachment semantics.\n\tgcc/testsuite/\n\t* g++.dg/modules/lang-3_a.C: New.\n\t* g++.dg/modules/lang-3_b.C: New.\n\t* g++.dg/modules/lang-3_c.C: New.", "tree": {"sha": "217867ee60c1cb15c1567f28bf680885ec4ce7a0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/217867ee60c1cb15c1567f28bf680885ec4ce7a0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/78c8b0b980341f28de96da518a38bf85bbd24d98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/78c8b0b980341f28de96da518a38bf85bbd24d98", "html_url": "https://github.com/Rust-GCC/gccrs/commit/78c8b0b980341f28de96da518a38bf85bbd24d98", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/78c8b0b980341f28de96da518a38bf85bbd24d98/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c9364f29e7e47eb9de33f2d8843d5b00284ceca", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3c9364f29e7e47eb9de33f2d8843d5b00284ceca", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3c9364f29e7e47eb9de33f2d8843d5b00284ceca"}], "stats": {"total": 50, "additions": 50, "deletions": 0}, "files": [{"sha": "8969ed0076a649f1f8c5cde6aebd7dce106482eb", "filename": "gcc/cp/parser.cc", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Fcp%2Fparser.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Fcp%2Fparser.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fparser.cc?ref=78c8b0b980341f28de96da518a38bf85bbd24d98", "patch": "@@ -16189,6 +16189,8 @@ cp_parser_linkage_specification (cp_parser* parser, tree prefix_attr)\n     linkage = get_identifier (TREE_STRING_POINTER (linkage));\n \n   /* We're now using the new linkage.  */\n+  unsigned saved_module = module_kind;\n+  module_kind &= ~MK_ATTACH;\n   push_lang_context (linkage);\n \n   /* Preserve the location of the innermost linkage specification,\n@@ -16235,6 +16237,7 @@ cp_parser_linkage_specification (cp_parser* parser, tree prefix_attr)\n \n   /* We're done with the linkage-specification.  */\n   pop_lang_context ();\n+  module_kind = saved_module;\n \n   /* Restore location of parent linkage specification, if any.  */\n   parser->innermost_linkage_specification_location = saved_location;"}, {"sha": "1c6fa1fa2e996342ea76795a44f1e802306c518f", "filename": "gcc/testsuite/g++.dg/modules/lang-3_a.C", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_a.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_a.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_a.C?ref=78c8b0b980341f28de96da518a38bf85bbd24d98", "patch": "@@ -0,0 +1,17 @@\n+// { dg-additional-options \"-fmodules-ts -Wno-pedantic\" }\n+module;\n+# 4 __FILE__ 1\n+void Quux ();\n+# 6 \"\" 2\n+export module bob;\n+// { dg-module-cmi bob }\n+\n+extern \"C++\" \n+{\n+export void Bar () {}\n+export void Quux ();\n+void Baz () {}\n+}\n+\n+// { dg-final { scan-assembler {_Z3Barv:} } }\n+// { dg-final { scan-assembler {_Z3Bazv:} } }"}, {"sha": "17300ece699371af1ae2b3c20ee7175dfe7d46de", "filename": "gcc/testsuite/g++.dg/modules/lang-3_b.C", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_b.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_b.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_b.C?ref=78c8b0b980341f28de96da518a38bf85bbd24d98", "patch": "@@ -0,0 +1,18 @@\n+// { dg-additional-options -fmodules-ts }\n+import bob;\n+\n+void Foo () \n+{\n+  Bar ();\n+  Baz (); // { dg-error \"was not declared\" }\n+  Quux ();\n+}\n+\n+void Bar ();\n+void Baz ();\n+\n+void Quux ()\n+{\n+  Bar ();\n+  Baz ();\n+}"}, {"sha": "ca18db72ad89ec0e0725792c7b9dfca26c19e277", "filename": "gcc/testsuite/g++.dg/modules/lang-3_c.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_c.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/78c8b0b980341f28de96da518a38bf85bbd24d98/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_c.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Flang-3_c.C?ref=78c8b0b980341f28de96da518a38bf85bbd24d98", "patch": "@@ -0,0 +1,12 @@\n+// { dg-additional-options -fmodules-ts }\n+module bob;\n+\n+void Foo () \n+{\n+  Bar ();\n+  Baz ();\n+}\n+\n+extern \"C++\" void Bar ();\n+extern \"C++\" void Baz ();\n+"}]}