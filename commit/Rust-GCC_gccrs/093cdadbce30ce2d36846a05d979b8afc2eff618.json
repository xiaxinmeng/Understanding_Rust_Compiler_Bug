{"sha": "093cdadbce30ce2d36846a05d979b8afc2eff618", "node_id": "C_kwDOANBUbNoAKDA5M2NkYWRiY2UzMGNlMmQzNjg0NmEwNWQ5NzliOGFmYzJlZmY2MTg", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-17T13:37:28Z"}, "committer": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-18T14:45:13Z"}, "message": "[openmp] Fix SIMT reduction using TRUTH_{AND,OR}IF_EXPR\n\nConsider test-case pr104952-1.c, included in this commit, containing:\n...\n  #pragma omp target map(tofrom:result) map(to:arr)\n  #pragma omp simd reduction(||: result)\n...\n\nWhen run on x86_64 with nvptx accelerator, the test-case either aborts or\nhangs.\n\nThe reduction clause is translated by the SIMT code (active for nvptx) as a\nbutterfly reduction loop with this butterfly shuffle / update pair:\n...\n  D.2163 = D.2163 || .GOMP_SIMT_XCHG_BFLY (D.2163, D.2164)\n...\nin the loop body.\n\nThe problem is that the butterfly shuffle is possibly not executed, while it\nneeds to be executed unconditionally.\n\nFix this by translating instead as:\n...\n  D.tmp_bfly = .GOMP_SIMT_XCHG_BFLY (D.2163, D.2164)\n  D.2163 = D.2163 || D.tmp_bfly\n...\n\nTested on x86_64-linux with nvptx accelerator.\n\ngcc/ChangeLog:\n\n2022-03-17  Tom de Vries  <tdevries@suse.de>\n\n\tPR target/104952\n\t* omp-low.cc (lower_rec_input_clauses): Make sure GOMP_SIMT_XCHG_BFLY\n\tis executed unconditionally.\n\nlibgomp/ChangeLog:\n\n2022-03-17  Tom de Vries  <tdevries@suse.de>\n\n\tPR target/104952\n\t* testsuite/libgomp.c/pr104952-1.c: New test.\n\t* testsuite/libgomp.c/pr104952-2.c: New test.", "tree": {"sha": "0c7e552417ad83f581717d24b57735a03fbb3c0a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0c7e552417ad83f581717d24b57735a03fbb3c0a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/093cdadbce30ce2d36846a05d979b8afc2eff618", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/093cdadbce30ce2d36846a05d979b8afc2eff618", "html_url": "https://github.com/Rust-GCC/gccrs/commit/093cdadbce30ce2d36846a05d979b8afc2eff618", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/093cdadbce30ce2d36846a05d979b8afc2eff618/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6393122d271a92d5d9d8656a57ea167e92498871", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6393122d271a92d5d9d8656a57ea167e92498871", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6393122d271a92d5d9d8656a57ea167e92498871"}], "stats": {"total": 51, "additions": 50, "deletions": 1}, "files": [{"sha": "392bb18bc5dd51965ee769e4db50f49a39a9a9be", "filename": "gcc/omp-low.cc", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/093cdadbce30ce2d36846a05d979b8afc2eff618/gcc%2Fomp-low.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/093cdadbce30ce2d36846a05d979b8afc2eff618/gcc%2Fomp-low.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.cc?ref=093cdadbce30ce2d36846a05d979b8afc2eff618", "patch": "@@ -6743,7 +6743,10 @@ lower_rec_input_clauses (tree clauses, gimple_seq *ilist, gimple_seq *dlist,\n \t\t\t  x = build_call_expr_internal_loc\n \t\t\t    (UNKNOWN_LOCATION, IFN_GOMP_SIMT_XCHG_BFLY,\n \t\t\t     TREE_TYPE (ivar), 2, ivar, simt_lane);\n-\t\t\t  x = build2 (code, TREE_TYPE (ivar), ivar, x);\n+\t\t\t  /* Make sure x is evaluated unconditionally.  */\n+\t\t\t  tree bfly_var = create_tmp_var (TREE_TYPE (ivar));\n+\t\t\t  gimplify_assign (bfly_var, x, &llist[2]);\n+\t\t\t  x = build2 (code, TREE_TYPE (ivar), ivar, bfly_var);\n \t\t\t  gimplify_assign (ivar, x, &llist[2]);\n \t\t\t}\n \t\t      tree ivar2 = ivar;"}, {"sha": "a3bfb1e77df28c0090b633d3fba55282e2979af9", "filename": "libgomp/testsuite/libgomp.c/pr104952-1.c", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/093cdadbce30ce2d36846a05d979b8afc2eff618/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr104952-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/093cdadbce30ce2d36846a05d979b8afc2eff618/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr104952-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr104952-1.c?ref=093cdadbce30ce2d36846a05d979b8afc2eff618", "patch": "@@ -0,0 +1,24 @@\n+#define N 32\n+\n+static char arr[N];\n+\n+int\n+main (void)\n+{\n+  unsigned int result = 0;\n+\n+  for (unsigned int i = 0; i < N; ++i)\n+    arr[i] = 0;\n+\n+  arr[5] = 42;\n+\n+#pragma omp target map(tofrom:result) map(to:arr)\n+#pragma omp simd reduction(||: result)\n+  for (unsigned int i = 0; i < N; ++i)\n+    result = result || arr[i];\n+\n+  if (result != 1)\n+    __builtin_abort ();\n+\n+  return 0;\n+}"}, {"sha": "7ab4bcdb8af3ebb9fe0f6f71ae3d708e99fe7879", "filename": "libgomp/testsuite/libgomp.c/pr104952-2.c", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/093cdadbce30ce2d36846a05d979b8afc2eff618/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr104952-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/093cdadbce30ce2d36846a05d979b8afc2eff618/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr104952-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr104952-2.c?ref=093cdadbce30ce2d36846a05d979b8afc2eff618", "patch": "@@ -0,0 +1,22 @@\n+#define N 32\n+\n+static char arr[N];\n+\n+int\n+main (void)\n+{\n+  unsigned int result = 2;\n+\n+  for (unsigned int i = 0; i < N; ++i)\n+    arr[i] = i + 1;\n+\n+#pragma omp target map(tofrom:result) map(to:arr)\n+#pragma omp simd reduction(&&: result)\n+  for (unsigned int i = 0; i < N; ++i)\n+    result = result && arr[i];\n+\n+  if (result != 1)\n+    __builtin_abort ();\n+\n+  return 0;\n+}"}]}