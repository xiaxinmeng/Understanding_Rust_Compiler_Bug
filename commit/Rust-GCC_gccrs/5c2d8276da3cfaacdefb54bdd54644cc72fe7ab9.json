{"sha": "5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWMyZDgyNzZkYTNjZmFhY2RlZmI1NGJkZDU0NjQ0Y2M3MmZlN2FiOQ==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2004-11-19T11:25:28Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2004-11-19T11:25:28Z"}, "message": "make.adb (Gnatmake): Invoke gnatlink with -shared-libgcc when gnatbind is invoked with -shared.\n\n\t* make.adb (Gnatmake): Invoke gnatlink with -shared-libgcc when\n\tgnatbind is invoked with -shared.\n\nFrom-SVN: r90912", "tree": {"sha": "e6a56036a8cdb88c07612e74c0efc410508d8eb3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e6a56036a8cdb88c07612e74c0efc410508d8eb3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9/comments", "author": null, "committer": null, "parents": [{"sha": "edbe49d1f936a259ff4f6b6fe7dbb5a52b6e947f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/edbe49d1f936a259ff4f6b6fe7dbb5a52b6e947f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/edbe49d1f936a259ff4f6b6fe7dbb5a52b6e947f"}], "stats": {"total": 64, "additions": 38, "deletions": 26}, "files": [{"sha": "473c73cdfe0f0cb16f41bd2f8b8926ea6ff7f129", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 38, "deletions": 26, "changes": 64, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=5c2d8276da3cfaacdefb54bdd54644cc72fe7ab9", "patch": "@@ -357,9 +357,6 @@ package body Make is\n    --  added. Switch \"-shared\" is added if there is a non-static Library\n    --  Project File.\n \n-   Bind_Shared_Known : Boolean := False;\n-   --  Set to True after the first time Bind_Shared is computed\n-\n    Shared_Libgcc : aliased String := \"-shared-libgcc\";\n \n    No_Shared_Libgcc_Switch : aliased Argument_List := (1 .. 0 => null);\n@@ -3750,7 +3747,6 @@ package body Make is\n \n       Bind_Shared := No_Shared_Switch'Access;\n       Link_With_Shared_Libgcc := No_Shared_Libgcc_Switch'Access;\n-      Bind_Shared_Known := False;\n \n       Failed_Links.Set_Last (0);\n       Successful_Links.Set_Last (0);\n@@ -3969,7 +3965,8 @@ package body Make is\n          Write_Eol;\n          Write_Str (\"GNATMAKE \");\n          Write_Str (Gnatvsn.Gnat_Version_String);\n-         Write_Str (\" Copyright 1995-2004 Free Software Foundation, Inc.\");\n+         Write_Eol;\n+         Write_Str (\"Copyright 1995-2004 Free Software Foundation, Inc.\");\n          Write_Eol;\n       end if;\n \n@@ -4958,32 +4955,47 @@ package body Make is\n                Last_Arg : Natural := Binder_Switches.Last;\n                --  Index of the last argument in Args\n \n+               Shared_Libs : Boolean := False;\n+               --  Set to True when there are shared library project files or\n+               --  when gnatbind is invoked with -shared.\n+\n             begin\n-               --  If it is the first time the bind step is performed,\n-               --  check if there are shared libraries, so that gnatbind is\n-               --  called with -shared.\n+               --  Check if there are shared libraries, so that gnatbind is\n+               --  called with -shared. Check also if gnatbind is called with\n+               --  -shared, so that gnatlink is called with -shared-libgcc\n+               --  for GCC version 3 and above, ensuring that the shared\n+               --  version of libgcc will be used.\n \n-               if not Bind_Shared_Known then\n-                  if Main_Project /= No_Project\n-                     and then MLib.Tgt.Support_For_Libraries /= MLib.Tgt.None\n-                  then\n-                     for Proj in Projects.First .. Projects.Last loop\n-                        if Projects.Table (Proj).Library and then\n-                          Projects.Table (Proj).Library_Kind /= Static\n-                        then\n-                           Bind_Shared := Shared_Switch'Access;\n+               if Main_Project /= No_Project\n+                 and then MLib.Tgt.Support_For_Libraries /= MLib.Tgt.None\n+               then\n+                  for Proj in Projects.First .. Projects.Last loop\n+                     if Projects.Table (Proj).Library and then\n+                       Projects.Table (Proj).Library_Kind /= Static\n+                     then\n+                        Shared_Libs := True;\n+                        Bind_Shared := Shared_Switch'Access;\n+                        exit;\n+                     end if;\n+                  end loop;\n+               end if;\n \n-                           if GCC_Version >= 3 then\n-                              Link_With_Shared_Libgcc :=\n-                                Shared_Libgcc_Switch'Access;\n-                           end if;\n+               --  Check now for switch -shared\n \n-                           exit;\n-                        end if;\n-                     end loop;\n-                  end if;\n+               if not Shared_Libs then\n+                  for J in Binder_Switches.First .. Last_Arg loop\n+                     if Binder_Switches.Table (J).all = \"-shared\" then\n+                        Shared_Libs := True;\n+                        exit;\n+                     end if;\n+                  end loop;\n+               end if;\n+\n+               --  If there are shared libraries, invoke gnatlink with\n+               --  -shared-libgcc if GCC version is 3 or more.\n \n-                  Bind_Shared_Known := True;\n+               if Shared_Libs and then GCC_Version >= 3 then\n+                  Link_With_Shared_Libgcc := Shared_Libgcc_Switch'Access;\n                end if;\n \n                --  Get all the binder switches"}]}