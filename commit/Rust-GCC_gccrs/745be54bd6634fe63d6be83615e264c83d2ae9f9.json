{"sha": "745be54bd6634fe63d6be83615e264c83d2ae9f9", "node_id": "C_kwDOANBUbNoAKDc0NWJlNTRiZDY2MzRmZTYzZDZiZTgzNjE1ZTI2NGM4M2QyYWU5Zjk", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-08-17T15:00:33Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-08-17T15:03:30Z"}, "message": "fortran: Add -static-libquadmath support [PR46539]\n\nThe following patch is a revival of the\nhttps://gcc.gnu.org/legacy-ml/gcc-patches/2014-10/msg00771.html\npatch.  While trunk configured against recent glibc and with linker\n--as-needed support doesn't really need to link against -lquadmath\nanymore, there are still other targets where libquadmath is still in\nuse.\nAs has been discussed, making -static-libgfortran imply statically\nlinking both libgfortran and libquadmath is undesirable because of\nthe significant licensing differences between the 2 libraries.\nCompared to the 2014 patch, this one doesn't handle -lquadmath\naddition in the driver, which to me looks incorrect, libgfortran\nconfigure determines where in libgfortran.spec -lquadmath should\nbe present if at all and with what it should be wrapped, but\nanalyzes gfortran -### -static-libgfortran stderr and based on\nthat figures out what gcc/configure.ac determined.\n\n2022-08-17  Francois-Xavier Coudert  <fxcoudert@gcc.gnu.org>\n\t    Jakub Jelinek  <jakub@redhat.com>\n\n\tPR fortran/46539\ngcc/\n\t* common.opt (static-libquadmath): New option.\n\t* gcc.cc (driver_handle_option): Always accept -static-libquadmath.\n\t* config/darwin.h (LINK_SPEC): Handle -static-libquadmath.\ngcc/fortran/\n\t* lang.opt (static-libquadmath): New option.\n\t* invoke.texi (-static-libquadmath): Document it.\n\t* options.cc (gfc_handle_option): Error out if -static-libquadmath\n\tis passed but we do not support it.\nlibgfortran/\n\t* acinclude.m4 (LIBQUADSPEC): From $FC -static-libgfortran -###\n\toutput determine -Bstatic/-Bdynamic, -bstatic/-bdynamic,\n\t-aarchive_shared/-adefault linker support or Darwin remapping\n\tof -lgfortran to libgfortran.a%s and use that around or instead\n\tof -lquadmath in LIBQUADSPEC.\n\t* configure: Regenerated.\n\nCo-Authored-By: Francois-Xavier Coudert <fxcoudert@gcc.gnu.org>", "tree": {"sha": "234d7a6f04483a8a083d4532cb76ae6da0930dc9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/234d7a6f04483a8a083d4532cb76ae6da0930dc9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/745be54bd6634fe63d6be83615e264c83d2ae9f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/745be54bd6634fe63d6be83615e264c83d2ae9f9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/745be54bd6634fe63d6be83615e264c83d2ae9f9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/745be54bd6634fe63d6be83615e264c83d2ae9f9/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1513512ec7d0751cba30c9c8804f2be462acfb9b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1513512ec7d0751cba30c9c8804f2be462acfb9b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1513512ec7d0751cba30c9c8804f2be462acfb9b"}], "stats": {"total": 91, "additions": 82, "deletions": 9}, "files": [{"sha": "fba90ff6dcbed4b274c99f1affa772469c225990", "filename": "gcc/common.opt", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Fcommon.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Fcommon.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcommon.opt?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -3601,6 +3601,10 @@ static-libphobos\n Driver\n ; Documented for D, but always accepted by driver.\n \n+static-libquadmath\n+Driver\n+; Documented for Fortran, but always accepted by driver.\n+\n static-libstdc++\n Driver\n "}, {"sha": "c5e1ba84e6f885ad2a36c755fc4d3d480e2567d2", "filename": "gcc/config/darwin.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Fconfig%2Fdarwin.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Fconfig%2Fdarwin.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.h?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -443,6 +443,7 @@ extern GTY(()) int darwin_ms_struct;\n                      %:replace-outfile(-lobjc libobjc-gnu.a%s); \\\n                     :%:replace-outfile(-lobjc -lobjc-gnu )}}\\\n    %{static|static-libgcc|static-libgfortran:%:replace-outfile(-lgfortran libgfortran.a%s)}\\\n+   %{static|static-libgcc|static-libquadmath:%:replace-outfile(-lquadmath libquadmath.a%s)}\\\n    %{static|static-libgcc|static-libphobos:%:replace-outfile(-lgphobos libgphobos.a%s)}\\\n    %{static|static-libgcc|static-libstdc++|static-libgfortran:%:replace-outfile(-lgomp libgomp.a%s)}\\\n    %{static|static-libgcc|static-libstdc++:%:replace-outfile(-lstdc++ libstdc++.a%s)}\\"}, {"sha": "4d1e0d6b513640f41d72644f55c306dd484901ac", "filename": "gcc/fortran/invoke.texi", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Ffortran%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Ffortran%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Finvoke.texi?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -170,7 +170,7 @@ and warnings}.\n \n @item Link Options\n @xref{Link Options,,Options for influencing the linking step}.\n-@gccoptlist{-static-libgfortran}\n+@gccoptlist{-static-libgfortran  -static-libquadmath}\n \n @item Runtime Options\n @xref{Runtime Options,,Options for influencing runtime behavior}.\n@@ -1425,6 +1425,20 @@ configured, this option has no effect.\n @end table\n \n \n+@table @gcctabopt\n+@item -static-libquadmath\n+@opindex @code{static-libquadmath}\n+On systems that provide @file{libquadmath} as a shared and a static\n+library, this option forces the use of the static version. If no\n+shared version of @file{libquadmath} was built when the compiler was\n+configured, this option has no effect.\n+\n+Please note that the @file{libquadmath} runtime library is licensed under the\n+GNU Lesser General Public License (LGPL), and linking it statically introduces\n+requirements when redistributing the resulting binaries.\n+@end table\n+\n+\n @node Runtime Options\n @section Influencing runtime behavior\n @cindex options, runtime"}, {"sha": "e8cd73505e8f165c590ed5e55184cb81845fe7d9", "filename": "gcc/fortran/lang.opt", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Ffortran%2Flang.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Ffortran%2Flang.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Flang.opt?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -863,6 +863,10 @@ static-libgfortran\n Fortran\n Statically link the GNU Fortran helper library (libgfortran).\n \n+static-libquadmath\n+Fortran\n+Statically link the GCC Quad-Precision Math Library (libquadmath).\n+\n std=f2003\n Fortran\n Conform to the ISO Fortran 2003 standard."}, {"sha": "38249d65cd8e3143760d8500b0da8b962a211e5b", "filename": "gcc/fortran/options.cc", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Ffortran%2Foptions.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Ffortran%2Foptions.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Foptions.cc?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -692,6 +692,13 @@ gfc_handle_option (size_t scode, const char *arg, HOST_WIDE_INT value,\n #endif\n       break;\n \n+    case OPT_static_libquadmath:\n+#ifndef HAVE_LD_STATIC_DYNAMIC\n+      gfc_fatal_error (\"%<-static-libquadmath%> is not supported in this \"\n+\t\t       \"configuration\");\n+#endif\n+      break;\n+\n     case OPT_fintrinsic_modules_path:\n     case OPT_fintrinsic_modules_path_:\n "}, {"sha": "b6d562a92f0a09d25404fc92a705e177763b3bcf", "filename": "gcc/gcc.cc", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Fgcc.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/gcc%2Fgcc.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgcc.cc?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -4585,12 +4585,14 @@ driver_handle_option (struct gcc_options *opts,\n     case OPT_static_libgcc:\n     case OPT_shared_libgcc:\n     case OPT_static_libgfortran:\n+    case OPT_static_libquadmath:\n     case OPT_static_libphobos:\n     case OPT_static_libstdc__:\n       /* These are always valid, since gcc.cc itself understands the\n \t first two, gfortranspec.cc understands -static-libgfortran,\n-\t d-spec.cc understands -static-libphobos, and g++spec.cc\n-\t understands -static-libstdc++ */\n+\t d-spec.cc understands -static-libphobos, g++spec.cc\n+\t understands -static-libstdc++ and libgfortran.spec handles\n+\t -static-libquadmath.  */\n       validated = true;\n       break;\n "}, {"sha": "a73207e54656fdd412eba99551cd77ac37e402de", "filename": "libgfortran/acinclude.m4", "status": "modified", "additions": 24, "deletions": 3, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/libgfortran%2Facinclude.m4", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/libgfortran%2Facinclude.m4", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Facinclude.m4?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -356,18 +356,39 @@ AC_DEFUN([LIBGFOR_CHECK_FLOAT128], [\n       ac_[]_AC_LANG_ABBREV[]_werror_flag=$ac_xsave_[]_AC_LANG_ABBREV[]_werror_flag\n     ])\n \n+    dnl Determine -Bstatic ... -Bdynamic etc. support from gfortran -### stderr.\n+    touch conftest1.$ac_objext conftest2.$ac_objext\n+    LQUADMATH=-lquadmath\n+    $FC -static-libgfortran -### -o conftest \\\n+\tconftest1.$ac_objext -lgfortran conftest2.$ac_objext 2>&1 >/dev/null \\\n+\t| grep \"conftest1.$ac_objext.*conftest2.$ac_objext\" > conftest.cmd\n+    if grep \"conftest1.$ac_objext.* -Bstatic -lgfortran -Bdynamic .*conftest2.$ac_objext\" \\\n+       conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:-Bstatic} -lquadmath %{static-libquadmath:-Bdynamic}\"\n+    elif grep \"conftest1.$ac_objext.* -bstatic -lgfortran -bdynamic .*conftest2.$ac_objext\" \\\n+         conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:-bstatic} -lquadmath %{static-libquadmath:-bdynamic}\"\n+    elif grep \"conftest1.$ac_objext.* -aarchive_shared -lgfortran -adefault .*conftest2.$ac_objext\" \\\n+         conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:-aarchive_shared} -lquadmath %{static-libquadmath:-adefault}\"\n+    elif grep \"conftest1.$ac_objext.*libgfortran.a .*conftest2.$ac_objext\" \\\n+         conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:libquadmath.a%s;:-lquadmath}\"\n+    fi\n+    rm -f conftest1.$ac_objext conftest2.$ac_objext conftest conftest.cmd\n+\n     dnl For static libgfortran linkage, depend on libquadmath only if needed.\n     dnl If using *f128 APIs from libc/libm, depend on libquadmath only if needed\n     dnl even for dynamic libgfortran linkage, and don't link libgfortran against\n     dnl -lquadmath.\n     if test \"x$libgfor_cv_have_as_needed\" = xyes; then\n       if test \"x$USE_IEC_60559\" = xyes; then\n-\tLIBQUADSPEC=\"$libgfor_cv_as_needed_option -lquadmath $libgfor_cv_no_as_needed_option\"\n+\tLIBQUADSPEC=\"$libgfor_cv_as_needed_option $LQUADMATH $libgfor_cv_no_as_needed_option\"\n       else\n-\tLIBQUADSPEC=\"%{static-libgfortran:$libgfor_cv_as_needed_option} -lquadmath %{static-libgfortran:$libgfor_cv_no_as_needed_option}\"\n+\tLIBQUADSPEC=\"%{static-libgfortran:$libgfor_cv_as_needed_option} $LQUADMATH %{static-libgfortran:$libgfor_cv_no_as_needed_option}\"\n       fi\n     else\n-      LIBQUADSPEC=\"-lquadmath\"\n+      LIBQUADSPEC=\"$LQUADMATH\"\n     fi\n     if test \"x$USE_IEC_60559\" != xyes; then\n       if test -f ../libquadmath/libquadmath.la; then"}, {"sha": "beb0ec49eb15093a2bd0ba32da4720f85bb096e1", "filename": "libgfortran/configure", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/745be54bd6634fe63d6be83615e264c83d2ae9f9/libgfortran%2Fconfigure", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/745be54bd6634fe63d6be83615e264c83d2ae9f9/libgfortran%2Fconfigure", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fconfigure?ref=745be54bd6634fe63d6be83615e264c83d2ae9f9", "patch": "@@ -30323,14 +30323,34 @@ fi\n { $as_echo \"$as_me:${as_lineno-$LINENO}: result: $libgfor_cv_have_as_needed\" >&5\n $as_echo \"$libgfor_cv_have_as_needed\" >&6; }\n \n+        touch conftest1.$ac_objext conftest2.$ac_objext\n+    LQUADMATH=-lquadmath\n+    $FC -static-libgfortran -### -o conftest \\\n+\tconftest1.$ac_objext -lgfortran conftest2.$ac_objext 2>&1 >/dev/null \\\n+\t| grep \"conftest1.$ac_objext.*conftest2.$ac_objext\" > conftest.cmd\n+    if grep \"conftest1.$ac_objext.* -Bstatic -lgfortran -Bdynamic .*conftest2.$ac_objext\" \\\n+       conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:-Bstatic} -lquadmath %{static-libquadmath:-Bdynamic}\"\n+    elif grep \"conftest1.$ac_objext.* -bstatic -lgfortran -bdynamic .*conftest2.$ac_objext\" \\\n+         conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:-bstatic} -lquadmath %{static-libquadmath:-bdynamic}\"\n+    elif grep \"conftest1.$ac_objext.* -aarchive_shared -lgfortran -adefault .*conftest2.$ac_objext\" \\\n+         conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:-aarchive_shared} -lquadmath %{static-libquadmath:-adefault}\"\n+    elif grep \"conftest1.$ac_objext.*libgfortran.a .*conftest2.$ac_objext\" \\\n+         conftest.cmd >/dev/null 2>&1; then\n+      LQUADMATH=\"%{static-libquadmath:libquadmath.a%s;:-lquadmath}\"\n+    fi\n+    rm -f conftest1.$ac_objext conftest2.$ac_objext conftest conftest.cmd\n+\n                     if test \"x$libgfor_cv_have_as_needed\" = xyes; then\n       if test \"x$USE_IEC_60559\" = xyes; then\n-\tLIBQUADSPEC=\"$libgfor_cv_as_needed_option -lquadmath $libgfor_cv_no_as_needed_option\"\n+\tLIBQUADSPEC=\"$libgfor_cv_as_needed_option $LQUADMATH $libgfor_cv_no_as_needed_option\"\n       else\n-\tLIBQUADSPEC=\"%{static-libgfortran:$libgfor_cv_as_needed_option} -lquadmath %{static-libgfortran:$libgfor_cv_no_as_needed_option}\"\n+\tLIBQUADSPEC=\"%{static-libgfortran:$libgfor_cv_as_needed_option} $LQUADMATH %{static-libgfortran:$libgfor_cv_no_as_needed_option}\"\n       fi\n     else\n-      LIBQUADSPEC=\"-lquadmath\"\n+      LIBQUADSPEC=\"$LQUADMATH\"\n     fi\n     if test \"x$USE_IEC_60559\" != xyes; then\n       if test -f ../libquadmath/libquadmath.la; then"}]}