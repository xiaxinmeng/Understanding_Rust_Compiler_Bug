{"sha": "c1b8f25d8090e778b330555005c81bc0c582a6b8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzFiOGYyNWQ4MDkwZTc3OGIzMzA1NTUwMDVjODFiYzBjNTgyYTZiOA==", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2018-04-10T06:33:38Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2018-04-10T06:33:38Z"}, "message": "re PR lto/85078 (LTO ICE: tree check: expected tree that contains 'decl minimal' structure, have 'identifier_node' in decl_mangling_context, at cp/mangle.c:878)\n\n\n\tPR lto/85078\n\t* ipa-devirt.c (rebuild_type_inheritance-hash): New.\n\t* ipa-utils.h (rebuild_type_inheritance-hash): Declare.\n\t* tree.c (free_lang_data_in_type): Fix handling of binfos;\n\twalk basetypes.\n\t(free_lang_data): Rebuild type inheritance graph.\n\t* g++.dg/torture/pr85078.C: New.\n\nFrom-SVN: r259264", "tree": {"sha": "7820fbe8f54a1910d5b3f0a145e1fea2b418a3e4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7820fbe8f54a1910d5b3f0a145e1fea2b418a3e4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c1b8f25d8090e778b330555005c81bc0c582a6b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c1b8f25d8090e778b330555005c81bc0c582a6b8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c1b8f25d8090e778b330555005c81bc0c582a6b8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c1b8f25d8090e778b330555005c81bc0c582a6b8/comments", "author": null, "committer": null, "parents": [{"sha": "f518da46fbbdd79ab13417440198110dc9fc96d3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f518da46fbbdd79ab13417440198110dc9fc96d3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f518da46fbbdd79ab13417440198110dc9fc96d3"}], "stats": {"total": 80, "additions": 79, "deletions": 1}, "files": [{"sha": "0f5a8b25c0d20f23e5cc3edf41cca7cddc116a20", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c1b8f25d8090e778b330555005c81bc0c582a6b8", "patch": "@@ -1,3 +1,12 @@\n+2018-04-09  Jan Hubicka  <jh@suse.cz>\n+\n+\tPR lto/85078\n+\t* ipa-devirt.c (rebuild_type_inheritance-hash): New.\n+\t* ipa-utils.h (rebuild_type_inheritance-hash): Declare.\n+\t* tree.c (free_lang_data_in_type): Fix handling of binfos;\n+\twalk basetypes.\n+\t(free_lang_data): Rebuild type inheritance graph.\n+\n 2018-04-09  Martin Sebor  <msebor@redhat.com>\n \n \t* invoke.texi (-finline-small-functions): Mention other optimization"}, {"sha": "fa9380cce80ecdeb5a9f06fbe727cf6fe1031594", "filename": "gcc/ipa-devirt.c", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Fipa-devirt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Fipa-devirt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-devirt.c?ref=c1b8f25d8090e778b330555005c81bc0c582a6b8", "patch": "@@ -2702,6 +2702,24 @@ free_polymorphic_call_targets_hash ()\n     }\n }\n \n+/* Force rebuilding type inheritance graph from scratch.\n+   This is use to make sure that we do not keep references to types\n+   which was not visible to free_lang_data.  */\n+\n+void\n+rebuild_type_inheritance_graph ()\n+{\n+  if (!odr_hash)\n+    return;\n+  delete odr_hash;\n+  if (in_lto_p)\n+    delete odr_vtable_hash;\n+  odr_hash = NULL;\n+  odr_vtable_hash = NULL;\n+  odr_types_ptr = NULL;\n+  free_polymorphic_call_targets_hash ();\n+}\n+\n /* When virtual function is removed, we may need to flush the cache.  */\n \n static void"}, {"sha": "1609ac14d7fbea5da73cc5f6806807d7fbe4ff91", "filename": "gcc/ipa-utils.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Fipa-utils.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Fipa-utils.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-utils.h?ref=c1b8f25d8090e778b330555005c81bc0c582a6b8", "patch": "@@ -55,6 +55,7 @@ bool ipa_propagate_frequency (struct cgraph_node *node);\n struct odr_type_d;\n typedef odr_type_d *odr_type;\n void build_type_inheritance_graph (void);\n+void rebuild_type_inheritance_graph (void);\n void update_type_inheritance_graph (void);\n vec <cgraph_node *>\n possible_polymorphic_call_targets (tree, HOST_WIDE_INT,"}, {"sha": "85392f68f29a1459bd9280a087c751172d0ca383", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c1b8f25d8090e778b330555005c81bc0c582a6b8", "patch": "@@ -1,3 +1,8 @@\n+2018-04-09  Jan Hubicka  <jh@suse.cz>\n+\n+\tPR lto/85078\n+\t* g++.dg/torture/pr85078.C: New.\n+\n 2018-04-09  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/85227"}, {"sha": "de512bdfd31cac82e360a73efcedc1bd57e45d86", "filename": "gcc/testsuite/g++.dg/torture/pr85078.C", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fpr85078.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fpr85078.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fpr85078.C?ref=c1b8f25d8090e778b330555005c81bc0c582a6b8", "patch": "@@ -0,0 +1,40 @@\n+typedef __builtin_va_list a;\n+\n+class b\n+{\n+public:\n+  virtual void c (int, const char *, a &);\n+  char d;\n+  void m_fn2 ()\n+  {\n+    a a;\n+    c (2, &d, a);\n+  }\n+};\n+\n+class e:b\n+{\n+  virtual void f ()\n+  {\n+  }\n+  void c (int, const char *, a &);\n+};\n+\n+class g\n+{\n+protected:\n+  b h;\n+};\n+\n+class i:g\n+{\n+  int j ();\n+};\n+\n+int\n+i::j ()\n+{\n+  h.m_fn2 ();\n+  return 0;\n+}\n+"}, {"sha": "e93f24dd4d30f24df6e25c398a9d063edee7f7fb", "filename": "gcc/tree.c", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Ftree.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c1b8f25d8090e778b330555005c81bc0c582a6b8/gcc%2Ftree.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree.c?ref=c1b8f25d8090e778b330555005c81bc0c582a6b8", "patch": "@@ -5521,7 +5521,8 @@ find_decls_types_r (tree *tp, int *ws, void *data)\n \t  tree tem;\n \t  FOR_EACH_VEC_ELT (*BINFO_BASE_BINFOS (TYPE_BINFO (t)), i, tem)\n \t    fld_worklist_push (TREE_TYPE (tem), fld);\n-\t  fld_worklist_push (BINFO_VIRTUALS (TYPE_BINFO (t)), fld);\n+\t  fld_worklist_push (BINFO_TYPE (TYPE_BINFO (t)), fld);\n+\t  fld_worklist_push (BINFO_VTABLE (TYPE_BINFO (t)), fld);\n \t}\n       if (RECORD_OR_UNION_TYPE_P (t))\n \t{\n@@ -5540,6 +5541,8 @@ find_decls_types_r (tree *tp, int *ws, void *data)\n \t      tem = TREE_CHAIN (tem);\n \t    }\n \t}\n+      if (FUNC_OR_METHOD_TYPE_P (t))\n+\tfld_worklist_push (TYPE_METHOD_BASETYPE (t), fld);\n \n       fld_worklist_push (TYPE_STUB_DECL (t), fld);\n       *ws = 0;\n@@ -5859,6 +5862,8 @@ free_lang_data (void)\n   /* Reset diagnostic machinery.  */\n   tree_diagnostics_defaults (global_dc);\n \n+  rebuild_type_inheritance_graph ();\n+\n   return 0;\n }\n "}]}