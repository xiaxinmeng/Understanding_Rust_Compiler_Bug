{"sha": "356e2720e9030927579024c2f060d665a0b9080f", "node_id": "C_kwDOANBUbNoAKDM1NmUyNzIwZTkwMzA5Mjc1NzkwMjRjMmYwNjBkNjY1YTBiOTA4MGY", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-18T09:34:02Z"}, "committer": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-18T15:16:24Z"}, "message": "[openmp] Set location for taskloop stmts\n\nThe test-case included in this patch contains:\n...\n  #pragma omp taskloop simd shared(a) lastprivate(myId)\n...\n\nThis is translated to 3 taskloop statements in gimple, visible with\n-fdump-tree-gimple:\n...\n  #pragma omp taskloop private(D.2124)\n    #pragma omp taskloop shared(a) shared(myId) private(i.0) firstprivate(a_h)\n      #pragma omp taskloop lastprivate(myId)\n...\n\nBut when exposing the gimple statement locations using\n-fdump-tree-gimple-lineno, we find that only the first one has location\ninformation.\n\nFix this by adding the missing location information.\n\nTested gomp.exp on x86_64.\n\nTested libgomp testsuite on x86_64 with nvptx accelerator.\n\ngcc/ChangeLog:\n\n2022-03-18  Tom de Vries  <tdevries@suse.de>\n\n\t* gimplify.cc (gimplify_omp_for): Set taskloop location.\n\ngcc/testsuite/ChangeLog:\n\n2022-03-18  Tom de Vries  <tdevries@suse.de>\n\n\t* c-c++-common/gomp/pr104968.c: New test.", "tree": {"sha": "9252b0b01116b5a9d156179f7b5266b09b286a56", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9252b0b01116b5a9d156179f7b5266b09b286a56"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/356e2720e9030927579024c2f060d665a0b9080f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/356e2720e9030927579024c2f060d665a0b9080f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/356e2720e9030927579024c2f060d665a0b9080f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/356e2720e9030927579024c2f060d665a0b9080f/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "093cdadbce30ce2d36846a05d979b8afc2eff618", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/093cdadbce30ce2d36846a05d979b8afc2eff618", "html_url": "https://github.com/Rust-GCC/gccrs/commit/093cdadbce30ce2d36846a05d979b8afc2eff618"}], "stats": {"total": 16, "additions": 16, "deletions": 0}, "files": [{"sha": "c46589639e41b7a2898b92e4ce0b817b6bef3365", "filename": "gcc/gimplify.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/356e2720e9030927579024c2f060d665a0b9080f/gcc%2Fgimplify.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/356e2720e9030927579024c2f060d665a0b9080f/gcc%2Fgimplify.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.cc?ref=356e2720e9030927579024c2f060d665a0b9080f", "patch": "@@ -13178,6 +13178,7 @@ gimplify_omp_for (tree *expr_p, gimple_seq *pre_p)\n   gfor = gimple_build_omp_for (for_body, kind, OMP_FOR_CLAUSES (orig_for_stmt),\n \t\t\t       TREE_VEC_LENGTH (OMP_FOR_INIT (for_stmt)),\n \t\t\t       for_pre_body);\n+  gimple_set_location (gfor, EXPR_LOCATION (*expr_p));\n   if (orig_for_stmt != for_stmt)\n     gimple_omp_for_set_combined_p (gfor, true);\n   if (gimplify_omp_ctxp\n@@ -13361,6 +13362,7 @@ gimplify_omp_for (tree *expr_p, gimple_seq *pre_p)\n       g = gimple_build_bind (NULL_TREE, gfor, NULL_TREE);\n       g = gimple_build_omp_task (g, task_clauses, NULL_TREE, NULL_TREE,\n \t\t\t\t NULL_TREE, NULL_TREE, NULL_TREE);\n+      gimple_set_location (g, EXPR_LOCATION (*expr_p));\n       gimple_omp_task_set_taskloop_p (g, true);\n       g = gimple_build_bind (NULL_TREE, g, NULL_TREE);\n       gomp_for *gforo"}, {"sha": "2977db2f433436d40c1a2b45739b78e4c359edef", "filename": "gcc/testsuite/c-c++-common/gomp/pr104968.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/356e2720e9030927579024c2f060d665a0b9080f/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr104968.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/356e2720e9030927579024c2f060d665a0b9080f/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr104968.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr104968.c?ref=356e2720e9030927579024c2f060d665a0b9080f", "patch": "@@ -0,0 +1,14 @@\n+/* { dg-additional-options \"-fdump-tree-gimple-lineno\" }  */\n+\n+int\n+main (void)\n+{\n+  double a[10], a_h[10];\n+  int myId = -1;\n+#pragma omp target map(tofrom:a)\n+#pragma omp taskloop simd shared(a) lastprivate(myId) /* { dg-line here } */\n+    for(int i = 0 ; i < 10; i++) if (a[i] != a_h[i]) { }\n+}\n+\n+/* { dg-final { scan-tree-dump-times \"#pragma omp taskloop\" 3 \"gimple\" } }  */\n+/* { dg-final { scan-tree-dump-times \"(?n)\\\\\\[.*pr104968.c:[get-absolute-line '' here]:.*\\\\\\] #pragma omp taskloop\" 3 \"gimple\" } }  */"}]}