{"sha": "e5fd6684b9577e822997ceedabfeaa7d61722fe2", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTVmZDY2ODRiOTU3N2U4MjI5OTdjZWVkYWJmZWFhN2Q2MTcyMmZlMg==", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2019-02-28T20:31:23Z"}, "committer": {"name": "Thomas Schwinge", "email": "tschwinge@gcc.gnu.org", "date": "2019-02-28T20:31:23Z"}, "message": "[PR72741] For all Fortran OpenACC 'routine' directive variants check for multiple clauses specifying the level of parallelism\n\n\tgcc/fortran/\n\tPR fortran/72741\n\t* gfortran.h (enum oacc_routine_lop): Add OACC_ROUTINE_LOP_ERROR.\n\t* openmp.c (gfc_oacc_routine_lop, gfc_match_oacc_routine): Use it.\n\t* trans-decl.c (add_attributes_to_decl): Likewise.\n\tgcc/testsuite/\n\tPR fortran/72741\n\t* gfortran.dg/goacc/routine-multiple-lop-clauses-1.f90: New file.\n\nCo-Authored-By: Cesar Philippidis <cesar@codesourcery.com>\n\nFrom-SVN: r269286", "tree": {"sha": "a9ce3a476a0cc9f399634c7fe84677a40a285410", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a9ce3a476a0cc9f399634c7fe84677a40a285410"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e5fd6684b9577e822997ceedabfeaa7d61722fe2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e5fd6684b9577e822997ceedabfeaa7d61722fe2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e5fd6684b9577e822997ceedabfeaa7d61722fe2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e5fd6684b9577e822997ceedabfeaa7d61722fe2/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6f87db2d7823ff70eca4fa76950aafe8a98d7356", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6f87db2d7823ff70eca4fa76950aafe8a98d7356", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6f87db2d7823ff70eca4fa76950aafe8a98d7356"}], "stats": {"total": 57, "additions": 53, "deletions": 4}, "files": [{"sha": "1c8f7125298064554587fc0d8f05c49899f37e68", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=e5fd6684b9577e822997ceedabfeaa7d61722fe2", "patch": "@@ -1,6 +1,11 @@\n 2019-02-28  Thomas Schwinge  <thomas@codesourcery.com>\n \t    Cesar Philippidis  <cesar@codesourcery.com>\n \n+\tPR fortran/72741\n+\t* gfortran.h (enum oacc_routine_lop): Add OACC_ROUTINE_LOP_ERROR.\n+\t* openmp.c (gfc_oacc_routine_lop, gfc_match_oacc_routine): Use it.\n+\t* trans-decl.c (add_attributes_to_decl): Likewise.\n+\n \tPR fortran/72741\n \tPR fortran/89433\n \t* openmp.c (gfc_match_oacc_routine): Accept intrinsic symbols."}, {"sha": "3e0f634c3a8e3992f13054b0df26ba1d698e7c50", "filename": "gcc/fortran/gfortran.h", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2Fgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2Fgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.h?ref=e5fd6684b9577e822997ceedabfeaa7d61722fe2", "patch": "@@ -323,7 +323,8 @@ enum oacc_routine_lop\n   OACC_ROUTINE_LOP_GANG,\n   OACC_ROUTINE_LOP_WORKER,\n   OACC_ROUTINE_LOP_VECTOR,\n-  OACC_ROUTINE_LOP_SEQ\n+  OACC_ROUTINE_LOP_SEQ,\n+  OACC_ROUTINE_LOP_ERROR\n };\n \n /* Strings for all symbol attributes.  We use these for dumping the"}, {"sha": "50b91f2150ab75b026be5b68e980d11848c2dcbc", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=e5fd6684b9577e822997ceedabfeaa7d61722fe2", "patch": "@@ -2265,7 +2265,7 @@ gfc_oacc_routine_lop (gfc_omp_clauses *clauses)\n \t}\n \n       if (n_lop_clauses > 1)\n-\tgfc_error (\"Multiple loop axes specified for routine\");\n+\tret = OACC_ROUTINE_LOP_ERROR;\n     }\n \n   return ret;\n@@ -2280,6 +2280,7 @@ gfc_match_oacc_routine (void)\n   gfc_symbol *sym = NULL;\n   gfc_omp_clauses *c = NULL;\n   gfc_oacc_routine_name *n = NULL;\n+  oacc_routine_lop lop = OACC_ROUTINE_LOP_NONE;\n \n   old_loc = gfc_current_locus;\n \n@@ -2352,6 +2353,13 @@ gfc_match_oacc_routine (void)\n \t  != MATCH_YES))\n     return MATCH_ERROR;\n \n+  lop = gfc_oacc_routine_lop (c);\n+  if (lop == OACC_ROUTINE_LOP_ERROR)\n+    {\n+      gfc_error (\"Multiple loop axes specified for routine at %C\");\n+      goto cleanup;\n+    }\n+\n   if (isym != NULL)\n     {\n       /* Diagnose any OpenACC 'routine' directive that doesn't match the\n@@ -2381,8 +2389,7 @@ gfc_match_oacc_routine (void)\n \t\t\t\t       gfc_current_ns->proc_name->name,\n \t\t\t\t       &old_loc))\n \tgoto cleanup;\n-      gfc_current_ns->proc_name->attr.oacc_routine_lop\n-\t= gfc_oacc_routine_lop (c);\n+      gfc_current_ns->proc_name->attr.oacc_routine_lop = lop;\n     }\n   else\n     /* Something has gone wrong, possibly a syntax error.  */"}, {"sha": "36b7fdd2701f2ed2c6ee8eabe818214caf104943", "filename": "gcc/fortran/trans-decl.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2Ftrans-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ffortran%2Ftrans-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.c?ref=e5fd6684b9577e822997ceedabfeaa7d61722fe2", "patch": "@@ -1425,6 +1425,7 @@ add_attributes_to_decl (symbol_attribute sym_attr, tree list)\n \t  code = OMP_CLAUSE_SEQ;\n \t  break;\n \tcase OACC_ROUTINE_LOP_NONE:\n+\tcase OACC_ROUTINE_LOP_ERROR:\n \tdefault:\n \t  gcc_unreachable ();\n \t}"}, {"sha": "9f4c598951c3d482ef8ecd4973c079a0b15f85b7", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e5fd6684b9577e822997ceedabfeaa7d61722fe2", "patch": "@@ -1,6 +1,9 @@\n 2019-02-28  Thomas Schwinge  <thomas@codesourcery.com>\n \t    Cesar Philippidis  <cesar@codesourcery.com>\n \n+\tPR fortran/72741\n+\t* gfortran.dg/goacc/routine-multiple-lop-clauses-1.f90: New file.\n+\n \tPR fortran/72741\n \tPR fortran/89433\n \t* gfortran.dg/goacc/routine-6.f90: Update"}, {"sha": "8ca9be822ea598fad7309b679cae916f4f35e664", "filename": "gcc/testsuite/gfortran.dg/goacc/routine-multiple-lop-clauses-1.f90", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-lop-clauses-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e5fd6684b9577e822997ceedabfeaa7d61722fe2/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-lop-clauses-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Froutine-multiple-lop-clauses-1.f90?ref=e5fd6684b9577e822997ceedabfeaa7d61722fe2", "patch": "@@ -0,0 +1,32 @@\n+! Check for multiple clauses specifying the level of parallelism.\n+\n+SUBROUTINE v_1\n+  !$ACC ROUTINE VECTOR WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+END SUBROUTINE v_1\n+\n+SUBROUTINE sub_1\n+  IMPLICIT NONE\n+  EXTERNAL :: g_1\n+  !$ACC ROUTINE (g_1) GANG WORKER ! { dg-error \"Multiple loop axes specified for routine\" }\n+  !$ACC ROUTINE (ABORT) SEQ WORKER GANG VECTOR ! { dg-error \"Multiple loop axes specified for routine\" }\n+  !$ACC ROUTINE WORKER SEQ ! { dg-error \"Multiple loop axes specified for routine\" }\n+\n+  CALL v_1\n+  CALL g_1\n+  CALL ABORT\n+END SUBROUTINE sub_1\n+\n+MODULE m_w_1\n+  IMPLICIT NONE\n+  EXTERNAL :: w_1\n+  !$ACC ROUTINE VECTOR GANG SEQ ! { dg-error \"Multiple loop axes specified for routine\" }\n+  !$ACC ROUTINE (w_1) GANG WORKER SEQ ! { dg-error \"Multiple loop axes specified for routine\" }\n+  !$ACC ROUTINE (ABORT) VECTOR GANG ! { dg-error \"Multiple loop axes specified for routine\" }\n+\n+CONTAINS\n+  SUBROUTINE sub_2\n+    CALL v_1\n+    CALL w_1\n+    CALL ABORT\n+  END SUBROUTINE sub_2\n+END MODULE m_w_1"}]}