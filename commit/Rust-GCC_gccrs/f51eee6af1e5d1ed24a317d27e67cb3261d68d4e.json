{"sha": "f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjUxZWVlNmFmMWU1ZDFlZDI0YTMxN2QyN2U2N2NiMzI2MWQ2OGQ0ZQ==", "commit": {"author": {"name": "Geoffrey Keating", "email": "geoffk@apple.com", "date": "2002-09-20T18:42:24Z"}, "committer": {"name": "Geoffrey Keating", "email": "geoffk@gcc.gnu.org", "date": "2002-09-20T18:42:24Z"}, "message": "rs6000.c (rs6000_emit_prologue): Update for change to load_macho_picbase.\n\n\t* config/rs6000/rs6000.c (rs6000_emit_prologue): Update for change\n\tto load_macho_picbase.\n\t* config/rs6000/rs6000.md: Document Darwin-specific unspec IDs.\n\t(load_macho_picbase): Take the symbol to use as a parameter.\n\t(macho_correct_pic): New insn.\n\t(builtin_setjmp_reciever): On Darwin, restore the PIC register.\n\nFrom-SVN: r57360", "tree": {"sha": "33fea21ac869569cab0b164a30d0095ceb5f9c3e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/33fea21ac869569cab0b164a30d0095ceb5f9c3e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/comments", "author": {"login": "geoffk01", "id": 31905243, "node_id": "MDQ6VXNlcjMxOTA1MjQz", "avatar_url": "https://avatars.githubusercontent.com/u/31905243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/geoffk01", "html_url": "https://github.com/geoffk01", "followers_url": "https://api.github.com/users/geoffk01/followers", "following_url": "https://api.github.com/users/geoffk01/following{/other_user}", "gists_url": "https://api.github.com/users/geoffk01/gists{/gist_id}", "starred_url": "https://api.github.com/users/geoffk01/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/geoffk01/subscriptions", "organizations_url": "https://api.github.com/users/geoffk01/orgs", "repos_url": "https://api.github.com/users/geoffk01/repos", "events_url": "https://api.github.com/users/geoffk01/events{/privacy}", "received_events_url": "https://api.github.com/users/geoffk01/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "97b2385389ad390f0c24b824bc9577cb533a48ff", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/97b2385389ad390f0c24b824bc9577cb533a48ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/97b2385389ad390f0c24b824bc9577cb533a48ff"}], "stats": {"total": 60, "additions": 47, "deletions": 13}, "files": [{"sha": "7dfdfa0668a08016361d5810aafecd89d65303af", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "patch": "@@ -1,5 +1,12 @@\n 2002-09-20  Geoffrey Keating  <geoffk@apple.com>\n \n+\t* config/rs6000/rs6000.c (rs6000_emit_prologue): Update for change\n+\tto load_macho_picbase.\n+\t* config/rs6000/rs6000.md: Document Darwin-specific unspec IDs.\n+\t(load_macho_picbase): Take the symbol to use as a parameter.\n+\t(macho_correct_pic): New insn.\n+\t(builtin_setjmp_reciever): On Darwin, restore the PIC register.\n+\n \t* config/rs6000/rs6000.h (ELIMINABLE_REGS): Use\n \tRS6000_PIC_OFFSET_TABLE_REGNUM rather than hardcoding 30.\n \t(CAN_ELIMINATE): Likewise."}, {"sha": "909dc6bd195be9d6e25273f6131c10004104942f", "filename": "gcc/config/rs6000/rs6000.c", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/gcc%2Fconfig%2Frs6000%2Frs6000.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/gcc%2Fconfig%2Frs6000%2Frs6000.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.c?ref=f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "patch": "@@ -10458,8 +10458,12 @@ rs6000_emit_prologue ()\n       && flag_pic && current_function_uses_pic_offset_table)\n     {\n       rtx dest = gen_rtx_REG (Pmode, LINK_REGISTER_REGNUM);\n+#if TARGET_MACHO\n+      char *picbase = machopic_function_base_name ();\n+      rtx src = gen_rtx_SYMBOL_REF (Pmode, ggc_alloc_string (picbase, -1));\n \n-      rs6000_maybe_dead (emit_insn (gen_load_macho_picbase (dest)));\n+      rs6000_maybe_dead (emit_insn (gen_load_macho_picbase (dest, src)));\n+#endif\n \n       rs6000_maybe_dead (\n \temit_move_insn (gen_rtx_REG (Pmode, RS6000_PIC_OFFSET_TABLE_REGNUM),"}, {"sha": "e85dc53c0c5a6aa622166d9f26932969784cbeaa", "filename": "gcc/config/rs6000/rs6000.md", "status": "modified", "additions": 35, "deletions": 12, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/gcc%2Fconfig%2Frs6000%2Frs6000.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f51eee6af1e5d1ed24a317d27e67cb3261d68d4e/gcc%2Fconfig%2Frs6000%2Frs6000.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.md?ref=f51eee6af1e5d1ed24a317d27e67cb3261d68d4e", "patch": "@@ -1,6 +1,6 @@\n ;; Machine description for IBM RISC System 6000 (POWER) for GNU C compiler\n ;; Copyright (C) 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, \n-;; 1999, 2000, 2001 Free Software Foundation, Inc.\n+;; 1999, 2000, 2001, 2002 Free Software Foundation, Inc.\n ;; Contributed by Richard Kenner (kenner@vlsi1.ultra.nyu.edu)\n \n ;; This file is part of GNU CC.\n@@ -32,6 +32,8 @@\n ;; 8\t\tmovsi_got\n ;; 9/v\t\teh_reg_restore\n ;; 10\t\tfctiwz\n+;; 15\t\tload_macho_picbase\n+;; 16\t\tmacho_correct_pic\n ;; 19\t\tmovesi_from_cr\n ;; 20\t\tmovesi_to_cr\n \f\n@@ -10220,30 +10222,51 @@\n \n (define_insn \"load_macho_picbase\"\n   [(set (match_operand:SI 0 \"register_operand\" \"=l\")\n-\t(unspec:SI [(const_int 0)] 15))]\n+\t(unspec:SI [(match_operand:SI 1 \"immediate_operand\" \"s\")] 15))]\n   \"(DEFAULT_ABI == ABI_DARWIN) && flag_pic\"\n-  \"*\n-{\n-#if TARGET_MACHO\n-  char *picbase = machopic_function_base_name ();\n-  operands[1] = gen_rtx_SYMBOL_REF (Pmode, ggc_alloc_string (picbase, -1));\n-#endif\n-  return \\\"bcl 20,31,%1\\\\n%1:\\\";\n-}\"\n+  \"bcl 20,31,%1\\\\n%1:\"\n   [(set_attr \"type\" \"branch\")\n    (set_attr \"length\" \"4\")])\n \n+(define_insn \"macho_correct_pic\"\n+  [(set (match_operand:SI 0 \"gpc_reg_operand\" \"=r\")\n+\t(plus:SI (match_operand:SI 1 \"gpc_reg_operand\" \"=r\")\n+\t\t (unspec:SI [(match_operand:SI 2 \"immediate_operand\" \"s\")\n+\t\t\t     (match_operand:SI 3 \"immediate_operand\" \"s\")]\n+\t\t\t    16)))]\n+  \"DEFAULT_ABI == ABI_DARWIN\"\n+  \"addis %0,%1,ha16(%2-%3)\\n\\taddi %1,%1,lo16(%2-%3)\"\n+  [(set_attr \"length\" \"8\")])\n+\n ;; If the TOC is shared over a translation unit, as happens with all\n ;; the kinds of PIC that we support, we need to restore the TOC\n ;; pointer only when jumping over units of translation.\n+;; On Darwin, we need to reload the picbase.\n \n (define_expand \"builtin_setjmp_receiver\"\n   [(use (label_ref (match_operand 0 \"\" \"\")))]\n   \"(DEFAULT_ABI == ABI_V4 && flag_pic == 1)\n-   || (TARGET_TOC && TARGET_MINIMAL_TOC)\"\n+   || (TARGET_TOC && TARGET_MINIMAL_TOC)\n+   || (DEFAULT_ABI == ABI_DARWIN && flag_pic)\"\n   \"\n {\n-  rs6000_emit_load_toc_table (FALSE);\n+  if (DEFAULT_ABI == ABI_DARWIN)\n+    {\n+      char *picbase = machopic_function_base_name ();\n+      rtx picrtx = gen_rtx_SYMBOL_REF (Pmode, ggc_alloc_string (picbase, -1));\n+      rtx picreg = gen_rtx_REG (Pmode, RS6000_PIC_OFFSET_TABLE_REGNUM);\n+      rtx tmplabrtx;\n+      char tmplab[20];\n+\n+      ASM_GENERATE_INTERNAL_LABEL(tmplab, \\\"LSJR\\\",\n+\t\t\t\t  CODE_LABEL_NUMBER (operands[0]));\n+      tmplabrtx = gen_rtx_SYMBOL_REF (Pmode, ggc_alloc_string (tmplab, -1));\n+\n+      emit_insn (gen_load_macho_picbase (picreg, tmplabrtx));\n+      emit_insn (gen_macho_correct_pic (picreg, picreg, picrtx, tmplabrtx));\n+    }\n+  else\n+    rs6000_emit_load_toc_table (FALSE);\n   DONE;\n }\")\n \f"}]}