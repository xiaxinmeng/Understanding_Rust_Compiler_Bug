{"sha": "97b56dece74138398977ea53368a025ed231b35c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTdiNTZkZWNlNzQxMzgzOTg5NzdlYTUzMzY4YTAyNWVkMjMxYjM1Yw==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2020-12-11T14:42:26Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2020-12-11T14:44:26Z"}, "message": "c++: Module lang hook overriding\n\nThis installs stub lang hooks for modules and creates the module dump file.\n\n\tgcc/cp/\n\t* cp-lang.c (LANG_HOOKS_PREPROCESS_MAIN_FILE): Override.\n\t(LANG_HOOKS_PREPROCESS_OPTIONS): Override.\n\t(LANG_HOOKS_PREPROCESS_TOKEN): Override.\n\t* cp-objcp-common.c (cp_register_dumps): Add module dump.\n\t(cp_handle_option): New.\n\t* cp-objcp-common.h (cp_handle_option): Declare.\n\t(LANG_HOOKS_HANDLE_OPTION): Override.\n\t* cp-tree.h (module_dump_id): Declare.\n\t* module.cc (module_dump_id): Define.\n\t(module_begin_main_file, handle_module_option)\n\t(module_preproces_options): Stubs.", "tree": {"sha": "51154b245c698f740fec5c4306d30371af0c9210", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/51154b245c698f740fec5c4306d30371af0c9210"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/97b56dece74138398977ea53368a025ed231b35c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/97b56dece74138398977ea53368a025ed231b35c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/97b56dece74138398977ea53368a025ed231b35c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/97b56dece74138398977ea53368a025ed231b35c/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37b242a3fbd29839ce352dfd8444c44989642a42", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37b242a3fbd29839ce352dfd8444c44989642a42", "html_url": "https://github.com/Rust-GCC/gccrs/commit/37b242a3fbd29839ce352dfd8444c44989642a42"}], "stats": {"total": 45, "additions": 44, "deletions": 1}, "files": [{"sha": "5d2aef45a7deba5b4aa4921338fa59a0159dd61e", "filename": "gcc/cp/cp-lang.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-lang.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-lang.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-lang.c?ref=97b56dece74138398977ea53368a025ed231b35c", "patch": "@@ -77,6 +77,12 @@ static tree cxx_enum_underlying_base_type (const_tree);\n #define LANG_HOOKS_EH_RUNTIME_TYPE build_eh_type_type\n #undef LANG_HOOKS_ENUM_UNDERLYING_BASE_TYPE\n #define LANG_HOOKS_ENUM_UNDERLYING_BASE_TYPE cxx_enum_underlying_base_type\n+#undef LANG_HOOKS_PREPROCESS_MAIN_FILE\n+#define LANG_HOOKS_PREPROCESS_MAIN_FILE module_begin_main_file\n+#undef LANG_HOOKS_PREPROCESS_OPTIONS\n+#define LANG_HOOKS_PREPROCESS_OPTIONS module_preprocess_options\n+#undef LANG_HOOKS_PREPROCESS_TOKEN\n+#define LANG_HOOKS_PREPROCESS_TOKEN module_token_pre\n \n #if CHECKING_P\n #undef LANG_HOOKS_RUN_LANG_SELFTESTS"}, {"sha": "84f0b5986e1950e9761fa2eb22024e575dada143", "filename": "gcc/cp/cp-objcp-common.c", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-objcp-common.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-objcp-common.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-objcp-common.c?ref=97b56dece74138398977ea53368a025ed231b35c", "patch": "@@ -438,6 +438,9 @@ cp_register_dumps (gcc::dump_manager *dumps)\n   class_dump_id = dumps->dump_register\n     (\".class\", \"lang-class\", \"lang-class\", DK_lang, OPTGROUP_NONE, false);\n \n+  module_dump_id = dumps->dump_register\n+    (\".module\", \"lang-module\", \"lang-module\", DK_lang, OPTGROUP_NONE, false);\n+\n   raw_dump_id = dumps->dump_register\n     (\".raw\", \"lang-raw\", \"lang-raw\", DK_lang, OPTGROUP_NONE, false);\n }\n@@ -551,4 +554,16 @@ cp_common_init_ts (void)\n   c_common_init_ts ();\n }\n \n+/* Handle C++-specficic options here.  Punt to c_common otherwise.  */\n+\n+bool\n+cp_handle_option (size_t scode, const char *arg, HOST_WIDE_INT value,\n+\t\t  int kind, location_t loc,\n+\t\t  const struct cl_option_handlers *handlers)\n+{\n+  if (handle_module_option (unsigned (scode), arg, value))\n+    return true;\n+  return c_common_handle_option (scode, arg, value, kind, loc, handlers);\n+}\n+\n #include \"gt-cp-cp-objcp-common.h\""}, {"sha": "4b5b96fedbc27a88770a1fc84961b82177ce8182", "filename": "gcc/cp/cp-objcp-common.h", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-objcp-common.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-objcp-common.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-objcp-common.h?ref=97b56dece74138398977ea53368a025ed231b35c", "patch": "@@ -34,6 +34,8 @@ extern tree cp_unit_size_without_reusable_padding (tree);\n extern tree cp_get_global_decls ();\n extern tree cp_pushdecl (tree);\n extern void cp_register_dumps (gcc::dump_manager *);\n+extern bool cp_handle_option (size_t, const char *, HOST_WIDE_INT, int,\n+\t\t\t      location_t, const struct cl_option_handlers *);\n extern tree cxx_make_type_hook\t\t\t(tree_code);\n extern tree cxx_simulate_enum_decl (location_t, const char *,\n \t\t\t\t    vec<string_int_pair>);\n@@ -63,7 +65,7 @@ extern tree cxx_simulate_enum_decl (location_t, const char *,\n #undef LANG_HOOKS_REGISTER_DUMPS\n #define LANG_HOOKS_REGISTER_DUMPS cp_register_dumps\n #undef LANG_HOOKS_HANDLE_OPTION\n-#define LANG_HOOKS_HANDLE_OPTION c_common_handle_option\n+#define LANG_HOOKS_HANDLE_OPTION cp_handle_option\n #undef LANG_HOOKS_HANDLE_FILENAME\n #define LANG_HOOKS_HANDLE_FILENAME c_common_handle_filename\n #undef LANG_HOOKS_POST_OPTIONS"}, {"sha": "63170fc013d5624bfdc74abbcf2671b218318284", "filename": "gcc/cp/cp-tree.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-tree.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fcp-tree.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-tree.h?ref=97b56dece74138398977ea53368a025ed231b35c", "patch": "@@ -6330,6 +6330,7 @@ extern cp_parameter_declarator *no_parameters;\n \n /* Various dump ids.  */\n extern int class_dump_id;\n+extern int module_dump_id;\n extern int raw_dump_id;\n \n /* in call.c */"}, {"sha": "02b5af811896c411c5d6a4a75605207f0fcf7cc1", "filename": "gcc/cp/module.cc", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fmodule.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/97b56dece74138398977ea53368a025ed231b35c/gcc%2Fcp%2Fmodule.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fmodule.cc?ref=97b56dece74138398977ea53368a025ed231b35c", "patch": "@@ -65,6 +65,9 @@ along with GCC; see the file COPYING3.  If not see\n #include \"intl.h\"\n #include \"langhooks.h\"\n \n+/* Id for dumping module information.  */\n+int module_dump_id;\n+\n /* What the current TU is.  */\n unsigned module_kind;\n \n@@ -189,6 +192,11 @@ preprocessed_module (cpp_reader *)\n {\n }\n \n+void\n+module_begin_main_file (cpp_reader *, line_maps *, const line_map_ordinary *)\n+{\n+}\n+\n void\n init_modules (cpp_reader *)\n {\n@@ -207,3 +215,14 @@ void\n fini_modules ()\n {\n }\n+\n+bool\n+handle_module_option (unsigned, const char *, int)\n+{\n+  return false;\n+}\n+\n+void\n+module_preprocess_options (cpp_reader *)\n+{\n+}"}]}