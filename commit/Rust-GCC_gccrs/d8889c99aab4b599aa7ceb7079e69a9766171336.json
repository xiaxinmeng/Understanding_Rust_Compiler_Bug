{"sha": "d8889c99aab4b599aa7ceb7079e69a9766171336", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDg4ODljOTlhYWI0YjU5OWFhN2NlYjcwNzllNjlhOTc2NjE3MTMzNg==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2021-02-17T18:43:21Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2021-02-17T18:47:00Z"}, "message": "c++: Macros need to be GTY-reachable [PR 99023]\n\nI'd missed that macros were allocated from GC storage, and that they can\nbecome unattached from an identifier, and therefore not GC-reachable.\nAnd then bad things happen.   Fixed by making the module machinery's\nreference vector a GC root.\n\n\tPR c++/99023\n\tgcc/cp/\n\t* module.cc (struct macro_export): Add GTY markers.\n\t(macro_exports): Likewise, us a va_gc Vector.\n\tgcc/testsuite/\n\t* g++.dg/modules/pr99023_a.H: New.\n\t* g++.dg/modules/pr99023_b.H: New.", "tree": {"sha": "9b84f9a3113d2938d448d8ca7c85dfc6b615838e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9b84f9a3113d2938d448d8ca7c85dfc6b615838e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d8889c99aab4b599aa7ceb7079e69a9766171336", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d8889c99aab4b599aa7ceb7079e69a9766171336", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d8889c99aab4b599aa7ceb7079e69a9766171336", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d8889c99aab4b599aa7ceb7079e69a9766171336/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0139b2a912585496f23c352f0e2c56895f78fbf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e0139b2a912585496f23c352f0e2c56895f78fbf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e0139b2a912585496f23c352f0e2c56895f78fbf"}], "stats": {"total": 26906, "additions": 26904, "deletions": 2}, "files": [{"sha": "064e57a29c417c3efc4aab20caef2ce609e6d191", "filename": "gcc/cp/module.cc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8889c99aab4b599aa7ceb7079e69a9766171336/gcc%2Fcp%2Fmodule.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8889c99aab4b599aa7ceb7079e69a9766171336/gcc%2Fcp%2Fmodule.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fmodule.cc?ref=d8889c99aab4b599aa7ceb7079e69a9766171336", "patch": "@@ -16566,7 +16566,7 @@ module_state::read_define (bytes_in &sec, cpp_reader *reader, bool located) cons\n }\n \n /* Exported macro data.  */\n-struct macro_export {\n+struct GTY(()) macro_export {\n   cpp_macro *def;\n   location_t undef_loc;\n \n@@ -16731,7 +16731,7 @@ static vec<macro_import, va_heap, vl_embed> *macro_imports;\n    indexes this array.  If the zeroth slot is not for module zero,\n    there is no export.  */\n \n-static vec<macro_export, va_heap, vl_embed> *macro_exports;\n+static GTY(()) vec<macro_export, va_gc> *macro_exports;\n \n /* The reachable set of header imports from this TU.  */\n "}, {"sha": "0db3f559ff00c750abb3aaa52de6e114baf0c445", "filename": "gcc/testsuite/g++.dg/modules/pr99023_a.H", "status": "added", "additions": 4237, "deletions": 0, "changes": 4237, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8889c99aab4b599aa7ceb7079e69a9766171336/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99023_a.H", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8889c99aab4b599aa7ceb7079e69a9766171336/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99023_a.H", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99023_a.H?ref=d8889c99aab4b599aa7ceb7079e69a9766171336"}, {"sha": "71ac5c2276376b2a2167aaf5a1dc0a83f93f278a", "filename": "gcc/testsuite/g++.dg/modules/pr99023_b.H", "status": "added", "additions": 22665, "deletions": 0, "changes": 22665, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d8889c99aab4b599aa7ceb7079e69a9766171336/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99023_b.H", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d8889c99aab4b599aa7ceb7079e69a9766171336/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99023_b.H", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99023_b.H?ref=d8889c99aab4b599aa7ceb7079e69a9766171336"}]}