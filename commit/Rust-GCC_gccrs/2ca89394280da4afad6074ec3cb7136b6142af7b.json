{"sha": "2ca89394280da4afad6074ec3cb7136b6142af7b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmNhODkzOTQyODBkYTRhZmFkNjA3NGVjM2NiNzEzNmI2MTQyYWY3Yg==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-07-02T19:57:24Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-07-02T19:57:24Z"}, "message": "openmp: Reject #pragma omp atomic update, [PR101297]\n\nI've noticed that we allow a trailing comma on OpenMP atomic construct\nif there is at least one clause.  Commas should be only allowed to\nseparate the clauses (or in OpenMP 5.1 to separate directive name\nfrom the clauses).\n\n2021-07-02  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR c/101297\n\t* c-parser.c (c_parser_omp_atomic): Consume comma only if it\n\tappears before a CPP_NAME.\n\n\t* parser.c (cp_parser_omp_atomic): Consume comma only if it\n\tappears before a CPP_NAME.\n\n\t* c-c++-common/gomp/atomic-24.c: New test.", "tree": {"sha": "040ffd0b44805914dd7c6bae2d9b5d71f3772ef3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/040ffd0b44805914dd7c6bae2d9b5d71f3772ef3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2ca89394280da4afad6074ec3cb7136b6142af7b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2ca89394280da4afad6074ec3cb7136b6142af7b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2ca89394280da4afad6074ec3cb7136b6142af7b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2ca89394280da4afad6074ec3cb7136b6142af7b/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e3528ce197f8886869f95e8a8f901861a319851c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e3528ce197f8886869f95e8a8f901861a319851c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e3528ce197f8886869f95e8a8f901861a319851c"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "9a56e0c04c6a9b6ef1db0a61cfc94d928d140011", "filename": "gcc/c/c-parser.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2ca89394280da4afad6074ec3cb7136b6142af7b/gcc%2Fc%2Fc-parser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2ca89394280da4afad6074ec3cb7136b6142af7b/gcc%2Fc%2Fc-parser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2Fc-parser.c?ref=2ca89394280da4afad6074ec3cb7136b6142af7b", "patch": "@@ -17533,7 +17533,9 @@ c_parser_omp_atomic (location_t loc, c_parser *parser, bool openacc)\n \n   while (c_parser_next_token_is_not (parser, CPP_PRAGMA_EOL))\n     {\n-      if (!first && c_parser_next_token_is (parser, CPP_COMMA))\n+      if (!first\n+\t  && c_parser_next_token_is (parser, CPP_COMMA)\n+\t  && c_parser_peek_2nd_token (parser)->type == CPP_NAME)\n \tc_parser_consume_token (parser);\n \n       first = false;"}, {"sha": "3550cd06dc19424ab69389bf1f26652d189d08fb", "filename": "gcc/cp/parser.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2ca89394280da4afad6074ec3cb7136b6142af7b/gcc%2Fcp%2Fparser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2ca89394280da4afad6074ec3cb7136b6142af7b/gcc%2Fcp%2Fparser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fparser.c?ref=2ca89394280da4afad6074ec3cb7136b6142af7b", "patch": "@@ -39171,7 +39171,9 @@ cp_parser_omp_atomic (cp_parser *parser, cp_token *pragma_tok, bool openacc)\n \n   while (cp_lexer_next_token_is_not (parser->lexer, CPP_PRAGMA_EOL))\n     {\n-      if (!first && cp_lexer_next_token_is (parser->lexer, CPP_COMMA))\n+      if (!first\n+\t  && cp_lexer_next_token_is (parser->lexer, CPP_COMMA)\n+\t  && cp_lexer_nth_token_is (parser->lexer, 2, CPP_NAME))\n \tcp_lexer_consume_token (parser->lexer);\n \n       first = false;"}, {"sha": "f70c805102336a9f55d6af9ed25b71a1a830b3d3", "filename": "gcc/testsuite/c-c++-common/gomp/atomic-24.c", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2ca89394280da4afad6074ec3cb7136b6142af7b/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fatomic-24.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2ca89394280da4afad6074ec3cb7136b6142af7b/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fatomic-24.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fatomic-24.c?ref=2ca89394280da4afad6074ec3cb7136b6142af7b", "patch": "@@ -0,0 +1,12 @@\n+/* PR c/101297 */\n+\n+int i;\n+\n+void\n+foo (void)\n+{\n+  #pragma omp atomic update,\t/* { dg-error \"expected end of line before ',' token\" } */\n+  i++;\n+  #pragma omp atomic update,,\t/* { dg-error \"expected end of line before ',' token\" } */\n+  i++;\n+}"}]}