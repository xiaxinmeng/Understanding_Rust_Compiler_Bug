{"sha": "c914ac45c7670c710f3ec17dbd5341e55ae2380f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzkxNGFjNDVjNzY3MGM3MTBmM2VjMTdkYmQ1MzQxZTU1YWUyMzgwZg==", "commit": {"author": {"name": "Andreas Krebbel", "email": "krebbel@linux.vnet.ibm.com", "date": "2015-08-06T10:21:41Z"}, "committer": {"name": "Andreas Krebbel", "email": "krebbel@gcc.gnu.org", "date": "2015-08-06T10:21:41Z"}, "message": "S/390: Clobber VRs in __builtin_tbegin.\n\ngcc/ChangeLog:\n\t    * config/s390/s390.c (s390_expand_tbegin): Expand either\n\t    tbegin_1_z13 or tbegin_1 depending on VX flag.\n\t    * config/s390/s390.md (\"tbegin_1_z13\"): New expander.\n\ngcc/testsuite/ChangeLog:\n\t    * gcc.target/s390/htm-builtins-z13-1.c: New test.\n\nFrom-SVN: r226672", "tree": {"sha": "5e8d1a9d8c249a6b65d1057994534a922a773a6f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5e8d1a9d8c249a6b65d1057994534a922a773a6f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c914ac45c7670c710f3ec17dbd5341e55ae2380f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c914ac45c7670c710f3ec17dbd5341e55ae2380f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c914ac45c7670c710f3ec17dbd5341e55ae2380f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c914ac45c7670c710f3ec17dbd5341e55ae2380f/comments", "author": null, "committer": null, "parents": [{"sha": "17f262c539a04ae4e3d6c3ea673ca0b46201d237", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/17f262c539a04ae4e3d6c3ea673ca0b46201d237", "html_url": "https://github.com/Rust-GCC/gccrs/commit/17f262c539a04ae4e3d6c3ea673ca0b46201d237"}], "stats": {"total": 82, "additions": 81, "deletions": 1}, "files": [{"sha": "357ea67b76ec5868056ba17f711b3b7bf4b6faa3", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c914ac45c7670c710f3ec17dbd5341e55ae2380f", "patch": "@@ -1,3 +1,9 @@\n+2015-08-06  Andreas Krebbel  <krebbel@linux.vnet.ibm.com>\n+\n+\t* config/s390/s390.c (s390_expand_tbegin): Expand either\n+\ttbegin_1_z13 or tbegin_1 depending on VX flag.\n+\t* config/s390/s390.md (\"tbegin_1_z13\"): New expander.\n+\n 2015-08-06  Andreas Krebbel  <krebbel@linux.vnet.ibm.com>\n \n \t* config/s390/s390.opt: Clarify description for -mzvector"}, {"sha": "24a92908556e2dff915978df1a9de59d2e49e12c", "filename": "gcc/config/s390/s390.c", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Fconfig%2Fs390%2Fs390.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Fconfig%2Fs390%2Fs390.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fs390.c?ref=c914ac45c7670c710f3ec17dbd5341e55ae2380f", "patch": "@@ -11623,7 +11623,14 @@ s390_expand_tbegin (rtx dest, rtx tdb, rtx retry, bool clobber_fprs_p)\n     }\n \n   if (clobber_fprs_p)\n-    emit_insn (gen_tbegin_1 (gen_rtx_CONST_INT (VOIDmode, TBEGIN_MASK), tdb));\n+    {\n+      if (TARGET_VX)\n+\temit_insn (gen_tbegin_1_z13 (gen_rtx_CONST_INT (VOIDmode, TBEGIN_MASK),\n+\t\t\t\t     tdb));\n+      else\n+\temit_insn (gen_tbegin_1 (gen_rtx_CONST_INT (VOIDmode, TBEGIN_MASK),\n+\t\t\t\t tdb));\n+    }\n   else\n     emit_insn (gen_tbegin_nofloat_1 (gen_rtx_CONST_INT (VOIDmode, TBEGIN_MASK),\n \t\t\t\t     tdb));"}, {"sha": "2be7653d713053323c4cd2e2e03dcd43ac2e21bf", "filename": "gcc/config/s390/s390.md", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Fconfig%2Fs390%2Fs390.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Fconfig%2Fs390%2Fs390.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fs390%2Fs390.md?ref=c914ac45c7670c710f3ec17dbd5341e55ae2380f", "patch": "@@ -10626,6 +10626,35 @@\n   DONE;\n })\n \n+; Clobber VRs since they don't get restored\n+(define_insn \"tbegin_1_z13\"\n+  [(set (reg:CCRAW CC_REGNUM)\n+\t(unspec_volatile:CCRAW [(match_operand 0 \"const_int_operand\" \"D\")]\n+\t\t\t       UNSPECV_TBEGIN))\n+   (set (match_operand:BLK 1 \"memory_operand\" \"=Q\")\n+\t(unspec_volatile:BLK [(match_dup 0)] UNSPECV_TBEGIN_TDB))\n+   (clobber (reg:TI 16)) (clobber (reg:TI 38))\n+   (clobber (reg:TI 17)) (clobber (reg:TI 39))\n+   (clobber (reg:TI 18)) (clobber (reg:TI 40))\n+   (clobber (reg:TI 19)) (clobber (reg:TI 41))\n+   (clobber (reg:TI 20)) (clobber (reg:TI 42))\n+   (clobber (reg:TI 21)) (clobber (reg:TI 43))\n+   (clobber (reg:TI 22)) (clobber (reg:TI 44))\n+   (clobber (reg:TI 23)) (clobber (reg:TI 45))\n+   (clobber (reg:TI 24)) (clobber (reg:TI 46))\n+   (clobber (reg:TI 25)) (clobber (reg:TI 47))\n+   (clobber (reg:TI 26)) (clobber (reg:TI 48))\n+   (clobber (reg:TI 27)) (clobber (reg:TI 49))\n+   (clobber (reg:TI 28)) (clobber (reg:TI 50))\n+   (clobber (reg:TI 29)) (clobber (reg:TI 51))\n+   (clobber (reg:TI 30)) (clobber (reg:TI 52))\n+   (clobber (reg:TI 31)) (clobber (reg:TI 53))]\n+; CONST_OK_FOR_CONSTRAINT_P does not work with D constraint since D is\n+; not supposed to be used for immediates (see genpreds.c).\n+  \"TARGET_VX && INTVAL (operands[0]) >= 0 && INTVAL (operands[0]) <= 0xffff\"\n+  \"tbegin\\t%1,%x0\"\n+  [(set_attr \"op_type\" \"SIL\")])\n+\n (define_insn \"tbegin_1\"\n   [(set (reg:CCRAW CC_REGNUM)\n \t(unspec_volatile:CCRAW [(match_operand 0 \"const_int_operand\" \"D\")]"}, {"sha": "e087538b332d84f136841953aa3485677fcf7a97", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c914ac45c7670c710f3ec17dbd5341e55ae2380f", "patch": "@@ -1,3 +1,7 @@\n+2015-08-06  Andreas Krebbel  <krebbel@linux.vnet.ibm.com>\n+\n+\t* gcc.target/s390/htm-builtins-z13-1.c: New test.\n+\n 2015-08-06  Francois-Xavier Coudert  <fxcoudert@gcc.gnu.org>\n \n \tPR fortran/64022"}, {"sha": "7879c36aeab63fd3df71b80f0d508e82759de38d", "filename": "gcc/testsuite/gcc.target/s390/htm-builtins-z13-1.c", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Ftestsuite%2Fgcc.target%2Fs390%2Fhtm-builtins-z13-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c914ac45c7670c710f3ec17dbd5341e55ae2380f/gcc%2Ftestsuite%2Fgcc.target%2Fs390%2Fhtm-builtins-z13-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fs390%2Fhtm-builtins-z13-1.c?ref=c914ac45c7670c710f3ec17dbd5341e55ae2380f", "patch": "@@ -0,0 +1,34 @@\n+/* Verify if VRs are saved and restored.  */\n+\n+/* { dg-do run } */\n+/* { dg-require-effective-target vector } */\n+/* { dg-options \"-O3 -march=z13 -mzarch\" } */\n+\n+typedef int __attribute__((vector_size(16))) v4si;\n+\n+v4si __attribute__((noinline))\n+foo (v4si a)\n+{\n+  a += (v4si){ 1, 1, 1, 1 };\n+  if (__builtin_tbegin (0) == 0)\n+    {\n+      a += (v4si){ 1, 1, 1, 1 };\n+      __builtin_tabort (256);\n+      __builtin_tend ();\n+    }\n+  else\n+    a -= (v4si){ 1, 1, 1, 1 };\n+\n+  return a;\n+}\n+\n+int\n+main ()\n+{\n+  v4si a = (v4si){ 0, 0, 0, 0 };\n+\n+  a = foo (a);\n+\n+  if (a[0] != 0)\n+    __builtin_abort ();\n+}"}]}