{"sha": "16dae48e9cd0421106517fc657c8743a14468945", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTZkYWU0OGU5Y2QwNDIxMTA2NTE3ZmM2NTdjODc0M2ExNDQ2ODk0NQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-01-09T09:48:20Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-01-09T09:48:20Z"}, "message": "vregs: Fix up instantiate_virtual_regs_in_insn for asm goto with outputs [PR98603]\n\nIf an asm insn fails constraint checking during vregs, it is just deleted.\nWe don't delete asm goto though because of the edges to the labels, so\ninstantiate_virtual_regs_in_insn would just remove the inputs and their\nconstraints, the pattern etc.\nThis worked fine when asm goto couldn't have output operands, but causes\nICEs later on when it has more than one output (and furthermore doesn't\nreally remove the problematic outputs).  The problem is that\nfor multiple outputs we have a PARALLEL with multiple ASM_OPERANDS, but\nthose must use the same ASM_OPERANDS_INPUT_VEC etc., but the code was\nadjusting just one.\n\nThe following patch turns invalid asm goto into a bare\nasm goto (\"\" : : : : lab, lab2, lab3);\ni.e. no inputs/outputs/clobbers, just the labels.\n\n2021-01-09  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR rtl-optimization/98603\n\t* function.c (instantiate_virtual_regs_in_insn): For asm goto\n\twith impossible constraints, drop all SETs, CLOBBERs, drop PARALLEL\n\tif any, set ASM_OPERANDS mode to VOIDmode and change\n\tASM_OPERANDS_OUTPUT_CONSTRAINT and ASM_OPERANDS_OUTPUT_IDX.\n\n\t* gcc.target/i386/pr98603.c: New test.\n\t* gcc.target/aarch64/pr98603.c: New test.", "tree": {"sha": "585a37079b9a6ac307ed2016ff7c63a3996cdfdc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/585a37079b9a6ac307ed2016ff7c63a3996cdfdc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/16dae48e9cd0421106517fc657c8743a14468945", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/16dae48e9cd0421106517fc657c8743a14468945", "html_url": "https://github.com/Rust-GCC/gccrs/commit/16dae48e9cd0421106517fc657c8743a14468945", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/16dae48e9cd0421106517fc657c8743a14468945/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57450da2fef3a32dc463b85e7b3d67f519b282cb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/57450da2fef3a32dc463b85e7b3d67f519b282cb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/57450da2fef3a32dc463b85e7b3d67f519b282cb"}], "stats": {"total": 30, "additions": 28, "deletions": 2}, "files": [{"sha": "a3ed3987b9523eb2fdc75986bb992e9fb15c2509", "filename": "gcc/function.c", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16dae48e9cd0421106517fc657c8743a14468945/gcc%2Ffunction.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16dae48e9cd0421106517fc657c8743a14468945/gcc%2Ffunction.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffunction.c?ref=16dae48e9cd0421106517fc657c8743a14468945", "patch": "@@ -1785,12 +1785,16 @@ instantiate_virtual_regs_in_insn (rtx_insn *insn)\n \t{\n \t  error_for_asm (insn, \"impossible constraint in %<asm%>\");\n \t  /* For asm goto, instead of fixing up all the edges\n-\t     just clear the template and clear input operands\n-\t     (asm goto doesn't have any output operands).  */\n+\t     just clear the template and clear input and output operands\n+\t     and strip away clobbers.  */\n \t  if (JUMP_P (insn))\n \t    {\n \t      rtx asm_op = extract_asm_operands (PATTERN (insn));\n+\t      PATTERN (insn) = asm_op;\n+\t      PUT_MODE (asm_op, VOIDmode);\n \t      ASM_OPERANDS_TEMPLATE (asm_op) = ggc_strdup (\"\");\n+\t      ASM_OPERANDS_OUTPUT_CONSTRAINT (asm_op) = \"\";\n+\t      ASM_OPERANDS_OUTPUT_IDX (asm_op) = 0;\n \t      ASM_OPERANDS_INPUT_VEC (asm_op) = rtvec_alloc (0);\n \t      ASM_OPERANDS_INPUT_CONSTRAINT_VEC (asm_op) = rtvec_alloc (0);\n \t    }"}, {"sha": "f75d8e4e23a82f4be3d04bbb2205efa7a534f46f", "filename": "gcc/testsuite/gcc.target/aarch64/pr98603.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16dae48e9cd0421106517fc657c8743a14468945/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Fpr98603.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16dae48e9cd0421106517fc657c8743a14468945/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Fpr98603.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Faarch64%2Fpr98603.c?ref=16dae48e9cd0421106517fc657c8743a14468945", "patch": "@@ -0,0 +1,11 @@\n+/* PR rtl-optimization/98603 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O0\" } */\n+\n+int\n+foo (void)\n+{\n+  int b, c;\n+  asm goto (\"\" : \"=R\" (b), \"=r\" (c) : : : lab);\t/* { dg-error \"impossible constraint in 'asm'\" } */\n+lab:;\n+}"}, {"sha": "9bf924ec06b7273092f5b7ec85e6b5fc7c5fd0ae", "filename": "gcc/testsuite/gcc.target/i386/pr98603.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16dae48e9cd0421106517fc657c8743a14468945/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr98603.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16dae48e9cd0421106517fc657c8743a14468945/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr98603.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr98603.c?ref=16dae48e9cd0421106517fc657c8743a14468945", "patch": "@@ -0,0 +1,11 @@\n+/* PR rtl-optimization/98603 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O0 -w\" } */\n+\n+int\n+foo (void)\n+{\n+  int b, c;\n+  asm goto (\"\" : \"=r\" (b), \"=r\" (c) : \"I\" (128) : : lab);\t/* { dg-error \"impossible constraint in 'asm'\" } */\n+lab:;\n+}"}]}