{"sha": "922a06c370916f82d58f43a782075994ae7b4009", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTIyYTA2YzM3MDkxNmY4MmQ1OGY0M2E3ODIwNzU5OTRhZTdiNDAwOQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2010-10-11T06:17:45Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2010-10-11T06:17:45Z"}, "message": "re PR target/45870 (note: non-delegitimized UNSPEC 5 found (-O1 -g))\n\n\tPR target/45870\n\t* config/i386/i386.c (ix86_delegitimize_tls_address): New function.\n\t(ix86_delegitimize_address): Use it.\n\n\t* gcc.dg/tls/pr45870.c: New test.\n\nFrom-SVN: r165270", "tree": {"sha": "377e2b3bf614a01891d536ccc1e426d22fa853b1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/377e2b3bf614a01891d536ccc1e426d22fa853b1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/922a06c370916f82d58f43a782075994ae7b4009", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/922a06c370916f82d58f43a782075994ae7b4009", "html_url": "https://github.com/Rust-GCC/gccrs/commit/922a06c370916f82d58f43a782075994ae7b4009", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/922a06c370916f82d58f43a782075994ae7b4009/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "fdcbbfe70c66b9c793f7e0cde99e1acdbc299990", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fdcbbfe70c66b9c793f7e0cde99e1acdbc299990", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fdcbbfe70c66b9c793f7e0cde99e1acdbc299990"}], "stats": {"total": 81, "additions": 78, "deletions": 3}, "files": [{"sha": "50f894396cac4fb5f1ec223bac7ab636a57d2957", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/922a06c370916f82d58f43a782075994ae7b4009/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/922a06c370916f82d58f43a782075994ae7b4009/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=922a06c370916f82d58f43a782075994ae7b4009", "patch": "@@ -1,3 +1,9 @@\n+2010-10-11  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/45870\n+\t* config/i386/i386.c (ix86_delegitimize_tls_address): New function.\n+\t(ix86_delegitimize_address): Use it.\n+\n 2010-10-10  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* opt-functions.awk (opt_sanitized_name): Remove gdwarf+ handling."}, {"sha": "f6c4eb40e6c471010adeeb7831f81a0a2e25a3ef", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 46, "deletions": 3, "changes": 49, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/922a06c370916f82d58f43a782075994ae7b4009/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/922a06c370916f82d58f43a782075994ae7b4009/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=922a06c370916f82d58f43a782075994ae7b4009", "patch": "@@ -12305,6 +12305,49 @@ ix86_pic_register_p (rtx x)\n     return REG_P (x) && REGNO (x) == PIC_OFFSET_TABLE_REGNUM;\n }\n \n+/* Helper function for ix86_delegitimize_address.\n+   Attempt to delegitimize TLS local-exec accesses.  */\n+\n+static rtx\n+ix86_delegitimize_tls_address (rtx orig_x)\n+{\n+  rtx x = orig_x, unspec;\n+  struct ix86_address addr;\n+\n+  if (!TARGET_TLS_DIRECT_SEG_REFS)\n+    return orig_x;\n+  if (MEM_P (x))\n+    x = XEXP (x, 0);\n+  if (GET_CODE (x) != PLUS || GET_MODE (x) != Pmode)\n+    return orig_x;\n+  if (ix86_decompose_address (x, &addr) == 0\n+      || addr.seg != (TARGET_64BIT ? SEG_FS : SEG_GS)\n+      || addr.disp == NULL_RTX\n+      || GET_CODE (addr.disp) != CONST)\n+    return orig_x;\n+  unspec = XEXP (addr.disp, 0);\n+  if (GET_CODE (unspec) == PLUS && CONST_INT_P (XEXP (unspec, 1)))\n+    unspec = XEXP (unspec, 0);\n+  if (GET_CODE (unspec) != UNSPEC || XINT (unspec, 1) != UNSPEC_NTPOFF)\n+    return orig_x;\n+  x = XVECEXP (unspec, 0, 0);\n+  gcc_assert (GET_CODE (x) == SYMBOL_REF);\n+  if (unspec != XEXP (addr.disp, 0))\n+    x = gen_rtx_PLUS (Pmode, x, XEXP (XEXP (addr.disp, 0), 1));\n+  if (addr.index)\n+    {\n+      rtx idx = addr.index;\n+      if (addr.scale != 1)\n+\tidx = gen_rtx_MULT (Pmode, idx, GEN_INT (addr.scale));\n+      x = gen_rtx_PLUS (Pmode, idx, x);\n+    }\n+  if (addr.base)\n+    x = gen_rtx_PLUS (Pmode, addr.base, x);\n+  if (MEM_P (orig_x))\n+    x = replace_equiv_address_nv (orig_x, x);\n+  return x;\n+}\n+\n /* In the name of slightly smaller debug output, and to cater to\n    general assembler lossage, recognize PIC+GOTOFF and turn it back\n    into a direct symbol reference.\n@@ -12340,7 +12383,7 @@ ix86_delegitimize_address (rtx x)\n \t  || GET_CODE (XEXP (x, 0)) != UNSPEC\n \t  || XINT (XEXP (x, 0), 1) != UNSPEC_GOTPCREL\n \t  || !MEM_P (orig_x))\n-\treturn orig_x;\n+\treturn ix86_delegitimize_tls_address (orig_x);\n       x = XVECEXP (XEXP (x, 0), 0, 0);\n       if (GET_MODE (orig_x) != Pmode)\n \treturn simplify_gen_subreg (GET_MODE (orig_x), x, Pmode, 0);\n@@ -12349,7 +12392,7 @@ ix86_delegitimize_address (rtx x)\n \n   if (GET_CODE (x) != PLUS\n       || GET_CODE (XEXP (x, 1)) != CONST)\n-    return orig_x;\n+    return ix86_delegitimize_tls_address (orig_x);\n \n   if (ix86_pic_register_p (XEXP (x, 0)))\n     /* %ebx + GOT/GOTOFF */\n@@ -12389,7 +12432,7 @@ ix86_delegitimize_address (rtx x)\n     result = XVECEXP (x, 0, 0);\n \n   if (! result)\n-    return orig_x;\n+    return ix86_delegitimize_tls_address (orig_x);\n \n   if (const_addend)\n     result = gen_rtx_CONST (Pmode, gen_rtx_PLUS (Pmode, result, const_addend));"}, {"sha": "46b7174dc1aa3540c2879d9a87097f7dd74eabe7", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/922a06c370916f82d58f43a782075994ae7b4009/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/922a06c370916f82d58f43a782075994ae7b4009/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=922a06c370916f82d58f43a782075994ae7b4009", "patch": "@@ -1,3 +1,8 @@\n+2010-10-11  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/45870\n+\t* gcc.dg/tls/pr45870.c: New test.\n+\n 2010-10-10  Janus Weil  <janus@gcc.gnu.org>\n \n \tPR fortran/45961"}, {"sha": "8a5d3c74a4c992434fcf24d1558e26a932c56191", "filename": "gcc/testsuite/gcc.dg/tls/pr45870.c", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/922a06c370916f82d58f43a782075994ae7b4009/gcc%2Ftestsuite%2Fgcc.dg%2Ftls%2Fpr45870.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/922a06c370916f82d58f43a782075994ae7b4009/gcc%2Ftestsuite%2Fgcc.dg%2Ftls%2Fpr45870.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftls%2Fpr45870.c?ref=922a06c370916f82d58f43a782075994ae7b4009", "patch": "@@ -0,0 +1,21 @@\n+/* PR target/45870 */\n+/* { dg-do compile } */\n+/* { dg-options \"-g -O\" } */\n+/* { dg-require-effective-target tls } */\n+\n+__thread int v[30];\n+int bar (void);\n+\n+int\n+foo (int x, int y, int z)\n+{\n+  int a, b = z, c;\n+  while (b > 0)\n+    {\n+      c = (bar () % 3);\n+      a = v[x];\n+      if (x < y)\n+\tfor (;;);\n+      b += a;\n+    }\n+}"}]}