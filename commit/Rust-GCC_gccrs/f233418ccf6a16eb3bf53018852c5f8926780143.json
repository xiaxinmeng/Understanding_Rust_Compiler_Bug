{"sha": "f233418ccf6a16eb3bf53018852c5f8926780143", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjIzMzQxOGNjZjZhMTZlYjNiZjUzMDE4ODUyYzVmODkyNjc4MDE0Mw==", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2020-05-14T13:49:52Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2020-06-04T16:56:37Z"}, "message": "[OpenACC] Use 'tgt' returned from 'gomp_map_vars'\n\n\tlibgomp/\n\t* oacc-mem.c (goacc_enter_datum): Use 'tgt' returned from\n\t'gomp_map_vars'.\n\t (acc_map_data): Clean up accordingly.\n\nCo-Authored-By: Julian Brown <julian@codesourcery.com>", "tree": {"sha": "d01a177f5507320bf35e770fabf1a25246630ece", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d01a177f5507320bf35e770fabf1a25246630ece"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f233418ccf6a16eb3bf53018852c5f8926780143", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f233418ccf6a16eb3bf53018852c5f8926780143", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f233418ccf6a16eb3bf53018852c5f8926780143", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f233418ccf6a16eb3bf53018852c5f8926780143/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d7794c0a2aa6696ab1a91ef209e8a9fe2df56ac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8d7794c0a2aa6696ab1a91ef209e8a9fe2df56ac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8d7794c0a2aa6696ab1a91ef209e8a9fe2df56ac"}], "stats": {"total": 27, "additions": 15, "deletions": 12}, "files": [{"sha": "e2fb651a23349f42e61aea7c1f4eaaa9f6f6f53e", "filename": "libgomp/oacc-mem.c", "status": "modified", "additions": 15, "deletions": 12, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f233418ccf6a16eb3bf53018852c5f8926780143/libgomp%2Foacc-mem.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f233418ccf6a16eb3bf53018852c5f8926780143/libgomp%2Foacc-mem.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Foacc-mem.c?ref=f233418ccf6a16eb3bf53018852c5f8926780143", "patch": "@@ -355,7 +355,6 @@ acc_is_present (void *h, size_t s)\n void\n acc_map_data (void *h, void *d, size_t s)\n {\n-  struct target_mem_desc *tgt = NULL;\n   size_t mapnum = 1;\n   void *hostaddrs = h;\n   void *devaddrs = d;\n@@ -402,10 +401,13 @@ acc_map_data (void *h, void *d, size_t s)\n \n       gomp_mutex_unlock (&acc_dev->lock);\n \n-      tgt = gomp_map_vars (acc_dev, mapnum, &hostaddrs, &devaddrs, &sizes,\n-\t\t\t   &kinds, true, GOMP_MAP_VARS_ENTER_DATA);\n+      struct target_mem_desc *tgt\n+\t= gomp_map_vars (acc_dev, mapnum, &hostaddrs, &devaddrs, &sizes,\n+\t\t\t &kinds, true, GOMP_MAP_VARS_ENTER_DATA);\n       assert (tgt);\n+      assert (tgt->list_count == 1);\n       splay_tree_key n = tgt->list[0].key;\n+      assert (n);\n       assert (n->refcount == 1);\n       assert (n->virtual_refcount == 0);\n       /* Special reference counting behavior.  */\n@@ -555,16 +557,17 @@ goacc_enter_datum (void **hostaddrs, size_t *sizes, void *kinds, int async)\n \n       goacc_aq aq = get_goacc_asyncqueue (async);\n \n-      gomp_map_vars_async (acc_dev, aq, mapnum, hostaddrs, NULL, sizes, kinds,\n-\t\t\t   true, GOMP_MAP_VARS_OPENACC_ENTER_DATA);\n+      struct target_mem_desc *tgt\n+\t= gomp_map_vars_async (acc_dev, aq, mapnum, hostaddrs, NULL, sizes,\n+\t\t\t       kinds, true, GOMP_MAP_VARS_OPENACC_ENTER_DATA);\n+      assert (tgt);\n+      assert (tgt->list_count == 1);\n+      n = tgt->list[0].key;\n+      assert (n);\n+      assert (n->refcount == 1);\n+      assert (n->virtual_refcount == 0);\n \n-      gomp_mutex_lock (&acc_dev->lock);\n-      n = lookup_host (acc_dev, hostaddrs[0], sizes[0]);\n-      assert (n != NULL);\n-      assert (n->tgt_offset == 0);\n-      assert ((uintptr_t) hostaddrs[0] == n->host_start);\n-      d = (void *) n->tgt->tgt_start;\n-      gomp_mutex_unlock (&acc_dev->lock);\n+      d = (void *) tgt->tgt_start;\n     }\n \n   if (profiling_p)"}]}