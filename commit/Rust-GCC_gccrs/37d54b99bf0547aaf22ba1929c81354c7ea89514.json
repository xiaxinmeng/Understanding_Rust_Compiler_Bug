{"sha": "37d54b99bf0547aaf22ba1929c81354c7ea89514", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzdkNTRiOTliZjA1NDdhYWYyMmJhMTkyOWM4MTM1NGM3ZWE4OTUxNA==", "commit": {"author": {"name": "Florian Villoing", "email": "villoing@adacore.com", "date": "2007-09-26T10:44:16Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2007-09-26T10:44:16Z"}, "message": "g-dirope.adb (Remove_Dir): In case we are removing directories recursively...\n\n2007-09-26  Florian Villoing  <villoing@adacore.com>\n\n\t* g-dirope.adb (Remove_Dir): In case we are removing directories\n\trecursively, make sure that if an exception is raised during the\n\tprocessing, the current working directory is reset to its initial\n\tvalue before propagating the exception.\n\nFrom-SVN: r128792", "tree": {"sha": "a9b7b5e8ada88d38fc353bedb861d9539ba2c732", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a9b7b5e8ada88d38fc353bedb861d9539ba2c732"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/37d54b99bf0547aaf22ba1929c81354c7ea89514", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37d54b99bf0547aaf22ba1929c81354c7ea89514", "html_url": "https://github.com/Rust-GCC/gccrs/commit/37d54b99bf0547aaf22ba1929c81354c7ea89514", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37d54b99bf0547aaf22ba1929c81354c7ea89514/comments", "author": null, "committer": null, "parents": [{"sha": "da2ac8c26f63fbe1d5d2c4ff23b99e81967873ff", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/da2ac8c26f63fbe1d5d2c4ff23b99e81967873ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/da2ac8c26f63fbe1d5d2c4ff23b99e81967873ff"}], "stats": {"total": 60, "additions": 40, "deletions": 20}, "files": [{"sha": "fe9b5f17aa6c4aecd13532852181cac84f93d0a7", "filename": "gcc/ada/g-dirope.adb", "status": "modified", "additions": 40, "deletions": 20, "changes": 60, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37d54b99bf0547aaf22ba1929c81354c7ea89514/gcc%2Fada%2Fg-dirope.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37d54b99bf0547aaf22ba1929c81354c7ea89514/gcc%2Fada%2Fg-dirope.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fg-dirope.adb?ref=37d54b99bf0547aaf22ba1929c81354c7ea89514", "patch": "@@ -743,32 +743,52 @@ package body GNAT.Directory_Operations is\n       --  Remove directory and all files and directories that it may contain\n \n       else\n-         Change_Dir (Dir_Name);\n-         Open (Working_Dir, \".\");\n+         --  Substantial comments needed. See RH for revision 1.50 ???\n \n-         loop\n-            Read (Working_Dir, Str, Last);\n-            exit when Last = 0;\n+         begin\n+            Change_Dir (Dir_Name);\n+            Open (Working_Dir, \".\");\n \n-            if GNAT.OS_Lib.Is_Directory (Str (1 .. Last)) then\n-               if Str (1 .. Last) /= \".\" and then Str (1 .. Last) /= \"..\" then\n-                  Remove_Dir (Str (1 .. Last), True);\n-                  Remove_Dir (Str (1 .. Last));\n-               end if;\n+            loop\n+               Read (Working_Dir, Str, Last);\n+               exit when Last = 0;\n \n-            else\n-               GNAT.OS_Lib.Delete_File (Str (1 .. Last), Success);\n+               if GNAT.OS_Lib.Is_Directory (Str (1 .. Last)) then\n+                  if Str (1 .. Last) /= \".\"\n+                       and then\n+                     Str (1 .. Last) /= \"..\"\n+                  then\n+                     Remove_Dir (Str (1 .. Last), True);\n+                     Remove_Dir (Str (1 .. Last));\n+                  end if;\n+\n+               else\n+                  GNAT.OS_Lib.Delete_File (Str (1 .. Last), Success);\n \n-               if not Success then\n-                  Change_Dir (Current_Dir);\n-                  raise Directory_Error;\n+                  if not Success then\n+                     Change_Dir (Current_Dir);\n+                     raise Directory_Error;\n+                  end if;\n                end if;\n-            end if;\n-         end loop;\n+            end loop;\n+\n+            Change_Dir (Current_Dir);\n+            Close (Working_Dir);\n+            Remove_Dir (Dir_Name);\n+\n+         exception\n+            when others =>\n \n-         Change_Dir (Current_Dir);\n-         Close (Working_Dir);\n-         Remove_Dir (Dir_Name);\n+               --  An exception occurred. We must make sure the current working\n+               --  directory is unchanged.\n+\n+               Change_Dir (Current_Dir);\n+\n+               --  What if the Change_Dir raises an exception itself, shouldn't\n+               --  that be protected? ???\n+\n+               raise;\n+         end;\n       end if;\n    end Remove_Dir;\n "}]}