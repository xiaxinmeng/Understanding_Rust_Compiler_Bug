{"sha": "a6fc8e21b21142c6f8215420a0c7ffef533881a5", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTZmYzhlMjFiMjExNDJjNmY4MjE1NDIwYTBjN2ZmZWY1MzM4ODFhNQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2006-05-15T10:02:26Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2006-05-15T10:02:26Z"}, "message": "omp-low.c (check_omp_nesting_restrictions): New function.\n\n\t* omp-low.c (check_omp_nesting_restrictions): New function.\n\t(scan_omp_1): Call it.\n\n\t* gcc.dg/gomp/critical-4.c: New test.\n\t* gcc.dg/gomp/appendix-a/a.35.1.c: Add dg-warning.\n\t* gcc.dg/gomp/appendix-a/a.35.3.c: Likewise.\n\t* gfortran.dg/gomp/appendix-a/a.35.1.f90: Likewise.\n\t* gfortran.dg/gomp/appendix-a/a.35.3.f90: Likewise.\n\nFrom-SVN: r113790", "tree": {"sha": "7388a01e1751bcddaf846846ad4e5f139e5bbc61", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7388a01e1751bcddaf846846ad4e5f139e5bbc61"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a6fc8e21b21142c6f8215420a0c7ffef533881a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a6fc8e21b21142c6f8215420a0c7ffef533881a5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a6fc8e21b21142c6f8215420a0c7ffef533881a5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a6fc8e21b21142c6f8215420a0c7ffef533881a5/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "eeb1d9e08e920796ba71d81765f5a9fdf54af25e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eeb1d9e08e920796ba71d81765f5a9fdf54af25e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/eeb1d9e08e920796ba71d81765f5a9fdf54af25e"}], "stats": {"total": 131, "additions": 127, "deletions": 4}, "files": [{"sha": "ed5920e07e390b4875e88afb741789ecf6d1bab0", "filename": "gcc/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -1,5 +1,8 @@\n 2006-05-15  Jakub Jelinek  <jakub@redhat.com>\n \n+\t* omp-low.c (check_omp_nesting_restrictions): New function.\n+\t(scan_omp_1): Call it.\n+\n \tPR middle-end/27416\n \t* omp-low.c (build_outer_var_ref): If VAR is reference in orphaned\n \tconstruct, return *VAR."}, {"sha": "2b691fa4c4d1772d261f9f95d385879952a09c07", "filename": "gcc/omp-low.c", "status": "modified", "additions": 82, "deletions": 0, "changes": 82, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Fomp-low.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Fomp-low.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.c?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -1245,6 +1245,84 @@ scan_omp_single (tree *stmt_p, omp_context *outer_ctx)\n }\n \n \n+/* Check OpenMP nesting restrictions.  */\n+static void\n+check_omp_nesting_restrictions (tree t, omp_context *ctx)\n+{\n+  switch (TREE_CODE (t))\n+    {\n+    case OMP_FOR:\n+    case OMP_SECTIONS:\n+    case OMP_SINGLE:\n+      for (; ctx != NULL; ctx = ctx->outer)\n+\tswitch (TREE_CODE (ctx->stmt))\n+\t  {\n+\t  case OMP_FOR:\n+\t  case OMP_SECTIONS:\n+\t  case OMP_SINGLE:\n+\t  case OMP_ORDERED:\n+\t  case OMP_MASTER:\n+\t    warning (0, \"work-sharing region may not be closely nested inside \"\n+\t\t\t\"of work-sharing, critical, ordered or master region\");\n+\t    return;\n+\t  case OMP_PARALLEL:\n+\t    return;\n+\t  default:\n+\t    break;\n+\t  }\n+      break;\n+    case OMP_MASTER:\n+      for (; ctx != NULL; ctx = ctx->outer)\n+\tswitch (TREE_CODE (ctx->stmt))\n+\t  {\n+\t  case OMP_FOR:\n+\t  case OMP_SECTIONS:\n+\t  case OMP_SINGLE:\n+\t    warning (0, \"master region may not be closely nested inside \"\n+\t\t\t\"of work-sharing region\");\n+\t    return;\n+\t  case OMP_PARALLEL:\n+\t    return;\n+\t  default:\n+\t    break;\n+\t  }\n+      break;\n+    case OMP_ORDERED:\n+      for (; ctx != NULL; ctx = ctx->outer)\n+\tswitch (TREE_CODE (ctx->stmt))\n+\t  {\n+\t  case OMP_CRITICAL:\n+\t    warning (0, \"ordered region may not be closely nested inside \"\n+\t\t\t\"of critical region\");\n+\t    return;\n+\t  case OMP_FOR:\n+\t    if (find_omp_clause (OMP_CLAUSES (ctx->stmt),\n+\t\t\t\t OMP_CLAUSE_ORDERED) == NULL)\n+\t      warning (0, \"ordered region must be closely nested inside \"\n+\t\t\t  \"a loop region with an ordered clause\");\n+\t    return;\n+\t  case OMP_PARALLEL:\n+\t    return;\n+\t  default:\n+\t    break;\n+\t  }\n+      break;\n+    case OMP_CRITICAL:\n+      for (; ctx != NULL; ctx = ctx->outer)\n+\tif (TREE_CODE (ctx->stmt) == OMP_CRITICAL\n+\t    && OMP_CRITICAL_NAME (t) == OMP_CRITICAL_NAME (ctx->stmt))\n+\t  {\n+\t    warning (0, \"critical region may not be nested inside a critical \"\n+\t\t\t\"region with the same name\");\n+\t    return;\n+\t  }\n+      break;\n+    default:\n+      break;\n+    }\n+}\n+\n+\n /* Callback for walk_stmts used to scan for OpenMP directives at TP.  */\n \n static tree\n@@ -1257,6 +1335,10 @@ scan_omp_1 (tree *tp, int *walk_subtrees, void *data)\n   if (EXPR_HAS_LOCATION (t))\n     input_location = EXPR_LOCATION (t);\n \n+  /* Check the OpenMP nesting restrictions.  */\n+  if (OMP_DIRECTIVE_P (t) && ctx != NULL)\n+    check_omp_nesting_restrictions (t, ctx);\n+\n   *walk_subtrees = 0;\n   switch (TREE_CODE (t))\n     {"}, {"sha": "de208a50dd9fa46a8f7cf70de095b0b06c26ca0d", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -1,3 +1,11 @@\n+2006-05-15  Jakub Jelinek  <jakub@redhat.com>\n+\n+\t* gcc.dg/gomp/critical-4.c: New test.\n+\t* gcc.dg/gomp/appendix-a/a.35.1.c: Add dg-warning.\n+\t* gcc.dg/gomp/appendix-a/a.35.3.c: Likewise.\n+\t* gfortran.dg/gomp/appendix-a/a.35.1.f90: Likewise.\n+\t* gfortran.dg/gomp/appendix-a/a.35.3.f90: Likewise.\n+\n 2006-05-15  Volker Reichelt  <reichelt@igpm.rwth-aachen.de>\n \n \tPR c++/27582"}, {"sha": "4196b2d1521673f8b52496cbb2ca233c5da81e1f", "filename": "gcc/testsuite/gcc.dg/gomp/appendix-a/a.35.1.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fappendix-a%2Fa.35.1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fappendix-a%2Fa.35.1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fappendix-a%2Fa.35.1.c?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -15,7 +15,7 @@ wrong1 (int n)\n     for (i = 0; i < n; i++)\n       {\n \t/* incorrect nesting of loop regions */\n-#pragma omp for\n+#pragma omp for\t\t/* { dg-warning \"may not be closely nested\" } */\n \tfor (j = 0; j < n; j++)\n \t  work (i, j);\n       }"}, {"sha": "31b2ddf0367e492e0f9043431c744dc15ec6fc09", "filename": "gcc/testsuite/gcc.dg/gomp/appendix-a/a.35.3.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fappendix-a%2Fa.35.3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fappendix-a%2Fa.35.3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fappendix-a%2Fa.35.3.c?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -12,7 +12,7 @@ wrong3 (int n)\n     for (i = 0; i < n; i++)\n       {\n /* incorrect nesting of regions */\n-#pragma omp single\n+#pragma omp single\t/* { dg-warning \"may not be closely nested\" } */\n \twork (i, 0);\n       }\n   }"}, {"sha": "530e7c976fcdc548ccdfb6bb742590a6c04c898f", "filename": "gcc/testsuite/gcc.dg/gomp/critical-4.c", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fcritical-4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fcritical-4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fcritical-4.c?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -0,0 +1,28 @@\n+/* { dg-do compile } */\n+\n+extern void bar(int);\n+\n+void\n+foo1 (void)\n+{\n+  #pragma omp critical\n+  #pragma omp critical(foo)\n+  #pragma omp critical(bar)\n+    bar (0);\n+}\n+\n+void\n+foo2 (void)\n+{\n+  #pragma omp critical\n+  #pragma omp critical\t\t/* { dg-warning \"with the same name\" } */\n+    bar (0);\n+}\n+\n+void\n+foo3 (void)\n+{\n+  #pragma omp critical(foo)\n+  #pragma omp critical(foo)\t/* { dg-warning \"with the same name\" } */\n+    bar (0);\n+}"}, {"sha": "7431a6579c3ab968cdb1591f0f512052715bc4e0", "filename": "gcc/testsuite/gfortran.dg/gomp/appendix-a/a.35.1.f90", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fappendix-a%2Fa.35.1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fappendix-a%2Fa.35.1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fappendix-a%2Fa.35.1.f90?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -9,7 +9,8 @@ SUBROUTINE WRONG1(N)\n !$OMP PARALLEL DEFAULT(SHARED)\n !$OMP DO\n           DO I = 1, N\n-!$OMP DO              ! incorrect nesting of loop regions\n+\t     ! incorrect nesting of loop regions\n+!$OMP DO     ! { dg-warning \"may not be closely nested\" }\n              DO J = 1, N\n                 CALL WORK(I,J)\n              END DO"}, {"sha": "bb3e02fefd9ef5f30c72f0665038deb891aa9599", "filename": "gcc/testsuite/gfortran.dg/gomp/appendix-a/a.35.3.f90", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fappendix-a%2Fa.35.3.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6fc8e21b21142c6f8215420a0c7ffef533881a5/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fappendix-a%2Fa.35.3.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fappendix-a%2Fa.35.3.f90?ref=a6fc8e21b21142c6f8215420a0c7ffef533881a5", "patch": "@@ -6,7 +6,8 @@ SUBROUTINE WRONG3(N)\n !$OMP PARALLEL DEFAULT(SHARED)\n !$OMP DO\n           DO I = 1, N\n-!$OMP SINGLE            ! incorrect nesting of regions\n+\t       ! incorrect nesting of regions\n+!$OMP SINGLE   ! { dg-warning \"may not be closely nested\" }\n                CALL WORK(I, 1)\n !$OMP END SINGLE\n           END DO"}]}