{"sha": "45116f342057b7facecd3d05c2091ce3a77eda59", "node_id": "C_kwDOANBUbNoAKDQ1MTE2ZjM0MjA1N2I3ZmFjZWNkM2QwNWMyMDkxY2UzYTc3ZWRhNTk", "commit": {"author": {"name": "Nelson Chu", "email": "nelson.chu@sifive.com", "date": "2021-11-29T12:48:20Z"}, "committer": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2021-12-06T02:55:01Z"}, "message": "RISC-V: jal cannot refer to a default visibility symbol for shared object.\n\nThis is the original binutils bugzilla report,\nhttps://sourceware.org/bugzilla/show_bug.cgi?id=28509\n\nAnd this is the first version of the proposed binutils patch,\nhttps://sourceware.org/pipermail/binutils/2021-November/118398.html\n\nAfter applying the binutils patch, I get the the unexpected error when\nbuilding libgcc,\n\n/scratch/nelsonc/riscv-gnu-toolchain/riscv-gcc/libgcc/config/riscv/div.S:42:\n/scratch/nelsonc/build-upstream/rv64gc-linux/build-install/riscv64-unknown-linux-gnu/bin/ld: relocation R_RISCV_JAL against `__udivdi3' which may bind externally can not be used when making a shared object; recompile with -fPIC\n\nTherefore, this patch add an extra hidden alias symbol for __udivdi3, and\nthen use HIDDEN_JUMPTARGET to target a non-preemptible symbol instead.\nThe solution is similar to glibc as follows,\nhttps://sourceware.org/git/?p=glibc.git;a=commit;h=68389203832ab39dd0dbaabbc4059e7fff51c29b\n\nlibgcc/ChangeLog:\n\n\t* config/riscv/div.S: Add the hidden alias symbol for __udivdi3, and\n\tthen use HIDDEN_JUMPTARGET to target it since it is non-preemptible.\n\t* config/riscv/riscv-asm.h: Added new macros HIDDEN_JUMPTARGET and\n\tHIDDEN_DEF.", "tree": {"sha": "c4ec4f8c446d5fe5d59d4259f41e44f07c8eaa25", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c4ec4f8c446d5fe5d59d4259f41e44f07c8eaa25"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/45116f342057b7facecd3d05c2091ce3a77eda59", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/45116f342057b7facecd3d05c2091ce3a77eda59", "html_url": "https://github.com/Rust-GCC/gccrs/commit/45116f342057b7facecd3d05c2091ce3a77eda59", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/45116f342057b7facecd3d05c2091ce3a77eda59/comments", "author": null, "committer": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b880d1514c1e3dd75a6ea311a5cc956742bd713c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b880d1514c1e3dd75a6ea311a5cc956742bd713c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b880d1514c1e3dd75a6ea311a5cc956742bd713c"}], "stats": {"total": 21, "additions": 14, "deletions": 7}, "files": [{"sha": "723c3b82e48c63227258072e12d504b749c8e05f", "filename": "libgcc/config/riscv/div.S", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/45116f342057b7facecd3d05c2091ce3a77eda59/libgcc%2Fconfig%2Friscv%2Fdiv.S", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/45116f342057b7facecd3d05c2091ce3a77eda59/libgcc%2Fconfig%2Friscv%2Fdiv.S", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Fconfig%2Friscv%2Fdiv.S?ref=45116f342057b7facecd3d05c2091ce3a77eda59", "patch": "@@ -40,7 +40,7 @@ FUNC_BEGIN (__udivsi3)\n   sll    a0, a0, 32\n   sll    a1, a1, 32\n   move   t0, ra\n-  jal    __udivdi3\n+  jal    HIDDEN_JUMPTARGET(__udivdi3)\n   sext.w a0, a0\n   jr     t0\n FUNC_END (__udivsi3)\n@@ -52,7 +52,7 @@ FUNC_BEGIN (__umodsi3)\n   srl    a0, a0, 32\n   srl    a1, a1, 32\n   move   t0, ra\n-  jal    __udivdi3\n+  jal    HIDDEN_JUMPTARGET(__udivdi3)\n   sext.w a0, a1\n   jr     t0\n FUNC_END (__umodsi3)\n@@ -95,11 +95,12 @@ FUNC_BEGIN (__udivdi3)\n .L5:\n   ret\n FUNC_END (__udivdi3)\n+HIDDEN_DEF (__udivdi3)\n \n FUNC_BEGIN (__umoddi3)\n   /* Call __udivdi3(a0, a1), then return the remainder, which is in a1.  */\n   move  t0, ra\n-  jal   __udivdi3\n+  jal   HIDDEN_JUMPTARGET(__udivdi3)\n   move  a0, a1\n   jr    t0\n FUNC_END (__umoddi3)\n@@ -111,12 +112,12 @@ FUNC_END (__umoddi3)\n   bgtz  a1, .L12     /* Compute __udivdi3(-a0, a1), then negate the result.  */\n \n   neg   a1, a1\n-  j     __udivdi3    /* Compute __udivdi3(-a0, -a1).  */\n+  j     HIDDEN_JUMPTARGET(__udivdi3)     /* Compute __udivdi3(-a0, -a1).  */\n .L11:                /* Compute __udivdi3(a0, -a1), then negate the result.  */\n   neg   a1, a1\n .L12:\n   move  t0, ra\n-  jal   __udivdi3\n+  jal   HIDDEN_JUMPTARGET(__udivdi3)\n   neg   a0, a0\n   jr    t0\n FUNC_END (__divdi3)\n@@ -126,15 +127,15 @@ FUNC_BEGIN (__moddi3)\n   bltz   a1, .L31\n   bltz   a0, .L32\n .L30:\n-  jal    __udivdi3    /* The dividend is not negative.  */\n+  jal    HIDDEN_JUMPTARGET(__udivdi3)    /* The dividend is not negative.  */\n   move   a0, a1\n   jr     t0\n .L31:\n   neg    a1, a1\n   bgez   a0, .L30\n .L32:\n   neg    a0, a0\n-  jal    __udivdi3    /* The dividend is hella negative.  */\n+  jal    HIDDEN_JUMPTARGET(__udivdi3)    /* The dividend is hella negative.  */\n   neg    a0, a1\n   jr     t0\n FUNC_END (__moddi3)"}, {"sha": "96dd85b0df2e5d224ba33604237e44916069b102", "filename": "libgcc/config/riscv/riscv-asm.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/45116f342057b7facecd3d05c2091ce3a77eda59/libgcc%2Fconfig%2Friscv%2Friscv-asm.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/45116f342057b7facecd3d05c2091ce3a77eda59/libgcc%2Fconfig%2Friscv%2Friscv-asm.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Fconfig%2Friscv%2Friscv-asm.h?ref=45116f342057b7facecd3d05c2091ce3a77eda59", "patch": "@@ -33,3 +33,9 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n #define FUNC_ALIAS(X,Y)\t\t\\\n \t.globl X;\t\t\\\n \tX = Y\n+\n+#define CONCAT1(a, b)\t\tCONCAT2(a, b)\n+#define CONCAT2(a, b)\t\ta ## b\n+#define HIDDEN_JUMPTARGET(X)\tCONCAT1(__hidden_, X)\n+#define HIDDEN_DEF(X)\t\tFUNC_ALIAS(HIDDEN_JUMPTARGET(X), X);     \\\n+\t\t\t\t.hidden HIDDEN_JUMPTARGET(X)"}]}