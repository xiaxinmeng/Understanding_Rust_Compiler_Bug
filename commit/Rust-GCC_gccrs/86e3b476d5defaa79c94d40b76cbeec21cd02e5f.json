{"sha": "86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "node_id": "C_kwDOANBUbNoAKDg2ZTNiNDc2ZDVkZWZhYTc5Yzk0ZDQwYjc2Y2JlZWMyMWNkMDJlNWY", "commit": {"author": {"name": "Francois-Xavier Coudert", "email": "fxcoudert@gmail.com", "date": "2022-01-16T23:00:18Z"}, "committer": {"name": "Francois-Xavier Coudert", "email": "fxcoudert@gmail.com", "date": "2022-01-16T23:02:51Z"}, "message": "Fortran: xfail signaling NaN testcases on x87\n\nThe ABI for x87 and x86-32 is not suitable for passing around\nsignaling NaNs in the way IEEE expects. See for example discussion\nin https://gcc.gnu.org/bugzilla/show_bug.cgi?id=57484\n\ngcc/testsuite/ChangeLog:\n\n\t* gfortran.dg/ieee/signaling_1.f90: xfail on x87.\n\t* gfortran.dg/ieee/signaling_2.f90: xfail on x87.", "tree": {"sha": "182f91488ff1799b6332777964ac3958dc194ffa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/182f91488ff1799b6332777964ac3958dc194ffa"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/comments", "author": {"login": "fxcoudert", "id": 1980544, "node_id": "MDQ6VXNlcjE5ODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1980544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fxcoudert", "html_url": "https://github.com/fxcoudert", "followers_url": "https://api.github.com/users/fxcoudert/followers", "following_url": "https://api.github.com/users/fxcoudert/following{/other_user}", "gists_url": "https://api.github.com/users/fxcoudert/gists{/gist_id}", "starred_url": "https://api.github.com/users/fxcoudert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fxcoudert/subscriptions", "organizations_url": "https://api.github.com/users/fxcoudert/orgs", "repos_url": "https://api.github.com/users/fxcoudert/repos", "events_url": "https://api.github.com/users/fxcoudert/events{/privacy}", "received_events_url": "https://api.github.com/users/fxcoudert/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fxcoudert", "id": 1980544, "node_id": "MDQ6VXNlcjE5ODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1980544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fxcoudert", "html_url": "https://github.com/fxcoudert", "followers_url": "https://api.github.com/users/fxcoudert/followers", "following_url": "https://api.github.com/users/fxcoudert/following{/other_user}", "gists_url": "https://api.github.com/users/fxcoudert/gists{/gist_id}", "starred_url": "https://api.github.com/users/fxcoudert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fxcoudert/subscriptions", "organizations_url": "https://api.github.com/users/fxcoudert/orgs", "repos_url": "https://api.github.com/users/fxcoudert/repos", "events_url": "https://api.github.com/users/fxcoudert/events{/privacy}", "received_events_url": "https://api.github.com/users/fxcoudert/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90045c5df5b3c8853e7740fb72a11aead1c489bb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/90045c5df5b3c8853e7740fb72a11aead1c489bb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/90045c5df5b3c8853e7740fb72a11aead1c489bb"}], "stats": {"total": 292, "additions": 288, "deletions": 4}, "files": [{"sha": "94ece3a4f615e1ce03129a763d42b30fc67ec25f", "filename": "gcc/testsuite/gfortran.dg/ieee/signaling_1.f90", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_1.f90?ref=86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "patch": "@@ -1,8 +1,10 @@\n-! { dg-do run }\n+! { dg-do run { xfail { { i?86-*-* x86_64-*-* } && ilp32 } } }\n+! x87 / x86-32 ABI is unsuitable for signaling NaNs\n+!\n ! { dg-require-effective-target issignaling } */\n ! { dg-additional-sources signaling_1_c.c }\n ! { dg-additional-options \"-w\" }\n-! the -w option is needed to make cc1 not report a warning for \n+! The -w option is needed to make cc1 not report a warning for \n ! the -fintrinsic-modules-path option passed by ieee.exp\n !\n program test"}, {"sha": "ff37ab6e13eb3a0a8af4757c34b9d94331a4c4c8", "filename": "gcc/testsuite/gfortran.dg/ieee/signaling_2.f90", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_2.f90?ref=86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "patch": "@@ -1,8 +1,10 @@\n-! { dg-do run }\n+! { dg-do run { xfail { { i?86-*-* x86_64-*-* } && ilp32 } } }\n+! x87 / x86-32 ABI is unsuitable for signaling NaNs\n+!\n ! { dg-require-effective-target issignaling } */\n ! { dg-additional-sources signaling_2_c.c }\n ! { dg-additional-options \"-w\" }\n-! the -w option is needed to make cc1 not report a warning for\n+! The -w option is needed to make cc1 not report a warning for\n ! the -fintrinsic-modules-path option passed by ieee.exp\n !\n program test"}, {"sha": "45bd9c3599f54e9473a48c81c156ffdcc8bb9265", "filename": "gcc/testsuite/gfortran.dg/ieee/signaling_3.f90", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_3.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_3.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fieee%2Fsignaling_3.f90?ref=86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "patch": "@@ -0,0 +1,42 @@\n+! { dg-do run }\n+!\n+program test\n+  use, intrinsic :: iso_c_binding\n+  use, intrinsic :: ieee_arithmetic\n+  implicit none\n+\n+  real(kind=c_float) :: x\n+  real(kind=c_double) :: y\n+  real(kind=c_long_double) :: z\n+\n+  if (ieee_support_nan(x)) then\n+    x = ieee_value(x, ieee_signaling_nan)\n+    if (ieee_class(x) /= ieee_signaling_nan) stop 100\n+    if (.not. ieee_is_nan(x)) stop 101\n+\n+    x = ieee_value(x, ieee_quiet_nan)\n+    if (ieee_class(x) /= ieee_quiet_nan) stop 103\n+    if (.not. ieee_is_nan(x)) stop 104\n+  end if\n+\n+  if (ieee_support_nan(y)) then\n+    y = ieee_value(y, ieee_signaling_nan)\n+    if (ieee_class(y) /= ieee_signaling_nan) stop 100\n+    if (.not. ieee_is_nan(y)) stop 101\n+\n+    y = ieee_value(y, ieee_quiet_nan)\n+    if (ieee_class(y) /= ieee_quiet_nan) stop 103\n+    if (.not. ieee_is_nan(y)) stop 104\n+  end if\n+\n+  if (ieee_support_nan(z)) then\n+    z = ieee_value(z, ieee_signaling_nan)\n+    if (ieee_class(z) /= ieee_signaling_nan) stop 100\n+    if (.not. ieee_is_nan(z)) stop 101\n+\n+    z = ieee_value(z, ieee_quiet_nan)\n+    if (ieee_class(z) /= ieee_quiet_nan) stop 103\n+    if (.not. ieee_is_nan(z)) stop 104\n+  end if\n+\n+end program test"}, {"sha": "e824cf8c59bde4b2cf58ac3834a3cf5e82f751c1", "filename": "libgfortran/ieee/issignaling_fallback.h", "status": "added", "additions": 238, "deletions": 0, "changes": 238, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/libgfortran%2Fieee%2Fissignaling_fallback.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86e3b476d5defaa79c94d40b76cbeec21cd02e5f/libgfortran%2Fieee%2Fissignaling_fallback.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fieee%2Fissignaling_fallback.h?ref=86e3b476d5defaa79c94d40b76cbeec21cd02e5f", "patch": "@@ -0,0 +1,238 @@\n+/* Fallback implementation of issignaling macro.\n+   Copyright (C) 2022 Free Software Foundation, Inc.\n+   Contributed by Francois-Xavier Coudert <fxcoudert@gcc.gnu.org>\n+\n+This file is part of the GNU Fortran runtime library (libgfortran).\n+\n+Libgfortran is free software; you can redistribute it and/or\n+modify it under the terms of the GNU General Public\n+License as published by the Free Software Foundation; either\n+version 3 of the License, or (at your option) any later version.\n+\n+Libgfortran is distributed in the hope that it will be useful,\n+but WITHOUT ANY WARRANTY; without even the implied warranty of\n+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+GNU General Public License for more details.\n+\n+Under Section 7 of GPL version 3, you are granted additional\n+permissions described in the GCC Runtime Library Exception, version\n+3.1, as published by the Free Software Foundation.\n+\n+You should have received a copy of the GNU General Public License and\n+a copy of the GCC Runtime Library Exception along with this program;\n+see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n+<http://www.gnu.org/licenses/>.  */\n+\n+#include \"libgfortran.h\"\n+\n+/* This header provides an implementation of the type-generic issignaling macro.\n+   Some points of note:\n+\n+     - This header is only included if the issignaling macro is not defined.\n+     - All targets for which Fortran IEEE modules are supported currently have\n+       the high-order bit of the NaN mantissa clear for signaling (and set\n+       for quiet), as recommended by IEEE.\n+     - We use the __*_IS_IEC_60559__ macros to make sure we only deal with formats\n+       we know. For other floating-point formats, we consider all NaNs as quiet.\n+\n+ */\n+\n+typedef union\n+{\n+  float value;\n+  uint32_t word;\n+} ieee_float_shape_type;\n+\n+static inline int\n+__issignalingf (float x)\n+{\n+#if __FLT_IS_IEC_60559__\n+  uint32_t xi;\n+  ieee_float_shape_type u;\n+\n+  u.value = x;\n+  xi = u.word;\n+\n+  xi ^= 0x00400000;\n+  return (xi & 0x7fffffff) > 0x7fc00000;\n+#else\n+  return 0;\n+#endif\n+}\n+\n+\n+typedef union\n+{\n+  double value;\n+  uint64_t word;\n+} ieee_double_shape_type;\n+\n+static inline int\n+__issignaling (double x)\n+{\n+#if __DBL_IS_IEC_60559__\n+  ieee_double_shape_type u;\n+  uint64_t xi;\n+\n+  u.value = x;\n+  xi = u.word;\n+\n+  xi ^= UINT64_C (0x0008000000000000);\n+  return (xi & UINT64_C (0x7fffffffffffffff)) > UINT64_C (0x7ff8000000000000);\n+#else\n+  return 0;\n+#endif\n+}\n+\n+\n+#if __LDBL_DIG__ == __DBL_DIG__\n+\n+/* Long double is the same as double.  */\n+static inline int\n+__issignalingl (long double x)\n+{\n+  return __issignaling (x);\n+}\n+\n+#elif (__LDBL_DIG__ == 18) && __LDBL_IS_IEC_60559__\n+\n+/* Long double is x86 extended type.  */\n+\n+typedef union\n+{\n+  long double value;\n+  struct\n+  {\n+#if __FLOAT_WORD_ORDER == __BIG_ENDIAN\n+    int sign_exponent:16;\n+    unsigned int empty:16;\n+    uint32_t msw;\n+    uint32_t lsw;\n+#elif __FLOAT_WORD_ORDER == __LITTLE_ENDIAN\n+    uint32_t lsw;\n+    uint32_t msw;\n+    int sign_exponent:16;\n+    unsigned int empty:16;\n+#endif\n+  } parts;\n+} ieee_long_double_shape_type;\n+\n+static inline int\n+__issignalingl (long double x)\n+{\n+  int ret;\n+  uint32_t exi, hxi, lxi;\n+  ieee_long_double_shape_type u;\n+\n+  u.value = x;\n+  exi = u.parts.sign_exponent;\n+  hxi = u.parts.msw;\n+  lxi = u.parts.lsw;\n+\n+  /* Pseudo numbers on x86 are always signaling.  */\n+  ret = (exi & 0x7fff) && ((hxi & 0x80000000) == 0);\n+\n+  hxi ^= 0x40000000;\n+  hxi |= (lxi | -lxi) >> 31;\n+  return ret || (((exi & 0x7fff) == 0x7fff) && (hxi > 0xc0000000));\n+}\n+\n+#elif (__LDBL_DIG__ = 33) && __LDBL_IS_IEC_60559__\n+\n+/* Long double is 128-bit type.  */\n+\n+typedef union\n+{\n+  long double value;\n+  struct\n+  {\n+#if __FLOAT_WORD_ORDER == __BIG_ENDIAN\n+    uint64_t msw;\n+    uint64_t lsw;\n+#elif __FLOAT_WORD_ORDER == __LITTLE_ENDIAN\n+    uint64_t lsw;\n+    uint64_t msw;\n+#endif\n+  } parts64;\n+} ieee854_long_double_shape_type;\n+\n+static inline int\n+__issignalingl (long double x)\n+{\n+  uint64_t hxi, lxi;\n+  ieee854_long_double_shape_type u;\n+\n+  u.value = x;\n+  hxi = u.parts64.msw;\n+  lxi = u.parts64.lsw;\n+\n+  hxi ^= UINT64_C (0x0000800000000000);\n+  hxi |= (lxi | -lxi) >> 63;\n+  return (hxi & UINT64_C (0x7fffffffffffffff)) > UINT64_C (0x7fff800000000000);\n+}\n+\n+#else\n+\n+static inline int\n+__issignalingl (long double x)\n+{\n+  return 0;\n+}\n+\n+#endif\n+\n+\n+#if __FLT128_IS_IEC_60559__\n+\n+/* We have a _Float128 type.  */\n+\n+typedef union\n+{\n+  __float128 value;\n+  struct\n+  {\n+#if __FLOAT_WORD_ORDER == __BIG_ENDIAN\n+    uint64_t msw;\n+    uint64_t lsw;\n+#elif __FLOAT_WORD_ORDER == __LITTLE_ENDIAN\n+    uint64_t lsw;\n+    uint64_t msw;\n+#endif\n+  } parts64;\n+} ieee854_float128_shape_type;\n+\n+static inline int\n+__issignalingf128 (__float128 x)\n+{\n+  uint64_t hxi, lxi;\n+  ieee854_float128_shape_type u;\n+\n+  u.value = x;\n+  hxi = u.parts64.msw;\n+  lxi = u.parts64.lsw;\n+\n+  hxi ^= UINT64_C (0x0000800000000000);\n+  hxi |= (lxi | -lxi) >> 63;\n+  return (hxi & UINT64_C (0x7fffffffffffffff)) > UINT64_C (0x7fff800000000000);\n+}\n+\n+#endif\n+\n+\n+/* Define the type-generic macro based on the functions above.  */\n+\n+#if __FLT128_IS_IEC_60559__\n+# define issignaling(X) \\\n+  _Generic ((X), \\\n+\t    __float128: __issignalingf128, \\\n+\t    float: __issignalingf, \\\n+\t    double: __issignaling, \\\n+\t    long double: __issignalingl)(X)\n+#else\n+# define issignaling(X) \\\n+  _Generic ((X), \\\n+\t    float: __issignalingf, \\\n+\t    double: __issignaling, \\\n+\t    long double: __issignalingl)(X)\n+#endif\n+"}]}