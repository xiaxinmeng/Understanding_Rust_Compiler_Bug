{"sha": "ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "node_id": "C_kwDOANBUbNoAKGNlODNjM2U0OTJjMmZhNWEwOGMxNWI1ZjQ2MTlkNThmNDJhNWRjZDA", "commit": {"author": {"name": "Takayuki 'January June' Suwa", "email": "jjsuwa_sys3175@yahoo.co.jp", "date": "2023-02-26T17:27:42Z"}, "committer": {"name": "Max Filippov", "email": "jcmvbkbc@gmail.com", "date": "2023-02-27T12:03:33Z"}, "message": "xtensa: Make use of CLAMPS instruction if configured\n\nThis patch introduces the use of CLAMPS instruction when the instruction\nis configured.\n\n    /* example */\n    int test(int a) {\n      if (a < -512)\n        return -512;\n      if (a > 511)\n        return 511;\n      return a;\n    }\n\n    ;; prereq: TARGET_CLAMPS\n    test:\n\tclamps\ta2, a2, 9\n\tret.n\n\ngcc/ChangeLog:\n\n\t* config/xtensa/xtensa-protos.h (xtensa_match_CLAMPS_imms_p):\n\tNew prototype.\n\t* config/xtensa/xtensa.cc (xtensa_match_CLAMPS_imms_p):\n\tNew function.\n\t* config/xtensa/xtensa.h (TARGET_CLAMPS): New macro definition.\n\t* config/xtensa/xtensa.md (*xtensa_clamps): New insn pattern.", "tree": {"sha": "214b49a0e36c7ab170b4b1298bd1c3c633ad5f79", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/214b49a0e36c7ab170b4b1298bd1c3c633ad5f79"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/comments", "author": {"login": "jjsuwa-sys3175", "id": 73290592, "node_id": "MDQ6VXNlcjczMjkwNTky", "avatar_url": "https://avatars.githubusercontent.com/u/73290592?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jjsuwa-sys3175", "html_url": "https://github.com/jjsuwa-sys3175", "followers_url": "https://api.github.com/users/jjsuwa-sys3175/followers", "following_url": "https://api.github.com/users/jjsuwa-sys3175/following{/other_user}", "gists_url": "https://api.github.com/users/jjsuwa-sys3175/gists{/gist_id}", "starred_url": "https://api.github.com/users/jjsuwa-sys3175/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jjsuwa-sys3175/subscriptions", "organizations_url": "https://api.github.com/users/jjsuwa-sys3175/orgs", "repos_url": "https://api.github.com/users/jjsuwa-sys3175/repos", "events_url": "https://api.github.com/users/jjsuwa-sys3175/events{/privacy}", "received_events_url": "https://api.github.com/users/jjsuwa-sys3175/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jcmvbkbc", "id": 166731, "node_id": "MDQ6VXNlcjE2NjczMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jcmvbkbc", "html_url": "https://github.com/jcmvbkbc", "followers_url": "https://api.github.com/users/jcmvbkbc/followers", "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}", "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}", "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions", "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs", "repos_url": "https://api.github.com/users/jcmvbkbc/repos", "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}", "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "999b7aab21ca96d58a1dc99f52a3c01cd8760c72", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/999b7aab21ca96d58a1dc99f52a3c01cd8760c72", "html_url": "https://github.com/Rust-GCC/gccrs/commit/999b7aab21ca96d58a1dc99f52a3c01cd8760c72"}], "stats": {"total": 52, "additions": 52, "deletions": 0}, "files": [{"sha": "64cbf27c24859f7abb98e6ccd64345d80a0aec70", "filename": "gcc/config/xtensa/xtensa-protos.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa-protos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa-protos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa-protos.h?ref=ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "patch": "@@ -60,6 +60,7 @@ extern bool xtensa_tls_referenced_p (rtx);\n extern enum rtx_code xtensa_shlrd_which_direction (rtx, rtx);\n extern bool xtensa_split1_finished_p (void);\n extern void xtensa_split_DI_reg_imm (rtx *);\n+extern bool xtensa_match_CLAMPS_imms_p (rtx, rtx);\n \n #ifdef TREE_CODE\n extern void init_cumulative_args (CUMULATIVE_ARGS *, int);"}, {"sha": "7287aa7a258acd81446d850201277d66302e463f", "filename": "gcc/config/xtensa/xtensa.cc", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa.cc?ref=ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "patch": "@@ -2611,6 +2611,19 @@ xtensa_emit_add_imm (rtx dst, rtx src, HOST_WIDE_INT imm, rtx scratch,\n }\n \n \n+/* Return true if the constants used in the application of smin() following\n+   smax() meet the specifications of the CLAMPS machine instruction.  */\n+bool\n+xtensa_match_CLAMPS_imms_p (rtx cst_max, rtx cst_min)\n+{\n+  int max, min;\n+\n+  return IN_RANGE (max = exact_log2 (-INTVAL (cst_max)), 7, 22)\n+\t && IN_RANGE (min = exact_log2 (INTVAL (cst_min) + 1), 7, 22)\n+\t && max == min;\n+}\n+\n+\n /* Implement TARGET_CANNOT_FORCE_CONST_MEM.  */\n \n static bool"}, {"sha": "058602e44ee2298799a39b618f2067c7ebca4964", "filename": "gcc/config/xtensa/xtensa.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa.h?ref=ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "patch": "@@ -35,6 +35,7 @@ along with GCC; see the file COPYING3.  If not see\n #define TARGET_NSA\t\tXCHAL_HAVE_NSA\n #define TARGET_MINMAX\t\tXCHAL_HAVE_MINMAX\n #define TARGET_SEXT\t\tXCHAL_HAVE_SEXT\n+#define TARGET_CLAMPS\t\tXCHAL_HAVE_CLAMPS\n #define TARGET_BOOLEANS\t\tXCHAL_HAVE_BOOLEANS\n #define TARGET_HARD_FLOAT\tXCHAL_HAVE_FP\n #define TARGET_HARD_FLOAT_DIV\tXCHAL_HAVE_FP_DIV"}, {"sha": "3521fa33b47dd8670a5bbb35a7e292b2870cbc2f", "filename": "gcc/config/xtensa/xtensa.md", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0/gcc%2Fconfig%2Fxtensa%2Fxtensa.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fxtensa%2Fxtensa.md?ref=ce83c3e492c2fa5a08c15b5f4619d58f42a5dcd0", "patch": "@@ -446,6 +446,43 @@\n    (set_attr \"mode\"\t\"SI\")\n    (set_attr \"length\"\t\"3\")])\n \n+\f\n+;; Signed clamp.\n+\n+(define_insn_and_split \"*xtensa_clamps\"\n+  [(set (match_operand:SI 0 \"register_operand\" \"=a\")\n+\t(smax:SI (smin:SI (match_operand:SI 1 \"register_operand\" \"r\")\n+\t\t\t  (match_operand:SI 2 \"const_int_operand\" \"i\"))\n+\t\t (match_operand:SI 3 \"const_int_operand\" \"i\")))]\n+  \"TARGET_CLAMPS\n+   && xtensa_match_CLAMPS_imms_p (operands[3], operands[2])\"\n+  \"#\"\n+  \"&& 1\"\n+  [(set (match_dup 0)\n+\t(smin:SI (smax:SI (match_dup 1)\n+\t\t\t  (match_dup 3))\n+\t\t (match_dup 2)))]\n+  \"\"\n+  [(set_attr \"type\"\t\"arith\")\n+   (set_attr \"mode\"\t\"SI\")\n+   (set_attr \"length\"\t\"3\")])\n+\n+(define_insn \"*xtensa_clamps\"\n+  [(set (match_operand:SI 0 \"register_operand\" \"=a\")\n+\t(smin:SI (smax:SI (match_operand:SI 1 \"register_operand\" \"r\")\n+\t\t\t  (match_operand:SI 2 \"const_int_operand\" \"i\"))\n+\t\t (match_operand:SI 3 \"const_int_operand\" \"i\")))]\n+  \"TARGET_CLAMPS\n+   && xtensa_match_CLAMPS_imms_p (operands[2], operands[3])\"\n+{\n+  static char result[64];\n+  sprintf (result, \"clamps\\t%%0, %%1, %d\", floor_log2 (-INTVAL (operands[2])));\n+  return result;\n+}\n+  [(set_attr \"type\"\t\"arith\")\n+   (set_attr \"mode\"\t\"SI\")\n+   (set_attr \"length\"\t\"3\")])\n+\n \f\n ;; Count redundant leading sign bits and leading/trailing zeros,\n ;; and find first bit."}]}