{"sha": "86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODZjMTJmNzYyOWI0M2NiYzI1OWQ4YmJjYjE4NzVmZmYxZjhlNmE0Zg==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2018-05-10T07:36:38Z"}, "committer": {"name": "Eric Botcazou", "email": "ebotcazou@gcc.gnu.org", "date": "2018-05-10T07:36:38Z"}, "message": "re PR c++/85400 (invalid Local Dynamic TLS relaxation for symbol defined in method)\n\n\tPR c++/85400\ncp/\n\t* decl2.c (adjust_var_decl_tls_model): New static function.\n\t(comdat_linkage): Call it on a variable.\n\t(maybe_make_one_only): Likewise.\nc-family/\n\t* c-attribs.c (handle_visibility_attribute): Do not set no_add_attrs.\n\nFrom-SVN: r260106", "tree": {"sha": "5072c928276d92ea5db82bc91219a9b1b942ed7d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5072c928276d92ea5db82bc91219a9b1b942ed7d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/comments", "author": null, "committer": null, "parents": [{"sha": "09dd57a3a4c2e71a972257587f1c3944a51d4846", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/09dd57a3a4c2e71a972257587f1c3944a51d4846", "html_url": "https://github.com/Rust-GCC/gccrs/commit/09dd57a3a4c2e71a972257587f1c3944a51d4846"}], "stats": {"total": 61, "additions": 58, "deletions": 3}, "files": [{"sha": "6ea5eaf1fdf0a829b1d82698cc66aee92a50045c", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "patch": "@@ -1,3 +1,8 @@\n+2018-05-10  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\tPR c++/85400\n+\t* c-attribs.c (handle_visibility_attribute): Do not set no_add_attrs.\n+\n 2018-05-07  Nathan Sidwell  <nathan@acm.org>\n \n \t* c.opt (ffor-scope): Remove functionality, issue warning."}, {"sha": "9bddc1aad4f11d59dd0f85e1dff04a8890d988fa", "filename": "gcc/c-family/c-attribs.c", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fc-family%2Fc-attribs.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fc-family%2Fc-attribs.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-attribs.c?ref=86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "patch": "@@ -2299,14 +2299,13 @@ handle_visibility_attribute (tree *node, tree name, tree args,\n \n static tree\n handle_tls_model_attribute (tree *node, tree name, tree args,\n-\t\t\t    int ARG_UNUSED (flags), bool *no_add_attrs)\n+\t\t\t    int ARG_UNUSED (flags),\n+\t\t\t    bool *ARG_UNUSED (no_add_attrs))\n {\n   tree id;\n   tree decl = *node;\n   enum tls_model kind;\n \n-  *no_add_attrs = true;\n-\n   if (!VAR_P (decl) || !DECL_THREAD_LOCAL_P (decl))\n     {\n       warning (OPT_Wattributes, \"%qE attribute ignored\", name);"}, {"sha": "a2de8f6812563d59b87ce641887fcc4a9de997d9", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "patch": "@@ -1,3 +1,10 @@\n+2018-05-10  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\tPR c++/85400\n+\t* decl2.c (adjust_var_decl_tls_model): New static function.\n+\t(comdat_linkage): Call it on a variable.\n+\t(maybe_make_one_only): Likewise.\n+\n 2018-05-09  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/85713"}, {"sha": "6f3ad4c515041a70765a6224f0538c95a64d83bd", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "patch": "@@ -1838,6 +1838,17 @@ mark_vtable_entries (tree decl)\n     }\n }\n \n+/* Adjust the TLS model on variable DECL if need be, typically after\n+   the linkage of DECL has been modified.  */\n+\n+static void\n+adjust_var_decl_tls_model (tree decl)\n+{\n+  if (CP_DECL_THREAD_LOCAL_P (decl)\n+      && !lookup_attribute (\"tls_model\", DECL_ATTRIBUTES (decl)))\n+    set_decl_tls_model (decl, decl_default_tls_model (decl));\n+}\n+\n /* Set DECL up to have the closest approximation of \"initialized common\"\n    linkage available.  */\n \n@@ -1888,6 +1899,9 @@ comdat_linkage (tree decl)\n \n   if (TREE_PUBLIC (decl))\n     DECL_COMDAT (decl) = 1;\n+\n+  if (VAR_P (decl))\n+    adjust_var_decl_tls_model (decl);\n }\n \n /* For win32 we also want to put explicit instantiations in\n@@ -1926,6 +1940,8 @@ maybe_make_one_only (tree decl)\n \t  /* Mark it needed so we don't forget to emit it.  */\n           node->forced_by_abi = true;\n \t  TREE_USED (decl) = 1;\n+\n+\t  adjust_var_decl_tls_model (decl);\n \t}\n     }\n }"}, {"sha": "5bbcd708d656c17969601002b0eae3afbd4ce62a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "patch": "@@ -1,3 +1,7 @@\n+2018-05-10  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* g++.dg/tls/pr85400.C: New test.\n+\n 2018-05-09  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/85713"}, {"sha": "f8d1bceaca5a41bd1d221bf47047b5670bcac491", "filename": "gcc/testsuite/g++.dg/tls/pr85400.C", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr85400.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr85400.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr85400.C?ref=86c12f7629b43cbc259d8bbcb1875fff1f8e6a4f", "patch": "@@ -0,0 +1,24 @@\n+// PR c++/85400\n+// Testcase by Brian Vandenberg <phantall@gmail.com>\n+\n+// { dg-do link { target c++11 } }\n+// { dg-require-effective-target fpic }\n+// { dg-require-effective-target shared }\n+// { dg-require-effective-target tls }\n+// { dg-options \"-shared -fPIC -O\" }\n+// { dg-add-options tls }\n+\n+struct Test\n+{\n+  int blah (int y)\n+  {\n+    thread_local int mything = 3;\n+    mything = y > 0 ? y : mything;\n+    return mything;\n+  }\n+};\n+\n+int stuff (Test& test, int y)\n+{\n+  return test.blah(y);\n+}"}]}