{"sha": "d4434b511a4e650e95c7a1de6810d8748c5d8a70", "node_id": "C_kwDOANBUbNoAKGQ0NDM0YjUxMWE0ZTY1MGU5NWM3YTFkZTY4MTBkODc0OGM1ZDhhNzA", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-05-11T17:12:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-11T17:12:51Z"}, "message": "Merge #1244\n\n1244: Allow match on integer and char types r=dafaust a=dafaust\n\nEnable compiling match expressions on other primitive types like `i32`, `usize` and `char`.\r\n\n\nCo-authored-by: David Faust <david.faust@oracle.com>", "tree": {"sha": "3556b2c237a43afcde7a643cac7896e0b39e9858", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3556b2c237a43afcde7a643cac7896e0b39e9858"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d4434b511a4e650e95c7a1de6810d8748c5d8a70", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJie+6UCRBK7hj4Ov3rIwAAacsIABdhdUhdOuBdRP042Kc9UWNL\nWmAOO43FD+lw4/CvzGTdYKv6IRFsT/6LV/XjGA/cr/XlbmORL0ec8WebI/qOIWKK\nFDVLBYUJ9LicIHeCeGlL/QLJIc+ZsKN8OhgRLzQ/ctzvhQ1e9tqel71AAM0Xc5+U\nsqsJ+3yA2dT3eCXBelMdtmunwEyTaNxANrt3+dSoeb4jFD63ruK3NOZl36V1W/24\nuk2XxA/fMp0NuJpTB+uSWLPYkrTY4et8dVpwfdfAjbG8PZJBCYfpxCykxarlUqJe\nzjtKcil7jV8qCexfoK87C9qJ7F/AMFkoKB4Oi7I4tUUioh48zJKjMdiNwE2Ezw8=\n=UFSj\n-----END PGP SIGNATURE-----\n", "payload": "tree 3556b2c237a43afcde7a643cac7896e0b39e9858\nparent f2aee09a0b72eec4732cc2e3324bf62729539f88\nparent 5aa411c537289f5695b63de12b973415b2d830d6\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1652289171 +0000\ncommitter GitHub <noreply@github.com> 1652289171 +0000\n\nMerge #1244\n\n1244: Allow match on integer and char types r=dafaust a=dafaust\n\nEnable compiling match expressions on other primitive types like `i32`, `usize` and `char`.\r\n\n\nCo-authored-by: David Faust <david.faust@oracle.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d4434b511a4e650e95c7a1de6810d8748c5d8a70", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d4434b511a4e650e95c7a1de6810d8748c5d8a70", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d4434b511a4e650e95c7a1de6810d8748c5d8a70/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2aee09a0b72eec4732cc2e3324bf62729539f88", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f2aee09a0b72eec4732cc2e3324bf62729539f88", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f2aee09a0b72eec4732cc2e3324bf62729539f88"}, {"sha": "5aa411c537289f5695b63de12b973415b2d830d6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5aa411c537289f5695b63de12b973415b2d830d6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5aa411c537289f5695b63de12b973415b2d830d6"}], "stats": {"total": 240, "additions": 237, "deletions": 3}, "files": [{"sha": "824d6d30d49a0cf9baae139385c7dcd3dc263c2c", "filename": "gcc/rust/backend/rust-compile-expr.cc", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Fbackend%2Frust-compile-expr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Fbackend%2Frust-compile-expr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-expr.cc?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -212,7 +212,8 @@ CompileExpr::visit (HIR::MatchExpr &expr)\n     }\n \n   TyTy::TypeKind scrutinee_kind = scrutinee_expr_tyty->get_kind ();\n-  rust_assert (scrutinee_kind == TyTy::TypeKind::BOOL\n+  rust_assert ((TyTy::is_primitive_type_kind (scrutinee_kind)\n+\t\t&& scrutinee_kind != TyTy::TypeKind::NEVER)\n \t       || scrutinee_kind == TyTy::TypeKind::ADT);\n \n   if (scrutinee_kind == TyTy::TypeKind::ADT)\n@@ -223,6 +224,13 @@ CompileExpr::visit (HIR::MatchExpr &expr)\n       rust_assert (adt->is_enum ());\n       rust_assert (adt->number_of_variants () > 0);\n     }\n+  else if (scrutinee_kind == TyTy::TypeKind::FLOAT)\n+    {\n+      // FIXME: CASE_LABEL_EXPR does not support floating point types.\n+      // Find another way to compile these.\n+      sorry_at (expr.get_locus ().gcc_location (),\n+\t\t\"match on floating-point types is not yet supported\");\n+    }\n \n   TyTy::BaseType *expr_tyty = nullptr;\n   if (!ctx->get_tyctx ()->lookup_type (expr.get_mappings ().get_hirid (),\n@@ -253,7 +261,7 @@ CompileExpr::visit (HIR::MatchExpr &expr)\n     = CompileExpr::Compile (expr.get_scrutinee_expr ().get (), ctx);\n \n   tree match_scrutinee_expr_qualifier_expr;\n-  if (scrutinee_kind == TyTy::TypeKind::BOOL)\n+  if (TyTy::is_primitive_type_kind (scrutinee_kind))\n     {\n       match_scrutinee_expr_qualifier_expr = match_scrutinee_expr;\n     }\n@@ -274,7 +282,7 @@ CompileExpr::visit (HIR::MatchExpr &expr)\n   else\n     {\n       // FIXME: match on other types of expressions not yet implemented.\n-      gcc_assert (0);\n+      gcc_unreachable ();\n     }\n \n   // setup the end label so the cases can exit properly"}, {"sha": "9c1a35a5b91c0a211b6ce9111e92f98b9857f6e1", "filename": "gcc/rust/backend/rust-compile-pattern.cc", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Fbackend%2Frust-compile-pattern.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Fbackend%2Frust-compile-pattern.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-pattern.cc?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -89,6 +89,17 @@ CompilePatternCaseLabelExpr::visit (HIR::LiteralPattern &pattern)\n \t\t\t    pattern.get_literal (), pattern.get_locus (),\n \t\t\t    std::vector<AST::Attribute> ());\n \n+  // Note: Floating point literals are currently accepted but will likely be\n+  // forbidden in LiteralPatterns in a future version of Rust.\n+  // See: https://github.com/rust-lang/rust/issues/41620\n+  // For now, we cannot compile them anyway as CASE_LABEL_EXPR does not support\n+  // floating point types.\n+  if (pattern.get_literal ().get_lit_type () == HIR::Literal::LitType::FLOAT)\n+    {\n+      sorry_at (pattern.get_locus ().gcc_location (),\n+\t\t\"floating-point literal in pattern\");\n+    }\n+\n   tree lit = CompileExpr::Compile (litexpr, ctx);\n \n   case_label_expr = build_case_label (lit, NULL_TREE, associated_case_label);"}, {"sha": "d0e8b761622b9cafaf681d42e552e53a0009a2a7", "filename": "gcc/rust/typecheck/rust-tyty.cc", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -113,6 +113,26 @@ TypeKindFormat::to_string (TypeKind kind)\n   gcc_unreachable ();\n }\n \n+bool\n+is_primitive_type_kind (TypeKind kind)\n+{\n+  switch (kind)\n+    {\n+    case TypeKind::BOOL:\n+    case TypeKind::CHAR:\n+    case TypeKind::INT:\n+    case TypeKind::UINT:\n+    case TypeKind::ISIZE:\n+    case TypeKind::USIZE:\n+    case TypeKind::FLOAT:\n+    case TypeKind::NEVER:\n+    case TypeKind::STR:\n+      return true;\n+    default:\n+      return false;\n+    }\n+}\n+\n bool\n BaseType::satisfies_bound (const TypeBoundPredicate &predicate) const\n {"}, {"sha": "a2950e97b560cfc684d3375c38b541e38f65f24e", "filename": "gcc/rust/typecheck/rust-tyty.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.h?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -67,6 +67,9 @@ enum TypeKind\n   ERROR\n };\n \n+extern bool\n+is_primitive_type_kind (TypeKind kind);\n+\n class TypeKindFormat\n {\n public:"}, {"sha": "3d09a33a77ec74e44937f0223c8b125b44ec7223", "filename": "gcc/testsuite/rust/execute/torture/match_byte1.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_byte1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_byte1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_byte1.rs?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -0,0 +1,49 @@\n+// { dg-output \"a\\nseven\\nquote\\nelse\" }\n+\n+extern \"C\" {\n+    fn printf(s: *const i8, ...);\n+}\n+\n+fn foo (x: u8) {\n+    match x {\n+        b'a' => {\n+            let a = \"a\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        b'\\x07' => {\n+            let a = \"seven\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        b'\\'' => {\n+            let a = \"quote\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        _ => {\n+            let a = \"else\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+    }\n+}\n+\n+fn main () -> i32 {\n+\n+    let x: u8 = 7;\n+\n+    foo (b'a');\n+    foo (x);\n+    foo (b'\\'');\n+    foo (b'\\\\');\n+\n+    0\n+}"}, {"sha": "e9da8ffbddc529094209d403b478f2a0209d477d", "filename": "gcc/testsuite/rust/execute/torture/match_char1.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_char1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_char1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_char1.rs?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -0,0 +1,49 @@\n+// { dg-output \"amazing\\nwildcard\\ncompiler\\nproductivity\\n\" }\n+\n+extern \"C\" {\n+    fn printf(s: *const i8, ...);\n+}\n+\n+fn foo (x: char) {\n+    match x {\n+        'a' => {\n+            let a = \"amazing\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        'c' => {\n+            let a = \"compiler\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        'p' => {\n+            let a = \"productivity\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        _ => {\n+            let a = \"wildcard\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+    }\n+}\n+\n+fn main () -> i32 {\n+\n+    let p = 'p';\n+\n+    foo ('a');\n+    foo ('b');\n+    foo ('c');\n+    foo (p);\n+\n+    0\n+}"}, {"sha": "b1373bf849824e36b7e2d4f904e56e10efa14b58", "filename": "gcc/testsuite/rust/execute/torture/match_int1.rs", "status": "added", "additions": 94, "deletions": 0, "changes": 94, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_int1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d4434b511a4e650e95c7a1de6810d8748c5d8a70/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_int1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fexecute%2Ftorture%2Fmatch_int1.rs?ref=d4434b511a4e650e95c7a1de6810d8748c5d8a70", "patch": "@@ -0,0 +1,94 @@\n+// { dg-output \"other!\\nother!\\nother!\\nfifteen!\\nfifteen!\\nother!\\nother!\\nfifteen!\\n\" }\n+\n+extern \"C\" {\n+    fn printf(s: *const i8, ...);\n+}\n+\n+fn foo_i32 (x: i32) {\n+    match x {\n+        15 => {\n+            let a = \"fifteen!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        _ => {\n+            let a = \"other!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+    }\n+}\n+\n+fn foo_isize (x: isize) {\n+    match x {\n+        15 => {\n+            let a = \"fifteen!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        _ => {\n+            let a = \"other!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+    }\n+}\n+\n+fn foo_u32 (x: u32) {\n+    match x {\n+        15 => {\n+            let a = \"fifteen!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        _ => {\n+            let a = \"other!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+    }\n+}\n+\n+fn foo_usize (x: usize) {\n+    match x {\n+        15 => {\n+            let a = \"fifteen!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+\n+        _ => {\n+            let a = \"other!\\n\\0\";\n+            let b = a as *const str;\n+            let c = b as *const i8;\n+            printf (c);\n+        }\n+    }\n+}\n+\n+\n+fn main () -> i32 {\n+    let x = -2;\n+    foo_i32 (x);\n+    foo_i32 (334);\n+    foo_isize (-4768);\n+    foo_isize (15);\n+\n+    let y = 127;\n+    foo_u32 (15);\n+    foo_u32 (y);\n+    foo_usize (2394);\n+    foo_usize (15);\n+\n+    0\n+}"}]}