{"sha": "0f42a240e53e932de0ae4799d54fe0bd15d06047", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MGY0MmEyNDBlNTNlOTMyZGUwYWU0Nzk5ZDU0ZmUwYmQxNWQwNjA0Nw==", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2021-01-08T16:49:06Z"}, "committer": {"name": "Philip Herron", "email": "herron.philip@googlemail.com", "date": "2021-01-09T14:47:50Z"}, "message": "Functions with parameters much receive their own scoping Rib\n\nThis means that paramters are scoped and shadowed correctly. Currently\nthe resolver is treating all paramters are shadowing each other if they\nhave the same name which is incorrect.", "tree": {"sha": "efc00c63fd2ec4f1fe1bcb890b82e80240be9c4d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/efc00c63fd2ec4f1fe1bcb890b82e80240be9c4d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0f42a240e53e932de0ae4799d54fe0bd15d06047", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0f42a240e53e932de0ae4799d54fe0bd15d06047", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0f42a240e53e932de0ae4799d54fe0bd15d06047", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0f42a240e53e932de0ae4799d54fe0bd15d06047/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d7a53b684b5765acda82f39f71bc7798bf0ee94", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6d7a53b684b5765acda82f39f71bc7798bf0ee94", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6d7a53b684b5765acda82f39f71bc7798bf0ee94"}], "stats": {"total": 30, "additions": 14, "deletions": 16}, "files": [{"sha": "310d296976eb13d89b4bd89b4daeb353893f09d9", "filename": "gcc/rust/resolve/rust-ast-resolve-item.h", "status": "modified", "additions": 11, "deletions": 16, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0f42a240e53e932de0ae4799d54fe0bd15d06047/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0f42a240e53e932de0ae4799d54fe0bd15d06047/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-ast-resolve-item.h?ref=0f42a240e53e932de0ae4799d54fe0bd15d06047", "patch": "@@ -65,29 +65,24 @@ class ResolveItem : public ResolverBase\n       ResolveType::go (function.get_return_type ().get (),\n \t\t       function.get_node_id ());\n \n+    NodeId scope_node_id = function.get_node_id ();\n+    resolver->get_name_scope ().push (scope_node_id);\n+    resolver->get_type_scope ().push (scope_node_id);\n+    resolver->push_new_name_rib (resolver->get_name_scope ().peek ());\n+    resolver->push_new_type_rib (resolver->get_type_scope ().peek ());\n+\n+    // we make a new scope so the names of parameters are resolved and shadowed\n+    // correctly\n     for (auto &param : function.get_function_params ())\n       {\n \tResolveType::go (param.get_type ().get (), param.get_node_id ());\n \tPatternDeclaration::go (param.get_pattern ().get (),\n \t\t\t\tparam.get_node_id ());\n       }\n \n-    // setup parent scoping for names\n-    NodeId scope_node_id = function.get_definition ()->get_node_id ();\n-    resolver->get_name_scope ().push (scope_node_id);\n-    resolver->get_type_scope ().push (scope_node_id);\n-    resolver->push_new_name_rib (resolver->get_name_scope ().peek ());\n-    resolver->push_new_type_rib (resolver->get_type_scope ().peek ());\n-\n-    function.get_definition ()->iterate_stmts (\n-      [&] (AST::Stmt *s) mutable -> bool {\n-\tResolveStmt::go (s, s->get_node_id ());\n-\treturn true;\n-      });\n-\n-    if (function.get_definition ()->has_tail_expr ())\n-      ResolveExpr::go (function.get_definition ()->get_tail_expr ().get (),\n-\t\t       function.get_node_id ());\n+    // resolve the function body\n+    ResolveExpr::go (function.get_definition ().get (),\n+\t\t     function.get_node_id ());\n \n     resolver->get_name_scope ().pop ();\n     resolver->get_type_scope ().pop ();"}, {"sha": "e5b09424d33550de20a20c37c532431ff3c69028", "filename": "gcc/rust/resolve/rust-ast-resolve.cc", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0f42a240e53e932de0ae4799d54fe0bd15d06047/gcc%2Frust%2Fresolve%2Frust-ast-resolve.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0f42a240e53e932de0ae4799d54fe0bd15d06047/gcc%2Frust%2Fresolve%2Frust-ast-resolve.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-ast-resolve.cc?ref=0f42a240e53e932de0ae4799d54fe0bd15d06047", "patch": "@@ -285,6 +285,9 @@ ResolveExpr::visit (AST::BlockExpr &expr)\n     return true;\n   });\n \n+  if (expr.has_tail_expr ())\n+    ResolveExpr::go (expr.get_tail_expr ().get (), expr.get_node_id ());\n+\n   resolver->get_name_scope ().pop ();\n   resolver->get_type_scope ().pop ();\n }"}]}