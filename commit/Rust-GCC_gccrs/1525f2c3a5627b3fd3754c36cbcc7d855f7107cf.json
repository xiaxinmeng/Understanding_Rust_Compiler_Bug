{"sha": "1525f2c3a5627b3fd3754c36cbcc7d855f7107cf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTUyNWYyYzNhNTYyN2IzZmQzNzU0YzM2Y2JjYzdkODU1ZjcxMDdjZg==", "commit": {"author": {"name": "Golovanevsky Olga", "email": "olga@il.ibm.com", "date": "2008-01-25T08:02:54Z"}, "committer": {"name": "Olga Golovanevsky", "email": "olga@gcc.gnu.org", "date": "2008-01-25T08:02:54Z"}, "message": "ipa-struct-reorg.c (remove_str_allocs_in_func, [...]): New functions.\n\n2008-01-25  Golovanevsky Olga  <olga@il.ibm.com>\n\n\t* ipa-struct-reorg.c (remove_str_allocs_in_func, remove_str_allocs):\n\tNew functions.\n\t(remove_structure): Update allocations list before removing structure.\n\nFrom-SVN: r131818", "tree": {"sha": "b7f43043132a654f9b071fd72aee83a8a848eb0c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b7f43043132a654f9b071fd72aee83a8a848eb0c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf/comments", "author": null, "committer": null, "parents": [{"sha": "bd91d74392900e18b3eb5c06ddd39cd06977890a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bd91d74392900e18b3eb5c06ddd39cd06977890a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bd91d74392900e18b3eb5c06ddd39cd06977890a"}], "stats": {"total": 49, "additions": 47, "deletions": 2}, "files": [{"sha": "392999fa36f6dfb7a9da2315061ec2996d76773c", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=1525f2c3a5627b3fd3754c36cbcc7d855f7107cf", "patch": "@@ -1,3 +1,9 @@\n+2008-01-25  Golovanevsky Olga  <olga@il.ibm.com>\n+\n+\t* ipa-struct-reorg.c (remove_str_allocs_in_func, remove_str_allocs):\n+\tNew functions.\n+\t(remove_structure): Update allocations list before removing structure.\n+\t\n 2008-01-25  Golovanevsky Olga  <olga@il.ibm.com>\n \n \t* ipa-struct-reorg.c (is_safe_cond_expr, "}, {"sha": "79a2ffddb0258064186111ca2e45e405be643496", "filename": "gcc/ipa-struct-reorg.c", "status": "modified", "additions": 41, "deletions": 2, "changes": 43, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf/gcc%2Fipa-struct-reorg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1525f2c3a5627b3fd3754c36cbcc7d855f7107cf/gcc%2Fipa-struct-reorg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-struct-reorg.c?ref=1525f2c3a5627b3fd3754c36cbcc7d855f7107cf", "patch": "@@ -187,7 +187,7 @@ typedef struct func_alloc_sites *fallocs_t;\n typedef const struct func_alloc_sites *const_fallocs_t;\n \n /* All allocation sites in the program.  */\n-htab_t alloc_sites;\n+htab_t alloc_sites = NULL;\n \n /* New global variables. Generated once for whole program.  */\n htab_t new_global_vars;\n@@ -2347,6 +2347,41 @@ dump_access_sites (htab_t accs)\n     htab_traverse (accs, dump_acc, NULL);\n }\n \n+/* This function is a callback for alloc_sites hashtable \n+   traversal. SLOT is a pointer to fallocs_t. This function\n+   removes all allocations of the structure defined by DATA.  */\n+\n+static int\n+remove_str_allocs_in_func (void **slot, void *data)\n+{\n+  fallocs_t fallocs = *(fallocs_t *) slot;\n+  unsigned i = 0;\n+  alloc_site_t *call;\n+\n+  while (VEC_iterate (alloc_site_t, fallocs->allocs, i, call))\n+    {\n+      if (call->str == (d_str) data)\n+\tVEC_ordered_remove (alloc_site_t, fallocs->allocs, i);\n+      else\n+\ti++;\n+    }\n+\n+  return 1;\n+}\n+\n+/* This function remove all entries corresponding to the STR structure\n+   from alloc_sites hashtable.   */\n+\n+static void\n+remove_str_allocs (d_str str)\n+{\n+  if (!str)\n+    return;\n+\n+  if (alloc_sites)\n+    htab_traverse (alloc_sites, remove_str_allocs_in_func, str);\n+}\n+\n /* This function removes the structure with index I from structures vector.  */\n \n static void \n@@ -2357,7 +2392,11 @@ remove_structure (unsigned i)\n   if (i >= VEC_length (structure, structures))\n     return;\n \n-  str = VEC_index (structure, structures, i);  \n+  str = VEC_index (structure, structures, i);\n+  \n+  /* Before removing the structure str, we have to remove its\n+     allocations from alloc_sites hashtable.  */\n+  remove_str_allocs (str);\n   free_data_struct (str);\n   VEC_ordered_remove (structure, structures, i);\n }"}]}