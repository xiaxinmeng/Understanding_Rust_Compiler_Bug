{"sha": "c7008d3e254786b5e752aa61e067f62c38042b81", "node_id": "C_kwDOANBUbNoAKGM3MDA4ZDNlMjU0Nzg2YjVlNzUyYWE2MWUwNjdmNjJjMzgwNDJiODE", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-05-23T11:03:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-23T11:03:46Z"}, "message": "Merge #1266\n\n1266: Make TyTy::BaseType::destructure recursive r=philberty a=philberty\n\nIn the case of Generic Associated Types we end up\r\n\r\n  placeholders->projections->generic-param->i32\r\n\r\nThis means we need to keep destructuring the TyTy object until we finally\r\nget the real type at the end. In order to do this safely we need to ensure\r\nwe add in recursion limits and apply this where it matters such as\r\ncompiling types in general too.\r\n\n\nCo-authored-by: Philip Herron <philip.herron@embecosm.com>", "tree": {"sha": "7c197b54d3e150c643b46ebfadb709ef83befa73", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7c197b54d3e150c643b46ebfadb709ef83befa73"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c7008d3e254786b5e752aa61e067f62c38042b81", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJii2oSCRBK7hj4Ov3rIwAAVLcIAJkO39v9kJaEPIPhjTxQjhAR\nJYAMJpzz+vyGhGKS5dlOr7k72E6mTGbeynj2XTR3mTWR8SKsTQLcaQRDFrfcCMLW\nvpeakDPCWOsmRLfFeucW0/V8eCNO4pHWuEcfC5wKV7zH2uW7BykP2PSWxmcgDGUY\nsab8qRXRvIal9yr7YK0A1WpfROAWiQjE2VpauRI2Ct++vfeyHD7ZnDqNy7jqHd41\n5jdQY49P8wFXN3B36MwV4UnrkFrspHOAx0sOyiiPQBF7u+JEpRINrCjZx+0YC0dz\nzhwybSYJO3KhBSk3Fj09TNBYDydNvIt4ulZ7MQRKdUg1FeeXd88p+bkXJXun4Bo=\n=c8m8\n-----END PGP SIGNATURE-----\n", "payload": "tree 7c197b54d3e150c643b46ebfadb709ef83befa73\nparent 9204e7a1ac617126b65c27668524aebf8f65f134\nparent a647c005908d79bc6b50739c43b7ac105bc193a9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1653303826 +0000\ncommitter GitHub <noreply@github.com> 1653303826 +0000\n\nMerge #1266\n\n1266: Make TyTy::BaseType::destructure recursive r=philberty a=philberty\n\nIn the case of Generic Associated Types we end up\r\n\r\n  placeholders->projections->generic-param->i32\r\n\r\nThis means we need to keep destructuring the TyTy object until we finally\r\nget the real type at the end. In order to do this safely we need to ensure\r\nwe add in recursion limits and apply this where it matters such as\r\ncompiling types in general too.\r\n\n\nCo-authored-by: Philip Herron <philip.herron@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c7008d3e254786b5e752aa61e067f62c38042b81", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c7008d3e254786b5e752aa61e067f62c38042b81", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c7008d3e254786b5e752aa61e067f62c38042b81/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9204e7a1ac617126b65c27668524aebf8f65f134", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9204e7a1ac617126b65c27668524aebf8f65f134", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9204e7a1ac617126b65c27668524aebf8f65f134"}, {"sha": "a647c005908d79bc6b50739c43b7ac105bc193a9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a647c005908d79bc6b50739c43b7ac105bc193a9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a647c005908d79bc6b50739c43b7ac105bc193a9"}], "stats": {"total": 85, "additions": 54, "deletions": 31}, "files": [{"sha": "102bc0a3f65bbc83f465093c0d7e403c3bd4a9a4", "filename": "gcc/rust/backend/rust-compile-type.cc", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Fbackend%2Frust-compile-type.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Fbackend%2Frust-compile-type.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-type.cc?ref=c7008d3e254786b5e752aa61e067f62c38042b81", "patch": "@@ -112,9 +112,15 @@ TyTyResolveCompile::visit (const TyTy::PlaceholderType &type)\n void\n TyTyResolveCompile::visit (const TyTy::ParamType &param)\n {\n-  // FIXME make this reuse the same machinery from constexpr code\n-  recursion_count++;\n-  rust_assert (recursion_count < kDefaultRecusionLimit);\n+  if (recurisve_ops++ >= rust_max_recursion_depth)\n+    {\n+      rust_error_at (Location (),\n+\t\t     \"%<recursion depth%> count exceeds limit of %i (use \"\n+\t\t     \"%<frust-max-recursion-depth=%> to increase the limit)\",\n+\t\t     rust_max_recursion_depth);\n+      translated = error_mark_node;\n+      return;\n+    }\n \n   param.resolve ()->accept_vis (*this);\n }"}, {"sha": "262b8fc51a08c571759f43509ef517099b3c75b2", "filename": "gcc/rust/backend/rust-compile-type.h", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Fbackend%2Frust-compile-type.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Fbackend%2Frust-compile-type.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-type.h?ref=c7008d3e254786b5e752aa61e067f62c38042b81", "patch": "@@ -63,16 +63,13 @@ class TyTyResolveCompile : public TyTy::TyConstVisitor\n private:\n   TyTyResolveCompile (Context *ctx, bool trait_object_mode)\n     : ctx (ctx), trait_object_mode (trait_object_mode),\n-      translated (error_mark_node), recursion_count (0)\n+      translated (error_mark_node), recurisve_ops (0)\n   {}\n \n   Context *ctx;\n   bool trait_object_mode;\n   tree translated;\n-\n-  // FIXME this needs to be derived from the gcc config option\n-  size_t recursion_count;\n-  static const size_t kDefaultRecusionLimit = 5;\n+  int recurisve_ops;\n };\n \n } // namespace Compile"}, {"sha": "58ec9a75e9a39db9347a89d5a3186389c24049c9", "filename": "gcc/rust/lang.opt", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Flang.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Flang.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Flang.opt?ref=c7008d3e254786b5e752aa61e067f62c38042b81", "patch": "@@ -66,6 +66,10 @@ frust-dump-\n Rust Joined RejectNegative\n -frust-dump-<type>\tDump Rust frontend internal information.\n \n+frust-max-recursion-depth=\n+Rust RejectNegative Type(int) Var(rust_max_recursion_depth) Init(64)\n+-frust-max-recursion-depth=integer\n+\n frust-mangling=\n Rust Joined RejectNegative Enum(frust_mangling) Var(flag_rust_mangling)\n -frust-mangling=[legacy|v0]     Choose which version to use for name mangling"}, {"sha": "f03bc8234c8227dda8fd2d330a99d10acc25d365", "filename": "gcc/rust/typecheck/rust-tyty.cc", "status": "modified", "additions": 39, "deletions": 23, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c7008d3e254786b5e752aa61e067f62c38042b81/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc?ref=c7008d3e254786b5e752aa61e067f62c38042b81", "patch": "@@ -252,33 +252,49 @@ BaseType::get_root () const\n const BaseType *\n BaseType::destructure () const\n {\n-  switch (get_kind ())\n+  int recurisve_ops = 0;\n+  const BaseType *x = this;\n+  while (true)\n     {\n-      case TyTy::TypeKind::PARAM: {\n-\tconst TyTy::ParamType *p = static_cast<const TyTy::ParamType *> (this);\n-\treturn p->resolve ();\n-      }\n-      break;\n-\n-      case TyTy::TypeKind::PLACEHOLDER: {\n-\tconst TyTy::PlaceholderType *p\n-\t  = static_cast<const TyTy::PlaceholderType *> (this);\n-\trust_assert (p->can_resolve ());\n-\treturn p->resolve ();\n-      }\n-      break;\n-\n-      case TyTy::TypeKind::PROJECTION: {\n-\tconst TyTy::ProjectionType *p\n-\t  = static_cast<const TyTy::ProjectionType *> (this);\n-\treturn p->get ();\n-      }\n+      if (recurisve_ops++ >= rust_max_recursion_depth)\n+\t{\n+\t  rust_error_at (\n+\t    Location (),\n+\t    \"%<recursion depth%> count exceeds limit of %i (use \"\n+\t    \"%<frust-max-recursion-depth=%> to increase the limit)\",\n+\t    rust_max_recursion_depth);\n+\t  return new ErrorType (get_ref ());\n+\t}\n \n-    default:\n-      return this;\n+      switch (x->get_kind ())\n+\t{\n+\t  case TyTy::TypeKind::PARAM: {\n+\t    const TyTy::ParamType *p = static_cast<const TyTy::ParamType *> (x);\n+\t    x = p->resolve ();\n+\t  }\n+\t  break;\n+\n+\t  case TyTy::TypeKind::PLACEHOLDER: {\n+\t    const TyTy::PlaceholderType *p\n+\t      = static_cast<const TyTy::PlaceholderType *> (x);\n+\t    rust_assert (p->can_resolve ());\n+\t    x = p->resolve ();\n+\t  }\n+\t  break;\n+\n+\t  case TyTy::TypeKind::PROJECTION: {\n+\t    const TyTy::ProjectionType *p\n+\t      = static_cast<const TyTy::ProjectionType *> (x);\n+\t    x = p->get ();\n+\t  }\n+\t  break;\n+\n+\tdefault:\n+\t  return x;\n+\t}\n     }\n \n-  return this;\n+  return x;\n }\n \n TyVar::TyVar (HirId ref) : ref (ref)"}]}